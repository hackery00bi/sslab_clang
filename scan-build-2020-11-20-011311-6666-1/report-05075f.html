<!doctype html>
<html>
<head>
<title>ssl/t1_lib.c</title>

<style type="text/css">
body { color:#000000; background-color:#ffffff }
body { font-family:Helvetica, sans-serif; font-size:10pt }
h1 { font-size:14pt }
.FileName { margin-top: 5px; margin-bottom: 5px; display: inline; }
.FileNav { margin-left: 5px; margin-right: 5px; display: inline; }
.FileNav a { text-decoration:none; font-size: larger; }
.divider { margin-top: 30px; margin-bottom: 30px; height: 15px; }
.divider { background-color: gray; }
.code { border-collapse:collapse; width:100%; }
.code { font-family: "Monospace", monospace; font-size:10pt }
.code { line-height: 1.2em }
.comment { color: green; font-style: oblique }
.keyword { color: blue }
.string_literal { color: red }
.directive { color: darkmagenta }

/* Macros and variables could have pop-up notes hidden by default.
  - Macro pop-up:    expansion of the macro
  - Variable pop-up: value (table) of the variable */
.macro_popup, .variable_popup { display: none; }

/* Pop-up appears on mouse-hover event. */
.macro:hover .macro_popup, .variable:hover .variable_popup {
  display: block;
  padding: 2px;
  -webkit-border-radius:5px;
  -webkit-box-shadow:1px 1px 7px #000;
  border-radius:5px;
  box-shadow:1px 1px 7px #000;
  position: absolute;
  top: -1em;
  left:10em;
  z-index: 1
}

.macro_popup {
  border: 2px solid red;
  background-color:#FFF0F0;
  font-weight: normal;
}

.variable_popup {
  border: 2px solid blue;
  background-color:#F0F0FF;
  font-weight: bold;
  font-family: Helvetica, sans-serif;
  font-size: 9pt;
}

/* Pop-up notes needs a relative position as a base where they pops up. */
.macro, .variable {
  background-color: PaleGoldenRod;
  position: relative;
}
.macro { color: DarkMagenta; }

#tooltiphint {
  position: fixed;
  width: 50em;
  margin-left: -25em;
  left: 50%;
  padding: 10px;
  border: 1px solid #b0b0b0;
  border-radius: 2px;
  box-shadow: 1px 1px 7px black;
  background-color: #c0c0c0;
  z-index: 2;
}

.num { width:2.5em; padding-right:2ex; background-color:#eeeeee }
.num { text-align:right; font-size:8pt }
.num { color:#444444 }
.line { padding-left: 1ex; border-left: 3px solid #ccc }
.line { white-space: pre }
.msg { -webkit-box-shadow:1px 1px 7px #000 }
.msg { box-shadow:1px 1px 7px #000 }
.msg { -webkit-border-radius:5px }
.msg { border-radius:5px }
.msg { font-family:Helvetica, sans-serif; font-size:8pt }
.msg { float:left }
.msg { padding:0.25em 1ex 0.25em 1ex }
.msg { margin-top:10px; margin-bottom:10px }
.msg { font-weight:bold }
.msg { max-width:60em; word-wrap: break-word; white-space: pre-wrap }
.msgT { padding:0x; spacing:0x }
.msgEvent { background-color:#fff8b4; color:#000000 }
.msgControl { background-color:#bbbbbb; color:#000000 }
.msgNote { background-color:#ddeeff; color:#000000 }
.mrange { background-color:#dfddf3 }
.mrange { border-bottom:1px solid #6F9DBE }
.PathIndex { font-weight: bold; padding:0px 5px; margin-right:5px; }
.PathIndex { -webkit-border-radius:8px }
.PathIndex { border-radius:8px }
.PathIndexEvent { background-color:#bfba87 }
.PathIndexControl { background-color:#8c8c8c }
.PathIndexPopUp { background-color: #879abc; }
.PathNav a { text-decoration:none; font-size: larger }
.CodeInsertionHint { font-weight: bold; background-color: #10dd10 }
.CodeRemovalHint { background-color:#de1010 }
.CodeRemovalHint { border-bottom:1px solid #6F9DBE }
.selected{ background-color:orange !important; }

table.simpletable {
  padding: 5px;
  font-size:12pt;
  margin:20px;
  border-collapse: collapse; border-spacing: 0px;
}
td.rowname {
  text-align: right;
  vertical-align: top;
  font-weight: bold;
  color:#444444;
  padding-right:2ex;
}

/* Hidden text. */
input.spoilerhider + label {
  cursor: pointer;
  text-decoration: underline;
  display: block;
}
input.spoilerhider {
 display: none;
}
input.spoilerhider ~ .spoiler {
  overflow: hidden;
  margin: 10px auto 0;
  height: 0;
  opacity: 0;
}
input.spoilerhider:checked + label + .spoiler{
  height: auto;
  opacity: 1;
}
</style>
</head>
<body>
<!-- BUGDESC Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11 -->

<!-- BUGTYPE Potential insecure memory buffer bounds restriction in call 'memcpy' -->

<!-- BUGCATEGORY Security -->

<!-- BUGFILE /tmp/real/c_wrk/wrk0/obj/openssl-1.1.0g/ssl/t1_lib.c -->

<!-- FILENAME t1_lib.c -->

<!-- FUNCTIONNAME ssl_add_clienthello_tlsext -->

<!-- ISSUEHASHCONTENTOFLINEINCONTEXT 69e1b5507040fc166dcc44c04406095b -->

<!-- BUGLINE 1194 -->

<!-- BUGCOLUMN 13 -->

<!-- BUGPATHLENGTH 1 -->

<!-- BUGMETAEND -->
<!-- REPORTHEADER -->
<h3>Bug Summary</h3>
<table class="simpletable">
<tr><td class="rowname">File:</td><td>obj/openssl-1.1.0g/ssl/t1_lib.c</td></tr>
<tr><td class="rowname">Warning:</td><td><a href="#EndPath">line 1194, column 13</a><br />Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11</td></tr>

</table>
<!-- REPORTSUMMARYEXTRA -->
<h3>Annotated Source Code</h3>
<p>Press <a href="#" onclick="toggleHelp(); return false;">'?'</a>
   to see keyboard shortcuts</p>
<input type="checkbox" class="spoilerhider" id="showinvocation" />
<label for="showinvocation" >Show analyzer invocation</label>
<div class="spoiler">clang -cc1 -cc1 -triple x86_64-unknown-linux-gnu -analyze -disable-free -main-file-name t1_lib.c -analyzer-store=region -analyzer-opt-analyze-nested-blocks -analyzer-checker=core -analyzer-checker=apiModeling -analyzer-checker=unix -analyzer-checker=deadcode -analyzer-checker=security.insecureAPI.UncheckedReturn -analyzer-checker=security.insecureAPI.getpw -analyzer-checker=security.insecureAPI.gets -analyzer-checker=security.insecureAPI.mktemp -analyzer-checker=security.insecureAPI.mkstemp -analyzer-checker=security.insecureAPI.vfork -analyzer-checker=nullability.NullPassedToNonnull -analyzer-checker=nullability.NullReturnedFromNonnull -analyzer-output plist -w -setup-static-analyzer -mrelocation-model pic -pic-level 2 -mframe-pointer=none -fmath-errno -fno-rounding-math -mconstructor-aliases -munwind-tables -target-cpu x86-64 -fno-split-dwarf-inlining -debugger-tuning=gdb -resource-dir /llvm-project/build/lib/clang/12.0.0 -I . -I include -D DSO_DLFCN -D HAVE_DLFCN_H -D NDEBUG -D OPENSSL_THREADS -D OPENSSL_NO_DYNAMIC_ENGINE -D OPENSSL_PIC -D OPENSSL_IA32_SSE2 -D OPENSSL_BN_ASM_MONT -D OPENSSL_BN_ASM_MONT5 -D OPENSSL_BN_ASM_GF2m -D SHA1_ASM -D SHA256_ASM -D SHA512_ASM -D RC4_ASM -D MD5_ASM -D AES_ASM -D VPAES_ASM -D BSAES_ASM -D GHASH_ASM -D ECP_NISTZ256_ASM -D PADLOCK_ASM -D POLY1305_ASM -D OPENSSLDIR="/tmp/real/c_wrk/wrk0/obj/ssl" -D ENGINESDIR="/tmp/real/c_wrk/wrk0/obj/lib/engines-1.1" -D L_ENDIAN -D OPENSSL_USE_NODELETE -internal-isystem /usr/local/include -internal-isystem /llvm-project/build/lib/clang/12.0.0/include -internal-externc-isystem /usr/include/x86_64-linux-gnu -internal-externc-isystem /include -internal-externc-isystem /usr/include -O3 -fdebug-compilation-dir /tmp/real/c_wrk/wrk0/obj/openssl-1.1.0g -ferror-limit 19 -fgnuc-version=4.2.1 -vectorize-loops -vectorize-slp -analyzer-checker core -analyzer-checker cplusplus -analyzer-checker nullability -analyzer-checker optin -analyzer-checker security -analyzer-checker unix -analyzer-checker osx -analyzer-checker fuchsia -analyzer-checker webkit -analyzer-output=html -faddrsig -o /tmp/scan-build-2020-11-20-011311-6666-1 -x c ssl/t1_lib.c
</div>
<div id='tooltiphint' hidden="true">
  <p>Keyboard shortcuts: </p>
  <ul>
    <li>Use 'j/k' keys for keyboard navigation</li>
    <li>Use 'Shift+S' to show/hide relevant lines</li>
    <li>Use '?' to toggle this window</li>
  </ul>
  <a href="#" onclick="toggleHelp(); return false;">Close</a>
</div>
<script type='text/javascript'>
var relevant_lines = {"1": {"1194": 1}};

var filterCounterexample = function (hide) {
  var tables = document.getElementsByClassName("code");
  for (var t=0; t<tables.length; t++) {
    var table = tables[t];
    var file_id = table.getAttribute("data-fileid");
    var lines_in_fid = relevant_lines[file_id];
    if (!lines_in_fid) {
      lines_in_fid = {};
    }
    var lines = table.getElementsByClassName("codeline");
    for (var i=0; i<lines.length; i++) {
        var el = lines[i];
        var lineNo = el.getAttribute("data-linenumber");
        if (!lines_in_fid[lineNo]) {
          if (hide) {
            el.setAttribute("hidden", "");
          } else {
            el.removeAttribute("hidden");
          }
        }
    }
  }
}

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "S") {
    var checked = document.getElementsByName("showCounterexample")[0].checked;
    filterCounterexample(!checked);
    document.getElementsByName("showCounterexample")[0].checked = !checked;
  } else {
    return;
  }
  event.preventDefault();
}, true);

document.addEventListener("DOMContentLoaded", function() {
    document.querySelector('input[name="showCounterexample"]').onchange=
        function (event) {
      filterCounterexample(this.checked);
    };
});
</script>

<form>
    <input type="checkbox" name="showCounterexample" id="showCounterexample" />
    <label for="showCounterexample">
       Show only relevant lines
    </label>
</form>

<script type='text/javascript'>
var digitMatcher = new RegExp("[0-9]+");

var querySelectorAllArray = function(selector) {
  return Array.prototype.slice.call(
    document.querySelectorAll(selector));
}

document.addEventListener("DOMContentLoaded", function() {
    querySelectorAllArray(".PathNav > a").forEach(
        function(currentValue, currentIndex) {
            var hrefValue = currentValue.getAttribute("href");
            currentValue.onclick = function() {
                scrollTo(document.querySelector(hrefValue));
                return false;
            };
        });
});

var findNum = function() {
    var s = document.querySelector(".selected");
    if (!s || s.id == "EndPath") {
        return 0;
    }
    var out = parseInt(digitMatcher.exec(s.id)[0]);
    return out;
};

var scrollTo = function(el) {
    querySelectorAllArray(".selected").forEach(function(s) {
        s.classList.remove("selected");
    });
    el.classList.add("selected");
    window.scrollBy(0, el.getBoundingClientRect().top -
        (window.innerHeight / 2));
}

var move = function(num, up, numItems) {
  if (num == 1 && up || num == numItems - 1 && !up) {
    return 0;
  } else if (num == 0 && up) {
    return numItems - 1;
  } else if (num == 0 && !up) {
    return 1 % numItems;
  }
  return up ? num - 1 : num + 1;
}

var numToId = function(num) {
  if (num == 0) {
    return document.getElementById("EndPath")
  }
  return document.getElementById("Path" + num);
};

var navigateTo = function(up) {
  var numItems = document.querySelectorAll(
      ".line > .msgEvent, .line > .msgControl").length;
  var currentSelected = findNum();
  var newSelected = move(currentSelected, up, numItems);
  var newEl = numToId(newSelected, numItems);

  // Scroll element into center.
  scrollTo(newEl);
};

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "j") {
    navigateTo(/*up=*/false);
  } else if (event.key == "k") {
    navigateTo(/*up=*/true);
  } else {
    return;
  }
  event.preventDefault();
}, true);
</script>
  
<script type='text/javascript'>

var toggleHelp = function() {
    var hint = document.querySelector("#tooltiphint");
    var attributeName = "hidden";
    if (hint.hasAttribute(attributeName)) {
      hint.removeAttribute(attributeName);
    } else {
      hint.setAttribute("hidden", "true");
    }
};
window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "?") {
    toggleHelp();
  } else {
    return;
  }
  event.preventDefault();
});
</script>
<table class="code" data-fileid="1">
<tr class="codeline" data-linenumber="1"><td class="num" id="LN1">1</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2"><td class="num" id="LN2">2</td><td class="line"> <span class='comment'>* Copyright 1995-2016 The OpenSSL Project Authors. All Rights Reserved.</span></td></tr>
<tr class="codeline" data-linenumber="3"><td class="num" id="LN3">3</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="4"><td class="num" id="LN4">4</td><td class="line"> <span class='comment'>* Licensed under the OpenSSL license (the "License").  You may not use</span></td></tr>
<tr class="codeline" data-linenumber="5"><td class="num" id="LN5">5</td><td class="line"> <span class='comment'>* this file except in compliance with the License.  You can obtain a copy</span></td></tr>
<tr class="codeline" data-linenumber="6"><td class="num" id="LN6">6</td><td class="line"> <span class='comment'>* in the file LICENSE in the source distribution or at</span></td></tr>
<tr class="codeline" data-linenumber="7"><td class="num" id="LN7">7</td><td class="line"> <span class='comment'>* https://www.openssl.org/source/license.html</span></td></tr>
<tr class="codeline" data-linenumber="8"><td class="num" id="LN8">8</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="9"><td class="num" id="LN9">9</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="10"><td class="num" id="LN10">10</td><td class="line"><span class='directive'>#include &lt;stdio.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="11"><td class="num" id="LN11">11</td><td class="line"><span class='directive'>#include &lt;stdlib.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="12"><td class="num" id="LN12">12</td><td class="line"><span class='directive'>#include &lt;openssl/objects.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="13"><td class="num" id="LN13">13</td><td class="line"><span class='directive'>#include &lt;openssl/evp.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="14"><td class="num" id="LN14">14</td><td class="line"><span class='directive'>#include &lt;openssl/hmac.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="15"><td class="num" id="LN15">15</td><td class="line"><span class='directive'>#include &lt;openssl/ocsp.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="16"><td class="num" id="LN16">16</td><td class="line"><span class='directive'>#include &lt;openssl/conf.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="17"><td class="num" id="LN17">17</td><td class="line"><span class='directive'>#include &lt;openssl/x509v3.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="18"><td class="num" id="LN18">18</td><td class="line"><span class='directive'>#include &lt;openssl/dh.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="19"><td class="num" id="LN19">19</td><td class="line"><span class='directive'>#include &lt;openssl/bn.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="20"><td class="num" id="LN20">20</td><td class="line"><span class='directive'>#include "ssl_locl.h"</span></td></tr>
<tr class="codeline" data-linenumber="21"><td class="num" id="LN21">21</td><td class="line"><span class='directive'>#include &lt;openssl/ct.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="22"><td class="num" id="LN22">22</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="23"><td class="num" id="LN23">23</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="24"><td class="num" id="LN24">24</td><td class="line"><span class='directive'>#define <span class='macro'>CHECKLEN(curr, val, limit)<span class='macro_popup'>(((curr) &gt;= (limit)) || (size_t)((limit) - (curr)) &lt; (size_t<br>)(val))</span></span> \</span></td></tr>
<tr class="codeline" data-linenumber="25"><td class="num" id="LN25">25</td><td class="line">    <span class='directive'>(((curr) &gt;= (limit)) || (size_t)((limit) - (curr)) &lt; (size_t)(val))</span></td></tr>
<tr class="codeline" data-linenumber="26"><td class="num" id="LN26">26</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="27"><td class="num" id="LN27">27</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls_decrypt_ticket(SSL *s, <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *tick, <span class='keyword'>int</span> ticklen,</td></tr>
<tr class="codeline" data-linenumber="28"><td class="num" id="LN28">28</td><td class="line">                              <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *sess_id, <span class='keyword'>int</span> sesslen,</td></tr>
<tr class="codeline" data-linenumber="29"><td class="num" id="LN29">29</td><td class="line">                              SSL_SESSION **psess);</td></tr>
<tr class="codeline" data-linenumber="30"><td class="num" id="LN30">30</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> ssl_check_clienthello_tlsext_early(SSL *s);</td></tr>
<tr class="codeline" data-linenumber="31"><td class="num" id="LN31">31</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> ssl_check_serverhello_tlsext(SSL *s);</td></tr>
<tr class="codeline" data-linenumber="32"><td class="num" id="LN32">32</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="33"><td class="num" id="LN33">33</td><td class="line">SSL3_ENC_METHOD <span class='keyword'>const</span> TLSv1_enc_data = {</td></tr>
<tr class="codeline" data-linenumber="34"><td class="num" id="LN34">34</td><td class="line">    tls1_enc,</td></tr>
<tr class="codeline" data-linenumber="35"><td class="num" id="LN35">35</td><td class="line">    tls1_mac,</td></tr>
<tr class="codeline" data-linenumber="36"><td class="num" id="LN36">36</td><td class="line">    tls1_setup_key_block,</td></tr>
<tr class="codeline" data-linenumber="37"><td class="num" id="LN37">37</td><td class="line">    tls1_generate_master_secret,</td></tr>
<tr class="codeline" data-linenumber="38"><td class="num" id="LN38">38</td><td class="line">    tls1_change_cipher_state,</td></tr>
<tr class="codeline" data-linenumber="39"><td class="num" id="LN39">39</td><td class="line">    tls1_final_finish_mac,</td></tr>
<tr class="codeline" data-linenumber="40"><td class="num" id="LN40">40</td><td class="line">    <span class='macro'>TLS1_FINISH_MAC_LENGTH<span class='macro_popup'>12</span></span>,</td></tr>
<tr class="codeline" data-linenumber="41"><td class="num" id="LN41">41</td><td class="line">    <span class='macro'>TLS_MD_CLIENT_FINISH_CONST<span class='macro_popup'>"client finished"</span></span>, <span class='macro'>TLS_MD_CLIENT_FINISH_CONST_SIZE<span class='macro_popup'>15</span></span>,</td></tr>
<tr class="codeline" data-linenumber="42"><td class="num" id="LN42">42</td><td class="line">    <span class='macro'>TLS_MD_SERVER_FINISH_CONST<span class='macro_popup'>"server finished"</span></span>, <span class='macro'>TLS_MD_SERVER_FINISH_CONST_SIZE<span class='macro_popup'>15</span></span>,</td></tr>
<tr class="codeline" data-linenumber="43"><td class="num" id="LN43">43</td><td class="line">    tls1_alert_code,</td></tr>
<tr class="codeline" data-linenumber="44"><td class="num" id="LN44">44</td><td class="line">    tls1_export_keying_material,</td></tr>
<tr class="codeline" data-linenumber="45"><td class="num" id="LN45">45</td><td class="line">    0,</td></tr>
<tr class="codeline" data-linenumber="46"><td class="num" id="LN46">46</td><td class="line">    <span class='macro'>SSL3_HM_HEADER_LENGTH<span class='macro_popup'>4</span></span>,</td></tr>
<tr class="codeline" data-linenumber="47"><td class="num" id="LN47">47</td><td class="line">    ssl3_set_handshake_header,</td></tr>
<tr class="codeline" data-linenumber="48"><td class="num" id="LN48">48</td><td class="line">    ssl3_handshake_write</td></tr>
<tr class="codeline" data-linenumber="49"><td class="num" id="LN49">49</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="50"><td class="num" id="LN50">50</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="51"><td class="num" id="LN51">51</td><td class="line">SSL3_ENC_METHOD <span class='keyword'>const</span> TLSv1_1_enc_data = {</td></tr>
<tr class="codeline" data-linenumber="52"><td class="num" id="LN52">52</td><td class="line">    tls1_enc,</td></tr>
<tr class="codeline" data-linenumber="53"><td class="num" id="LN53">53</td><td class="line">    tls1_mac,</td></tr>
<tr class="codeline" data-linenumber="54"><td class="num" id="LN54">54</td><td class="line">    tls1_setup_key_block,</td></tr>
<tr class="codeline" data-linenumber="55"><td class="num" id="LN55">55</td><td class="line">    tls1_generate_master_secret,</td></tr>
<tr class="codeline" data-linenumber="56"><td class="num" id="LN56">56</td><td class="line">    tls1_change_cipher_state,</td></tr>
<tr class="codeline" data-linenumber="57"><td class="num" id="LN57">57</td><td class="line">    tls1_final_finish_mac,</td></tr>
<tr class="codeline" data-linenumber="58"><td class="num" id="LN58">58</td><td class="line">    <span class='macro'>TLS1_FINISH_MAC_LENGTH<span class='macro_popup'>12</span></span>,</td></tr>
<tr class="codeline" data-linenumber="59"><td class="num" id="LN59">59</td><td class="line">    <span class='macro'>TLS_MD_CLIENT_FINISH_CONST<span class='macro_popup'>"client finished"</span></span>, <span class='macro'>TLS_MD_CLIENT_FINISH_CONST_SIZE<span class='macro_popup'>15</span></span>,</td></tr>
<tr class="codeline" data-linenumber="60"><td class="num" id="LN60">60</td><td class="line">    <span class='macro'>TLS_MD_SERVER_FINISH_CONST<span class='macro_popup'>"server finished"</span></span>, <span class='macro'>TLS_MD_SERVER_FINISH_CONST_SIZE<span class='macro_popup'>15</span></span>,</td></tr>
<tr class="codeline" data-linenumber="61"><td class="num" id="LN61">61</td><td class="line">    tls1_alert_code,</td></tr>
<tr class="codeline" data-linenumber="62"><td class="num" id="LN62">62</td><td class="line">    tls1_export_keying_material,</td></tr>
<tr class="codeline" data-linenumber="63"><td class="num" id="LN63">63</td><td class="line">    <span class='macro'>SSL_ENC_FLAG_EXPLICIT_IV<span class='macro_popup'>0x1</span></span>,</td></tr>
<tr class="codeline" data-linenumber="64"><td class="num" id="LN64">64</td><td class="line">    <span class='macro'>SSL3_HM_HEADER_LENGTH<span class='macro_popup'>4</span></span>,</td></tr>
<tr class="codeline" data-linenumber="65"><td class="num" id="LN65">65</td><td class="line">    ssl3_set_handshake_header,</td></tr>
<tr class="codeline" data-linenumber="66"><td class="num" id="LN66">66</td><td class="line">    ssl3_handshake_write</td></tr>
<tr class="codeline" data-linenumber="67"><td class="num" id="LN67">67</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="68"><td class="num" id="LN68">68</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="69"><td class="num" id="LN69">69</td><td class="line">SSL3_ENC_METHOD <span class='keyword'>const</span> TLSv1_2_enc_data = {</td></tr>
<tr class="codeline" data-linenumber="70"><td class="num" id="LN70">70</td><td class="line">    tls1_enc,</td></tr>
<tr class="codeline" data-linenumber="71"><td class="num" id="LN71">71</td><td class="line">    tls1_mac,</td></tr>
<tr class="codeline" data-linenumber="72"><td class="num" id="LN72">72</td><td class="line">    tls1_setup_key_block,</td></tr>
<tr class="codeline" data-linenumber="73"><td class="num" id="LN73">73</td><td class="line">    tls1_generate_master_secret,</td></tr>
<tr class="codeline" data-linenumber="74"><td class="num" id="LN74">74</td><td class="line">    tls1_change_cipher_state,</td></tr>
<tr class="codeline" data-linenumber="75"><td class="num" id="LN75">75</td><td class="line">    tls1_final_finish_mac,</td></tr>
<tr class="codeline" data-linenumber="76"><td class="num" id="LN76">76</td><td class="line">    <span class='macro'>TLS1_FINISH_MAC_LENGTH<span class='macro_popup'>12</span></span>,</td></tr>
<tr class="codeline" data-linenumber="77"><td class="num" id="LN77">77</td><td class="line">    <span class='macro'>TLS_MD_CLIENT_FINISH_CONST<span class='macro_popup'>"client finished"</span></span>, <span class='macro'>TLS_MD_CLIENT_FINISH_CONST_SIZE<span class='macro_popup'>15</span></span>,</td></tr>
<tr class="codeline" data-linenumber="78"><td class="num" id="LN78">78</td><td class="line">    <span class='macro'>TLS_MD_SERVER_FINISH_CONST<span class='macro_popup'>"server finished"</span></span>, <span class='macro'>TLS_MD_SERVER_FINISH_CONST_SIZE<span class='macro_popup'>15</span></span>,</td></tr>
<tr class="codeline" data-linenumber="79"><td class="num" id="LN79">79</td><td class="line">    tls1_alert_code,</td></tr>
<tr class="codeline" data-linenumber="80"><td class="num" id="LN80">80</td><td class="line">    tls1_export_keying_material,</td></tr>
<tr class="codeline" data-linenumber="81"><td class="num" id="LN81">81</td><td class="line">    <span class='macro'>SSL_ENC_FLAG_EXPLICIT_IV<span class='macro_popup'>0x1</span></span> | <span class='macro'>SSL_ENC_FLAG_SIGALGS<span class='macro_popup'>0x2</span></span> | <span class='macro'>SSL_ENC_FLAG_SHA256_PRF<span class='macro_popup'>0x4</span></span></td></tr>
<tr class="codeline" data-linenumber="82"><td class="num" id="LN82">82</td><td class="line">        | <span class='macro'>SSL_ENC_FLAG_TLS1_2_CIPHERS<span class='macro_popup'>0x10</span></span>,</td></tr>
<tr class="codeline" data-linenumber="83"><td class="num" id="LN83">83</td><td class="line">    <span class='macro'>SSL3_HM_HEADER_LENGTH<span class='macro_popup'>4</span></span>,</td></tr>
<tr class="codeline" data-linenumber="84"><td class="num" id="LN84">84</td><td class="line">    ssl3_set_handshake_header,</td></tr>
<tr class="codeline" data-linenumber="85"><td class="num" id="LN85">85</td><td class="line">    ssl3_handshake_write</td></tr>
<tr class="codeline" data-linenumber="86"><td class="num" id="LN86">86</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="87"><td class="num" id="LN87">87</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="88"><td class="num" id="LN88">88</td><td class="line"><span class='keyword'>long</span> tls1_default_timeout(<span class='keyword'>void</span>)</td></tr>
<tr class="codeline" data-linenumber="89"><td class="num" id="LN89">89</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="90"><td class="num" id="LN90">90</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="91"><td class="num" id="LN91">91</td><td class="line">     <span class='comment'>* 2 hours, the 24 hours mentioned in the TLSv1 spec is way too long for</span></td></tr>
<tr class="codeline" data-linenumber="92"><td class="num" id="LN92">92</td><td class="line">     <span class='comment'>* http, the cache would over fill</span></td></tr>
<tr class="codeline" data-linenumber="93"><td class="num" id="LN93">93</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="94"><td class="num" id="LN94">94</td><td class="line">    <span class='keyword'>return</span> (60 * 60 * 2);</td></tr>
<tr class="codeline" data-linenumber="95"><td class="num" id="LN95">95</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="96"><td class="num" id="LN96">96</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="97"><td class="num" id="LN97">97</td><td class="line"><span class='keyword'>int</span> tls1_new(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="98"><td class="num" id="LN98">98</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="99"><td class="num" id="LN99">99</td><td class="line">    <span class='keyword'>if</span> (!ssl3_new(s))</td></tr>
<tr class="codeline" data-linenumber="100"><td class="num" id="LN100">100</td><td class="line">        <span class='keyword'>return</span> (0);</td></tr>
<tr class="codeline" data-linenumber="101"><td class="num" id="LN101">101</td><td class="line">    s-&gt;method-&gt;ssl_clear(s);</td></tr>
<tr class="codeline" data-linenumber="102"><td class="num" id="LN102">102</td><td class="line">    <span class='keyword'>return</span> (1);</td></tr>
<tr class="codeline" data-linenumber="103"><td class="num" id="LN103">103</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="104"><td class="num" id="LN104">104</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="105"><td class="num" id="LN105">105</td><td class="line"><span class='keyword'>void</span> tls1_free(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="106"><td class="num" id="LN106">106</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="107"><td class="num" id="LN107">107</td><td class="line">    <span class='macro'>OPENSSL_free(s-&gt;tlsext_session_ticket)<span class='macro_popup'>CRYPTO_free(s-&gt;tlsext_session_ticket, "ssl/t1_lib.c", 107)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="108"><td class="num" id="LN108">108</td><td class="line">    ssl3_free(s);</td></tr>
<tr class="codeline" data-linenumber="109"><td class="num" id="LN109">109</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="110"><td class="num" id="LN110">110</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="111"><td class="num" id="LN111">111</td><td class="line"><span class='keyword'>void</span> tls1_clear(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="112"><td class="num" id="LN112">112</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="113"><td class="num" id="LN113">113</td><td class="line">    ssl3_clear(s);</td></tr>
<tr class="codeline" data-linenumber="114"><td class="num" id="LN114">114</td><td class="line">    <span class='keyword'>if</span> (s-&gt;method-&gt;version == <span class='macro'>TLS_ANY_VERSION<span class='macro_popup'>0x10000</span></span>)</td></tr>
<tr class="codeline" data-linenumber="115"><td class="num" id="LN115">115</td><td class="line">        s-&gt;version = <span class='macro'>TLS_MAX_VERSION<span class='macro_popup'>0x0303</span></span>;</td></tr>
<tr class="codeline" data-linenumber="116"><td class="num" id="LN116">116</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="117"><td class="num" id="LN117">117</td><td class="line">        s-&gt;version = s-&gt;method-&gt;version;</td></tr>
<tr class="codeline" data-linenumber="118"><td class="num" id="LN118">118</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="119"><td class="num" id="LN119">119</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="120"><td class="num" id="LN120">120</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="121"><td class="num" id="LN121">121</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="122"><td class="num" id="LN122">122</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> {</td></tr>
<tr class="codeline" data-linenumber="123"><td class="num" id="LN123">123</td><td class="line">    <span class='keyword'>int</span> nid;                    <span class='comment'>/* Curve NID */</span></td></tr>
<tr class="codeline" data-linenumber="124"><td class="num" id="LN124">124</td><td class="line">    <span class='keyword'>int</span> secbits;                <span class='comment'>/* Bits of security (from SP800-57) */</span></td></tr>
<tr class="codeline" data-linenumber="125"><td class="num" id="LN125">125</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> flags;         <span class='comment'>/* Flags: currently just field type */</span></td></tr>
<tr class="codeline" data-linenumber="126"><td class="num" id="LN126">126</td><td class="line">} tls_curve_info;</td></tr>
<tr class="codeline" data-linenumber="127"><td class="num" id="LN127">127</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="128"><td class="num" id="LN128">128</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="129"><td class="num" id="LN129">129</td><td class="line"> <span class='comment'>* Table of curve information.</span></td></tr>
<tr class="codeline" data-linenumber="130"><td class="num" id="LN130">130</td><td class="line"> <span class='comment'>* Do not delete entries or reorder this array! It is used as a lookup</span></td></tr>
<tr class="codeline" data-linenumber="131"><td class="num" id="LN131">131</td><td class="line"> <span class='comment'>* table: the index of each entry is one less than the TLS curve id.</span></td></tr>
<tr class="codeline" data-linenumber="132"><td class="num" id="LN132">132</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="133"><td class="num" id="LN133">133</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> tls_curve_info nid_list[] = {</td></tr>
<tr class="codeline" data-linenumber="134"><td class="num" id="LN134">134</td><td class="line">    {<span class='macro'>NID_sect163k1<span class='macro_popup'>721</span></span>, 80, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect163k1 (1) */</span></td></tr>
<tr class="codeline" data-linenumber="135"><td class="num" id="LN135">135</td><td class="line">    {<span class='macro'>NID_sect163r1<span class='macro_popup'>722</span></span>, 80, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect163r1 (2) */</span></td></tr>
<tr class="codeline" data-linenumber="136"><td class="num" id="LN136">136</td><td class="line">    {<span class='macro'>NID_sect163r2<span class='macro_popup'>723</span></span>, 80, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect163r2 (3) */</span></td></tr>
<tr class="codeline" data-linenumber="137"><td class="num" id="LN137">137</td><td class="line">    {<span class='macro'>NID_sect193r1<span class='macro_popup'>724</span></span>, 80, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect193r1 (4) */</span></td></tr>
<tr class="codeline" data-linenumber="138"><td class="num" id="LN138">138</td><td class="line">    {<span class='macro'>NID_sect193r2<span class='macro_popup'>725</span></span>, 80, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect193r2 (5) */</span></td></tr>
<tr class="codeline" data-linenumber="139"><td class="num" id="LN139">139</td><td class="line">    {<span class='macro'>NID_sect233k1<span class='macro_popup'>726</span></span>, 112, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect233k1 (6) */</span></td></tr>
<tr class="codeline" data-linenumber="140"><td class="num" id="LN140">140</td><td class="line">    {<span class='macro'>NID_sect233r1<span class='macro_popup'>727</span></span>, 112, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect233r1 (7) */</span></td></tr>
<tr class="codeline" data-linenumber="141"><td class="num" id="LN141">141</td><td class="line">    {<span class='macro'>NID_sect239k1<span class='macro_popup'>728</span></span>, 112, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect239k1 (8) */</span></td></tr>
<tr class="codeline" data-linenumber="142"><td class="num" id="LN142">142</td><td class="line">    {<span class='macro'>NID_sect283k1<span class='macro_popup'>729</span></span>, 128, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect283k1 (9) */</span></td></tr>
<tr class="codeline" data-linenumber="143"><td class="num" id="LN143">143</td><td class="line">    {<span class='macro'>NID_sect283r1<span class='macro_popup'>730</span></span>, 128, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect283r1 (10) */</span></td></tr>
<tr class="codeline" data-linenumber="144"><td class="num" id="LN144">144</td><td class="line">    {<span class='macro'>NID_sect409k1<span class='macro_popup'>731</span></span>, 192, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect409k1 (11) */</span></td></tr>
<tr class="codeline" data-linenumber="145"><td class="num" id="LN145">145</td><td class="line">    {<span class='macro'>NID_sect409r1<span class='macro_popup'>732</span></span>, 192, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect409r1 (12) */</span></td></tr>
<tr class="codeline" data-linenumber="146"><td class="num" id="LN146">146</td><td class="line">    {<span class='macro'>NID_sect571k1<span class='macro_popup'>733</span></span>, 256, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect571k1 (13) */</span></td></tr>
<tr class="codeline" data-linenumber="147"><td class="num" id="LN147">147</td><td class="line">    {<span class='macro'>NID_sect571r1<span class='macro_popup'>734</span></span>, 256, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect571r1 (14) */</span></td></tr>
<tr class="codeline" data-linenumber="148"><td class="num" id="LN148">148</td><td class="line">    {<span class='macro'>NID_secp160k1<span class='macro_popup'>708</span></span>, 80, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* secp160k1 (15) */</span></td></tr>
<tr class="codeline" data-linenumber="149"><td class="num" id="LN149">149</td><td class="line">    {<span class='macro'>NID_secp160r1<span class='macro_popup'>709</span></span>, 80, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* secp160r1 (16) */</span></td></tr>
<tr class="codeline" data-linenumber="150"><td class="num" id="LN150">150</td><td class="line">    {<span class='macro'>NID_secp160r2<span class='macro_popup'>710</span></span>, 80, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* secp160r2 (17) */</span></td></tr>
<tr class="codeline" data-linenumber="151"><td class="num" id="LN151">151</td><td class="line">    {<span class='macro'>NID_secp192k1<span class='macro_popup'>711</span></span>, 80, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* secp192k1 (18) */</span></td></tr>
<tr class="codeline" data-linenumber="152"><td class="num" id="LN152">152</td><td class="line">    {<span class='macro'>NID_X9_62_prime192v1<span class='macro_popup'>409</span></span>, 80, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* secp192r1 (19) */</span></td></tr>
<tr class="codeline" data-linenumber="153"><td class="num" id="LN153">153</td><td class="line">    {<span class='macro'>NID_secp224k1<span class='macro_popup'>712</span></span>, 112, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* secp224k1 (20) */</span></td></tr>
<tr class="codeline" data-linenumber="154"><td class="num" id="LN154">154</td><td class="line">    {<span class='macro'>NID_secp224r1<span class='macro_popup'>713</span></span>, 112, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* secp224r1 (21) */</span></td></tr>
<tr class="codeline" data-linenumber="155"><td class="num" id="LN155">155</td><td class="line">    {<span class='macro'>NID_secp256k1<span class='macro_popup'>714</span></span>, 128, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* secp256k1 (22) */</span></td></tr>
<tr class="codeline" data-linenumber="156"><td class="num" id="LN156">156</td><td class="line">    {<span class='macro'>NID_X9_62_prime256v1<span class='macro_popup'>415</span></span>, 128, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* secp256r1 (23) */</span></td></tr>
<tr class="codeline" data-linenumber="157"><td class="num" id="LN157">157</td><td class="line">    {<span class='macro'>NID_secp384r1<span class='macro_popup'>715</span></span>, 192, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* secp384r1 (24) */</span></td></tr>
<tr class="codeline" data-linenumber="158"><td class="num" id="LN158">158</td><td class="line">    {<span class='macro'>NID_secp521r1<span class='macro_popup'>716</span></span>, 256, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* secp521r1 (25) */</span></td></tr>
<tr class="codeline" data-linenumber="159"><td class="num" id="LN159">159</td><td class="line">    {<span class='macro'>NID_brainpoolP256r1<span class='macro_popup'>927</span></span>, 128, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* brainpoolP256r1 (26) */</span></td></tr>
<tr class="codeline" data-linenumber="160"><td class="num" id="LN160">160</td><td class="line">    {<span class='macro'>NID_brainpoolP384r1<span class='macro_popup'>931</span></span>, 192, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* brainpoolP384r1 (27) */</span></td></tr>
<tr class="codeline" data-linenumber="161"><td class="num" id="LN161">161</td><td class="line">    {<span class='macro'>NID_brainpoolP512r1<span class='macro_popup'>933</span></span>, 256, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* brainpool512r1 (28) */</span></td></tr>
<tr class="codeline" data-linenumber="162"><td class="num" id="LN162">162</td><td class="line">    {<span class='macro'>NID_X25519<span class='macro_popup'>1034</span></span>, 128, <span class='macro'>TLS_CURVE_CUSTOM<span class='macro_popup'>0x2</span></span>}, <span class='comment'>/* X25519 (29) */</span></td></tr>
<tr class="codeline" data-linenumber="163"><td class="num" id="LN163">163</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="164"><td class="num" id="LN164">164</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="165"><td class="num" id="LN165">165</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> ecformats_default[] = {</td></tr>
<tr class="codeline" data-linenumber="166"><td class="num" id="LN166">166</td><td class="line">    <span class='macro'>TLSEXT_ECPOINTFORMAT_uncompressed<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="167"><td class="num" id="LN167">167</td><td class="line">    <span class='macro'>TLSEXT_ECPOINTFORMAT_ansiX962_compressed_prime<span class='macro_popup'>1</span></span>,</td></tr>
<tr class="codeline" data-linenumber="168"><td class="num" id="LN168">168</td><td class="line">    <span class='macro'>TLSEXT_ECPOINTFORMAT_ansiX962_compressed_char2<span class='macro_popup'>2</span></span></td></tr>
<tr class="codeline" data-linenumber="169"><td class="num" id="LN169">169</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="170"><td class="num" id="LN170">170</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="171"><td class="num" id="LN171">171</td><td class="line"><span class='comment'>/* The default curves */</span></td></tr>
<tr class="codeline" data-linenumber="172"><td class="num" id="LN172">172</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> eccurves_default[] = {</td></tr>
<tr class="codeline" data-linenumber="173"><td class="num" id="LN173">173</td><td class="line">    0, 29,                      <span class='comment'>/* X25519 (29) */</span></td></tr>
<tr class="codeline" data-linenumber="174"><td class="num" id="LN174">174</td><td class="line">    0, 23,                      <span class='comment'>/* secp256r1 (23) */</span></td></tr>
<tr class="codeline" data-linenumber="175"><td class="num" id="LN175">175</td><td class="line">    0, 25,                      <span class='comment'>/* secp521r1 (25) */</span></td></tr>
<tr class="codeline" data-linenumber="176"><td class="num" id="LN176">176</td><td class="line">    0, 24,                      <span class='comment'>/* secp384r1 (24) */</span></td></tr>
<tr class="codeline" data-linenumber="177"><td class="num" id="LN177">177</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="178"><td class="num" id="LN178">178</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="179"><td class="num" id="LN179">179</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> suiteb_curves[] = {</td></tr>
<tr class="codeline" data-linenumber="180"><td class="num" id="LN180">180</td><td class="line">    0, <span class='macro'>TLSEXT_curve_P_256<span class='macro_popup'>23</span></span>,</td></tr>
<tr class="codeline" data-linenumber="181"><td class="num" id="LN181">181</td><td class="line">    0, <span class='macro'>TLSEXT_curve_P_384<span class='macro_popup'>24</span></span></td></tr>
<tr class="codeline" data-linenumber="182"><td class="num" id="LN182">182</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="183"><td class="num" id="LN183">183</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="184"><td class="num" id="LN184">184</td><td class="line"><span class='keyword'>int</span> tls1_ec_curve_id2nid(<span class='keyword'>int</span> curve_id, <span class='keyword'>unsigned</span> <span class='keyword'>int</span> *pflags)</td></tr>
<tr class="codeline" data-linenumber="185"><td class="num" id="LN185">185</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="186"><td class="num" id="LN186">186</td><td class="line">    <span class='keyword'>const</span> tls_curve_info *cinfo;</td></tr>
<tr class="codeline" data-linenumber="187"><td class="num" id="LN187">187</td><td class="line">    <span class='comment'>/* ECC curves from RFC 4492 and RFC 7027 */</span></td></tr>
<tr class="codeline" data-linenumber="188"><td class="num" id="LN188">188</td><td class="line">    <span class='keyword'>if</span> ((curve_id &lt; 1) || ((<span class='keyword'>unsigned</span> <span class='keyword'>int</span>)curve_id &gt; <span class='macro'>OSSL_NELEM(nid_list)<span class='macro_popup'>(sizeof(nid_list)/sizeof((nid_list)[0]))</span></span>))</td></tr>
<tr class="codeline" data-linenumber="189"><td class="num" id="LN189">189</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="190"><td class="num" id="LN190">190</td><td class="line">    cinfo = nid_list + curve_id - 1;</td></tr>
<tr class="codeline" data-linenumber="191"><td class="num" id="LN191">191</td><td class="line">    <span class='keyword'>if</span> (pflags)</td></tr>
<tr class="codeline" data-linenumber="192"><td class="num" id="LN192">192</td><td class="line">        *pflags = cinfo-&gt;flags;</td></tr>
<tr class="codeline" data-linenumber="193"><td class="num" id="LN193">193</td><td class="line">    <span class='keyword'>return</span> cinfo-&gt;nid;</td></tr>
<tr class="codeline" data-linenumber="194"><td class="num" id="LN194">194</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="195"><td class="num" id="LN195">195</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="196"><td class="num" id="LN196">196</td><td class="line"><span class='keyword'>int</span> tls1_ec_nid2curve_id(<span class='keyword'>int</span> nid)</td></tr>
<tr class="codeline" data-linenumber="197"><td class="num" id="LN197">197</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="198"><td class="num" id="LN198">198</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="199"><td class="num" id="LN199">199</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; <span class='macro'>OSSL_NELEM(nid_list)<span class='macro_popup'>(sizeof(nid_list)/sizeof((nid_list)[0]))</span></span>; i++) {</td></tr>
<tr class="codeline" data-linenumber="200"><td class="num" id="LN200">200</td><td class="line">        <span class='keyword'>if</span> (nid_list[i].nid == nid)</td></tr>
<tr class="codeline" data-linenumber="201"><td class="num" id="LN201">201</td><td class="line">            <span class='keyword'>return</span> i + 1;</td></tr>
<tr class="codeline" data-linenumber="202"><td class="num" id="LN202">202</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="203"><td class="num" id="LN203">203</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="204"><td class="num" id="LN204">204</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="205"><td class="num" id="LN205">205</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="206"><td class="num" id="LN206">206</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="207"><td class="num" id="LN207">207</td><td class="line"> <span class='comment'>* Get curves list, if "sess" is set return client curves otherwise</span></td></tr>
<tr class="codeline" data-linenumber="208"><td class="num" id="LN208">208</td><td class="line"> <span class='comment'>* preferred list.</span></td></tr>
<tr class="codeline" data-linenumber="209"><td class="num" id="LN209">209</td><td class="line"> <span class='comment'>* Sets |num_curves| to the number of curves in the list, i.e.,</span></td></tr>
<tr class="codeline" data-linenumber="210"><td class="num" id="LN210">210</td><td class="line"> <span class='comment'>* the length of |pcurves| is 2 * num_curves.</span></td></tr>
<tr class="codeline" data-linenumber="211"><td class="num" id="LN211">211</td><td class="line"> <span class='comment'>* Returns 1 on success and 0 if the client curves list has invalid format.</span></td></tr>
<tr class="codeline" data-linenumber="212"><td class="num" id="LN212">212</td><td class="line"> <span class='comment'>* The latter indicates an internal error: we should not be accepting such</span></td></tr>
<tr class="codeline" data-linenumber="213"><td class="num" id="LN213">213</td><td class="line"> <span class='comment'>* lists in the first place.</span></td></tr>
<tr class="codeline" data-linenumber="214"><td class="num" id="LN214">214</td><td class="line"> <span class='comment'>* TODO(emilia): we should really be storing the curves list in explicitly</span></td></tr>
<tr class="codeline" data-linenumber="215"><td class="num" id="LN215">215</td><td class="line"> <span class='comment'>* parsed form instead. (However, this would affect binary compatibility</span></td></tr>
<tr class="codeline" data-linenumber="216"><td class="num" id="LN216">216</td><td class="line"> <span class='comment'>* so cannot happen in the 1.0.x series.)</span></td></tr>
<tr class="codeline" data-linenumber="217"><td class="num" id="LN217">217</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="218"><td class="num" id="LN218">218</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls1_get_curvelist(SSL *s, <span class='keyword'>int</span> sess,</td></tr>
<tr class="codeline" data-linenumber="219"><td class="num" id="LN219">219</td><td class="line">                              <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> **pcurves, size_t *num_curves)</td></tr>
<tr class="codeline" data-linenumber="220"><td class="num" id="LN220">220</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="221"><td class="num" id="LN221">221</td><td class="line">    size_t pcurveslen = 0;</td></tr>
<tr class="codeline" data-linenumber="222"><td class="num" id="LN222">222</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="223"><td class="num" id="LN223">223</td><td class="line">    <span class='keyword'>if</span> (sess) {</td></tr>
<tr class="codeline" data-linenumber="224"><td class="num" id="LN224">224</td><td class="line">        *pcurves = s-&gt;session-&gt;tlsext_ellipticcurvelist;</td></tr>
<tr class="codeline" data-linenumber="225"><td class="num" id="LN225">225</td><td class="line">        pcurveslen = s-&gt;session-&gt;tlsext_ellipticcurvelist_length;</td></tr>
<tr class="codeline" data-linenumber="226"><td class="num" id="LN226">226</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="227"><td class="num" id="LN227">227</td><td class="line">        <span class='comment'>/* For Suite B mode only include P-256, P-384 */</span></td></tr>
<tr class="codeline" data-linenumber="228"><td class="num" id="LN228">228</td><td class="line">        <span class='keyword'>switch</span> (<span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="229"><td class="num" id="LN229">229</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>SSL_CERT_FLAG_SUITEB_128_LOS<span class='macro_popup'>0x30000</span></span>:</td></tr>
<tr class="codeline" data-linenumber="230"><td class="num" id="LN230">230</td><td class="line">            *pcurves = suiteb_curves;</td></tr>
<tr class="codeline" data-linenumber="231"><td class="num" id="LN231">231</td><td class="line">            pcurveslen = <span class='keyword'>sizeof</span>(suiteb_curves);</td></tr>
<tr class="codeline" data-linenumber="232"><td class="num" id="LN232">232</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="233"><td class="num" id="LN233">233</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="234"><td class="num" id="LN234">234</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>SSL_CERT_FLAG_SUITEB_128_LOS_ONLY<span class='macro_popup'>0x10000</span></span>:</td></tr>
<tr class="codeline" data-linenumber="235"><td class="num" id="LN235">235</td><td class="line">            *pcurves = suiteb_curves;</td></tr>
<tr class="codeline" data-linenumber="236"><td class="num" id="LN236">236</td><td class="line">            pcurveslen = 2;</td></tr>
<tr class="codeline" data-linenumber="237"><td class="num" id="LN237">237</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="238"><td class="num" id="LN238">238</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="239"><td class="num" id="LN239">239</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>SSL_CERT_FLAG_SUITEB_192_LOS<span class='macro_popup'>0x20000</span></span>:</td></tr>
<tr class="codeline" data-linenumber="240"><td class="num" id="LN240">240</td><td class="line">            *pcurves = suiteb_curves + 2;</td></tr>
<tr class="codeline" data-linenumber="241"><td class="num" id="LN241">241</td><td class="line">            pcurveslen = 2;</td></tr>
<tr class="codeline" data-linenumber="242"><td class="num" id="LN242">242</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="243"><td class="num" id="LN243">243</td><td class="line">        <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="244"><td class="num" id="LN244">244</td><td class="line">            *pcurves = s-&gt;tlsext_ellipticcurvelist;</td></tr>
<tr class="codeline" data-linenumber="245"><td class="num" id="LN245">245</td><td class="line">            pcurveslen = s-&gt;tlsext_ellipticcurvelist_length;</td></tr>
<tr class="codeline" data-linenumber="246"><td class="num" id="LN246">246</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="247"><td class="num" id="LN247">247</td><td class="line">        <span class='keyword'>if</span> (!*pcurves) {</td></tr>
<tr class="codeline" data-linenumber="248"><td class="num" id="LN248">248</td><td class="line">            *pcurves = eccurves_default;</td></tr>
<tr class="codeline" data-linenumber="249"><td class="num" id="LN249">249</td><td class="line">            pcurveslen = <span class='keyword'>sizeof</span>(eccurves_default);</td></tr>
<tr class="codeline" data-linenumber="250"><td class="num" id="LN250">250</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="251"><td class="num" id="LN251">251</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="252"><td class="num" id="LN252">252</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="253"><td class="num" id="LN253">253</td><td class="line">    <span class='comment'>/* We do not allow odd length arrays to enter the system. */</span></td></tr>
<tr class="codeline" data-linenumber="254"><td class="num" id="LN254">254</td><td class="line">    <span class='keyword'>if</span> (pcurveslen &amp; 1) {</td></tr>
<tr class="codeline" data-linenumber="255"><td class="num" id="LN255">255</td><td class="line">        <span class='macro'>SSLerr(SSL_F_TLS1_GET_CURVELIST, ERR_R_INTERNAL_ERROR)<span class='macro_popup'>ERR_put_error(20,(338),((4|64)),"ssl/t1_lib.c",255)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="256"><td class="num" id="LN256">256</td><td class="line">        *num_curves = 0;</td></tr>
<tr class="codeline" data-linenumber="257"><td class="num" id="LN257">257</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="258"><td class="num" id="LN258">258</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="259"><td class="num" id="LN259">259</td><td class="line">    *num_curves = pcurveslen / 2;</td></tr>
<tr class="codeline" data-linenumber="260"><td class="num" id="LN260">260</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="261"><td class="num" id="LN261">261</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="262"><td class="num" id="LN262">262</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="263"><td class="num" id="LN263">263</td><td class="line"><span class='comment'>/* See if curve is allowed by security callback */</span></td></tr>
<tr class="codeline" data-linenumber="264"><td class="num" id="LN264">264</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls_curve_allowed(SSL *s, <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *curve, <span class='keyword'>int</span> op)</td></tr>
<tr class="codeline" data-linenumber="265"><td class="num" id="LN265">265</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="266"><td class="num" id="LN266">266</td><td class="line">    <span class='keyword'>const</span> tls_curve_info *cinfo;</td></tr>
<tr class="codeline" data-linenumber="267"><td class="num" id="LN267">267</td><td class="line">    <span class='keyword'>if</span> (curve[0])</td></tr>
<tr class="codeline" data-linenumber="268"><td class="num" id="LN268">268</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="269"><td class="num" id="LN269">269</td><td class="line">    <span class='keyword'>if</span> ((curve[1] &lt; 1) || ((size_t)curve[1] &gt; <span class='macro'>OSSL_NELEM(nid_list)<span class='macro_popup'>(sizeof(nid_list)/sizeof((nid_list)[0]))</span></span>))</td></tr>
<tr class="codeline" data-linenumber="270"><td class="num" id="LN270">270</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="271"><td class="num" id="LN271">271</td><td class="line">    cinfo = &amp;nid_list[curve[1] - 1];</td></tr>
<tr class="codeline" data-linenumber="272"><td class="num" id="LN272">272</td><td class="line"><span class='directive'># ifdef OPENSSL_NO_EC2M</span></td></tr>
<tr class="codeline" data-linenumber="273"><td class="num" id="LN273">273</td><td class="line">    <span class='keyword'>if</span> (cinfo-&gt;flags &amp; <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="274"><td class="num" id="LN274">274</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="275"><td class="num" id="LN275">275</td><td class="line"><span class='directive'># endif</span></td></tr>
<tr class="codeline" data-linenumber="276"><td class="num" id="LN276">276</td><td class="line">    <span class='keyword'>return</span> ssl_security(s, op, cinfo-&gt;secbits, cinfo-&gt;nid, (<span class='keyword'>void</span> *)curve);</td></tr>
<tr class="codeline" data-linenumber="277"><td class="num" id="LN277">277</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="278"><td class="num" id="LN278">278</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="279"><td class="num" id="LN279">279</td><td class="line"><span class='comment'>/* Check a curve is one of our preferences */</span></td></tr>
<tr class="codeline" data-linenumber="280"><td class="num" id="LN280">280</td><td class="line"><span class='keyword'>int</span> tls1_check_curve(SSL *s, <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p, size_t len)</td></tr>
<tr class="codeline" data-linenumber="281"><td class="num" id="LN281">281</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="282"><td class="num" id="LN282">282</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *curves;</td></tr>
<tr class="codeline" data-linenumber="283"><td class="num" id="LN283">283</td><td class="line">    size_t num_curves, i;</td></tr>
<tr class="codeline" data-linenumber="284"><td class="num" id="LN284">284</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> suiteb_flags = <span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="285"><td class="num" id="LN285">285</td><td class="line">    <span class='keyword'>if</span> (len != 3 || p[0] != <span class='macro'>NAMED_CURVE_TYPE<span class='macro_popup'>3</span></span>)</td></tr>
<tr class="codeline" data-linenumber="286"><td class="num" id="LN286">286</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="287"><td class="num" id="LN287">287</td><td class="line">    <span class='comment'>/* Check curve matches Suite B preferences */</span></td></tr>
<tr class="codeline" data-linenumber="288"><td class="num" id="LN288">288</td><td class="line">    <span class='keyword'>if</span> (suiteb_flags) {</td></tr>
<tr class="codeline" data-linenumber="289"><td class="num" id="LN289">289</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>long</span> cid = s-&gt;s3-&gt;tmp.new_cipher-&gt;id;</td></tr>
<tr class="codeline" data-linenumber="290"><td class="num" id="LN290">290</td><td class="line">        <span class='keyword'>if</span> (p[1])</td></tr>
<tr class="codeline" data-linenumber="291"><td class="num" id="LN291">291</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="292"><td class="num" id="LN292">292</td><td class="line">        <span class='keyword'>if</span> (cid == <span class='macro'>TLS1_CK_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256<span class='macro_popup'>0x0300C02B</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="293"><td class="num" id="LN293">293</td><td class="line">            <span class='keyword'>if</span> (p[2] != <span class='macro'>TLSEXT_curve_P_256<span class='macro_popup'>23</span></span>)</td></tr>
<tr class="codeline" data-linenumber="294"><td class="num" id="LN294">294</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="295"><td class="num" id="LN295">295</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (cid == <span class='macro'>TLS1_CK_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384<span class='macro_popup'>0x0300C02C</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="296"><td class="num" id="LN296">296</td><td class="line">            <span class='keyword'>if</span> (p[2] != <span class='macro'>TLSEXT_curve_P_384<span class='macro_popup'>24</span></span>)</td></tr>
<tr class="codeline" data-linenumber="297"><td class="num" id="LN297">297</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="298"><td class="num" id="LN298">298</td><td class="line">        } <span class='keyword'>else</span>                  <span class='comment'>/* Should never happen */</span></td></tr>
<tr class="codeline" data-linenumber="299"><td class="num" id="LN299">299</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="300"><td class="num" id="LN300">300</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="301"><td class="num" id="LN301">301</td><td class="line">    <span class='keyword'>if</span> (!tls1_get_curvelist(s, 0, &amp;curves, &amp;num_curves))</td></tr>
<tr class="codeline" data-linenumber="302"><td class="num" id="LN302">302</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="303"><td class="num" id="LN303">303</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; num_curves; i++, curves += 2) {</td></tr>
<tr class="codeline" data-linenumber="304"><td class="num" id="LN304">304</td><td class="line">        <span class='keyword'>if</span> (p[1] == curves[0] &amp;&amp; p[2] == curves[1])</td></tr>
<tr class="codeline" data-linenumber="305"><td class="num" id="LN305">305</td><td class="line">            <span class='keyword'>return</span> tls_curve_allowed(s, p + 1, <span class='macro'>SSL_SECOP_CURVE_CHECK<span class='macro_popup'>(6 | (2 &lt;&lt; 16))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="306"><td class="num" id="LN306">306</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="307"><td class="num" id="LN307">307</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="308"><td class="num" id="LN308">308</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="309"><td class="num" id="LN309">309</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="310"><td class="num" id="LN310">310</td><td class="line"><span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="311"><td class="num" id="LN311">311</td><td class="line"> <span class='comment'>* For nmatch &gt;= 0, return the NID of the |nmatch|th shared curve or NID_undef</span></td></tr>
<tr class="codeline" data-linenumber="312"><td class="num" id="LN312">312</td><td class="line"> <span class='comment'>* if there is no match.</span></td></tr>
<tr class="codeline" data-linenumber="313"><td class="num" id="LN313">313</td><td class="line"> <span class='comment'>* For nmatch == -1, return number of matches</span></td></tr>
<tr class="codeline" data-linenumber="314"><td class="num" id="LN314">314</td><td class="line"> <span class='comment'>* For nmatch == -2, return the NID of the curve to use for</span></td></tr>
<tr class="codeline" data-linenumber="315"><td class="num" id="LN315">315</td><td class="line"> <span class='comment'>* an EC tmp key, or NID_undef if there is no match.</span></td></tr>
<tr class="codeline" data-linenumber="316"><td class="num" id="LN316">316</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="317"><td class="num" id="LN317">317</td><td class="line"><span class='keyword'>int</span> tls1_shared_curve(SSL *s, <span class='keyword'>int</span> nmatch)</td></tr>
<tr class="codeline" data-linenumber="318"><td class="num" id="LN318">318</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="319"><td class="num" id="LN319">319</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *pref, *supp;</td></tr>
<tr class="codeline" data-linenumber="320"><td class="num" id="LN320">320</td><td class="line">    size_t num_pref, num_supp, i, j;</td></tr>
<tr class="codeline" data-linenumber="321"><td class="num" id="LN321">321</td><td class="line">    <span class='keyword'>int</span> k;</td></tr>
<tr class="codeline" data-linenumber="322"><td class="num" id="LN322">322</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="323"><td class="num" id="LN323">323</td><td class="line">    <span class='comment'>/* Can't do anything on client side */</span></td></tr>
<tr class="codeline" data-linenumber="324"><td class="num" id="LN324">324</td><td class="line">    <span class='keyword'>if</span> (s-&gt;server == 0)</td></tr>
<tr class="codeline" data-linenumber="325"><td class="num" id="LN325">325</td><td class="line">        <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="326"><td class="num" id="LN326">326</td><td class="line">    <span class='keyword'>if</span> (nmatch == -2) {</td></tr>
<tr class="codeline" data-linenumber="327"><td class="num" id="LN327">327</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="328"><td class="num" id="LN328">328</td><td class="line">            <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="329"><td class="num" id="LN329">329</td><td class="line">             <span class='comment'>* For Suite B ciphersuite determines curve: we already know</span></td></tr>
<tr class="codeline" data-linenumber="330"><td class="num" id="LN330">330</td><td class="line">             <span class='comment'>* these are acceptable due to previous checks.</span></td></tr>
<tr class="codeline" data-linenumber="331"><td class="num" id="LN331">331</td><td class="line">             <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="332"><td class="num" id="LN332">332</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>long</span> cid = s-&gt;s3-&gt;tmp.new_cipher-&gt;id;</td></tr>
<tr class="codeline" data-linenumber="333"><td class="num" id="LN333">333</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="334"><td class="num" id="LN334">334</td><td class="line">            <span class='keyword'>if</span> (cid == <span class='macro'>TLS1_CK_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256<span class='macro_popup'>0x0300C02B</span></span>)</td></tr>
<tr class="codeline" data-linenumber="335"><td class="num" id="LN335">335</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>NID_X9_62_prime256v1<span class='macro_popup'>415</span></span>; <span class='comment'>/* P-256 */</span></td></tr>
<tr class="codeline" data-linenumber="336"><td class="num" id="LN336">336</td><td class="line">            <span class='keyword'>if</span> (cid == <span class='macro'>TLS1_CK_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384<span class='macro_popup'>0x0300C02C</span></span>)</td></tr>
<tr class="codeline" data-linenumber="337"><td class="num" id="LN337">337</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>NID_secp384r1<span class='macro_popup'>715</span></span>; <span class='comment'>/* P-384 */</span></td></tr>
<tr class="codeline" data-linenumber="338"><td class="num" id="LN338">338</td><td class="line">            <span class='comment'>/* Should never happen */</span></td></tr>
<tr class="codeline" data-linenumber="339"><td class="num" id="LN339">339</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="340"><td class="num" id="LN340">340</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="341"><td class="num" id="LN341">341</td><td class="line">        <span class='comment'>/* If not Suite B just return first preference shared curve */</span></td></tr>
<tr class="codeline" data-linenumber="342"><td class="num" id="LN342">342</td><td class="line">        nmatch = 0;</td></tr>
<tr class="codeline" data-linenumber="343"><td class="num" id="LN343">343</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="344"><td class="num" id="LN344">344</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="345"><td class="num" id="LN345">345</td><td class="line">     <span class='comment'>* Avoid truncation. tls1_get_curvelist takes an int</span></td></tr>
<tr class="codeline" data-linenumber="346"><td class="num" id="LN346">346</td><td class="line">     <span class='comment'>* but s-&gt;options is a long...</span></td></tr>
<tr class="codeline" data-linenumber="347"><td class="num" id="LN347">347</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="348"><td class="num" id="LN348">348</td><td class="line">    <span class='keyword'>if</span> (!tls1_get_curvelist(s,</td></tr>
<tr class="codeline" data-linenumber="349"><td class="num" id="LN349">349</td><td class="line">            (s-&gt;options &amp; <span class='macro'>SSL_OP_CIPHER_SERVER_PREFERENCE<span class='macro_popup'>0x00400000U</span></span>) != 0,</td></tr>
<tr class="codeline" data-linenumber="350"><td class="num" id="LN350">350</td><td class="line">            &amp;supp, &amp;num_supp))</td></tr>
<tr class="codeline" data-linenumber="351"><td class="num" id="LN351">351</td><td class="line">        <span class='comment'>/* In practice, NID_undef == 0 but let's be precise. */</span></td></tr>
<tr class="codeline" data-linenumber="352"><td class="num" id="LN352">352</td><td class="line">        <span class='keyword'>return</span> nmatch == -1 ? 0 : <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="353"><td class="num" id="LN353">353</td><td class="line">    <span class='keyword'>if</span> (!tls1_get_curvelist(s,</td></tr>
<tr class="codeline" data-linenumber="354"><td class="num" id="LN354">354</td><td class="line">            (s-&gt;options &amp; <span class='macro'>SSL_OP_CIPHER_SERVER_PREFERENCE<span class='macro_popup'>0x00400000U</span></span>) == 0,</td></tr>
<tr class="codeline" data-linenumber="355"><td class="num" id="LN355">355</td><td class="line">            &amp;pref, &amp;num_pref))</td></tr>
<tr class="codeline" data-linenumber="356"><td class="num" id="LN356">356</td><td class="line">        <span class='keyword'>return</span> nmatch == -1 ? 0 : <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="357"><td class="num" id="LN357">357</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="358"><td class="num" id="LN358">358</td><td class="line">    <span class='keyword'>for</span> (k = 0, i = 0; i &lt; num_pref; i++, pref += 2) {</td></tr>
<tr class="codeline" data-linenumber="359"><td class="num" id="LN359">359</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *tsupp = supp;</td></tr>
<tr class="codeline" data-linenumber="360"><td class="num" id="LN360">360</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="361"><td class="num" id="LN361">361</td><td class="line">        <span class='keyword'>for</span> (j = 0; j &lt; num_supp; j++, tsupp += 2) {</td></tr>
<tr class="codeline" data-linenumber="362"><td class="num" id="LN362">362</td><td class="line">            <span class='keyword'>if</span> (pref[0] == tsupp[0] &amp;&amp; pref[1] == tsupp[1]) {</td></tr>
<tr class="codeline" data-linenumber="363"><td class="num" id="LN363">363</td><td class="line">                <span class='keyword'>if</span> (!tls_curve_allowed(s, pref, <span class='macro'>SSL_SECOP_CURVE_SHARED<span class='macro_popup'>(5 | (2 &lt;&lt; 16))</span></span>))</td></tr>
<tr class="codeline" data-linenumber="364"><td class="num" id="LN364">364</td><td class="line">                    <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="365"><td class="num" id="LN365">365</td><td class="line">                <span class='keyword'>if</span> (nmatch == k) {</td></tr>
<tr class="codeline" data-linenumber="366"><td class="num" id="LN366">366</td><td class="line">                    <span class='keyword'>int</span> id = (pref[0] &lt;&lt; 8) | pref[1];</td></tr>
<tr class="codeline" data-linenumber="367"><td class="num" id="LN367">367</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="368"><td class="num" id="LN368">368</td><td class="line">                    <span class='keyword'>return</span> tls1_ec_curve_id2nid(id, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="369"><td class="num" id="LN369">369</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="370"><td class="num" id="LN370">370</td><td class="line">                k++;</td></tr>
<tr class="codeline" data-linenumber="371"><td class="num" id="LN371">371</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="372"><td class="num" id="LN372">372</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="373"><td class="num" id="LN373">373</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="374"><td class="num" id="LN374">374</td><td class="line">    <span class='keyword'>if</span> (nmatch == -1)</td></tr>
<tr class="codeline" data-linenumber="375"><td class="num" id="LN375">375</td><td class="line">        <span class='keyword'>return</span> k;</td></tr>
<tr class="codeline" data-linenumber="376"><td class="num" id="LN376">376</td><td class="line">    <span class='comment'>/* Out of range (nmatch &gt; k). */</span></td></tr>
<tr class="codeline" data-linenumber="377"><td class="num" id="LN377">377</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="378"><td class="num" id="LN378">378</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="379"><td class="num" id="LN379">379</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="380"><td class="num" id="LN380">380</td><td class="line"><span class='keyword'>int</span> tls1_set_curves(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> **pext, size_t *pextlen,</td></tr>
<tr class="codeline" data-linenumber="381"><td class="num" id="LN381">381</td><td class="line">                    <span class='keyword'>int</span> *curves, size_t ncurves)</td></tr>
<tr class="codeline" data-linenumber="382"><td class="num" id="LN382">382</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="383"><td class="num" id="LN383">383</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *clist, *p;</td></tr>
<tr class="codeline" data-linenumber="384"><td class="num" id="LN384">384</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="385"><td class="num" id="LN385">385</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="386"><td class="num" id="LN386">386</td><td class="line">     <span class='comment'>* Bitmap of curves included to detect duplicates: only works while curve</span></td></tr>
<tr class="codeline" data-linenumber="387"><td class="num" id="LN387">387</td><td class="line">     <span class='comment'>* ids &lt; 32</span></td></tr>
<tr class="codeline" data-linenumber="388"><td class="num" id="LN388">388</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="389"><td class="num" id="LN389">389</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> dup_list = 0;</td></tr>
<tr class="codeline" data-linenumber="390"><td class="num" id="LN390">390</td><td class="line">    clist = <span class='macro'>OPENSSL_malloc(ncurves * 2)<span class='macro_popup'>CRYPTO_malloc(ncurves * 2, "ssl/t1_lib.c", 390)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="391"><td class="num" id="LN391">391</td><td class="line">    <span class='keyword'>if</span> (clist == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="392"><td class="num" id="LN392">392</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="393"><td class="num" id="LN393">393</td><td class="line">    <span class='keyword'>for</span> (i = 0, p = clist; i &lt; ncurves; i++) {</td></tr>
<tr class="codeline" data-linenumber="394"><td class="num" id="LN394">394</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>long</span> idmask;</td></tr>
<tr class="codeline" data-linenumber="395"><td class="num" id="LN395">395</td><td class="line">        <span class='keyword'>int</span> id;</td></tr>
<tr class="codeline" data-linenumber="396"><td class="num" id="LN396">396</td><td class="line">        id = tls1_ec_nid2curve_id(curves[i]);</td></tr>
<tr class="codeline" data-linenumber="397"><td class="num" id="LN397">397</td><td class="line">        idmask = 1L &lt;&lt; id;</td></tr>
<tr class="codeline" data-linenumber="398"><td class="num" id="LN398">398</td><td class="line">        <span class='keyword'>if</span> (!id || (dup_list &amp; idmask)) {</td></tr>
<tr class="codeline" data-linenumber="399"><td class="num" id="LN399">399</td><td class="line">            <span class='macro'>OPENSSL_free(clist)<span class='macro_popup'>CRYPTO_free(clist, "ssl/t1_lib.c", 399)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="400"><td class="num" id="LN400">400</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="401"><td class="num" id="LN401">401</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="402"><td class="num" id="LN402">402</td><td class="line">        dup_list |= idmask;</td></tr>
<tr class="codeline" data-linenumber="403"><td class="num" id="LN403">403</td><td class="line">        <span class='macro'>s2n(id, p)<span class='macro_popup'>(((p)[0]=(unsigned char)(((id)&gt;&gt; 8)&amp;0xff), (p)[1]=(<br>unsigned char)(((id) )&amp;0xff)),(p)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="404"><td class="num" id="LN404">404</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="405"><td class="num" id="LN405">405</td><td class="line">    <span class='macro'>OPENSSL_free(*pext)<span class='macro_popup'>CRYPTO_free(*pext, "ssl/t1_lib.c", 405)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="406"><td class="num" id="LN406">406</td><td class="line">    *pext = clist;</td></tr>
<tr class="codeline" data-linenumber="407"><td class="num" id="LN407">407</td><td class="line">    *pextlen = ncurves * 2;</td></tr>
<tr class="codeline" data-linenumber="408"><td class="num" id="LN408">408</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="409"><td class="num" id="LN409">409</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="410"><td class="num" id="LN410">410</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="411"><td class="num" id="LN411">411</td><td class="line"><span class='directive'># define <span class='macro'>MAX_CURVELIST<span class='macro_popup'>28</span></span>   28</span></td></tr>
<tr class="codeline" data-linenumber="412"><td class="num" id="LN412">412</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="413"><td class="num" id="LN413">413</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> {</td></tr>
<tr class="codeline" data-linenumber="414"><td class="num" id="LN414">414</td><td class="line">    size_t nidcnt;</td></tr>
<tr class="codeline" data-linenumber="415"><td class="num" id="LN415">415</td><td class="line">    <span class='keyword'>int</span> nid_arr[<span class='macro'>MAX_CURVELIST<span class='macro_popup'>28</span></span>];</td></tr>
<tr class="codeline" data-linenumber="416"><td class="num" id="LN416">416</td><td class="line">} nid_cb_st;</td></tr>
<tr class="codeline" data-linenumber="417"><td class="num" id="LN417">417</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="418"><td class="num" id="LN418">418</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> nid_cb(<span class='keyword'>const</span> <span class='keyword'>char</span> *elem, <span class='keyword'>int</span> len, <span class='keyword'>void</span> *arg)</td></tr>
<tr class="codeline" data-linenumber="419"><td class="num" id="LN419">419</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="420"><td class="num" id="LN420">420</td><td class="line">    nid_cb_st *narg = arg;</td></tr>
<tr class="codeline" data-linenumber="421"><td class="num" id="LN421">421</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="422"><td class="num" id="LN422">422</td><td class="line">    <span class='keyword'>int</span> nid;</td></tr>
<tr class="codeline" data-linenumber="423"><td class="num" id="LN423">423</td><td class="line">    <span class='keyword'>char</span> etmp[20];</td></tr>
<tr class="codeline" data-linenumber="424"><td class="num" id="LN424">424</td><td class="line">    <span class='keyword'>if</span> (elem == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="425"><td class="num" id="LN425">425</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="426"><td class="num" id="LN426">426</td><td class="line">    <span class='keyword'>if</span> (narg-&gt;nidcnt == <span class='macro'>MAX_CURVELIST<span class='macro_popup'>28</span></span>)</td></tr>
<tr class="codeline" data-linenumber="427"><td class="num" id="LN427">427</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="428"><td class="num" id="LN428">428</td><td class="line">    <span class='keyword'>if</span> (len &gt; (<span class='keyword'>int</span>)(<span class='keyword'>sizeof</span>(etmp) - 1))</td></tr>
<tr class="codeline" data-linenumber="429"><td class="num" id="LN429">429</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="430"><td class="num" id="LN430">430</td><td class="line">    memcpy(etmp, elem, len);</td></tr>
<tr class="codeline" data-linenumber="431"><td class="num" id="LN431">431</td><td class="line">    etmp[len] = 0;</td></tr>
<tr class="codeline" data-linenumber="432"><td class="num" id="LN432">432</td><td class="line">    nid = EC_curve_nist2nid(etmp);</td></tr>
<tr class="codeline" data-linenumber="433"><td class="num" id="LN433">433</td><td class="line">    <span class='keyword'>if</span> (nid == <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="434"><td class="num" id="LN434">434</td><td class="line">        nid = OBJ_sn2nid(etmp);</td></tr>
<tr class="codeline" data-linenumber="435"><td class="num" id="LN435">435</td><td class="line">    <span class='keyword'>if</span> (nid == <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="436"><td class="num" id="LN436">436</td><td class="line">        nid = OBJ_ln2nid(etmp);</td></tr>
<tr class="codeline" data-linenumber="437"><td class="num" id="LN437">437</td><td class="line">    <span class='keyword'>if</span> (nid == <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="438"><td class="num" id="LN438">438</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="439"><td class="num" id="LN439">439</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; narg-&gt;nidcnt; i++)</td></tr>
<tr class="codeline" data-linenumber="440"><td class="num" id="LN440">440</td><td class="line">        <span class='keyword'>if</span> (narg-&gt;nid_arr[i] == nid)</td></tr>
<tr class="codeline" data-linenumber="441"><td class="num" id="LN441">441</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="442"><td class="num" id="LN442">442</td><td class="line">    narg-&gt;nid_arr[narg-&gt;nidcnt++] = nid;</td></tr>
<tr class="codeline" data-linenumber="443"><td class="num" id="LN443">443</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="444"><td class="num" id="LN444">444</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="445"><td class="num" id="LN445">445</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="446"><td class="num" id="LN446">446</td><td class="line"><span class='comment'>/* Set curves based on a colon separate list */</span></td></tr>
<tr class="codeline" data-linenumber="447"><td class="num" id="LN447">447</td><td class="line"><span class='keyword'>int</span> tls1_set_curves_list(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> **pext, size_t *pextlen, <span class='keyword'>const</span> <span class='keyword'>char</span> *str)</td></tr>
<tr class="codeline" data-linenumber="448"><td class="num" id="LN448">448</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="449"><td class="num" id="LN449">449</td><td class="line">    nid_cb_st ncb;</td></tr>
<tr class="codeline" data-linenumber="450"><td class="num" id="LN450">450</td><td class="line">    ncb.nidcnt = 0;</td></tr>
<tr class="codeline" data-linenumber="451"><td class="num" id="LN451">451</td><td class="line">    <span class='keyword'>if</span> (!CONF_parse_list(str, ':', 1, nid_cb, &amp;ncb))</td></tr>
<tr class="codeline" data-linenumber="452"><td class="num" id="LN452">452</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="453"><td class="num" id="LN453">453</td><td class="line">    <span class='keyword'>if</span> (pext == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="454"><td class="num" id="LN454">454</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="455"><td class="num" id="LN455">455</td><td class="line">    <span class='keyword'>return</span> tls1_set_curves(pext, pextlen, ncb.nid_arr, ncb.nidcnt);</td></tr>
<tr class="codeline" data-linenumber="456"><td class="num" id="LN456">456</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="457"><td class="num" id="LN457">457</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="458"><td class="num" id="LN458">458</td><td class="line"><span class='comment'>/* For an EC key set TLS id and required compression based on parameters */</span></td></tr>
<tr class="codeline" data-linenumber="459"><td class="num" id="LN459">459</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls1_set_ec_id(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *curve_id, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *comp_id,</td></tr>
<tr class="codeline" data-linenumber="460"><td class="num" id="LN460">460</td><td class="line">                          EC_KEY *ec)</td></tr>
<tr class="codeline" data-linenumber="461"><td class="num" id="LN461">461</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="462"><td class="num" id="LN462">462</td><td class="line">    <span class='keyword'>int</span> id;</td></tr>
<tr class="codeline" data-linenumber="463"><td class="num" id="LN463">463</td><td class="line">    <span class='keyword'>const</span> EC_GROUP *grp;</td></tr>
<tr class="codeline" data-linenumber="464"><td class="num" id="LN464">464</td><td class="line">    <span class='keyword'>if</span> (!ec)</td></tr>
<tr class="codeline" data-linenumber="465"><td class="num" id="LN465">465</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="466"><td class="num" id="LN466">466</td><td class="line">    <span class='comment'>/* Determine if it is a prime field */</span></td></tr>
<tr class="codeline" data-linenumber="467"><td class="num" id="LN467">467</td><td class="line">    grp = EC_KEY_get0_group(ec);</td></tr>
<tr class="codeline" data-linenumber="468"><td class="num" id="LN468">468</td><td class="line">    <span class='keyword'>if</span> (!grp)</td></tr>
<tr class="codeline" data-linenumber="469"><td class="num" id="LN469">469</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="470"><td class="num" id="LN470">470</td><td class="line">    <span class='comment'>/* Determine curve ID */</span></td></tr>
<tr class="codeline" data-linenumber="471"><td class="num" id="LN471">471</td><td class="line">    id = EC_GROUP_get_curve_name(grp);</td></tr>
<tr class="codeline" data-linenumber="472"><td class="num" id="LN472">472</td><td class="line">    id = tls1_ec_nid2curve_id(id);</td></tr>
<tr class="codeline" data-linenumber="473"><td class="num" id="LN473">473</td><td class="line">    <span class='comment'>/* If no id return error: we don't support arbitrary explicit curves */</span></td></tr>
<tr class="codeline" data-linenumber="474"><td class="num" id="LN474">474</td><td class="line">    <span class='keyword'>if</span> (id == 0)</td></tr>
<tr class="codeline" data-linenumber="475"><td class="num" id="LN475">475</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="476"><td class="num" id="LN476">476</td><td class="line">    curve_id[0] = 0;</td></tr>
<tr class="codeline" data-linenumber="477"><td class="num" id="LN477">477</td><td class="line">    curve_id[1] = (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>)id;</td></tr>
<tr class="codeline" data-linenumber="478"><td class="num" id="LN478">478</td><td class="line">    <span class='keyword'>if</span> (comp_id) {</td></tr>
<tr class="codeline" data-linenumber="479"><td class="num" id="LN479">479</td><td class="line">        <span class='keyword'>if</span> (EC_KEY_get0_public_key(ec) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="480"><td class="num" id="LN480">480</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="481"><td class="num" id="LN481">481</td><td class="line">        <span class='keyword'>if</span> (EC_KEY_get_conv_form(ec) == POINT_CONVERSION_UNCOMPRESSED) {</td></tr>
<tr class="codeline" data-linenumber="482"><td class="num" id="LN482">482</td><td class="line">            *comp_id = <span class='macro'>TLSEXT_ECPOINTFORMAT_uncompressed<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="483"><td class="num" id="LN483">483</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="484"><td class="num" id="LN484">484</td><td class="line">            <span class='keyword'>if</span> ((nid_list[id - 1].flags &amp; <span class='macro'>TLS_CURVE_TYPE<span class='macro_popup'>0x3</span></span>) == <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="485"><td class="num" id="LN485">485</td><td class="line">                *comp_id = <span class='macro'>TLSEXT_ECPOINTFORMAT_ansiX962_compressed_prime<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="486"><td class="num" id="LN486">486</td><td class="line">            <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="487"><td class="num" id="LN487">487</td><td class="line">                *comp_id = <span class='macro'>TLSEXT_ECPOINTFORMAT_ansiX962_compressed_char2<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="488"><td class="num" id="LN488">488</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="489"><td class="num" id="LN489">489</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="490"><td class="num" id="LN490">490</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="491"><td class="num" id="LN491">491</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="492"><td class="num" id="LN492">492</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="493"><td class="num" id="LN493">493</td><td class="line"><span class='comment'>/* Check an EC key is compatible with extensions */</span></td></tr>
<tr class="codeline" data-linenumber="494"><td class="num" id="LN494">494</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls1_check_ec_key(SSL *s,</td></tr>
<tr class="codeline" data-linenumber="495"><td class="num" id="LN495">495</td><td class="line">                             <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *curve_id, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *comp_id)</td></tr>
<tr class="codeline" data-linenumber="496"><td class="num" id="LN496">496</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="497"><td class="num" id="LN497">497</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *pformats, *pcurves;</td></tr>
<tr class="codeline" data-linenumber="498"><td class="num" id="LN498">498</td><td class="line">    size_t num_formats, num_curves, i;</td></tr>
<tr class="codeline" data-linenumber="499"><td class="num" id="LN499">499</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="500"><td class="num" id="LN500">500</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="501"><td class="num" id="LN501">501</td><td class="line">     <span class='comment'>* If point formats extension present check it, otherwise everything is</span></td></tr>
<tr class="codeline" data-linenumber="502"><td class="num" id="LN502">502</td><td class="line">     <span class='comment'>* supported (see RFC4492).</span></td></tr>
<tr class="codeline" data-linenumber="503"><td class="num" id="LN503">503</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="504"><td class="num" id="LN504">504</td><td class="line">    <span class='keyword'>if</span> (comp_id &amp;&amp; s-&gt;session-&gt;tlsext_ecpointformatlist) {</td></tr>
<tr class="codeline" data-linenumber="505"><td class="num" id="LN505">505</td><td class="line">        pformats = s-&gt;session-&gt;tlsext_ecpointformatlist;</td></tr>
<tr class="codeline" data-linenumber="506"><td class="num" id="LN506">506</td><td class="line">        num_formats = s-&gt;session-&gt;tlsext_ecpointformatlist_length;</td></tr>
<tr class="codeline" data-linenumber="507"><td class="num" id="LN507">507</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; num_formats; i++, pformats++) {</td></tr>
<tr class="codeline" data-linenumber="508"><td class="num" id="LN508">508</td><td class="line">            <span class='keyword'>if</span> (*comp_id == *pformats)</td></tr>
<tr class="codeline" data-linenumber="509"><td class="num" id="LN509">509</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="510"><td class="num" id="LN510">510</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="511"><td class="num" id="LN511">511</td><td class="line">        <span class='keyword'>if</span> (i == num_formats)</td></tr>
<tr class="codeline" data-linenumber="512"><td class="num" id="LN512">512</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="513"><td class="num" id="LN513">513</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="514"><td class="num" id="LN514">514</td><td class="line">    <span class='keyword'>if</span> (!curve_id)</td></tr>
<tr class="codeline" data-linenumber="515"><td class="num" id="LN515">515</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="516"><td class="num" id="LN516">516</td><td class="line">    <span class='comment'>/* Check curve is consistent with client and server preferences */</span></td></tr>
<tr class="codeline" data-linenumber="517"><td class="num" id="LN517">517</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt;= 1; j++) {</td></tr>
<tr class="codeline" data-linenumber="518"><td class="num" id="LN518">518</td><td class="line">        <span class='keyword'>if</span> (!tls1_get_curvelist(s, j, &amp;pcurves, &amp;num_curves))</td></tr>
<tr class="codeline" data-linenumber="519"><td class="num" id="LN519">519</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="520"><td class="num" id="LN520">520</td><td class="line">        <span class='keyword'>if</span> (j == 1 &amp;&amp; num_curves == 0) {</td></tr>
<tr class="codeline" data-linenumber="521"><td class="num" id="LN521">521</td><td class="line">            <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="522"><td class="num" id="LN522">522</td><td class="line">             <span class='comment'>* If we've not received any curves then skip this check.</span></td></tr>
<tr class="codeline" data-linenumber="523"><td class="num" id="LN523">523</td><td class="line">             <span class='comment'>* RFC 4492 does not require the supported elliptic curves extension</span></td></tr>
<tr class="codeline" data-linenumber="524"><td class="num" id="LN524">524</td><td class="line">             <span class='comment'>* so if it is not sent we can just choose any curve.</span></td></tr>
<tr class="codeline" data-linenumber="525"><td class="num" id="LN525">525</td><td class="line">             <span class='comment'>* It is invalid to send an empty list in the elliptic curves</span></td></tr>
<tr class="codeline" data-linenumber="526"><td class="num" id="LN526">526</td><td class="line">             <span class='comment'>* extension, so num_curves == 0 always means no extension.</span></td></tr>
<tr class="codeline" data-linenumber="527"><td class="num" id="LN527">527</td><td class="line">             <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="528"><td class="num" id="LN528">528</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="529"><td class="num" id="LN529">529</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="530"><td class="num" id="LN530">530</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; num_curves; i++, pcurves += 2) {</td></tr>
<tr class="codeline" data-linenumber="531"><td class="num" id="LN531">531</td><td class="line">            <span class='keyword'>if</span> (pcurves[0] == curve_id[0] &amp;&amp; pcurves[1] == curve_id[1])</td></tr>
<tr class="codeline" data-linenumber="532"><td class="num" id="LN532">532</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="533"><td class="num" id="LN533">533</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="534"><td class="num" id="LN534">534</td><td class="line">        <span class='keyword'>if</span> (i == num_curves)</td></tr>
<tr class="codeline" data-linenumber="535"><td class="num" id="LN535">535</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="536"><td class="num" id="LN536">536</td><td class="line">        <span class='comment'>/* For clients can only check sent curve list */</span></td></tr>
<tr class="codeline" data-linenumber="537"><td class="num" id="LN537">537</td><td class="line">        <span class='keyword'>if</span> (!s-&gt;server)</td></tr>
<tr class="codeline" data-linenumber="538"><td class="num" id="LN538">538</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="539"><td class="num" id="LN539">539</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="540"><td class="num" id="LN540">540</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="541"><td class="num" id="LN541">541</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="542"><td class="num" id="LN542">542</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="543"><td class="num" id="LN543">543</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> tls1_get_formatlist(SSL *s, <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> **pformats,</td></tr>
<tr class="codeline" data-linenumber="544"><td class="num" id="LN544">544</td><td class="line">                                size_t *num_formats)</td></tr>
<tr class="codeline" data-linenumber="545"><td class="num" id="LN545">545</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="546"><td class="num" id="LN546">546</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="547"><td class="num" id="LN547">547</td><td class="line">     <span class='comment'>* If we have a custom point format list use it otherwise use default</span></td></tr>
<tr class="codeline" data-linenumber="548"><td class="num" id="LN548">548</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="549"><td class="num" id="LN549">549</td><td class="line">    <span class='keyword'>if</span> (s-&gt;tlsext_ecpointformatlist) {</td></tr>
<tr class="codeline" data-linenumber="550"><td class="num" id="LN550">550</td><td class="line">        *pformats = s-&gt;tlsext_ecpointformatlist;</td></tr>
<tr class="codeline" data-linenumber="551"><td class="num" id="LN551">551</td><td class="line">        *num_formats = s-&gt;tlsext_ecpointformatlist_length;</td></tr>
<tr class="codeline" data-linenumber="552"><td class="num" id="LN552">552</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="553"><td class="num" id="LN553">553</td><td class="line">        *pformats = ecformats_default;</td></tr>
<tr class="codeline" data-linenumber="554"><td class="num" id="LN554">554</td><td class="line">        <span class='comment'>/* For Suite B we don't support char2 fields */</span></td></tr>
<tr class="codeline" data-linenumber="555"><td class="num" id="LN555">555</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="556"><td class="num" id="LN556">556</td><td class="line">            *num_formats = <span class='keyword'>sizeof</span>(ecformats_default) - 1;</td></tr>
<tr class="codeline" data-linenumber="557"><td class="num" id="LN557">557</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="558"><td class="num" id="LN558">558</td><td class="line">            *num_formats = <span class='keyword'>sizeof</span>(ecformats_default);</td></tr>
<tr class="codeline" data-linenumber="559"><td class="num" id="LN559">559</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="560"><td class="num" id="LN560">560</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="561"><td class="num" id="LN561">561</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="562"><td class="num" id="LN562">562</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="563"><td class="num" id="LN563">563</td><td class="line"> <span class='comment'>* Check cert parameters compatible with extensions: currently just checks EC</span></td></tr>
<tr class="codeline" data-linenumber="564"><td class="num" id="LN564">564</td><td class="line"> <span class='comment'>* certificates have compatible curves and compression.</span></td></tr>
<tr class="codeline" data-linenumber="565"><td class="num" id="LN565">565</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="566"><td class="num" id="LN566">566</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls1_check_cert_param(SSL *s, X509 *x, <span class='keyword'>int</span> set_ee_md)</td></tr>
<tr class="codeline" data-linenumber="567"><td class="num" id="LN567">567</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="568"><td class="num" id="LN568">568</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> comp_id, curve_id[2];</td></tr>
<tr class="codeline" data-linenumber="569"><td class="num" id="LN569">569</td><td class="line">    EVP_PKEY *pkey;</td></tr>
<tr class="codeline" data-linenumber="570"><td class="num" id="LN570">570</td><td class="line">    <span class='keyword'>int</span> rv;</td></tr>
<tr class="codeline" data-linenumber="571"><td class="num" id="LN571">571</td><td class="line">    pkey = X509_get0_pubkey(x);</td></tr>
<tr class="codeline" data-linenumber="572"><td class="num" id="LN572">572</td><td class="line">    <span class='keyword'>if</span> (!pkey)</td></tr>
<tr class="codeline" data-linenumber="573"><td class="num" id="LN573">573</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="574"><td class="num" id="LN574">574</td><td class="line">    <span class='comment'>/* If not EC nothing to do */</span></td></tr>
<tr class="codeline" data-linenumber="575"><td class="num" id="LN575">575</td><td class="line">    <span class='keyword'>if</span> (EVP_PKEY_id(pkey) != <span class='macro'>EVP_PKEY_EC<span class='macro_popup'>408</span></span>)</td></tr>
<tr class="codeline" data-linenumber="576"><td class="num" id="LN576">576</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="577"><td class="num" id="LN577">577</td><td class="line">    rv = tls1_set_ec_id(curve_id, &amp;comp_id, EVP_PKEY_get0_EC_KEY(pkey));</td></tr>
<tr class="codeline" data-linenumber="578"><td class="num" id="LN578">578</td><td class="line">    <span class='keyword'>if</span> (!rv)</td></tr>
<tr class="codeline" data-linenumber="579"><td class="num" id="LN579">579</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="580"><td class="num" id="LN580">580</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="581"><td class="num" id="LN581">581</td><td class="line">     <span class='comment'>* Can't check curve_id for client certs as we don't have a supported</span></td></tr>
<tr class="codeline" data-linenumber="582"><td class="num" id="LN582">582</td><td class="line">     <span class='comment'>* curves extension.</span></td></tr>
<tr class="codeline" data-linenumber="583"><td class="num" id="LN583">583</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="584"><td class="num" id="LN584">584</td><td class="line">    rv = tls1_check_ec_key(s, s-&gt;server ? curve_id : <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, &amp;comp_id);</td></tr>
<tr class="codeline" data-linenumber="585"><td class="num" id="LN585">585</td><td class="line">    <span class='keyword'>if</span> (!rv)</td></tr>
<tr class="codeline" data-linenumber="586"><td class="num" id="LN586">586</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="587"><td class="num" id="LN587">587</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="588"><td class="num" id="LN588">588</td><td class="line">     <span class='comment'>* Special case for suite B. We *MUST* sign using SHA256+P-256 or</span></td></tr>
<tr class="codeline" data-linenumber="589"><td class="num" id="LN589">589</td><td class="line">     <span class='comment'>* SHA384+P-384, adjust digest if necessary.</span></td></tr>
<tr class="codeline" data-linenumber="590"><td class="num" id="LN590">590</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="591"><td class="num" id="LN591">591</td><td class="line">    <span class='keyword'>if</span> (set_ee_md &amp;&amp; <span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="592"><td class="num" id="LN592">592</td><td class="line">        <span class='keyword'>int</span> check_md;</td></tr>
<tr class="codeline" data-linenumber="593"><td class="num" id="LN593">593</td><td class="line">        size_t i;</td></tr>
<tr class="codeline" data-linenumber="594"><td class="num" id="LN594">594</td><td class="line">        CERT *c = s-&gt;cert;</td></tr>
<tr class="codeline" data-linenumber="595"><td class="num" id="LN595">595</td><td class="line">        <span class='keyword'>if</span> (curve_id[0])</td></tr>
<tr class="codeline" data-linenumber="596"><td class="num" id="LN596">596</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="597"><td class="num" id="LN597">597</td><td class="line">        <span class='comment'>/* Check to see we have necessary signing algorithm */</span></td></tr>
<tr class="codeline" data-linenumber="598"><td class="num" id="LN598">598</td><td class="line">        <span class='keyword'>if</span> (curve_id[1] == <span class='macro'>TLSEXT_curve_P_256<span class='macro_popup'>23</span></span>)</td></tr>
<tr class="codeline" data-linenumber="599"><td class="num" id="LN599">599</td><td class="line">            check_md = <span class='macro'>NID_ecdsa_with_SHA256<span class='macro_popup'>794</span></span>;</td></tr>
<tr class="codeline" data-linenumber="600"><td class="num" id="LN600">600</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (curve_id[1] == <span class='macro'>TLSEXT_curve_P_384<span class='macro_popup'>24</span></span>)</td></tr>
<tr class="codeline" data-linenumber="601"><td class="num" id="LN601">601</td><td class="line">            check_md = <span class='macro'>NID_ecdsa_with_SHA384<span class='macro_popup'>795</span></span>;</td></tr>
<tr class="codeline" data-linenumber="602"><td class="num" id="LN602">602</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="603"><td class="num" id="LN603">603</td><td class="line">            <span class='keyword'>return</span> 0;           <span class='comment'>/* Should never happen */</span></td></tr>
<tr class="codeline" data-linenumber="604"><td class="num" id="LN604">604</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; c-&gt;shared_sigalgslen; i++)</td></tr>
<tr class="codeline" data-linenumber="605"><td class="num" id="LN605">605</td><td class="line">            <span class='keyword'>if</span> (check_md == c-&gt;shared_sigalgs[i].signandhash_nid)</td></tr>
<tr class="codeline" data-linenumber="606"><td class="num" id="LN606">606</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="607"><td class="num" id="LN607">607</td><td class="line">        <span class='keyword'>if</span> (i == c-&gt;shared_sigalgslen)</td></tr>
<tr class="codeline" data-linenumber="608"><td class="num" id="LN608">608</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="609"><td class="num" id="LN609">609</td><td class="line">        <span class='keyword'>if</span> (set_ee_md == 2) {</td></tr>
<tr class="codeline" data-linenumber="610"><td class="num" id="LN610">610</td><td class="line">            <span class='keyword'>if</span> (check_md == <span class='macro'>NID_ecdsa_with_SHA256<span class='macro_popup'>794</span></span>)</td></tr>
<tr class="codeline" data-linenumber="611"><td class="num" id="LN611">611</td><td class="line">                s-&gt;s3-&gt;tmp.md[<span class='macro'>SSL_PKEY_ECC<span class='macro_popup'>3</span></span>] = EVP_sha256();</td></tr>
<tr class="codeline" data-linenumber="612"><td class="num" id="LN612">612</td><td class="line">            <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="613"><td class="num" id="LN613">613</td><td class="line">                s-&gt;s3-&gt;tmp.md[<span class='macro'>SSL_PKEY_ECC<span class='macro_popup'>3</span></span>] = EVP_sha384();</td></tr>
<tr class="codeline" data-linenumber="614"><td class="num" id="LN614">614</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="615"><td class="num" id="LN615">615</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="616"><td class="num" id="LN616">616</td><td class="line">    <span class='keyword'>return</span> rv;</td></tr>
<tr class="codeline" data-linenumber="617"><td class="num" id="LN617">617</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="618"><td class="num" id="LN618">618</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="619"><td class="num" id="LN619">619</td><td class="line"><span class='directive'># ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="620"><td class="num" id="LN620">620</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="621"><td class="num" id="LN621">621</td><td class="line"> <span class='comment'>* tls1_check_ec_tmp_key - Check EC temporary key compatibility</span></td></tr>
<tr class="codeline" data-linenumber="622"><td class="num" id="LN622">622</td><td class="line"> <span class='comment'>* @s: SSL connection</span></td></tr>
<tr class="codeline" data-linenumber="623"><td class="num" id="LN623">623</td><td class="line"> <span class='comment'>* @cid: Cipher ID we're considering using</span></td></tr>
<tr class="codeline" data-linenumber="624"><td class="num" id="LN624">624</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="625"><td class="num" id="LN625">625</td><td class="line"> <span class='comment'>* Checks that the kECDHE cipher suite we're considering using</span></td></tr>
<tr class="codeline" data-linenumber="626"><td class="num" id="LN626">626</td><td class="line"> <span class='comment'>* is compatible with the client extensions.</span></td></tr>
<tr class="codeline" data-linenumber="627"><td class="num" id="LN627">627</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="628"><td class="num" id="LN628">628</td><td class="line"> <span class='comment'>* Returns 0 when the cipher can't be used or 1 when it can.</span></td></tr>
<tr class="codeline" data-linenumber="629"><td class="num" id="LN629">629</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="630"><td class="num" id="LN630">630</td><td class="line"><span class='keyword'>int</span> tls1_check_ec_tmp_key(SSL *s, <span class='keyword'>unsigned</span> <span class='keyword'>long</span> cid)</td></tr>
<tr class="codeline" data-linenumber="631"><td class="num" id="LN631">631</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="632"><td class="num" id="LN632">632</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="633"><td class="num" id="LN633">633</td><td class="line">     <span class='comment'>* If Suite B, AES128 MUST use P-256 and AES256 MUST use P-384, no other</span></td></tr>
<tr class="codeline" data-linenumber="634"><td class="num" id="LN634">634</td><td class="line">     <span class='comment'>* curves permitted.</span></td></tr>
<tr class="codeline" data-linenumber="635"><td class="num" id="LN635">635</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="636"><td class="num" id="LN636">636</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="637"><td class="num" id="LN637">637</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> curve_id[2];</td></tr>
<tr class="codeline" data-linenumber="638"><td class="num" id="LN638">638</td><td class="line">        <span class='comment'>/* Curve to check determined by ciphersuite */</span></td></tr>
<tr class="codeline" data-linenumber="639"><td class="num" id="LN639">639</td><td class="line">        <span class='keyword'>if</span> (cid == <span class='macro'>TLS1_CK_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256<span class='macro_popup'>0x0300C02B</span></span>)</td></tr>
<tr class="codeline" data-linenumber="640"><td class="num" id="LN640">640</td><td class="line">            curve_id[1] = <span class='macro'>TLSEXT_curve_P_256<span class='macro_popup'>23</span></span>;</td></tr>
<tr class="codeline" data-linenumber="641"><td class="num" id="LN641">641</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (cid == <span class='macro'>TLS1_CK_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384<span class='macro_popup'>0x0300C02C</span></span>)</td></tr>
<tr class="codeline" data-linenumber="642"><td class="num" id="LN642">642</td><td class="line">            curve_id[1] = <span class='macro'>TLSEXT_curve_P_384<span class='macro_popup'>24</span></span>;</td></tr>
<tr class="codeline" data-linenumber="643"><td class="num" id="LN643">643</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="644"><td class="num" id="LN644">644</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="645"><td class="num" id="LN645">645</td><td class="line">        curve_id[0] = 0;</td></tr>
<tr class="codeline" data-linenumber="646"><td class="num" id="LN646">646</td><td class="line">        <span class='comment'>/* Check this curve is acceptable */</span></td></tr>
<tr class="codeline" data-linenumber="647"><td class="num" id="LN647">647</td><td class="line">        <span class='keyword'>if</span> (!tls1_check_ec_key(s, curve_id, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="648"><td class="num" id="LN648">648</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="649"><td class="num" id="LN649">649</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="650"><td class="num" id="LN650">650</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="651"><td class="num" id="LN651">651</td><td class="line">    <span class='comment'>/* Need a shared curve */</span></td></tr>
<tr class="codeline" data-linenumber="652"><td class="num" id="LN652">652</td><td class="line">    <span class='keyword'>if</span> (tls1_shared_curve(s, 0))</td></tr>
<tr class="codeline" data-linenumber="653"><td class="num" id="LN653">653</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="654"><td class="num" id="LN654">654</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="655"><td class="num" id="LN655">655</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="656"><td class="num" id="LN656">656</td><td class="line"><span class='directive'># endif                         /* OPENSSL_NO_EC */</span></td></tr>
<tr class="codeline" data-linenumber="657"><td class="num" id="LN657">657</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="658"><td class="num" id="LN658">658</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="659"><td class="num" id="LN659">659</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="660"><td class="num" id="LN660">660</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls1_check_cert_param(SSL *s, X509 *x, <span class='keyword'>int</span> set_ee_md)</td></tr>
<tr class="codeline" data-linenumber="661"><td class="num" id="LN661">661</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="662"><td class="num" id="LN662">662</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="663"><td class="num" id="LN663">663</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="664"><td class="num" id="LN664">664</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="665"><td class="num" id="LN665">665</td><td class="line"><span class='directive'>#endif                          /* OPENSSL_NO_EC */</span></td></tr>
<tr class="codeline" data-linenumber="666"><td class="num" id="LN666">666</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="667"><td class="num" id="LN667">667</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="668"><td class="num" id="LN668">668</td><td class="line"> <span class='comment'>* List of supported signature algorithms and hashes. Should make this</span></td></tr>
<tr class="codeline" data-linenumber="669"><td class="num" id="LN669">669</td><td class="line"> <span class='comment'>* customisable at some point, for now include everything we support.</span></td></tr>
<tr class="codeline" data-linenumber="670"><td class="num" id="LN670">670</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="671"><td class="num" id="LN671">671</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="672"><td class="num" id="LN672">672</td><td class="line"><span class='directive'>#ifdef OPENSSL_NO_RSA</span></td></tr>
<tr class="codeline" data-linenumber="673"><td class="num" id="LN673">673</td><td class="line"><span class='directive'># define <span class='macro'>tlsext_sigalg_rsa(md)<span class='macro_popup'>md, 1,</span></span>  /* */</span></td></tr>
<tr class="codeline" data-linenumber="674"><td class="num" id="LN674">674</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="675"><td class="num" id="LN675">675</td><td class="line"><span class='directive'># define <span class='macro'>tlsext_sigalg_rsa(md)<span class='macro_popup'>md, 1,</span></span> md, <span class='macro'>TLSEXT_signature_rsa<span class='macro_popup'>1</span></span>,</span></td></tr>
<tr class="codeline" data-linenumber="676"><td class="num" id="LN676">676</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="677"><td class="num" id="LN677">677</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="678"><td class="num" id="LN678">678</td><td class="line"><span class='directive'>#ifdef OPENSSL_NO_DSA</span></td></tr>
<tr class="codeline" data-linenumber="679"><td class="num" id="LN679">679</td><td class="line"><span class='directive'># define <span class='macro'>tlsext_sigalg_dsa(md)<span class='macro_popup'>md, 2,</span></span>  /* */</span></td></tr>
<tr class="codeline" data-linenumber="680"><td class="num" id="LN680">680</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="681"><td class="num" id="LN681">681</td><td class="line"><span class='directive'># define <span class='macro'>tlsext_sigalg_dsa(md)<span class='macro_popup'>md, 2,</span></span> md, <span class='macro'>TLSEXT_signature_dsa<span class='macro_popup'>2</span></span>,</span></td></tr>
<tr class="codeline" data-linenumber="682"><td class="num" id="LN682">682</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="683"><td class="num" id="LN683">683</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="684"><td class="num" id="LN684">684</td><td class="line"><span class='directive'>#ifdef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="685"><td class="num" id="LN685">685</td><td class="line"><span class='directive'># define <span class='macro'>tlsext_sigalg_ecdsa(md)<span class='macro_popup'>md, 3,</span></span>/* */</span></td></tr>
<tr class="codeline" data-linenumber="686"><td class="num" id="LN686">686</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="687"><td class="num" id="LN687">687</td><td class="line"><span class='directive'># define <span class='macro'>tlsext_sigalg_ecdsa(md)<span class='macro_popup'>md, 3,</span></span> md, <span class='macro'>TLSEXT_signature_ecdsa<span class='macro_popup'>3</span></span>,</span></td></tr>
<tr class="codeline" data-linenumber="688"><td class="num" id="LN688">688</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="689"><td class="num" id="LN689">689</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="690"><td class="num" id="LN690">690</td><td class="line"><span class='directive'>#define <span class='macro'>tlsext_sigalg(md)<span class='macro_popup'>md, 1, md, 2, md, 3,</span></span> \</span></td></tr>
<tr class="codeline" data-linenumber="691"><td class="num" id="LN691">691</td><td class="line">                <span class='directive'><span class='macro'>tlsext_sigalg_rsa(md)<span class='macro_popup'>md, 1,</span></span> \</span></td></tr>
<tr class="codeline" data-linenumber="692"><td class="num" id="LN692">692</td><td class="line">                <span class='directive'><span class='macro'>tlsext_sigalg_dsa(md)<span class='macro_popup'>md, 2,</span></span> \</span></td></tr>
<tr class="codeline" data-linenumber="693"><td class="num" id="LN693">693</td><td class="line">                <span class='directive'><span class='macro'>tlsext_sigalg_ecdsa(md)<span class='macro_popup'>md, 3,</span></span></span></td></tr>
<tr class="codeline" data-linenumber="694"><td class="num" id="LN694">694</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="695"><td class="num" id="LN695">695</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> tls12_sigalgs[] = {</td></tr>
<tr class="codeline" data-linenumber="696"><td class="num" id="LN696">696</td><td class="line">    <span class='macro'>tlsext_sigalg(TLSEXT_hash_sha512)<span class='macro_popup'>6, 1, 6, 2, 6, 3,</span></span></td></tr>
<tr class="codeline" data-linenumber="697"><td class="num" id="LN697">697</td><td class="line">        <span class='macro'>tlsext_sigalg(TLSEXT_hash_sha384)<span class='macro_popup'>5, 1, 5, 2, 5, 3,</span></span></td></tr>
<tr class="codeline" data-linenumber="698"><td class="num" id="LN698">698</td><td class="line">        <span class='macro'>tlsext_sigalg(TLSEXT_hash_sha256)<span class='macro_popup'>4, 1, 4, 2, 4, 3,</span></span></td></tr>
<tr class="codeline" data-linenumber="699"><td class="num" id="LN699">699</td><td class="line">        <span class='macro'>tlsext_sigalg(TLSEXT_hash_sha224)<span class='macro_popup'>3, 1, 3, 2, 3, 3,</span></span></td></tr>
<tr class="codeline" data-linenumber="700"><td class="num" id="LN700">700</td><td class="line">        <span class='macro'>tlsext_sigalg(TLSEXT_hash_sha1)<span class='macro_popup'>2, 1, 2, 2, 2, 3,</span></span></td></tr>
<tr class="codeline" data-linenumber="701"><td class="num" id="LN701">701</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_GOST</span></td></tr>
<tr class="codeline" data-linenumber="702"><td class="num" id="LN702">702</td><td class="line">        <span class='macro'>TLSEXT_hash_gostr3411<span class='macro_popup'>237</span></span>, <span class='macro'>TLSEXT_signature_gostr34102001<span class='macro_popup'>237</span></span>,</td></tr>
<tr class="codeline" data-linenumber="703"><td class="num" id="LN703">703</td><td class="line">    <span class='macro'>TLSEXT_hash_gostr34112012_256<span class='macro_popup'>238</span></span>, <span class='macro'>TLSEXT_signature_gostr34102012_256<span class='macro_popup'>238</span></span>,</td></tr>
<tr class="codeline" data-linenumber="704"><td class="num" id="LN704">704</td><td class="line">    <span class='macro'>TLSEXT_hash_gostr34112012_512<span class='macro_popup'>239</span></span>, <span class='macro'>TLSEXT_signature_gostr34102012_512<span class='macro_popup'>239</span></span></td></tr>
<tr class="codeline" data-linenumber="705"><td class="num" id="LN705">705</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="706"><td class="num" id="LN706">706</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="707"><td class="num" id="LN707">707</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="708"><td class="num" id="LN708">708</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="709"><td class="num" id="LN709">709</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> suiteb_sigalgs[] = {</td></tr>
<tr class="codeline" data-linenumber="710"><td class="num" id="LN710">710</td><td class="line">    <span class='macro'>tlsext_sigalg_ecdsa(TLSEXT_hash_sha256)<span class='macro_popup'>4, 3,</span></span></td></tr>
<tr class="codeline" data-linenumber="711"><td class="num" id="LN711">711</td><td class="line">        <span class='macro'>tlsext_sigalg_ecdsa(TLSEXT_hash_sha384)<span class='macro_popup'>5, 3,</span></span></td></tr>
<tr class="codeline" data-linenumber="712"><td class="num" id="LN712">712</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="713"><td class="num" id="LN713">713</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="714"><td class="num" id="LN714">714</td><td class="line">size_t tls12_get_psigalgs(SSL *s, <span class='keyword'>int</span> sent, <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> **psigs)</td></tr>
<tr class="codeline" data-linenumber="715"><td class="num" id="LN715">715</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="716"><td class="num" id="LN716">716</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="717"><td class="num" id="LN717">717</td><td class="line">     <span class='comment'>* If Suite B mode use Suite B sigalgs only, ignore any other</span></td></tr>
<tr class="codeline" data-linenumber="718"><td class="num" id="LN718">718</td><td class="line">     <span class='comment'>* preferences.</span></td></tr>
<tr class="codeline" data-linenumber="719"><td class="num" id="LN719">719</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="720"><td class="num" id="LN720">720</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="721"><td class="num" id="LN721">721</td><td class="line">    <span class='keyword'>switch</span> (<span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="722"><td class="num" id="LN722">722</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>SSL_CERT_FLAG_SUITEB_128_LOS<span class='macro_popup'>0x30000</span></span>:</td></tr>
<tr class="codeline" data-linenumber="723"><td class="num" id="LN723">723</td><td class="line">        *psigs = suiteb_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="724"><td class="num" id="LN724">724</td><td class="line">        <span class='keyword'>return</span> <span class='keyword'>sizeof</span>(suiteb_sigalgs);</td></tr>
<tr class="codeline" data-linenumber="725"><td class="num" id="LN725">725</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="726"><td class="num" id="LN726">726</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>SSL_CERT_FLAG_SUITEB_128_LOS_ONLY<span class='macro_popup'>0x10000</span></span>:</td></tr>
<tr class="codeline" data-linenumber="727"><td class="num" id="LN727">727</td><td class="line">        *psigs = suiteb_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="728"><td class="num" id="LN728">728</td><td class="line">        <span class='keyword'>return</span> 2;</td></tr>
<tr class="codeline" data-linenumber="729"><td class="num" id="LN729">729</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="730"><td class="num" id="LN730">730</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>SSL_CERT_FLAG_SUITEB_192_LOS<span class='macro_popup'>0x20000</span></span>:</td></tr>
<tr class="codeline" data-linenumber="731"><td class="num" id="LN731">731</td><td class="line">        *psigs = suiteb_sigalgs + 2;</td></tr>
<tr class="codeline" data-linenumber="732"><td class="num" id="LN732">732</td><td class="line">        <span class='keyword'>return</span> 2;</td></tr>
<tr class="codeline" data-linenumber="733"><td class="num" id="LN733">733</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="734"><td class="num" id="LN734">734</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="735"><td class="num" id="LN735">735</td><td class="line">    <span class='comment'>/* If server use client authentication sigalgs if not NULL */</span></td></tr>
<tr class="codeline" data-linenumber="736"><td class="num" id="LN736">736</td><td class="line">    <span class='keyword'>if</span> (s-&gt;server == sent &amp;&amp; s-&gt;cert-&gt;client_sigalgs) {</td></tr>
<tr class="codeline" data-linenumber="737"><td class="num" id="LN737">737</td><td class="line">        *psigs = s-&gt;cert-&gt;client_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="738"><td class="num" id="LN738">738</td><td class="line">        <span class='keyword'>return</span> s-&gt;cert-&gt;client_sigalgslen;</td></tr>
<tr class="codeline" data-linenumber="739"><td class="num" id="LN739">739</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (s-&gt;cert-&gt;conf_sigalgs) {</td></tr>
<tr class="codeline" data-linenumber="740"><td class="num" id="LN740">740</td><td class="line">        *psigs = s-&gt;cert-&gt;conf_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="741"><td class="num" id="LN741">741</td><td class="line">        <span class='keyword'>return</span> s-&gt;cert-&gt;conf_sigalgslen;</td></tr>
<tr class="codeline" data-linenumber="742"><td class="num" id="LN742">742</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="743"><td class="num" id="LN743">743</td><td class="line">        *psigs = tls12_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="744"><td class="num" id="LN744">744</td><td class="line">        <span class='keyword'>return</span> <span class='keyword'>sizeof</span>(tls12_sigalgs);</td></tr>
<tr class="codeline" data-linenumber="745"><td class="num" id="LN745">745</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="746"><td class="num" id="LN746">746</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="747"><td class="num" id="LN747">747</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="748"><td class="num" id="LN748">748</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="749"><td class="num" id="LN749">749</td><td class="line"> <span class='comment'>* Check signature algorithm is consistent with sent supported signature</span></td></tr>
<tr class="codeline" data-linenumber="750"><td class="num" id="LN750">750</td><td class="line"> <span class='comment'>* algorithms and if so return relevant digest.</span></td></tr>
<tr class="codeline" data-linenumber="751"><td class="num" id="LN751">751</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="752"><td class="num" id="LN752">752</td><td class="line"><span class='keyword'>int</span> tls12_check_peer_sigalg(<span class='keyword'>const</span> EVP_MD **pmd, SSL *s,</td></tr>
<tr class="codeline" data-linenumber="753"><td class="num" id="LN753">753</td><td class="line">                            <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *sig, EVP_PKEY *pkey)</td></tr>
<tr class="codeline" data-linenumber="754"><td class="num" id="LN754">754</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="755"><td class="num" id="LN755">755</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *sent_sigs;</td></tr>
<tr class="codeline" data-linenumber="756"><td class="num" id="LN756">756</td><td class="line">    size_t sent_sigslen, i;</td></tr>
<tr class="codeline" data-linenumber="757"><td class="num" id="LN757">757</td><td class="line">    <span class='keyword'>int</span> sigalg = tls12_get_sigid(pkey);</td></tr>
<tr class="codeline" data-linenumber="758"><td class="num" id="LN758">758</td><td class="line">    <span class='comment'>/* Should never happen */</span></td></tr>
<tr class="codeline" data-linenumber="759"><td class="num" id="LN759">759</td><td class="line">    <span class='keyword'>if</span> (sigalg == -1)</td></tr>
<tr class="codeline" data-linenumber="760"><td class="num" id="LN760">760</td><td class="line">        <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="761"><td class="num" id="LN761">761</td><td class="line">    <span class='comment'>/* Check key type is consistent with signature */</span></td></tr>
<tr class="codeline" data-linenumber="762"><td class="num" id="LN762">762</td><td class="line">    <span class='keyword'>if</span> (sigalg != (<span class='keyword'>int</span>)sig[1]) {</td></tr>
<tr class="codeline" data-linenumber="763"><td class="num" id="LN763">763</td><td class="line">        <span class='macro'>SSLerr(SSL_F_TLS12_CHECK_PEER_SIGALG, SSL_R_WRONG_SIGNATURE_TYPE)<span class='macro_popup'>ERR_put_error(20,(333),(370),"ssl/t1_lib.c",763)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="764"><td class="num" id="LN764">764</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="765"><td class="num" id="LN765">765</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="766"><td class="num" id="LN766">766</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="767"><td class="num" id="LN767">767</td><td class="line">    <span class='keyword'>if</span> (EVP_PKEY_id(pkey) == <span class='macro'>EVP_PKEY_EC<span class='macro_popup'>408</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="768"><td class="num" id="LN768">768</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> curve_id[2], comp_id;</td></tr>
<tr class="codeline" data-linenumber="769"><td class="num" id="LN769">769</td><td class="line">        <span class='comment'>/* Check compression and curve matches extensions */</span></td></tr>
<tr class="codeline" data-linenumber="770"><td class="num" id="LN770">770</td><td class="line">        <span class='keyword'>if</span> (!tls1_set_ec_id(curve_id, &amp;comp_id, EVP_PKEY_get0_EC_KEY(pkey)))</td></tr>
<tr class="codeline" data-linenumber="771"><td class="num" id="LN771">771</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="772"><td class="num" id="LN772">772</td><td class="line">        <span class='keyword'>if</span> (!s-&gt;server &amp;&amp; !tls1_check_ec_key(s, curve_id, &amp;comp_id)) {</td></tr>
<tr class="codeline" data-linenumber="773"><td class="num" id="LN773">773</td><td class="line">            <span class='macro'>SSLerr(SSL_F_TLS12_CHECK_PEER_SIGALG, SSL_R_WRONG_CURVE)<span class='macro_popup'>ERR_put_error(20,(333),(378),"ssl/t1_lib.c",773)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="774"><td class="num" id="LN774">774</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="775"><td class="num" id="LN775">775</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="776"><td class="num" id="LN776">776</td><td class="line">        <span class='comment'>/* If Suite B only P-384+SHA384 or P-256+SHA-256 allowed */</span></td></tr>
<tr class="codeline" data-linenumber="777"><td class="num" id="LN777">777</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="778"><td class="num" id="LN778">778</td><td class="line">            <span class='keyword'>if</span> (curve_id[0])</td></tr>
<tr class="codeline" data-linenumber="779"><td class="num" id="LN779">779</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="780"><td class="num" id="LN780">780</td><td class="line">            <span class='keyword'>if</span> (curve_id[1] == <span class='macro'>TLSEXT_curve_P_256<span class='macro_popup'>23</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="781"><td class="num" id="LN781">781</td><td class="line">                <span class='keyword'>if</span> (sig[0] != <span class='macro'>TLSEXT_hash_sha256<span class='macro_popup'>4</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="782"><td class="num" id="LN782">782</td><td class="line">                    <span class='macro'>SSLerr(SSL_F_TLS12_CHECK_PEER_SIGALG,<span class='macro_popup'>ERR_put_error(20,(333),(380),"ssl/t1_lib.c",783)</span></span></td></tr>
<tr class="codeline" data-linenumber="783"><td class="num" id="LN783">783</td><td class="line">                           <span class='macro'>SSL_R_ILLEGAL_SUITEB_DIGEST)<span class='macro_popup'>ERR_put_error(20,(333),(380),"ssl/t1_lib.c",783)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="784"><td class="num" id="LN784">784</td><td class="line">                    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="785"><td class="num" id="LN785">785</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="786"><td class="num" id="LN786">786</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (curve_id[1] == <span class='macro'>TLSEXT_curve_P_384<span class='macro_popup'>24</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="787"><td class="num" id="LN787">787</td><td class="line">                <span class='keyword'>if</span> (sig[0] != <span class='macro'>TLSEXT_hash_sha384<span class='macro_popup'>5</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="788"><td class="num" id="LN788">788</td><td class="line">                    <span class='macro'>SSLerr(SSL_F_TLS12_CHECK_PEER_SIGALG,<span class='macro_popup'>ERR_put_error(20,(333),(380),"ssl/t1_lib.c",789)</span></span></td></tr>
<tr class="codeline" data-linenumber="789"><td class="num" id="LN789">789</td><td class="line">                           <span class='macro'>SSL_R_ILLEGAL_SUITEB_DIGEST)<span class='macro_popup'>ERR_put_error(20,(333),(380),"ssl/t1_lib.c",789)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="790"><td class="num" id="LN790">790</td><td class="line">                    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="791"><td class="num" id="LN791">791</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="792"><td class="num" id="LN792">792</td><td class="line">            } <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="793"><td class="num" id="LN793">793</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="794"><td class="num" id="LN794">794</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="795"><td class="num" id="LN795">795</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="796"><td class="num" id="LN796">796</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="797"><td class="num" id="LN797">797</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="798"><td class="num" id="LN798">798</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="799"><td class="num" id="LN799">799</td><td class="line">    <span class='comment'>/* Check signature matches a type we sent */</span></td></tr>
<tr class="codeline" data-linenumber="800"><td class="num" id="LN800">800</td><td class="line">    sent_sigslen = tls12_get_psigalgs(s, 1, &amp;sent_sigs);</td></tr>
<tr class="codeline" data-linenumber="801"><td class="num" id="LN801">801</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; sent_sigslen; i += 2, sent_sigs += 2) {</td></tr>
<tr class="codeline" data-linenumber="802"><td class="num" id="LN802">802</td><td class="line">        <span class='keyword'>if</span> (sig[0] == sent_sigs[0] &amp;&amp; sig[1] == sent_sigs[1])</td></tr>
<tr class="codeline" data-linenumber="803"><td class="num" id="LN803">803</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="804"><td class="num" id="LN804">804</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="805"><td class="num" id="LN805">805</td><td class="line">    <span class='comment'>/* Allow fallback to SHA1 if not strict mode */</span></td></tr>
<tr class="codeline" data-linenumber="806"><td class="num" id="LN806">806</td><td class="line">    <span class='keyword'>if</span> (i == sent_sigslen</td></tr>
<tr class="codeline" data-linenumber="807"><td class="num" id="LN807">807</td><td class="line">        &amp;&amp; (sig[0] != <span class='macro'>TLSEXT_hash_sha1<span class='macro_popup'>2</span></span></td></tr>
<tr class="codeline" data-linenumber="808"><td class="num" id="LN808">808</td><td class="line">            || s-&gt;cert-&gt;cert_flags &amp; <span class='macro'>SSL_CERT_FLAGS_CHECK_TLS_STRICT<span class='macro_popup'>(0x30000|0x00000001U)</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="809"><td class="num" id="LN809">809</td><td class="line">        <span class='macro'>SSLerr(SSL_F_TLS12_CHECK_PEER_SIGALG, SSL_R_WRONG_SIGNATURE_TYPE)<span class='macro_popup'>ERR_put_error(20,(333),(370),"ssl/t1_lib.c",809)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="810"><td class="num" id="LN810">810</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="811"><td class="num" id="LN811">811</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="812"><td class="num" id="LN812">812</td><td class="line">    *pmd = tls12_get_hash(sig[0]);</td></tr>
<tr class="codeline" data-linenumber="813"><td class="num" id="LN813">813</td><td class="line">    <span class='keyword'>if</span> (*pmd == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="814"><td class="num" id="LN814">814</td><td class="line">        <span class='macro'>SSLerr(SSL_F_TLS12_CHECK_PEER_SIGALG, SSL_R_UNKNOWN_DIGEST)<span class='macro_popup'>ERR_put_error(20,(333),(368),"ssl/t1_lib.c",814)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="815"><td class="num" id="LN815">815</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="816"><td class="num" id="LN816">816</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="817"><td class="num" id="LN817">817</td><td class="line">    <span class='comment'>/* Make sure security callback allows algorithm */</span></td></tr>
<tr class="codeline" data-linenumber="818"><td class="num" id="LN818">818</td><td class="line">    <span class='keyword'>if</span> (!ssl_security(s, <span class='macro'>SSL_SECOP_SIGALG_CHECK<span class='macro_popup'>(13 | (5 &lt;&lt; 16))</span></span>,</td></tr>
<tr class="codeline" data-linenumber="819"><td class="num" id="LN819">819</td><td class="line">                      EVP_MD_size(*pmd) * 4, EVP_MD_type(*pmd), (<span class='keyword'>void</span> *)sig)) {</td></tr>
<tr class="codeline" data-linenumber="820"><td class="num" id="LN820">820</td><td class="line">        <span class='macro'>SSLerr(SSL_F_TLS12_CHECK_PEER_SIGALG, SSL_R_WRONG_SIGNATURE_TYPE)<span class='macro_popup'>ERR_put_error(20,(333),(370),"ssl/t1_lib.c",820)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="821"><td class="num" id="LN821">821</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="822"><td class="num" id="LN822">822</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="823"><td class="num" id="LN823">823</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="824"><td class="num" id="LN824">824</td><td class="line">     <span class='comment'>* Store the digest used so applications can retrieve it if they wish.</span></td></tr>
<tr class="codeline" data-linenumber="825"><td class="num" id="LN825">825</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="826"><td class="num" id="LN826">826</td><td class="line">    s-&gt;s3-&gt;tmp.peer_md = *pmd;</td></tr>
<tr class="codeline" data-linenumber="827"><td class="num" id="LN827">827</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="828"><td class="num" id="LN828">828</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="829"><td class="num" id="LN829">829</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="830"><td class="num" id="LN830">830</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="831"><td class="num" id="LN831">831</td><td class="line"> <span class='comment'>* Set a mask of disabled algorithms: an algorithm is disabled if it isn't</span></td></tr>
<tr class="codeline" data-linenumber="832"><td class="num" id="LN832">832</td><td class="line"> <span class='comment'>* supported, doesn't appear in supported signature algorithms, isn't supported</span></td></tr>
<tr class="codeline" data-linenumber="833"><td class="num" id="LN833">833</td><td class="line"> <span class='comment'>* by the enabled protocol versions or by the security level.</span></td></tr>
<tr class="codeline" data-linenumber="834"><td class="num" id="LN834">834</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="835"><td class="num" id="LN835">835</td><td class="line"> <span class='comment'>* This function should only be used for checking which ciphers are supported</span></td></tr>
<tr class="codeline" data-linenumber="836"><td class="num" id="LN836">836</td><td class="line"> <span class='comment'>* by the client.</span></td></tr>
<tr class="codeline" data-linenumber="837"><td class="num" id="LN837">837</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="838"><td class="num" id="LN838">838</td><td class="line"> <span class='comment'>* Call ssl_cipher_disabled() to check that it's enabled or not.</span></td></tr>
<tr class="codeline" data-linenumber="839"><td class="num" id="LN839">839</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="840"><td class="num" id="LN840">840</td><td class="line"><span class='keyword'>void</span> ssl_set_client_disabled(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="841"><td class="num" id="LN841">841</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="842"><td class="num" id="LN842">842</td><td class="line">    s-&gt;s3-&gt;tmp.mask_a = 0;</td></tr>
<tr class="codeline" data-linenumber="843"><td class="num" id="LN843">843</td><td class="line">    s-&gt;s3-&gt;tmp.mask_k = 0;</td></tr>
<tr class="codeline" data-linenumber="844"><td class="num" id="LN844">844</td><td class="line">    ssl_set_sig_mask(&amp;s-&gt;s3-&gt;tmp.mask_a, s, <span class='macro'>SSL_SECOP_SIGALG_MASK<span class='macro_popup'>(14 | (5 &lt;&lt; 16))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="845"><td class="num" id="LN845">845</td><td class="line">    ssl_get_client_min_max_version(s, &amp;s-&gt;s3-&gt;tmp.min_ver, &amp;s-&gt;s3-&gt;tmp.max_ver);</td></tr>
<tr class="codeline" data-linenumber="846"><td class="num" id="LN846">846</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_PSK</span></td></tr>
<tr class="codeline" data-linenumber="847"><td class="num" id="LN847">847</td><td class="line">    <span class='comment'>/* with PSK there must be client callback set */</span></td></tr>
<tr class="codeline" data-linenumber="848"><td class="num" id="LN848">848</td><td class="line">    <span class='keyword'>if</span> (!s-&gt;psk_client_callback) {</td></tr>
<tr class="codeline" data-linenumber="849"><td class="num" id="LN849">849</td><td class="line">        s-&gt;s3-&gt;tmp.mask_a |= <span class='macro'>SSL_aPSK<span class='macro_popup'>0x00000010U</span></span>;</td></tr>
<tr class="codeline" data-linenumber="850"><td class="num" id="LN850">850</td><td class="line">        s-&gt;s3-&gt;tmp.mask_k |= <span class='macro'>SSL_PSK<span class='macro_popup'>(0x00000008U | 0x00000040U | 0x00000080U | 0x00000100U)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="851"><td class="num" id="LN851">851</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="852"><td class="num" id="LN852">852</td><td class="line"><span class='directive'>#endif                          /* OPENSSL_NO_PSK */</span></td></tr>
<tr class="codeline" data-linenumber="853"><td class="num" id="LN853">853</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_SRP</span></td></tr>
<tr class="codeline" data-linenumber="854"><td class="num" id="LN854">854</td><td class="line">    <span class='keyword'>if</span> (!(s-&gt;srp_ctx.srp_Mask &amp; <span class='macro'>SSL_kSRP<span class='macro_popup'>0x00000020U</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="855"><td class="num" id="LN855">855</td><td class="line">        s-&gt;s3-&gt;tmp.mask_a |= <span class='macro'>SSL_aSRP<span class='macro_popup'>0x00000040U</span></span>;</td></tr>
<tr class="codeline" data-linenumber="856"><td class="num" id="LN856">856</td><td class="line">        s-&gt;s3-&gt;tmp.mask_k |= <span class='macro'>SSL_kSRP<span class='macro_popup'>0x00000020U</span></span>;</td></tr>
<tr class="codeline" data-linenumber="857"><td class="num" id="LN857">857</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="858"><td class="num" id="LN858">858</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="859"><td class="num" id="LN859">859</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="860"><td class="num" id="LN860">860</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="861"><td class="num" id="LN861">861</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="862"><td class="num" id="LN862">862</td><td class="line"> <span class='comment'>* ssl_cipher_disabled - check that a cipher is disabled or not</span></td></tr>
<tr class="codeline" data-linenumber="863"><td class="num" id="LN863">863</td><td class="line"> <span class='comment'>* @s: SSL connection that you want to use the cipher on</span></td></tr>
<tr class="codeline" data-linenumber="864"><td class="num" id="LN864">864</td><td class="line"> <span class='comment'>* @c: cipher to check</span></td></tr>
<tr class="codeline" data-linenumber="865"><td class="num" id="LN865">865</td><td class="line"> <span class='comment'>* @op: Security check that you want to do</span></td></tr>
<tr class="codeline" data-linenumber="866"><td class="num" id="LN866">866</td><td class="line"> <span class='comment'>* @ecdhe: If set to 1 then TLSv1 ECDHE ciphers are also allowed in SSLv3</span></td></tr>
<tr class="codeline" data-linenumber="867"><td class="num" id="LN867">867</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="868"><td class="num" id="LN868">868</td><td class="line"> <span class='comment'>* Returns 1 when it's disabled, 0 when enabled.</span></td></tr>
<tr class="codeline" data-linenumber="869"><td class="num" id="LN869">869</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="870"><td class="num" id="LN870">870</td><td class="line"><span class='keyword'>int</span> ssl_cipher_disabled(SSL *s, <span class='keyword'>const</span> SSL_CIPHER *c, <span class='keyword'>int</span> op, <span class='keyword'>int</span> ecdhe)</td></tr>
<tr class="codeline" data-linenumber="871"><td class="num" id="LN871">871</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="872"><td class="num" id="LN872">872</td><td class="line">    <span class='keyword'>if</span> (c-&gt;algorithm_mkey &amp; s-&gt;s3-&gt;tmp.mask_k</td></tr>
<tr class="codeline" data-linenumber="873"><td class="num" id="LN873">873</td><td class="line">        || c-&gt;algorithm_auth &amp; s-&gt;s3-&gt;tmp.mask_a)</td></tr>
<tr class="codeline" data-linenumber="874"><td class="num" id="LN874">874</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="875"><td class="num" id="LN875">875</td><td class="line">    <span class='keyword'>if</span> (s-&gt;s3-&gt;tmp.max_ver == 0)</td></tr>
<tr class="codeline" data-linenumber="876"><td class="num" id="LN876">876</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="877"><td class="num" id="LN877">877</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>SSL_IS_DTLS(s)<span class='macro_popup'>(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="878"><td class="num" id="LN878">878</td><td class="line">        <span class='keyword'>int</span> min_tls = c-&gt;min_tls;</td></tr>
<tr class="codeline" data-linenumber="879"><td class="num" id="LN879">879</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="880"><td class="num" id="LN880">880</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="881"><td class="num" id="LN881">881</td><td class="line">         <span class='comment'>* For historical reasons we will allow ECHDE to be selected by a server</span></td></tr>
<tr class="codeline" data-linenumber="882"><td class="num" id="LN882">882</td><td class="line">         <span class='comment'>* in SSLv3 if we are a client</span></td></tr>
<tr class="codeline" data-linenumber="883"><td class="num" id="LN883">883</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="884"><td class="num" id="LN884">884</td><td class="line">        <span class='keyword'>if</span> (min_tls == <span class='macro'>TLS1_VERSION<span class='macro_popup'>0x0301</span></span> &amp;&amp; ecdhe</td></tr>
<tr class="codeline" data-linenumber="885"><td class="num" id="LN885">885</td><td class="line">                &amp;&amp; (c-&gt;algorithm_mkey &amp; (<span class='macro'>SSL_kECDHE<span class='macro_popup'>0x00000004U</span></span> | <span class='macro'>SSL_kECDHEPSK<span class='macro_popup'>0x00000080U</span></span>)) != 0)</td></tr>
<tr class="codeline" data-linenumber="886"><td class="num" id="LN886">886</td><td class="line">            min_tls = <span class='macro'>SSL3_VERSION<span class='macro_popup'>0x0300</span></span>;</td></tr>
<tr class="codeline" data-linenumber="887"><td class="num" id="LN887">887</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="888"><td class="num" id="LN888">888</td><td class="line">        <span class='keyword'>if</span> ((min_tls &gt; s-&gt;s3-&gt;tmp.max_ver) || (c-&gt;max_tls &lt; s-&gt;s3-&gt;tmp.min_ver))</td></tr>
<tr class="codeline" data-linenumber="889"><td class="num" id="LN889">889</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="890"><td class="num" id="LN890">890</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="891"><td class="num" id="LN891">891</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>SSL_IS_DTLS(s)<span class='macro_popup'>(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8)</span></span> &amp;&amp; (<span class='macro'>DTLS_VERSION_GT(c-&gt;min_dtls, s-&gt;s3-&gt;tmp.max_ver)<span class='macro_popup'>((((c-&gt;min_dtls) == 0x0100) ? 0xff00 : (c-&gt;min_dtls)) &lt;<br> (((s-&gt;s3-&gt;tmp.max_ver) == 0x0100) ? 0xff00 : (s-&gt;s3<br>-&gt;tmp.max_ver)))</span></span></td></tr>
<tr class="codeline" data-linenumber="892"><td class="num" id="LN892">892</td><td class="line">                           || <span class='macro'>DTLS_VERSION_LT(c-&gt;max_dtls, s-&gt;s3-&gt;tmp.min_ver)<span class='macro_popup'>((((c-&gt;max_dtls) == 0x0100) ? 0xff00 : (c-&gt;max_dtls)) &gt;<br> (((s-&gt;s3-&gt;tmp.min_ver) == 0x0100) ? 0xff00 : (s-&gt;s3<br>-&gt;tmp.min_ver)))</span></span>))</td></tr>
<tr class="codeline" data-linenumber="893"><td class="num" id="LN893">893</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="894"><td class="num" id="LN894">894</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="895"><td class="num" id="LN895">895</td><td class="line">    <span class='keyword'>return</span> !ssl_security(s, op, c-&gt;strength_bits, 0, (<span class='keyword'>void</span> *)c);</td></tr>
<tr class="codeline" data-linenumber="896"><td class="num" id="LN896">896</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="897"><td class="num" id="LN897">897</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="898"><td class="num" id="LN898">898</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls_use_ticket(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="899"><td class="num" id="LN899">899</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="900"><td class="num" id="LN900">900</td><td class="line">    <span class='keyword'>if</span> (s-&gt;options &amp; <span class='macro'>SSL_OP_NO_TICKET<span class='macro_popup'>0x00004000U</span></span>)</td></tr>
<tr class="codeline" data-linenumber="901"><td class="num" id="LN901">901</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="902"><td class="num" id="LN902">902</td><td class="line">    <span class='keyword'>return</span> ssl_security(s, <span class='macro'>SSL_SECOP_TICKET<span class='macro_popup'>(10 | 0)</span></span>, 0, 0, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="903"><td class="num" id="LN903">903</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="904"><td class="num" id="LN904">904</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="905"><td class="num" id="LN905">905</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> compare_uint(<span class='keyword'>const</span> <span class='keyword'>void</span> *p1, <span class='keyword'>const</span> <span class='keyword'>void</span> *p2)</td></tr>
<tr class="codeline" data-linenumber="906"><td class="num" id="LN906">906</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="907"><td class="num" id="LN907">907</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> u1 = *((<span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>int</span> *)p1);</td></tr>
<tr class="codeline" data-linenumber="908"><td class="num" id="LN908">908</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> u2 = *((<span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>int</span> *)p2);</td></tr>
<tr class="codeline" data-linenumber="909"><td class="num" id="LN909">909</td><td class="line">    <span class='keyword'>if</span> (u1 &lt; u2)</td></tr>
<tr class="codeline" data-linenumber="910"><td class="num" id="LN910">910</td><td class="line">        <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="911"><td class="num" id="LN911">911</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (u1 &gt; u2)</td></tr>
<tr class="codeline" data-linenumber="912"><td class="num" id="LN912">912</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="913"><td class="num" id="LN913">913</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="914"><td class="num" id="LN914">914</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="915"><td class="num" id="LN915">915</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="916"><td class="num" id="LN916">916</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="917"><td class="num" id="LN917">917</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="918"><td class="num" id="LN918">918</td><td class="line"> <span class='comment'>* Per http://tools.ietf.org/html/rfc5246#section-7.4.1.4, there may not be</span></td></tr>
<tr class="codeline" data-linenumber="919"><td class="num" id="LN919">919</td><td class="line"> <span class='comment'>* more than one extension of the same type in a ClientHello or ServerHello.</span></td></tr>
<tr class="codeline" data-linenumber="920"><td class="num" id="LN920">920</td><td class="line"> <span class='comment'>* This function does an initial scan over the extensions block to filter those</span></td></tr>
<tr class="codeline" data-linenumber="921"><td class="num" id="LN921">921</td><td class="line"> <span class='comment'>* out. It returns 1 if all extensions are unique, and 0 if the extensions</span></td></tr>
<tr class="codeline" data-linenumber="922"><td class="num" id="LN922">922</td><td class="line"> <span class='comment'>* contain duplicates, could not be successfully parsed, or an internal error</span></td></tr>
<tr class="codeline" data-linenumber="923"><td class="num" id="LN923">923</td><td class="line"> <span class='comment'>* occurred.</span></td></tr>
<tr class="codeline" data-linenumber="924"><td class="num" id="LN924">924</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="925"><td class="num" id="LN925">925</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls1_check_duplicate_extensions(<span class='keyword'>const</span> PACKET *packet)</td></tr>
<tr class="codeline" data-linenumber="926"><td class="num" id="LN926">926</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="927"><td class="num" id="LN927">927</td><td class="line">    PACKET extensions = *packet;</td></tr>
<tr class="codeline" data-linenumber="928"><td class="num" id="LN928">928</td><td class="line">    size_t num_extensions = 0, i = 0;</td></tr>
<tr class="codeline" data-linenumber="929"><td class="num" id="LN929">929</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> *extension_types = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="930"><td class="num" id="LN930">930</td><td class="line">    <span class='keyword'>int</span> ret = 0;</td></tr>
<tr class="codeline" data-linenumber="931"><td class="num" id="LN931">931</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="932"><td class="num" id="LN932">932</td><td class="line">    <span class='comment'>/* First pass: count the extensions. */</span></td></tr>
<tr class="codeline" data-linenumber="933"><td class="num" id="LN933">933</td><td class="line">    <span class='keyword'>while</span> (PACKET_remaining(&amp;extensions) &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="934"><td class="num" id="LN934">934</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>int</span> type;</td></tr>
<tr class="codeline" data-linenumber="935"><td class="num" id="LN935">935</td><td class="line">        PACKET extension;</td></tr>
<tr class="codeline" data-linenumber="936"><td class="num" id="LN936">936</td><td class="line">        <span class='keyword'>if</span> (!PACKET_get_net_2(&amp;extensions, &amp;type) ||</td></tr>
<tr class="codeline" data-linenumber="937"><td class="num" id="LN937">937</td><td class="line">            !PACKET_get_length_prefixed_2(&amp;extensions, &amp;extension)) {</td></tr>
<tr class="codeline" data-linenumber="938"><td class="num" id="LN938">938</td><td class="line">            <span class='keyword'>goto</span> done;</td></tr>
<tr class="codeline" data-linenumber="939"><td class="num" id="LN939">939</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="940"><td class="num" id="LN940">940</td><td class="line">        num_extensions++;</td></tr>
<tr class="codeline" data-linenumber="941"><td class="num" id="LN941">941</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="942"><td class="num" id="LN942">942</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="943"><td class="num" id="LN943">943</td><td class="line">    <span class='keyword'>if</span> (num_extensions &lt;= 1)</td></tr>
<tr class="codeline" data-linenumber="944"><td class="num" id="LN944">944</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="945"><td class="num" id="LN945">945</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="946"><td class="num" id="LN946">946</td><td class="line">    extension_types = <span class='macro'>OPENSSL_malloc(<span class='keyword'>sizeof</span>(<span class='keyword'>unsigned</span> <span class='keyword'>int</span>) * num_extensions)<span class='macro_popup'>CRYPTO_malloc(sizeof(unsigned int) * num_extensions, "ssl/t1_lib.c"<br>, 946)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="947"><td class="num" id="LN947">947</td><td class="line">    <span class='keyword'>if</span> (extension_types == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="948"><td class="num" id="LN948">948</td><td class="line">        <span class='macro'>SSLerr(SSL_F_TLS1_CHECK_DUPLICATE_EXTENSIONS, ERR_R_MALLOC_FAILURE)<span class='macro_popup'>ERR_put_error(20,(341),((1|64)),"ssl/t1_lib.c",948)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="949"><td class="num" id="LN949">949</td><td class="line">        <span class='keyword'>goto</span> done;</td></tr>
<tr class="codeline" data-linenumber="950"><td class="num" id="LN950">950</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="951"><td class="num" id="LN951">951</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="952"><td class="num" id="LN952">952</td><td class="line">    <span class='comment'>/* Second pass: gather the extension types. */</span></td></tr>
<tr class="codeline" data-linenumber="953"><td class="num" id="LN953">953</td><td class="line">    extensions = *packet;</td></tr>
<tr class="codeline" data-linenumber="954"><td class="num" id="LN954">954</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; num_extensions; i++) {</td></tr>
<tr class="codeline" data-linenumber="955"><td class="num" id="LN955">955</td><td class="line">        PACKET extension;</td></tr>
<tr class="codeline" data-linenumber="956"><td class="num" id="LN956">956</td><td class="line">        <span class='keyword'>if</span> (!PACKET_get_net_2(&amp;extensions, &amp;extension_types[i]) ||</td></tr>
<tr class="codeline" data-linenumber="957"><td class="num" id="LN957">957</td><td class="line">            !PACKET_get_length_prefixed_2(&amp;extensions, &amp;extension)) {</td></tr>
<tr class="codeline" data-linenumber="958"><td class="num" id="LN958">958</td><td class="line">            <span class='comment'>/* This should not happen. */</span></td></tr>
<tr class="codeline" data-linenumber="959"><td class="num" id="LN959">959</td><td class="line">            <span class='macro'>SSLerr(SSL_F_TLS1_CHECK_DUPLICATE_EXTENSIONS, ERR_R_INTERNAL_ERROR)<span class='macro_popup'>ERR_put_error(20,(341),((4|64)),"ssl/t1_lib.c",959)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="960"><td class="num" id="LN960">960</td><td class="line">            <span class='keyword'>goto</span> done;</td></tr>
<tr class="codeline" data-linenumber="961"><td class="num" id="LN961">961</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="962"><td class="num" id="LN962">962</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="963"><td class="num" id="LN963">963</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="964"><td class="num" id="LN964">964</td><td class="line">    <span class='keyword'>if</span> (PACKET_remaining(&amp;extensions) != 0) {</td></tr>
<tr class="codeline" data-linenumber="965"><td class="num" id="LN965">965</td><td class="line">        <span class='macro'>SSLerr(SSL_F_TLS1_CHECK_DUPLICATE_EXTENSIONS, ERR_R_INTERNAL_ERROR)<span class='macro_popup'>ERR_put_error(20,(341),((4|64)),"ssl/t1_lib.c",965)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="966"><td class="num" id="LN966">966</td><td class="line">        <span class='keyword'>goto</span> done;</td></tr>
<tr class="codeline" data-linenumber="967"><td class="num" id="LN967">967</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="968"><td class="num" id="LN968">968</td><td class="line">    <span class='comment'>/* Sort the extensions and make sure there are no duplicates. */</span></td></tr>
<tr class="codeline" data-linenumber="969"><td class="num" id="LN969">969</td><td class="line">    qsort(extension_types, num_extensions, <span class='keyword'>sizeof</span>(<span class='keyword'>unsigned</span> <span class='keyword'>int</span>), compare_uint);</td></tr>
<tr class="codeline" data-linenumber="970"><td class="num" id="LN970">970</td><td class="line">    <span class='keyword'>for</span> (i = 1; i &lt; num_extensions; i++) {</td></tr>
<tr class="codeline" data-linenumber="971"><td class="num" id="LN971">971</td><td class="line">        <span class='keyword'>if</span> (extension_types[i - 1] == extension_types[i])</td></tr>
<tr class="codeline" data-linenumber="972"><td class="num" id="LN972">972</td><td class="line">            <span class='keyword'>goto</span> done;</td></tr>
<tr class="codeline" data-linenumber="973"><td class="num" id="LN973">973</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="974"><td class="num" id="LN974">974</td><td class="line">    ret = 1;</td></tr>
<tr class="codeline" data-linenumber="975"><td class="num" id="LN975">975</td><td class="line"> done:</td></tr>
<tr class="codeline" data-linenumber="976"><td class="num" id="LN976">976</td><td class="line">    <span class='macro'>OPENSSL_free(extension_types)<span class='macro_popup'>CRYPTO_free(extension_types, "ssl/t1_lib.c", 976)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="977"><td class="num" id="LN977">977</td><td class="line">    <span class='keyword'>return</span> ret;</td></tr>
<tr class="codeline" data-linenumber="978"><td class="num" id="LN978">978</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="979"><td class="num" id="LN979">979</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="980"><td class="num" id="LN980">980</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>char</span> *ssl_add_clienthello_tlsext(SSL *s, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *buf,</td></tr>
<tr class="codeline" data-linenumber="981"><td class="num" id="LN981">981</td><td class="line">                                          <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *limit, <span class='keyword'>int</span> *al)</td></tr>
<tr class="codeline" data-linenumber="982"><td class="num" id="LN982">982</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="983"><td class="num" id="LN983">983</td><td class="line">    <span class='keyword'>int</span> extdatalen = 0;</td></tr>
<tr class="codeline" data-linenumber="984"><td class="num" id="LN984">984</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *orig = buf;</td></tr>
<tr class="codeline" data-linenumber="985"><td class="num" id="LN985">985</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *ret = buf;</td></tr>
<tr class="codeline" data-linenumber="986"><td class="num" id="LN986">986</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="987"><td class="num" id="LN987">987</td><td class="line">    <span class='comment'>/* See if we support any ECC ciphersuites */</span></td></tr>
<tr class="codeline" data-linenumber="988"><td class="num" id="LN988">988</td><td class="line">    <span class='keyword'>int</span> using_ecc = 0;</td></tr>
<tr class="codeline" data-linenumber="989"><td class="num" id="LN989">989</td><td class="line">    <span class='keyword'>if</span> (s-&gt;version &gt;= <span class='macro'>TLS1_VERSION<span class='macro_popup'>0x0301</span></span> || <span class='macro'>SSL_IS_DTLS(s)<span class='macro_popup'>(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="990"><td class="num" id="LN990">990</td><td class="line">        <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="991"><td class="num" id="LN991">991</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>long</span> alg_k, alg_a;</td></tr>
<tr class="codeline" data-linenumber="992"><td class="num" id="LN992">992</td><td class="line">        <span class='macro'>STACK_OF(SSL_CIPHER)<span class='macro_popup'>struct stack_st_SSL_CIPHER</span></span> *cipher_stack = SSL_get_ciphers(s);</td></tr>
<tr class="codeline" data-linenumber="993"><td class="num" id="LN993">993</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="994"><td class="num" id="LN994">994</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; sk_SSL_CIPHER_num(cipher_stack); i++) {</td></tr>
<tr class="codeline" data-linenumber="995"><td class="num" id="LN995">995</td><td class="line">            <span class='keyword'>const</span> SSL_CIPHER *c = sk_SSL_CIPHER_value(cipher_stack, i);</td></tr>
<tr class="codeline" data-linenumber="996"><td class="num" id="LN996">996</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="997"><td class="num" id="LN997">997</td><td class="line">            alg_k = c-&gt;algorithm_mkey;</td></tr>
<tr class="codeline" data-linenumber="998"><td class="num" id="LN998">998</td><td class="line">            alg_a = c-&gt;algorithm_auth;</td></tr>
<tr class="codeline" data-linenumber="999"><td class="num" id="LN999">999</td><td class="line">            <span class='keyword'>if</span> ((alg_k &amp; (<span class='macro'>SSL_kECDHE<span class='macro_popup'>0x00000004U</span></span> | <span class='macro'>SSL_kECDHEPSK<span class='macro_popup'>0x00000080U</span></span>))</td></tr>
<tr class="codeline" data-linenumber="1000"><td class="num" id="LN1000">1000</td><td class="line">                || (alg_a &amp; <span class='macro'>SSL_aECDSA<span class='macro_popup'>0x00000008U</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="1001"><td class="num" id="LN1001">1001</td><td class="line">                using_ecc = 1;</td></tr>
<tr class="codeline" data-linenumber="1002"><td class="num" id="LN1002">1002</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1003"><td class="num" id="LN1003">1003</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1004"><td class="num" id="LN1004">1004</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1005"><td class="num" id="LN1005">1005</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1006"><td class="num" id="LN1006">1006</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1007"><td class="num" id="LN1007">1007</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1008"><td class="num" id="LN1008">1008</td><td class="line">    ret += 2;</td></tr>
<tr class="codeline" data-linenumber="1009"><td class="num" id="LN1009">1009</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1010"><td class="num" id="LN1010">1010</td><td class="line">    <span class='keyword'>if</span> (ret &gt;= limit)</td></tr>
<tr class="codeline" data-linenumber="1011"><td class="num" id="LN1011">1011</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;            <span class='comment'>/* this really never occurs, but ... */</span></td></tr>
<tr class="codeline" data-linenumber="1012"><td class="num" id="LN1012">1012</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1013"><td class="num" id="LN1013">1013</td><td class="line">    <span class='comment'>/* Add RI if renegotiating */</span></td></tr>
<tr class="codeline" data-linenumber="1014"><td class="num" id="LN1014">1014</td><td class="line">    <span class='keyword'>if</span> (s-&gt;renegotiate) {</td></tr>
<tr class="codeline" data-linenumber="1015"><td class="num" id="LN1015">1015</td><td class="line">        <span class='keyword'>int</span> el;</td></tr>
<tr class="codeline" data-linenumber="1016"><td class="num" id="LN1016">1016</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1017"><td class="num" id="LN1017">1017</td><td class="line">        <span class='keyword'>if</span> (!ssl_add_clienthello_renegotiate_ext(s, 0, &amp;el, 0)) {</td></tr>
<tr class="codeline" data-linenumber="1018"><td class="num" id="LN1018">1018</td><td class="line">            <span class='macro'>SSLerr(SSL_F_SSL_ADD_CLIENTHELLO_TLSEXT, ERR_R_INTERNAL_ERROR)<span class='macro_popup'>ERR_put_error(20,(277),((4|64)),"ssl/t1_lib.c",1018)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1019"><td class="num" id="LN1019">1019</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1020"><td class="num" id="LN1020">1020</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1021"><td class="num" id="LN1021">1021</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1022"><td class="num" id="LN1022">1022</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 4 + el, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(4 + el))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1023"><td class="num" id="LN1023">1023</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1024"><td class="num" id="LN1024">1024</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1025"><td class="num" id="LN1025">1025</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_renegotiate, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((0xff01)&gt;&gt; 8)&amp;0xff), (ret<br>)[1]=(unsigned char)(((0xff01) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1026"><td class="num" id="LN1026">1026</td><td class="line">        <span class='macro'>s2n(el, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((el)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((el) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1027"><td class="num" id="LN1027">1027</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1028"><td class="num" id="LN1028">1028</td><td class="line">        <span class='keyword'>if</span> (!ssl_add_clienthello_renegotiate_ext(s, ret, &amp;el, el)) {</td></tr>
<tr class="codeline" data-linenumber="1029"><td class="num" id="LN1029">1029</td><td class="line">            <span class='macro'>SSLerr(SSL_F_SSL_ADD_CLIENTHELLO_TLSEXT, ERR_R_INTERNAL_ERROR)<span class='macro_popup'>ERR_put_error(20,(277),((4|64)),"ssl/t1_lib.c",1029)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1030"><td class="num" id="LN1030">1030</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1031"><td class="num" id="LN1031">1031</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1032"><td class="num" id="LN1032">1032</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1033"><td class="num" id="LN1033">1033</td><td class="line">        ret += el;</td></tr>
<tr class="codeline" data-linenumber="1034"><td class="num" id="LN1034">1034</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1035"><td class="num" id="LN1035">1035</td><td class="line">    <span class='comment'>/* Only add RI for SSLv3 */</span></td></tr>
<tr class="codeline" data-linenumber="1036"><td class="num" id="LN1036">1036</td><td class="line">    <span class='keyword'>if</span> (s-&gt;client_version == <span class='macro'>SSL3_VERSION<span class='macro_popup'>0x0300</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1037"><td class="num" id="LN1037">1037</td><td class="line">        <span class='keyword'>goto</span> done;</td></tr>
<tr class="codeline" data-linenumber="1038"><td class="num" id="LN1038">1038</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1039"><td class="num" id="LN1039">1039</td><td class="line">    <span class='keyword'>if</span> (s-&gt;tlsext_hostname != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1040"><td class="num" id="LN1040">1040</td><td class="line">        <span class='comment'>/* Add TLS extension servername to the Client Hello message */</span></td></tr>
<tr class="codeline" data-linenumber="1041"><td class="num" id="LN1041">1041</td><td class="line">        size_t size_str;</td></tr>
<tr class="codeline" data-linenumber="1042"><td class="num" id="LN1042">1042</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1043"><td class="num" id="LN1043">1043</td><td class="line">        <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1044"><td class="num" id="LN1044">1044</td><td class="line">         <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1045"><td class="num" id="LN1045">1045</td><td class="line">         <span class='comment'>* 4 for the servername type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1046"><td class="num" id="LN1046">1046</td><td class="line">         <span class='comment'>* 2 for servernamelist length</span></td></tr>
<tr class="codeline" data-linenumber="1047"><td class="num" id="LN1047">1047</td><td class="line">         <span class='comment'>* 1 for the hostname type</span></td></tr>
<tr class="codeline" data-linenumber="1048"><td class="num" id="LN1048">1048</td><td class="line">         <span class='comment'>* 2 for hostname length</span></td></tr>
<tr class="codeline" data-linenumber="1049"><td class="num" id="LN1049">1049</td><td class="line">         <span class='comment'>* + hostname length</span></td></tr>
<tr class="codeline" data-linenumber="1050"><td class="num" id="LN1050">1050</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1051"><td class="num" id="LN1051">1051</td><td class="line">        size_str = strlen(s-&gt;tlsext_hostname);</td></tr>
<tr class="codeline" data-linenumber="1052"><td class="num" id="LN1052">1052</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 9 + size_str, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(9 + size_str))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1053"><td class="num" id="LN1053">1053</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1054"><td class="num" id="LN1054">1054</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1055"><td class="num" id="LN1055">1055</td><td class="line">        <span class='comment'>/* extension type and length */</span></td></tr>
<tr class="codeline" data-linenumber="1056"><td class="num" id="LN1056">1056</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_server_name, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((0)&gt;&gt; 8)&amp;0xff), (ret)[1<br>]=(unsigned char)(((0) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1057"><td class="num" id="LN1057">1057</td><td class="line">        <span class='macro'>s2n(size_str + 5, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((size_str + 5)&gt;&gt; 8)&amp;0xff<br>), (ret)[1]=(unsigned char)(((size_str + 5) )&amp;0xff)),(ret<br>)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1058"><td class="num" id="LN1058">1058</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1059"><td class="num" id="LN1059">1059</td><td class="line">        <span class='comment'>/* length of servername list */</span></td></tr>
<tr class="codeline" data-linenumber="1060"><td class="num" id="LN1060">1060</td><td class="line">        <span class='macro'>s2n(size_str + 3, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((size_str + 3)&gt;&gt; 8)&amp;0xff<br>), (ret)[1]=(unsigned char)(((size_str + 3) )&amp;0xff)),(ret<br>)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1061"><td class="num" id="LN1061">1061</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1062"><td class="num" id="LN1062">1062</td><td class="line">        <span class='comment'>/* hostname type, length and hostname */</span></td></tr>
<tr class="codeline" data-linenumber="1063"><td class="num" id="LN1063">1063</td><td class="line">        *(ret++) = (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>)<span class='macro'>TLSEXT_NAMETYPE_host_name<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1064"><td class="num" id="LN1064">1064</td><td class="line">        <span class='macro'>s2n(size_str, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((size_str)&gt;&gt; 8)&amp;0xff), (<br>ret)[1]=(unsigned char)(((size_str) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1065"><td class="num" id="LN1065">1065</td><td class="line">        memcpy(ret, s-&gt;tlsext_hostname, size_str);</td></tr>
<tr class="codeline" data-linenumber="1066"><td class="num" id="LN1066">1066</td><td class="line">        ret += size_str;</td></tr>
<tr class="codeline" data-linenumber="1067"><td class="num" id="LN1067">1067</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1068"><td class="num" id="LN1068">1068</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_SRP</span></td></tr>
<tr class="codeline" data-linenumber="1069"><td class="num" id="LN1069">1069</td><td class="line">    <span class='comment'>/* Add SRP username if there is one */</span></td></tr>
<tr class="codeline" data-linenumber="1070"><td class="num" id="LN1070">1070</td><td class="line">    <span class='keyword'>if</span> (s-&gt;srp_ctx.login != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) { <span class='comment'>/* Add TLS extension SRP username to the</span></td></tr>
<tr class="codeline" data-linenumber="1071"><td class="num" id="LN1071">1071</td><td class="line">                                     <span class='comment'>* Client Hello message */</span></td></tr>
<tr class="codeline" data-linenumber="1072"><td class="num" id="LN1072">1072</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1073"><td class="num" id="LN1073">1073</td><td class="line">        size_t login_len = strlen(s-&gt;srp_ctx.login);</td></tr>
<tr class="codeline" data-linenumber="1074"><td class="num" id="LN1074">1074</td><td class="line">        <span class='keyword'>if</span> (login_len &gt; 255 || login_len == 0) {</td></tr>
<tr class="codeline" data-linenumber="1075"><td class="num" id="LN1075">1075</td><td class="line">            <span class='macro'>SSLerr(SSL_F_SSL_ADD_CLIENTHELLO_TLSEXT, ERR_R_INTERNAL_ERROR)<span class='macro_popup'>ERR_put_error(20,(277),((4|64)),"ssl/t1_lib.c",1075)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1076"><td class="num" id="LN1076">1076</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1077"><td class="num" id="LN1077">1077</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1078"><td class="num" id="LN1078">1078</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1079"><td class="num" id="LN1079">1079</td><td class="line">        <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1080"><td class="num" id="LN1080">1080</td><td class="line">         <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1081"><td class="num" id="LN1081">1081</td><td class="line">         <span class='comment'>* 4 for the srp type type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1082"><td class="num" id="LN1082">1082</td><td class="line">         <span class='comment'>* 1 for the srp user identity</span></td></tr>
<tr class="codeline" data-linenumber="1083"><td class="num" id="LN1083">1083</td><td class="line">         <span class='comment'>* + srp user identity length</span></td></tr>
<tr class="codeline" data-linenumber="1084"><td class="num" id="LN1084">1084</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1085"><td class="num" id="LN1085">1085</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 5 + login_len, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(5 + login_len))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1086"><td class="num" id="LN1086">1086</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1087"><td class="num" id="LN1087">1087</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1088"><td class="num" id="LN1088">1088</td><td class="line">        <span class='comment'>/* fill in the extension */</span></td></tr>
<tr class="codeline" data-linenumber="1089"><td class="num" id="LN1089">1089</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_srp, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((12)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((12) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1090"><td class="num" id="LN1090">1090</td><td class="line">        <span class='macro'>s2n(login_len + 1, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((login_len + 1)&gt;&gt; 8)&amp;0xff<br>), (ret)[1]=(unsigned char)(((login_len + 1) )&amp;0xff)),(ret<br>)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1091"><td class="num" id="LN1091">1091</td><td class="line">        (*ret++) = (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>)login_len;</td></tr>
<tr class="codeline" data-linenumber="1092"><td class="num" id="LN1092">1092</td><td class="line">        memcpy(ret, s-&gt;srp_ctx.login, login_len);</td></tr>
<tr class="codeline" data-linenumber="1093"><td class="num" id="LN1093">1093</td><td class="line">        ret += login_len;</td></tr>
<tr class="codeline" data-linenumber="1094"><td class="num" id="LN1094">1094</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1095"><td class="num" id="LN1095">1095</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1096"><td class="num" id="LN1096">1096</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1097"><td class="num" id="LN1097">1097</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="1098"><td class="num" id="LN1098">1098</td><td class="line">    <span class='keyword'>if</span> (using_ecc) {</td></tr>
<tr class="codeline" data-linenumber="1099"><td class="num" id="LN1099">1099</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1100"><td class="num" id="LN1100">1100</td><td class="line">         <span class='comment'>* Add TLS extension ECPointFormats to the ClientHello message</span></td></tr>
<tr class="codeline" data-linenumber="1101"><td class="num" id="LN1101">1101</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1102"><td class="num" id="LN1102">1102</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *pcurves, *pformats;</td></tr>
<tr class="codeline" data-linenumber="1103"><td class="num" id="LN1103">1103</td><td class="line">        size_t num_curves, num_formats, curves_list_len;</td></tr>
<tr class="codeline" data-linenumber="1104"><td class="num" id="LN1104">1104</td><td class="line">        size_t i;</td></tr>
<tr class="codeline" data-linenumber="1105"><td class="num" id="LN1105">1105</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *etmp;</td></tr>
<tr class="codeline" data-linenumber="1106"><td class="num" id="LN1106">1106</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1107"><td class="num" id="LN1107">1107</td><td class="line">        tls1_get_formatlist(s, &amp;pformats, &amp;num_formats);</td></tr>
<tr class="codeline" data-linenumber="1108"><td class="num" id="LN1108">1108</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1109"><td class="num" id="LN1109">1109</td><td class="line">        <span class='keyword'>if</span> (num_formats &gt; 255) {</td></tr>
<tr class="codeline" data-linenumber="1110"><td class="num" id="LN1110">1110</td><td class="line">            <span class='macro'>SSLerr(SSL_F_SSL_ADD_CLIENTHELLO_TLSEXT, ERR_R_INTERNAL_ERROR)<span class='macro_popup'>ERR_put_error(20,(277),((4|64)),"ssl/t1_lib.c",1110)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1111"><td class="num" id="LN1111">1111</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1112"><td class="num" id="LN1112">1112</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1113"><td class="num" id="LN1113">1113</td><td class="line">        <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1114"><td class="num" id="LN1114">1114</td><td class="line">         <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1115"><td class="num" id="LN1115">1115</td><td class="line">         <span class='comment'>* 4 bytes for the ec point formats type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1116"><td class="num" id="LN1116">1116</td><td class="line">         <span class='comment'>* 1 byte for the length of the formats</span></td></tr>
<tr class="codeline" data-linenumber="1117"><td class="num" id="LN1117">1117</td><td class="line">         <span class='comment'>* + formats length</span></td></tr>
<tr class="codeline" data-linenumber="1118"><td class="num" id="LN1118">1118</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1119"><td class="num" id="LN1119">1119</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 5 + num_formats, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(5 + num_formats))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1120"><td class="num" id="LN1120">1120</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1121"><td class="num" id="LN1121">1121</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1122"><td class="num" id="LN1122">1122</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_ec_point_formats, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((11)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((11) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1123"><td class="num" id="LN1123">1123</td><td class="line">        <span class='comment'>/* The point format list has 1-byte length. */</span></td></tr>
<tr class="codeline" data-linenumber="1124"><td class="num" id="LN1124">1124</td><td class="line">        <span class='macro'>s2n(num_formats + 1, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((num_formats + 1)&gt;&gt; 8)&amp;<br>0xff), (ret)[1]=(unsigned char)(((num_formats + 1) )&amp;0xff<br>)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1125"><td class="num" id="LN1125">1125</td><td class="line">        *(ret++) = (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>)num_formats;</td></tr>
<tr class="codeline" data-linenumber="1126"><td class="num" id="LN1126">1126</td><td class="line">        memcpy(ret, pformats, num_formats);</td></tr>
<tr class="codeline" data-linenumber="1127"><td class="num" id="LN1127">1127</td><td class="line">        ret += num_formats;</td></tr>
<tr class="codeline" data-linenumber="1128"><td class="num" id="LN1128">1128</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1129"><td class="num" id="LN1129">1129</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1130"><td class="num" id="LN1130">1130</td><td class="line">         <span class='comment'>* Add TLS extension EllipticCurves to the ClientHello message</span></td></tr>
<tr class="codeline" data-linenumber="1131"><td class="num" id="LN1131">1131</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1132"><td class="num" id="LN1132">1132</td><td class="line">        pcurves = s-&gt;tlsext_ellipticcurvelist;</td></tr>
<tr class="codeline" data-linenumber="1133"><td class="num" id="LN1133">1133</td><td class="line">        <span class='keyword'>if</span> (!tls1_get_curvelist(s, 0, &amp;pcurves, &amp;num_curves))</td></tr>
<tr class="codeline" data-linenumber="1134"><td class="num" id="LN1134">1134</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1135"><td class="num" id="LN1135">1135</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1136"><td class="num" id="LN1136">1136</td><td class="line">        <span class='keyword'>if</span> (num_curves &gt; 65532 / 2) {</td></tr>
<tr class="codeline" data-linenumber="1137"><td class="num" id="LN1137">1137</td><td class="line">            <span class='macro'>SSLerr(SSL_F_SSL_ADD_CLIENTHELLO_TLSEXT, ERR_R_INTERNAL_ERROR)<span class='macro_popup'>ERR_put_error(20,(277),((4|64)),"ssl/t1_lib.c",1137)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1138"><td class="num" id="LN1138">1138</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1139"><td class="num" id="LN1139">1139</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1140"><td class="num" id="LN1140">1140</td><td class="line">        <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1141"><td class="num" id="LN1141">1141</td><td class="line">         <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1142"><td class="num" id="LN1142">1142</td><td class="line">         <span class='comment'>* 4 bytes for the ec curves type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1143"><td class="num" id="LN1143">1143</td><td class="line">         <span class='comment'>* 2 bytes for the curve list length</span></td></tr>
<tr class="codeline" data-linenumber="1144"><td class="num" id="LN1144">1144</td><td class="line">         <span class='comment'>* + curve list length</span></td></tr>
<tr class="codeline" data-linenumber="1145"><td class="num" id="LN1145">1145</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1146"><td class="num" id="LN1146">1146</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 6 + (num_curves * 2), limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(6 + (num_curves * 2)))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1147"><td class="num" id="LN1147">1147</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1148"><td class="num" id="LN1148">1148</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1149"><td class="num" id="LN1149">1149</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_elliptic_curves, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((10)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((10) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1150"><td class="num" id="LN1150">1150</td><td class="line">        etmp = ret + 4;</td></tr>
<tr class="codeline" data-linenumber="1151"><td class="num" id="LN1151">1151</td><td class="line">        <span class='comment'>/* Copy curve ID if supported */</span></td></tr>
<tr class="codeline" data-linenumber="1152"><td class="num" id="LN1152">1152</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; num_curves; i++, pcurves += 2) {</td></tr>
<tr class="codeline" data-linenumber="1153"><td class="num" id="LN1153">1153</td><td class="line">            <span class='keyword'>if</span> (tls_curve_allowed(s, pcurves, <span class='macro'>SSL_SECOP_CURVE_SUPPORTED<span class='macro_popup'>(4 | (2 &lt;&lt; 16))</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="1154"><td class="num" id="LN1154">1154</td><td class="line">                *etmp++ = pcurves[0];</td></tr>
<tr class="codeline" data-linenumber="1155"><td class="num" id="LN1155">1155</td><td class="line">                *etmp++ = pcurves[1];</td></tr>
<tr class="codeline" data-linenumber="1156"><td class="num" id="LN1156">1156</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1157"><td class="num" id="LN1157">1157</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1158"><td class="num" id="LN1158">1158</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1159"><td class="num" id="LN1159">1159</td><td class="line">        curves_list_len = etmp - ret - 4;</td></tr>
<tr class="codeline" data-linenumber="1160"><td class="num" id="LN1160">1160</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1161"><td class="num" id="LN1161">1161</td><td class="line">        <span class='macro'>s2n(curves_list_len + 2, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((curves_list_len + 2)&gt;&gt; 8)&amp;<br>0xff), (ret)[1]=(unsigned char)(((curves_list_len + 2) )&amp;<br>0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1162"><td class="num" id="LN1162">1162</td><td class="line">        <span class='macro'>s2n(curves_list_len, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((curves_list_len)&gt;&gt; 8)&amp;<br>0xff), (ret)[1]=(unsigned char)(((curves_list_len) )&amp;0xff<br>)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1163"><td class="num" id="LN1163">1163</td><td class="line">        ret += curves_list_len;</td></tr>
<tr class="codeline" data-linenumber="1164"><td class="num" id="LN1164">1164</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1165"><td class="num" id="LN1165">1165</td><td class="line"><span class='directive'>#endif                          /* OPENSSL_NO_EC */</span></td></tr>
<tr class="codeline" data-linenumber="1166"><td class="num" id="LN1166">1166</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1167"><td class="num" id="LN1167">1167</td><td class="line">    <span class='keyword'>if</span> (tls_use_ticket(s)) {</td></tr>
<tr class="codeline" data-linenumber="1168"><td class="num" id="LN1168">1168</td><td class="line">        size_t ticklen;</td></tr>
<tr class="codeline" data-linenumber="1169"><td class="num" id="LN1169">1169</td><td class="line">        <span class='keyword'>if</span> (!s-&gt;new_session &amp;&amp; s-&gt;session &amp;&amp; s-&gt;session-&gt;tlsext_tick)</td></tr>
<tr class="codeline" data-linenumber="1170"><td class="num" id="LN1170">1170</td><td class="line">            ticklen = s-&gt;session-&gt;tlsext_ticklen;</td></tr>
<tr class="codeline" data-linenumber="1171"><td class="num" id="LN1171">1171</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (s-&gt;session &amp;&amp; s-&gt;tlsext_session_ticket &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1172"><td class="num" id="LN1172">1172</td><td class="line">                 s-&gt;tlsext_session_ticket-&gt;data) {</td></tr>
<tr class="codeline" data-linenumber="1173"><td class="num" id="LN1173">1173</td><td class="line">            ticklen = s-&gt;tlsext_session_ticket-&gt;length;</td></tr>
<tr class="codeline" data-linenumber="1174"><td class="num" id="LN1174">1174</td><td class="line">            s-&gt;session-&gt;tlsext_tick = <span class='macro'>OPENSSL_malloc(ticklen)<span class='macro_popup'>CRYPTO_malloc(ticklen, "ssl/t1_lib.c", 1174)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1175"><td class="num" id="LN1175">1175</td><td class="line">            <span class='keyword'>if</span> (s-&gt;session-&gt;tlsext_tick == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1176"><td class="num" id="LN1176">1176</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1177"><td class="num" id="LN1177">1177</td><td class="line">            memcpy(s-&gt;session-&gt;tlsext_tick,</td></tr>
<tr class="codeline" data-linenumber="1178"><td class="num" id="LN1178">1178</td><td class="line">                   s-&gt;tlsext_session_ticket-&gt;data, ticklen);</td></tr>
<tr class="codeline" data-linenumber="1179"><td class="num" id="LN1179">1179</td><td class="line">            s-&gt;session-&gt;tlsext_ticklen = ticklen;</td></tr>
<tr class="codeline" data-linenumber="1180"><td class="num" id="LN1180">1180</td><td class="line">        } <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1181"><td class="num" id="LN1181">1181</td><td class="line">            ticklen = 0;</td></tr>
<tr class="codeline" data-linenumber="1182"><td class="num" id="LN1182">1182</td><td class="line">        <span class='keyword'>if</span> (ticklen == 0 &amp;&amp; s-&gt;tlsext_session_ticket &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1183"><td class="num" id="LN1183">1183</td><td class="line">            s-&gt;tlsext_session_ticket-&gt;data == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1184"><td class="num" id="LN1184">1184</td><td class="line">            <span class='keyword'>goto</span> skip_ext;</td></tr>
<tr class="codeline" data-linenumber="1185"><td class="num" id="LN1185">1185</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1186"><td class="num" id="LN1186">1186</td><td class="line">         <span class='comment'>* Check for enough room 2 for extension type, 2 for len rest for</span></td></tr>
<tr class="codeline" data-linenumber="1187"><td class="num" id="LN1187">1187</td><td class="line">         <span class='comment'>* ticket</span></td></tr>
<tr class="codeline" data-linenumber="1188"><td class="num" id="LN1188">1188</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1189"><td class="num" id="LN1189">1189</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 4 + ticklen, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(4 + ticklen))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1190"><td class="num" id="LN1190">1190</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1191"><td class="num" id="LN1191">1191</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_session_ticket, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((35)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((35) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1192"><td class="num" id="LN1192">1192</td><td class="line">        <span class='macro'>s2n(ticklen, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((ticklen)&gt;&gt; 8)&amp;0xff), (<br>ret)[1]=(unsigned char)(((ticklen) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1193"><td class="num" id="LN1193">1193</td><td class="line">        <span class='keyword'>if</span> (ticklen &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="1194"><td class="num" id="LN1194">1194</td><td class="line">            <span class="mrange">memcpy</span>(ret, s-&gt;session-&gt;tlsext_tick, ticklen);</td></tr>
<tr><td class="num"></td><td class="line"><div id="EndPath" class="msg msgEvent" style="margin-left:13ex; max-width:58em">Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11</div></td></tr>
<tr class="codeline" data-linenumber="1195"><td class="num" id="LN1195">1195</td><td class="line">            ret += ticklen;</td></tr>
<tr class="codeline" data-linenumber="1196"><td class="num" id="LN1196">1196</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1197"><td class="num" id="LN1197">1197</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1198"><td class="num" id="LN1198">1198</td><td class="line"> skip_ext:</td></tr>
<tr class="codeline" data-linenumber="1199"><td class="num" id="LN1199">1199</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1200"><td class="num" id="LN1200">1200</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_OCSP</span></td></tr>
<tr class="codeline" data-linenumber="1201"><td class="num" id="LN1201">1201</td><td class="line">    <span class='keyword'>if</span> (s-&gt;tlsext_status_type == <span class='macro'>TLSEXT_STATUSTYPE_ocsp<span class='macro_popup'>1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1202"><td class="num" id="LN1202">1202</td><td class="line">        <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="1203"><td class="num" id="LN1203">1203</td><td class="line">        size_t extlen, idlen;</td></tr>
<tr class="codeline" data-linenumber="1204"><td class="num" id="LN1204">1204</td><td class="line">        <span class='keyword'>int</span> lentmp;</td></tr>
<tr class="codeline" data-linenumber="1205"><td class="num" id="LN1205">1205</td><td class="line">        OCSP_RESPID *id;</td></tr>
<tr class="codeline" data-linenumber="1206"><td class="num" id="LN1206">1206</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1207"><td class="num" id="LN1207">1207</td><td class="line">        idlen = 0;</td></tr>
<tr class="codeline" data-linenumber="1208"><td class="num" id="LN1208">1208</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; sk_OCSP_RESPID_num(s-&gt;tlsext_ocsp_ids); i++) {</td></tr>
<tr class="codeline" data-linenumber="1209"><td class="num" id="LN1209">1209</td><td class="line">            id = sk_OCSP_RESPID_value(s-&gt;tlsext_ocsp_ids, i);</td></tr>
<tr class="codeline" data-linenumber="1210"><td class="num" id="LN1210">1210</td><td class="line">            lentmp = i2d_OCSP_RESPID(id, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1211"><td class="num" id="LN1211">1211</td><td class="line">            <span class='keyword'>if</span> (lentmp &lt;= 0)</td></tr>
<tr class="codeline" data-linenumber="1212"><td class="num" id="LN1212">1212</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1213"><td class="num" id="LN1213">1213</td><td class="line">            idlen += (size_t)lentmp + 2;</td></tr>
<tr class="codeline" data-linenumber="1214"><td class="num" id="LN1214">1214</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1215"><td class="num" id="LN1215">1215</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1216"><td class="num" id="LN1216">1216</td><td class="line">        <span class='keyword'>if</span> (s-&gt;tlsext_ocsp_exts) {</td></tr>
<tr class="codeline" data-linenumber="1217"><td class="num" id="LN1217">1217</td><td class="line">            lentmp = i2d_X509_EXTENSIONS(s-&gt;tlsext_ocsp_exts, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1218"><td class="num" id="LN1218">1218</td><td class="line">            <span class='keyword'>if</span> (lentmp &lt; 0)</td></tr>
<tr class="codeline" data-linenumber="1219"><td class="num" id="LN1219">1219</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1220"><td class="num" id="LN1220">1220</td><td class="line">            extlen = (size_t)lentmp;</td></tr>
<tr class="codeline" data-linenumber="1221"><td class="num" id="LN1221">1221</td><td class="line">        } <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1222"><td class="num" id="LN1222">1222</td><td class="line">            extlen = 0;</td></tr>
<tr class="codeline" data-linenumber="1223"><td class="num" id="LN1223">1223</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1224"><td class="num" id="LN1224">1224</td><td class="line">        <span class='keyword'>if</span> (extlen + idlen &gt; 0xFFF0)</td></tr>
<tr class="codeline" data-linenumber="1225"><td class="num" id="LN1225">1225</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1226"><td class="num" id="LN1226">1226</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1227"><td class="num" id="LN1227">1227</td><td class="line">         <span class='comment'>* 2 bytes for status request type</span></td></tr>
<tr class="codeline" data-linenumber="1228"><td class="num" id="LN1228">1228</td><td class="line">         <span class='comment'>* 2 bytes for status request len</span></td></tr>
<tr class="codeline" data-linenumber="1229"><td class="num" id="LN1229">1229</td><td class="line">         <span class='comment'>* 1 byte for OCSP request type</span></td></tr>
<tr class="codeline" data-linenumber="1230"><td class="num" id="LN1230">1230</td><td class="line">         <span class='comment'>* 2 bytes for length of ids</span></td></tr>
<tr class="codeline" data-linenumber="1231"><td class="num" id="LN1231">1231</td><td class="line">         <span class='comment'>* 2 bytes for length of extensions</span></td></tr>
<tr class="codeline" data-linenumber="1232"><td class="num" id="LN1232">1232</td><td class="line">         <span class='comment'>* + length of ids</span></td></tr>
<tr class="codeline" data-linenumber="1233"><td class="num" id="LN1233">1233</td><td class="line">         <span class='comment'>* + length of extensions</span></td></tr>
<tr class="codeline" data-linenumber="1234"><td class="num" id="LN1234">1234</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1235"><td class="num" id="LN1235">1235</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 9 + idlen + extlen, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(9 + idlen + extlen))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1236"><td class="num" id="LN1236">1236</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1237"><td class="num" id="LN1237">1237</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1238"><td class="num" id="LN1238">1238</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_status_request, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((5)&gt;&gt; 8)&amp;0xff), (ret)[1<br>]=(unsigned char)(((5) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1239"><td class="num" id="LN1239">1239</td><td class="line">        <span class='macro'>s2n(extlen + idlen + 5, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((extlen + idlen + 5)&gt;&gt; 8)&amp;<br>0xff), (ret)[1]=(unsigned char)(((extlen + idlen + 5) )&amp;0xff<br>)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1240"><td class="num" id="LN1240">1240</td><td class="line">        *(ret++) = <span class='macro'>TLSEXT_STATUSTYPE_ocsp<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1241"><td class="num" id="LN1241">1241</td><td class="line">        <span class='macro'>s2n(idlen, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((idlen)&gt;&gt; 8)&amp;0xff), (ret<br>)[1]=(unsigned char)(((idlen) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1242"><td class="num" id="LN1242">1242</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; sk_OCSP_RESPID_num(s-&gt;tlsext_ocsp_ids); i++) {</td></tr>
<tr class="codeline" data-linenumber="1243"><td class="num" id="LN1243">1243</td><td class="line">            <span class='comment'>/* save position of id len */</span></td></tr>
<tr class="codeline" data-linenumber="1244"><td class="num" id="LN1244">1244</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *q = ret;</td></tr>
<tr class="codeline" data-linenumber="1245"><td class="num" id="LN1245">1245</td><td class="line">            id = sk_OCSP_RESPID_value(s-&gt;tlsext_ocsp_ids, i);</td></tr>
<tr class="codeline" data-linenumber="1246"><td class="num" id="LN1246">1246</td><td class="line">            <span class='comment'>/* skip over id len */</span></td></tr>
<tr class="codeline" data-linenumber="1247"><td class="num" id="LN1247">1247</td><td class="line">            ret += 2;</td></tr>
<tr class="codeline" data-linenumber="1248"><td class="num" id="LN1248">1248</td><td class="line">            lentmp = i2d_OCSP_RESPID(id, &amp;ret);</td></tr>
<tr class="codeline" data-linenumber="1249"><td class="num" id="LN1249">1249</td><td class="line">            <span class='comment'>/* write id len */</span></td></tr>
<tr class="codeline" data-linenumber="1250"><td class="num" id="LN1250">1250</td><td class="line">            <span class='macro'>s2n(lentmp, q)<span class='macro_popup'>(((q)[0]=(unsigned char)(((lentmp)&gt;&gt; 8)&amp;0xff), (q)[<br>1]=(unsigned char)(((lentmp) )&amp;0xff)),(q)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1251"><td class="num" id="LN1251">1251</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1252"><td class="num" id="LN1252">1252</td><td class="line">        <span class='macro'>s2n(extlen, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((extlen)&gt;&gt; 8)&amp;0xff), (ret<br>)[1]=(unsigned char)(((extlen) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1253"><td class="num" id="LN1253">1253</td><td class="line">        <span class='keyword'>if</span> (extlen &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="1254"><td class="num" id="LN1254">1254</td><td class="line">            i2d_X509_EXTENSIONS(s-&gt;tlsext_ocsp_exts, &amp;ret);</td></tr>
<tr class="codeline" data-linenumber="1255"><td class="num" id="LN1255">1255</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1256"><td class="num" id="LN1256">1256</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1257"><td class="num" id="LN1257">1257</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_HEARTBEATS</span></td></tr>
<tr class="codeline" data-linenumber="1258"><td class="num" id="LN1258">1258</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>SSL_IS_DTLS(s)<span class='macro_popup'>(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1259"><td class="num" id="LN1259">1259</td><td class="line">        <span class='comment'>/* Add Heartbeat extension */</span></td></tr>
<tr class="codeline" data-linenumber="1260"><td class="num" id="LN1260">1260</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1261"><td class="num" id="LN1261">1261</td><td class="line">        <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1262"><td class="num" id="LN1262">1262</td><td class="line">         <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1263"><td class="num" id="LN1263">1263</td><td class="line">         <span class='comment'>* 4 bytes for the heartbeat ext type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1264"><td class="num" id="LN1264">1264</td><td class="line">         <span class='comment'>* 1 byte for the mode</span></td></tr>
<tr class="codeline" data-linenumber="1265"><td class="num" id="LN1265">1265</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1266"><td class="num" id="LN1266">1266</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 5, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(5))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1267"><td class="num" id="LN1267">1267</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1268"><td class="num" id="LN1268">1268</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1269"><td class="num" id="LN1269">1269</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_heartbeat, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((15)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((15) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1270"><td class="num" id="LN1270">1270</td><td class="line">        <span class='macro'>s2n(1, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((1)&gt;&gt; 8)&amp;0xff), (ret)[1<br>]=(unsigned char)(((1) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1271"><td class="num" id="LN1271">1271</td><td class="line">        <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1272"><td class="num" id="LN1272">1272</td><td class="line">         <span class='comment'>* Set mode:</span></td></tr>
<tr class="codeline" data-linenumber="1273"><td class="num" id="LN1273">1273</td><td class="line">         <span class='comment'>* 1: peer may send requests</span></td></tr>
<tr class="codeline" data-linenumber="1274"><td class="num" id="LN1274">1274</td><td class="line">         <span class='comment'>* 2: peer not allowed to send requests</span></td></tr>
<tr class="codeline" data-linenumber="1275"><td class="num" id="LN1275">1275</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1276"><td class="num" id="LN1276">1276</td><td class="line">        <span class='keyword'>if</span> (s-&gt;tlsext_heartbeat &amp; SSL_DTLSEXT_HB_DONT_RECV_REQUESTS)</td></tr>
<tr class="codeline" data-linenumber="1277"><td class="num" id="LN1277">1277</td><td class="line">            *(ret++) = SSL_DTLSEXT_HB_DONT_SEND_REQUESTS;</td></tr>
<tr class="codeline" data-linenumber="1278"><td class="num" id="LN1278">1278</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1279"><td class="num" id="LN1279">1279</td><td class="line">            *(ret++) = SSL_DTLSEXT_HB_ENABLED;</td></tr>
<tr class="codeline" data-linenumber="1280"><td class="num" id="LN1280">1280</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1281"><td class="num" id="LN1281">1281</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1282"><td class="num" id="LN1282">1282</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1283"><td class="num" id="LN1283">1283</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_NEXTPROTONEG</span></td></tr>
<tr class="codeline" data-linenumber="1284"><td class="num" id="LN1284">1284</td><td class="line">    <span class='keyword'>if</span> (s-&gt;ctx-&gt;next_proto_select_cb &amp;&amp; !s-&gt;s3-&gt;tmp.finish_md_len) {</td></tr>
<tr class="codeline" data-linenumber="1285"><td class="num" id="LN1285">1285</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1286"><td class="num" id="LN1286">1286</td><td class="line">         <span class='comment'>* The client advertises an empty extension to indicate its support</span></td></tr>
<tr class="codeline" data-linenumber="1287"><td class="num" id="LN1287">1287</td><td class="line">         <span class='comment'>* for Next Protocol Negotiation</span></td></tr>
<tr class="codeline" data-linenumber="1288"><td class="num" id="LN1288">1288</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1289"><td class="num" id="LN1289">1289</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1290"><td class="num" id="LN1290">1290</td><td class="line">        <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1291"><td class="num" id="LN1291">1291</td><td class="line">         <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1292"><td class="num" id="LN1292">1292</td><td class="line">         <span class='comment'>* 4 bytes for the NPN ext type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1293"><td class="num" id="LN1293">1293</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1294"><td class="num" id="LN1294">1294</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 4, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(4))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1295"><td class="num" id="LN1295">1295</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1296"><td class="num" id="LN1296">1296</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_next_proto_neg, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((13172)&gt;&gt; 8)&amp;0xff), (ret<br>)[1]=(unsigned char)(((13172) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1297"><td class="num" id="LN1297">1297</td><td class="line">        <span class='macro'>s2n(0, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((0)&gt;&gt; 8)&amp;0xff), (ret)[1<br>]=(unsigned char)(((0) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1298"><td class="num" id="LN1298">1298</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1299"><td class="num" id="LN1299">1299</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1300"><td class="num" id="LN1300">1300</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1301"><td class="num" id="LN1301">1301</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1302"><td class="num" id="LN1302">1302</td><td class="line">     <span class='comment'>* finish_md_len is non-zero during a renegotiation, so</span></td></tr>
<tr class="codeline" data-linenumber="1303"><td class="num" id="LN1303">1303</td><td class="line">     <span class='comment'>* this avoids sending ALPN during the renegotiation</span></td></tr>
<tr class="codeline" data-linenumber="1304"><td class="num" id="LN1304">1304</td><td class="line">     <span class='comment'>* (see longer comment below)</span></td></tr>
<tr class="codeline" data-linenumber="1305"><td class="num" id="LN1305">1305</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1306"><td class="num" id="LN1306">1306</td><td class="line">    <span class='keyword'>if</span> (s-&gt;alpn_client_proto_list &amp;&amp; !s-&gt;s3-&gt;tmp.finish_md_len) {</td></tr>
<tr class="codeline" data-linenumber="1307"><td class="num" id="LN1307">1307</td><td class="line">        <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1308"><td class="num" id="LN1308">1308</td><td class="line">         <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1309"><td class="num" id="LN1309">1309</td><td class="line">         <span class='comment'>* 4 bytes for the ALPN type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1310"><td class="num" id="LN1310">1310</td><td class="line">         <span class='comment'>* 2 bytes for the ALPN protocol list length</span></td></tr>
<tr class="codeline" data-linenumber="1311"><td class="num" id="LN1311">1311</td><td class="line">         <span class='comment'>* + ALPN protocol list length</span></td></tr>
<tr class="codeline" data-linenumber="1312"><td class="num" id="LN1312">1312</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1313"><td class="num" id="LN1313">1313</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 6 + s-&gt;alpn_client_proto_list_len, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(6 + s-&gt;alpn_client_proto_list_len))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1314"><td class="num" id="LN1314">1314</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1315"><td class="num" id="LN1315">1315</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_application_layer_protocol_negotiation, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((16)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((16) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1316"><td class="num" id="LN1316">1316</td><td class="line">        <span class='macro'>s2n(2 + s-&gt;alpn_client_proto_list_len, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((2 + s-&gt;alpn_client_proto_list_len<br>)&gt;&gt; 8)&amp;0xff), (ret)[1]=(unsigned char)(((2 + s-&gt;<br>alpn_client_proto_list_len) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1317"><td class="num" id="LN1317">1317</td><td class="line">        <span class='macro'>s2n(s-&gt;alpn_client_proto_list_len, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((s-&gt;alpn_client_proto_list_len<br>)&gt;&gt; 8)&amp;0xff), (ret)[1]=(unsigned char)(((s-&gt;alpn_client_proto_list_len<br>) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1318"><td class="num" id="LN1318">1318</td><td class="line">        memcpy(ret, s-&gt;alpn_client_proto_list, s-&gt;alpn_client_proto_list_len);</td></tr>
<tr class="codeline" data-linenumber="1319"><td class="num" id="LN1319">1319</td><td class="line">        ret += s-&gt;alpn_client_proto_list_len;</td></tr>
<tr class="codeline" data-linenumber="1320"><td class="num" id="LN1320">1320</td><td class="line">        s-&gt;s3-&gt;alpn_sent = 1;</td></tr>
<tr class="codeline" data-linenumber="1321"><td class="num" id="LN1321">1321</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1322"><td class="num" id="LN1322">1322</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_SRTP</span></td></tr>
<tr class="codeline" data-linenumber="1323"><td class="num" id="LN1323">1323</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>SSL_IS_DTLS(s)<span class='macro_popup'>(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8)</span></span> &amp;&amp; SSL_get_srtp_profiles(s)) {</td></tr>
<tr class="codeline" data-linenumber="1324"><td class="num" id="LN1324">1324</td><td class="line">        <span class='keyword'>int</span> el;</td></tr>
<tr class="codeline" data-linenumber="1325"><td class="num" id="LN1325">1325</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1326"><td class="num" id="LN1326">1326</td><td class="line">        <span class='comment'>/* Returns 0 on success!! */</span></td></tr>
<tr class="codeline" data-linenumber="1327"><td class="num" id="LN1327">1327</td><td class="line">        <span class='keyword'>if</span> (ssl_add_clienthello_use_srtp_ext(s, 0, &amp;el, 0)) {</td></tr>
<tr class="codeline" data-linenumber="1328"><td class="num" id="LN1328">1328</td><td class="line">            <span class='macro'>SSLerr(SSL_F_SSL_ADD_CLIENTHELLO_TLSEXT, ERR_R_INTERNAL_ERROR)<span class='macro_popup'>ERR_put_error(20,(277),((4|64)),"ssl/t1_lib.c",1328)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1329"><td class="num" id="LN1329">1329</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1330"><td class="num" id="LN1330">1330</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1331"><td class="num" id="LN1331">1331</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1332"><td class="num" id="LN1332">1332</td><td class="line">        <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1333"><td class="num" id="LN1333">1333</td><td class="line">         <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1334"><td class="num" id="LN1334">1334</td><td class="line">         <span class='comment'>* 4 bytes for the SRTP type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1335"><td class="num" id="LN1335">1335</td><td class="line">         <span class='comment'>* + SRTP profiles length</span></td></tr>
<tr class="codeline" data-linenumber="1336"><td class="num" id="LN1336">1336</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1337"><td class="num" id="LN1337">1337</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 4 + el, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(4 + el))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1338"><td class="num" id="LN1338">1338</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1339"><td class="num" id="LN1339">1339</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1340"><td class="num" id="LN1340">1340</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_use_srtp, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((14)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((14) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1341"><td class="num" id="LN1341">1341</td><td class="line">        <span class='macro'>s2n(el, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((el)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((el) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1342"><td class="num" id="LN1342">1342</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1343"><td class="num" id="LN1343">1343</td><td class="line">        <span class='keyword'>if</span> (ssl_add_clienthello_use_srtp_ext(s, ret, &amp;el, el)) {</td></tr>
<tr class="codeline" data-linenumber="1344"><td class="num" id="LN1344">1344</td><td class="line">            <span class='macro'>SSLerr(SSL_F_SSL_ADD_CLIENTHELLO_TLSEXT, ERR_R_INTERNAL_ERROR)<span class='macro_popup'>ERR_put_error(20,(277),((4|64)),"ssl/t1_lib.c",1344)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1345"><td class="num" id="LN1345">1345</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1346"><td class="num" id="LN1346">1346</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1347"><td class="num" id="LN1347">1347</td><td class="line">        ret += el;</td></tr>
<tr class="codeline" data-linenumber="1348"><td class="num" id="LN1348">1348</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1349"><td class="num" id="LN1349">1349</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1350"><td class="num" id="LN1350">1350</td><td class="line">    custom_ext_init(&amp;s-&gt;cert-&gt;cli_ext);</td></tr>
<tr class="codeline" data-linenumber="1351"><td class="num" id="LN1351">1351</td><td class="line">    <span class='comment'>/* Add custom TLS Extensions to ClientHello */</span></td></tr>
<tr class="codeline" data-linenumber="1352"><td class="num" id="LN1352">1352</td><td class="line">    <span class='keyword'>if</span> (!custom_ext_add(s, 0, &amp;ret, limit, al))</td></tr>
<tr class="codeline" data-linenumber="1353"><td class="num" id="LN1353">1353</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1354"><td class="num" id="LN1354">1354</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1355"><td class="num" id="LN1355">1355</td><td class="line">     <span class='comment'>* In 1.1.0 before 1.1.0c we negotiated EtM with DTLS, then just</span></td></tr>
<tr class="codeline" data-linenumber="1356"><td class="num" id="LN1356">1356</td><td class="line">     <span class='comment'>* silently failed to actually do it. It is fixed in 1.1.1 but to</span></td></tr>
<tr class="codeline" data-linenumber="1357"><td class="num" id="LN1357">1357</td><td class="line">     <span class='comment'>* ease the transition especially from 1.1.0b to 1.1.0c, we just</span></td></tr>
<tr class="codeline" data-linenumber="1358"><td class="num" id="LN1358">1358</td><td class="line">     <span class='comment'>* disable it in 1.1.0.</span></td></tr>
<tr class="codeline" data-linenumber="1359"><td class="num" id="LN1359">1359</td><td class="line">     <span class='comment'>* Also skip if SSL_OP_NO_ENCRYPT_THEN_MAC is set.</span></td></tr>
<tr class="codeline" data-linenumber="1360"><td class="num" id="LN1360">1360</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1361"><td class="num" id="LN1361">1361</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>SSL_IS_DTLS(s)<span class='macro_popup'>(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8)</span></span> &amp;&amp; !(s-&gt;options &amp; <span class='macro'>SSL_OP_NO_ENCRYPT_THEN_MAC<span class='macro_popup'>0x00080000U</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="1362"><td class="num" id="LN1362">1362</td><td class="line">        <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1363"><td class="num" id="LN1363">1363</td><td class="line">         <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1364"><td class="num" id="LN1364">1364</td><td class="line">         <span class='comment'>* 4 bytes for the ETM type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1365"><td class="num" id="LN1365">1365</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1366"><td class="num" id="LN1366">1366</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 4, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(4))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1367"><td class="num" id="LN1367">1367</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1368"><td class="num" id="LN1368">1368</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_encrypt_then_mac, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((22)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((22) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1369"><td class="num" id="LN1369">1369</td><td class="line">        <span class='macro'>s2n(0, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((0)&gt;&gt; 8)&amp;0xff), (ret)[1<br>]=(unsigned char)(((0) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1370"><td class="num" id="LN1370">1370</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1371"><td class="num" id="LN1371">1371</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1372"><td class="num" id="LN1372">1372</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_CT</span></td></tr>
<tr class="codeline" data-linenumber="1373"><td class="num" id="LN1373">1373</td><td class="line">    <span class='keyword'>if</span> (s-&gt;ct_validation_callback != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1374"><td class="num" id="LN1374">1374</td><td class="line">        <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1375"><td class="num" id="LN1375">1375</td><td class="line">         <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1376"><td class="num" id="LN1376">1376</td><td class="line">         <span class='comment'>* 4 bytes for the SCT type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1377"><td class="num" id="LN1377">1377</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1378"><td class="num" id="LN1378">1378</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 4, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(4))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1379"><td class="num" id="LN1379">1379</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1380"><td class="num" id="LN1380">1380</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1381"><td class="num" id="LN1381">1381</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_signed_certificate_timestamp, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((18)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((18) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1382"><td class="num" id="LN1382">1382</td><td class="line">        <span class='macro'>s2n(0, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((0)&gt;&gt; 8)&amp;0xff), (ret)[1<br>]=(unsigned char)(((0) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1383"><td class="num" id="LN1383">1383</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1384"><td class="num" id="LN1384">1384</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1385"><td class="num" id="LN1385">1385</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1386"><td class="num" id="LN1386">1386</td><td class="line">    <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1387"><td class="num" id="LN1387">1387</td><td class="line">     <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1388"><td class="num" id="LN1388">1388</td><td class="line">     <span class='comment'>* 4 bytes for the EMS type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1389"><td class="num" id="LN1389">1389</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1390"><td class="num" id="LN1390">1390</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 4, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(4))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1391"><td class="num" id="LN1391">1391</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1392"><td class="num" id="LN1392">1392</td><td class="line">    <span class='macro'>s2n(TLSEXT_TYPE_extended_master_secret, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((23)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((23) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1393"><td class="num" id="LN1393">1393</td><td class="line">    <span class='macro'>s2n(0, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((0)&gt;&gt; 8)&amp;0xff), (ret)[1<br>]=(unsigned char)(((0) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1394"><td class="num" id="LN1394">1394</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1395"><td class="num" id="LN1395">1395</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1396"><td class="num" id="LN1396">1396</td><td class="line">     <span class='comment'>* WebSphere application server can not handle having the</span></td></tr>
<tr class="codeline" data-linenumber="1397"><td class="num" id="LN1397">1397</td><td class="line">     <span class='comment'>* last extension be 0-length (e.g. EMS, EtM), so keep those</span></td></tr>
<tr class="codeline" data-linenumber="1398"><td class="num" id="LN1398">1398</td><td class="line">     <span class='comment'>* before SigAlgs</span></td></tr>
<tr class="codeline" data-linenumber="1399"><td class="num" id="LN1399">1399</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1400"><td class="num" id="LN1400">1400</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>SSL_CLIENT_USE_SIGALGS(s)<span class='macro_popup'>((!(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8) &amp;&amp;<br> s-&gt;client_version &gt;= 0x0303) || ((s-&gt;method-&gt;ssl3_enc<br>-&gt;enc_flags &amp; 0x8) &amp;&amp; ((((s-&gt;client_version<br>) == 0x0100) ? 0xff00 : (s-&gt;client_version)) &lt;= (((0xFEFD<br>) == 0x0100) ? 0xff00 : (0xFEFD)))))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1401"><td class="num" id="LN1401">1401</td><td class="line">        size_t salglen;</td></tr>
<tr class="codeline" data-linenumber="1402"><td class="num" id="LN1402">1402</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *salg;</td></tr>
<tr class="codeline" data-linenumber="1403"><td class="num" id="LN1403">1403</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *etmp;</td></tr>
<tr class="codeline" data-linenumber="1404"><td class="num" id="LN1404">1404</td><td class="line">        salglen = tls12_get_psigalgs(s, 1, &amp;salg);</td></tr>
<tr class="codeline" data-linenumber="1405"><td class="num" id="LN1405">1405</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1406"><td class="num" id="LN1406">1406</td><td class="line">        <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1407"><td class="num" id="LN1407">1407</td><td class="line">         <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1408"><td class="num" id="LN1408">1408</td><td class="line">         <span class='comment'>* 4 bytes for the sigalgs type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1409"><td class="num" id="LN1409">1409</td><td class="line">         <span class='comment'>* 2 bytes for the sigalg list length</span></td></tr>
<tr class="codeline" data-linenumber="1410"><td class="num" id="LN1410">1410</td><td class="line">         <span class='comment'>* + sigalg list length</span></td></tr>
<tr class="codeline" data-linenumber="1411"><td class="num" id="LN1411">1411</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1412"><td class="num" id="LN1412">1412</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, salglen + 6, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(salglen + 6))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1413"><td class="num" id="LN1413">1413</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1414"><td class="num" id="LN1414">1414</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_signature_algorithms, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((13)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((13) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1415"><td class="num" id="LN1415">1415</td><td class="line">        etmp = ret;</td></tr>
<tr class="codeline" data-linenumber="1416"><td class="num" id="LN1416">1416</td><td class="line">        <span class='comment'>/* Skip over lengths for now */</span></td></tr>
<tr class="codeline" data-linenumber="1417"><td class="num" id="LN1417">1417</td><td class="line">        ret += 4;</td></tr>
<tr class="codeline" data-linenumber="1418"><td class="num" id="LN1418">1418</td><td class="line">        salglen = tls12_copy_sigalgs(s, ret, salg, salglen);</td></tr>
<tr class="codeline" data-linenumber="1419"><td class="num" id="LN1419">1419</td><td class="line">        <span class='comment'>/* Fill in lengths */</span></td></tr>
<tr class="codeline" data-linenumber="1420"><td class="num" id="LN1420">1420</td><td class="line">        <span class='macro'>s2n(salglen + 2, etmp)<span class='macro_popup'>(((etmp)[0]=(unsigned char)(((salglen + 2)&gt;&gt; 8)&amp;0xff<br>), (etmp)[1]=(unsigned char)(((salglen + 2) )&amp;0xff)),(etmp<br>)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1421"><td class="num" id="LN1421">1421</td><td class="line">        <span class='macro'>s2n(salglen, etmp)<span class='macro_popup'>(((etmp)[0]=(unsigned char)(((salglen)&gt;&gt; 8)&amp;0xff), (<br>etmp)[1]=(unsigned char)(((salglen) )&amp;0xff)),(etmp)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1422"><td class="num" id="LN1422">1422</td><td class="line">        ret += salglen;</td></tr>
<tr class="codeline" data-linenumber="1423"><td class="num" id="LN1423">1423</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1424"><td class="num" id="LN1424">1424</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1425"><td class="num" id="LN1425">1425</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1426"><td class="num" id="LN1426">1426</td><td class="line">     <span class='comment'>* Add padding to workaround bugs in F5 terminators. See</span></td></tr>
<tr class="codeline" data-linenumber="1427"><td class="num" id="LN1427">1427</td><td class="line">     <span class='comment'>* https://tools.ietf.org/html/draft-agl-tls-padding-03 NB: because this</span></td></tr>
<tr class="codeline" data-linenumber="1428"><td class="num" id="LN1428">1428</td><td class="line">     <span class='comment'>* code works out the length of all existing extensions it MUST always</span></td></tr>
<tr class="codeline" data-linenumber="1429"><td class="num" id="LN1429">1429</td><td class="line">     <span class='comment'>* appear last. WebSphere 7.x/8.x is intolerant of empty extensions</span></td></tr>
<tr class="codeline" data-linenumber="1430"><td class="num" id="LN1430">1430</td><td class="line">     <span class='comment'>* being last, so minimum length of 1.</span></td></tr>
<tr class="codeline" data-linenumber="1431"><td class="num" id="LN1431">1431</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1432"><td class="num" id="LN1432">1432</td><td class="line">    <span class='keyword'>if</span> (s-&gt;options &amp; <span class='macro'>SSL_OP_TLSEXT_PADDING<span class='macro_popup'>0x00000010U</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1433"><td class="num" id="LN1433">1433</td><td class="line">        <span class='keyword'>int</span> hlen = ret - (<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *)s-&gt;init_buf-&gt;data;</td></tr>
<tr class="codeline" data-linenumber="1434"><td class="num" id="LN1434">1434</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1435"><td class="num" id="LN1435">1435</td><td class="line">        <span class='keyword'>if</span> (hlen &gt; 0xff &amp;&amp; hlen &lt; 0x200) {</td></tr>
<tr class="codeline" data-linenumber="1436"><td class="num" id="LN1436">1436</td><td class="line">            hlen = 0x200 - hlen;</td></tr>
<tr class="codeline" data-linenumber="1437"><td class="num" id="LN1437">1437</td><td class="line">            <span class='keyword'>if</span> (hlen &gt;= 4)</td></tr>
<tr class="codeline" data-linenumber="1438"><td class="num" id="LN1438">1438</td><td class="line">                hlen -= 4;</td></tr>
<tr class="codeline" data-linenumber="1439"><td class="num" id="LN1439">1439</td><td class="line">            <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1440"><td class="num" id="LN1440">1440</td><td class="line">                hlen = 1;</td></tr>
<tr class="codeline" data-linenumber="1441"><td class="num" id="LN1441">1441</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1442"><td class="num" id="LN1442">1442</td><td class="line">            <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1443"><td class="num" id="LN1443">1443</td><td class="line">             <span class='comment'>* check for enough space. Strictly speaking we know we've already</span></td></tr>
<tr class="codeline" data-linenumber="1444"><td class="num" id="LN1444">1444</td><td class="line">             <span class='comment'>* got enough space because to get here the message size is &lt; 0x200,</span></td></tr>
<tr class="codeline" data-linenumber="1445"><td class="num" id="LN1445">1445</td><td class="line">             <span class='comment'>* but we know that we've allocated far more than that in the buffer</span></td></tr>
<tr class="codeline" data-linenumber="1446"><td class="num" id="LN1446">1446</td><td class="line">             <span class='comment'>* - but for consistency and robustness we're going to check anyway.</span></td></tr>
<tr class="codeline" data-linenumber="1447"><td class="num" id="LN1447">1447</td><td class="line">             <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1448"><td class="num" id="LN1448">1448</td><td class="line">             <span class='comment'>* 4 bytes for the padding type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1449"><td class="num" id="LN1449">1449</td><td class="line">             <span class='comment'>* + padding length</span></td></tr>
<tr class="codeline" data-linenumber="1450"><td class="num" id="LN1450">1450</td><td class="line">             <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1451"><td class="num" id="LN1451">1451</td><td class="line">            <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 4 + hlen, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(4 + hlen))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1452"><td class="num" id="LN1452">1452</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1453"><td class="num" id="LN1453">1453</td><td class="line">            <span class='macro'>s2n(TLSEXT_TYPE_padding, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((21)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((21) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1454"><td class="num" id="LN1454">1454</td><td class="line">            <span class='macro'>s2n(hlen, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((hlen)&gt;&gt; 8)&amp;0xff), (ret<br>)[1]=(unsigned char)(((hlen) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1455"><td class="num" id="LN1455">1455</td><td class="line">            memset(ret, 0, hlen);</td></tr>
<tr class="codeline" data-linenumber="1456"><td class="num" id="LN1456">1456</td><td class="line">            ret += hlen;</td></tr>
<tr class="codeline" data-linenumber="1457"><td class="num" id="LN1457">1457</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1458"><td class="num" id="LN1458">1458</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1459"><td class="num" id="LN1459">1459</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1460"><td class="num" id="LN1460">1460</td><td class="line"> done:</td></tr>
<tr class="codeline" data-linenumber="1461"><td class="num" id="LN1461">1461</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1462"><td class="num" id="LN1462">1462</td><td class="line">    <span class='keyword'>if</span> ((extdatalen = ret - orig - 2) == 0)</td></tr>
<tr class="codeline" data-linenumber="1463"><td class="num" id="LN1463">1463</td><td class="line">        <span class='keyword'>return</span> orig;</td></tr>
<tr class="codeline" data-linenumber="1464"><td class="num" id="LN1464">1464</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1465"><td class="num" id="LN1465">1465</td><td class="line">    <span class='macro'>s2n(extdatalen, orig)<span class='macro_popup'>(((orig)[0]=(unsigned char)(((extdatalen)&gt;&gt; 8)&amp;0xff<br>), (orig)[1]=(unsigned char)(((extdatalen) )&amp;0xff)),(orig<br>)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1466"><td class="num" id="LN1466">1466</td><td class="line">    <span class='keyword'>return</span> ret;</td></tr>
<tr class="codeline" data-linenumber="1467"><td class="num" id="LN1467">1467</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1468"><td class="num" id="LN1468">1468</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1469"><td class="num" id="LN1469">1469</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>char</span> *ssl_add_serverhello_tlsext(SSL *s, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *buf,</td></tr>
<tr class="codeline" data-linenumber="1470"><td class="num" id="LN1470">1470</td><td class="line">                                          <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *limit, <span class='keyword'>int</span> *al)</td></tr>
<tr class="codeline" data-linenumber="1471"><td class="num" id="LN1471">1471</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1472"><td class="num" id="LN1472">1472</td><td class="line">    <span class='keyword'>int</span> extdatalen = 0;</td></tr>
<tr class="codeline" data-linenumber="1473"><td class="num" id="LN1473">1473</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *orig = buf;</td></tr>
<tr class="codeline" data-linenumber="1474"><td class="num" id="LN1474">1474</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *ret = buf;</td></tr>
<tr class="codeline" data-linenumber="1475"><td class="num" id="LN1475">1475</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_NEXTPROTONEG</span></td></tr>
<tr class="codeline" data-linenumber="1476"><td class="num" id="LN1476">1476</td><td class="line">    <span class='keyword'>int</span> next_proto_neg_seen;</td></tr>
<tr class="codeline" data-linenumber="1477"><td class="num" id="LN1477">1477</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1478"><td class="num" id="LN1478">1478</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="1479"><td class="num" id="LN1479">1479</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> alg_k = s-&gt;s3-&gt;tmp.new_cipher-&gt;algorithm_mkey;</td></tr>
<tr class="codeline" data-linenumber="1480"><td class="num" id="LN1480">1480</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> alg_a = s-&gt;s3-&gt;tmp.new_cipher-&gt;algorithm_auth;</td></tr>
<tr class="codeline" data-linenumber="1481"><td class="num" id="LN1481">1481</td><td class="line">    <span class='keyword'>int</span> using_ecc = (alg_k &amp; <span class='macro'>SSL_kECDHE<span class='macro_popup'>0x00000004U</span></span>) || (alg_a &amp; <span class='macro'>SSL_aECDSA<span class='macro_popup'>0x00000008U</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1482"><td class="num" id="LN1482">1482</td><td class="line">    using_ecc = using_ecc &amp;&amp; (s-&gt;session-&gt;tlsext_ecpointformatlist != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1483"><td class="num" id="LN1483">1483</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1484"><td class="num" id="LN1484">1484</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1485"><td class="num" id="LN1485">1485</td><td class="line">    ret += 2;</td></tr>
<tr class="codeline" data-linenumber="1486"><td class="num" id="LN1486">1486</td><td class="line">    <span class='keyword'>if</span> (ret &gt;= limit)</td></tr>
<tr class="codeline" data-linenumber="1487"><td class="num" id="LN1487">1487</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;            <span class='comment'>/* this really never occurs, but ... */</span></td></tr>
<tr class="codeline" data-linenumber="1488"><td class="num" id="LN1488">1488</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1489"><td class="num" id="LN1489">1489</td><td class="line">    <span class='keyword'>if</span> (s-&gt;s3-&gt;send_connection_binding) {</td></tr>
<tr class="codeline" data-linenumber="1490"><td class="num" id="LN1490">1490</td><td class="line">        <span class='keyword'>int</span> el;</td></tr>
<tr class="codeline" data-linenumber="1491"><td class="num" id="LN1491">1491</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1492"><td class="num" id="LN1492">1492</td><td class="line">        <span class='keyword'>if</span> (!ssl_add_serverhello_renegotiate_ext(s, 0, &amp;el, 0)) {</td></tr>
<tr class="codeline" data-linenumber="1493"><td class="num" id="LN1493">1493</td><td class="line">            <span class='macro'>SSLerr(SSL_F_SSL_ADD_SERVERHELLO_TLSEXT, ERR_R_INTERNAL_ERROR)<span class='macro_popup'>ERR_put_error(20,(278),((4|64)),"ssl/t1_lib.c",1493)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1494"><td class="num" id="LN1494">1494</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1495"><td class="num" id="LN1495">1495</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1496"><td class="num" id="LN1496">1496</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1497"><td class="num" id="LN1497">1497</td><td class="line">        <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1498"><td class="num" id="LN1498">1498</td><td class="line">         <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1499"><td class="num" id="LN1499">1499</td><td class="line">         <span class='comment'>* 4 bytes for the reneg type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1500"><td class="num" id="LN1500">1500</td><td class="line">         <span class='comment'>* + reneg data length</span></td></tr>
<tr class="codeline" data-linenumber="1501"><td class="num" id="LN1501">1501</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1502"><td class="num" id="LN1502">1502</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 4 + el, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(4 + el))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1503"><td class="num" id="LN1503">1503</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1504"><td class="num" id="LN1504">1504</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1505"><td class="num" id="LN1505">1505</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_renegotiate, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((0xff01)&gt;&gt; 8)&amp;0xff), (ret<br>)[1]=(unsigned char)(((0xff01) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1506"><td class="num" id="LN1506">1506</td><td class="line">        <span class='macro'>s2n(el, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((el)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((el) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1507"><td class="num" id="LN1507">1507</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1508"><td class="num" id="LN1508">1508</td><td class="line">        <span class='keyword'>if</span> (!ssl_add_serverhello_renegotiate_ext(s, ret, &amp;el, el)) {</td></tr>
<tr class="codeline" data-linenumber="1509"><td class="num" id="LN1509">1509</td><td class="line">            <span class='macro'>SSLerr(SSL_F_SSL_ADD_SERVERHELLO_TLSEXT, ERR_R_INTERNAL_ERROR)<span class='macro_popup'>ERR_put_error(20,(278),((4|64)),"ssl/t1_lib.c",1509)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1510"><td class="num" id="LN1510">1510</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1511"><td class="num" id="LN1511">1511</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1512"><td class="num" id="LN1512">1512</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1513"><td class="num" id="LN1513">1513</td><td class="line">        ret += el;</td></tr>
<tr class="codeline" data-linenumber="1514"><td class="num" id="LN1514">1514</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1515"><td class="num" id="LN1515">1515</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1516"><td class="num" id="LN1516">1516</td><td class="line">    <span class='comment'>/* Only add RI for SSLv3 */</span></td></tr>
<tr class="codeline" data-linenumber="1517"><td class="num" id="LN1517">1517</td><td class="line">    <span class='keyword'>if</span> (s-&gt;version == <span class='macro'>SSL3_VERSION<span class='macro_popup'>0x0300</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1518"><td class="num" id="LN1518">1518</td><td class="line">        <span class='keyword'>goto</span> done;</td></tr>
<tr class="codeline" data-linenumber="1519"><td class="num" id="LN1519">1519</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1520"><td class="num" id="LN1520">1520</td><td class="line">    <span class='keyword'>if</span> (!s-&gt;hit &amp;&amp; s-&gt;servername_done == 1</td></tr>
<tr class="codeline" data-linenumber="1521"><td class="num" id="LN1521">1521</td><td class="line">        &amp;&amp; s-&gt;session-&gt;tlsext_hostname != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1522"><td class="num" id="LN1522">1522</td><td class="line">        <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1523"><td class="num" id="LN1523">1523</td><td class="line">         <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1524"><td class="num" id="LN1524">1524</td><td class="line">         <span class='comment'>* 4 bytes for the server name type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1525"><td class="num" id="LN1525">1525</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1526"><td class="num" id="LN1526">1526</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 4, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(4))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1527"><td class="num" id="LN1527">1527</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1528"><td class="num" id="LN1528">1528</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1529"><td class="num" id="LN1529">1529</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_server_name, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((0)&gt;&gt; 8)&amp;0xff), (ret)[1<br>]=(unsigned char)(((0) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1530"><td class="num" id="LN1530">1530</td><td class="line">        <span class='macro'>s2n(0, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((0)&gt;&gt; 8)&amp;0xff), (ret)[1<br>]=(unsigned char)(((0) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1531"><td class="num" id="LN1531">1531</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1532"><td class="num" id="LN1532">1532</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="1533"><td class="num" id="LN1533">1533</td><td class="line">    <span class='keyword'>if</span> (using_ecc) {</td></tr>
<tr class="codeline" data-linenumber="1534"><td class="num" id="LN1534">1534</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *plist;</td></tr>
<tr class="codeline" data-linenumber="1535"><td class="num" id="LN1535">1535</td><td class="line">        size_t plistlen;</td></tr>
<tr class="codeline" data-linenumber="1536"><td class="num" id="LN1536">1536</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1537"><td class="num" id="LN1537">1537</td><td class="line">         <span class='comment'>* Add TLS extension ECPointFormats to the ServerHello message</span></td></tr>
<tr class="codeline" data-linenumber="1538"><td class="num" id="LN1538">1538</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1539"><td class="num" id="LN1539">1539</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1540"><td class="num" id="LN1540">1540</td><td class="line">        tls1_get_formatlist(s, &amp;plist, &amp;plistlen);</td></tr>
<tr class="codeline" data-linenumber="1541"><td class="num" id="LN1541">1541</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1542"><td class="num" id="LN1542">1542</td><td class="line">        <span class='keyword'>if</span> (plistlen &gt; 255) {</td></tr>
<tr class="codeline" data-linenumber="1543"><td class="num" id="LN1543">1543</td><td class="line">            <span class='macro'>SSLerr(SSL_F_SSL_ADD_SERVERHELLO_TLSEXT, ERR_R_INTERNAL_ERROR)<span class='macro_popup'>ERR_put_error(20,(278),((4|64)),"ssl/t1_lib.c",1543)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1544"><td class="num" id="LN1544">1544</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1545"><td class="num" id="LN1545">1545</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1546"><td class="num" id="LN1546">1546</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1547"><td class="num" id="LN1547">1547</td><td class="line">        <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1548"><td class="num" id="LN1548">1548</td><td class="line">         <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1549"><td class="num" id="LN1549">1549</td><td class="line">         <span class='comment'>* 4 bytes for the ec points format type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1550"><td class="num" id="LN1550">1550</td><td class="line">         <span class='comment'>* 1 byte for the points format list length</span></td></tr>
<tr class="codeline" data-linenumber="1551"><td class="num" id="LN1551">1551</td><td class="line">         <span class='comment'>* + length of points format list</span></td></tr>
<tr class="codeline" data-linenumber="1552"><td class="num" id="LN1552">1552</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1553"><td class="num" id="LN1553">1553</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 5 + plistlen, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(5 + plistlen))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1554"><td class="num" id="LN1554">1554</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1555"><td class="num" id="LN1555">1555</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1556"><td class="num" id="LN1556">1556</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_ec_point_formats, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((11)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((11) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1557"><td class="num" id="LN1557">1557</td><td class="line">        <span class='macro'>s2n(plistlen + 1, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((plistlen + 1)&gt;&gt; 8)&amp;0xff<br>), (ret)[1]=(unsigned char)(((plistlen + 1) )&amp;0xff)),(ret<br>)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1558"><td class="num" id="LN1558">1558</td><td class="line">        *(ret++) = (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>)plistlen;</td></tr>
<tr class="codeline" data-linenumber="1559"><td class="num" id="LN1559">1559</td><td class="line">        memcpy(ret, plist, plistlen);</td></tr>
<tr class="codeline" data-linenumber="1560"><td class="num" id="LN1560">1560</td><td class="line">        ret += plistlen;</td></tr>
<tr class="codeline" data-linenumber="1561"><td class="num" id="LN1561">1561</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1562"><td class="num" id="LN1562">1562</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1563"><td class="num" id="LN1563">1563</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1564"><td class="num" id="LN1564">1564</td><td class="line">     <span class='comment'>* Currently the server should not respond with a SupportedCurves</span></td></tr>
<tr class="codeline" data-linenumber="1565"><td class="num" id="LN1565">1565</td><td class="line">     <span class='comment'>* extension</span></td></tr>
<tr class="codeline" data-linenumber="1566"><td class="num" id="LN1566">1566</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1567"><td class="num" id="LN1567">1567</td><td class="line"><span class='directive'>#endif                          /* OPENSSL_NO_EC */</span></td></tr>
<tr class="codeline" data-linenumber="1568"><td class="num" id="LN1568">1568</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1569"><td class="num" id="LN1569">1569</td><td class="line">    <span class='keyword'>if</span> (s-&gt;tlsext_ticket_expected &amp;&amp; tls_use_ticket(s)) {</td></tr>
<tr class="codeline" data-linenumber="1570"><td class="num" id="LN1570">1570</td><td class="line">        <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1571"><td class="num" id="LN1571">1571</td><td class="line">         <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1572"><td class="num" id="LN1572">1572</td><td class="line">         <span class='comment'>* 4 bytes for the Ticket type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1573"><td class="num" id="LN1573">1573</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1574"><td class="num" id="LN1574">1574</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 4, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(4))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1575"><td class="num" id="LN1575">1575</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1576"><td class="num" id="LN1576">1576</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_session_ticket, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((35)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((35) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1577"><td class="num" id="LN1577">1577</td><td class="line">        <span class='macro'>s2n(0, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((0)&gt;&gt; 8)&amp;0xff), (ret)[1<br>]=(unsigned char)(((0) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1578"><td class="num" id="LN1578">1578</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1579"><td class="num" id="LN1579">1579</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1580"><td class="num" id="LN1580">1580</td><td class="line">         <span class='comment'>* if we don't add the above TLSEXT, we can't add a session ticket</span></td></tr>
<tr class="codeline" data-linenumber="1581"><td class="num" id="LN1581">1581</td><td class="line">         <span class='comment'>* later</span></td></tr>
<tr class="codeline" data-linenumber="1582"><td class="num" id="LN1582">1582</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1583"><td class="num" id="LN1583">1583</td><td class="line">        s-&gt;tlsext_ticket_expected = 0;</td></tr>
<tr class="codeline" data-linenumber="1584"><td class="num" id="LN1584">1584</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1585"><td class="num" id="LN1585">1585</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1586"><td class="num" id="LN1586">1586</td><td class="line">    <span class='keyword'>if</span> (s-&gt;tlsext_status_expected) {</td></tr>
<tr class="codeline" data-linenumber="1587"><td class="num" id="LN1587">1587</td><td class="line">        <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1588"><td class="num" id="LN1588">1588</td><td class="line">         <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1589"><td class="num" id="LN1589">1589</td><td class="line">         <span class='comment'>* 4 bytes for the Status request type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1590"><td class="num" id="LN1590">1590</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1591"><td class="num" id="LN1591">1591</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 4, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(4))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1592"><td class="num" id="LN1592">1592</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1593"><td class="num" id="LN1593">1593</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_status_request, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((5)&gt;&gt; 8)&amp;0xff), (ret)[1<br>]=(unsigned char)(((5) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1594"><td class="num" id="LN1594">1594</td><td class="line">        <span class='macro'>s2n(0, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((0)&gt;&gt; 8)&amp;0xff), (ret)[1<br>]=(unsigned char)(((0) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1595"><td class="num" id="LN1595">1595</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1596"><td class="num" id="LN1596">1596</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_SRTP</span></td></tr>
<tr class="codeline" data-linenumber="1597"><td class="num" id="LN1597">1597</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>SSL_IS_DTLS(s)<span class='macro_popup'>(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8)</span></span> &amp;&amp; s-&gt;srtp_profile) {</td></tr>
<tr class="codeline" data-linenumber="1598"><td class="num" id="LN1598">1598</td><td class="line">        <span class='keyword'>int</span> el;</td></tr>
<tr class="codeline" data-linenumber="1599"><td class="num" id="LN1599">1599</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1600"><td class="num" id="LN1600">1600</td><td class="line">        <span class='comment'>/* Returns 0 on success!! */</span></td></tr>
<tr class="codeline" data-linenumber="1601"><td class="num" id="LN1601">1601</td><td class="line">        <span class='keyword'>if</span> (ssl_add_serverhello_use_srtp_ext(s, 0, &amp;el, 0)) {</td></tr>
<tr class="codeline" data-linenumber="1602"><td class="num" id="LN1602">1602</td><td class="line">            <span class='macro'>SSLerr(SSL_F_SSL_ADD_SERVERHELLO_TLSEXT, ERR_R_INTERNAL_ERROR)<span class='macro_popup'>ERR_put_error(20,(278),((4|64)),"ssl/t1_lib.c",1602)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1603"><td class="num" id="LN1603">1603</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1604"><td class="num" id="LN1604">1604</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1605"><td class="num" id="LN1605">1605</td><td class="line">        <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1606"><td class="num" id="LN1606">1606</td><td class="line">         <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1607"><td class="num" id="LN1607">1607</td><td class="line">         <span class='comment'>* 4 bytes for the SRTP profiles type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1608"><td class="num" id="LN1608">1608</td><td class="line">         <span class='comment'>* + length of the SRTP profiles list</span></td></tr>
<tr class="codeline" data-linenumber="1609"><td class="num" id="LN1609">1609</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1610"><td class="num" id="LN1610">1610</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 4 + el, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(4 + el))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1611"><td class="num" id="LN1611">1611</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1612"><td class="num" id="LN1612">1612</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1613"><td class="num" id="LN1613">1613</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_use_srtp, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((14)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((14) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1614"><td class="num" id="LN1614">1614</td><td class="line">        <span class='macro'>s2n(el, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((el)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((el) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1615"><td class="num" id="LN1615">1615</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1616"><td class="num" id="LN1616">1616</td><td class="line">        <span class='keyword'>if</span> (ssl_add_serverhello_use_srtp_ext(s, ret, &amp;el, el)) {</td></tr>
<tr class="codeline" data-linenumber="1617"><td class="num" id="LN1617">1617</td><td class="line">            <span class='macro'>SSLerr(SSL_F_SSL_ADD_SERVERHELLO_TLSEXT, ERR_R_INTERNAL_ERROR)<span class='macro_popup'>ERR_put_error(20,(278),((4|64)),"ssl/t1_lib.c",1617)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1618"><td class="num" id="LN1618">1618</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1619"><td class="num" id="LN1619">1619</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1620"><td class="num" id="LN1620">1620</td><td class="line">        ret += el;</td></tr>
<tr class="codeline" data-linenumber="1621"><td class="num" id="LN1621">1621</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1622"><td class="num" id="LN1622">1622</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1623"><td class="num" id="LN1623">1623</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1624"><td class="num" id="LN1624">1624</td><td class="line">    <span class='keyword'>if</span> (((s-&gt;s3-&gt;tmp.new_cipher-&gt;id &amp; 0xFFFF) == 0x80</td></tr>
<tr class="codeline" data-linenumber="1625"><td class="num" id="LN1625">1625</td><td class="line">         || (s-&gt;s3-&gt;tmp.new_cipher-&gt;id &amp; 0xFFFF) == 0x81)</td></tr>
<tr class="codeline" data-linenumber="1626"><td class="num" id="LN1626">1626</td><td class="line">        &amp;&amp; (SSL_get_options(s) &amp; <span class='macro'>SSL_OP_CRYPTOPRO_TLSEXT_BUG<span class='macro_popup'>0x80000000U</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="1627"><td class="num" id="LN1627">1627</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> cryptopro_ext[36] = {</td></tr>
<tr class="codeline" data-linenumber="1628"><td class="num" id="LN1628">1628</td><td class="line">            0xfd, 0xe8,         <span class='comment'>/* 65000 */</span></td></tr>
<tr class="codeline" data-linenumber="1629"><td class="num" id="LN1629">1629</td><td class="line">            0x00, 0x20,         <span class='comment'>/* 32 bytes length */</span></td></tr>
<tr class="codeline" data-linenumber="1630"><td class="num" id="LN1630">1630</td><td class="line">            0x30, 0x1e, 0x30, 0x08, 0x06, 0x06, 0x2a, 0x85,</td></tr>
<tr class="codeline" data-linenumber="1631"><td class="num" id="LN1631">1631</td><td class="line">            0x03, 0x02, 0x02, 0x09, 0x30, 0x08, 0x06, 0x06,</td></tr>
<tr class="codeline" data-linenumber="1632"><td class="num" id="LN1632">1632</td><td class="line">            0x2a, 0x85, 0x03, 0x02, 0x02, 0x16, 0x30, 0x08,</td></tr>
<tr class="codeline" data-linenumber="1633"><td class="num" id="LN1633">1633</td><td class="line">            0x06, 0x06, 0x2a, 0x85, 0x03, 0x02, 0x02, 0x17</td></tr>
<tr class="codeline" data-linenumber="1634"><td class="num" id="LN1634">1634</td><td class="line">        };</td></tr>
<tr class="codeline" data-linenumber="1635"><td class="num" id="LN1635">1635</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1636"><td class="num" id="LN1636">1636</td><td class="line">        <span class='comment'>/* check for enough space. */</span></td></tr>
<tr class="codeline" data-linenumber="1637"><td class="num" id="LN1637">1637</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, <span class='keyword'>sizeof</span>(cryptopro_ext), limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(sizeof(cryptopro_ext)))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1638"><td class="num" id="LN1638">1638</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1639"><td class="num" id="LN1639">1639</td><td class="line">        memcpy(ret, cryptopro_ext, <span class='keyword'>sizeof</span>(cryptopro_ext));</td></tr>
<tr class="codeline" data-linenumber="1640"><td class="num" id="LN1640">1640</td><td class="line">        ret += <span class='keyword'>sizeof</span>(cryptopro_ext);</td></tr>
<tr class="codeline" data-linenumber="1641"><td class="num" id="LN1641">1641</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1642"><td class="num" id="LN1642">1642</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1643"><td class="num" id="LN1643">1643</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_HEARTBEATS</span></td></tr>
<tr class="codeline" data-linenumber="1644"><td class="num" id="LN1644">1644</td><td class="line">    <span class='comment'>/* Add Heartbeat extension if we've received one */</span></td></tr>
<tr class="codeline" data-linenumber="1645"><td class="num" id="LN1645">1645</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>SSL_IS_DTLS(s)<span class='macro_popup'>(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8)</span></span> &amp;&amp; (s-&gt;tlsext_heartbeat &amp; SSL_DTLSEXT_HB_ENABLED)) {</td></tr>
<tr class="codeline" data-linenumber="1646"><td class="num" id="LN1646">1646</td><td class="line">        <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1647"><td class="num" id="LN1647">1647</td><td class="line">         <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1648"><td class="num" id="LN1648">1648</td><td class="line">         <span class='comment'>* 4 bytes for the Heartbeat type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1649"><td class="num" id="LN1649">1649</td><td class="line">         <span class='comment'>* 1 byte for the mode</span></td></tr>
<tr class="codeline" data-linenumber="1650"><td class="num" id="LN1650">1650</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1651"><td class="num" id="LN1651">1651</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 5, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(5))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1652"><td class="num" id="LN1652">1652</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1653"><td class="num" id="LN1653">1653</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_heartbeat, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((15)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((15) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1654"><td class="num" id="LN1654">1654</td><td class="line">        <span class='macro'>s2n(1, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((1)&gt;&gt; 8)&amp;0xff), (ret)[1<br>]=(unsigned char)(((1) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1655"><td class="num" id="LN1655">1655</td><td class="line">        <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1656"><td class="num" id="LN1656">1656</td><td class="line">         <span class='comment'>* Set mode:</span></td></tr>
<tr class="codeline" data-linenumber="1657"><td class="num" id="LN1657">1657</td><td class="line">         <span class='comment'>* 1: peer may send requests</span></td></tr>
<tr class="codeline" data-linenumber="1658"><td class="num" id="LN1658">1658</td><td class="line">         <span class='comment'>* 2: peer not allowed to send requests</span></td></tr>
<tr class="codeline" data-linenumber="1659"><td class="num" id="LN1659">1659</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1660"><td class="num" id="LN1660">1660</td><td class="line">        <span class='keyword'>if</span> (s-&gt;tlsext_heartbeat &amp; SSL_DTLSEXT_HB_DONT_RECV_REQUESTS)</td></tr>
<tr class="codeline" data-linenumber="1661"><td class="num" id="LN1661">1661</td><td class="line">            *(ret++) = SSL_DTLSEXT_HB_DONT_SEND_REQUESTS;</td></tr>
<tr class="codeline" data-linenumber="1662"><td class="num" id="LN1662">1662</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1663"><td class="num" id="LN1663">1663</td><td class="line">            *(ret++) = SSL_DTLSEXT_HB_ENABLED;</td></tr>
<tr class="codeline" data-linenumber="1664"><td class="num" id="LN1664">1664</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1665"><td class="num" id="LN1665">1665</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1666"><td class="num" id="LN1666">1666</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1667"><td class="num" id="LN1667">1667</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1668"><td class="num" id="LN1668">1668</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_NEXTPROTONEG</span></td></tr>
<tr class="codeline" data-linenumber="1669"><td class="num" id="LN1669">1669</td><td class="line">    next_proto_neg_seen = s-&gt;s3-&gt;next_proto_neg_seen;</td></tr>
<tr class="codeline" data-linenumber="1670"><td class="num" id="LN1670">1670</td><td class="line">    s-&gt;s3-&gt;next_proto_neg_seen = 0;</td></tr>
<tr class="codeline" data-linenumber="1671"><td class="num" id="LN1671">1671</td><td class="line">    <span class='keyword'>if</span> (next_proto_neg_seen &amp;&amp; s-&gt;ctx-&gt;next_protos_advertised_cb) {</td></tr>
<tr class="codeline" data-linenumber="1672"><td class="num" id="LN1672">1672</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *npa;</td></tr>
<tr class="codeline" data-linenumber="1673"><td class="num" id="LN1673">1673</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>int</span> npalen;</td></tr>
<tr class="codeline" data-linenumber="1674"><td class="num" id="LN1674">1674</td><td class="line">        <span class='keyword'>int</span> r;</td></tr>
<tr class="codeline" data-linenumber="1675"><td class="num" id="LN1675">1675</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1676"><td class="num" id="LN1676">1676</td><td class="line">        r = s-&gt;ctx-&gt;next_protos_advertised_cb(s, &amp;npa, &amp;npalen,</td></tr>
<tr class="codeline" data-linenumber="1677"><td class="num" id="LN1677">1677</td><td class="line">                                              s-&gt;</td></tr>
<tr class="codeline" data-linenumber="1678"><td class="num" id="LN1678">1678</td><td class="line">                                              ctx-&gt;next_protos_advertised_cb_arg);</td></tr>
<tr class="codeline" data-linenumber="1679"><td class="num" id="LN1679">1679</td><td class="line">        <span class='keyword'>if</span> (r == <span class='macro'>SSL_TLSEXT_ERR_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1680"><td class="num" id="LN1680">1680</td><td class="line">            <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1681"><td class="num" id="LN1681">1681</td><td class="line">             <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1682"><td class="num" id="LN1682">1682</td><td class="line">             <span class='comment'>* 4 bytes for the NPN type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1683"><td class="num" id="LN1683">1683</td><td class="line">             <span class='comment'>* + length of protocols list</span></td></tr>
<tr class="codeline" data-linenumber="1684"><td class="num" id="LN1684">1684</td><td class="line">             <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1685"><td class="num" id="LN1685">1685</td><td class="line">            <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 4 + npalen, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(4 + npalen))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1686"><td class="num" id="LN1686">1686</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1687"><td class="num" id="LN1687">1687</td><td class="line">            <span class='macro'>s2n(TLSEXT_TYPE_next_proto_neg, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((13172)&gt;&gt; 8)&amp;0xff), (ret<br>)[1]=(unsigned char)(((13172) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1688"><td class="num" id="LN1688">1688</td><td class="line">            <span class='macro'>s2n(npalen, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((npalen)&gt;&gt; 8)&amp;0xff), (ret<br>)[1]=(unsigned char)(((npalen) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1689"><td class="num" id="LN1689">1689</td><td class="line">            memcpy(ret, npa, npalen);</td></tr>
<tr class="codeline" data-linenumber="1690"><td class="num" id="LN1690">1690</td><td class="line">            ret += npalen;</td></tr>
<tr class="codeline" data-linenumber="1691"><td class="num" id="LN1691">1691</td><td class="line">            s-&gt;s3-&gt;next_proto_neg_seen = 1;</td></tr>
<tr class="codeline" data-linenumber="1692"><td class="num" id="LN1692">1692</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1693"><td class="num" id="LN1693">1693</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1694"><td class="num" id="LN1694">1694</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1695"><td class="num" id="LN1695">1695</td><td class="line">    <span class='keyword'>if</span> (!custom_ext_add(s, 1, &amp;ret, limit, al))</td></tr>
<tr class="codeline" data-linenumber="1696"><td class="num" id="LN1696">1696</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1697"><td class="num" id="LN1697">1697</td><td class="line">    <span class='keyword'>if</span> (s-&gt;tlsext_use_etm) {</td></tr>
<tr class="codeline" data-linenumber="1698"><td class="num" id="LN1698">1698</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1699"><td class="num" id="LN1699">1699</td><td class="line">         <span class='comment'>* Don't use encrypt_then_mac if AEAD or RC4 might want to disable</span></td></tr>
<tr class="codeline" data-linenumber="1700"><td class="num" id="LN1700">1700</td><td class="line">         <span class='comment'>* for other cases too.</span></td></tr>
<tr class="codeline" data-linenumber="1701"><td class="num" id="LN1701">1701</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1702"><td class="num" id="LN1702">1702</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>SSL_IS_DTLS(s)<span class='macro_popup'>(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8)</span></span> || s-&gt;s3-&gt;tmp.new_cipher-&gt;algorithm_mac == <span class='macro'>SSL_AEAD<span class='macro_popup'>0x00000040U</span></span></td></tr>
<tr class="codeline" data-linenumber="1703"><td class="num" id="LN1703">1703</td><td class="line">            || s-&gt;s3-&gt;tmp.new_cipher-&gt;algorithm_enc == <span class='macro'>SSL_RC4<span class='macro_popup'>0x00000004U</span></span></td></tr>
<tr class="codeline" data-linenumber="1704"><td class="num" id="LN1704">1704</td><td class="line">            || s-&gt;s3-&gt;tmp.new_cipher-&gt;algorithm_enc == <span class='macro'>SSL_eGOST2814789CNT<span class='macro_popup'>0x00000400U</span></span></td></tr>
<tr class="codeline" data-linenumber="1705"><td class="num" id="LN1705">1705</td><td class="line">            || s-&gt;s3-&gt;tmp.new_cipher-&gt;algorithm_enc == <span class='macro'>SSL_eGOST2814789CNT12<span class='macro_popup'>0x00040000U</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1706"><td class="num" id="LN1706">1706</td><td class="line">            s-&gt;tlsext_use_etm = 0;</td></tr>
<tr class="codeline" data-linenumber="1707"><td class="num" id="LN1707">1707</td><td class="line">        <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1708"><td class="num" id="LN1708">1708</td><td class="line">            <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1709"><td class="num" id="LN1709">1709</td><td class="line">             <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1710"><td class="num" id="LN1710">1710</td><td class="line">             <span class='comment'>* 4 bytes for the ETM type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1711"><td class="num" id="LN1711">1711</td><td class="line">             <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1712"><td class="num" id="LN1712">1712</td><td class="line">            <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 4, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(4))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1713"><td class="num" id="LN1713">1713</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1714"><td class="num" id="LN1714">1714</td><td class="line">            <span class='macro'>s2n(TLSEXT_TYPE_encrypt_then_mac, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((22)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((22) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1715"><td class="num" id="LN1715">1715</td><td class="line">            <span class='macro'>s2n(0, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((0)&gt;&gt; 8)&amp;0xff), (ret)[1<br>]=(unsigned char)(((0) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1716"><td class="num" id="LN1716">1716</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1717"><td class="num" id="LN1717">1717</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1718"><td class="num" id="LN1718">1718</td><td class="line">    <span class='keyword'>if</span> (s-&gt;s3-&gt;flags &amp; <span class='macro'>TLS1_FLAGS_RECEIVED_EXTMS<span class='macro_popup'>0x0200</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1719"><td class="num" id="LN1719">1719</td><td class="line">        <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1720"><td class="num" id="LN1720">1720</td><td class="line">         <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1721"><td class="num" id="LN1721">1721</td><td class="line">         <span class='comment'>* 4 bytes for the EMS type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1722"><td class="num" id="LN1722">1722</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1723"><td class="num" id="LN1723">1723</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 4, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(4))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1724"><td class="num" id="LN1724">1724</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1725"><td class="num" id="LN1725">1725</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_extended_master_secret, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((23)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((23) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1726"><td class="num" id="LN1726">1726</td><td class="line">        <span class='macro'>s2n(0, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((0)&gt;&gt; 8)&amp;0xff), (ret)[1<br>]=(unsigned char)(((0) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1727"><td class="num" id="LN1727">1727</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1728"><td class="num" id="LN1728">1728</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1729"><td class="num" id="LN1729">1729</td><td class="line">    <span class='keyword'>if</span> (s-&gt;s3-&gt;alpn_selected != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1730"><td class="num" id="LN1730">1730</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *selected = s-&gt;s3-&gt;alpn_selected;</td></tr>
<tr class="codeline" data-linenumber="1731"><td class="num" id="LN1731">1731</td><td class="line">        size_t len = s-&gt;s3-&gt;alpn_selected_len;</td></tr>
<tr class="codeline" data-linenumber="1732"><td class="num" id="LN1732">1732</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1733"><td class="num" id="LN1733">1733</td><td class="line">        <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1734"><td class="num" id="LN1734">1734</td><td class="line">         <span class='comment'>* check for enough space.</span></td></tr>
<tr class="codeline" data-linenumber="1735"><td class="num" id="LN1735">1735</td><td class="line">         <span class='comment'>* 4 bytes for the ALPN type and extension length</span></td></tr>
<tr class="codeline" data-linenumber="1736"><td class="num" id="LN1736">1736</td><td class="line">         <span class='comment'>* 2 bytes for ALPN data length</span></td></tr>
<tr class="codeline" data-linenumber="1737"><td class="num" id="LN1737">1737</td><td class="line">         <span class='comment'>* 1 byte for selected protocol length</span></td></tr>
<tr class="codeline" data-linenumber="1738"><td class="num" id="LN1738">1738</td><td class="line">         <span class='comment'>* + length of the selected protocol</span></td></tr>
<tr class="codeline" data-linenumber="1739"><td class="num" id="LN1739">1739</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1740"><td class="num" id="LN1740">1740</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>CHECKLEN(ret, 7 + len, limit)<span class='macro_popup'>(((ret) &gt;= (limit)) || (size_t)((limit) - (ret)) &lt; (size_t<br>)(7 + len))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1741"><td class="num" id="LN1741">1741</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1742"><td class="num" id="LN1742">1742</td><td class="line">        <span class='macro'>s2n(TLSEXT_TYPE_application_layer_protocol_negotiation, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((16)&gt;&gt; 8)&amp;0xff), (ret)[<br>1]=(unsigned char)(((16) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1743"><td class="num" id="LN1743">1743</td><td class="line">        <span class='macro'>s2n(3 + len, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((3 + len)&gt;&gt; 8)&amp;0xff), (<br>ret)[1]=(unsigned char)(((3 + len) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1744"><td class="num" id="LN1744">1744</td><td class="line">        <span class='macro'>s2n(1 + len, ret)<span class='macro_popup'>(((ret)[0]=(unsigned char)(((1 + len)&gt;&gt; 8)&amp;0xff), (<br>ret)[1]=(unsigned char)(((1 + len) )&amp;0xff)),(ret)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1745"><td class="num" id="LN1745">1745</td><td class="line">        *ret++ = len;</td></tr>
<tr class="codeline" data-linenumber="1746"><td class="num" id="LN1746">1746</td><td class="line">        memcpy(ret, selected, len);</td></tr>
<tr class="codeline" data-linenumber="1747"><td class="num" id="LN1747">1747</td><td class="line">        ret += len;</td></tr>
<tr class="codeline" data-linenumber="1748"><td class="num" id="LN1748">1748</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1749"><td class="num" id="LN1749">1749</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1750"><td class="num" id="LN1750">1750</td><td class="line"> done:</td></tr>
<tr class="codeline" data-linenumber="1751"><td class="num" id="LN1751">1751</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1752"><td class="num" id="LN1752">1752</td><td class="line">    <span class='keyword'>if</span> ((extdatalen = ret - orig - 2) == 0)</td></tr>
<tr class="codeline" data-linenumber="1753"><td class="num" id="LN1753">1753</td><td class="line">        <span class='keyword'>return</span> orig;</td></tr>
<tr class="codeline" data-linenumber="1754"><td class="num" id="LN1754">1754</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1755"><td class="num" id="LN1755">1755</td><td class="line">    <span class='macro'>s2n(extdatalen, orig)<span class='macro_popup'>(((orig)[0]=(unsigned char)(((extdatalen)&gt;&gt; 8)&amp;0xff<br>), (orig)[1]=(unsigned char)(((extdatalen) )&amp;0xff)),(orig<br>)+=2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1756"><td class="num" id="LN1756">1756</td><td class="line">    <span class='keyword'>return</span> ret;</td></tr>
<tr class="codeline" data-linenumber="1757"><td class="num" id="LN1757">1757</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1758"><td class="num" id="LN1758">1758</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1759"><td class="num" id="LN1759">1759</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1760"><td class="num" id="LN1760">1760</td><td class="line"> <span class='comment'>* Save the ALPN extension in a ClientHello.</span></td></tr>
<tr class="codeline" data-linenumber="1761"><td class="num" id="LN1761">1761</td><td class="line"> <span class='comment'>* pkt: the contents of the ALPN extension, not including type and length.</span></td></tr>
<tr class="codeline" data-linenumber="1762"><td class="num" id="LN1762">1762</td><td class="line"> <span class='comment'>* al: a pointer to the  alert value to send in the event of a failure.</span></td></tr>
<tr class="codeline" data-linenumber="1763"><td class="num" id="LN1763">1763</td><td class="line"> <span class='comment'>* returns: 1 on success, 0 on error.</span></td></tr>
<tr class="codeline" data-linenumber="1764"><td class="num" id="LN1764">1764</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1765"><td class="num" id="LN1765">1765</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls1_alpn_handle_client_hello(SSL *s, PACKET *pkt, <span class='keyword'>int</span> *al)</td></tr>
<tr class="codeline" data-linenumber="1766"><td class="num" id="LN1766">1766</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1767"><td class="num" id="LN1767">1767</td><td class="line">    PACKET protocol_list, save_protocol_list, protocol;</td></tr>
<tr class="codeline" data-linenumber="1768"><td class="num" id="LN1768">1768</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1769"><td class="num" id="LN1769">1769</td><td class="line">    *al = <span class='macro'>SSL_AD_DECODE_ERROR<span class='macro_popup'>50</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1770"><td class="num" id="LN1770">1770</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1771"><td class="num" id="LN1771">1771</td><td class="line">    <span class='keyword'>if</span> (!PACKET_as_length_prefixed_2(pkt, &amp;protocol_list)</td></tr>
<tr class="codeline" data-linenumber="1772"><td class="num" id="LN1772">1772</td><td class="line">        || PACKET_remaining(&amp;protocol_list) &lt; 2) {</td></tr>
<tr class="codeline" data-linenumber="1773"><td class="num" id="LN1773">1773</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1774"><td class="num" id="LN1774">1774</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1775"><td class="num" id="LN1775">1775</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1776"><td class="num" id="LN1776">1776</td><td class="line">    save_protocol_list = protocol_list;</td></tr>
<tr class="codeline" data-linenumber="1777"><td class="num" id="LN1777">1777</td><td class="line">    <span class='keyword'>do</span> {</td></tr>
<tr class="codeline" data-linenumber="1778"><td class="num" id="LN1778">1778</td><td class="line">        <span class='comment'>/* Protocol names can't be empty. */</span></td></tr>
<tr class="codeline" data-linenumber="1779"><td class="num" id="LN1779">1779</td><td class="line">        <span class='keyword'>if</span> (!PACKET_get_length_prefixed_1(&amp;protocol_list, &amp;protocol)</td></tr>
<tr class="codeline" data-linenumber="1780"><td class="num" id="LN1780">1780</td><td class="line">            || PACKET_remaining(&amp;protocol) == 0) {</td></tr>
<tr class="codeline" data-linenumber="1781"><td class="num" id="LN1781">1781</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1782"><td class="num" id="LN1782">1782</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1783"><td class="num" id="LN1783">1783</td><td class="line">    } <span class='keyword'>while</span> (PACKET_remaining(&amp;protocol_list) != 0);</td></tr>
<tr class="codeline" data-linenumber="1784"><td class="num" id="LN1784">1784</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1785"><td class="num" id="LN1785">1785</td><td class="line">    <span class='keyword'>if</span> (!PACKET_memdup(&amp;save_protocol_list,</td></tr>
<tr class="codeline" data-linenumber="1786"><td class="num" id="LN1786">1786</td><td class="line">                       &amp;s-&gt;s3-&gt;alpn_proposed, &amp;s-&gt;s3-&gt;alpn_proposed_len)) {</td></tr>
<tr class="codeline" data-linenumber="1787"><td class="num" id="LN1787">1787</td><td class="line">        *al = <span class='macro'>TLS1_AD_INTERNAL_ERROR<span class='macro_popup'>80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1788"><td class="num" id="LN1788">1788</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1789"><td class="num" id="LN1789">1789</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1790"><td class="num" id="LN1790">1790</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1791"><td class="num" id="LN1791">1791</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1792"><td class="num" id="LN1792">1792</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1793"><td class="num" id="LN1793">1793</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1794"><td class="num" id="LN1794">1794</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1795"><td class="num" id="LN1795">1795</td><td class="line"> <span class='comment'>* Process the ALPN extension in a ClientHello.</span></td></tr>
<tr class="codeline" data-linenumber="1796"><td class="num" id="LN1796">1796</td><td class="line"> <span class='comment'>* al: a pointer to the alert value to send in the event of a failure.</span></td></tr>
<tr class="codeline" data-linenumber="1797"><td class="num" id="LN1797">1797</td><td class="line"> <span class='comment'>* returns 1 on success, 0 on error.</span></td></tr>
<tr class="codeline" data-linenumber="1798"><td class="num" id="LN1798">1798</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1799"><td class="num" id="LN1799">1799</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls1_alpn_handle_client_hello_late(SSL *s, <span class='keyword'>int</span> *al)</td></tr>
<tr class="codeline" data-linenumber="1800"><td class="num" id="LN1800">1800</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1801"><td class="num" id="LN1801">1801</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *selected = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1802"><td class="num" id="LN1802">1802</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> selected_len = 0;</td></tr>
<tr class="codeline" data-linenumber="1803"><td class="num" id="LN1803">1803</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1804"><td class="num" id="LN1804">1804</td><td class="line">    <span class='keyword'>if</span> (s-&gt;ctx-&gt;alpn_select_cb != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; s-&gt;s3-&gt;alpn_proposed != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1805"><td class="num" id="LN1805">1805</td><td class="line">        <span class='keyword'>int</span> r = s-&gt;ctx-&gt;alpn_select_cb(s, &amp;selected, &amp;selected_len,</td></tr>
<tr class="codeline" data-linenumber="1806"><td class="num" id="LN1806">1806</td><td class="line">                                       s-&gt;s3-&gt;alpn_proposed,</td></tr>
<tr class="codeline" data-linenumber="1807"><td class="num" id="LN1807">1807</td><td class="line">                                       s-&gt;s3-&gt;alpn_proposed_len,</td></tr>
<tr class="codeline" data-linenumber="1808"><td class="num" id="LN1808">1808</td><td class="line">                                       s-&gt;ctx-&gt;alpn_select_cb_arg);</td></tr>
<tr class="codeline" data-linenumber="1809"><td class="num" id="LN1809">1809</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1810"><td class="num" id="LN1810">1810</td><td class="line">        <span class='keyword'>if</span> (r == <span class='macro'>SSL_TLSEXT_ERR_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1811"><td class="num" id="LN1811">1811</td><td class="line">            <span class='macro'>OPENSSL_free(s-&gt;s3-&gt;alpn_selected)<span class='macro_popup'>CRYPTO_free(s-&gt;s3-&gt;alpn_selected, "ssl/t1_lib.c", 1811)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1812"><td class="num" id="LN1812">1812</td><td class="line">            s-&gt;s3-&gt;alpn_selected = <span class='macro'>OPENSSL_memdup(selected, selected_len)<span class='macro_popup'>CRYPTO_memdup((selected), selected_len, "ssl/t1_lib.c", 1812)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1813"><td class="num" id="LN1813">1813</td><td class="line">            <span class='keyword'>if</span> (s-&gt;s3-&gt;alpn_selected == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1814"><td class="num" id="LN1814">1814</td><td class="line">                *al = <span class='macro'>SSL_AD_INTERNAL_ERROR<span class='macro_popup'>80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1815"><td class="num" id="LN1815">1815</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1816"><td class="num" id="LN1816">1816</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1817"><td class="num" id="LN1817">1817</td><td class="line">            s-&gt;s3-&gt;alpn_selected_len = selected_len;</td></tr>
<tr class="codeline" data-linenumber="1818"><td class="num" id="LN1818">1818</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_NEXTPROTONEG</span></td></tr>
<tr class="codeline" data-linenumber="1819"><td class="num" id="LN1819">1819</td><td class="line">            <span class='comment'>/* ALPN takes precedence over NPN. */</span></td></tr>
<tr class="codeline" data-linenumber="1820"><td class="num" id="LN1820">1820</td><td class="line">            s-&gt;s3-&gt;next_proto_neg_seen = 0;</td></tr>
<tr class="codeline" data-linenumber="1821"><td class="num" id="LN1821">1821</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1822"><td class="num" id="LN1822">1822</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (r == <span class='macro'>SSL_TLSEXT_ERR_NOACK<span class='macro_popup'>3</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1823"><td class="num" id="LN1823">1823</td><td class="line">            <span class='comment'>/* Behave as if no callback was present. */</span></td></tr>
<tr class="codeline" data-linenumber="1824"><td class="num" id="LN1824">1824</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1825"><td class="num" id="LN1825">1825</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1826"><td class="num" id="LN1826">1826</td><td class="line">            *al = <span class='macro'>SSL_AD_NO_APPLICATION_PROTOCOL<span class='macro_popup'>120</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1827"><td class="num" id="LN1827">1827</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1828"><td class="num" id="LN1828">1828</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1829"><td class="num" id="LN1829">1829</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1830"><td class="num" id="LN1830">1830</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1831"><td class="num" id="LN1831">1831</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1832"><td class="num" id="LN1832">1832</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1833"><td class="num" id="LN1833">1833</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1834"><td class="num" id="LN1834">1834</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="1835"><td class="num" id="LN1835">1835</td><td class="line"><span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1836"><td class="num" id="LN1836">1836</td><td class="line"> <span class='comment'>* ssl_check_for_safari attempts to fingerprint Safari using OS X</span></td></tr>
<tr class="codeline" data-linenumber="1837"><td class="num" id="LN1837">1837</td><td class="line"> <span class='comment'>* SecureTransport using the TLS extension block in |pkt|.</span></td></tr>
<tr class="codeline" data-linenumber="1838"><td class="num" id="LN1838">1838</td><td class="line"> <span class='comment'>* Safari, since 10.6, sends exactly these extensions, in this order:</span></td></tr>
<tr class="codeline" data-linenumber="1839"><td class="num" id="LN1839">1839</td><td class="line"> <span class='comment'>*   SNI,</span></td></tr>
<tr class="codeline" data-linenumber="1840"><td class="num" id="LN1840">1840</td><td class="line"> <span class='comment'>*   elliptic_curves</span></td></tr>
<tr class="codeline" data-linenumber="1841"><td class="num" id="LN1841">1841</td><td class="line"> <span class='comment'>*   ec_point_formats</span></td></tr>
<tr class="codeline" data-linenumber="1842"><td class="num" id="LN1842">1842</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1843"><td class="num" id="LN1843">1843</td><td class="line"> <span class='comment'>* We wish to fingerprint Safari because they broke ECDHE-ECDSA support in 10.8,</span></td></tr>
<tr class="codeline" data-linenumber="1844"><td class="num" id="LN1844">1844</td><td class="line"> <span class='comment'>* but they advertise support. So enabling ECDHE-ECDSA ciphers breaks them.</span></td></tr>
<tr class="codeline" data-linenumber="1845"><td class="num" id="LN1845">1845</td><td class="line"> <span class='comment'>* Sadly we cannot differentiate 10.6, 10.7 and 10.8.4 (which work), from</span></td></tr>
<tr class="codeline" data-linenumber="1846"><td class="num" id="LN1846">1846</td><td class="line"> <span class='comment'>* 10.8..10.8.3 (which don't work).</span></td></tr>
<tr class="codeline" data-linenumber="1847"><td class="num" id="LN1847">1847</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1848"><td class="num" id="LN1848">1848</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> ssl_check_for_safari(SSL *s, <span class='keyword'>const</span> PACKET *pkt)</td></tr>
<tr class="codeline" data-linenumber="1849"><td class="num" id="LN1849">1849</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1850"><td class="num" id="LN1850">1850</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> type;</td></tr>
<tr class="codeline" data-linenumber="1851"><td class="num" id="LN1851">1851</td><td class="line">    PACKET sni, tmppkt;</td></tr>
<tr class="codeline" data-linenumber="1852"><td class="num" id="LN1852">1852</td><td class="line">    size_t ext_len;</td></tr>
<tr class="codeline" data-linenumber="1853"><td class="num" id="LN1853">1853</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1854"><td class="num" id="LN1854">1854</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> kSafariExtensionsBlock[] = {</td></tr>
<tr class="codeline" data-linenumber="1855"><td class="num" id="LN1855">1855</td><td class="line">        0x00, 0x0a,             <span class='comment'>/* elliptic_curves extension */</span></td></tr>
<tr class="codeline" data-linenumber="1856"><td class="num" id="LN1856">1856</td><td class="line">        0x00, 0x08,             <span class='comment'>/* 8 bytes */</span></td></tr>
<tr class="codeline" data-linenumber="1857"><td class="num" id="LN1857">1857</td><td class="line">        0x00, 0x06,             <span class='comment'>/* 6 bytes of curve ids */</span></td></tr>
<tr class="codeline" data-linenumber="1858"><td class="num" id="LN1858">1858</td><td class="line">        0x00, 0x17,             <span class='comment'>/* P-256 */</span></td></tr>
<tr class="codeline" data-linenumber="1859"><td class="num" id="LN1859">1859</td><td class="line">        0x00, 0x18,             <span class='comment'>/* P-384 */</span></td></tr>
<tr class="codeline" data-linenumber="1860"><td class="num" id="LN1860">1860</td><td class="line">        0x00, 0x19,             <span class='comment'>/* P-521 */</span></td></tr>
<tr class="codeline" data-linenumber="1861"><td class="num" id="LN1861">1861</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1862"><td class="num" id="LN1862">1862</td><td class="line">        0x00, 0x0b,             <span class='comment'>/* ec_point_formats */</span></td></tr>
<tr class="codeline" data-linenumber="1863"><td class="num" id="LN1863">1863</td><td class="line">        0x00, 0x02,             <span class='comment'>/* 2 bytes */</span></td></tr>
<tr class="codeline" data-linenumber="1864"><td class="num" id="LN1864">1864</td><td class="line">        0x01,                   <span class='comment'>/* 1 point format */</span></td></tr>
<tr class="codeline" data-linenumber="1865"><td class="num" id="LN1865">1865</td><td class="line">        0x00,                   <span class='comment'>/* uncompressed */</span></td></tr>
<tr class="codeline" data-linenumber="1866"><td class="num" id="LN1866">1866</td><td class="line">        <span class='comment'>/* The following is only present in TLS 1.2 */</span></td></tr>
<tr class="codeline" data-linenumber="1867"><td class="num" id="LN1867">1867</td><td class="line">        0x00, 0x0d,             <span class='comment'>/* signature_algorithms */</span></td></tr>
<tr class="codeline" data-linenumber="1868"><td class="num" id="LN1868">1868</td><td class="line">        0x00, 0x0c,             <span class='comment'>/* 12 bytes */</span></td></tr>
<tr class="codeline" data-linenumber="1869"><td class="num" id="LN1869">1869</td><td class="line">        0x00, 0x0a,             <span class='comment'>/* 10 bytes */</span></td></tr>
<tr class="codeline" data-linenumber="1870"><td class="num" id="LN1870">1870</td><td class="line">        0x05, 0x01,             <span class='comment'>/* SHA-384/RSA */</span></td></tr>
<tr class="codeline" data-linenumber="1871"><td class="num" id="LN1871">1871</td><td class="line">        0x04, 0x01,             <span class='comment'>/* SHA-256/RSA */</span></td></tr>
<tr class="codeline" data-linenumber="1872"><td class="num" id="LN1872">1872</td><td class="line">        0x02, 0x01,             <span class='comment'>/* SHA-1/RSA */</span></td></tr>
<tr class="codeline" data-linenumber="1873"><td class="num" id="LN1873">1873</td><td class="line">        0x04, 0x03,             <span class='comment'>/* SHA-256/ECDSA */</span></td></tr>
<tr class="codeline" data-linenumber="1874"><td class="num" id="LN1874">1874</td><td class="line">        0x02, 0x03,             <span class='comment'>/* SHA-1/ECDSA */</span></td></tr>
<tr class="codeline" data-linenumber="1875"><td class="num" id="LN1875">1875</td><td class="line">    };</td></tr>
<tr class="codeline" data-linenumber="1876"><td class="num" id="LN1876">1876</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1877"><td class="num" id="LN1877">1877</td><td class="line">    <span class='comment'>/* Length of the common prefix (first two extensions). */</span></td></tr>
<tr class="codeline" data-linenumber="1878"><td class="num" id="LN1878">1878</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>const</span> size_t kSafariCommonExtensionsLength = 18;</td></tr>
<tr class="codeline" data-linenumber="1879"><td class="num" id="LN1879">1879</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1880"><td class="num" id="LN1880">1880</td><td class="line">    tmppkt = *pkt;</td></tr>
<tr class="codeline" data-linenumber="1881"><td class="num" id="LN1881">1881</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1882"><td class="num" id="LN1882">1882</td><td class="line">    <span class='keyword'>if</span> (!PACKET_forward(&amp;tmppkt, 2)</td></tr>
<tr class="codeline" data-linenumber="1883"><td class="num" id="LN1883">1883</td><td class="line">        || !PACKET_get_net_2(&amp;tmppkt, &amp;type)</td></tr>
<tr class="codeline" data-linenumber="1884"><td class="num" id="LN1884">1884</td><td class="line">        || !PACKET_get_length_prefixed_2(&amp;tmppkt, &amp;sni)) {</td></tr>
<tr class="codeline" data-linenumber="1885"><td class="num" id="LN1885">1885</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1886"><td class="num" id="LN1886">1886</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1887"><td class="num" id="LN1887">1887</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1888"><td class="num" id="LN1888">1888</td><td class="line">    <span class='keyword'>if</span> (type != <span class='macro'>TLSEXT_TYPE_server_name<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1889"><td class="num" id="LN1889">1889</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1890"><td class="num" id="LN1890">1890</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1891"><td class="num" id="LN1891">1891</td><td class="line">    ext_len = <span class='macro'>TLS1_get_client_version(s)<span class='macro_popup'>((SSL_client_version(s) &gt;&gt; 8) == 0x03 ? SSL_client_version<br>(s) : 0)</span></span> &gt;= <span class='macro'>TLS1_2_VERSION<span class='macro_popup'>0x0303</span></span> ?</td></tr>
<tr class="codeline" data-linenumber="1892"><td class="num" id="LN1892">1892</td><td class="line">        <span class='keyword'>sizeof</span>(kSafariExtensionsBlock) : kSafariCommonExtensionsLength;</td></tr>
<tr class="codeline" data-linenumber="1893"><td class="num" id="LN1893">1893</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1894"><td class="num" id="LN1894">1894</td><td class="line">    s-&gt;s3-&gt;is_probably_safari = PACKET_equal(&amp;tmppkt, kSafariExtensionsBlock,</td></tr>
<tr class="codeline" data-linenumber="1895"><td class="num" id="LN1895">1895</td><td class="line">                                             ext_len);</td></tr>
<tr class="codeline" data-linenumber="1896"><td class="num" id="LN1896">1896</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1897"><td class="num" id="LN1897">1897</td><td class="line"><span class='directive'>#endif                          /* !OPENSSL_NO_EC */</span></td></tr>
<tr class="codeline" data-linenumber="1898"><td class="num" id="LN1898">1898</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1899"><td class="num" id="LN1899">1899</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1900"><td class="num" id="LN1900">1900</td><td class="line"> <span class='comment'>* Parse ClientHello extensions and stash extension info in various parts of</span></td></tr>
<tr class="codeline" data-linenumber="1901"><td class="num" id="LN1901">1901</td><td class="line"> <span class='comment'>* the SSL object. Verify that there are no duplicate extensions.</span></td></tr>
<tr class="codeline" data-linenumber="1902"><td class="num" id="LN1902">1902</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1903"><td class="num" id="LN1903">1903</td><td class="line"> <span class='comment'>* Behaviour upon resumption is extension-specific. If the extension has no</span></td></tr>
<tr class="codeline" data-linenumber="1904"><td class="num" id="LN1904">1904</td><td class="line"> <span class='comment'>* effect during resumption, it is parsed (to verify its format) but otherwise</span></td></tr>
<tr class="codeline" data-linenumber="1905"><td class="num" id="LN1905">1905</td><td class="line"> <span class='comment'>* ignored.</span></td></tr>
<tr class="codeline" data-linenumber="1906"><td class="num" id="LN1906">1906</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1907"><td class="num" id="LN1907">1907</td><td class="line"> <span class='comment'>* Consumes the entire packet in |pkt|. Returns 1 on success and 0 on failure.</span></td></tr>
<tr class="codeline" data-linenumber="1908"><td class="num" id="LN1908">1908</td><td class="line"> <span class='comment'>* Upon failure, sets |al| to the appropriate alert.</span></td></tr>
<tr class="codeline" data-linenumber="1909"><td class="num" id="LN1909">1909</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1910"><td class="num" id="LN1910">1910</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> ssl_scan_clienthello_tlsext(SSL *s, PACKET *pkt, <span class='keyword'>int</span> *al)</td></tr>
<tr class="codeline" data-linenumber="1911"><td class="num" id="LN1911">1911</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1912"><td class="num" id="LN1912">1912</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> type;</td></tr>
<tr class="codeline" data-linenumber="1913"><td class="num" id="LN1913">1913</td><td class="line">    <span class='keyword'>int</span> renegotiate_seen = 0;</td></tr>
<tr class="codeline" data-linenumber="1914"><td class="num" id="LN1914">1914</td><td class="line">    PACKET extensions;</td></tr>
<tr class="codeline" data-linenumber="1915"><td class="num" id="LN1915">1915</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1916"><td class="num" id="LN1916">1916</td><td class="line">    *al = <span class='macro'>SSL_AD_DECODE_ERROR<span class='macro_popup'>50</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1917"><td class="num" id="LN1917">1917</td><td class="line">    s-&gt;servername_done = 0;</td></tr>
<tr class="codeline" data-linenumber="1918"><td class="num" id="LN1918">1918</td><td class="line">    s-&gt;tlsext_status_type = -1;</td></tr>
<tr class="codeline" data-linenumber="1919"><td class="num" id="LN1919">1919</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_NEXTPROTONEG</span></td></tr>
<tr class="codeline" data-linenumber="1920"><td class="num" id="LN1920">1920</td><td class="line">    s-&gt;s3-&gt;next_proto_neg_seen = 0;</td></tr>
<tr class="codeline" data-linenumber="1921"><td class="num" id="LN1921">1921</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1922"><td class="num" id="LN1922">1922</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1923"><td class="num" id="LN1923">1923</td><td class="line">    <span class='macro'>OPENSSL_free(s-&gt;s3-&gt;alpn_selected)<span class='macro_popup'>CRYPTO_free(s-&gt;s3-&gt;alpn_selected, "ssl/t1_lib.c", 1923)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1924"><td class="num" id="LN1924">1924</td><td class="line">    s-&gt;s3-&gt;alpn_selected = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1925"><td class="num" id="LN1925">1925</td><td class="line">    s-&gt;s3-&gt;alpn_selected_len = 0;</td></tr>
<tr class="codeline" data-linenumber="1926"><td class="num" id="LN1926">1926</td><td class="line">    <span class='macro'>OPENSSL_free(s-&gt;s3-&gt;alpn_proposed)<span class='macro_popup'>CRYPTO_free(s-&gt;s3-&gt;alpn_proposed, "ssl/t1_lib.c", 1926)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1927"><td class="num" id="LN1927">1927</td><td class="line">    s-&gt;s3-&gt;alpn_proposed = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1928"><td class="num" id="LN1928">1928</td><td class="line">    s-&gt;s3-&gt;alpn_proposed_len = 0;</td></tr>
<tr class="codeline" data-linenumber="1929"><td class="num" id="LN1929">1929</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_HEARTBEATS</span></td></tr>
<tr class="codeline" data-linenumber="1930"><td class="num" id="LN1930">1930</td><td class="line">    s-&gt;tlsext_heartbeat &amp;= ~(SSL_DTLSEXT_HB_ENABLED |</td></tr>
<tr class="codeline" data-linenumber="1931"><td class="num" id="LN1931">1931</td><td class="line">                             SSL_DTLSEXT_HB_DONT_SEND_REQUESTS);</td></tr>
<tr class="codeline" data-linenumber="1932"><td class="num" id="LN1932">1932</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1933"><td class="num" id="LN1933">1933</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1934"><td class="num" id="LN1934">1934</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="1935"><td class="num" id="LN1935">1935</td><td class="line">    <span class='keyword'>if</span> (s-&gt;options &amp; <span class='macro'>SSL_OP_SAFARI_ECDHE_ECDSA_BUG<span class='macro_popup'>0x00000040U</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1936"><td class="num" id="LN1936">1936</td><td class="line">        ssl_check_for_safari(s, pkt);</td></tr>
<tr class="codeline" data-linenumber="1937"><td class="num" id="LN1937">1937</td><td class="line"><span class='directive'>#endif                          /* !OPENSSL_NO_EC */</span></td></tr>
<tr class="codeline" data-linenumber="1938"><td class="num" id="LN1938">1938</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1939"><td class="num" id="LN1939">1939</td><td class="line">    <span class='comment'>/* Clear any signature algorithms extension received */</span></td></tr>
<tr class="codeline" data-linenumber="1940"><td class="num" id="LN1940">1940</td><td class="line">    <span class='macro'>OPENSSL_free(s-&gt;s3-&gt;tmp.peer_sigalgs)<span class='macro_popup'>CRYPTO_free(s-&gt;s3-&gt;tmp.peer_sigalgs, "ssl/t1_lib.c", 1940<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1941"><td class="num" id="LN1941">1941</td><td class="line">    s-&gt;s3-&gt;tmp.peer_sigalgs = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1942"><td class="num" id="LN1942">1942</td><td class="line">    s-&gt;tlsext_use_etm = 0;</td></tr>
<tr class="codeline" data-linenumber="1943"><td class="num" id="LN1943">1943</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1944"><td class="num" id="LN1944">1944</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_SRP</span></td></tr>
<tr class="codeline" data-linenumber="1945"><td class="num" id="LN1945">1945</td><td class="line">    <span class='macro'>OPENSSL_free(s-&gt;srp_ctx.login)<span class='macro_popup'>CRYPTO_free(s-&gt;srp_ctx.login, "ssl/t1_lib.c", 1945)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1946"><td class="num" id="LN1946">1946</td><td class="line">    s-&gt;srp_ctx.login = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1947"><td class="num" id="LN1947">1947</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1948"><td class="num" id="LN1948">1948</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1949"><td class="num" id="LN1949">1949</td><td class="line">    s-&gt;srtp_profile = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1950"><td class="num" id="LN1950">1950</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1951"><td class="num" id="LN1951">1951</td><td class="line">    <span class='keyword'>if</span> (PACKET_remaining(pkt) == 0)</td></tr>
<tr class="codeline" data-linenumber="1952"><td class="num" id="LN1952">1952</td><td class="line">        <span class='keyword'>goto</span> ri_check;</td></tr>
<tr class="codeline" data-linenumber="1953"><td class="num" id="LN1953">1953</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1954"><td class="num" id="LN1954">1954</td><td class="line">    <span class='keyword'>if</span> (!PACKET_as_length_prefixed_2(pkt, &amp;extensions))</td></tr>
<tr class="codeline" data-linenumber="1955"><td class="num" id="LN1955">1955</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1956"><td class="num" id="LN1956">1956</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1957"><td class="num" id="LN1957">1957</td><td class="line">    <span class='keyword'>if</span> (!tls1_check_duplicate_extensions(&amp;extensions))</td></tr>
<tr class="codeline" data-linenumber="1958"><td class="num" id="LN1958">1958</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1959"><td class="num" id="LN1959">1959</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1960"><td class="num" id="LN1960">1960</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1961"><td class="num" id="LN1961">1961</td><td class="line">     <span class='comment'>* We parse all extensions to ensure the ClientHello is well-formed but,</span></td></tr>
<tr class="codeline" data-linenumber="1962"><td class="num" id="LN1962">1962</td><td class="line">     <span class='comment'>* unless an extension specifies otherwise, we ignore extensions upon</span></td></tr>
<tr class="codeline" data-linenumber="1963"><td class="num" id="LN1963">1963</td><td class="line">     <span class='comment'>* resumption.</span></td></tr>
<tr class="codeline" data-linenumber="1964"><td class="num" id="LN1964">1964</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1965"><td class="num" id="LN1965">1965</td><td class="line">    <span class='keyword'>while</span> (PACKET_get_net_2(&amp;extensions, &amp;type)) {</td></tr>
<tr class="codeline" data-linenumber="1966"><td class="num" id="LN1966">1966</td><td class="line">        PACKET extension;</td></tr>
<tr class="codeline" data-linenumber="1967"><td class="num" id="LN1967">1967</td><td class="line">        <span class='keyword'>if</span> (!PACKET_get_length_prefixed_2(&amp;extensions, &amp;extension))</td></tr>
<tr class="codeline" data-linenumber="1968"><td class="num" id="LN1968">1968</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1969"><td class="num" id="LN1969">1969</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1970"><td class="num" id="LN1970">1970</td><td class="line">        <span class='keyword'>if</span> (s-&gt;tlsext_debug_cb)</td></tr>
<tr class="codeline" data-linenumber="1971"><td class="num" id="LN1971">1971</td><td class="line">            s-&gt;tlsext_debug_cb(s, 0, type, PACKET_data(&amp;extension),</td></tr>
<tr class="codeline" data-linenumber="1972"><td class="num" id="LN1972">1972</td><td class="line">                               PACKET_remaining(&amp;extension),</td></tr>
<tr class="codeline" data-linenumber="1973"><td class="num" id="LN1973">1973</td><td class="line">                               s-&gt;tlsext_debug_arg);</td></tr>
<tr class="codeline" data-linenumber="1974"><td class="num" id="LN1974">1974</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1975"><td class="num" id="LN1975">1975</td><td class="line">        <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_renegotiate<span class='macro_popup'>0xff01</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1976"><td class="num" id="LN1976">1976</td><td class="line">            <span class='keyword'>if</span> (!ssl_parse_clienthello_renegotiate_ext(s, &amp;extension, al))</td></tr>
<tr class="codeline" data-linenumber="1977"><td class="num" id="LN1977">1977</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1978"><td class="num" id="LN1978">1978</td><td class="line">            renegotiate_seen = 1;</td></tr>
<tr class="codeline" data-linenumber="1979"><td class="num" id="LN1979">1979</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (s-&gt;version == <span class='macro'>SSL3_VERSION<span class='macro_popup'>0x0300</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1980"><td class="num" id="LN1980">1980</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1981"><td class="num" id="LN1981">1981</td><td class="line"><span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1982"><td class="num" id="LN1982">1982</td><td class="line"> <span class='comment'>* The servername extension is treated as follows:</span></td></tr>
<tr class="codeline" data-linenumber="1983"><td class="num" id="LN1983">1983</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1984"><td class="num" id="LN1984">1984</td><td class="line"> <span class='comment'>* - Only the hostname type is supported with a maximum length of 255.</span></td></tr>
<tr class="codeline" data-linenumber="1985"><td class="num" id="LN1985">1985</td><td class="line"> <span class='comment'>* - The servername is rejected if too long or if it contains zeros,</span></td></tr>
<tr class="codeline" data-linenumber="1986"><td class="num" id="LN1986">1986</td><td class="line"> <span class='comment'>*   in which case an fatal alert is generated.</span></td></tr>
<tr class="codeline" data-linenumber="1987"><td class="num" id="LN1987">1987</td><td class="line"> <span class='comment'>* - The servername field is maintained together with the session cache.</span></td></tr>
<tr class="codeline" data-linenumber="1988"><td class="num" id="LN1988">1988</td><td class="line"> <span class='comment'>* - When a session is resumed, the servername call back invoked in order</span></td></tr>
<tr class="codeline" data-linenumber="1989"><td class="num" id="LN1989">1989</td><td class="line"> <span class='comment'>*   to allow the application to position itself to the right context.</span></td></tr>
<tr class="codeline" data-linenumber="1990"><td class="num" id="LN1990">1990</td><td class="line"> <span class='comment'>* - The servername is acknowledged if it is new for a session or when</span></td></tr>
<tr class="codeline" data-linenumber="1991"><td class="num" id="LN1991">1991</td><td class="line"> <span class='comment'>*   it is identical to a previously used for the same session.</span></td></tr>
<tr class="codeline" data-linenumber="1992"><td class="num" id="LN1992">1992</td><td class="line"> <span class='comment'>*   Applications can control the behaviour.  They can at any time</span></td></tr>
<tr class="codeline" data-linenumber="1993"><td class="num" id="LN1993">1993</td><td class="line"> <span class='comment'>*   set a 'desirable' servername for a new SSL object. This can be the</span></td></tr>
<tr class="codeline" data-linenumber="1994"><td class="num" id="LN1994">1994</td><td class="line"> <span class='comment'>*   case for example with HTTPS when a Host: header field is received and</span></td></tr>
<tr class="codeline" data-linenumber="1995"><td class="num" id="LN1995">1995</td><td class="line"> <span class='comment'>*   a renegotiation is requested. In this case, a possible servername</span></td></tr>
<tr class="codeline" data-linenumber="1996"><td class="num" id="LN1996">1996</td><td class="line"> <span class='comment'>*   presented in the new client hello is only acknowledged if it matches</span></td></tr>
<tr class="codeline" data-linenumber="1997"><td class="num" id="LN1997">1997</td><td class="line"> <span class='comment'>*   the value of the Host: field.</span></td></tr>
<tr class="codeline" data-linenumber="1998"><td class="num" id="LN1998">1998</td><td class="line"> <span class='comment'>* - Applications must  use SSL_OP_NO_SESSION_RESUMPTION_ON_RENEGOTIATION</span></td></tr>
<tr class="codeline" data-linenumber="1999"><td class="num" id="LN1999">1999</td><td class="line"> <span class='comment'>*   if they provide for changing an explicit servername context for the</span></td></tr>
<tr class="codeline" data-linenumber="2000"><td class="num" id="LN2000">2000</td><td class="line"> <span class='comment'>*   session, i.e. when the session has been established with a servername</span></td></tr>
<tr class="codeline" data-linenumber="2001"><td class="num" id="LN2001">2001</td><td class="line"> <span class='comment'>*   extension.</span></td></tr>
<tr class="codeline" data-linenumber="2002"><td class="num" id="LN2002">2002</td><td class="line"> <span class='comment'>* - On session reconnect, the servername extension may be absent.</span></td></tr>
<tr class="codeline" data-linenumber="2003"><td class="num" id="LN2003">2003</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2004"><td class="num" id="LN2004">2004</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2005"><td class="num" id="LN2005">2005</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2006"><td class="num" id="LN2006">2006</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_server_name<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2007"><td class="num" id="LN2007">2007</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>int</span> servname_type;</td></tr>
<tr class="codeline" data-linenumber="2008"><td class="num" id="LN2008">2008</td><td class="line">            PACKET sni, hostname;</td></tr>
<tr class="codeline" data-linenumber="2009"><td class="num" id="LN2009">2009</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2010"><td class="num" id="LN2010">2010</td><td class="line">            <span class='keyword'>if</span> (!PACKET_as_length_prefixed_2(&amp;extension, &amp;sni)</td></tr>
<tr class="codeline" data-linenumber="2011"><td class="num" id="LN2011">2011</td><td class="line">                <span class='comment'>/* ServerNameList must be at least 1 byte long. */</span></td></tr>
<tr class="codeline" data-linenumber="2012"><td class="num" id="LN2012">2012</td><td class="line">                || PACKET_remaining(&amp;sni) == 0) {</td></tr>
<tr class="codeline" data-linenumber="2013"><td class="num" id="LN2013">2013</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2014"><td class="num" id="LN2014">2014</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2015"><td class="num" id="LN2015">2015</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2016"><td class="num" id="LN2016">2016</td><td class="line">            <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2017"><td class="num" id="LN2017">2017</td><td class="line">             <span class='comment'>* Although the server_name extension was intended to be</span></td></tr>
<tr class="codeline" data-linenumber="2018"><td class="num" id="LN2018">2018</td><td class="line">             <span class='comment'>* extensible to new name types, RFC 4366 defined the</span></td></tr>
<tr class="codeline" data-linenumber="2019"><td class="num" id="LN2019">2019</td><td class="line">             <span class='comment'>* syntax inextensibility and OpenSSL 1.0.x parses it as</span></td></tr>
<tr class="codeline" data-linenumber="2020"><td class="num" id="LN2020">2020</td><td class="line">             <span class='comment'>* such.</span></td></tr>
<tr class="codeline" data-linenumber="2021"><td class="num" id="LN2021">2021</td><td class="line">             <span class='comment'>* RFC 6066 corrected the mistake but adding new name types</span></td></tr>
<tr class="codeline" data-linenumber="2022"><td class="num" id="LN2022">2022</td><td class="line">             <span class='comment'>* is nevertheless no longer feasible, so act as if no other</span></td></tr>
<tr class="codeline" data-linenumber="2023"><td class="num" id="LN2023">2023</td><td class="line">             <span class='comment'>* SNI types can exist, to simplify parsing.</span></td></tr>
<tr class="codeline" data-linenumber="2024"><td class="num" id="LN2024">2024</td><td class="line">             <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2025"><td class="num" id="LN2025">2025</td><td class="line">             <span class='comment'>* Also note that the RFC permits only one SNI value per type,</span></td></tr>
<tr class="codeline" data-linenumber="2026"><td class="num" id="LN2026">2026</td><td class="line">             <span class='comment'>* i.e., we can only have a single hostname.</span></td></tr>
<tr class="codeline" data-linenumber="2027"><td class="num" id="LN2027">2027</td><td class="line">             <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2028"><td class="num" id="LN2028">2028</td><td class="line">            <span class='keyword'>if</span> (!PACKET_get_1(&amp;sni, &amp;servname_type)</td></tr>
<tr class="codeline" data-linenumber="2029"><td class="num" id="LN2029">2029</td><td class="line">                || servname_type != <span class='macro'>TLSEXT_NAMETYPE_host_name<span class='macro_popup'>0</span></span></td></tr>
<tr class="codeline" data-linenumber="2030"><td class="num" id="LN2030">2030</td><td class="line">                || !PACKET_as_length_prefixed_2(&amp;sni, &amp;hostname)) {</td></tr>
<tr class="codeline" data-linenumber="2031"><td class="num" id="LN2031">2031</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2032"><td class="num" id="LN2032">2032</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2033"><td class="num" id="LN2033">2033</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2034"><td class="num" id="LN2034">2034</td><td class="line">            <span class='keyword'>if</span> (!s-&gt;hit) {</td></tr>
<tr class="codeline" data-linenumber="2035"><td class="num" id="LN2035">2035</td><td class="line">                <span class='keyword'>if</span> (PACKET_remaining(&amp;hostname) &gt; <span class='macro'>TLSEXT_MAXLEN_host_name<span class='macro_popup'>255</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2036"><td class="num" id="LN2036">2036</td><td class="line">                    *al = <span class='macro'>TLS1_AD_UNRECOGNIZED_NAME<span class='macro_popup'>112</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2037"><td class="num" id="LN2037">2037</td><td class="line">                    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2038"><td class="num" id="LN2038">2038</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2039"><td class="num" id="LN2039">2039</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2040"><td class="num" id="LN2040">2040</td><td class="line">                <span class='keyword'>if</span> (PACKET_contains_zero_byte(&amp;hostname)) {</td></tr>
<tr class="codeline" data-linenumber="2041"><td class="num" id="LN2041">2041</td><td class="line">                    *al = <span class='macro'>TLS1_AD_UNRECOGNIZED_NAME<span class='macro_popup'>112</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2042"><td class="num" id="LN2042">2042</td><td class="line">                    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2043"><td class="num" id="LN2043">2043</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2044"><td class="num" id="LN2044">2044</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2045"><td class="num" id="LN2045">2045</td><td class="line">                <span class='keyword'>if</span> (!PACKET_strndup(&amp;hostname, &amp;s-&gt;session-&gt;tlsext_hostname)) {</td></tr>
<tr class="codeline" data-linenumber="2046"><td class="num" id="LN2046">2046</td><td class="line">                    *al = <span class='macro'>TLS1_AD_INTERNAL_ERROR<span class='macro_popup'>80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2047"><td class="num" id="LN2047">2047</td><td class="line">                    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2048"><td class="num" id="LN2048">2048</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2049"><td class="num" id="LN2049">2049</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2050"><td class="num" id="LN2050">2050</td><td class="line">                s-&gt;servername_done = 1;</td></tr>
<tr class="codeline" data-linenumber="2051"><td class="num" id="LN2051">2051</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2052"><td class="num" id="LN2052">2052</td><td class="line">                <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2053"><td class="num" id="LN2053">2053</td><td class="line">                 <span class='comment'>* TODO(openssl-team): if the SNI doesn't match, we MUST</span></td></tr>
<tr class="codeline" data-linenumber="2054"><td class="num" id="LN2054">2054</td><td class="line">                 <span class='comment'>* fall back to a full handshake.</span></td></tr>
<tr class="codeline" data-linenumber="2055"><td class="num" id="LN2055">2055</td><td class="line">                 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2056"><td class="num" id="LN2056">2056</td><td class="line">                s-&gt;servername_done = s-&gt;session-&gt;tlsext_hostname</td></tr>
<tr class="codeline" data-linenumber="2057"><td class="num" id="LN2057">2057</td><td class="line">                    &amp;&amp; PACKET_equal(&amp;hostname, s-&gt;session-&gt;tlsext_hostname,</td></tr>
<tr class="codeline" data-linenumber="2058"><td class="num" id="LN2058">2058</td><td class="line">                                    strlen(s-&gt;session-&gt;tlsext_hostname));</td></tr>
<tr class="codeline" data-linenumber="2059"><td class="num" id="LN2059">2059</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2060"><td class="num" id="LN2060">2060</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2061"><td class="num" id="LN2061">2061</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_SRP</span></td></tr>
<tr class="codeline" data-linenumber="2062"><td class="num" id="LN2062">2062</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_srp<span class='macro_popup'>12</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2063"><td class="num" id="LN2063">2063</td><td class="line">            PACKET srp_I;</td></tr>
<tr class="codeline" data-linenumber="2064"><td class="num" id="LN2064">2064</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2065"><td class="num" id="LN2065">2065</td><td class="line">            <span class='keyword'>if</span> (!PACKET_as_length_prefixed_1(&amp;extension, &amp;srp_I))</td></tr>
<tr class="codeline" data-linenumber="2066"><td class="num" id="LN2066">2066</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2067"><td class="num" id="LN2067">2067</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2068"><td class="num" id="LN2068">2068</td><td class="line">            <span class='keyword'>if</span> (PACKET_contains_zero_byte(&amp;srp_I))</td></tr>
<tr class="codeline" data-linenumber="2069"><td class="num" id="LN2069">2069</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2070"><td class="num" id="LN2070">2070</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2071"><td class="num" id="LN2071">2071</td><td class="line">            <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2072"><td class="num" id="LN2072">2072</td><td class="line">             <span class='comment'>* TODO(openssl-team): currently, we re-authenticate the user</span></td></tr>
<tr class="codeline" data-linenumber="2073"><td class="num" id="LN2073">2073</td><td class="line">             <span class='comment'>* upon resumption. Instead, we MUST ignore the login.</span></td></tr>
<tr class="codeline" data-linenumber="2074"><td class="num" id="LN2074">2074</td><td class="line">             <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2075"><td class="num" id="LN2075">2075</td><td class="line">            <span class='keyword'>if</span> (!PACKET_strndup(&amp;srp_I, &amp;s-&gt;srp_ctx.login)) {</td></tr>
<tr class="codeline" data-linenumber="2076"><td class="num" id="LN2076">2076</td><td class="line">                *al = <span class='macro'>TLS1_AD_INTERNAL_ERROR<span class='macro_popup'>80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2077"><td class="num" id="LN2077">2077</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2078"><td class="num" id="LN2078">2078</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2079"><td class="num" id="LN2079">2079</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2080"><td class="num" id="LN2080">2080</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2081"><td class="num" id="LN2081">2081</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2082"><td class="num" id="LN2082">2082</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="2083"><td class="num" id="LN2083">2083</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_ec_point_formats<span class='macro_popup'>11</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2084"><td class="num" id="LN2084">2084</td><td class="line">            PACKET ec_point_format_list;</td></tr>
<tr class="codeline" data-linenumber="2085"><td class="num" id="LN2085">2085</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2086"><td class="num" id="LN2086">2086</td><td class="line">            <span class='keyword'>if</span> (!PACKET_as_length_prefixed_1(&amp;extension, &amp;ec_point_format_list)</td></tr>
<tr class="codeline" data-linenumber="2087"><td class="num" id="LN2087">2087</td><td class="line">                || PACKET_remaining(&amp;ec_point_format_list) == 0) {</td></tr>
<tr class="codeline" data-linenumber="2088"><td class="num" id="LN2088">2088</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2089"><td class="num" id="LN2089">2089</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2090"><td class="num" id="LN2090">2090</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2091"><td class="num" id="LN2091">2091</td><td class="line">            <span class='keyword'>if</span> (!s-&gt;hit) {</td></tr>
<tr class="codeline" data-linenumber="2092"><td class="num" id="LN2092">2092</td><td class="line">                <span class='keyword'>if</span> (!PACKET_memdup(&amp;ec_point_format_list,</td></tr>
<tr class="codeline" data-linenumber="2093"><td class="num" id="LN2093">2093</td><td class="line">                                   &amp;s-&gt;session-&gt;tlsext_ecpointformatlist,</td></tr>
<tr class="codeline" data-linenumber="2094"><td class="num" id="LN2094">2094</td><td class="line">                                   &amp;s-&gt;</td></tr>
<tr class="codeline" data-linenumber="2095"><td class="num" id="LN2095">2095</td><td class="line">                                   session-&gt;tlsext_ecpointformatlist_length)) {</td></tr>
<tr class="codeline" data-linenumber="2096"><td class="num" id="LN2096">2096</td><td class="line">                    *al = <span class='macro'>TLS1_AD_INTERNAL_ERROR<span class='macro_popup'>80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2097"><td class="num" id="LN2097">2097</td><td class="line">                    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2098"><td class="num" id="LN2098">2098</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2099"><td class="num" id="LN2099">2099</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2100"><td class="num" id="LN2100">2100</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_elliptic_curves<span class='macro_popup'>10</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2101"><td class="num" id="LN2101">2101</td><td class="line">            PACKET elliptic_curve_list;</td></tr>
<tr class="codeline" data-linenumber="2102"><td class="num" id="LN2102">2102</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2103"><td class="num" id="LN2103">2103</td><td class="line">            <span class='comment'>/* Each NamedCurve is 2 bytes and we must have at least 1. */</span></td></tr>
<tr class="codeline" data-linenumber="2104"><td class="num" id="LN2104">2104</td><td class="line">            <span class='keyword'>if</span> (!PACKET_as_length_prefixed_2(&amp;extension, &amp;elliptic_curve_list)</td></tr>
<tr class="codeline" data-linenumber="2105"><td class="num" id="LN2105">2105</td><td class="line">                || PACKET_remaining(&amp;elliptic_curve_list) == 0</td></tr>
<tr class="codeline" data-linenumber="2106"><td class="num" id="LN2106">2106</td><td class="line">                || (PACKET_remaining(&amp;elliptic_curve_list) % 2) != 0) {</td></tr>
<tr class="codeline" data-linenumber="2107"><td class="num" id="LN2107">2107</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2108"><td class="num" id="LN2108">2108</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2109"><td class="num" id="LN2109">2109</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2110"><td class="num" id="LN2110">2110</td><td class="line">            <span class='keyword'>if</span> (!s-&gt;hit) {</td></tr>
<tr class="codeline" data-linenumber="2111"><td class="num" id="LN2111">2111</td><td class="line">                <span class='keyword'>if</span> (!PACKET_memdup(&amp;elliptic_curve_list,</td></tr>
<tr class="codeline" data-linenumber="2112"><td class="num" id="LN2112">2112</td><td class="line">                                   &amp;s-&gt;session-&gt;tlsext_ellipticcurvelist,</td></tr>
<tr class="codeline" data-linenumber="2113"><td class="num" id="LN2113">2113</td><td class="line">                                   &amp;s-&gt;</td></tr>
<tr class="codeline" data-linenumber="2114"><td class="num" id="LN2114">2114</td><td class="line">                                   session-&gt;tlsext_ellipticcurvelist_length)) {</td></tr>
<tr class="codeline" data-linenumber="2115"><td class="num" id="LN2115">2115</td><td class="line">                    *al = <span class='macro'>TLS1_AD_INTERNAL_ERROR<span class='macro_popup'>80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2116"><td class="num" id="LN2116">2116</td><td class="line">                    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2117"><td class="num" id="LN2117">2117</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2118"><td class="num" id="LN2118">2118</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2119"><td class="num" id="LN2119">2119</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2120"><td class="num" id="LN2120">2120</td><td class="line"><span class='directive'>#endif                          /* OPENSSL_NO_EC */</span></td></tr>
<tr class="codeline" data-linenumber="2121"><td class="num" id="LN2121">2121</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_session_ticket<span class='macro_popup'>35</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2122"><td class="num" id="LN2122">2122</td><td class="line">            <span class='keyword'>if</span> (s-&gt;tls_session_ticket_ext_cb &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2123"><td class="num" id="LN2123">2123</td><td class="line">                !s-&gt;tls_session_ticket_ext_cb(s, PACKET_data(&amp;extension),</td></tr>
<tr class="codeline" data-linenumber="2124"><td class="num" id="LN2124">2124</td><td class="line">                                              PACKET_remaining(&amp;extension),</td></tr>
<tr class="codeline" data-linenumber="2125"><td class="num" id="LN2125">2125</td><td class="line">                                              s-&gt;tls_session_ticket_ext_cb_arg))</td></tr>
<tr class="codeline" data-linenumber="2126"><td class="num" id="LN2126">2126</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="2127"><td class="num" id="LN2127">2127</td><td class="line">                *al = <span class='macro'>TLS1_AD_INTERNAL_ERROR<span class='macro_popup'>80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2128"><td class="num" id="LN2128">2128</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2129"><td class="num" id="LN2129">2129</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2130"><td class="num" id="LN2130">2130</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_signature_algorithms<span class='macro_popup'>13</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2131"><td class="num" id="LN2131">2131</td><td class="line">            PACKET supported_sig_algs;</td></tr>
<tr class="codeline" data-linenumber="2132"><td class="num" id="LN2132">2132</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2133"><td class="num" id="LN2133">2133</td><td class="line">            <span class='keyword'>if</span> (!PACKET_as_length_prefixed_2(&amp;extension, &amp;supported_sig_algs)</td></tr>
<tr class="codeline" data-linenumber="2134"><td class="num" id="LN2134">2134</td><td class="line">                || (PACKET_remaining(&amp;supported_sig_algs) % 2) != 0</td></tr>
<tr class="codeline" data-linenumber="2135"><td class="num" id="LN2135">2135</td><td class="line">                || PACKET_remaining(&amp;supported_sig_algs) == 0) {</td></tr>
<tr class="codeline" data-linenumber="2136"><td class="num" id="LN2136">2136</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2137"><td class="num" id="LN2137">2137</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2138"><td class="num" id="LN2138">2138</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2139"><td class="num" id="LN2139">2139</td><td class="line">            <span class='keyword'>if</span> (!s-&gt;hit) {</td></tr>
<tr class="codeline" data-linenumber="2140"><td class="num" id="LN2140">2140</td><td class="line">                <span class='keyword'>if</span> (!tls1_save_sigalgs(s, PACKET_data(&amp;supported_sig_algs),</td></tr>
<tr class="codeline" data-linenumber="2141"><td class="num" id="LN2141">2141</td><td class="line">                                       PACKET_remaining(&amp;supported_sig_algs))) {</td></tr>
<tr class="codeline" data-linenumber="2142"><td class="num" id="LN2142">2142</td><td class="line">                    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2143"><td class="num" id="LN2143">2143</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2144"><td class="num" id="LN2144">2144</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2145"><td class="num" id="LN2145">2145</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_status_request<span class='macro_popup'>5</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2146"><td class="num" id="LN2146">2146</td><td class="line">            <span class='keyword'>if</span> (!PACKET_get_1(&amp;extension,</td></tr>
<tr class="codeline" data-linenumber="2147"><td class="num" id="LN2147">2147</td><td class="line">                              (<span class='keyword'>unsigned</span> <span class='keyword'>int</span> *)&amp;s-&gt;tlsext_status_type)) {</td></tr>
<tr class="codeline" data-linenumber="2148"><td class="num" id="LN2148">2148</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2149"><td class="num" id="LN2149">2149</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2150"><td class="num" id="LN2150">2150</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_OCSP</span></td></tr>
<tr class="codeline" data-linenumber="2151"><td class="num" id="LN2151">2151</td><td class="line">            <span class='keyword'>if</span> (s-&gt;tlsext_status_type == <span class='macro'>TLSEXT_STATUSTYPE_ocsp<span class='macro_popup'>1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2152"><td class="num" id="LN2152">2152</td><td class="line">                <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *ext_data;</td></tr>
<tr class="codeline" data-linenumber="2153"><td class="num" id="LN2153">2153</td><td class="line">                PACKET responder_id_list, exts;</td></tr>
<tr class="codeline" data-linenumber="2154"><td class="num" id="LN2154">2154</td><td class="line">                <span class='keyword'>if</span> (!PACKET_get_length_prefixed_2</td></tr>
<tr class="codeline" data-linenumber="2155"><td class="num" id="LN2155">2155</td><td class="line">                    (&amp;extension, &amp;responder_id_list))</td></tr>
<tr class="codeline" data-linenumber="2156"><td class="num" id="LN2156">2156</td><td class="line">                    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2157"><td class="num" id="LN2157">2157</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2158"><td class="num" id="LN2158">2158</td><td class="line">                <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2159"><td class="num" id="LN2159">2159</td><td class="line">                 <span class='comment'>* We remove any OCSP_RESPIDs from a previous handshake</span></td></tr>
<tr class="codeline" data-linenumber="2160"><td class="num" id="LN2160">2160</td><td class="line">                 <span class='comment'>* to prevent unbounded memory growth - CVE-2016-6304</span></td></tr>
<tr class="codeline" data-linenumber="2161"><td class="num" id="LN2161">2161</td><td class="line">                 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2162"><td class="num" id="LN2162">2162</td><td class="line">                sk_OCSP_RESPID_pop_free(s-&gt;tlsext_ocsp_ids,</td></tr>
<tr class="codeline" data-linenumber="2163"><td class="num" id="LN2163">2163</td><td class="line">                                        OCSP_RESPID_free);</td></tr>
<tr class="codeline" data-linenumber="2164"><td class="num" id="LN2164">2164</td><td class="line">                <span class='keyword'>if</span> (PACKET_remaining(&amp;responder_id_list) &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="2165"><td class="num" id="LN2165">2165</td><td class="line">                    s-&gt;tlsext_ocsp_ids = sk_OCSP_RESPID_new_null();</td></tr>
<tr class="codeline" data-linenumber="2166"><td class="num" id="LN2166">2166</td><td class="line">                    <span class='keyword'>if</span> (s-&gt;tlsext_ocsp_ids == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2167"><td class="num" id="LN2167">2167</td><td class="line">                        *al = <span class='macro'>SSL_AD_INTERNAL_ERROR<span class='macro_popup'>80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2168"><td class="num" id="LN2168">2168</td><td class="line">                        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2169"><td class="num" id="LN2169">2169</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="2170"><td class="num" id="LN2170">2170</td><td class="line">                } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2171"><td class="num" id="LN2171">2171</td><td class="line">                    s-&gt;tlsext_ocsp_ids = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2172"><td class="num" id="LN2172">2172</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2173"><td class="num" id="LN2173">2173</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2174"><td class="num" id="LN2174">2174</td><td class="line">                <span class='keyword'>while</span> (PACKET_remaining(&amp;responder_id_list) &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="2175"><td class="num" id="LN2175">2175</td><td class="line">                    OCSP_RESPID *id;</td></tr>
<tr class="codeline" data-linenumber="2176"><td class="num" id="LN2176">2176</td><td class="line">                    PACKET responder_id;</td></tr>
<tr class="codeline" data-linenumber="2177"><td class="num" id="LN2177">2177</td><td class="line">                    <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *id_data;</td></tr>
<tr class="codeline" data-linenumber="2178"><td class="num" id="LN2178">2178</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2179"><td class="num" id="LN2179">2179</td><td class="line">                    <span class='keyword'>if</span> (!PACKET_get_length_prefixed_2(&amp;responder_id_list,</td></tr>
<tr class="codeline" data-linenumber="2180"><td class="num" id="LN2180">2180</td><td class="line">                                                      &amp;responder_id)</td></tr>
<tr class="codeline" data-linenumber="2181"><td class="num" id="LN2181">2181</td><td class="line">                        || PACKET_remaining(&amp;responder_id) == 0) {</td></tr>
<tr class="codeline" data-linenumber="2182"><td class="num" id="LN2182">2182</td><td class="line">                        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2183"><td class="num" id="LN2183">2183</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="2184"><td class="num" id="LN2184">2184</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2185"><td class="num" id="LN2185">2185</td><td class="line">                    id_data = PACKET_data(&amp;responder_id);</td></tr>
<tr class="codeline" data-linenumber="2186"><td class="num" id="LN2186">2186</td><td class="line">                    id = d2i_OCSP_RESPID(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, &amp;id_data,</td></tr>
<tr class="codeline" data-linenumber="2187"><td class="num" id="LN2187">2187</td><td class="line">                                         PACKET_remaining(&amp;responder_id));</td></tr>
<tr class="codeline" data-linenumber="2188"><td class="num" id="LN2188">2188</td><td class="line">                    <span class='keyword'>if</span> (id == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2189"><td class="num" id="LN2189">2189</td><td class="line">                        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2190"><td class="num" id="LN2190">2190</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2191"><td class="num" id="LN2191">2191</td><td class="line">                    <span class='keyword'>if</span> (id_data != PACKET_end(&amp;responder_id)) {</td></tr>
<tr class="codeline" data-linenumber="2192"><td class="num" id="LN2192">2192</td><td class="line">                        OCSP_RESPID_free(id);</td></tr>
<tr class="codeline" data-linenumber="2193"><td class="num" id="LN2193">2193</td><td class="line">                        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2194"><td class="num" id="LN2194">2194</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="2195"><td class="num" id="LN2195">2195</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2196"><td class="num" id="LN2196">2196</td><td class="line">                    <span class='keyword'>if</span> (!sk_OCSP_RESPID_push(s-&gt;tlsext_ocsp_ids, id)) {</td></tr>
<tr class="codeline" data-linenumber="2197"><td class="num" id="LN2197">2197</td><td class="line">                        OCSP_RESPID_free(id);</td></tr>
<tr class="codeline" data-linenumber="2198"><td class="num" id="LN2198">2198</td><td class="line">                        *al = <span class='macro'>SSL_AD_INTERNAL_ERROR<span class='macro_popup'>80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2199"><td class="num" id="LN2199">2199</td><td class="line">                        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2200"><td class="num" id="LN2200">2200</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="2201"><td class="num" id="LN2201">2201</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2202"><td class="num" id="LN2202">2202</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2203"><td class="num" id="LN2203">2203</td><td class="line">                <span class='comment'>/* Read in request_extensions */</span></td></tr>
<tr class="codeline" data-linenumber="2204"><td class="num" id="LN2204">2204</td><td class="line">                <span class='keyword'>if</span> (!PACKET_as_length_prefixed_2(&amp;extension, &amp;exts))</td></tr>
<tr class="codeline" data-linenumber="2205"><td class="num" id="LN2205">2205</td><td class="line">                    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2206"><td class="num" id="LN2206">2206</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2207"><td class="num" id="LN2207">2207</td><td class="line">                <span class='keyword'>if</span> (PACKET_remaining(&amp;exts) &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="2208"><td class="num" id="LN2208">2208</td><td class="line">                    ext_data = PACKET_data(&amp;exts);</td></tr>
<tr class="codeline" data-linenumber="2209"><td class="num" id="LN2209">2209</td><td class="line">                    sk_X509_EXTENSION_pop_free(s-&gt;tlsext_ocsp_exts,</td></tr>
<tr class="codeline" data-linenumber="2210"><td class="num" id="LN2210">2210</td><td class="line">                                               X509_EXTENSION_free);</td></tr>
<tr class="codeline" data-linenumber="2211"><td class="num" id="LN2211">2211</td><td class="line">                    s-&gt;tlsext_ocsp_exts =</td></tr>
<tr class="codeline" data-linenumber="2212"><td class="num" id="LN2212">2212</td><td class="line">                        d2i_X509_EXTENSIONS(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, &amp;ext_data,</td></tr>
<tr class="codeline" data-linenumber="2213"><td class="num" id="LN2213">2213</td><td class="line">                                            PACKET_remaining(&amp;exts));</td></tr>
<tr class="codeline" data-linenumber="2214"><td class="num" id="LN2214">2214</td><td class="line">                    <span class='keyword'>if</span> (s-&gt;tlsext_ocsp_exts == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="2215"><td class="num" id="LN2215">2215</td><td class="line">                        || ext_data != PACKET_end(&amp;exts)) {</td></tr>
<tr class="codeline" data-linenumber="2216"><td class="num" id="LN2216">2216</td><td class="line">                        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2217"><td class="num" id="LN2217">2217</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="2218"><td class="num" id="LN2218">2218</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2219"><td class="num" id="LN2219">2219</td><td class="line">            } <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2220"><td class="num" id="LN2220">2220</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2221"><td class="num" id="LN2221">2221</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="2222"><td class="num" id="LN2222">2222</td><td class="line">                <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2223"><td class="num" id="LN2223">2223</td><td class="line">                 <span class='comment'>* We don't know what to do with any other type so ignore it.</span></td></tr>
<tr class="codeline" data-linenumber="2224"><td class="num" id="LN2224">2224</td><td class="line">                 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2225"><td class="num" id="LN2225">2225</td><td class="line">                s-&gt;tlsext_status_type = -1;</td></tr>
<tr class="codeline" data-linenumber="2226"><td class="num" id="LN2226">2226</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2227"><td class="num" id="LN2227">2227</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2228"><td class="num" id="LN2228">2228</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_HEARTBEATS</span></td></tr>
<tr class="codeline" data-linenumber="2229"><td class="num" id="LN2229">2229</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>SSL_IS_DTLS(s)<span class='macro_popup'>(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8)</span></span> &amp;&amp; type == <span class='macro'>TLSEXT_TYPE_heartbeat<span class='macro_popup'>15</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2230"><td class="num" id="LN2230">2230</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>int</span> hbtype;</td></tr>
<tr class="codeline" data-linenumber="2231"><td class="num" id="LN2231">2231</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2232"><td class="num" id="LN2232">2232</td><td class="line">            <span class='keyword'>if</span> (!PACKET_get_1(&amp;extension, &amp;hbtype)</td></tr>
<tr class="codeline" data-linenumber="2233"><td class="num" id="LN2233">2233</td><td class="line">                || PACKET_remaining(&amp;extension)) {</td></tr>
<tr class="codeline" data-linenumber="2234"><td class="num" id="LN2234">2234</td><td class="line">                *al = <span class='macro'>SSL_AD_DECODE_ERROR<span class='macro_popup'>50</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2235"><td class="num" id="LN2235">2235</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2236"><td class="num" id="LN2236">2236</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2237"><td class="num" id="LN2237">2237</td><td class="line">            <span class='keyword'>switch</span> (hbtype) {</td></tr>
<tr class="codeline" data-linenumber="2238"><td class="num" id="LN2238">2238</td><td class="line">            <span class='keyword'>case</span> 0x01:         <span class='comment'>/* Client allows us to send HB requests */</span></td></tr>
<tr class="codeline" data-linenumber="2239"><td class="num" id="LN2239">2239</td><td class="line">                s-&gt;tlsext_heartbeat |= SSL_DTLSEXT_HB_ENABLED;</td></tr>
<tr class="codeline" data-linenumber="2240"><td class="num" id="LN2240">2240</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2241"><td class="num" id="LN2241">2241</td><td class="line">            <span class='keyword'>case</span> 0x02:         <span class='comment'>/* Client doesn't accept HB requests */</span></td></tr>
<tr class="codeline" data-linenumber="2242"><td class="num" id="LN2242">2242</td><td class="line">                s-&gt;tlsext_heartbeat |= SSL_DTLSEXT_HB_ENABLED;</td></tr>
<tr class="codeline" data-linenumber="2243"><td class="num" id="LN2243">2243</td><td class="line">                s-&gt;tlsext_heartbeat |= SSL_DTLSEXT_HB_DONT_SEND_REQUESTS;</td></tr>
<tr class="codeline" data-linenumber="2244"><td class="num" id="LN2244">2244</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2245"><td class="num" id="LN2245">2245</td><td class="line">            <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="2246"><td class="num" id="LN2246">2246</td><td class="line">                *al = <span class='macro'>SSL_AD_ILLEGAL_PARAMETER<span class='macro_popup'>47</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2247"><td class="num" id="LN2247">2247</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2248"><td class="num" id="LN2248">2248</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2249"><td class="num" id="LN2249">2249</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2250"><td class="num" id="LN2250">2250</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2251"><td class="num" id="LN2251">2251</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_NEXTPROTONEG</span></td></tr>
<tr class="codeline" data-linenumber="2252"><td class="num" id="LN2252">2252</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_next_proto_neg<span class='macro_popup'>13172</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2253"><td class="num" id="LN2253">2253</td><td class="line">                 s-&gt;s3-&gt;tmp.finish_md_len == 0) {</td></tr>
<tr class="codeline" data-linenumber="2254"><td class="num" id="LN2254">2254</td><td class="line">            <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="2255"><td class="num" id="LN2255">2255</td><td class="line">             <span class='comment'>* We shouldn't accept this extension on a</span></td></tr>
<tr class="codeline" data-linenumber="2256"><td class="num" id="LN2256">2256</td><td class="line">             <span class='comment'>* renegotiation.</span></td></tr>
<tr class="codeline" data-linenumber="2257"><td class="num" id="LN2257">2257</td><td class="line">             <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2258"><td class="num" id="LN2258">2258</td><td class="line">             <span class='comment'>* s-&gt;new_session will be set on renegotiation, but we</span></td></tr>
<tr class="codeline" data-linenumber="2259"><td class="num" id="LN2259">2259</td><td class="line">             <span class='comment'>* probably shouldn't rely that it couldn't be set on</span></td></tr>
<tr class="codeline" data-linenumber="2260"><td class="num" id="LN2260">2260</td><td class="line">             <span class='comment'>* the initial renegotiation too in certain cases (when</span></td></tr>
<tr class="codeline" data-linenumber="2261"><td class="num" id="LN2261">2261</td><td class="line">             <span class='comment'>* there's some other reason to disallow resuming an</span></td></tr>
<tr class="codeline" data-linenumber="2262"><td class="num" id="LN2262">2262</td><td class="line">             <span class='comment'>* earlier session -- the current code won't be doing</span></td></tr>
<tr class="codeline" data-linenumber="2263"><td class="num" id="LN2263">2263</td><td class="line">             <span class='comment'>* anything like that, but this might change).</span></td></tr>
<tr class="codeline" data-linenumber="2264"><td class="num" id="LN2264">2264</td><td class="line">             <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2265"><td class="num" id="LN2265">2265</td><td class="line">             <span class='comment'>* A valid sign that there's been a previous handshake</span></td></tr>
<tr class="codeline" data-linenumber="2266"><td class="num" id="LN2266">2266</td><td class="line">             <span class='comment'>* in this connection is if s-&gt;s3-&gt;tmp.finish_md_len &gt;</span></td></tr>
<tr class="codeline" data-linenumber="2267"><td class="num" id="LN2267">2267</td><td class="line">             <span class='comment'>* 0.  (We are talking about a check that will happen</span></td></tr>
<tr class="codeline" data-linenumber="2268"><td class="num" id="LN2268">2268</td><td class="line">             <span class='comment'>* in the Hello protocol round, well before a new</span></td></tr>
<tr class="codeline" data-linenumber="2269"><td class="num" id="LN2269">2269</td><td class="line">             <span class='comment'>* Finished message could have been computed.)</span></td></tr>
<tr class="codeline" data-linenumber="2270"><td class="num" id="LN2270">2270</td><td class="line">             <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2271"><td class="num" id="LN2271">2271</td><td class="line">            s-&gt;s3-&gt;next_proto_neg_seen = 1;</td></tr>
<tr class="codeline" data-linenumber="2272"><td class="num" id="LN2272">2272</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2273"><td class="num" id="LN2273">2273</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2274"><td class="num" id="LN2274">2274</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2275"><td class="num" id="LN2275">2275</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_application_layer_protocol_negotiation<span class='macro_popup'>16</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2276"><td class="num" id="LN2276">2276</td><td class="line">                 s-&gt;s3-&gt;tmp.finish_md_len == 0) {</td></tr>
<tr class="codeline" data-linenumber="2277"><td class="num" id="LN2277">2277</td><td class="line">            <span class='keyword'>if</span> (!tls1_alpn_handle_client_hello(s, &amp;extension, al))</td></tr>
<tr class="codeline" data-linenumber="2278"><td class="num" id="LN2278">2278</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2279"><td class="num" id="LN2279">2279</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2280"><td class="num" id="LN2280">2280</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2281"><td class="num" id="LN2281">2281</td><td class="line">        <span class='comment'>/* session ticket processed earlier */</span></td></tr>
<tr class="codeline" data-linenumber="2282"><td class="num" id="LN2282">2282</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_SRTP</span></td></tr>
<tr class="codeline" data-linenumber="2283"><td class="num" id="LN2283">2283</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>SSL_IS_DTLS(s)<span class='macro_popup'>(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8)</span></span> &amp;&amp; SSL_get_srtp_profiles(s)</td></tr>
<tr class="codeline" data-linenumber="2284"><td class="num" id="LN2284">2284</td><td class="line">                 &amp;&amp; type == <span class='macro'>TLSEXT_TYPE_use_srtp<span class='macro_popup'>14</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2285"><td class="num" id="LN2285">2285</td><td class="line">            <span class='keyword'>if</span> (ssl_parse_clienthello_use_srtp_ext(s, &amp;extension, al))</td></tr>
<tr class="codeline" data-linenumber="2286"><td class="num" id="LN2286">2286</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2287"><td class="num" id="LN2287">2287</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2288"><td class="num" id="LN2288">2288</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2289"><td class="num" id="LN2289">2289</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_encrypt_then_mac<span class='macro_popup'>22</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2290"><td class="num" id="LN2290">2290</td><td class="line">                 !(s-&gt;options &amp; <span class='macro'>SSL_OP_NO_ENCRYPT_THEN_MAC<span class='macro_popup'>0x00080000U</span></span>))</td></tr>
<tr class="codeline" data-linenumber="2291"><td class="num" id="LN2291">2291</td><td class="line">            s-&gt;tlsext_use_etm = 1;</td></tr>
<tr class="codeline" data-linenumber="2292"><td class="num" id="LN2292">2292</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2293"><td class="num" id="LN2293">2293</td><td class="line">         <span class='comment'>* Note: extended master secret extension handled in</span></td></tr>
<tr class="codeline" data-linenumber="2294"><td class="num" id="LN2294">2294</td><td class="line">         <span class='comment'>* tls_check_serverhello_tlsext_early()</span></td></tr>
<tr class="codeline" data-linenumber="2295"><td class="num" id="LN2295">2295</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2296"><td class="num" id="LN2296">2296</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2297"><td class="num" id="LN2297">2297</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2298"><td class="num" id="LN2298">2298</td><td class="line">         <span class='comment'>* If this ClientHello extension was unhandled and this is a</span></td></tr>
<tr class="codeline" data-linenumber="2299"><td class="num" id="LN2299">2299</td><td class="line">         <span class='comment'>* nonresumed connection, check whether the extension is a custom</span></td></tr>
<tr class="codeline" data-linenumber="2300"><td class="num" id="LN2300">2300</td><td class="line">         <span class='comment'>* TLS Extension (has a custom_srv_ext_record), and if so call the</span></td></tr>
<tr class="codeline" data-linenumber="2301"><td class="num" id="LN2301">2301</td><td class="line">         <span class='comment'>* callback and record the extension number so that an appropriate</span></td></tr>
<tr class="codeline" data-linenumber="2302"><td class="num" id="LN2302">2302</td><td class="line">         <span class='comment'>* ServerHello may be later returned.</span></td></tr>
<tr class="codeline" data-linenumber="2303"><td class="num" id="LN2303">2303</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2304"><td class="num" id="LN2304">2304</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (!s-&gt;hit) {</td></tr>
<tr class="codeline" data-linenumber="2305"><td class="num" id="LN2305">2305</td><td class="line">            <span class='keyword'>if</span> (custom_ext_parse(s, 1, type, PACKET_data(&amp;extension),</td></tr>
<tr class="codeline" data-linenumber="2306"><td class="num" id="LN2306">2306</td><td class="line">                                 PACKET_remaining(&amp;extension), al) &lt;= 0)</td></tr>
<tr class="codeline" data-linenumber="2307"><td class="num" id="LN2307">2307</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2308"><td class="num" id="LN2308">2308</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2309"><td class="num" id="LN2309">2309</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2310"><td class="num" id="LN2310">2310</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2311"><td class="num" id="LN2311">2311</td><td class="line">    <span class='keyword'>if</span> (PACKET_remaining(pkt) != 0) {</td></tr>
<tr class="codeline" data-linenumber="2312"><td class="num" id="LN2312">2312</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2313"><td class="num" id="LN2313">2313</td><td class="line">         <span class='comment'>* tls1_check_duplicate_extensions should ensure this never happens.</span></td></tr>
<tr class="codeline" data-linenumber="2314"><td class="num" id="LN2314">2314</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2315"><td class="num" id="LN2315">2315</td><td class="line">        *al = <span class='macro'>SSL_AD_INTERNAL_ERROR<span class='macro_popup'>80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2316"><td class="num" id="LN2316">2316</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2317"><td class="num" id="LN2317">2317</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2318"><td class="num" id="LN2318">2318</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2319"><td class="num" id="LN2319">2319</td><td class="line"> ri_check:</td></tr>
<tr class="codeline" data-linenumber="2320"><td class="num" id="LN2320">2320</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2321"><td class="num" id="LN2321">2321</td><td class="line">    <span class='comment'>/* Need RI if renegotiating */</span></td></tr>
<tr class="codeline" data-linenumber="2322"><td class="num" id="LN2322">2322</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2323"><td class="num" id="LN2323">2323</td><td class="line">    <span class='keyword'>if</span> (!renegotiate_seen &amp;&amp; s-&gt;renegotiate &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2324"><td class="num" id="LN2324">2324</td><td class="line">        !(s-&gt;options &amp; <span class='macro'>SSL_OP_ALLOW_UNSAFE_LEGACY_RENEGOTIATION<span class='macro_popup'>0x00040000U</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="2325"><td class="num" id="LN2325">2325</td><td class="line">        *al = <span class='macro'>SSL_AD_HANDSHAKE_FAILURE<span class='macro_popup'>40</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2326"><td class="num" id="LN2326">2326</td><td class="line">        <span class='macro'>SSLerr(SSL_F_SSL_SCAN_CLIENTHELLO_TLSEXT,<span class='macro_popup'>ERR_put_error(20,(320),(338),"ssl/t1_lib.c",2327)</span></span></td></tr>
<tr class="codeline" data-linenumber="2327"><td class="num" id="LN2327">2327</td><td class="line">               <span class='macro'>SSL_R_UNSAFE_LEGACY_RENEGOTIATION_DISABLED)<span class='macro_popup'>ERR_put_error(20,(320),(338),"ssl/t1_lib.c",2327)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2328"><td class="num" id="LN2328">2328</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2329"><td class="num" id="LN2329">2329</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2330"><td class="num" id="LN2330">2330</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2331"><td class="num" id="LN2331">2331</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2332"><td class="num" id="LN2332">2332</td><td class="line">     <span class='comment'>* This function currently has no state to clean up, so it returns directly.</span></td></tr>
<tr class="codeline" data-linenumber="2333"><td class="num" id="LN2333">2333</td><td class="line">     <span class='comment'>* If parsing fails at any point, the function returns early.</span></td></tr>
<tr class="codeline" data-linenumber="2334"><td class="num" id="LN2334">2334</td><td class="line">     <span class='comment'>* The SSL object may be left with partial data from extensions, but it must</span></td></tr>
<tr class="codeline" data-linenumber="2335"><td class="num" id="LN2335">2335</td><td class="line">     <span class='comment'>* then no longer be used, and clearing it up will free the leftovers.</span></td></tr>
<tr class="codeline" data-linenumber="2336"><td class="num" id="LN2336">2336</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2337"><td class="num" id="LN2337">2337</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2338"><td class="num" id="LN2338">2338</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2339"><td class="num" id="LN2339">2339</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2340"><td class="num" id="LN2340">2340</td><td class="line"><span class='keyword'>int</span> ssl_parse_clienthello_tlsext(SSL *s, PACKET *pkt)</td></tr>
<tr class="codeline" data-linenumber="2341"><td class="num" id="LN2341">2341</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2342"><td class="num" id="LN2342">2342</td><td class="line">    <span class='keyword'>int</span> al = -1;</td></tr>
<tr class="codeline" data-linenumber="2343"><td class="num" id="LN2343">2343</td><td class="line">    custom_ext_init(&amp;s-&gt;cert-&gt;srv_ext);</td></tr>
<tr class="codeline" data-linenumber="2344"><td class="num" id="LN2344">2344</td><td class="line">    <span class='keyword'>if</span> (ssl_scan_clienthello_tlsext(s, pkt, &amp;al) &lt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="2345"><td class="num" id="LN2345">2345</td><td class="line">        ssl3_send_alert(s, <span class='macro'>SSL3_AL_FATAL<span class='macro_popup'>2</span></span>, al);</td></tr>
<tr class="codeline" data-linenumber="2346"><td class="num" id="LN2346">2346</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2347"><td class="num" id="LN2347">2347</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2348"><td class="num" id="LN2348">2348</td><td class="line">    <span class='keyword'>if</span> (ssl_check_clienthello_tlsext_early(s) &lt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="2349"><td class="num" id="LN2349">2349</td><td class="line">        <span class='macro'>SSLerr(SSL_F_SSL_PARSE_CLIENTHELLO_TLSEXT, SSL_R_CLIENTHELLO_TLSEXT)<span class='macro_popup'>ERR_put_error(20,(302),(226),"ssl/t1_lib.c",2349)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2350"><td class="num" id="LN2350">2350</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2351"><td class="num" id="LN2351">2351</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2352"><td class="num" id="LN2352">2352</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2353"><td class="num" id="LN2353">2353</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2354"><td class="num" id="LN2354">2354</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2355"><td class="num" id="LN2355">2355</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_NEXTPROTONEG</span></td></tr>
<tr class="codeline" data-linenumber="2356"><td class="num" id="LN2356">2356</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2357"><td class="num" id="LN2357">2357</td><td class="line"> <span class='comment'>* ssl_next_proto_validate validates a Next Protocol Negotiation block. No</span></td></tr>
<tr class="codeline" data-linenumber="2358"><td class="num" id="LN2358">2358</td><td class="line"> <span class='comment'>* elements of zero length are allowed and the set of elements must exactly</span></td></tr>
<tr class="codeline" data-linenumber="2359"><td class="num" id="LN2359">2359</td><td class="line"> <span class='comment'>* fill the length of the block.</span></td></tr>
<tr class="codeline" data-linenumber="2360"><td class="num" id="LN2360">2360</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2361"><td class="num" id="LN2361">2361</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>char</span> ssl_next_proto_validate(PACKET *pkt)</td></tr>
<tr class="codeline" data-linenumber="2362"><td class="num" id="LN2362">2362</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2363"><td class="num" id="LN2363">2363</td><td class="line">    PACKET tmp_protocol;</td></tr>
<tr class="codeline" data-linenumber="2364"><td class="num" id="LN2364">2364</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2365"><td class="num" id="LN2365">2365</td><td class="line">    <span class='keyword'>while</span> (PACKET_remaining(pkt)) {</td></tr>
<tr class="codeline" data-linenumber="2366"><td class="num" id="LN2366">2366</td><td class="line">        <span class='keyword'>if</span> (!PACKET_get_length_prefixed_1(pkt, &amp;tmp_protocol)</td></tr>
<tr class="codeline" data-linenumber="2367"><td class="num" id="LN2367">2367</td><td class="line">            || PACKET_remaining(&amp;tmp_protocol) == 0)</td></tr>
<tr class="codeline" data-linenumber="2368"><td class="num" id="LN2368">2368</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2369"><td class="num" id="LN2369">2369</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2370"><td class="num" id="LN2370">2370</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2371"><td class="num" id="LN2371">2371</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2372"><td class="num" id="LN2372">2372</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2373"><td class="num" id="LN2373">2373</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2374"><td class="num" id="LN2374">2374</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2375"><td class="num" id="LN2375">2375</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> ssl_scan_serverhello_tlsext(SSL *s, PACKET *pkt, <span class='keyword'>int</span> *al)</td></tr>
<tr class="codeline" data-linenumber="2376"><td class="num" id="LN2376">2376</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2377"><td class="num" id="LN2377">2377</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> length, type, size;</td></tr>
<tr class="codeline" data-linenumber="2378"><td class="num" id="LN2378">2378</td><td class="line">    <span class='keyword'>int</span> tlsext_servername = 0;</td></tr>
<tr class="codeline" data-linenumber="2379"><td class="num" id="LN2379">2379</td><td class="line">    <span class='keyword'>int</span> renegotiate_seen = 0;</td></tr>
<tr class="codeline" data-linenumber="2380"><td class="num" id="LN2380">2380</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2381"><td class="num" id="LN2381">2381</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_NEXTPROTONEG</span></td></tr>
<tr class="codeline" data-linenumber="2382"><td class="num" id="LN2382">2382</td><td class="line">    s-&gt;s3-&gt;next_proto_neg_seen = 0;</td></tr>
<tr class="codeline" data-linenumber="2383"><td class="num" id="LN2383">2383</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2384"><td class="num" id="LN2384">2384</td><td class="line">    s-&gt;tlsext_ticket_expected = 0;</td></tr>
<tr class="codeline" data-linenumber="2385"><td class="num" id="LN2385">2385</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2386"><td class="num" id="LN2386">2386</td><td class="line">    <span class='macro'>OPENSSL_free(s-&gt;s3-&gt;alpn_selected)<span class='macro_popup'>CRYPTO_free(s-&gt;s3-&gt;alpn_selected, "ssl/t1_lib.c", 2386)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2387"><td class="num" id="LN2387">2387</td><td class="line">    s-&gt;s3-&gt;alpn_selected = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2388"><td class="num" id="LN2388">2388</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_HEARTBEATS</span></td></tr>
<tr class="codeline" data-linenumber="2389"><td class="num" id="LN2389">2389</td><td class="line">    s-&gt;tlsext_heartbeat &amp;= ~(SSL_DTLSEXT_HB_ENABLED |</td></tr>
<tr class="codeline" data-linenumber="2390"><td class="num" id="LN2390">2390</td><td class="line">                             SSL_DTLSEXT_HB_DONT_SEND_REQUESTS);</td></tr>
<tr class="codeline" data-linenumber="2391"><td class="num" id="LN2391">2391</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2392"><td class="num" id="LN2392">2392</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2393"><td class="num" id="LN2393">2393</td><td class="line">    s-&gt;tlsext_use_etm = 0;</td></tr>
<tr class="codeline" data-linenumber="2394"><td class="num" id="LN2394">2394</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2395"><td class="num" id="LN2395">2395</td><td class="line">    s-&gt;s3-&gt;flags &amp;= ~<span class='macro'>TLS1_FLAGS_RECEIVED_EXTMS<span class='macro_popup'>0x0200</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2396"><td class="num" id="LN2396">2396</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2397"><td class="num" id="LN2397">2397</td><td class="line">    <span class='keyword'>if</span> (!PACKET_get_net_2(pkt, &amp;length))</td></tr>
<tr class="codeline" data-linenumber="2398"><td class="num" id="LN2398">2398</td><td class="line">        <span class='keyword'>goto</span> ri_check;</td></tr>
<tr class="codeline" data-linenumber="2399"><td class="num" id="LN2399">2399</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2400"><td class="num" id="LN2400">2400</td><td class="line">    <span class='keyword'>if</span> (PACKET_remaining(pkt) != length) {</td></tr>
<tr class="codeline" data-linenumber="2401"><td class="num" id="LN2401">2401</td><td class="line">        *al = <span class='macro'>SSL_AD_DECODE_ERROR<span class='macro_popup'>50</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2402"><td class="num" id="LN2402">2402</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2403"><td class="num" id="LN2403">2403</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2404"><td class="num" id="LN2404">2404</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2405"><td class="num" id="LN2405">2405</td><td class="line">    <span class='keyword'>if</span> (!tls1_check_duplicate_extensions(pkt)) {</td></tr>
<tr class="codeline" data-linenumber="2406"><td class="num" id="LN2406">2406</td><td class="line">        *al = <span class='macro'>SSL_AD_DECODE_ERROR<span class='macro_popup'>50</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2407"><td class="num" id="LN2407">2407</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2408"><td class="num" id="LN2408">2408</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2409"><td class="num" id="LN2409">2409</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2410"><td class="num" id="LN2410">2410</td><td class="line">    <span class='keyword'>while</span> (PACKET_get_net_2(pkt, &amp;type) &amp;&amp; PACKET_get_net_2(pkt, &amp;size)) {</td></tr>
<tr class="codeline" data-linenumber="2411"><td class="num" id="LN2411">2411</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *data;</td></tr>
<tr class="codeline" data-linenumber="2412"><td class="num" id="LN2412">2412</td><td class="line">        PACKET spkt;</td></tr>
<tr class="codeline" data-linenumber="2413"><td class="num" id="LN2413">2413</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2414"><td class="num" id="LN2414">2414</td><td class="line">        <span class='keyword'>if</span> (!PACKET_get_sub_packet(pkt, &amp;spkt, size)</td></tr>
<tr class="codeline" data-linenumber="2415"><td class="num" id="LN2415">2415</td><td class="line">            || !PACKET_peek_bytes(&amp;spkt, &amp;data, size))</td></tr>
<tr class="codeline" data-linenumber="2416"><td class="num" id="LN2416">2416</td><td class="line">            <span class='keyword'>goto</span> ri_check;</td></tr>
<tr class="codeline" data-linenumber="2417"><td class="num" id="LN2417">2417</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2418"><td class="num" id="LN2418">2418</td><td class="line">        <span class='keyword'>if</span> (s-&gt;tlsext_debug_cb)</td></tr>
<tr class="codeline" data-linenumber="2419"><td class="num" id="LN2419">2419</td><td class="line">            s-&gt;tlsext_debug_cb(s, 1, type, data, size, s-&gt;tlsext_debug_arg);</td></tr>
<tr class="codeline" data-linenumber="2420"><td class="num" id="LN2420">2420</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2421"><td class="num" id="LN2421">2421</td><td class="line">        <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_renegotiate<span class='macro_popup'>0xff01</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2422"><td class="num" id="LN2422">2422</td><td class="line">            <span class='keyword'>if</span> (!ssl_parse_serverhello_renegotiate_ext(s, &amp;spkt, al))</td></tr>
<tr class="codeline" data-linenumber="2423"><td class="num" id="LN2423">2423</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2424"><td class="num" id="LN2424">2424</td><td class="line">            renegotiate_seen = 1;</td></tr>
<tr class="codeline" data-linenumber="2425"><td class="num" id="LN2425">2425</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (s-&gt;version == <span class='macro'>SSL3_VERSION<span class='macro_popup'>0x0300</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2426"><td class="num" id="LN2426">2426</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_server_name<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2427"><td class="num" id="LN2427">2427</td><td class="line">            <span class='keyword'>if</span> (s-&gt;tlsext_hostname == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || size &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="2428"><td class="num" id="LN2428">2428</td><td class="line">                *al = <span class='macro'>TLS1_AD_UNRECOGNIZED_NAME<span class='macro_popup'>112</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2429"><td class="num" id="LN2429">2429</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2430"><td class="num" id="LN2430">2430</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2431"><td class="num" id="LN2431">2431</td><td class="line">            tlsext_servername = 1;</td></tr>
<tr class="codeline" data-linenumber="2432"><td class="num" id="LN2432">2432</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2433"><td class="num" id="LN2433">2433</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="2434"><td class="num" id="LN2434">2434</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_ec_point_formats<span class='macro_popup'>11</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2435"><td class="num" id="LN2435">2435</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>int</span> ecpointformatlist_length;</td></tr>
<tr class="codeline" data-linenumber="2436"><td class="num" id="LN2436">2436</td><td class="line">            <span class='keyword'>if</span> (!PACKET_get_1(&amp;spkt, &amp;ecpointformatlist_length)</td></tr>
<tr class="codeline" data-linenumber="2437"><td class="num" id="LN2437">2437</td><td class="line">                || ecpointformatlist_length != size - 1) {</td></tr>
<tr class="codeline" data-linenumber="2438"><td class="num" id="LN2438">2438</td><td class="line">                *al = <span class='macro'>TLS1_AD_DECODE_ERROR<span class='macro_popup'>50</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2439"><td class="num" id="LN2439">2439</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2440"><td class="num" id="LN2440">2440</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2441"><td class="num" id="LN2441">2441</td><td class="line">            <span class='keyword'>if</span> (!s-&gt;hit) {</td></tr>
<tr class="codeline" data-linenumber="2442"><td class="num" id="LN2442">2442</td><td class="line">                s-&gt;session-&gt;tlsext_ecpointformatlist_length = 0;</td></tr>
<tr class="codeline" data-linenumber="2443"><td class="num" id="LN2443">2443</td><td class="line">                <span class='macro'>OPENSSL_free(s-&gt;session-&gt;tlsext_ecpointformatlist)<span class='macro_popup'>CRYPTO_free(s-&gt;session-&gt;tlsext_ecpointformatlist, "ssl/t1_lib.c"<br>, 2443)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2444"><td class="num" id="LN2444">2444</td><td class="line">                <span class='keyword'>if</span> ((s-&gt;session-&gt;tlsext_ecpointformatlist =</td></tr>
<tr class="codeline" data-linenumber="2445"><td class="num" id="LN2445">2445</td><td class="line">                     <span class='macro'>OPENSSL_malloc(ecpointformatlist_length)<span class='macro_popup'>CRYPTO_malloc(ecpointformatlist_length, "ssl/t1_lib.c", 2445)</span></span>) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2446"><td class="num" id="LN2446">2446</td><td class="line">                    *al = <span class='macro'>TLS1_AD_INTERNAL_ERROR<span class='macro_popup'>80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2447"><td class="num" id="LN2447">2447</td><td class="line">                    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2448"><td class="num" id="LN2448">2448</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2449"><td class="num" id="LN2449">2449</td><td class="line">                s-&gt;session-&gt;tlsext_ecpointformatlist_length =</td></tr>
<tr class="codeline" data-linenumber="2450"><td class="num" id="LN2450">2450</td><td class="line">                    ecpointformatlist_length;</td></tr>
<tr class="codeline" data-linenumber="2451"><td class="num" id="LN2451">2451</td><td class="line">                <span class='keyword'>if</span> (!PACKET_copy_bytes(&amp;spkt,</td></tr>
<tr class="codeline" data-linenumber="2452"><td class="num" id="LN2452">2452</td><td class="line">                                       s-&gt;session-&gt;tlsext_ecpointformatlist,</td></tr>
<tr class="codeline" data-linenumber="2453"><td class="num" id="LN2453">2453</td><td class="line">                                       ecpointformatlist_length)) {</td></tr>
<tr class="codeline" data-linenumber="2454"><td class="num" id="LN2454">2454</td><td class="line">                    *al = <span class='macro'>TLS1_AD_DECODE_ERROR<span class='macro_popup'>50</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2455"><td class="num" id="LN2455">2455</td><td class="line">                    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2456"><td class="num" id="LN2456">2456</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2457"><td class="num" id="LN2457">2457</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2458"><td class="num" id="LN2458">2458</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2459"><td class="num" id="LN2459">2459</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2460"><td class="num" id="LN2460">2460</td><td class="line"><span class='directive'>#endif                          /* OPENSSL_NO_EC */</span></td></tr>
<tr class="codeline" data-linenumber="2461"><td class="num" id="LN2461">2461</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2462"><td class="num" id="LN2462">2462</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_session_ticket<span class='macro_popup'>35</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2463"><td class="num" id="LN2463">2463</td><td class="line">            <span class='keyword'>if</span> (s-&gt;tls_session_ticket_ext_cb &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2464"><td class="num" id="LN2464">2464</td><td class="line">                !s-&gt;tls_session_ticket_ext_cb(s, data, size,</td></tr>
<tr class="codeline" data-linenumber="2465"><td class="num" id="LN2465">2465</td><td class="line">                                              s-&gt;tls_session_ticket_ext_cb_arg))</td></tr>
<tr class="codeline" data-linenumber="2466"><td class="num" id="LN2466">2466</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="2467"><td class="num" id="LN2467">2467</td><td class="line">                *al = <span class='macro'>TLS1_AD_INTERNAL_ERROR<span class='macro_popup'>80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2468"><td class="num" id="LN2468">2468</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2469"><td class="num" id="LN2469">2469</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2470"><td class="num" id="LN2470">2470</td><td class="line">            <span class='keyword'>if</span> (!tls_use_ticket(s) || (size &gt; 0)) {</td></tr>
<tr class="codeline" data-linenumber="2471"><td class="num" id="LN2471">2471</td><td class="line">                *al = <span class='macro'>TLS1_AD_UNSUPPORTED_EXTENSION<span class='macro_popup'>110</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2472"><td class="num" id="LN2472">2472</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2473"><td class="num" id="LN2473">2473</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2474"><td class="num" id="LN2474">2474</td><td class="line">            s-&gt;tlsext_ticket_expected = 1;</td></tr>
<tr class="codeline" data-linenumber="2475"><td class="num" id="LN2475">2475</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_status_request<span class='macro_popup'>5</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2476"><td class="num" id="LN2476">2476</td><td class="line">            <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2477"><td class="num" id="LN2477">2477</td><td class="line">             <span class='comment'>* MUST be empty and only sent if we've requested a status</span></td></tr>
<tr class="codeline" data-linenumber="2478"><td class="num" id="LN2478">2478</td><td class="line">             <span class='comment'>* request message.</span></td></tr>
<tr class="codeline" data-linenumber="2479"><td class="num" id="LN2479">2479</td><td class="line">             <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2480"><td class="num" id="LN2480">2480</td><td class="line">            <span class='keyword'>if</span> ((s-&gt;tlsext_status_type == -1) || (size &gt; 0)) {</td></tr>
<tr class="codeline" data-linenumber="2481"><td class="num" id="LN2481">2481</td><td class="line">                *al = <span class='macro'>TLS1_AD_UNSUPPORTED_EXTENSION<span class='macro_popup'>110</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2482"><td class="num" id="LN2482">2482</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2483"><td class="num" id="LN2483">2483</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2484"><td class="num" id="LN2484">2484</td><td class="line">            <span class='comment'>/* Set flag to expect CertificateStatus message */</span></td></tr>
<tr class="codeline" data-linenumber="2485"><td class="num" id="LN2485">2485</td><td class="line">            s-&gt;tlsext_status_expected = 1;</td></tr>
<tr class="codeline" data-linenumber="2486"><td class="num" id="LN2486">2486</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2487"><td class="num" id="LN2487">2487</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_CT</span></td></tr>
<tr class="codeline" data-linenumber="2488"><td class="num" id="LN2488">2488</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2489"><td class="num" id="LN2489">2489</td><td class="line">         <span class='comment'>* Only take it if we asked for it - i.e if there is no CT validation</span></td></tr>
<tr class="codeline" data-linenumber="2490"><td class="num" id="LN2490">2490</td><td class="line">         <span class='comment'>* callback set, then a custom extension MAY be processing it, so we</span></td></tr>
<tr class="codeline" data-linenumber="2491"><td class="num" id="LN2491">2491</td><td class="line">         <span class='comment'>* need to let control continue to flow to that.</span></td></tr>
<tr class="codeline" data-linenumber="2492"><td class="num" id="LN2492">2492</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2493"><td class="num" id="LN2493">2493</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_signed_certificate_timestamp<span class='macro_popup'>18</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2494"><td class="num" id="LN2494">2494</td><td class="line">                 s-&gt;ct_validation_callback != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2495"><td class="num" id="LN2495">2495</td><td class="line">            <span class='comment'>/* Simply copy it off for later processing */</span></td></tr>
<tr class="codeline" data-linenumber="2496"><td class="num" id="LN2496">2496</td><td class="line">            <span class='keyword'>if</span> (s-&gt;tlsext_scts != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2497"><td class="num" id="LN2497">2497</td><td class="line">                <span class='macro'>OPENSSL_free(s-&gt;tlsext_scts)<span class='macro_popup'>CRYPTO_free(s-&gt;tlsext_scts, "ssl/t1_lib.c", 2497)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2498"><td class="num" id="LN2498">2498</td><td class="line">                s-&gt;tlsext_scts = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2499"><td class="num" id="LN2499">2499</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2500"><td class="num" id="LN2500">2500</td><td class="line">            s-&gt;tlsext_scts_len = size;</td></tr>
<tr class="codeline" data-linenumber="2501"><td class="num" id="LN2501">2501</td><td class="line">            <span class='keyword'>if</span> (size &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="2502"><td class="num" id="LN2502">2502</td><td class="line">                s-&gt;tlsext_scts = <span class='macro'>OPENSSL_malloc(size)<span class='macro_popup'>CRYPTO_malloc(size, "ssl/t1_lib.c", 2502)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2503"><td class="num" id="LN2503">2503</td><td class="line">                <span class='keyword'>if</span> (s-&gt;tlsext_scts == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2504"><td class="num" id="LN2504">2504</td><td class="line">                    *al = <span class='macro'>TLS1_AD_INTERNAL_ERROR<span class='macro_popup'>80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2505"><td class="num" id="LN2505">2505</td><td class="line">                    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2506"><td class="num" id="LN2506">2506</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2507"><td class="num" id="LN2507">2507</td><td class="line">                memcpy(s-&gt;tlsext_scts, data, size);</td></tr>
<tr class="codeline" data-linenumber="2508"><td class="num" id="LN2508">2508</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2509"><td class="num" id="LN2509">2509</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2510"><td class="num" id="LN2510">2510</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2511"><td class="num" id="LN2511">2511</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_NEXTPROTONEG</span></td></tr>
<tr class="codeline" data-linenumber="2512"><td class="num" id="LN2512">2512</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_next_proto_neg<span class='macro_popup'>13172</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2513"><td class="num" id="LN2513">2513</td><td class="line">                 s-&gt;s3-&gt;tmp.finish_md_len == 0) {</td></tr>
<tr class="codeline" data-linenumber="2514"><td class="num" id="LN2514">2514</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *selected;</td></tr>
<tr class="codeline" data-linenumber="2515"><td class="num" id="LN2515">2515</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>char</span> selected_len;</td></tr>
<tr class="codeline" data-linenumber="2516"><td class="num" id="LN2516">2516</td><td class="line">            <span class='comment'>/* We must have requested it. */</span></td></tr>
<tr class="codeline" data-linenumber="2517"><td class="num" id="LN2517">2517</td><td class="line">            <span class='keyword'>if</span> (s-&gt;ctx-&gt;next_proto_select_cb == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2518"><td class="num" id="LN2518">2518</td><td class="line">                *al = <span class='macro'>TLS1_AD_UNSUPPORTED_EXTENSION<span class='macro_popup'>110</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2519"><td class="num" id="LN2519">2519</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2520"><td class="num" id="LN2520">2520</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2521"><td class="num" id="LN2521">2521</td><td class="line">            <span class='comment'>/* The data must be valid */</span></td></tr>
<tr class="codeline" data-linenumber="2522"><td class="num" id="LN2522">2522</td><td class="line">            <span class='keyword'>if</span> (!ssl_next_proto_validate(&amp;spkt)) {</td></tr>
<tr class="codeline" data-linenumber="2523"><td class="num" id="LN2523">2523</td><td class="line">                *al = <span class='macro'>TLS1_AD_DECODE_ERROR<span class='macro_popup'>50</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2524"><td class="num" id="LN2524">2524</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2525"><td class="num" id="LN2525">2525</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2526"><td class="num" id="LN2526">2526</td><td class="line">            <span class='keyword'>if</span> (s-&gt;ctx-&gt;next_proto_select_cb(s, &amp;selected, &amp;selected_len, data,</td></tr>
<tr class="codeline" data-linenumber="2527"><td class="num" id="LN2527">2527</td><td class="line">                                             size,</td></tr>
<tr class="codeline" data-linenumber="2528"><td class="num" id="LN2528">2528</td><td class="line">                                             s-&gt;</td></tr>
<tr class="codeline" data-linenumber="2529"><td class="num" id="LN2529">2529</td><td class="line">                                             ctx-&gt;next_proto_select_cb_arg) !=</td></tr>
<tr class="codeline" data-linenumber="2530"><td class="num" id="LN2530">2530</td><td class="line">                <span class='macro'>SSL_TLSEXT_ERR_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2531"><td class="num" id="LN2531">2531</td><td class="line">                *al = <span class='macro'>TLS1_AD_INTERNAL_ERROR<span class='macro_popup'>80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2532"><td class="num" id="LN2532">2532</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2533"><td class="num" id="LN2533">2533</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2534"><td class="num" id="LN2534">2534</td><td class="line">            <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2535"><td class="num" id="LN2535">2535</td><td class="line">             <span class='comment'>* Could be non-NULL if server has sent multiple NPN extensions in</span></td></tr>
<tr class="codeline" data-linenumber="2536"><td class="num" id="LN2536">2536</td><td class="line">             <span class='comment'>* a single Serverhello</span></td></tr>
<tr class="codeline" data-linenumber="2537"><td class="num" id="LN2537">2537</td><td class="line">             <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2538"><td class="num" id="LN2538">2538</td><td class="line">            <span class='macro'>OPENSSL_free(s-&gt;next_proto_negotiated)<span class='macro_popup'>CRYPTO_free(s-&gt;next_proto_negotiated, "ssl/t1_lib.c", 2538<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2539"><td class="num" id="LN2539">2539</td><td class="line">            s-&gt;next_proto_negotiated = <span class='macro'>OPENSSL_malloc(selected_len)<span class='macro_popup'>CRYPTO_malloc(selected_len, "ssl/t1_lib.c", 2539)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2540"><td class="num" id="LN2540">2540</td><td class="line">            <span class='keyword'>if</span> (s-&gt;next_proto_negotiated == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2541"><td class="num" id="LN2541">2541</td><td class="line">                *al = <span class='macro'>TLS1_AD_INTERNAL_ERROR<span class='macro_popup'>80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2542"><td class="num" id="LN2542">2542</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2543"><td class="num" id="LN2543">2543</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2544"><td class="num" id="LN2544">2544</td><td class="line">            memcpy(s-&gt;next_proto_negotiated, selected, selected_len);</td></tr>
<tr class="codeline" data-linenumber="2545"><td class="num" id="LN2545">2545</td><td class="line">            s-&gt;next_proto_negotiated_len = selected_len;</td></tr>
<tr class="codeline" data-linenumber="2546"><td class="num" id="LN2546">2546</td><td class="line">            s-&gt;s3-&gt;next_proto_neg_seen = 1;</td></tr>
<tr class="codeline" data-linenumber="2547"><td class="num" id="LN2547">2547</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2548"><td class="num" id="LN2548">2548</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2549"><td class="num" id="LN2549">2549</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2550"><td class="num" id="LN2550">2550</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_application_layer_protocol_negotiation<span class='macro_popup'>16</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2551"><td class="num" id="LN2551">2551</td><td class="line">            <span class='keyword'>unsigned</span> len;</td></tr>
<tr class="codeline" data-linenumber="2552"><td class="num" id="LN2552">2552</td><td class="line">            <span class='comment'>/* We must have requested it. */</span></td></tr>
<tr class="codeline" data-linenumber="2553"><td class="num" id="LN2553">2553</td><td class="line">            <span class='keyword'>if</span> (!s-&gt;s3-&gt;alpn_sent) {</td></tr>
<tr class="codeline" data-linenumber="2554"><td class="num" id="LN2554">2554</td><td class="line">                *al = <span class='macro'>TLS1_AD_UNSUPPORTED_EXTENSION<span class='macro_popup'>110</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2555"><td class="num" id="LN2555">2555</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2556"><td class="num" id="LN2556">2556</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2557"><td class="num" id="LN2557">2557</td><td class="line">            <span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="2558"><td class="num" id="LN2558">2558</td><td class="line">             <span class='comment'>* The extension data consists of:</span></td></tr>
<tr class="codeline" data-linenumber="2559"><td class="num" id="LN2559">2559</td><td class="line">             <span class='comment'>*   uint16 list_length</span></td></tr>
<tr class="codeline" data-linenumber="2560"><td class="num" id="LN2560">2560</td><td class="line">             <span class='comment'>*   uint8 proto_length;</span></td></tr>
<tr class="codeline" data-linenumber="2561"><td class="num" id="LN2561">2561</td><td class="line">             <span class='comment'>*   uint8 proto[proto_length];</span></td></tr>
<tr class="codeline" data-linenumber="2562"><td class="num" id="LN2562">2562</td><td class="line">             <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2563"><td class="num" id="LN2563">2563</td><td class="line">            <span class='keyword'>if</span> (!PACKET_get_net_2(&amp;spkt, &amp;len)</td></tr>
<tr class="codeline" data-linenumber="2564"><td class="num" id="LN2564">2564</td><td class="line">                || PACKET_remaining(&amp;spkt) != len || !PACKET_get_1(&amp;spkt, &amp;len)</td></tr>
<tr class="codeline" data-linenumber="2565"><td class="num" id="LN2565">2565</td><td class="line">                || PACKET_remaining(&amp;spkt) != len) {</td></tr>
<tr class="codeline" data-linenumber="2566"><td class="num" id="LN2566">2566</td><td class="line">                *al = <span class='macro'>TLS1_AD_DECODE_ERROR<span class='macro_popup'>50</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2567"><td class="num" id="LN2567">2567</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2568"><td class="num" id="LN2568">2568</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2569"><td class="num" id="LN2569">2569</td><td class="line">            <span class='macro'>OPENSSL_free(s-&gt;s3-&gt;alpn_selected)<span class='macro_popup'>CRYPTO_free(s-&gt;s3-&gt;alpn_selected, "ssl/t1_lib.c", 2569)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2570"><td class="num" id="LN2570">2570</td><td class="line">            s-&gt;s3-&gt;alpn_selected = <span class='macro'>OPENSSL_malloc(len)<span class='macro_popup'>CRYPTO_malloc(len, "ssl/t1_lib.c", 2570)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2571"><td class="num" id="LN2571">2571</td><td class="line">            <span class='keyword'>if</span> (s-&gt;s3-&gt;alpn_selected == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2572"><td class="num" id="LN2572">2572</td><td class="line">                *al = <span class='macro'>TLS1_AD_INTERNAL_ERROR<span class='macro_popup'>80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2573"><td class="num" id="LN2573">2573</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2574"><td class="num" id="LN2574">2574</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2575"><td class="num" id="LN2575">2575</td><td class="line">            <span class='keyword'>if</span> (!PACKET_copy_bytes(&amp;spkt, s-&gt;s3-&gt;alpn_selected, len)) {</td></tr>
<tr class="codeline" data-linenumber="2576"><td class="num" id="LN2576">2576</td><td class="line">                *al = <span class='macro'>TLS1_AD_DECODE_ERROR<span class='macro_popup'>50</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2577"><td class="num" id="LN2577">2577</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2578"><td class="num" id="LN2578">2578</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2579"><td class="num" id="LN2579">2579</td><td class="line">            s-&gt;s3-&gt;alpn_selected_len = len;</td></tr>
<tr class="codeline" data-linenumber="2580"><td class="num" id="LN2580">2580</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2581"><td class="num" id="LN2581">2581</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_HEARTBEATS</span></td></tr>
<tr class="codeline" data-linenumber="2582"><td class="num" id="LN2582">2582</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>SSL_IS_DTLS(s)<span class='macro_popup'>(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8)</span></span> &amp;&amp; type == <span class='macro'>TLSEXT_TYPE_heartbeat<span class='macro_popup'>15</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2583"><td class="num" id="LN2583">2583</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>int</span> hbtype;</td></tr>
<tr class="codeline" data-linenumber="2584"><td class="num" id="LN2584">2584</td><td class="line">            <span class='keyword'>if</span> (!PACKET_get_1(&amp;spkt, &amp;hbtype)) {</td></tr>
<tr class="codeline" data-linenumber="2585"><td class="num" id="LN2585">2585</td><td class="line">                *al = <span class='macro'>SSL_AD_DECODE_ERROR<span class='macro_popup'>50</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2586"><td class="num" id="LN2586">2586</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2587"><td class="num" id="LN2587">2587</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2588"><td class="num" id="LN2588">2588</td><td class="line">            <span class='keyword'>switch</span> (hbtype) {</td></tr>
<tr class="codeline" data-linenumber="2589"><td class="num" id="LN2589">2589</td><td class="line">            <span class='keyword'>case</span> 0x01:         <span class='comment'>/* Server allows us to send HB requests */</span></td></tr>
<tr class="codeline" data-linenumber="2590"><td class="num" id="LN2590">2590</td><td class="line">                s-&gt;tlsext_heartbeat |= SSL_DTLSEXT_HB_ENABLED;</td></tr>
<tr class="codeline" data-linenumber="2591"><td class="num" id="LN2591">2591</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2592"><td class="num" id="LN2592">2592</td><td class="line">            <span class='keyword'>case</span> 0x02:         <span class='comment'>/* Server doesn't accept HB requests */</span></td></tr>
<tr class="codeline" data-linenumber="2593"><td class="num" id="LN2593">2593</td><td class="line">                s-&gt;tlsext_heartbeat |= SSL_DTLSEXT_HB_ENABLED;</td></tr>
<tr class="codeline" data-linenumber="2594"><td class="num" id="LN2594">2594</td><td class="line">                s-&gt;tlsext_heartbeat |= SSL_DTLSEXT_HB_DONT_SEND_REQUESTS;</td></tr>
<tr class="codeline" data-linenumber="2595"><td class="num" id="LN2595">2595</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2596"><td class="num" id="LN2596">2596</td><td class="line">            <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="2597"><td class="num" id="LN2597">2597</td><td class="line">                *al = <span class='macro'>SSL_AD_ILLEGAL_PARAMETER<span class='macro_popup'>47</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2598"><td class="num" id="LN2598">2598</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2599"><td class="num" id="LN2599">2599</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2600"><td class="num" id="LN2600">2600</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2601"><td class="num" id="LN2601">2601</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2602"><td class="num" id="LN2602">2602</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_SRTP</span></td></tr>
<tr class="codeline" data-linenumber="2603"><td class="num" id="LN2603">2603</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>SSL_IS_DTLS(s)<span class='macro_popup'>(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8)</span></span> &amp;&amp; type == <span class='macro'>TLSEXT_TYPE_use_srtp<span class='macro_popup'>14</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2604"><td class="num" id="LN2604">2604</td><td class="line">            <span class='keyword'>if</span> (ssl_parse_serverhello_use_srtp_ext(s, &amp;spkt, al))</td></tr>
<tr class="codeline" data-linenumber="2605"><td class="num" id="LN2605">2605</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2606"><td class="num" id="LN2606">2606</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2607"><td class="num" id="LN2607">2607</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2608"><td class="num" id="LN2608">2608</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_encrypt_then_mac<span class='macro_popup'>22</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2609"><td class="num" id="LN2609">2609</td><td class="line">            <span class='comment'>/* Ignore if inappropriate ciphersuite */</span></td></tr>
<tr class="codeline" data-linenumber="2610"><td class="num" id="LN2610">2610</td><td class="line">            <span class='keyword'>if</span> (!(s-&gt;options &amp; <span class='macro'>SSL_OP_NO_ENCRYPT_THEN_MAC<span class='macro_popup'>0x00080000U</span></span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2611"><td class="num" id="LN2611">2611</td><td class="line">                s-&gt;s3-&gt;tmp.new_cipher-&gt;algorithm_mac != <span class='macro'>SSL_AEAD<span class='macro_popup'>0x00000040U</span></span></td></tr>
<tr class="codeline" data-linenumber="2612"><td class="num" id="LN2612">2612</td><td class="line">                &amp;&amp; s-&gt;s3-&gt;tmp.new_cipher-&gt;algorithm_enc != <span class='macro'>SSL_RC4<span class='macro_popup'>0x00000004U</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2613"><td class="num" id="LN2613">2613</td><td class="line">                s-&gt;tlsext_use_etm = 1;</td></tr>
<tr class="codeline" data-linenumber="2614"><td class="num" id="LN2614">2614</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_extended_master_secret<span class='macro_popup'>23</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2615"><td class="num" id="LN2615">2615</td><td class="line">            s-&gt;s3-&gt;flags |= <span class='macro'>TLS1_FLAGS_RECEIVED_EXTMS<span class='macro_popup'>0x0200</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2616"><td class="num" id="LN2616">2616</td><td class="line">            <span class='keyword'>if</span> (!s-&gt;hit)</td></tr>
<tr class="codeline" data-linenumber="2617"><td class="num" id="LN2617">2617</td><td class="line">                s-&gt;session-&gt;flags |= <span class='macro'>SSL_SESS_FLAG_EXTMS<span class='macro_popup'>0x1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2618"><td class="num" id="LN2618">2618</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2619"><td class="num" id="LN2619">2619</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2620"><td class="num" id="LN2620">2620</td><td class="line">         <span class='comment'>* If this extension type was not otherwise handled, but matches a</span></td></tr>
<tr class="codeline" data-linenumber="2621"><td class="num" id="LN2621">2621</td><td class="line">         <span class='comment'>* custom_cli_ext_record, then send it to the c callback</span></td></tr>
<tr class="codeline" data-linenumber="2622"><td class="num" id="LN2622">2622</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2623"><td class="num" id="LN2623">2623</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (custom_ext_parse(s, 0, type, data, size, al) &lt;= 0)</td></tr>
<tr class="codeline" data-linenumber="2624"><td class="num" id="LN2624">2624</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2625"><td class="num" id="LN2625">2625</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2626"><td class="num" id="LN2626">2626</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2627"><td class="num" id="LN2627">2627</td><td class="line">    <span class='keyword'>if</span> (PACKET_remaining(pkt) != 0) {</td></tr>
<tr class="codeline" data-linenumber="2628"><td class="num" id="LN2628">2628</td><td class="line">        *al = <span class='macro'>SSL_AD_DECODE_ERROR<span class='macro_popup'>50</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2629"><td class="num" id="LN2629">2629</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2630"><td class="num" id="LN2630">2630</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2631"><td class="num" id="LN2631">2631</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2632"><td class="num" id="LN2632">2632</td><td class="line">    <span class='keyword'>if</span> (!s-&gt;hit &amp;&amp; tlsext_servername == 1) {</td></tr>
<tr class="codeline" data-linenumber="2633"><td class="num" id="LN2633">2633</td><td class="line">        <span class='keyword'>if</span> (s-&gt;tlsext_hostname) {</td></tr>
<tr class="codeline" data-linenumber="2634"><td class="num" id="LN2634">2634</td><td class="line">            <span class='keyword'>if</span> (s-&gt;session-&gt;tlsext_hostname == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2635"><td class="num" id="LN2635">2635</td><td class="line">                s-&gt;session-&gt;tlsext_hostname =</td></tr>
<tr class="codeline" data-linenumber="2636"><td class="num" id="LN2636">2636</td><td class="line">                    <span class='macro'>OPENSSL_strdup(s-&gt;tlsext_hostname)<span class='macro_popup'>CRYPTO_strdup(s-&gt;tlsext_hostname, "ssl/t1_lib.c", 2636)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2637"><td class="num" id="LN2637">2637</td><td class="line">                <span class='keyword'>if</span> (!s-&gt;session-&gt;tlsext_hostname) {</td></tr>
<tr class="codeline" data-linenumber="2638"><td class="num" id="LN2638">2638</td><td class="line">                    *al = <span class='macro'>SSL_AD_UNRECOGNIZED_NAME<span class='macro_popup'>112</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2639"><td class="num" id="LN2639">2639</td><td class="line">                    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2640"><td class="num" id="LN2640">2640</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2641"><td class="num" id="LN2641">2641</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2642"><td class="num" id="LN2642">2642</td><td class="line">                *al = <span class='macro'>SSL_AD_DECODE_ERROR<span class='macro_popup'>50</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2643"><td class="num" id="LN2643">2643</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2644"><td class="num" id="LN2644">2644</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2645"><td class="num" id="LN2645">2645</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2646"><td class="num" id="LN2646">2646</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2647"><td class="num" id="LN2647">2647</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2648"><td class="num" id="LN2648">2648</td><td class="line"> ri_check:</td></tr>
<tr class="codeline" data-linenumber="2649"><td class="num" id="LN2649">2649</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2650"><td class="num" id="LN2650">2650</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2651"><td class="num" id="LN2651">2651</td><td class="line">     <span class='comment'>* Determine if we need to see RI. Strictly speaking if we want to avoid</span></td></tr>
<tr class="codeline" data-linenumber="2652"><td class="num" id="LN2652">2652</td><td class="line">     <span class='comment'>* an attack we should *always* see RI even on initial server hello</span></td></tr>
<tr class="codeline" data-linenumber="2653"><td class="num" id="LN2653">2653</td><td class="line">     <span class='comment'>* because the client doesn't see any renegotiation during an attack.</span></td></tr>
<tr class="codeline" data-linenumber="2654"><td class="num" id="LN2654">2654</td><td class="line">     <span class='comment'>* However this would mean we could not connect to any server which</span></td></tr>
<tr class="codeline" data-linenumber="2655"><td class="num" id="LN2655">2655</td><td class="line">     <span class='comment'>* doesn't support RI so for the immediate future tolerate RI absence</span></td></tr>
<tr class="codeline" data-linenumber="2656"><td class="num" id="LN2656">2656</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2657"><td class="num" id="LN2657">2657</td><td class="line">    <span class='keyword'>if</span> (!renegotiate_seen &amp;&amp; !(s-&gt;options &amp; <span class='macro'>SSL_OP_LEGACY_SERVER_CONNECT<span class='macro_popup'>0x00000004U</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2658"><td class="num" id="LN2658">2658</td><td class="line">        &amp;&amp; !(s-&gt;options &amp; <span class='macro'>SSL_OP_ALLOW_UNSAFE_LEGACY_RENEGOTIATION<span class='macro_popup'>0x00040000U</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="2659"><td class="num" id="LN2659">2659</td><td class="line">        *al = <span class='macro'>SSL_AD_HANDSHAKE_FAILURE<span class='macro_popup'>40</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2660"><td class="num" id="LN2660">2660</td><td class="line">        <span class='macro'>SSLerr(SSL_F_SSL_SCAN_SERVERHELLO_TLSEXT,<span class='macro_popup'>ERR_put_error(20,(321),(338),"ssl/t1_lib.c",2661)</span></span></td></tr>
<tr class="codeline" data-linenumber="2661"><td class="num" id="LN2661">2661</td><td class="line">               <span class='macro'>SSL_R_UNSAFE_LEGACY_RENEGOTIATION_DISABLED)<span class='macro_popup'>ERR_put_error(20,(321),(338),"ssl/t1_lib.c",2661)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2662"><td class="num" id="LN2662">2662</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2663"><td class="num" id="LN2663">2663</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2664"><td class="num" id="LN2664">2664</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2665"><td class="num" id="LN2665">2665</td><td class="line">    <span class='keyword'>if</span> (s-&gt;hit) {</td></tr>
<tr class="codeline" data-linenumber="2666"><td class="num" id="LN2666">2666</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2667"><td class="num" id="LN2667">2667</td><td class="line">         <span class='comment'>* Check extended master secret extension is consistent with</span></td></tr>
<tr class="codeline" data-linenumber="2668"><td class="num" id="LN2668">2668</td><td class="line">         <span class='comment'>* original session.</span></td></tr>
<tr class="codeline" data-linenumber="2669"><td class="num" id="LN2669">2669</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2670"><td class="num" id="LN2670">2670</td><td class="line">        <span class='keyword'>if</span> (!(s-&gt;s3-&gt;flags &amp; <span class='macro'>TLS1_FLAGS_RECEIVED_EXTMS<span class='macro_popup'>0x0200</span></span>) !=</td></tr>
<tr class="codeline" data-linenumber="2671"><td class="num" id="LN2671">2671</td><td class="line">            !(s-&gt;session-&gt;flags &amp; <span class='macro'>SSL_SESS_FLAG_EXTMS<span class='macro_popup'>0x1</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="2672"><td class="num" id="LN2672">2672</td><td class="line">            *al = <span class='macro'>SSL_AD_HANDSHAKE_FAILURE<span class='macro_popup'>40</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2673"><td class="num" id="LN2673">2673</td><td class="line">            <span class='macro'>SSLerr(SSL_F_SSL_SCAN_SERVERHELLO_TLSEXT, SSL_R_INCONSISTENT_EXTMS)<span class='macro_popup'>ERR_put_error(20,(321),(104),"ssl/t1_lib.c",2673)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2674"><td class="num" id="LN2674">2674</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2675"><td class="num" id="LN2675">2675</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2676"><td class="num" id="LN2676">2676</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2677"><td class="num" id="LN2677">2677</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2678"><td class="num" id="LN2678">2678</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2679"><td class="num" id="LN2679">2679</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2680"><td class="num" id="LN2680">2680</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2681"><td class="num" id="LN2681">2681</td><td class="line"><span class='keyword'>int</span> ssl_prepare_clienthello_tlsext(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="2682"><td class="num" id="LN2682">2682</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2683"><td class="num" id="LN2683">2683</td><td class="line">    s-&gt;s3-&gt;alpn_sent = 0;</td></tr>
<tr class="codeline" data-linenumber="2684"><td class="num" id="LN2684">2684</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2685"><td class="num" id="LN2685">2685</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2686"><td class="num" id="LN2686">2686</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2687"><td class="num" id="LN2687">2687</td><td class="line"><span class='keyword'>int</span> ssl_prepare_serverhello_tlsext(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="2688"><td class="num" id="LN2688">2688</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2689"><td class="num" id="LN2689">2689</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2690"><td class="num" id="LN2690">2690</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2691"><td class="num" id="LN2691">2691</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2692"><td class="num" id="LN2692">2692</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> ssl_check_clienthello_tlsext_early(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="2693"><td class="num" id="LN2693">2693</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2694"><td class="num" id="LN2694">2694</td><td class="line">    <span class='keyword'>int</span> ret = <span class='macro'>SSL_TLSEXT_ERR_NOACK<span class='macro_popup'>3</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2695"><td class="num" id="LN2695">2695</td><td class="line">    <span class='keyword'>int</span> al = <span class='macro'>SSL_AD_UNRECOGNIZED_NAME<span class='macro_popup'>112</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2696"><td class="num" id="LN2696">2696</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2697"><td class="num" id="LN2697">2697</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="2698"><td class="num" id="LN2698">2698</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2699"><td class="num" id="LN2699">2699</td><td class="line">     <span class='comment'>* The handling of the ECPointFormats extension is done elsewhere, namely</span></td></tr>
<tr class="codeline" data-linenumber="2700"><td class="num" id="LN2700">2700</td><td class="line">     <span class='comment'>* in ssl3_choose_cipher in s3_lib.c.</span></td></tr>
<tr class="codeline" data-linenumber="2701"><td class="num" id="LN2701">2701</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2702"><td class="num" id="LN2702">2702</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2703"><td class="num" id="LN2703">2703</td><td class="line">     <span class='comment'>* The handling of the EllipticCurves extension is done elsewhere, namely</span></td></tr>
<tr class="codeline" data-linenumber="2704"><td class="num" id="LN2704">2704</td><td class="line">     <span class='comment'>* in ssl3_choose_cipher in s3_lib.c.</span></td></tr>
<tr class="codeline" data-linenumber="2705"><td class="num" id="LN2705">2705</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2706"><td class="num" id="LN2706">2706</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2707"><td class="num" id="LN2707">2707</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2708"><td class="num" id="LN2708">2708</td><td class="line">    <span class='keyword'>if</span> (s-&gt;ctx != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; s-&gt;ctx-&gt;tlsext_servername_callback != 0)</td></tr>
<tr class="codeline" data-linenumber="2709"><td class="num" id="LN2709">2709</td><td class="line">        ret =</td></tr>
<tr class="codeline" data-linenumber="2710"><td class="num" id="LN2710">2710</td><td class="line">            s-&gt;ctx-&gt;tlsext_servername_callback(s, &amp;al,</td></tr>
<tr class="codeline" data-linenumber="2711"><td class="num" id="LN2711">2711</td><td class="line">                                               s-&gt;ctx-&gt;tlsext_servername_arg);</td></tr>
<tr class="codeline" data-linenumber="2712"><td class="num" id="LN2712">2712</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (s-&gt;session_ctx != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="2713"><td class="num" id="LN2713">2713</td><td class="line">             &amp;&amp; s-&gt;session_ctx-&gt;tlsext_servername_callback != 0)</td></tr>
<tr class="codeline" data-linenumber="2714"><td class="num" id="LN2714">2714</td><td class="line">        ret =</td></tr>
<tr class="codeline" data-linenumber="2715"><td class="num" id="LN2715">2715</td><td class="line">            s-&gt;session_ctx-&gt;tlsext_servername_callback(s, &amp;al,</td></tr>
<tr class="codeline" data-linenumber="2716"><td class="num" id="LN2716">2716</td><td class="line">                                                       s-&gt;</td></tr>
<tr class="codeline" data-linenumber="2717"><td class="num" id="LN2717">2717</td><td class="line">                                                       session_ctx-&gt;tlsext_servername_arg);</td></tr>
<tr class="codeline" data-linenumber="2718"><td class="num" id="LN2718">2718</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2719"><td class="num" id="LN2719">2719</td><td class="line">    <span class='keyword'>switch</span> (ret) {</td></tr>
<tr class="codeline" data-linenumber="2720"><td class="num" id="LN2720">2720</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>SSL_TLSEXT_ERR_ALERT_FATAL<span class='macro_popup'>2</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2721"><td class="num" id="LN2721">2721</td><td class="line">        ssl3_send_alert(s, <span class='macro'>SSL3_AL_FATAL<span class='macro_popup'>2</span></span>, al);</td></tr>
<tr class="codeline" data-linenumber="2722"><td class="num" id="LN2722">2722</td><td class="line">        <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="2723"><td class="num" id="LN2723">2723</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2724"><td class="num" id="LN2724">2724</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>SSL_TLSEXT_ERR_ALERT_WARNING<span class='macro_popup'>1</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2725"><td class="num" id="LN2725">2725</td><td class="line">        ssl3_send_alert(s, <span class='macro'>SSL3_AL_WARNING<span class='macro_popup'>1</span></span>, al);</td></tr>
<tr class="codeline" data-linenumber="2726"><td class="num" id="LN2726">2726</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2727"><td class="num" id="LN2727">2727</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2728"><td class="num" id="LN2728">2728</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>SSL_TLSEXT_ERR_NOACK<span class='macro_popup'>3</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2729"><td class="num" id="LN2729">2729</td><td class="line">        s-&gt;servername_done = 0;</td></tr>
<tr class="codeline" data-linenumber="2730"><td class="num" id="LN2730">2730</td><td class="line">        <span class='comment'>/* fall thru */</span></td></tr>
<tr class="codeline" data-linenumber="2731"><td class="num" id="LN2731">2731</td><td class="line">    <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="2732"><td class="num" id="LN2732">2732</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2733"><td class="num" id="LN2733">2733</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2734"><td class="num" id="LN2734">2734</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2735"><td class="num" id="LN2735">2735</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2736"><td class="num" id="LN2736">2736</td><td class="line"><span class='comment'>/* Initialise digests to default values */</span></td></tr>
<tr class="codeline" data-linenumber="2737"><td class="num" id="LN2737">2737</td><td class="line"><span class='keyword'>void</span> ssl_set_default_md(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="2738"><td class="num" id="LN2738">2738</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2739"><td class="num" id="LN2739">2739</td><td class="line">    <span class='keyword'>const</span> EVP_MD **pmd = s-&gt;s3-&gt;tmp.md;</td></tr>
<tr class="codeline" data-linenumber="2740"><td class="num" id="LN2740">2740</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_DSA</span></td></tr>
<tr class="codeline" data-linenumber="2741"><td class="num" id="LN2741">2741</td><td class="line">    pmd[<span class='macro'>SSL_PKEY_DSA_SIGN<span class='macro_popup'>2</span></span>] = ssl_md(<span class='macro'>SSL_MD_SHA1_IDX<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2742"><td class="num" id="LN2742">2742</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2743"><td class="num" id="LN2743">2743</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_RSA</span></td></tr>
<tr class="codeline" data-linenumber="2744"><td class="num" id="LN2744">2744</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>SSL_USE_SIGALGS(s)<span class='macro_popup'>(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x2)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2745"><td class="num" id="LN2745">2745</td><td class="line">        pmd[<span class='macro'>SSL_PKEY_RSA_SIGN<span class='macro_popup'>1</span></span>] = ssl_md(<span class='macro'>SSL_MD_SHA1_IDX<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2746"><td class="num" id="LN2746">2746</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2747"><td class="num" id="LN2747">2747</td><td class="line">        pmd[<span class='macro'>SSL_PKEY_RSA_SIGN<span class='macro_popup'>1</span></span>] = ssl_md(<span class='macro'>SSL_MD_MD5_SHA1_IDX<span class='macro_popup'>9</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2748"><td class="num" id="LN2748">2748</td><td class="line">    pmd[<span class='macro'>SSL_PKEY_RSA_ENC<span class='macro_popup'>0</span></span>] = pmd[<span class='macro'>SSL_PKEY_RSA_SIGN<span class='macro_popup'>1</span></span>];</td></tr>
<tr class="codeline" data-linenumber="2749"><td class="num" id="LN2749">2749</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2750"><td class="num" id="LN2750">2750</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="2751"><td class="num" id="LN2751">2751</td><td class="line">    pmd[<span class='macro'>SSL_PKEY_ECC<span class='macro_popup'>3</span></span>] = ssl_md(<span class='macro'>SSL_MD_SHA1_IDX<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2752"><td class="num" id="LN2752">2752</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2753"><td class="num" id="LN2753">2753</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_GOST</span></td></tr>
<tr class="codeline" data-linenumber="2754"><td class="num" id="LN2754">2754</td><td class="line">    pmd[<span class='macro'>SSL_PKEY_GOST01<span class='macro_popup'>4</span></span>] = ssl_md(<span class='macro'>SSL_MD_GOST94_IDX<span class='macro_popup'>2</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2755"><td class="num" id="LN2755">2755</td><td class="line">    pmd[<span class='macro'>SSL_PKEY_GOST12_256<span class='macro_popup'>5</span></span>] = ssl_md(<span class='macro'>SSL_MD_GOST12_256_IDX<span class='macro_popup'>6</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2756"><td class="num" id="LN2756">2756</td><td class="line">    pmd[<span class='macro'>SSL_PKEY_GOST12_512<span class='macro_popup'>6</span></span>] = ssl_md(<span class='macro'>SSL_MD_GOST12_512_IDX<span class='macro_popup'>8</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2757"><td class="num" id="LN2757">2757</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2758"><td class="num" id="LN2758">2758</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2759"><td class="num" id="LN2759">2759</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2760"><td class="num" id="LN2760">2760</td><td class="line"><span class='keyword'>int</span> tls1_set_server_sigalgs(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="2761"><td class="num" id="LN2761">2761</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2762"><td class="num" id="LN2762">2762</td><td class="line">    <span class='keyword'>int</span> al;</td></tr>
<tr class="codeline" data-linenumber="2763"><td class="num" id="LN2763">2763</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="2764"><td class="num" id="LN2764">2764</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2765"><td class="num" id="LN2765">2765</td><td class="line">    <span class='comment'>/* Clear any shared signature algorithms */</span></td></tr>
<tr class="codeline" data-linenumber="2766"><td class="num" id="LN2766">2766</td><td class="line">    <span class='macro'>OPENSSL_free(s-&gt;cert-&gt;shared_sigalgs)<span class='macro_popup'>CRYPTO_free(s-&gt;cert-&gt;shared_sigalgs, "ssl/t1_lib.c", 2766<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2767"><td class="num" id="LN2767">2767</td><td class="line">    s-&gt;cert-&gt;shared_sigalgs = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2768"><td class="num" id="LN2768">2768</td><td class="line">    s-&gt;cert-&gt;shared_sigalgslen = 0;</td></tr>
<tr class="codeline" data-linenumber="2769"><td class="num" id="LN2769">2769</td><td class="line">    <span class='comment'>/* Clear certificate digests and validity flags */</span></td></tr>
<tr class="codeline" data-linenumber="2770"><td class="num" id="LN2770">2770</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; <span class='macro'>SSL_PKEY_NUM<span class='macro_popup'>7</span></span>; i++) {</td></tr>
<tr class="codeline" data-linenumber="2771"><td class="num" id="LN2771">2771</td><td class="line">        s-&gt;s3-&gt;tmp.md[i] = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2772"><td class="num" id="LN2772">2772</td><td class="line">        s-&gt;s3-&gt;tmp.valid_flags[i] = 0;</td></tr>
<tr class="codeline" data-linenumber="2773"><td class="num" id="LN2773">2773</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2774"><td class="num" id="LN2774">2774</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2775"><td class="num" id="LN2775">2775</td><td class="line">    <span class='comment'>/* If sigalgs received process it. */</span></td></tr>
<tr class="codeline" data-linenumber="2776"><td class="num" id="LN2776">2776</td><td class="line">    <span class='keyword'>if</span> (s-&gt;s3-&gt;tmp.peer_sigalgs) {</td></tr>
<tr class="codeline" data-linenumber="2777"><td class="num" id="LN2777">2777</td><td class="line">        <span class='keyword'>if</span> (!tls1_process_sigalgs(s)) {</td></tr>
<tr class="codeline" data-linenumber="2778"><td class="num" id="LN2778">2778</td><td class="line">            <span class='macro'>SSLerr(SSL_F_TLS1_SET_SERVER_SIGALGS, ERR_R_MALLOC_FAILURE)<span class='macro_popup'>ERR_put_error(20,(335),((1|64)),"ssl/t1_lib.c",2778)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2779"><td class="num" id="LN2779">2779</td><td class="line">            al = <span class='macro'>SSL_AD_INTERNAL_ERROR<span class='macro_popup'>80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2780"><td class="num" id="LN2780">2780</td><td class="line">            <span class='keyword'>goto</span> err;</td></tr>
<tr class="codeline" data-linenumber="2781"><td class="num" id="LN2781">2781</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2782"><td class="num" id="LN2782">2782</td><td class="line">        <span class='comment'>/* Fatal error is no shared signature algorithms */</span></td></tr>
<tr class="codeline" data-linenumber="2783"><td class="num" id="LN2783">2783</td><td class="line">        <span class='keyword'>if</span> (!s-&gt;cert-&gt;shared_sigalgs) {</td></tr>
<tr class="codeline" data-linenumber="2784"><td class="num" id="LN2784">2784</td><td class="line">            <span class='macro'>SSLerr(SSL_F_TLS1_SET_SERVER_SIGALGS,<span class='macro_popup'>ERR_put_error(20,(335),(376),"ssl/t1_lib.c",2785)</span></span></td></tr>
<tr class="codeline" data-linenumber="2785"><td class="num" id="LN2785">2785</td><td class="line">                   <span class='macro'>SSL_R_NO_SHARED_SIGNATURE_ALGORITHMS)<span class='macro_popup'>ERR_put_error(20,(335),(376),"ssl/t1_lib.c",2785)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2786"><td class="num" id="LN2786">2786</td><td class="line">            al = <span class='macro'>SSL_AD_ILLEGAL_PARAMETER<span class='macro_popup'>47</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2787"><td class="num" id="LN2787">2787</td><td class="line">            <span class='keyword'>goto</span> err;</td></tr>
<tr class="codeline" data-linenumber="2788"><td class="num" id="LN2788">2788</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2789"><td class="num" id="LN2789">2789</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2790"><td class="num" id="LN2790">2790</td><td class="line">        ssl_set_default_md(s);</td></tr>
<tr class="codeline" data-linenumber="2791"><td class="num" id="LN2791">2791</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2792"><td class="num" id="LN2792">2792</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2793"><td class="num" id="LN2793">2793</td><td class="line"> err:</td></tr>
<tr class="codeline" data-linenumber="2794"><td class="num" id="LN2794">2794</td><td class="line">    ssl3_send_alert(s, <span class='macro'>SSL3_AL_FATAL<span class='macro_popup'>2</span></span>, al);</td></tr>
<tr class="codeline" data-linenumber="2795"><td class="num" id="LN2795">2795</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2796"><td class="num" id="LN2796">2796</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2797"><td class="num" id="LN2797">2797</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2798"><td class="num" id="LN2798">2798</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2799"><td class="num" id="LN2799">2799</td><td class="line"> <span class='comment'>* Upon success, returns 1.</span></td></tr>
<tr class="codeline" data-linenumber="2800"><td class="num" id="LN2800">2800</td><td class="line"> <span class='comment'>* Upon failure, returns 0 and sets |al| to the appropriate fatal alert.</span></td></tr>
<tr class="codeline" data-linenumber="2801"><td class="num" id="LN2801">2801</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2802"><td class="num" id="LN2802">2802</td><td class="line"><span class='keyword'>int</span> ssl_check_clienthello_tlsext_late(SSL *s, <span class='keyword'>int</span> *al)</td></tr>
<tr class="codeline" data-linenumber="2803"><td class="num" id="LN2803">2803</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2804"><td class="num" id="LN2804">2804</td><td class="line">    s-&gt;tlsext_status_expected = 0;</td></tr>
<tr class="codeline" data-linenumber="2805"><td class="num" id="LN2805">2805</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2806"><td class="num" id="LN2806">2806</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2807"><td class="num" id="LN2807">2807</td><td class="line">     <span class='comment'>* If status request then ask callback what to do. Note: this must be</span></td></tr>
<tr class="codeline" data-linenumber="2808"><td class="num" id="LN2808">2808</td><td class="line">     <span class='comment'>* called after servername callbacks in case the certificate has changed,</span></td></tr>
<tr class="codeline" data-linenumber="2809"><td class="num" id="LN2809">2809</td><td class="line">     <span class='comment'>* and must be called after the cipher has been chosen because this may</span></td></tr>
<tr class="codeline" data-linenumber="2810"><td class="num" id="LN2810">2810</td><td class="line">     <span class='comment'>* influence which certificate is sent</span></td></tr>
<tr class="codeline" data-linenumber="2811"><td class="num" id="LN2811">2811</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2812"><td class="num" id="LN2812">2812</td><td class="line">    <span class='keyword'>if</span> ((s-&gt;tlsext_status_type != -1) &amp;&amp; s-&gt;ctx &amp;&amp; s-&gt;ctx-&gt;tlsext_status_cb) {</td></tr>
<tr class="codeline" data-linenumber="2813"><td class="num" id="LN2813">2813</td><td class="line">        <span class='keyword'>int</span> ret;</td></tr>
<tr class="codeline" data-linenumber="2814"><td class="num" id="LN2814">2814</td><td class="line">        CERT_PKEY *certpkey;</td></tr>
<tr class="codeline" data-linenumber="2815"><td class="num" id="LN2815">2815</td><td class="line">        certpkey = ssl_get_server_send_pkey(s);</td></tr>
<tr class="codeline" data-linenumber="2816"><td class="num" id="LN2816">2816</td><td class="line">        <span class='comment'>/* If no certificate can't return certificate status */</span></td></tr>
<tr class="codeline" data-linenumber="2817"><td class="num" id="LN2817">2817</td><td class="line">        <span class='keyword'>if</span> (certpkey != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2818"><td class="num" id="LN2818">2818</td><td class="line">            <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2819"><td class="num" id="LN2819">2819</td><td class="line">             <span class='comment'>* Set current certificate to one we will use so SSL_get_certificate</span></td></tr>
<tr class="codeline" data-linenumber="2820"><td class="num" id="LN2820">2820</td><td class="line">             <span class='comment'>* et al can pick it up.</span></td></tr>
<tr class="codeline" data-linenumber="2821"><td class="num" id="LN2821">2821</td><td class="line">             <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2822"><td class="num" id="LN2822">2822</td><td class="line">            s-&gt;cert-&gt;key = certpkey;</td></tr>
<tr class="codeline" data-linenumber="2823"><td class="num" id="LN2823">2823</td><td class="line">            ret = s-&gt;ctx-&gt;tlsext_status_cb(s, s-&gt;ctx-&gt;tlsext_status_arg);</td></tr>
<tr class="codeline" data-linenumber="2824"><td class="num" id="LN2824">2824</td><td class="line">            <span class='keyword'>switch</span> (ret) {</td></tr>
<tr class="codeline" data-linenumber="2825"><td class="num" id="LN2825">2825</td><td class="line">                <span class='comment'>/* We don't want to send a status request response */</span></td></tr>
<tr class="codeline" data-linenumber="2826"><td class="num" id="LN2826">2826</td><td class="line">            <span class='keyword'>case</span> <span class='macro'>SSL_TLSEXT_ERR_NOACK<span class='macro_popup'>3</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2827"><td class="num" id="LN2827">2827</td><td class="line">                s-&gt;tlsext_status_expected = 0;</td></tr>
<tr class="codeline" data-linenumber="2828"><td class="num" id="LN2828">2828</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2829"><td class="num" id="LN2829">2829</td><td class="line">                <span class='comment'>/* status request response should be sent */</span></td></tr>
<tr class="codeline" data-linenumber="2830"><td class="num" id="LN2830">2830</td><td class="line">            <span class='keyword'>case</span> <span class='macro'>SSL_TLSEXT_ERR_OK<span class='macro_popup'>0</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2831"><td class="num" id="LN2831">2831</td><td class="line">                <span class='keyword'>if</span> (s-&gt;tlsext_ocsp_resp)</td></tr>
<tr class="codeline" data-linenumber="2832"><td class="num" id="LN2832">2832</td><td class="line">                    s-&gt;tlsext_status_expected = 1;</td></tr>
<tr class="codeline" data-linenumber="2833"><td class="num" id="LN2833">2833</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2834"><td class="num" id="LN2834">2834</td><td class="line">                <span class='comment'>/* something bad happened */</span></td></tr>
<tr class="codeline" data-linenumber="2835"><td class="num" id="LN2835">2835</td><td class="line">            <span class='keyword'>case</span> <span class='macro'>SSL_TLSEXT_ERR_ALERT_FATAL<span class='macro_popup'>2</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2836"><td class="num" id="LN2836">2836</td><td class="line">            <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="2837"><td class="num" id="LN2837">2837</td><td class="line">                *al = <span class='macro'>SSL_AD_INTERNAL_ERROR<span class='macro_popup'>80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2838"><td class="num" id="LN2838">2838</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2839"><td class="num" id="LN2839">2839</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2840"><td class="num" id="LN2840">2840</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2841"><td class="num" id="LN2841">2841</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2842"><td class="num" id="LN2842">2842</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2843"><td class="num" id="LN2843">2843</td><td class="line">    <span class='keyword'>if</span> (!tls1_alpn_handle_client_hello_late(s, al)) {</td></tr>
<tr class="codeline" data-linenumber="2844"><td class="num" id="LN2844">2844</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2845"><td class="num" id="LN2845">2845</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2846"><td class="num" id="LN2846">2846</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2847"><td class="num" id="LN2847">2847</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2848"><td class="num" id="LN2848">2848</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2849"><td class="num" id="LN2849">2849</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2850"><td class="num" id="LN2850">2850</td><td class="line"><span class='keyword'>int</span> ssl_check_serverhello_tlsext(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="2851"><td class="num" id="LN2851">2851</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2852"><td class="num" id="LN2852">2852</td><td class="line">    <span class='keyword'>int</span> ret = <span class='macro'>SSL_TLSEXT_ERR_NOACK<span class='macro_popup'>3</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2853"><td class="num" id="LN2853">2853</td><td class="line">    <span class='keyword'>int</span> al = <span class='macro'>SSL_AD_UNRECOGNIZED_NAME<span class='macro_popup'>112</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2854"><td class="num" id="LN2854">2854</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2855"><td class="num" id="LN2855">2855</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="2856"><td class="num" id="LN2856">2856</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2857"><td class="num" id="LN2857">2857</td><td class="line">     <span class='comment'>* If we are client and using an elliptic curve cryptography cipher</span></td></tr>
<tr class="codeline" data-linenumber="2858"><td class="num" id="LN2858">2858</td><td class="line">     <span class='comment'>* suite, then if server returns an EC point formats lists extension it</span></td></tr>
<tr class="codeline" data-linenumber="2859"><td class="num" id="LN2859">2859</td><td class="line">     <span class='comment'>* must contain uncompressed.</span></td></tr>
<tr class="codeline" data-linenumber="2860"><td class="num" id="LN2860">2860</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2861"><td class="num" id="LN2861">2861</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> alg_k = s-&gt;s3-&gt;tmp.new_cipher-&gt;algorithm_mkey;</td></tr>
<tr class="codeline" data-linenumber="2862"><td class="num" id="LN2862">2862</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> alg_a = s-&gt;s3-&gt;tmp.new_cipher-&gt;algorithm_auth;</td></tr>
<tr class="codeline" data-linenumber="2863"><td class="num" id="LN2863">2863</td><td class="line">    <span class='keyword'>if</span> ((s-&gt;tlsext_ecpointformatlist != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2864"><td class="num" id="LN2864">2864</td><td class="line">        &amp;&amp; (s-&gt;tlsext_ecpointformatlist_length &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="2865"><td class="num" id="LN2865">2865</td><td class="line">        &amp;&amp; (s-&gt;session-&gt;tlsext_ecpointformatlist != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2866"><td class="num" id="LN2866">2866</td><td class="line">        &amp;&amp; (s-&gt;session-&gt;tlsext_ecpointformatlist_length &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="2867"><td class="num" id="LN2867">2867</td><td class="line">        &amp;&amp; ((alg_k &amp; <span class='macro'>SSL_kECDHE<span class='macro_popup'>0x00000004U</span></span>) || (alg_a &amp; <span class='macro'>SSL_aECDSA<span class='macro_popup'>0x00000008U</span></span>))) {</td></tr>
<tr class="codeline" data-linenumber="2868"><td class="num" id="LN2868">2868</td><td class="line">        <span class='comment'>/* we are using an ECC cipher */</span></td></tr>
<tr class="codeline" data-linenumber="2869"><td class="num" id="LN2869">2869</td><td class="line">        size_t i;</td></tr>
<tr class="codeline" data-linenumber="2870"><td class="num" id="LN2870">2870</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *list;</td></tr>
<tr class="codeline" data-linenumber="2871"><td class="num" id="LN2871">2871</td><td class="line">        <span class='keyword'>int</span> found_uncompressed = 0;</td></tr>
<tr class="codeline" data-linenumber="2872"><td class="num" id="LN2872">2872</td><td class="line">        list = s-&gt;session-&gt;tlsext_ecpointformatlist;</td></tr>
<tr class="codeline" data-linenumber="2873"><td class="num" id="LN2873">2873</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; s-&gt;session-&gt;tlsext_ecpointformatlist_length; i++) {</td></tr>
<tr class="codeline" data-linenumber="2874"><td class="num" id="LN2874">2874</td><td class="line">            <span class='keyword'>if</span> (*(list++) == <span class='macro'>TLSEXT_ECPOINTFORMAT_uncompressed<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2875"><td class="num" id="LN2875">2875</td><td class="line">                found_uncompressed = 1;</td></tr>
<tr class="codeline" data-linenumber="2876"><td class="num" id="LN2876">2876</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2877"><td class="num" id="LN2877">2877</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2878"><td class="num" id="LN2878">2878</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2879"><td class="num" id="LN2879">2879</td><td class="line">        <span class='keyword'>if</span> (!found_uncompressed) {</td></tr>
<tr class="codeline" data-linenumber="2880"><td class="num" id="LN2880">2880</td><td class="line">            <span class='macro'>SSLerr(SSL_F_SSL_CHECK_SERVERHELLO_TLSEXT,<span class='macro_popup'>ERR_put_error(20,(280),(157),"ssl/t1_lib.c",2881)</span></span></td></tr>
<tr class="codeline" data-linenumber="2881"><td class="num" id="LN2881">2881</td><td class="line">                   <span class='macro'>SSL_R_TLS_INVALID_ECPOINTFORMAT_LIST)<span class='macro_popup'>ERR_put_error(20,(280),(157),"ssl/t1_lib.c",2881)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2882"><td class="num" id="LN2882">2882</td><td class="line">            <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="2883"><td class="num" id="LN2883">2883</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2884"><td class="num" id="LN2884">2884</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2885"><td class="num" id="LN2885">2885</td><td class="line">    ret = <span class='macro'>SSL_TLSEXT_ERR_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2886"><td class="num" id="LN2886">2886</td><td class="line"><span class='directive'>#endif                          /* OPENSSL_NO_EC */</span></td></tr>
<tr class="codeline" data-linenumber="2887"><td class="num" id="LN2887">2887</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2888"><td class="num" id="LN2888">2888</td><td class="line">    <span class='keyword'>if</span> (s-&gt;ctx != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; s-&gt;ctx-&gt;tlsext_servername_callback != 0)</td></tr>
<tr class="codeline" data-linenumber="2889"><td class="num" id="LN2889">2889</td><td class="line">        ret =</td></tr>
<tr class="codeline" data-linenumber="2890"><td class="num" id="LN2890">2890</td><td class="line">            s-&gt;ctx-&gt;tlsext_servername_callback(s, &amp;al,</td></tr>
<tr class="codeline" data-linenumber="2891"><td class="num" id="LN2891">2891</td><td class="line">                                               s-&gt;ctx-&gt;tlsext_servername_arg);</td></tr>
<tr class="codeline" data-linenumber="2892"><td class="num" id="LN2892">2892</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (s-&gt;session_ctx != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="2893"><td class="num" id="LN2893">2893</td><td class="line">             &amp;&amp; s-&gt;session_ctx-&gt;tlsext_servername_callback != 0)</td></tr>
<tr class="codeline" data-linenumber="2894"><td class="num" id="LN2894">2894</td><td class="line">        ret =</td></tr>
<tr class="codeline" data-linenumber="2895"><td class="num" id="LN2895">2895</td><td class="line">            s-&gt;session_ctx-&gt;tlsext_servername_callback(s, &amp;al,</td></tr>
<tr class="codeline" data-linenumber="2896"><td class="num" id="LN2896">2896</td><td class="line">                                                       s-&gt;</td></tr>
<tr class="codeline" data-linenumber="2897"><td class="num" id="LN2897">2897</td><td class="line">                                                       session_ctx-&gt;tlsext_servername_arg);</td></tr>
<tr class="codeline" data-linenumber="2898"><td class="num" id="LN2898">2898</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2899"><td class="num" id="LN2899">2899</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2900"><td class="num" id="LN2900">2900</td><td class="line">     <span class='comment'>* Ensure we get sensible values passed to tlsext_status_cb in the event</span></td></tr>
<tr class="codeline" data-linenumber="2901"><td class="num" id="LN2901">2901</td><td class="line">     <span class='comment'>* that we don't receive a status message</span></td></tr>
<tr class="codeline" data-linenumber="2902"><td class="num" id="LN2902">2902</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2903"><td class="num" id="LN2903">2903</td><td class="line">    <span class='macro'>OPENSSL_free(s-&gt;tlsext_ocsp_resp)<span class='macro_popup'>CRYPTO_free(s-&gt;tlsext_ocsp_resp, "ssl/t1_lib.c", 2903)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2904"><td class="num" id="LN2904">2904</td><td class="line">    s-&gt;tlsext_ocsp_resp = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2905"><td class="num" id="LN2905">2905</td><td class="line">    s-&gt;tlsext_ocsp_resplen = -1;</td></tr>
<tr class="codeline" data-linenumber="2906"><td class="num" id="LN2906">2906</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2907"><td class="num" id="LN2907">2907</td><td class="line">    <span class='keyword'>switch</span> (ret) {</td></tr>
<tr class="codeline" data-linenumber="2908"><td class="num" id="LN2908">2908</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>SSL_TLSEXT_ERR_ALERT_FATAL<span class='macro_popup'>2</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2909"><td class="num" id="LN2909">2909</td><td class="line">        ssl3_send_alert(s, <span class='macro'>SSL3_AL_FATAL<span class='macro_popup'>2</span></span>, al);</td></tr>
<tr class="codeline" data-linenumber="2910"><td class="num" id="LN2910">2910</td><td class="line">        <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="2911"><td class="num" id="LN2911">2911</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2912"><td class="num" id="LN2912">2912</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>SSL_TLSEXT_ERR_ALERT_WARNING<span class='macro_popup'>1</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2913"><td class="num" id="LN2913">2913</td><td class="line">        ssl3_send_alert(s, <span class='macro'>SSL3_AL_WARNING<span class='macro_popup'>1</span></span>, al);</td></tr>
<tr class="codeline" data-linenumber="2914"><td class="num" id="LN2914">2914</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2915"><td class="num" id="LN2915">2915</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2916"><td class="num" id="LN2916">2916</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>SSL_TLSEXT_ERR_NOACK<span class='macro_popup'>3</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2917"><td class="num" id="LN2917">2917</td><td class="line">        s-&gt;servername_done = 0;</td></tr>
<tr class="codeline" data-linenumber="2918"><td class="num" id="LN2918">2918</td><td class="line">        <span class='comment'>/* fall thru */</span></td></tr>
<tr class="codeline" data-linenumber="2919"><td class="num" id="LN2919">2919</td><td class="line">    <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="2920"><td class="num" id="LN2920">2920</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2921"><td class="num" id="LN2921">2921</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2922"><td class="num" id="LN2922">2922</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2923"><td class="num" id="LN2923">2923</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2924"><td class="num" id="LN2924">2924</td><td class="line"><span class='keyword'>int</span> ssl_parse_serverhello_tlsext(SSL *s, PACKET *pkt)</td></tr>
<tr class="codeline" data-linenumber="2925"><td class="num" id="LN2925">2925</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2926"><td class="num" id="LN2926">2926</td><td class="line">    <span class='keyword'>int</span> al = -1;</td></tr>
<tr class="codeline" data-linenumber="2927"><td class="num" id="LN2927">2927</td><td class="line">    <span class='keyword'>if</span> (s-&gt;version &lt; <span class='macro'>SSL3_VERSION<span class='macro_popup'>0x0300</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2928"><td class="num" id="LN2928">2928</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2929"><td class="num" id="LN2929">2929</td><td class="line">    <span class='keyword'>if</span> (ssl_scan_serverhello_tlsext(s, pkt, &amp;al) &lt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="2930"><td class="num" id="LN2930">2930</td><td class="line">        ssl3_send_alert(s, <span class='macro'>SSL3_AL_FATAL<span class='macro_popup'>2</span></span>, al);</td></tr>
<tr class="codeline" data-linenumber="2931"><td class="num" id="LN2931">2931</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2932"><td class="num" id="LN2932">2932</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2933"><td class="num" id="LN2933">2933</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2934"><td class="num" id="LN2934">2934</td><td class="line">    <span class='keyword'>if</span> (ssl_check_serverhello_tlsext(s) &lt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="2935"><td class="num" id="LN2935">2935</td><td class="line">        <span class='macro'>SSLerr(SSL_F_SSL_PARSE_SERVERHELLO_TLSEXT, SSL_R_SERVERHELLO_TLSEXT)<span class='macro_popup'>ERR_put_error(20,(303),(275),"ssl/t1_lib.c",2935)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2936"><td class="num" id="LN2936">2936</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2937"><td class="num" id="LN2937">2937</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2938"><td class="num" id="LN2938">2938</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2939"><td class="num" id="LN2939">2939</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2940"><td class="num" id="LN2940">2940</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2941"><td class="num" id="LN2941">2941</td><td class="line"><span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="2942"><td class="num" id="LN2942">2942</td><td class="line"> <span class='comment'>* Since the server cache lookup is done early on in the processing of the</span></td></tr>
<tr class="codeline" data-linenumber="2943"><td class="num" id="LN2943">2943</td><td class="line"> <span class='comment'>* ClientHello and other operations depend on the result some extensions</span></td></tr>
<tr class="codeline" data-linenumber="2944"><td class="num" id="LN2944">2944</td><td class="line"> <span class='comment'>* need to be handled at the same time.</span></td></tr>
<tr class="codeline" data-linenumber="2945"><td class="num" id="LN2945">2945</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2946"><td class="num" id="LN2946">2946</td><td class="line"> <span class='comment'>* Two extensions are currently handled, session ticket and extended master</span></td></tr>
<tr class="codeline" data-linenumber="2947"><td class="num" id="LN2947">2947</td><td class="line"> <span class='comment'>* secret.</span></td></tr>
<tr class="codeline" data-linenumber="2948"><td class="num" id="LN2948">2948</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2949"><td class="num" id="LN2949">2949</td><td class="line"> <span class='comment'>*   session_id: ClientHello session ID.</span></td></tr>
<tr class="codeline" data-linenumber="2950"><td class="num" id="LN2950">2950</td><td class="line"> <span class='comment'>*   ext: ClientHello extensions (including length prefix)</span></td></tr>
<tr class="codeline" data-linenumber="2951"><td class="num" id="LN2951">2951</td><td class="line"> <span class='comment'>*   ret: (output) on return, if a ticket was decrypted, then this is set to</span></td></tr>
<tr class="codeline" data-linenumber="2952"><td class="num" id="LN2952">2952</td><td class="line"> <span class='comment'>*       point to the resulting session.</span></td></tr>
<tr class="codeline" data-linenumber="2953"><td class="num" id="LN2953">2953</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2954"><td class="num" id="LN2954">2954</td><td class="line"> <span class='comment'>* If s-&gt;tls_session_secret_cb is set then we are expecting a pre-shared key</span></td></tr>
<tr class="codeline" data-linenumber="2955"><td class="num" id="LN2955">2955</td><td class="line"> <span class='comment'>* ciphersuite, in which case we have no use for session tickets and one will</span></td></tr>
<tr class="codeline" data-linenumber="2956"><td class="num" id="LN2956">2956</td><td class="line"> <span class='comment'>* never be decrypted, nor will s-&gt;tlsext_ticket_expected be set to 1.</span></td></tr>
<tr class="codeline" data-linenumber="2957"><td class="num" id="LN2957">2957</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2958"><td class="num" id="LN2958">2958</td><td class="line"> <span class='comment'>* Returns:</span></td></tr>
<tr class="codeline" data-linenumber="2959"><td class="num" id="LN2959">2959</td><td class="line"> <span class='comment'>*   -1: fatal error, either from parsing or decrypting the ticket.</span></td></tr>
<tr class="codeline" data-linenumber="2960"><td class="num" id="LN2960">2960</td><td class="line"> <span class='comment'>*    0: no ticket was found (or was ignored, based on settings).</span></td></tr>
<tr class="codeline" data-linenumber="2961"><td class="num" id="LN2961">2961</td><td class="line"> <span class='comment'>*    1: a zero length extension was found, indicating that the client supports</span></td></tr>
<tr class="codeline" data-linenumber="2962"><td class="num" id="LN2962">2962</td><td class="line"> <span class='comment'>*       session tickets but doesn't currently have one to offer.</span></td></tr>
<tr class="codeline" data-linenumber="2963"><td class="num" id="LN2963">2963</td><td class="line"> <span class='comment'>*    2: either s-&gt;tls_session_secret_cb was set, or a ticket was offered but</span></td></tr>
<tr class="codeline" data-linenumber="2964"><td class="num" id="LN2964">2964</td><td class="line"> <span class='comment'>*       couldn't be decrypted because of a non-fatal error.</span></td></tr>
<tr class="codeline" data-linenumber="2965"><td class="num" id="LN2965">2965</td><td class="line"> <span class='comment'>*    3: a ticket was successfully decrypted and *ret was set.</span></td></tr>
<tr class="codeline" data-linenumber="2966"><td class="num" id="LN2966">2966</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2967"><td class="num" id="LN2967">2967</td><td class="line"> <span class='comment'>* Side effects:</span></td></tr>
<tr class="codeline" data-linenumber="2968"><td class="num" id="LN2968">2968</td><td class="line"> <span class='comment'>*   Sets s-&gt;tlsext_ticket_expected to 1 if the server will have to issue</span></td></tr>
<tr class="codeline" data-linenumber="2969"><td class="num" id="LN2969">2969</td><td class="line"> <span class='comment'>*   a new session ticket to the client because the client indicated support</span></td></tr>
<tr class="codeline" data-linenumber="2970"><td class="num" id="LN2970">2970</td><td class="line"> <span class='comment'>*   (and s-&gt;tls_session_secret_cb is NULL) but the client either doesn't have</span></td></tr>
<tr class="codeline" data-linenumber="2971"><td class="num" id="LN2971">2971</td><td class="line"> <span class='comment'>*   a session ticket or we couldn't use the one it gave us, or if</span></td></tr>
<tr class="codeline" data-linenumber="2972"><td class="num" id="LN2972">2972</td><td class="line"> <span class='comment'>*   s-&gt;ctx-&gt;tlsext_ticket_key_cb asked to renew the client's ticket.</span></td></tr>
<tr class="codeline" data-linenumber="2973"><td class="num" id="LN2973">2973</td><td class="line"> <span class='comment'>*   Otherwise, s-&gt;tlsext_ticket_expected is set to 0.</span></td></tr>
<tr class="codeline" data-linenumber="2974"><td class="num" id="LN2974">2974</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2975"><td class="num" id="LN2975">2975</td><td class="line"> <span class='comment'>*   For extended master secret flag is set if the extension is present.</span></td></tr>
<tr class="codeline" data-linenumber="2976"><td class="num" id="LN2976">2976</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2977"><td class="num" id="LN2977">2977</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2978"><td class="num" id="LN2978">2978</td><td class="line"><span class='keyword'>int</span> tls_check_serverhello_tlsext_early(SSL *s, <span class='keyword'>const</span> PACKET *ext,</td></tr>
<tr class="codeline" data-linenumber="2979"><td class="num" id="LN2979">2979</td><td class="line">                                       <span class='keyword'>const</span> PACKET *session_id,</td></tr>
<tr class="codeline" data-linenumber="2980"><td class="num" id="LN2980">2980</td><td class="line">                                       SSL_SESSION **ret)</td></tr>
<tr class="codeline" data-linenumber="2981"><td class="num" id="LN2981">2981</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2982"><td class="num" id="LN2982">2982</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="2983"><td class="num" id="LN2983">2983</td><td class="line">    PACKET local_ext = *ext;</td></tr>
<tr class="codeline" data-linenumber="2984"><td class="num" id="LN2984">2984</td><td class="line">    <span class='keyword'>int</span> retv = -1;</td></tr>
<tr class="codeline" data-linenumber="2985"><td class="num" id="LN2985">2985</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2986"><td class="num" id="LN2986">2986</td><td class="line">    <span class='keyword'>int</span> have_ticket = 0;</td></tr>
<tr class="codeline" data-linenumber="2987"><td class="num" id="LN2987">2987</td><td class="line">    <span class='keyword'>int</span> use_ticket = tls_use_ticket(s);</td></tr>
<tr class="codeline" data-linenumber="2988"><td class="num" id="LN2988">2988</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2989"><td class="num" id="LN2989">2989</td><td class="line">    *ret = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2990"><td class="num" id="LN2990">2990</td><td class="line">    s-&gt;tlsext_ticket_expected = 0;</td></tr>
<tr class="codeline" data-linenumber="2991"><td class="num" id="LN2991">2991</td><td class="line">    s-&gt;s3-&gt;flags &amp;= ~<span class='macro'>TLS1_FLAGS_RECEIVED_EXTMS<span class='macro_popup'>0x0200</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2992"><td class="num" id="LN2992">2992</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2993"><td class="num" id="LN2993">2993</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2994"><td class="num" id="LN2994">2994</td><td class="line">     <span class='comment'>* If tickets disabled behave as if no ticket present to permit stateful</span></td></tr>
<tr class="codeline" data-linenumber="2995"><td class="num" id="LN2995">2995</td><td class="line">     <span class='comment'>* resumption.</span></td></tr>
<tr class="codeline" data-linenumber="2996"><td class="num" id="LN2996">2996</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2997"><td class="num" id="LN2997">2997</td><td class="line">    <span class='keyword'>if</span> ((s-&gt;version &lt;= <span class='macro'>SSL3_VERSION<span class='macro_popup'>0x0300</span></span>))</td></tr>
<tr class="codeline" data-linenumber="2998"><td class="num" id="LN2998">2998</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2999"><td class="num" id="LN2999">2999</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3000"><td class="num" id="LN3000">3000</td><td class="line">    <span class='keyword'>if</span> (!PACKET_get_net_2(&amp;local_ext, &amp;i)) {</td></tr>
<tr class="codeline" data-linenumber="3001"><td class="num" id="LN3001">3001</td><td class="line">        retv = 0;</td></tr>
<tr class="codeline" data-linenumber="3002"><td class="num" id="LN3002">3002</td><td class="line">        <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="3003"><td class="num" id="LN3003">3003</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3004"><td class="num" id="LN3004">3004</td><td class="line">    <span class='keyword'>while</span> (PACKET_remaining(&amp;local_ext) &gt;= 4) {</td></tr>
<tr class="codeline" data-linenumber="3005"><td class="num" id="LN3005">3005</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>int</span> type, size;</td></tr>
<tr class="codeline" data-linenumber="3006"><td class="num" id="LN3006">3006</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3007"><td class="num" id="LN3007">3007</td><td class="line">        <span class='keyword'>if</span> (!PACKET_get_net_2(&amp;local_ext, &amp;type)</td></tr>
<tr class="codeline" data-linenumber="3008"><td class="num" id="LN3008">3008</td><td class="line">            || !PACKET_get_net_2(&amp;local_ext, &amp;size)) {</td></tr>
<tr class="codeline" data-linenumber="3009"><td class="num" id="LN3009">3009</td><td class="line">            <span class='comment'>/* Shouldn't ever happen */</span></td></tr>
<tr class="codeline" data-linenumber="3010"><td class="num" id="LN3010">3010</td><td class="line">            retv = -1;</td></tr>
<tr class="codeline" data-linenumber="3011"><td class="num" id="LN3011">3011</td><td class="line">            <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="3012"><td class="num" id="LN3012">3012</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3013"><td class="num" id="LN3013">3013</td><td class="line">        <span class='keyword'>if</span> (PACKET_remaining(&amp;local_ext) &lt; size) {</td></tr>
<tr class="codeline" data-linenumber="3014"><td class="num" id="LN3014">3014</td><td class="line">            retv = 0;</td></tr>
<tr class="codeline" data-linenumber="3015"><td class="num" id="LN3015">3015</td><td class="line">            <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="3016"><td class="num" id="LN3016">3016</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3017"><td class="num" id="LN3017">3017</td><td class="line">        <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_session_ticket<span class='macro_popup'>35</span></span> &amp;&amp; use_ticket) {</td></tr>
<tr class="codeline" data-linenumber="3018"><td class="num" id="LN3018">3018</td><td class="line">            <span class='keyword'>int</span> r;</td></tr>
<tr class="codeline" data-linenumber="3019"><td class="num" id="LN3019">3019</td><td class="line">            <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *etick;</td></tr>
<tr class="codeline" data-linenumber="3020"><td class="num" id="LN3020">3020</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3021"><td class="num" id="LN3021">3021</td><td class="line">            <span class='comment'>/* Duplicate extension */</span></td></tr>
<tr class="codeline" data-linenumber="3022"><td class="num" id="LN3022">3022</td><td class="line">            <span class='keyword'>if</span> (have_ticket != 0) {</td></tr>
<tr class="codeline" data-linenumber="3023"><td class="num" id="LN3023">3023</td><td class="line">                retv = -1;</td></tr>
<tr class="codeline" data-linenumber="3024"><td class="num" id="LN3024">3024</td><td class="line">                <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="3025"><td class="num" id="LN3025">3025</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3026"><td class="num" id="LN3026">3026</td><td class="line">            have_ticket = 1;</td></tr>
<tr class="codeline" data-linenumber="3027"><td class="num" id="LN3027">3027</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3028"><td class="num" id="LN3028">3028</td><td class="line">            <span class='keyword'>if</span> (size == 0) {</td></tr>
<tr class="codeline" data-linenumber="3029"><td class="num" id="LN3029">3029</td><td class="line">                <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3030"><td class="num" id="LN3030">3030</td><td class="line">                 <span class='comment'>* The client will accept a ticket but doesn't currently have</span></td></tr>
<tr class="codeline" data-linenumber="3031"><td class="num" id="LN3031">3031</td><td class="line">                 <span class='comment'>* one.</span></td></tr>
<tr class="codeline" data-linenumber="3032"><td class="num" id="LN3032">3032</td><td class="line">                 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3033"><td class="num" id="LN3033">3033</td><td class="line">                s-&gt;tlsext_ticket_expected = 1;</td></tr>
<tr class="codeline" data-linenumber="3034"><td class="num" id="LN3034">3034</td><td class="line">                retv = 1;</td></tr>
<tr class="codeline" data-linenumber="3035"><td class="num" id="LN3035">3035</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="3036"><td class="num" id="LN3036">3036</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3037"><td class="num" id="LN3037">3037</td><td class="line">            <span class='keyword'>if</span> (s-&gt;tls_session_secret_cb) {</td></tr>
<tr class="codeline" data-linenumber="3038"><td class="num" id="LN3038">3038</td><td class="line">                <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3039"><td class="num" id="LN3039">3039</td><td class="line">                 <span class='comment'>* Indicate that the ticket couldn't be decrypted rather than</span></td></tr>
<tr class="codeline" data-linenumber="3040"><td class="num" id="LN3040">3040</td><td class="line">                 <span class='comment'>* generating the session from ticket now, trigger</span></td></tr>
<tr class="codeline" data-linenumber="3041"><td class="num" id="LN3041">3041</td><td class="line">                 <span class='comment'>* abbreviated handshake based on external mechanism to</span></td></tr>
<tr class="codeline" data-linenumber="3042"><td class="num" id="LN3042">3042</td><td class="line">                 <span class='comment'>* calculate the master secret later.</span></td></tr>
<tr class="codeline" data-linenumber="3043"><td class="num" id="LN3043">3043</td><td class="line">                 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3044"><td class="num" id="LN3044">3044</td><td class="line">                retv = 2;</td></tr>
<tr class="codeline" data-linenumber="3045"><td class="num" id="LN3045">3045</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="3046"><td class="num" id="LN3046">3046</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3047"><td class="num" id="LN3047">3047</td><td class="line">            <span class='keyword'>if</span> (!PACKET_get_bytes(&amp;local_ext, &amp;etick, size)) {</td></tr>
<tr class="codeline" data-linenumber="3048"><td class="num" id="LN3048">3048</td><td class="line">                <span class='comment'>/* Shouldn't ever happen */</span></td></tr>
<tr class="codeline" data-linenumber="3049"><td class="num" id="LN3049">3049</td><td class="line">                retv = -1;</td></tr>
<tr class="codeline" data-linenumber="3050"><td class="num" id="LN3050">3050</td><td class="line">                <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="3051"><td class="num" id="LN3051">3051</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3052"><td class="num" id="LN3052">3052</td><td class="line">            r = tls_decrypt_ticket(s, etick, size, PACKET_data(session_id),</td></tr>
<tr class="codeline" data-linenumber="3053"><td class="num" id="LN3053">3053</td><td class="line">                                   PACKET_remaining(session_id), ret);</td></tr>
<tr class="codeline" data-linenumber="3054"><td class="num" id="LN3054">3054</td><td class="line">            <span class='keyword'>switch</span> (r) {</td></tr>
<tr class="codeline" data-linenumber="3055"><td class="num" id="LN3055">3055</td><td class="line">            <span class='keyword'>case</span> 2:            <span class='comment'>/* ticket couldn't be decrypted */</span></td></tr>
<tr class="codeline" data-linenumber="3056"><td class="num" id="LN3056">3056</td><td class="line">                s-&gt;tlsext_ticket_expected = 1;</td></tr>
<tr class="codeline" data-linenumber="3057"><td class="num" id="LN3057">3057</td><td class="line">                retv = 2;</td></tr>
<tr class="codeline" data-linenumber="3058"><td class="num" id="LN3058">3058</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3059"><td class="num" id="LN3059">3059</td><td class="line">            <span class='keyword'>case</span> 3:            <span class='comment'>/* ticket was decrypted */</span></td></tr>
<tr class="codeline" data-linenumber="3060"><td class="num" id="LN3060">3060</td><td class="line">                retv = r;</td></tr>
<tr class="codeline" data-linenumber="3061"><td class="num" id="LN3061">3061</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3062"><td class="num" id="LN3062">3062</td><td class="line">            <span class='keyword'>case</span> 4:            <span class='comment'>/* ticket decrypted but need to renew */</span></td></tr>
<tr class="codeline" data-linenumber="3063"><td class="num" id="LN3063">3063</td><td class="line">                s-&gt;tlsext_ticket_expected = 1;</td></tr>
<tr class="codeline" data-linenumber="3064"><td class="num" id="LN3064">3064</td><td class="line">                retv = 3;</td></tr>
<tr class="codeline" data-linenumber="3065"><td class="num" id="LN3065">3065</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3066"><td class="num" id="LN3066">3066</td><td class="line">            <span class='keyword'>default</span>:           <span class='comment'>/* fatal error */</span></td></tr>
<tr class="codeline" data-linenumber="3067"><td class="num" id="LN3067">3067</td><td class="line">                retv = -1;</td></tr>
<tr class="codeline" data-linenumber="3068"><td class="num" id="LN3068">3068</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3069"><td class="num" id="LN3069">3069</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3070"><td class="num" id="LN3070">3070</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="3071"><td class="num" id="LN3071">3071</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3072"><td class="num" id="LN3072">3072</td><td class="line">            <span class='keyword'>if</span> (type == <span class='macro'>TLSEXT_TYPE_extended_master_secret<span class='macro_popup'>23</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3073"><td class="num" id="LN3073">3073</td><td class="line">                s-&gt;s3-&gt;flags |= <span class='macro'>TLS1_FLAGS_RECEIVED_EXTMS<span class='macro_popup'>0x0200</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3074"><td class="num" id="LN3074">3074</td><td class="line">            <span class='keyword'>if</span> (!PACKET_forward(&amp;local_ext, size)) {</td></tr>
<tr class="codeline" data-linenumber="3075"><td class="num" id="LN3075">3075</td><td class="line">                retv = -1;</td></tr>
<tr class="codeline" data-linenumber="3076"><td class="num" id="LN3076">3076</td><td class="line">                <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="3077"><td class="num" id="LN3077">3077</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3078"><td class="num" id="LN3078">3078</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3079"><td class="num" id="LN3079">3079</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3080"><td class="num" id="LN3080">3080</td><td class="line">    <span class='keyword'>if</span> (have_ticket == 0)</td></tr>
<tr class="codeline" data-linenumber="3081"><td class="num" id="LN3081">3081</td><td class="line">        retv = 0;</td></tr>
<tr class="codeline" data-linenumber="3082"><td class="num" id="LN3082">3082</td><td class="line"> end:</td></tr>
<tr class="codeline" data-linenumber="3083"><td class="num" id="LN3083">3083</td><td class="line">    <span class='keyword'>return</span> retv;</td></tr>
<tr class="codeline" data-linenumber="3084"><td class="num" id="LN3084">3084</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3085"><td class="num" id="LN3085">3085</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3086"><td class="num" id="LN3086">3086</td><td class="line"><span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="3087"><td class="num" id="LN3087">3087</td><td class="line"> <span class='comment'>* tls_decrypt_ticket attempts to decrypt a session ticket.</span></td></tr>
<tr class="codeline" data-linenumber="3088"><td class="num" id="LN3088">3088</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3089"><td class="num" id="LN3089">3089</td><td class="line"> <span class='comment'>*   etick: points to the body of the session ticket extension.</span></td></tr>
<tr class="codeline" data-linenumber="3090"><td class="num" id="LN3090">3090</td><td class="line"> <span class='comment'>*   eticklen: the length of the session tickets extension.</span></td></tr>
<tr class="codeline" data-linenumber="3091"><td class="num" id="LN3091">3091</td><td class="line"> <span class='comment'>*   sess_id: points at the session ID.</span></td></tr>
<tr class="codeline" data-linenumber="3092"><td class="num" id="LN3092">3092</td><td class="line"> <span class='comment'>*   sesslen: the length of the session ID.</span></td></tr>
<tr class="codeline" data-linenumber="3093"><td class="num" id="LN3093">3093</td><td class="line"> <span class='comment'>*   psess: (output) on return, if a ticket was decrypted, then this is set to</span></td></tr>
<tr class="codeline" data-linenumber="3094"><td class="num" id="LN3094">3094</td><td class="line"> <span class='comment'>*       point to the resulting session.</span></td></tr>
<tr class="codeline" data-linenumber="3095"><td class="num" id="LN3095">3095</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3096"><td class="num" id="LN3096">3096</td><td class="line"> <span class='comment'>* Returns:</span></td></tr>
<tr class="codeline" data-linenumber="3097"><td class="num" id="LN3097">3097</td><td class="line"> <span class='comment'>*   -2: fatal error, malloc failure.</span></td></tr>
<tr class="codeline" data-linenumber="3098"><td class="num" id="LN3098">3098</td><td class="line"> <span class='comment'>*   -1: fatal error, either from parsing or decrypting the ticket.</span></td></tr>
<tr class="codeline" data-linenumber="3099"><td class="num" id="LN3099">3099</td><td class="line"> <span class='comment'>*    2: the ticket couldn't be decrypted.</span></td></tr>
<tr class="codeline" data-linenumber="3100"><td class="num" id="LN3100">3100</td><td class="line"> <span class='comment'>*    3: a ticket was successfully decrypted and *psess was set.</span></td></tr>
<tr class="codeline" data-linenumber="3101"><td class="num" id="LN3101">3101</td><td class="line"> <span class='comment'>*    4: same as 3, but the ticket needs to be renewed.</span></td></tr>
<tr class="codeline" data-linenumber="3102"><td class="num" id="LN3102">3102</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3103"><td class="num" id="LN3103">3103</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls_decrypt_ticket(SSL *s, <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *etick,</td></tr>
<tr class="codeline" data-linenumber="3104"><td class="num" id="LN3104">3104</td><td class="line">                              <span class='keyword'>int</span> eticklen, <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *sess_id,</td></tr>
<tr class="codeline" data-linenumber="3105"><td class="num" id="LN3105">3105</td><td class="line">                              <span class='keyword'>int</span> sesslen, SSL_SESSION **psess)</td></tr>
<tr class="codeline" data-linenumber="3106"><td class="num" id="LN3106">3106</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3107"><td class="num" id="LN3107">3107</td><td class="line">    SSL_SESSION *sess;</td></tr>
<tr class="codeline" data-linenumber="3108"><td class="num" id="LN3108">3108</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *sdec;</td></tr>
<tr class="codeline" data-linenumber="3109"><td class="num" id="LN3109">3109</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p;</td></tr>
<tr class="codeline" data-linenumber="3110"><td class="num" id="LN3110">3110</td><td class="line">    <span class='keyword'>int</span> slen, mlen, renew_ticket = 0, ret = -1;</td></tr>
<tr class="codeline" data-linenumber="3111"><td class="num" id="LN3111">3111</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> tick_hmac[<span class='macro'>EVP_MAX_MD_SIZE<span class='macro_popup'>64</span></span>];</td></tr>
<tr class="codeline" data-linenumber="3112"><td class="num" id="LN3112">3112</td><td class="line">    HMAC_CTX *hctx = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3113"><td class="num" id="LN3113">3113</td><td class="line">    EVP_CIPHER_CTX *ctx;</td></tr>
<tr class="codeline" data-linenumber="3114"><td class="num" id="LN3114">3114</td><td class="line">    SSL_CTX *tctx = s-&gt;session_ctx;</td></tr>
<tr class="codeline" data-linenumber="3115"><td class="num" id="LN3115">3115</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3116"><td class="num" id="LN3116">3116</td><td class="line">    <span class='comment'>/* Initialize session ticket encryption and HMAC contexts */</span></td></tr>
<tr class="codeline" data-linenumber="3117"><td class="num" id="LN3117">3117</td><td class="line">    hctx = HMAC_CTX_new();</td></tr>
<tr class="codeline" data-linenumber="3118"><td class="num" id="LN3118">3118</td><td class="line">    <span class='keyword'>if</span> (hctx == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3119"><td class="num" id="LN3119">3119</td><td class="line">        <span class='keyword'>return</span> -2;</td></tr>
<tr class="codeline" data-linenumber="3120"><td class="num" id="LN3120">3120</td><td class="line">    ctx = EVP_CIPHER_CTX_new();</td></tr>
<tr class="codeline" data-linenumber="3121"><td class="num" id="LN3121">3121</td><td class="line">    <span class='keyword'>if</span> (ctx == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3122"><td class="num" id="LN3122">3122</td><td class="line">        ret = -2;</td></tr>
<tr class="codeline" data-linenumber="3123"><td class="num" id="LN3123">3123</td><td class="line">        <span class='keyword'>goto</span> err;</td></tr>
<tr class="codeline" data-linenumber="3124"><td class="num" id="LN3124">3124</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3125"><td class="num" id="LN3125">3125</td><td class="line">    <span class='keyword'>if</span> (tctx-&gt;tlsext_ticket_key_cb) {</td></tr>
<tr class="codeline" data-linenumber="3126"><td class="num" id="LN3126">3126</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *nctick = (<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *)etick;</td></tr>
<tr class="codeline" data-linenumber="3127"><td class="num" id="LN3127">3127</td><td class="line">        <span class='keyword'>int</span> rv = tctx-&gt;tlsext_ticket_key_cb(s, nctick, nctick + 16,</td></tr>
<tr class="codeline" data-linenumber="3128"><td class="num" id="LN3128">3128</td><td class="line">                                            ctx, hctx, 0);</td></tr>
<tr class="codeline" data-linenumber="3129"><td class="num" id="LN3129">3129</td><td class="line">        <span class='keyword'>if</span> (rv &lt; 0)</td></tr>
<tr class="codeline" data-linenumber="3130"><td class="num" id="LN3130">3130</td><td class="line">            <span class='keyword'>goto</span> err;</td></tr>
<tr class="codeline" data-linenumber="3131"><td class="num" id="LN3131">3131</td><td class="line">        <span class='keyword'>if</span> (rv == 0) {</td></tr>
<tr class="codeline" data-linenumber="3132"><td class="num" id="LN3132">3132</td><td class="line">            ret = 2;</td></tr>
<tr class="codeline" data-linenumber="3133"><td class="num" id="LN3133">3133</td><td class="line">            <span class='keyword'>goto</span> err;</td></tr>
<tr class="codeline" data-linenumber="3134"><td class="num" id="LN3134">3134</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3135"><td class="num" id="LN3135">3135</td><td class="line">        <span class='keyword'>if</span> (rv == 2)</td></tr>
<tr class="codeline" data-linenumber="3136"><td class="num" id="LN3136">3136</td><td class="line">            renew_ticket = 1;</td></tr>
<tr class="codeline" data-linenumber="3137"><td class="num" id="LN3137">3137</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3138"><td class="num" id="LN3138">3138</td><td class="line">        <span class='comment'>/* Check key name matches */</span></td></tr>
<tr class="codeline" data-linenumber="3139"><td class="num" id="LN3139">3139</td><td class="line">        <span class='keyword'>if</span> (memcmp(etick, tctx-&gt;tlsext_tick_key_name,</td></tr>
<tr class="codeline" data-linenumber="3140"><td class="num" id="LN3140">3140</td><td class="line">                   <span class='keyword'>sizeof</span>(tctx-&gt;tlsext_tick_key_name)) != 0) {</td></tr>
<tr class="codeline" data-linenumber="3141"><td class="num" id="LN3141">3141</td><td class="line">            ret = 2;</td></tr>
<tr class="codeline" data-linenumber="3142"><td class="num" id="LN3142">3142</td><td class="line">            <span class='keyword'>goto</span> err;</td></tr>
<tr class="codeline" data-linenumber="3143"><td class="num" id="LN3143">3143</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3144"><td class="num" id="LN3144">3144</td><td class="line">        <span class='keyword'>if</span> (HMAC_Init_ex(hctx, tctx-&gt;tlsext_tick_hmac_key,</td></tr>
<tr class="codeline" data-linenumber="3145"><td class="num" id="LN3145">3145</td><td class="line">                         <span class='keyword'>sizeof</span>(tctx-&gt;tlsext_tick_hmac_key),</td></tr>
<tr class="codeline" data-linenumber="3146"><td class="num" id="LN3146">3146</td><td class="line">                         EVP_sha256(), <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) &lt;= 0</td></tr>
<tr class="codeline" data-linenumber="3147"><td class="num" id="LN3147">3147</td><td class="line">            || EVP_DecryptInit_ex(ctx, EVP_aes_256_cbc(), <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="3148"><td class="num" id="LN3148">3148</td><td class="line">                                  tctx-&gt;tlsext_tick_aes_key,</td></tr>
<tr class="codeline" data-linenumber="3149"><td class="num" id="LN3149">3149</td><td class="line">                                  etick + <span class='keyword'>sizeof</span>(tctx-&gt;tlsext_tick_key_name)) &lt;=</td></tr>
<tr class="codeline" data-linenumber="3150"><td class="num" id="LN3150">3150</td><td class="line">            0) {</td></tr>
<tr class="codeline" data-linenumber="3151"><td class="num" id="LN3151">3151</td><td class="line">            <span class='keyword'>goto</span> err;</td></tr>
<tr class="codeline" data-linenumber="3152"><td class="num" id="LN3152">3152</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3153"><td class="num" id="LN3153">3153</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3154"><td class="num" id="LN3154">3154</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3155"><td class="num" id="LN3155">3155</td><td class="line">     <span class='comment'>* Attempt to process session ticket, first conduct sanity and integrity</span></td></tr>
<tr class="codeline" data-linenumber="3156"><td class="num" id="LN3156">3156</td><td class="line">     <span class='comment'>* checks on ticket.</span></td></tr>
<tr class="codeline" data-linenumber="3157"><td class="num" id="LN3157">3157</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3158"><td class="num" id="LN3158">3158</td><td class="line">    mlen = HMAC_size(hctx);</td></tr>
<tr class="codeline" data-linenumber="3159"><td class="num" id="LN3159">3159</td><td class="line">    <span class='keyword'>if</span> (mlen &lt; 0) {</td></tr>
<tr class="codeline" data-linenumber="3160"><td class="num" id="LN3160">3160</td><td class="line">        <span class='keyword'>goto</span> err;</td></tr>
<tr class="codeline" data-linenumber="3161"><td class="num" id="LN3161">3161</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3162"><td class="num" id="LN3162">3162</td><td class="line">    <span class='comment'>/* Sanity check ticket length: must exceed keyname + IV + HMAC */</span></td></tr>
<tr class="codeline" data-linenumber="3163"><td class="num" id="LN3163">3163</td><td class="line">    <span class='keyword'>if</span> (eticklen &lt;=</td></tr>
<tr class="codeline" data-linenumber="3164"><td class="num" id="LN3164">3164</td><td class="line">        <span class='macro'>TLSEXT_KEYNAME_LENGTH<span class='macro_popup'>16</span></span> + EVP_CIPHER_CTX_iv_length(ctx) + mlen) {</td></tr>
<tr class="codeline" data-linenumber="3165"><td class="num" id="LN3165">3165</td><td class="line">        ret = 2;</td></tr>
<tr class="codeline" data-linenumber="3166"><td class="num" id="LN3166">3166</td><td class="line">        <span class='keyword'>goto</span> err;</td></tr>
<tr class="codeline" data-linenumber="3167"><td class="num" id="LN3167">3167</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3168"><td class="num" id="LN3168">3168</td><td class="line">    eticklen -= mlen;</td></tr>
<tr class="codeline" data-linenumber="3169"><td class="num" id="LN3169">3169</td><td class="line">    <span class='comment'>/* Check HMAC of encrypted ticket */</span></td></tr>
<tr class="codeline" data-linenumber="3170"><td class="num" id="LN3170">3170</td><td class="line">    <span class='keyword'>if</span> (HMAC_Update(hctx, etick, eticklen) &lt;= 0</td></tr>
<tr class="codeline" data-linenumber="3171"><td class="num" id="LN3171">3171</td><td class="line">        || HMAC_Final(hctx, tick_hmac, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) &lt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="3172"><td class="num" id="LN3172">3172</td><td class="line">        <span class='keyword'>goto</span> err;</td></tr>
<tr class="codeline" data-linenumber="3173"><td class="num" id="LN3173">3173</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3174"><td class="num" id="LN3174">3174</td><td class="line">    HMAC_CTX_free(hctx);</td></tr>
<tr class="codeline" data-linenumber="3175"><td class="num" id="LN3175">3175</td><td class="line">    <span class='keyword'>if</span> (CRYPTO_memcmp(tick_hmac, etick + eticklen, mlen)) {</td></tr>
<tr class="codeline" data-linenumber="3176"><td class="num" id="LN3176">3176</td><td class="line">        EVP_CIPHER_CTX_free(ctx);</td></tr>
<tr class="codeline" data-linenumber="3177"><td class="num" id="LN3177">3177</td><td class="line">        <span class='keyword'>return</span> 2;</td></tr>
<tr class="codeline" data-linenumber="3178"><td class="num" id="LN3178">3178</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3179"><td class="num" id="LN3179">3179</td><td class="line">    <span class='comment'>/* Attempt to decrypt session data */</span></td></tr>
<tr class="codeline" data-linenumber="3180"><td class="num" id="LN3180">3180</td><td class="line">    <span class='comment'>/* Move p after IV to start of encrypted ticket, update length */</span></td></tr>
<tr class="codeline" data-linenumber="3181"><td class="num" id="LN3181">3181</td><td class="line">    p = etick + <span class='macro'>TLSEXT_KEYNAME_LENGTH<span class='macro_popup'>16</span></span> + EVP_CIPHER_CTX_iv_length(ctx);</td></tr>
<tr class="codeline" data-linenumber="3182"><td class="num" id="LN3182">3182</td><td class="line">    eticklen -= <span class='macro'>TLSEXT_KEYNAME_LENGTH<span class='macro_popup'>16</span></span> + EVP_CIPHER_CTX_iv_length(ctx);</td></tr>
<tr class="codeline" data-linenumber="3183"><td class="num" id="LN3183">3183</td><td class="line">    sdec = <span class='macro'>OPENSSL_malloc(eticklen)<span class='macro_popup'>CRYPTO_malloc(eticklen, "ssl/t1_lib.c", 3183)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3184"><td class="num" id="LN3184">3184</td><td class="line">    <span class='keyword'>if</span> (sdec == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || EVP_DecryptUpdate(ctx, sdec, &amp;slen, p, eticklen) &lt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="3185"><td class="num" id="LN3185">3185</td><td class="line">        EVP_CIPHER_CTX_free(ctx);</td></tr>
<tr class="codeline" data-linenumber="3186"><td class="num" id="LN3186">3186</td><td class="line">        <span class='macro'>OPENSSL_free(sdec)<span class='macro_popup'>CRYPTO_free(sdec, "ssl/t1_lib.c", 3186)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3187"><td class="num" id="LN3187">3187</td><td class="line">        <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="3188"><td class="num" id="LN3188">3188</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3189"><td class="num" id="LN3189">3189</td><td class="line">    <span class='keyword'>if</span> (EVP_DecryptFinal(ctx, sdec + slen, &amp;mlen) &lt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="3190"><td class="num" id="LN3190">3190</td><td class="line">        EVP_CIPHER_CTX_free(ctx);</td></tr>
<tr class="codeline" data-linenumber="3191"><td class="num" id="LN3191">3191</td><td class="line">        <span class='macro'>OPENSSL_free(sdec)<span class='macro_popup'>CRYPTO_free(sdec, "ssl/t1_lib.c", 3191)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3192"><td class="num" id="LN3192">3192</td><td class="line">        <span class='keyword'>return</span> 2;</td></tr>
<tr class="codeline" data-linenumber="3193"><td class="num" id="LN3193">3193</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3194"><td class="num" id="LN3194">3194</td><td class="line">    slen += mlen;</td></tr>
<tr class="codeline" data-linenumber="3195"><td class="num" id="LN3195">3195</td><td class="line">    EVP_CIPHER_CTX_free(ctx);</td></tr>
<tr class="codeline" data-linenumber="3196"><td class="num" id="LN3196">3196</td><td class="line">    ctx = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3197"><td class="num" id="LN3197">3197</td><td class="line">    p = sdec;</td></tr>
<tr class="codeline" data-linenumber="3198"><td class="num" id="LN3198">3198</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3199"><td class="num" id="LN3199">3199</td><td class="line">    sess = d2i_SSL_SESSION(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, &amp;p, slen);</td></tr>
<tr class="codeline" data-linenumber="3200"><td class="num" id="LN3200">3200</td><td class="line">    slen -= p - sdec;</td></tr>
<tr class="codeline" data-linenumber="3201"><td class="num" id="LN3201">3201</td><td class="line">    <span class='macro'>OPENSSL_free(sdec)<span class='macro_popup'>CRYPTO_free(sdec, "ssl/t1_lib.c", 3201)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3202"><td class="num" id="LN3202">3202</td><td class="line">    <span class='keyword'>if</span> (sess) {</td></tr>
<tr class="codeline" data-linenumber="3203"><td class="num" id="LN3203">3203</td><td class="line">        <span class='comment'>/* Some additional consistency checks */</span></td></tr>
<tr class="codeline" data-linenumber="3204"><td class="num" id="LN3204">3204</td><td class="line">        <span class='keyword'>if</span> (slen != 0 || sess-&gt;session_id_length != 0) {</td></tr>
<tr class="codeline" data-linenumber="3205"><td class="num" id="LN3205">3205</td><td class="line">            SSL_SESSION_free(sess);</td></tr>
<tr class="codeline" data-linenumber="3206"><td class="num" id="LN3206">3206</td><td class="line">            <span class='keyword'>return</span> 2;</td></tr>
<tr class="codeline" data-linenumber="3207"><td class="num" id="LN3207">3207</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3208"><td class="num" id="LN3208">3208</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3209"><td class="num" id="LN3209">3209</td><td class="line">         <span class='comment'>* The session ID, if non-empty, is used by some clients to detect</span></td></tr>
<tr class="codeline" data-linenumber="3210"><td class="num" id="LN3210">3210</td><td class="line">         <span class='comment'>* that the ticket has been accepted. So we copy it to the session</span></td></tr>
<tr class="codeline" data-linenumber="3211"><td class="num" id="LN3211">3211</td><td class="line">         <span class='comment'>* structure. If it is empty set length to zero as required by</span></td></tr>
<tr class="codeline" data-linenumber="3212"><td class="num" id="LN3212">3212</td><td class="line">         <span class='comment'>* standard.</span></td></tr>
<tr class="codeline" data-linenumber="3213"><td class="num" id="LN3213">3213</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3214"><td class="num" id="LN3214">3214</td><td class="line">        <span class='keyword'>if</span> (sesslen)</td></tr>
<tr class="codeline" data-linenumber="3215"><td class="num" id="LN3215">3215</td><td class="line">            memcpy(sess-&gt;session_id, sess_id, sesslen);</td></tr>
<tr class="codeline" data-linenumber="3216"><td class="num" id="LN3216">3216</td><td class="line">        sess-&gt;session_id_length = sesslen;</td></tr>
<tr class="codeline" data-linenumber="3217"><td class="num" id="LN3217">3217</td><td class="line">        *psess = sess;</td></tr>
<tr class="codeline" data-linenumber="3218"><td class="num" id="LN3218">3218</td><td class="line">        <span class='keyword'>if</span> (renew_ticket)</td></tr>
<tr class="codeline" data-linenumber="3219"><td class="num" id="LN3219">3219</td><td class="line">            <span class='keyword'>return</span> 4;</td></tr>
<tr class="codeline" data-linenumber="3220"><td class="num" id="LN3220">3220</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3221"><td class="num" id="LN3221">3221</td><td class="line">            <span class='keyword'>return</span> 3;</td></tr>
<tr class="codeline" data-linenumber="3222"><td class="num" id="LN3222">3222</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3223"><td class="num" id="LN3223">3223</td><td class="line">    ERR_clear_error();</td></tr>
<tr class="codeline" data-linenumber="3224"><td class="num" id="LN3224">3224</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3225"><td class="num" id="LN3225">3225</td><td class="line">     <span class='comment'>* For session parse failure, indicate that we need to send a new ticket.</span></td></tr>
<tr class="codeline" data-linenumber="3226"><td class="num" id="LN3226">3226</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3227"><td class="num" id="LN3227">3227</td><td class="line">    <span class='keyword'>return</span> 2;</td></tr>
<tr class="codeline" data-linenumber="3228"><td class="num" id="LN3228">3228</td><td class="line"> err:</td></tr>
<tr class="codeline" data-linenumber="3229"><td class="num" id="LN3229">3229</td><td class="line">    EVP_CIPHER_CTX_free(ctx);</td></tr>
<tr class="codeline" data-linenumber="3230"><td class="num" id="LN3230">3230</td><td class="line">    HMAC_CTX_free(hctx);</td></tr>
<tr class="codeline" data-linenumber="3231"><td class="num" id="LN3231">3231</td><td class="line">    <span class='keyword'>return</span> ret;</td></tr>
<tr class="codeline" data-linenumber="3232"><td class="num" id="LN3232">3232</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3233"><td class="num" id="LN3233">3233</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3234"><td class="num" id="LN3234">3234</td><td class="line"><span class='comment'>/* Tables to translate from NIDs to TLS v1.2 ids */</span></td></tr>
<tr class="codeline" data-linenumber="3235"><td class="num" id="LN3235">3235</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3236"><td class="num" id="LN3236">3236</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> {</td></tr>
<tr class="codeline" data-linenumber="3237"><td class="num" id="LN3237">3237</td><td class="line">    <span class='keyword'>int</span> nid;</td></tr>
<tr class="codeline" data-linenumber="3238"><td class="num" id="LN3238">3238</td><td class="line">    <span class='keyword'>int</span> id;</td></tr>
<tr class="codeline" data-linenumber="3239"><td class="num" id="LN3239">3239</td><td class="line">} tls12_lookup;</td></tr>
<tr class="codeline" data-linenumber="3240"><td class="num" id="LN3240">3240</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3241"><td class="num" id="LN3241">3241</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> tls12_lookup tls12_md[] = {</td></tr>
<tr class="codeline" data-linenumber="3242"><td class="num" id="LN3242">3242</td><td class="line">    {<span class='macro'>NID_md5<span class='macro_popup'>4</span></span>, <span class='macro'>TLSEXT_hash_md5<span class='macro_popup'>1</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3243"><td class="num" id="LN3243">3243</td><td class="line">    {<span class='macro'>NID_sha1<span class='macro_popup'>64</span></span>, <span class='macro'>TLSEXT_hash_sha1<span class='macro_popup'>2</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3244"><td class="num" id="LN3244">3244</td><td class="line">    {<span class='macro'>NID_sha224<span class='macro_popup'>675</span></span>, <span class='macro'>TLSEXT_hash_sha224<span class='macro_popup'>3</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3245"><td class="num" id="LN3245">3245</td><td class="line">    {<span class='macro'>NID_sha256<span class='macro_popup'>672</span></span>, <span class='macro'>TLSEXT_hash_sha256<span class='macro_popup'>4</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3246"><td class="num" id="LN3246">3246</td><td class="line">    {<span class='macro'>NID_sha384<span class='macro_popup'>673</span></span>, <span class='macro'>TLSEXT_hash_sha384<span class='macro_popup'>5</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3247"><td class="num" id="LN3247">3247</td><td class="line">    {<span class='macro'>NID_sha512<span class='macro_popup'>674</span></span>, <span class='macro'>TLSEXT_hash_sha512<span class='macro_popup'>6</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3248"><td class="num" id="LN3248">3248</td><td class="line">    {<span class='macro'>NID_id_GostR3411_94<span class='macro_popup'>809</span></span>, <span class='macro'>TLSEXT_hash_gostr3411<span class='macro_popup'>237</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3249"><td class="num" id="LN3249">3249</td><td class="line">    {<span class='macro'>NID_id_GostR3411_2012_256<span class='macro_popup'>982</span></span>, <span class='macro'>TLSEXT_hash_gostr34112012_256<span class='macro_popup'>238</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3250"><td class="num" id="LN3250">3250</td><td class="line">    {<span class='macro'>NID_id_GostR3411_2012_512<span class='macro_popup'>983</span></span>, <span class='macro'>TLSEXT_hash_gostr34112012_512<span class='macro_popup'>239</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3251"><td class="num" id="LN3251">3251</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="3252"><td class="num" id="LN3252">3252</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3253"><td class="num" id="LN3253">3253</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> tls12_lookup tls12_sig[] = {</td></tr>
<tr class="codeline" data-linenumber="3254"><td class="num" id="LN3254">3254</td><td class="line">    {<span class='macro'>EVP_PKEY_RSA<span class='macro_popup'>6</span></span>, <span class='macro'>TLSEXT_signature_rsa<span class='macro_popup'>1</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3255"><td class="num" id="LN3255">3255</td><td class="line">    {<span class='macro'>EVP_PKEY_DSA<span class='macro_popup'>116</span></span>, <span class='macro'>TLSEXT_signature_dsa<span class='macro_popup'>2</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3256"><td class="num" id="LN3256">3256</td><td class="line">    {<span class='macro'>EVP_PKEY_EC<span class='macro_popup'>408</span></span>, <span class='macro'>TLSEXT_signature_ecdsa<span class='macro_popup'>3</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3257"><td class="num" id="LN3257">3257</td><td class="line">    {<span class='macro'>NID_id_GostR3410_2001<span class='macro_popup'>811</span></span>, <span class='macro'>TLSEXT_signature_gostr34102001<span class='macro_popup'>237</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3258"><td class="num" id="LN3258">3258</td><td class="line">    {<span class='macro'>NID_id_GostR3410_2012_256<span class='macro_popup'>979</span></span>, <span class='macro'>TLSEXT_signature_gostr34102012_256<span class='macro_popup'>238</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3259"><td class="num" id="LN3259">3259</td><td class="line">    {<span class='macro'>NID_id_GostR3410_2012_512<span class='macro_popup'>980</span></span>, <span class='macro'>TLSEXT_signature_gostr34102012_512<span class='macro_popup'>239</span></span>}</td></tr>
<tr class="codeline" data-linenumber="3260"><td class="num" id="LN3260">3260</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="3261"><td class="num" id="LN3261">3261</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3262"><td class="num" id="LN3262">3262</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls12_find_id(<span class='keyword'>int</span> nid, <span class='keyword'>const</span> tls12_lookup *table, size_t tlen)</td></tr>
<tr class="codeline" data-linenumber="3263"><td class="num" id="LN3263">3263</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3264"><td class="num" id="LN3264">3264</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="3265"><td class="num" id="LN3265">3265</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; tlen; i++) {</td></tr>
<tr class="codeline" data-linenumber="3266"><td class="num" id="LN3266">3266</td><td class="line">        <span class='keyword'>if</span> (table[i].nid == nid)</td></tr>
<tr class="codeline" data-linenumber="3267"><td class="num" id="LN3267">3267</td><td class="line">            <span class='keyword'>return</span> table[i].id;</td></tr>
<tr class="codeline" data-linenumber="3268"><td class="num" id="LN3268">3268</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3269"><td class="num" id="LN3269">3269</td><td class="line">    <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="3270"><td class="num" id="LN3270">3270</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3271"><td class="num" id="LN3271">3271</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3272"><td class="num" id="LN3272">3272</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls12_find_nid(<span class='keyword'>int</span> id, <span class='keyword'>const</span> tls12_lookup *table, size_t tlen)</td></tr>
<tr class="codeline" data-linenumber="3273"><td class="num" id="LN3273">3273</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3274"><td class="num" id="LN3274">3274</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="3275"><td class="num" id="LN3275">3275</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; tlen; i++) {</td></tr>
<tr class="codeline" data-linenumber="3276"><td class="num" id="LN3276">3276</td><td class="line">        <span class='keyword'>if</span> ((table[i].id) == id)</td></tr>
<tr class="codeline" data-linenumber="3277"><td class="num" id="LN3277">3277</td><td class="line">            <span class='keyword'>return</span> table[i].nid;</td></tr>
<tr class="codeline" data-linenumber="3278"><td class="num" id="LN3278">3278</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3279"><td class="num" id="LN3279">3279</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3280"><td class="num" id="LN3280">3280</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3281"><td class="num" id="LN3281">3281</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3282"><td class="num" id="LN3282">3282</td><td class="line"><span class='keyword'>int</span> tls12_get_sigandhash(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p, <span class='keyword'>const</span> EVP_PKEY *pk, <span class='keyword'>const</span> EVP_MD *md)</td></tr>
<tr class="codeline" data-linenumber="3283"><td class="num" id="LN3283">3283</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3284"><td class="num" id="LN3284">3284</td><td class="line">    <span class='keyword'>int</span> sig_id, md_id;</td></tr>
<tr class="codeline" data-linenumber="3285"><td class="num" id="LN3285">3285</td><td class="line">    <span class='keyword'>if</span> (!md)</td></tr>
<tr class="codeline" data-linenumber="3286"><td class="num" id="LN3286">3286</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3287"><td class="num" id="LN3287">3287</td><td class="line">    md_id = tls12_find_id(EVP_MD_type(md), tls12_md, <span class='macro'>OSSL_NELEM(tls12_md)<span class='macro_popup'>(sizeof(tls12_md)/sizeof((tls12_md)[0]))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3288"><td class="num" id="LN3288">3288</td><td class="line">    <span class='keyword'>if</span> (md_id == -1)</td></tr>
<tr class="codeline" data-linenumber="3289"><td class="num" id="LN3289">3289</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3290"><td class="num" id="LN3290">3290</td><td class="line">    sig_id = tls12_get_sigid(pk);</td></tr>
<tr class="codeline" data-linenumber="3291"><td class="num" id="LN3291">3291</td><td class="line">    <span class='keyword'>if</span> (sig_id == -1)</td></tr>
<tr class="codeline" data-linenumber="3292"><td class="num" id="LN3292">3292</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3293"><td class="num" id="LN3293">3293</td><td class="line">    p[0] = (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>)md_id;</td></tr>
<tr class="codeline" data-linenumber="3294"><td class="num" id="LN3294">3294</td><td class="line">    p[1] = (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>)sig_id;</td></tr>
<tr class="codeline" data-linenumber="3295"><td class="num" id="LN3295">3295</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="3296"><td class="num" id="LN3296">3296</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3297"><td class="num" id="LN3297">3297</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3298"><td class="num" id="LN3298">3298</td><td class="line"><span class='keyword'>int</span> tls12_get_sigid(<span class='keyword'>const</span> EVP_PKEY *pk)</td></tr>
<tr class="codeline" data-linenumber="3299"><td class="num" id="LN3299">3299</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3300"><td class="num" id="LN3300">3300</td><td class="line">    <span class='keyword'>return</span> tls12_find_id(EVP_PKEY_id(pk), tls12_sig, <span class='macro'>OSSL_NELEM(tls12_sig)<span class='macro_popup'>(sizeof(tls12_sig)/sizeof((tls12_sig)[0]))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3301"><td class="num" id="LN3301">3301</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3302"><td class="num" id="LN3302">3302</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3303"><td class="num" id="LN3303">3303</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> {</td></tr>
<tr class="codeline" data-linenumber="3304"><td class="num" id="LN3304">3304</td><td class="line">    <span class='keyword'>int</span> nid;</td></tr>
<tr class="codeline" data-linenumber="3305"><td class="num" id="LN3305">3305</td><td class="line">    <span class='keyword'>int</span> secbits;</td></tr>
<tr class="codeline" data-linenumber="3306"><td class="num" id="LN3306">3306</td><td class="line">    <span class='keyword'>int</span> md_idx;</td></tr>
<tr class="codeline" data-linenumber="3307"><td class="num" id="LN3307">3307</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> tlsext_hash;</td></tr>
<tr class="codeline" data-linenumber="3308"><td class="num" id="LN3308">3308</td><td class="line">} tls12_hash_info;</td></tr>
<tr class="codeline" data-linenumber="3309"><td class="num" id="LN3309">3309</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3310"><td class="num" id="LN3310">3310</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> tls12_hash_info tls12_md_info[] = {</td></tr>
<tr class="codeline" data-linenumber="3311"><td class="num" id="LN3311">3311</td><td class="line">    {<span class='macro'>NID_md5<span class='macro_popup'>4</span></span>, 64, <span class='macro'>SSL_MD_MD5_IDX<span class='macro_popup'>0</span></span>, <span class='macro'>TLSEXT_hash_md5<span class='macro_popup'>1</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3312"><td class="num" id="LN3312">3312</td><td class="line">    {<span class='macro'>NID_sha1<span class='macro_popup'>64</span></span>, 80, <span class='macro'>SSL_MD_SHA1_IDX<span class='macro_popup'>1</span></span>, <span class='macro'>TLSEXT_hash_sha1<span class='macro_popup'>2</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3313"><td class="num" id="LN3313">3313</td><td class="line">    {<span class='macro'>NID_sha224<span class='macro_popup'>675</span></span>, 112, <span class='macro'>SSL_MD_SHA224_IDX<span class='macro_popup'>10</span></span>, <span class='macro'>TLSEXT_hash_sha224<span class='macro_popup'>3</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3314"><td class="num" id="LN3314">3314</td><td class="line">    {<span class='macro'>NID_sha256<span class='macro_popup'>672</span></span>, 128, <span class='macro'>SSL_MD_SHA256_IDX<span class='macro_popup'>4</span></span>, <span class='macro'>TLSEXT_hash_sha256<span class='macro_popup'>4</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3315"><td class="num" id="LN3315">3315</td><td class="line">    {<span class='macro'>NID_sha384<span class='macro_popup'>673</span></span>, 192, <span class='macro'>SSL_MD_SHA384_IDX<span class='macro_popup'>5</span></span>, <span class='macro'>TLSEXT_hash_sha384<span class='macro_popup'>5</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3316"><td class="num" id="LN3316">3316</td><td class="line">    {<span class='macro'>NID_sha512<span class='macro_popup'>674</span></span>, 256, <span class='macro'>SSL_MD_SHA512_IDX<span class='macro_popup'>11</span></span>, <span class='macro'>TLSEXT_hash_sha512<span class='macro_popup'>6</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3317"><td class="num" id="LN3317">3317</td><td class="line">    {<span class='macro'>NID_id_GostR3411_94<span class='macro_popup'>809</span></span>, 128, <span class='macro'>SSL_MD_GOST94_IDX<span class='macro_popup'>2</span></span>, <span class='macro'>TLSEXT_hash_gostr3411<span class='macro_popup'>237</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3318"><td class="num" id="LN3318">3318</td><td class="line">    {<span class='macro'>NID_id_GostR3411_2012_256<span class='macro_popup'>982</span></span>, 128, <span class='macro'>SSL_MD_GOST12_256_IDX<span class='macro_popup'>6</span></span>,</td></tr>
<tr class="codeline" data-linenumber="3319"><td class="num" id="LN3319">3319</td><td class="line">     <span class='macro'>TLSEXT_hash_gostr34112012_256<span class='macro_popup'>238</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3320"><td class="num" id="LN3320">3320</td><td class="line">    {<span class='macro'>NID_id_GostR3411_2012_512<span class='macro_popup'>983</span></span>, 256, <span class='macro'>SSL_MD_GOST12_512_IDX<span class='macro_popup'>8</span></span>,</td></tr>
<tr class="codeline" data-linenumber="3321"><td class="num" id="LN3321">3321</td><td class="line">     <span class='macro'>TLSEXT_hash_gostr34112012_512<span class='macro_popup'>239</span></span>},</td></tr>
<tr class="codeline" data-linenumber="3322"><td class="num" id="LN3322">3322</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="3323"><td class="num" id="LN3323">3323</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3324"><td class="num" id="LN3324">3324</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> tls12_hash_info *tls12_get_hash_info(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> hash_alg)</td></tr>
<tr class="codeline" data-linenumber="3325"><td class="num" id="LN3325">3325</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3326"><td class="num" id="LN3326">3326</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="3327"><td class="num" id="LN3327">3327</td><td class="line">    <span class='keyword'>if</span> (hash_alg == 0)</td></tr>
<tr class="codeline" data-linenumber="3328"><td class="num" id="LN3328">3328</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3329"><td class="num" id="LN3329">3329</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3330"><td class="num" id="LN3330">3330</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; <span class='macro'>OSSL_NELEM(tls12_md_info)<span class='macro_popup'>(sizeof(tls12_md_info)/sizeof((tls12_md_info)[0]))</span></span>; i++) {</td></tr>
<tr class="codeline" data-linenumber="3331"><td class="num" id="LN3331">3331</td><td class="line">        <span class='keyword'>if</span> (tls12_md_info[i].tlsext_hash == hash_alg)</td></tr>
<tr class="codeline" data-linenumber="3332"><td class="num" id="LN3332">3332</td><td class="line">            <span class='keyword'>return</span> tls12_md_info + i;</td></tr>
<tr class="codeline" data-linenumber="3333"><td class="num" id="LN3333">3333</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3334"><td class="num" id="LN3334">3334</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3335"><td class="num" id="LN3335">3335</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3336"><td class="num" id="LN3336">3336</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3337"><td class="num" id="LN3337">3337</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3338"><td class="num" id="LN3338">3338</td><td class="line"><span class='keyword'>const</span> EVP_MD *tls12_get_hash(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> hash_alg)</td></tr>
<tr class="codeline" data-linenumber="3339"><td class="num" id="LN3339">3339</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3340"><td class="num" id="LN3340">3340</td><td class="line">    <span class='keyword'>const</span> tls12_hash_info *inf;</td></tr>
<tr class="codeline" data-linenumber="3341"><td class="num" id="LN3341">3341</td><td class="line">    <span class='keyword'>if</span> (hash_alg == <span class='macro'>TLSEXT_hash_md5<span class='macro_popup'>1</span></span> &amp;&amp; FIPS_mode())</td></tr>
<tr class="codeline" data-linenumber="3342"><td class="num" id="LN3342">3342</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3343"><td class="num" id="LN3343">3343</td><td class="line">    inf = tls12_get_hash_info(hash_alg);</td></tr>
<tr class="codeline" data-linenumber="3344"><td class="num" id="LN3344">3344</td><td class="line">    <span class='keyword'>if</span> (!inf)</td></tr>
<tr class="codeline" data-linenumber="3345"><td class="num" id="LN3345">3345</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3346"><td class="num" id="LN3346">3346</td><td class="line">    <span class='keyword'>return</span> ssl_md(inf-&gt;md_idx);</td></tr>
<tr class="codeline" data-linenumber="3347"><td class="num" id="LN3347">3347</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3348"><td class="num" id="LN3348">3348</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3349"><td class="num" id="LN3349">3349</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls12_get_pkey_idx(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> sig_alg)</td></tr>
<tr class="codeline" data-linenumber="3350"><td class="num" id="LN3350">3350</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3351"><td class="num" id="LN3351">3351</td><td class="line">    <span class='keyword'>switch</span> (sig_alg) {</td></tr>
<tr class="codeline" data-linenumber="3352"><td class="num" id="LN3352">3352</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_RSA</span></td></tr>
<tr class="codeline" data-linenumber="3353"><td class="num" id="LN3353">3353</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>TLSEXT_signature_rsa<span class='macro_popup'>1</span></span>:</td></tr>
<tr class="codeline" data-linenumber="3354"><td class="num" id="LN3354">3354</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>SSL_PKEY_RSA_SIGN<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3355"><td class="num" id="LN3355">3355</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3356"><td class="num" id="LN3356">3356</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_DSA</span></td></tr>
<tr class="codeline" data-linenumber="3357"><td class="num" id="LN3357">3357</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>TLSEXT_signature_dsa<span class='macro_popup'>2</span></span>:</td></tr>
<tr class="codeline" data-linenumber="3358"><td class="num" id="LN3358">3358</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>SSL_PKEY_DSA_SIGN<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3359"><td class="num" id="LN3359">3359</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3360"><td class="num" id="LN3360">3360</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="3361"><td class="num" id="LN3361">3361</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>TLSEXT_signature_ecdsa<span class='macro_popup'>3</span></span>:</td></tr>
<tr class="codeline" data-linenumber="3362"><td class="num" id="LN3362">3362</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>SSL_PKEY_ECC<span class='macro_popup'>3</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3363"><td class="num" id="LN3363">3363</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3364"><td class="num" id="LN3364">3364</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_GOST</span></td></tr>
<tr class="codeline" data-linenumber="3365"><td class="num" id="LN3365">3365</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>TLSEXT_signature_gostr34102001<span class='macro_popup'>237</span></span>:</td></tr>
<tr class="codeline" data-linenumber="3366"><td class="num" id="LN3366">3366</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>SSL_PKEY_GOST01<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3367"><td class="num" id="LN3367">3367</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3368"><td class="num" id="LN3368">3368</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>TLSEXT_signature_gostr34102012_256<span class='macro_popup'>238</span></span>:</td></tr>
<tr class="codeline" data-linenumber="3369"><td class="num" id="LN3369">3369</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>SSL_PKEY_GOST12_256<span class='macro_popup'>5</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3370"><td class="num" id="LN3370">3370</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3371"><td class="num" id="LN3371">3371</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>TLSEXT_signature_gostr34102012_512<span class='macro_popup'>239</span></span>:</td></tr>
<tr class="codeline" data-linenumber="3372"><td class="num" id="LN3372">3372</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>SSL_PKEY_GOST12_512<span class='macro_popup'>6</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3373"><td class="num" id="LN3373">3373</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3374"><td class="num" id="LN3374">3374</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3375"><td class="num" id="LN3375">3375</td><td class="line">    <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="3376"><td class="num" id="LN3376">3376</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3377"><td class="num" id="LN3377">3377</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3378"><td class="num" id="LN3378">3378</td><td class="line"><span class='comment'>/* Convert TLS 1.2 signature algorithm extension values into NIDs */</span></td></tr>
<tr class="codeline" data-linenumber="3379"><td class="num" id="LN3379">3379</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> tls1_lookup_sigalg(<span class='keyword'>int</span> *phash_nid, <span class='keyword'>int</span> *psign_nid,</td></tr>
<tr class="codeline" data-linenumber="3380"><td class="num" id="LN3380">3380</td><td class="line">                               <span class='keyword'>int</span> *psignhash_nid, <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *data)</td></tr>
<tr class="codeline" data-linenumber="3381"><td class="num" id="LN3381">3381</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3382"><td class="num" id="LN3382">3382</td><td class="line">    <span class='keyword'>int</span> sign_nid = <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>, hash_nid = <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3383"><td class="num" id="LN3383">3383</td><td class="line">    <span class='keyword'>if</span> (!phash_nid &amp;&amp; !psign_nid &amp;&amp; !psignhash_nid)</td></tr>
<tr class="codeline" data-linenumber="3384"><td class="num" id="LN3384">3384</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="3385"><td class="num" id="LN3385">3385</td><td class="line">    <span class='keyword'>if</span> (phash_nid || psignhash_nid) {</td></tr>
<tr class="codeline" data-linenumber="3386"><td class="num" id="LN3386">3386</td><td class="line">        hash_nid = tls12_find_nid(data[0], tls12_md, <span class='macro'>OSSL_NELEM(tls12_md)<span class='macro_popup'>(sizeof(tls12_md)/sizeof((tls12_md)[0]))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3387"><td class="num" id="LN3387">3387</td><td class="line">        <span class='keyword'>if</span> (phash_nid)</td></tr>
<tr class="codeline" data-linenumber="3388"><td class="num" id="LN3388">3388</td><td class="line">            *phash_nid = hash_nid;</td></tr>
<tr class="codeline" data-linenumber="3389"><td class="num" id="LN3389">3389</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3390"><td class="num" id="LN3390">3390</td><td class="line">    <span class='keyword'>if</span> (psign_nid || psignhash_nid) {</td></tr>
<tr class="codeline" data-linenumber="3391"><td class="num" id="LN3391">3391</td><td class="line">        sign_nid = tls12_find_nid(data[1], tls12_sig, <span class='macro'>OSSL_NELEM(tls12_sig)<span class='macro_popup'>(sizeof(tls12_sig)/sizeof((tls12_sig)[0]))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3392"><td class="num" id="LN3392">3392</td><td class="line">        <span class='keyword'>if</span> (psign_nid)</td></tr>
<tr class="codeline" data-linenumber="3393"><td class="num" id="LN3393">3393</td><td class="line">            *psign_nid = sign_nid;</td></tr>
<tr class="codeline" data-linenumber="3394"><td class="num" id="LN3394">3394</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3395"><td class="num" id="LN3395">3395</td><td class="line">    <span class='keyword'>if</span> (psignhash_nid) {</td></tr>
<tr class="codeline" data-linenumber="3396"><td class="num" id="LN3396">3396</td><td class="line">        <span class='keyword'>if</span> (sign_nid == <span class='macro'>NID_undef<span class='macro_popup'>0</span></span> || hash_nid == <span class='macro'>NID_undef<span class='macro_popup'>0</span></span></td></tr>
<tr class="codeline" data-linenumber="3397"><td class="num" id="LN3397">3397</td><td class="line">            || OBJ_find_sigid_by_algs(psignhash_nid, hash_nid, sign_nid) &lt;= 0)</td></tr>
<tr class="codeline" data-linenumber="3398"><td class="num" id="LN3398">3398</td><td class="line">            *psignhash_nid = <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3399"><td class="num" id="LN3399">3399</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3400"><td class="num" id="LN3400">3400</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3401"><td class="num" id="LN3401">3401</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3402"><td class="num" id="LN3402">3402</td><td class="line"><span class='comment'>/* Check to see if a signature algorithm is allowed */</span></td></tr>
<tr class="codeline" data-linenumber="3403"><td class="num" id="LN3403">3403</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls12_sigalg_allowed(SSL *s, <span class='keyword'>int</span> op, <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *ptmp)</td></tr>
<tr class="codeline" data-linenumber="3404"><td class="num" id="LN3404">3404</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3405"><td class="num" id="LN3405">3405</td><td class="line">    <span class='comment'>/* See if we have an entry in the hash table and it is enabled */</span></td></tr>
<tr class="codeline" data-linenumber="3406"><td class="num" id="LN3406">3406</td><td class="line">    <span class='keyword'>const</span> tls12_hash_info *hinf = tls12_get_hash_info(ptmp[0]);</td></tr>
<tr class="codeline" data-linenumber="3407"><td class="num" id="LN3407">3407</td><td class="line">    <span class='keyword'>if</span> (hinf == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || ssl_md(hinf-&gt;md_idx) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3408"><td class="num" id="LN3408">3408</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3409"><td class="num" id="LN3409">3409</td><td class="line">    <span class='comment'>/* See if public key algorithm allowed */</span></td></tr>
<tr class="codeline" data-linenumber="3410"><td class="num" id="LN3410">3410</td><td class="line">    <span class='keyword'>if</span> (tls12_get_pkey_idx(ptmp[1]) == -1)</td></tr>
<tr class="codeline" data-linenumber="3411"><td class="num" id="LN3411">3411</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3412"><td class="num" id="LN3412">3412</td><td class="line">    <span class='comment'>/* Finally see if security callback allows it */</span></td></tr>
<tr class="codeline" data-linenumber="3413"><td class="num" id="LN3413">3413</td><td class="line">    <span class='keyword'>return</span> ssl_security(s, op, hinf-&gt;secbits, hinf-&gt;nid, (<span class='keyword'>void</span> *)ptmp);</td></tr>
<tr class="codeline" data-linenumber="3414"><td class="num" id="LN3414">3414</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3415"><td class="num" id="LN3415">3415</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3416"><td class="num" id="LN3416">3416</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3417"><td class="num" id="LN3417">3417</td><td class="line"> <span class='comment'>* Get a mask of disabled public key algorithms based on supported signature</span></td></tr>
<tr class="codeline" data-linenumber="3418"><td class="num" id="LN3418">3418</td><td class="line"> <span class='comment'>* algorithms. For example if no signature algorithm supports RSA then RSA is</span></td></tr>
<tr class="codeline" data-linenumber="3419"><td class="num" id="LN3419">3419</td><td class="line"> <span class='comment'>* disabled.</span></td></tr>
<tr class="codeline" data-linenumber="3420"><td class="num" id="LN3420">3420</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3421"><td class="num" id="LN3421">3421</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3422"><td class="num" id="LN3422">3422</td><td class="line"><span class='keyword'>void</span> ssl_set_sig_mask(uint32_t *pmask_a, SSL *s, <span class='keyword'>int</span> op)</td></tr>
<tr class="codeline" data-linenumber="3423"><td class="num" id="LN3423">3423</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3424"><td class="num" id="LN3424">3424</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *sigalgs;</td></tr>
<tr class="codeline" data-linenumber="3425"><td class="num" id="LN3425">3425</td><td class="line">    size_t i, sigalgslen;</td></tr>
<tr class="codeline" data-linenumber="3426"><td class="num" id="LN3426">3426</td><td class="line">    <span class='keyword'>int</span> have_rsa = 0, have_dsa = 0, have_ecdsa = 0;</td></tr>
<tr class="codeline" data-linenumber="3427"><td class="num" id="LN3427">3427</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3428"><td class="num" id="LN3428">3428</td><td class="line">     <span class='comment'>* Now go through all signature algorithms seeing if we support any for</span></td></tr>
<tr class="codeline" data-linenumber="3429"><td class="num" id="LN3429">3429</td><td class="line">     <span class='comment'>* RSA, DSA, ECDSA. Do this for all versions not just TLS 1.2. To keep</span></td></tr>
<tr class="codeline" data-linenumber="3430"><td class="num" id="LN3430">3430</td><td class="line">     <span class='comment'>* down calls to security callback only check if we have to.</span></td></tr>
<tr class="codeline" data-linenumber="3431"><td class="num" id="LN3431">3431</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3432"><td class="num" id="LN3432">3432</td><td class="line">    sigalgslen = tls12_get_psigalgs(s, 1, &amp;sigalgs);</td></tr>
<tr class="codeline" data-linenumber="3433"><td class="num" id="LN3433">3433</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; sigalgslen; i += 2, sigalgs += 2) {</td></tr>
<tr class="codeline" data-linenumber="3434"><td class="num" id="LN3434">3434</td><td class="line">        <span class='keyword'>switch</span> (sigalgs[1]) {</td></tr>
<tr class="codeline" data-linenumber="3435"><td class="num" id="LN3435">3435</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_RSA</span></td></tr>
<tr class="codeline" data-linenumber="3436"><td class="num" id="LN3436">3436</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>TLSEXT_signature_rsa<span class='macro_popup'>1</span></span>:</td></tr>
<tr class="codeline" data-linenumber="3437"><td class="num" id="LN3437">3437</td><td class="line">            <span class='keyword'>if</span> (!have_rsa &amp;&amp; tls12_sigalg_allowed(s, op, sigalgs))</td></tr>
<tr class="codeline" data-linenumber="3438"><td class="num" id="LN3438">3438</td><td class="line">                have_rsa = 1;</td></tr>
<tr class="codeline" data-linenumber="3439"><td class="num" id="LN3439">3439</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3440"><td class="num" id="LN3440">3440</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3441"><td class="num" id="LN3441">3441</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_DSA</span></td></tr>
<tr class="codeline" data-linenumber="3442"><td class="num" id="LN3442">3442</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>TLSEXT_signature_dsa<span class='macro_popup'>2</span></span>:</td></tr>
<tr class="codeline" data-linenumber="3443"><td class="num" id="LN3443">3443</td><td class="line">            <span class='keyword'>if</span> (!have_dsa &amp;&amp; tls12_sigalg_allowed(s, op, sigalgs))</td></tr>
<tr class="codeline" data-linenumber="3444"><td class="num" id="LN3444">3444</td><td class="line">                have_dsa = 1;</td></tr>
<tr class="codeline" data-linenumber="3445"><td class="num" id="LN3445">3445</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3446"><td class="num" id="LN3446">3446</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3447"><td class="num" id="LN3447">3447</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="3448"><td class="num" id="LN3448">3448</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>TLSEXT_signature_ecdsa<span class='macro_popup'>3</span></span>:</td></tr>
<tr class="codeline" data-linenumber="3449"><td class="num" id="LN3449">3449</td><td class="line">            <span class='keyword'>if</span> (!have_ecdsa &amp;&amp; tls12_sigalg_allowed(s, op, sigalgs))</td></tr>
<tr class="codeline" data-linenumber="3450"><td class="num" id="LN3450">3450</td><td class="line">                have_ecdsa = 1;</td></tr>
<tr class="codeline" data-linenumber="3451"><td class="num" id="LN3451">3451</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3452"><td class="num" id="LN3452">3452</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3453"><td class="num" id="LN3453">3453</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3454"><td class="num" id="LN3454">3454</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3455"><td class="num" id="LN3455">3455</td><td class="line">    <span class='keyword'>if</span> (!have_rsa)</td></tr>
<tr class="codeline" data-linenumber="3456"><td class="num" id="LN3456">3456</td><td class="line">        *pmask_a |= <span class='macro'>SSL_aRSA<span class='macro_popup'>0x00000001U</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3457"><td class="num" id="LN3457">3457</td><td class="line">    <span class='keyword'>if</span> (!have_dsa)</td></tr>
<tr class="codeline" data-linenumber="3458"><td class="num" id="LN3458">3458</td><td class="line">        *pmask_a |= <span class='macro'>SSL_aDSS<span class='macro_popup'>0x00000002U</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3459"><td class="num" id="LN3459">3459</td><td class="line">    <span class='keyword'>if</span> (!have_ecdsa)</td></tr>
<tr class="codeline" data-linenumber="3460"><td class="num" id="LN3460">3460</td><td class="line">        *pmask_a |= <span class='macro'>SSL_aECDSA<span class='macro_popup'>0x00000008U</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3461"><td class="num" id="LN3461">3461</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3462"><td class="num" id="LN3462">3462</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3463"><td class="num" id="LN3463">3463</td><td class="line">size_t tls12_copy_sigalgs(SSL *s, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *out,</td></tr>
<tr class="codeline" data-linenumber="3464"><td class="num" id="LN3464">3464</td><td class="line">                          <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *psig, size_t psiglen)</td></tr>
<tr class="codeline" data-linenumber="3465"><td class="num" id="LN3465">3465</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3466"><td class="num" id="LN3466">3466</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *tmpout = out;</td></tr>
<tr class="codeline" data-linenumber="3467"><td class="num" id="LN3467">3467</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="3468"><td class="num" id="LN3468">3468</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; psiglen; i += 2, psig += 2) {</td></tr>
<tr class="codeline" data-linenumber="3469"><td class="num" id="LN3469">3469</td><td class="line">        <span class='keyword'>if</span> (tls12_sigalg_allowed(s, <span class='macro'>SSL_SECOP_SIGALG_SUPPORTED<span class='macro_popup'>(11 | (5 &lt;&lt; 16))</span></span>, psig)) {</td></tr>
<tr class="codeline" data-linenumber="3470"><td class="num" id="LN3470">3470</td><td class="line">            *tmpout++ = psig[0];</td></tr>
<tr class="codeline" data-linenumber="3471"><td class="num" id="LN3471">3471</td><td class="line">            *tmpout++ = psig[1];</td></tr>
<tr class="codeline" data-linenumber="3472"><td class="num" id="LN3472">3472</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3473"><td class="num" id="LN3473">3473</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3474"><td class="num" id="LN3474">3474</td><td class="line">    <span class='keyword'>return</span> tmpout - out;</td></tr>
<tr class="codeline" data-linenumber="3475"><td class="num" id="LN3475">3475</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3476"><td class="num" id="LN3476">3476</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3477"><td class="num" id="LN3477">3477</td><td class="line"><span class='comment'>/* Given preference and allowed sigalgs set shared sigalgs */</span></td></tr>
<tr class="codeline" data-linenumber="3478"><td class="num" id="LN3478">3478</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls12_shared_sigalgs(SSL *s, TLS_SIGALGS *shsig,</td></tr>
<tr class="codeline" data-linenumber="3479"><td class="num" id="LN3479">3479</td><td class="line">                                <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *pref, size_t preflen,</td></tr>
<tr class="codeline" data-linenumber="3480"><td class="num" id="LN3480">3480</td><td class="line">                                <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *allow, size_t allowlen)</td></tr>
<tr class="codeline" data-linenumber="3481"><td class="num" id="LN3481">3481</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3482"><td class="num" id="LN3482">3482</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *ptmp, *atmp;</td></tr>
<tr class="codeline" data-linenumber="3483"><td class="num" id="LN3483">3483</td><td class="line">    size_t i, j, nmatch = 0;</td></tr>
<tr class="codeline" data-linenumber="3484"><td class="num" id="LN3484">3484</td><td class="line">    <span class='keyword'>for</span> (i = 0, ptmp = pref; i &lt; preflen; i += 2, ptmp += 2) {</td></tr>
<tr class="codeline" data-linenumber="3485"><td class="num" id="LN3485">3485</td><td class="line">        <span class='comment'>/* Skip disabled hashes or signature algorithms */</span></td></tr>
<tr class="codeline" data-linenumber="3486"><td class="num" id="LN3486">3486</td><td class="line">        <span class='keyword'>if</span> (!tls12_sigalg_allowed(s, <span class='macro'>SSL_SECOP_SIGALG_SHARED<span class='macro_popup'>(12 | (5 &lt;&lt; 16))</span></span>, ptmp))</td></tr>
<tr class="codeline" data-linenumber="3487"><td class="num" id="LN3487">3487</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="3488"><td class="num" id="LN3488">3488</td><td class="line">        <span class='keyword'>for</span> (j = 0, atmp = allow; j &lt; allowlen; j += 2, atmp += 2) {</td></tr>
<tr class="codeline" data-linenumber="3489"><td class="num" id="LN3489">3489</td><td class="line">            <span class='keyword'>if</span> (ptmp[0] == atmp[0] &amp;&amp; ptmp[1] == atmp[1]) {</td></tr>
<tr class="codeline" data-linenumber="3490"><td class="num" id="LN3490">3490</td><td class="line">                nmatch++;</td></tr>
<tr class="codeline" data-linenumber="3491"><td class="num" id="LN3491">3491</td><td class="line">                <span class='keyword'>if</span> (shsig) {</td></tr>
<tr class="codeline" data-linenumber="3492"><td class="num" id="LN3492">3492</td><td class="line">                    shsig-&gt;rhash = ptmp[0];</td></tr>
<tr class="codeline" data-linenumber="3493"><td class="num" id="LN3493">3493</td><td class="line">                    shsig-&gt;rsign = ptmp[1];</td></tr>
<tr class="codeline" data-linenumber="3494"><td class="num" id="LN3494">3494</td><td class="line">                    tls1_lookup_sigalg(&amp;shsig-&gt;hash_nid,</td></tr>
<tr class="codeline" data-linenumber="3495"><td class="num" id="LN3495">3495</td><td class="line">                                       &amp;shsig-&gt;sign_nid,</td></tr>
<tr class="codeline" data-linenumber="3496"><td class="num" id="LN3496">3496</td><td class="line">                                       &amp;shsig-&gt;signandhash_nid, ptmp);</td></tr>
<tr class="codeline" data-linenumber="3497"><td class="num" id="LN3497">3497</td><td class="line">                    shsig++;</td></tr>
<tr class="codeline" data-linenumber="3498"><td class="num" id="LN3498">3498</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="3499"><td class="num" id="LN3499">3499</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3500"><td class="num" id="LN3500">3500</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3501"><td class="num" id="LN3501">3501</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3502"><td class="num" id="LN3502">3502</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3503"><td class="num" id="LN3503">3503</td><td class="line">    <span class='keyword'>return</span> nmatch;</td></tr>
<tr class="codeline" data-linenumber="3504"><td class="num" id="LN3504">3504</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3505"><td class="num" id="LN3505">3505</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3506"><td class="num" id="LN3506">3506</td><td class="line"><span class='comment'>/* Set shared signature algorithms for SSL structures */</span></td></tr>
<tr class="codeline" data-linenumber="3507"><td class="num" id="LN3507">3507</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls1_set_shared_sigalgs(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="3508"><td class="num" id="LN3508">3508</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3509"><td class="num" id="LN3509">3509</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *pref, *allow, *conf;</td></tr>
<tr class="codeline" data-linenumber="3510"><td class="num" id="LN3510">3510</td><td class="line">    size_t preflen, allowlen, conflen;</td></tr>
<tr class="codeline" data-linenumber="3511"><td class="num" id="LN3511">3511</td><td class="line">    size_t nmatch;</td></tr>
<tr class="codeline" data-linenumber="3512"><td class="num" id="LN3512">3512</td><td class="line">    TLS_SIGALGS *salgs = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3513"><td class="num" id="LN3513">3513</td><td class="line">    CERT *c = s-&gt;cert;</td></tr>
<tr class="codeline" data-linenumber="3514"><td class="num" id="LN3514">3514</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> is_suiteb = <span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3515"><td class="num" id="LN3515">3515</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3516"><td class="num" id="LN3516">3516</td><td class="line">    <span class='macro'>OPENSSL_free(c-&gt;shared_sigalgs)<span class='macro_popup'>CRYPTO_free(c-&gt;shared_sigalgs, "ssl/t1_lib.c", 3516)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3517"><td class="num" id="LN3517">3517</td><td class="line">    c-&gt;shared_sigalgs = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3518"><td class="num" id="LN3518">3518</td><td class="line">    c-&gt;shared_sigalgslen = 0;</td></tr>
<tr class="codeline" data-linenumber="3519"><td class="num" id="LN3519">3519</td><td class="line">    <span class='comment'>/* If client use client signature algorithms if not NULL */</span></td></tr>
<tr class="codeline" data-linenumber="3520"><td class="num" id="LN3520">3520</td><td class="line">    <span class='keyword'>if</span> (!s-&gt;server &amp;&amp; c-&gt;client_sigalgs &amp;&amp; !is_suiteb) {</td></tr>
<tr class="codeline" data-linenumber="3521"><td class="num" id="LN3521">3521</td><td class="line">        conf = c-&gt;client_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="3522"><td class="num" id="LN3522">3522</td><td class="line">        conflen = c-&gt;client_sigalgslen;</td></tr>
<tr class="codeline" data-linenumber="3523"><td class="num" id="LN3523">3523</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (c-&gt;conf_sigalgs &amp;&amp; !is_suiteb) {</td></tr>
<tr class="codeline" data-linenumber="3524"><td class="num" id="LN3524">3524</td><td class="line">        conf = c-&gt;conf_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="3525"><td class="num" id="LN3525">3525</td><td class="line">        conflen = c-&gt;conf_sigalgslen;</td></tr>
<tr class="codeline" data-linenumber="3526"><td class="num" id="LN3526">3526</td><td class="line">    } <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3527"><td class="num" id="LN3527">3527</td><td class="line">        conflen = tls12_get_psigalgs(s, 0, &amp;conf);</td></tr>
<tr class="codeline" data-linenumber="3528"><td class="num" id="LN3528">3528</td><td class="line">    <span class='keyword'>if</span> (s-&gt;options &amp; <span class='macro'>SSL_OP_CIPHER_SERVER_PREFERENCE<span class='macro_popup'>0x00400000U</span></span> || is_suiteb) {</td></tr>
<tr class="codeline" data-linenumber="3529"><td class="num" id="LN3529">3529</td><td class="line">        pref = conf;</td></tr>
<tr class="codeline" data-linenumber="3530"><td class="num" id="LN3530">3530</td><td class="line">        preflen = conflen;</td></tr>
<tr class="codeline" data-linenumber="3531"><td class="num" id="LN3531">3531</td><td class="line">        allow = s-&gt;s3-&gt;tmp.peer_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="3532"><td class="num" id="LN3532">3532</td><td class="line">        allowlen = s-&gt;s3-&gt;tmp.peer_sigalgslen;</td></tr>
<tr class="codeline" data-linenumber="3533"><td class="num" id="LN3533">3533</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3534"><td class="num" id="LN3534">3534</td><td class="line">        allow = conf;</td></tr>
<tr class="codeline" data-linenumber="3535"><td class="num" id="LN3535">3535</td><td class="line">        allowlen = conflen;</td></tr>
<tr class="codeline" data-linenumber="3536"><td class="num" id="LN3536">3536</td><td class="line">        pref = s-&gt;s3-&gt;tmp.peer_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="3537"><td class="num" id="LN3537">3537</td><td class="line">        preflen = s-&gt;s3-&gt;tmp.peer_sigalgslen;</td></tr>
<tr class="codeline" data-linenumber="3538"><td class="num" id="LN3538">3538</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3539"><td class="num" id="LN3539">3539</td><td class="line">    nmatch = tls12_shared_sigalgs(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, pref, preflen, allow, allowlen);</td></tr>
<tr class="codeline" data-linenumber="3540"><td class="num" id="LN3540">3540</td><td class="line">    <span class='keyword'>if</span> (nmatch) {</td></tr>
<tr class="codeline" data-linenumber="3541"><td class="num" id="LN3541">3541</td><td class="line">        salgs = <span class='macro'>OPENSSL_malloc(nmatch * <span class='keyword'>sizeof</span>(TLS_SIGALGS))<span class='macro_popup'>CRYPTO_malloc(nmatch * sizeof(TLS_SIGALGS), "ssl/t1_lib.c", 3541<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3542"><td class="num" id="LN3542">3542</td><td class="line">        <span class='keyword'>if</span> (salgs == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3543"><td class="num" id="LN3543">3543</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3544"><td class="num" id="LN3544">3544</td><td class="line">        nmatch = tls12_shared_sigalgs(s, salgs, pref, preflen, allow, allowlen);</td></tr>
<tr class="codeline" data-linenumber="3545"><td class="num" id="LN3545">3545</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3546"><td class="num" id="LN3546">3546</td><td class="line">        salgs = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3547"><td class="num" id="LN3547">3547</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3548"><td class="num" id="LN3548">3548</td><td class="line">    c-&gt;shared_sigalgs = salgs;</td></tr>
<tr class="codeline" data-linenumber="3549"><td class="num" id="LN3549">3549</td><td class="line">    c-&gt;shared_sigalgslen = nmatch;</td></tr>
<tr class="codeline" data-linenumber="3550"><td class="num" id="LN3550">3550</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="3551"><td class="num" id="LN3551">3551</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3552"><td class="num" id="LN3552">3552</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3553"><td class="num" id="LN3553">3553</td><td class="line"><span class='comment'>/* Set preferred digest for each key type */</span></td></tr>
<tr class="codeline" data-linenumber="3554"><td class="num" id="LN3554">3554</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3555"><td class="num" id="LN3555">3555</td><td class="line"><span class='keyword'>int</span> tls1_save_sigalgs(SSL *s, <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *data, <span class='keyword'>int</span> dsize)</td></tr>
<tr class="codeline" data-linenumber="3556"><td class="num" id="LN3556">3556</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3557"><td class="num" id="LN3557">3557</td><td class="line">    CERT *c = s-&gt;cert;</td></tr>
<tr class="codeline" data-linenumber="3558"><td class="num" id="LN3558">3558</td><td class="line">    <span class='comment'>/* Extension ignored for inappropriate versions */</span></td></tr>
<tr class="codeline" data-linenumber="3559"><td class="num" id="LN3559">3559</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>SSL_USE_SIGALGS(s)<span class='macro_popup'>(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x2)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3560"><td class="num" id="LN3560">3560</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="3561"><td class="num" id="LN3561">3561</td><td class="line">    <span class='comment'>/* Should never happen */</span></td></tr>
<tr class="codeline" data-linenumber="3562"><td class="num" id="LN3562">3562</td><td class="line">    <span class='keyword'>if</span> (!c)</td></tr>
<tr class="codeline" data-linenumber="3563"><td class="num" id="LN3563">3563</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3564"><td class="num" id="LN3564">3564</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3565"><td class="num" id="LN3565">3565</td><td class="line">    <span class='macro'>OPENSSL_free(s-&gt;s3-&gt;tmp.peer_sigalgs)<span class='macro_popup'>CRYPTO_free(s-&gt;s3-&gt;tmp.peer_sigalgs, "ssl/t1_lib.c", 3565<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3566"><td class="num" id="LN3566">3566</td><td class="line">    s-&gt;s3-&gt;tmp.peer_sigalgs = <span class='macro'>OPENSSL_malloc(dsize)<span class='macro_popup'>CRYPTO_malloc(dsize, "ssl/t1_lib.c", 3566)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3567"><td class="num" id="LN3567">3567</td><td class="line">    <span class='keyword'>if</span> (s-&gt;s3-&gt;tmp.peer_sigalgs == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3568"><td class="num" id="LN3568">3568</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3569"><td class="num" id="LN3569">3569</td><td class="line">    s-&gt;s3-&gt;tmp.peer_sigalgslen = dsize;</td></tr>
<tr class="codeline" data-linenumber="3570"><td class="num" id="LN3570">3570</td><td class="line">    memcpy(s-&gt;s3-&gt;tmp.peer_sigalgs, data, dsize);</td></tr>
<tr class="codeline" data-linenumber="3571"><td class="num" id="LN3571">3571</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="3572"><td class="num" id="LN3572">3572</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3573"><td class="num" id="LN3573">3573</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3574"><td class="num" id="LN3574">3574</td><td class="line"><span class='keyword'>int</span> tls1_process_sigalgs(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="3575"><td class="num" id="LN3575">3575</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3576"><td class="num" id="LN3576">3576</td><td class="line">    <span class='keyword'>int</span> idx;</td></tr>
<tr class="codeline" data-linenumber="3577"><td class="num" id="LN3577">3577</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="3578"><td class="num" id="LN3578">3578</td><td class="line">    <span class='keyword'>const</span> EVP_MD *md;</td></tr>
<tr class="codeline" data-linenumber="3579"><td class="num" id="LN3579">3579</td><td class="line">    <span class='keyword'>const</span> EVP_MD **pmd = s-&gt;s3-&gt;tmp.md;</td></tr>
<tr class="codeline" data-linenumber="3580"><td class="num" id="LN3580">3580</td><td class="line">    uint32_t *pvalid = s-&gt;s3-&gt;tmp.valid_flags;</td></tr>
<tr class="codeline" data-linenumber="3581"><td class="num" id="LN3581">3581</td><td class="line">    CERT *c = s-&gt;cert;</td></tr>
<tr class="codeline" data-linenumber="3582"><td class="num" id="LN3582">3582</td><td class="line">    TLS_SIGALGS *sigptr;</td></tr>
<tr class="codeline" data-linenumber="3583"><td class="num" id="LN3583">3583</td><td class="line">    <span class='keyword'>if</span> (!tls1_set_shared_sigalgs(s))</td></tr>
<tr class="codeline" data-linenumber="3584"><td class="num" id="LN3584">3584</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3585"><td class="num" id="LN3585">3585</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3586"><td class="num" id="LN3586">3586</td><td class="line">    <span class='keyword'>for</span> (i = 0, sigptr = c-&gt;shared_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="3587"><td class="num" id="LN3587">3587</td><td class="line">         i &lt; c-&gt;shared_sigalgslen; i++, sigptr++) {</td></tr>
<tr class="codeline" data-linenumber="3588"><td class="num" id="LN3588">3588</td><td class="line">        idx = tls12_get_pkey_idx(sigptr-&gt;rsign);</td></tr>
<tr class="codeline" data-linenumber="3589"><td class="num" id="LN3589">3589</td><td class="line">        <span class='keyword'>if</span> (idx &gt; 0 &amp;&amp; pmd[idx] == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3590"><td class="num" id="LN3590">3590</td><td class="line">            md = tls12_get_hash(sigptr-&gt;rhash);</td></tr>
<tr class="codeline" data-linenumber="3591"><td class="num" id="LN3591">3591</td><td class="line">            pmd[idx] = md;</td></tr>
<tr class="codeline" data-linenumber="3592"><td class="num" id="LN3592">3592</td><td class="line">            pvalid[idx] = <span class='macro'>CERT_PKEY_EXPLICIT_SIGN<span class='macro_popup'>0x100</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3593"><td class="num" id="LN3593">3593</td><td class="line">            <span class='keyword'>if</span> (idx == <span class='macro'>SSL_PKEY_RSA_SIGN<span class='macro_popup'>1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3594"><td class="num" id="LN3594">3594</td><td class="line">                pvalid[<span class='macro'>SSL_PKEY_RSA_ENC<span class='macro_popup'>0</span></span>] = <span class='macro'>CERT_PKEY_EXPLICIT_SIGN<span class='macro_popup'>0x100</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3595"><td class="num" id="LN3595">3595</td><td class="line">                pmd[<span class='macro'>SSL_PKEY_RSA_ENC<span class='macro_popup'>0</span></span>] = md;</td></tr>
<tr class="codeline" data-linenumber="3596"><td class="num" id="LN3596">3596</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3597"><td class="num" id="LN3597">3597</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3598"><td class="num" id="LN3598">3598</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3599"><td class="num" id="LN3599">3599</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3600"><td class="num" id="LN3600">3600</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3601"><td class="num" id="LN3601">3601</td><td class="line">     <span class='comment'>* In strict mode leave unset digests as NULL to indicate we can't use</span></td></tr>
<tr class="codeline" data-linenumber="3602"><td class="num" id="LN3602">3602</td><td class="line">     <span class='comment'>* the certificate for signing.</span></td></tr>
<tr class="codeline" data-linenumber="3603"><td class="num" id="LN3603">3603</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3604"><td class="num" id="LN3604">3604</td><td class="line">    <span class='keyword'>if</span> (!(s-&gt;cert-&gt;cert_flags &amp; <span class='macro'>SSL_CERT_FLAGS_CHECK_TLS_STRICT<span class='macro_popup'>(0x30000|0x00000001U)</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="3605"><td class="num" id="LN3605">3605</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3606"><td class="num" id="LN3606">3606</td><td class="line">         <span class='comment'>* Set any remaining keys to default values. NOTE: if alg is not</span></td></tr>
<tr class="codeline" data-linenumber="3607"><td class="num" id="LN3607">3607</td><td class="line">         <span class='comment'>* supported it stays as NULL.</span></td></tr>
<tr class="codeline" data-linenumber="3608"><td class="num" id="LN3608">3608</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3609"><td class="num" id="LN3609">3609</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_DSA</span></td></tr>
<tr class="codeline" data-linenumber="3610"><td class="num" id="LN3610">3610</td><td class="line">        <span class='keyword'>if</span> (pmd[<span class='macro'>SSL_PKEY_DSA_SIGN<span class='macro_popup'>2</span></span>] == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3611"><td class="num" id="LN3611">3611</td><td class="line">            pmd[<span class='macro'>SSL_PKEY_DSA_SIGN<span class='macro_popup'>2</span></span>] = EVP_sha1();</td></tr>
<tr class="codeline" data-linenumber="3612"><td class="num" id="LN3612">3612</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3613"><td class="num" id="LN3613">3613</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_RSA</span></td></tr>
<tr class="codeline" data-linenumber="3614"><td class="num" id="LN3614">3614</td><td class="line">        <span class='keyword'>if</span> (pmd[<span class='macro'>SSL_PKEY_RSA_SIGN<span class='macro_popup'>1</span></span>] == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3615"><td class="num" id="LN3615">3615</td><td class="line">            pmd[<span class='macro'>SSL_PKEY_RSA_SIGN<span class='macro_popup'>1</span></span>] = EVP_sha1();</td></tr>
<tr class="codeline" data-linenumber="3616"><td class="num" id="LN3616">3616</td><td class="line">            pmd[<span class='macro'>SSL_PKEY_RSA_ENC<span class='macro_popup'>0</span></span>] = EVP_sha1();</td></tr>
<tr class="codeline" data-linenumber="3617"><td class="num" id="LN3617">3617</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3618"><td class="num" id="LN3618">3618</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3619"><td class="num" id="LN3619">3619</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="3620"><td class="num" id="LN3620">3620</td><td class="line">        <span class='keyword'>if</span> (pmd[<span class='macro'>SSL_PKEY_ECC<span class='macro_popup'>3</span></span>] == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3621"><td class="num" id="LN3621">3621</td><td class="line">            pmd[<span class='macro'>SSL_PKEY_ECC<span class='macro_popup'>3</span></span>] = EVP_sha1();</td></tr>
<tr class="codeline" data-linenumber="3622"><td class="num" id="LN3622">3622</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3623"><td class="num" id="LN3623">3623</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_GOST</span></td></tr>
<tr class="codeline" data-linenumber="3624"><td class="num" id="LN3624">3624</td><td class="line">        <span class='keyword'>if</span> (pmd[<span class='macro'>SSL_PKEY_GOST01<span class='macro_popup'>4</span></span>] == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3625"><td class="num" id="LN3625">3625</td><td class="line">            pmd[<span class='macro'>SSL_PKEY_GOST01<span class='macro_popup'>4</span></span>] = <span class='macro'>EVP_get_digestbynid(NID_id_GostR3411_94)<span class='macro_popup'>EVP_get_digestbyname(OBJ_nid2sn(809))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3626"><td class="num" id="LN3626">3626</td><td class="line">        <span class='keyword'>if</span> (pmd[<span class='macro'>SSL_PKEY_GOST12_256<span class='macro_popup'>5</span></span>] == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3627"><td class="num" id="LN3627">3627</td><td class="line">            pmd[<span class='macro'>SSL_PKEY_GOST12_256<span class='macro_popup'>5</span></span>] =</td></tr>
<tr class="codeline" data-linenumber="3628"><td class="num" id="LN3628">3628</td><td class="line">                <span class='macro'>EVP_get_digestbynid(NID_id_GostR3411_2012_256)<span class='macro_popup'>EVP_get_digestbyname(OBJ_nid2sn(982))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3629"><td class="num" id="LN3629">3629</td><td class="line">        <span class='keyword'>if</span> (pmd[<span class='macro'>SSL_PKEY_GOST12_512<span class='macro_popup'>6</span></span>] == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3630"><td class="num" id="LN3630">3630</td><td class="line">            pmd[<span class='macro'>SSL_PKEY_GOST12_512<span class='macro_popup'>6</span></span>] =</td></tr>
<tr class="codeline" data-linenumber="3631"><td class="num" id="LN3631">3631</td><td class="line">                <span class='macro'>EVP_get_digestbynid(NID_id_GostR3411_2012_512)<span class='macro_popup'>EVP_get_digestbyname(OBJ_nid2sn(983))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3632"><td class="num" id="LN3632">3632</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3633"><td class="num" id="LN3633">3633</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3634"><td class="num" id="LN3634">3634</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="3635"><td class="num" id="LN3635">3635</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3636"><td class="num" id="LN3636">3636</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3637"><td class="num" id="LN3637">3637</td><td class="line"><span class='keyword'>int</span> SSL_get_sigalgs(SSL *s, <span class='keyword'>int</span> idx,</td></tr>
<tr class="codeline" data-linenumber="3638"><td class="num" id="LN3638">3638</td><td class="line">                    <span class='keyword'>int</span> *psign, <span class='keyword'>int</span> *phash, <span class='keyword'>int</span> *psignhash,</td></tr>
<tr class="codeline" data-linenumber="3639"><td class="num" id="LN3639">3639</td><td class="line">                    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *rsig, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *rhash)</td></tr>
<tr class="codeline" data-linenumber="3640"><td class="num" id="LN3640">3640</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3641"><td class="num" id="LN3641">3641</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *psig = s-&gt;s3-&gt;tmp.peer_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="3642"><td class="num" id="LN3642">3642</td><td class="line">    <span class='keyword'>if</span> (psig == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3643"><td class="num" id="LN3643">3643</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3644"><td class="num" id="LN3644">3644</td><td class="line">    <span class='keyword'>if</span> (idx &gt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="3645"><td class="num" id="LN3645">3645</td><td class="line">        idx &lt;&lt;= 1;</td></tr>
<tr class="codeline" data-linenumber="3646"><td class="num" id="LN3646">3646</td><td class="line">        <span class='keyword'>if</span> (idx &gt;= (<span class='keyword'>int</span>)s-&gt;s3-&gt;tmp.peer_sigalgslen)</td></tr>
<tr class="codeline" data-linenumber="3647"><td class="num" id="LN3647">3647</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3648"><td class="num" id="LN3648">3648</td><td class="line">        psig += idx;</td></tr>
<tr class="codeline" data-linenumber="3649"><td class="num" id="LN3649">3649</td><td class="line">        <span class='keyword'>if</span> (rhash)</td></tr>
<tr class="codeline" data-linenumber="3650"><td class="num" id="LN3650">3650</td><td class="line">            *rhash = psig[0];</td></tr>
<tr class="codeline" data-linenumber="3651"><td class="num" id="LN3651">3651</td><td class="line">        <span class='keyword'>if</span> (rsig)</td></tr>
<tr class="codeline" data-linenumber="3652"><td class="num" id="LN3652">3652</td><td class="line">            *rsig = psig[1];</td></tr>
<tr class="codeline" data-linenumber="3653"><td class="num" id="LN3653">3653</td><td class="line">        tls1_lookup_sigalg(phash, psign, psignhash, psig);</td></tr>
<tr class="codeline" data-linenumber="3654"><td class="num" id="LN3654">3654</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3655"><td class="num" id="LN3655">3655</td><td class="line">    <span class='keyword'>return</span> s-&gt;s3-&gt;tmp.peer_sigalgslen / 2;</td></tr>
<tr class="codeline" data-linenumber="3656"><td class="num" id="LN3656">3656</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3657"><td class="num" id="LN3657">3657</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3658"><td class="num" id="LN3658">3658</td><td class="line"><span class='keyword'>int</span> SSL_get_shared_sigalgs(SSL *s, <span class='keyword'>int</span> idx,</td></tr>
<tr class="codeline" data-linenumber="3659"><td class="num" id="LN3659">3659</td><td class="line">                           <span class='keyword'>int</span> *psign, <span class='keyword'>int</span> *phash, <span class='keyword'>int</span> *psignhash,</td></tr>
<tr class="codeline" data-linenumber="3660"><td class="num" id="LN3660">3660</td><td class="line">                           <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *rsig, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *rhash)</td></tr>
<tr class="codeline" data-linenumber="3661"><td class="num" id="LN3661">3661</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3662"><td class="num" id="LN3662">3662</td><td class="line">    TLS_SIGALGS *shsigalgs = s-&gt;cert-&gt;shared_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="3663"><td class="num" id="LN3663">3663</td><td class="line">    <span class='keyword'>if</span> (!shsigalgs || idx &gt;= (<span class='keyword'>int</span>)s-&gt;cert-&gt;shared_sigalgslen)</td></tr>
<tr class="codeline" data-linenumber="3664"><td class="num" id="LN3664">3664</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3665"><td class="num" id="LN3665">3665</td><td class="line">    shsigalgs += idx;</td></tr>
<tr class="codeline" data-linenumber="3666"><td class="num" id="LN3666">3666</td><td class="line">    <span class='keyword'>if</span> (phash)</td></tr>
<tr class="codeline" data-linenumber="3667"><td class="num" id="LN3667">3667</td><td class="line">        *phash = shsigalgs-&gt;hash_nid;</td></tr>
<tr class="codeline" data-linenumber="3668"><td class="num" id="LN3668">3668</td><td class="line">    <span class='keyword'>if</span> (psign)</td></tr>
<tr class="codeline" data-linenumber="3669"><td class="num" id="LN3669">3669</td><td class="line">        *psign = shsigalgs-&gt;sign_nid;</td></tr>
<tr class="codeline" data-linenumber="3670"><td class="num" id="LN3670">3670</td><td class="line">    <span class='keyword'>if</span> (psignhash)</td></tr>
<tr class="codeline" data-linenumber="3671"><td class="num" id="LN3671">3671</td><td class="line">        *psignhash = shsigalgs-&gt;signandhash_nid;</td></tr>
<tr class="codeline" data-linenumber="3672"><td class="num" id="LN3672">3672</td><td class="line">    <span class='keyword'>if</span> (rsig)</td></tr>
<tr class="codeline" data-linenumber="3673"><td class="num" id="LN3673">3673</td><td class="line">        *rsig = shsigalgs-&gt;rsign;</td></tr>
<tr class="codeline" data-linenumber="3674"><td class="num" id="LN3674">3674</td><td class="line">    <span class='keyword'>if</span> (rhash)</td></tr>
<tr class="codeline" data-linenumber="3675"><td class="num" id="LN3675">3675</td><td class="line">        *rhash = shsigalgs-&gt;rhash;</td></tr>
<tr class="codeline" data-linenumber="3676"><td class="num" id="LN3676">3676</td><td class="line">    <span class='keyword'>return</span> s-&gt;cert-&gt;shared_sigalgslen;</td></tr>
<tr class="codeline" data-linenumber="3677"><td class="num" id="LN3677">3677</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3678"><td class="num" id="LN3678">3678</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3679"><td class="num" id="LN3679">3679</td><td class="line"><span class='directive'>#define <span class='macro'>MAX_SIGALGLEN<span class='macro_popup'>(10 * 7 * 2)</span></span>   (<span class='macro'>TLSEXT_hash_num<span class='macro_popup'>10</span></span> * <span class='macro'>TLSEXT_signature_num<span class='macro_popup'>7</span></span> * 2)</span></td></tr>
<tr class="codeline" data-linenumber="3680"><td class="num" id="LN3680">3680</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3681"><td class="num" id="LN3681">3681</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> {</td></tr>
<tr class="codeline" data-linenumber="3682"><td class="num" id="LN3682">3682</td><td class="line">    size_t sigalgcnt;</td></tr>
<tr class="codeline" data-linenumber="3683"><td class="num" id="LN3683">3683</td><td class="line">    <span class='keyword'>int</span> sigalgs[<span class='macro'>MAX_SIGALGLEN<span class='macro_popup'>(10 * 7 * 2)</span></span>];</td></tr>
<tr class="codeline" data-linenumber="3684"><td class="num" id="LN3684">3684</td><td class="line">} sig_cb_st;</td></tr>
<tr class="codeline" data-linenumber="3685"><td class="num" id="LN3685">3685</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3686"><td class="num" id="LN3686">3686</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> get_sigorhash(<span class='keyword'>int</span> *psig, <span class='keyword'>int</span> *phash, <span class='keyword'>const</span> <span class='keyword'>char</span> *str)</td></tr>
<tr class="codeline" data-linenumber="3687"><td class="num" id="LN3687">3687</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3688"><td class="num" id="LN3688">3688</td><td class="line">    <span class='keyword'>if</span> (strcmp(str, <span class='string_literal'>"RSA"</span>) == 0) {</td></tr>
<tr class="codeline" data-linenumber="3689"><td class="num" id="LN3689">3689</td><td class="line">        *psig = <span class='macro'>EVP_PKEY_RSA<span class='macro_popup'>6</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3690"><td class="num" id="LN3690">3690</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (strcmp(str, <span class='string_literal'>"DSA"</span>) == 0) {</td></tr>
<tr class="codeline" data-linenumber="3691"><td class="num" id="LN3691">3691</td><td class="line">        *psig = <span class='macro'>EVP_PKEY_DSA<span class='macro_popup'>116</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3692"><td class="num" id="LN3692">3692</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (strcmp(str, <span class='string_literal'>"ECDSA"</span>) == 0) {</td></tr>
<tr class="codeline" data-linenumber="3693"><td class="num" id="LN3693">3693</td><td class="line">        *psig = <span class='macro'>EVP_PKEY_EC<span class='macro_popup'>408</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3694"><td class="num" id="LN3694">3694</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3695"><td class="num" id="LN3695">3695</td><td class="line">        *phash = OBJ_sn2nid(str);</td></tr>
<tr class="codeline" data-linenumber="3696"><td class="num" id="LN3696">3696</td><td class="line">        <span class='keyword'>if</span> (*phash == <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3697"><td class="num" id="LN3697">3697</td><td class="line">            *phash = OBJ_ln2nid(str);</td></tr>
<tr class="codeline" data-linenumber="3698"><td class="num" id="LN3698">3698</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3699"><td class="num" id="LN3699">3699</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3700"><td class="num" id="LN3700">3700</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3701"><td class="num" id="LN3701">3701</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> sig_cb(<span class='keyword'>const</span> <span class='keyword'>char</span> *elem, <span class='keyword'>int</span> len, <span class='keyword'>void</span> *arg)</td></tr>
<tr class="codeline" data-linenumber="3702"><td class="num" id="LN3702">3702</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3703"><td class="num" id="LN3703">3703</td><td class="line">    sig_cb_st *sarg = arg;</td></tr>
<tr class="codeline" data-linenumber="3704"><td class="num" id="LN3704">3704</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="3705"><td class="num" id="LN3705">3705</td><td class="line">    <span class='keyword'>char</span> etmp[20], *p;</td></tr>
<tr class="codeline" data-linenumber="3706"><td class="num" id="LN3706">3706</td><td class="line">    <span class='keyword'>int</span> sig_alg = <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>, hash_alg = <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3707"><td class="num" id="LN3707">3707</td><td class="line">    <span class='keyword'>if</span> (elem == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3708"><td class="num" id="LN3708">3708</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3709"><td class="num" id="LN3709">3709</td><td class="line">    <span class='keyword'>if</span> (sarg-&gt;sigalgcnt == <span class='macro'>MAX_SIGALGLEN<span class='macro_popup'>(10 * 7 * 2)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3710"><td class="num" id="LN3710">3710</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3711"><td class="num" id="LN3711">3711</td><td class="line">    <span class='keyword'>if</span> (len &gt; (<span class='keyword'>int</span>)(<span class='keyword'>sizeof</span>(etmp) - 1))</td></tr>
<tr class="codeline" data-linenumber="3712"><td class="num" id="LN3712">3712</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3713"><td class="num" id="LN3713">3713</td><td class="line">    memcpy(etmp, elem, len);</td></tr>
<tr class="codeline" data-linenumber="3714"><td class="num" id="LN3714">3714</td><td class="line">    etmp[len] = 0;</td></tr>
<tr class="codeline" data-linenumber="3715"><td class="num" id="LN3715">3715</td><td class="line">    p = strchr(etmp, '+');</td></tr>
<tr class="codeline" data-linenumber="3716"><td class="num" id="LN3716">3716</td><td class="line">    <span class='keyword'>if</span> (!p)</td></tr>
<tr class="codeline" data-linenumber="3717"><td class="num" id="LN3717">3717</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3718"><td class="num" id="LN3718">3718</td><td class="line">    *p = 0;</td></tr>
<tr class="codeline" data-linenumber="3719"><td class="num" id="LN3719">3719</td><td class="line">    p++;</td></tr>
<tr class="codeline" data-linenumber="3720"><td class="num" id="LN3720">3720</td><td class="line">    <span class='keyword'>if</span> (!*p)</td></tr>
<tr class="codeline" data-linenumber="3721"><td class="num" id="LN3721">3721</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3722"><td class="num" id="LN3722">3722</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3723"><td class="num" id="LN3723">3723</td><td class="line">    get_sigorhash(&amp;sig_alg, &amp;hash_alg, etmp);</td></tr>
<tr class="codeline" data-linenumber="3724"><td class="num" id="LN3724">3724</td><td class="line">    get_sigorhash(&amp;sig_alg, &amp;hash_alg, p);</td></tr>
<tr class="codeline" data-linenumber="3725"><td class="num" id="LN3725">3725</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3726"><td class="num" id="LN3726">3726</td><td class="line">    <span class='keyword'>if</span> (sig_alg == <span class='macro'>NID_undef<span class='macro_popup'>0</span></span> || hash_alg == <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3727"><td class="num" id="LN3727">3727</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3728"><td class="num" id="LN3728">3728</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3729"><td class="num" id="LN3729">3729</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; sarg-&gt;sigalgcnt; i += 2) {</td></tr>
<tr class="codeline" data-linenumber="3730"><td class="num" id="LN3730">3730</td><td class="line">        <span class='keyword'>if</span> (sarg-&gt;sigalgs[i] == sig_alg &amp;&amp; sarg-&gt;sigalgs[i + 1] == hash_alg)</td></tr>
<tr class="codeline" data-linenumber="3731"><td class="num" id="LN3731">3731</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3732"><td class="num" id="LN3732">3732</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3733"><td class="num" id="LN3733">3733</td><td class="line">    sarg-&gt;sigalgs[sarg-&gt;sigalgcnt++] = hash_alg;</td></tr>
<tr class="codeline" data-linenumber="3734"><td class="num" id="LN3734">3734</td><td class="line">    sarg-&gt;sigalgs[sarg-&gt;sigalgcnt++] = sig_alg;</td></tr>
<tr class="codeline" data-linenumber="3735"><td class="num" id="LN3735">3735</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="3736"><td class="num" id="LN3736">3736</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3737"><td class="num" id="LN3737">3737</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3738"><td class="num" id="LN3738">3738</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3739"><td class="num" id="LN3739">3739</td><td class="line"> <span class='comment'>* Set supported signature algorithms based on a colon separated list of the</span></td></tr>
<tr class="codeline" data-linenumber="3740"><td class="num" id="LN3740">3740</td><td class="line"> <span class='comment'>* form sig+hash e.g. RSA+SHA512:DSA+SHA512</span></td></tr>
<tr class="codeline" data-linenumber="3741"><td class="num" id="LN3741">3741</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3742"><td class="num" id="LN3742">3742</td><td class="line"><span class='keyword'>int</span> tls1_set_sigalgs_list(CERT *c, <span class='keyword'>const</span> <span class='keyword'>char</span> *str, <span class='keyword'>int</span> client)</td></tr>
<tr class="codeline" data-linenumber="3743"><td class="num" id="LN3743">3743</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3744"><td class="num" id="LN3744">3744</td><td class="line">    sig_cb_st sig;</td></tr>
<tr class="codeline" data-linenumber="3745"><td class="num" id="LN3745">3745</td><td class="line">    sig.sigalgcnt = 0;</td></tr>
<tr class="codeline" data-linenumber="3746"><td class="num" id="LN3746">3746</td><td class="line">    <span class='keyword'>if</span> (!CONF_parse_list(str, ':', 1, sig_cb, &amp;sig))</td></tr>
<tr class="codeline" data-linenumber="3747"><td class="num" id="LN3747">3747</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3748"><td class="num" id="LN3748">3748</td><td class="line">    <span class='keyword'>if</span> (c == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3749"><td class="num" id="LN3749">3749</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="3750"><td class="num" id="LN3750">3750</td><td class="line">    <span class='keyword'>return</span> tls1_set_sigalgs(c, sig.sigalgs, sig.sigalgcnt, client);</td></tr>
<tr class="codeline" data-linenumber="3751"><td class="num" id="LN3751">3751</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3752"><td class="num" id="LN3752">3752</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3753"><td class="num" id="LN3753">3753</td><td class="line"><span class='keyword'>int</span> tls1_set_sigalgs(CERT *c, <span class='keyword'>const</span> <span class='keyword'>int</span> *psig_nids, size_t salglen, <span class='keyword'>int</span> client)</td></tr>
<tr class="codeline" data-linenumber="3754"><td class="num" id="LN3754">3754</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3755"><td class="num" id="LN3755">3755</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *sigalgs, *sptr;</td></tr>
<tr class="codeline" data-linenumber="3756"><td class="num" id="LN3756">3756</td><td class="line">    <span class='keyword'>int</span> rhash, rsign;</td></tr>
<tr class="codeline" data-linenumber="3757"><td class="num" id="LN3757">3757</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="3758"><td class="num" id="LN3758">3758</td><td class="line">    <span class='keyword'>if</span> (salglen &amp; 1)</td></tr>
<tr class="codeline" data-linenumber="3759"><td class="num" id="LN3759">3759</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3760"><td class="num" id="LN3760">3760</td><td class="line">    sigalgs = <span class='macro'>OPENSSL_malloc(salglen)<span class='macro_popup'>CRYPTO_malloc(salglen, "ssl/t1_lib.c", 3760)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3761"><td class="num" id="LN3761">3761</td><td class="line">    <span class='keyword'>if</span> (sigalgs == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3762"><td class="num" id="LN3762">3762</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3763"><td class="num" id="LN3763">3763</td><td class="line">    <span class='keyword'>for</span> (i = 0, sptr = sigalgs; i &lt; salglen; i += 2) {</td></tr>
<tr class="codeline" data-linenumber="3764"><td class="num" id="LN3764">3764</td><td class="line">        rhash = tls12_find_id(*psig_nids++, tls12_md, <span class='macro'>OSSL_NELEM(tls12_md)<span class='macro_popup'>(sizeof(tls12_md)/sizeof((tls12_md)[0]))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3765"><td class="num" id="LN3765">3765</td><td class="line">        rsign = tls12_find_id(*psig_nids++, tls12_sig, <span class='macro'>OSSL_NELEM(tls12_sig)<span class='macro_popup'>(sizeof(tls12_sig)/sizeof((tls12_sig)[0]))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3766"><td class="num" id="LN3766">3766</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3767"><td class="num" id="LN3767">3767</td><td class="line">        <span class='keyword'>if</span> (rhash == -1 || rsign == -1)</td></tr>
<tr class="codeline" data-linenumber="3768"><td class="num" id="LN3768">3768</td><td class="line">            <span class='keyword'>goto</span> err;</td></tr>
<tr class="codeline" data-linenumber="3769"><td class="num" id="LN3769">3769</td><td class="line">        *sptr++ = rhash;</td></tr>
<tr class="codeline" data-linenumber="3770"><td class="num" id="LN3770">3770</td><td class="line">        *sptr++ = rsign;</td></tr>
<tr class="codeline" data-linenumber="3771"><td class="num" id="LN3771">3771</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3772"><td class="num" id="LN3772">3772</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3773"><td class="num" id="LN3773">3773</td><td class="line">    <span class='keyword'>if</span> (client) {</td></tr>
<tr class="codeline" data-linenumber="3774"><td class="num" id="LN3774">3774</td><td class="line">        <span class='macro'>OPENSSL_free(c-&gt;client_sigalgs)<span class='macro_popup'>CRYPTO_free(c-&gt;client_sigalgs, "ssl/t1_lib.c", 3774)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3775"><td class="num" id="LN3775">3775</td><td class="line">        c-&gt;client_sigalgs = sigalgs;</td></tr>
<tr class="codeline" data-linenumber="3776"><td class="num" id="LN3776">3776</td><td class="line">        c-&gt;client_sigalgslen = salglen;</td></tr>
<tr class="codeline" data-linenumber="3777"><td class="num" id="LN3777">3777</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3778"><td class="num" id="LN3778">3778</td><td class="line">        <span class='macro'>OPENSSL_free(c-&gt;conf_sigalgs)<span class='macro_popup'>CRYPTO_free(c-&gt;conf_sigalgs, "ssl/t1_lib.c", 3778)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3779"><td class="num" id="LN3779">3779</td><td class="line">        c-&gt;conf_sigalgs = sigalgs;</td></tr>
<tr class="codeline" data-linenumber="3780"><td class="num" id="LN3780">3780</td><td class="line">        c-&gt;conf_sigalgslen = salglen;</td></tr>
<tr class="codeline" data-linenumber="3781"><td class="num" id="LN3781">3781</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3782"><td class="num" id="LN3782">3782</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3783"><td class="num" id="LN3783">3783</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="3784"><td class="num" id="LN3784">3784</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3785"><td class="num" id="LN3785">3785</td><td class="line"> err:</td></tr>
<tr class="codeline" data-linenumber="3786"><td class="num" id="LN3786">3786</td><td class="line">    <span class='macro'>OPENSSL_free(sigalgs)<span class='macro_popup'>CRYPTO_free(sigalgs, "ssl/t1_lib.c", 3786)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3787"><td class="num" id="LN3787">3787</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3788"><td class="num" id="LN3788">3788</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3789"><td class="num" id="LN3789">3789</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3790"><td class="num" id="LN3790">3790</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls1_check_sig_alg(CERT *c, X509 *x, <span class='keyword'>int</span> default_nid)</td></tr>
<tr class="codeline" data-linenumber="3791"><td class="num" id="LN3791">3791</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3792"><td class="num" id="LN3792">3792</td><td class="line">    <span class='keyword'>int</span> sig_nid;</td></tr>
<tr class="codeline" data-linenumber="3793"><td class="num" id="LN3793">3793</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="3794"><td class="num" id="LN3794">3794</td><td class="line">    <span class='keyword'>if</span> (default_nid == -1)</td></tr>
<tr class="codeline" data-linenumber="3795"><td class="num" id="LN3795">3795</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="3796"><td class="num" id="LN3796">3796</td><td class="line">    sig_nid = X509_get_signature_nid(x);</td></tr>
<tr class="codeline" data-linenumber="3797"><td class="num" id="LN3797">3797</td><td class="line">    <span class='keyword'>if</span> (default_nid)</td></tr>
<tr class="codeline" data-linenumber="3798"><td class="num" id="LN3798">3798</td><td class="line">        <span class='keyword'>return</span> sig_nid == default_nid ? 1 : 0;</td></tr>
<tr class="codeline" data-linenumber="3799"><td class="num" id="LN3799">3799</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; c-&gt;shared_sigalgslen; i++)</td></tr>
<tr class="codeline" data-linenumber="3800"><td class="num" id="LN3800">3800</td><td class="line">        <span class='keyword'>if</span> (sig_nid == c-&gt;shared_sigalgs[i].signandhash_nid)</td></tr>
<tr class="codeline" data-linenumber="3801"><td class="num" id="LN3801">3801</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="3802"><td class="num" id="LN3802">3802</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3803"><td class="num" id="LN3803">3803</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3804"><td class="num" id="LN3804">3804</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3805"><td class="num" id="LN3805">3805</td><td class="line"><span class='comment'>/* Check to see if a certificate issuer name matches list of CA names */</span></td></tr>
<tr class="codeline" data-linenumber="3806"><td class="num" id="LN3806">3806</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> ssl_check_ca_name(<span class='macro'>STACK_OF(X509_NAME)<span class='macro_popup'>struct stack_st_X509_NAME</span></span> *names, X509 *x)</td></tr>
<tr class="codeline" data-linenumber="3807"><td class="num" id="LN3807">3807</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3808"><td class="num" id="LN3808">3808</td><td class="line">    X509_NAME *nm;</td></tr>
<tr class="codeline" data-linenumber="3809"><td class="num" id="LN3809">3809</td><td class="line">    <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="3810"><td class="num" id="LN3810">3810</td><td class="line">    nm = X509_get_issuer_name(x);</td></tr>
<tr class="codeline" data-linenumber="3811"><td class="num" id="LN3811">3811</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; sk_X509_NAME_num(names); i++) {</td></tr>
<tr class="codeline" data-linenumber="3812"><td class="num" id="LN3812">3812</td><td class="line">        <span class='keyword'>if</span> (!X509_NAME_cmp(nm, sk_X509_NAME_value(names, i)))</td></tr>
<tr class="codeline" data-linenumber="3813"><td class="num" id="LN3813">3813</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="3814"><td class="num" id="LN3814">3814</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3815"><td class="num" id="LN3815">3815</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3816"><td class="num" id="LN3816">3816</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3817"><td class="num" id="LN3817">3817</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3818"><td class="num" id="LN3818">3818</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3819"><td class="num" id="LN3819">3819</td><td class="line"> <span class='comment'>* Check certificate chain is consistent with TLS extensions and is usable by</span></td></tr>
<tr class="codeline" data-linenumber="3820"><td class="num" id="LN3820">3820</td><td class="line"> <span class='comment'>* server. This servers two purposes: it allows users to check chains before</span></td></tr>
<tr class="codeline" data-linenumber="3821"><td class="num" id="LN3821">3821</td><td class="line"> <span class='comment'>* passing them to the server and it allows the server to check chains before</span></td></tr>
<tr class="codeline" data-linenumber="3822"><td class="num" id="LN3822">3822</td><td class="line"> <span class='comment'>* attempting to use them.</span></td></tr>
<tr class="codeline" data-linenumber="3823"><td class="num" id="LN3823">3823</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3824"><td class="num" id="LN3824">3824</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3825"><td class="num" id="LN3825">3825</td><td class="line"><span class='comment'>/* Flags which need to be set for a certificate when strict mode not set */</span></td></tr>
<tr class="codeline" data-linenumber="3826"><td class="num" id="LN3826">3826</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3827"><td class="num" id="LN3827">3827</td><td class="line"><span class='directive'>#define <span class='macro'>CERT_PKEY_VALID_FLAGS<span class='macro_popup'>(0x10|0x40)</span></span> \</span></td></tr>
<tr class="codeline" data-linenumber="3828"><td class="num" id="LN3828">3828</td><td class="line">        <span class='directive'>(<span class='macro'>CERT_PKEY_EE_SIGNATURE<span class='macro_popup'>0x10</span></span>|<span class='macro'>CERT_PKEY_EE_PARAM<span class='macro_popup'>0x40</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="3829"><td class="num" id="LN3829">3829</td><td class="line"><span class='comment'>/* Strict mode flags */</span></td></tr>
<tr class="codeline" data-linenumber="3830"><td class="num" id="LN3830">3830</td><td class="line"><span class='directive'>#define <span class='macro'>CERT_PKEY_STRICT_FLAGS<span class='macro_popup'>((0x10|0x40)|0x20|0x80 | 0x200|0x400)</span></span> \</span></td></tr>
<tr class="codeline" data-linenumber="3831"><td class="num" id="LN3831">3831</td><td class="line">         <span class='directive'>(<span class='macro'>CERT_PKEY_VALID_FLAGS<span class='macro_popup'>(0x10|0x40)</span></span>|<span class='macro'>CERT_PKEY_CA_SIGNATURE<span class='macro_popup'>0x20</span></span>|<span class='macro'>CERT_PKEY_CA_PARAM<span class='macro_popup'>0x80</span></span> \</span></td></tr>
<tr class="codeline" data-linenumber="3832"><td class="num" id="LN3832">3832</td><td class="line">         <span class='directive'>| <span class='macro'>CERT_PKEY_ISSUER_NAME<span class='macro_popup'>0x200</span></span>|<span class='macro'>CERT_PKEY_CERT_TYPE<span class='macro_popup'>0x400</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="3833"><td class="num" id="LN3833">3833</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3834"><td class="num" id="LN3834">3834</td><td class="line"><span class='keyword'>int</span> tls1_check_chain(SSL *s, X509 *x, EVP_PKEY *pk, <span class='macro'>STACK_OF(X509)<span class='macro_popup'>struct stack_st_X509</span></span> *chain,</td></tr>
<tr class="codeline" data-linenumber="3835"><td class="num" id="LN3835">3835</td><td class="line">                     <span class='keyword'>int</span> idx)</td></tr>
<tr class="codeline" data-linenumber="3836"><td class="num" id="LN3836">3836</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3837"><td class="num" id="LN3837">3837</td><td class="line">    <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="3838"><td class="num" id="LN3838">3838</td><td class="line">    <span class='keyword'>int</span> rv = 0;</td></tr>
<tr class="codeline" data-linenumber="3839"><td class="num" id="LN3839">3839</td><td class="line">    <span class='keyword'>int</span> check_flags = 0, strict_mode;</td></tr>
<tr class="codeline" data-linenumber="3840"><td class="num" id="LN3840">3840</td><td class="line">    CERT_PKEY *cpk = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3841"><td class="num" id="LN3841">3841</td><td class="line">    CERT *c = s-&gt;cert;</td></tr>
<tr class="codeline" data-linenumber="3842"><td class="num" id="LN3842">3842</td><td class="line">    uint32_t *pvalid;</td></tr>
<tr class="codeline" data-linenumber="3843"><td class="num" id="LN3843">3843</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> suiteb_flags = <span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3844"><td class="num" id="LN3844">3844</td><td class="line">    <span class='comment'>/* idx == -1 means checking server chains */</span></td></tr>
<tr class="codeline" data-linenumber="3845"><td class="num" id="LN3845">3845</td><td class="line">    <span class='keyword'>if</span> (idx != -1) {</td></tr>
<tr class="codeline" data-linenumber="3846"><td class="num" id="LN3846">3846</td><td class="line">        <span class='comment'>/* idx == -2 means checking client certificate chains */</span></td></tr>
<tr class="codeline" data-linenumber="3847"><td class="num" id="LN3847">3847</td><td class="line">        <span class='keyword'>if</span> (idx == -2) {</td></tr>
<tr class="codeline" data-linenumber="3848"><td class="num" id="LN3848">3848</td><td class="line">            cpk = c-&gt;key;</td></tr>
<tr class="codeline" data-linenumber="3849"><td class="num" id="LN3849">3849</td><td class="line">            idx = cpk - c-&gt;pkeys;</td></tr>
<tr class="codeline" data-linenumber="3850"><td class="num" id="LN3850">3850</td><td class="line">        } <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3851"><td class="num" id="LN3851">3851</td><td class="line">            cpk = c-&gt;pkeys + idx;</td></tr>
<tr class="codeline" data-linenumber="3852"><td class="num" id="LN3852">3852</td><td class="line">        pvalid = s-&gt;s3-&gt;tmp.valid_flags + idx;</td></tr>
<tr class="codeline" data-linenumber="3853"><td class="num" id="LN3853">3853</td><td class="line">        x = cpk-&gt;x509;</td></tr>
<tr class="codeline" data-linenumber="3854"><td class="num" id="LN3854">3854</td><td class="line">        pk = cpk-&gt;privatekey;</td></tr>
<tr class="codeline" data-linenumber="3855"><td class="num" id="LN3855">3855</td><td class="line">        chain = cpk-&gt;chain;</td></tr>
<tr class="codeline" data-linenumber="3856"><td class="num" id="LN3856">3856</td><td class="line">        strict_mode = c-&gt;cert_flags &amp; <span class='macro'>SSL_CERT_FLAGS_CHECK_TLS_STRICT<span class='macro_popup'>(0x30000|0x00000001U)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3857"><td class="num" id="LN3857">3857</td><td class="line">        <span class='comment'>/* If no cert or key, forget it */</span></td></tr>
<tr class="codeline" data-linenumber="3858"><td class="num" id="LN3858">3858</td><td class="line">        <span class='keyword'>if</span> (!x || !pk)</td></tr>
<tr class="codeline" data-linenumber="3859"><td class="num" id="LN3859">3859</td><td class="line">            <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="3860"><td class="num" id="LN3860">3860</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3861"><td class="num" id="LN3861">3861</td><td class="line">        <span class='keyword'>if</span> (!x || !pk)</td></tr>
<tr class="codeline" data-linenumber="3862"><td class="num" id="LN3862">3862</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3863"><td class="num" id="LN3863">3863</td><td class="line">        idx = ssl_cert_type(x, pk);</td></tr>
<tr class="codeline" data-linenumber="3864"><td class="num" id="LN3864">3864</td><td class="line">        <span class='keyword'>if</span> (idx == -1)</td></tr>
<tr class="codeline" data-linenumber="3865"><td class="num" id="LN3865">3865</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3866"><td class="num" id="LN3866">3866</td><td class="line">        pvalid = s-&gt;s3-&gt;tmp.valid_flags + idx;</td></tr>
<tr class="codeline" data-linenumber="3867"><td class="num" id="LN3867">3867</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3868"><td class="num" id="LN3868">3868</td><td class="line">        <span class='keyword'>if</span> (c-&gt;cert_flags &amp; <span class='macro'>SSL_CERT_FLAGS_CHECK_TLS_STRICT<span class='macro_popup'>(0x30000|0x00000001U)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3869"><td class="num" id="LN3869">3869</td><td class="line">            check_flags = <span class='macro'>CERT_PKEY_STRICT_FLAGS<span class='macro_popup'>((0x10|0x40)|0x20|0x80 | 0x200|0x400)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3870"><td class="num" id="LN3870">3870</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3871"><td class="num" id="LN3871">3871</td><td class="line">            check_flags = <span class='macro'>CERT_PKEY_VALID_FLAGS<span class='macro_popup'>(0x10|0x40)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3872"><td class="num" id="LN3872">3872</td><td class="line">        strict_mode = 1;</td></tr>
<tr class="codeline" data-linenumber="3873"><td class="num" id="LN3873">3873</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3874"><td class="num" id="LN3874">3874</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3875"><td class="num" id="LN3875">3875</td><td class="line">    <span class='keyword'>if</span> (suiteb_flags) {</td></tr>
<tr class="codeline" data-linenumber="3876"><td class="num" id="LN3876">3876</td><td class="line">        <span class='keyword'>int</span> ok;</td></tr>
<tr class="codeline" data-linenumber="3877"><td class="num" id="LN3877">3877</td><td class="line">        <span class='keyword'>if</span> (check_flags)</td></tr>
<tr class="codeline" data-linenumber="3878"><td class="num" id="LN3878">3878</td><td class="line">            check_flags |= <span class='macro'>CERT_PKEY_SUITEB<span class='macro_popup'>0x800</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3879"><td class="num" id="LN3879">3879</td><td class="line">        ok = X509_chain_check_suiteb(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, x, chain, suiteb_flags);</td></tr>
<tr class="codeline" data-linenumber="3880"><td class="num" id="LN3880">3880</td><td class="line">        <span class='keyword'>if</span> (ok == <span class='macro'>X509_V_OK<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3881"><td class="num" id="LN3881">3881</td><td class="line">            rv |= <span class='macro'>CERT_PKEY_SUITEB<span class='macro_popup'>0x800</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3882"><td class="num" id="LN3882">3882</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (!check_flags)</td></tr>
<tr class="codeline" data-linenumber="3883"><td class="num" id="LN3883">3883</td><td class="line">            <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="3884"><td class="num" id="LN3884">3884</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3885"><td class="num" id="LN3885">3885</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3886"><td class="num" id="LN3886">3886</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3887"><td class="num" id="LN3887">3887</td><td class="line">     <span class='comment'>* Check all signature algorithms are consistent with signature</span></td></tr>
<tr class="codeline" data-linenumber="3888"><td class="num" id="LN3888">3888</td><td class="line">     <span class='comment'>* algorithms extension if TLS 1.2 or later and strict mode.</span></td></tr>
<tr class="codeline" data-linenumber="3889"><td class="num" id="LN3889">3889</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3890"><td class="num" id="LN3890">3890</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>TLS1_get_version(s)<span class='macro_popup'>((SSL_version(s) &gt;&gt; 8) == 0x03 ? SSL_version(s) : 0)</span></span> &gt;= <span class='macro'>TLS1_2_VERSION<span class='macro_popup'>0x0303</span></span> &amp;&amp; strict_mode) {</td></tr>
<tr class="codeline" data-linenumber="3891"><td class="num" id="LN3891">3891</td><td class="line">        <span class='keyword'>int</span> default_nid;</td></tr>
<tr class="codeline" data-linenumber="3892"><td class="num" id="LN3892">3892</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> rsign = 0;</td></tr>
<tr class="codeline" data-linenumber="3893"><td class="num" id="LN3893">3893</td><td class="line">        <span class='keyword'>if</span> (s-&gt;s3-&gt;tmp.peer_sigalgs)</td></tr>
<tr class="codeline" data-linenumber="3894"><td class="num" id="LN3894">3894</td><td class="line">            default_nid = 0;</td></tr>
<tr class="codeline" data-linenumber="3895"><td class="num" id="LN3895">3895</td><td class="line">        <span class='comment'>/* If no sigalgs extension use defaults from RFC5246 */</span></td></tr>
<tr class="codeline" data-linenumber="3896"><td class="num" id="LN3896">3896</td><td class="line">        <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3897"><td class="num" id="LN3897">3897</td><td class="line">            <span class='keyword'>switch</span> (idx) {</td></tr>
<tr class="codeline" data-linenumber="3898"><td class="num" id="LN3898">3898</td><td class="line">            <span class='keyword'>case</span> <span class='macro'>SSL_PKEY_RSA_ENC<span class='macro_popup'>0</span></span>:</td></tr>
<tr class="codeline" data-linenumber="3899"><td class="num" id="LN3899">3899</td><td class="line">            <span class='keyword'>case</span> <span class='macro'>SSL_PKEY_RSA_SIGN<span class='macro_popup'>1</span></span>:</td></tr>
<tr class="codeline" data-linenumber="3900"><td class="num" id="LN3900">3900</td><td class="line">                rsign = <span class='macro'>TLSEXT_signature_rsa<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3901"><td class="num" id="LN3901">3901</td><td class="line">                default_nid = <span class='macro'>NID_sha1WithRSAEncryption<span class='macro_popup'>65</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3902"><td class="num" id="LN3902">3902</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3903"><td class="num" id="LN3903">3903</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3904"><td class="num" id="LN3904">3904</td><td class="line">            <span class='keyword'>case</span> <span class='macro'>SSL_PKEY_DSA_SIGN<span class='macro_popup'>2</span></span>:</td></tr>
<tr class="codeline" data-linenumber="3905"><td class="num" id="LN3905">3905</td><td class="line">                rsign = <span class='macro'>TLSEXT_signature_dsa<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3906"><td class="num" id="LN3906">3906</td><td class="line">                default_nid = <span class='macro'>NID_dsaWithSHA1<span class='macro_popup'>113</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3907"><td class="num" id="LN3907">3907</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3908"><td class="num" id="LN3908">3908</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3909"><td class="num" id="LN3909">3909</td><td class="line">            <span class='keyword'>case</span> <span class='macro'>SSL_PKEY_ECC<span class='macro_popup'>3</span></span>:</td></tr>
<tr class="codeline" data-linenumber="3910"><td class="num" id="LN3910">3910</td><td class="line">                rsign = <span class='macro'>TLSEXT_signature_ecdsa<span class='macro_popup'>3</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3911"><td class="num" id="LN3911">3911</td><td class="line">                default_nid = <span class='macro'>NID_ecdsa_with_SHA1<span class='macro_popup'>416</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3912"><td class="num" id="LN3912">3912</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3913"><td class="num" id="LN3913">3913</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3914"><td class="num" id="LN3914">3914</td><td class="line">            <span class='keyword'>case</span> <span class='macro'>SSL_PKEY_GOST01<span class='macro_popup'>4</span></span>:</td></tr>
<tr class="codeline" data-linenumber="3915"><td class="num" id="LN3915">3915</td><td class="line">                rsign = <span class='macro'>TLSEXT_signature_gostr34102001<span class='macro_popup'>237</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3916"><td class="num" id="LN3916">3916</td><td class="line">                default_nid = <span class='macro'>NID_id_GostR3411_94_with_GostR3410_2001<span class='macro_popup'>807</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3917"><td class="num" id="LN3917">3917</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3918"><td class="num" id="LN3918">3918</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3919"><td class="num" id="LN3919">3919</td><td class="line">            <span class='keyword'>case</span> <span class='macro'>SSL_PKEY_GOST12_256<span class='macro_popup'>5</span></span>:</td></tr>
<tr class="codeline" data-linenumber="3920"><td class="num" id="LN3920">3920</td><td class="line">                rsign = <span class='macro'>TLSEXT_signature_gostr34102012_256<span class='macro_popup'>238</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3921"><td class="num" id="LN3921">3921</td><td class="line">                default_nid = <span class='macro'>NID_id_tc26_signwithdigest_gost3410_2012_256<span class='macro_popup'>985</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3922"><td class="num" id="LN3922">3922</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3923"><td class="num" id="LN3923">3923</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3924"><td class="num" id="LN3924">3924</td><td class="line">            <span class='keyword'>case</span> <span class='macro'>SSL_PKEY_GOST12_512<span class='macro_popup'>6</span></span>:</td></tr>
<tr class="codeline" data-linenumber="3925"><td class="num" id="LN3925">3925</td><td class="line">                rsign = <span class='macro'>TLSEXT_signature_gostr34102012_512<span class='macro_popup'>239</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3926"><td class="num" id="LN3926">3926</td><td class="line">                default_nid = <span class='macro'>NID_id_tc26_signwithdigest_gost3410_2012_512<span class='macro_popup'>986</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3927"><td class="num" id="LN3927">3927</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3928"><td class="num" id="LN3928">3928</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3929"><td class="num" id="LN3929">3929</td><td class="line">            <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="3930"><td class="num" id="LN3930">3930</td><td class="line">                default_nid = -1;</td></tr>
<tr class="codeline" data-linenumber="3931"><td class="num" id="LN3931">3931</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3932"><td class="num" id="LN3932">3932</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3933"><td class="num" id="LN3933">3933</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3934"><td class="num" id="LN3934">3934</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3935"><td class="num" id="LN3935">3935</td><td class="line">         <span class='comment'>* If peer sent no signature algorithms extension and we have set</span></td></tr>
<tr class="codeline" data-linenumber="3936"><td class="num" id="LN3936">3936</td><td class="line">         <span class='comment'>* preferred signature algorithms check we support sha1.</span></td></tr>
<tr class="codeline" data-linenumber="3937"><td class="num" id="LN3937">3937</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3938"><td class="num" id="LN3938">3938</td><td class="line">        <span class='keyword'>if</span> (default_nid &gt; 0 &amp;&amp; c-&gt;conf_sigalgs) {</td></tr>
<tr class="codeline" data-linenumber="3939"><td class="num" id="LN3939">3939</td><td class="line">            size_t j;</td></tr>
<tr class="codeline" data-linenumber="3940"><td class="num" id="LN3940">3940</td><td class="line">            <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p = c-&gt;conf_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="3941"><td class="num" id="LN3941">3941</td><td class="line">            <span class='keyword'>for</span> (j = 0; j &lt; c-&gt;conf_sigalgslen; j += 2, p += 2) {</td></tr>
<tr class="codeline" data-linenumber="3942"><td class="num" id="LN3942">3942</td><td class="line">                <span class='keyword'>if</span> (p[0] == <span class='macro'>TLSEXT_hash_sha1<span class='macro_popup'>2</span></span> &amp;&amp; p[1] == rsign)</td></tr>
<tr class="codeline" data-linenumber="3943"><td class="num" id="LN3943">3943</td><td class="line">                    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3944"><td class="num" id="LN3944">3944</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3945"><td class="num" id="LN3945">3945</td><td class="line">            <span class='keyword'>if</span> (j == c-&gt;conf_sigalgslen) {</td></tr>
<tr class="codeline" data-linenumber="3946"><td class="num" id="LN3946">3946</td><td class="line">                <span class='keyword'>if</span> (check_flags)</td></tr>
<tr class="codeline" data-linenumber="3947"><td class="num" id="LN3947">3947</td><td class="line">                    <span class='keyword'>goto</span> skip_sigs;</td></tr>
<tr class="codeline" data-linenumber="3948"><td class="num" id="LN3948">3948</td><td class="line">                <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3949"><td class="num" id="LN3949">3949</td><td class="line">                    <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="3950"><td class="num" id="LN3950">3950</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3951"><td class="num" id="LN3951">3951</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3952"><td class="num" id="LN3952">3952</td><td class="line">        <span class='comment'>/* Check signature algorithm of each cert in chain */</span></td></tr>
<tr class="codeline" data-linenumber="3953"><td class="num" id="LN3953">3953</td><td class="line">        <span class='keyword'>if</span> (!tls1_check_sig_alg(c, x, default_nid)) {</td></tr>
<tr class="codeline" data-linenumber="3954"><td class="num" id="LN3954">3954</td><td class="line">            <span class='keyword'>if</span> (!check_flags)</td></tr>
<tr class="codeline" data-linenumber="3955"><td class="num" id="LN3955">3955</td><td class="line">                <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="3956"><td class="num" id="LN3956">3956</td><td class="line">        } <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3957"><td class="num" id="LN3957">3957</td><td class="line">            rv |= <span class='macro'>CERT_PKEY_EE_SIGNATURE<span class='macro_popup'>0x10</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3958"><td class="num" id="LN3958">3958</td><td class="line">        rv |= <span class='macro'>CERT_PKEY_CA_SIGNATURE<span class='macro_popup'>0x20</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3959"><td class="num" id="LN3959">3959</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; sk_X509_num(chain); i++) {</td></tr>
<tr class="codeline" data-linenumber="3960"><td class="num" id="LN3960">3960</td><td class="line">            <span class='keyword'>if</span> (!tls1_check_sig_alg(c, sk_X509_value(chain, i), default_nid)) {</td></tr>
<tr class="codeline" data-linenumber="3961"><td class="num" id="LN3961">3961</td><td class="line">                <span class='keyword'>if</span> (check_flags) {</td></tr>
<tr class="codeline" data-linenumber="3962"><td class="num" id="LN3962">3962</td><td class="line">                    rv &amp;= ~<span class='macro'>CERT_PKEY_CA_SIGNATURE<span class='macro_popup'>0x20</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3963"><td class="num" id="LN3963">3963</td><td class="line">                    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3964"><td class="num" id="LN3964">3964</td><td class="line">                } <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3965"><td class="num" id="LN3965">3965</td><td class="line">                    <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="3966"><td class="num" id="LN3966">3966</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3967"><td class="num" id="LN3967">3967</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3968"><td class="num" id="LN3968">3968</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3969"><td class="num" id="LN3969">3969</td><td class="line">    <span class='comment'>/* Else not TLS 1.2, so mark EE and CA signing algorithms OK */</span></td></tr>
<tr class="codeline" data-linenumber="3970"><td class="num" id="LN3970">3970</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (check_flags)</td></tr>
<tr class="codeline" data-linenumber="3971"><td class="num" id="LN3971">3971</td><td class="line">        rv |= <span class='macro'>CERT_PKEY_EE_SIGNATURE<span class='macro_popup'>0x10</span></span> | <span class='macro'>CERT_PKEY_CA_SIGNATURE<span class='macro_popup'>0x20</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3972"><td class="num" id="LN3972">3972</td><td class="line"> skip_sigs:</td></tr>
<tr class="codeline" data-linenumber="3973"><td class="num" id="LN3973">3973</td><td class="line">    <span class='comment'>/* Check cert parameters are consistent */</span></td></tr>
<tr class="codeline" data-linenumber="3974"><td class="num" id="LN3974">3974</td><td class="line">    <span class='keyword'>if</span> (tls1_check_cert_param(s, x, check_flags ? 1 : 2))</td></tr>
<tr class="codeline" data-linenumber="3975"><td class="num" id="LN3975">3975</td><td class="line">        rv |= <span class='macro'>CERT_PKEY_EE_PARAM<span class='macro_popup'>0x40</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3976"><td class="num" id="LN3976">3976</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (!check_flags)</td></tr>
<tr class="codeline" data-linenumber="3977"><td class="num" id="LN3977">3977</td><td class="line">        <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="3978"><td class="num" id="LN3978">3978</td><td class="line">    <span class='keyword'>if</span> (!s-&gt;server)</td></tr>
<tr class="codeline" data-linenumber="3979"><td class="num" id="LN3979">3979</td><td class="line">        rv |= <span class='macro'>CERT_PKEY_CA_PARAM<span class='macro_popup'>0x80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3980"><td class="num" id="LN3980">3980</td><td class="line">    <span class='comment'>/* In strict mode check rest of chain too */</span></td></tr>
<tr class="codeline" data-linenumber="3981"><td class="num" id="LN3981">3981</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (strict_mode) {</td></tr>
<tr class="codeline" data-linenumber="3982"><td class="num" id="LN3982">3982</td><td class="line">        rv |= <span class='macro'>CERT_PKEY_CA_PARAM<span class='macro_popup'>0x80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3983"><td class="num" id="LN3983">3983</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; sk_X509_num(chain); i++) {</td></tr>
<tr class="codeline" data-linenumber="3984"><td class="num" id="LN3984">3984</td><td class="line">            X509 *ca = sk_X509_value(chain, i);</td></tr>
<tr class="codeline" data-linenumber="3985"><td class="num" id="LN3985">3985</td><td class="line">            <span class='keyword'>if</span> (!tls1_check_cert_param(s, ca, 0)) {</td></tr>
<tr class="codeline" data-linenumber="3986"><td class="num" id="LN3986">3986</td><td class="line">                <span class='keyword'>if</span> (check_flags) {</td></tr>
<tr class="codeline" data-linenumber="3987"><td class="num" id="LN3987">3987</td><td class="line">                    rv &amp;= ~<span class='macro'>CERT_PKEY_CA_PARAM<span class='macro_popup'>0x80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3988"><td class="num" id="LN3988">3988</td><td class="line">                    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3989"><td class="num" id="LN3989">3989</td><td class="line">                } <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3990"><td class="num" id="LN3990">3990</td><td class="line">                    <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="3991"><td class="num" id="LN3991">3991</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3992"><td class="num" id="LN3992">3992</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3993"><td class="num" id="LN3993">3993</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3994"><td class="num" id="LN3994">3994</td><td class="line">    <span class='keyword'>if</span> (!s-&gt;server &amp;&amp; strict_mode) {</td></tr>
<tr class="codeline" data-linenumber="3995"><td class="num" id="LN3995">3995</td><td class="line">        <span class='macro'>STACK_OF(X509_NAME)<span class='macro_popup'>struct stack_st_X509_NAME</span></span> *ca_dn;</td></tr>
<tr class="codeline" data-linenumber="3996"><td class="num" id="LN3996">3996</td><td class="line">        <span class='keyword'>int</span> check_type = 0;</td></tr>
<tr class="codeline" data-linenumber="3997"><td class="num" id="LN3997">3997</td><td class="line">        <span class='keyword'>switch</span> (EVP_PKEY_id(pk)) {</td></tr>
<tr class="codeline" data-linenumber="3998"><td class="num" id="LN3998">3998</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>EVP_PKEY_RSA<span class='macro_popup'>6</span></span>:</td></tr>
<tr class="codeline" data-linenumber="3999"><td class="num" id="LN3999">3999</td><td class="line">            check_type = <span class='macro'>TLS_CT_RSA_SIGN<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4000"><td class="num" id="LN4000">4000</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4001"><td class="num" id="LN4001">4001</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>EVP_PKEY_DSA<span class='macro_popup'>116</span></span>:</td></tr>
<tr class="codeline" data-linenumber="4002"><td class="num" id="LN4002">4002</td><td class="line">            check_type = <span class='macro'>TLS_CT_DSS_SIGN<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4003"><td class="num" id="LN4003">4003</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4004"><td class="num" id="LN4004">4004</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>EVP_PKEY_EC<span class='macro_popup'>408</span></span>:</td></tr>
<tr class="codeline" data-linenumber="4005"><td class="num" id="LN4005">4005</td><td class="line">            check_type = <span class='macro'>TLS_CT_ECDSA_SIGN<span class='macro_popup'>64</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4006"><td class="num" id="LN4006">4006</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4007"><td class="num" id="LN4007">4007</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4008"><td class="num" id="LN4008">4008</td><td class="line">        <span class='keyword'>if</span> (check_type) {</td></tr>
<tr class="codeline" data-linenumber="4009"><td class="num" id="LN4009">4009</td><td class="line">            <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *ctypes;</td></tr>
<tr class="codeline" data-linenumber="4010"><td class="num" id="LN4010">4010</td><td class="line">            <span class='keyword'>int</span> ctypelen;</td></tr>
<tr class="codeline" data-linenumber="4011"><td class="num" id="LN4011">4011</td><td class="line">            <span class='keyword'>if</span> (c-&gt;ctypes) {</td></tr>
<tr class="codeline" data-linenumber="4012"><td class="num" id="LN4012">4012</td><td class="line">                ctypes = c-&gt;ctypes;</td></tr>
<tr class="codeline" data-linenumber="4013"><td class="num" id="LN4013">4013</td><td class="line">                ctypelen = (<span class='keyword'>int</span>)c-&gt;ctype_num;</td></tr>
<tr class="codeline" data-linenumber="4014"><td class="num" id="LN4014">4014</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="4015"><td class="num" id="LN4015">4015</td><td class="line">                ctypes = (<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *)s-&gt;s3-&gt;tmp.ctype;</td></tr>
<tr class="codeline" data-linenumber="4016"><td class="num" id="LN4016">4016</td><td class="line">                ctypelen = s-&gt;s3-&gt;tmp.ctype_num;</td></tr>
<tr class="codeline" data-linenumber="4017"><td class="num" id="LN4017">4017</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="4018"><td class="num" id="LN4018">4018</td><td class="line">            <span class='keyword'>for</span> (i = 0; i &lt; ctypelen; i++) {</td></tr>
<tr class="codeline" data-linenumber="4019"><td class="num" id="LN4019">4019</td><td class="line">                <span class='keyword'>if</span> (ctypes[i] == check_type) {</td></tr>
<tr class="codeline" data-linenumber="4020"><td class="num" id="LN4020">4020</td><td class="line">                    rv |= <span class='macro'>CERT_PKEY_CERT_TYPE<span class='macro_popup'>0x400</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4021"><td class="num" id="LN4021">4021</td><td class="line">                    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4022"><td class="num" id="LN4022">4022</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="4023"><td class="num" id="LN4023">4023</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="4024"><td class="num" id="LN4024">4024</td><td class="line">            <span class='keyword'>if</span> (!(rv &amp; <span class='macro'>CERT_PKEY_CERT_TYPE<span class='macro_popup'>0x400</span></span>) &amp;&amp; !check_flags)</td></tr>
<tr class="codeline" data-linenumber="4025"><td class="num" id="LN4025">4025</td><td class="line">                <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="4026"><td class="num" id="LN4026">4026</td><td class="line">        } <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="4027"><td class="num" id="LN4027">4027</td><td class="line">            rv |= <span class='macro'>CERT_PKEY_CERT_TYPE<span class='macro_popup'>0x400</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4028"><td class="num" id="LN4028">4028</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4029"><td class="num" id="LN4029">4029</td><td class="line">        ca_dn = s-&gt;s3-&gt;tmp.ca_names;</td></tr>
<tr class="codeline" data-linenumber="4030"><td class="num" id="LN4030">4030</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4031"><td class="num" id="LN4031">4031</td><td class="line">        <span class='keyword'>if</span> (!sk_X509_NAME_num(ca_dn))</td></tr>
<tr class="codeline" data-linenumber="4032"><td class="num" id="LN4032">4032</td><td class="line">            rv |= <span class='macro'>CERT_PKEY_ISSUER_NAME<span class='macro_popup'>0x200</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4033"><td class="num" id="LN4033">4033</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4034"><td class="num" id="LN4034">4034</td><td class="line">        <span class='keyword'>if</span> (!(rv &amp; <span class='macro'>CERT_PKEY_ISSUER_NAME<span class='macro_popup'>0x200</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="4035"><td class="num" id="LN4035">4035</td><td class="line">            <span class='keyword'>if</span> (ssl_check_ca_name(ca_dn, x))</td></tr>
<tr class="codeline" data-linenumber="4036"><td class="num" id="LN4036">4036</td><td class="line">                rv |= <span class='macro'>CERT_PKEY_ISSUER_NAME<span class='macro_popup'>0x200</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4037"><td class="num" id="LN4037">4037</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4038"><td class="num" id="LN4038">4038</td><td class="line">        <span class='keyword'>if</span> (!(rv &amp; <span class='macro'>CERT_PKEY_ISSUER_NAME<span class='macro_popup'>0x200</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="4039"><td class="num" id="LN4039">4039</td><td class="line">            <span class='keyword'>for</span> (i = 0; i &lt; sk_X509_num(chain); i++) {</td></tr>
<tr class="codeline" data-linenumber="4040"><td class="num" id="LN4040">4040</td><td class="line">                X509 *xtmp = sk_X509_value(chain, i);</td></tr>
<tr class="codeline" data-linenumber="4041"><td class="num" id="LN4041">4041</td><td class="line">                <span class='keyword'>if</span> (ssl_check_ca_name(ca_dn, xtmp)) {</td></tr>
<tr class="codeline" data-linenumber="4042"><td class="num" id="LN4042">4042</td><td class="line">                    rv |= <span class='macro'>CERT_PKEY_ISSUER_NAME<span class='macro_popup'>0x200</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4043"><td class="num" id="LN4043">4043</td><td class="line">                    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4044"><td class="num" id="LN4044">4044</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="4045"><td class="num" id="LN4045">4045</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="4046"><td class="num" id="LN4046">4046</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4047"><td class="num" id="LN4047">4047</td><td class="line">        <span class='keyword'>if</span> (!check_flags &amp;&amp; !(rv &amp; <span class='macro'>CERT_PKEY_ISSUER_NAME<span class='macro_popup'>0x200</span></span>))</td></tr>
<tr class="codeline" data-linenumber="4048"><td class="num" id="LN4048">4048</td><td class="line">            <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="4049"><td class="num" id="LN4049">4049</td><td class="line">    } <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="4050"><td class="num" id="LN4050">4050</td><td class="line">        rv |= <span class='macro'>CERT_PKEY_ISSUER_NAME<span class='macro_popup'>0x200</span></span> | <span class='macro'>CERT_PKEY_CERT_TYPE<span class='macro_popup'>0x400</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4051"><td class="num" id="LN4051">4051</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4052"><td class="num" id="LN4052">4052</td><td class="line">    <span class='keyword'>if</span> (!check_flags || (rv &amp; check_flags) == check_flags)</td></tr>
<tr class="codeline" data-linenumber="4053"><td class="num" id="LN4053">4053</td><td class="line">        rv |= <span class='macro'>CERT_PKEY_VALID<span class='macro_popup'>0x1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4054"><td class="num" id="LN4054">4054</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4055"><td class="num" id="LN4055">4055</td><td class="line"> end:</td></tr>
<tr class="codeline" data-linenumber="4056"><td class="num" id="LN4056">4056</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4057"><td class="num" id="LN4057">4057</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>TLS1_get_version(s)<span class='macro_popup'>((SSL_version(s) &gt;&gt; 8) == 0x03 ? SSL_version(s) : 0)</span></span> &gt;= <span class='macro'>TLS1_2_VERSION<span class='macro_popup'>0x0303</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4058"><td class="num" id="LN4058">4058</td><td class="line">        <span class='keyword'>if</span> (*pvalid &amp; <span class='macro'>CERT_PKEY_EXPLICIT_SIGN<span class='macro_popup'>0x100</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4059"><td class="num" id="LN4059">4059</td><td class="line">            rv |= <span class='macro'>CERT_PKEY_EXPLICIT_SIGN<span class='macro_popup'>0x100</span></span> | <span class='macro'>CERT_PKEY_SIGN<span class='macro_popup'>0x2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4060"><td class="num" id="LN4060">4060</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (s-&gt;s3-&gt;tmp.md[idx] != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4061"><td class="num" id="LN4061">4061</td><td class="line">            rv |= <span class='macro'>CERT_PKEY_SIGN<span class='macro_popup'>0x2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4062"><td class="num" id="LN4062">4062</td><td class="line">    } <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="4063"><td class="num" id="LN4063">4063</td><td class="line">        rv |= <span class='macro'>CERT_PKEY_SIGN<span class='macro_popup'>0x2</span></span> | <span class='macro'>CERT_PKEY_EXPLICIT_SIGN<span class='macro_popup'>0x100</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4064"><td class="num" id="LN4064">4064</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4065"><td class="num" id="LN4065">4065</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4066"><td class="num" id="LN4066">4066</td><td class="line">     <span class='comment'>* When checking a CERT_PKEY structure all flags are irrelevant if the</span></td></tr>
<tr class="codeline" data-linenumber="4067"><td class="num" id="LN4067">4067</td><td class="line">     <span class='comment'>* chain is invalid.</span></td></tr>
<tr class="codeline" data-linenumber="4068"><td class="num" id="LN4068">4068</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4069"><td class="num" id="LN4069">4069</td><td class="line">    <span class='keyword'>if</span> (!check_flags) {</td></tr>
<tr class="codeline" data-linenumber="4070"><td class="num" id="LN4070">4070</td><td class="line">        <span class='keyword'>if</span> (rv &amp; <span class='macro'>CERT_PKEY_VALID<span class='macro_popup'>0x1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4071"><td class="num" id="LN4071">4071</td><td class="line">            *pvalid = rv;</td></tr>
<tr class="codeline" data-linenumber="4072"><td class="num" id="LN4072">4072</td><td class="line">        <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="4073"><td class="num" id="LN4073">4073</td><td class="line">            <span class='comment'>/* Preserve explicit sign flag, clear rest */</span></td></tr>
<tr class="codeline" data-linenumber="4074"><td class="num" id="LN4074">4074</td><td class="line">            *pvalid &amp;= <span class='macro'>CERT_PKEY_EXPLICIT_SIGN<span class='macro_popup'>0x100</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4075"><td class="num" id="LN4075">4075</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="4076"><td class="num" id="LN4076">4076</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4077"><td class="num" id="LN4077">4077</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4078"><td class="num" id="LN4078">4078</td><td class="line">    <span class='keyword'>return</span> rv;</td></tr>
<tr class="codeline" data-linenumber="4079"><td class="num" id="LN4079">4079</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4080"><td class="num" id="LN4080">4080</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4081"><td class="num" id="LN4081">4081</td><td class="line"><span class='comment'>/* Set validity of certificates in an SSL structure */</span></td></tr>
<tr class="codeline" data-linenumber="4082"><td class="num" id="LN4082">4082</td><td class="line"><span class='keyword'>void</span> tls1_set_cert_validity(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="4083"><td class="num" id="LN4083">4083</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4084"><td class="num" id="LN4084">4084</td><td class="line">    tls1_check_chain(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>SSL_PKEY_RSA_ENC<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4085"><td class="num" id="LN4085">4085</td><td class="line">    tls1_check_chain(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>SSL_PKEY_RSA_SIGN<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4086"><td class="num" id="LN4086">4086</td><td class="line">    tls1_check_chain(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>SSL_PKEY_DSA_SIGN<span class='macro_popup'>2</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4087"><td class="num" id="LN4087">4087</td><td class="line">    tls1_check_chain(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>SSL_PKEY_ECC<span class='macro_popup'>3</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4088"><td class="num" id="LN4088">4088</td><td class="line">    tls1_check_chain(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>SSL_PKEY_GOST01<span class='macro_popup'>4</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4089"><td class="num" id="LN4089">4089</td><td class="line">    tls1_check_chain(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>SSL_PKEY_GOST12_256<span class='macro_popup'>5</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4090"><td class="num" id="LN4090">4090</td><td class="line">    tls1_check_chain(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>SSL_PKEY_GOST12_512<span class='macro_popup'>6</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4091"><td class="num" id="LN4091">4091</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4092"><td class="num" id="LN4092">4092</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4093"><td class="num" id="LN4093">4093</td><td class="line"><span class='comment'>/* User level utility function to check a chain is suitable */</span></td></tr>
<tr class="codeline" data-linenumber="4094"><td class="num" id="LN4094">4094</td><td class="line"><span class='keyword'>int</span> SSL_check_chain(SSL *s, X509 *x, EVP_PKEY *pk, <span class='macro'>STACK_OF(X509)<span class='macro_popup'>struct stack_st_X509</span></span> *chain)</td></tr>
<tr class="codeline" data-linenumber="4095"><td class="num" id="LN4095">4095</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4096"><td class="num" id="LN4096">4096</td><td class="line">    <span class='keyword'>return</span> tls1_check_chain(s, x, pk, chain, -1);</td></tr>
<tr class="codeline" data-linenumber="4097"><td class="num" id="LN4097">4097</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4098"><td class="num" id="LN4098">4098</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4099"><td class="num" id="LN4099">4099</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_DH</span></td></tr>
<tr class="codeline" data-linenumber="4100"><td class="num" id="LN4100">4100</td><td class="line">DH *ssl_get_auto_dh(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="4101"><td class="num" id="LN4101">4101</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4102"><td class="num" id="LN4102">4102</td><td class="line">    <span class='keyword'>int</span> dh_secbits = 80;</td></tr>
<tr class="codeline" data-linenumber="4103"><td class="num" id="LN4103">4103</td><td class="line">    <span class='keyword'>if</span> (s-&gt;cert-&gt;dh_tmp_auto == 2)</td></tr>
<tr class="codeline" data-linenumber="4104"><td class="num" id="LN4104">4104</td><td class="line">        <span class='keyword'>return</span> DH_get_1024_160();</td></tr>
<tr class="codeline" data-linenumber="4105"><td class="num" id="LN4105">4105</td><td class="line">    <span class='keyword'>if</span> (s-&gt;s3-&gt;tmp.new_cipher-&gt;algorithm_auth &amp; (<span class='macro'>SSL_aNULL<span class='macro_popup'>0x00000004U</span></span> | <span class='macro'>SSL_aPSK<span class='macro_popup'>0x00000010U</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="4106"><td class="num" id="LN4106">4106</td><td class="line">        <span class='keyword'>if</span> (s-&gt;s3-&gt;tmp.new_cipher-&gt;strength_bits == 256)</td></tr>
<tr class="codeline" data-linenumber="4107"><td class="num" id="LN4107">4107</td><td class="line">            dh_secbits = 128;</td></tr>
<tr class="codeline" data-linenumber="4108"><td class="num" id="LN4108">4108</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="4109"><td class="num" id="LN4109">4109</td><td class="line">            dh_secbits = 80;</td></tr>
<tr class="codeline" data-linenumber="4110"><td class="num" id="LN4110">4110</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="4111"><td class="num" id="LN4111">4111</td><td class="line">        CERT_PKEY *cpk = ssl_get_server_send_pkey(s);</td></tr>
<tr class="codeline" data-linenumber="4112"><td class="num" id="LN4112">4112</td><td class="line">        dh_secbits = EVP_PKEY_security_bits(cpk-&gt;privatekey);</td></tr>
<tr class="codeline" data-linenumber="4113"><td class="num" id="LN4113">4113</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4114"><td class="num" id="LN4114">4114</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4115"><td class="num" id="LN4115">4115</td><td class="line">    <span class='keyword'>if</span> (dh_secbits &gt;= 128) {</td></tr>
<tr class="codeline" data-linenumber="4116"><td class="num" id="LN4116">4116</td><td class="line">        DH *dhp = DH_new();</td></tr>
<tr class="codeline" data-linenumber="4117"><td class="num" id="LN4117">4117</td><td class="line">        BIGNUM *p, *g;</td></tr>
<tr class="codeline" data-linenumber="4118"><td class="num" id="LN4118">4118</td><td class="line">        <span class='keyword'>if</span> (dhp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4119"><td class="num" id="LN4119">4119</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4120"><td class="num" id="LN4120">4120</td><td class="line">        g = BN_new();</td></tr>
<tr class="codeline" data-linenumber="4121"><td class="num" id="LN4121">4121</td><td class="line">        <span class='keyword'>if</span> (g != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4122"><td class="num" id="LN4122">4122</td><td class="line">            BN_set_word(g, 2);</td></tr>
<tr class="codeline" data-linenumber="4123"><td class="num" id="LN4123">4123</td><td class="line">        <span class='keyword'>if</span> (dh_secbits &gt;= 192)</td></tr>
<tr class="codeline" data-linenumber="4124"><td class="num" id="LN4124">4124</td><td class="line">            p = BN_get_rfc3526_prime_8192(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4125"><td class="num" id="LN4125">4125</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="4126"><td class="num" id="LN4126">4126</td><td class="line">            p = BN_get_rfc3526_prime_3072(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4127"><td class="num" id="LN4127">4127</td><td class="line">        <span class='keyword'>if</span> (p == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || g == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || !DH_set0_pqg(dhp, p, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, g)) {</td></tr>
<tr class="codeline" data-linenumber="4128"><td class="num" id="LN4128">4128</td><td class="line">            DH_free(dhp);</td></tr>
<tr class="codeline" data-linenumber="4129"><td class="num" id="LN4129">4129</td><td class="line">            BN_free(p);</td></tr>
<tr class="codeline" data-linenumber="4130"><td class="num" id="LN4130">4130</td><td class="line">            BN_free(g);</td></tr>
<tr class="codeline" data-linenumber="4131"><td class="num" id="LN4131">4131</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4132"><td class="num" id="LN4132">4132</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4133"><td class="num" id="LN4133">4133</td><td class="line">        <span class='keyword'>return</span> dhp;</td></tr>
<tr class="codeline" data-linenumber="4134"><td class="num" id="LN4134">4134</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4135"><td class="num" id="LN4135">4135</td><td class="line">    <span class='keyword'>if</span> (dh_secbits &gt;= 112)</td></tr>
<tr class="codeline" data-linenumber="4136"><td class="num" id="LN4136">4136</td><td class="line">        <span class='keyword'>return</span> DH_get_2048_224();</td></tr>
<tr class="codeline" data-linenumber="4137"><td class="num" id="LN4137">4137</td><td class="line">    <span class='keyword'>return</span> DH_get_1024_160();</td></tr>
<tr class="codeline" data-linenumber="4138"><td class="num" id="LN4138">4138</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4139"><td class="num" id="LN4139">4139</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="4140"><td class="num" id="LN4140">4140</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4141"><td class="num" id="LN4141">4141</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> ssl_security_cert_key(SSL *s, SSL_CTX *ctx, X509 *x, <span class='keyword'>int</span> op)</td></tr>
<tr class="codeline" data-linenumber="4142"><td class="num" id="LN4142">4142</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4143"><td class="num" id="LN4143">4143</td><td class="line">    <span class='keyword'>int</span> secbits = -1;</td></tr>
<tr class="codeline" data-linenumber="4144"><td class="num" id="LN4144">4144</td><td class="line">    EVP_PKEY *pkey = X509_get0_pubkey(x);</td></tr>
<tr class="codeline" data-linenumber="4145"><td class="num" id="LN4145">4145</td><td class="line">    <span class='keyword'>if</span> (pkey) {</td></tr>
<tr class="codeline" data-linenumber="4146"><td class="num" id="LN4146">4146</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4147"><td class="num" id="LN4147">4147</td><td class="line">         <span class='comment'>* If no parameters this will return -1 and fail using the default</span></td></tr>
<tr class="codeline" data-linenumber="4148"><td class="num" id="LN4148">4148</td><td class="line">         <span class='comment'>* security callback for any non-zero security level. This will</span></td></tr>
<tr class="codeline" data-linenumber="4149"><td class="num" id="LN4149">4149</td><td class="line">         <span class='comment'>* reject keys which omit parameters but this only affects DSA and</span></td></tr>
<tr class="codeline" data-linenumber="4150"><td class="num" id="LN4150">4150</td><td class="line">         <span class='comment'>* omission of parameters is never (?) done in practice.</span></td></tr>
<tr class="codeline" data-linenumber="4151"><td class="num" id="LN4151">4151</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4152"><td class="num" id="LN4152">4152</td><td class="line">        secbits = EVP_PKEY_security_bits(pkey);</td></tr>
<tr class="codeline" data-linenumber="4153"><td class="num" id="LN4153">4153</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4154"><td class="num" id="LN4154">4154</td><td class="line">    <span class='keyword'>if</span> (s)</td></tr>
<tr class="codeline" data-linenumber="4155"><td class="num" id="LN4155">4155</td><td class="line">        <span class='keyword'>return</span> ssl_security(s, op, secbits, 0, x);</td></tr>
<tr class="codeline" data-linenumber="4156"><td class="num" id="LN4156">4156</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="4157"><td class="num" id="LN4157">4157</td><td class="line">        <span class='keyword'>return</span> ssl_ctx_security(ctx, op, secbits, 0, x);</td></tr>
<tr class="codeline" data-linenumber="4158"><td class="num" id="LN4158">4158</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4159"><td class="num" id="LN4159">4159</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4160"><td class="num" id="LN4160">4160</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> ssl_security_cert_sig(SSL *s, SSL_CTX *ctx, X509 *x, <span class='keyword'>int</span> op)</td></tr>
<tr class="codeline" data-linenumber="4161"><td class="num" id="LN4161">4161</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4162"><td class="num" id="LN4162">4162</td><td class="line">    <span class='comment'>/* Lookup signature algorithm digest */</span></td></tr>
<tr class="codeline" data-linenumber="4163"><td class="num" id="LN4163">4163</td><td class="line">    <span class='keyword'>int</span> secbits = -1, md_nid = <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>, sig_nid;</td></tr>
<tr class="codeline" data-linenumber="4164"><td class="num" id="LN4164">4164</td><td class="line">    <span class='comment'>/* Don't check signature if self signed */</span></td></tr>
<tr class="codeline" data-linenumber="4165"><td class="num" id="LN4165">4165</td><td class="line">    <span class='keyword'>if</span> ((X509_get_extension_flags(x) &amp; <span class='macro'>EXFLAG_SS<span class='macro_popup'>0x2000</span></span>) != 0)</td></tr>
<tr class="codeline" data-linenumber="4166"><td class="num" id="LN4166">4166</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="4167"><td class="num" id="LN4167">4167</td><td class="line">    sig_nid = X509_get_signature_nid(x);</td></tr>
<tr class="codeline" data-linenumber="4168"><td class="num" id="LN4168">4168</td><td class="line">    <span class='keyword'>if</span> (sig_nid &amp;&amp; OBJ_find_sigid_algs(sig_nid, &amp;md_nid, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="4169"><td class="num" id="LN4169">4169</td><td class="line">        <span class='keyword'>const</span> EVP_MD *md;</td></tr>
<tr class="codeline" data-linenumber="4170"><td class="num" id="LN4170">4170</td><td class="line">        <span class='keyword'>if</span> (md_nid &amp;&amp; (md = <span class='macro'>EVP_get_digestbynid(md_nid)<span class='macro_popup'>EVP_get_digestbyname(OBJ_nid2sn(md_nid))</span></span>))</td></tr>
<tr class="codeline" data-linenumber="4171"><td class="num" id="LN4171">4171</td><td class="line">            secbits = EVP_MD_size(md) * 4;</td></tr>
<tr class="codeline" data-linenumber="4172"><td class="num" id="LN4172">4172</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4173"><td class="num" id="LN4173">4173</td><td class="line">    <span class='keyword'>if</span> (s)</td></tr>
<tr class="codeline" data-linenumber="4174"><td class="num" id="LN4174">4174</td><td class="line">        <span class='keyword'>return</span> ssl_security(s, op, secbits, md_nid, x);</td></tr>
<tr class="codeline" data-linenumber="4175"><td class="num" id="LN4175">4175</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="4176"><td class="num" id="LN4176">4176</td><td class="line">        <span class='keyword'>return</span> ssl_ctx_security(ctx, op, secbits, md_nid, x);</td></tr>
<tr class="codeline" data-linenumber="4177"><td class="num" id="LN4177">4177</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4178"><td class="num" id="LN4178">4178</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4179"><td class="num" id="LN4179">4179</td><td class="line"><span class='keyword'>int</span> ssl_security_cert(SSL *s, SSL_CTX *ctx, X509 *x, <span class='keyword'>int</span> vfy, <span class='keyword'>int</span> is_ee)</td></tr>
<tr class="codeline" data-linenumber="4180"><td class="num" id="LN4180">4180</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4181"><td class="num" id="LN4181">4181</td><td class="line">    <span class='keyword'>if</span> (vfy)</td></tr>
<tr class="codeline" data-linenumber="4182"><td class="num" id="LN4182">4182</td><td class="line">        vfy = <span class='macro'>SSL_SECOP_PEER<span class='macro_popup'>0x1000</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4183"><td class="num" id="LN4183">4183</td><td class="line">    <span class='keyword'>if</span> (is_ee) {</td></tr>
<tr class="codeline" data-linenumber="4184"><td class="num" id="LN4184">4184</td><td class="line">        <span class='keyword'>if</span> (!ssl_security_cert_key(s, ctx, x, <span class='macro'>SSL_SECOP_EE_KEY<span class='macro_popup'>(16 | (6 &lt;&lt; 16))</span></span> | vfy))</td></tr>
<tr class="codeline" data-linenumber="4185"><td class="num" id="LN4185">4185</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>SSL_R_EE_KEY_TOO_SMALL<span class='macro_popup'>399</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4186"><td class="num" id="LN4186">4186</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="4187"><td class="num" id="LN4187">4187</td><td class="line">        <span class='keyword'>if</span> (!ssl_security_cert_key(s, ctx, x, <span class='macro'>SSL_SECOP_CA_KEY<span class='macro_popup'>(17 | (6 &lt;&lt; 16))</span></span> | vfy))</td></tr>
<tr class="codeline" data-linenumber="4188"><td class="num" id="LN4188">4188</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>SSL_R_CA_KEY_TOO_SMALL<span class='macro_popup'>397</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4189"><td class="num" id="LN4189">4189</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4190"><td class="num" id="LN4190">4190</td><td class="line">    <span class='keyword'>if</span> (!ssl_security_cert_sig(s, ctx, x, <span class='macro'>SSL_SECOP_CA_MD<span class='macro_popup'>(18 | (6 &lt;&lt; 16))</span></span> | vfy))</td></tr>
<tr class="codeline" data-linenumber="4191"><td class="num" id="LN4191">4191</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>SSL_R_CA_MD_TOO_WEAK<span class='macro_popup'>398</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4192"><td class="num" id="LN4192">4192</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="4193"><td class="num" id="LN4193">4193</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4194"><td class="num" id="LN4194">4194</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4195"><td class="num" id="LN4195">4195</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4196"><td class="num" id="LN4196">4196</td><td class="line"> <span class='comment'>* Check security of a chain, if |sk| includes the end entity certificate then</span></td></tr>
<tr class="codeline" data-linenumber="4197"><td class="num" id="LN4197">4197</td><td class="line"> <span class='comment'>* |x| is NULL. If |vfy| is 1 then we are verifying a peer chain and not sending</span></td></tr>
<tr class="codeline" data-linenumber="4198"><td class="num" id="LN4198">4198</td><td class="line"> <span class='comment'>* one to the peer. Return values: 1 if ok otherwise error code to use</span></td></tr>
<tr class="codeline" data-linenumber="4199"><td class="num" id="LN4199">4199</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4200"><td class="num" id="LN4200">4200</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4201"><td class="num" id="LN4201">4201</td><td class="line"><span class='keyword'>int</span> ssl_security_cert_chain(SSL *s, <span class='macro'>STACK_OF(X509)<span class='macro_popup'>struct stack_st_X509</span></span> *sk, X509 *x, <span class='keyword'>int</span> vfy)</td></tr>
<tr class="codeline" data-linenumber="4202"><td class="num" id="LN4202">4202</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4203"><td class="num" id="LN4203">4203</td><td class="line">    <span class='keyword'>int</span> rv, start_idx, i;</td></tr>
<tr class="codeline" data-linenumber="4204"><td class="num" id="LN4204">4204</td><td class="line">    <span class='keyword'>if</span> (x == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4205"><td class="num" id="LN4205">4205</td><td class="line">        x = sk_X509_value(sk, 0);</td></tr>
<tr class="codeline" data-linenumber="4206"><td class="num" id="LN4206">4206</td><td class="line">        start_idx = 1;</td></tr>
<tr class="codeline" data-linenumber="4207"><td class="num" id="LN4207">4207</td><td class="line">    } <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="4208"><td class="num" id="LN4208">4208</td><td class="line">        start_idx = 0;</td></tr>
<tr class="codeline" data-linenumber="4209"><td class="num" id="LN4209">4209</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4210"><td class="num" id="LN4210">4210</td><td class="line">    rv = ssl_security_cert(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, x, vfy, 1);</td></tr>
<tr class="codeline" data-linenumber="4211"><td class="num" id="LN4211">4211</td><td class="line">    <span class='keyword'>if</span> (rv != 1)</td></tr>
<tr class="codeline" data-linenumber="4212"><td class="num" id="LN4212">4212</td><td class="line">        <span class='keyword'>return</span> rv;</td></tr>
<tr class="codeline" data-linenumber="4213"><td class="num" id="LN4213">4213</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4214"><td class="num" id="LN4214">4214</td><td class="line">    <span class='keyword'>for</span> (i = start_idx; i &lt; sk_X509_num(sk); i++) {</td></tr>
<tr class="codeline" data-linenumber="4215"><td class="num" id="LN4215">4215</td><td class="line">        x = sk_X509_value(sk, i);</td></tr>
<tr class="codeline" data-linenumber="4216"><td class="num" id="LN4216">4216</td><td class="line">        rv = ssl_security_cert(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, x, vfy, 0);</td></tr>
<tr class="codeline" data-linenumber="4217"><td class="num" id="LN4217">4217</td><td class="line">        <span class='keyword'>if</span> (rv != 1)</td></tr>
<tr class="codeline" data-linenumber="4218"><td class="num" id="LN4218">4218</td><td class="line">            <span class='keyword'>return</span> rv;</td></tr>
<tr class="codeline" data-linenumber="4219"><td class="num" id="LN4219">4219</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4220"><td class="num" id="LN4220">4220</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="4221"><td class="num" id="LN4221">4221</td><td class="line">}</td></tr>
</table></body></html>
