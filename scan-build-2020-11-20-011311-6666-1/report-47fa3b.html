<!doctype html>
<html>
<head>
<title>test/bad_dtls_test.c</title>

<style type="text/css">
body { color:#000000; background-color:#ffffff }
body { font-family:Helvetica, sans-serif; font-size:10pt }
h1 { font-size:14pt }
.FileName { margin-top: 5px; margin-bottom: 5px; display: inline; }
.FileNav { margin-left: 5px; margin-right: 5px; display: inline; }
.FileNav a { text-decoration:none; font-size: larger; }
.divider { margin-top: 30px; margin-bottom: 30px; height: 15px; }
.divider { background-color: gray; }
.code { border-collapse:collapse; width:100%; }
.code { font-family: "Monospace", monospace; font-size:10pt }
.code { line-height: 1.2em }
.comment { color: green; font-style: oblique }
.keyword { color: blue }
.string_literal { color: red }
.directive { color: darkmagenta }

/* Macros and variables could have pop-up notes hidden by default.
  - Macro pop-up:    expansion of the macro
  - Variable pop-up: value (table) of the variable */
.macro_popup, .variable_popup { display: none; }

/* Pop-up appears on mouse-hover event. */
.macro:hover .macro_popup, .variable:hover .variable_popup {
  display: block;
  padding: 2px;
  -webkit-border-radius:5px;
  -webkit-box-shadow:1px 1px 7px #000;
  border-radius:5px;
  box-shadow:1px 1px 7px #000;
  position: absolute;
  top: -1em;
  left:10em;
  z-index: 1
}

.macro_popup {
  border: 2px solid red;
  background-color:#FFF0F0;
  font-weight: normal;
}

.variable_popup {
  border: 2px solid blue;
  background-color:#F0F0FF;
  font-weight: bold;
  font-family: Helvetica, sans-serif;
  font-size: 9pt;
}

/* Pop-up notes needs a relative position as a base where they pops up. */
.macro, .variable {
  background-color: PaleGoldenRod;
  position: relative;
}
.macro { color: DarkMagenta; }

#tooltiphint {
  position: fixed;
  width: 50em;
  margin-left: -25em;
  left: 50%;
  padding: 10px;
  border: 1px solid #b0b0b0;
  border-radius: 2px;
  box-shadow: 1px 1px 7px black;
  background-color: #c0c0c0;
  z-index: 2;
}

.num { width:2.5em; padding-right:2ex; background-color:#eeeeee }
.num { text-align:right; font-size:8pt }
.num { color:#444444 }
.line { padding-left: 1ex; border-left: 3px solid #ccc }
.line { white-space: pre }
.msg { -webkit-box-shadow:1px 1px 7px #000 }
.msg { box-shadow:1px 1px 7px #000 }
.msg { -webkit-border-radius:5px }
.msg { border-radius:5px }
.msg { font-family:Helvetica, sans-serif; font-size:8pt }
.msg { float:left }
.msg { padding:0.25em 1ex 0.25em 1ex }
.msg { margin-top:10px; margin-bottom:10px }
.msg { font-weight:bold }
.msg { max-width:60em; word-wrap: break-word; white-space: pre-wrap }
.msgT { padding:0x; spacing:0x }
.msgEvent { background-color:#fff8b4; color:#000000 }
.msgControl { background-color:#bbbbbb; color:#000000 }
.msgNote { background-color:#ddeeff; color:#000000 }
.mrange { background-color:#dfddf3 }
.mrange { border-bottom:1px solid #6F9DBE }
.PathIndex { font-weight: bold; padding:0px 5px; margin-right:5px; }
.PathIndex { -webkit-border-radius:8px }
.PathIndex { border-radius:8px }
.PathIndexEvent { background-color:#bfba87 }
.PathIndexControl { background-color:#8c8c8c }
.PathIndexPopUp { background-color: #879abc; }
.PathNav a { text-decoration:none; font-size: larger }
.CodeInsertionHint { font-weight: bold; background-color: #10dd10 }
.CodeRemovalHint { background-color:#de1010 }
.CodeRemovalHint { border-bottom:1px solid #6F9DBE }
.selected{ background-color:orange !important; }

table.simpletable {
  padding: 5px;
  font-size:12pt;
  margin:20px;
  border-collapse: collapse; border-spacing: 0px;
}
td.rowname {
  text-align: right;
  vertical-align: top;
  font-weight: bold;
  color:#444444;
  padding-right:2ex;
}

/* Hidden text. */
input.spoilerhider + label {
  cursor: pointer;
  text-decoration: underline;
  display: block;
}
input.spoilerhider {
 display: none;
}
input.spoilerhider ~ .spoiler {
  overflow: hidden;
  margin: 10px auto 0;
  height: 0;
  opacity: 0;
}
input.spoilerhider:checked + label + .spoiler{
  height: auto;
  opacity: 1;
}
</style>
</head>
<body>
<!-- BUGDESC Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11 -->

<!-- BUGTYPE Potential insecure memory buffer bounds restriction in call 'memcpy' -->

<!-- BUGCATEGORY Security -->

<!-- BUGFILE /tmp/real/c_wrk/wrk0/obj/openssl-1.1.0g/test/bad_dtls_test.c -->

<!-- FILENAME bad_dtls_test.c -->

<!-- FUNCTIONNAME send_server_hello -->

<!-- ISSUEHASHCONTENTOFLINEINCONTEXT 61e85f12bad9c7cb3d6df117f7859295 -->

<!-- BUGLINE 257 -->

<!-- BUGCOLUMN 5 -->

<!-- BUGPATHLENGTH 1 -->

<!-- BUGMETAEND -->
<!-- REPORTHEADER -->
<h3>Bug Summary</h3>
<table class="simpletable">
<tr><td class="rowname">File:</td><td>obj/openssl-1.1.0g/test/bad_dtls_test.c</td></tr>
<tr><td class="rowname">Warning:</td><td><a href="#EndPath">line 257, column 5</a><br />Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11</td></tr>

</table>
<!-- REPORTSUMMARYEXTRA -->
<h3>Annotated Source Code</h3>
<p>Press <a href="#" onclick="toggleHelp(); return false;">'?'</a>
   to see keyboard shortcuts</p>
<input type="checkbox" class="spoilerhider" id="showinvocation" />
<label for="showinvocation" >Show analyzer invocation</label>
<div class="spoiler">clang -cc1 -cc1 -triple x86_64-unknown-linux-gnu -analyze -disable-free -main-file-name bad_dtls_test.c -analyzer-store=region -analyzer-opt-analyze-nested-blocks -analyzer-checker=core -analyzer-checker=apiModeling -analyzer-checker=unix -analyzer-checker=deadcode -analyzer-checker=security.insecureAPI.UncheckedReturn -analyzer-checker=security.insecureAPI.getpw -analyzer-checker=security.insecureAPI.gets -analyzer-checker=security.insecureAPI.mktemp -analyzer-checker=security.insecureAPI.mkstemp -analyzer-checker=security.insecureAPI.vfork -analyzer-checker=nullability.NullPassedToNonnull -analyzer-checker=nullability.NullReturnedFromNonnull -analyzer-output plist -w -setup-static-analyzer -mrelocation-model static -mframe-pointer=none -fmath-errno -fno-rounding-math -mconstructor-aliases -munwind-tables -target-cpu x86-64 -fno-split-dwarf-inlining -debugger-tuning=gdb -resource-dir /llvm-project/build/lib/clang/12.0.0 -I include -D DSO_DLFCN -D HAVE_DLFCN_H -D NDEBUG -D OPENSSL_THREADS -D OPENSSL_NO_DYNAMIC_ENGINE -D OPENSSL_PIC -D OPENSSL_IA32_SSE2 -D OPENSSL_BN_ASM_MONT -D OPENSSL_BN_ASM_MONT5 -D OPENSSL_BN_ASM_GF2m -D SHA1_ASM -D SHA256_ASM -D SHA512_ASM -D RC4_ASM -D MD5_ASM -D AES_ASM -D VPAES_ASM -D BSAES_ASM -D GHASH_ASM -D ECP_NISTZ256_ASM -D PADLOCK_ASM -D POLY1305_ASM -D OPENSSLDIR="/tmp/real/c_wrk/wrk0/obj/ssl" -D ENGINESDIR="/tmp/real/c_wrk/wrk0/obj/lib/engines-1.1" -D L_ENDIAN -internal-isystem /usr/local/include -internal-isystem /llvm-project/build/lib/clang/12.0.0/include -internal-externc-isystem /usr/include/x86_64-linux-gnu -internal-externc-isystem /include -internal-externc-isystem /usr/include -O3 -fdebug-compilation-dir /tmp/real/c_wrk/wrk0/obj/openssl-1.1.0g -ferror-limit 19 -fgnuc-version=4.2.1 -vectorize-loops -vectorize-slp -analyzer-checker core -analyzer-checker cplusplus -analyzer-checker nullability -analyzer-checker optin -analyzer-checker security -analyzer-checker unix -analyzer-checker osx -analyzer-checker fuchsia -analyzer-checker webkit -analyzer-output=html -faddrsig -o /tmp/scan-build-2020-11-20-011311-6666-1 -x c test/bad_dtls_test.c
</div>
<div id='tooltiphint' hidden="true">
  <p>Keyboard shortcuts: </p>
  <ul>
    <li>Use 'j/k' keys for keyboard navigation</li>
    <li>Use 'Shift+S' to show/hide relevant lines</li>
    <li>Use '?' to toggle this window</li>
  </ul>
  <a href="#" onclick="toggleHelp(); return false;">Close</a>
</div>
<script type='text/javascript'>
var relevant_lines = {"1": {"257": 1}};

var filterCounterexample = function (hide) {
  var tables = document.getElementsByClassName("code");
  for (var t=0; t<tables.length; t++) {
    var table = tables[t];
    var file_id = table.getAttribute("data-fileid");
    var lines_in_fid = relevant_lines[file_id];
    if (!lines_in_fid) {
      lines_in_fid = {};
    }
    var lines = table.getElementsByClassName("codeline");
    for (var i=0; i<lines.length; i++) {
        var el = lines[i];
        var lineNo = el.getAttribute("data-linenumber");
        if (!lines_in_fid[lineNo]) {
          if (hide) {
            el.setAttribute("hidden", "");
          } else {
            el.removeAttribute("hidden");
          }
        }
    }
  }
}

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "S") {
    var checked = document.getElementsByName("showCounterexample")[0].checked;
    filterCounterexample(!checked);
    document.getElementsByName("showCounterexample")[0].checked = !checked;
  } else {
    return;
  }
  event.preventDefault();
}, true);

document.addEventListener("DOMContentLoaded", function() {
    document.querySelector('input[name="showCounterexample"]').onchange=
        function (event) {
      filterCounterexample(this.checked);
    };
});
</script>

<form>
    <input type="checkbox" name="showCounterexample" id="showCounterexample" />
    <label for="showCounterexample">
       Show only relevant lines
    </label>
</form>

<script type='text/javascript'>
var digitMatcher = new RegExp("[0-9]+");

var querySelectorAllArray = function(selector) {
  return Array.prototype.slice.call(
    document.querySelectorAll(selector));
}

document.addEventListener("DOMContentLoaded", function() {
    querySelectorAllArray(".PathNav > a").forEach(
        function(currentValue, currentIndex) {
            var hrefValue = currentValue.getAttribute("href");
            currentValue.onclick = function() {
                scrollTo(document.querySelector(hrefValue));
                return false;
            };
        });
});

var findNum = function() {
    var s = document.querySelector(".selected");
    if (!s || s.id == "EndPath") {
        return 0;
    }
    var out = parseInt(digitMatcher.exec(s.id)[0]);
    return out;
};

var scrollTo = function(el) {
    querySelectorAllArray(".selected").forEach(function(s) {
        s.classList.remove("selected");
    });
    el.classList.add("selected");
    window.scrollBy(0, el.getBoundingClientRect().top -
        (window.innerHeight / 2));
}

var move = function(num, up, numItems) {
  if (num == 1 && up || num == numItems - 1 && !up) {
    return 0;
  } else if (num == 0 && up) {
    return numItems - 1;
  } else if (num == 0 && !up) {
    return 1 % numItems;
  }
  return up ? num - 1 : num + 1;
}

var numToId = function(num) {
  if (num == 0) {
    return document.getElementById("EndPath")
  }
  return document.getElementById("Path" + num);
};

var navigateTo = function(up) {
  var numItems = document.querySelectorAll(
      ".line > .msgEvent, .line > .msgControl").length;
  var currentSelected = findNum();
  var newSelected = move(currentSelected, up, numItems);
  var newEl = numToId(newSelected, numItems);

  // Scroll element into center.
  scrollTo(newEl);
};

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "j") {
    navigateTo(/*up=*/false);
  } else if (event.key == "k") {
    navigateTo(/*up=*/true);
  } else {
    return;
  }
  event.preventDefault();
}, true);
</script>
  
<script type='text/javascript'>

var toggleHelp = function() {
    var hint = document.querySelector("#tooltiphint");
    var attributeName = "hidden";
    if (hint.hasAttribute(attributeName)) {
      hint.removeAttribute(attributeName);
    } else {
      hint.setAttribute("hidden", "true");
    }
};
window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "?") {
    toggleHelp();
  } else {
    return;
  }
  event.preventDefault();
});
</script>
<table class="code" data-fileid="1">
<tr class="codeline" data-linenumber="1"><td class="num" id="LN1">1</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2"><td class="num" id="LN2">2</td><td class="line"> <span class='comment'>* Copyright 2016 The OpenSSL Project Authors. All Rights Reserved.</span></td></tr>
<tr class="codeline" data-linenumber="3"><td class="num" id="LN3">3</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="4"><td class="num" id="LN4">4</td><td class="line"> <span class='comment'>* Licensed under the OpenSSL license (the "License").  You may not use</span></td></tr>
<tr class="codeline" data-linenumber="5"><td class="num" id="LN5">5</td><td class="line"> <span class='comment'>* this file except in compliance with the License.  You can obtain a copy</span></td></tr>
<tr class="codeline" data-linenumber="6"><td class="num" id="LN6">6</td><td class="line"> <span class='comment'>* in the file LICENSE in the source distribution or at</span></td></tr>
<tr class="codeline" data-linenumber="7"><td class="num" id="LN7">7</td><td class="line"> <span class='comment'>* https://www.openssl.org/source/license.html</span></td></tr>
<tr class="codeline" data-linenumber="8"><td class="num" id="LN8">8</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="9"><td class="num" id="LN9">9</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="10"><td class="num" id="LN10">10</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="11"><td class="num" id="LN11">11</td><td class="line"> <span class='comment'>* Unit test for Cisco DTLS1_BAD_VER session resume, as used by</span></td></tr>
<tr class="codeline" data-linenumber="12"><td class="num" id="LN12">12</td><td class="line"> <span class='comment'>* AnyConnect VPN protocol.</span></td></tr>
<tr class="codeline" data-linenumber="13"><td class="num" id="LN13">13</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="14"><td class="num" id="LN14">14</td><td class="line"> <span class='comment'>* This is designed to exercise the code paths in</span></td></tr>
<tr class="codeline" data-linenumber="15"><td class="num" id="LN15">15</td><td class="line"> <span class='comment'>* http://git.infradead.org/users/dwmw2/openconnect.git/blob/HEAD:/dtls.c</span></td></tr>
<tr class="codeline" data-linenumber="16"><td class="num" id="LN16">16</td><td class="line"> <span class='comment'>* which have frequently been affected by regressions in DTLS1_BAD_VER</span></td></tr>
<tr class="codeline" data-linenumber="17"><td class="num" id="LN17">17</td><td class="line"> <span class='comment'>* support.</span></td></tr>
<tr class="codeline" data-linenumber="18"><td class="num" id="LN18">18</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="19"><td class="num" id="LN19">19</td><td class="line"> <span class='comment'>* Note that unlike other SSL tests, we don't test against our own SSL</span></td></tr>
<tr class="codeline" data-linenumber="20"><td class="num" id="LN20">20</td><td class="line"> <span class='comment'>* server method. Firstly because we don't have one; we *only* support</span></td></tr>
<tr class="codeline" data-linenumber="21"><td class="num" id="LN21">21</td><td class="line"> <span class='comment'>* DTLS1_BAD_VER as a client. And secondly because even if that were</span></td></tr>
<tr class="codeline" data-linenumber="22"><td class="num" id="LN22">22</td><td class="line"> <span class='comment'>* fixed up it's the wrong thing to test against â€” because if changes</span></td></tr>
<tr class="codeline" data-linenumber="23"><td class="num" id="LN23">23</td><td class="line"> <span class='comment'>* are made in generic DTLS code which don't take DTLS1_BAD_VER into</span></td></tr>
<tr class="codeline" data-linenumber="24"><td class="num" id="LN24">24</td><td class="line"> <span class='comment'>* account, there's plenty of scope for making those changes such that</span></td></tr>
<tr class="codeline" data-linenumber="25"><td class="num" id="LN25">25</td><td class="line"> <span class='comment'>* they break *both* the client and the server in the same way.</span></td></tr>
<tr class="codeline" data-linenumber="26"><td class="num" id="LN26">26</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="27"><td class="num" id="LN27">27</td><td class="line"> <span class='comment'>* So we handle the server side manually. In a session resume there isn't</span></td></tr>
<tr class="codeline" data-linenumber="28"><td class="num" id="LN28">28</td><td class="line"> <span class='comment'>* much to be done anyway.</span></td></tr>
<tr class="codeline" data-linenumber="29"><td class="num" id="LN29">29</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="30"><td class="num" id="LN30">30</td><td class="line"><span class='directive'>#include &lt;string.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="31"><td class="num" id="LN31">31</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="32"><td class="num" id="LN32">32</td><td class="line"><span class='directive'>#include &lt;openssl/opensslconf.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="33"><td class="num" id="LN33">33</td><td class="line"><span class='directive'>#include &lt;openssl/bio.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="34"><td class="num" id="LN34">34</td><td class="line"><span class='directive'>#include &lt;openssl/crypto.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="35"><td class="num" id="LN35">35</td><td class="line"><span class='directive'>#include &lt;openssl/evp.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="36"><td class="num" id="LN36">36</td><td class="line"><span class='directive'>#include &lt;openssl/ssl.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="37"><td class="num" id="LN37">37</td><td class="line"><span class='directive'>#include &lt;openssl/err.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="38"><td class="num" id="LN38">38</td><td class="line"><span class='directive'>#include &lt;openssl/rand.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="39"><td class="num" id="LN39">39</td><td class="line"><span class='directive'>#include &lt;openssl/kdf.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="40"><td class="num" id="LN40">40</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="41"><td class="num" id="LN41">41</td><td class="line"><span class='directive'>#include "../ssl/packet_locl.h"</span></td></tr>
<tr class="codeline" data-linenumber="42"><td class="num" id="LN42">42</td><td class="line"><span class='directive'>#include "../e_os.h" /* for OSSL_NELEM() */</span></td></tr>
<tr class="codeline" data-linenumber="43"><td class="num" id="LN43">43</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="44"><td class="num" id="LN44">44</td><td class="line"><span class='comment'>/* For DTLS1_BAD_VER packets the MAC doesn't include the handshake header */</span></td></tr>
<tr class="codeline" data-linenumber="45"><td class="num" id="LN45">45</td><td class="line"><span class='directive'>#define <span class='macro'>MAC_OFFSET<span class='macro_popup'>(13 + 12)</span></span> (<span class='macro'>DTLS1_RT_HEADER_LENGTH<span class='macro_popup'>13</span></span> + <span class='macro'>DTLS1_HM_HEADER_LENGTH<span class='macro_popup'>12</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="46"><td class="num" id="LN46">46</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="47"><td class="num" id="LN47">47</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> client_random[<span class='macro'>SSL3_RANDOM_SIZE<span class='macro_popup'>32</span></span>];</td></tr>
<tr class="codeline" data-linenumber="48"><td class="num" id="LN48">48</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> server_random[<span class='macro'>SSL3_RANDOM_SIZE<span class='macro_popup'>32</span></span>];</td></tr>
<tr class="codeline" data-linenumber="49"><td class="num" id="LN49">49</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="50"><td class="num" id="LN50">50</td><td class="line"><span class='comment'>/* These are all generated locally, sized purely according to our own whim */</span></td></tr>
<tr class="codeline" data-linenumber="51"><td class="num" id="LN51">51</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> session_id[32];</td></tr>
<tr class="codeline" data-linenumber="52"><td class="num" id="LN52">52</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> master_secret[48];</td></tr>
<tr class="codeline" data-linenumber="53"><td class="num" id="LN53">53</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> cookie[20];</td></tr>
<tr class="codeline" data-linenumber="54"><td class="num" id="LN54">54</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="55"><td class="num" id="LN55">55</td><td class="line"><span class='comment'>/* We've hard-coded the cipher suite; we know it's 104 bytes */</span></td></tr>
<tr class="codeline" data-linenumber="56"><td class="num" id="LN56">56</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> key_block[104];</td></tr>
<tr class="codeline" data-linenumber="57"><td class="num" id="LN57">57</td><td class="line"><span class='directive'>#define <span class='macro'>mac_key<span class='macro_popup'>(key_block + 20)</span></span> (key_block + 20)</span></td></tr>
<tr class="codeline" data-linenumber="58"><td class="num" id="LN58">58</td><td class="line"><span class='directive'>#define <span class='macro'>dec_key<span class='macro_popup'>(key_block + 40)</span></span> (key_block + 40)</span></td></tr>
<tr class="codeline" data-linenumber="59"><td class="num" id="LN59">59</td><td class="line"><span class='directive'>#define <span class='macro'>enc_key<span class='macro_popup'>(key_block + 56)</span></span> (key_block + 56)</span></td></tr>
<tr class="codeline" data-linenumber="60"><td class="num" id="LN60">60</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="61"><td class="num" id="LN61">61</td><td class="line"><span class='keyword'>static</span> EVP_MD_CTX *handshake_md;</td></tr>
<tr class="codeline" data-linenumber="62"><td class="num" id="LN62">62</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="63"><td class="num" id="LN63">63</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> do_PRF(<span class='keyword'>const</span> <span class='keyword'>void</span> *seed1, <span class='keyword'>int</span> seed1_len,</td></tr>
<tr class="codeline" data-linenumber="64"><td class="num" id="LN64">64</td><td class="line">                  <span class='keyword'>const</span> <span class='keyword'>void</span> *seed2, <span class='keyword'>int</span> seed2_len,</td></tr>
<tr class="codeline" data-linenumber="65"><td class="num" id="LN65">65</td><td class="line">                  <span class='keyword'>const</span> <span class='keyword'>void</span> *seed3, <span class='keyword'>int</span> seed3_len,</td></tr>
<tr class="codeline" data-linenumber="66"><td class="num" id="LN66">66</td><td class="line">                  <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *out, <span class='keyword'>int</span> olen)</td></tr>
<tr class="codeline" data-linenumber="67"><td class="num" id="LN67">67</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="68"><td class="num" id="LN68">68</td><td class="line">    EVP_PKEY_CTX *pctx = EVP_PKEY_CTX_new_id(<span class='macro'>EVP_PKEY_TLS1_PRF<span class='macro_popup'>1021</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="69"><td class="num" id="LN69">69</td><td class="line">    size_t outlen = olen;</td></tr>
<tr class="codeline" data-linenumber="70"><td class="num" id="LN70">70</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="71"><td class="num" id="LN71">71</td><td class="line">    <span class='comment'>/* No error handling. If it all screws up, the test will fail anyway */</span></td></tr>
<tr class="codeline" data-linenumber="72"><td class="num" id="LN72">72</td><td class="line">    EVP_PKEY_derive_init(pctx);</td></tr>
<tr class="codeline" data-linenumber="73"><td class="num" id="LN73">73</td><td class="line">    <span class='macro'>EVP_PKEY_CTX_set_tls1_prf_md(pctx, EVP_md5_sha1())<span class='macro_popup'>EVP_PKEY_CTX_ctrl(pctx, -1, (1&lt;&lt;10), (0x1000), 0, (void<br> *)EVP_md5_sha1())</span></span>;</td></tr>
<tr class="codeline" data-linenumber="74"><td class="num" id="LN74">74</td><td class="line">    <span class='macro'>EVP_PKEY_CTX_set1_tls1_prf_secret(pctx, master_secret, <span class='keyword'>sizeof</span>(master_secret))<span class='macro_popup'>EVP_PKEY_CTX_ctrl(pctx, -1, (1&lt;&lt;10), (0x1000 + 1), sizeof<br>(master_secret), (void *)master_secret)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="75"><td class="num" id="LN75">75</td><td class="line">    <span class='macro'>EVP_PKEY_CTX_add1_tls1_prf_seed(pctx, seed1, seed1_len)<span class='macro_popup'>EVP_PKEY_CTX_ctrl(pctx, -1, (1&lt;&lt;10), (0x1000 + 2), seed1_len<br>, (void *)seed1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="76"><td class="num" id="LN76">76</td><td class="line">    <span class='macro'>EVP_PKEY_CTX_add1_tls1_prf_seed(pctx, seed2, seed2_len)<span class='macro_popup'>EVP_PKEY_CTX_ctrl(pctx, -1, (1&lt;&lt;10), (0x1000 + 2), seed2_len<br>, (void *)seed2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="77"><td class="num" id="LN77">77</td><td class="line">    <span class='macro'>EVP_PKEY_CTX_add1_tls1_prf_seed(pctx, seed3, seed3_len)<span class='macro_popup'>EVP_PKEY_CTX_ctrl(pctx, -1, (1&lt;&lt;10), (0x1000 + 2), seed3_len<br>, (void *)seed3)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="78"><td class="num" id="LN78">78</td><td class="line">    EVP_PKEY_derive(pctx, out, &amp;outlen);</td></tr>
<tr class="codeline" data-linenumber="79"><td class="num" id="LN79">79</td><td class="line">    EVP_PKEY_CTX_free(pctx);</td></tr>
<tr class="codeline" data-linenumber="80"><td class="num" id="LN80">80</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="81"><td class="num" id="LN81">81</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="82"><td class="num" id="LN82">82</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="83"><td class="num" id="LN83">83</td><td class="line"><span class='keyword'>static</span> SSL_SESSION *client_session(<span class='keyword'>void</span>)</td></tr>
<tr class="codeline" data-linenumber="84"><td class="num" id="LN84">84</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="85"><td class="num" id="LN85">85</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> session_asn1[] = {</td></tr>
<tr class="codeline" data-linenumber="86"><td class="num" id="LN86">86</td><td class="line">        0x30, 0x5F,              <span class='comment'>/* SEQUENCE, length 0x5F */</span></td></tr>
<tr class="codeline" data-linenumber="87"><td class="num" id="LN87">87</td><td class="line">        0x02, 0x01, 0x01,        <span class='comment'>/* INTEGER, SSL_SESSION_ASN1_VERSION */</span></td></tr>
<tr class="codeline" data-linenumber="88"><td class="num" id="LN88">88</td><td class="line">        0x02, 0x02, 0x01, 0x00,  <span class='comment'>/* INTEGER, DTLS1_BAD_VER */</span></td></tr>
<tr class="codeline" data-linenumber="89"><td class="num" id="LN89">89</td><td class="line">        0x04, 0x02, 0x00, 0x2F,  <span class='comment'>/* OCTET_STRING, AES128-SHA */</span></td></tr>
<tr class="codeline" data-linenumber="90"><td class="num" id="LN90">90</td><td class="line">        0x04, 0x20,              <span class='comment'>/* OCTET_STRING, session id */</span></td></tr>
<tr class="codeline" data-linenumber="91"><td class="num" id="LN91">91</td><td class="line"><span class='directive'>#define <span class='macro'>SS_SESSID_OFS<span class='macro_popup'>15</span></span> 15 /* Session ID goes here */</span></td></tr>
<tr class="codeline" data-linenumber="92"><td class="num" id="LN92">92</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</td></tr>
<tr class="codeline" data-linenumber="93"><td class="num" id="LN93">93</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</td></tr>
<tr class="codeline" data-linenumber="94"><td class="num" id="LN94">94</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</td></tr>
<tr class="codeline" data-linenumber="95"><td class="num" id="LN95">95</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</td></tr>
<tr class="codeline" data-linenumber="96"><td class="num" id="LN96">96</td><td class="line">        0x04, 0x30,              <span class='comment'>/* OCTET_STRING, master secret */</span></td></tr>
<tr class="codeline" data-linenumber="97"><td class="num" id="LN97">97</td><td class="line"><span class='directive'>#define <span class='macro'>SS_SECRET_OFS<span class='macro_popup'>49</span></span> 49 /* Master secret goes here */</span></td></tr>
<tr class="codeline" data-linenumber="98"><td class="num" id="LN98">98</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</td></tr>
<tr class="codeline" data-linenumber="99"><td class="num" id="LN99">99</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</td></tr>
<tr class="codeline" data-linenumber="100"><td class="num" id="LN100">100</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</td></tr>
<tr class="codeline" data-linenumber="101"><td class="num" id="LN101">101</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</td></tr>
<tr class="codeline" data-linenumber="102"><td class="num" id="LN102">102</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</td></tr>
<tr class="codeline" data-linenumber="103"><td class="num" id="LN103">103</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</td></tr>
<tr class="codeline" data-linenumber="104"><td class="num" id="LN104">104</td><td class="line">    };</td></tr>
<tr class="codeline" data-linenumber="105"><td class="num" id="LN105">105</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p = session_asn1;</td></tr>
<tr class="codeline" data-linenumber="106"><td class="num" id="LN106">106</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="107"><td class="num" id="LN107">107</td><td class="line">    <span class='comment'>/* Copy the randomly-generated fields into the above ASN1 */</span></td></tr>
<tr class="codeline" data-linenumber="108"><td class="num" id="LN108">108</td><td class="line">    memcpy(session_asn1 + <span class='macro'>SS_SESSID_OFS<span class='macro_popup'>15</span></span>, session_id, <span class='keyword'>sizeof</span>(session_id));</td></tr>
<tr class="codeline" data-linenumber="109"><td class="num" id="LN109">109</td><td class="line">    memcpy(session_asn1 + <span class='macro'>SS_SECRET_OFS<span class='macro_popup'>49</span></span>, master_secret, <span class='keyword'>sizeof</span>(master_secret));</td></tr>
<tr class="codeline" data-linenumber="110"><td class="num" id="LN110">110</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="111"><td class="num" id="LN111">111</td><td class="line">    <span class='keyword'>return</span> d2i_SSL_SESSION(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, &amp;p, <span class='keyword'>sizeof</span>(session_asn1));</td></tr>
<tr class="codeline" data-linenumber="112"><td class="num" id="LN112">112</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="113"><td class="num" id="LN113">113</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="114"><td class="num" id="LN114">114</td><td class="line"><span class='comment'>/* Returns 1 for initial ClientHello, 2 for ClientHello with cookie */</span></td></tr>
<tr class="codeline" data-linenumber="115"><td class="num" id="LN115">115</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> validate_client_hello(BIO *wbio)</td></tr>
<tr class="codeline" data-linenumber="116"><td class="num" id="LN116">116</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="117"><td class="num" id="LN117">117</td><td class="line">    PACKET pkt, pkt2;</td></tr>
<tr class="codeline" data-linenumber="118"><td class="num" id="LN118">118</td><td class="line">    <span class='keyword'>long</span> len;</td></tr>
<tr class="codeline" data-linenumber="119"><td class="num" id="LN119">119</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *data;</td></tr>
<tr class="codeline" data-linenumber="120"><td class="num" id="LN120">120</td><td class="line">    <span class='keyword'>int</span> cookie_found = 0;</td></tr>
<tr class="codeline" data-linenumber="121"><td class="num" id="LN121">121</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> u;</td></tr>
<tr class="codeline" data-linenumber="122"><td class="num" id="LN122">122</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="123"><td class="num" id="LN123">123</td><td class="line">    len = <span class='macro'>BIO_get_mem_data(wbio, (<span class='keyword'>char</span> **)&amp;data)<span class='macro_popup'>BIO_ctrl(wbio,3,0,(char *)(char **)&amp;data)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="124"><td class="num" id="LN124">124</td><td class="line">    <span class='keyword'>if</span> (!PACKET_buf_init(&amp;pkt, data, len))</td></tr>
<tr class="codeline" data-linenumber="125"><td class="num" id="LN125">125</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="126"><td class="num" id="LN126">126</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="127"><td class="num" id="LN127">127</td><td class="line">    <span class='comment'>/* Check record header type */</span></td></tr>
<tr class="codeline" data-linenumber="128"><td class="num" id="LN128">128</td><td class="line">    <span class='keyword'>if</span> (!PACKET_get_1(&amp;pkt, &amp;u) || u != <span class='macro'>SSL3_RT_HANDSHAKE<span class='macro_popup'>22</span></span>)</td></tr>
<tr class="codeline" data-linenumber="129"><td class="num" id="LN129">129</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="130"><td class="num" id="LN130">130</td><td class="line">    <span class='comment'>/* Version */</span></td></tr>
<tr class="codeline" data-linenumber="131"><td class="num" id="LN131">131</td><td class="line">    <span class='keyword'>if</span> (!PACKET_get_net_2(&amp;pkt, &amp;u) || u != <span class='macro'>DTLS1_BAD_VER<span class='macro_popup'>0x0100</span></span>)</td></tr>
<tr class="codeline" data-linenumber="132"><td class="num" id="LN132">132</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="133"><td class="num" id="LN133">133</td><td class="line">    <span class='comment'>/* Skip the rest of the record header */</span></td></tr>
<tr class="codeline" data-linenumber="134"><td class="num" id="LN134">134</td><td class="line">    <span class='keyword'>if</span> (!PACKET_forward(&amp;pkt, <span class='macro'>DTLS1_RT_HEADER_LENGTH<span class='macro_popup'>13</span></span> - 3))</td></tr>
<tr class="codeline" data-linenumber="135"><td class="num" id="LN135">135</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="136"><td class="num" id="LN136">136</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="137"><td class="num" id="LN137">137</td><td class="line">    <span class='comment'>/* Check it's a ClientHello */</span></td></tr>
<tr class="codeline" data-linenumber="138"><td class="num" id="LN138">138</td><td class="line">    <span class='keyword'>if</span> (!PACKET_get_1(&amp;pkt, &amp;u) || u != <span class='macro'>SSL3_MT_CLIENT_HELLO<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="139"><td class="num" id="LN139">139</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="140"><td class="num" id="LN140">140</td><td class="line">    <span class='comment'>/* Skip the rest of the handshake message header */</span></td></tr>
<tr class="codeline" data-linenumber="141"><td class="num" id="LN141">141</td><td class="line">    <span class='keyword'>if</span> (!PACKET_forward(&amp;pkt, <span class='macro'>DTLS1_HM_HEADER_LENGTH<span class='macro_popup'>12</span></span> - 1))</td></tr>
<tr class="codeline" data-linenumber="142"><td class="num" id="LN142">142</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="143"><td class="num" id="LN143">143</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="144"><td class="num" id="LN144">144</td><td class="line">    <span class='comment'>/* Check client version */</span></td></tr>
<tr class="codeline" data-linenumber="145"><td class="num" id="LN145">145</td><td class="line">    <span class='keyword'>if</span> (!PACKET_get_net_2(&amp;pkt, &amp;u) || u != <span class='macro'>DTLS1_BAD_VER<span class='macro_popup'>0x0100</span></span>)</td></tr>
<tr class="codeline" data-linenumber="146"><td class="num" id="LN146">146</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="147"><td class="num" id="LN147">147</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="148"><td class="num" id="LN148">148</td><td class="line">    <span class='comment'>/* Store random */</span></td></tr>
<tr class="codeline" data-linenumber="149"><td class="num" id="LN149">149</td><td class="line">    <span class='keyword'>if</span> (!PACKET_copy_bytes(&amp;pkt, client_random, <span class='macro'>SSL3_RANDOM_SIZE<span class='macro_popup'>32</span></span>))</td></tr>
<tr class="codeline" data-linenumber="150"><td class="num" id="LN150">150</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="151"><td class="num" id="LN151">151</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="152"><td class="num" id="LN152">152</td><td class="line">    <span class='comment'>/* Check session id length and content */</span></td></tr>
<tr class="codeline" data-linenumber="153"><td class="num" id="LN153">153</td><td class="line">    <span class='keyword'>if</span> (!PACKET_get_length_prefixed_1(&amp;pkt, &amp;pkt2) ||</td></tr>
<tr class="codeline" data-linenumber="154"><td class="num" id="LN154">154</td><td class="line">        !PACKET_equal(&amp;pkt2, session_id, <span class='keyword'>sizeof</span>(session_id)))</td></tr>
<tr class="codeline" data-linenumber="155"><td class="num" id="LN155">155</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="156"><td class="num" id="LN156">156</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="157"><td class="num" id="LN157">157</td><td class="line">    <span class='comment'>/* Check cookie */</span></td></tr>
<tr class="codeline" data-linenumber="158"><td class="num" id="LN158">158</td><td class="line">    <span class='keyword'>if</span> (!PACKET_get_length_prefixed_1(&amp;pkt, &amp;pkt2))</td></tr>
<tr class="codeline" data-linenumber="159"><td class="num" id="LN159">159</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="160"><td class="num" id="LN160">160</td><td class="line">    <span class='keyword'>if</span> (PACKET_remaining(&amp;pkt2)) {</td></tr>
<tr class="codeline" data-linenumber="161"><td class="num" id="LN161">161</td><td class="line">        <span class='keyword'>if</span> (!PACKET_equal(&amp;pkt2, cookie, <span class='keyword'>sizeof</span>(cookie)))</td></tr>
<tr class="codeline" data-linenumber="162"><td class="num" id="LN162">162</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="163"><td class="num" id="LN163">163</td><td class="line">        cookie_found = 1;</td></tr>
<tr class="codeline" data-linenumber="164"><td class="num" id="LN164">164</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="165"><td class="num" id="LN165">165</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="166"><td class="num" id="LN166">166</td><td class="line">    <span class='comment'>/* Skip ciphers */</span></td></tr>
<tr class="codeline" data-linenumber="167"><td class="num" id="LN167">167</td><td class="line">    <span class='keyword'>if</span> (!PACKET_get_net_2(&amp;pkt, &amp;u) || !PACKET_forward(&amp;pkt, u))</td></tr>
<tr class="codeline" data-linenumber="168"><td class="num" id="LN168">168</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="169"><td class="num" id="LN169">169</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="170"><td class="num" id="LN170">170</td><td class="line">    <span class='comment'>/* Skip compression */</span></td></tr>
<tr class="codeline" data-linenumber="171"><td class="num" id="LN171">171</td><td class="line">    <span class='keyword'>if</span> (!PACKET_get_1(&amp;pkt, &amp;u) || !PACKET_forward(&amp;pkt, u))</td></tr>
<tr class="codeline" data-linenumber="172"><td class="num" id="LN172">172</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="173"><td class="num" id="LN173">173</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="174"><td class="num" id="LN174">174</td><td class="line">    <span class='comment'>/* Skip extensions */</span></td></tr>
<tr class="codeline" data-linenumber="175"><td class="num" id="LN175">175</td><td class="line">    <span class='keyword'>if</span> (!PACKET_get_net_2(&amp;pkt, &amp;u) || !PACKET_forward(&amp;pkt, u))</td></tr>
<tr class="codeline" data-linenumber="176"><td class="num" id="LN176">176</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="177"><td class="num" id="LN177">177</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="178"><td class="num" id="LN178">178</td><td class="line">    <span class='comment'>/* Now we are at the end */</span></td></tr>
<tr class="codeline" data-linenumber="179"><td class="num" id="LN179">179</td><td class="line">    <span class='keyword'>if</span> (PACKET_remaining(&amp;pkt))</td></tr>
<tr class="codeline" data-linenumber="180"><td class="num" id="LN180">180</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="181"><td class="num" id="LN181">181</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="182"><td class="num" id="LN182">182</td><td class="line">    <span class='comment'>/* Update handshake MAC for second ClientHello (with cookie) */</span></td></tr>
<tr class="codeline" data-linenumber="183"><td class="num" id="LN183">183</td><td class="line">    <span class='keyword'>if</span> (cookie_found &amp;&amp; !EVP_DigestUpdate(handshake_md, data + <span class='macro'>MAC_OFFSET<span class='macro_popup'>(13 + 12)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="184"><td class="num" id="LN184">184</td><td class="line">                                          len - <span class='macro'>MAC_OFFSET<span class='macro_popup'>(13 + 12)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="185"><td class="num" id="LN185">185</td><td class="line">            printf(<span class='string_literal'>"EVP_DigestUpdate() failed\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="186"><td class="num" id="LN186">186</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="187"><td class="num" id="LN187">187</td><td class="line">    (<span class='keyword'>void</span>)<span class='macro'>BIO_reset(wbio)<span class='macro_popup'>(int)BIO_ctrl(wbio,1,0,((void*)0))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="188"><td class="num" id="LN188">188</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="189"><td class="num" id="LN189">189</td><td class="line">    <span class='keyword'>return</span> 1 + cookie_found;</td></tr>
<tr class="codeline" data-linenumber="190"><td class="num" id="LN190">190</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="191"><td class="num" id="LN191">191</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="192"><td class="num" id="LN192">192</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> send_hello_verify(BIO *rbio)</td></tr>
<tr class="codeline" data-linenumber="193"><td class="num" id="LN193">193</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="194"><td class="num" id="LN194">194</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> hello_verify[] = {</td></tr>
<tr class="codeline" data-linenumber="195"><td class="num" id="LN195">195</td><td class="line">        0x16, <span class='comment'>/* Handshake */</span></td></tr>
<tr class="codeline" data-linenumber="196"><td class="num" id="LN196">196</td><td class="line">        0x01, 0x00, <span class='comment'>/* DTLS1_BAD_VER */</span></td></tr>
<tr class="codeline" data-linenumber="197"><td class="num" id="LN197">197</td><td class="line">        0x00, 0x00, <span class='comment'>/* Epoch 0 */</span></td></tr>
<tr class="codeline" data-linenumber="198"><td class="num" id="LN198">198</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, <span class='comment'>/* Seq# 0 */</span></td></tr>
<tr class="codeline" data-linenumber="199"><td class="num" id="LN199">199</td><td class="line">        0x00, 0x23, <span class='comment'>/* Length */</span></td></tr>
<tr class="codeline" data-linenumber="200"><td class="num" id="LN200">200</td><td class="line">        0x03, <span class='comment'>/* Hello Verify */</span></td></tr>
<tr class="codeline" data-linenumber="201"><td class="num" id="LN201">201</td><td class="line">        0x00, 0x00, 0x17, <span class='comment'>/* Length */</span></td></tr>
<tr class="codeline" data-linenumber="202"><td class="num" id="LN202">202</td><td class="line">        0x00, 0x00, <span class='comment'>/* Seq# 0 */</span></td></tr>
<tr class="codeline" data-linenumber="203"><td class="num" id="LN203">203</td><td class="line">        0x00, 0x00, 0x00, <span class='comment'>/* Fragment offset */</span></td></tr>
<tr class="codeline" data-linenumber="204"><td class="num" id="LN204">204</td><td class="line">        0x00, 0x00, 0x17, <span class='comment'>/* Fragment length */</span></td></tr>
<tr class="codeline" data-linenumber="205"><td class="num" id="LN205">205</td><td class="line">        0x01, 0x00, <span class='comment'>/* DTLS1_BAD_VER */</span></td></tr>
<tr class="codeline" data-linenumber="206"><td class="num" id="LN206">206</td><td class="line">        0x14, <span class='comment'>/* Cookie length */</span></td></tr>
<tr class="codeline" data-linenumber="207"><td class="num" id="LN207">207</td><td class="line"><span class='directive'>#define <span class='macro'>HV_COOKIE_OFS<span class='macro_popup'>28</span></span> 28 /* Cookie goes here */</span></td></tr>
<tr class="codeline" data-linenumber="208"><td class="num" id="LN208">208</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</td></tr>
<tr class="codeline" data-linenumber="209"><td class="num" id="LN209">209</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</td></tr>
<tr class="codeline" data-linenumber="210"><td class="num" id="LN210">210</td><td class="line">        0x00, 0x00, 0x00, 0x00,</td></tr>
<tr class="codeline" data-linenumber="211"><td class="num" id="LN211">211</td><td class="line">    };</td></tr>
<tr class="codeline" data-linenumber="212"><td class="num" id="LN212">212</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="213"><td class="num" id="LN213">213</td><td class="line">    memcpy(hello_verify + <span class='macro'>HV_COOKIE_OFS<span class='macro_popup'>28</span></span>, cookie, <span class='keyword'>sizeof</span>(cookie));</td></tr>
<tr class="codeline" data-linenumber="214"><td class="num" id="LN214">214</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="215"><td class="num" id="LN215">215</td><td class="line">    BIO_write(rbio, hello_verify, <span class='keyword'>sizeof</span>(hello_verify));</td></tr>
<tr class="codeline" data-linenumber="216"><td class="num" id="LN216">216</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="217"><td class="num" id="LN217">217</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="218"><td class="num" id="LN218">218</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="219"><td class="num" id="LN219">219</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="220"><td class="num" id="LN220">220</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> send_server_hello(BIO *rbio)</td></tr>
<tr class="codeline" data-linenumber="221"><td class="num" id="LN221">221</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="222"><td class="num" id="LN222">222</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> server_hello[] = {</td></tr>
<tr class="codeline" data-linenumber="223"><td class="num" id="LN223">223</td><td class="line">        0x16, <span class='comment'>/* Handshake */</span></td></tr>
<tr class="codeline" data-linenumber="224"><td class="num" id="LN224">224</td><td class="line">        0x01, 0x00, <span class='comment'>/* DTLS1_BAD_VER */</span></td></tr>
<tr class="codeline" data-linenumber="225"><td class="num" id="LN225">225</td><td class="line">        0x00, 0x00, <span class='comment'>/* Epoch 0 */</span></td></tr>
<tr class="codeline" data-linenumber="226"><td class="num" id="LN226">226</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x01, <span class='comment'>/* Seq# 1 */</span></td></tr>
<tr class="codeline" data-linenumber="227"><td class="num" id="LN227">227</td><td class="line">        0x00, 0x52, <span class='comment'>/* Length */</span></td></tr>
<tr class="codeline" data-linenumber="228"><td class="num" id="LN228">228</td><td class="line">        0x02, <span class='comment'>/* Server Hello */</span></td></tr>
<tr class="codeline" data-linenumber="229"><td class="num" id="LN229">229</td><td class="line">        0x00, 0x00, 0x46, <span class='comment'>/* Length */</span></td></tr>
<tr class="codeline" data-linenumber="230"><td class="num" id="LN230">230</td><td class="line">        0x00, 0x01, <span class='comment'>/* Seq# */</span></td></tr>
<tr class="codeline" data-linenumber="231"><td class="num" id="LN231">231</td><td class="line">        0x00, 0x00, 0x00, <span class='comment'>/* Fragment offset */</span></td></tr>
<tr class="codeline" data-linenumber="232"><td class="num" id="LN232">232</td><td class="line">        0x00, 0x00, 0x46, <span class='comment'>/* Fragment length */</span></td></tr>
<tr class="codeline" data-linenumber="233"><td class="num" id="LN233">233</td><td class="line">        0x01, 0x00, <span class='comment'>/* DTLS1_BAD_VER */</span></td></tr>
<tr class="codeline" data-linenumber="234"><td class="num" id="LN234">234</td><td class="line"><span class='directive'>#define <span class='macro'>SH_RANDOM_OFS<span class='macro_popup'>27</span></span> 27 /* Server random goes here */</span></td></tr>
<tr class="codeline" data-linenumber="235"><td class="num" id="LN235">235</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</td></tr>
<tr class="codeline" data-linenumber="236"><td class="num" id="LN236">236</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</td></tr>
<tr class="codeline" data-linenumber="237"><td class="num" id="LN237">237</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</td></tr>
<tr class="codeline" data-linenumber="238"><td class="num" id="LN238">238</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</td></tr>
<tr class="codeline" data-linenumber="239"><td class="num" id="LN239">239</td><td class="line">        0x20, <span class='comment'>/* Session ID length */</span></td></tr>
<tr class="codeline" data-linenumber="240"><td class="num" id="LN240">240</td><td class="line"><span class='directive'>#define <span class='macro'>SH_SESSID_OFS<span class='macro_popup'>60</span></span> 60 /* Session ID goes here */</span></td></tr>
<tr class="codeline" data-linenumber="241"><td class="num" id="LN241">241</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</td></tr>
<tr class="codeline" data-linenumber="242"><td class="num" id="LN242">242</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</td></tr>
<tr class="codeline" data-linenumber="243"><td class="num" id="LN243">243</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</td></tr>
<tr class="codeline" data-linenumber="244"><td class="num" id="LN244">244</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</td></tr>
<tr class="codeline" data-linenumber="245"><td class="num" id="LN245">245</td><td class="line">        0x00, 0x2f, <span class='comment'>/* Cipher suite AES128-SHA */</span></td></tr>
<tr class="codeline" data-linenumber="246"><td class="num" id="LN246">246</td><td class="line">        0x00, <span class='comment'>/* Compression null */</span></td></tr>
<tr class="codeline" data-linenumber="247"><td class="num" id="LN247">247</td><td class="line">    };</td></tr>
<tr class="codeline" data-linenumber="248"><td class="num" id="LN248">248</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> change_cipher_spec[] = {</td></tr>
<tr class="codeline" data-linenumber="249"><td class="num" id="LN249">249</td><td class="line">        0x14, <span class='comment'>/* Change Cipher Spec */</span></td></tr>
<tr class="codeline" data-linenumber="250"><td class="num" id="LN250">250</td><td class="line">        0x01, 0x00, <span class='comment'>/* DTLS1_BAD_VER */</span></td></tr>
<tr class="codeline" data-linenumber="251"><td class="num" id="LN251">251</td><td class="line">        0x00, 0x00, <span class='comment'>/* Epoch 0 */</span></td></tr>
<tr class="codeline" data-linenumber="252"><td class="num" id="LN252">252</td><td class="line">        0x00, 0x00, 0x00, 0x00, 0x00, 0x02, <span class='comment'>/* Seq# 2 */</span></td></tr>
<tr class="codeline" data-linenumber="253"><td class="num" id="LN253">253</td><td class="line">        0x00, 0x03, <span class='comment'>/* Length */</span></td></tr>
<tr class="codeline" data-linenumber="254"><td class="num" id="LN254">254</td><td class="line">        0x01, 0x00, 0x02, <span class='comment'>/* Message */</span></td></tr>
<tr class="codeline" data-linenumber="255"><td class="num" id="LN255">255</td><td class="line">    };</td></tr>
<tr class="codeline" data-linenumber="256"><td class="num" id="LN256">256</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="257"><td class="num" id="LN257">257</td><td class="line">    <span class="mrange">memcpy</span>(server_hello + <span class='macro'>SH_RANDOM_OFS<span class='macro_popup'>27</span></span>, server_random, <span class='keyword'>sizeof</span>(server_random));</td></tr>
<tr><td class="num"></td><td class="line"><div id="EndPath" class="msg msgEvent" style="margin-left:5ex; max-width:58em">Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11</div></td></tr>
<tr class="codeline" data-linenumber="258"><td class="num" id="LN258">258</td><td class="line">    memcpy(server_hello + <span class='macro'>SH_SESSID_OFS<span class='macro_popup'>60</span></span>, session_id, <span class='keyword'>sizeof</span>(session_id));</td></tr>
<tr class="codeline" data-linenumber="259"><td class="num" id="LN259">259</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="260"><td class="num" id="LN260">260</td><td class="line">    <span class='keyword'>if</span> (!EVP_DigestUpdate(handshake_md, server_hello + <span class='macro'>MAC_OFFSET<span class='macro_popup'>(13 + 12)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="261"><td class="num" id="LN261">261</td><td class="line">                          <span class='keyword'>sizeof</span>(server_hello) - <span class='macro'>MAC_OFFSET<span class='macro_popup'>(13 + 12)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="262"><td class="num" id="LN262">262</td><td class="line">        printf(<span class='string_literal'>"EVP_DigestUpdate() failed\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="263"><td class="num" id="LN263">263</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="264"><td class="num" id="LN264">264</td><td class="line">    BIO_write(rbio, server_hello, <span class='keyword'>sizeof</span>(server_hello));</td></tr>
<tr class="codeline" data-linenumber="265"><td class="num" id="LN265">265</td><td class="line">    BIO_write(rbio, change_cipher_spec, <span class='keyword'>sizeof</span>(change_cipher_spec));</td></tr>
<tr class="codeline" data-linenumber="266"><td class="num" id="LN266">266</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="267"><td class="num" id="LN267">267</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="268"><td class="num" id="LN268">268</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="269"><td class="num" id="LN269">269</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="270"><td class="num" id="LN270">270</td><td class="line"><span class='comment'>/* Create header, HMAC, pad, encrypt and send a record */</span></td></tr>
<tr class="codeline" data-linenumber="271"><td class="num" id="LN271">271</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> send_record(BIO *rbio, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> type, <span class='keyword'>unsigned</span> <span class='keyword'>long</span> seqnr,</td></tr>
<tr class="codeline" data-linenumber="272"><td class="num" id="LN272">272</td><td class="line">                       <span class='keyword'>const</span> <span class='keyword'>void</span> *msg, size_t len)</td></tr>
<tr class="codeline" data-linenumber="273"><td class="num" id="LN273">273</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="274"><td class="num" id="LN274">274</td><td class="line">    <span class='comment'>/* Note that the order of the record header fields on the wire,</span></td></tr>
<tr class="codeline" data-linenumber="275"><td class="num" id="LN275">275</td><td class="line">     <span class='comment'>* and in the HMAC, is different. So we just keep them in separate</span></td></tr>
<tr class="codeline" data-linenumber="276"><td class="num" id="LN276">276</td><td class="line">     <span class='comment'>* variables and handle them individually. */</span></td></tr>
<tr class="codeline" data-linenumber="277"><td class="num" id="LN277">277</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> epoch[2] = { 0x00, 0x01 };</td></tr>
<tr class="codeline" data-linenumber="278"><td class="num" id="LN278">278</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> seq[6] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };</td></tr>
<tr class="codeline" data-linenumber="279"><td class="num" id="LN279">279</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> ver[2] = { 0x01, 0x00 }; <span class='comment'>/* DTLS1_BAD_VER */</span></td></tr>
<tr class="codeline" data-linenumber="280"><td class="num" id="LN280">280</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> lenbytes[2];</td></tr>
<tr class="codeline" data-linenumber="281"><td class="num" id="LN281">281</td><td class="line">    HMAC_CTX *ctx;</td></tr>
<tr class="codeline" data-linenumber="282"><td class="num" id="LN282">282</td><td class="line">    EVP_CIPHER_CTX *enc_ctx;</td></tr>
<tr class="codeline" data-linenumber="283"><td class="num" id="LN283">283</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> iv[16];</td></tr>
<tr class="codeline" data-linenumber="284"><td class="num" id="LN284">284</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> pad;</td></tr>
<tr class="codeline" data-linenumber="285"><td class="num" id="LN285">285</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *enc;</td></tr>
<tr class="codeline" data-linenumber="286"><td class="num" id="LN286">286</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="287"><td class="num" id="LN287">287</td><td class="line"><span class='directive'>#ifdef SIXTY_FOUR_BIT_LONG</span></td></tr>
<tr class="codeline" data-linenumber="288"><td class="num" id="LN288">288</td><td class="line">    seq[0] = (seqnr &gt;&gt; 40) &amp; 0xff;</td></tr>
<tr class="codeline" data-linenumber="289"><td class="num" id="LN289">289</td><td class="line">    seq[1] = (seqnr &gt;&gt; 32) &amp; 0xff;</td></tr>
<tr class="codeline" data-linenumber="290"><td class="num" id="LN290">290</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="291"><td class="num" id="LN291">291</td><td class="line">    seq[2] = (seqnr &gt;&gt; 24) &amp; 0xff;</td></tr>
<tr class="codeline" data-linenumber="292"><td class="num" id="LN292">292</td><td class="line">    seq[3] = (seqnr &gt;&gt; 16) &amp; 0xff;</td></tr>
<tr class="codeline" data-linenumber="293"><td class="num" id="LN293">293</td><td class="line">    seq[4] = (seqnr &gt;&gt; 8) &amp; 0xff;</td></tr>
<tr class="codeline" data-linenumber="294"><td class="num" id="LN294">294</td><td class="line">    seq[5] = seqnr &amp; 0xff;</td></tr>
<tr class="codeline" data-linenumber="295"><td class="num" id="LN295">295</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="296"><td class="num" id="LN296">296</td><td class="line">    pad = 15 - ((len + <span class='macro'>SHA_DIGEST_LENGTH<span class='macro_popup'>20</span></span>) % 16);</td></tr>
<tr class="codeline" data-linenumber="297"><td class="num" id="LN297">297</td><td class="line">    enc = <span class='macro'>OPENSSL_malloc(len + SHA_DIGEST_LENGTH + 1 + pad)<span class='macro_popup'>CRYPTO_malloc(len + 20 + 1 + pad, "test/bad_dtls_test.c", 297<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="298"><td class="num" id="LN298">298</td><td class="line">    <span class='keyword'>if</span> (enc == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="299"><td class="num" id="LN299">299</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="300"><td class="num" id="LN300">300</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="301"><td class="num" id="LN301">301</td><td class="line">    <span class='comment'>/* Copy record to encryption buffer */</span></td></tr>
<tr class="codeline" data-linenumber="302"><td class="num" id="LN302">302</td><td class="line">    memcpy(enc, msg, len);</td></tr>
<tr class="codeline" data-linenumber="303"><td class="num" id="LN303">303</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="304"><td class="num" id="LN304">304</td><td class="line">    <span class='comment'>/* Append HMAC to data */</span></td></tr>
<tr class="codeline" data-linenumber="305"><td class="num" id="LN305">305</td><td class="line">    ctx = HMAC_CTX_new();</td></tr>
<tr class="codeline" data-linenumber="306"><td class="num" id="LN306">306</td><td class="line">    HMAC_Init_ex(ctx, <span class='macro'>mac_key<span class='macro_popup'>(key_block + 20)</span></span>, 20, EVP_sha1(), <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="307"><td class="num" id="LN307">307</td><td class="line">    HMAC_Update(ctx, epoch, 2);</td></tr>
<tr class="codeline" data-linenumber="308"><td class="num" id="LN308">308</td><td class="line">    HMAC_Update(ctx, seq, 6);</td></tr>
<tr class="codeline" data-linenumber="309"><td class="num" id="LN309">309</td><td class="line">    HMAC_Update(ctx, &amp;type, 1);</td></tr>
<tr class="codeline" data-linenumber="310"><td class="num" id="LN310">310</td><td class="line">    HMAC_Update(ctx, ver, 2); <span class='comment'>/* Version */</span></td></tr>
<tr class="codeline" data-linenumber="311"><td class="num" id="LN311">311</td><td class="line">    lenbytes[0] = len &gt;&gt; 8;</td></tr>
<tr class="codeline" data-linenumber="312"><td class="num" id="LN312">312</td><td class="line">    lenbytes[1] = len &amp; 0xff;</td></tr>
<tr class="codeline" data-linenumber="313"><td class="num" id="LN313">313</td><td class="line">    HMAC_Update(ctx, lenbytes, 2); <span class='comment'>/* Length */</span></td></tr>
<tr class="codeline" data-linenumber="314"><td class="num" id="LN314">314</td><td class="line">    HMAC_Update(ctx, enc, len); <span class='comment'>/* Finally the data itself */</span></td></tr>
<tr class="codeline" data-linenumber="315"><td class="num" id="LN315">315</td><td class="line">    HMAC_Final(ctx, enc + len, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="316"><td class="num" id="LN316">316</td><td class="line">    HMAC_CTX_free(ctx);</td></tr>
<tr class="codeline" data-linenumber="317"><td class="num" id="LN317">317</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="318"><td class="num" id="LN318">318</td><td class="line">    <span class='comment'>/* Append padding bytes */</span></td></tr>
<tr class="codeline" data-linenumber="319"><td class="num" id="LN319">319</td><td class="line">    len += <span class='macro'>SHA_DIGEST_LENGTH<span class='macro_popup'>20</span></span>;</td></tr>
<tr class="codeline" data-linenumber="320"><td class="num" id="LN320">320</td><td class="line">    <span class='keyword'>do</span> {</td></tr>
<tr class="codeline" data-linenumber="321"><td class="num" id="LN321">321</td><td class="line">        enc[len++] = pad;</td></tr>
<tr class="codeline" data-linenumber="322"><td class="num" id="LN322">322</td><td class="line">    } <span class='keyword'>while</span> (len % 16);</td></tr>
<tr class="codeline" data-linenumber="323"><td class="num" id="LN323">323</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="324"><td class="num" id="LN324">324</td><td class="line">    <span class='comment'>/* Generate IV, and encrypt */</span></td></tr>
<tr class="codeline" data-linenumber="325"><td class="num" id="LN325">325</td><td class="line">    RAND_bytes(iv, <span class='keyword'>sizeof</span>(iv));</td></tr>
<tr class="codeline" data-linenumber="326"><td class="num" id="LN326">326</td><td class="line">    enc_ctx = EVP_CIPHER_CTX_new();</td></tr>
<tr class="codeline" data-linenumber="327"><td class="num" id="LN327">327</td><td class="line">    EVP_CipherInit_ex(enc_ctx, EVP_aes_128_cbc(), <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>enc_key<span class='macro_popup'>(key_block + 56)</span></span>, iv, 1);</td></tr>
<tr class="codeline" data-linenumber="328"><td class="num" id="LN328">328</td><td class="line">    EVP_Cipher(enc_ctx, enc, enc, len);</td></tr>
<tr class="codeline" data-linenumber="329"><td class="num" id="LN329">329</td><td class="line">    EVP_CIPHER_CTX_free(enc_ctx);</td></tr>
<tr class="codeline" data-linenumber="330"><td class="num" id="LN330">330</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="331"><td class="num" id="LN331">331</td><td class="line">    <span class='comment'>/* Finally write header (from fragmented variables), IV and encrypted record */</span></td></tr>
<tr class="codeline" data-linenumber="332"><td class="num" id="LN332">332</td><td class="line">    BIO_write(rbio, &amp;type, 1);</td></tr>
<tr class="codeline" data-linenumber="333"><td class="num" id="LN333">333</td><td class="line">    BIO_write(rbio, ver, 2);</td></tr>
<tr class="codeline" data-linenumber="334"><td class="num" id="LN334">334</td><td class="line">    BIO_write(rbio, epoch, 2);</td></tr>
<tr class="codeline" data-linenumber="335"><td class="num" id="LN335">335</td><td class="line">    BIO_write(rbio, seq, 6);</td></tr>
<tr class="codeline" data-linenumber="336"><td class="num" id="LN336">336</td><td class="line">    lenbytes[0] = (len + <span class='keyword'>sizeof</span>(iv)) &gt;&gt; 8;</td></tr>
<tr class="codeline" data-linenumber="337"><td class="num" id="LN337">337</td><td class="line">    lenbytes[1] = (len + <span class='keyword'>sizeof</span>(iv)) &amp; 0xff;</td></tr>
<tr class="codeline" data-linenumber="338"><td class="num" id="LN338">338</td><td class="line">    BIO_write(rbio, lenbytes, 2);</td></tr>
<tr class="codeline" data-linenumber="339"><td class="num" id="LN339">339</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="340"><td class="num" id="LN340">340</td><td class="line">    BIO_write(rbio, iv, <span class='keyword'>sizeof</span>(iv));</td></tr>
<tr class="codeline" data-linenumber="341"><td class="num" id="LN341">341</td><td class="line">    BIO_write(rbio, enc, len);</td></tr>
<tr class="codeline" data-linenumber="342"><td class="num" id="LN342">342</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="343"><td class="num" id="LN343">343</td><td class="line">    <span class='macro'>OPENSSL_free(enc)<span class='macro_popup'>CRYPTO_free(enc, "test/bad_dtls_test.c", 343)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="344"><td class="num" id="LN344">344</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="345"><td class="num" id="LN345">345</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="346"><td class="num" id="LN346">346</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="347"><td class="num" id="LN347">347</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> send_finished(SSL *s, BIO *rbio)</td></tr>
<tr class="codeline" data-linenumber="348"><td class="num" id="LN348">348</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="349"><td class="num" id="LN349">349</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> finished_msg[<span class='macro'>DTLS1_HM_HEADER_LENGTH<span class='macro_popup'>12</span></span> +</td></tr>
<tr class="codeline" data-linenumber="350"><td class="num" id="LN350">350</td><td class="line">                                      <span class='macro'>TLS1_FINISH_MAC_LENGTH<span class='macro_popup'>12</span></span>] = {</td></tr>
<tr class="codeline" data-linenumber="351"><td class="num" id="LN351">351</td><td class="line">        0x14, <span class='comment'>/* Finished */</span></td></tr>
<tr class="codeline" data-linenumber="352"><td class="num" id="LN352">352</td><td class="line">        0x00, 0x00, 0x0c, <span class='comment'>/* Length */</span></td></tr>
<tr class="codeline" data-linenumber="353"><td class="num" id="LN353">353</td><td class="line">        0x00, 0x03, <span class='comment'>/* Seq# 3 */</span></td></tr>
<tr class="codeline" data-linenumber="354"><td class="num" id="LN354">354</td><td class="line">        0x00, 0x00, 0x00, <span class='comment'>/* Fragment offset */</span></td></tr>
<tr class="codeline" data-linenumber="355"><td class="num" id="LN355">355</td><td class="line">        0x00, 0x00, 0x0c, <span class='comment'>/* Fragment length */</span></td></tr>
<tr class="codeline" data-linenumber="356"><td class="num" id="LN356">356</td><td class="line">        <span class='comment'>/* Finished MAC (12 bytes) */</span></td></tr>
<tr class="codeline" data-linenumber="357"><td class="num" id="LN357">357</td><td class="line">    };</td></tr>
<tr class="codeline" data-linenumber="358"><td class="num" id="LN358">358</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> handshake_hash[<span class='macro'>EVP_MAX_MD_SIZE<span class='macro_popup'>64</span></span>];</td></tr>
<tr class="codeline" data-linenumber="359"><td class="num" id="LN359">359</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="360"><td class="num" id="LN360">360</td><td class="line">    <span class='comment'>/* Derive key material */</span></td></tr>
<tr class="codeline" data-linenumber="361"><td class="num" id="LN361">361</td><td class="line">    do_PRF(<span class='macro'>TLS_MD_KEY_EXPANSION_CONST<span class='macro_popup'>"key expansion"</span></span>, <span class='macro'>TLS_MD_KEY_EXPANSION_CONST_SIZE<span class='macro_popup'>13</span></span>,</td></tr>
<tr class="codeline" data-linenumber="362"><td class="num" id="LN362">362</td><td class="line">           server_random, <span class='macro'>SSL3_RANDOM_SIZE<span class='macro_popup'>32</span></span>,</td></tr>
<tr class="codeline" data-linenumber="363"><td class="num" id="LN363">363</td><td class="line">           client_random, <span class='macro'>SSL3_RANDOM_SIZE<span class='macro_popup'>32</span></span>,</td></tr>
<tr class="codeline" data-linenumber="364"><td class="num" id="LN364">364</td><td class="line">           key_block, <span class='keyword'>sizeof</span>(key_block));</td></tr>
<tr class="codeline" data-linenumber="365"><td class="num" id="LN365">365</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="366"><td class="num" id="LN366">366</td><td class="line">    <span class='comment'>/* Generate Finished MAC */</span></td></tr>
<tr class="codeline" data-linenumber="367"><td class="num" id="LN367">367</td><td class="line">    <span class='keyword'>if</span> (!EVP_DigestFinal_ex(handshake_md, handshake_hash, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="368"><td class="num" id="LN368">368</td><td class="line">        printf(<span class='string_literal'>"EVP_DigestFinal_ex() failed\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="369"><td class="num" id="LN369">369</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="370"><td class="num" id="LN370">370</td><td class="line">    do_PRF(<span class='macro'>TLS_MD_SERVER_FINISH_CONST<span class='macro_popup'>"server finished"</span></span>, <span class='macro'>TLS_MD_SERVER_FINISH_CONST_SIZE<span class='macro_popup'>15</span></span>,</td></tr>
<tr class="codeline" data-linenumber="371"><td class="num" id="LN371">371</td><td class="line">           handshake_hash, <span class='macro'>EVP_MD_CTX_size(handshake_md)<span class='macro_popup'>EVP_MD_size(EVP_MD_CTX_md(handshake_md))</span></span>,</td></tr>
<tr class="codeline" data-linenumber="372"><td class="num" id="LN372">372</td><td class="line">           <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, 0,</td></tr>
<tr class="codeline" data-linenumber="373"><td class="num" id="LN373">373</td><td class="line">           finished_msg + <span class='macro'>DTLS1_HM_HEADER_LENGTH<span class='macro_popup'>12</span></span>, <span class='macro'>TLS1_FINISH_MAC_LENGTH<span class='macro_popup'>12</span></span>);</td></tr>
<tr class="codeline" data-linenumber="374"><td class="num" id="LN374">374</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="375"><td class="num" id="LN375">375</td><td class="line">    <span class='keyword'>return</span> send_record(rbio, <span class='macro'>SSL3_RT_HANDSHAKE<span class='macro_popup'>22</span></span>, 0,</td></tr>
<tr class="codeline" data-linenumber="376"><td class="num" id="LN376">376</td><td class="line">                       finished_msg, <span class='keyword'>sizeof</span>(finished_msg));</td></tr>
<tr class="codeline" data-linenumber="377"><td class="num" id="LN377">377</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="378"><td class="num" id="LN378">378</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="379"><td class="num" id="LN379">379</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> validate_ccs(BIO *wbio)</td></tr>
<tr class="codeline" data-linenumber="380"><td class="num" id="LN380">380</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="381"><td class="num" id="LN381">381</td><td class="line">    PACKET pkt;</td></tr>
<tr class="codeline" data-linenumber="382"><td class="num" id="LN382">382</td><td class="line">    <span class='keyword'>long</span> len;</td></tr>
<tr class="codeline" data-linenumber="383"><td class="num" id="LN383">383</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *data;</td></tr>
<tr class="codeline" data-linenumber="384"><td class="num" id="LN384">384</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> u;</td></tr>
<tr class="codeline" data-linenumber="385"><td class="num" id="LN385">385</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="386"><td class="num" id="LN386">386</td><td class="line">    len = <span class='macro'>BIO_get_mem_data(wbio, (<span class='keyword'>char</span> **)&amp;data)<span class='macro_popup'>BIO_ctrl(wbio,3,0,(char *)(char **)&amp;data)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="387"><td class="num" id="LN387">387</td><td class="line">    <span class='keyword'>if</span> (!PACKET_buf_init(&amp;pkt, data, len))</td></tr>
<tr class="codeline" data-linenumber="388"><td class="num" id="LN388">388</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="389"><td class="num" id="LN389">389</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="390"><td class="num" id="LN390">390</td><td class="line">    <span class='comment'>/* Check record header type */</span></td></tr>
<tr class="codeline" data-linenumber="391"><td class="num" id="LN391">391</td><td class="line">    <span class='keyword'>if</span> (!PACKET_get_1(&amp;pkt, &amp;u) || u != <span class='macro'>SSL3_RT_CHANGE_CIPHER_SPEC<span class='macro_popup'>20</span></span>)</td></tr>
<tr class="codeline" data-linenumber="392"><td class="num" id="LN392">392</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="393"><td class="num" id="LN393">393</td><td class="line">    <span class='comment'>/* Version */</span></td></tr>
<tr class="codeline" data-linenumber="394"><td class="num" id="LN394">394</td><td class="line">    <span class='keyword'>if</span> (!PACKET_get_net_2(&amp;pkt, &amp;u) || u != <span class='macro'>DTLS1_BAD_VER<span class='macro_popup'>0x0100</span></span>)</td></tr>
<tr class="codeline" data-linenumber="395"><td class="num" id="LN395">395</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="396"><td class="num" id="LN396">396</td><td class="line">    <span class='comment'>/* Skip the rest of the record header */</span></td></tr>
<tr class="codeline" data-linenumber="397"><td class="num" id="LN397">397</td><td class="line">    <span class='keyword'>if</span> (!PACKET_forward(&amp;pkt, <span class='macro'>DTLS1_RT_HEADER_LENGTH<span class='macro_popup'>13</span></span> - 3))</td></tr>
<tr class="codeline" data-linenumber="398"><td class="num" id="LN398">398</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="399"><td class="num" id="LN399">399</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="400"><td class="num" id="LN400">400</td><td class="line">    <span class='comment'>/* Check ChangeCipherSpec message */</span></td></tr>
<tr class="codeline" data-linenumber="401"><td class="num" id="LN401">401</td><td class="line">    <span class='keyword'>if</span> (!PACKET_get_1(&amp;pkt, &amp;u) || u != <span class='macro'>SSL3_MT_CCS<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="402"><td class="num" id="LN402">402</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="403"><td class="num" id="LN403">403</td><td class="line">    <span class='comment'>/* A DTLS1_BAD_VER ChangeCipherSpec also contains the</span></td></tr>
<tr class="codeline" data-linenumber="404"><td class="num" id="LN404">404</td><td class="line">     <span class='comment'>* handshake sequence number (which is 2 here) */</span></td></tr>
<tr class="codeline" data-linenumber="405"><td class="num" id="LN405">405</td><td class="line">    <span class='keyword'>if</span> (!PACKET_get_net_2(&amp;pkt, &amp;u) || u != 0x0002)</td></tr>
<tr class="codeline" data-linenumber="406"><td class="num" id="LN406">406</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="407"><td class="num" id="LN407">407</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="408"><td class="num" id="LN408">408</td><td class="line">    <span class='comment'>/* Now check the Finished packet */</span></td></tr>
<tr class="codeline" data-linenumber="409"><td class="num" id="LN409">409</td><td class="line">    <span class='keyword'>if</span> (!PACKET_get_1(&amp;pkt, &amp;u) || u != <span class='macro'>SSL3_RT_HANDSHAKE<span class='macro_popup'>22</span></span>)</td></tr>
<tr class="codeline" data-linenumber="410"><td class="num" id="LN410">410</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="411"><td class="num" id="LN411">411</td><td class="line">    <span class='keyword'>if</span> (!PACKET_get_net_2(&amp;pkt, &amp;u) || u != <span class='macro'>DTLS1_BAD_VER<span class='macro_popup'>0x0100</span></span>)</td></tr>
<tr class="codeline" data-linenumber="412"><td class="num" id="LN412">412</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="413"><td class="num" id="LN413">413</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="414"><td class="num" id="LN414">414</td><td class="line">    <span class='comment'>/* Check epoch is now 1 */</span></td></tr>
<tr class="codeline" data-linenumber="415"><td class="num" id="LN415">415</td><td class="line">    <span class='keyword'>if</span> (!PACKET_get_net_2(&amp;pkt, &amp;u) || u != 0x0001)</td></tr>
<tr class="codeline" data-linenumber="416"><td class="num" id="LN416">416</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="417"><td class="num" id="LN417">417</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="418"><td class="num" id="LN418">418</td><td class="line">    <span class='comment'>/* That'll do for now. If OpenSSL accepted *our* Finished packet</span></td></tr>
<tr class="codeline" data-linenumber="419"><td class="num" id="LN419">419</td><td class="line">     <span class='comment'>* then it's evidently remembered that DTLS1_BAD_VER doesn't</span></td></tr>
<tr class="codeline" data-linenumber="420"><td class="num" id="LN420">420</td><td class="line">     <span class='comment'>* include the handshake header in the MAC. There's not a lot of</span></td></tr>
<tr class="codeline" data-linenumber="421"><td class="num" id="LN421">421</td><td class="line">     <span class='comment'>* point in implementing decryption here, just to check that it</span></td></tr>
<tr class="codeline" data-linenumber="422"><td class="num" id="LN422">422</td><td class="line">     <span class='comment'>* continues to get it right for one more packet. */</span></td></tr>
<tr class="codeline" data-linenumber="423"><td class="num" id="LN423">423</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="424"><td class="num" id="LN424">424</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="425"><td class="num" id="LN425">425</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="426"><td class="num" id="LN426">426</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="427"><td class="num" id="LN427">427</td><td class="line"><span class='directive'>#define <span class='macro'>NODROP(x)<span class='macro_popup'>{ xUL, 0 }</span></span> { x##UL, 0 }</span></td></tr>
<tr class="codeline" data-linenumber="428"><td class="num" id="LN428">428</td><td class="line"><span class='directive'>#define <span class='macro'>DROP(x)<span class='macro_popup'>{ xUL, 1 }</span></span>   { x##UL, 1 }</span></td></tr>
<tr class="codeline" data-linenumber="429"><td class="num" id="LN429">429</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="430"><td class="num" id="LN430">430</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>struct</span> {</td></tr>
<tr class="codeline" data-linenumber="431"><td class="num" id="LN431">431</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> seq;</td></tr>
<tr class="codeline" data-linenumber="432"><td class="num" id="LN432">432</td><td class="line">    <span class='keyword'>int</span> drop;</td></tr>
<tr class="codeline" data-linenumber="433"><td class="num" id="LN433">433</td><td class="line">} tests[] = {</td></tr>
<tr class="codeline" data-linenumber="434"><td class="num" id="LN434">434</td><td class="line">    <span class='macro'>NODROP(1)<span class='macro_popup'>{ 1UL, 0 }</span></span>, <span class='macro'>NODROP(3)<span class='macro_popup'>{ 3UL, 0 }</span></span>, <span class='macro'>NODROP(2)<span class='macro_popup'>{ 2UL, 0 }</span></span>,</td></tr>
<tr class="codeline" data-linenumber="435"><td class="num" id="LN435">435</td><td class="line">    <span class='macro'>NODROP(0x1234)<span class='macro_popup'>{ 0x1234UL, 0 }</span></span>, <span class='macro'>NODROP(0x1230)<span class='macro_popup'>{ 0x1230UL, 0 }</span></span>, <span class='macro'>NODROP(0x1235)<span class='macro_popup'>{ 0x1235UL, 0 }</span></span>,</td></tr>
<tr class="codeline" data-linenumber="436"><td class="num" id="LN436">436</td><td class="line">    <span class='macro'>NODROP(0xffff)<span class='macro_popup'>{ 0xffffUL, 0 }</span></span>, <span class='macro'>NODROP(0x10001)<span class='macro_popup'>{ 0x10001UL, 0 }</span></span>, <span class='macro'>NODROP(0xfffe)<span class='macro_popup'>{ 0xfffeUL, 0 }</span></span>, <span class='macro'>NODROP(0x10000)<span class='macro_popup'>{ 0x10000UL, 0 }</span></span>,</td></tr>
<tr class="codeline" data-linenumber="437"><td class="num" id="LN437">437</td><td class="line">    <span class='macro'>DROP(0x10001)<span class='macro_popup'>{ 0x10001UL, 1 }</span></span>, <span class='macro'>DROP(0xff)<span class='macro_popup'>{ 0xffUL, 1 }</span></span>, <span class='macro'>NODROP(0x100000)<span class='macro_popup'>{ 0x100000UL, 0 }</span></span>, <span class='macro'>NODROP(0x800000)<span class='macro_popup'>{ 0x800000UL, 0 }</span></span>, <span class='macro'>NODROP(0x7fffe1)<span class='macro_popup'>{ 0x7fffe1UL, 0 }</span></span>,</td></tr>
<tr class="codeline" data-linenumber="438"><td class="num" id="LN438">438</td><td class="line">    <span class='macro'>NODROP(0xffffff)<span class='macro_popup'>{ 0xffffffUL, 0 }</span></span>, <span class='macro'>NODROP(0x1000000)<span class='macro_popup'>{ 0x1000000UL, 0 }</span></span>, <span class='macro'>NODROP(0xfffffe)<span class='macro_popup'>{ 0xfffffeUL, 0 }</span></span>, <span class='macro'>DROP(0xffffff)<span class='macro_popup'>{ 0xffffffUL, 1 }</span></span>, <span class='macro'>NODROP(0x1000010)<span class='macro_popup'>{ 0x1000010UL, 0 }</span></span>,</td></tr>
<tr class="codeline" data-linenumber="439"><td class="num" id="LN439">439</td><td class="line">    <span class='macro'>NODROP(0xfffffd)<span class='macro_popup'>{ 0xfffffdUL, 0 }</span></span>, <span class='macro'>NODROP(0x1000011)<span class='macro_popup'>{ 0x1000011UL, 0 }</span></span>, <span class='macro'>DROP(0x12)<span class='macro_popup'>{ 0x12UL, 1 }</span></span>, <span class='macro'>NODROP(0x1000012)<span class='macro_popup'>{ 0x1000012UL, 0 }</span></span>,</td></tr>
<tr class="codeline" data-linenumber="440"><td class="num" id="LN440">440</td><td class="line">    <span class='macro'>NODROP(0x1ffffff)<span class='macro_popup'>{ 0x1ffffffUL, 0 }</span></span>, <span class='macro'>NODROP(0x2000000)<span class='macro_popup'>{ 0x2000000UL, 0 }</span></span>, <span class='macro'>DROP(0x1ff00fe)<span class='macro_popup'>{ 0x1ff00feUL, 1 }</span></span>, <span class='macro'>NODROP(0x2000001)<span class='macro_popup'>{ 0x2000001UL, 0 }</span></span>,</td></tr>
<tr class="codeline" data-linenumber="441"><td class="num" id="LN441">441</td><td class="line">    <span class='macro'>NODROP(0x20fffff)<span class='macro_popup'>{ 0x20fffffUL, 0 }</span></span>, <span class='macro'>NODROP(0x2105500)<span class='macro_popup'>{ 0x2105500UL, 0 }</span></span>, <span class='macro'>DROP(0x20ffffe)<span class='macro_popup'>{ 0x20ffffeUL, 1 }</span></span>, <span class='macro'>NODROP(0x21054ff)<span class='macro_popup'>{ 0x21054ffUL, 0 }</span></span>,</td></tr>
<tr class="codeline" data-linenumber="442"><td class="num" id="LN442">442</td><td class="line">    <span class='macro'>NODROP(0x211ffff)<span class='macro_popup'>{ 0x211ffffUL, 0 }</span></span>, <span class='macro'>DROP(0x2110000)<span class='macro_popup'>{ 0x2110000UL, 1 }</span></span>, <span class='macro'>NODROP(0x2120000)<span class='macro_popup'>{ 0x2120000UL, 0 }</span></span></td></tr>
<tr class="codeline" data-linenumber="443"><td class="num" id="LN443">443</td><td class="line">    <span class='comment'>/* The last test should be NODROP, because a DROP wouldn't get tested. */</span></td></tr>
<tr class="codeline" data-linenumber="444"><td class="num" id="LN444">444</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="445"><td class="num" id="LN445">445</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="446"><td class="num" id="LN446">446</td><td class="line"><span class='keyword'>int</span> main(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> *argv[])</td></tr>
<tr class="codeline" data-linenumber="447"><td class="num" id="LN447">447</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="448"><td class="num" id="LN448">448</td><td class="line">    SSL_SESSION *sess;</td></tr>
<tr class="codeline" data-linenumber="449"><td class="num" id="LN449">449</td><td class="line">    SSL_CTX *ctx;</td></tr>
<tr class="codeline" data-linenumber="450"><td class="num" id="LN450">450</td><td class="line">    SSL *con;</td></tr>
<tr class="codeline" data-linenumber="451"><td class="num" id="LN451">451</td><td class="line">    BIO *rbio;</td></tr>
<tr class="codeline" data-linenumber="452"><td class="num" id="LN452">452</td><td class="line">    BIO *wbio;</td></tr>
<tr class="codeline" data-linenumber="453"><td class="num" id="LN453">453</td><td class="line">    BIO *err;</td></tr>
<tr class="codeline" data-linenumber="454"><td class="num" id="LN454">454</td><td class="line">    time_t now = 0;</td></tr>
<tr class="codeline" data-linenumber="455"><td class="num" id="LN455">455</td><td class="line">    <span class='keyword'>int</span> testresult = 0;</td></tr>
<tr class="codeline" data-linenumber="456"><td class="num" id="LN456">456</td><td class="line">    <span class='keyword'>int</span> ret;</td></tr>
<tr class="codeline" data-linenumber="457"><td class="num" id="LN457">457</td><td class="line">    <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="458"><td class="num" id="LN458">458</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="459"><td class="num" id="LN459">459</td><td class="line">    err = BIO_new_fp(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, <span class='macro'>BIO_NOCLOSE<span class='macro_popup'>0x00</span></span> | <span class='macro'>BIO_FP_TEXT<span class='macro_popup'>0x10</span></span>);</td></tr>
<tr class="codeline" data-linenumber="460"><td class="num" id="LN460">460</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="461"><td class="num" id="LN461">461</td><td class="line">    CRYPTO_set_mem_debug(1);</td></tr>
<tr class="codeline" data-linenumber="462"><td class="num" id="LN462">462</td><td class="line">    CRYPTO_mem_ctrl(<span class='macro'>CRYPTO_MEM_CHECK_ON<span class='macro_popup'>0x1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="463"><td class="num" id="LN463">463</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="464"><td class="num" id="LN464">464</td><td class="line">    RAND_bytes(session_id, <span class='keyword'>sizeof</span>(session_id));</td></tr>
<tr class="codeline" data-linenumber="465"><td class="num" id="LN465">465</td><td class="line">    RAND_bytes(master_secret, <span class='keyword'>sizeof</span>(master_secret));</td></tr>
<tr class="codeline" data-linenumber="466"><td class="num" id="LN466">466</td><td class="line">    RAND_bytes(cookie, <span class='keyword'>sizeof</span>(cookie));</td></tr>
<tr class="codeline" data-linenumber="467"><td class="num" id="LN467">467</td><td class="line">    RAND_bytes(server_random + 4, <span class='keyword'>sizeof</span>(server_random) - 4);</td></tr>
<tr class="codeline" data-linenumber="468"><td class="num" id="LN468">468</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="469"><td class="num" id="LN469">469</td><td class="line">    now = time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="470"><td class="num" id="LN470">470</td><td class="line">    memcpy(server_random, &amp;now, <span class='keyword'>sizeof</span>(now));</td></tr>
<tr class="codeline" data-linenumber="471"><td class="num" id="LN471">471</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="472"><td class="num" id="LN472">472</td><td class="line">    sess = client_session();</td></tr>
<tr class="codeline" data-linenumber="473"><td class="num" id="LN473">473</td><td class="line">    <span class='keyword'>if</span> (sess == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="474"><td class="num" id="LN474">474</td><td class="line">        printf(<span class='string_literal'>"Failed to generate SSL_SESSION\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="475"><td class="num" id="LN475">475</td><td class="line">        <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="476"><td class="num" id="LN476">476</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="477"><td class="num" id="LN477">477</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="478"><td class="num" id="LN478">478</td><td class="line">    handshake_md = EVP_MD_CTX_new();</td></tr>
<tr class="codeline" data-linenumber="479"><td class="num" id="LN479">479</td><td class="line">    <span class='keyword'>if</span> (handshake_md == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="480"><td class="num" id="LN480">480</td><td class="line">        !EVP_DigestInit_ex(handshake_md, EVP_md5_sha1(), <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="481"><td class="num" id="LN481">481</td><td class="line">        printf(<span class='string_literal'>"Failed to initialise handshake_md\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="482"><td class="num" id="LN482">482</td><td class="line">        <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="483"><td class="num" id="LN483">483</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="484"><td class="num" id="LN484">484</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="485"><td class="num" id="LN485">485</td><td class="line">    ctx = SSL_CTX_new(DTLS_client_method());</td></tr>
<tr class="codeline" data-linenumber="486"><td class="num" id="LN486">486</td><td class="line">    <span class='keyword'>if</span> (ctx == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="487"><td class="num" id="LN487">487</td><td class="line">        printf(<span class='string_literal'>"Failed to allocate SSL_CTX\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="488"><td class="num" id="LN488">488</td><td class="line">        <span class='keyword'>goto</span> end_md;</td></tr>
<tr class="codeline" data-linenumber="489"><td class="num" id="LN489">489</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="490"><td class="num" id="LN490">490</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>SSL_CTX_set_min_proto_version(ctx, DTLS1_BAD_VER)<span class='macro_popup'>SSL_CTX_ctrl(ctx, 123, 0x0100, ((void*)0))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="491"><td class="num" id="LN491">491</td><td class="line">        printf(<span class='string_literal'>"SSL_CTX_set_min_proto_version() failed\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="492"><td class="num" id="LN492">492</td><td class="line">        <span class='keyword'>goto</span> end_ctx;</td></tr>
<tr class="codeline" data-linenumber="493"><td class="num" id="LN493">493</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="494"><td class="num" id="LN494">494</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>SSL_CTX_set_max_proto_version(ctx, DTLS1_BAD_VER)<span class='macro_popup'>SSL_CTX_ctrl(ctx, 124, 0x0100, ((void*)0))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="495"><td class="num" id="LN495">495</td><td class="line">        printf(<span class='string_literal'>"SSL_CTX_set_max_proto_version() failed\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="496"><td class="num" id="LN496">496</td><td class="line">        <span class='keyword'>goto</span> end_ctx;</td></tr>
<tr class="codeline" data-linenumber="497"><td class="num" id="LN497">497</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="498"><td class="num" id="LN498">498</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="499"><td class="num" id="LN499">499</td><td class="line">    <span class='keyword'>if</span> (!SSL_CTX_set_cipher_list(ctx, <span class='string_literal'>"AES128-SHA"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="500"><td class="num" id="LN500">500</td><td class="line">        printf(<span class='string_literal'>"SSL_CTX_set_cipher_list() failed\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="501"><td class="num" id="LN501">501</td><td class="line">        <span class='keyword'>goto</span> end_ctx;</td></tr>
<tr class="codeline" data-linenumber="502"><td class="num" id="LN502">502</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="503"><td class="num" id="LN503">503</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="504"><td class="num" id="LN504">504</td><td class="line">    con = SSL_new(ctx);</td></tr>
<tr class="codeline" data-linenumber="505"><td class="num" id="LN505">505</td><td class="line">    <span class='keyword'>if</span> (!SSL_set_session(con, sess)) {</td></tr>
<tr class="codeline" data-linenumber="506"><td class="num" id="LN506">506</td><td class="line">        printf(<span class='string_literal'>"SSL_set_session() failed\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="507"><td class="num" id="LN507">507</td><td class="line">        <span class='keyword'>goto</span> end_con;</td></tr>
<tr class="codeline" data-linenumber="508"><td class="num" id="LN508">508</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="509"><td class="num" id="LN509">509</td><td class="line">    SSL_SESSION_free(sess);</td></tr>
<tr class="codeline" data-linenumber="510"><td class="num" id="LN510">510</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="511"><td class="num" id="LN511">511</td><td class="line">    rbio = BIO_new(BIO_s_mem());</td></tr>
<tr class="codeline" data-linenumber="512"><td class="num" id="LN512">512</td><td class="line">    wbio = BIO_new(BIO_s_mem());</td></tr>
<tr class="codeline" data-linenumber="513"><td class="num" id="LN513">513</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="514"><td class="num" id="LN514">514</td><td class="line">    <span class='macro'>BIO_set_nbio(rbio, 1)<span class='macro_popup'>BIO_ctrl(rbio,102,(1),((void*)0))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="515"><td class="num" id="LN515">515</td><td class="line">    <span class='macro'>BIO_set_nbio(wbio, 1)<span class='macro_popup'>BIO_ctrl(wbio,102,(1),((void*)0))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="516"><td class="num" id="LN516">516</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="517"><td class="num" id="LN517">517</td><td class="line">    SSL_set_bio(con, rbio, wbio);</td></tr>
<tr class="codeline" data-linenumber="518"><td class="num" id="LN518">518</td><td class="line">    SSL_set_connect_state(con);</td></tr>
<tr class="codeline" data-linenumber="519"><td class="num" id="LN519">519</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="520"><td class="num" id="LN520">520</td><td class="line">    <span class='comment'>/* Send initial ClientHello */</span></td></tr>
<tr class="codeline" data-linenumber="521"><td class="num" id="LN521">521</td><td class="line">    ret = SSL_do_handshake(con);</td></tr>
<tr class="codeline" data-linenumber="522"><td class="num" id="LN522">522</td><td class="line">    <span class='keyword'>if</span> (ret &gt; 0 || SSL_get_error(con, ret) != <span class='macro'>SSL_ERROR_WANT_READ<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="523"><td class="num" id="LN523">523</td><td class="line">        printf(<span class='string_literal'>"Unexpected handshake result at initial call!\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="524"><td class="num" id="LN524">524</td><td class="line">        <span class='keyword'>goto</span> end_con;</td></tr>
<tr class="codeline" data-linenumber="525"><td class="num" id="LN525">525</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="526"><td class="num" id="LN526">526</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="527"><td class="num" id="LN527">527</td><td class="line">    <span class='keyword'>if</span> (validate_client_hello(wbio) != 1) {</td></tr>
<tr class="codeline" data-linenumber="528"><td class="num" id="LN528">528</td><td class="line">        printf(<span class='string_literal'>"Initial ClientHello failed validation\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="529"><td class="num" id="LN529">529</td><td class="line">        <span class='keyword'>goto</span> end_con;</td></tr>
<tr class="codeline" data-linenumber="530"><td class="num" id="LN530">530</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="531"><td class="num" id="LN531">531</td><td class="line">    <span class='keyword'>if</span> (send_hello_verify(rbio) != 1) {</td></tr>
<tr class="codeline" data-linenumber="532"><td class="num" id="LN532">532</td><td class="line">        printf(<span class='string_literal'>"Failed to send HelloVerify\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="533"><td class="num" id="LN533">533</td><td class="line">        <span class='keyword'>goto</span> end_con;</td></tr>
<tr class="codeline" data-linenumber="534"><td class="num" id="LN534">534</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="535"><td class="num" id="LN535">535</td><td class="line">    ret = SSL_do_handshake(con);</td></tr>
<tr class="codeline" data-linenumber="536"><td class="num" id="LN536">536</td><td class="line">    <span class='keyword'>if</span> (ret &gt; 0 || SSL_get_error(con, ret) != <span class='macro'>SSL_ERROR_WANT_READ<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="537"><td class="num" id="LN537">537</td><td class="line">        printf(<span class='string_literal'>"Unexpected handshake result after HelloVerify!\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="538"><td class="num" id="LN538">538</td><td class="line">        <span class='keyword'>goto</span> end_con;</td></tr>
<tr class="codeline" data-linenumber="539"><td class="num" id="LN539">539</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="540"><td class="num" id="LN540">540</td><td class="line">    <span class='keyword'>if</span> (validate_client_hello(wbio) != 2) {</td></tr>
<tr class="codeline" data-linenumber="541"><td class="num" id="LN541">541</td><td class="line">        printf(<span class='string_literal'>"Second ClientHello failed validation\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="542"><td class="num" id="LN542">542</td><td class="line">        <span class='keyword'>goto</span> end_con;</td></tr>
<tr class="codeline" data-linenumber="543"><td class="num" id="LN543">543</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="544"><td class="num" id="LN544">544</td><td class="line">    <span class='keyword'>if</span> (send_server_hello(rbio) != 1) {</td></tr>
<tr class="codeline" data-linenumber="545"><td class="num" id="LN545">545</td><td class="line">        printf(<span class='string_literal'>"Failed to send ServerHello\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="546"><td class="num" id="LN546">546</td><td class="line">        <span class='keyword'>goto</span> end_con;</td></tr>
<tr class="codeline" data-linenumber="547"><td class="num" id="LN547">547</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="548"><td class="num" id="LN548">548</td><td class="line">    ret = SSL_do_handshake(con);</td></tr>
<tr class="codeline" data-linenumber="549"><td class="num" id="LN549">549</td><td class="line">    <span class='keyword'>if</span> (ret &gt; 0 || SSL_get_error(con, ret) != <span class='macro'>SSL_ERROR_WANT_READ<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="550"><td class="num" id="LN550">550</td><td class="line">        printf(<span class='string_literal'>"Unexpected handshake result after ServerHello!\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="551"><td class="num" id="LN551">551</td><td class="line">        <span class='keyword'>goto</span> end_con;</td></tr>
<tr class="codeline" data-linenumber="552"><td class="num" id="LN552">552</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="553"><td class="num" id="LN553">553</td><td class="line">    <span class='keyword'>if</span> (send_finished(con, rbio) != 1) {</td></tr>
<tr class="codeline" data-linenumber="554"><td class="num" id="LN554">554</td><td class="line">        printf(<span class='string_literal'>"Failed to send Finished\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="555"><td class="num" id="LN555">555</td><td class="line">        <span class='keyword'>goto</span> end_con;</td></tr>
<tr class="codeline" data-linenumber="556"><td class="num" id="LN556">556</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="557"><td class="num" id="LN557">557</td><td class="line">    ret = SSL_do_handshake(con);</td></tr>
<tr class="codeline" data-linenumber="558"><td class="num" id="LN558">558</td><td class="line">    <span class='keyword'>if</span> (ret &lt; 1) {</td></tr>
<tr class="codeline" data-linenumber="559"><td class="num" id="LN559">559</td><td class="line">        printf(<span class='string_literal'>"Handshake not successful after Finished!\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="560"><td class="num" id="LN560">560</td><td class="line">        <span class='keyword'>goto</span> end_con;</td></tr>
<tr class="codeline" data-linenumber="561"><td class="num" id="LN561">561</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="562"><td class="num" id="LN562">562</td><td class="line">    <span class='keyword'>if</span> (validate_ccs(wbio) != 1) {</td></tr>
<tr class="codeline" data-linenumber="563"><td class="num" id="LN563">563</td><td class="line">        printf(<span class='string_literal'>"Failed to validate client CCS/Finished\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="564"><td class="num" id="LN564">564</td><td class="line">        <span class='keyword'>goto</span> end_con;</td></tr>
<tr class="codeline" data-linenumber="565"><td class="num" id="LN565">565</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="566"><td class="num" id="LN566">566</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="567"><td class="num" id="LN567">567</td><td class="line">    <span class='comment'>/* While we're here and crafting packets by hand, we might as well do a</span></td></tr>
<tr class="codeline" data-linenumber="568"><td class="num" id="LN568">568</td><td class="line">       <span class='comment'>bit of a stress test on the DTLS record replay handling. Not Cisco-DTLS</span></td></tr>
<tr class="codeline" data-linenumber="569"><td class="num" id="LN569">569</td><td class="line">       <span class='comment'>specific but useful anyway for the general case. It's been broken</span></td></tr>
<tr class="codeline" data-linenumber="570"><td class="num" id="LN570">570</td><td class="line">       <span class='comment'>before, and in fact was broken even for a basic 0, 2, 1 test case</span></td></tr>
<tr class="codeline" data-linenumber="571"><td class="num" id="LN571">571</td><td class="line">       <span class='comment'>when this test was first added.... */</span></td></tr>
<tr class="codeline" data-linenumber="572"><td class="num" id="LN572">572</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; (<span class='keyword'>int</span>)<span class='macro'>OSSL_NELEM(tests)<span class='macro_popup'>(sizeof(tests)/sizeof((tests)[0]))</span></span>; i++) {</td></tr>
<tr class="codeline" data-linenumber="573"><td class="num" id="LN573">573</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>long</span> recv_buf[2];</td></tr>
<tr class="codeline" data-linenumber="574"><td class="num" id="LN574">574</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="575"><td class="num" id="LN575">575</td><td class="line">        <span class='keyword'>if</span> (send_record(rbio, <span class='macro'>SSL3_RT_APPLICATION_DATA<span class='macro_popup'>23</span></span>, tests[i].seq,</td></tr>
<tr class="codeline" data-linenumber="576"><td class="num" id="LN576">576</td><td class="line">                        &amp;tests[i].seq, <span class='keyword'>sizeof</span>(<span class='keyword'>unsigned</span> <span class='keyword'>long</span>)) != 1) {</td></tr>
<tr class="codeline" data-linenumber="577"><td class="num" id="LN577">577</td><td class="line">            printf(<span class='string_literal'>"Failed to send data seq #0x%lx (%d)\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="578"><td class="num" id="LN578">578</td><td class="line">                   tests[i].seq, i);</td></tr>
<tr class="codeline" data-linenumber="579"><td class="num" id="LN579">579</td><td class="line">            <span class='keyword'>goto</span> end_con;</td></tr>
<tr class="codeline" data-linenumber="580"><td class="num" id="LN580">580</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="581"><td class="num" id="LN581">581</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="582"><td class="num" id="LN582">582</td><td class="line">        <span class='keyword'>if</span> (tests[i].drop)</td></tr>
<tr class="codeline" data-linenumber="583"><td class="num" id="LN583">583</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="584"><td class="num" id="LN584">584</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="585"><td class="num" id="LN585">585</td><td class="line">        ret = SSL_read(con, recv_buf, 2 * <span class='keyword'>sizeof</span>(<span class='keyword'>unsigned</span> <span class='keyword'>long</span>));</td></tr>
<tr class="codeline" data-linenumber="586"><td class="num" id="LN586">586</td><td class="line">        <span class='keyword'>if</span> (ret != <span class='keyword'>sizeof</span>(<span class='keyword'>unsigned</span> <span class='keyword'>long</span>)) {</td></tr>
<tr class="codeline" data-linenumber="587"><td class="num" id="LN587">587</td><td class="line">            printf(<span class='string_literal'>"SSL_read failed or wrong size on seq#0x%lx (%d)\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="588"><td class="num" id="LN588">588</td><td class="line">                   tests[i].seq, i);</td></tr>
<tr class="codeline" data-linenumber="589"><td class="num" id="LN589">589</td><td class="line">            <span class='keyword'>goto</span> end_con;</td></tr>
<tr class="codeline" data-linenumber="590"><td class="num" id="LN590">590</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="591"><td class="num" id="LN591">591</td><td class="line">        <span class='keyword'>if</span> (recv_buf[0] != tests[i].seq) {</td></tr>
<tr class="codeline" data-linenumber="592"><td class="num" id="LN592">592</td><td class="line">            printf(<span class='string_literal'>"Wrong data packet received (0x%lx not 0x%lx) at packet %d\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="593"><td class="num" id="LN593">593</td><td class="line">                   recv_buf[0], tests[i].seq, i);</td></tr>
<tr class="codeline" data-linenumber="594"><td class="num" id="LN594">594</td><td class="line">            <span class='keyword'>goto</span> end_con;</td></tr>
<tr class="codeline" data-linenumber="595"><td class="num" id="LN595">595</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="596"><td class="num" id="LN596">596</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="597"><td class="num" id="LN597">597</td><td class="line">    <span class='keyword'>if</span> (tests[i-1].drop) {</td></tr>
<tr class="codeline" data-linenumber="598"><td class="num" id="LN598">598</td><td class="line">        printf(<span class='string_literal'>"Error: last test cannot be DROP()\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="599"><td class="num" id="LN599">599</td><td class="line">        <span class='keyword'>goto</span> end_con;</td></tr>
<tr class="codeline" data-linenumber="600"><td class="num" id="LN600">600</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="601"><td class="num" id="LN601">601</td><td class="line">    testresult=1;</td></tr>
<tr class="codeline" data-linenumber="602"><td class="num" id="LN602">602</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="603"><td class="num" id="LN603">603</td><td class="line"> end_con:</td></tr>
<tr class="codeline" data-linenumber="604"><td class="num" id="LN604">604</td><td class="line">    SSL_free(con);</td></tr>
<tr class="codeline" data-linenumber="605"><td class="num" id="LN605">605</td><td class="line"> end_ctx:</td></tr>
<tr class="codeline" data-linenumber="606"><td class="num" id="LN606">606</td><td class="line">    SSL_CTX_free(ctx);</td></tr>
<tr class="codeline" data-linenumber="607"><td class="num" id="LN607">607</td><td class="line"> end_md:</td></tr>
<tr class="codeline" data-linenumber="608"><td class="num" id="LN608">608</td><td class="line">    EVP_MD_CTX_free(handshake_md);</td></tr>
<tr class="codeline" data-linenumber="609"><td class="num" id="LN609">609</td><td class="line"> end:</td></tr>
<tr class="codeline" data-linenumber="610"><td class="num" id="LN610">610</td><td class="line">    ERR_print_errors_fp(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>);</td></tr>
<tr class="codeline" data-linenumber="611"><td class="num" id="LN611">611</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="612"><td class="num" id="LN612">612</td><td class="line">    <span class='keyword'>if</span> (!testresult) {</td></tr>
<tr class="codeline" data-linenumber="613"><td class="num" id="LN613">613</td><td class="line">        printf(<span class='string_literal'>"Cisco BadDTLS test: FAILED\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="614"><td class="num" id="LN614">614</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="615"><td class="num" id="LN615">615</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="616"><td class="num" id="LN616">616</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="617"><td class="num" id="LN617">617</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_CRYPTO_MDEBUG</span></td></tr>
<tr class="codeline" data-linenumber="618"><td class="num" id="LN618">618</td><td class="line">    <span class='keyword'>if</span> (CRYPTO_mem_leaks(err) &lt;= 0)</td></tr>
<tr class="codeline" data-linenumber="619"><td class="num" id="LN619">619</td><td class="line">        testresult = 0;</td></tr>
<tr class="codeline" data-linenumber="620"><td class="num" id="LN620">620</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="621"><td class="num" id="LN621">621</td><td class="line">    BIO_free(err);</td></tr>
<tr class="codeline" data-linenumber="622"><td class="num" id="LN622">622</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="623"><td class="num" id="LN623">623</td><td class="line">    <span class='keyword'>return</span> testresult?0:1;</td></tr>
<tr class="codeline" data-linenumber="624"><td class="num" id="LN624">624</td><td class="line">}</td></tr>
</table></body></html>
