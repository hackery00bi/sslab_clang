<!doctype html>
<html>
<head>
<title>lj_ffrecord.c</title>

<style type="text/css">
body { color:#000000; background-color:#ffffff }
body { font-family:Helvetica, sans-serif; font-size:10pt }
h1 { font-size:14pt }
.FileName { margin-top: 5px; margin-bottom: 5px; display: inline; }
.FileNav { margin-left: 5px; margin-right: 5px; display: inline; }
.FileNav a { text-decoration:none; font-size: larger; }
.divider { margin-top: 30px; margin-bottom: 30px; height: 15px; }
.divider { background-color: gray; }
.code { border-collapse:collapse; width:100%; }
.code { font-family: "Monospace", monospace; font-size:10pt }
.code { line-height: 1.2em }
.comment { color: green; font-style: oblique }
.keyword { color: blue }
.string_literal { color: red }
.directive { color: darkmagenta }

/* Macros and variables could have pop-up notes hidden by default.
  - Macro pop-up:    expansion of the macro
  - Variable pop-up: value (table) of the variable */
.macro_popup, .variable_popup { display: none; }

/* Pop-up appears on mouse-hover event. */
.macro:hover .macro_popup, .variable:hover .variable_popup {
  display: block;
  padding: 2px;
  -webkit-border-radius:5px;
  -webkit-box-shadow:1px 1px 7px #000;
  border-radius:5px;
  box-shadow:1px 1px 7px #000;
  position: absolute;
  top: -1em;
  left:10em;
  z-index: 1
}

.macro_popup {
  border: 2px solid red;
  background-color:#FFF0F0;
  font-weight: normal;
}

.variable_popup {
  border: 2px solid blue;
  background-color:#F0F0FF;
  font-weight: bold;
  font-family: Helvetica, sans-serif;
  font-size: 9pt;
}

/* Pop-up notes needs a relative position as a base where they pops up. */
.macro, .variable {
  background-color: PaleGoldenRod;
  position: relative;
}
.macro { color: DarkMagenta; }

#tooltiphint {
  position: fixed;
  width: 50em;
  margin-left: -25em;
  left: 50%;
  padding: 10px;
  border: 1px solid #b0b0b0;
  border-radius: 2px;
  box-shadow: 1px 1px 7px black;
  background-color: #c0c0c0;
  z-index: 2;
}

.num { width:2.5em; padding-right:2ex; background-color:#eeeeee }
.num { text-align:right; font-size:8pt }
.num { color:#444444 }
.line { padding-left: 1ex; border-left: 3px solid #ccc }
.line { white-space: pre }
.msg { -webkit-box-shadow:1px 1px 7px #000 }
.msg { box-shadow:1px 1px 7px #000 }
.msg { -webkit-border-radius:5px }
.msg { border-radius:5px }
.msg { font-family:Helvetica, sans-serif; font-size:8pt }
.msg { float:left }
.msg { padding:0.25em 1ex 0.25em 1ex }
.msg { margin-top:10px; margin-bottom:10px }
.msg { font-weight:bold }
.msg { max-width:60em; word-wrap: break-word; white-space: pre-wrap }
.msgT { padding:0x; spacing:0x }
.msgEvent { background-color:#fff8b4; color:#000000 }
.msgControl { background-color:#bbbbbb; color:#000000 }
.msgNote { background-color:#ddeeff; color:#000000 }
.mrange { background-color:#dfddf3 }
.mrange { border-bottom:1px solid #6F9DBE }
.PathIndex { font-weight: bold; padding:0px 5px; margin-right:5px; }
.PathIndex { -webkit-border-radius:8px }
.PathIndex { border-radius:8px }
.PathIndexEvent { background-color:#bfba87 }
.PathIndexControl { background-color:#8c8c8c }
.PathIndexPopUp { background-color: #879abc; }
.PathNav a { text-decoration:none; font-size: larger }
.CodeInsertionHint { font-weight: bold; background-color: #10dd10 }
.CodeRemovalHint { background-color:#de1010 }
.CodeRemovalHint { border-bottom:1px solid #6F9DBE }
.selected{ background-color:orange !important; }

table.simpletable {
  padding: 5px;
  font-size:12pt;
  margin:20px;
  border-collapse: collapse; border-spacing: 0px;
}
td.rowname {
  text-align: right;
  vertical-align: top;
  font-weight: bold;
  color:#444444;
  padding-right:2ex;
}

/* Hidden text. */
input.spoilerhider + label {
  cursor: pointer;
  text-decoration: underline;
  display: block;
}
input.spoilerhider {
 display: none;
}
input.spoilerhider ~ .spoiler {
  overflow: hidden;
  margin: 10px auto 0;
  height: 0;
  opacity: 0;
}
input.spoilerhider:checked + label + .spoiler{
  height: auto;
  opacity: 1;
}
</style>
</head>
<body>
<!-- BUGDESC Call to function 'memmove' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memmove_s' in case of C11 -->

<!-- BUGTYPE Potential insecure memory buffer bounds restriction in call 'memmove' -->

<!-- BUGCATEGORY Security -->

<!-- BUGFILE /tmp/real/c_wrk/wrk0/obj/LuaJIT-2.1.0-beta3/src/lj_ffrecord.c -->

<!-- FILENAME lj_ffrecord.c -->

<!-- FUNCTIONNAME recff_stitch -->

<!-- ISSUEHASHCONTENTOFLINEINCONTEXT 7496f668dae53a5b9bea0c9aeaeb9140 -->

<!-- BUGLINE 120 -->

<!-- BUGCOLUMN 3 -->

<!-- BUGPATHLENGTH 1 -->

<!-- BUGMETAEND -->
<!-- REPORTHEADER -->
<h3>Bug Summary</h3>
<table class="simpletable">
<tr><td class="rowname">File:</td><td>obj/LuaJIT-2.1.0-beta3/src/lj_ffrecord.c</td></tr>
<tr><td class="rowname">Warning:</td><td><a href="#EndPath">line 120, column 3</a><br />Call to function 'memmove' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memmove_s' in case of C11</td></tr>

</table>
<!-- REPORTSUMMARYEXTRA -->
<h3>Annotated Source Code</h3>
<p>Press <a href="#" onclick="toggleHelp(); return false;">'?'</a>
   to see keyboard shortcuts</p>
<input type="checkbox" class="spoilerhider" id="showinvocation" />
<label for="showinvocation" >Show analyzer invocation</label>
<div class="spoiler">clang -cc1 -cc1 -triple x86_64-unknown-linux-gnu -analyze -disable-free -main-file-name lj_ffrecord.c -analyzer-store=region -analyzer-opt-analyze-nested-blocks -analyzer-checker=core -analyzer-checker=apiModeling -analyzer-checker=unix -analyzer-checker=deadcode -analyzer-checker=security.insecureAPI.UncheckedReturn -analyzer-checker=security.insecureAPI.getpw -analyzer-checker=security.insecureAPI.gets -analyzer-checker=security.insecureAPI.mktemp -analyzer-checker=security.insecureAPI.mkstemp -analyzer-checker=security.insecureAPI.vfork -analyzer-checker=nullability.NullPassedToNonnull -analyzer-checker=nullability.NullReturnedFromNonnull -analyzer-output plist -w -setup-static-analyzer -mrelocation-model static -mframe-pointer=none -fmath-errno -fno-rounding-math -mconstructor-aliases -munwind-tables -target-cpu x86-64 -fno-split-dwarf-inlining -debugger-tuning=gdb -resource-dir /llvm-project/build/lib/clang/12.0.0 -D _FILE_OFFSET_BITS=64 -D _LARGEFILE_SOURCE -U _FORTIFY_SOURCE -D LUA_ROOT="/tmp/real/c_wrk/wrk0/obj" -D LUA_MULTILIB="lib" -internal-isystem /usr/local/include -internal-isystem /llvm-project/build/lib/clang/12.0.0/include -internal-externc-isystem /usr/include/x86_64-linux-gnu -internal-externc-isystem /include -internal-externc-isystem /usr/include -O2 -fdebug-compilation-dir /tmp/real/c_wrk/wrk0/obj/LuaJIT-2.1.0-beta3/src -ferror-limit 19 -fgnuc-version=4.2.1 -vectorize-loops -vectorize-slp -analyzer-checker core -analyzer-checker cplusplus -analyzer-checker nullability -analyzer-checker optin -analyzer-checker security -analyzer-checker unix -analyzer-checker osx -analyzer-checker fuchsia -analyzer-checker webkit -analyzer-output=html -faddrsig -o /tmp/scan-build-2020-11-20-011311-6666-1 -x c lj_ffrecord.c
</div>
<div id='tooltiphint' hidden="true">
  <p>Keyboard shortcuts: </p>
  <ul>
    <li>Use 'j/k' keys for keyboard navigation</li>
    <li>Use 'Shift+S' to show/hide relevant lines</li>
    <li>Use '?' to toggle this window</li>
  </ul>
  <a href="#" onclick="toggleHelp(); return false;">Close</a>
</div>
<script type='text/javascript'>
var relevant_lines = {"1": {"120": 1}};

var filterCounterexample = function (hide) {
  var tables = document.getElementsByClassName("code");
  for (var t=0; t<tables.length; t++) {
    var table = tables[t];
    var file_id = table.getAttribute("data-fileid");
    var lines_in_fid = relevant_lines[file_id];
    if (!lines_in_fid) {
      lines_in_fid = {};
    }
    var lines = table.getElementsByClassName("codeline");
    for (var i=0; i<lines.length; i++) {
        var el = lines[i];
        var lineNo = el.getAttribute("data-linenumber");
        if (!lines_in_fid[lineNo]) {
          if (hide) {
            el.setAttribute("hidden", "");
          } else {
            el.removeAttribute("hidden");
          }
        }
    }
  }
}

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "S") {
    var checked = document.getElementsByName("showCounterexample")[0].checked;
    filterCounterexample(!checked);
    document.getElementsByName("showCounterexample")[0].checked = !checked;
  } else {
    return;
  }
  event.preventDefault();
}, true);

document.addEventListener("DOMContentLoaded", function() {
    document.querySelector('input[name="showCounterexample"]').onchange=
        function (event) {
      filterCounterexample(this.checked);
    };
});
</script>

<form>
    <input type="checkbox" name="showCounterexample" id="showCounterexample" />
    <label for="showCounterexample">
       Show only relevant lines
    </label>
</form>

<script type='text/javascript'>
var digitMatcher = new RegExp("[0-9]+");

var querySelectorAllArray = function(selector) {
  return Array.prototype.slice.call(
    document.querySelectorAll(selector));
}

document.addEventListener("DOMContentLoaded", function() {
    querySelectorAllArray(".PathNav > a").forEach(
        function(currentValue, currentIndex) {
            var hrefValue = currentValue.getAttribute("href");
            currentValue.onclick = function() {
                scrollTo(document.querySelector(hrefValue));
                return false;
            };
        });
});

var findNum = function() {
    var s = document.querySelector(".selected");
    if (!s || s.id == "EndPath") {
        return 0;
    }
    var out = parseInt(digitMatcher.exec(s.id)[0]);
    return out;
};

var scrollTo = function(el) {
    querySelectorAllArray(".selected").forEach(function(s) {
        s.classList.remove("selected");
    });
    el.classList.add("selected");
    window.scrollBy(0, el.getBoundingClientRect().top -
        (window.innerHeight / 2));
}

var move = function(num, up, numItems) {
  if (num == 1 && up || num == numItems - 1 && !up) {
    return 0;
  } else if (num == 0 && up) {
    return numItems - 1;
  } else if (num == 0 && !up) {
    return 1 % numItems;
  }
  return up ? num - 1 : num + 1;
}

var numToId = function(num) {
  if (num == 0) {
    return document.getElementById("EndPath")
  }
  return document.getElementById("Path" + num);
};

var navigateTo = function(up) {
  var numItems = document.querySelectorAll(
      ".line > .msgEvent, .line > .msgControl").length;
  var currentSelected = findNum();
  var newSelected = move(currentSelected, up, numItems);
  var newEl = numToId(newSelected, numItems);

  // Scroll element into center.
  scrollTo(newEl);
};

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "j") {
    navigateTo(/*up=*/false);
  } else if (event.key == "k") {
    navigateTo(/*up=*/true);
  } else {
    return;
  }
  event.preventDefault();
}, true);
</script>
  
<script type='text/javascript'>

var toggleHelp = function() {
    var hint = document.querySelector("#tooltiphint");
    var attributeName = "hidden";
    if (hint.hasAttribute(attributeName)) {
      hint.removeAttribute(attributeName);
    } else {
      hint.setAttribute("hidden", "true");
    }
};
window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "?") {
    toggleHelp();
  } else {
    return;
  }
  event.preventDefault();
});
</script>
<table class="code" data-fileid="1">
<tr class="codeline" data-linenumber="1"><td class="num" id="LN1">1</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2"><td class="num" id="LN2">2</td><td class="line"><span class='comment'>** Fast function call recorder.</span></td></tr>
<tr class="codeline" data-linenumber="3"><td class="num" id="LN3">3</td><td class="line"><span class='comment'>** Copyright (C) 2005-2017 Mike Pall. See Copyright Notice in luajit.h</span></td></tr>
<tr class="codeline" data-linenumber="4"><td class="num" id="LN4">4</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="5"><td class="num" id="LN5">5</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6"><td class="num" id="LN6">6</td><td class="line"><span class='directive'>#define lj_ffrecord_c</span></td></tr>
<tr class="codeline" data-linenumber="7"><td class="num" id="LN7">7</td><td class="line"><span class='directive'>#define LUA_CORE</span></td></tr>
<tr class="codeline" data-linenumber="8"><td class="num" id="LN8">8</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="9"><td class="num" id="LN9">9</td><td class="line"><span class='directive'>#include "lj_obj.h"</span></td></tr>
<tr class="codeline" data-linenumber="10"><td class="num" id="LN10">10</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="11"><td class="num" id="LN11">11</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_HASJIT<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="12"><td class="num" id="LN12">12</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="13"><td class="num" id="LN13">13</td><td class="line"><span class='directive'>#include "lj_err.h"</span></td></tr>
<tr class="codeline" data-linenumber="14"><td class="num" id="LN14">14</td><td class="line"><span class='directive'>#include "lj_str.h"</span></td></tr>
<tr class="codeline" data-linenumber="15"><td class="num" id="LN15">15</td><td class="line"><span class='directive'>#include "lj_tab.h"</span></td></tr>
<tr class="codeline" data-linenumber="16"><td class="num" id="LN16">16</td><td class="line"><span class='directive'>#include "lj_frame.h"</span></td></tr>
<tr class="codeline" data-linenumber="17"><td class="num" id="LN17">17</td><td class="line"><span class='directive'>#include "lj_bc.h"</span></td></tr>
<tr class="codeline" data-linenumber="18"><td class="num" id="LN18">18</td><td class="line"><span class='directive'>#include "lj_ff.h"</span></td></tr>
<tr class="codeline" data-linenumber="19"><td class="num" id="LN19">19</td><td class="line"><span class='directive'>#include "lj_ir.h"</span></td></tr>
<tr class="codeline" data-linenumber="20"><td class="num" id="LN20">20</td><td class="line"><span class='directive'>#include "lj_jit.h"</span></td></tr>
<tr class="codeline" data-linenumber="21"><td class="num" id="LN21">21</td><td class="line"><span class='directive'>#include "lj_ircall.h"</span></td></tr>
<tr class="codeline" data-linenumber="22"><td class="num" id="LN22">22</td><td class="line"><span class='directive'>#include "lj_iropt.h"</span></td></tr>
<tr class="codeline" data-linenumber="23"><td class="num" id="LN23">23</td><td class="line"><span class='directive'>#include "lj_trace.h"</span></td></tr>
<tr class="codeline" data-linenumber="24"><td class="num" id="LN24">24</td><td class="line"><span class='directive'>#include "lj_record.h"</span></td></tr>
<tr class="codeline" data-linenumber="25"><td class="num" id="LN25">25</td><td class="line"><span class='directive'>#include "lj_ffrecord.h"</span></td></tr>
<tr class="codeline" data-linenumber="26"><td class="num" id="LN26">26</td><td class="line"><span class='directive'>#include "lj_crecord.h"</span></td></tr>
<tr class="codeline" data-linenumber="27"><td class="num" id="LN27">27</td><td class="line"><span class='directive'>#include "lj_dispatch.h"</span></td></tr>
<tr class="codeline" data-linenumber="28"><td class="num" id="LN28">28</td><td class="line"><span class='directive'>#include "lj_vm.h"</span></td></tr>
<tr class="codeline" data-linenumber="29"><td class="num" id="LN29">29</td><td class="line"><span class='directive'>#include "lj_strscan.h"</span></td></tr>
<tr class="codeline" data-linenumber="30"><td class="num" id="LN30">30</td><td class="line"><span class='directive'>#include "lj_strfmt.h"</span></td></tr>
<tr class="codeline" data-linenumber="31"><td class="num" id="LN31">31</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="32"><td class="num" id="LN32">32</td><td class="line"><span class='comment'>/* Some local macros to save typing. Undef'd at the end. */</span></td></tr>
<tr class="codeline" data-linenumber="33"><td class="num" id="LN33">33</td><td class="line"><span class='directive'>#define IR(ref)			(&amp;J-&gt;cur.ir[(ref)])</span></td></tr>
<tr class="codeline" data-linenumber="34"><td class="num" id="LN34">34</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="35"><td class="num" id="LN35">35</td><td class="line"><span class='comment'>/* Pass IR on to next optimization in chain (FOLD). */</span></td></tr>
<tr class="codeline" data-linenumber="36"><td class="num" id="LN36">36</td><td class="line"><span class='directive'>#define emitir(ot, a, b)	(<span class='macro'>lj_ir_set(J, (ot), (a), (b))<span class='macro_popup'>lj_ir_set_(J, (uint16_t)((ot)), (IRRef1)((a)), (IRRef1)((b)))</span></span>, lj_opt_fold(J))</span></td></tr>
<tr class="codeline" data-linenumber="37"><td class="num" id="LN37">37</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="38"><td class="num" id="LN38">38</td><td class="line"><span class='comment'>/* -- Fast function recording handlers ------------------------------------ */</span></td></tr>
<tr class="codeline" data-linenumber="39"><td class="num" id="LN39">39</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="40"><td class="num" id="LN40">40</td><td class="line"><span class='comment'>/* Conventions for fast function call handlers:</span></td></tr>
<tr class="codeline" data-linenumber="41"><td class="num" id="LN41">41</td><td class="line"><span class='comment'>**</span></td></tr>
<tr class="codeline" data-linenumber="42"><td class="num" id="LN42">42</td><td class="line"><span class='comment'>** The argument slots start at J-&gt;base[0]. All of them are guaranteed to be</span></td></tr>
<tr class="codeline" data-linenumber="43"><td class="num" id="LN43">43</td><td class="line"><span class='comment'>** valid and type-specialized references. J-&gt;base[J-&gt;maxslot] is set to 0</span></td></tr>
<tr class="codeline" data-linenumber="44"><td class="num" id="LN44">44</td><td class="line"><span class='comment'>** as a sentinel. The runtime argument values start at rd-&gt;argv[0].</span></td></tr>
<tr class="codeline" data-linenumber="45"><td class="num" id="LN45">45</td><td class="line"><span class='comment'>**</span></td></tr>
<tr class="codeline" data-linenumber="46"><td class="num" id="LN46">46</td><td class="line"><span class='comment'>** In general fast functions should check for presence of all of their</span></td></tr>
<tr class="codeline" data-linenumber="47"><td class="num" id="LN47">47</td><td class="line"><span class='comment'>** arguments and for the correct argument types. Some simplifications</span></td></tr>
<tr class="codeline" data-linenumber="48"><td class="num" id="LN48">48</td><td class="line"><span class='comment'>** are allowed if the interpreter throws instead. But even if recording</span></td></tr>
<tr class="codeline" data-linenumber="49"><td class="num" id="LN49">49</td><td class="line"><span class='comment'>** is aborted, the generated IR must be consistent (no zero-refs).</span></td></tr>
<tr class="codeline" data-linenumber="50"><td class="num" id="LN50">50</td><td class="line"><span class='comment'>**</span></td></tr>
<tr class="codeline" data-linenumber="51"><td class="num" id="LN51">51</td><td class="line"><span class='comment'>** The number of results in rd-&gt;nres is set to 1. Handlers that return</span></td></tr>
<tr class="codeline" data-linenumber="52"><td class="num" id="LN52">52</td><td class="line"><span class='comment'>** a different number of results need to override it. A negative value</span></td></tr>
<tr class="codeline" data-linenumber="53"><td class="num" id="LN53">53</td><td class="line"><span class='comment'>** prevents return processing (e.g. for pending calls).</span></td></tr>
<tr class="codeline" data-linenumber="54"><td class="num" id="LN54">54</td><td class="line"><span class='comment'>**</span></td></tr>
<tr class="codeline" data-linenumber="55"><td class="num" id="LN55">55</td><td class="line"><span class='comment'>** Results need to be stored starting at J-&gt;base[0]. Return processing</span></td></tr>
<tr class="codeline" data-linenumber="56"><td class="num" id="LN56">56</td><td class="line"><span class='comment'>** moves them to the right slots later.</span></td></tr>
<tr class="codeline" data-linenumber="57"><td class="num" id="LN57">57</td><td class="line"><span class='comment'>**</span></td></tr>
<tr class="codeline" data-linenumber="58"><td class="num" id="LN58">58</td><td class="line"><span class='comment'>** The per-ffid auxiliary data is the value of the 2nd part of the</span></td></tr>
<tr class="codeline" data-linenumber="59"><td class="num" id="LN59">59</td><td class="line"><span class='comment'>** LJLIB_REC() annotation. This allows handling similar functionality</span></td></tr>
<tr class="codeline" data-linenumber="60"><td class="num" id="LN60">60</td><td class="line"><span class='comment'>** in a common handler.</span></td></tr>
<tr class="codeline" data-linenumber="61"><td class="num" id="LN61">61</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="62"><td class="num" id="LN62">62</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="63"><td class="num" id="LN63">63</td><td class="line"><span class='comment'>/* Type of handler to record a fast function. */</span></td></tr>
<tr class="codeline" data-linenumber="64"><td class="num" id="LN64">64</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>void</span> (LJ_FASTCALL *RecordFunc)(jit_State *J, RecordFFData *rd);</td></tr>
<tr class="codeline" data-linenumber="65"><td class="num" id="LN65">65</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="66"><td class="num" id="LN66">66</td><td class="line"><span class='comment'>/* Get runtime value of int argument. */</span></td></tr>
<tr class="codeline" data-linenumber="67"><td class="num" id="LN67">67</td><td class="line"><span class='keyword'>static</span> int32_t argv2int(jit_State *J, TValue *o)</td></tr>
<tr class="codeline" data-linenumber="68"><td class="num" id="LN68">68</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="69"><td class="num" id="LN69">69</td><td class="line">  <span class='keyword'>if</span> (!lj_strscan_numberobj(o))</td></tr>
<tr class="codeline" data-linenumber="70"><td class="num" id="LN70">70</td><td class="line">    lj_trace_err(J, LJ_TRERR_BADTYPE);</td></tr>
<tr class="codeline" data-linenumber="71"><td class="num" id="LN71">71</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>tvisint(o)<span class='macro_popup'>(0 &amp;&amp; ((o)-&gt;it) == 0xfffeffffu)</span></span> ? <span class='macro'>intV(o)<span class='macro_popup'>((int32_t)(o)-&gt;i)</span></span> : <span class='macro'>lj_num2int(numV(o))<span class='macro_popup'>((int32_t)(((o)-&gt;n)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="72"><td class="num" id="LN72">72</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="73"><td class="num" id="LN73">73</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="74"><td class="num" id="LN74">74</td><td class="line"><span class='comment'>/* Get runtime value of string argument. */</span></td></tr>
<tr class="codeline" data-linenumber="75"><td class="num" id="LN75">75</td><td class="line"><span class='keyword'>static</span> GCstr *argv2str(jit_State *J, TValue *o)</td></tr>
<tr class="codeline" data-linenumber="76"><td class="num" id="LN76">76</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="77"><td class="num" id="LN77">77</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>LJ_LIKELY(tvisstr(o))<span class='macro_popup'>__builtin_expect(!!((((o)-&gt;it) == (~4u))), 1)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="78"><td class="num" id="LN78">78</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>strV(o)<span class='macro_popup'>(&amp;(((GCobj *)(uintptr_t)((o)-&gt;gcr).gcptr32))-&gt;str)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="79"><td class="num" id="LN79">79</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="80"><td class="num" id="LN80">80</td><td class="line">    GCstr *s;</td></tr>
<tr class="codeline" data-linenumber="81"><td class="num" id="LN81">81</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>tvisnumber(o)<span class='macro_popup'>(((o)-&gt;it) &lt;= 0xfffeffffu)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="82"><td class="num" id="LN82">82</td><td class="line">      lj_trace_err(J, LJ_TRERR_BADTYPE);</td></tr>
<tr class="codeline" data-linenumber="83"><td class="num" id="LN83">83</td><td class="line">    s = lj_strfmt_number(J-&gt;L, o);</td></tr>
<tr class="codeline" data-linenumber="84"><td class="num" id="LN84">84</td><td class="line">    setstrV(J-&gt;L, o, s);</td></tr>
<tr class="codeline" data-linenumber="85"><td class="num" id="LN85">85</td><td class="line">    <span class='keyword'>return</span> s;</td></tr>
<tr class="codeline" data-linenumber="86"><td class="num" id="LN86">86</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="87"><td class="num" id="LN87">87</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="88"><td class="num" id="LN88">88</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="89"><td class="num" id="LN89">89</td><td class="line"><span class='comment'>/* Return number of results wanted by caller. */</span></td></tr>
<tr class="codeline" data-linenumber="90"><td class="num" id="LN90">90</td><td class="line"><span class='keyword'>static</span> ptrdiff_t results_wanted(jit_State *J)</td></tr>
<tr class="codeline" data-linenumber="91"><td class="num" id="LN91">91</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="92"><td class="num" id="LN92">92</td><td class="line">  TValue *frame = J-&gt;L-&gt;base-1;</td></tr>
<tr class="codeline" data-linenumber="93"><td class="num" id="LN93">93</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>frame_islua(frame)<span class='macro_popup'>((((ptrdiff_t)(frame)-&gt;fr.tp.ftsz) &amp; 3) == FRAME_LUA)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="94"><td class="num" id="LN94">94</td><td class="line">    <span class='keyword'>return</span> (ptrdiff_t)<span class='macro'>bc_b(frame_pc(frame)[-1])<span class='macro_popup'>((BCReg)(((((const BCIns *)(void *)(uintptr_t)((frame)-&gt;fr<br>.tp.pcr).ptr32))[-1])&gt;&gt;24))</span></span> - 1;</td></tr>
<tr class="codeline" data-linenumber="95"><td class="num" id="LN95">95</td><td class="line">  <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="96"><td class="num" id="LN96">96</td><td class="line">    <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="97"><td class="num" id="LN97">97</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="98"><td class="num" id="LN98">98</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="99"><td class="num" id="LN99">99</td><td class="line"><span class='comment'>/* Trace stitching: add continuation below frame to start a new trace. */</span></td></tr>
<tr class="codeline" data-linenumber="100"><td class="num" id="LN100">100</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> recff_stitch(jit_State *J)</td></tr>
<tr class="codeline" data-linenumber="101"><td class="num" id="LN101">101</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="102"><td class="num" id="LN102">102</td><td class="line">  ASMFunction cont = lj_cont_stitch;</td></tr>
<tr class="codeline" data-linenumber="103"><td class="num" id="LN103">103</td><td class="line">  lua_State *L = J-&gt;L;</td></tr>
<tr class="codeline" data-linenumber="104"><td class="num" id="LN104">104</td><td class="line">  TValue *base = L-&gt;base;</td></tr>
<tr class="codeline" data-linenumber="105"><td class="num" id="LN105">105</td><td class="line">  BCReg nslot = J-&gt;maxslot + 1 + <span class='macro'>LJ_FR2<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="106"><td class="num" id="LN106">106</td><td class="line">  TValue *nframe = base + 1 + <span class='macro'>LJ_FR2<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="107"><td class="num" id="LN107">107</td><td class="line">  <span class='keyword'>const</span> BCIns *pc = <span class='macro'>frame_pc(base-1)<span class='macro_popup'>(((const BCIns *)(void *)(uintptr_t)((base-1)-&gt;fr.tp.pcr).<br>ptr32))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="108"><td class="num" id="LN108">108</td><td class="line">  TValue *pframe = <span class='macro'>frame_prevl(base-1)<span class='macro_popup'>((base-1) - (1+0 +((BCReg)((((((const BCIns *)(void *)(uintptr_t<br>)((base-1)-&gt;fr.tp.pcr).ptr32))[-1])&gt;&gt;8)&amp;0xff))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="109"><td class="num" id="LN109">109</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="110"><td class="num" id="LN110">110</td><td class="line">  <span class='comment'>/* Move func + args up in Lua stack and insert continuation. */</span></td></tr>
<tr class="codeline" data-linenumber="111"><td class="num" id="LN111">111</td><td class="line">  memmove(&amp;base[1], &amp;base[-1-<span class='macro'>LJ_FR2<span class='macro_popup'>0</span></span>], <span class='keyword'>sizeof</span>(TValue)*nslot);</td></tr>
<tr class="codeline" data-linenumber="112"><td class="num" id="LN112">112</td><td class="line">  <span class='macro'>setframe_ftsz(nframe, ((<span class='keyword'>char</span> *)nframe - (<span class='keyword'>char</span> *)pframe) + FRAME_CONT)<span class='macro_popup'>((nframe)-&gt;fr.tp.ftsz = (int32_t)(((char *)nframe - (char *<br>)pframe) + FRAME_CONT))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="113"><td class="num" id="LN113">113</td><td class="line">  <span class='macro'>setcont(base-LJ_FR2, cont)<span class='macro_popup'>((base-0)-&gt;u64 = (uint64_t)(void *)(cont) - (uint64_t)lj_vm_asm_begin<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="114"><td class="num" id="LN114">114</td><td class="line">  <span class='macro'>setframe_pc(base, pc)<span class='macro_popup'>((((base)-&gt;fr.tp.pcr).ptr32 = (uint32_t)(uintptr_t)(void *<br>)((pc))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="115"><td class="num" id="LN115">115</td><td class="line">  <span class='macro'>setnilV(base-1-LJ_FR2)<span class='macro_popup'>((base-1-0)-&gt;it = (~0u))</span></span>;  <span class='comment'>/* Incorrect, but rec_check_slots() won't run anymore. */</span></td></tr>
<tr class="codeline" data-linenumber="116"><td class="num" id="LN116">116</td><td class="line">  L-&gt;base += 2 + <span class='macro'>LJ_FR2<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="117"><td class="num" id="LN117">117</td><td class="line">  L-&gt;top += 2 + <span class='macro'>LJ_FR2<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="118"><td class="num" id="LN118">118</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="119"><td class="num" id="LN119">119</td><td class="line">  <span class='comment'>/* Ditto for the IR. */</span></td></tr>
<tr class="codeline" data-linenumber="120"><td class="num" id="LN120">120</td><td class="line">  <span class="mrange">memmove</span>(&amp;J-&gt;base[1], &amp;J-&gt;base[-1-<span class='macro'>LJ_FR2<span class='macro_popup'>0</span></span>], <span class='keyword'>sizeof</span>(TRef)*nslot);</td></tr>
<tr><td class="num"></td><td class="line"><div id="EndPath" class="msg msgEvent" style="margin-left:3ex; max-width:59em">Call to function 'memmove' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memmove_s' in case of C11</div></td></tr>
<tr class="codeline" data-linenumber="121"><td class="num" id="LN121">121</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_FR2<span class='macro_popup'>0</span></span></span></td></tr>
<tr class="codeline" data-linenumber="122"><td class="num" id="LN122">122</td><td class="line">  J-&gt;base[2] = <span class='macro'>TREF_FRAME<span class='macro_popup'>0x00010000</span></span>;</td></tr>
<tr class="codeline" data-linenumber="123"><td class="num" id="LN123">123</td><td class="line">  J-&gt;base[-1] = lj_ir_k64(J, IR_KNUM, <span class='macro'>u64ptr(contptr(cont))<span class='macro_popup'>((uint64_t)(intptr_t)(void *)(((void *)(uintptr_t)(uint32_t)(<br>(intptr_t)(cont) - (intptr_t)lj_vm_asm_begin))))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="124"><td class="num" id="LN124">124</td><td class="line">  J-&gt;base[0] = lj_ir_k64(J, IR_KNUM, <span class='macro'>u64ptr(pc)<span class='macro_popup'>((uint64_t)(intptr_t)(void *)(pc))</span></span>) | <span class='macro'>TREF_CONT<span class='macro_popup'>0x00020000</span></span>;</td></tr>
<tr class="codeline" data-linenumber="125"><td class="num" id="LN125">125</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="126"><td class="num" id="LN126">126</td><td class="line">  J-&gt;base[0] = <span class='macro'>lj_ir_kptr(J, contptr(cont))<span class='macro_popup'>lj_ir_kptr_(J, IR_KPTR, (((void *)(uintptr_t)(uint32_t)((intptr_t<br>)(cont) - (intptr_t)lj_vm_asm_begin))))</span></span> | <span class='macro'>TREF_CONT<span class='macro_popup'>0x00020000</span></span>;</td></tr>
<tr class="codeline" data-linenumber="127"><td class="num" id="LN127">127</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="128"><td class="num" id="LN128">128</td><td class="line">  J-&gt;ktrace = <span class='macro'>tref_ref((J-&gt;base[-1-LJ_FR2] = lj_ir_ktrace(J)))<span class='macro_popup'>((IRRef1)((J-&gt;base[-1-0] = lj_ir_ktrace(J))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="129"><td class="num" id="LN129">129</td><td class="line">  J-&gt;base += 2 + <span class='macro'>LJ_FR2<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="130"><td class="num" id="LN130">130</td><td class="line">  J-&gt;baseslot += 2 + <span class='macro'>LJ_FR2<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="131"><td class="num" id="LN131">131</td><td class="line">  J-&gt;framedepth++;</td></tr>
<tr class="codeline" data-linenumber="132"><td class="num" id="LN132">132</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="133"><td class="num" id="LN133">133</td><td class="line">  lj_record_stop(J, LJ_TRLINK_STITCH, 0);</td></tr>
<tr class="codeline" data-linenumber="134"><td class="num" id="LN134">134</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="135"><td class="num" id="LN135">135</td><td class="line">  <span class='comment'>/* Undo Lua stack changes. */</span></td></tr>
<tr class="codeline" data-linenumber="136"><td class="num" id="LN136">136</td><td class="line">  memmove(&amp;base[-1-<span class='macro'>LJ_FR2<span class='macro_popup'>0</span></span>], &amp;base[1], <span class='keyword'>sizeof</span>(TValue)*nslot);</td></tr>
<tr class="codeline" data-linenumber="137"><td class="num" id="LN137">137</td><td class="line">  <span class='macro'>setframe_pc(base-1, pc)<span class='macro_popup'>((((base-1)-&gt;fr.tp.pcr).ptr32 = (uint32_t)(uintptr_t)(void<br> *)((pc))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="138"><td class="num" id="LN138">138</td><td class="line">  L-&gt;base -= 2 + <span class='macro'>LJ_FR2<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="139"><td class="num" id="LN139">139</td><td class="line">  L-&gt;top -= 2 + <span class='macro'>LJ_FR2<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="140"><td class="num" id="LN140">140</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="141"><td class="num" id="LN141">141</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="142"><td class="num" id="LN142">142</td><td class="line"><span class='comment'>/* Fallback handler for fast functions that are not recorded (yet). */</span></td></tr>
<tr class="codeline" data-linenumber="143"><td class="num" id="LN143">143</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_nyi(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="144"><td class="num" id="LN144">144</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="145"><td class="num" id="LN145">145</td><td class="line">  <span class='keyword'>if</span> (J-&gt;cur.nins &lt; (IRRef)J-&gt;param[JIT_P_minstitch] + REF_BASE) {</td></tr>
<tr class="codeline" data-linenumber="146"><td class="num" id="LN146">146</td><td class="line">    lj_trace_err_info(J, LJ_TRERR_TRACEUV);</td></tr>
<tr class="codeline" data-linenumber="147"><td class="num" id="LN147">147</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="148"><td class="num" id="LN148">148</td><td class="line">    <span class='comment'>/* Can only stitch from Lua call. */</span></td></tr>
<tr class="codeline" data-linenumber="149"><td class="num" id="LN149">149</td><td class="line">    <span class='keyword'>if</span> (J-&gt;framedepth &amp;&amp; <span class='macro'>frame_islua(J-&gt;L-&gt;base-1)<span class='macro_popup'>((((ptrdiff_t)(J-&gt;L-&gt;base-1)-&gt;fr.tp.ftsz) &amp; 3) ==<br> FRAME_LUA)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="150"><td class="num" id="LN150">150</td><td class="line">      BCOp op = <span class='macro'>bc_op(*frame_pc(J-&gt;L-&gt;base-1))<span class='macro_popup'>((BCOp)((*(((const BCIns *)(void *)(uintptr_t)((J-&gt;L-&gt;base<br>-1)-&gt;fr.tp.pcr).ptr32)))&amp;0xff))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="151"><td class="num" id="LN151">151</td><td class="line">      <span class='comment'>/* Stitched trace cannot start with *M op with variable # of args. */</span></td></tr>
<tr class="codeline" data-linenumber="152"><td class="num" id="LN152">152</td><td class="line">      <span class='keyword'>if</span> (!(op == BC_CALLM || op == BC_CALLMT ||</td></tr>
<tr class="codeline" data-linenumber="153"><td class="num" id="LN153">153</td><td class="line">	    op == BC_RETM || op == BC_TSETM)) {</td></tr>
<tr class="codeline" data-linenumber="154"><td class="num" id="LN154">154</td><td class="line">	<span class='keyword'>switch</span> (J-&gt;fn-&gt;c.ffid) {</td></tr>
<tr class="codeline" data-linenumber="155"><td class="num" id="LN155">155</td><td class="line">	<span class='keyword'>case</span> FF_error:</td></tr>
<tr class="codeline" data-linenumber="156"><td class="num" id="LN156">156</td><td class="line">	<span class='keyword'>case</span> FF_debug_sethook:</td></tr>
<tr class="codeline" data-linenumber="157"><td class="num" id="LN157">157</td><td class="line">	<span class='keyword'>case</span> FF_jit_flush:</td></tr>
<tr class="codeline" data-linenumber="158"><td class="num" id="LN158">158</td><td class="line">	  <span class='keyword'>break</span>;  <span class='comment'>/* Don't stitch across special builtins. */</span></td></tr>
<tr class="codeline" data-linenumber="159"><td class="num" id="LN159">159</td><td class="line">	<span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="160"><td class="num" id="LN160">160</td><td class="line">	  recff_stitch(J);  <span class='comment'>/* Use trace stitching. */</span></td></tr>
<tr class="codeline" data-linenumber="161"><td class="num" id="LN161">161</td><td class="line">	  rd-&gt;nres = -1;</td></tr>
<tr class="codeline" data-linenumber="162"><td class="num" id="LN162">162</td><td class="line">	  <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="163"><td class="num" id="LN163">163</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="164"><td class="num" id="LN164">164</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="165"><td class="num" id="LN165">165</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="166"><td class="num" id="LN166">166</td><td class="line">    <span class='comment'>/* Otherwise stop trace and return to interpreter. */</span></td></tr>
<tr class="codeline" data-linenumber="167"><td class="num" id="LN167">167</td><td class="line">    lj_record_stop(J, LJ_TRLINK_RETURN, 0);</td></tr>
<tr class="codeline" data-linenumber="168"><td class="num" id="LN168">168</td><td class="line">    rd-&gt;nres = -1;</td></tr>
<tr class="codeline" data-linenumber="169"><td class="num" id="LN169">169</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="170"><td class="num" id="LN170">170</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="171"><td class="num" id="LN171">171</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="172"><td class="num" id="LN172">172</td><td class="line"><span class='comment'>/* Fallback handler for unsupported variants of fast functions. */</span></td></tr>
<tr class="codeline" data-linenumber="173"><td class="num" id="LN173">173</td><td class="line"><span class='directive'>#define <span class='macro'>recff_nyiu<span class='macro_popup'>recff_nyi</span></span>	recff_nyi</span></td></tr>
<tr class="codeline" data-linenumber="174"><td class="num" id="LN174">174</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="175"><td class="num" id="LN175">175</td><td class="line"><span class='comment'>/* Must stop the trace for classic C functions with arbitrary side-effects. */</span></td></tr>
<tr class="codeline" data-linenumber="176"><td class="num" id="LN176">176</td><td class="line"><span class='directive'>#define <span class='macro'>recff_c<span class='macro_popup'>recff_nyi</span></span>		recff_nyi</span></td></tr>
<tr class="codeline" data-linenumber="177"><td class="num" id="LN177">177</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="178"><td class="num" id="LN178">178</td><td class="line"><span class='comment'>/* Emit BUFHDR for the global temporary buffer. */</span></td></tr>
<tr class="codeline" data-linenumber="179"><td class="num" id="LN179">179</td><td class="line"><span class='keyword'>static</span> TRef recff_bufhdr(jit_State *J)</td></tr>
<tr class="codeline" data-linenumber="180"><td class="num" id="LN180">180</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="181"><td class="num" id="LN181">181</td><td class="line">  <span class='keyword'>return</span> emitir(<span class='macro'>IRT(IR_BUFHDR, IRT_PGC)<span class='macro_popup'>((uint32_t)(((IR_BUFHDR)&lt;&lt;8) | (IRT_PGC)))</span></span>,</td></tr>
<tr class="codeline" data-linenumber="182"><td class="num" id="LN182">182</td><td class="line">		<span class='macro'>lj_ir_kptr(J, &amp;J2G(J)-&gt;tmpbuf)<span class='macro_popup'>lj_ir_kptr_(J, IR_KPTR, (&amp;(&amp;((GG_State *)((char *)(J)<br> - ((int)__builtin_offsetof(GG_State, J))))-&gt;g)-&gt;tmpbuf<br>))</span></span>, <span class='macro'>IRBUFHDR_RESET<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="183"><td class="num" id="LN183">183</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="184"><td class="num" id="LN184">184</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="185"><td class="num" id="LN185">185</td><td class="line"><span class='comment'>/* -- Base library fast functions ----------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="186"><td class="num" id="LN186">186</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="187"><td class="num" id="LN187">187</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_assert(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="188"><td class="num" id="LN188">188</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="189"><td class="num" id="LN189">189</td><td class="line">  <span class='comment'>/* Arguments already specialized. The interpreter throws for nil/false. */</span></td></tr>
<tr class="codeline" data-linenumber="190"><td class="num" id="LN190">190</td><td class="line">  rd-&gt;nres = J-&gt;maxslot;  <span class='comment'>/* Pass through all arguments. */</span></td></tr>
<tr class="codeline" data-linenumber="191"><td class="num" id="LN191">191</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="192"><td class="num" id="LN192">192</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="193"><td class="num" id="LN193">193</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_type(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="194"><td class="num" id="LN194">194</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="195"><td class="num" id="LN195">195</td><td class="line">  <span class='comment'>/* Arguments already specialized. Result is a constant string. Neat, huh? */</span></td></tr>
<tr class="codeline" data-linenumber="196"><td class="num" id="LN196">196</td><td class="line">  uint32_t t;</td></tr>
<tr class="codeline" data-linenumber="197"><td class="num" id="LN197">197</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>tvisnumber(&amp;rd-&gt;argv[0])<span class='macro_popup'>(((&amp;rd-&gt;argv[0])-&gt;it) &lt;= 0xfffeffffu)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="198"><td class="num" id="LN198">198</td><td class="line">    t = ~<span class='macro'>LJ_TNUMX<span class='macro_popup'>(~13u)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="199"><td class="num" id="LN199">199</td><td class="line">  <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>LJ_64<span class='macro_popup'>1</span></span> &amp;&amp; !<span class='macro'>LJ_GC64<span class='macro_popup'>0</span></span> &amp;&amp; <span class='macro'>tvislightud(&amp;rd-&gt;argv[0])<span class='macro_popup'>(((int32_t)((&amp;rd-&gt;argv[0])-&gt;it) &gt;&gt; 15) == -2)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="200"><td class="num" id="LN200">200</td><td class="line">    t = ~<span class='macro'>LJ_TLIGHTUD<span class='macro_popup'>(~3u)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="201"><td class="num" id="LN201">201</td><td class="line">  <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="202"><td class="num" id="LN202">202</td><td class="line">    t = ~<span class='macro'>itype(&amp;rd-&gt;argv[0])<span class='macro_popup'>((&amp;rd-&gt;argv[0])-&gt;it)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="203"><td class="num" id="LN203">203</td><td class="line">  J-&gt;base[0] = <span class='macro'>lj_ir_kstr(J, strV(&amp;J-&gt;fn-&gt;c.upvalue[t]))<span class='macro_popup'>lj_ir_kgc(J, ((GCobj *)(((&amp;(((GCobj *)(uintptr_t)((&amp;J<br>-&gt;fn-&gt;c.upvalue[t])-&gt;gcr).gcptr32))-&gt;str)))), IRT_STR<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="204"><td class="num" id="LN204">204</td><td class="line">  <span class='macro'>UNUSED(rd)<span class='macro_popup'>((void)(rd))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="205"><td class="num" id="LN205">205</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="206"><td class="num" id="LN206">206</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="207"><td class="num" id="LN207">207</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_getmetatable(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="208"><td class="num" id="LN208">208</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="209"><td class="num" id="LN209">209</td><td class="line">  TRef tr = J-&gt;base[0];</td></tr>
<tr class="codeline" data-linenumber="210"><td class="num" id="LN210">210</td><td class="line">  <span class='keyword'>if</span> (tr) {</td></tr>
<tr class="codeline" data-linenumber="211"><td class="num" id="LN211">211</td><td class="line">    RecordIndex ix;</td></tr>
<tr class="codeline" data-linenumber="212"><td class="num" id="LN212">212</td><td class="line">    ix.tab = tr;</td></tr>
<tr class="codeline" data-linenumber="213"><td class="num" id="LN213">213</td><td class="line">    copyTV(J-&gt;L, &amp;ix.tabv, &amp;rd-&gt;argv[0]);</td></tr>
<tr class="codeline" data-linenumber="214"><td class="num" id="LN214">214</td><td class="line">    <span class='keyword'>if</span> (lj_record_mm_lookup(J, &amp;ix, MM_metatable))</td></tr>
<tr class="codeline" data-linenumber="215"><td class="num" id="LN215">215</td><td class="line">      J-&gt;base[0] = ix.mobj;</td></tr>
<tr class="codeline" data-linenumber="216"><td class="num" id="LN216">216</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="217"><td class="num" id="LN217">217</td><td class="line">      J-&gt;base[0] = ix.mt;</td></tr>
<tr class="codeline" data-linenumber="218"><td class="num" id="LN218">218</td><td class="line">  }  <span class='comment'>/* else: Interpreter will throw. */</span></td></tr>
<tr class="codeline" data-linenumber="219"><td class="num" id="LN219">219</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="220"><td class="num" id="LN220">220</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="221"><td class="num" id="LN221">221</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_setmetatable(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="222"><td class="num" id="LN222">222</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="223"><td class="num" id="LN223">223</td><td class="line">  TRef tr = J-&gt;base[0];</td></tr>
<tr class="codeline" data-linenumber="224"><td class="num" id="LN224">224</td><td class="line">  TRef mt = J-&gt;base[1];</td></tr>
<tr class="codeline" data-linenumber="225"><td class="num" id="LN225">225</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>tref_istab(tr)<span class='macro_popup'>(((((tr)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_TAB)&lt;&lt;24<br>)))</span></span> &amp;&amp; (<span class='macro'>tref_istab(mt)<span class='macro_popup'>(((((mt)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_TAB)&lt;&lt;24<br>)))</span></span> || (mt &amp;&amp; <span class='macro'>tref_isnil(mt)<span class='macro_popup'>(((((mt)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_NIL)&lt;&lt;24<br>)))</span></span>))) {</td></tr>
<tr class="codeline" data-linenumber="226"><td class="num" id="LN226">226</td><td class="line">    TRef fref, mtref;</td></tr>
<tr class="codeline" data-linenumber="227"><td class="num" id="LN227">227</td><td class="line">    RecordIndex ix;</td></tr>
<tr class="codeline" data-linenumber="228"><td class="num" id="LN228">228</td><td class="line">    ix.tab = tr;</td></tr>
<tr class="codeline" data-linenumber="229"><td class="num" id="LN229">229</td><td class="line">    copyTV(J-&gt;L, &amp;ix.tabv, &amp;rd-&gt;argv[0]);</td></tr>
<tr class="codeline" data-linenumber="230"><td class="num" id="LN230">230</td><td class="line">    lj_record_mm_lookup(J, &amp;ix, MM_metatable); <span class='comment'>/* Guard for no __metatable. */</span></td></tr>
<tr class="codeline" data-linenumber="231"><td class="num" id="LN231">231</td><td class="line">    fref = emitir(<span class='macro'>IRT(IR_FREF, IRT_PGC)<span class='macro_popup'>((uint32_t)(((IR_FREF)&lt;&lt;8) | (IRT_PGC)))</span></span>, tr, IRFL_TAB_META);</td></tr>
<tr class="codeline" data-linenumber="232"><td class="num" id="LN232">232</td><td class="line">    mtref = <span class='macro'>tref_isnil(mt)<span class='macro_popup'>(((((mt)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_NIL)&lt;&lt;24<br>)))</span></span> ? lj_ir_knull(J, IRT_TAB) : mt;</td></tr>
<tr class="codeline" data-linenumber="233"><td class="num" id="LN233">233</td><td class="line">    emitir(<span class='macro'>IRT(IR_FSTORE, IRT_TAB)<span class='macro_popup'>((uint32_t)(((IR_FSTORE)&lt;&lt;8) | (IRT_TAB)))</span></span>, fref, mtref);</td></tr>
<tr class="codeline" data-linenumber="234"><td class="num" id="LN234">234</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>tref_isnil(mt)<span class='macro_popup'>(((((mt)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_NIL)&lt;&lt;24<br>)))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="235"><td class="num" id="LN235">235</td><td class="line">      emitir(<span class='macro'>IRT(IR_TBAR, IRT_TAB)<span class='macro_popup'>((uint32_t)(((IR_TBAR)&lt;&lt;8) | (IRT_TAB)))</span></span>, tr, 0);</td></tr>
<tr class="codeline" data-linenumber="236"><td class="num" id="LN236">236</td><td class="line">    J-&gt;base[0] = tr;</td></tr>
<tr class="codeline" data-linenumber="237"><td class="num" id="LN237">237</td><td class="line">    J-&gt;needsnap = 1;</td></tr>
<tr class="codeline" data-linenumber="238"><td class="num" id="LN238">238</td><td class="line">  }  <span class='comment'>/* else: Interpreter will throw. */</span></td></tr>
<tr class="codeline" data-linenumber="239"><td class="num" id="LN239">239</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="240"><td class="num" id="LN240">240</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="241"><td class="num" id="LN241">241</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_rawget(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="242"><td class="num" id="LN242">242</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="243"><td class="num" id="LN243">243</td><td class="line">  RecordIndex ix;</td></tr>
<tr class="codeline" data-linenumber="244"><td class="num" id="LN244">244</td><td class="line">  ix.tab = J-&gt;base[0]; ix.key = J-&gt;base[1];</td></tr>
<tr class="codeline" data-linenumber="245"><td class="num" id="LN245">245</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>tref_istab(ix.tab)<span class='macro_popup'>(((((ix.tab)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_TAB)&lt;&lt;<br>24)))</span></span> &amp;&amp; ix.key) {</td></tr>
<tr class="codeline" data-linenumber="246"><td class="num" id="LN246">246</td><td class="line">    ix.val = 0; ix.idxchain = 0;</td></tr>
<tr class="codeline" data-linenumber="247"><td class="num" id="LN247">247</td><td class="line">    settabV(J-&gt;L, &amp;ix.tabv, <span class='macro'>tabV(&amp;rd-&gt;argv[0])<span class='macro_popup'>(&amp;(((GCobj *)(uintptr_t)((&amp;rd-&gt;argv[0])-&gt;gcr).gcptr32<br>))-&gt;tab)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="248"><td class="num" id="LN248">248</td><td class="line">    copyTV(J-&gt;L, &amp;ix.keyv, &amp;rd-&gt;argv[1]);</td></tr>
<tr class="codeline" data-linenumber="249"><td class="num" id="LN249">249</td><td class="line">    J-&gt;base[0] = lj_record_idx(J, &amp;ix);</td></tr>
<tr class="codeline" data-linenumber="250"><td class="num" id="LN250">250</td><td class="line">  }  <span class='comment'>/* else: Interpreter will throw. */</span></td></tr>
<tr class="codeline" data-linenumber="251"><td class="num" id="LN251">251</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="252"><td class="num" id="LN252">252</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="253"><td class="num" id="LN253">253</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_rawset(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="254"><td class="num" id="LN254">254</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="255"><td class="num" id="LN255">255</td><td class="line">  RecordIndex ix;</td></tr>
<tr class="codeline" data-linenumber="256"><td class="num" id="LN256">256</td><td class="line">  ix.tab = J-&gt;base[0]; ix.key = J-&gt;base[1]; ix.val = J-&gt;base[2];</td></tr>
<tr class="codeline" data-linenumber="257"><td class="num" id="LN257">257</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>tref_istab(ix.tab)<span class='macro_popup'>(((((ix.tab)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_TAB)&lt;&lt;<br>24)))</span></span> &amp;&amp; ix.key &amp;&amp; ix.val) {</td></tr>
<tr class="codeline" data-linenumber="258"><td class="num" id="LN258">258</td><td class="line">    ix.idxchain = 0;</td></tr>
<tr class="codeline" data-linenumber="259"><td class="num" id="LN259">259</td><td class="line">    settabV(J-&gt;L, &amp;ix.tabv, <span class='macro'>tabV(&amp;rd-&gt;argv[0])<span class='macro_popup'>(&amp;(((GCobj *)(uintptr_t)((&amp;rd-&gt;argv[0])-&gt;gcr).gcptr32<br>))-&gt;tab)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="260"><td class="num" id="LN260">260</td><td class="line">    copyTV(J-&gt;L, &amp;ix.keyv, &amp;rd-&gt;argv[1]);</td></tr>
<tr class="codeline" data-linenumber="261"><td class="num" id="LN261">261</td><td class="line">    copyTV(J-&gt;L, &amp;ix.valv, &amp;rd-&gt;argv[2]);</td></tr>
<tr class="codeline" data-linenumber="262"><td class="num" id="LN262">262</td><td class="line">    lj_record_idx(J, &amp;ix);</td></tr>
<tr class="codeline" data-linenumber="263"><td class="num" id="LN263">263</td><td class="line">    <span class='comment'>/* Pass through table at J-&gt;base[0] as result. */</span></td></tr>
<tr class="codeline" data-linenumber="264"><td class="num" id="LN264">264</td><td class="line">  }  <span class='comment'>/* else: Interpreter will throw. */</span></td></tr>
<tr class="codeline" data-linenumber="265"><td class="num" id="LN265">265</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="266"><td class="num" id="LN266">266</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="267"><td class="num" id="LN267">267</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_rawequal(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="268"><td class="num" id="LN268">268</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="269"><td class="num" id="LN269">269</td><td class="line">  TRef tra = J-&gt;base[0];</td></tr>
<tr class="codeline" data-linenumber="270"><td class="num" id="LN270">270</td><td class="line">  TRef trb = J-&gt;base[1];</td></tr>
<tr class="codeline" data-linenumber="271"><td class="num" id="LN271">271</td><td class="line">  <span class='keyword'>if</span> (tra &amp;&amp; trb) {</td></tr>
<tr class="codeline" data-linenumber="272"><td class="num" id="LN272">272</td><td class="line">    <span class='keyword'>int</span> diff = lj_record_objcmp(J, tra, trb, &amp;rd-&gt;argv[0], &amp;rd-&gt;argv[1]);</td></tr>
<tr class="codeline" data-linenumber="273"><td class="num" id="LN273">273</td><td class="line">    J-&gt;base[0] = diff ? <span class='macro'>TREF_FALSE<span class='macro_popup'>((((TRef)((REF_NIL-(IRT_FALSE)) + (((IRT_FALSE))&lt;&lt;24)))<br>))</span></span> : <span class='macro'>TREF_TRUE<span class='macro_popup'>((((TRef)((REF_NIL-(IRT_TRUE)) + (((IRT_TRUE))&lt;&lt;24)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="274"><td class="num" id="LN274">274</td><td class="line">  }  <span class='comment'>/* else: Interpreter will throw. */</span></td></tr>
<tr class="codeline" data-linenumber="275"><td class="num" id="LN275">275</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="276"><td class="num" id="LN276">276</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="277"><td class="num" id="LN277">277</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_52<span class='macro_popup'>0</span></span></span></td></tr>
<tr class="codeline" data-linenumber="278"><td class="num" id="LN278">278</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_rawlen(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="279"><td class="num" id="LN279">279</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="280"><td class="num" id="LN280">280</td><td class="line">  TRef tr = J-&gt;base[0];</td></tr>
<tr class="codeline" data-linenumber="281"><td class="num" id="LN281">281</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>tref_isstr(tr)<span class='macro_popup'>(((((tr)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_STR)&lt;&lt;24<br>)))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="282"><td class="num" id="LN282">282</td><td class="line">    J-&gt;base[0] = emitir(<span class='macro'>IRTI(IR_FLOAD)<span class='macro_popup'>(((uint32_t)((((IR_FLOAD))&lt;&lt;8) | (IRT_INT))))</span></span>, tr, IRFL_STR_LEN);</td></tr>
<tr class="codeline" data-linenumber="283"><td class="num" id="LN283">283</td><td class="line">  <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>tref_istab(tr)<span class='macro_popup'>(((((tr)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_TAB)&lt;&lt;24<br>)))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="284"><td class="num" id="LN284">284</td><td class="line">    J-&gt;base[0] = lj_ir_call(J, IRCALL_lj_tab_len, tr);</td></tr>
<tr class="codeline" data-linenumber="285"><td class="num" id="LN285">285</td><td class="line">  <span class='comment'>/* else: Interpreter will throw. */</span></td></tr>
<tr class="codeline" data-linenumber="286"><td class="num" id="LN286">286</td><td class="line">  <span class='macro'>UNUSED(rd)<span class='macro_popup'>((void)(rd))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="287"><td class="num" id="LN287">287</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="288"><td class="num" id="LN288">288</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="289"><td class="num" id="LN289">289</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="290"><td class="num" id="LN290">290</td><td class="line"><span class='comment'>/* Determine mode of select() call. */</span></td></tr>
<tr class="codeline" data-linenumber="291"><td class="num" id="LN291">291</td><td class="line">int32_t lj_ffrecord_select_mode(jit_State *J, TRef tr, TValue *tv)</td></tr>
<tr class="codeline" data-linenumber="292"><td class="num" id="LN292">292</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="293"><td class="num" id="LN293">293</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>tref_isstr(tr)<span class='macro_popup'>(((((tr)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_STR)&lt;&lt;24<br>)))</span></span> &amp;&amp; *<span class='macro'>strVdata(tv)<span class='macro_popup'>((const char *)(((&amp;(((GCobj *)(uintptr_t)((tv)-&gt;gcr).gcptr32<br>))-&gt;str))+1))</span></span> == '#') {  <span class='comment'>/* select('#', ...) */</span></td></tr>
<tr class="codeline" data-linenumber="294"><td class="num" id="LN294">294</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>strV(tv)<span class='macro_popup'>(&amp;(((GCobj *)(uintptr_t)((tv)-&gt;gcr).gcptr32))-&gt;str)</span></span>-&gt;len == 1) {</td></tr>
<tr class="codeline" data-linenumber="295"><td class="num" id="LN295">295</td><td class="line">      emitir(<span class='macro'>IRTG(IR_EQ, IRT_STR)<span class='macro_popup'>(((uint32_t)((((IR_EQ))&lt;&lt;8) | (IRT_GUARD|(IRT_STR)))))</span></span>, tr, <span class='macro'>lj_ir_kstr(J, strV(tv))<span class='macro_popup'>lj_ir_kgc(J, ((GCobj *)(((&amp;(((GCobj *)(uintptr_t)((tv)-&gt;<br>gcr).gcptr32))-&gt;str)))), IRT_STR)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="296"><td class="num" id="LN296">296</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="297"><td class="num" id="LN297">297</td><td class="line">      TRef trptr = emitir(<span class='macro'>IRT(IR_STRREF, IRT_PGC)<span class='macro_popup'>((uint32_t)(((IR_STRREF)&lt;&lt;8) | (IRT_PGC)))</span></span>, tr, lj_ir_kint(J, 0));</td></tr>
<tr class="codeline" data-linenumber="298"><td class="num" id="LN298">298</td><td class="line">      TRef trchar = emitir(<span class='macro'>IRT(IR_XLOAD, IRT_U8)<span class='macro_popup'>((uint32_t)(((IR_XLOAD)&lt;&lt;8) | (IRT_U8)))</span></span>, trptr, <span class='macro'>IRXLOAD_READONLY<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="299"><td class="num" id="LN299">299</td><td class="line">      emitir(<span class='macro'>IRTG(IR_EQ, IRT_INT)<span class='macro_popup'>(((uint32_t)((((IR_EQ))&lt;&lt;8) | (IRT_GUARD|(IRT_INT)))))</span></span>, trchar, lj_ir_kint(J, '#'));</td></tr>
<tr class="codeline" data-linenumber="300"><td class="num" id="LN300">300</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="301"><td class="num" id="LN301">301</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="302"><td class="num" id="LN302">302</td><td class="line">  } <span class='keyword'>else</span> {  <span class='comment'>/* select(n, ...) */</span></td></tr>
<tr class="codeline" data-linenumber="303"><td class="num" id="LN303">303</td><td class="line">    int32_t start = argv2int(J, tv);</td></tr>
<tr class="codeline" data-linenumber="304"><td class="num" id="LN304">304</td><td class="line">    <span class='keyword'>if</span> (start == 0) lj_trace_err(J, LJ_TRERR_BADTYPE);  <span class='comment'>/* A bit misleading. */</span></td></tr>
<tr class="codeline" data-linenumber="305"><td class="num" id="LN305">305</td><td class="line">    <span class='keyword'>return</span> start;</td></tr>
<tr class="codeline" data-linenumber="306"><td class="num" id="LN306">306</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="307"><td class="num" id="LN307">307</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="308"><td class="num" id="LN308">308</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="309"><td class="num" id="LN309">309</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_select(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="310"><td class="num" id="LN310">310</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="311"><td class="num" id="LN311">311</td><td class="line">  TRef tr = J-&gt;base[0];</td></tr>
<tr class="codeline" data-linenumber="312"><td class="num" id="LN312">312</td><td class="line">  <span class='keyword'>if</span> (tr) {</td></tr>
<tr class="codeline" data-linenumber="313"><td class="num" id="LN313">313</td><td class="line">    ptrdiff_t start = lj_ffrecord_select_mode(J, tr, &amp;rd-&gt;argv[0]);</td></tr>
<tr class="codeline" data-linenumber="314"><td class="num" id="LN314">314</td><td class="line">    <span class='keyword'>if</span> (start == 0) {  <span class='comment'>/* select('#', ...) */</span></td></tr>
<tr class="codeline" data-linenumber="315"><td class="num" id="LN315">315</td><td class="line">      J-&gt;base[0] = lj_ir_kint(J, J-&gt;maxslot - 1);</td></tr>
<tr class="codeline" data-linenumber="316"><td class="num" id="LN316">316</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>tref_isk(tr)<span class='macro_popup'>(((((IRRef1)((tr)))) &lt; REF_BIAS))</span></span>) {  <span class='comment'>/* select(k, ...) */</span></td></tr>
<tr class="codeline" data-linenumber="317"><td class="num" id="LN317">317</td><td class="line">      ptrdiff_t n = (ptrdiff_t)J-&gt;maxslot;</td></tr>
<tr class="codeline" data-linenumber="318"><td class="num" id="LN318">318</td><td class="line">      <span class='keyword'>if</span> (start &lt; 0) start += n;</td></tr>
<tr class="codeline" data-linenumber="319"><td class="num" id="LN319">319</td><td class="line">      <span class='keyword'>else</span> <span class='keyword'>if</span> (start &gt; n) start = n;</td></tr>
<tr class="codeline" data-linenumber="320"><td class="num" id="LN320">320</td><td class="line">      rd-&gt;nres = n - start;</td></tr>
<tr class="codeline" data-linenumber="321"><td class="num" id="LN321">321</td><td class="line">      <span class='keyword'>if</span> (start &gt;= 1) {</td></tr>
<tr class="codeline" data-linenumber="322"><td class="num" id="LN322">322</td><td class="line">	ptrdiff_t i;</td></tr>
<tr class="codeline" data-linenumber="323"><td class="num" id="LN323">323</td><td class="line">	<span class='keyword'>for</span> (i = 0; i &lt; n - start; i++)</td></tr>
<tr class="codeline" data-linenumber="324"><td class="num" id="LN324">324</td><td class="line">	  J-&gt;base[i] = J-&gt;base[start+i];</td></tr>
<tr class="codeline" data-linenumber="325"><td class="num" id="LN325">325</td><td class="line">      }  <span class='comment'>/* else: Interpreter will throw. */</span></td></tr>
<tr class="codeline" data-linenumber="326"><td class="num" id="LN326">326</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="327"><td class="num" id="LN327">327</td><td class="line">      <span class='macro'>recff_nyiu<span class='macro_popup'>recff_nyi</span></span>(J, rd);</td></tr>
<tr class="codeline" data-linenumber="328"><td class="num" id="LN328">328</td><td class="line">      <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="329"><td class="num" id="LN329">329</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="330"><td class="num" id="LN330">330</td><td class="line">  }  <span class='comment'>/* else: Interpreter will throw. */</span></td></tr>
<tr class="codeline" data-linenumber="331"><td class="num" id="LN331">331</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="332"><td class="num" id="LN332">332</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="333"><td class="num" id="LN333">333</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_tonumber(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="334"><td class="num" id="LN334">334</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="335"><td class="num" id="LN335">335</td><td class="line">  TRef tr = J-&gt;base[0];</td></tr>
<tr class="codeline" data-linenumber="336"><td class="num" id="LN336">336</td><td class="line">  TRef base = J-&gt;base[1];</td></tr>
<tr class="codeline" data-linenumber="337"><td class="num" id="LN337">337</td><td class="line">  <span class='keyword'>if</span> (tr &amp;&amp; !<span class='macro'>tref_isnil(base)<span class='macro_popup'>(((((base)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_NIL)&lt;&lt;<br>24)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="338"><td class="num" id="LN338">338</td><td class="line">    base = lj_opt_narrow_toint(J, base);</td></tr>
<tr class="codeline" data-linenumber="339"><td class="num" id="LN339">339</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>tref_isk(base)<span class='macro_popup'>(((((IRRef1)((base)))) &lt; REF_BIAS))</span></span> || IR(<span class='macro'>tref_ref(base)<span class='macro_popup'>((IRRef1)(base))</span></span>)-&gt;i != 10) {</td></tr>
<tr class="codeline" data-linenumber="340"><td class="num" id="LN340">340</td><td class="line">      <span class='macro'>recff_nyiu<span class='macro_popup'>recff_nyi</span></span>(J, rd);</td></tr>
<tr class="codeline" data-linenumber="341"><td class="num" id="LN341">341</td><td class="line">      <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="342"><td class="num" id="LN342">342</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="343"><td class="num" id="LN343">343</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="344"><td class="num" id="LN344">344</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>tref_isnumber_str(tr)<span class='macro_popup'>((((((((tr)))&gt;&gt;24) &amp; IRT_TYPE) - (TRef)(IRT_NUM) &lt;=<br> (TRef)(IRT_INT-IRT_NUM))) || ((((((tr))) &amp; (IRT_TYPE&lt;&lt;<br>24)) == ((IRT_STR)&lt;&lt;24))))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="345"><td class="num" id="LN345">345</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>tref_isstr(tr)<span class='macro_popup'>(((((tr)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_STR)&lt;&lt;24<br>)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="346"><td class="num" id="LN346">346</td><td class="line">      TValue tmp;</td></tr>
<tr class="codeline" data-linenumber="347"><td class="num" id="LN347">347</td><td class="line">      <span class='keyword'>if</span> (!lj_strscan_num(<span class='macro'>strV(&amp;rd-&gt;argv[0])<span class='macro_popup'>(&amp;(((GCobj *)(uintptr_t)((&amp;rd-&gt;argv[0])-&gt;gcr).gcptr32<br>))-&gt;str)</span></span>, &amp;tmp)) {</td></tr>
<tr class="codeline" data-linenumber="348"><td class="num" id="LN348">348</td><td class="line">	<span class='macro'>recff_nyiu<span class='macro_popup'>recff_nyi</span></span>(J, rd);  <span class='comment'>/* Would need an inverted STRTO for this case. */</span></td></tr>
<tr class="codeline" data-linenumber="349"><td class="num" id="LN349">349</td><td class="line">	<span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="350"><td class="num" id="LN350">350</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="351"><td class="num" id="LN351">351</td><td class="line">      tr = emitir(<span class='macro'>IRTG(IR_STRTO, IRT_NUM)<span class='macro_popup'>(((uint32_t)((((IR_STRTO))&lt;&lt;8) | (IRT_GUARD|(IRT_NUM)))<br>))</span></span>, tr, 0);</td></tr>
<tr class="codeline" data-linenumber="352"><td class="num" id="LN352">352</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="353"><td class="num" id="LN353">353</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_HASFFI<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="354"><td class="num" id="LN354">354</td><td class="line">  } <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>tref_iscdata(tr)<span class='macro_popup'>(((((tr)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_CDATA)&lt;&lt;<br>24)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="355"><td class="num" id="LN355">355</td><td class="line">    lj_crecord_tonumber(J, rd);</td></tr>
<tr class="codeline" data-linenumber="356"><td class="num" id="LN356">356</td><td class="line">    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="357"><td class="num" id="LN357">357</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="358"><td class="num" id="LN358">358</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="359"><td class="num" id="LN359">359</td><td class="line">    tr = <span class='macro'>TREF_NIL<span class='macro_popup'>((((TRef)((REF_NIL-(IRT_NIL)) + (((IRT_NIL))&lt;&lt;24)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="360"><td class="num" id="LN360">360</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="361"><td class="num" id="LN361">361</td><td class="line">  J-&gt;base[0] = tr;</td></tr>
<tr class="codeline" data-linenumber="362"><td class="num" id="LN362">362</td><td class="line">  <span class='macro'>UNUSED(rd)<span class='macro_popup'>((void)(rd))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="363"><td class="num" id="LN363">363</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="364"><td class="num" id="LN364">364</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="365"><td class="num" id="LN365">365</td><td class="line"><span class='keyword'>static</span> TValue *recff_metacall_cp(lua_State *L, lua_CFunction dummy, <span class='keyword'>void</span> *ud)</td></tr>
<tr class="codeline" data-linenumber="366"><td class="num" id="LN366">366</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="367"><td class="num" id="LN367">367</td><td class="line">  jit_State *J = (jit_State *)ud;</td></tr>
<tr class="codeline" data-linenumber="368"><td class="num" id="LN368">368</td><td class="line">  lj_record_tailcall(J, 0, 1);</td></tr>
<tr class="codeline" data-linenumber="369"><td class="num" id="LN369">369</td><td class="line">  <span class='macro'>UNUSED(L)<span class='macro_popup'>((void)(L))</span></span>; <span class='macro'>UNUSED(dummy)<span class='macro_popup'>((void)(dummy))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="370"><td class="num" id="LN370">370</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="371"><td class="num" id="LN371">371</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="372"><td class="num" id="LN372">372</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="373"><td class="num" id="LN373">373</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> recff_metacall(jit_State *J, RecordFFData *rd, MMS mm)</td></tr>
<tr class="codeline" data-linenumber="374"><td class="num" id="LN374">374</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="375"><td class="num" id="LN375">375</td><td class="line">  RecordIndex ix;</td></tr>
<tr class="codeline" data-linenumber="376"><td class="num" id="LN376">376</td><td class="line">  ix.tab = J-&gt;base[0];</td></tr>
<tr class="codeline" data-linenumber="377"><td class="num" id="LN377">377</td><td class="line">  copyTV(J-&gt;L, &amp;ix.tabv, &amp;rd-&gt;argv[0]);</td></tr>
<tr class="codeline" data-linenumber="378"><td class="num" id="LN378">378</td><td class="line">  <span class='keyword'>if</span> (lj_record_mm_lookup(J, &amp;ix, mm)) {  <span class='comment'>/* Has metamethod? */</span></td></tr>
<tr class="codeline" data-linenumber="379"><td class="num" id="LN379">379</td><td class="line">    <span class='keyword'>int</span> errcode;</td></tr>
<tr class="codeline" data-linenumber="380"><td class="num" id="LN380">380</td><td class="line">    TValue argv0;</td></tr>
<tr class="codeline" data-linenumber="381"><td class="num" id="LN381">381</td><td class="line">    <span class='comment'>/* Temporarily insert metamethod below object. */</span></td></tr>
<tr class="codeline" data-linenumber="382"><td class="num" id="LN382">382</td><td class="line">    J-&gt;base[1+<span class='macro'>LJ_FR2<span class='macro_popup'>0</span></span>] = J-&gt;base[0];</td></tr>
<tr class="codeline" data-linenumber="383"><td class="num" id="LN383">383</td><td class="line">    J-&gt;base[0] = ix.mobj;</td></tr>
<tr class="codeline" data-linenumber="384"><td class="num" id="LN384">384</td><td class="line">    copyTV(J-&gt;L, &amp;argv0, &amp;rd-&gt;argv[0]);</td></tr>
<tr class="codeline" data-linenumber="385"><td class="num" id="LN385">385</td><td class="line">    copyTV(J-&gt;L, &amp;rd-&gt;argv[1+<span class='macro'>LJ_FR2<span class='macro_popup'>0</span></span>], &amp;rd-&gt;argv[0]);</td></tr>
<tr class="codeline" data-linenumber="386"><td class="num" id="LN386">386</td><td class="line">    copyTV(J-&gt;L, &amp;rd-&gt;argv[0], &amp;ix.mobjv);</td></tr>
<tr class="codeline" data-linenumber="387"><td class="num" id="LN387">387</td><td class="line">    <span class='comment'>/* Need to protect lj_record_tailcall because it may throw. */</span></td></tr>
<tr class="codeline" data-linenumber="388"><td class="num" id="LN388">388</td><td class="line">    errcode = lj_vm_cpcall(J-&gt;L, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, J, recff_metacall_cp);</td></tr>
<tr class="codeline" data-linenumber="389"><td class="num" id="LN389">389</td><td class="line">    <span class='comment'>/* Always undo Lua stack changes to avoid confusing the interpreter. */</span></td></tr>
<tr class="codeline" data-linenumber="390"><td class="num" id="LN390">390</td><td class="line">    copyTV(J-&gt;L, &amp;rd-&gt;argv[0], &amp;argv0);</td></tr>
<tr class="codeline" data-linenumber="391"><td class="num" id="LN391">391</td><td class="line">    <span class='keyword'>if</span> (errcode)</td></tr>
<tr class="codeline" data-linenumber="392"><td class="num" id="LN392">392</td><td class="line">      lj_err_throw(J-&gt;L, errcode);  <span class='comment'>/* Propagate errors. */</span></td></tr>
<tr class="codeline" data-linenumber="393"><td class="num" id="LN393">393</td><td class="line">    rd-&gt;nres = -1;  <span class='comment'>/* Pending call. */</span></td></tr>
<tr class="codeline" data-linenumber="394"><td class="num" id="LN394">394</td><td class="line">    <span class='keyword'>return</span> 1;  <span class='comment'>/* Tailcalled to metamethod. */</span></td></tr>
<tr class="codeline" data-linenumber="395"><td class="num" id="LN395">395</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="396"><td class="num" id="LN396">396</td><td class="line">  <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="397"><td class="num" id="LN397">397</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="398"><td class="num" id="LN398">398</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="399"><td class="num" id="LN399">399</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_tostring(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="400"><td class="num" id="LN400">400</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="401"><td class="num" id="LN401">401</td><td class="line">  TRef tr = J-&gt;base[0];</td></tr>
<tr class="codeline" data-linenumber="402"><td class="num" id="LN402">402</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>tref_isstr(tr)<span class='macro_popup'>(((((tr)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_STR)&lt;&lt;24<br>)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="403"><td class="num" id="LN403">403</td><td class="line">    <span class='comment'>/* Ignore __tostring in the string base metatable. */</span></td></tr>
<tr class="codeline" data-linenumber="404"><td class="num" id="LN404">404</td><td class="line">    <span class='comment'>/* Pass on result in J-&gt;base[0]. */</span></td></tr>
<tr class="codeline" data-linenumber="405"><td class="num" id="LN405">405</td><td class="line">  } <span class='keyword'>else</span> <span class='keyword'>if</span> (tr &amp;&amp; !recff_metacall(J, rd, MM_tostring)) {</td></tr>
<tr class="codeline" data-linenumber="406"><td class="num" id="LN406">406</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>tref_isnumber(tr)<span class='macro_popup'>((((((tr))&gt;&gt;24) &amp; IRT_TYPE) - (TRef)(IRT_NUM) &lt;=<br> (TRef)(IRT_INT-IRT_NUM)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="407"><td class="num" id="LN407">407</td><td class="line">      J-&gt;base[0] = emitir(<span class='macro'>IRT(IR_TOSTR, IRT_STR)<span class='macro_popup'>((uint32_t)(((IR_TOSTR)&lt;&lt;8) | (IRT_STR)))</span></span>, tr,</td></tr>
<tr class="codeline" data-linenumber="408"><td class="num" id="LN408">408</td><td class="line">			  <span class='macro'>tref_isnum(tr)<span class='macro_popup'>(((((tr)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_NUM)&lt;&lt;24<br>)))</span></span> ? <span class='macro'>IRTOSTR_NUM<span class='macro_popup'>1</span></span> : <span class='macro'>IRTOSTR_INT<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="409"><td class="num" id="LN409">409</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>tref_ispri(tr)<span class='macro_popup'>((((((tr))&gt;&gt;24) &amp; IRT_TYPE) - (TRef)(IRT_NIL) &lt;=<br> (TRef)(IRT_TRUE-IRT_NIL)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="410"><td class="num" id="LN410">410</td><td class="line">      J-&gt;base[0] = <span class='macro'>lj_ir_kstr(J, lj_strfmt_obj(J-&gt;L, &amp;rd-&gt;argv[0]))<span class='macro_popup'>lj_ir_kgc(J, ((GCobj *)((lj_strfmt_obj(J-&gt;L, &amp;rd-&gt;argv<br>[0])))), IRT_STR)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="411"><td class="num" id="LN411">411</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="412"><td class="num" id="LN412">412</td><td class="line">      <span class='macro'>recff_nyiu<span class='macro_popup'>recff_nyi</span></span>(J, rd);</td></tr>
<tr class="codeline" data-linenumber="413"><td class="num" id="LN413">413</td><td class="line">      <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="414"><td class="num" id="LN414">414</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="415"><td class="num" id="LN415">415</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="416"><td class="num" id="LN416">416</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="417"><td class="num" id="LN417">417</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="418"><td class="num" id="LN418">418</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_ipairs_aux(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="419"><td class="num" id="LN419">419</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="420"><td class="num" id="LN420">420</td><td class="line">  RecordIndex ix;</td></tr>
<tr class="codeline" data-linenumber="421"><td class="num" id="LN421">421</td><td class="line">  ix.tab = J-&gt;base[0];</td></tr>
<tr class="codeline" data-linenumber="422"><td class="num" id="LN422">422</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>tref_istab(ix.tab)<span class='macro_popup'>(((((ix.tab)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_TAB)&lt;&lt;<br>24)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="423"><td class="num" id="LN423">423</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>tvisnumber(&amp;rd-&gt;argv[1])<span class='macro_popup'>(((&amp;rd-&gt;argv[1])-&gt;it) &lt;= 0xfffeffffu)</span></span>)  <span class='comment'>/* No support for string coercion. */</span></td></tr>
<tr class="codeline" data-linenumber="424"><td class="num" id="LN424">424</td><td class="line">      lj_trace_err(J, LJ_TRERR_BADTYPE);</td></tr>
<tr class="codeline" data-linenumber="425"><td class="num" id="LN425">425</td><td class="line">    setintV(&amp;ix.keyv, numberVint(&amp;rd-&gt;argv[1])+1);</td></tr>
<tr class="codeline" data-linenumber="426"><td class="num" id="LN426">426</td><td class="line">    settabV(J-&gt;L, &amp;ix.tabv, <span class='macro'>tabV(&amp;rd-&gt;argv[0])<span class='macro_popup'>(&amp;(((GCobj *)(uintptr_t)((&amp;rd-&gt;argv[0])-&gt;gcr).gcptr32<br>))-&gt;tab)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="427"><td class="num" id="LN427">427</td><td class="line">    ix.val = 0; ix.idxchain = 0;</td></tr>
<tr class="codeline" data-linenumber="428"><td class="num" id="LN428">428</td><td class="line">    ix.key = lj_opt_narrow_toint(J, J-&gt;base[1]);</td></tr>
<tr class="codeline" data-linenumber="429"><td class="num" id="LN429">429</td><td class="line">    J-&gt;base[0] = ix.key = emitir(<span class='macro'>IRTI(IR_ADD)<span class='macro_popup'>(((uint32_t)((((IR_ADD))&lt;&lt;8) | (IRT_INT))))</span></span>, ix.key, lj_ir_kint(J, 1));</td></tr>
<tr class="codeline" data-linenumber="430"><td class="num" id="LN430">430</td><td class="line">    J-&gt;base[1] = lj_record_idx(J, &amp;ix);</td></tr>
<tr class="codeline" data-linenumber="431"><td class="num" id="LN431">431</td><td class="line">    rd-&gt;nres = <span class='macro'>tref_isnil(J-&gt;base[1])<span class='macro_popup'>(((((J-&gt;base[1])) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_NIL<br>)&lt;&lt;24)))</span></span> ? 0 : 2;</td></tr>
<tr class="codeline" data-linenumber="432"><td class="num" id="LN432">432</td><td class="line">  }  <span class='comment'>/* else: Interpreter will throw. */</span></td></tr>
<tr class="codeline" data-linenumber="433"><td class="num" id="LN433">433</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="434"><td class="num" id="LN434">434</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="435"><td class="num" id="LN435">435</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_xpairs(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="436"><td class="num" id="LN436">436</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="437"><td class="num" id="LN437">437</td><td class="line">  TRef tr = J-&gt;base[0];</td></tr>
<tr class="codeline" data-linenumber="438"><td class="num" id="LN438">438</td><td class="line">  <span class='keyword'>if</span> (!((<span class='macro'>LJ_52<span class='macro_popup'>0</span></span> || (<span class='macro'>LJ_HASFFI<span class='macro_popup'>1</span></span> &amp;&amp; <span class='macro'>tref_iscdata(tr)<span class='macro_popup'>(((((tr)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_CDATA)&lt;&lt;<br>24)))</span></span>)) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="439"><td class="num" id="LN439">439</td><td class="line">	recff_metacall(J, rd, MM_pairs + rd-&gt;data))) {</td></tr>
<tr class="codeline" data-linenumber="440"><td class="num" id="LN440">440</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>tref_istab(tr)<span class='macro_popup'>(((((tr)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_TAB)&lt;&lt;24<br>)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="441"><td class="num" id="LN441">441</td><td class="line">      J-&gt;base[0] = <span class='macro'>lj_ir_kfunc(J, funcV(&amp;J-&gt;fn-&gt;c.upvalue[0]))<span class='macro_popup'>lj_ir_kgc(J, ((GCobj *)(((&amp;(((GCobj *)(uintptr_t)((&amp;J<br>-&gt;fn-&gt;c.upvalue[0])-&gt;gcr).gcptr32))-&gt;fn)))), IRT_FUNC<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="442"><td class="num" id="LN442">442</td><td class="line">      J-&gt;base[1] = tr;</td></tr>
<tr class="codeline" data-linenumber="443"><td class="num" id="LN443">443</td><td class="line">      J-&gt;base[2] = rd-&gt;data ? lj_ir_kint(J, 0) : <span class='macro'>TREF_NIL<span class='macro_popup'>((((TRef)((REF_NIL-(IRT_NIL)) + (((IRT_NIL))&lt;&lt;24)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="444"><td class="num" id="LN444">444</td><td class="line">      rd-&gt;nres = 3;</td></tr>
<tr class="codeline" data-linenumber="445"><td class="num" id="LN445">445</td><td class="line">    }  <span class='comment'>/* else: Interpreter will throw. */</span></td></tr>
<tr class="codeline" data-linenumber="446"><td class="num" id="LN446">446</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="447"><td class="num" id="LN447">447</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="448"><td class="num" id="LN448">448</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="449"><td class="num" id="LN449">449</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_pcall(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="450"><td class="num" id="LN450">450</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="451"><td class="num" id="LN451">451</td><td class="line">  <span class='keyword'>if</span> (J-&gt;maxslot &gt;= 1) {</td></tr>
<tr class="codeline" data-linenumber="452"><td class="num" id="LN452">452</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_FR2<span class='macro_popup'>0</span></span></span></td></tr>
<tr class="codeline" data-linenumber="453"><td class="num" id="LN453">453</td><td class="line">    <span class='comment'>/* Shift function arguments up. */</span></td></tr>
<tr class="codeline" data-linenumber="454"><td class="num" id="LN454">454</td><td class="line">    memmove(J-&gt;base + 1, J-&gt;base, <span class='keyword'>sizeof</span>(TRef) * J-&gt;maxslot);</td></tr>
<tr class="codeline" data-linenumber="455"><td class="num" id="LN455">455</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="456"><td class="num" id="LN456">456</td><td class="line">    lj_record_call(J, 0, J-&gt;maxslot - 1);</td></tr>
<tr class="codeline" data-linenumber="457"><td class="num" id="LN457">457</td><td class="line">    rd-&gt;nres = -1;  <span class='comment'>/* Pending call. */</span></td></tr>
<tr class="codeline" data-linenumber="458"><td class="num" id="LN458">458</td><td class="line">  }  <span class='comment'>/* else: Interpreter will throw. */</span></td></tr>
<tr class="codeline" data-linenumber="459"><td class="num" id="LN459">459</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="460"><td class="num" id="LN460">460</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="461"><td class="num" id="LN461">461</td><td class="line"><span class='keyword'>static</span> TValue *recff_xpcall_cp(lua_State *L, lua_CFunction dummy, <span class='keyword'>void</span> *ud)</td></tr>
<tr class="codeline" data-linenumber="462"><td class="num" id="LN462">462</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="463"><td class="num" id="LN463">463</td><td class="line">  jit_State *J = (jit_State *)ud;</td></tr>
<tr class="codeline" data-linenumber="464"><td class="num" id="LN464">464</td><td class="line">  lj_record_call(J, 1, J-&gt;maxslot - 2);</td></tr>
<tr class="codeline" data-linenumber="465"><td class="num" id="LN465">465</td><td class="line">  <span class='macro'>UNUSED(L)<span class='macro_popup'>((void)(L))</span></span>; <span class='macro'>UNUSED(dummy)<span class='macro_popup'>((void)(dummy))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="466"><td class="num" id="LN466">466</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="467"><td class="num" id="LN467">467</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="468"><td class="num" id="LN468">468</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="469"><td class="num" id="LN469">469</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_xpcall(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="470"><td class="num" id="LN470">470</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="471"><td class="num" id="LN471">471</td><td class="line">  <span class='keyword'>if</span> (J-&gt;maxslot &gt;= 2) {</td></tr>
<tr class="codeline" data-linenumber="472"><td class="num" id="LN472">472</td><td class="line">    TValue argv0, argv1;</td></tr>
<tr class="codeline" data-linenumber="473"><td class="num" id="LN473">473</td><td class="line">    TRef tmp;</td></tr>
<tr class="codeline" data-linenumber="474"><td class="num" id="LN474">474</td><td class="line">    <span class='keyword'>int</span> errcode;</td></tr>
<tr class="codeline" data-linenumber="475"><td class="num" id="LN475">475</td><td class="line">    <span class='comment'>/* Swap function and traceback. */</span></td></tr>
<tr class="codeline" data-linenumber="476"><td class="num" id="LN476">476</td><td class="line">    tmp = J-&gt;base[0]; J-&gt;base[0] = J-&gt;base[1]; J-&gt;base[1] = tmp;</td></tr>
<tr class="codeline" data-linenumber="477"><td class="num" id="LN477">477</td><td class="line">    copyTV(J-&gt;L, &amp;argv0, &amp;rd-&gt;argv[0]);</td></tr>
<tr class="codeline" data-linenumber="478"><td class="num" id="LN478">478</td><td class="line">    copyTV(J-&gt;L, &amp;argv1, &amp;rd-&gt;argv[1]);</td></tr>
<tr class="codeline" data-linenumber="479"><td class="num" id="LN479">479</td><td class="line">    copyTV(J-&gt;L, &amp;rd-&gt;argv[0], &amp;argv1);</td></tr>
<tr class="codeline" data-linenumber="480"><td class="num" id="LN480">480</td><td class="line">    copyTV(J-&gt;L, &amp;rd-&gt;argv[1], &amp;argv0);</td></tr>
<tr class="codeline" data-linenumber="481"><td class="num" id="LN481">481</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_FR2<span class='macro_popup'>0</span></span></span></td></tr>
<tr class="codeline" data-linenumber="482"><td class="num" id="LN482">482</td><td class="line">    <span class='comment'>/* Shift function arguments up. */</span></td></tr>
<tr class="codeline" data-linenumber="483"><td class="num" id="LN483">483</td><td class="line">    memmove(J-&gt;base + 2, J-&gt;base + 1, <span class='keyword'>sizeof</span>(TRef) * (J-&gt;maxslot-1));</td></tr>
<tr class="codeline" data-linenumber="484"><td class="num" id="LN484">484</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="485"><td class="num" id="LN485">485</td><td class="line">    <span class='comment'>/* Need to protect lj_record_call because it may throw. */</span></td></tr>
<tr class="codeline" data-linenumber="486"><td class="num" id="LN486">486</td><td class="line">    errcode = lj_vm_cpcall(J-&gt;L, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, J, recff_xpcall_cp);</td></tr>
<tr class="codeline" data-linenumber="487"><td class="num" id="LN487">487</td><td class="line">    <span class='comment'>/* Always undo Lua stack swap to avoid confusing the interpreter. */</span></td></tr>
<tr class="codeline" data-linenumber="488"><td class="num" id="LN488">488</td><td class="line">    copyTV(J-&gt;L, &amp;rd-&gt;argv[0], &amp;argv0);</td></tr>
<tr class="codeline" data-linenumber="489"><td class="num" id="LN489">489</td><td class="line">    copyTV(J-&gt;L, &amp;rd-&gt;argv[1], &amp;argv1);</td></tr>
<tr class="codeline" data-linenumber="490"><td class="num" id="LN490">490</td><td class="line">    <span class='keyword'>if</span> (errcode)</td></tr>
<tr class="codeline" data-linenumber="491"><td class="num" id="LN491">491</td><td class="line">      lj_err_throw(J-&gt;L, errcode);  <span class='comment'>/* Propagate errors. */</span></td></tr>
<tr class="codeline" data-linenumber="492"><td class="num" id="LN492">492</td><td class="line">    rd-&gt;nres = -1;  <span class='comment'>/* Pending call. */</span></td></tr>
<tr class="codeline" data-linenumber="493"><td class="num" id="LN493">493</td><td class="line">  }  <span class='comment'>/* else: Interpreter will throw. */</span></td></tr>
<tr class="codeline" data-linenumber="494"><td class="num" id="LN494">494</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="495"><td class="num" id="LN495">495</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="496"><td class="num" id="LN496">496</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_getfenv(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="497"><td class="num" id="LN497">497</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="498"><td class="num" id="LN498">498</td><td class="line">  TRef tr = J-&gt;base[0];</td></tr>
<tr class="codeline" data-linenumber="499"><td class="num" id="LN499">499</td><td class="line">  <span class='comment'>/* Only support getfenv(0) for now. */</span></td></tr>
<tr class="codeline" data-linenumber="500"><td class="num" id="LN500">500</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>tref_isint(tr)<span class='macro_popup'>(((((tr)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_INT)&lt;&lt;24<br>)))</span></span> &amp;&amp; <span class='macro'>tref_isk(tr)<span class='macro_popup'>(((((IRRef1)((tr)))) &lt; REF_BIAS))</span></span> &amp;&amp; IR(<span class='macro'>tref_ref(tr)<span class='macro_popup'>((IRRef1)(tr))</span></span>)-&gt;i == 0) {</td></tr>
<tr class="codeline" data-linenumber="501"><td class="num" id="LN501">501</td><td class="line">    TRef trl = emitir(<span class='macro'>IRT(IR_LREF, IRT_THREAD)<span class='macro_popup'>((uint32_t)(((IR_LREF)&lt;&lt;8) | (IRT_THREAD)))</span></span>, 0, 0);</td></tr>
<tr class="codeline" data-linenumber="502"><td class="num" id="LN502">502</td><td class="line">    J-&gt;base[0] = emitir(<span class='macro'>IRT(IR_FLOAD, IRT_TAB)<span class='macro_popup'>((uint32_t)(((IR_FLOAD)&lt;&lt;8) | (IRT_TAB)))</span></span>, trl, IRFL_THREAD_ENV);</td></tr>
<tr class="codeline" data-linenumber="503"><td class="num" id="LN503">503</td><td class="line">    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="504"><td class="num" id="LN504">504</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="505"><td class="num" id="LN505">505</td><td class="line">  <span class='macro'>recff_nyiu<span class='macro_popup'>recff_nyi</span></span>(J, rd);</td></tr>
<tr class="codeline" data-linenumber="506"><td class="num" id="LN506">506</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="507"><td class="num" id="LN507">507</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="508"><td class="num" id="LN508">508</td><td class="line"><span class='comment'>/* -- Math library fast functions ----------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="509"><td class="num" id="LN509">509</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="510"><td class="num" id="LN510">510</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_math_abs(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="511"><td class="num" id="LN511">511</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="512"><td class="num" id="LN512">512</td><td class="line">  TRef tr = lj_ir_tonum(J, J-&gt;base[0]);</td></tr>
<tr class="codeline" data-linenumber="513"><td class="num" id="LN513">513</td><td class="line">  J-&gt;base[0] = emitir(<span class='macro'>IRTN(IR_ABS)<span class='macro_popup'>(((uint32_t)((((IR_ABS))&lt;&lt;8) | (IRT_NUM))))</span></span>, tr, <span class='macro'>lj_ir_ksimd(J, LJ_KSIMD_ABS)<span class='macro_popup'>lj_ir_ggfload(J, IRT_NUM, (uintptr_t)((TValue *)(((intptr_t)&amp;<br>J-&gt;ksimd[2*(LJ_KSIMD_ABS)] + 15) &amp; ~(intptr_t)15)) - (<br>uintptr_t)((GG_State *)((char *)(J) - ((int)__builtin_offsetof<br>(GG_State, J)))))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="514"><td class="num" id="LN514">514</td><td class="line">  <span class='macro'>UNUSED(rd)<span class='macro_popup'>((void)(rd))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="515"><td class="num" id="LN515">515</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="516"><td class="num" id="LN516">516</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="517"><td class="num" id="LN517">517</td><td class="line"><span class='comment'>/* Record rounding functions math.floor and math.ceil. */</span></td></tr>
<tr class="codeline" data-linenumber="518"><td class="num" id="LN518">518</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_math_round(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="519"><td class="num" id="LN519">519</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="520"><td class="num" id="LN520">520</td><td class="line">  TRef tr = J-&gt;base[0];</td></tr>
<tr class="codeline" data-linenumber="521"><td class="num" id="LN521">521</td><td class="line">  <span class='keyword'>if</span> (!<span class='macro'>tref_isinteger(tr)<span class='macro_popup'>((((((tr))&gt;&gt;24) &amp; IRT_TYPE) - (TRef)(IRT_I8) &lt;= (<br>TRef)(IRT_INT-IRT_I8)))</span></span>) {  <span class='comment'>/* Pass through integers unmodified. */</span></td></tr>
<tr class="codeline" data-linenumber="522"><td class="num" id="LN522">522</td><td class="line">    tr = emitir(<span class='macro'>IRTN(IR_FPMATH)<span class='macro_popup'>(((uint32_t)((((IR_FPMATH))&lt;&lt;8) | (IRT_NUM))))</span></span>, lj_ir_tonum(J, tr), rd-&gt;data);</td></tr>
<tr class="codeline" data-linenumber="523"><td class="num" id="LN523">523</td><td class="line">    <span class='comment'>/* Result is integral (or NaN/Inf), but may not fit an int32_t. */</span></td></tr>
<tr class="codeline" data-linenumber="524"><td class="num" id="LN524">524</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>LJ_DUALNUM<span class='macro_popup'>0</span></span>) {  <span class='comment'>/* Try to narrow using a guarded conversion to int. */</span></td></tr>
<tr class="codeline" data-linenumber="525"><td class="num" id="LN525">525</td><td class="line">      lua_Number n = lj_vm_foldfpm(numberVnum(&amp;rd-&gt;argv[0]), rd-&gt;data);</td></tr>
<tr class="codeline" data-linenumber="526"><td class="num" id="LN526">526</td><td class="line">      <span class='keyword'>if</span> (n == (lua_Number)<span class='macro'>lj_num2int(n)<span class='macro_popup'>((int32_t)(n))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="527"><td class="num" id="LN527">527</td><td class="line">	tr = emitir(<span class='macro'>IRTGI(IR_CONV)<span class='macro_popup'>(((uint32_t)((((IR_CONV))&lt;&lt;8) | (IRT_GUARD|IRT_INT))))</span></span>, tr, <span class='macro'>IRCONV_INT_NUM<span class='macro_popup'>((IRT_INT&lt;&lt;5)|IRT_NUM)</span></span>|<span class='macro'>IRCONV_CHECK<span class='macro_popup'>(3&lt;&lt;12)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="528"><td class="num" id="LN528">528</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="529"><td class="num" id="LN529">529</td><td class="line">    J-&gt;base[0] = tr;</td></tr>
<tr class="codeline" data-linenumber="530"><td class="num" id="LN530">530</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="531"><td class="num" id="LN531">531</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="532"><td class="num" id="LN532">532</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="533"><td class="num" id="LN533">533</td><td class="line"><span class='comment'>/* Record unary math.* functions, mapped to IR_FPMATH opcode. */</span></td></tr>
<tr class="codeline" data-linenumber="534"><td class="num" id="LN534">534</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_math_unary(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="535"><td class="num" id="LN535">535</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="536"><td class="num" id="LN536">536</td><td class="line">  J-&gt;base[0] = emitir(<span class='macro'>IRTN(IR_FPMATH)<span class='macro_popup'>(((uint32_t)((((IR_FPMATH))&lt;&lt;8) | (IRT_NUM))))</span></span>, lj_ir_tonum(J, J-&gt;base[0]), rd-&gt;data);</td></tr>
<tr class="codeline" data-linenumber="537"><td class="num" id="LN537">537</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="538"><td class="num" id="LN538">538</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="539"><td class="num" id="LN539">539</td><td class="line"><span class='comment'>/* Record math.log. */</span></td></tr>
<tr class="codeline" data-linenumber="540"><td class="num" id="LN540">540</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_math_log(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="541"><td class="num" id="LN541">541</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="542"><td class="num" id="LN542">542</td><td class="line">  TRef tr = lj_ir_tonum(J, J-&gt;base[0]);</td></tr>
<tr class="codeline" data-linenumber="543"><td class="num" id="LN543">543</td><td class="line">  <span class='keyword'>if</span> (J-&gt;base[1]) {</td></tr>
<tr class="codeline" data-linenumber="544"><td class="num" id="LN544">544</td><td class="line"><span class='directive'>#ifdef LUAJIT_NO_LOG2</span></td></tr>
<tr class="codeline" data-linenumber="545"><td class="num" id="LN545">545</td><td class="line">    uint32_t fpm = IRFPM_LOG;</td></tr>
<tr class="codeline" data-linenumber="546"><td class="num" id="LN546">546</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="547"><td class="num" id="LN547">547</td><td class="line">    uint32_t fpm = IRFPM_LOG2;</td></tr>
<tr class="codeline" data-linenumber="548"><td class="num" id="LN548">548</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="549"><td class="num" id="LN549">549</td><td class="line">    TRef trb = lj_ir_tonum(J, J-&gt;base[1]);</td></tr>
<tr class="codeline" data-linenumber="550"><td class="num" id="LN550">550</td><td class="line">    tr = emitir(<span class='macro'>IRTN(IR_FPMATH)<span class='macro_popup'>(((uint32_t)((((IR_FPMATH))&lt;&lt;8) | (IRT_NUM))))</span></span>, tr, fpm);</td></tr>
<tr class="codeline" data-linenumber="551"><td class="num" id="LN551">551</td><td class="line">    trb = emitir(<span class='macro'>IRTN(IR_FPMATH)<span class='macro_popup'>(((uint32_t)((((IR_FPMATH))&lt;&lt;8) | (IRT_NUM))))</span></span>, trb, fpm);</td></tr>
<tr class="codeline" data-linenumber="552"><td class="num" id="LN552">552</td><td class="line">    trb = emitir(<span class='macro'>IRTN(IR_DIV)<span class='macro_popup'>(((uint32_t)((((IR_DIV))&lt;&lt;8) | (IRT_NUM))))</span></span>, <span class='macro'>lj_ir_knum_one(J)<span class='macro_popup'>lj_ir_knum_u64(J, (((uint64_t)0x3ff00000 &lt;&lt; 32) + (uint64_t<br>)0x00000000))</span></span>, trb);</td></tr>
<tr class="codeline" data-linenumber="553"><td class="num" id="LN553">553</td><td class="line">    tr = emitir(<span class='macro'>IRTN(IR_MUL)<span class='macro_popup'>(((uint32_t)((((IR_MUL))&lt;&lt;8) | (IRT_NUM))))</span></span>, tr, trb);</td></tr>
<tr class="codeline" data-linenumber="554"><td class="num" id="LN554">554</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="555"><td class="num" id="LN555">555</td><td class="line">    tr = emitir(<span class='macro'>IRTN(IR_FPMATH)<span class='macro_popup'>(((uint32_t)((((IR_FPMATH))&lt;&lt;8) | (IRT_NUM))))</span></span>, tr, IRFPM_LOG);</td></tr>
<tr class="codeline" data-linenumber="556"><td class="num" id="LN556">556</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="557"><td class="num" id="LN557">557</td><td class="line">  J-&gt;base[0] = tr;</td></tr>
<tr class="codeline" data-linenumber="558"><td class="num" id="LN558">558</td><td class="line">  <span class='macro'>UNUSED(rd)<span class='macro_popup'>((void)(rd))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="559"><td class="num" id="LN559">559</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="560"><td class="num" id="LN560">560</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="561"><td class="num" id="LN561">561</td><td class="line"><span class='comment'>/* Record math.atan2. */</span></td></tr>
<tr class="codeline" data-linenumber="562"><td class="num" id="LN562">562</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_math_atan2(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="563"><td class="num" id="LN563">563</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="564"><td class="num" id="LN564">564</td><td class="line">  TRef tr = lj_ir_tonum(J, J-&gt;base[0]);</td></tr>
<tr class="codeline" data-linenumber="565"><td class="num" id="LN565">565</td><td class="line">  TRef tr2 = lj_ir_tonum(J, J-&gt;base[1]);</td></tr>
<tr class="codeline" data-linenumber="566"><td class="num" id="LN566">566</td><td class="line">  J-&gt;base[0] = emitir(<span class='macro'>IRTN(IR_ATAN2)<span class='macro_popup'>(((uint32_t)((((IR_ATAN2))&lt;&lt;8) | (IRT_NUM))))</span></span>, tr, tr2);</td></tr>
<tr class="codeline" data-linenumber="567"><td class="num" id="LN567">567</td><td class="line">  <span class='macro'>UNUSED(rd)<span class='macro_popup'>((void)(rd))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="568"><td class="num" id="LN568">568</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="569"><td class="num" id="LN569">569</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="570"><td class="num" id="LN570">570</td><td class="line"><span class='comment'>/* Record math.ldexp. */</span></td></tr>
<tr class="codeline" data-linenumber="571"><td class="num" id="LN571">571</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_math_ldexp(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="572"><td class="num" id="LN572">572</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="573"><td class="num" id="LN573">573</td><td class="line">  TRef tr = lj_ir_tonum(J, J-&gt;base[0]);</td></tr>
<tr class="codeline" data-linenumber="574"><td class="num" id="LN574">574</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_TARGET_X86ORX64<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="575"><td class="num" id="LN575">575</td><td class="line">  TRef tr2 = lj_ir_tonum(J, J-&gt;base[1]);</td></tr>
<tr class="codeline" data-linenumber="576"><td class="num" id="LN576">576</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="577"><td class="num" id="LN577">577</td><td class="line">  TRef tr2 = lj_opt_narrow_toint(J, J-&gt;base[1]);</td></tr>
<tr class="codeline" data-linenumber="578"><td class="num" id="LN578">578</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="579"><td class="num" id="LN579">579</td><td class="line">  J-&gt;base[0] = emitir(<span class='macro'>IRTN(IR_LDEXP)<span class='macro_popup'>(((uint32_t)((((IR_LDEXP))&lt;&lt;8) | (IRT_NUM))))</span></span>, tr, tr2);</td></tr>
<tr class="codeline" data-linenumber="580"><td class="num" id="LN580">580</td><td class="line">  <span class='macro'>UNUSED(rd)<span class='macro_popup'>((void)(rd))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="581"><td class="num" id="LN581">581</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="582"><td class="num" id="LN582">582</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="583"><td class="num" id="LN583">583</td><td class="line"><span class='comment'>/* Record math.asin, math.acos, math.atan. */</span></td></tr>
<tr class="codeline" data-linenumber="584"><td class="num" id="LN584">584</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_math_atrig(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="585"><td class="num" id="LN585">585</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="586"><td class="num" id="LN586">586</td><td class="line">  TRef y = lj_ir_tonum(J, J-&gt;base[0]);</td></tr>
<tr class="codeline" data-linenumber="587"><td class="num" id="LN587">587</td><td class="line">  TRef x = <span class='macro'>lj_ir_knum_one(J)<span class='macro_popup'>lj_ir_knum_u64(J, (((uint64_t)0x3ff00000 &lt;&lt; 32) + (uint64_t<br>)0x00000000))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="588"><td class="num" id="LN588">588</td><td class="line">  uint32_t ffid = rd-&gt;data;</td></tr>
<tr class="codeline" data-linenumber="589"><td class="num" id="LN589">589</td><td class="line">  <span class='keyword'>if</span> (ffid != FF_math_atan) {</td></tr>
<tr class="codeline" data-linenumber="590"><td class="num" id="LN590">590</td><td class="line">    TRef tmp = emitir(<span class='macro'>IRTN(IR_MUL)<span class='macro_popup'>(((uint32_t)((((IR_MUL))&lt;&lt;8) | (IRT_NUM))))</span></span>, y, y);</td></tr>
<tr class="codeline" data-linenumber="591"><td class="num" id="LN591">591</td><td class="line">    tmp = emitir(<span class='macro'>IRTN(IR_SUB)<span class='macro_popup'>(((uint32_t)((((IR_SUB))&lt;&lt;8) | (IRT_NUM))))</span></span>, x, tmp);</td></tr>
<tr class="codeline" data-linenumber="592"><td class="num" id="LN592">592</td><td class="line">    tmp = emitir(<span class='macro'>IRTN(IR_FPMATH)<span class='macro_popup'>(((uint32_t)((((IR_FPMATH))&lt;&lt;8) | (IRT_NUM))))</span></span>, tmp, IRFPM_SQRT);</td></tr>
<tr class="codeline" data-linenumber="593"><td class="num" id="LN593">593</td><td class="line">    <span class='keyword'>if</span> (ffid == FF_math_asin) { x = tmp; } <span class='keyword'>else</span> { x = y; y = tmp; }</td></tr>
<tr class="codeline" data-linenumber="594"><td class="num" id="LN594">594</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="595"><td class="num" id="LN595">595</td><td class="line">  J-&gt;base[0] = emitir(<span class='macro'>IRTN(IR_ATAN2)<span class='macro_popup'>(((uint32_t)((((IR_ATAN2))&lt;&lt;8) | (IRT_NUM))))</span></span>, y, x);</td></tr>
<tr class="codeline" data-linenumber="596"><td class="num" id="LN596">596</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="597"><td class="num" id="LN597">597</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="598"><td class="num" id="LN598">598</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_math_htrig(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="599"><td class="num" id="LN599">599</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="600"><td class="num" id="LN600">600</td><td class="line">  TRef tr = lj_ir_tonum(J, J-&gt;base[0]);</td></tr>
<tr class="codeline" data-linenumber="601"><td class="num" id="LN601">601</td><td class="line">  J-&gt;base[0] = emitir(<span class='macro'>IRTN(IR_CALLN)<span class='macro_popup'>(((uint32_t)((((IR_CALLN))&lt;&lt;8) | (IRT_NUM))))</span></span>, tr, rd-&gt;data);</td></tr>
<tr class="codeline" data-linenumber="602"><td class="num" id="LN602">602</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="603"><td class="num" id="LN603">603</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="604"><td class="num" id="LN604">604</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_math_modf(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="605"><td class="num" id="LN605">605</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="606"><td class="num" id="LN606">606</td><td class="line">  TRef tr = J-&gt;base[0];</td></tr>
<tr class="codeline" data-linenumber="607"><td class="num" id="LN607">607</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>tref_isinteger(tr)<span class='macro_popup'>((((((tr))&gt;&gt;24) &amp; IRT_TYPE) - (TRef)(IRT_I8) &lt;= (<br>TRef)(IRT_INT-IRT_I8)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="608"><td class="num" id="LN608">608</td><td class="line">    J-&gt;base[0] = tr;</td></tr>
<tr class="codeline" data-linenumber="609"><td class="num" id="LN609">609</td><td class="line">    J-&gt;base[1] = lj_ir_kint(J, 0);</td></tr>
<tr class="codeline" data-linenumber="610"><td class="num" id="LN610">610</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="611"><td class="num" id="LN611">611</td><td class="line">    TRef trt;</td></tr>
<tr class="codeline" data-linenumber="612"><td class="num" id="LN612">612</td><td class="line">    tr = lj_ir_tonum(J, tr);</td></tr>
<tr class="codeline" data-linenumber="613"><td class="num" id="LN613">613</td><td class="line">    trt = emitir(<span class='macro'>IRTN(IR_FPMATH)<span class='macro_popup'>(((uint32_t)((((IR_FPMATH))&lt;&lt;8) | (IRT_NUM))))</span></span>, tr, IRFPM_TRUNC);</td></tr>
<tr class="codeline" data-linenumber="614"><td class="num" id="LN614">614</td><td class="line">    J-&gt;base[0] = trt;</td></tr>
<tr class="codeline" data-linenumber="615"><td class="num" id="LN615">615</td><td class="line">    J-&gt;base[1] = emitir(<span class='macro'>IRTN(IR_SUB)<span class='macro_popup'>(((uint32_t)((((IR_SUB))&lt;&lt;8) | (IRT_NUM))))</span></span>, tr, trt);</td></tr>
<tr class="codeline" data-linenumber="616"><td class="num" id="LN616">616</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="617"><td class="num" id="LN617">617</td><td class="line">  rd-&gt;nres = 2;</td></tr>
<tr class="codeline" data-linenumber="618"><td class="num" id="LN618">618</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="619"><td class="num" id="LN619">619</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="620"><td class="num" id="LN620">620</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_math_pow(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="621"><td class="num" id="LN621">621</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="622"><td class="num" id="LN622">622</td><td class="line">  J-&gt;base[0] = lj_opt_narrow_pow(J, J-&gt;base[0], J-&gt;base[1],</td></tr>
<tr class="codeline" data-linenumber="623"><td class="num" id="LN623">623</td><td class="line">				 &amp;rd-&gt;argv[0], &amp;rd-&gt;argv[1]);</td></tr>
<tr class="codeline" data-linenumber="624"><td class="num" id="LN624">624</td><td class="line">  <span class='macro'>UNUSED(rd)<span class='macro_popup'>((void)(rd))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="625"><td class="num" id="LN625">625</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="626"><td class="num" id="LN626">626</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="627"><td class="num" id="LN627">627</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_math_minmax(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="628"><td class="num" id="LN628">628</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="629"><td class="num" id="LN629">629</td><td class="line">  TRef tr = lj_ir_tonumber(J, J-&gt;base[0]);</td></tr>
<tr class="codeline" data-linenumber="630"><td class="num" id="LN630">630</td><td class="line">  uint32_t op = rd-&gt;data;</td></tr>
<tr class="codeline" data-linenumber="631"><td class="num" id="LN631">631</td><td class="line">  BCReg i;</td></tr>
<tr class="codeline" data-linenumber="632"><td class="num" id="LN632">632</td><td class="line">  <span class='keyword'>for</span> (i = 1; J-&gt;base[i] != 0; i++) {</td></tr>
<tr class="codeline" data-linenumber="633"><td class="num" id="LN633">633</td><td class="line">    TRef tr2 = lj_ir_tonumber(J, J-&gt;base[i]);</td></tr>
<tr class="codeline" data-linenumber="634"><td class="num" id="LN634">634</td><td class="line">    IRType t = IRT_INT;</td></tr>
<tr class="codeline" data-linenumber="635"><td class="num" id="LN635">635</td><td class="line">    <span class='keyword'>if</span> (!(<span class='macro'>tref_isinteger(tr)<span class='macro_popup'>((((((tr))&gt;&gt;24) &amp; IRT_TYPE) - (TRef)(IRT_I8) &lt;= (<br>TRef)(IRT_INT-IRT_I8)))</span></span> &amp;&amp; <span class='macro'>tref_isinteger(tr2)<span class='macro_popup'>((((((tr2))&gt;&gt;24) &amp; IRT_TYPE) - (TRef)(IRT_I8) &lt;=<br> (TRef)(IRT_INT-IRT_I8)))</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="636"><td class="num" id="LN636">636</td><td class="line">      <span class='keyword'>if</span> (<span class='macro'>tref_isinteger(tr)<span class='macro_popup'>((((((tr))&gt;&gt;24) &amp; IRT_TYPE) - (TRef)(IRT_I8) &lt;= (<br>TRef)(IRT_INT-IRT_I8)))</span></span>) tr = emitir(<span class='macro'>IRTN(IR_CONV)<span class='macro_popup'>(((uint32_t)((((IR_CONV))&lt;&lt;8) | (IRT_NUM))))</span></span>, tr, <span class='macro'>IRCONV_NUM_INT<span class='macro_popup'>((IRT_NUM&lt;&lt;5)|IRT_INT)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="637"><td class="num" id="LN637">637</td><td class="line">      <span class='keyword'>if</span> (<span class='macro'>tref_isinteger(tr2)<span class='macro_popup'>((((((tr2))&gt;&gt;24) &amp; IRT_TYPE) - (TRef)(IRT_I8) &lt;=<br> (TRef)(IRT_INT-IRT_I8)))</span></span>) tr2 = emitir(<span class='macro'>IRTN(IR_CONV)<span class='macro_popup'>(((uint32_t)((((IR_CONV))&lt;&lt;8) | (IRT_NUM))))</span></span>, tr2, <span class='macro'>IRCONV_NUM_INT<span class='macro_popup'>((IRT_NUM&lt;&lt;5)|IRT_INT)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="638"><td class="num" id="LN638">638</td><td class="line">      t = IRT_NUM;</td></tr>
<tr class="codeline" data-linenumber="639"><td class="num" id="LN639">639</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="640"><td class="num" id="LN640">640</td><td class="line">    tr = emitir(<span class='macro'>IRT(op, t)<span class='macro_popup'>((uint32_t)(((op)&lt;&lt;8) | (t)))</span></span>, tr, tr2);</td></tr>
<tr class="codeline" data-linenumber="641"><td class="num" id="LN641">641</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="642"><td class="num" id="LN642">642</td><td class="line">  J-&gt;base[0] = tr;</td></tr>
<tr class="codeline" data-linenumber="643"><td class="num" id="LN643">643</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="644"><td class="num" id="LN644">644</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="645"><td class="num" id="LN645">645</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_math_random(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="646"><td class="num" id="LN646">646</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="647"><td class="num" id="LN647">647</td><td class="line">  GCudata *ud = <span class='macro'>udataV(&amp;J-&gt;fn-&gt;c.upvalue[0])<span class='macro_popup'>(&amp;(((GCobj *)(uintptr_t)((&amp;J-&gt;fn-&gt;c.upvalue[0])<br>-&gt;gcr).gcptr32))-&gt;ud)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="648"><td class="num" id="LN648">648</td><td class="line">  TRef tr, one;</td></tr>
<tr class="codeline" data-linenumber="649"><td class="num" id="LN649">649</td><td class="line">  lj_ir_kgc(J, <span class='macro'>obj2gco(ud)<span class='macro_popup'>((GCobj *)(ud))</span></span>, IRT_UDATA);  <span class='comment'>/* Prevent collection. */</span></td></tr>
<tr class="codeline" data-linenumber="650"><td class="num" id="LN650">650</td><td class="line">  tr = lj_ir_call(J, IRCALL_lj_math_random_step, <span class='macro'>lj_ir_kptr(J, uddata(ud))<span class='macro_popup'>lj_ir_kptr_(J, IR_KPTR, (((void *)((ud)+1))))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="651"><td class="num" id="LN651">651</td><td class="line">  one = <span class='macro'>lj_ir_knum_one(J)<span class='macro_popup'>lj_ir_knum_u64(J, (((uint64_t)0x3ff00000 &lt;&lt; 32) + (uint64_t<br>)0x00000000))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="652"><td class="num" id="LN652">652</td><td class="line">  tr = emitir(<span class='macro'>IRTN(IR_SUB)<span class='macro_popup'>(((uint32_t)((((IR_SUB))&lt;&lt;8) | (IRT_NUM))))</span></span>, tr, one);</td></tr>
<tr class="codeline" data-linenumber="653"><td class="num" id="LN653">653</td><td class="line">  <span class='keyword'>if</span> (J-&gt;base[0]) {</td></tr>
<tr class="codeline" data-linenumber="654"><td class="num" id="LN654">654</td><td class="line">    TRef tr1 = lj_ir_tonum(J, J-&gt;base[0]);</td></tr>
<tr class="codeline" data-linenumber="655"><td class="num" id="LN655">655</td><td class="line">    <span class='keyword'>if</span> (J-&gt;base[1]) {  <span class='comment'>/* d = floor(d*(r2-r1+1.0)) + r1 */</span></td></tr>
<tr class="codeline" data-linenumber="656"><td class="num" id="LN656">656</td><td class="line">      TRef tr2 = lj_ir_tonum(J, J-&gt;base[1]);</td></tr>
<tr class="codeline" data-linenumber="657"><td class="num" id="LN657">657</td><td class="line">      tr2 = emitir(<span class='macro'>IRTN(IR_SUB)<span class='macro_popup'>(((uint32_t)((((IR_SUB))&lt;&lt;8) | (IRT_NUM))))</span></span>, tr2, tr1);</td></tr>
<tr class="codeline" data-linenumber="658"><td class="num" id="LN658">658</td><td class="line">      tr2 = emitir(<span class='macro'>IRTN(IR_ADD)<span class='macro_popup'>(((uint32_t)((((IR_ADD))&lt;&lt;8) | (IRT_NUM))))</span></span>, tr2, one);</td></tr>
<tr class="codeline" data-linenumber="659"><td class="num" id="LN659">659</td><td class="line">      tr = emitir(<span class='macro'>IRTN(IR_MUL)<span class='macro_popup'>(((uint32_t)((((IR_MUL))&lt;&lt;8) | (IRT_NUM))))</span></span>, tr, tr2);</td></tr>
<tr class="codeline" data-linenumber="660"><td class="num" id="LN660">660</td><td class="line">      tr = emitir(<span class='macro'>IRTN(IR_FPMATH)<span class='macro_popup'>(((uint32_t)((((IR_FPMATH))&lt;&lt;8) | (IRT_NUM))))</span></span>, tr, IRFPM_FLOOR);</td></tr>
<tr class="codeline" data-linenumber="661"><td class="num" id="LN661">661</td><td class="line">      tr = emitir(<span class='macro'>IRTN(IR_ADD)<span class='macro_popup'>(((uint32_t)((((IR_ADD))&lt;&lt;8) | (IRT_NUM))))</span></span>, tr, tr1);</td></tr>
<tr class="codeline" data-linenumber="662"><td class="num" id="LN662">662</td><td class="line">    } <span class='keyword'>else</span> {  <span class='comment'>/* d = floor(d*r1) + 1.0 */</span></td></tr>
<tr class="codeline" data-linenumber="663"><td class="num" id="LN663">663</td><td class="line">      tr = emitir(<span class='macro'>IRTN(IR_MUL)<span class='macro_popup'>(((uint32_t)((((IR_MUL))&lt;&lt;8) | (IRT_NUM))))</span></span>, tr, tr1);</td></tr>
<tr class="codeline" data-linenumber="664"><td class="num" id="LN664">664</td><td class="line">      tr = emitir(<span class='macro'>IRTN(IR_FPMATH)<span class='macro_popup'>(((uint32_t)((((IR_FPMATH))&lt;&lt;8) | (IRT_NUM))))</span></span>, tr, IRFPM_FLOOR);</td></tr>
<tr class="codeline" data-linenumber="665"><td class="num" id="LN665">665</td><td class="line">      tr = emitir(<span class='macro'>IRTN(IR_ADD)<span class='macro_popup'>(((uint32_t)((((IR_ADD))&lt;&lt;8) | (IRT_NUM))))</span></span>, tr, one);</td></tr>
<tr class="codeline" data-linenumber="666"><td class="num" id="LN666">666</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="667"><td class="num" id="LN667">667</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="668"><td class="num" id="LN668">668</td><td class="line">  J-&gt;base[0] = tr;</td></tr>
<tr class="codeline" data-linenumber="669"><td class="num" id="LN669">669</td><td class="line">  <span class='macro'>UNUSED(rd)<span class='macro_popup'>((void)(rd))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="670"><td class="num" id="LN670">670</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="671"><td class="num" id="LN671">671</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="672"><td class="num" id="LN672">672</td><td class="line"><span class='comment'>/* -- Bit library fast functions ------------------------------------------ */</span></td></tr>
<tr class="codeline" data-linenumber="673"><td class="num" id="LN673">673</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="674"><td class="num" id="LN674">674</td><td class="line"><span class='comment'>/* Record bit.tobit. */</span></td></tr>
<tr class="codeline" data-linenumber="675"><td class="num" id="LN675">675</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_bit_tobit(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="676"><td class="num" id="LN676">676</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="677"><td class="num" id="LN677">677</td><td class="line">  TRef tr = J-&gt;base[0];</td></tr>
<tr class="codeline" data-linenumber="678"><td class="num" id="LN678">678</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_HASFFI<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="679"><td class="num" id="LN679">679</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>tref_iscdata(tr)<span class='macro_popup'>(((((tr)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_CDATA)&lt;&lt;<br>24)))</span></span>) { recff_bit64_tobit(J, rd); <span class='keyword'>return</span>; }</td></tr>
<tr class="codeline" data-linenumber="680"><td class="num" id="LN680">680</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="681"><td class="num" id="LN681">681</td><td class="line">  J-&gt;base[0] = lj_opt_narrow_tobit(J, tr);</td></tr>
<tr class="codeline" data-linenumber="682"><td class="num" id="LN682">682</td><td class="line">  <span class='macro'>UNUSED(rd)<span class='macro_popup'>((void)(rd))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="683"><td class="num" id="LN683">683</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="684"><td class="num" id="LN684">684</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="685"><td class="num" id="LN685">685</td><td class="line"><span class='comment'>/* Record unary bit.bnot, bit.bswap. */</span></td></tr>
<tr class="codeline" data-linenumber="686"><td class="num" id="LN686">686</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_bit_unary(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="687"><td class="num" id="LN687">687</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="688"><td class="num" id="LN688">688</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_HASFFI<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="689"><td class="num" id="LN689">689</td><td class="line">  <span class='keyword'>if</span> (recff_bit64_unary(J, rd))</td></tr>
<tr class="codeline" data-linenumber="690"><td class="num" id="LN690">690</td><td class="line">    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="691"><td class="num" id="LN691">691</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="692"><td class="num" id="LN692">692</td><td class="line">  J-&gt;base[0] = emitir(<span class='macro'>IRTI(rd-&gt;data)<span class='macro_popup'>(((uint32_t)((((rd-&gt;data))&lt;&lt;8) | (IRT_INT))))</span></span>, lj_opt_narrow_tobit(J, J-&gt;base[0]), 0);</td></tr>
<tr class="codeline" data-linenumber="693"><td class="num" id="LN693">693</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="694"><td class="num" id="LN694">694</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="695"><td class="num" id="LN695">695</td><td class="line"><span class='comment'>/* Record N-ary bit.band, bit.bor, bit.bxor. */</span></td></tr>
<tr class="codeline" data-linenumber="696"><td class="num" id="LN696">696</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_bit_nary(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="697"><td class="num" id="LN697">697</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="698"><td class="num" id="LN698">698</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_HASFFI<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="699"><td class="num" id="LN699">699</td><td class="line">  <span class='keyword'>if</span> (recff_bit64_nary(J, rd))</td></tr>
<tr class="codeline" data-linenumber="700"><td class="num" id="LN700">700</td><td class="line">    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="701"><td class="num" id="LN701">701</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="702"><td class="num" id="LN702">702</td><td class="line">  {</td></tr>
<tr class="codeline" data-linenumber="703"><td class="num" id="LN703">703</td><td class="line">    TRef tr = lj_opt_narrow_tobit(J, J-&gt;base[0]);</td></tr>
<tr class="codeline" data-linenumber="704"><td class="num" id="LN704">704</td><td class="line">    uint32_t ot = <span class='macro'>IRTI(rd-&gt;data)<span class='macro_popup'>(((uint32_t)((((rd-&gt;data))&lt;&lt;8) | (IRT_INT))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="705"><td class="num" id="LN705">705</td><td class="line">    BCReg i;</td></tr>
<tr class="codeline" data-linenumber="706"><td class="num" id="LN706">706</td><td class="line">    <span class='keyword'>for</span> (i = 1; J-&gt;base[i] != 0; i++)</td></tr>
<tr class="codeline" data-linenumber="707"><td class="num" id="LN707">707</td><td class="line">      tr = emitir(ot, tr, lj_opt_narrow_tobit(J, J-&gt;base[i]));</td></tr>
<tr class="codeline" data-linenumber="708"><td class="num" id="LN708">708</td><td class="line">    J-&gt;base[0] = tr;</td></tr>
<tr class="codeline" data-linenumber="709"><td class="num" id="LN709">709</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="710"><td class="num" id="LN710">710</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="711"><td class="num" id="LN711">711</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="712"><td class="num" id="LN712">712</td><td class="line"><span class='comment'>/* Record bit shifts. */</span></td></tr>
<tr class="codeline" data-linenumber="713"><td class="num" id="LN713">713</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_bit_shift(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="714"><td class="num" id="LN714">714</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="715"><td class="num" id="LN715">715</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_HASFFI<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="716"><td class="num" id="LN716">716</td><td class="line">  <span class='keyword'>if</span> (recff_bit64_shift(J, rd))</td></tr>
<tr class="codeline" data-linenumber="717"><td class="num" id="LN717">717</td><td class="line">    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="718"><td class="num" id="LN718">718</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="719"><td class="num" id="LN719">719</td><td class="line">  {</td></tr>
<tr class="codeline" data-linenumber="720"><td class="num" id="LN720">720</td><td class="line">    TRef tr = lj_opt_narrow_tobit(J, J-&gt;base[0]);</td></tr>
<tr class="codeline" data-linenumber="721"><td class="num" id="LN721">721</td><td class="line">    TRef tsh = lj_opt_narrow_tobit(J, J-&gt;base[1]);</td></tr>
<tr class="codeline" data-linenumber="722"><td class="num" id="LN722">722</td><td class="line">    IROp op = (IROp)rd-&gt;data;</td></tr>
<tr class="codeline" data-linenumber="723"><td class="num" id="LN723">723</td><td class="line">    <span class='keyword'>if</span> (!(op &lt; IR_BROL ? <span class='macro'>LJ_TARGET_MASKSHIFT<span class='macro_popup'>1</span></span> : <span class='macro'>LJ_TARGET_MASKROT<span class='macro_popup'>1</span></span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="724"><td class="num" id="LN724">724</td><td class="line">	!<span class='macro'>tref_isk(tsh)<span class='macro_popup'>(((((IRRef1)((tsh)))) &lt; REF_BIAS))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="725"><td class="num" id="LN725">725</td><td class="line">      tsh = emitir(<span class='macro'>IRTI(IR_BAND)<span class='macro_popup'>(((uint32_t)((((IR_BAND))&lt;&lt;8) | (IRT_INT))))</span></span>, tsh, lj_ir_kint(J, 31));</td></tr>
<tr class="codeline" data-linenumber="726"><td class="num" id="LN726">726</td><td class="line"><span class='directive'>#ifdef LJ_TARGET_UNIFYROT</span></td></tr>
<tr class="codeline" data-linenumber="727"><td class="num" id="LN727">727</td><td class="line">    <span class='keyword'>if</span> (op == (LJ_TARGET_UNIFYROT == 1 ? IR_BROR : IR_BROL)) {</td></tr>
<tr class="codeline" data-linenumber="728"><td class="num" id="LN728">728</td><td class="line">      op = LJ_TARGET_UNIFYROT == 1 ? IR_BROL : IR_BROR;</td></tr>
<tr class="codeline" data-linenumber="729"><td class="num" id="LN729">729</td><td class="line">      tsh = emitir(<span class='macro'>IRTI(IR_NEG)<span class='macro_popup'>(((uint32_t)((((IR_NEG))&lt;&lt;8) | (IRT_INT))))</span></span>, tsh, tsh);</td></tr>
<tr class="codeline" data-linenumber="730"><td class="num" id="LN730">730</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="731"><td class="num" id="LN731">731</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="732"><td class="num" id="LN732">732</td><td class="line">    J-&gt;base[0] = emitir(<span class='macro'>IRTI(op)<span class='macro_popup'>(((uint32_t)((((op))&lt;&lt;8) | (IRT_INT))))</span></span>, tr, tsh);</td></tr>
<tr class="codeline" data-linenumber="733"><td class="num" id="LN733">733</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="734"><td class="num" id="LN734">734</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="735"><td class="num" id="LN735">735</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="736"><td class="num" id="LN736">736</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_bit_tohex(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="737"><td class="num" id="LN737">737</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="738"><td class="num" id="LN738">738</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_HASFFI<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="739"><td class="num" id="LN739">739</td><td class="line">  TRef hdr = recff_bufhdr(J);</td></tr>
<tr class="codeline" data-linenumber="740"><td class="num" id="LN740">740</td><td class="line">  TRef tr = recff_bit64_tohex(J, rd, hdr);</td></tr>
<tr class="codeline" data-linenumber="741"><td class="num" id="LN741">741</td><td class="line">  J-&gt;base[0] = emitir(<span class='macro'>IRT(IR_BUFSTR, IRT_STR)<span class='macro_popup'>((uint32_t)(((IR_BUFSTR)&lt;&lt;8) | (IRT_STR)))</span></span>, tr, hdr);</td></tr>
<tr class="codeline" data-linenumber="742"><td class="num" id="LN742">742</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="743"><td class="num" id="LN743">743</td><td class="line">  <span class='macro'>recff_nyiu<span class='macro_popup'>recff_nyi</span></span>(J, rd);  <span class='comment'>/* Don't bother working around this NYI. */</span></td></tr>
<tr class="codeline" data-linenumber="744"><td class="num" id="LN744">744</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="745"><td class="num" id="LN745">745</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="746"><td class="num" id="LN746">746</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="747"><td class="num" id="LN747">747</td><td class="line"><span class='comment'>/* -- String library fast functions --------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="748"><td class="num" id="LN748">748</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="749"><td class="num" id="LN749">749</td><td class="line"><span class='comment'>/* Specialize to relative starting position for string. */</span></td></tr>
<tr class="codeline" data-linenumber="750"><td class="num" id="LN750">750</td><td class="line"><span class='keyword'>static</span> TRef recff_string_start(jit_State *J, GCstr *s, int32_t *st, TRef tr,</td></tr>
<tr class="codeline" data-linenumber="751"><td class="num" id="LN751">751</td><td class="line">			       TRef trlen, TRef tr0)</td></tr>
<tr class="codeline" data-linenumber="752"><td class="num" id="LN752">752</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="753"><td class="num" id="LN753">753</td><td class="line">  int32_t start = *st;</td></tr>
<tr class="codeline" data-linenumber="754"><td class="num" id="LN754">754</td><td class="line">  <span class='keyword'>if</span> (start &lt; 0) {</td></tr>
<tr class="codeline" data-linenumber="755"><td class="num" id="LN755">755</td><td class="line">    emitir(<span class='macro'>IRTGI(IR_LT)<span class='macro_popup'>(((uint32_t)((((IR_LT))&lt;&lt;8) | (IRT_GUARD|IRT_INT))))</span></span>, tr, tr0);</td></tr>
<tr class="codeline" data-linenumber="756"><td class="num" id="LN756">756</td><td class="line">    tr = emitir(<span class='macro'>IRTI(IR_ADD)<span class='macro_popup'>(((uint32_t)((((IR_ADD))&lt;&lt;8) | (IRT_INT))))</span></span>, trlen, tr);</td></tr>
<tr class="codeline" data-linenumber="757"><td class="num" id="LN757">757</td><td class="line">    start = start + (int32_t)s-&gt;len;</td></tr>
<tr class="codeline" data-linenumber="758"><td class="num" id="LN758">758</td><td class="line">    emitir(start &lt; 0 ? <span class='macro'>IRTGI(IR_LT)<span class='macro_popup'>(((uint32_t)((((IR_LT))&lt;&lt;8) | (IRT_GUARD|IRT_INT))))</span></span> : <span class='macro'>IRTGI(IR_GE)<span class='macro_popup'>(((uint32_t)((((IR_GE))&lt;&lt;8) | (IRT_GUARD|IRT_INT))))</span></span>, tr, tr0);</td></tr>
<tr class="codeline" data-linenumber="759"><td class="num" id="LN759">759</td><td class="line">    <span class='keyword'>if</span> (start &lt; 0) {</td></tr>
<tr class="codeline" data-linenumber="760"><td class="num" id="LN760">760</td><td class="line">      tr = tr0;</td></tr>
<tr class="codeline" data-linenumber="761"><td class="num" id="LN761">761</td><td class="line">      start = 0;</td></tr>
<tr class="codeline" data-linenumber="762"><td class="num" id="LN762">762</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="763"><td class="num" id="LN763">763</td><td class="line">  } <span class='keyword'>else</span> <span class='keyword'>if</span> (start == 0) {</td></tr>
<tr class="codeline" data-linenumber="764"><td class="num" id="LN764">764</td><td class="line">    emitir(<span class='macro'>IRTGI(IR_EQ)<span class='macro_popup'>(((uint32_t)((((IR_EQ))&lt;&lt;8) | (IRT_GUARD|IRT_INT))))</span></span>, tr, tr0);</td></tr>
<tr class="codeline" data-linenumber="765"><td class="num" id="LN765">765</td><td class="line">    tr = tr0;</td></tr>
<tr class="codeline" data-linenumber="766"><td class="num" id="LN766">766</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="767"><td class="num" id="LN767">767</td><td class="line">    tr = emitir(<span class='macro'>IRTI(IR_ADD)<span class='macro_popup'>(((uint32_t)((((IR_ADD))&lt;&lt;8) | (IRT_INT))))</span></span>, tr, lj_ir_kint(J, -1));</td></tr>
<tr class="codeline" data-linenumber="768"><td class="num" id="LN768">768</td><td class="line">    emitir(<span class='macro'>IRTGI(IR_GE)<span class='macro_popup'>(((uint32_t)((((IR_GE))&lt;&lt;8) | (IRT_GUARD|IRT_INT))))</span></span>, tr, tr0);</td></tr>
<tr class="codeline" data-linenumber="769"><td class="num" id="LN769">769</td><td class="line">    start--;</td></tr>
<tr class="codeline" data-linenumber="770"><td class="num" id="LN770">770</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="771"><td class="num" id="LN771">771</td><td class="line">  *st = start;</td></tr>
<tr class="codeline" data-linenumber="772"><td class="num" id="LN772">772</td><td class="line">  <span class='keyword'>return</span> tr;</td></tr>
<tr class="codeline" data-linenumber="773"><td class="num" id="LN773">773</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="774"><td class="num" id="LN774">774</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="775"><td class="num" id="LN775">775</td><td class="line"><span class='comment'>/* Handle string.byte (rd-&gt;data = 0) and string.sub (rd-&gt;data = 1). */</span></td></tr>
<tr class="codeline" data-linenumber="776"><td class="num" id="LN776">776</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_string_range(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="777"><td class="num" id="LN777">777</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="778"><td class="num" id="LN778">778</td><td class="line">  TRef trstr = lj_ir_tostr(J, J-&gt;base[0]);</td></tr>
<tr class="codeline" data-linenumber="779"><td class="num" id="LN779">779</td><td class="line">  TRef trlen = emitir(<span class='macro'>IRTI(IR_FLOAD)<span class='macro_popup'>(((uint32_t)((((IR_FLOAD))&lt;&lt;8) | (IRT_INT))))</span></span>, trstr, IRFL_STR_LEN);</td></tr>
<tr class="codeline" data-linenumber="780"><td class="num" id="LN780">780</td><td class="line">  TRef tr0 = lj_ir_kint(J, 0);</td></tr>
<tr class="codeline" data-linenumber="781"><td class="num" id="LN781">781</td><td class="line">  TRef trstart, trend;</td></tr>
<tr class="codeline" data-linenumber="782"><td class="num" id="LN782">782</td><td class="line">  GCstr *str = argv2str(J, &amp;rd-&gt;argv[0]);</td></tr>
<tr class="codeline" data-linenumber="783"><td class="num" id="LN783">783</td><td class="line">  int32_t start, end;</td></tr>
<tr class="codeline" data-linenumber="784"><td class="num" id="LN784">784</td><td class="line">  <span class='keyword'>if</span> (rd-&gt;data) {  <span class='comment'>/* string.sub(str, start [,end]) */</span></td></tr>
<tr class="codeline" data-linenumber="785"><td class="num" id="LN785">785</td><td class="line">    start = argv2int(J, &amp;rd-&gt;argv[1]);</td></tr>
<tr class="codeline" data-linenumber="786"><td class="num" id="LN786">786</td><td class="line">    trstart = lj_opt_narrow_toint(J, J-&gt;base[1]);</td></tr>
<tr class="codeline" data-linenumber="787"><td class="num" id="LN787">787</td><td class="line">    trend = J-&gt;base[2];</td></tr>
<tr class="codeline" data-linenumber="788"><td class="num" id="LN788">788</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>tref_isnil(trend)<span class='macro_popup'>(((((trend)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_NIL)&lt;&lt;<br>24)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="789"><td class="num" id="LN789">789</td><td class="line">      trend = lj_ir_kint(J, -1);</td></tr>
<tr class="codeline" data-linenumber="790"><td class="num" id="LN790">790</td><td class="line">      end = -1;</td></tr>
<tr class="codeline" data-linenumber="791"><td class="num" id="LN791">791</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="792"><td class="num" id="LN792">792</td><td class="line">      trend = lj_opt_narrow_toint(J, trend);</td></tr>
<tr class="codeline" data-linenumber="793"><td class="num" id="LN793">793</td><td class="line">      end = argv2int(J, &amp;rd-&gt;argv[2]);</td></tr>
<tr class="codeline" data-linenumber="794"><td class="num" id="LN794">794</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="795"><td class="num" id="LN795">795</td><td class="line">  } <span class='keyword'>else</span> {  <span class='comment'>/* string.byte(str, [,start [,end]]) */</span></td></tr>
<tr class="codeline" data-linenumber="796"><td class="num" id="LN796">796</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>tref_isnil(J-&gt;base[1])<span class='macro_popup'>(((((J-&gt;base[1])) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_NIL<br>)&lt;&lt;24)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="797"><td class="num" id="LN797">797</td><td class="line">      start = 1;</td></tr>
<tr class="codeline" data-linenumber="798"><td class="num" id="LN798">798</td><td class="line">      trstart = lj_ir_kint(J, 1);</td></tr>
<tr class="codeline" data-linenumber="799"><td class="num" id="LN799">799</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="800"><td class="num" id="LN800">800</td><td class="line">      start = argv2int(J, &amp;rd-&gt;argv[1]);</td></tr>
<tr class="codeline" data-linenumber="801"><td class="num" id="LN801">801</td><td class="line">      trstart = lj_opt_narrow_toint(J, J-&gt;base[1]);</td></tr>
<tr class="codeline" data-linenumber="802"><td class="num" id="LN802">802</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="803"><td class="num" id="LN803">803</td><td class="line">    <span class='keyword'>if</span> (J-&gt;base[1] &amp;&amp; !<span class='macro'>tref_isnil(J-&gt;base[2])<span class='macro_popup'>(((((J-&gt;base[2])) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_NIL<br>)&lt;&lt;24)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="804"><td class="num" id="LN804">804</td><td class="line">      trend = lj_opt_narrow_toint(J, J-&gt;base[2]);</td></tr>
<tr class="codeline" data-linenumber="805"><td class="num" id="LN805">805</td><td class="line">      end = argv2int(J, &amp;rd-&gt;argv[2]);</td></tr>
<tr class="codeline" data-linenumber="806"><td class="num" id="LN806">806</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="807"><td class="num" id="LN807">807</td><td class="line">      trend = trstart;</td></tr>
<tr class="codeline" data-linenumber="808"><td class="num" id="LN808">808</td><td class="line">      end = start;</td></tr>
<tr class="codeline" data-linenumber="809"><td class="num" id="LN809">809</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="810"><td class="num" id="LN810">810</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="811"><td class="num" id="LN811">811</td><td class="line">  <span class='keyword'>if</span> (end &lt; 0) {</td></tr>
<tr class="codeline" data-linenumber="812"><td class="num" id="LN812">812</td><td class="line">    emitir(<span class='macro'>IRTGI(IR_LT)<span class='macro_popup'>(((uint32_t)((((IR_LT))&lt;&lt;8) | (IRT_GUARD|IRT_INT))))</span></span>, trend, tr0);</td></tr>
<tr class="codeline" data-linenumber="813"><td class="num" id="LN813">813</td><td class="line">    trend = emitir(<span class='macro'>IRTI(IR_ADD)<span class='macro_popup'>(((uint32_t)((((IR_ADD))&lt;&lt;8) | (IRT_INT))))</span></span>, emitir(<span class='macro'>IRTI(IR_ADD)<span class='macro_popup'>(((uint32_t)((((IR_ADD))&lt;&lt;8) | (IRT_INT))))</span></span>, trlen, trend),</td></tr>
<tr class="codeline" data-linenumber="814"><td class="num" id="LN814">814</td><td class="line">		   lj_ir_kint(J, 1));</td></tr>
<tr class="codeline" data-linenumber="815"><td class="num" id="LN815">815</td><td class="line">    end = end+(int32_t)str-&gt;len+1;</td></tr>
<tr class="codeline" data-linenumber="816"><td class="num" id="LN816">816</td><td class="line">  } <span class='keyword'>else</span> <span class='keyword'>if</span> ((MSize)end &lt;= str-&gt;len) {</td></tr>
<tr class="codeline" data-linenumber="817"><td class="num" id="LN817">817</td><td class="line">    emitir(<span class='macro'>IRTGI(IR_ULE)<span class='macro_popup'>(((uint32_t)((((IR_ULE))&lt;&lt;8) | (IRT_GUARD|IRT_INT))))</span></span>, trend, trlen);</td></tr>
<tr class="codeline" data-linenumber="818"><td class="num" id="LN818">818</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="819"><td class="num" id="LN819">819</td><td class="line">    emitir(<span class='macro'>IRTGI(IR_UGT)<span class='macro_popup'>(((uint32_t)((((IR_UGT))&lt;&lt;8) | (IRT_GUARD|IRT_INT))))</span></span>, trend, trlen);</td></tr>
<tr class="codeline" data-linenumber="820"><td class="num" id="LN820">820</td><td class="line">    end = (int32_t)str-&gt;len;</td></tr>
<tr class="codeline" data-linenumber="821"><td class="num" id="LN821">821</td><td class="line">    trend = trlen;</td></tr>
<tr class="codeline" data-linenumber="822"><td class="num" id="LN822">822</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="823"><td class="num" id="LN823">823</td><td class="line">  trstart = recff_string_start(J, str, &amp;start, trstart, trlen, tr0);</td></tr>
<tr class="codeline" data-linenumber="824"><td class="num" id="LN824">824</td><td class="line">  <span class='keyword'>if</span> (rd-&gt;data) {  <span class='comment'>/* Return string.sub result. */</span></td></tr>
<tr class="codeline" data-linenumber="825"><td class="num" id="LN825">825</td><td class="line">    <span class='keyword'>if</span> (end - start &gt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="826"><td class="num" id="LN826">826</td><td class="line">      <span class='comment'>/* Also handle empty range here, to avoid extra traces. */</span></td></tr>
<tr class="codeline" data-linenumber="827"><td class="num" id="LN827">827</td><td class="line">      TRef trptr, trslen = emitir(<span class='macro'>IRTI(IR_SUB)<span class='macro_popup'>(((uint32_t)((((IR_SUB))&lt;&lt;8) | (IRT_INT))))</span></span>, trend, trstart);</td></tr>
<tr class="codeline" data-linenumber="828"><td class="num" id="LN828">828</td><td class="line">      emitir(<span class='macro'>IRTGI(IR_GE)<span class='macro_popup'>(((uint32_t)((((IR_GE))&lt;&lt;8) | (IRT_GUARD|IRT_INT))))</span></span>, trslen, tr0);</td></tr>
<tr class="codeline" data-linenumber="829"><td class="num" id="LN829">829</td><td class="line">      trptr = emitir(<span class='macro'>IRT(IR_STRREF, IRT_PGC)<span class='macro_popup'>((uint32_t)(((IR_STRREF)&lt;&lt;8) | (IRT_PGC)))</span></span>, trstr, trstart);</td></tr>
<tr class="codeline" data-linenumber="830"><td class="num" id="LN830">830</td><td class="line">      J-&gt;base[0] = emitir(<span class='macro'>IRT(IR_SNEW, IRT_STR)<span class='macro_popup'>((uint32_t)(((IR_SNEW)&lt;&lt;8) | (IRT_STR)))</span></span>, trptr, trslen);</td></tr>
<tr class="codeline" data-linenumber="831"><td class="num" id="LN831">831</td><td class="line">    } <span class='keyword'>else</span> {  <span class='comment'>/* Range underflow: return empty string. */</span></td></tr>
<tr class="codeline" data-linenumber="832"><td class="num" id="LN832">832</td><td class="line">      emitir(<span class='macro'>IRTGI(IR_LT)<span class='macro_popup'>(((uint32_t)((((IR_LT))&lt;&lt;8) | (IRT_GUARD|IRT_INT))))</span></span>, trend, trstart);</td></tr>
<tr class="codeline" data-linenumber="833"><td class="num" id="LN833">833</td><td class="line">      J-&gt;base[0] = <span class='macro'>lj_ir_kstr(J, &amp;J2G(J)-&gt;strempty)<span class='macro_popup'>lj_ir_kgc(J, ((GCobj *)((&amp;(&amp;((GG_State *)((char *)(J)<br> - ((int)__builtin_offsetof(GG_State, J))))-&gt;g)-&gt;strempty<br>))), IRT_STR)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="834"><td class="num" id="LN834">834</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="835"><td class="num" id="LN835">835</td><td class="line">  } <span class='keyword'>else</span> {  <span class='comment'>/* Return string.byte result(s). */</span></td></tr>
<tr class="codeline" data-linenumber="836"><td class="num" id="LN836">836</td><td class="line">    ptrdiff_t i, len = end - start;</td></tr>
<tr class="codeline" data-linenumber="837"><td class="num" id="LN837">837</td><td class="line">    <span class='keyword'>if</span> (len &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="838"><td class="num" id="LN838">838</td><td class="line">      TRef trslen = emitir(<span class='macro'>IRTI(IR_SUB)<span class='macro_popup'>(((uint32_t)((((IR_SUB))&lt;&lt;8) | (IRT_INT))))</span></span>, trend, trstart);</td></tr>
<tr class="codeline" data-linenumber="839"><td class="num" id="LN839">839</td><td class="line">      emitir(<span class='macro'>IRTGI(IR_EQ)<span class='macro_popup'>(((uint32_t)((((IR_EQ))&lt;&lt;8) | (IRT_GUARD|IRT_INT))))</span></span>, trslen, lj_ir_kint(J, (int32_t)len));</td></tr>
<tr class="codeline" data-linenumber="840"><td class="num" id="LN840">840</td><td class="line">      <span class='keyword'>if</span> (J-&gt;baseslot + len &gt; <span class='macro'>LJ_MAX_JSLOTS<span class='macro_popup'>250</span></span>)</td></tr>
<tr class="codeline" data-linenumber="841"><td class="num" id="LN841">841</td><td class="line">	lj_trace_err_info(J, LJ_TRERR_STACKOV);</td></tr>
<tr class="codeline" data-linenumber="842"><td class="num" id="LN842">842</td><td class="line">      rd-&gt;nres = len;</td></tr>
<tr class="codeline" data-linenumber="843"><td class="num" id="LN843">843</td><td class="line">      <span class='keyword'>for</span> (i = 0; i &lt; len; i++) {</td></tr>
<tr class="codeline" data-linenumber="844"><td class="num" id="LN844">844</td><td class="line">	TRef tmp = emitir(<span class='macro'>IRTI(IR_ADD)<span class='macro_popup'>(((uint32_t)((((IR_ADD))&lt;&lt;8) | (IRT_INT))))</span></span>, trstart, lj_ir_kint(J, (int32_t)i));</td></tr>
<tr class="codeline" data-linenumber="845"><td class="num" id="LN845">845</td><td class="line">	tmp = emitir(<span class='macro'>IRT(IR_STRREF, IRT_PGC)<span class='macro_popup'>((uint32_t)(((IR_STRREF)&lt;&lt;8) | (IRT_PGC)))</span></span>, trstr, tmp);</td></tr>
<tr class="codeline" data-linenumber="846"><td class="num" id="LN846">846</td><td class="line">	J-&gt;base[i] = emitir(<span class='macro'>IRT(IR_XLOAD, IRT_U8)<span class='macro_popup'>((uint32_t)(((IR_XLOAD)&lt;&lt;8) | (IRT_U8)))</span></span>, tmp, <span class='macro'>IRXLOAD_READONLY<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="847"><td class="num" id="LN847">847</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="848"><td class="num" id="LN848">848</td><td class="line">    } <span class='keyword'>else</span> {  <span class='comment'>/* Empty range or range underflow: return no results. */</span></td></tr>
<tr class="codeline" data-linenumber="849"><td class="num" id="LN849">849</td><td class="line">      emitir(<span class='macro'>IRTGI(IR_LE)<span class='macro_popup'>(((uint32_t)((((IR_LE))&lt;&lt;8) | (IRT_GUARD|IRT_INT))))</span></span>, trend, trstart);</td></tr>
<tr class="codeline" data-linenumber="850"><td class="num" id="LN850">850</td><td class="line">      rd-&gt;nres = 0;</td></tr>
<tr class="codeline" data-linenumber="851"><td class="num" id="LN851">851</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="852"><td class="num" id="LN852">852</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="853"><td class="num" id="LN853">853</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="854"><td class="num" id="LN854">854</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="855"><td class="num" id="LN855">855</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_string_char(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="856"><td class="num" id="LN856">856</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="857"><td class="num" id="LN857">857</td><td class="line">  TRef k255 = lj_ir_kint(J, 255);</td></tr>
<tr class="codeline" data-linenumber="858"><td class="num" id="LN858">858</td><td class="line">  BCReg i;</td></tr>
<tr class="codeline" data-linenumber="859"><td class="num" id="LN859">859</td><td class="line">  <span class='keyword'>for</span> (i = 0; J-&gt;base[i] != 0; i++) {  <span class='comment'>/* Convert char values to strings. */</span></td></tr>
<tr class="codeline" data-linenumber="860"><td class="num" id="LN860">860</td><td class="line">    TRef tr = lj_opt_narrow_toint(J, J-&gt;base[i]);</td></tr>
<tr class="codeline" data-linenumber="861"><td class="num" id="LN861">861</td><td class="line">    emitir(<span class='macro'>IRTGI(IR_ULE)<span class='macro_popup'>(((uint32_t)((((IR_ULE))&lt;&lt;8) | (IRT_GUARD|IRT_INT))))</span></span>, tr, k255);</td></tr>
<tr class="codeline" data-linenumber="862"><td class="num" id="LN862">862</td><td class="line">    J-&gt;base[i] = emitir(<span class='macro'>IRT(IR_TOSTR, IRT_STR)<span class='macro_popup'>((uint32_t)(((IR_TOSTR)&lt;&lt;8) | (IRT_STR)))</span></span>, tr, <span class='macro'>IRTOSTR_CHAR<span class='macro_popup'>2</span></span>);</td></tr>
<tr class="codeline" data-linenumber="863"><td class="num" id="LN863">863</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="864"><td class="num" id="LN864">864</td><td class="line">  <span class='keyword'>if</span> (i &gt; 1) {  <span class='comment'>/* Concatenate the strings, if there's more than one. */</span></td></tr>
<tr class="codeline" data-linenumber="865"><td class="num" id="LN865">865</td><td class="line">    TRef hdr = recff_bufhdr(J), tr = hdr;</td></tr>
<tr class="codeline" data-linenumber="866"><td class="num" id="LN866">866</td><td class="line">    <span class='keyword'>for</span> (i = 0; J-&gt;base[i] != 0; i++)</td></tr>
<tr class="codeline" data-linenumber="867"><td class="num" id="LN867">867</td><td class="line">      tr = emitir(<span class='macro'>IRT(IR_BUFPUT, IRT_PGC)<span class='macro_popup'>((uint32_t)(((IR_BUFPUT)&lt;&lt;8) | (IRT_PGC)))</span></span>, tr, J-&gt;base[i]);</td></tr>
<tr class="codeline" data-linenumber="868"><td class="num" id="LN868">868</td><td class="line">    J-&gt;base[0] = emitir(<span class='macro'>IRT(IR_BUFSTR, IRT_STR)<span class='macro_popup'>((uint32_t)(((IR_BUFSTR)&lt;&lt;8) | (IRT_STR)))</span></span>, tr, hdr);</td></tr>
<tr class="codeline" data-linenumber="869"><td class="num" id="LN869">869</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="870"><td class="num" id="LN870">870</td><td class="line">  <span class='macro'>UNUSED(rd)<span class='macro_popup'>((void)(rd))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="871"><td class="num" id="LN871">871</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="872"><td class="num" id="LN872">872</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="873"><td class="num" id="LN873">873</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_string_rep(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="874"><td class="num" id="LN874">874</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="875"><td class="num" id="LN875">875</td><td class="line">  TRef str = lj_ir_tostr(J, J-&gt;base[0]);</td></tr>
<tr class="codeline" data-linenumber="876"><td class="num" id="LN876">876</td><td class="line">  TRef rep = lj_opt_narrow_toint(J, J-&gt;base[1]);</td></tr>
<tr class="codeline" data-linenumber="877"><td class="num" id="LN877">877</td><td class="line">  TRef hdr, tr, str2 = 0;</td></tr>
<tr class="codeline" data-linenumber="878"><td class="num" id="LN878">878</td><td class="line">  <span class='keyword'>if</span> (!<span class='macro'>tref_isnil(J-&gt;base[2])<span class='macro_popup'>(((((J-&gt;base[2])) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_NIL<br>)&lt;&lt;24)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="879"><td class="num" id="LN879">879</td><td class="line">    TRef sep = lj_ir_tostr(J, J-&gt;base[2]);</td></tr>
<tr class="codeline" data-linenumber="880"><td class="num" id="LN880">880</td><td class="line">    int32_t vrep = argv2int(J, &amp;rd-&gt;argv[1]);</td></tr>
<tr class="codeline" data-linenumber="881"><td class="num" id="LN881">881</td><td class="line">    emitir(<span class='macro'>IRTGI(vrep &gt; 1 ? IR_GT : IR_LE)<span class='macro_popup'>(((uint32_t)((((vrep &gt; 1 ? IR_GT : IR_LE))&lt;&lt;8) | (IRT_GUARD<br>|IRT_INT))))</span></span>, rep, lj_ir_kint(J, 1));</td></tr>
<tr class="codeline" data-linenumber="882"><td class="num" id="LN882">882</td><td class="line">    <span class='keyword'>if</span> (vrep &gt; 1) {</td></tr>
<tr class="codeline" data-linenumber="883"><td class="num" id="LN883">883</td><td class="line">      TRef hdr2 = recff_bufhdr(J);</td></tr>
<tr class="codeline" data-linenumber="884"><td class="num" id="LN884">884</td><td class="line">      TRef tr2 = emitir(<span class='macro'>IRT(IR_BUFPUT, IRT_PGC)<span class='macro_popup'>((uint32_t)(((IR_BUFPUT)&lt;&lt;8) | (IRT_PGC)))</span></span>, hdr2, sep);</td></tr>
<tr class="codeline" data-linenumber="885"><td class="num" id="LN885">885</td><td class="line">      tr2 = emitir(<span class='macro'>IRT(IR_BUFPUT, IRT_PGC)<span class='macro_popup'>((uint32_t)(((IR_BUFPUT)&lt;&lt;8) | (IRT_PGC)))</span></span>, tr2, str);</td></tr>
<tr class="codeline" data-linenumber="886"><td class="num" id="LN886">886</td><td class="line">      str2 = emitir(<span class='macro'>IRT(IR_BUFSTR, IRT_STR)<span class='macro_popup'>((uint32_t)(((IR_BUFSTR)&lt;&lt;8) | (IRT_STR)))</span></span>, tr2, hdr2);</td></tr>
<tr class="codeline" data-linenumber="887"><td class="num" id="LN887">887</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="888"><td class="num" id="LN888">888</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="889"><td class="num" id="LN889">889</td><td class="line">  tr = hdr = recff_bufhdr(J);</td></tr>
<tr class="codeline" data-linenumber="890"><td class="num" id="LN890">890</td><td class="line">  <span class='keyword'>if</span> (str2) {</td></tr>
<tr class="codeline" data-linenumber="891"><td class="num" id="LN891">891</td><td class="line">    tr = emitir(<span class='macro'>IRT(IR_BUFPUT, IRT_PGC)<span class='macro_popup'>((uint32_t)(((IR_BUFPUT)&lt;&lt;8) | (IRT_PGC)))</span></span>, tr, str);</td></tr>
<tr class="codeline" data-linenumber="892"><td class="num" id="LN892">892</td><td class="line">    str = str2;</td></tr>
<tr class="codeline" data-linenumber="893"><td class="num" id="LN893">893</td><td class="line">    rep = emitir(<span class='macro'>IRTI(IR_ADD)<span class='macro_popup'>(((uint32_t)((((IR_ADD))&lt;&lt;8) | (IRT_INT))))</span></span>, rep, lj_ir_kint(J, -1));</td></tr>
<tr class="codeline" data-linenumber="894"><td class="num" id="LN894">894</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="895"><td class="num" id="LN895">895</td><td class="line">  tr = lj_ir_call(J, IRCALL_lj_buf_putstr_rep, tr, str, rep);</td></tr>
<tr class="codeline" data-linenumber="896"><td class="num" id="LN896">896</td><td class="line">  J-&gt;base[0] = emitir(<span class='macro'>IRT(IR_BUFSTR, IRT_STR)<span class='macro_popup'>((uint32_t)(((IR_BUFSTR)&lt;&lt;8) | (IRT_STR)))</span></span>, tr, hdr);</td></tr>
<tr class="codeline" data-linenumber="897"><td class="num" id="LN897">897</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="898"><td class="num" id="LN898">898</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="899"><td class="num" id="LN899">899</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_string_op(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="900"><td class="num" id="LN900">900</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="901"><td class="num" id="LN901">901</td><td class="line">  TRef str = lj_ir_tostr(J, J-&gt;base[0]);</td></tr>
<tr class="codeline" data-linenumber="902"><td class="num" id="LN902">902</td><td class="line">  TRef hdr = recff_bufhdr(J);</td></tr>
<tr class="codeline" data-linenumber="903"><td class="num" id="LN903">903</td><td class="line">  TRef tr = lj_ir_call(J, rd-&gt;data, hdr, str);</td></tr>
<tr class="codeline" data-linenumber="904"><td class="num" id="LN904">904</td><td class="line">  J-&gt;base[0] = emitir(<span class='macro'>IRT(IR_BUFSTR, IRT_STR)<span class='macro_popup'>((uint32_t)(((IR_BUFSTR)&lt;&lt;8) | (IRT_STR)))</span></span>, tr, hdr);</td></tr>
<tr class="codeline" data-linenumber="905"><td class="num" id="LN905">905</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="906"><td class="num" id="LN906">906</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="907"><td class="num" id="LN907">907</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_string_find(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="908"><td class="num" id="LN908">908</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="909"><td class="num" id="LN909">909</td><td class="line">  TRef trstr = lj_ir_tostr(J, J-&gt;base[0]);</td></tr>
<tr class="codeline" data-linenumber="910"><td class="num" id="LN910">910</td><td class="line">  TRef trpat = lj_ir_tostr(J, J-&gt;base[1]);</td></tr>
<tr class="codeline" data-linenumber="911"><td class="num" id="LN911">911</td><td class="line">  TRef trlen = emitir(<span class='macro'>IRTI(IR_FLOAD)<span class='macro_popup'>(((uint32_t)((((IR_FLOAD))&lt;&lt;8) | (IRT_INT))))</span></span>, trstr, IRFL_STR_LEN);</td></tr>
<tr class="codeline" data-linenumber="912"><td class="num" id="LN912">912</td><td class="line">  TRef tr0 = lj_ir_kint(J, 0);</td></tr>
<tr class="codeline" data-linenumber="913"><td class="num" id="LN913">913</td><td class="line">  TRef trstart;</td></tr>
<tr class="codeline" data-linenumber="914"><td class="num" id="LN914">914</td><td class="line">  GCstr *str = argv2str(J, &amp;rd-&gt;argv[0]);</td></tr>
<tr class="codeline" data-linenumber="915"><td class="num" id="LN915">915</td><td class="line">  GCstr *pat = argv2str(J, &amp;rd-&gt;argv[1]);</td></tr>
<tr class="codeline" data-linenumber="916"><td class="num" id="LN916">916</td><td class="line">  int32_t start;</td></tr>
<tr class="codeline" data-linenumber="917"><td class="num" id="LN917">917</td><td class="line">  J-&gt;needsnap = 1;</td></tr>
<tr class="codeline" data-linenumber="918"><td class="num" id="LN918">918</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>tref_isnil(J-&gt;base[2])<span class='macro_popup'>(((((J-&gt;base[2])) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_NIL<br>)&lt;&lt;24)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="919"><td class="num" id="LN919">919</td><td class="line">    trstart = lj_ir_kint(J, 1);</td></tr>
<tr class="codeline" data-linenumber="920"><td class="num" id="LN920">920</td><td class="line">    start = 1;</td></tr>
<tr class="codeline" data-linenumber="921"><td class="num" id="LN921">921</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="922"><td class="num" id="LN922">922</td><td class="line">    trstart = lj_opt_narrow_toint(J, J-&gt;base[2]);</td></tr>
<tr class="codeline" data-linenumber="923"><td class="num" id="LN923">923</td><td class="line">    start = argv2int(J, &amp;rd-&gt;argv[2]);</td></tr>
<tr class="codeline" data-linenumber="924"><td class="num" id="LN924">924</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="925"><td class="num" id="LN925">925</td><td class="line">  trstart = recff_string_start(J, str, &amp;start, trstart, trlen, tr0);</td></tr>
<tr class="codeline" data-linenumber="926"><td class="num" id="LN926">926</td><td class="line">  <span class='keyword'>if</span> ((MSize)start &lt;= str-&gt;len) {</td></tr>
<tr class="codeline" data-linenumber="927"><td class="num" id="LN927">927</td><td class="line">    emitir(<span class='macro'>IRTGI(IR_ULE)<span class='macro_popup'>(((uint32_t)((((IR_ULE))&lt;&lt;8) | (IRT_GUARD|IRT_INT))))</span></span>, trstart, trlen);</td></tr>
<tr class="codeline" data-linenumber="928"><td class="num" id="LN928">928</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="929"><td class="num" id="LN929">929</td><td class="line">    emitir(<span class='macro'>IRTGI(IR_UGT)<span class='macro_popup'>(((uint32_t)((((IR_UGT))&lt;&lt;8) | (IRT_GUARD|IRT_INT))))</span></span>, trstart, trlen);</td></tr>
<tr class="codeline" data-linenumber="930"><td class="num" id="LN930">930</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_52<span class='macro_popup'>0</span></span></span></td></tr>
<tr class="codeline" data-linenumber="931"><td class="num" id="LN931">931</td><td class="line">    J-&gt;base[0] = <span class='macro'>TREF_NIL<span class='macro_popup'>((((TRef)((REF_NIL-(IRT_NIL)) + (((IRT_NIL))&lt;&lt;24)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="932"><td class="num" id="LN932">932</td><td class="line">    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="933"><td class="num" id="LN933">933</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="934"><td class="num" id="LN934">934</td><td class="line">    trstart = trlen;</td></tr>
<tr class="codeline" data-linenumber="935"><td class="num" id="LN935">935</td><td class="line">    start = str-&gt;len;</td></tr>
<tr class="codeline" data-linenumber="936"><td class="num" id="LN936">936</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="937"><td class="num" id="LN937">937</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="938"><td class="num" id="LN938">938</td><td class="line">  <span class='comment'>/* Fixed arg or no pattern matching chars? (Specialized to pattern string.) */</span></td></tr>
<tr class="codeline" data-linenumber="939"><td class="num" id="LN939">939</td><td class="line">  <span class='keyword'>if</span> ((J-&gt;base[2] &amp;&amp; <span class='macro'>tref_istruecond(J-&gt;base[3])<span class='macro_popup'>(!(((((J-&gt;base[3]))&gt;&gt;24) &amp; IRT_TYPE) - (TRef)(IRT_NIL<br>) &lt;= (TRef)(IRT_FALSE-IRT_NIL)))</span></span>) ||</td></tr>
<tr class="codeline" data-linenumber="940"><td class="num" id="LN940">940</td><td class="line">      (emitir(<span class='macro'>IRTG(IR_EQ, IRT_STR)<span class='macro_popup'>(((uint32_t)((((IR_EQ))&lt;&lt;8) | (IRT_GUARD|(IRT_STR)))))</span></span>, trpat, <span class='macro'>lj_ir_kstr(J, pat)<span class='macro_popup'>lj_ir_kgc(J, ((GCobj *)((pat))), IRT_STR)</span></span>),</td></tr>
<tr class="codeline" data-linenumber="941"><td class="num" id="LN941">941</td><td class="line">       !lj_str_haspattern(pat))) {  <span class='comment'>/* Search for fixed string. */</span></td></tr>
<tr class="codeline" data-linenumber="942"><td class="num" id="LN942">942</td><td class="line">    TRef trsptr = emitir(<span class='macro'>IRT(IR_STRREF, IRT_PGC)<span class='macro_popup'>((uint32_t)(((IR_STRREF)&lt;&lt;8) | (IRT_PGC)))</span></span>, trstr, trstart);</td></tr>
<tr class="codeline" data-linenumber="943"><td class="num" id="LN943">943</td><td class="line">    TRef trpptr = emitir(<span class='macro'>IRT(IR_STRREF, IRT_PGC)<span class='macro_popup'>((uint32_t)(((IR_STRREF)&lt;&lt;8) | (IRT_PGC)))</span></span>, trpat, tr0);</td></tr>
<tr class="codeline" data-linenumber="944"><td class="num" id="LN944">944</td><td class="line">    TRef trslen = emitir(<span class='macro'>IRTI(IR_SUB)<span class='macro_popup'>(((uint32_t)((((IR_SUB))&lt;&lt;8) | (IRT_INT))))</span></span>, trlen, trstart);</td></tr>
<tr class="codeline" data-linenumber="945"><td class="num" id="LN945">945</td><td class="line">    TRef trplen = emitir(<span class='macro'>IRTI(IR_FLOAD)<span class='macro_popup'>(((uint32_t)((((IR_FLOAD))&lt;&lt;8) | (IRT_INT))))</span></span>, trpat, IRFL_STR_LEN);</td></tr>
<tr class="codeline" data-linenumber="946"><td class="num" id="LN946">946</td><td class="line">    TRef tr = lj_ir_call(J, IRCALL_lj_str_find, trsptr, trpptr, trslen, trplen);</td></tr>
<tr class="codeline" data-linenumber="947"><td class="num" id="LN947">947</td><td class="line">    TRef trp0 = <span class='macro'>lj_ir_kkptr(J, NULL)<span class='macro_popup'>lj_ir_kptr_(J, IR_KKPTR, (((void*)0)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="948"><td class="num" id="LN948">948</td><td class="line">    <span class='keyword'>if</span> (lj_str_find(<span class='macro'>strdata(str)<span class='macro_popup'>((const char *)((str)+1))</span></span>+(MSize)start, <span class='macro'>strdata(pat)<span class='macro_popup'>((const char *)((pat)+1))</span></span>,</td></tr>
<tr class="codeline" data-linenumber="949"><td class="num" id="LN949">949</td><td class="line">		    str-&gt;len-(MSize)start, pat-&gt;len)) {</td></tr>
<tr class="codeline" data-linenumber="950"><td class="num" id="LN950">950</td><td class="line">      TRef pos;</td></tr>
<tr class="codeline" data-linenumber="951"><td class="num" id="LN951">951</td><td class="line">      emitir(<span class='macro'>IRTG(IR_NE, IRT_PGC)<span class='macro_popup'>(((uint32_t)((((IR_NE))&lt;&lt;8) | (IRT_GUARD|(IRT_PGC)))))</span></span>, tr, trp0);</td></tr>
<tr class="codeline" data-linenumber="952"><td class="num" id="LN952">952</td><td class="line">      pos = emitir(<span class='macro'>IRTI(IR_SUB)<span class='macro_popup'>(((uint32_t)((((IR_SUB))&lt;&lt;8) | (IRT_INT))))</span></span>, tr, emitir(<span class='macro'>IRT(IR_STRREF, IRT_PGC)<span class='macro_popup'>((uint32_t)(((IR_STRREF)&lt;&lt;8) | (IRT_PGC)))</span></span>, trstr, tr0));</td></tr>
<tr class="codeline" data-linenumber="953"><td class="num" id="LN953">953</td><td class="line">      J-&gt;base[0] = emitir(<span class='macro'>IRTI(IR_ADD)<span class='macro_popup'>(((uint32_t)((((IR_ADD))&lt;&lt;8) | (IRT_INT))))</span></span>, pos, lj_ir_kint(J, 1));</td></tr>
<tr class="codeline" data-linenumber="954"><td class="num" id="LN954">954</td><td class="line">      J-&gt;base[1] = emitir(<span class='macro'>IRTI(IR_ADD)<span class='macro_popup'>(((uint32_t)((((IR_ADD))&lt;&lt;8) | (IRT_INT))))</span></span>, pos, trplen);</td></tr>
<tr class="codeline" data-linenumber="955"><td class="num" id="LN955">955</td><td class="line">      rd-&gt;nres = 2;</td></tr>
<tr class="codeline" data-linenumber="956"><td class="num" id="LN956">956</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="957"><td class="num" id="LN957">957</td><td class="line">      emitir(<span class='macro'>IRTG(IR_EQ, IRT_PGC)<span class='macro_popup'>(((uint32_t)((((IR_EQ))&lt;&lt;8) | (IRT_GUARD|(IRT_PGC)))))</span></span>, tr, trp0);</td></tr>
<tr class="codeline" data-linenumber="958"><td class="num" id="LN958">958</td><td class="line">      J-&gt;base[0] = <span class='macro'>TREF_NIL<span class='macro_popup'>((((TRef)((REF_NIL-(IRT_NIL)) + (((IRT_NIL))&lt;&lt;24)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="959"><td class="num" id="LN959">959</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="960"><td class="num" id="LN960">960</td><td class="line">  } <span class='keyword'>else</span> {  <span class='comment'>/* Search for pattern. */</span></td></tr>
<tr class="codeline" data-linenumber="961"><td class="num" id="LN961">961</td><td class="line">    <span class='macro'>recff_nyiu<span class='macro_popup'>recff_nyi</span></span>(J, rd);</td></tr>
<tr class="codeline" data-linenumber="962"><td class="num" id="LN962">962</td><td class="line">    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="963"><td class="num" id="LN963">963</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="964"><td class="num" id="LN964">964</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="965"><td class="num" id="LN965">965</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="966"><td class="num" id="LN966">966</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_string_format(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="967"><td class="num" id="LN967">967</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="968"><td class="num" id="LN968">968</td><td class="line">  TRef trfmt = lj_ir_tostr(J, J-&gt;base[0]);</td></tr>
<tr class="codeline" data-linenumber="969"><td class="num" id="LN969">969</td><td class="line">  GCstr *fmt = argv2str(J, &amp;rd-&gt;argv[0]);</td></tr>
<tr class="codeline" data-linenumber="970"><td class="num" id="LN970">970</td><td class="line">  <span class='keyword'>int</span> arg = 1;</td></tr>
<tr class="codeline" data-linenumber="971"><td class="num" id="LN971">971</td><td class="line">  TRef hdr, tr;</td></tr>
<tr class="codeline" data-linenumber="972"><td class="num" id="LN972">972</td><td class="line">  FormatState fs;</td></tr>
<tr class="codeline" data-linenumber="973"><td class="num" id="LN973">973</td><td class="line">  SFormat sf;</td></tr>
<tr class="codeline" data-linenumber="974"><td class="num" id="LN974">974</td><td class="line">  <span class='comment'>/* Specialize to the format string. */</span></td></tr>
<tr class="codeline" data-linenumber="975"><td class="num" id="LN975">975</td><td class="line">  emitir(<span class='macro'>IRTG(IR_EQ, IRT_STR)<span class='macro_popup'>(((uint32_t)((((IR_EQ))&lt;&lt;8) | (IRT_GUARD|(IRT_STR)))))</span></span>, trfmt, <span class='macro'>lj_ir_kstr(J, fmt)<span class='macro_popup'>lj_ir_kgc(J, ((GCobj *)((fmt))), IRT_STR)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="976"><td class="num" id="LN976">976</td><td class="line">  tr = hdr = recff_bufhdr(J);</td></tr>
<tr class="codeline" data-linenumber="977"><td class="num" id="LN977">977</td><td class="line">  lj_strfmt_init(&amp;fs, <span class='macro'>strdata(fmt)<span class='macro_popup'>((const char *)((fmt)+1))</span></span>, fmt-&gt;len);</td></tr>
<tr class="codeline" data-linenumber="978"><td class="num" id="LN978">978</td><td class="line">  <span class='keyword'>while</span> ((sf = lj_strfmt_parse(&amp;fs)) != STRFMT_EOF) {  <span class='comment'>/* Parse format. */</span></td></tr>
<tr class="codeline" data-linenumber="979"><td class="num" id="LN979">979</td><td class="line">    TRef tra = sf == STRFMT_LIT ? 0 : J-&gt;base[arg++];</td></tr>
<tr class="codeline" data-linenumber="980"><td class="num" id="LN980">980</td><td class="line">    TRef trsf = lj_ir_kint(J, (int32_t)sf);</td></tr>
<tr class="codeline" data-linenumber="981"><td class="num" id="LN981">981</td><td class="line">    IRCallID id;</td></tr>
<tr class="codeline" data-linenumber="982"><td class="num" id="LN982">982</td><td class="line">    <span class='keyword'>switch</span> (<span class='macro'>STRFMT_TYPE(sf)<span class='macro_popup'>((FormatType)((sf) &amp; 15))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="983"><td class="num" id="LN983">983</td><td class="line">    <span class='keyword'>case</span> STRFMT_LIT:</td></tr>
<tr class="codeline" data-linenumber="984"><td class="num" id="LN984">984</td><td class="line">      tr = emitir(<span class='macro'>IRT(IR_BUFPUT, IRT_PGC)<span class='macro_popup'>((uint32_t)(((IR_BUFPUT)&lt;&lt;8) | (IRT_PGC)))</span></span>, tr,</td></tr>
<tr class="codeline" data-linenumber="985"><td class="num" id="LN985">985</td><td class="line">		  <span class='macro'>lj_ir_kstr(J, lj_str_new(J-&gt;L, fs.str, fs.len))<span class='macro_popup'>lj_ir_kgc(J, ((GCobj *)((lj_str_new(J-&gt;L, fs.str, fs.len))<br>)), IRT_STR)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="986"><td class="num" id="LN986">986</td><td class="line">      <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="987"><td class="num" id="LN987">987</td><td class="line">    <span class='keyword'>case</span> STRFMT_INT:</td></tr>
<tr class="codeline" data-linenumber="988"><td class="num" id="LN988">988</td><td class="line">      id = IRCALL_lj_strfmt_putfnum_int;</td></tr>
<tr class="codeline" data-linenumber="989"><td class="num" id="LN989">989</td><td class="line">    handle_int:</td></tr>
<tr class="codeline" data-linenumber="990"><td class="num" id="LN990">990</td><td class="line">      <span class='keyword'>if</span> (!<span class='macro'>tref_isinteger(tra)<span class='macro_popup'>((((((tra))&gt;&gt;24) &amp; IRT_TYPE) - (TRef)(IRT_I8) &lt;=<br> (TRef)(IRT_INT-IRT_I8)))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="991"><td class="num" id="LN991">991</td><td class="line">	<span class='keyword'>goto</span> handle_num;</td></tr>
<tr class="codeline" data-linenumber="992"><td class="num" id="LN992">992</td><td class="line">      <span class='keyword'>if</span> (sf == STRFMT_INT) { <span class='comment'>/* Shortcut for plain %d. */</span></td></tr>
<tr class="codeline" data-linenumber="993"><td class="num" id="LN993">993</td><td class="line">	tr = emitir(<span class='macro'>IRT(IR_BUFPUT, IRT_PGC)<span class='macro_popup'>((uint32_t)(((IR_BUFPUT)&lt;&lt;8) | (IRT_PGC)))</span></span>, tr,</td></tr>
<tr class="codeline" data-linenumber="994"><td class="num" id="LN994">994</td><td class="line">		    emitir(<span class='macro'>IRT(IR_TOSTR, IRT_STR)<span class='macro_popup'>((uint32_t)(((IR_TOSTR)&lt;&lt;8) | (IRT_STR)))</span></span>, tra, <span class='macro'>IRTOSTR_INT<span class='macro_popup'>0</span></span>));</td></tr>
<tr class="codeline" data-linenumber="995"><td class="num" id="LN995">995</td><td class="line">      } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="996"><td class="num" id="LN996">996</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_HASFFI<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="997"><td class="num" id="LN997">997</td><td class="line">	tra = emitir(<span class='macro'>IRT(IR_CONV, IRT_U64)<span class='macro_popup'>((uint32_t)(((IR_CONV)&lt;&lt;8) | (IRT_U64)))</span></span>, tra,</td></tr>
<tr class="codeline" data-linenumber="998"><td class="num" id="LN998">998</td><td class="line">		     (IRT_INT|(IRT_U64&lt;&lt;5)|<span class='macro'>IRCONV_SEXT<span class='macro_popup'>0x0800</span></span>));</td></tr>
<tr class="codeline" data-linenumber="999"><td class="num" id="LN999">999</td><td class="line">	tr = lj_ir_call(J, IRCALL_lj_strfmt_putfxint, tr, trsf, tra);</td></tr>
<tr class="codeline" data-linenumber="1000"><td class="num" id="LN1000">1000</td><td class="line">	<span class='macro'>lj_needsplit(J)<span class='macro_popup'>((void)(J))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1001"><td class="num" id="LN1001">1001</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="1002"><td class="num" id="LN1002">1002</td><td class="line">	<span class='macro'>recff_nyiu<span class='macro_popup'>recff_nyi</span></span>(J, rd);  <span class='comment'>/* Don't bother working around this NYI. */</span></td></tr>
<tr class="codeline" data-linenumber="1003"><td class="num" id="LN1003">1003</td><td class="line">	<span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1004"><td class="num" id="LN1004">1004</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1005"><td class="num" id="LN1005">1005</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="1006"><td class="num" id="LN1006">1006</td><td class="line">      <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1007"><td class="num" id="LN1007">1007</td><td class="line">    <span class='keyword'>case</span> STRFMT_UINT:</td></tr>
<tr class="codeline" data-linenumber="1008"><td class="num" id="LN1008">1008</td><td class="line">      id = IRCALL_lj_strfmt_putfnum_uint;</td></tr>
<tr class="codeline" data-linenumber="1009"><td class="num" id="LN1009">1009</td><td class="line">      <span class='keyword'>goto</span> handle_int;</td></tr>
<tr class="codeline" data-linenumber="1010"><td class="num" id="LN1010">1010</td><td class="line">    <span class='keyword'>case</span> STRFMT_NUM:</td></tr>
<tr class="codeline" data-linenumber="1011"><td class="num" id="LN1011">1011</td><td class="line">      id = IRCALL_lj_strfmt_putfnum;</td></tr>
<tr class="codeline" data-linenumber="1012"><td class="num" id="LN1012">1012</td><td class="line">    handle_num:</td></tr>
<tr class="codeline" data-linenumber="1013"><td class="num" id="LN1013">1013</td><td class="line">      tra = lj_ir_tonum(J, tra);</td></tr>
<tr class="codeline" data-linenumber="1014"><td class="num" id="LN1014">1014</td><td class="line">      tr = lj_ir_call(J, id, tr, trsf, tra);</td></tr>
<tr class="codeline" data-linenumber="1015"><td class="num" id="LN1015">1015</td><td class="line">      <span class='keyword'>if</span> (<span class='macro'>LJ_SOFTFP<span class='macro_popup'>(!1)</span></span>) <span class='macro'>lj_needsplit(J)<span class='macro_popup'>((void)(J))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1016"><td class="num" id="LN1016">1016</td><td class="line">      <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1017"><td class="num" id="LN1017">1017</td><td class="line">    <span class='keyword'>case</span> STRFMT_STR:</td></tr>
<tr class="codeline" data-linenumber="1018"><td class="num" id="LN1018">1018</td><td class="line">      <span class='keyword'>if</span> (!<span class='macro'>tref_isstr(tra)<span class='macro_popup'>(((((tra)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_STR)&lt;&lt;24<br>)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1019"><td class="num" id="LN1019">1019</td><td class="line">	<span class='macro'>recff_nyiu<span class='macro_popup'>recff_nyi</span></span>(J, rd);  <span class='comment'>/* NYI: __tostring and non-string types for %s. */</span></td></tr>
<tr class="codeline" data-linenumber="1020"><td class="num" id="LN1020">1020</td><td class="line">	<span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1021"><td class="num" id="LN1021">1021</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="1022"><td class="num" id="LN1022">1022</td><td class="line">      <span class='keyword'>if</span> (sf == STRFMT_STR)  <span class='comment'>/* Shortcut for plain %s. */</span></td></tr>
<tr class="codeline" data-linenumber="1023"><td class="num" id="LN1023">1023</td><td class="line">	tr = emitir(<span class='macro'>IRT(IR_BUFPUT, IRT_PGC)<span class='macro_popup'>((uint32_t)(((IR_BUFPUT)&lt;&lt;8) | (IRT_PGC)))</span></span>, tr, tra);</td></tr>
<tr class="codeline" data-linenumber="1024"><td class="num" id="LN1024">1024</td><td class="line">      <span class='keyword'>else</span> <span class='keyword'>if</span> ((sf &amp; <span class='macro'>STRFMT_T_QUOTED<span class='macro_popup'>0x0010</span></span>))</td></tr>
<tr class="codeline" data-linenumber="1025"><td class="num" id="LN1025">1025</td><td class="line">	tr = lj_ir_call(J, IRCALL_lj_strfmt_putquoted, tr, tra);</td></tr>
<tr class="codeline" data-linenumber="1026"><td class="num" id="LN1026">1026</td><td class="line">      <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1027"><td class="num" id="LN1027">1027</td><td class="line">	tr = lj_ir_call(J, IRCALL_lj_strfmt_putfstr, tr, trsf, tra);</td></tr>
<tr class="codeline" data-linenumber="1028"><td class="num" id="LN1028">1028</td><td class="line">      <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1029"><td class="num" id="LN1029">1029</td><td class="line">    <span class='keyword'>case</span> STRFMT_CHAR:</td></tr>
<tr class="codeline" data-linenumber="1030"><td class="num" id="LN1030">1030</td><td class="line">      tra = lj_opt_narrow_toint(J, tra);</td></tr>
<tr class="codeline" data-linenumber="1031"><td class="num" id="LN1031">1031</td><td class="line">      <span class='keyword'>if</span> (sf == STRFMT_CHAR)  <span class='comment'>/* Shortcut for plain %c. */</span></td></tr>
<tr class="codeline" data-linenumber="1032"><td class="num" id="LN1032">1032</td><td class="line">	tr = emitir(<span class='macro'>IRT(IR_BUFPUT, IRT_PGC)<span class='macro_popup'>((uint32_t)(((IR_BUFPUT)&lt;&lt;8) | (IRT_PGC)))</span></span>, tr,</td></tr>
<tr class="codeline" data-linenumber="1033"><td class="num" id="LN1033">1033</td><td class="line">		    emitir(<span class='macro'>IRT(IR_TOSTR, IRT_STR)<span class='macro_popup'>((uint32_t)(((IR_TOSTR)&lt;&lt;8) | (IRT_STR)))</span></span>, tra, <span class='macro'>IRTOSTR_CHAR<span class='macro_popup'>2</span></span>));</td></tr>
<tr class="codeline" data-linenumber="1034"><td class="num" id="LN1034">1034</td><td class="line">      <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1035"><td class="num" id="LN1035">1035</td><td class="line">	tr = lj_ir_call(J, IRCALL_lj_strfmt_putfchar, tr, trsf, tra);</td></tr>
<tr class="codeline" data-linenumber="1036"><td class="num" id="LN1036">1036</td><td class="line">      <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1037"><td class="num" id="LN1037">1037</td><td class="line">    <span class='keyword'>case</span> STRFMT_PTR:  <span class='comment'>/* NYI */</span></td></tr>
<tr class="codeline" data-linenumber="1038"><td class="num" id="LN1038">1038</td><td class="line">    <span class='keyword'>case</span> STRFMT_ERR:</td></tr>
<tr class="codeline" data-linenumber="1039"><td class="num" id="LN1039">1039</td><td class="line">    <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="1040"><td class="num" id="LN1040">1040</td><td class="line">      <span class='macro'>recff_nyiu<span class='macro_popup'>recff_nyi</span></span>(J, rd);</td></tr>
<tr class="codeline" data-linenumber="1041"><td class="num" id="LN1041">1041</td><td class="line">      <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1042"><td class="num" id="LN1042">1042</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1043"><td class="num" id="LN1043">1043</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="1044"><td class="num" id="LN1044">1044</td><td class="line">  J-&gt;base[0] = emitir(<span class='macro'>IRT(IR_BUFSTR, IRT_STR)<span class='macro_popup'>((uint32_t)(((IR_BUFSTR)&lt;&lt;8) | (IRT_STR)))</span></span>, tr, hdr);</td></tr>
<tr class="codeline" data-linenumber="1045"><td class="num" id="LN1045">1045</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1046"><td class="num" id="LN1046">1046</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1047"><td class="num" id="LN1047">1047</td><td class="line"><span class='comment'>/* -- Table library fast functions ---------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="1048"><td class="num" id="LN1048">1048</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1049"><td class="num" id="LN1049">1049</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_table_insert(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="1050"><td class="num" id="LN1050">1050</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1051"><td class="num" id="LN1051">1051</td><td class="line">  RecordIndex ix;</td></tr>
<tr class="codeline" data-linenumber="1052"><td class="num" id="LN1052">1052</td><td class="line">  ix.tab = J-&gt;base[0];</td></tr>
<tr class="codeline" data-linenumber="1053"><td class="num" id="LN1053">1053</td><td class="line">  ix.val = J-&gt;base[1];</td></tr>
<tr class="codeline" data-linenumber="1054"><td class="num" id="LN1054">1054</td><td class="line">  rd-&gt;nres = 0;</td></tr>
<tr class="codeline" data-linenumber="1055"><td class="num" id="LN1055">1055</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>tref_istab(ix.tab)<span class='macro_popup'>(((((ix.tab)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_TAB)&lt;&lt;<br>24)))</span></span> &amp;&amp; ix.val) {</td></tr>
<tr class="codeline" data-linenumber="1056"><td class="num" id="LN1056">1056</td><td class="line">    <span class='keyword'>if</span> (!J-&gt;base[2]) {  <span class='comment'>/* Simple push: t[#t+1] = v */</span></td></tr>
<tr class="codeline" data-linenumber="1057"><td class="num" id="LN1057">1057</td><td class="line">      TRef trlen = lj_ir_call(J, IRCALL_lj_tab_len, ix.tab);</td></tr>
<tr class="codeline" data-linenumber="1058"><td class="num" id="LN1058">1058</td><td class="line">      GCtab *t = <span class='macro'>tabV(&amp;rd-&gt;argv[0])<span class='macro_popup'>(&amp;(((GCobj *)(uintptr_t)((&amp;rd-&gt;argv[0])-&gt;gcr).gcptr32<br>))-&gt;tab)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1059"><td class="num" id="LN1059">1059</td><td class="line">      ix.key = emitir(<span class='macro'>IRTI(IR_ADD)<span class='macro_popup'>(((uint32_t)((((IR_ADD))&lt;&lt;8) | (IRT_INT))))</span></span>, trlen, lj_ir_kint(J, 1));</td></tr>
<tr class="codeline" data-linenumber="1060"><td class="num" id="LN1060">1060</td><td class="line">      settabV(J-&gt;L, &amp;ix.tabv, t);</td></tr>
<tr class="codeline" data-linenumber="1061"><td class="num" id="LN1061">1061</td><td class="line">      setintV(&amp;ix.keyv, lj_tab_len(t) + 1);</td></tr>
<tr class="codeline" data-linenumber="1062"><td class="num" id="LN1062">1062</td><td class="line">      ix.idxchain = 0;</td></tr>
<tr class="codeline" data-linenumber="1063"><td class="num" id="LN1063">1063</td><td class="line">      lj_record_idx(J, &amp;ix);  <span class='comment'>/* Set new value. */</span></td></tr>
<tr class="codeline" data-linenumber="1064"><td class="num" id="LN1064">1064</td><td class="line">    } <span class='keyword'>else</span> {  <span class='comment'>/* Complex case: insert in the middle. */</span></td></tr>
<tr class="codeline" data-linenumber="1065"><td class="num" id="LN1065">1065</td><td class="line">      <span class='macro'>recff_nyiu<span class='macro_popup'>recff_nyi</span></span>(J, rd);</td></tr>
<tr class="codeline" data-linenumber="1066"><td class="num" id="LN1066">1066</td><td class="line">      <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1067"><td class="num" id="LN1067">1067</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1068"><td class="num" id="LN1068">1068</td><td class="line">  }  <span class='comment'>/* else: Interpreter will throw. */</span></td></tr>
<tr class="codeline" data-linenumber="1069"><td class="num" id="LN1069">1069</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1070"><td class="num" id="LN1070">1070</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1071"><td class="num" id="LN1071">1071</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_table_concat(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="1072"><td class="num" id="LN1072">1072</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1073"><td class="num" id="LN1073">1073</td><td class="line">  TRef tab = J-&gt;base[0];</td></tr>
<tr class="codeline" data-linenumber="1074"><td class="num" id="LN1074">1074</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>tref_istab(tab)<span class='macro_popup'>(((((tab)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_TAB)&lt;&lt;24<br>)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1075"><td class="num" id="LN1075">1075</td><td class="line">    TRef sep = !<span class='macro'>tref_isnil(J-&gt;base[1])<span class='macro_popup'>(((((J-&gt;base[1])) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_NIL<br>)&lt;&lt;24)))</span></span> ?</td></tr>
<tr class="codeline" data-linenumber="1076"><td class="num" id="LN1076">1076</td><td class="line">	       lj_ir_tostr(J, J-&gt;base[1]) : lj_ir_knull(J, IRT_STR);</td></tr>
<tr class="codeline" data-linenumber="1077"><td class="num" id="LN1077">1077</td><td class="line">    TRef tri = (J-&gt;base[1] &amp;&amp; !<span class='macro'>tref_isnil(J-&gt;base[2])<span class='macro_popup'>(((((J-&gt;base[2])) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_NIL<br>)&lt;&lt;24)))</span></span>) ?</td></tr>
<tr class="codeline" data-linenumber="1078"><td class="num" id="LN1078">1078</td><td class="line">	       lj_opt_narrow_toint(J, J-&gt;base[2]) : lj_ir_kint(J, 1);</td></tr>
<tr class="codeline" data-linenumber="1079"><td class="num" id="LN1079">1079</td><td class="line">    TRef tre = (J-&gt;base[1] &amp;&amp; J-&gt;base[2] &amp;&amp; !<span class='macro'>tref_isnil(J-&gt;base[3])<span class='macro_popup'>(((((J-&gt;base[3])) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_NIL<br>)&lt;&lt;24)))</span></span>) ?</td></tr>
<tr class="codeline" data-linenumber="1080"><td class="num" id="LN1080">1080</td><td class="line">	       lj_opt_narrow_toint(J, J-&gt;base[3]) :</td></tr>
<tr class="codeline" data-linenumber="1081"><td class="num" id="LN1081">1081</td><td class="line">	       lj_ir_call(J, IRCALL_lj_tab_len, tab);</td></tr>
<tr class="codeline" data-linenumber="1082"><td class="num" id="LN1082">1082</td><td class="line">    TRef hdr = recff_bufhdr(J);</td></tr>
<tr class="codeline" data-linenumber="1083"><td class="num" id="LN1083">1083</td><td class="line">    TRef tr = lj_ir_call(J, IRCALL_lj_buf_puttab, hdr, tab, sep, tri, tre);</td></tr>
<tr class="codeline" data-linenumber="1084"><td class="num" id="LN1084">1084</td><td class="line">    emitir(<span class='macro'>IRTG(IR_NE, IRT_PTR)<span class='macro_popup'>(((uint32_t)((((IR_NE))&lt;&lt;8) | (IRT_GUARD|(IRT_PTR)))))</span></span>, tr, <span class='macro'>lj_ir_kptr(J, NULL)<span class='macro_popup'>lj_ir_kptr_(J, IR_KPTR, (((void*)0)))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1085"><td class="num" id="LN1085">1085</td><td class="line">    J-&gt;base[0] = emitir(<span class='macro'>IRT(IR_BUFSTR, IRT_STR)<span class='macro_popup'>((uint32_t)(((IR_BUFSTR)&lt;&lt;8) | (IRT_STR)))</span></span>, tr, hdr);</td></tr>
<tr class="codeline" data-linenumber="1086"><td class="num" id="LN1086">1086</td><td class="line">  }  <span class='comment'>/* else: Interpreter will throw. */</span></td></tr>
<tr class="codeline" data-linenumber="1087"><td class="num" id="LN1087">1087</td><td class="line">  <span class='macro'>UNUSED(rd)<span class='macro_popup'>((void)(rd))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1088"><td class="num" id="LN1088">1088</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1089"><td class="num" id="LN1089">1089</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1090"><td class="num" id="LN1090">1090</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_table_new(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="1091"><td class="num" id="LN1091">1091</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1092"><td class="num" id="LN1092">1092</td><td class="line">  TRef tra = lj_opt_narrow_toint(J, J-&gt;base[0]);</td></tr>
<tr class="codeline" data-linenumber="1093"><td class="num" id="LN1093">1093</td><td class="line">  TRef trh = lj_opt_narrow_toint(J, J-&gt;base[1]);</td></tr>
<tr class="codeline" data-linenumber="1094"><td class="num" id="LN1094">1094</td><td class="line">  J-&gt;base[0] = lj_ir_call(J, IRCALL_lj_tab_new_ah, tra, trh);</td></tr>
<tr class="codeline" data-linenumber="1095"><td class="num" id="LN1095">1095</td><td class="line">  <span class='macro'>UNUSED(rd)<span class='macro_popup'>((void)(rd))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1096"><td class="num" id="LN1096">1096</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1097"><td class="num" id="LN1097">1097</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1098"><td class="num" id="LN1098">1098</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_table_clear(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="1099"><td class="num" id="LN1099">1099</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1100"><td class="num" id="LN1100">1100</td><td class="line">  TRef tr = J-&gt;base[0];</td></tr>
<tr class="codeline" data-linenumber="1101"><td class="num" id="LN1101">1101</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>tref_istab(tr)<span class='macro_popup'>(((((tr)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_TAB)&lt;&lt;24<br>)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1102"><td class="num" id="LN1102">1102</td><td class="line">    rd-&gt;nres = 0;</td></tr>
<tr class="codeline" data-linenumber="1103"><td class="num" id="LN1103">1103</td><td class="line">    lj_ir_call(J, IRCALL_lj_tab_clear, tr);</td></tr>
<tr class="codeline" data-linenumber="1104"><td class="num" id="LN1104">1104</td><td class="line">    J-&gt;needsnap = 1;</td></tr>
<tr class="codeline" data-linenumber="1105"><td class="num" id="LN1105">1105</td><td class="line">  }  <span class='comment'>/* else: Interpreter will throw. */</span></td></tr>
<tr class="codeline" data-linenumber="1106"><td class="num" id="LN1106">1106</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1107"><td class="num" id="LN1107">1107</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1108"><td class="num" id="LN1108">1108</td><td class="line"><span class='comment'>/* -- I/O library fast functions ------------------------------------------ */</span></td></tr>
<tr class="codeline" data-linenumber="1109"><td class="num" id="LN1109">1109</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1110"><td class="num" id="LN1110">1110</td><td class="line"><span class='comment'>/* Get FILE* for I/O function. Any I/O error aborts recording, so there's</span></td></tr>
<tr class="codeline" data-linenumber="1111"><td class="num" id="LN1111">1111</td><td class="line"><span class='comment'>** no need to encode the alternate cases for any of the guards.</span></td></tr>
<tr class="codeline" data-linenumber="1112"><td class="num" id="LN1112">1112</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1113"><td class="num" id="LN1113">1113</td><td class="line"><span class='keyword'>static</span> TRef recff_io_fp(jit_State *J, TRef *udp, int32_t id)</td></tr>
<tr class="codeline" data-linenumber="1114"><td class="num" id="LN1114">1114</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1115"><td class="num" id="LN1115">1115</td><td class="line">  TRef tr, ud, fp;</td></tr>
<tr class="codeline" data-linenumber="1116"><td class="num" id="LN1116">1116</td><td class="line">  <span class='keyword'>if</span> (id) {  <span class='comment'>/* io.func() */</span></td></tr>
<tr class="codeline" data-linenumber="1117"><td class="num" id="LN1117">1117</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_GC64<span class='macro_popup'>0</span></span></span></td></tr>
<tr class="codeline" data-linenumber="1118"><td class="num" id="LN1118">1118</td><td class="line">    <span class='comment'>/* TODO: fix ARM32 asm_fload(), so we can use this for all archs. */</span></td></tr>
<tr class="codeline" data-linenumber="1119"><td class="num" id="LN1119">1119</td><td class="line">    ud = lj_ir_ggfload(J, IRT_UDATA, <span class='macro'>GG_OFS(g.gcroot[id])<span class='macro_popup'>((int)__builtin_offsetof(GG_State, g.gcroot[id]))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1120"><td class="num" id="LN1120">1120</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="1121"><td class="num" id="LN1121">1121</td><td class="line">    tr = <span class='macro'>lj_ir_kptr(J, &amp;J2G(J)-&gt;gcroot[id])<span class='macro_popup'>lj_ir_kptr_(J, IR_KPTR, (&amp;(&amp;((GG_State *)((char *)(J)<br> - ((int)__builtin_offsetof(GG_State, J))))-&gt;g)-&gt;gcroot<br>[id]))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1122"><td class="num" id="LN1122">1122</td><td class="line">    ud = emitir(<span class='macro'>IRT(IR_XLOAD, IRT_UDATA)<span class='macro_popup'>((uint32_t)(((IR_XLOAD)&lt;&lt;8) | (IRT_UDATA)))</span></span>, tr, 0);</td></tr>
<tr class="codeline" data-linenumber="1123"><td class="num" id="LN1123">1123</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1124"><td class="num" id="LN1124">1124</td><td class="line">  } <span class='keyword'>else</span> {  <span class='comment'>/* fp:method() */</span></td></tr>
<tr class="codeline" data-linenumber="1125"><td class="num" id="LN1125">1125</td><td class="line">    ud = J-&gt;base[0];</td></tr>
<tr class="codeline" data-linenumber="1126"><td class="num" id="LN1126">1126</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>tref_isudata(ud)<span class='macro_popup'>(((((ud)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_UDATA)&lt;&lt;<br>24)))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1127"><td class="num" id="LN1127">1127</td><td class="line">      lj_trace_err(J, LJ_TRERR_BADTYPE);</td></tr>
<tr class="codeline" data-linenumber="1128"><td class="num" id="LN1128">1128</td><td class="line">    tr = emitir(<span class='macro'>IRT(IR_FLOAD, IRT_U8)<span class='macro_popup'>((uint32_t)(((IR_FLOAD)&lt;&lt;8) | (IRT_U8)))</span></span>, ud, IRFL_UDATA_UDTYPE);</td></tr>
<tr class="codeline" data-linenumber="1129"><td class="num" id="LN1129">1129</td><td class="line">    emitir(<span class='macro'>IRTGI(IR_EQ)<span class='macro_popup'>(((uint32_t)((((IR_EQ))&lt;&lt;8) | (IRT_GUARD|IRT_INT))))</span></span>, tr, lj_ir_kint(J, UDTYPE_IO_FILE));</td></tr>
<tr class="codeline" data-linenumber="1130"><td class="num" id="LN1130">1130</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="1131"><td class="num" id="LN1131">1131</td><td class="line">  *udp = ud;</td></tr>
<tr class="codeline" data-linenumber="1132"><td class="num" id="LN1132">1132</td><td class="line">  fp = emitir(<span class='macro'>IRT(IR_FLOAD, IRT_PTR)<span class='macro_popup'>((uint32_t)(((IR_FLOAD)&lt;&lt;8) | (IRT_PTR)))</span></span>, ud, IRFL_UDATA_FILE);</td></tr>
<tr class="codeline" data-linenumber="1133"><td class="num" id="LN1133">1133</td><td class="line">  emitir(<span class='macro'>IRTG(IR_NE, IRT_PTR)<span class='macro_popup'>(((uint32_t)((((IR_NE))&lt;&lt;8) | (IRT_GUARD|(IRT_PTR)))))</span></span>, fp, lj_ir_knull(J, IRT_PTR));</td></tr>
<tr class="codeline" data-linenumber="1134"><td class="num" id="LN1134">1134</td><td class="line">  <span class='keyword'>return</span> fp;</td></tr>
<tr class="codeline" data-linenumber="1135"><td class="num" id="LN1135">1135</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1136"><td class="num" id="LN1136">1136</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1137"><td class="num" id="LN1137">1137</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_io_write(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="1138"><td class="num" id="LN1138">1138</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1139"><td class="num" id="LN1139">1139</td><td class="line">  TRef ud, fp = recff_io_fp(J, &amp;ud, rd-&gt;data);</td></tr>
<tr class="codeline" data-linenumber="1140"><td class="num" id="LN1140">1140</td><td class="line">  TRef zero = lj_ir_kint(J, 0);</td></tr>
<tr class="codeline" data-linenumber="1141"><td class="num" id="LN1141">1141</td><td class="line">  TRef one = lj_ir_kint(J, 1);</td></tr>
<tr class="codeline" data-linenumber="1142"><td class="num" id="LN1142">1142</td><td class="line">  ptrdiff_t i = rd-&gt;data == 0 ? 1 : 0;</td></tr>
<tr class="codeline" data-linenumber="1143"><td class="num" id="LN1143">1143</td><td class="line">  <span class='keyword'>for</span> (; J-&gt;base[i]; i++) {</td></tr>
<tr class="codeline" data-linenumber="1144"><td class="num" id="LN1144">1144</td><td class="line">    TRef str = lj_ir_tostr(J, J-&gt;base[i]);</td></tr>
<tr class="codeline" data-linenumber="1145"><td class="num" id="LN1145">1145</td><td class="line">    TRef buf = emitir(<span class='macro'>IRT(IR_STRREF, IRT_PGC)<span class='macro_popup'>((uint32_t)(((IR_STRREF)&lt;&lt;8) | (IRT_PGC)))</span></span>, str, zero);</td></tr>
<tr class="codeline" data-linenumber="1146"><td class="num" id="LN1146">1146</td><td class="line">    TRef len = emitir(<span class='macro'>IRTI(IR_FLOAD)<span class='macro_popup'>(((uint32_t)((((IR_FLOAD))&lt;&lt;8) | (IRT_INT))))</span></span>, str, IRFL_STR_LEN);</td></tr>
<tr class="codeline" data-linenumber="1147"><td class="num" id="LN1147">1147</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>tref_isk(len)<span class='macro_popup'>(((((IRRef1)((len)))) &lt; REF_BIAS))</span></span> &amp;&amp; IR(<span class='macro'>tref_ref(len)<span class='macro_popup'>((IRRef1)(len))</span></span>)-&gt;i == 1) {</td></tr>
<tr class="codeline" data-linenumber="1148"><td class="num" id="LN1148">1148</td><td class="line">      IRIns *irs = IR(<span class='macro'>tref_ref(str)<span class='macro_popup'>((IRRef1)(str))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1149"><td class="num" id="LN1149">1149</td><td class="line">      TRef tr = (irs-&gt;o == IR_TOSTR &amp;&amp; irs-&gt;op2 == <span class='macro'>IRTOSTR_CHAR<span class='macro_popup'>2</span></span>) ?</td></tr>
<tr class="codeline" data-linenumber="1150"><td class="num" id="LN1150">1150</td><td class="line">		irs-&gt;op1 :</td></tr>
<tr class="codeline" data-linenumber="1151"><td class="num" id="LN1151">1151</td><td class="line">		emitir(<span class='macro'>IRT(IR_XLOAD, IRT_U8)<span class='macro_popup'>((uint32_t)(((IR_XLOAD)&lt;&lt;8) | (IRT_U8)))</span></span>, buf, <span class='macro'>IRXLOAD_READONLY<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1152"><td class="num" id="LN1152">1152</td><td class="line">      tr = lj_ir_call(J, IRCALL_fputc, tr, fp);</td></tr>
<tr class="codeline" data-linenumber="1153"><td class="num" id="LN1153">1153</td><td class="line">      <span class='keyword'>if</span> (results_wanted(J) != 0)  <span class='comment'>/* Check result only if not ignored. */</span></td></tr>
<tr class="codeline" data-linenumber="1154"><td class="num" id="LN1154">1154</td><td class="line">	emitir(<span class='macro'>IRTGI(IR_NE)<span class='macro_popup'>(((uint32_t)((((IR_NE))&lt;&lt;8) | (IRT_GUARD|IRT_INT))))</span></span>, tr, lj_ir_kint(J, -1));</td></tr>
<tr class="codeline" data-linenumber="1155"><td class="num" id="LN1155">1155</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1156"><td class="num" id="LN1156">1156</td><td class="line">      TRef tr = lj_ir_call(J, IRCALL_fwrite, buf, one, len, fp);</td></tr>
<tr class="codeline" data-linenumber="1157"><td class="num" id="LN1157">1157</td><td class="line">      <span class='keyword'>if</span> (results_wanted(J) != 0)  <span class='comment'>/* Check result only if not ignored. */</span></td></tr>
<tr class="codeline" data-linenumber="1158"><td class="num" id="LN1158">1158</td><td class="line">	emitir(<span class='macro'>IRTGI(IR_EQ)<span class='macro_popup'>(((uint32_t)((((IR_EQ))&lt;&lt;8) | (IRT_GUARD|IRT_INT))))</span></span>, tr, len);</td></tr>
<tr class="codeline" data-linenumber="1159"><td class="num" id="LN1159">1159</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1160"><td class="num" id="LN1160">1160</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="1161"><td class="num" id="LN1161">1161</td><td class="line">  J-&gt;base[0] = <span class='macro'>LJ_52<span class='macro_popup'>0</span></span> ? ud : <span class='macro'>TREF_TRUE<span class='macro_popup'>((((TRef)((REF_NIL-(IRT_TRUE)) + (((IRT_TRUE))&lt;&lt;24)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1162"><td class="num" id="LN1162">1162</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1163"><td class="num" id="LN1163">1163</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1164"><td class="num" id="LN1164">1164</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_io_flush(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="1165"><td class="num" id="LN1165">1165</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1166"><td class="num" id="LN1166">1166</td><td class="line">  TRef ud, fp = recff_io_fp(J, &amp;ud, rd-&gt;data);</td></tr>
<tr class="codeline" data-linenumber="1167"><td class="num" id="LN1167">1167</td><td class="line">  TRef tr = lj_ir_call(J, IRCALL_fflush, fp);</td></tr>
<tr class="codeline" data-linenumber="1168"><td class="num" id="LN1168">1168</td><td class="line">  <span class='keyword'>if</span> (results_wanted(J) != 0)  <span class='comment'>/* Check result only if not ignored. */</span></td></tr>
<tr class="codeline" data-linenumber="1169"><td class="num" id="LN1169">1169</td><td class="line">    emitir(<span class='macro'>IRTGI(IR_EQ)<span class='macro_popup'>(((uint32_t)((((IR_EQ))&lt;&lt;8) | (IRT_GUARD|IRT_INT))))</span></span>, tr, lj_ir_kint(J, 0));</td></tr>
<tr class="codeline" data-linenumber="1170"><td class="num" id="LN1170">1170</td><td class="line">  J-&gt;base[0] = <span class='macro'>TREF_TRUE<span class='macro_popup'>((((TRef)((REF_NIL-(IRT_TRUE)) + (((IRT_TRUE))&lt;&lt;24)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1171"><td class="num" id="LN1171">1171</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1172"><td class="num" id="LN1172">1172</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1173"><td class="num" id="LN1173">1173</td><td class="line"><span class='comment'>/* -- Debug library fast functions ---------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="1174"><td class="num" id="LN1174">1174</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1175"><td class="num" id="LN1175">1175</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> LJ_FASTCALL recff_debug_getmetatable(jit_State *J, RecordFFData *rd)</td></tr>
<tr class="codeline" data-linenumber="1176"><td class="num" id="LN1176">1176</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1177"><td class="num" id="LN1177">1177</td><td class="line">  GCtab *mt;</td></tr>
<tr class="codeline" data-linenumber="1178"><td class="num" id="LN1178">1178</td><td class="line">  TRef mtref;</td></tr>
<tr class="codeline" data-linenumber="1179"><td class="num" id="LN1179">1179</td><td class="line">  TRef tr = J-&gt;base[0];</td></tr>
<tr class="codeline" data-linenumber="1180"><td class="num" id="LN1180">1180</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>tref_istab(tr)<span class='macro_popup'>(((((tr)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_TAB)&lt;&lt;24<br>)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1181"><td class="num" id="LN1181">1181</td><td class="line">    mt = <span class='macro'>tabref(tabV(&amp;rd-&gt;argv[0])-&gt;metatable)<span class='macro_popup'>(&amp;((GCobj *)(uintptr_t)(((&amp;(((GCobj *)(uintptr_t)((&amp;<br>rd-&gt;argv[0])-&gt;gcr).gcptr32))-&gt;tab)-&gt;metatable)).gcptr32<br>)-&gt;tab)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1182"><td class="num" id="LN1182">1182</td><td class="line">    mtref = emitir(<span class='macro'>IRT(IR_FLOAD, IRT_TAB)<span class='macro_popup'>((uint32_t)(((IR_FLOAD)&lt;&lt;8) | (IRT_TAB)))</span></span>, tr, IRFL_TAB_META);</td></tr>
<tr class="codeline" data-linenumber="1183"><td class="num" id="LN1183">1183</td><td class="line">  } <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>tref_isudata(tr)<span class='macro_popup'>(((((tr)) &amp; (IRT_TYPE&lt;&lt;24)) == ((IRT_UDATA)&lt;&lt;<br>24)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1184"><td class="num" id="LN1184">1184</td><td class="line">    mt = <span class='macro'>tabref(udataV(&amp;rd-&gt;argv[0])-&gt;metatable)<span class='macro_popup'>(&amp;((GCobj *)(uintptr_t)(((&amp;(((GCobj *)(uintptr_t)((&amp;<br>rd-&gt;argv[0])-&gt;gcr).gcptr32))-&gt;ud)-&gt;metatable)).gcptr32<br>)-&gt;tab)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1185"><td class="num" id="LN1185">1185</td><td class="line">    mtref = emitir(<span class='macro'>IRT(IR_FLOAD, IRT_TAB)<span class='macro_popup'>((uint32_t)(((IR_FLOAD)&lt;&lt;8) | (IRT_TAB)))</span></span>, tr, IRFL_UDATA_META);</td></tr>
<tr class="codeline" data-linenumber="1186"><td class="num" id="LN1186">1186</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1187"><td class="num" id="LN1187">1187</td><td class="line">    mt = <span class='macro'>tabref(basemt_obj(J2G(J), &amp;rd-&gt;argv[0]))<span class='macro_popup'>(&amp;((GCobj *)(uintptr_t)(((((&amp;((GG_State *)((char *)(J<br>) - ((int)__builtin_offsetof(GG_State, J))))-&gt;g))-&gt;gcroot<br>[GCROOT_BASEMT+((((&amp;rd-&gt;argv[0])-&gt;it) &lt;= 0xfffeffffu<br>) ? ~(~13u) : (((int32_t)((&amp;rd-&gt;argv[0])-&gt;it) &gt;&gt;<br> 15) == -2) ? ~(~3u) : ~((&amp;rd-&gt;argv[0])-&gt;it))]))).gcptr32<br>)-&gt;tab)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1188"><td class="num" id="LN1188">1188</td><td class="line">    J-&gt;base[0] = mt ? <span class='macro'>lj_ir_ktab(J, mt)<span class='macro_popup'>lj_ir_kgc(J, ((GCobj *)((mt))), IRT_TAB)</span></span> : <span class='macro'>TREF_NIL<span class='macro_popup'>((((TRef)((REF_NIL-(IRT_NIL)) + (((IRT_NIL))&lt;&lt;24)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1189"><td class="num" id="LN1189">1189</td><td class="line">    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1190"><td class="num" id="LN1190">1190</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="1191"><td class="num" id="LN1191">1191</td><td class="line">  emitir(<span class='macro'>IRTG(mt ? IR_NE : IR_EQ, IRT_TAB)<span class='macro_popup'>(((uint32_t)((((mt ? IR_NE : IR_EQ))&lt;&lt;8) | (IRT_GUARD|(<br>IRT_TAB)))))</span></span>, mtref, lj_ir_knull(J, IRT_TAB));</td></tr>
<tr class="codeline" data-linenumber="1192"><td class="num" id="LN1192">1192</td><td class="line">  J-&gt;base[0] = mt ? mtref : <span class='macro'>TREF_NIL<span class='macro_popup'>((((TRef)((REF_NIL-(IRT_NIL)) + (((IRT_NIL))&lt;&lt;24)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1193"><td class="num" id="LN1193">1193</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1194"><td class="num" id="LN1194">1194</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1195"><td class="num" id="LN1195">1195</td><td class="line"><span class='comment'>/* -- Record calls to fast functions -------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="1196"><td class="num" id="LN1196">1196</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1197"><td class="num" id="LN1197">1197</td><td class="line"><span class='directive'>#include "lj_recdef.h"</span></td></tr>
<tr class="codeline" data-linenumber="1198"><td class="num" id="LN1198">1198</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1199"><td class="num" id="LN1199">1199</td><td class="line"><span class='keyword'>static</span> uint32_t recdef_lookup(GCfunc *fn)</td></tr>
<tr class="codeline" data-linenumber="1200"><td class="num" id="LN1200">1200</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1201"><td class="num" id="LN1201">1201</td><td class="line">  <span class='keyword'>if</span> (fn-&gt;c.ffid &lt; <span class='keyword'>sizeof</span>(recff_idmap)/<span class='keyword'>sizeof</span>(recff_idmap[0]))</td></tr>
<tr class="codeline" data-linenumber="1202"><td class="num" id="LN1202">1202</td><td class="line">    <span class='keyword'>return</span> recff_idmap[fn-&gt;c.ffid];</td></tr>
<tr class="codeline" data-linenumber="1203"><td class="num" id="LN1203">1203</td><td class="line">  <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1204"><td class="num" id="LN1204">1204</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1205"><td class="num" id="LN1205">1205</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1206"><td class="num" id="LN1206">1206</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1207"><td class="num" id="LN1207">1207</td><td class="line"><span class='comment'>/* Record entry to a fast function or C function. */</span></td></tr>
<tr class="codeline" data-linenumber="1208"><td class="num" id="LN1208">1208</td><td class="line"><span class='keyword'>void</span> lj_ffrecord_func(jit_State *J)</td></tr>
<tr class="codeline" data-linenumber="1209"><td class="num" id="LN1209">1209</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1210"><td class="num" id="LN1210">1210</td><td class="line">  RecordFFData rd;</td></tr>
<tr class="codeline" data-linenumber="1211"><td class="num" id="LN1211">1211</td><td class="line">  uint32_t m = recdef_lookup(J-&gt;fn);</td></tr>
<tr class="codeline" data-linenumber="1212"><td class="num" id="LN1212">1212</td><td class="line">  rd.data = m &amp; 0xff;</td></tr>
<tr class="codeline" data-linenumber="1213"><td class="num" id="LN1213">1213</td><td class="line">  rd.nres = 1;  <span class='comment'>/* Default is one result. */</span></td></tr>
<tr class="codeline" data-linenumber="1214"><td class="num" id="LN1214">1214</td><td class="line">  rd.argv = J-&gt;L-&gt;base;</td></tr>
<tr class="codeline" data-linenumber="1215"><td class="num" id="LN1215">1215</td><td class="line">  J-&gt;base[J-&gt;maxslot] = 0;  <span class='comment'>/* Mark end of arguments. */</span></td></tr>
<tr class="codeline" data-linenumber="1216"><td class="num" id="LN1216">1216</td><td class="line">  (recff_func[m &gt;&gt; 8])(J, &amp;rd);  <span class='comment'>/* Call recff_* handler. */</span></td></tr>
<tr class="codeline" data-linenumber="1217"><td class="num" id="LN1217">1217</td><td class="line">  <span class='keyword'>if</span> (rd.nres &gt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="1218"><td class="num" id="LN1218">1218</td><td class="line">    <span class='keyword'>if</span> (J-&gt;postproc == LJ_POST_NONE) J-&gt;postproc = LJ_POST_FFRETRY;</td></tr>
<tr class="codeline" data-linenumber="1219"><td class="num" id="LN1219">1219</td><td class="line">    lj_record_ret(J, 0, rd.nres);</td></tr>
<tr class="codeline" data-linenumber="1220"><td class="num" id="LN1220">1220</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="1221"><td class="num" id="LN1221">1221</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1222"><td class="num" id="LN1222">1222</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1223"><td class="num" id="LN1223">1223</td><td class="line"><span class='directive'>#undef IR</span></td></tr>
<tr class="codeline" data-linenumber="1224"><td class="num" id="LN1224">1224</td><td class="line"><span class='directive'>#undef emitir</span></td></tr>
<tr class="codeline" data-linenumber="1225"><td class="num" id="LN1225">1225</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1226"><td class="num" id="LN1226">1226</td><td class="line"><span class='directive'>#endif</span></td></tr>
</table></body></html>
