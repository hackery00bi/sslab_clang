<!doctype html>
<html>
<head>
<title>lj_alloc.c</title>

<style type="text/css">
body { color:#000000; background-color:#ffffff }
body { font-family:Helvetica, sans-serif; font-size:10pt }
h1 { font-size:14pt }
.FileName { margin-top: 5px; margin-bottom: 5px; display: inline; }
.FileNav { margin-left: 5px; margin-right: 5px; display: inline; }
.FileNav a { text-decoration:none; font-size: larger; }
.divider { margin-top: 30px; margin-bottom: 30px; height: 15px; }
.divider { background-color: gray; }
.code { border-collapse:collapse; width:100%; }
.code { font-family: "Monospace", monospace; font-size:10pt }
.code { line-height: 1.2em }
.comment { color: green; font-style: oblique }
.keyword { color: blue }
.string_literal { color: red }
.directive { color: darkmagenta }

/* Macros and variables could have pop-up notes hidden by default.
  - Macro pop-up:    expansion of the macro
  - Variable pop-up: value (table) of the variable */
.macro_popup, .variable_popup { display: none; }

/* Pop-up appears on mouse-hover event. */
.macro:hover .macro_popup, .variable:hover .variable_popup {
  display: block;
  padding: 2px;
  -webkit-border-radius:5px;
  -webkit-box-shadow:1px 1px 7px #000;
  border-radius:5px;
  box-shadow:1px 1px 7px #000;
  position: absolute;
  top: -1em;
  left:10em;
  z-index: 1
}

.macro_popup {
  border: 2px solid red;
  background-color:#FFF0F0;
  font-weight: normal;
}

.variable_popup {
  border: 2px solid blue;
  background-color:#F0F0FF;
  font-weight: bold;
  font-family: Helvetica, sans-serif;
  font-size: 9pt;
}

/* Pop-up notes needs a relative position as a base where they pops up. */
.macro, .variable {
  background-color: PaleGoldenRod;
  position: relative;
}
.macro { color: DarkMagenta; }

#tooltiphint {
  position: fixed;
  width: 50em;
  margin-left: -25em;
  left: 50%;
  padding: 10px;
  border: 1px solid #b0b0b0;
  border-radius: 2px;
  box-shadow: 1px 1px 7px black;
  background-color: #c0c0c0;
  z-index: 2;
}

.num { width:2.5em; padding-right:2ex; background-color:#eeeeee }
.num { text-align:right; font-size:8pt }
.num { color:#444444 }
.line { padding-left: 1ex; border-left: 3px solid #ccc }
.line { white-space: pre }
.msg { -webkit-box-shadow:1px 1px 7px #000 }
.msg { box-shadow:1px 1px 7px #000 }
.msg { -webkit-border-radius:5px }
.msg { border-radius:5px }
.msg { font-family:Helvetica, sans-serif; font-size:8pt }
.msg { float:left }
.msg { padding:0.25em 1ex 0.25em 1ex }
.msg { margin-top:10px; margin-bottom:10px }
.msg { font-weight:bold }
.msg { max-width:60em; word-wrap: break-word; white-space: pre-wrap }
.msgT { padding:0x; spacing:0x }
.msgEvent { background-color:#fff8b4; color:#000000 }
.msgControl { background-color:#bbbbbb; color:#000000 }
.msgNote { background-color:#ddeeff; color:#000000 }
.mrange { background-color:#dfddf3 }
.mrange { border-bottom:1px solid #6F9DBE }
.PathIndex { font-weight: bold; padding:0px 5px; margin-right:5px; }
.PathIndex { -webkit-border-radius:8px }
.PathIndex { border-radius:8px }
.PathIndexEvent { background-color:#bfba87 }
.PathIndexControl { background-color:#8c8c8c }
.PathIndexPopUp { background-color: #879abc; }
.PathNav a { text-decoration:none; font-size: larger }
.CodeInsertionHint { font-weight: bold; background-color: #10dd10 }
.CodeRemovalHint { background-color:#de1010 }
.CodeRemovalHint { border-bottom:1px solid #6F9DBE }
.selected{ background-color:orange !important; }

table.simpletable {
  padding: 5px;
  font-size:12pt;
  margin:20px;
  border-collapse: collapse; border-spacing: 0px;
}
td.rowname {
  text-align: right;
  vertical-align: top;
  font-weight: bold;
  color:#444444;
  padding-right:2ex;
}

/* Hidden text. */
input.spoilerhider + label {
  cursor: pointer;
  text-decoration: underline;
  display: block;
}
input.spoilerhider {
 display: none;
}
input.spoilerhider ~ .spoiler {
  overflow: hidden;
  margin: 10px auto 0;
  height: 0;
  opacity: 0;
}
input.spoilerhider:checked + label + .spoiler{
  height: auto;
  opacity: 1;
}
</style>
</head>
<body>
<!-- BUGDESC Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11 -->

<!-- BUGTYPE Potential insecure memory buffer bounds restriction in call 'memcpy' -->

<!-- BUGCATEGORY Security -->

<!-- BUGFILE /tmp/real/c_wrk/wrk1/deps/luajit/src/lj_alloc.c -->

<!-- FILENAME lj_alloc.c -->

<!-- FUNCTIONNAME lj_alloc_realloc -->

<!-- ISSUEHASHCONTENTOFLINEINCONTEXT a3c408446b0825e34c462bfca0906a44 -->

<!-- BUGLINE 1370 -->

<!-- BUGCOLUMN 2 -->

<!-- BUGPATHLENGTH 1 -->

<!-- BUGMETAEND -->
<!-- REPORTHEADER -->
<h3>Bug Summary</h3>
<table class="simpletable">
<tr><td class="rowname">File:</td><td>src/lj_alloc.c</td></tr>
<tr><td class="rowname">Warning:</td><td><a href="#EndPath">line 1370, column 2</a><br />Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11</td></tr>

</table>
<!-- REPORTSUMMARYEXTRA -->
<h3>Annotated Source Code</h3>
<p>Press <a href="#" onclick="toggleHelp(); return false;">'?'</a>
   to see keyboard shortcuts</p>
<input type="checkbox" class="spoilerhider" id="showinvocation" />
<label for="showinvocation" >Show analyzer invocation</label>
<div class="spoiler">clang -cc1 -cc1 -triple x86_64-unknown-linux-gnu -analyze -disable-free -main-file-name lj_alloc.c -analyzer-store=region -analyzer-opt-analyze-nested-blocks -analyzer-checker=core -analyzer-checker=apiModeling -analyzer-checker=unix -analyzer-checker=deadcode -analyzer-checker=security.insecureAPI.UncheckedReturn -analyzer-checker=security.insecureAPI.getpw -analyzer-checker=security.insecureAPI.gets -analyzer-checker=security.insecureAPI.mktemp -analyzer-checker=security.insecureAPI.mkstemp -analyzer-checker=security.insecureAPI.vfork -analyzer-checker=nullability.NullPassedToNonnull -analyzer-checker=nullability.NullReturnedFromNonnull -analyzer-output plist -w -setup-static-analyzer -mrelocation-model static -mframe-pointer=none -fmath-errno -fno-rounding-math -mconstructor-aliases -munwind-tables -target-cpu x86-64 -fno-split-dwarf-inlining -debugger-tuning=gdb -resource-dir /llvm-project/build/lib/clang/12.0.0 -D _FILE_OFFSET_BITS=64 -D _LARGEFILE_SOURCE -U _FORTIFY_SOURCE -internal-isystem /usr/local/include -internal-isystem /llvm-project/build/lib/clang/12.0.0/include -internal-externc-isystem /usr/include/x86_64-linux-gnu -internal-externc-isystem /include -internal-externc-isystem /usr/include -O2 -fdebug-compilation-dir /tmp/real/c_wrk/wrk1/deps/luajit/src -ferror-limit 19 -fgnuc-version=4.2.1 -vectorize-loops -vectorize-slp -analyzer-checker core -analyzer-checker cplusplus -analyzer-checker nullability -analyzer-checker optin -analyzer-checker security -analyzer-checker unix -analyzer-checker osx -analyzer-checker fuchsia -analyzer-checker webkit -analyzer-output=html -faddrsig -o /tmp/scan-build-2020-11-20-015525-12771-1 -x c lj_alloc.c
</div>
<div id='tooltiphint' hidden="true">
  <p>Keyboard shortcuts: </p>
  <ul>
    <li>Use 'j/k' keys for keyboard navigation</li>
    <li>Use 'Shift+S' to show/hide relevant lines</li>
    <li>Use '?' to toggle this window</li>
  </ul>
  <a href="#" onclick="toggleHelp(); return false;">Close</a>
</div>
<script type='text/javascript'>
var relevant_lines = {"1": {"1370": 1}};

var filterCounterexample = function (hide) {
  var tables = document.getElementsByClassName("code");
  for (var t=0; t<tables.length; t++) {
    var table = tables[t];
    var file_id = table.getAttribute("data-fileid");
    var lines_in_fid = relevant_lines[file_id];
    if (!lines_in_fid) {
      lines_in_fid = {};
    }
    var lines = table.getElementsByClassName("codeline");
    for (var i=0; i<lines.length; i++) {
        var el = lines[i];
        var lineNo = el.getAttribute("data-linenumber");
        if (!lines_in_fid[lineNo]) {
          if (hide) {
            el.setAttribute("hidden", "");
          } else {
            el.removeAttribute("hidden");
          }
        }
    }
  }
}

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "S") {
    var checked = document.getElementsByName("showCounterexample")[0].checked;
    filterCounterexample(!checked);
    document.getElementsByName("showCounterexample")[0].checked = !checked;
  } else {
    return;
  }
  event.preventDefault();
}, true);

document.addEventListener("DOMContentLoaded", function() {
    document.querySelector('input[name="showCounterexample"]').onchange=
        function (event) {
      filterCounterexample(this.checked);
    };
});
</script>

<form>
    <input type="checkbox" name="showCounterexample" id="showCounterexample" />
    <label for="showCounterexample">
       Show only relevant lines
    </label>
</form>

<script type='text/javascript'>
var digitMatcher = new RegExp("[0-9]+");

var querySelectorAllArray = function(selector) {
  return Array.prototype.slice.call(
    document.querySelectorAll(selector));
}

document.addEventListener("DOMContentLoaded", function() {
    querySelectorAllArray(".PathNav > a").forEach(
        function(currentValue, currentIndex) {
            var hrefValue = currentValue.getAttribute("href");
            currentValue.onclick = function() {
                scrollTo(document.querySelector(hrefValue));
                return false;
            };
        });
});

var findNum = function() {
    var s = document.querySelector(".selected");
    if (!s || s.id == "EndPath") {
        return 0;
    }
    var out = parseInt(digitMatcher.exec(s.id)[0]);
    return out;
};

var scrollTo = function(el) {
    querySelectorAllArray(".selected").forEach(function(s) {
        s.classList.remove("selected");
    });
    el.classList.add("selected");
    window.scrollBy(0, el.getBoundingClientRect().top -
        (window.innerHeight / 2));
}

var move = function(num, up, numItems) {
  if (num == 1 && up || num == numItems - 1 && !up) {
    return 0;
  } else if (num == 0 && up) {
    return numItems - 1;
  } else if (num == 0 && !up) {
    return 1 % numItems;
  }
  return up ? num - 1 : num + 1;
}

var numToId = function(num) {
  if (num == 0) {
    return document.getElementById("EndPath")
  }
  return document.getElementById("Path" + num);
};

var navigateTo = function(up) {
  var numItems = document.querySelectorAll(
      ".line > .msgEvent, .line > .msgControl").length;
  var currentSelected = findNum();
  var newSelected = move(currentSelected, up, numItems);
  var newEl = numToId(newSelected, numItems);

  // Scroll element into center.
  scrollTo(newEl);
};

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "j") {
    navigateTo(/*up=*/false);
  } else if (event.key == "k") {
    navigateTo(/*up=*/true);
  } else {
    return;
  }
  event.preventDefault();
}, true);
</script>
  
<script type='text/javascript'>

var toggleHelp = function() {
    var hint = document.querySelector("#tooltiphint");
    var attributeName = "hidden";
    if (hint.hasAttribute(attributeName)) {
      hint.removeAttribute(attributeName);
    } else {
      hint.setAttribute("hidden", "true");
    }
};
window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "?") {
    toggleHelp();
  } else {
    return;
  }
  event.preventDefault();
});
</script>
<table class="code" data-fileid="1">
<tr class="codeline" data-linenumber="1"><td class="num" id="LN1">1</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2"><td class="num" id="LN2">2</td><td class="line"><span class='comment'>** Bundled memory allocator.</span></td></tr>
<tr class="codeline" data-linenumber="3"><td class="num" id="LN3">3</td><td class="line"><span class='comment'>**</span></td></tr>
<tr class="codeline" data-linenumber="4"><td class="num" id="LN4">4</td><td class="line"><span class='comment'>** Beware: this is a HEAVILY CUSTOMIZED version of dlmalloc.</span></td></tr>
<tr class="codeline" data-linenumber="5"><td class="num" id="LN5">5</td><td class="line"><span class='comment'>** The original bears the following remark:</span></td></tr>
<tr class="codeline" data-linenumber="6"><td class="num" id="LN6">6</td><td class="line"><span class='comment'>**</span></td></tr>
<tr class="codeline" data-linenumber="7"><td class="num" id="LN7">7</td><td class="line"><span class='comment'>**   This is a version (aka dlmalloc) of malloc/free/realloc written by</span></td></tr>
<tr class="codeline" data-linenumber="8"><td class="num" id="LN8">8</td><td class="line"><span class='comment'>**   Doug Lea and released to the public domain, as explained at</span></td></tr>
<tr class="codeline" data-linenumber="9"><td class="num" id="LN9">9</td><td class="line"><span class='comment'>**   http://creativecommons.org/licenses/publicdomain.</span></td></tr>
<tr class="codeline" data-linenumber="10"><td class="num" id="LN10">10</td><td class="line"><span class='comment'>**</span></td></tr>
<tr class="codeline" data-linenumber="11"><td class="num" id="LN11">11</td><td class="line"><span class='comment'>**   * Version pre-2.8.4 Wed Mar 29 19:46:29 2006    (dl at gee)</span></td></tr>
<tr class="codeline" data-linenumber="12"><td class="num" id="LN12">12</td><td class="line"><span class='comment'>**</span></td></tr>
<tr class="codeline" data-linenumber="13"><td class="num" id="LN13">13</td><td class="line"><span class='comment'>** No additional copyright is claimed over the customizations.</span></td></tr>
<tr class="codeline" data-linenumber="14"><td class="num" id="LN14">14</td><td class="line"><span class='comment'>** Please do NOT bother the original author about this version here!</span></td></tr>
<tr class="codeline" data-linenumber="15"><td class="num" id="LN15">15</td><td class="line"><span class='comment'>**</span></td></tr>
<tr class="codeline" data-linenumber="16"><td class="num" id="LN16">16</td><td class="line"><span class='comment'>** If you want to use dlmalloc in another project, you should get</span></td></tr>
<tr class="codeline" data-linenumber="17"><td class="num" id="LN17">17</td><td class="line"><span class='comment'>** the original from: ftp://gee.cs.oswego.edu/pub/misc/</span></td></tr>
<tr class="codeline" data-linenumber="18"><td class="num" id="LN18">18</td><td class="line"><span class='comment'>** For thread-safe derivatives, take a look at:</span></td></tr>
<tr class="codeline" data-linenumber="19"><td class="num" id="LN19">19</td><td class="line"><span class='comment'>** - ptmalloc: http://www.malloc.de/</span></td></tr>
<tr class="codeline" data-linenumber="20"><td class="num" id="LN20">20</td><td class="line"><span class='comment'>** - nedmalloc: http://www.nedprod.com/programs/portable/nedmalloc/</span></td></tr>
<tr class="codeline" data-linenumber="21"><td class="num" id="LN21">21</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="22"><td class="num" id="LN22">22</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="23"><td class="num" id="LN23">23</td><td class="line"><span class='directive'>#define lj_alloc_c</span></td></tr>
<tr class="codeline" data-linenumber="24"><td class="num" id="LN24">24</td><td class="line"><span class='directive'>#define LUA_CORE</span></td></tr>
<tr class="codeline" data-linenumber="25"><td class="num" id="LN25">25</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="26"><td class="num" id="LN26">26</td><td class="line"><span class='comment'>/* To get the mremap prototype. Must be defined before any system includes. */</span></td></tr>
<tr class="codeline" data-linenumber="27"><td class="num" id="LN27">27</td><td class="line"><span class='directive'>#if defined(<span class='macro'>__linux__<span class='macro_popup'>1</span></span>) &amp;&amp; !defined(_GNU_SOURCE)</span></td></tr>
<tr class="codeline" data-linenumber="28"><td class="num" id="LN28">28</td><td class="line"><span class='directive'>#define _GNU_SOURCE</span></td></tr>
<tr class="codeline" data-linenumber="29"><td class="num" id="LN29">29</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="30"><td class="num" id="LN30">30</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="31"><td class="num" id="LN31">31</td><td class="line"><span class='directive'>#include "lj_def.h"</span></td></tr>
<tr class="codeline" data-linenumber="32"><td class="num" id="LN32">32</td><td class="line"><span class='directive'>#include "lj_arch.h"</span></td></tr>
<tr class="codeline" data-linenumber="33"><td class="num" id="LN33">33</td><td class="line"><span class='directive'>#include "lj_alloc.h"</span></td></tr>
<tr class="codeline" data-linenumber="34"><td class="num" id="LN34">34</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="35"><td class="num" id="LN35">35</td><td class="line"><span class='directive'>#ifndef LUAJIT_USE_SYSMALLOC</span></td></tr>
<tr class="codeline" data-linenumber="36"><td class="num" id="LN36">36</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="37"><td class="num" id="LN37">37</td><td class="line"><span class='directive'>#define <span class='macro'>MAX_SIZE_T<span class='macro_popup'>(~(size_t)0)</span></span>		(~(size_t)0)</span></td></tr>
<tr class="codeline" data-linenumber="38"><td class="num" id="LN38">38</td><td class="line"><span class='directive'>#define <span class='macro'>MALLOC_ALIGNMENT<span class='macro_popup'>((size_t)8U)</span></span>	((size_t)8U)</span></td></tr>
<tr class="codeline" data-linenumber="39"><td class="num" id="LN39">39</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="40"><td class="num" id="LN40">40</td><td class="line"><span class='directive'>#define <span class='macro'>DEFAULT_GRANULARITY<span class='macro_popup'>((size_t)128U * (size_t)1024U)</span></span>	((size_t)128U * (size_t)1024U)</span></td></tr>
<tr class="codeline" data-linenumber="41"><td class="num" id="LN41">41</td><td class="line"><span class='directive'>#define <span class='macro'>DEFAULT_TRIM_THRESHOLD<span class='macro_popup'>((size_t)2U * (size_t)1024U * (size_t)1024U)</span></span>	((size_t)2U * (size_t)1024U * (size_t)1024U)</span></td></tr>
<tr class="codeline" data-linenumber="42"><td class="num" id="LN42">42</td><td class="line"><span class='directive'>#define <span class='macro'>DEFAULT_MMAP_THRESHOLD<span class='macro_popup'>((size_t)128U * (size_t)1024U)</span></span>	((size_t)128U * (size_t)1024U)</span></td></tr>
<tr class="codeline" data-linenumber="43"><td class="num" id="LN43">43</td><td class="line"><span class='directive'>#define <span class='macro'>MAX_RELEASE_CHECK_RATE<span class='macro_popup'>255</span></span>	255</span></td></tr>
<tr class="codeline" data-linenumber="44"><td class="num" id="LN44">44</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="45"><td class="num" id="LN45">45</td><td class="line"><span class='comment'>/* ------------------- size_t and alignment properties -------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="46"><td class="num" id="LN46">46</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="47"><td class="num" id="LN47">47</td><td class="line"><span class='comment'>/* The byte and bit size of a size_t */</span></td></tr>
<tr class="codeline" data-linenumber="48"><td class="num" id="LN48">48</td><td class="line"><span class='directive'>#define <span class='macro'>SIZE_T_SIZE<span class='macro_popup'>(sizeof(size_t))</span></span>		(sizeof(size_t))</span></td></tr>
<tr class="codeline" data-linenumber="49"><td class="num" id="LN49">49</td><td class="line"><span class='directive'>#define <span class='macro'>SIZE_T_BITSIZE<span class='macro_popup'>(sizeof(size_t) &lt;&lt; 3)</span></span>		(sizeof(size_t) &lt;&lt; 3)</span></td></tr>
<tr class="codeline" data-linenumber="50"><td class="num" id="LN50">50</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="51"><td class="num" id="LN51">51</td><td class="line"><span class='comment'>/* Some constants coerced to size_t */</span></td></tr>
<tr class="codeline" data-linenumber="52"><td class="num" id="LN52">52</td><td class="line"><span class='comment'>/* Annoying but necessary to avoid errors on some platforms */</span></td></tr>
<tr class="codeline" data-linenumber="53"><td class="num" id="LN53">53</td><td class="line"><span class='directive'>#define <span class='macro'>SIZE_T_ZERO<span class='macro_popup'>((size_t)0)</span></span>		((size_t)0)</span></td></tr>
<tr class="codeline" data-linenumber="54"><td class="num" id="LN54">54</td><td class="line"><span class='directive'>#define <span class='macro'>SIZE_T_ONE<span class='macro_popup'>((size_t)1)</span></span>		((size_t)1)</span></td></tr>
<tr class="codeline" data-linenumber="55"><td class="num" id="LN55">55</td><td class="line"><span class='directive'>#define <span class='macro'>SIZE_T_TWO<span class='macro_popup'>((size_t)2)</span></span>		((size_t)2)</span></td></tr>
<tr class="codeline" data-linenumber="56"><td class="num" id="LN56">56</td><td class="line"><span class='directive'>#define <span class='macro'>TWO_SIZE_T_SIZES<span class='macro_popup'>((sizeof(size_t))&lt;&lt;1)</span></span>	(<span class='macro'>SIZE_T_SIZE<span class='macro_popup'>(sizeof(size_t))</span></span>&lt;&lt;1)</span></td></tr>
<tr class="codeline" data-linenumber="57"><td class="num" id="LN57">57</td><td class="line"><span class='directive'>#define <span class='macro'>FOUR_SIZE_T_SIZES<span class='macro_popup'>((sizeof(size_t))&lt;&lt;2)</span></span>	(<span class='macro'>SIZE_T_SIZE<span class='macro_popup'>(sizeof(size_t))</span></span>&lt;&lt;2)</span></td></tr>
<tr class="codeline" data-linenumber="58"><td class="num" id="LN58">58</td><td class="line"><span class='directive'>#define <span class='macro'>SIX_SIZE_T_SIZES<span class='macro_popup'>(((sizeof(size_t))&lt;&lt;2)+((sizeof(size_t))&lt;&lt;1))</span></span>	(<span class='macro'>FOUR_SIZE_T_SIZES<span class='macro_popup'>((sizeof(size_t))&lt;&lt;2)</span></span>+<span class='macro'>TWO_SIZE_T_SIZES<span class='macro_popup'>((sizeof(size_t))&lt;&lt;1)</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="59"><td class="num" id="LN59">59</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="60"><td class="num" id="LN60">60</td><td class="line"><span class='comment'>/* The bit mask value corresponding to MALLOC_ALIGNMENT */</span></td></tr>
<tr class="codeline" data-linenumber="61"><td class="num" id="LN61">61</td><td class="line"><span class='directive'>#define <span class='macro'>CHUNK_ALIGN_MASK<span class='macro_popup'>(((size_t)8U) - ((size_t)1))</span></span>	(<span class='macro'>MALLOC_ALIGNMENT<span class='macro_popup'>((size_t)8U)</span></span> - <span class='macro'>SIZE_T_ONE<span class='macro_popup'>((size_t)1)</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="62"><td class="num" id="LN62">62</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="63"><td class="num" id="LN63">63</td><td class="line"><span class='comment'>/* the number of bytes to offset an address to align it */</span></td></tr>
<tr class="codeline" data-linenumber="64"><td class="num" id="LN64">64</td><td class="line"><span class='directive'>#define <span class='macro'>align_offset(A)<span class='macro_popup'>((((size_t)(A) &amp; (((size_t)8U) - ((size_t)1))) == 0)? 0 :<br> ((((size_t)8U) - ((size_t)(A) &amp; (((size_t)8U) - ((size_t<br>)1)))) &amp; (((size_t)8U) - ((size_t)1))))</span></span>\</span></td></tr>
<tr class="codeline" data-linenumber="65"><td class="num" id="LN65">65</td><td class="line"> <span class='directive'>((((size_t)(A) &amp; <span class='macro'>CHUNK_ALIGN_MASK<span class='macro_popup'>(((size_t)8U) - ((size_t)1))</span></span>) == 0)? 0 :\</span></td></tr>
<tr class="codeline" data-linenumber="66"><td class="num" id="LN66">66</td><td class="line">  <span class='directive'>((<span class='macro'>MALLOC_ALIGNMENT<span class='macro_popup'>((size_t)8U)</span></span> - ((size_t)(A) &amp; <span class='macro'>CHUNK_ALIGN_MASK<span class='macro_popup'>(((size_t)8U) - ((size_t)1))</span></span>)) &amp; <span class='macro'>CHUNK_ALIGN_MASK<span class='macro_popup'>(((size_t)8U) - ((size_t)1))</span></span>))</span></td></tr>
<tr class="codeline" data-linenumber="67"><td class="num" id="LN67">67</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="68"><td class="num" id="LN68">68</td><td class="line"><span class='comment'>/* -------------------------- MMAP support ------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="69"><td class="num" id="LN69">69</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="70"><td class="num" id="LN70">70</td><td class="line"><span class='directive'>#define <span class='macro'>MFAIL<span class='macro_popup'>((void *)((~(size_t)0)))</span></span>			((void *)(<span class='macro'>MAX_SIZE_T<span class='macro_popup'>(~(size_t)0)</span></span>))</span></td></tr>
<tr class="codeline" data-linenumber="71"><td class="num" id="LN71">71</td><td class="line"><span class='directive'>#define <span class='macro'>CMFAIL<span class='macro_popup'>((char *)(((void *)((~(size_t)0)))))</span></span>			((char *)(<span class='macro'>MFAIL<span class='macro_popup'>((void *)((~(size_t)0)))</span></span>)) /* defined for convenience */</span></td></tr>
<tr class="codeline" data-linenumber="72"><td class="num" id="LN72">72</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="73"><td class="num" id="LN73">73</td><td class="line"><span class='directive'>#define <span class='macro'>IS_DIRECT_BIT<span class='macro_popup'>(((size_t)1))</span></span>		(<span class='macro'>SIZE_T_ONE<span class='macro_popup'>((size_t)1)</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="74"><td class="num" id="LN74">74</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="75"><td class="num" id="LN75">75</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_TARGET_WINDOWS<span class='macro_popup'>(2 == 1)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="76"><td class="num" id="LN76">76</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="77"><td class="num" id="LN77">77</td><td class="line"><span class='directive'>#define WIN32_LEAN_AND_MEAN</span></td></tr>
<tr class="codeline" data-linenumber="78"><td class="num" id="LN78">78</td><td class="line"><span class='directive'>#include &lt;windows.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="79"><td class="num" id="LN79">79</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="80"><td class="num" id="LN80">80</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_64<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="81"><td class="num" id="LN81">81</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="82"><td class="num" id="LN82">82</td><td class="line"><span class='comment'>/* Undocumented, but hey, that's what we all love so much about Windows. */</span></td></tr>
<tr class="codeline" data-linenumber="83"><td class="num" id="LN83">83</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>long</span> (*PNTAVM)(HANDLE handle, <span class='keyword'>void</span> **addr, ULONG zbits,</td></tr>
<tr class="codeline" data-linenumber="84"><td class="num" id="LN84">84</td><td class="line">		       size_t *size, ULONG alloctype, ULONG prot);</td></tr>
<tr class="codeline" data-linenumber="85"><td class="num" id="LN85">85</td><td class="line"><span class='keyword'>static</span> PNTAVM ntavm;</td></tr>
<tr class="codeline" data-linenumber="86"><td class="num" id="LN86">86</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="87"><td class="num" id="LN87">87</td><td class="line"><span class='comment'>/* Number of top bits of the lower 32 bits of an address that must be zero.</span></td></tr>
<tr class="codeline" data-linenumber="88"><td class="num" id="LN88">88</td><td class="line"><span class='comment'>** Apparently 0 gives us full 64 bit addresses and 1 gives us the lower 2GB.</span></td></tr>
<tr class="codeline" data-linenumber="89"><td class="num" id="LN89">89</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="90"><td class="num" id="LN90">90</td><td class="line"><span class='directive'>#define NTAVM_ZEROBITS		1</span></td></tr>
<tr class="codeline" data-linenumber="91"><td class="num" id="LN91">91</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="92"><td class="num" id="LN92">92</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> INIT_MMAP(<span class='keyword'>void</span>)</td></tr>
<tr class="codeline" data-linenumber="93"><td class="num" id="LN93">93</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="94"><td class="num" id="LN94">94</td><td class="line">  ntavm = (PNTAVM)GetProcAddress(GetModuleHandleA(<span class='string_literal'>"ntdll.dll"</span>),</td></tr>
<tr class="codeline" data-linenumber="95"><td class="num" id="LN95">95</td><td class="line">				 <span class='string_literal'>"NtAllocateVirtualMemory"</span>);</td></tr>
<tr class="codeline" data-linenumber="96"><td class="num" id="LN96">96</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="97"><td class="num" id="LN97">97</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="98"><td class="num" id="LN98">98</td><td class="line"><span class='comment'>/* Win64 32 bit MMAP via NtAllocateVirtualMemory. */</span></td></tr>
<tr class="codeline" data-linenumber="99"><td class="num" id="LN99">99</td><td class="line"><span class='keyword'>static</span> <span class='macro'>LJ_AINLINE<span class='macro_popup'>inline __attribute__((always_inline))</span></span> <span class='keyword'>void</span> *CALL_MMAP(size_t size)</td></tr>
<tr class="codeline" data-linenumber="100"><td class="num" id="LN100">100</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="101"><td class="num" id="LN101">101</td><td class="line">  DWORD olderr = GetLastError();</td></tr>
<tr class="codeline" data-linenumber="102"><td class="num" id="LN102">102</td><td class="line">  <span class='keyword'>void</span> *ptr = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="103"><td class="num" id="LN103">103</td><td class="line">  <span class='keyword'>long</span> st = ntavm(INVALID_HANDLE_VALUE, &amp;ptr, NTAVM_ZEROBITS, &amp;size,</td></tr>
<tr class="codeline" data-linenumber="104"><td class="num" id="LN104">104</td><td class="line">		  MEM_RESERVE|MEM_COMMIT, PAGE_READWRITE);</td></tr>
<tr class="codeline" data-linenumber="105"><td class="num" id="LN105">105</td><td class="line">  SetLastError(olderr);</td></tr>
<tr class="codeline" data-linenumber="106"><td class="num" id="LN106">106</td><td class="line">  <span class='keyword'>return</span> st == 0 ? ptr : <span class='macro'>MFAIL<span class='macro_popup'>((void *)((~(size_t)0)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="107"><td class="num" id="LN107">107</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="108"><td class="num" id="LN108">108</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="109"><td class="num" id="LN109">109</td><td class="line"><span class='comment'>/* For direct MMAP, use MEM_TOP_DOWN to minimize interference */</span></td></tr>
<tr class="codeline" data-linenumber="110"><td class="num" id="LN110">110</td><td class="line"><span class='keyword'>static</span> <span class='macro'>LJ_AINLINE<span class='macro_popup'>inline __attribute__((always_inline))</span></span> <span class='keyword'>void</span> *<span class='macro'>DIRECT_MMAP(size_t size)<span class='macro_popup'>CALL_MMAP(size_t size)</span></span></td></tr>
<tr class="codeline" data-linenumber="111"><td class="num" id="LN111">111</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="112"><td class="num" id="LN112">112</td><td class="line">  DWORD olderr = GetLastError();</td></tr>
<tr class="codeline" data-linenumber="113"><td class="num" id="LN113">113</td><td class="line">  <span class='keyword'>void</span> *ptr = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="114"><td class="num" id="LN114">114</td><td class="line">  <span class='keyword'>long</span> st = ntavm(INVALID_HANDLE_VALUE, &amp;ptr, NTAVM_ZEROBITS, &amp;size,</td></tr>
<tr class="codeline" data-linenumber="115"><td class="num" id="LN115">115</td><td class="line">		  MEM_RESERVE|MEM_COMMIT|MEM_TOP_DOWN, PAGE_READWRITE);</td></tr>
<tr class="codeline" data-linenumber="116"><td class="num" id="LN116">116</td><td class="line">  SetLastError(olderr);</td></tr>
<tr class="codeline" data-linenumber="117"><td class="num" id="LN117">117</td><td class="line">  <span class='keyword'>return</span> st == 0 ? ptr : <span class='macro'>MFAIL<span class='macro_popup'>((void *)((~(size_t)0)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="118"><td class="num" id="LN118">118</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="119"><td class="num" id="LN119">119</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="120"><td class="num" id="LN120">120</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="121"><td class="num" id="LN121">121</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="122"><td class="num" id="LN122">122</td><td class="line"><span class='directive'>#define <span class='macro'>INIT_MMAP()<span class='macro_popup'>((void)0)</span></span>		((void)0)</span></td></tr>
<tr class="codeline" data-linenumber="123"><td class="num" id="LN123">123</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="124"><td class="num" id="LN124">124</td><td class="line"><span class='comment'>/* Win32 MMAP via VirtualAlloc */</span></td></tr>
<tr class="codeline" data-linenumber="125"><td class="num" id="LN125">125</td><td class="line"><span class='keyword'>static</span> <span class='macro'>LJ_AINLINE<span class='macro_popup'>inline __attribute__((always_inline))</span></span> <span class='keyword'>void</span> *CALL_MMAP(size_t size)</td></tr>
<tr class="codeline" data-linenumber="126"><td class="num" id="LN126">126</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="127"><td class="num" id="LN127">127</td><td class="line">  DWORD olderr = GetLastError();</td></tr>
<tr class="codeline" data-linenumber="128"><td class="num" id="LN128">128</td><td class="line">  <span class='keyword'>void</span> *ptr = VirtualAlloc(0, size, MEM_RESERVE|MEM_COMMIT, PAGE_READWRITE);</td></tr>
<tr class="codeline" data-linenumber="129"><td class="num" id="LN129">129</td><td class="line">  SetLastError(olderr);</td></tr>
<tr class="codeline" data-linenumber="130"><td class="num" id="LN130">130</td><td class="line">  <span class='keyword'>return</span> ptr ? ptr : <span class='macro'>MFAIL<span class='macro_popup'>((void *)((~(size_t)0)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="131"><td class="num" id="LN131">131</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="132"><td class="num" id="LN132">132</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="133"><td class="num" id="LN133">133</td><td class="line"><span class='comment'>/* For direct MMAP, use MEM_TOP_DOWN to minimize interference */</span></td></tr>
<tr class="codeline" data-linenumber="134"><td class="num" id="LN134">134</td><td class="line"><span class='keyword'>static</span> <span class='macro'>LJ_AINLINE<span class='macro_popup'>inline __attribute__((always_inline))</span></span> <span class='keyword'>void</span> *<span class='macro'>DIRECT_MMAP(size_t size)<span class='macro_popup'>CALL_MMAP(size_t size)</span></span></td></tr>
<tr class="codeline" data-linenumber="135"><td class="num" id="LN135">135</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="136"><td class="num" id="LN136">136</td><td class="line">  DWORD olderr = GetLastError();</td></tr>
<tr class="codeline" data-linenumber="137"><td class="num" id="LN137">137</td><td class="line">  <span class='keyword'>void</span> *ptr = VirtualAlloc(0, size, MEM_RESERVE|MEM_COMMIT|MEM_TOP_DOWN,</td></tr>
<tr class="codeline" data-linenumber="138"><td class="num" id="LN138">138</td><td class="line">			   PAGE_READWRITE);</td></tr>
<tr class="codeline" data-linenumber="139"><td class="num" id="LN139">139</td><td class="line">  SetLastError(olderr);</td></tr>
<tr class="codeline" data-linenumber="140"><td class="num" id="LN140">140</td><td class="line">  <span class='keyword'>return</span> ptr ? ptr : <span class='macro'>MFAIL<span class='macro_popup'>((void *)((~(size_t)0)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="141"><td class="num" id="LN141">141</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="142"><td class="num" id="LN142">142</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="143"><td class="num" id="LN143">143</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="144"><td class="num" id="LN144">144</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="145"><td class="num" id="LN145">145</td><td class="line"><span class='comment'>/* This function supports releasing coalesed segments */</span></td></tr>
<tr class="codeline" data-linenumber="146"><td class="num" id="LN146">146</td><td class="line"><span class='keyword'>static</span> <span class='macro'>LJ_AINLINE<span class='macro_popup'>inline __attribute__((always_inline))</span></span> <span class='keyword'>int</span> CALL_MUNMAP(<span class='keyword'>void</span> *ptr, size_t size)</td></tr>
<tr class="codeline" data-linenumber="147"><td class="num" id="LN147">147</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="148"><td class="num" id="LN148">148</td><td class="line">  DWORD olderr = GetLastError();</td></tr>
<tr class="codeline" data-linenumber="149"><td class="num" id="LN149">149</td><td class="line">  MEMORY_BASIC_INFORMATION minfo;</td></tr>
<tr class="codeline" data-linenumber="150"><td class="num" id="LN150">150</td><td class="line">  <span class='keyword'>char</span> *cptr = (<span class='keyword'>char</span> *)ptr;</td></tr>
<tr class="codeline" data-linenumber="151"><td class="num" id="LN151">151</td><td class="line">  <span class='keyword'>while</span> (size) {</td></tr>
<tr class="codeline" data-linenumber="152"><td class="num" id="LN152">152</td><td class="line">    <span class='keyword'>if</span> (VirtualQuery(cptr, &amp;minfo, <span class='keyword'>sizeof</span>(minfo)) == 0)</td></tr>
<tr class="codeline" data-linenumber="153"><td class="num" id="LN153">153</td><td class="line">      <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="154"><td class="num" id="LN154">154</td><td class="line">    <span class='keyword'>if</span> (minfo.BaseAddress != cptr || minfo.AllocationBase != cptr ||</td></tr>
<tr class="codeline" data-linenumber="155"><td class="num" id="LN155">155</td><td class="line">	minfo.State != MEM_COMMIT || minfo.RegionSize &gt; size)</td></tr>
<tr class="codeline" data-linenumber="156"><td class="num" id="LN156">156</td><td class="line">      <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="157"><td class="num" id="LN157">157</td><td class="line">    <span class='keyword'>if</span> (VirtualFree(cptr, 0, MEM_RELEASE) == 0)</td></tr>
<tr class="codeline" data-linenumber="158"><td class="num" id="LN158">158</td><td class="line">      <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="159"><td class="num" id="LN159">159</td><td class="line">    cptr += minfo.RegionSize;</td></tr>
<tr class="codeline" data-linenumber="160"><td class="num" id="LN160">160</td><td class="line">    size -= minfo.RegionSize;</td></tr>
<tr class="codeline" data-linenumber="161"><td class="num" id="LN161">161</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="162"><td class="num" id="LN162">162</td><td class="line">  SetLastError(olderr);</td></tr>
<tr class="codeline" data-linenumber="163"><td class="num" id="LN163">163</td><td class="line">  <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="164"><td class="num" id="LN164">164</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="165"><td class="num" id="LN165">165</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="166"><td class="num" id="LN166">166</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="167"><td class="num" id="LN167">167</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="168"><td class="num" id="LN168">168</td><td class="line"><span class='directive'>#include &lt;<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="169"><td class="num" id="LN169">169</td><td class="line"><span class='directive'>#include &lt;sys/mman.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="170"><td class="num" id="LN170">170</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="171"><td class="num" id="LN171">171</td><td class="line"><span class='directive'>#define <span class='macro'>MMAP_PROT<span class='macro_popup'>(0x1|0x2)</span></span>		(<span class='macro'>PROT_READ<span class='macro_popup'>0x1</span></span>|<span class='macro'>PROT_WRITE<span class='macro_popup'>0x2</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="172"><td class="num" id="LN172">172</td><td class="line"><span class='directive'>#if !defined(<span class='macro'>MAP_ANONYMOUS<span class='macro_popup'>0x20</span></span>) &amp;&amp; defined(<span class='macro'>MAP_ANON<span class='macro_popup'>0x20</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="173"><td class="num" id="LN173">173</td><td class="line"><span class='directive'>#define <span class='macro'>MAP_ANONYMOUS<span class='macro_popup'>0x20</span></span>		<span class='macro'>MAP_ANON<span class='macro_popup'>0x20</span></span></span></td></tr>
<tr class="codeline" data-linenumber="174"><td class="num" id="LN174">174</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="175"><td class="num" id="LN175">175</td><td class="line"><span class='directive'>#define <span class='macro'>MMAP_FLAGS<span class='macro_popup'>(0x02|0x20)</span></span>		(<span class='macro'>MAP_PRIVATE<span class='macro_popup'>0x02</span></span>|<span class='macro'>MAP_ANONYMOUS<span class='macro_popup'>0x20</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="176"><td class="num" id="LN176">176</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="177"><td class="num" id="LN177">177</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_64<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="178"><td class="num" id="LN178">178</td><td class="line"><span class='comment'>/* 64 bit mode needs special support for allocating memory in the lower 2GB. */</span></td></tr>
<tr class="codeline" data-linenumber="179"><td class="num" id="LN179">179</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="180"><td class="num" id="LN180">180</td><td class="line"><span class='directive'>#if defined(<span class='macro'>MAP_32BIT<span class='macro_popup'>0x40</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="181"><td class="num" id="LN181">181</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="182"><td class="num" id="LN182">182</td><td class="line"><span class='comment'>/* Actually this only gives us max. 1GB in current Linux kernels. */</span></td></tr>
<tr class="codeline" data-linenumber="183"><td class="num" id="LN183">183</td><td class="line"><span class='keyword'>static</span> <span class='macro'>LJ_AINLINE<span class='macro_popup'>inline __attribute__((always_inline))</span></span> <span class='keyword'>void</span> *CALL_MMAP(size_t size)</td></tr>
<tr class="codeline" data-linenumber="184"><td class="num" id="LN184">184</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="185"><td class="num" id="LN185">185</td><td class="line">  <span class='keyword'>int</span> olderr = <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>;</td></tr>
<tr class="codeline" data-linenumber="186"><td class="num" id="LN186">186</td><td class="line">  <span class='keyword'>void</span> *ptr = mmap(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, size, <span class='macro'>MMAP_PROT<span class='macro_popup'>(0x1|0x2)</span></span>, <span class='macro'>MAP_32BIT<span class='macro_popup'>0x40</span></span>|<span class='macro'>MMAP_FLAGS<span class='macro_popup'>(0x02|0x20)</span></span>, -1, 0);</td></tr>
<tr class="codeline" data-linenumber="187"><td class="num" id="LN187">187</td><td class="line">  <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> = olderr;</td></tr>
<tr class="codeline" data-linenumber="188"><td class="num" id="LN188">188</td><td class="line">  <span class='keyword'>return</span> ptr;</td></tr>
<tr class="codeline" data-linenumber="189"><td class="num" id="LN189">189</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="190"><td class="num" id="LN190">190</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="191"><td class="num" id="LN191">191</td><td class="line"><span class='directive'>#elif <span class='macro'>LJ_TARGET_OSX<span class='macro_popup'>(2 == 3)</span></span> || LJ_TARGET_PS4 || defined(__FreeBSD__) || defined(__FreeBSD_kernel__) || defined(__NetBSD__) || defined(__OpenBSD__) || defined(__sun__)</span></td></tr>
<tr class="codeline" data-linenumber="192"><td class="num" id="LN192">192</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="193"><td class="num" id="LN193">193</td><td class="line"><span class='comment'>/* OSX and FreeBSD mmap() use a naive first-fit linear search.</span></td></tr>
<tr class="codeline" data-linenumber="194"><td class="num" id="LN194">194</td><td class="line"><span class='comment'>** That's perfect for us. Except that -pagezero_size must be set for OSX,</span></td></tr>
<tr class="codeline" data-linenumber="195"><td class="num" id="LN195">195</td><td class="line"><span class='comment'>** otherwise the lower 4GB are blocked. And the 32GB RLIMIT_DATA needs</span></td></tr>
<tr class="codeline" data-linenumber="196"><td class="num" id="LN196">196</td><td class="line"><span class='comment'>** to be reduced to 250MB on FreeBSD.</span></td></tr>
<tr class="codeline" data-linenumber="197"><td class="num" id="LN197">197</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="198"><td class="num" id="LN198">198</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_TARGET_OSX<span class='macro_popup'>(2 == 3)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="199"><td class="num" id="LN199">199</td><td class="line"><span class='directive'>#define MMAP_REGION_START	((uintptr_t)0x10000)</span></td></tr>
<tr class="codeline" data-linenumber="200"><td class="num" id="LN200">200</td><td class="line"><span class='directive'>#elif LJ_TARGET_PS4</span></td></tr>
<tr class="codeline" data-linenumber="201"><td class="num" id="LN201">201</td><td class="line"><span class='directive'>#define MMAP_REGION_START	((uintptr_t)0x4000)</span></td></tr>
<tr class="codeline" data-linenumber="202"><td class="num" id="LN202">202</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="203"><td class="num" id="LN203">203</td><td class="line"><span class='directive'>#define MMAP_REGION_START	((uintptr_t)0x10000000)</span></td></tr>
<tr class="codeline" data-linenumber="204"><td class="num" id="LN204">204</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="205"><td class="num" id="LN205">205</td><td class="line"><span class='directive'>#define MMAP_REGION_END		((uintptr_t)0x80000000)</span></td></tr>
<tr class="codeline" data-linenumber="206"><td class="num" id="LN206">206</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="207"><td class="num" id="LN207">207</td><td class="line"><span class='directive'>#if (defined(__FreeBSD__) || defined(__FreeBSD_kernel__)) &amp;&amp; !LJ_TARGET_PS4</span></td></tr>
<tr class="codeline" data-linenumber="208"><td class="num" id="LN208">208</td><td class="line"><span class='directive'>#include &lt;sys/resource.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="209"><td class="num" id="LN209">209</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="210"><td class="num" id="LN210">210</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="211"><td class="num" id="LN211">211</td><td class="line"><span class='keyword'>static</span> <span class='macro'>LJ_AINLINE<span class='macro_popup'>inline __attribute__((always_inline))</span></span> <span class='keyword'>void</span> *CALL_MMAP(size_t size)</td></tr>
<tr class="codeline" data-linenumber="212"><td class="num" id="LN212">212</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="213"><td class="num" id="LN213">213</td><td class="line">  <span class='keyword'>int</span> olderr = <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>;</td></tr>
<tr class="codeline" data-linenumber="214"><td class="num" id="LN214">214</td><td class="line">  <span class='comment'>/* Hint for next allocation. Doesn't need to be thread-safe. */</span></td></tr>
<tr class="codeline" data-linenumber="215"><td class="num" id="LN215">215</td><td class="line">  <span class='keyword'>static</span> uintptr_t alloc_hint = MMAP_REGION_START;</td></tr>
<tr class="codeline" data-linenumber="216"><td class="num" id="LN216">216</td><td class="line">  <span class='keyword'>int</span> retry = 0;</td></tr>
<tr class="codeline" data-linenumber="217"><td class="num" id="LN217">217</td><td class="line"><span class='directive'>#if (defined(__FreeBSD__) || defined(__FreeBSD_kernel__)) &amp;&amp; !LJ_TARGET_PS4</span></td></tr>
<tr class="codeline" data-linenumber="218"><td class="num" id="LN218">218</td><td class="line">  <span class='keyword'>static</span> <span class='keyword'>int</span> rlimit_modified = 0;</td></tr>
<tr class="codeline" data-linenumber="219"><td class="num" id="LN219">219</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>LJ_UNLIKELY(rlimit_modified == 0)<span class='macro_popup'>__builtin_expect(!!(rlimit_modified == 0), 0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="220"><td class="num" id="LN220">220</td><td class="line">    <span class='keyword'>struct</span> rlimit rlim;</td></tr>
<tr class="codeline" data-linenumber="221"><td class="num" id="LN221">221</td><td class="line">    rlim.rlim_cur = rlim.rlim_max = MMAP_REGION_START;</td></tr>
<tr class="codeline" data-linenumber="222"><td class="num" id="LN222">222</td><td class="line">    setrlimit(RLIMIT_DATA, &amp;rlim);  <span class='comment'>/* Ignore result. May fail below. */</span></td></tr>
<tr class="codeline" data-linenumber="223"><td class="num" id="LN223">223</td><td class="line">    rlimit_modified = 1;</td></tr>
<tr class="codeline" data-linenumber="224"><td class="num" id="LN224">224</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="225"><td class="num" id="LN225">225</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="226"><td class="num" id="LN226">226</td><td class="line">  <span class='keyword'>for</span> (;;) {</td></tr>
<tr class="codeline" data-linenumber="227"><td class="num" id="LN227">227</td><td class="line">    <span class='keyword'>void</span> *p = mmap((<span class='keyword'>void</span> *)alloc_hint, size, <span class='macro'>MMAP_PROT<span class='macro_popup'>(0x1|0x2)</span></span>, <span class='macro'>MMAP_FLAGS<span class='macro_popup'>(0x02|0x20)</span></span>, -1, 0);</td></tr>
<tr class="codeline" data-linenumber="228"><td class="num" id="LN228">228</td><td class="line">    <span class='keyword'>if</span> ((uintptr_t)p &gt;= MMAP_REGION_START &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="229"><td class="num" id="LN229">229</td><td class="line">	(uintptr_t)p + size &lt; MMAP_REGION_END) {</td></tr>
<tr class="codeline" data-linenumber="230"><td class="num" id="LN230">230</td><td class="line">      alloc_hint = (uintptr_t)p + size;</td></tr>
<tr class="codeline" data-linenumber="231"><td class="num" id="LN231">231</td><td class="line">      <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> = olderr;</td></tr>
<tr class="codeline" data-linenumber="232"><td class="num" id="LN232">232</td><td class="line">      <span class='keyword'>return</span> p;</td></tr>
<tr class="codeline" data-linenumber="233"><td class="num" id="LN233">233</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="234"><td class="num" id="LN234">234</td><td class="line">    <span class='keyword'>if</span> (p != <span class='macro'>CMFAIL<span class='macro_popup'>((char *)(((void *)((~(size_t)0)))))</span></span>) munmap(p, size);</td></tr>
<tr class="codeline" data-linenumber="235"><td class="num" id="LN235">235</td><td class="line"><span class='directive'>#ifdef __sun__</span></td></tr>
<tr class="codeline" data-linenumber="236"><td class="num" id="LN236">236</td><td class="line">    alloc_hint += 0x1000000;  <span class='comment'>/* Need near-exhaustive linear scan. */</span></td></tr>
<tr class="codeline" data-linenumber="237"><td class="num" id="LN237">237</td><td class="line">    <span class='keyword'>if</span> (alloc_hint + size &lt; MMAP_REGION_END) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="238"><td class="num" id="LN238">238</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="239"><td class="num" id="LN239">239</td><td class="line">    <span class='keyword'>if</span> (retry) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="240"><td class="num" id="LN240">240</td><td class="line">    retry = 1;</td></tr>
<tr class="codeline" data-linenumber="241"><td class="num" id="LN241">241</td><td class="line">    alloc_hint = MMAP_REGION_START;</td></tr>
<tr class="codeline" data-linenumber="242"><td class="num" id="LN242">242</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="243"><td class="num" id="LN243">243</td><td class="line">  <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> = olderr;</td></tr>
<tr class="codeline" data-linenumber="244"><td class="num" id="LN244">244</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>CMFAIL<span class='macro_popup'>((char *)(((void *)((~(size_t)0)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="245"><td class="num" id="LN245">245</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="246"><td class="num" id="LN246">246</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="247"><td class="num" id="LN247">247</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="248"><td class="num" id="LN248">248</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="249"><td class="num" id="LN249">249</td><td class="line"><span class='directive'>#error "NYI: need an equivalent of MAP_32BIT for this 64 bit OS"</span></td></tr>
<tr class="codeline" data-linenumber="250"><td class="num" id="LN250">250</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="251"><td class="num" id="LN251">251</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="252"><td class="num" id="LN252">252</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="253"><td class="num" id="LN253">253</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="254"><td class="num" id="LN254">254</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="255"><td class="num" id="LN255">255</td><td class="line"><span class='comment'>/* 32 bit mode is easy. */</span></td></tr>
<tr class="codeline" data-linenumber="256"><td class="num" id="LN256">256</td><td class="line"><span class='keyword'>static</span> <span class='macro'>LJ_AINLINE<span class='macro_popup'>inline __attribute__((always_inline))</span></span> <span class='keyword'>void</span> *CALL_MMAP(size_t size)</td></tr>
<tr class="codeline" data-linenumber="257"><td class="num" id="LN257">257</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="258"><td class="num" id="LN258">258</td><td class="line">  <span class='keyword'>int</span> olderr = <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>;</td></tr>
<tr class="codeline" data-linenumber="259"><td class="num" id="LN259">259</td><td class="line">  <span class='keyword'>void</span> *ptr = mmap(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, size, <span class='macro'>MMAP_PROT<span class='macro_popup'>(0x1|0x2)</span></span>, <span class='macro'>MMAP_FLAGS<span class='macro_popup'>(0x02|0x20)</span></span>, -1, 0);</td></tr>
<tr class="codeline" data-linenumber="260"><td class="num" id="LN260">260</td><td class="line">  <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> = olderr;</td></tr>
<tr class="codeline" data-linenumber="261"><td class="num" id="LN261">261</td><td class="line">  <span class='keyword'>return</span> ptr;</td></tr>
<tr class="codeline" data-linenumber="262"><td class="num" id="LN262">262</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="263"><td class="num" id="LN263">263</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="264"><td class="num" id="LN264">264</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="265"><td class="num" id="LN265">265</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="266"><td class="num" id="LN266">266</td><td class="line"><span class='directive'>#define <span class='macro'>INIT_MMAP()<span class='macro_popup'>((void)0)</span></span>		((void)0)</span></td></tr>
<tr class="codeline" data-linenumber="267"><td class="num" id="LN267">267</td><td class="line"><span class='directive'>#define <span class='macro'>DIRECT_MMAP(s)<span class='macro_popup'>CALL_MMAP(s)</span></span>		CALL_MMAP(s)</span></td></tr>
<tr class="codeline" data-linenumber="268"><td class="num" id="LN268">268</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="269"><td class="num" id="LN269">269</td><td class="line"><span class='keyword'>static</span> <span class='macro'>LJ_AINLINE<span class='macro_popup'>inline __attribute__((always_inline))</span></span> <span class='keyword'>int</span> CALL_MUNMAP(<span class='keyword'>void</span> *ptr, size_t size)</td></tr>
<tr class="codeline" data-linenumber="270"><td class="num" id="LN270">270</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="271"><td class="num" id="LN271">271</td><td class="line">  <span class='keyword'>int</span> olderr = <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>;</td></tr>
<tr class="codeline" data-linenumber="272"><td class="num" id="LN272">272</td><td class="line">  <span class='keyword'>int</span> ret = munmap(ptr, size);</td></tr>
<tr class="codeline" data-linenumber="273"><td class="num" id="LN273">273</td><td class="line">  <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> = olderr;</td></tr>
<tr class="codeline" data-linenumber="274"><td class="num" id="LN274">274</td><td class="line">  <span class='keyword'>return</span> ret;</td></tr>
<tr class="codeline" data-linenumber="275"><td class="num" id="LN275">275</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="276"><td class="num" id="LN276">276</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="277"><td class="num" id="LN277">277</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_TARGET_LINUX<span class='macro_popup'>(2 == 2)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="278"><td class="num" id="LN278">278</td><td class="line"><span class='comment'>/* Need to define _GNU_SOURCE to get the mremap prototype. */</span></td></tr>
<tr class="codeline" data-linenumber="279"><td class="num" id="LN279">279</td><td class="line"><span class='keyword'>static</span> <span class='macro'>LJ_AINLINE<span class='macro_popup'>inline __attribute__((always_inline))</span></span> <span class='keyword'>void</span> *CALL_MREMAP_(<span class='keyword'>void</span> *ptr, size_t osz, size_t nsz,</td></tr>
<tr class="codeline" data-linenumber="280"><td class="num" id="LN280">280</td><td class="line">				     <span class='keyword'>int</span> flags)</td></tr>
<tr class="codeline" data-linenumber="281"><td class="num" id="LN281">281</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="282"><td class="num" id="LN282">282</td><td class="line">  <span class='keyword'>int</span> olderr = <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>;</td></tr>
<tr class="codeline" data-linenumber="283"><td class="num" id="LN283">283</td><td class="line">  ptr = mremap(ptr, osz, nsz, flags);</td></tr>
<tr class="codeline" data-linenumber="284"><td class="num" id="LN284">284</td><td class="line">  <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> = olderr;</td></tr>
<tr class="codeline" data-linenumber="285"><td class="num" id="LN285">285</td><td class="line">  <span class='keyword'>return</span> ptr;</td></tr>
<tr class="codeline" data-linenumber="286"><td class="num" id="LN286">286</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="287"><td class="num" id="LN287">287</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="288"><td class="num" id="LN288">288</td><td class="line"><span class='directive'>#define <span class='macro'>CALL_MREMAP(addr, osz, nsz, mv)<span class='macro_popup'>CALL_MREMAP_((addr), (osz), (nsz), (mv))</span></span> CALL_MREMAP_((addr), (osz), (nsz), (mv))</span></td></tr>
<tr class="codeline" data-linenumber="289"><td class="num" id="LN289">289</td><td class="line"><span class='directive'>#define <span class='macro'>CALL_MREMAP_NOMOVE<span class='macro_popup'>0</span></span>	0</span></td></tr>
<tr class="codeline" data-linenumber="290"><td class="num" id="LN290">290</td><td class="line"><span class='directive'>#define <span class='macro'>CALL_MREMAP_MAYMOVE<span class='macro_popup'>1</span></span>	1</span></td></tr>
<tr class="codeline" data-linenumber="291"><td class="num" id="LN291">291</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_64<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="292"><td class="num" id="LN292">292</td><td class="line"><span class='directive'>#define <span class='macro'>CALL_MREMAP_MV<span class='macro_popup'>0</span></span>		<span class='macro'>CALL_MREMAP_NOMOVE<span class='macro_popup'>0</span></span></span></td></tr>
<tr class="codeline" data-linenumber="293"><td class="num" id="LN293">293</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="294"><td class="num" id="LN294">294</td><td class="line"><span class='directive'>#define <span class='macro'>CALL_MREMAP_MV<span class='macro_popup'>0</span></span>		<span class='macro'>CALL_MREMAP_MAYMOVE<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="295"><td class="num" id="LN295">295</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="296"><td class="num" id="LN296">296</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="297"><td class="num" id="LN297">297</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="298"><td class="num" id="LN298">298</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="299"><td class="num" id="LN299">299</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="300"><td class="num" id="LN300">300</td><td class="line"><span class='directive'>#ifndef CALL_MREMAP</span></td></tr>
<tr class="codeline" data-linenumber="301"><td class="num" id="LN301">301</td><td class="line"><span class='directive'>#define <span class='macro'>CALL_MREMAP(addr, osz, nsz, mv)<span class='macro_popup'>CALL_MREMAP_((addr), (osz), (nsz), (mv))</span></span> ((void)osz, <span class='macro'>MFAIL<span class='macro_popup'>((void *)((~(size_t)0)))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="302"><td class="num" id="LN302">302</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="303"><td class="num" id="LN303">303</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="304"><td class="num" id="LN304">304</td><td class="line"><span class='comment'>/* -----------------------  Chunk representations ------------------------ */</span></td></tr>
<tr class="codeline" data-linenumber="305"><td class="num" id="LN305">305</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="306"><td class="num" id="LN306">306</td><td class="line"><span class='keyword'>struct</span> malloc_chunk {</td></tr>
<tr class="codeline" data-linenumber="307"><td class="num" id="LN307">307</td><td class="line">  size_t               prev_foot;  <span class='comment'>/* Size of previous chunk (if free).  */</span></td></tr>
<tr class="codeline" data-linenumber="308"><td class="num" id="LN308">308</td><td class="line">  size_t               head;       <span class='comment'>/* Size and inuse bits. */</span></td></tr>
<tr class="codeline" data-linenumber="309"><td class="num" id="LN309">309</td><td class="line">  <span class='keyword'>struct</span> malloc_chunk *fd;         <span class='comment'>/* double links -- used only if free. */</span></td></tr>
<tr class="codeline" data-linenumber="310"><td class="num" id="LN310">310</td><td class="line">  <span class='keyword'>struct</span> malloc_chunk *bk;</td></tr>
<tr class="codeline" data-linenumber="311"><td class="num" id="LN311">311</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="312"><td class="num" id="LN312">312</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="313"><td class="num" id="LN313">313</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> malloc_chunk  mchunk;</td></tr>
<tr class="codeline" data-linenumber="314"><td class="num" id="LN314">314</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> malloc_chunk *mchunkptr;</td></tr>
<tr class="codeline" data-linenumber="315"><td class="num" id="LN315">315</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> malloc_chunk *sbinptr;  <span class='comment'>/* The type of bins of chunks */</span></td></tr>
<tr class="codeline" data-linenumber="316"><td class="num" id="LN316">316</td><td class="line"><span class='keyword'>typedef</span> size_t bindex_t;               <span class='comment'>/* Described below */</span></td></tr>
<tr class="codeline" data-linenumber="317"><td class="num" id="LN317">317</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>unsigned</span> <span class='keyword'>int</span> binmap_t;         <span class='comment'>/* Described below */</span></td></tr>
<tr class="codeline" data-linenumber="318"><td class="num" id="LN318">318</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>unsigned</span> <span class='keyword'>int</span> flag_t;           <span class='comment'>/* The type of various bit flag sets */</span></td></tr>
<tr class="codeline" data-linenumber="319"><td class="num" id="LN319">319</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="320"><td class="num" id="LN320">320</td><td class="line"><span class='comment'>/* ------------------- Chunks sizes and alignments ----------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="321"><td class="num" id="LN321">321</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="322"><td class="num" id="LN322">322</td><td class="line"><span class='directive'>#define <span class='macro'>MCHUNK_SIZE<span class='macro_popup'>(sizeof(mchunk))</span></span>		(sizeof(mchunk))</span></td></tr>
<tr class="codeline" data-linenumber="323"><td class="num" id="LN323">323</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="324"><td class="num" id="LN324">324</td><td class="line"><span class='directive'>#define <span class='macro'>CHUNK_OVERHEAD<span class='macro_popup'>((sizeof(size_t)))</span></span>		(<span class='macro'>SIZE_T_SIZE<span class='macro_popup'>(sizeof(size_t))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="325"><td class="num" id="LN325">325</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="326"><td class="num" id="LN326">326</td><td class="line"><span class='comment'>/* Direct chunks need a second word of overhead ... */</span></td></tr>
<tr class="codeline" data-linenumber="327"><td class="num" id="LN327">327</td><td class="line"><span class='directive'>#define <span class='macro'>DIRECT_CHUNK_OVERHEAD<span class='macro_popup'>(((sizeof(size_t))&lt;&lt;1))</span></span>	(<span class='macro'>TWO_SIZE_T_SIZES<span class='macro_popup'>((sizeof(size_t))&lt;&lt;1)</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="328"><td class="num" id="LN328">328</td><td class="line"><span class='comment'>/* ... and additional padding for fake next-chunk at foot */</span></td></tr>
<tr class="codeline" data-linenumber="329"><td class="num" id="LN329">329</td><td class="line"><span class='directive'>#define <span class='macro'>DIRECT_FOOT_PAD<span class='macro_popup'>(((sizeof(size_t))&lt;&lt;2))</span></span>		(<span class='macro'>FOUR_SIZE_T_SIZES<span class='macro_popup'>((sizeof(size_t))&lt;&lt;2)</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="330"><td class="num" id="LN330">330</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="331"><td class="num" id="LN331">331</td><td class="line"><span class='comment'>/* The smallest size we can malloc is an aligned minimal chunk */</span></td></tr>
<tr class="codeline" data-linenumber="332"><td class="num" id="LN332">332</td><td class="line"><span class='directive'>#define <span class='macro'>MIN_CHUNK_SIZE<span class='macro_popup'>(((sizeof(mchunk)) + (((size_t)8U) - ((size_t)1))) &amp; ~(((<br>size_t)8U) - ((size_t)1)))</span></span>\</span></td></tr>
<tr class="codeline" data-linenumber="333"><td class="num" id="LN333">333</td><td class="line">  <span class='directive'>((<span class='macro'>MCHUNK_SIZE<span class='macro_popup'>(sizeof(mchunk))</span></span> + <span class='macro'>CHUNK_ALIGN_MASK<span class='macro_popup'>(((size_t)8U) - ((size_t)1))</span></span>) &amp; ~<span class='macro'>CHUNK_ALIGN_MASK<span class='macro_popup'>(((size_t)8U) - ((size_t)1))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="334"><td class="num" id="LN334">334</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="335"><td class="num" id="LN335">335</td><td class="line"><span class='comment'>/* conversion from malloc headers to user pointers, and back */</span></td></tr>
<tr class="codeline" data-linenumber="336"><td class="num" id="LN336">336</td><td class="line"><span class='directive'>#define <span class='macro'>chunk2mem(p)<span class='macro_popup'>((void *)((char *)(p) + ((sizeof(size_t))&lt;&lt;1)))</span></span>		((void *)((char *)(p) + <span class='macro'>TWO_SIZE_T_SIZES<span class='macro_popup'>((sizeof(size_t))&lt;&lt;1)</span></span>))</span></td></tr>
<tr class="codeline" data-linenumber="337"><td class="num" id="LN337">337</td><td class="line"><span class='directive'>#define <span class='macro'>mem2chunk(mem)<span class='macro_popup'>((mchunkptr)((char *)(mem) - ((sizeof(size_t))&lt;&lt;1)))</span></span>		((mchunkptr)((char *)(mem) - <span class='macro'>TWO_SIZE_T_SIZES<span class='macro_popup'>((sizeof(size_t))&lt;&lt;1)</span></span>))</span></td></tr>
<tr class="codeline" data-linenumber="338"><td class="num" id="LN338">338</td><td class="line"><span class='comment'>/* chunk associated with aligned address A */</span></td></tr>
<tr class="codeline" data-linenumber="339"><td class="num" id="LN339">339</td><td class="line"><span class='directive'>#define <span class='macro'>align_as_chunk(A)<span class='macro_popup'>(mchunkptr)((A) + ((((size_t)(((void *)((char *)(A) + ((sizeof<br>(size_t))&lt;&lt;1)))) &amp; (((size_t)8U) - ((size_t)1))) ==<br> 0)? 0 : ((((size_t)8U) - ((size_t)(((void *)((char *)(A) + (<br>(sizeof(size_t))&lt;&lt;1)))) &amp; (((size_t)8U) - ((size_t)<br>1)))) &amp; (((size_t)8U) - ((size_t)1)))))</span></span>	(mchunkptr)((A) + <span class='macro'>align_offset(chunk2mem(A))<span class='macro_popup'>((((size_t)(((void *)((char *)(A) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1))) == 0)? 0 : ((((size_t<br>)8U) - ((size_t)(((void *)((char *)(A) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1)))) &amp; (((size_t)8U<br>) - ((size_t)1))))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="340"><td class="num" id="LN340">340</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="341"><td class="num" id="LN341">341</td><td class="line"><span class='comment'>/* Bounds on request (not chunk) sizes. */</span></td></tr>
<tr class="codeline" data-linenumber="342"><td class="num" id="LN342">342</td><td class="line"><span class='directive'>#define <span class='macro'>MAX_REQUEST<span class='macro_popup'>((~(((sizeof(mchunk)) + (((size_t)8U) - ((size_t)1))) &amp; ~<br>(((size_t)8U) - ((size_t)1)))+1) &lt;&lt; 2)</span></span>		((~<span class='macro'>MIN_CHUNK_SIZE<span class='macro_popup'>(((sizeof(mchunk)) + (((size_t)8U) - ((size_t)1))) &amp; ~(((<br>size_t)8U) - ((size_t)1)))</span></span>+1) &lt;&lt; 2)</span></td></tr>
<tr class="codeline" data-linenumber="343"><td class="num" id="LN343">343</td><td class="line"><span class='directive'>#define <span class='macro'>MIN_REQUEST<span class='macro_popup'>((((sizeof(mchunk)) + (((size_t)8U) - ((size_t)1))) &amp; ~((<br>(size_t)8U) - ((size_t)1))) - ((sizeof(size_t))) - ((size_t)1<br>))</span></span>		(<span class='macro'>MIN_CHUNK_SIZE<span class='macro_popup'>(((sizeof(mchunk)) + (((size_t)8U) - ((size_t)1))) &amp; ~(((<br>size_t)8U) - ((size_t)1)))</span></span> - <span class='macro'>CHUNK_OVERHEAD<span class='macro_popup'>((sizeof(size_t)))</span></span> - <span class='macro'>SIZE_T_ONE<span class='macro_popup'>((size_t)1)</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="344"><td class="num" id="LN344">344</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="345"><td class="num" id="LN345">345</td><td class="line"><span class='comment'>/* pad request bytes into a usable size */</span></td></tr>
<tr class="codeline" data-linenumber="346"><td class="num" id="LN346">346</td><td class="line"><span class='directive'>#define <span class='macro'>pad_request(req)<span class='macro_popup'>(((req) + ((sizeof(size_t))) + (((size_t)8U) - ((size_t)1))) &amp;<br> ~(((size_t)8U) - ((size_t)1)))</span></span> \</span></td></tr>
<tr class="codeline" data-linenumber="347"><td class="num" id="LN347">347</td><td class="line">   <span class='directive'>(((req) + <span class='macro'>CHUNK_OVERHEAD<span class='macro_popup'>((sizeof(size_t)))</span></span> + <span class='macro'>CHUNK_ALIGN_MASK<span class='macro_popup'>(((size_t)8U) - ((size_t)1))</span></span>) &amp; ~<span class='macro'>CHUNK_ALIGN_MASK<span class='macro_popup'>(((size_t)8U) - ((size_t)1))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="348"><td class="num" id="LN348">348</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="349"><td class="num" id="LN349">349</td><td class="line"><span class='comment'>/* pad request, checking for minimum (but not maximum) */</span></td></tr>
<tr class="codeline" data-linenumber="350"><td class="num" id="LN350">350</td><td class="line"><span class='directive'>#define <span class='macro'>request2size(req)<span class='macro_popup'>(((req) &lt; ((((sizeof(mchunk)) + (((size_t)8U) - ((size_t)1<br>))) &amp; ~(((size_t)8U) - ((size_t)1))) - ((sizeof(size_t)))<br> - ((size_t)1)))? (((sizeof(mchunk)) + (((size_t)8U) - ((size_t<br>)1))) &amp; ~(((size_t)8U) - ((size_t)1))) : (((req) + ((sizeof<br>(size_t))) + (((size_t)8U) - ((size_t)1))) &amp; ~(((size_t)8U<br>) - ((size_t)1))))</span></span> \</span></td></tr>
<tr class="codeline" data-linenumber="351"><td class="num" id="LN351">351</td><td class="line">  <span class='directive'>(((req) &lt; <span class='macro'>MIN_REQUEST<span class='macro_popup'>((((sizeof(mchunk)) + (((size_t)8U) - ((size_t)1))) &amp; ~((<br>(size_t)8U) - ((size_t)1))) - ((sizeof(size_t))) - ((size_t)1<br>))</span></span>)? <span class='macro'>MIN_CHUNK_SIZE<span class='macro_popup'>(((sizeof(mchunk)) + (((size_t)8U) - ((size_t)1))) &amp; ~(((<br>size_t)8U) - ((size_t)1)))</span></span> : <span class='macro'>pad_request(req)<span class='macro_popup'>(((req) + ((sizeof(size_t))) + (((size_t)8U) - ((size_t)1))) &amp;<br> ~(((size_t)8U) - ((size_t)1)))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="352"><td class="num" id="LN352">352</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="353"><td class="num" id="LN353">353</td><td class="line"><span class='comment'>/* ------------------ Operations on head and foot fields ----------------- */</span></td></tr>
<tr class="codeline" data-linenumber="354"><td class="num" id="LN354">354</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="355"><td class="num" id="LN355">355</td><td class="line"><span class='directive'>#define <span class='macro'>PINUSE_BIT<span class='macro_popup'>(((size_t)1))</span></span>		(<span class='macro'>SIZE_T_ONE<span class='macro_popup'>((size_t)1)</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="356"><td class="num" id="LN356">356</td><td class="line"><span class='directive'>#define <span class='macro'>CINUSE_BIT<span class='macro_popup'>(((size_t)2))</span></span>		(<span class='macro'>SIZE_T_TWO<span class='macro_popup'>((size_t)2)</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="357"><td class="num" id="LN357">357</td><td class="line"><span class='directive'>#define <span class='macro'>INUSE_BITS<span class='macro_popup'>((((size_t)1))|(((size_t)2)))</span></span>		(<span class='macro'>PINUSE_BIT<span class='macro_popup'>(((size_t)1))</span></span>|<span class='macro'>CINUSE_BIT<span class='macro_popup'>(((size_t)2))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="358"><td class="num" id="LN358">358</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="359"><td class="num" id="LN359">359</td><td class="line"><span class='comment'>/* Head value for fenceposts */</span></td></tr>
<tr class="codeline" data-linenumber="360"><td class="num" id="LN360">360</td><td class="line"><span class='directive'>#define <span class='macro'>FENCEPOST_HEAD<span class='macro_popup'>(((((size_t)1))|(((size_t)2)))|(sizeof(size_t)))</span></span>		(<span class='macro'>INUSE_BITS<span class='macro_popup'>((((size_t)1))|(((size_t)2)))</span></span>|<span class='macro'>SIZE_T_SIZE<span class='macro_popup'>(sizeof(size_t))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="361"><td class="num" id="LN361">361</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="362"><td class="num" id="LN362">362</td><td class="line"><span class='comment'>/* extraction of fields from head words */</span></td></tr>
<tr class="codeline" data-linenumber="363"><td class="num" id="LN363">363</td><td class="line"><span class='directive'>#define <span class='macro'>cinuse(p)<span class='macro_popup'>((p)-&gt;head &amp; (((size_t)2)))</span></span>		((p)-&gt;head &amp; <span class='macro'>CINUSE_BIT<span class='macro_popup'>(((size_t)2))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="364"><td class="num" id="LN364">364</td><td class="line"><span class='directive'>#define <span class='macro'>pinuse(p)<span class='macro_popup'>((p)-&gt;head &amp; (((size_t)1)))</span></span>		((p)-&gt;head &amp; <span class='macro'>PINUSE_BIT<span class='macro_popup'>(((size_t)1))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="365"><td class="num" id="LN365">365</td><td class="line"><span class='directive'>#define <span class='macro'>chunksize(p)<span class='macro_popup'>((p)-&gt;head &amp; ~(((((size_t)1))|(((size_t)2)))))</span></span>		((p)-&gt;head &amp; ~(<span class='macro'>INUSE_BITS<span class='macro_popup'>((((size_t)1))|(((size_t)2)))</span></span>))</span></td></tr>
<tr class="codeline" data-linenumber="366"><td class="num" id="LN366">366</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="367"><td class="num" id="LN367">367</td><td class="line"><span class='directive'>#define <span class='macro'>clear_pinuse(p)<span class='macro_popup'>((p)-&gt;head &amp;= ~(((size_t)1)))</span></span>		((p)-&gt;head &amp;= ~<span class='macro'>PINUSE_BIT<span class='macro_popup'>(((size_t)1))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="368"><td class="num" id="LN368">368</td><td class="line"><span class='directive'>#define <span class='macro'>clear_cinuse(p)<span class='macro_popup'>((p)-&gt;head &amp;= ~(((size_t)2)))</span></span>		((p)-&gt;head &amp;= ~<span class='macro'>CINUSE_BIT<span class='macro_popup'>(((size_t)2))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="369"><td class="num" id="LN369">369</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="370"><td class="num" id="LN370">370</td><td class="line"><span class='comment'>/* Treat space at ptr +/- offset as a chunk */</span></td></tr>
<tr class="codeline" data-linenumber="371"><td class="num" id="LN371">371</td><td class="line"><span class='directive'>#define <span class='macro'>chunk_plus_offset(p, s)<span class='macro_popup'>((mchunkptr)(((char *)(p)) + (s)))</span></span>		((mchunkptr)(((char *)(p)) + (s)))</span></td></tr>
<tr class="codeline" data-linenumber="372"><td class="num" id="LN372">372</td><td class="line"><span class='directive'>#define <span class='macro'>chunk_minus_offset(p, s)<span class='macro_popup'>((mchunkptr)(((char *)(p)) - (s)))</span></span>	((mchunkptr)(((char *)(p)) - (s)))</span></td></tr>
<tr class="codeline" data-linenumber="373"><td class="num" id="LN373">373</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="374"><td class="num" id="LN374">374</td><td class="line"><span class='comment'>/* Ptr to next or previous physical malloc_chunk. */</span></td></tr>
<tr class="codeline" data-linenumber="375"><td class="num" id="LN375">375</td><td class="line"><span class='directive'>#define <span class='macro'>next_chunk(p)<span class='macro_popup'>((mchunkptr)(((char *)(p)) + ((p)-&gt;head &amp; ~((((size_t)<br>1))|(((size_t)2))))))</span></span>	((mchunkptr)(((char *)(p)) + ((p)-&gt;head &amp; ~<span class='macro'>INUSE_BITS<span class='macro_popup'>((((size_t)1))|(((size_t)2)))</span></span>)))</span></td></tr>
<tr class="codeline" data-linenumber="376"><td class="num" id="LN376">376</td><td class="line"><span class='directive'>#define <span class='macro'>prev_chunk(p)<span class='macro_popup'>((mchunkptr)(((char *)(p)) - ((p)-&gt;prev_foot) ))</span></span>	((mchunkptr)(((char *)(p)) - ((p)-&gt;prev_foot) ))</span></td></tr>
<tr class="codeline" data-linenumber="377"><td class="num" id="LN377">377</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="378"><td class="num" id="LN378">378</td><td class="line"><span class='comment'>/* extract next chunk's pinuse bit */</span></td></tr>
<tr class="codeline" data-linenumber="379"><td class="num" id="LN379">379</td><td class="line"><span class='directive'>#define <span class='macro'>next_pinuse(p)<span class='macro_popup'>((((mchunkptr)(((char *)(p)) + ((p)-&gt;head &amp; ~((((size_t<br>)1))|(((size_t)2))))))-&gt;head) &amp; (((size_t)1)))</span></span>	((<span class='macro'>next_chunk(p)<span class='macro_popup'>((mchunkptr)(((char *)(p)) + ((p)-&gt;head &amp; ~((((size_t)<br>1))|(((size_t)2))))))</span></span>-&gt;head) &amp; <span class='macro'>PINUSE_BIT<span class='macro_popup'>(((size_t)1))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="380"><td class="num" id="LN380">380</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="381"><td class="num" id="LN381">381</td><td class="line"><span class='comment'>/* Get/set size at footer */</span></td></tr>
<tr class="codeline" data-linenumber="382"><td class="num" id="LN382">382</td><td class="line"><span class='directive'>#define <span class='macro'>get_foot(p, s)<span class='macro_popup'>(((mchunkptr)((char *)(p) + (s)))-&gt;prev_foot)</span></span>	(((mchunkptr)((char *)(p) + (s)))-&gt;prev_foot)</span></td></tr>
<tr class="codeline" data-linenumber="383"><td class="num" id="LN383">383</td><td class="line"><span class='directive'>#define <span class='macro'>set_foot(p, s)<span class='macro_popup'>(((mchunkptr)((char *)(p) + (s)))-&gt;prev_foot = (s))</span></span>	(((mchunkptr)((char *)(p) + (s)))-&gt;prev_foot = (s))</span></td></tr>
<tr class="codeline" data-linenumber="384"><td class="num" id="LN384">384</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="385"><td class="num" id="LN385">385</td><td class="line"><span class='comment'>/* Set size, pinuse bit, and foot */</span></td></tr>
<tr class="codeline" data-linenumber="386"><td class="num" id="LN386">386</td><td class="line"><span class='directive'>#define <span class='macro'>set_size_and_pinuse_of_free_chunk(p, s)<span class='macro_popup'>((p)-&gt;head = (s|(((size_t)1))), (((mchunkptr)((char *)(p) +<br> (s)))-&gt;prev_foot = (s)))</span></span>\</span></td></tr>
<tr class="codeline" data-linenumber="387"><td class="num" id="LN387">387</td><td class="line">  <span class='directive'>((p)-&gt;head = (s|<span class='macro'>PINUSE_BIT<span class='macro_popup'>(((size_t)1))</span></span>), <span class='macro'>set_foot(p, s)<span class='macro_popup'>(((mchunkptr)((char *)(p) + (s)))-&gt;prev_foot = (s))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="388"><td class="num" id="LN388">388</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="389"><td class="num" id="LN389">389</td><td class="line"><span class='comment'>/* Set size, pinuse bit, foot, and clear next pinuse */</span></td></tr>
<tr class="codeline" data-linenumber="390"><td class="num" id="LN390">390</td><td class="line"><span class='directive'>#define <span class='macro'>set_free_with_pinuse(p, s, n)<span class='macro_popup'>(((n)-&gt;head &amp;= ~(((size_t)1))), ((p)-&gt;head = (s|(((<br>size_t)1))), (((mchunkptr)((char *)(p) + (s)))-&gt;prev_foot =<br> (s))))</span></span>\</span></td></tr>
<tr class="codeline" data-linenumber="391"><td class="num" id="LN391">391</td><td class="line">  <span class='directive'>(<span class='macro'>clear_pinuse(n)<span class='macro_popup'>((n)-&gt;head &amp;= ~(((size_t)1)))</span></span>, <span class='macro'>set_size_and_pinuse_of_free_chunk(p, s)<span class='macro_popup'>((p)-&gt;head = (s|(((size_t)1))), (((mchunkptr)((char *)(p) +<br> (s)))-&gt;prev_foot = (s)))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="392"><td class="num" id="LN392">392</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="393"><td class="num" id="LN393">393</td><td class="line"><span class='directive'>#define <span class='macro'>is_direct(p)<span class='macro_popup'>(!((p)-&gt;head &amp; (((size_t)1))) &amp;&amp; ((p)-&gt;prev_foot<br> &amp; (((size_t)1))))</span></span>\</span></td></tr>
<tr class="codeline" data-linenumber="394"><td class="num" id="LN394">394</td><td class="line">  <span class='directive'>(!((p)-&gt;head &amp; <span class='macro'>PINUSE_BIT<span class='macro_popup'>(((size_t)1))</span></span>) &amp;&amp; ((p)-&gt;prev_foot &amp; <span class='macro'>IS_DIRECT_BIT<span class='macro_popup'>(((size_t)1))</span></span>))</span></td></tr>
<tr class="codeline" data-linenumber="395"><td class="num" id="LN395">395</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="396"><td class="num" id="LN396">396</td><td class="line"><span class='comment'>/* Get the internal overhead associated with chunk p */</span></td></tr>
<tr class="codeline" data-linenumber="397"><td class="num" id="LN397">397</td><td class="line"><span class='directive'>#define <span class='macro'>overhead_for(p)<span class='macro_popup'>((!((p)-&gt;head &amp; (((size_t)1))) &amp;&amp; ((p)-&gt;prev_foot<br> &amp; (((size_t)1))))? (((sizeof(size_t))&lt;&lt;1)) : ((sizeof<br>(size_t))))</span></span>\</span></td></tr>
<tr class="codeline" data-linenumber="398"><td class="num" id="LN398">398</td><td class="line"> <span class='directive'>(<span class='macro'>is_direct(p)<span class='macro_popup'>(!((p)-&gt;head &amp; (((size_t)1))) &amp;&amp; ((p)-&gt;prev_foot<br> &amp; (((size_t)1))))</span></span>? <span class='macro'>DIRECT_CHUNK_OVERHEAD<span class='macro_popup'>(((sizeof(size_t))&lt;&lt;1))</span></span> : <span class='macro'>CHUNK_OVERHEAD<span class='macro_popup'>((sizeof(size_t)))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="399"><td class="num" id="LN399">399</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="400"><td class="num" id="LN400">400</td><td class="line"><span class='comment'>/* ---------------------- Overlaid data structures ----------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="401"><td class="num" id="LN401">401</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="402"><td class="num" id="LN402">402</td><td class="line"><span class='keyword'>struct</span> malloc_tree_chunk {</td></tr>
<tr class="codeline" data-linenumber="403"><td class="num" id="LN403">403</td><td class="line">  <span class='comment'>/* The first four fields must be compatible with malloc_chunk */</span></td></tr>
<tr class="codeline" data-linenumber="404"><td class="num" id="LN404">404</td><td class="line">  size_t                    prev_foot;</td></tr>
<tr class="codeline" data-linenumber="405"><td class="num" id="LN405">405</td><td class="line">  size_t                    head;</td></tr>
<tr class="codeline" data-linenumber="406"><td class="num" id="LN406">406</td><td class="line">  <span class='keyword'>struct</span> malloc_tree_chunk *fd;</td></tr>
<tr class="codeline" data-linenumber="407"><td class="num" id="LN407">407</td><td class="line">  <span class='keyword'>struct</span> malloc_tree_chunk *bk;</td></tr>
<tr class="codeline" data-linenumber="408"><td class="num" id="LN408">408</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="409"><td class="num" id="LN409">409</td><td class="line">  <span class='keyword'>struct</span> malloc_tree_chunk *child[2];</td></tr>
<tr class="codeline" data-linenumber="410"><td class="num" id="LN410">410</td><td class="line">  <span class='keyword'>struct</span> malloc_tree_chunk *parent;</td></tr>
<tr class="codeline" data-linenumber="411"><td class="num" id="LN411">411</td><td class="line">  bindex_t                  index;</td></tr>
<tr class="codeline" data-linenumber="412"><td class="num" id="LN412">412</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="413"><td class="num" id="LN413">413</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="414"><td class="num" id="LN414">414</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> malloc_tree_chunk  tchunk;</td></tr>
<tr class="codeline" data-linenumber="415"><td class="num" id="LN415">415</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> malloc_tree_chunk *tchunkptr;</td></tr>
<tr class="codeline" data-linenumber="416"><td class="num" id="LN416">416</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> malloc_tree_chunk *tbinptr; <span class='comment'>/* The type of bins of trees */</span></td></tr>
<tr class="codeline" data-linenumber="417"><td class="num" id="LN417">417</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="418"><td class="num" id="LN418">418</td><td class="line"><span class='comment'>/* A little helper macro for trees */</span></td></tr>
<tr class="codeline" data-linenumber="419"><td class="num" id="LN419">419</td><td class="line"><span class='directive'>#define <span class='macro'>leftmost_child(t)<span class='macro_popup'>((t)-&gt;child[0] != 0? (t)-&gt;child[0] : (t)-&gt;child[1])</span></span> ((t)-&gt;child[0] != 0? (t)-&gt;child[0] : (t)-&gt;child[1])</span></td></tr>
<tr class="codeline" data-linenumber="420"><td class="num" id="LN420">420</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="421"><td class="num" id="LN421">421</td><td class="line"><span class='comment'>/* ----------------------------- Segments -------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="422"><td class="num" id="LN422">422</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="423"><td class="num" id="LN423">423</td><td class="line"><span class='keyword'>struct</span> malloc_segment {</td></tr>
<tr class="codeline" data-linenumber="424"><td class="num" id="LN424">424</td><td class="line">  <span class='keyword'>char</span>        *base;             <span class='comment'>/* base address */</span></td></tr>
<tr class="codeline" data-linenumber="425"><td class="num" id="LN425">425</td><td class="line">  size_t       size;             <span class='comment'>/* allocated size */</span></td></tr>
<tr class="codeline" data-linenumber="426"><td class="num" id="LN426">426</td><td class="line">  <span class='keyword'>struct</span> malloc_segment *next;   <span class='comment'>/* ptr to next segment */</span></td></tr>
<tr class="codeline" data-linenumber="427"><td class="num" id="LN427">427</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="428"><td class="num" id="LN428">428</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="429"><td class="num" id="LN429">429</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> malloc_segment  msegment;</td></tr>
<tr class="codeline" data-linenumber="430"><td class="num" id="LN430">430</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> malloc_segment *msegmentptr;</td></tr>
<tr class="codeline" data-linenumber="431"><td class="num" id="LN431">431</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="432"><td class="num" id="LN432">432</td><td class="line"><span class='comment'>/* ---------------------------- malloc_state ----------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="433"><td class="num" id="LN433">433</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="434"><td class="num" id="LN434">434</td><td class="line"><span class='comment'>/* Bin types, widths and sizes */</span></td></tr>
<tr class="codeline" data-linenumber="435"><td class="num" id="LN435">435</td><td class="line"><span class='directive'>#define <span class='macro'>NSMALLBINS<span class='macro_popup'>(32U)</span></span>		(32U)</span></td></tr>
<tr class="codeline" data-linenumber="436"><td class="num" id="LN436">436</td><td class="line"><span class='directive'>#define <span class='macro'>NTREEBINS<span class='macro_popup'>(32U)</span></span>		(32U)</span></td></tr>
<tr class="codeline" data-linenumber="437"><td class="num" id="LN437">437</td><td class="line"><span class='directive'>#define <span class='macro'>SMALLBIN_SHIFT<span class='macro_popup'>(3U)</span></span>		(3U)</span></td></tr>
<tr class="codeline" data-linenumber="438"><td class="num" id="LN438">438</td><td class="line"><span class='directive'>#define <span class='macro'>SMALLBIN_WIDTH<span class='macro_popup'>(((size_t)1) &lt;&lt; (3U))</span></span>		(<span class='macro'>SIZE_T_ONE<span class='macro_popup'>((size_t)1)</span></span> &lt;&lt; <span class='macro'>SMALLBIN_SHIFT<span class='macro_popup'>(3U)</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="439"><td class="num" id="LN439">439</td><td class="line"><span class='directive'>#define <span class='macro'>TREEBIN_SHIFT<span class='macro_popup'>(8U)</span></span>		(8U)</span></td></tr>
<tr class="codeline" data-linenumber="440"><td class="num" id="LN440">440</td><td class="line"><span class='directive'>#define <span class='macro'>MIN_LARGE_SIZE<span class='macro_popup'>(((size_t)1) &lt;&lt; (8U))</span></span>		(<span class='macro'>SIZE_T_ONE<span class='macro_popup'>((size_t)1)</span></span> &lt;&lt; <span class='macro'>TREEBIN_SHIFT<span class='macro_popup'>(8U)</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="441"><td class="num" id="LN441">441</td><td class="line"><span class='directive'>#define <span class='macro'>MAX_SMALL_SIZE<span class='macro_popup'>((((size_t)1) &lt;&lt; (8U)) - ((size_t)1))</span></span>		(<span class='macro'>MIN_LARGE_SIZE<span class='macro_popup'>(((size_t)1) &lt;&lt; (8U))</span></span> - <span class='macro'>SIZE_T_ONE<span class='macro_popup'>((size_t)1)</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="442"><td class="num" id="LN442">442</td><td class="line"><span class='directive'>#define <span class='macro'>MAX_SMALL_REQUEST<span class='macro_popup'>(((((size_t)1) &lt;&lt; (8U)) - ((size_t)1)) - (((size_t)8U) -<br> ((size_t)1)) - ((sizeof(size_t))))</span></span>  (<span class='macro'>MAX_SMALL_SIZE<span class='macro_popup'>((((size_t)1) &lt;&lt; (8U)) - ((size_t)1))</span></span> - <span class='macro'>CHUNK_ALIGN_MASK<span class='macro_popup'>(((size_t)8U) - ((size_t)1))</span></span> - <span class='macro'>CHUNK_OVERHEAD<span class='macro_popup'>((sizeof(size_t)))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="443"><td class="num" id="LN443">443</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="444"><td class="num" id="LN444">444</td><td class="line"><span class='keyword'>struct</span> malloc_state {</td></tr>
<tr class="codeline" data-linenumber="445"><td class="num" id="LN445">445</td><td class="line">  binmap_t   smallmap;</td></tr>
<tr class="codeline" data-linenumber="446"><td class="num" id="LN446">446</td><td class="line">  binmap_t   treemap;</td></tr>
<tr class="codeline" data-linenumber="447"><td class="num" id="LN447">447</td><td class="line">  size_t     dvsize;</td></tr>
<tr class="codeline" data-linenumber="448"><td class="num" id="LN448">448</td><td class="line">  size_t     topsize;</td></tr>
<tr class="codeline" data-linenumber="449"><td class="num" id="LN449">449</td><td class="line">  mchunkptr  dv;</td></tr>
<tr class="codeline" data-linenumber="450"><td class="num" id="LN450">450</td><td class="line">  mchunkptr  top;</td></tr>
<tr class="codeline" data-linenumber="451"><td class="num" id="LN451">451</td><td class="line">  size_t     trim_check;</td></tr>
<tr class="codeline" data-linenumber="452"><td class="num" id="LN452">452</td><td class="line">  size_t     release_checks;</td></tr>
<tr class="codeline" data-linenumber="453"><td class="num" id="LN453">453</td><td class="line">  mchunkptr  smallbins[(<span class='macro'>NSMALLBINS<span class='macro_popup'>(32U)</span></span>+1)*2];</td></tr>
<tr class="codeline" data-linenumber="454"><td class="num" id="LN454">454</td><td class="line">  tbinptr    treebins[<span class='macro'>NTREEBINS<span class='macro_popup'>(32U)</span></span>];</td></tr>
<tr class="codeline" data-linenumber="455"><td class="num" id="LN455">455</td><td class="line">  msegment   seg;</td></tr>
<tr class="codeline" data-linenumber="456"><td class="num" id="LN456">456</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="457"><td class="num" id="LN457">457</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="458"><td class="num" id="LN458">458</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> malloc_state *mstate;</td></tr>
<tr class="codeline" data-linenumber="459"><td class="num" id="LN459">459</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="460"><td class="num" id="LN460">460</td><td class="line"><span class='directive'>#define <span class='macro'>is_initialized(M)<span class='macro_popup'>((M)-&gt;top != 0)</span></span>	((M)-&gt;top != 0)</span></td></tr>
<tr class="codeline" data-linenumber="461"><td class="num" id="LN461">461</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="462"><td class="num" id="LN462">462</td><td class="line"><span class='comment'>/* -------------------------- system alloc setup ------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="463"><td class="num" id="LN463">463</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="464"><td class="num" id="LN464">464</td><td class="line"><span class='comment'>/* page-align a size */</span></td></tr>
<tr class="codeline" data-linenumber="465"><td class="num" id="LN465">465</td><td class="line"><span class='directive'>#define <span class='macro'>page_align(S)<span class='macro_popup'>(((S) + (4096 - ((size_t)1))) &amp; ~(4096 - ((size_t)1)))</span></span>\</span></td></tr>
<tr class="codeline" data-linenumber="466"><td class="num" id="LN466">466</td><td class="line"> <span class='directive'>(((S) + (<span class='macro'>LJ_PAGESIZE<span class='macro_popup'>4096</span></span> - <span class='macro'>SIZE_T_ONE<span class='macro_popup'>((size_t)1)</span></span>)) &amp; ~(<span class='macro'>LJ_PAGESIZE<span class='macro_popup'>4096</span></span> - <span class='macro'>SIZE_T_ONE<span class='macro_popup'>((size_t)1)</span></span>))</span></td></tr>
<tr class="codeline" data-linenumber="467"><td class="num" id="LN467">467</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="468"><td class="num" id="LN468">468</td><td class="line"><span class='comment'>/* granularity-align a size */</span></td></tr>
<tr class="codeline" data-linenumber="469"><td class="num" id="LN469">469</td><td class="line"><span class='directive'>#define <span class='macro'>granularity_align(S)<span class='macro_popup'>(((S) + (((size_t)128U * (size_t)1024U) - ((size_t)1))) &amp;<br> ~(((size_t)128U * (size_t)1024U) - ((size_t)1)))</span></span>\</span></td></tr>
<tr class="codeline" data-linenumber="470"><td class="num" id="LN470">470</td><td class="line">  <span class='directive'>(((S) + (<span class='macro'>DEFAULT_GRANULARITY<span class='macro_popup'>((size_t)128U * (size_t)1024U)</span></span> - <span class='macro'>SIZE_T_ONE<span class='macro_popup'>((size_t)1)</span></span>))\</span></td></tr>
<tr class="codeline" data-linenumber="471"><td class="num" id="LN471">471</td><td class="line">   <span class='directive'>&amp; ~(<span class='macro'>DEFAULT_GRANULARITY<span class='macro_popup'>((size_t)128U * (size_t)1024U)</span></span> - <span class='macro'>SIZE_T_ONE<span class='macro_popup'>((size_t)1)</span></span>))</span></td></tr>
<tr class="codeline" data-linenumber="472"><td class="num" id="LN472">472</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="473"><td class="num" id="LN473">473</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_TARGET_WINDOWS<span class='macro_popup'>(2 == 1)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="474"><td class="num" id="LN474">474</td><td class="line"><span class='directive'>#define <span class='macro'>mmap_align(S)<span class='macro_popup'>(((S) + (4096 - ((size_t)1))) &amp; ~(4096 - ((size_t)1)))</span></span>	<span class='macro'>granularity_align(S)<span class='macro_popup'>(((S) + (((size_t)128U * (size_t)1024U) - ((size_t)1))) &amp;<br> ~(((size_t)128U * (size_t)1024U) - ((size_t)1)))</span></span></span></td></tr>
<tr class="codeline" data-linenumber="475"><td class="num" id="LN475">475</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="476"><td class="num" id="LN476">476</td><td class="line"><span class='directive'>#define <span class='macro'>mmap_align(S)<span class='macro_popup'>(((S) + (4096 - ((size_t)1))) &amp; ~(4096 - ((size_t)1)))</span></span>	<span class='macro'>page_align(S)<span class='macro_popup'>(((S) + (4096 - ((size_t)1))) &amp; ~(4096 - ((size_t)1)))</span></span></span></td></tr>
<tr class="codeline" data-linenumber="477"><td class="num" id="LN477">477</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="478"><td class="num" id="LN478">478</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="479"><td class="num" id="LN479">479</td><td class="line"><span class='comment'>/*  True if segment S holds address A */</span></td></tr>
<tr class="codeline" data-linenumber="480"><td class="num" id="LN480">480</td><td class="line"><span class='directive'>#define <span class='macro'>segment_holds(S, A)<span class='macro_popup'>((char *)(A) &gt;= S-&gt;base &amp;&amp; (char *)(A) &lt; S-&gt;<br>base + S-&gt;size)</span></span>\</span></td></tr>
<tr class="codeline" data-linenumber="481"><td class="num" id="LN481">481</td><td class="line">  <span class='directive'>((char *)(A) &gt;= S-&gt;base &amp;&amp; (char *)(A) &lt; S-&gt;base + S-&gt;size)</span></td></tr>
<tr class="codeline" data-linenumber="482"><td class="num" id="LN482">482</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="483"><td class="num" id="LN483">483</td><td class="line"><span class='comment'>/* Return segment holding given address */</span></td></tr>
<tr class="codeline" data-linenumber="484"><td class="num" id="LN484">484</td><td class="line"><span class='keyword'>static</span> msegmentptr segment_holding(mstate m, <span class='keyword'>char</span> *addr)</td></tr>
<tr class="codeline" data-linenumber="485"><td class="num" id="LN485">485</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="486"><td class="num" id="LN486">486</td><td class="line">  msegmentptr sp = &amp;m-&gt;seg;</td></tr>
<tr class="codeline" data-linenumber="487"><td class="num" id="LN487">487</td><td class="line">  <span class='keyword'>for</span> (;;) {</td></tr>
<tr class="codeline" data-linenumber="488"><td class="num" id="LN488">488</td><td class="line">    <span class='keyword'>if</span> (addr &gt;= sp-&gt;base &amp;&amp; addr &lt; sp-&gt;base + sp-&gt;size)</td></tr>
<tr class="codeline" data-linenumber="489"><td class="num" id="LN489">489</td><td class="line">      <span class='keyword'>return</span> sp;</td></tr>
<tr class="codeline" data-linenumber="490"><td class="num" id="LN490">490</td><td class="line">    <span class='keyword'>if</span> ((sp = sp-&gt;next) == 0)</td></tr>
<tr class="codeline" data-linenumber="491"><td class="num" id="LN491">491</td><td class="line">      <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="492"><td class="num" id="LN492">492</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="493"><td class="num" id="LN493">493</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="494"><td class="num" id="LN494">494</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="495"><td class="num" id="LN495">495</td><td class="line"><span class='comment'>/* Return true if segment contains a segment link */</span></td></tr>
<tr class="codeline" data-linenumber="496"><td class="num" id="LN496">496</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> has_segment_link(mstate m, msegmentptr ss)</td></tr>
<tr class="codeline" data-linenumber="497"><td class="num" id="LN497">497</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="498"><td class="num" id="LN498">498</td><td class="line">  msegmentptr sp = &amp;m-&gt;seg;</td></tr>
<tr class="codeline" data-linenumber="499"><td class="num" id="LN499">499</td><td class="line">  <span class='keyword'>for</span> (;;) {</td></tr>
<tr class="codeline" data-linenumber="500"><td class="num" id="LN500">500</td><td class="line">    <span class='keyword'>if</span> ((<span class='keyword'>char</span> *)sp &gt;= ss-&gt;base &amp;&amp; (<span class='keyword'>char</span> *)sp &lt; ss-&gt;base + ss-&gt;size)</td></tr>
<tr class="codeline" data-linenumber="501"><td class="num" id="LN501">501</td><td class="line">      <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="502"><td class="num" id="LN502">502</td><td class="line">    <span class='keyword'>if</span> ((sp = sp-&gt;next) == 0)</td></tr>
<tr class="codeline" data-linenumber="503"><td class="num" id="LN503">503</td><td class="line">      <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="504"><td class="num" id="LN504">504</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="505"><td class="num" id="LN505">505</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="506"><td class="num" id="LN506">506</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="507"><td class="num" id="LN507">507</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="508"><td class="num" id="LN508">508</td><td class="line">  <span class='comment'>TOP_FOOT_SIZE is padding at the end of a segment, including space</span></td></tr>
<tr class="codeline" data-linenumber="509"><td class="num" id="LN509">509</td><td class="line">  <span class='comment'>that may be needed to place segment records and fenceposts when new</span></td></tr>
<tr class="codeline" data-linenumber="510"><td class="num" id="LN510">510</td><td class="line">  <span class='comment'>noncontiguous segments are added.</span></td></tr>
<tr class="codeline" data-linenumber="511"><td class="num" id="LN511">511</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="512"><td class="num" id="LN512">512</td><td class="line"><span class='directive'>#define <span class='macro'>TOP_FOOT_SIZE<span class='macro_popup'>(((((size_t)(((void *)((char *)(0) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1))) == 0)? 0 : ((((size_t<br>)8U) - ((size_t)(((void *)((char *)(0) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1)))) &amp; (((size_t)8U<br>) - ((size_t)1))))+(((sizeof(struct malloc_segment)) + ((sizeof<br>(size_t))) + (((size_t)8U) - ((size_t)1))) &amp; ~(((size_t)8U<br>) - ((size_t)1)))+(((sizeof(mchunk)) + (((size_t)8U) - ((size_t<br>)1))) &amp; ~(((size_t)8U) - ((size_t)1))))</span></span>\</span></td></tr>
<tr class="codeline" data-linenumber="513"><td class="num" id="LN513">513</td><td class="line">  <span class='directive'>(<span class='macro'>align_offset(chunk2mem(0))<span class='macro_popup'>((((size_t)(((void *)((char *)(0) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1))) == 0)? 0 : ((((size_t<br>)8U) - ((size_t)(((void *)((char *)(0) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1)))) &amp; (((size_t)8U<br>) - ((size_t)1))))</span></span>+<span class='macro'>pad_request(sizeof(struct malloc_segment))<span class='macro_popup'>(((sizeof(struct malloc_segment)) + ((sizeof(size_t))) + (((size_t<br>)8U) - ((size_t)1))) &amp; ~(((size_t)8U) - ((size_t)1)))</span></span>+<span class='macro'>MIN_CHUNK_SIZE<span class='macro_popup'>(((sizeof(mchunk)) + (((size_t)8U) - ((size_t)1))) &amp; ~(((<br>size_t)8U) - ((size_t)1)))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="514"><td class="num" id="LN514">514</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="515"><td class="num" id="LN515">515</td><td class="line"><span class='comment'>/* ---------------------------- Indexing Bins ---------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="516"><td class="num" id="LN516">516</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="517"><td class="num" id="LN517">517</td><td class="line"><span class='directive'>#define <span class='macro'>is_small(s)<span class='macro_popup'>(((s) &gt;&gt; (3U)) &lt; (32U))</span></span>		(((s) &gt;&gt; <span class='macro'>SMALLBIN_SHIFT<span class='macro_popup'>(3U)</span></span>) &lt; <span class='macro'>NSMALLBINS<span class='macro_popup'>(32U)</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="518"><td class="num" id="LN518">518</td><td class="line"><span class='directive'>#define <span class='macro'>small_index(s)<span class='macro_popup'>((s) &gt;&gt; (3U))</span></span>		((s)  &gt;&gt; <span class='macro'>SMALLBIN_SHIFT<span class='macro_popup'>(3U)</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="519"><td class="num" id="LN519">519</td><td class="line"><span class='directive'>#define <span class='macro'>small_index2size(i)<span class='macro_popup'>((i) &lt;&lt; (3U))</span></span>	((i)  &lt;&lt; <span class='macro'>SMALLBIN_SHIFT<span class='macro_popup'>(3U)</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="520"><td class="num" id="LN520">520</td><td class="line"><span class='directive'>#define <span class='macro'>MIN_SMALL_INDEX<span class='macro_popup'>((((((sizeof(mchunk)) + (((size_t)8U) - ((size_t)1))) &amp; ~<br>(((size_t)8U) - ((size_t)1)))) &gt;&gt; (3U)))</span></span>		(<span class='macro'>small_index(MIN_CHUNK_SIZE)<span class='macro_popup'>(((((sizeof(mchunk)) + (((size_t)8U) - ((size_t)1))) &amp; ~(<br>((size_t)8U) - ((size_t)1)))) &gt;&gt; (3U))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="521"><td class="num" id="LN521">521</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="522"><td class="num" id="LN522">522</td><td class="line"><span class='comment'>/* addressing by index. See above about smallbin repositioning */</span></td></tr>
<tr class="codeline" data-linenumber="523"><td class="num" id="LN523">523</td><td class="line"><span class='directive'>#define <span class='macro'>smallbin_at(M, i)<span class='macro_popup'>((sbinptr)((char *)&amp;((M)-&gt;smallbins[(i)&lt;&lt;1])))</span></span>	((sbinptr)((char *)&amp;((M)-&gt;smallbins[(i)&lt;&lt;1])))</span></td></tr>
<tr class="codeline" data-linenumber="524"><td class="num" id="LN524">524</td><td class="line"><span class='directive'>#define <span class='macro'>treebin_at(M,i)<span class='macro_popup'>(&amp;((M)-&gt;treebins[i]))</span></span>		(&amp;((M)-&gt;treebins[i]))</span></td></tr>
<tr class="codeline" data-linenumber="525"><td class="num" id="LN525">525</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="526"><td class="num" id="LN526">526</td><td class="line"><span class='comment'>/* assign tree index for size S to variable I */</span></td></tr>
<tr class="codeline" data-linenumber="527"><td class="num" id="LN527">527</td><td class="line"><span class='directive'>#define <span class='macro'>compute_tree_index(S, I)<span class='macro_popup'>{ unsigned int X = (unsigned int)(S &gt;&gt; (8U)); if (X == 0<br>) { I = 0; } else if (X &gt; 0xFFFF) { I = (32U)-1; } else { unsigned<br> int K = ((uint32_t)(__builtin_clz(X)^31)); I = (bindex_t)((K<br> &lt;&lt; 1) + ((S &gt;&gt; (K + ((8U)-1)) &amp; 1))); }}</span></span>\</span></td></tr>
<tr class="codeline" data-linenumber="528"><td class="num" id="LN528">528</td><td class="line"><span class='directive'>{\</span></td></tr>
<tr class="codeline" data-linenumber="529"><td class="num" id="LN529">529</td><td class="line">  <span class='directive'>unsigned int X = (unsigned int)(S &gt;&gt; <span class='macro'>TREEBIN_SHIFT<span class='macro_popup'>(8U)</span></span>);\</span></td></tr>
<tr class="codeline" data-linenumber="530"><td class="num" id="LN530">530</td><td class="line">  <span class='directive'>if (X == 0) {\</span></td></tr>
<tr class="codeline" data-linenumber="531"><td class="num" id="LN531">531</td><td class="line">    <span class='directive'>I = 0;\</span></td></tr>
<tr class="codeline" data-linenumber="532"><td class="num" id="LN532">532</td><td class="line">  <span class='directive'>} else if (X &gt; 0xFFFF) {\</span></td></tr>
<tr class="codeline" data-linenumber="533"><td class="num" id="LN533">533</td><td class="line">    <span class='directive'>I = <span class='macro'>NTREEBINS<span class='macro_popup'>(32U)</span></span>-1;\</span></td></tr>
<tr class="codeline" data-linenumber="534"><td class="num" id="LN534">534</td><td class="line">  <span class='directive'>} else {\</span></td></tr>
<tr class="codeline" data-linenumber="535"><td class="num" id="LN535">535</td><td class="line">    <span class='directive'>unsigned int K = <span class='macro'>lj_fls(X)<span class='macro_popup'>((uint32_t)(__builtin_clz(X)^31))</span></span>;\</span></td></tr>
<tr class="codeline" data-linenumber="536"><td class="num" id="LN536">536</td><td class="line">    <span class='directive'>I =  (bindex_t)((K &lt;&lt; 1) + ((S &gt;&gt; (K + (<span class='macro'>TREEBIN_SHIFT<span class='macro_popup'>(8U)</span></span>-1)) &amp; 1)));\</span></td></tr>
<tr class="codeline" data-linenumber="537"><td class="num" id="LN537">537</td><td class="line">  <span class='directive'>}\</span></td></tr>
<tr class="codeline" data-linenumber="538"><td class="num" id="LN538">538</td><td class="line"><span class='directive'>}</span></td></tr>
<tr class="codeline" data-linenumber="539"><td class="num" id="LN539">539</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="540"><td class="num" id="LN540">540</td><td class="line"><span class='comment'>/* Bit representing maximum resolved size in a treebin at i */</span></td></tr>
<tr class="codeline" data-linenumber="541"><td class="num" id="LN541">541</td><td class="line"><span class='directive'>#define <span class='macro'>bit_for_tree_index(i)<span class='macro_popup'>(i == (32U)-1)? ((sizeof(size_t) &lt;&lt; 3)-1) : (((i) &gt;&gt;<br> 1) + (8U) - 2)</span></span> \</span></td></tr>
<tr class="codeline" data-linenumber="542"><td class="num" id="LN542">542</td><td class="line">   <span class='directive'>(i == <span class='macro'>NTREEBINS<span class='macro_popup'>(32U)</span></span>-1)? (<span class='macro'>SIZE_T_BITSIZE<span class='macro_popup'>(sizeof(size_t) &lt;&lt; 3)</span></span>-1) : (((i) &gt;&gt; 1) + <span class='macro'>TREEBIN_SHIFT<span class='macro_popup'>(8U)</span></span> - 2)</span></td></tr>
<tr class="codeline" data-linenumber="543"><td class="num" id="LN543">543</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="544"><td class="num" id="LN544">544</td><td class="line"><span class='comment'>/* Shift placing maximum resolved bit in a treebin at i as sign bit */</span></td></tr>
<tr class="codeline" data-linenumber="545"><td class="num" id="LN545">545</td><td class="line"><span class='directive'>#define <span class='macro'>leftshift_for_tree_index(i)<span class='macro_popup'>((i == (32U)-1)? 0 : (((sizeof(size_t) &lt;&lt; 3)-((size_t)1<br>)) - (((i) &gt;&gt; 1) + (8U) - 2)))</span></span> \</span></td></tr>
<tr class="codeline" data-linenumber="546"><td class="num" id="LN546">546</td><td class="line">   <span class='directive'>((i == <span class='macro'>NTREEBINS<span class='macro_popup'>(32U)</span></span>-1)? 0 : \</span></td></tr>
<tr class="codeline" data-linenumber="547"><td class="num" id="LN547">547</td><td class="line">    <span class='directive'>((<span class='macro'>SIZE_T_BITSIZE<span class='macro_popup'>(sizeof(size_t) &lt;&lt; 3)</span></span>-<span class='macro'>SIZE_T_ONE<span class='macro_popup'>((size_t)1)</span></span>) - (((i) &gt;&gt; 1) + <span class='macro'>TREEBIN_SHIFT<span class='macro_popup'>(8U)</span></span> - 2)))</span></td></tr>
<tr class="codeline" data-linenumber="548"><td class="num" id="LN548">548</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="549"><td class="num" id="LN549">549</td><td class="line"><span class='comment'>/* The size of the smallest chunk held in bin with index i */</span></td></tr>
<tr class="codeline" data-linenumber="550"><td class="num" id="LN550">550</td><td class="line"><span class='directive'>#define <span class='macro'>minsize_for_tree_index(i)<span class='macro_popup'>((((size_t)1) &lt;&lt; (((i) &gt;&gt; 1) + (8U))) | (((size_t<br>)((i) &amp; ((size_t)1))) &lt;&lt; (((i) &gt;&gt; 1) + (8U) -<br> 1)))</span></span> \</span></td></tr>
<tr class="codeline" data-linenumber="551"><td class="num" id="LN551">551</td><td class="line">   <span class='directive'>((<span class='macro'>SIZE_T_ONE<span class='macro_popup'>((size_t)1)</span></span> &lt;&lt; (((i) &gt;&gt; 1) + <span class='macro'>TREEBIN_SHIFT<span class='macro_popup'>(8U)</span></span>)) |  \</span></td></tr>
<tr class="codeline" data-linenumber="552"><td class="num" id="LN552">552</td><td class="line">   <span class='directive'>(((size_t)((i) &amp; <span class='macro'>SIZE_T_ONE<span class='macro_popup'>((size_t)1)</span></span>)) &lt;&lt; (((i) &gt;&gt; 1) + <span class='macro'>TREEBIN_SHIFT<span class='macro_popup'>(8U)</span></span> - 1)))</span></td></tr>
<tr class="codeline" data-linenumber="553"><td class="num" id="LN553">553</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="554"><td class="num" id="LN554">554</td><td class="line"><span class='comment'>/* ------------------------ Operations on bin maps ----------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="555"><td class="num" id="LN555">555</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="556"><td class="num" id="LN556">556</td><td class="line"><span class='comment'>/* bit corresponding to given index */</span></td></tr>
<tr class="codeline" data-linenumber="557"><td class="num" id="LN557">557</td><td class="line"><span class='directive'>#define <span class='macro'>idx2bit(i)<span class='macro_popup'>((binmap_t)(1) &lt;&lt; (i))</span></span>		((binmap_t)(1) &lt;&lt; (i))</span></td></tr>
<tr class="codeline" data-linenumber="558"><td class="num" id="LN558">558</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="559"><td class="num" id="LN559">559</td><td class="line"><span class='comment'>/* Mark/Clear bits with given index */</span></td></tr>
<tr class="codeline" data-linenumber="560"><td class="num" id="LN560">560</td><td class="line"><span class='directive'>#define <span class='macro'>mark_smallmap(M,i)<span class='macro_popup'>((M)-&gt;smallmap |= ((binmap_t)(1) &lt;&lt; (i)))</span></span>	((M)-&gt;smallmap |=  <span class='macro'>idx2bit(i)<span class='macro_popup'>((binmap_t)(1) &lt;&lt; (i))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="561"><td class="num" id="LN561">561</td><td class="line"><span class='directive'>#define <span class='macro'>clear_smallmap(M,i)<span class='macro_popup'>((M)-&gt;smallmap &amp;= ~((binmap_t)(1) &lt;&lt; (i)))</span></span>	((M)-&gt;smallmap &amp;= ~<span class='macro'>idx2bit(i)<span class='macro_popup'>((binmap_t)(1) &lt;&lt; (i))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="562"><td class="num" id="LN562">562</td><td class="line"><span class='directive'>#define <span class='macro'>smallmap_is_marked(M,i)<span class='macro_popup'>((M)-&gt;smallmap &amp; ((binmap_t)(1) &lt;&lt; (i)))</span></span>	((M)-&gt;smallmap &amp;   <span class='macro'>idx2bit(i)<span class='macro_popup'>((binmap_t)(1) &lt;&lt; (i))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="563"><td class="num" id="LN563">563</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="564"><td class="num" id="LN564">564</td><td class="line"><span class='directive'>#define <span class='macro'>mark_treemap(M,i)<span class='macro_popup'>((M)-&gt;treemap |= ((binmap_t)(1) &lt;&lt; (i)))</span></span>	((M)-&gt;treemap  |=  <span class='macro'>idx2bit(i)<span class='macro_popup'>((binmap_t)(1) &lt;&lt; (i))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="565"><td class="num" id="LN565">565</td><td class="line"><span class='directive'>#define <span class='macro'>clear_treemap(M,i)<span class='macro_popup'>((M)-&gt;treemap &amp;= ~((binmap_t)(1) &lt;&lt; (i)))</span></span>	((M)-&gt;treemap  &amp;= ~<span class='macro'>idx2bit(i)<span class='macro_popup'>((binmap_t)(1) &lt;&lt; (i))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="566"><td class="num" id="LN566">566</td><td class="line"><span class='directive'>#define <span class='macro'>treemap_is_marked(M,i)<span class='macro_popup'>((M)-&gt;treemap &amp; ((binmap_t)(1) &lt;&lt; (i)))</span></span>	((M)-&gt;treemap  &amp;   <span class='macro'>idx2bit(i)<span class='macro_popup'>((binmap_t)(1) &lt;&lt; (i))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="567"><td class="num" id="LN567">567</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="568"><td class="num" id="LN568">568</td><td class="line"><span class='comment'>/* mask with all bits to left of least bit of x on */</span></td></tr>
<tr class="codeline" data-linenumber="569"><td class="num" id="LN569">569</td><td class="line"><span class='directive'>#define <span class='macro'>left_bits(x)<span class='macro_popup'>((x&lt;&lt;1) | (~(x&lt;&lt;1)+1))</span></span>		((x&lt;&lt;1) | (~(x&lt;&lt;1)+1))</span></td></tr>
<tr class="codeline" data-linenumber="570"><td class="num" id="LN570">570</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="571"><td class="num" id="LN571">571</td><td class="line"><span class='comment'>/* Set cinuse bit and pinuse bit of next chunk */</span></td></tr>
<tr class="codeline" data-linenumber="572"><td class="num" id="LN572">572</td><td class="line"><span class='directive'>#define <span class='macro'>set_inuse(M,p,s)<span class='macro_popup'>((p)-&gt;head = (((p)-&gt;head &amp; (((size_t)1)))|s|(((size_t<br>)2))), ((mchunkptr)(((char *)(p)) + (s)))-&gt;head |= (((size_t<br>)1)))</span></span>\</span></td></tr>
<tr class="codeline" data-linenumber="573"><td class="num" id="LN573">573</td><td class="line">  <span class='directive'>((p)-&gt;head = (((p)-&gt;head &amp; <span class='macro'>PINUSE_BIT<span class='macro_popup'>(((size_t)1))</span></span>)|s|<span class='macro'>CINUSE_BIT<span class='macro_popup'>(((size_t)2))</span></span>),\</span></td></tr>
<tr class="codeline" data-linenumber="574"><td class="num" id="LN574">574</td><td class="line">  <span class='directive'>((mchunkptr)(((char *)(p)) + (s)))-&gt;head |= <span class='macro'>PINUSE_BIT<span class='macro_popup'>(((size_t)1))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="575"><td class="num" id="LN575">575</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="576"><td class="num" id="LN576">576</td><td class="line"><span class='comment'>/* Set cinuse and pinuse of this chunk and pinuse of next chunk */</span></td></tr>
<tr class="codeline" data-linenumber="577"><td class="num" id="LN577">577</td><td class="line"><span class='directive'>#define <span class='macro'>set_inuse_and_pinuse(M,p,s)<span class='macro_popup'>((p)-&gt;head = (s|(((size_t)1))|(((size_t)2))), ((mchunkptr)<br>(((char *)(p)) + (s)))-&gt;head |= (((size_t)1)))</span></span>\</span></td></tr>
<tr class="codeline" data-linenumber="578"><td class="num" id="LN578">578</td><td class="line">  <span class='directive'>((p)-&gt;head = (s|<span class='macro'>PINUSE_BIT<span class='macro_popup'>(((size_t)1))</span></span>|<span class='macro'>CINUSE_BIT<span class='macro_popup'>(((size_t)2))</span></span>),\</span></td></tr>
<tr class="codeline" data-linenumber="579"><td class="num" id="LN579">579</td><td class="line">  <span class='directive'>((mchunkptr)(((char *)(p)) + (s)))-&gt;head |= <span class='macro'>PINUSE_BIT<span class='macro_popup'>(((size_t)1))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="580"><td class="num" id="LN580">580</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="581"><td class="num" id="LN581">581</td><td class="line"><span class='comment'>/* Set size, cinuse and pinuse bit of this chunk */</span></td></tr>
<tr class="codeline" data-linenumber="582"><td class="num" id="LN582">582</td><td class="line"><span class='directive'>#define <span class='macro'>set_size_and_pinuse_of_inuse_chunk(M, p, s)<span class='macro_popup'>((p)-&gt;head = (s|(((size_t)1))|(((size_t)2))))</span></span>\</span></td></tr>
<tr class="codeline" data-linenumber="583"><td class="num" id="LN583">583</td><td class="line">  <span class='directive'>((p)-&gt;head = (s|<span class='macro'>PINUSE_BIT<span class='macro_popup'>(((size_t)1))</span></span>|<span class='macro'>CINUSE_BIT<span class='macro_popup'>(((size_t)2))</span></span>))</span></td></tr>
<tr class="codeline" data-linenumber="584"><td class="num" id="LN584">584</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="585"><td class="num" id="LN585">585</td><td class="line"><span class='comment'>/* ----------------------- Operations on smallbins ----------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="586"><td class="num" id="LN586">586</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="587"><td class="num" id="LN587">587</td><td class="line"><span class='comment'>/* Link a free chunk into a smallbin  */</span></td></tr>
<tr class="codeline" data-linenumber="588"><td class="num" id="LN588">588</td><td class="line"><span class='directive'>#define <span class='macro'>insert_small_chunk(M, P, S)<span class='macro_popup'>{ bindex_t I = ((S) &gt;&gt; (3U)); mchunkptr B = ((sbinptr)(<br>(char *)&amp;((M)-&gt;smallbins[(I)&lt;&lt;1]))); mchunkptr F<br> = B; if (!((M)-&gt;smallmap &amp; ((binmap_t)(1) &lt;&lt; (I<br>)))) ((M)-&gt;smallmap |= ((binmap_t)(1) &lt;&lt; (I))); else<br> F = B-&gt;fd; B-&gt;fd = P; F-&gt;bk = P; P-&gt;fd = F; P-&gt;<br>bk = B;}</span></span> {\</span></td></tr>
<tr class="codeline" data-linenumber="589"><td class="num" id="LN589">589</td><td class="line">  <span class='directive'>bindex_t I = <span class='macro'>small_index(S)<span class='macro_popup'>((S) &gt;&gt; (3U))</span></span>;\</span></td></tr>
<tr class="codeline" data-linenumber="590"><td class="num" id="LN590">590</td><td class="line">  <span class='directive'>mchunkptr B = <span class='macro'>smallbin_at(M, I)<span class='macro_popup'>((sbinptr)((char *)&amp;((M)-&gt;smallbins[(I)&lt;&lt;1])))</span></span>;\</span></td></tr>
<tr class="codeline" data-linenumber="591"><td class="num" id="LN591">591</td><td class="line">  <span class='directive'>mchunkptr F = B;\</span></td></tr>
<tr class="codeline" data-linenumber="592"><td class="num" id="LN592">592</td><td class="line">  <span class='directive'>if (!<span class='macro'>smallmap_is_marked(M, I)<span class='macro_popup'>((M)-&gt;smallmap &amp; ((binmap_t)(1) &lt;&lt; (I)))</span></span>)\</span></td></tr>
<tr class="codeline" data-linenumber="593"><td class="num" id="LN593">593</td><td class="line">    <span class='directive'><span class='macro'>mark_smallmap(M, I)<span class='macro_popup'>((M)-&gt;smallmap |= ((binmap_t)(1) &lt;&lt; (I)))</span></span>;\</span></td></tr>
<tr class="codeline" data-linenumber="594"><td class="num" id="LN594">594</td><td class="line">  <span class='directive'>else\</span></td></tr>
<tr class="codeline" data-linenumber="595"><td class="num" id="LN595">595</td><td class="line">    <span class='directive'>F = B-&gt;fd;\</span></td></tr>
<tr class="codeline" data-linenumber="596"><td class="num" id="LN596">596</td><td class="line">  <span class='directive'>B-&gt;fd = P;\</span></td></tr>
<tr class="codeline" data-linenumber="597"><td class="num" id="LN597">597</td><td class="line">  <span class='directive'>F-&gt;bk = P;\</span></td></tr>
<tr class="codeline" data-linenumber="598"><td class="num" id="LN598">598</td><td class="line">  <span class='directive'>P-&gt;fd = F;\</span></td></tr>
<tr class="codeline" data-linenumber="599"><td class="num" id="LN599">599</td><td class="line">  <span class='directive'>P-&gt;bk = B;\</span></td></tr>
<tr class="codeline" data-linenumber="600"><td class="num" id="LN600">600</td><td class="line"><span class='directive'>}</span></td></tr>
<tr class="codeline" data-linenumber="601"><td class="num" id="LN601">601</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="602"><td class="num" id="LN602">602</td><td class="line"><span class='comment'>/* Unlink a chunk from a smallbin  */</span></td></tr>
<tr class="codeline" data-linenumber="603"><td class="num" id="LN603">603</td><td class="line"><span class='directive'>#define <span class='macro'>unlink_small_chunk(M, P, S)<span class='macro_popup'>{ mchunkptr F = P-&gt;fd; mchunkptr B = P-&gt;bk; bindex_t I =<br> ((S) &gt;&gt; (3U)); if (F == B) { ((M)-&gt;smallmap &amp;= ~<br>((binmap_t)(1) &lt;&lt; (I))); } else { F-&gt;bk = B; B-&gt;fd<br> = F; }}</span></span> {\</span></td></tr>
<tr class="codeline" data-linenumber="604"><td class="num" id="LN604">604</td><td class="line">  <span class='directive'>mchunkptr F = P-&gt;fd;\</span></td></tr>
<tr class="codeline" data-linenumber="605"><td class="num" id="LN605">605</td><td class="line">  <span class='directive'>mchunkptr B = P-&gt;bk;\</span></td></tr>
<tr class="codeline" data-linenumber="606"><td class="num" id="LN606">606</td><td class="line">  <span class='directive'>bindex_t I = <span class='macro'>small_index(S)<span class='macro_popup'>((S) &gt;&gt; (3U))</span></span>;\</span></td></tr>
<tr class="codeline" data-linenumber="607"><td class="num" id="LN607">607</td><td class="line">  <span class='directive'>if (F == B) {\</span></td></tr>
<tr class="codeline" data-linenumber="608"><td class="num" id="LN608">608</td><td class="line">    <span class='directive'><span class='macro'>clear_smallmap(M, I)<span class='macro_popup'>((M)-&gt;smallmap &amp;= ~((binmap_t)(1) &lt;&lt; (I)))</span></span>;\</span></td></tr>
<tr class="codeline" data-linenumber="609"><td class="num" id="LN609">609</td><td class="line">  <span class='directive'>} else {\</span></td></tr>
<tr class="codeline" data-linenumber="610"><td class="num" id="LN610">610</td><td class="line">    <span class='directive'>F-&gt;bk = B;\</span></td></tr>
<tr class="codeline" data-linenumber="611"><td class="num" id="LN611">611</td><td class="line">    <span class='directive'>B-&gt;fd = F;\</span></td></tr>
<tr class="codeline" data-linenumber="612"><td class="num" id="LN612">612</td><td class="line">  <span class='directive'>}\</span></td></tr>
<tr class="codeline" data-linenumber="613"><td class="num" id="LN613">613</td><td class="line"><span class='directive'>}</span></td></tr>
<tr class="codeline" data-linenumber="614"><td class="num" id="LN614">614</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="615"><td class="num" id="LN615">615</td><td class="line"><span class='comment'>/* Unlink the first chunk from a smallbin */</span></td></tr>
<tr class="codeline" data-linenumber="616"><td class="num" id="LN616">616</td><td class="line"><span class='directive'>#define <span class='macro'>unlink_first_small_chunk(M, B, P, I)<span class='macro_popup'>{ mchunkptr F = P-&gt;fd; if (B == F) { ((M)-&gt;smallmap &amp;=<br> ~((binmap_t)(1) &lt;&lt; (I))); } else { B-&gt;fd = F; F-&gt;<br>bk = B; }}</span></span> {\</span></td></tr>
<tr class="codeline" data-linenumber="617"><td class="num" id="LN617">617</td><td class="line">  <span class='directive'>mchunkptr F = P-&gt;fd;\</span></td></tr>
<tr class="codeline" data-linenumber="618"><td class="num" id="LN618">618</td><td class="line">  <span class='directive'>if (B == F) {\</span></td></tr>
<tr class="codeline" data-linenumber="619"><td class="num" id="LN619">619</td><td class="line">    <span class='directive'><span class='macro'>clear_smallmap(M, I)<span class='macro_popup'>((M)-&gt;smallmap &amp;= ~((binmap_t)(1) &lt;&lt; (I)))</span></span>;\</span></td></tr>
<tr class="codeline" data-linenumber="620"><td class="num" id="LN620">620</td><td class="line">  <span class='directive'>} else {\</span></td></tr>
<tr class="codeline" data-linenumber="621"><td class="num" id="LN621">621</td><td class="line">    <span class='directive'>B-&gt;fd = F;\</span></td></tr>
<tr class="codeline" data-linenumber="622"><td class="num" id="LN622">622</td><td class="line">    <span class='directive'>F-&gt;bk = B;\</span></td></tr>
<tr class="codeline" data-linenumber="623"><td class="num" id="LN623">623</td><td class="line">  <span class='directive'>}\</span></td></tr>
<tr class="codeline" data-linenumber="624"><td class="num" id="LN624">624</td><td class="line"><span class='directive'>}</span></td></tr>
<tr class="codeline" data-linenumber="625"><td class="num" id="LN625">625</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="626"><td class="num" id="LN626">626</td><td class="line"><span class='comment'>/* Replace dv node, binning the old one */</span></td></tr>
<tr class="codeline" data-linenumber="627"><td class="num" id="LN627">627</td><td class="line"><span class='comment'>/* Used only when dvsize known to be small */</span></td></tr>
<tr class="codeline" data-linenumber="628"><td class="num" id="LN628">628</td><td class="line"><span class='directive'>#define <span class='macro'>replace_dv(M, P, S)<span class='macro_popup'>{ size_t DVS = M-&gt;dvsize; if (DVS != 0) { mchunkptr DV = M<br>-&gt;dv; { bindex_t I = ((DVS) &gt;&gt; (3U)); mchunkptr B = (<br>(sbinptr)((char *)&amp;((M)-&gt;smallbins[(I)&lt;&lt;1]))); mchunkptr<br> F = B; if (!((M)-&gt;smallmap &amp; ((binmap_t)(1) &lt;&lt; (<br>I)))) ((M)-&gt;smallmap |= ((binmap_t)(1) &lt;&lt; (I))); else<br> F = B-&gt;fd; B-&gt;fd = DV; F-&gt;bk = DV; DV-&gt;fd = F; DV<br>-&gt;bk = B;}; } M-&gt;dvsize = S; M-&gt;dv = P;}</span></span> {\</span></td></tr>
<tr class="codeline" data-linenumber="629"><td class="num" id="LN629">629</td><td class="line">  <span class='directive'>size_t DVS = M-&gt;dvsize;\</span></td></tr>
<tr class="codeline" data-linenumber="630"><td class="num" id="LN630">630</td><td class="line">  <span class='directive'>if (DVS != 0) {\</span></td></tr>
<tr class="codeline" data-linenumber="631"><td class="num" id="LN631">631</td><td class="line">    <span class='directive'>mchunkptr DV = M-&gt;dv;\</span></td></tr>
<tr class="codeline" data-linenumber="632"><td class="num" id="LN632">632</td><td class="line">    <span class='directive'><span class='macro'>insert_small_chunk(M, DV, DVS)<span class='macro_popup'>{ bindex_t I = ((DVS) &gt;&gt; (3U)); mchunkptr B = ((sbinptr<br>)((char *)&amp;((M)-&gt;smallbins[(I)&lt;&lt;1]))); mchunkptr<br> F = B; if (!((M)-&gt;smallmap &amp; ((binmap_t)(1) &lt;&lt; (<br>I)))) ((M)-&gt;smallmap |= ((binmap_t)(1) &lt;&lt; (I))); else<br> F = B-&gt;fd; B-&gt;fd = DV; F-&gt;bk = DV; DV-&gt;fd = F; DV<br>-&gt;bk = B;}</span></span>;\</span></td></tr>
<tr class="codeline" data-linenumber="633"><td class="num" id="LN633">633</td><td class="line">  <span class='directive'>}\</span></td></tr>
<tr class="codeline" data-linenumber="634"><td class="num" id="LN634">634</td><td class="line">  <span class='directive'>M-&gt;dvsize = S;\</span></td></tr>
<tr class="codeline" data-linenumber="635"><td class="num" id="LN635">635</td><td class="line">  <span class='directive'>M-&gt;dv = P;\</span></td></tr>
<tr class="codeline" data-linenumber="636"><td class="num" id="LN636">636</td><td class="line"><span class='directive'>}</span></td></tr>
<tr class="codeline" data-linenumber="637"><td class="num" id="LN637">637</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="638"><td class="num" id="LN638">638</td><td class="line"><span class='comment'>/* ------------------------- Operations on trees ------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="639"><td class="num" id="LN639">639</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="640"><td class="num" id="LN640">640</td><td class="line"><span class='comment'>/* Insert chunk into tree */</span></td></tr>
<tr class="codeline" data-linenumber="641"><td class="num" id="LN641">641</td><td class="line"><span class='directive'>#define <span class='macro'>insert_large_chunk(M, X, S)<span class='macro_popup'>{ tbinptr *H; bindex_t I; { unsigned int X = (unsigned int)(S<br> &gt;&gt; (8U)); if (X == 0) { I = 0; } else if (X &gt; 0xFFFF<br>) { I = (32U)-1; } else { unsigned int K = ((uint32_t)(__builtin_clz<br>(X)^31)); I = (bindex_t)((K &lt;&lt; 1) + ((S &gt;&gt; (K + (<br>(8U)-1)) &amp; 1))); }}; H = (&amp;((M)-&gt;treebins[I])); X-&gt;<br>index = I; X-&gt;child[0] = X-&gt;child[1] = 0; if (!((M)-&gt;<br>treemap &amp; ((binmap_t)(1) &lt;&lt; (I)))) { ((M)-&gt;treemap<br> |= ((binmap_t)(1) &lt;&lt; (I))); *H = X; X-&gt;parent = (tchunkptr<br>)H; X-&gt;fd = X-&gt;bk = X; } else { tchunkptr T = *H; size_t<br> K = S &lt;&lt; ((I == (32U)-1)? 0 : (((sizeof(size_t) &lt;&lt;<br> 3)-((size_t)1)) - (((I) &gt;&gt; 1) + (8U) - 2))); for (;;) {<br> if (((T)-&gt;head &amp; ~(((((size_t)1))|(((size_t)2))))) !=<br> S) { tchunkptr *C = &amp;(T-&gt;child[(K &gt;&gt; ((sizeof(size_t<br>) &lt;&lt; 3)-((size_t)1))) &amp; 1]); K &lt;&lt;= 1; if (*C !=<br> 0) { T = *C; } else { *C = X; X-&gt;parent = T; X-&gt;fd = X<br>-&gt;bk = X; break; } } else { tchunkptr F = T-&gt;fd; T-&gt;<br>fd = F-&gt;bk = X; X-&gt;fd = F; X-&gt;bk = T; X-&gt;parent =<br> 0; break; } } }}</span></span> {\</span></td></tr>
<tr class="codeline" data-linenumber="642"><td class="num" id="LN642">642</td><td class="line">  <span class='directive'>tbinptr *H;\</span></td></tr>
<tr class="codeline" data-linenumber="643"><td class="num" id="LN643">643</td><td class="line">  <span class='directive'>bindex_t I;\</span></td></tr>
<tr class="codeline" data-linenumber="644"><td class="num" id="LN644">644</td><td class="line">  <span class='directive'><span class='macro'>compute_tree_index(S, I)<span class='macro_popup'>{ unsigned int X = (unsigned int)(S &gt;&gt; (8U)); if (X == 0<br>) { I = 0; } else if (X &gt; 0xFFFF) { I = (32U)-1; } else { unsigned<br> int K = ((uint32_t)(__builtin_clz(X)^31)); I = (bindex_t)((K<br> &lt;&lt; 1) + ((S &gt;&gt; (K + ((8U)-1)) &amp; 1))); }}</span></span>;\</span></td></tr>
<tr class="codeline" data-linenumber="645"><td class="num" id="LN645">645</td><td class="line">  <span class='directive'>H = <span class='macro'>treebin_at(M, I)<span class='macro_popup'>(&amp;((M)-&gt;treebins[I]))</span></span>;\</span></td></tr>
<tr class="codeline" data-linenumber="646"><td class="num" id="LN646">646</td><td class="line">  <span class='directive'>X-&gt;index = I;\</span></td></tr>
<tr class="codeline" data-linenumber="647"><td class="num" id="LN647">647</td><td class="line">  <span class='directive'>X-&gt;child[0] = X-&gt;child[1] = 0;\</span></td></tr>
<tr class="codeline" data-linenumber="648"><td class="num" id="LN648">648</td><td class="line">  <span class='directive'>if (!<span class='macro'>treemap_is_marked(M, I)<span class='macro_popup'>((M)-&gt;treemap &amp; ((binmap_t)(1) &lt;&lt; (I)))</span></span>) {\</span></td></tr>
<tr class="codeline" data-linenumber="649"><td class="num" id="LN649">649</td><td class="line">    <span class='directive'><span class='macro'>mark_treemap(M, I)<span class='macro_popup'>((M)-&gt;treemap |= ((binmap_t)(1) &lt;&lt; (I)))</span></span>;\</span></td></tr>
<tr class="codeline" data-linenumber="650"><td class="num" id="LN650">650</td><td class="line">    <span class='directive'>*H = X;\</span></td></tr>
<tr class="codeline" data-linenumber="651"><td class="num" id="LN651">651</td><td class="line">    <span class='directive'>X-&gt;parent = (tchunkptr)H;\</span></td></tr>
<tr class="codeline" data-linenumber="652"><td class="num" id="LN652">652</td><td class="line">    <span class='directive'>X-&gt;fd = X-&gt;bk = X;\</span></td></tr>
<tr class="codeline" data-linenumber="653"><td class="num" id="LN653">653</td><td class="line">  <span class='directive'>} else {\</span></td></tr>
<tr class="codeline" data-linenumber="654"><td class="num" id="LN654">654</td><td class="line">    <span class='directive'>tchunkptr T = *H;\</span></td></tr>
<tr class="codeline" data-linenumber="655"><td class="num" id="LN655">655</td><td class="line">    <span class='directive'>size_t K = S &lt;&lt; <span class='macro'>leftshift_for_tree_index(I)<span class='macro_popup'>((I == (32U)-1)? 0 : (((sizeof(size_t) &lt;&lt; 3)-((size_t)1<br>)) - (((I) &gt;&gt; 1) + (8U) - 2)))</span></span>;\</span></td></tr>
<tr class="codeline" data-linenumber="656"><td class="num" id="LN656">656</td><td class="line">    <span class='directive'>for (;;) {\</span></td></tr>
<tr class="codeline" data-linenumber="657"><td class="num" id="LN657">657</td><td class="line">      <span class='directive'>if (<span class='macro'>chunksize(T)<span class='macro_popup'>((T)-&gt;head &amp; ~(((((size_t)1))|(((size_t)2)))))</span></span> != S) {\</span></td></tr>
<tr class="codeline" data-linenumber="658"><td class="num" id="LN658">658</td><td class="line">	<span class='directive'>tchunkptr *C = &amp;(T-&gt;child[(K &gt;&gt; (<span class='macro'>SIZE_T_BITSIZE<span class='macro_popup'>(sizeof(size_t) &lt;&lt; 3)</span></span>-<span class='macro'>SIZE_T_ONE<span class='macro_popup'>((size_t)1)</span></span>)) &amp; 1]);\</span></td></tr>
<tr class="codeline" data-linenumber="659"><td class="num" id="LN659">659</td><td class="line">	<span class='directive'>K &lt;&lt;= 1;\</span></td></tr>
<tr class="codeline" data-linenumber="660"><td class="num" id="LN660">660</td><td class="line">	<span class='directive'>if (*C != 0) {\</span></td></tr>
<tr class="codeline" data-linenumber="661"><td class="num" id="LN661">661</td><td class="line">	  <span class='directive'>T = *C;\</span></td></tr>
<tr class="codeline" data-linenumber="662"><td class="num" id="LN662">662</td><td class="line">	<span class='directive'>} else {\</span></td></tr>
<tr class="codeline" data-linenumber="663"><td class="num" id="LN663">663</td><td class="line">	  <span class='directive'>*C = X;\</span></td></tr>
<tr class="codeline" data-linenumber="664"><td class="num" id="LN664">664</td><td class="line">	  <span class='directive'>X-&gt;parent = T;\</span></td></tr>
<tr class="codeline" data-linenumber="665"><td class="num" id="LN665">665</td><td class="line">	  <span class='directive'>X-&gt;fd = X-&gt;bk = X;\</span></td></tr>
<tr class="codeline" data-linenumber="666"><td class="num" id="LN666">666</td><td class="line">	  <span class='directive'>break;\</span></td></tr>
<tr class="codeline" data-linenumber="667"><td class="num" id="LN667">667</td><td class="line">	<span class='directive'>}\</span></td></tr>
<tr class="codeline" data-linenumber="668"><td class="num" id="LN668">668</td><td class="line">      <span class='directive'>} else {\</span></td></tr>
<tr class="codeline" data-linenumber="669"><td class="num" id="LN669">669</td><td class="line">	<span class='directive'>tchunkptr F = T-&gt;fd;\</span></td></tr>
<tr class="codeline" data-linenumber="670"><td class="num" id="LN670">670</td><td class="line">	<span class='directive'>T-&gt;fd = F-&gt;bk = X;\</span></td></tr>
<tr class="codeline" data-linenumber="671"><td class="num" id="LN671">671</td><td class="line">	<span class='directive'>X-&gt;fd = F;\</span></td></tr>
<tr class="codeline" data-linenumber="672"><td class="num" id="LN672">672</td><td class="line">	<span class='directive'>X-&gt;bk = T;\</span></td></tr>
<tr class="codeline" data-linenumber="673"><td class="num" id="LN673">673</td><td class="line">	<span class='directive'>X-&gt;parent = 0;\</span></td></tr>
<tr class="codeline" data-linenumber="674"><td class="num" id="LN674">674</td><td class="line">	<span class='directive'>break;\</span></td></tr>
<tr class="codeline" data-linenumber="675"><td class="num" id="LN675">675</td><td class="line">      <span class='directive'>}\</span></td></tr>
<tr class="codeline" data-linenumber="676"><td class="num" id="LN676">676</td><td class="line">    <span class='directive'>}\</span></td></tr>
<tr class="codeline" data-linenumber="677"><td class="num" id="LN677">677</td><td class="line">  <span class='directive'>}\</span></td></tr>
<tr class="codeline" data-linenumber="678"><td class="num" id="LN678">678</td><td class="line"><span class='directive'>}</span></td></tr>
<tr class="codeline" data-linenumber="679"><td class="num" id="LN679">679</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="680"><td class="num" id="LN680">680</td><td class="line"><span class='directive'>#define <span class='macro'>unlink_large_chunk(M, X)<span class='macro_popup'>{ tchunkptr XP = X-&gt;parent; tchunkptr R; if (X-&gt;bk != X<br>) { tchunkptr F = X-&gt;fd; R = X-&gt;bk; F-&gt;bk = R; R-&gt;<br>fd = F; } else { tchunkptr *RP; if (((R = *(RP = &amp;(X-&gt;<br>child[1]))) != 0) || ((R = *(RP = &amp;(X-&gt;child[0]))) != 0<br>)) { tchunkptr *CP; while ((*(CP = &amp;(R-&gt;child[1])) != 0<br>) || (*(CP = &amp;(R-&gt;child[0])) != 0)) { R = *(RP = CP); }<br> *RP = 0; } } if (XP != 0) { tbinptr *H = (&amp;((M)-&gt;treebins<br>[X-&gt;index])); if (X == *H) { if ((*H = R) == 0) ((M)-&gt;treemap<br> &amp;= ~((binmap_t)(1) &lt;&lt; (X-&gt;index))); } else { if<br> (XP-&gt;child[0] == X) XP-&gt;child[0] = R; else XP-&gt;child<br>[1] = R; } if (R != 0) { tchunkptr C0, C1; R-&gt;parent = XP;<br> if ((C0 = X-&gt;child[0]) != 0) { R-&gt;child[0] = C0; C0-&gt;<br>parent = R; } if ((C1 = X-&gt;child[1]) != 0) { R-&gt;child[1<br>] = C1; C1-&gt;parent = R; } } }}</span></span> {\</span></td></tr>
<tr class="codeline" data-linenumber="681"><td class="num" id="LN681">681</td><td class="line">  <span class='directive'>tchunkptr XP = X-&gt;parent;\</span></td></tr>
<tr class="codeline" data-linenumber="682"><td class="num" id="LN682">682</td><td class="line">  <span class='directive'>tchunkptr R;\</span></td></tr>
<tr class="codeline" data-linenumber="683"><td class="num" id="LN683">683</td><td class="line">  <span class='directive'>if (X-&gt;bk != X) {\</span></td></tr>
<tr class="codeline" data-linenumber="684"><td class="num" id="LN684">684</td><td class="line">    <span class='directive'>tchunkptr F = X-&gt;fd;\</span></td></tr>
<tr class="codeline" data-linenumber="685"><td class="num" id="LN685">685</td><td class="line">    <span class='directive'>R = X-&gt;bk;\</span></td></tr>
<tr class="codeline" data-linenumber="686"><td class="num" id="LN686">686</td><td class="line">    <span class='directive'>F-&gt;bk = R;\</span></td></tr>
<tr class="codeline" data-linenumber="687"><td class="num" id="LN687">687</td><td class="line">    <span class='directive'>R-&gt;fd = F;\</span></td></tr>
<tr class="codeline" data-linenumber="688"><td class="num" id="LN688">688</td><td class="line">  <span class='directive'>} else {\</span></td></tr>
<tr class="codeline" data-linenumber="689"><td class="num" id="LN689">689</td><td class="line">    <span class='directive'>tchunkptr *RP;\</span></td></tr>
<tr class="codeline" data-linenumber="690"><td class="num" id="LN690">690</td><td class="line">    <span class='directive'>if (((R = *(RP = &amp;(X-&gt;child[1]))) != 0) ||\</span></td></tr>
<tr class="codeline" data-linenumber="691"><td class="num" id="LN691">691</td><td class="line">	<span class='directive'>((R = *(RP = &amp;(X-&gt;child[0]))) != 0)) {\</span></td></tr>
<tr class="codeline" data-linenumber="692"><td class="num" id="LN692">692</td><td class="line">      <span class='directive'>tchunkptr *CP;\</span></td></tr>
<tr class="codeline" data-linenumber="693"><td class="num" id="LN693">693</td><td class="line">      <span class='directive'>while ((*(CP = &amp;(R-&gt;child[1])) != 0) ||\</span></td></tr>
<tr class="codeline" data-linenumber="694"><td class="num" id="LN694">694</td><td class="line">	     <span class='directive'>(*(CP = &amp;(R-&gt;child[0])) != 0)) {\</span></td></tr>
<tr class="codeline" data-linenumber="695"><td class="num" id="LN695">695</td><td class="line">	<span class='directive'>R = *(RP = CP);\</span></td></tr>
<tr class="codeline" data-linenumber="696"><td class="num" id="LN696">696</td><td class="line">      <span class='directive'>}\</span></td></tr>
<tr class="codeline" data-linenumber="697"><td class="num" id="LN697">697</td><td class="line">      <span class='directive'>*RP = 0;\</span></td></tr>
<tr class="codeline" data-linenumber="698"><td class="num" id="LN698">698</td><td class="line">    <span class='directive'>}\</span></td></tr>
<tr class="codeline" data-linenumber="699"><td class="num" id="LN699">699</td><td class="line">  <span class='directive'>}\</span></td></tr>
<tr class="codeline" data-linenumber="700"><td class="num" id="LN700">700</td><td class="line">  <span class='directive'>if (XP != 0) {\</span></td></tr>
<tr class="codeline" data-linenumber="701"><td class="num" id="LN701">701</td><td class="line">    <span class='directive'>tbinptr *H = <span class='macro'>treebin_at(M, X-&gt;index)<span class='macro_popup'>(&amp;((M)-&gt;treebins[X-&gt;index]))</span></span>;\</span></td></tr>
<tr class="codeline" data-linenumber="702"><td class="num" id="LN702">702</td><td class="line">    <span class='directive'>if (X == *H) {\</span></td></tr>
<tr class="codeline" data-linenumber="703"><td class="num" id="LN703">703</td><td class="line">      <span class='directive'>if ((*H = R) == 0) \</span></td></tr>
<tr class="codeline" data-linenumber="704"><td class="num" id="LN704">704</td><td class="line">	<span class='directive'><span class='macro'>clear_treemap(M, X-&gt;index)<span class='macro_popup'>((M)-&gt;treemap &amp;= ~((binmap_t)(1) &lt;&lt; (X-&gt;index<br>)))</span></span>;\</span></td></tr>
<tr class="codeline" data-linenumber="705"><td class="num" id="LN705">705</td><td class="line">    <span class='directive'>} else {\</span></td></tr>
<tr class="codeline" data-linenumber="706"><td class="num" id="LN706">706</td><td class="line">      <span class='directive'>if (XP-&gt;child[0] == X) \</span></td></tr>
<tr class="codeline" data-linenumber="707"><td class="num" id="LN707">707</td><td class="line">	<span class='directive'>XP-&gt;child[0] = R;\</span></td></tr>
<tr class="codeline" data-linenumber="708"><td class="num" id="LN708">708</td><td class="line">      <span class='directive'>else \</span></td></tr>
<tr class="codeline" data-linenumber="709"><td class="num" id="LN709">709</td><td class="line">	<span class='directive'>XP-&gt;child[1] = R;\</span></td></tr>
<tr class="codeline" data-linenumber="710"><td class="num" id="LN710">710</td><td class="line">    <span class='directive'>}\</span></td></tr>
<tr class="codeline" data-linenumber="711"><td class="num" id="LN711">711</td><td class="line">    <span class='directive'>if (R != 0) {\</span></td></tr>
<tr class="codeline" data-linenumber="712"><td class="num" id="LN712">712</td><td class="line">      <span class='directive'>tchunkptr C0, C1;\</span></td></tr>
<tr class="codeline" data-linenumber="713"><td class="num" id="LN713">713</td><td class="line">      <span class='directive'>R-&gt;parent = XP;\</span></td></tr>
<tr class="codeline" data-linenumber="714"><td class="num" id="LN714">714</td><td class="line">      <span class='directive'>if ((C0 = X-&gt;child[0]) != 0) {\</span></td></tr>
<tr class="codeline" data-linenumber="715"><td class="num" id="LN715">715</td><td class="line">	<span class='directive'>R-&gt;child[0] = C0;\</span></td></tr>
<tr class="codeline" data-linenumber="716"><td class="num" id="LN716">716</td><td class="line">	<span class='directive'>C0-&gt;parent = R;\</span></td></tr>
<tr class="codeline" data-linenumber="717"><td class="num" id="LN717">717</td><td class="line">      <span class='directive'>}\</span></td></tr>
<tr class="codeline" data-linenumber="718"><td class="num" id="LN718">718</td><td class="line">      <span class='directive'>if ((C1 = X-&gt;child[1]) != 0) {\</span></td></tr>
<tr class="codeline" data-linenumber="719"><td class="num" id="LN719">719</td><td class="line">	<span class='directive'>R-&gt;child[1] = C1;\</span></td></tr>
<tr class="codeline" data-linenumber="720"><td class="num" id="LN720">720</td><td class="line">	<span class='directive'>C1-&gt;parent = R;\</span></td></tr>
<tr class="codeline" data-linenumber="721"><td class="num" id="LN721">721</td><td class="line">      <span class='directive'>}\</span></td></tr>
<tr class="codeline" data-linenumber="722"><td class="num" id="LN722">722</td><td class="line">    <span class='directive'>}\</span></td></tr>
<tr class="codeline" data-linenumber="723"><td class="num" id="LN723">723</td><td class="line">  <span class='directive'>}\</span></td></tr>
<tr class="codeline" data-linenumber="724"><td class="num" id="LN724">724</td><td class="line"><span class='directive'>}</span></td></tr>
<tr class="codeline" data-linenumber="725"><td class="num" id="LN725">725</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="726"><td class="num" id="LN726">726</td><td class="line"><span class='comment'>/* Relays to large vs small bin operations */</span></td></tr>
<tr class="codeline" data-linenumber="727"><td class="num" id="LN727">727</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="728"><td class="num" id="LN728">728</td><td class="line"><span class='directive'>#define <span class='macro'>insert_chunk(M, P, S)<span class='macro_popup'>if ((((S) &gt;&gt; (3U)) &lt; (32U))) { { bindex_t I = ((S) &gt;&gt;<br> (3U)); mchunkptr B = ((sbinptr)((char *)&amp;((M)-&gt;smallbins<br>[(I)&lt;&lt;1]))); mchunkptr F = B; if (!((M)-&gt;smallmap &amp;<br> ((binmap_t)(1) &lt;&lt; (I)))) ((M)-&gt;smallmap |= ((binmap_t<br>)(1) &lt;&lt; (I))); else F = B-&gt;fd; B-&gt;fd = P; F-&gt;bk<br> = P; P-&gt;fd = F; P-&gt;bk = B;} } else { tchunkptr TP = (tchunkptr<br>)(P); { tbinptr *H; bindex_t I; { unsigned int X = (unsigned int<br>)(S &gt;&gt; (8U)); if (X == 0) { I = 0; } else if (X &gt; 0xFFFF<br>) { I = (32U)-1; } else { unsigned int K = ((uint32_t)(__builtin_clz<br>(X)^31)); I = (bindex_t)((K &lt;&lt; 1) + ((S &gt;&gt; (K + (<br>(8U)-1)) &amp; 1))); }}; H = (&amp;((M)-&gt;treebins[I])); TP<br>-&gt;index = I; TP-&gt;child[0] = TP-&gt;child[1] = 0; if (!(<br>(M)-&gt;treemap &amp; ((binmap_t)(1) &lt;&lt; (I)))) { ((M)-&gt;<br>treemap |= ((binmap_t)(1) &lt;&lt; (I))); *H = TP; TP-&gt;parent<br> = (tchunkptr)H; TP-&gt;fd = TP-&gt;bk = TP; } else { tchunkptr<br> T = *H; size_t K = S &lt;&lt; ((I == (32U)-1)? 0 : (((sizeof<br>(size_t) &lt;&lt; 3)-((size_t)1)) - (((I) &gt;&gt; 1) + (8U) -<br> 2))); for (;;) { if (((T)-&gt;head &amp; ~(((((size_t)1))|((<br>(size_t)2))))) != S) { tchunkptr *C = &amp;(T-&gt;child[(K &gt;&gt;<br> ((sizeof(size_t) &lt;&lt; 3)-((size_t)1))) &amp; 1]); K &lt;&lt;=<br> 1; if (*C != 0) { T = *C; } else { *C = TP; TP-&gt;parent = T<br>; TP-&gt;fd = TP-&gt;bk = TP; break; } } else { tchunkptr F =<br> T-&gt;fd; T-&gt;fd = F-&gt;bk = TP; TP-&gt;fd = F; TP-&gt;bk<br> = T; TP-&gt;parent = 0; break; } } }}; }</span></span>\</span></td></tr>
<tr class="codeline" data-linenumber="729"><td class="num" id="LN729">729</td><td class="line">  <span class='directive'>if (<span class='macro'>is_small(S)<span class='macro_popup'>(((S) &gt;&gt; (3U)) &lt; (32U))</span></span>) { <span class='macro'>insert_small_chunk(M, P, S)<span class='macro_popup'>{ bindex_t I = ((S) &gt;&gt; (3U)); mchunkptr B = ((sbinptr)(<br>(char *)&amp;((M)-&gt;smallbins[(I)&lt;&lt;1]))); mchunkptr F<br> = B; if (!((M)-&gt;smallmap &amp; ((binmap_t)(1) &lt;&lt; (I<br>)))) ((M)-&gt;smallmap |= ((binmap_t)(1) &lt;&lt; (I))); else<br> F = B-&gt;fd; B-&gt;fd = P; F-&gt;bk = P; P-&gt;fd = F; P-&gt;<br>bk = B;}</span></span>\</span></td></tr>
<tr class="codeline" data-linenumber="730"><td class="num" id="LN730">730</td><td class="line">  <span class='directive'>} else { tchunkptr TP = (tchunkptr)(P); <span class='macro'>insert_large_chunk(M, TP, S)<span class='macro_popup'>{ tbinptr *H; bindex_t I; { unsigned int X = (unsigned int)(S<br> &gt;&gt; (8U)); if (X == 0) { I = 0; } else if (X &gt; 0xFFFF<br>) { I = (32U)-1; } else { unsigned int K = ((uint32_t)(__builtin_clz<br>(X)^31)); I = (bindex_t)((K &lt;&lt; 1) + ((S &gt;&gt; (K + (<br>(8U)-1)) &amp; 1))); }}; H = (&amp;((M)-&gt;treebins[I])); TP<br>-&gt;index = I; TP-&gt;child[0] = TP-&gt;child[1] = 0; if (!(<br>(M)-&gt;treemap &amp; ((binmap_t)(1) &lt;&lt; (I)))) { ((M)-&gt;<br>treemap |= ((binmap_t)(1) &lt;&lt; (I))); *H = TP; TP-&gt;parent<br> = (tchunkptr)H; TP-&gt;fd = TP-&gt;bk = TP; } else { tchunkptr<br> T = *H; size_t K = S &lt;&lt; ((I == (32U)-1)? 0 : (((sizeof<br>(size_t) &lt;&lt; 3)-((size_t)1)) - (((I) &gt;&gt; 1) + (8U) -<br> 2))); for (;;) { if (((T)-&gt;head &amp; ~(((((size_t)1))|((<br>(size_t)2))))) != S) { tchunkptr *C = &amp;(T-&gt;child[(K &gt;&gt;<br> ((sizeof(size_t) &lt;&lt; 3)-((size_t)1))) &amp; 1]); K &lt;&lt;=<br> 1; if (*C != 0) { T = *C; } else { *C = TP; TP-&gt;parent = T<br>; TP-&gt;fd = TP-&gt;bk = TP; break; } } else { tchunkptr F =<br> T-&gt;fd; T-&gt;fd = F-&gt;bk = TP; TP-&gt;fd = F; TP-&gt;bk<br> = T; TP-&gt;parent = 0; break; } } }}</span></span>; }</span></td></tr>
<tr class="codeline" data-linenumber="731"><td class="num" id="LN731">731</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="732"><td class="num" id="LN732">732</td><td class="line"><span class='directive'>#define <span class='macro'>unlink_chunk(M, P, S)<span class='macro_popup'>if ((((S) &gt;&gt; (3U)) &lt; (32U))) { { mchunkptr F = P-&gt;<br>fd; mchunkptr B = P-&gt;bk; bindex_t I = ((S) &gt;&gt; (3U));<br> if (F == B) { ((M)-&gt;smallmap &amp;= ~((binmap_t)(1) &lt;&lt;<br> (I))); } else { F-&gt;bk = B; B-&gt;fd = F; }} } else { tchunkptr<br> TP = (tchunkptr)(P); { tchunkptr XP = TP-&gt;parent; tchunkptr<br> R; if (TP-&gt;bk != TP) { tchunkptr F = TP-&gt;fd; R = TP-&gt;<br>bk; F-&gt;bk = R; R-&gt;fd = F; } else { tchunkptr *RP; if ((<br>(R = *(RP = &amp;(TP-&gt;child[1]))) != 0) || ((R = *(RP = &amp;<br>(TP-&gt;child[0]))) != 0)) { tchunkptr *CP; while ((*(CP = &amp;<br>(R-&gt;child[1])) != 0) || (*(CP = &amp;(R-&gt;child[0])) != 0<br>)) { R = *(RP = CP); } *RP = 0; } } if (XP != 0) { tbinptr *H<br> = (&amp;((M)-&gt;treebins[TP-&gt;index])); if (TP == *H) { if<br> ((*H = R) == 0) ((M)-&gt;treemap &amp;= ~((binmap_t)(1) &lt;&lt;<br> (TP-&gt;index))); } else { if (XP-&gt;child[0] == TP) XP-&gt;<br>child[0] = R; else XP-&gt;child[1] = R; } if (R != 0) { tchunkptr<br> C0, C1; R-&gt;parent = XP; if ((C0 = TP-&gt;child[0]) != 0) {<br> R-&gt;child[0] = C0; C0-&gt;parent = R; } if ((C1 = TP-&gt;child<br>[1]) != 0) { R-&gt;child[1] = C1; C1-&gt;parent = R; } } }}; }</span></span>\</span></td></tr>
<tr class="codeline" data-linenumber="733"><td class="num" id="LN733">733</td><td class="line">  <span class='directive'>if (<span class='macro'>is_small(S)<span class='macro_popup'>(((S) &gt;&gt; (3U)) &lt; (32U))</span></span>) { <span class='macro'>unlink_small_chunk(M, P, S)<span class='macro_popup'>{ mchunkptr F = P-&gt;fd; mchunkptr B = P-&gt;bk; bindex_t I =<br> ((S) &gt;&gt; (3U)); if (F == B) { ((M)-&gt;smallmap &amp;= ~<br>((binmap_t)(1) &lt;&lt; (I))); } else { F-&gt;bk = B; B-&gt;fd<br> = F; }}</span></span>\</span></td></tr>
<tr class="codeline" data-linenumber="734"><td class="num" id="LN734">734</td><td class="line">  <span class='directive'>} else { tchunkptr TP = (tchunkptr)(P); <span class='macro'>unlink_large_chunk(M, TP)<span class='macro_popup'>{ tchunkptr XP = TP-&gt;parent; tchunkptr R; if (TP-&gt;bk !=<br> TP) { tchunkptr F = TP-&gt;fd; R = TP-&gt;bk; F-&gt;bk = R; R<br>-&gt;fd = F; } else { tchunkptr *RP; if (((R = *(RP = &amp;(TP<br>-&gt;child[1]))) != 0) || ((R = *(RP = &amp;(TP-&gt;child[0])<br>)) != 0)) { tchunkptr *CP; while ((*(CP = &amp;(R-&gt;child[1<br>])) != 0) || (*(CP = &amp;(R-&gt;child[0])) != 0)) { R = *(RP<br> = CP); } *RP = 0; } } if (XP != 0) { tbinptr *H = (&amp;((M)<br>-&gt;treebins[TP-&gt;index])); if (TP == *H) { if ((*H = R) ==<br> 0) ((M)-&gt;treemap &amp;= ~((binmap_t)(1) &lt;&lt; (TP-&gt;<br>index))); } else { if (XP-&gt;child[0] == TP) XP-&gt;child[0]<br> = R; else XP-&gt;child[1] = R; } if (R != 0) { tchunkptr C0,<br> C1; R-&gt;parent = XP; if ((C0 = TP-&gt;child[0]) != 0) { R-&gt;<br>child[0] = C0; C0-&gt;parent = R; } if ((C1 = TP-&gt;child[1]<br>) != 0) { R-&gt;child[1] = C1; C1-&gt;parent = R; } } }}</span></span>; }</span></td></tr>
<tr class="codeline" data-linenumber="735"><td class="num" id="LN735">735</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="736"><td class="num" id="LN736">736</td><td class="line"><span class='comment'>/* -----------------------  Direct-mmapping chunks ----------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="737"><td class="num" id="LN737">737</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="738"><td class="num" id="LN738">738</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> *direct_alloc(size_t nb)</td></tr>
<tr class="codeline" data-linenumber="739"><td class="num" id="LN739">739</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="740"><td class="num" id="LN740">740</td><td class="line">  size_t mmsize = <span class='macro'>mmap_align(nb + SIX_SIZE_T_SIZES + CHUNK_ALIGN_MASK)<span class='macro_popup'>(((nb + (((sizeof(size_t))&lt;&lt;2)+((sizeof(size_t))&lt;&lt;<br>1)) + (((size_t)8U) - ((size_t)1))) + (4096 - ((size_t)1))) &amp;<br> ~(4096 - ((size_t)1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="741"><td class="num" id="LN741">741</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>LJ_LIKELY(mmsize &gt; nb)<span class='macro_popup'>__builtin_expect(!!(mmsize &gt; nb), 1)</span></span>) {     <span class='comment'>/* Check for wrap around 0 */</span></td></tr>
<tr class="codeline" data-linenumber="742"><td class="num" id="LN742">742</td><td class="line">    <span class='keyword'>char</span> *mm = (<span class='keyword'>char</span> *)(<span class='macro'>DIRECT_MMAP(mmsize)<span class='macro_popup'>CALL_MMAP(mmsize)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="743"><td class="num" id="LN743">743</td><td class="line">    <span class='keyword'>if</span> (mm != <span class='macro'>CMFAIL<span class='macro_popup'>((char *)(((void *)((~(size_t)0)))))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="744"><td class="num" id="LN744">744</td><td class="line">      size_t offset = <span class='macro'>align_offset(chunk2mem(mm))<span class='macro_popup'>((((size_t)(((void *)((char *)(mm) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1))) == 0)? 0 : ((((size_t<br>)8U) - ((size_t)(((void *)((char *)(mm) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1)))) &amp; (((size_t)8U<br>) - ((size_t)1))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="745"><td class="num" id="LN745">745</td><td class="line">      size_t psize = mmsize - offset - <span class='macro'>DIRECT_FOOT_PAD<span class='macro_popup'>(((sizeof(size_t))&lt;&lt;2))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="746"><td class="num" id="LN746">746</td><td class="line">      mchunkptr p = (mchunkptr)(mm + offset);</td></tr>
<tr class="codeline" data-linenumber="747"><td class="num" id="LN747">747</td><td class="line">      p-&gt;prev_foot = offset | <span class='macro'>IS_DIRECT_BIT<span class='macro_popup'>(((size_t)1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="748"><td class="num" id="LN748">748</td><td class="line">      p-&gt;head = psize|<span class='macro'>CINUSE_BIT<span class='macro_popup'>(((size_t)2))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="749"><td class="num" id="LN749">749</td><td class="line">      <span class='macro'>chunk_plus_offset(p, psize)<span class='macro_popup'>((mchunkptr)(((char *)(p)) + (psize)))</span></span>-&gt;head = <span class='macro'>FENCEPOST_HEAD<span class='macro_popup'>(((((size_t)1))|(((size_t)2)))|(sizeof(size_t)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="750"><td class="num" id="LN750">750</td><td class="line">      <span class='macro'>chunk_plus_offset(p, psize+SIZE_T_SIZE)<span class='macro_popup'>((mchunkptr)(((char *)(p)) + (psize+(sizeof(size_t)))))</span></span>-&gt;head = 0;</td></tr>
<tr class="codeline" data-linenumber="751"><td class="num" id="LN751">751</td><td class="line">      <span class='keyword'>return</span> <span class='macro'>chunk2mem(p)<span class='macro_popup'>((void *)((char *)(p) + ((sizeof(size_t))&lt;&lt;1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="752"><td class="num" id="LN752">752</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="753"><td class="num" id="LN753">753</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="754"><td class="num" id="LN754">754</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="755"><td class="num" id="LN755">755</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="756"><td class="num" id="LN756">756</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="757"><td class="num" id="LN757">757</td><td class="line"><span class='keyword'>static</span> mchunkptr direct_resize(mchunkptr oldp, size_t nb)</td></tr>
<tr class="codeline" data-linenumber="758"><td class="num" id="LN758">758</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="759"><td class="num" id="LN759">759</td><td class="line">  size_t oldsize = <span class='macro'>chunksize(oldp)<span class='macro_popup'>((oldp)-&gt;head &amp; ~(((((size_t)1))|(((size_t)2)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="760"><td class="num" id="LN760">760</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>is_small(nb)<span class='macro_popup'>(((nb) &gt;&gt; (3U)) &lt; (32U))</span></span>) <span class='comment'>/* Can't shrink direct regions below small size */</span></td></tr>
<tr class="codeline" data-linenumber="761"><td class="num" id="LN761">761</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="762"><td class="num" id="LN762">762</td><td class="line">  <span class='comment'>/* Keep old chunk if big enough but not too big */</span></td></tr>
<tr class="codeline" data-linenumber="763"><td class="num" id="LN763">763</td><td class="line">  <span class='keyword'>if</span> (oldsize &gt;= nb + <span class='macro'>SIZE_T_SIZE<span class='macro_popup'>(sizeof(size_t))</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="764"><td class="num" id="LN764">764</td><td class="line">      (oldsize - nb) &lt;= (<span class='macro'>DEFAULT_GRANULARITY<span class='macro_popup'>((size_t)128U * (size_t)1024U)</span></span> &gt;&gt; 1)) {</td></tr>
<tr class="codeline" data-linenumber="765"><td class="num" id="LN765">765</td><td class="line">    <span class='keyword'>return</span> oldp;</td></tr>
<tr class="codeline" data-linenumber="766"><td class="num" id="LN766">766</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="767"><td class="num" id="LN767">767</td><td class="line">    size_t offset = oldp-&gt;prev_foot &amp; ~<span class='macro'>IS_DIRECT_BIT<span class='macro_popup'>(((size_t)1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="768"><td class="num" id="LN768">768</td><td class="line">    size_t oldmmsize = oldsize + offset + <span class='macro'>DIRECT_FOOT_PAD<span class='macro_popup'>(((sizeof(size_t))&lt;&lt;2))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="769"><td class="num" id="LN769">769</td><td class="line">    size_t newmmsize = <span class='macro'>mmap_align(nb + SIX_SIZE_T_SIZES + CHUNK_ALIGN_MASK)<span class='macro_popup'>(((nb + (((sizeof(size_t))&lt;&lt;2)+((sizeof(size_t))&lt;&lt;<br>1)) + (((size_t)8U) - ((size_t)1))) + (4096 - ((size_t)1))) &amp;<br> ~(4096 - ((size_t)1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="770"><td class="num" id="LN770">770</td><td class="line">    <span class='keyword'>char</span> *cp = (<span class='keyword'>char</span> *)<span class='macro'>CALL_MREMAP((<span class='keyword'>char</span> *)oldp - offset,<span class='macro_popup'>CALL_MREMAP_(((char *)oldp - offset), (oldmmsize), (newmmsize<br>), (0))</span></span></td></tr>
<tr class="codeline" data-linenumber="771"><td class="num" id="LN771">771</td><td class="line">				   <span class='macro'>oldmmsize, newmmsize, CALL_MREMAP_MV)<span class='macro_popup'>CALL_MREMAP_(((char *)oldp - offset), (oldmmsize), (newmmsize<br>), (0))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="772"><td class="num" id="LN772">772</td><td class="line">    <span class='keyword'>if</span> (cp != <span class='macro'>CMFAIL<span class='macro_popup'>((char *)(((void *)((~(size_t)0)))))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="773"><td class="num" id="LN773">773</td><td class="line">      mchunkptr newp = (mchunkptr)(cp + offset);</td></tr>
<tr class="codeline" data-linenumber="774"><td class="num" id="LN774">774</td><td class="line">      size_t psize = newmmsize - offset - <span class='macro'>DIRECT_FOOT_PAD<span class='macro_popup'>(((sizeof(size_t))&lt;&lt;2))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="775"><td class="num" id="LN775">775</td><td class="line">      newp-&gt;head = psize|<span class='macro'>CINUSE_BIT<span class='macro_popup'>(((size_t)2))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="776"><td class="num" id="LN776">776</td><td class="line">      <span class='macro'>chunk_plus_offset(newp, psize)<span class='macro_popup'>((mchunkptr)(((char *)(newp)) + (psize)))</span></span>-&gt;head = <span class='macro'>FENCEPOST_HEAD<span class='macro_popup'>(((((size_t)1))|(((size_t)2)))|(sizeof(size_t)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="777"><td class="num" id="LN777">777</td><td class="line">      <span class='macro'>chunk_plus_offset(newp, psize+SIZE_T_SIZE)<span class='macro_popup'>((mchunkptr)(((char *)(newp)) + (psize+(sizeof(size_t)))))</span></span>-&gt;head = 0;</td></tr>
<tr class="codeline" data-linenumber="778"><td class="num" id="LN778">778</td><td class="line">      <span class='keyword'>return</span> newp;</td></tr>
<tr class="codeline" data-linenumber="779"><td class="num" id="LN779">779</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="780"><td class="num" id="LN780">780</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="781"><td class="num" id="LN781">781</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="782"><td class="num" id="LN782">782</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="783"><td class="num" id="LN783">783</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="784"><td class="num" id="LN784">784</td><td class="line"><span class='comment'>/* -------------------------- mspace management -------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="785"><td class="num" id="LN785">785</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="786"><td class="num" id="LN786">786</td><td class="line"><span class='comment'>/* Initialize top chunk and its size */</span></td></tr>
<tr class="codeline" data-linenumber="787"><td class="num" id="LN787">787</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> init_top(mstate m, mchunkptr p, size_t psize)</td></tr>
<tr class="codeline" data-linenumber="788"><td class="num" id="LN788">788</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="789"><td class="num" id="LN789">789</td><td class="line">  <span class='comment'>/* Ensure alignment */</span></td></tr>
<tr class="codeline" data-linenumber="790"><td class="num" id="LN790">790</td><td class="line">  size_t offset = <span class='macro'>align_offset(chunk2mem(p))<span class='macro_popup'>((((size_t)(((void *)((char *)(p) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1))) == 0)? 0 : ((((size_t<br>)8U) - ((size_t)(((void *)((char *)(p) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1)))) &amp; (((size_t)8U<br>) - ((size_t)1))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="791"><td class="num" id="LN791">791</td><td class="line">  p = (mchunkptr)((<span class='keyword'>char</span> *)p + offset);</td></tr>
<tr class="codeline" data-linenumber="792"><td class="num" id="LN792">792</td><td class="line">  psize -= offset;</td></tr>
<tr class="codeline" data-linenumber="793"><td class="num" id="LN793">793</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="794"><td class="num" id="LN794">794</td><td class="line">  m-&gt;top = p;</td></tr>
<tr class="codeline" data-linenumber="795"><td class="num" id="LN795">795</td><td class="line">  m-&gt;topsize = psize;</td></tr>
<tr class="codeline" data-linenumber="796"><td class="num" id="LN796">796</td><td class="line">  p-&gt;head = psize | <span class='macro'>PINUSE_BIT<span class='macro_popup'>(((size_t)1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="797"><td class="num" id="LN797">797</td><td class="line">  <span class='comment'>/* set size of fake trailing chunk holding overhead space only once */</span></td></tr>
<tr class="codeline" data-linenumber="798"><td class="num" id="LN798">798</td><td class="line">  <span class='macro'>chunk_plus_offset(p, psize)<span class='macro_popup'>((mchunkptr)(((char *)(p)) + (psize)))</span></span>-&gt;head = <span class='macro'>TOP_FOOT_SIZE<span class='macro_popup'>(((((size_t)(((void *)((char *)(0) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1))) == 0)? 0 : ((((size_t<br>)8U) - ((size_t)(((void *)((char *)(0) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1)))) &amp; (((size_t)8U<br>) - ((size_t)1))))+(((sizeof(struct malloc_segment)) + ((sizeof<br>(size_t))) + (((size_t)8U) - ((size_t)1))) &amp; ~(((size_t)8U<br>) - ((size_t)1)))+(((sizeof(mchunk)) + (((size_t)8U) - ((size_t<br>)1))) &amp; ~(((size_t)8U) - ((size_t)1))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="799"><td class="num" id="LN799">799</td><td class="line">  m-&gt;trim_check = <span class='macro'>DEFAULT_TRIM_THRESHOLD<span class='macro_popup'>((size_t)2U * (size_t)1024U * (size_t)1024U)</span></span>; <span class='comment'>/* reset on each update */</span></td></tr>
<tr class="codeline" data-linenumber="800"><td class="num" id="LN800">800</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="801"><td class="num" id="LN801">801</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="802"><td class="num" id="LN802">802</td><td class="line"><span class='comment'>/* Initialize bins for a new mstate that is otherwise zeroed out */</span></td></tr>
<tr class="codeline" data-linenumber="803"><td class="num" id="LN803">803</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> init_bins(mstate m)</td></tr>
<tr class="codeline" data-linenumber="804"><td class="num" id="LN804">804</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="805"><td class="num" id="LN805">805</td><td class="line">  <span class='comment'>/* Establish circular links for smallbins */</span></td></tr>
<tr class="codeline" data-linenumber="806"><td class="num" id="LN806">806</td><td class="line">  bindex_t i;</td></tr>
<tr class="codeline" data-linenumber="807"><td class="num" id="LN807">807</td><td class="line">  <span class='keyword'>for</span> (i = 0; i &lt; <span class='macro'>NSMALLBINS<span class='macro_popup'>(32U)</span></span>; i++) {</td></tr>
<tr class="codeline" data-linenumber="808"><td class="num" id="LN808">808</td><td class="line">    sbinptr bin = <span class='macro'>smallbin_at(m,i)<span class='macro_popup'>((sbinptr)((char *)&amp;((m)-&gt;smallbins[(i)&lt;&lt;1])))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="809"><td class="num" id="LN809">809</td><td class="line">    bin-&gt;fd = bin-&gt;bk = bin;</td></tr>
<tr class="codeline" data-linenumber="810"><td class="num" id="LN810">810</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="811"><td class="num" id="LN811">811</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="812"><td class="num" id="LN812">812</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="813"><td class="num" id="LN813">813</td><td class="line"><span class='comment'>/* Allocate chunk and prepend remainder with chunk in successor base. */</span></td></tr>
<tr class="codeline" data-linenumber="814"><td class="num" id="LN814">814</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> *prepend_alloc(mstate m, <span class='keyword'>char</span> *newbase, <span class='keyword'>char</span> *oldbase, size_t nb)</td></tr>
<tr class="codeline" data-linenumber="815"><td class="num" id="LN815">815</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="816"><td class="num" id="LN816">816</td><td class="line">  mchunkptr p = <span class='macro'>align_as_chunk(newbase)<span class='macro_popup'>(mchunkptr)((newbase) + ((((size_t)(((void *)((char *)(newbase<br>) + ((sizeof(size_t))&lt;&lt;1)))) &amp; (((size_t)8U) - ((size_t<br>)1))) == 0)? 0 : ((((size_t)8U) - ((size_t)(((void *)((char *<br>)(newbase) + ((sizeof(size_t))&lt;&lt;1)))) &amp; (((size_t)8U<br>) - ((size_t)1)))) &amp; (((size_t)8U) - ((size_t)1)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="817"><td class="num" id="LN817">817</td><td class="line">  mchunkptr oldfirst = <span class='macro'>align_as_chunk(oldbase)<span class='macro_popup'>(mchunkptr)((oldbase) + ((((size_t)(((void *)((char *)(oldbase<br>) + ((sizeof(size_t))&lt;&lt;1)))) &amp; (((size_t)8U) - ((size_t<br>)1))) == 0)? 0 : ((((size_t)8U) - ((size_t)(((void *)((char *<br>)(oldbase) + ((sizeof(size_t))&lt;&lt;1)))) &amp; (((size_t)8U<br>) - ((size_t)1)))) &amp; (((size_t)8U) - ((size_t)1)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="818"><td class="num" id="LN818">818</td><td class="line">  size_t psize = (size_t)((<span class='keyword'>char</span> *)oldfirst - (<span class='keyword'>char</span> *)p);</td></tr>
<tr class="codeline" data-linenumber="819"><td class="num" id="LN819">819</td><td class="line">  mchunkptr q = <span class='macro'>chunk_plus_offset(p, nb)<span class='macro_popup'>((mchunkptr)(((char *)(p)) + (nb)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="820"><td class="num" id="LN820">820</td><td class="line">  size_t qsize = psize - nb;</td></tr>
<tr class="codeline" data-linenumber="821"><td class="num" id="LN821">821</td><td class="line">  <span class='macro'>set_size_and_pinuse_of_inuse_chunk(m, p, nb)<span class='macro_popup'>((p)-&gt;head = (nb|(((size_t)1))|(((size_t)2))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="822"><td class="num" id="LN822">822</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="823"><td class="num" id="LN823">823</td><td class="line">  <span class='comment'>/* consolidate remainder with first chunk of old base */</span></td></tr>
<tr class="codeline" data-linenumber="824"><td class="num" id="LN824">824</td><td class="line">  <span class='keyword'>if</span> (oldfirst == m-&gt;top) {</td></tr>
<tr class="codeline" data-linenumber="825"><td class="num" id="LN825">825</td><td class="line">    size_t tsize = m-&gt;topsize += qsize;</td></tr>
<tr class="codeline" data-linenumber="826"><td class="num" id="LN826">826</td><td class="line">    m-&gt;top = q;</td></tr>
<tr class="codeline" data-linenumber="827"><td class="num" id="LN827">827</td><td class="line">    q-&gt;head = tsize | <span class='macro'>PINUSE_BIT<span class='macro_popup'>(((size_t)1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="828"><td class="num" id="LN828">828</td><td class="line">  } <span class='keyword'>else</span> <span class='keyword'>if</span> (oldfirst == m-&gt;dv) {</td></tr>
<tr class="codeline" data-linenumber="829"><td class="num" id="LN829">829</td><td class="line">    size_t dsize = m-&gt;dvsize += qsize;</td></tr>
<tr class="codeline" data-linenumber="830"><td class="num" id="LN830">830</td><td class="line">    m-&gt;dv = q;</td></tr>
<tr class="codeline" data-linenumber="831"><td class="num" id="LN831">831</td><td class="line">    <span class='macro'>set_size_and_pinuse_of_free_chunk(q, dsize)<span class='macro_popup'>((q)-&gt;head = (dsize|(((size_t)1))), (((mchunkptr)((char *)<br>(q) + (dsize)))-&gt;prev_foot = (dsize)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="832"><td class="num" id="LN832">832</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="833"><td class="num" id="LN833">833</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>cinuse(oldfirst)<span class='macro_popup'>((oldfirst)-&gt;head &amp; (((size_t)2)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="834"><td class="num" id="LN834">834</td><td class="line">      size_t nsize = <span class='macro'>chunksize(oldfirst)<span class='macro_popup'>((oldfirst)-&gt;head &amp; ~(((((size_t)1))|(((size_t)2)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="835"><td class="num" id="LN835">835</td><td class="line">      <span class='macro'>unlink_chunk(m, oldfirst, nsize)<span class='macro_popup'>if ((((nsize) &gt;&gt; (3U)) &lt; (32U))) { { mchunkptr F = oldfirst<br>-&gt;fd; mchunkptr B = oldfirst-&gt;bk; bindex_t I = ((nsize)<br> &gt;&gt; (3U)); if (F == B) { ((m)-&gt;smallmap &amp;= ~((binmap_t<br>)(1) &lt;&lt; (I))); } else { F-&gt;bk = B; B-&gt;fd = F; }} }<br> else { tchunkptr TP = (tchunkptr)(oldfirst); { tchunkptr XP =<br> TP-&gt;parent; tchunkptr R; if (TP-&gt;bk != TP) { tchunkptr<br> F = TP-&gt;fd; R = TP-&gt;bk; F-&gt;bk = R; R-&gt;fd = F; } else<br> { tchunkptr *RP; if (((R = *(RP = &amp;(TP-&gt;child[1]))) !=<br> 0) || ((R = *(RP = &amp;(TP-&gt;child[0]))) != 0)) { tchunkptr<br> *CP; while ((*(CP = &amp;(R-&gt;child[1])) != 0) || (*(CP = &amp;<br>(R-&gt;child[0])) != 0)) { R = *(RP = CP); } *RP = 0; } } if (<br>XP != 0) { tbinptr *H = (&amp;((m)-&gt;treebins[TP-&gt;index]<br>)); if (TP == *H) { if ((*H = R) == 0) ((m)-&gt;treemap &amp;=<br> ~((binmap_t)(1) &lt;&lt; (TP-&gt;index))); } else { if (XP-&gt;<br>child[0] == TP) XP-&gt;child[0] = R; else XP-&gt;child[1] = R<br>; } if (R != 0) { tchunkptr C0, C1; R-&gt;parent = XP; if ((C0<br> = TP-&gt;child[0]) != 0) { R-&gt;child[0] = C0; C0-&gt;parent<br> = R; } if ((C1 = TP-&gt;child[1]) != 0) { R-&gt;child[1] = C1<br>; C1-&gt;parent = R; } } }}; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="836"><td class="num" id="LN836">836</td><td class="line">      oldfirst = <span class='macro'>chunk_plus_offset(oldfirst, nsize)<span class='macro_popup'>((mchunkptr)(((char *)(oldfirst)) + (nsize)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="837"><td class="num" id="LN837">837</td><td class="line">      qsize += nsize;</td></tr>
<tr class="codeline" data-linenumber="838"><td class="num" id="LN838">838</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="839"><td class="num" id="LN839">839</td><td class="line">    <span class='macro'>set_free_with_pinuse(q, qsize, oldfirst)<span class='macro_popup'>(((oldfirst)-&gt;head &amp;= ~(((size_t)1))), ((q)-&gt;head =<br> (qsize|(((size_t)1))), (((mchunkptr)((char *)(q) + (qsize)))<br>-&gt;prev_foot = (qsize))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="840"><td class="num" id="LN840">840</td><td class="line">    <span class='macro'>insert_chunk(m, q, qsize)<span class='macro_popup'>if ((((qsize) &gt;&gt; (3U)) &lt; (32U))) { { bindex_t I = ((<br>qsize) &gt;&gt; (3U)); mchunkptr B = ((sbinptr)((char *)&amp;<br>((m)-&gt;smallbins[(I)&lt;&lt;1]))); mchunkptr F = B; if (!((<br>m)-&gt;smallmap &amp; ((binmap_t)(1) &lt;&lt; (I)))) ((m)-&gt;<br>smallmap |= ((binmap_t)(1) &lt;&lt; (I))); else F = B-&gt;fd;<br> B-&gt;fd = q; F-&gt;bk = q; q-&gt;fd = F; q-&gt;bk = B;} } else<br> { tchunkptr TP = (tchunkptr)(q); { tbinptr *H; bindex_t I; {<br> unsigned int X = (unsigned int)(qsize &gt;&gt; (8U)); if (X ==<br> 0) { I = 0; } else if (X &gt; 0xFFFF) { I = (32U)-1; } else {<br> unsigned int K = ((uint32_t)(__builtin_clz(X)^31)); I = (bindex_t<br>)((K &lt;&lt; 1) + ((qsize &gt;&gt; (K + ((8U)-1)) &amp; 1)))<br>; }}; H = (&amp;((m)-&gt;treebins[I])); TP-&gt;index = I; TP-&gt;<br>child[0] = TP-&gt;child[1] = 0; if (!((m)-&gt;treemap &amp; (<br>(binmap_t)(1) &lt;&lt; (I)))) { ((m)-&gt;treemap |= ((binmap_t<br>)(1) &lt;&lt; (I))); *H = TP; TP-&gt;parent = (tchunkptr)H; TP<br>-&gt;fd = TP-&gt;bk = TP; } else { tchunkptr T = *H; size_t K<br> = qsize &lt;&lt; ((I == (32U)-1)? 0 : (((sizeof(size_t) &lt;&lt;<br> 3)-((size_t)1)) - (((I) &gt;&gt; 1) + (8U) - 2))); for (;;) {<br> if (((T)-&gt;head &amp; ~(((((size_t)1))|(((size_t)2))))) !=<br> qsize) { tchunkptr *C = &amp;(T-&gt;child[(K &gt;&gt; ((sizeof<br>(size_t) &lt;&lt; 3)-((size_t)1))) &amp; 1]); K &lt;&lt;= 1; if<br> (*C != 0) { T = *C; } else { *C = TP; TP-&gt;parent = T; TP-&gt;<br>fd = TP-&gt;bk = TP; break; } } else { tchunkptr F = T-&gt;fd<br>; T-&gt;fd = F-&gt;bk = TP; TP-&gt;fd = F; TP-&gt;bk = T; TP-&gt;<br>parent = 0; break; } } }}; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="841"><td class="num" id="LN841">841</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="842"><td class="num" id="LN842">842</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="843"><td class="num" id="LN843">843</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>chunk2mem(p)<span class='macro_popup'>((void *)((char *)(p) + ((sizeof(size_t))&lt;&lt;1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="844"><td class="num" id="LN844">844</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="845"><td class="num" id="LN845">845</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="846"><td class="num" id="LN846">846</td><td class="line"><span class='comment'>/* Add a segment to hold a new noncontiguous region */</span></td></tr>
<tr class="codeline" data-linenumber="847"><td class="num" id="LN847">847</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> add_segment(mstate m, <span class='keyword'>char</span> *tbase, size_t tsize)</td></tr>
<tr class="codeline" data-linenumber="848"><td class="num" id="LN848">848</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="849"><td class="num" id="LN849">849</td><td class="line">  <span class='comment'>/* Determine locations and sizes of segment, fenceposts, old top */</span></td></tr>
<tr class="codeline" data-linenumber="850"><td class="num" id="LN850">850</td><td class="line">  <span class='keyword'>char</span> *old_top = (<span class='keyword'>char</span> *)m-&gt;top;</td></tr>
<tr class="codeline" data-linenumber="851"><td class="num" id="LN851">851</td><td class="line">  msegmentptr oldsp = segment_holding(m, old_top);</td></tr>
<tr class="codeline" data-linenumber="852"><td class="num" id="LN852">852</td><td class="line">  <span class='keyword'>char</span> *old_end = oldsp-&gt;base + oldsp-&gt;size;</td></tr>
<tr class="codeline" data-linenumber="853"><td class="num" id="LN853">853</td><td class="line">  size_t ssize = <span class='macro'>pad_request(<span class='keyword'>sizeof</span>(<span class='keyword'>struct</span> malloc_segment))<span class='macro_popup'>(((sizeof(struct malloc_segment)) + ((sizeof(size_t))) + (((size_t<br>)8U) - ((size_t)1))) &amp; ~(((size_t)8U) - ((size_t)1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="854"><td class="num" id="LN854">854</td><td class="line">  <span class='keyword'>char</span> *rawsp = old_end - (ssize + <span class='macro'>FOUR_SIZE_T_SIZES<span class='macro_popup'>((sizeof(size_t))&lt;&lt;2)</span></span> + <span class='macro'>CHUNK_ALIGN_MASK<span class='macro_popup'>(((size_t)8U) - ((size_t)1))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="855"><td class="num" id="LN855">855</td><td class="line">  size_t offset = <span class='macro'>align_offset(chunk2mem(rawsp))<span class='macro_popup'>((((size_t)(((void *)((char *)(rawsp) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1))) == 0)? 0 : ((((size_t<br>)8U) - ((size_t)(((void *)((char *)(rawsp) + ((sizeof(size_t)<br>)&lt;&lt;1)))) &amp; (((size_t)8U) - ((size_t)1)))) &amp; (((<br>size_t)8U) - ((size_t)1))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="856"><td class="num" id="LN856">856</td><td class="line">  <span class='keyword'>char</span> *asp = rawsp + offset;</td></tr>
<tr class="codeline" data-linenumber="857"><td class="num" id="LN857">857</td><td class="line">  <span class='keyword'>char</span> *csp = (asp &lt; (old_top + <span class='macro'>MIN_CHUNK_SIZE<span class='macro_popup'>(((sizeof(mchunk)) + (((size_t)8U) - ((size_t)1))) &amp; ~(((<br>size_t)8U) - ((size_t)1)))</span></span>))? old_top : asp;</td></tr>
<tr class="codeline" data-linenumber="858"><td class="num" id="LN858">858</td><td class="line">  mchunkptr sp = (mchunkptr)csp;</td></tr>
<tr class="codeline" data-linenumber="859"><td class="num" id="LN859">859</td><td class="line">  msegmentptr ss = (msegmentptr)(<span class='macro'>chunk2mem(sp)<span class='macro_popup'>((void *)((char *)(sp) + ((sizeof(size_t))&lt;&lt;1)))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="860"><td class="num" id="LN860">860</td><td class="line">  mchunkptr tnext = <span class='macro'>chunk_plus_offset(sp, ssize)<span class='macro_popup'>((mchunkptr)(((char *)(sp)) + (ssize)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="861"><td class="num" id="LN861">861</td><td class="line">  mchunkptr p = tnext;</td></tr>
<tr class="codeline" data-linenumber="862"><td class="num" id="LN862">862</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="863"><td class="num" id="LN863">863</td><td class="line">  <span class='comment'>/* reset top to new space */</span></td></tr>
<tr class="codeline" data-linenumber="864"><td class="num" id="LN864">864</td><td class="line">  init_top(m, (mchunkptr)tbase, tsize - <span class='macro'>TOP_FOOT_SIZE<span class='macro_popup'>(((((size_t)(((void *)((char *)(0) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1))) == 0)? 0 : ((((size_t<br>)8U) - ((size_t)(((void *)((char *)(0) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1)))) &amp; (((size_t)8U<br>) - ((size_t)1))))+(((sizeof(struct malloc_segment)) + ((sizeof<br>(size_t))) + (((size_t)8U) - ((size_t)1))) &amp; ~(((size_t)8U<br>) - ((size_t)1)))+(((sizeof(mchunk)) + (((size_t)8U) - ((size_t<br>)1))) &amp; ~(((size_t)8U) - ((size_t)1))))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="865"><td class="num" id="LN865">865</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="866"><td class="num" id="LN866">866</td><td class="line">  <span class='comment'>/* Set up segment record */</span></td></tr>
<tr class="codeline" data-linenumber="867"><td class="num" id="LN867">867</td><td class="line">  <span class='macro'>set_size_and_pinuse_of_inuse_chunk(m, sp, ssize)<span class='macro_popup'>((sp)-&gt;head = (ssize|(((size_t)1))|(((size_t)2))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="868"><td class="num" id="LN868">868</td><td class="line">  *ss = m-&gt;seg; <span class='comment'>/* Push current record */</span></td></tr>
<tr class="codeline" data-linenumber="869"><td class="num" id="LN869">869</td><td class="line">  m-&gt;seg.base = tbase;</td></tr>
<tr class="codeline" data-linenumber="870"><td class="num" id="LN870">870</td><td class="line">  m-&gt;seg.size = tsize;</td></tr>
<tr class="codeline" data-linenumber="871"><td class="num" id="LN871">871</td><td class="line">  m-&gt;seg.next = ss;</td></tr>
<tr class="codeline" data-linenumber="872"><td class="num" id="LN872">872</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="873"><td class="num" id="LN873">873</td><td class="line">  <span class='comment'>/* Insert trailing fenceposts */</span></td></tr>
<tr class="codeline" data-linenumber="874"><td class="num" id="LN874">874</td><td class="line">  <span class='keyword'>for</span> (;;) {</td></tr>
<tr class="codeline" data-linenumber="875"><td class="num" id="LN875">875</td><td class="line">    mchunkptr nextp = <span class='macro'>chunk_plus_offset(p, SIZE_T_SIZE)<span class='macro_popup'>((mchunkptr)(((char *)(p)) + ((sizeof(size_t)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="876"><td class="num" id="LN876">876</td><td class="line">    p-&gt;head = <span class='macro'>FENCEPOST_HEAD<span class='macro_popup'>(((((size_t)1))|(((size_t)2)))|(sizeof(size_t)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="877"><td class="num" id="LN877">877</td><td class="line">    <span class='keyword'>if</span> ((<span class='keyword'>char</span> *)(&amp;(nextp-&gt;head)) &lt; old_end)</td></tr>
<tr class="codeline" data-linenumber="878"><td class="num" id="LN878">878</td><td class="line">      p = nextp;</td></tr>
<tr class="codeline" data-linenumber="879"><td class="num" id="LN879">879</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="880"><td class="num" id="LN880">880</td><td class="line">      <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="881"><td class="num" id="LN881">881</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="882"><td class="num" id="LN882">882</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="883"><td class="num" id="LN883">883</td><td class="line">  <span class='comment'>/* Insert the rest of old top into a bin as an ordinary free chunk */</span></td></tr>
<tr class="codeline" data-linenumber="884"><td class="num" id="LN884">884</td><td class="line">  <span class='keyword'>if</span> (csp != old_top) {</td></tr>
<tr class="codeline" data-linenumber="885"><td class="num" id="LN885">885</td><td class="line">    mchunkptr q = (mchunkptr)old_top;</td></tr>
<tr class="codeline" data-linenumber="886"><td class="num" id="LN886">886</td><td class="line">    size_t psize = (size_t)(csp - old_top);</td></tr>
<tr class="codeline" data-linenumber="887"><td class="num" id="LN887">887</td><td class="line">    mchunkptr tn = <span class='macro'>chunk_plus_offset(q, psize)<span class='macro_popup'>((mchunkptr)(((char *)(q)) + (psize)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="888"><td class="num" id="LN888">888</td><td class="line">    <span class='macro'>set_free_with_pinuse(q, psize, tn)<span class='macro_popup'>(((tn)-&gt;head &amp;= ~(((size_t)1))), ((q)-&gt;head = (psize<br>|(((size_t)1))), (((mchunkptr)((char *)(q) + (psize)))-&gt;prev_foot<br> = (psize))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="889"><td class="num" id="LN889">889</td><td class="line">    <span class='macro'>insert_chunk(m, q, psize)<span class='macro_popup'>if ((((psize) &gt;&gt; (3U)) &lt; (32U))) { { bindex_t I = ((<br>psize) &gt;&gt; (3U)); mchunkptr B = ((sbinptr)((char *)&amp;<br>((m)-&gt;smallbins[(I)&lt;&lt;1]))); mchunkptr F = B; if (!((<br>m)-&gt;smallmap &amp; ((binmap_t)(1) &lt;&lt; (I)))) ((m)-&gt;<br>smallmap |= ((binmap_t)(1) &lt;&lt; (I))); else F = B-&gt;fd;<br> B-&gt;fd = q; F-&gt;bk = q; q-&gt;fd = F; q-&gt;bk = B;} } else<br> { tchunkptr TP = (tchunkptr)(q); { tbinptr *H; bindex_t I; {<br> unsigned int X = (unsigned int)(psize &gt;&gt; (8U)); if (X ==<br> 0) { I = 0; } else if (X &gt; 0xFFFF) { I = (32U)-1; } else {<br> unsigned int K = ((uint32_t)(__builtin_clz(X)^31)); I = (bindex_t<br>)((K &lt;&lt; 1) + ((psize &gt;&gt; (K + ((8U)-1)) &amp; 1)))<br>; }}; H = (&amp;((m)-&gt;treebins[I])); TP-&gt;index = I; TP-&gt;<br>child[0] = TP-&gt;child[1] = 0; if (!((m)-&gt;treemap &amp; (<br>(binmap_t)(1) &lt;&lt; (I)))) { ((m)-&gt;treemap |= ((binmap_t<br>)(1) &lt;&lt; (I))); *H = TP; TP-&gt;parent = (tchunkptr)H; TP<br>-&gt;fd = TP-&gt;bk = TP; } else { tchunkptr T = *H; size_t K<br> = psize &lt;&lt; ((I == (32U)-1)? 0 : (((sizeof(size_t) &lt;&lt;<br> 3)-((size_t)1)) - (((I) &gt;&gt; 1) + (8U) - 2))); for (;;) {<br> if (((T)-&gt;head &amp; ~(((((size_t)1))|(((size_t)2))))) !=<br> psize) { tchunkptr *C = &amp;(T-&gt;child[(K &gt;&gt; ((sizeof<br>(size_t) &lt;&lt; 3)-((size_t)1))) &amp; 1]); K &lt;&lt;= 1; if<br> (*C != 0) { T = *C; } else { *C = TP; TP-&gt;parent = T; TP-&gt;<br>fd = TP-&gt;bk = TP; break; } } else { tchunkptr F = T-&gt;fd<br>; T-&gt;fd = F-&gt;bk = TP; TP-&gt;fd = F; TP-&gt;bk = T; TP-&gt;<br>parent = 0; break; } } }}; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="890"><td class="num" id="LN890">890</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="891"><td class="num" id="LN891">891</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="892"><td class="num" id="LN892">892</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="893"><td class="num" id="LN893">893</td><td class="line"><span class='comment'>/* -------------------------- System allocation -------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="894"><td class="num" id="LN894">894</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="895"><td class="num" id="LN895">895</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> *alloc_sys(mstate m, size_t nb)</td></tr>
<tr class="codeline" data-linenumber="896"><td class="num" id="LN896">896</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="897"><td class="num" id="LN897">897</td><td class="line">  <span class='keyword'>char</span> *tbase = <span class='macro'>CMFAIL<span class='macro_popup'>((char *)(((void *)((~(size_t)0)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="898"><td class="num" id="LN898">898</td><td class="line">  size_t tsize = 0;</td></tr>
<tr class="codeline" data-linenumber="899"><td class="num" id="LN899">899</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="900"><td class="num" id="LN900">900</td><td class="line">  <span class='comment'>/* Directly map large chunks */</span></td></tr>
<tr class="codeline" data-linenumber="901"><td class="num" id="LN901">901</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>LJ_UNLIKELY(nb &gt;= DEFAULT_MMAP_THRESHOLD)<span class='macro_popup'>__builtin_expect(!!(nb &gt;= ((size_t)128U * (size_t)1024U)),<br> 0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="902"><td class="num" id="LN902">902</td><td class="line">    <span class='keyword'>void</span> *mem = direct_alloc(nb);</td></tr>
<tr class="codeline" data-linenumber="903"><td class="num" id="LN903">903</td><td class="line">    <span class='keyword'>if</span> (mem != 0)</td></tr>
<tr class="codeline" data-linenumber="904"><td class="num" id="LN904">904</td><td class="line">      <span class='keyword'>return</span> mem;</td></tr>
<tr class="codeline" data-linenumber="905"><td class="num" id="LN905">905</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="906"><td class="num" id="LN906">906</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="907"><td class="num" id="LN907">907</td><td class="line">  {</td></tr>
<tr class="codeline" data-linenumber="908"><td class="num" id="LN908">908</td><td class="line">    size_t req = nb + <span class='macro'>TOP_FOOT_SIZE<span class='macro_popup'>(((((size_t)(((void *)((char *)(0) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1))) == 0)? 0 : ((((size_t<br>)8U) - ((size_t)(((void *)((char *)(0) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1)))) &amp; (((size_t)8U<br>) - ((size_t)1))))+(((sizeof(struct malloc_segment)) + ((sizeof<br>(size_t))) + (((size_t)8U) - ((size_t)1))) &amp; ~(((size_t)8U<br>) - ((size_t)1)))+(((sizeof(mchunk)) + (((size_t)8U) - ((size_t<br>)1))) &amp; ~(((size_t)8U) - ((size_t)1))))</span></span> + <span class='macro'>SIZE_T_ONE<span class='macro_popup'>((size_t)1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="909"><td class="num" id="LN909">909</td><td class="line">    size_t rsize = <span class='macro'>granularity_align(req)<span class='macro_popup'>(((req) + (((size_t)128U * (size_t)1024U) - ((size_t)1))) &amp;<br> ~(((size_t)128U * (size_t)1024U) - ((size_t)1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="910"><td class="num" id="LN910">910</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>LJ_LIKELY(rsize &gt; nb)<span class='macro_popup'>__builtin_expect(!!(rsize &gt; nb), 1)</span></span>) { <span class='comment'>/* Fail if wraps around zero */</span></td></tr>
<tr class="codeline" data-linenumber="911"><td class="num" id="LN911">911</td><td class="line">      <span class='keyword'>char</span> *mp = (<span class='keyword'>char</span> *)(CALL_MMAP(rsize));</td></tr>
<tr class="codeline" data-linenumber="912"><td class="num" id="LN912">912</td><td class="line">      <span class='keyword'>if</span> (mp != <span class='macro'>CMFAIL<span class='macro_popup'>((char *)(((void *)((~(size_t)0)))))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="913"><td class="num" id="LN913">913</td><td class="line">	tbase = mp;</td></tr>
<tr class="codeline" data-linenumber="914"><td class="num" id="LN914">914</td><td class="line">	tsize = rsize;</td></tr>
<tr class="codeline" data-linenumber="915"><td class="num" id="LN915">915</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="916"><td class="num" id="LN916">916</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="917"><td class="num" id="LN917">917</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="918"><td class="num" id="LN918">918</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="919"><td class="num" id="LN919">919</td><td class="line">  <span class='keyword'>if</span> (tbase != <span class='macro'>CMFAIL<span class='macro_popup'>((char *)(((void *)((~(size_t)0)))))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="920"><td class="num" id="LN920">920</td><td class="line">    msegmentptr sp = &amp;m-&gt;seg;</td></tr>
<tr class="codeline" data-linenumber="921"><td class="num" id="LN921">921</td><td class="line">    <span class='comment'>/* Try to merge with an existing segment */</span></td></tr>
<tr class="codeline" data-linenumber="922"><td class="num" id="LN922">922</td><td class="line">    <span class='keyword'>while</span> (sp != 0 &amp;&amp; tbase != sp-&gt;base + sp-&gt;size)</td></tr>
<tr class="codeline" data-linenumber="923"><td class="num" id="LN923">923</td><td class="line">      sp = sp-&gt;next;</td></tr>
<tr class="codeline" data-linenumber="924"><td class="num" id="LN924">924</td><td class="line">    <span class='keyword'>if</span> (sp != 0 &amp;&amp; <span class='macro'>segment_holds(sp, m-&gt;top)<span class='macro_popup'>((char *)(m-&gt;top) &gt;= sp-&gt;base &amp;&amp; (char *)(m-&gt;<br>top) &lt; sp-&gt;base + sp-&gt;size)</span></span>) { <span class='comment'>/* append */</span></td></tr>
<tr class="codeline" data-linenumber="925"><td class="num" id="LN925">925</td><td class="line">      sp-&gt;size += tsize;</td></tr>
<tr class="codeline" data-linenumber="926"><td class="num" id="LN926">926</td><td class="line">      init_top(m, m-&gt;top, m-&gt;topsize + tsize);</td></tr>
<tr class="codeline" data-linenumber="927"><td class="num" id="LN927">927</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="928"><td class="num" id="LN928">928</td><td class="line">      sp = &amp;m-&gt;seg;</td></tr>
<tr class="codeline" data-linenumber="929"><td class="num" id="LN929">929</td><td class="line">      <span class='keyword'>while</span> (sp != 0 &amp;&amp; sp-&gt;base != tbase + tsize)</td></tr>
<tr class="codeline" data-linenumber="930"><td class="num" id="LN930">930</td><td class="line">	sp = sp-&gt;next;</td></tr>
<tr class="codeline" data-linenumber="931"><td class="num" id="LN931">931</td><td class="line">      <span class='keyword'>if</span> (sp != 0) {</td></tr>
<tr class="codeline" data-linenumber="932"><td class="num" id="LN932">932</td><td class="line">	<span class='keyword'>char</span> *oldbase = sp-&gt;base;</td></tr>
<tr class="codeline" data-linenumber="933"><td class="num" id="LN933">933</td><td class="line">	sp-&gt;base = tbase;</td></tr>
<tr class="codeline" data-linenumber="934"><td class="num" id="LN934">934</td><td class="line">	sp-&gt;size += tsize;</td></tr>
<tr class="codeline" data-linenumber="935"><td class="num" id="LN935">935</td><td class="line">	<span class='keyword'>return</span> prepend_alloc(m, tbase, oldbase, nb);</td></tr>
<tr class="codeline" data-linenumber="936"><td class="num" id="LN936">936</td><td class="line">      } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="937"><td class="num" id="LN937">937</td><td class="line">	add_segment(m, tbase, tsize);</td></tr>
<tr class="codeline" data-linenumber="938"><td class="num" id="LN938">938</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="939"><td class="num" id="LN939">939</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="940"><td class="num" id="LN940">940</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="941"><td class="num" id="LN941">941</td><td class="line">    <span class='keyword'>if</span> (nb &lt; m-&gt;topsize) { <span class='comment'>/* Allocate from new or extended top space */</span></td></tr>
<tr class="codeline" data-linenumber="942"><td class="num" id="LN942">942</td><td class="line">      size_t rsize = m-&gt;topsize -= nb;</td></tr>
<tr class="codeline" data-linenumber="943"><td class="num" id="LN943">943</td><td class="line">      mchunkptr p = m-&gt;top;</td></tr>
<tr class="codeline" data-linenumber="944"><td class="num" id="LN944">944</td><td class="line">      mchunkptr r = m-&gt;top = <span class='macro'>chunk_plus_offset(p, nb)<span class='macro_popup'>((mchunkptr)(((char *)(p)) + (nb)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="945"><td class="num" id="LN945">945</td><td class="line">      r-&gt;head = rsize | <span class='macro'>PINUSE_BIT<span class='macro_popup'>(((size_t)1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="946"><td class="num" id="LN946">946</td><td class="line">      <span class='macro'>set_size_and_pinuse_of_inuse_chunk(m, p, nb)<span class='macro_popup'>((p)-&gt;head = (nb|(((size_t)1))|(((size_t)2))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="947"><td class="num" id="LN947">947</td><td class="line">      <span class='keyword'>return</span> <span class='macro'>chunk2mem(p)<span class='macro_popup'>((void *)((char *)(p) + ((sizeof(size_t))&lt;&lt;1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="948"><td class="num" id="LN948">948</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="949"><td class="num" id="LN949">949</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="950"><td class="num" id="LN950">950</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="951"><td class="num" id="LN951">951</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="952"><td class="num" id="LN952">952</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="953"><td class="num" id="LN953">953</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="954"><td class="num" id="LN954">954</td><td class="line"><span class='comment'>/* -----------------------  system deallocation -------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="955"><td class="num" id="LN955">955</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="956"><td class="num" id="LN956">956</td><td class="line"><span class='comment'>/* Unmap and unlink any mmapped segments that don't contain used chunks */</span></td></tr>
<tr class="codeline" data-linenumber="957"><td class="num" id="LN957">957</td><td class="line"><span class='keyword'>static</span> size_t release_unused_segments(mstate m)</td></tr>
<tr class="codeline" data-linenumber="958"><td class="num" id="LN958">958</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="959"><td class="num" id="LN959">959</td><td class="line">  size_t released = 0;</td></tr>
<tr class="codeline" data-linenumber="960"><td class="num" id="LN960">960</td><td class="line">  size_t nsegs = 0;</td></tr>
<tr class="codeline" data-linenumber="961"><td class="num" id="LN961">961</td><td class="line">  msegmentptr pred = &amp;m-&gt;seg;</td></tr>
<tr class="codeline" data-linenumber="962"><td class="num" id="LN962">962</td><td class="line">  msegmentptr sp = pred-&gt;next;</td></tr>
<tr class="codeline" data-linenumber="963"><td class="num" id="LN963">963</td><td class="line">  <span class='keyword'>while</span> (sp != 0) {</td></tr>
<tr class="codeline" data-linenumber="964"><td class="num" id="LN964">964</td><td class="line">    <span class='keyword'>char</span> *base = sp-&gt;base;</td></tr>
<tr class="codeline" data-linenumber="965"><td class="num" id="LN965">965</td><td class="line">    size_t size = sp-&gt;size;</td></tr>
<tr class="codeline" data-linenumber="966"><td class="num" id="LN966">966</td><td class="line">    msegmentptr next = sp-&gt;next;</td></tr>
<tr class="codeline" data-linenumber="967"><td class="num" id="LN967">967</td><td class="line">    nsegs++;</td></tr>
<tr class="codeline" data-linenumber="968"><td class="num" id="LN968">968</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="969"><td class="num" id="LN969">969</td><td class="line">      mchunkptr p = <span class='macro'>align_as_chunk(base)<span class='macro_popup'>(mchunkptr)((base) + ((((size_t)(((void *)((char *)(base) + (<br>(sizeof(size_t))&lt;&lt;1)))) &amp; (((size_t)8U) - ((size_t)<br>1))) == 0)? 0 : ((((size_t)8U) - ((size_t)(((void *)((char *)<br>(base) + ((sizeof(size_t))&lt;&lt;1)))) &amp; (((size_t)8U) -<br> ((size_t)1)))) &amp; (((size_t)8U) - ((size_t)1)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="970"><td class="num" id="LN970">970</td><td class="line">      size_t psize = <span class='macro'>chunksize(p)<span class='macro_popup'>((p)-&gt;head &amp; ~(((((size_t)1))|(((size_t)2)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="971"><td class="num" id="LN971">971</td><td class="line">      <span class='comment'>/* Can unmap if first chunk holds entire segment and not pinned */</span></td></tr>
<tr class="codeline" data-linenumber="972"><td class="num" id="LN972">972</td><td class="line">      <span class='keyword'>if</span> (!<span class='macro'>cinuse(p)<span class='macro_popup'>((p)-&gt;head &amp; (((size_t)2)))</span></span> &amp;&amp; (<span class='keyword'>char</span> *)p + psize &gt;= base + size - <span class='macro'>TOP_FOOT_SIZE<span class='macro_popup'>(((((size_t)(((void *)((char *)(0) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1))) == 0)? 0 : ((((size_t<br>)8U) - ((size_t)(((void *)((char *)(0) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1)))) &amp; (((size_t)8U<br>) - ((size_t)1))))+(((sizeof(struct malloc_segment)) + ((sizeof<br>(size_t))) + (((size_t)8U) - ((size_t)1))) &amp; ~(((size_t)8U<br>) - ((size_t)1)))+(((sizeof(mchunk)) + (((size_t)8U) - ((size_t<br>)1))) &amp; ~(((size_t)8U) - ((size_t)1))))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="973"><td class="num" id="LN973">973</td><td class="line">	tchunkptr tp = (tchunkptr)p;</td></tr>
<tr class="codeline" data-linenumber="974"><td class="num" id="LN974">974</td><td class="line">	<span class='keyword'>if</span> (p == m-&gt;dv) {</td></tr>
<tr class="codeline" data-linenumber="975"><td class="num" id="LN975">975</td><td class="line">	  m-&gt;dv = 0;</td></tr>
<tr class="codeline" data-linenumber="976"><td class="num" id="LN976">976</td><td class="line">	  m-&gt;dvsize = 0;</td></tr>
<tr class="codeline" data-linenumber="977"><td class="num" id="LN977">977</td><td class="line">	} <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="978"><td class="num" id="LN978">978</td><td class="line">	  <span class='macro'>unlink_large_chunk(m, tp)<span class='macro_popup'>{ tchunkptr XP = tp-&gt;parent; tchunkptr R; if (tp-&gt;bk !=<br> tp) { tchunkptr F = tp-&gt;fd; R = tp-&gt;bk; F-&gt;bk = R; R<br>-&gt;fd = F; } else { tchunkptr *RP; if (((R = *(RP = &amp;(tp<br>-&gt;child[1]))) != 0) || ((R = *(RP = &amp;(tp-&gt;child[0])<br>)) != 0)) { tchunkptr *CP; while ((*(CP = &amp;(R-&gt;child[1<br>])) != 0) || (*(CP = &amp;(R-&gt;child[0])) != 0)) { R = *(RP<br> = CP); } *RP = 0; } } if (XP != 0) { tbinptr *H = (&amp;((m)<br>-&gt;treebins[tp-&gt;index])); if (tp == *H) { if ((*H = R) ==<br> 0) ((m)-&gt;treemap &amp;= ~((binmap_t)(1) &lt;&lt; (tp-&gt;<br>index))); } else { if (XP-&gt;child[0] == tp) XP-&gt;child[0]<br> = R; else XP-&gt;child[1] = R; } if (R != 0) { tchunkptr C0,<br> C1; R-&gt;parent = XP; if ((C0 = tp-&gt;child[0]) != 0) { R-&gt;<br>child[0] = C0; C0-&gt;parent = R; } if ((C1 = tp-&gt;child[1]<br>) != 0) { R-&gt;child[1] = C1; C1-&gt;parent = R; } } }}</span></span>;</td></tr>
<tr class="codeline" data-linenumber="979"><td class="num" id="LN979">979</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="980"><td class="num" id="LN980">980</td><td class="line">	<span class='keyword'>if</span> (CALL_MUNMAP(base, size) == 0) {</td></tr>
<tr class="codeline" data-linenumber="981"><td class="num" id="LN981">981</td><td class="line">	  released += size;</td></tr>
<tr class="codeline" data-linenumber="982"><td class="num" id="LN982">982</td><td class="line">	  <span class='comment'>/* unlink obsoleted record */</span></td></tr>
<tr class="codeline" data-linenumber="983"><td class="num" id="LN983">983</td><td class="line">	  sp = pred;</td></tr>
<tr class="codeline" data-linenumber="984"><td class="num" id="LN984">984</td><td class="line">	  sp-&gt;next = next;</td></tr>
<tr class="codeline" data-linenumber="985"><td class="num" id="LN985">985</td><td class="line">	} <span class='keyword'>else</span> { <span class='comment'>/* back out if cannot unmap */</span></td></tr>
<tr class="codeline" data-linenumber="986"><td class="num" id="LN986">986</td><td class="line">	  <span class='macro'>insert_large_chunk(m, tp, psize)<span class='macro_popup'>{ tbinptr *H; bindex_t I; { unsigned int X = (unsigned int)(psize<br> &gt;&gt; (8U)); if (X == 0) { I = 0; } else if (X &gt; 0xFFFF<br>) { I = (32U)-1; } else { unsigned int K = ((uint32_t)(__builtin_clz<br>(X)^31)); I = (bindex_t)((K &lt;&lt; 1) + ((psize &gt;&gt; (K<br> + ((8U)-1)) &amp; 1))); }}; H = (&amp;((m)-&gt;treebins[I]))<br>; tp-&gt;index = I; tp-&gt;child[0] = tp-&gt;child[1] = 0; if<br> (!((m)-&gt;treemap &amp; ((binmap_t)(1) &lt;&lt; (I)))) { ((<br>m)-&gt;treemap |= ((binmap_t)(1) &lt;&lt; (I))); *H = tp; tp-&gt;<br>parent = (tchunkptr)H; tp-&gt;fd = tp-&gt;bk = tp; } else { tchunkptr<br> T = *H; size_t K = psize &lt;&lt; ((I == (32U)-1)? 0 : (((sizeof<br>(size_t) &lt;&lt; 3)-((size_t)1)) - (((I) &gt;&gt; 1) + (8U) -<br> 2))); for (;;) { if (((T)-&gt;head &amp; ~(((((size_t)1))|((<br>(size_t)2))))) != psize) { tchunkptr *C = &amp;(T-&gt;child[(<br>K &gt;&gt; ((sizeof(size_t) &lt;&lt; 3)-((size_t)1))) &amp; 1<br>]); K &lt;&lt;= 1; if (*C != 0) { T = *C; } else { *C = tp; tp<br>-&gt;parent = T; tp-&gt;fd = tp-&gt;bk = tp; break; } } else {<br> tchunkptr F = T-&gt;fd; T-&gt;fd = F-&gt;bk = tp; tp-&gt;fd =<br> F; tp-&gt;bk = T; tp-&gt;parent = 0; break; } } }}</span></span>;</td></tr>
<tr class="codeline" data-linenumber="987"><td class="num" id="LN987">987</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="988"><td class="num" id="LN988">988</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="989"><td class="num" id="LN989">989</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="990"><td class="num" id="LN990">990</td><td class="line">    pred = sp;</td></tr>
<tr class="codeline" data-linenumber="991"><td class="num" id="LN991">991</td><td class="line">    sp = next;</td></tr>
<tr class="codeline" data-linenumber="992"><td class="num" id="LN992">992</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="993"><td class="num" id="LN993">993</td><td class="line">  <span class='comment'>/* Reset check counter */</span></td></tr>
<tr class="codeline" data-linenumber="994"><td class="num" id="LN994">994</td><td class="line">  m-&gt;release_checks = nsegs &gt; <span class='macro'>MAX_RELEASE_CHECK_RATE<span class='macro_popup'>255</span></span> ?</td></tr>
<tr class="codeline" data-linenumber="995"><td class="num" id="LN995">995</td><td class="line">		      nsegs : <span class='macro'>MAX_RELEASE_CHECK_RATE<span class='macro_popup'>255</span></span>;</td></tr>
<tr class="codeline" data-linenumber="996"><td class="num" id="LN996">996</td><td class="line">  <span class='keyword'>return</span> released;</td></tr>
<tr class="codeline" data-linenumber="997"><td class="num" id="LN997">997</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="998"><td class="num" id="LN998">998</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="999"><td class="num" id="LN999">999</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> alloc_trim(mstate m, size_t pad)</td></tr>
<tr class="codeline" data-linenumber="1000"><td class="num" id="LN1000">1000</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1001"><td class="num" id="LN1001">1001</td><td class="line">  size_t released = 0;</td></tr>
<tr class="codeline" data-linenumber="1002"><td class="num" id="LN1002">1002</td><td class="line">  <span class='keyword'>if</span> (pad &lt; <span class='macro'>MAX_REQUEST<span class='macro_popup'>((~(((sizeof(mchunk)) + (((size_t)8U) - ((size_t)1))) &amp; ~<br>(((size_t)8U) - ((size_t)1)))+1) &lt;&lt; 2)</span></span> &amp;&amp; <span class='macro'>is_initialized(m)<span class='macro_popup'>((m)-&gt;top != 0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1003"><td class="num" id="LN1003">1003</td><td class="line">    pad += <span class='macro'>TOP_FOOT_SIZE<span class='macro_popup'>(((((size_t)(((void *)((char *)(0) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1))) == 0)? 0 : ((((size_t<br>)8U) - ((size_t)(((void *)((char *)(0) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1)))) &amp; (((size_t)8U<br>) - ((size_t)1))))+(((sizeof(struct malloc_segment)) + ((sizeof<br>(size_t))) + (((size_t)8U) - ((size_t)1))) &amp; ~(((size_t)8U<br>) - ((size_t)1)))+(((sizeof(mchunk)) + (((size_t)8U) - ((size_t<br>)1))) &amp; ~(((size_t)8U) - ((size_t)1))))</span></span>; <span class='comment'>/* ensure enough room for segment overhead */</span></td></tr>
<tr class="codeline" data-linenumber="1004"><td class="num" id="LN1004">1004</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1005"><td class="num" id="LN1005">1005</td><td class="line">    <span class='keyword'>if</span> (m-&gt;topsize &gt; pad) {</td></tr>
<tr class="codeline" data-linenumber="1006"><td class="num" id="LN1006">1006</td><td class="line">      <span class='comment'>/* Shrink top space in granularity-size units, keeping at least one */</span></td></tr>
<tr class="codeline" data-linenumber="1007"><td class="num" id="LN1007">1007</td><td class="line">      size_t unit = <span class='macro'>DEFAULT_GRANULARITY<span class='macro_popup'>((size_t)128U * (size_t)1024U)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1008"><td class="num" id="LN1008">1008</td><td class="line">      size_t extra = ((m-&gt;topsize - pad + (unit - <span class='macro'>SIZE_T_ONE<span class='macro_popup'>((size_t)1)</span></span>)) / unit -</td></tr>
<tr class="codeline" data-linenumber="1009"><td class="num" id="LN1009">1009</td><td class="line">		      <span class='macro'>SIZE_T_ONE<span class='macro_popup'>((size_t)1)</span></span>) * unit;</td></tr>
<tr class="codeline" data-linenumber="1010"><td class="num" id="LN1010">1010</td><td class="line">      msegmentptr sp = segment_holding(m, (<span class='keyword'>char</span> *)m-&gt;top);</td></tr>
<tr class="codeline" data-linenumber="1011"><td class="num" id="LN1011">1011</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1012"><td class="num" id="LN1012">1012</td><td class="line">      <span class='keyword'>if</span> (sp-&gt;size &gt;= extra &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1013"><td class="num" id="LN1013">1013</td><td class="line">	  !has_segment_link(m, sp)) { <span class='comment'>/* can't shrink if pinned */</span></td></tr>
<tr class="codeline" data-linenumber="1014"><td class="num" id="LN1014">1014</td><td class="line">	size_t newsize = sp-&gt;size - extra;</td></tr>
<tr class="codeline" data-linenumber="1015"><td class="num" id="LN1015">1015</td><td class="line">	<span class='comment'>/* Prefer mremap, fall back to munmap */</span></td></tr>
<tr class="codeline" data-linenumber="1016"><td class="num" id="LN1016">1016</td><td class="line">	<span class='keyword'>if</span> ((<span class='macro'>CALL_MREMAP(sp-&gt;base, sp-&gt;size, newsize, CALL_MREMAP_NOMOVE)<span class='macro_popup'>CALL_MREMAP_((sp-&gt;base), (sp-&gt;size), (newsize), (0))</span></span> != <span class='macro'>MFAIL<span class='macro_popup'>((void *)((~(size_t)0)))</span></span>) ||</td></tr>
<tr class="codeline" data-linenumber="1017"><td class="num" id="LN1017">1017</td><td class="line">	    (CALL_MUNMAP(sp-&gt;base + newsize, extra) == 0)) {</td></tr>
<tr class="codeline" data-linenumber="1018"><td class="num" id="LN1018">1018</td><td class="line">	  released = extra;</td></tr>
<tr class="codeline" data-linenumber="1019"><td class="num" id="LN1019">1019</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1020"><td class="num" id="LN1020">1020</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="1021"><td class="num" id="LN1021">1021</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1022"><td class="num" id="LN1022">1022</td><td class="line">      <span class='keyword'>if</span> (released != 0) {</td></tr>
<tr class="codeline" data-linenumber="1023"><td class="num" id="LN1023">1023</td><td class="line">	sp-&gt;size -= released;</td></tr>
<tr class="codeline" data-linenumber="1024"><td class="num" id="LN1024">1024</td><td class="line">	init_top(m, m-&gt;top, m-&gt;topsize - released);</td></tr>
<tr class="codeline" data-linenumber="1025"><td class="num" id="LN1025">1025</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="1026"><td class="num" id="LN1026">1026</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1027"><td class="num" id="LN1027">1027</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1028"><td class="num" id="LN1028">1028</td><td class="line">    <span class='comment'>/* Unmap any unused mmapped segments */</span></td></tr>
<tr class="codeline" data-linenumber="1029"><td class="num" id="LN1029">1029</td><td class="line">    released += release_unused_segments(m);</td></tr>
<tr class="codeline" data-linenumber="1030"><td class="num" id="LN1030">1030</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1031"><td class="num" id="LN1031">1031</td><td class="line">    <span class='comment'>/* On failure, disable autotrim to avoid repeated failed future calls */</span></td></tr>
<tr class="codeline" data-linenumber="1032"><td class="num" id="LN1032">1032</td><td class="line">    <span class='keyword'>if</span> (released == 0 &amp;&amp; m-&gt;topsize &gt; m-&gt;trim_check)</td></tr>
<tr class="codeline" data-linenumber="1033"><td class="num" id="LN1033">1033</td><td class="line">      m-&gt;trim_check = <span class='macro'>MAX_SIZE_T<span class='macro_popup'>(~(size_t)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1034"><td class="num" id="LN1034">1034</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="1035"><td class="num" id="LN1035">1035</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1036"><td class="num" id="LN1036">1036</td><td class="line">  <span class='keyword'>return</span> (released != 0)? 1 : 0;</td></tr>
<tr class="codeline" data-linenumber="1037"><td class="num" id="LN1037">1037</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1038"><td class="num" id="LN1038">1038</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1039"><td class="num" id="LN1039">1039</td><td class="line"><span class='comment'>/* ---------------------------- malloc support --------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="1040"><td class="num" id="LN1040">1040</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1041"><td class="num" id="LN1041">1041</td><td class="line"><span class='comment'>/* allocate a large request from the best fitting chunk in a treebin */</span></td></tr>
<tr class="codeline" data-linenumber="1042"><td class="num" id="LN1042">1042</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> *tmalloc_large(mstate m, size_t nb)</td></tr>
<tr class="codeline" data-linenumber="1043"><td class="num" id="LN1043">1043</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1044"><td class="num" id="LN1044">1044</td><td class="line">  tchunkptr v = 0;</td></tr>
<tr class="codeline" data-linenumber="1045"><td class="num" id="LN1045">1045</td><td class="line">  size_t rsize = ~nb+1; <span class='comment'>/* Unsigned negation */</span></td></tr>
<tr class="codeline" data-linenumber="1046"><td class="num" id="LN1046">1046</td><td class="line">  tchunkptr t;</td></tr>
<tr class="codeline" data-linenumber="1047"><td class="num" id="LN1047">1047</td><td class="line">  bindex_t idx;</td></tr>
<tr class="codeline" data-linenumber="1048"><td class="num" id="LN1048">1048</td><td class="line">  <span class='macro'>compute_tree_index(nb, idx)<span class='macro_popup'>{ unsigned int X = (unsigned int)(nb &gt;&gt; (8U)); if (X ==<br> 0) { idx = 0; } else if (X &gt; 0xFFFF) { idx = (32U)-1; } else<br> { unsigned int K = ((uint32_t)(__builtin_clz(X)^31)); idx = (<br>bindex_t)((K &lt;&lt; 1) + ((nb &gt;&gt; (K + ((8U)-1)) &amp;<br> 1))); }}</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1049"><td class="num" id="LN1049">1049</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1050"><td class="num" id="LN1050">1050</td><td class="line">  <span class='keyword'>if</span> ((t = *<span class='macro'>treebin_at(m, idx)<span class='macro_popup'>(&amp;((m)-&gt;treebins[idx]))</span></span>) != 0) {</td></tr>
<tr class="codeline" data-linenumber="1051"><td class="num" id="LN1051">1051</td><td class="line">    <span class='comment'>/* Traverse tree for this bin looking for node with size == nb */</span></td></tr>
<tr class="codeline" data-linenumber="1052"><td class="num" id="LN1052">1052</td><td class="line">    size_t sizebits = nb &lt;&lt; <span class='macro'>leftshift_for_tree_index(idx)<span class='macro_popup'>((idx == (32U)-1)? 0 : (((sizeof(size_t) &lt;&lt; 3)-((size_t<br>)1)) - (((idx) &gt;&gt; 1) + (8U) - 2)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1053"><td class="num" id="LN1053">1053</td><td class="line">    tchunkptr rst = 0;  <span class='comment'>/* The deepest untaken right subtree */</span></td></tr>
<tr class="codeline" data-linenumber="1054"><td class="num" id="LN1054">1054</td><td class="line">    <span class='keyword'>for</span> (;;) {</td></tr>
<tr class="codeline" data-linenumber="1055"><td class="num" id="LN1055">1055</td><td class="line">      tchunkptr rt;</td></tr>
<tr class="codeline" data-linenumber="1056"><td class="num" id="LN1056">1056</td><td class="line">      size_t trem = <span class='macro'>chunksize(t)<span class='macro_popup'>((t)-&gt;head &amp; ~(((((size_t)1))|(((size_t)2)))))</span></span> - nb;</td></tr>
<tr class="codeline" data-linenumber="1057"><td class="num" id="LN1057">1057</td><td class="line">      <span class='keyword'>if</span> (trem &lt; rsize) {</td></tr>
<tr class="codeline" data-linenumber="1058"><td class="num" id="LN1058">1058</td><td class="line">	v = t;</td></tr>
<tr class="codeline" data-linenumber="1059"><td class="num" id="LN1059">1059</td><td class="line">	<span class='keyword'>if</span> ((rsize = trem) == 0)</td></tr>
<tr class="codeline" data-linenumber="1060"><td class="num" id="LN1060">1060</td><td class="line">	  <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1061"><td class="num" id="LN1061">1061</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="1062"><td class="num" id="LN1062">1062</td><td class="line">      rt = t-&gt;child[1];</td></tr>
<tr class="codeline" data-linenumber="1063"><td class="num" id="LN1063">1063</td><td class="line">      t = t-&gt;child[(sizebits &gt;&gt; (<span class='macro'>SIZE_T_BITSIZE<span class='macro_popup'>(sizeof(size_t) &lt;&lt; 3)</span></span>-<span class='macro'>SIZE_T_ONE<span class='macro_popup'>((size_t)1)</span></span>)) &amp; 1];</td></tr>
<tr class="codeline" data-linenumber="1064"><td class="num" id="LN1064">1064</td><td class="line">      <span class='keyword'>if</span> (rt != 0 &amp;&amp; rt != t)</td></tr>
<tr class="codeline" data-linenumber="1065"><td class="num" id="LN1065">1065</td><td class="line">	rst = rt;</td></tr>
<tr class="codeline" data-linenumber="1066"><td class="num" id="LN1066">1066</td><td class="line">      <span class='keyword'>if</span> (t == 0) {</td></tr>
<tr class="codeline" data-linenumber="1067"><td class="num" id="LN1067">1067</td><td class="line">	t = rst; <span class='comment'>/* set t to least subtree holding sizes &gt; nb */</span></td></tr>
<tr class="codeline" data-linenumber="1068"><td class="num" id="LN1068">1068</td><td class="line">	<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1069"><td class="num" id="LN1069">1069</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="1070"><td class="num" id="LN1070">1070</td><td class="line">      sizebits &lt;&lt;= 1;</td></tr>
<tr class="codeline" data-linenumber="1071"><td class="num" id="LN1071">1071</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1072"><td class="num" id="LN1072">1072</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="1073"><td class="num" id="LN1073">1073</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1074"><td class="num" id="LN1074">1074</td><td class="line">  <span class='keyword'>if</span> (t == 0 &amp;&amp; v == 0) { <span class='comment'>/* set t to root of next non-empty treebin */</span></td></tr>
<tr class="codeline" data-linenumber="1075"><td class="num" id="LN1075">1075</td><td class="line">    binmap_t leftbits = <span class='macro'>left_bits(idx2bit(idx))<span class='macro_popup'>((((binmap_t)(1) &lt;&lt; (idx))&lt;&lt;1) | (~(((binmap_t)(1<br>) &lt;&lt; (idx))&lt;&lt;1)+1))</span></span> &amp; m-&gt;treemap;</td></tr>
<tr class="codeline" data-linenumber="1076"><td class="num" id="LN1076">1076</td><td class="line">    <span class='keyword'>if</span> (leftbits != 0)</td></tr>
<tr class="codeline" data-linenumber="1077"><td class="num" id="LN1077">1077</td><td class="line">      t = *<span class='macro'>treebin_at(m, lj_ffs(leftbits))<span class='macro_popup'>(&amp;((m)-&gt;treebins[((uint32_t)__builtin_ctz(leftbits))])<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1078"><td class="num" id="LN1078">1078</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="1079"><td class="num" id="LN1079">1079</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1080"><td class="num" id="LN1080">1080</td><td class="line">  <span class='keyword'>while</span> (t != 0) { <span class='comment'>/* find smallest of tree or subtree */</span></td></tr>
<tr class="codeline" data-linenumber="1081"><td class="num" id="LN1081">1081</td><td class="line">    size_t trem = <span class='macro'>chunksize(t)<span class='macro_popup'>((t)-&gt;head &amp; ~(((((size_t)1))|(((size_t)2)))))</span></span> - nb;</td></tr>
<tr class="codeline" data-linenumber="1082"><td class="num" id="LN1082">1082</td><td class="line">    <span class='keyword'>if</span> (trem &lt; rsize) {</td></tr>
<tr class="codeline" data-linenumber="1083"><td class="num" id="LN1083">1083</td><td class="line">      rsize = trem;</td></tr>
<tr class="codeline" data-linenumber="1084"><td class="num" id="LN1084">1084</td><td class="line">      v = t;</td></tr>
<tr class="codeline" data-linenumber="1085"><td class="num" id="LN1085">1085</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1086"><td class="num" id="LN1086">1086</td><td class="line">    t = <span class='macro'>leftmost_child(t)<span class='macro_popup'>((t)-&gt;child[0] != 0? (t)-&gt;child[0] : (t)-&gt;child[1])</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1087"><td class="num" id="LN1087">1087</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="1088"><td class="num" id="LN1088">1088</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1089"><td class="num" id="LN1089">1089</td><td class="line">  <span class='comment'>/*  If dv is a better fit, return NULL so malloc will use it */</span></td></tr>
<tr class="codeline" data-linenumber="1090"><td class="num" id="LN1090">1090</td><td class="line">  <span class='keyword'>if</span> (v != 0 &amp;&amp; rsize &lt; (size_t)(m-&gt;dvsize - nb)) {</td></tr>
<tr class="codeline" data-linenumber="1091"><td class="num" id="LN1091">1091</td><td class="line">    mchunkptr r = <span class='macro'>chunk_plus_offset(v, nb)<span class='macro_popup'>((mchunkptr)(((char *)(v)) + (nb)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1092"><td class="num" id="LN1092">1092</td><td class="line">    <span class='macro'>unlink_large_chunk(m, v)<span class='macro_popup'>{ tchunkptr XP = v-&gt;parent; tchunkptr R; if (v-&gt;bk != v<br>) { tchunkptr F = v-&gt;fd; R = v-&gt;bk; F-&gt;bk = R; R-&gt;<br>fd = F; } else { tchunkptr *RP; if (((R = *(RP = &amp;(v-&gt;<br>child[1]))) != 0) || ((R = *(RP = &amp;(v-&gt;child[0]))) != 0<br>)) { tchunkptr *CP; while ((*(CP = &amp;(R-&gt;child[1])) != 0<br>) || (*(CP = &amp;(R-&gt;child[0])) != 0)) { R = *(RP = CP); }<br> *RP = 0; } } if (XP != 0) { tbinptr *H = (&amp;((m)-&gt;treebins<br>[v-&gt;index])); if (v == *H) { if ((*H = R) == 0) ((m)-&gt;treemap<br> &amp;= ~((binmap_t)(1) &lt;&lt; (v-&gt;index))); } else { if<br> (XP-&gt;child[0] == v) XP-&gt;child[0] = R; else XP-&gt;child<br>[1] = R; } if (R != 0) { tchunkptr C0, C1; R-&gt;parent = XP;<br> if ((C0 = v-&gt;child[0]) != 0) { R-&gt;child[0] = C0; C0-&gt;<br>parent = R; } if ((C1 = v-&gt;child[1]) != 0) { R-&gt;child[1<br>] = C1; C1-&gt;parent = R; } } }}</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1093"><td class="num" id="LN1093">1093</td><td class="line">    <span class='keyword'>if</span> (rsize &lt; <span class='macro'>MIN_CHUNK_SIZE<span class='macro_popup'>(((sizeof(mchunk)) + (((size_t)8U) - ((size_t)1))) &amp; ~(((<br>size_t)8U) - ((size_t)1)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1094"><td class="num" id="LN1094">1094</td><td class="line">      <span class='macro'>set_inuse_and_pinuse(m, v, (rsize + nb))<span class='macro_popup'>((v)-&gt;head = ((rsize + nb)|(((size_t)1))|(((size_t)2))), (<br>(mchunkptr)(((char *)(v)) + ((rsize + nb))))-&gt;head |= (((size_t<br>)1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1095"><td class="num" id="LN1095">1095</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1096"><td class="num" id="LN1096">1096</td><td class="line">      <span class='macro'>set_size_and_pinuse_of_inuse_chunk(m, v, nb)<span class='macro_popup'>((v)-&gt;head = (nb|(((size_t)1))|(((size_t)2))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1097"><td class="num" id="LN1097">1097</td><td class="line">      <span class='macro'>set_size_and_pinuse_of_free_chunk(r, rsize)<span class='macro_popup'>((r)-&gt;head = (rsize|(((size_t)1))), (((mchunkptr)((char *)<br>(r) + (rsize)))-&gt;prev_foot = (rsize)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1098"><td class="num" id="LN1098">1098</td><td class="line">      <span class='macro'>insert_chunk(m, r, rsize)<span class='macro_popup'>if ((((rsize) &gt;&gt; (3U)) &lt; (32U))) { { bindex_t I = ((<br>rsize) &gt;&gt; (3U)); mchunkptr B = ((sbinptr)((char *)&amp;<br>((m)-&gt;smallbins[(I)&lt;&lt;1]))); mchunkptr F = B; if (!((<br>m)-&gt;smallmap &amp; ((binmap_t)(1) &lt;&lt; (I)))) ((m)-&gt;<br>smallmap |= ((binmap_t)(1) &lt;&lt; (I))); else F = B-&gt;fd;<br> B-&gt;fd = r; F-&gt;bk = r; r-&gt;fd = F; r-&gt;bk = B;} } else<br> { tchunkptr TP = (tchunkptr)(r); { tbinptr *H; bindex_t I; {<br> unsigned int X = (unsigned int)(rsize &gt;&gt; (8U)); if (X ==<br> 0) { I = 0; } else if (X &gt; 0xFFFF) { I = (32U)-1; } else {<br> unsigned int K = ((uint32_t)(__builtin_clz(X)^31)); I = (bindex_t<br>)((K &lt;&lt; 1) + ((rsize &gt;&gt; (K + ((8U)-1)) &amp; 1)))<br>; }}; H = (&amp;((m)-&gt;treebins[I])); TP-&gt;index = I; TP-&gt;<br>child[0] = TP-&gt;child[1] = 0; if (!((m)-&gt;treemap &amp; (<br>(binmap_t)(1) &lt;&lt; (I)))) { ((m)-&gt;treemap |= ((binmap_t<br>)(1) &lt;&lt; (I))); *H = TP; TP-&gt;parent = (tchunkptr)H; TP<br>-&gt;fd = TP-&gt;bk = TP; } else { tchunkptr T = *H; size_t K<br> = rsize &lt;&lt; ((I == (32U)-1)? 0 : (((sizeof(size_t) &lt;&lt;<br> 3)-((size_t)1)) - (((I) &gt;&gt; 1) + (8U) - 2))); for (;;) {<br> if (((T)-&gt;head &amp; ~(((((size_t)1))|(((size_t)2))))) !=<br> rsize) { tchunkptr *C = &amp;(T-&gt;child[(K &gt;&gt; ((sizeof<br>(size_t) &lt;&lt; 3)-((size_t)1))) &amp; 1]); K &lt;&lt;= 1; if<br> (*C != 0) { T = *C; } else { *C = TP; TP-&gt;parent = T; TP-&gt;<br>fd = TP-&gt;bk = TP; break; } } else { tchunkptr F = T-&gt;fd<br>; T-&gt;fd = F-&gt;bk = TP; TP-&gt;fd = F; TP-&gt;bk = T; TP-&gt;<br>parent = 0; break; } } }}; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1099"><td class="num" id="LN1099">1099</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1100"><td class="num" id="LN1100">1100</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>chunk2mem(v)<span class='macro_popup'>((void *)((char *)(v) + ((sizeof(size_t))&lt;&lt;1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1101"><td class="num" id="LN1101">1101</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="1102"><td class="num" id="LN1102">1102</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1103"><td class="num" id="LN1103">1103</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1104"><td class="num" id="LN1104">1104</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1105"><td class="num" id="LN1105">1105</td><td class="line"><span class='comment'>/* allocate a small request from the best fitting chunk in a treebin */</span></td></tr>
<tr class="codeline" data-linenumber="1106"><td class="num" id="LN1106">1106</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> *tmalloc_small(mstate m, size_t nb)</td></tr>
<tr class="codeline" data-linenumber="1107"><td class="num" id="LN1107">1107</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1108"><td class="num" id="LN1108">1108</td><td class="line">  tchunkptr t, v;</td></tr>
<tr class="codeline" data-linenumber="1109"><td class="num" id="LN1109">1109</td><td class="line">  mchunkptr r;</td></tr>
<tr class="codeline" data-linenumber="1110"><td class="num" id="LN1110">1110</td><td class="line">  size_t rsize;</td></tr>
<tr class="codeline" data-linenumber="1111"><td class="num" id="LN1111">1111</td><td class="line">  bindex_t i = <span class='macro'>lj_ffs(m-&gt;treemap)<span class='macro_popup'>((uint32_t)__builtin_ctz(m-&gt;treemap))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1112"><td class="num" id="LN1112">1112</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1113"><td class="num" id="LN1113">1113</td><td class="line">  v = t = *<span class='macro'>treebin_at(m, i)<span class='macro_popup'>(&amp;((m)-&gt;treebins[i]))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1114"><td class="num" id="LN1114">1114</td><td class="line">  rsize = <span class='macro'>chunksize(t)<span class='macro_popup'>((t)-&gt;head &amp; ~(((((size_t)1))|(((size_t)2)))))</span></span> - nb;</td></tr>
<tr class="codeline" data-linenumber="1115"><td class="num" id="LN1115">1115</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1116"><td class="num" id="LN1116">1116</td><td class="line">  <span class='keyword'>while</span> ((t = <span class='macro'>leftmost_child(t)<span class='macro_popup'>((t)-&gt;child[0] != 0? (t)-&gt;child[0] : (t)-&gt;child[1])</span></span>) != 0) {</td></tr>
<tr class="codeline" data-linenumber="1117"><td class="num" id="LN1117">1117</td><td class="line">    size_t trem = <span class='macro'>chunksize(t)<span class='macro_popup'>((t)-&gt;head &amp; ~(((((size_t)1))|(((size_t)2)))))</span></span> - nb;</td></tr>
<tr class="codeline" data-linenumber="1118"><td class="num" id="LN1118">1118</td><td class="line">    <span class='keyword'>if</span> (trem &lt; rsize) {</td></tr>
<tr class="codeline" data-linenumber="1119"><td class="num" id="LN1119">1119</td><td class="line">      rsize = trem;</td></tr>
<tr class="codeline" data-linenumber="1120"><td class="num" id="LN1120">1120</td><td class="line">      v = t;</td></tr>
<tr class="codeline" data-linenumber="1121"><td class="num" id="LN1121">1121</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1122"><td class="num" id="LN1122">1122</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="1123"><td class="num" id="LN1123">1123</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1124"><td class="num" id="LN1124">1124</td><td class="line">  r = <span class='macro'>chunk_plus_offset(v, nb)<span class='macro_popup'>((mchunkptr)(((char *)(v)) + (nb)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1125"><td class="num" id="LN1125">1125</td><td class="line">  <span class='macro'>unlink_large_chunk(m, v)<span class='macro_popup'>{ tchunkptr XP = v-&gt;parent; tchunkptr R; if (v-&gt;bk != v<br>) { tchunkptr F = v-&gt;fd; R = v-&gt;bk; F-&gt;bk = R; R-&gt;<br>fd = F; } else { tchunkptr *RP; if (((R = *(RP = &amp;(v-&gt;<br>child[1]))) != 0) || ((R = *(RP = &amp;(v-&gt;child[0]))) != 0<br>)) { tchunkptr *CP; while ((*(CP = &amp;(R-&gt;child[1])) != 0<br>) || (*(CP = &amp;(R-&gt;child[0])) != 0)) { R = *(RP = CP); }<br> *RP = 0; } } if (XP != 0) { tbinptr *H = (&amp;((m)-&gt;treebins<br>[v-&gt;index])); if (v == *H) { if ((*H = R) == 0) ((m)-&gt;treemap<br> &amp;= ~((binmap_t)(1) &lt;&lt; (v-&gt;index))); } else { if<br> (XP-&gt;child[0] == v) XP-&gt;child[0] = R; else XP-&gt;child<br>[1] = R; } if (R != 0) { tchunkptr C0, C1; R-&gt;parent = XP;<br> if ((C0 = v-&gt;child[0]) != 0) { R-&gt;child[0] = C0; C0-&gt;<br>parent = R; } if ((C1 = v-&gt;child[1]) != 0) { R-&gt;child[1<br>] = C1; C1-&gt;parent = R; } } }}</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1126"><td class="num" id="LN1126">1126</td><td class="line">  <span class='keyword'>if</span> (rsize &lt; <span class='macro'>MIN_CHUNK_SIZE<span class='macro_popup'>(((sizeof(mchunk)) + (((size_t)8U) - ((size_t)1))) &amp; ~(((<br>size_t)8U) - ((size_t)1)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1127"><td class="num" id="LN1127">1127</td><td class="line">    <span class='macro'>set_inuse_and_pinuse(m, v, (rsize + nb))<span class='macro_popup'>((v)-&gt;head = ((rsize + nb)|(((size_t)1))|(((size_t)2))), (<br>(mchunkptr)(((char *)(v)) + ((rsize + nb))))-&gt;head |= (((size_t<br>)1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1128"><td class="num" id="LN1128">1128</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1129"><td class="num" id="LN1129">1129</td><td class="line">    <span class='macro'>set_size_and_pinuse_of_inuse_chunk(m, v, nb)<span class='macro_popup'>((v)-&gt;head = (nb|(((size_t)1))|(((size_t)2))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1130"><td class="num" id="LN1130">1130</td><td class="line">    <span class='macro'>set_size_and_pinuse_of_free_chunk(r, rsize)<span class='macro_popup'>((r)-&gt;head = (rsize|(((size_t)1))), (((mchunkptr)((char *)<br>(r) + (rsize)))-&gt;prev_foot = (rsize)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1131"><td class="num" id="LN1131">1131</td><td class="line">    <span class='macro'>replace_dv(m, r, rsize)<span class='macro_popup'>{ size_t DVS = m-&gt;dvsize; if (DVS != 0) { mchunkptr DV = m<br>-&gt;dv; { bindex_t I = ((DVS) &gt;&gt; (3U)); mchunkptr B = (<br>(sbinptr)((char *)&amp;((m)-&gt;smallbins[(I)&lt;&lt;1]))); mchunkptr<br> F = B; if (!((m)-&gt;smallmap &amp; ((binmap_t)(1) &lt;&lt; (<br>I)))) ((m)-&gt;smallmap |= ((binmap_t)(1) &lt;&lt; (I))); else<br> F = B-&gt;fd; B-&gt;fd = DV; F-&gt;bk = DV; DV-&gt;fd = F; DV<br>-&gt;bk = B;}; } m-&gt;dvsize = rsize; m-&gt;dv = r;}</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1132"><td class="num" id="LN1132">1132</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="1133"><td class="num" id="LN1133">1133</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>chunk2mem(v)<span class='macro_popup'>((void *)((char *)(v) + ((sizeof(size_t))&lt;&lt;1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1134"><td class="num" id="LN1134">1134</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1135"><td class="num" id="LN1135">1135</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1136"><td class="num" id="LN1136">1136</td><td class="line"><span class='comment'>/* ----------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="1137"><td class="num" id="LN1137">1137</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1138"><td class="num" id="LN1138">1138</td><td class="line"><span class='keyword'>void</span> *lj_alloc_create(<span class='keyword'>void</span>)</td></tr>
<tr class="codeline" data-linenumber="1139"><td class="num" id="LN1139">1139</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1140"><td class="num" id="LN1140">1140</td><td class="line">  size_t tsize = <span class='macro'>DEFAULT_GRANULARITY<span class='macro_popup'>((size_t)128U * (size_t)1024U)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1141"><td class="num" id="LN1141">1141</td><td class="line">  <span class='keyword'>char</span> *tbase;</td></tr>
<tr class="codeline" data-linenumber="1142"><td class="num" id="LN1142">1142</td><td class="line">  <span class='macro'>INIT_MMAP()<span class='macro_popup'>((void)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1143"><td class="num" id="LN1143">1143</td><td class="line">  tbase = (<span class='keyword'>char</span> *)(CALL_MMAP(tsize));</td></tr>
<tr class="codeline" data-linenumber="1144"><td class="num" id="LN1144">1144</td><td class="line">  <span class='keyword'>if</span> (tbase != <span class='macro'>CMFAIL<span class='macro_popup'>((char *)(((void *)((~(size_t)0)))))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1145"><td class="num" id="LN1145">1145</td><td class="line">    size_t msize = <span class='macro'>pad_request(<span class='keyword'>sizeof</span>(<span class='keyword'>struct</span> malloc_state))<span class='macro_popup'>(((sizeof(struct malloc_state)) + ((sizeof(size_t))) + (((size_t<br>)8U) - ((size_t)1))) &amp; ~(((size_t)8U) - ((size_t)1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1146"><td class="num" id="LN1146">1146</td><td class="line">    mchunkptr mn;</td></tr>
<tr class="codeline" data-linenumber="1147"><td class="num" id="LN1147">1147</td><td class="line">    mchunkptr msp = <span class='macro'>align_as_chunk(tbase)<span class='macro_popup'>(mchunkptr)((tbase) + ((((size_t)(((void *)((char *)(tbase) +<br> ((sizeof(size_t))&lt;&lt;1)))) &amp; (((size_t)8U) - ((size_t<br>)1))) == 0)? 0 : ((((size_t)8U) - ((size_t)(((void *)((char *<br>)(tbase) + ((sizeof(size_t))&lt;&lt;1)))) &amp; (((size_t)8U)<br> - ((size_t)1)))) &amp; (((size_t)8U) - ((size_t)1)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1148"><td class="num" id="LN1148">1148</td><td class="line">    mstate m = (mstate)(<span class='macro'>chunk2mem(msp)<span class='macro_popup'>((void *)((char *)(msp) + ((sizeof(size_t))&lt;&lt;1)))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1149"><td class="num" id="LN1149">1149</td><td class="line">    memset(m, 0, msize);</td></tr>
<tr class="codeline" data-linenumber="1150"><td class="num" id="LN1150">1150</td><td class="line">    msp-&gt;head = (msize|<span class='macro'>PINUSE_BIT<span class='macro_popup'>(((size_t)1))</span></span>|<span class='macro'>CINUSE_BIT<span class='macro_popup'>(((size_t)2))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1151"><td class="num" id="LN1151">1151</td><td class="line">    m-&gt;seg.base = tbase;</td></tr>
<tr class="codeline" data-linenumber="1152"><td class="num" id="LN1152">1152</td><td class="line">    m-&gt;seg.size = tsize;</td></tr>
<tr class="codeline" data-linenumber="1153"><td class="num" id="LN1153">1153</td><td class="line">    m-&gt;release_checks = <span class='macro'>MAX_RELEASE_CHECK_RATE<span class='macro_popup'>255</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1154"><td class="num" id="LN1154">1154</td><td class="line">    init_bins(m);</td></tr>
<tr class="codeline" data-linenumber="1155"><td class="num" id="LN1155">1155</td><td class="line">    mn = <span class='macro'>next_chunk(mem2chunk(m))<span class='macro_popup'>((mchunkptr)(((char *)(((mchunkptr)((char *)(m) - ((sizeof(size_t<br>))&lt;&lt;1))))) + ((((mchunkptr)((char *)(m) - ((sizeof(size_t<br>))&lt;&lt;1))))-&gt;head &amp; ~((((size_t)1))|(((size_t)2)))<br>)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1156"><td class="num" id="LN1156">1156</td><td class="line">    init_top(m, mn, (size_t)((tbase + tsize) - (<span class='keyword'>char</span> *)mn) - <span class='macro'>TOP_FOOT_SIZE<span class='macro_popup'>(((((size_t)(((void *)((char *)(0) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1))) == 0)? 0 : ((((size_t<br>)8U) - ((size_t)(((void *)((char *)(0) + ((sizeof(size_t))&lt;&lt;<br>1)))) &amp; (((size_t)8U) - ((size_t)1)))) &amp; (((size_t)8U<br>) - ((size_t)1))))+(((sizeof(struct malloc_segment)) + ((sizeof<br>(size_t))) + (((size_t)8U) - ((size_t)1))) &amp; ~(((size_t)8U<br>) - ((size_t)1)))+(((sizeof(mchunk)) + (((size_t)8U) - ((size_t<br>)1))) &amp; ~(((size_t)8U) - ((size_t)1))))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1157"><td class="num" id="LN1157">1157</td><td class="line">    <span class='keyword'>return</span> m;</td></tr>
<tr class="codeline" data-linenumber="1158"><td class="num" id="LN1158">1158</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="1159"><td class="num" id="LN1159">1159</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1160"><td class="num" id="LN1160">1160</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1161"><td class="num" id="LN1161">1161</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1162"><td class="num" id="LN1162">1162</td><td class="line"><span class='keyword'>void</span> lj_alloc_destroy(<span class='keyword'>void</span> *msp)</td></tr>
<tr class="codeline" data-linenumber="1163"><td class="num" id="LN1163">1163</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1164"><td class="num" id="LN1164">1164</td><td class="line">  mstate ms = (mstate)msp;</td></tr>
<tr class="codeline" data-linenumber="1165"><td class="num" id="LN1165">1165</td><td class="line">  msegmentptr sp = &amp;ms-&gt;seg;</td></tr>
<tr class="codeline" data-linenumber="1166"><td class="num" id="LN1166">1166</td><td class="line">  <span class='keyword'>while</span> (sp != 0) {</td></tr>
<tr class="codeline" data-linenumber="1167"><td class="num" id="LN1167">1167</td><td class="line">    <span class='keyword'>char</span> *base = sp-&gt;base;</td></tr>
<tr class="codeline" data-linenumber="1168"><td class="num" id="LN1168">1168</td><td class="line">    size_t size = sp-&gt;size;</td></tr>
<tr class="codeline" data-linenumber="1169"><td class="num" id="LN1169">1169</td><td class="line">    sp = sp-&gt;next;</td></tr>
<tr class="codeline" data-linenumber="1170"><td class="num" id="LN1170">1170</td><td class="line">    CALL_MUNMAP(base, size);</td></tr>
<tr class="codeline" data-linenumber="1171"><td class="num" id="LN1171">1171</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="1172"><td class="num" id="LN1172">1172</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1173"><td class="num" id="LN1173">1173</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1174"><td class="num" id="LN1174">1174</td><td class="line"><span class='keyword'>static</span> <span class='macro'>LJ_NOINLINE<span class='macro_popup'>__attribute__((noinline))</span></span> <span class='keyword'>void</span> *lj_alloc_malloc(<span class='keyword'>void</span> *msp, size_t nsize)</td></tr>
<tr class="codeline" data-linenumber="1175"><td class="num" id="LN1175">1175</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1176"><td class="num" id="LN1176">1176</td><td class="line">  mstate ms = (mstate)msp;</td></tr>
<tr class="codeline" data-linenumber="1177"><td class="num" id="LN1177">1177</td><td class="line">  <span class='keyword'>void</span> *mem;</td></tr>
<tr class="codeline" data-linenumber="1178"><td class="num" id="LN1178">1178</td><td class="line">  size_t nb;</td></tr>
<tr class="codeline" data-linenumber="1179"><td class="num" id="LN1179">1179</td><td class="line">  <span class='keyword'>if</span> (nsize &lt;= <span class='macro'>MAX_SMALL_REQUEST<span class='macro_popup'>(((((size_t)1) &lt;&lt; (8U)) - ((size_t)1)) - (((size_t)8U) -<br> ((size_t)1)) - ((sizeof(size_t))))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1180"><td class="num" id="LN1180">1180</td><td class="line">    bindex_t idx;</td></tr>
<tr class="codeline" data-linenumber="1181"><td class="num" id="LN1181">1181</td><td class="line">    binmap_t smallbits;</td></tr>
<tr class="codeline" data-linenumber="1182"><td class="num" id="LN1182">1182</td><td class="line">    nb = (nsize &lt; <span class='macro'>MIN_REQUEST<span class='macro_popup'>((((sizeof(mchunk)) + (((size_t)8U) - ((size_t)1))) &amp; ~((<br>(size_t)8U) - ((size_t)1))) - ((sizeof(size_t))) - ((size_t)1<br>))</span></span>)? <span class='macro'>MIN_CHUNK_SIZE<span class='macro_popup'>(((sizeof(mchunk)) + (((size_t)8U) - ((size_t)1))) &amp; ~(((<br>size_t)8U) - ((size_t)1)))</span></span> : <span class='macro'>pad_request(nsize)<span class='macro_popup'>(((nsize) + ((sizeof(size_t))) + (((size_t)8U) - ((size_t)1))<br>) &amp; ~(((size_t)8U) - ((size_t)1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1183"><td class="num" id="LN1183">1183</td><td class="line">    idx = <span class='macro'>small_index(nb)<span class='macro_popup'>((nb) &gt;&gt; (3U))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1184"><td class="num" id="LN1184">1184</td><td class="line">    smallbits = ms-&gt;smallmap &gt;&gt; idx;</td></tr>
<tr class="codeline" data-linenumber="1185"><td class="num" id="LN1185">1185</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1186"><td class="num" id="LN1186">1186</td><td class="line">    <span class='keyword'>if</span> ((smallbits &amp; 0x3U) != 0) { <span class='comment'>/* Remainderless fit to a smallbin. */</span></td></tr>
<tr class="codeline" data-linenumber="1187"><td class="num" id="LN1187">1187</td><td class="line">      mchunkptr b, p;</td></tr>
<tr class="codeline" data-linenumber="1188"><td class="num" id="LN1188">1188</td><td class="line">      idx += ~smallbits &amp; 1;       <span class='comment'>/* Uses next bin if idx empty */</span></td></tr>
<tr class="codeline" data-linenumber="1189"><td class="num" id="LN1189">1189</td><td class="line">      b = <span class='macro'>smallbin_at(ms, idx)<span class='macro_popup'>((sbinptr)((char *)&amp;((ms)-&gt;smallbins[(idx)&lt;&lt;1]))<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1190"><td class="num" id="LN1190">1190</td><td class="line">      p = b-&gt;fd;</td></tr>
<tr class="codeline" data-linenumber="1191"><td class="num" id="LN1191">1191</td><td class="line">      <span class='macro'>unlink_first_small_chunk(ms, b, p, idx)<span class='macro_popup'>{ mchunkptr F = p-&gt;fd; if (b == F) { ((ms)-&gt;smallmap &amp;=<br> ~((binmap_t)(1) &lt;&lt; (idx))); } else { b-&gt;fd = F; F-&gt;<br>bk = b; }}</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1192"><td class="num" id="LN1192">1192</td><td class="line">      <span class='macro'>set_inuse_and_pinuse(ms, p, small_index2size(idx))<span class='macro_popup'>((p)-&gt;head = (((idx) &lt;&lt; (3U))|(((size_t)1))|(((size_t<br>)2))), ((mchunkptr)(((char *)(p)) + (((idx) &lt;&lt; (3U)))))<br>-&gt;head |= (((size_t)1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1193"><td class="num" id="LN1193">1193</td><td class="line">      mem = <span class='macro'>chunk2mem(p)<span class='macro_popup'>((void *)((char *)(p) + ((sizeof(size_t))&lt;&lt;1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1194"><td class="num" id="LN1194">1194</td><td class="line">      <span class='keyword'>return</span> mem;</td></tr>
<tr class="codeline" data-linenumber="1195"><td class="num" id="LN1195">1195</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (nb &gt; ms-&gt;dvsize) {</td></tr>
<tr class="codeline" data-linenumber="1196"><td class="num" id="LN1196">1196</td><td class="line">      <span class='keyword'>if</span> (smallbits != 0) { <span class='comment'>/* Use chunk in next nonempty smallbin */</span></td></tr>
<tr class="codeline" data-linenumber="1197"><td class="num" id="LN1197">1197</td><td class="line">	mchunkptr b, p, r;</td></tr>
<tr class="codeline" data-linenumber="1198"><td class="num" id="LN1198">1198</td><td class="line">	size_t rsize;</td></tr>
<tr class="codeline" data-linenumber="1199"><td class="num" id="LN1199">1199</td><td class="line">	binmap_t leftbits = (smallbits &lt;&lt; idx) &amp; <span class='macro'>left_bits(idx2bit(idx))<span class='macro_popup'>((((binmap_t)(1) &lt;&lt; (idx))&lt;&lt;1) | (~(((binmap_t)(1<br>) &lt;&lt; (idx))&lt;&lt;1)+1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1200"><td class="num" id="LN1200">1200</td><td class="line">	bindex_t i = <span class='macro'>lj_ffs(leftbits)<span class='macro_popup'>((uint32_t)__builtin_ctz(leftbits))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1201"><td class="num" id="LN1201">1201</td><td class="line">	b = <span class='macro'>smallbin_at(ms, i)<span class='macro_popup'>((sbinptr)((char *)&amp;((ms)-&gt;smallbins[(i)&lt;&lt;1])))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1202"><td class="num" id="LN1202">1202</td><td class="line">	p = b-&gt;fd;</td></tr>
<tr class="codeline" data-linenumber="1203"><td class="num" id="LN1203">1203</td><td class="line">	<span class='macro'>unlink_first_small_chunk(ms, b, p, i)<span class='macro_popup'>{ mchunkptr F = p-&gt;fd; if (b == F) { ((ms)-&gt;smallmap &amp;=<br> ~((binmap_t)(1) &lt;&lt; (i))); } else { b-&gt;fd = F; F-&gt;<br>bk = b; }}</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1204"><td class="num" id="LN1204">1204</td><td class="line">	rsize = <span class='macro'>small_index2size(i)<span class='macro_popup'>((i) &lt;&lt; (3U))</span></span> - nb;</td></tr>
<tr class="codeline" data-linenumber="1205"><td class="num" id="LN1205">1205</td><td class="line">	<span class='comment'>/* Fit here cannot be remainderless if 4byte sizes */</span></td></tr>
<tr class="codeline" data-linenumber="1206"><td class="num" id="LN1206">1206</td><td class="line">	<span class='keyword'>if</span> (<span class='macro'>SIZE_T_SIZE<span class='macro_popup'>(sizeof(size_t))</span></span> != 4 &amp;&amp; rsize &lt; <span class='macro'>MIN_CHUNK_SIZE<span class='macro_popup'>(((sizeof(mchunk)) + (((size_t)8U) - ((size_t)1))) &amp; ~(((<br>size_t)8U) - ((size_t)1)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1207"><td class="num" id="LN1207">1207</td><td class="line">	  <span class='macro'>set_inuse_and_pinuse(ms, p, small_index2size(i))<span class='macro_popup'>((p)-&gt;head = (((i) &lt;&lt; (3U))|(((size_t)1))|(((size_t)<br>2))), ((mchunkptr)(((char *)(p)) + (((i) &lt;&lt; (3U)))))-&gt;<br>head |= (((size_t)1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1208"><td class="num" id="LN1208">1208</td><td class="line">	} <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1209"><td class="num" id="LN1209">1209</td><td class="line">	  <span class='macro'>set_size_and_pinuse_of_inuse_chunk(ms, p, nb)<span class='macro_popup'>((p)-&gt;head = (nb|(((size_t)1))|(((size_t)2))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1210"><td class="num" id="LN1210">1210</td><td class="line">	  r = <span class='macro'>chunk_plus_offset(p, nb)<span class='macro_popup'>((mchunkptr)(((char *)(p)) + (nb)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1211"><td class="num" id="LN1211">1211</td><td class="line">	  <span class='macro'>set_size_and_pinuse_of_free_chunk(r, rsize)<span class='macro_popup'>((r)-&gt;head = (rsize|(((size_t)1))), (((mchunkptr)((char *)<br>(r) + (rsize)))-&gt;prev_foot = (rsize)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1212"><td class="num" id="LN1212">1212</td><td class="line">	  <span class='macro'>replace_dv(ms, r, rsize)<span class='macro_popup'>{ size_t DVS = ms-&gt;dvsize; if (DVS != 0) { mchunkptr DV = ms<br>-&gt;dv; { bindex_t I = ((DVS) &gt;&gt; (3U)); mchunkptr B = (<br>(sbinptr)((char *)&amp;((ms)-&gt;smallbins[(I)&lt;&lt;1]))); mchunkptr<br> F = B; if (!((ms)-&gt;smallmap &amp; ((binmap_t)(1) &lt;&lt;<br> (I)))) ((ms)-&gt;smallmap |= ((binmap_t)(1) &lt;&lt; (I))); else<br> F = B-&gt;fd; B-&gt;fd = DV; F-&gt;bk = DV; DV-&gt;fd = F; DV<br>-&gt;bk = B;}; } ms-&gt;dvsize = rsize; ms-&gt;dv = r;}</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1213"><td class="num" id="LN1213">1213</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1214"><td class="num" id="LN1214">1214</td><td class="line">	mem = <span class='macro'>chunk2mem(p)<span class='macro_popup'>((void *)((char *)(p) + ((sizeof(size_t))&lt;&lt;1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1215"><td class="num" id="LN1215">1215</td><td class="line">	<span class='keyword'>return</span> mem;</td></tr>
<tr class="codeline" data-linenumber="1216"><td class="num" id="LN1216">1216</td><td class="line">      } <span class='keyword'>else</span> <span class='keyword'>if</span> (ms-&gt;treemap != 0 &amp;&amp; (mem = tmalloc_small(ms, nb)) != 0) {</td></tr>
<tr class="codeline" data-linenumber="1217"><td class="num" id="LN1217">1217</td><td class="line">	<span class='keyword'>return</span> mem;</td></tr>
<tr class="codeline" data-linenumber="1218"><td class="num" id="LN1218">1218</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="1219"><td class="num" id="LN1219">1219</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1220"><td class="num" id="LN1220">1220</td><td class="line">  } <span class='keyword'>else</span> <span class='keyword'>if</span> (nsize &gt;= <span class='macro'>MAX_REQUEST<span class='macro_popup'>((~(((sizeof(mchunk)) + (((size_t)8U) - ((size_t)1))) &amp; ~<br>(((size_t)8U) - ((size_t)1)))+1) &lt;&lt; 2)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1221"><td class="num" id="LN1221">1221</td><td class="line">    nb = <span class='macro'>MAX_SIZE_T<span class='macro_popup'>(~(size_t)0)</span></span>; <span class='comment'>/* Too big to allocate. Force failure (in sys alloc) */</span></td></tr>
<tr class="codeline" data-linenumber="1222"><td class="num" id="LN1222">1222</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1223"><td class="num" id="LN1223">1223</td><td class="line">    nb = <span class='macro'>pad_request(nsize)<span class='macro_popup'>(((nsize) + ((sizeof(size_t))) + (((size_t)8U) - ((size_t)1))<br>) &amp; ~(((size_t)8U) - ((size_t)1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1224"><td class="num" id="LN1224">1224</td><td class="line">    <span class='keyword'>if</span> (ms-&gt;treemap != 0 &amp;&amp; (mem = tmalloc_large(ms, nb)) != 0) {</td></tr>
<tr class="codeline" data-linenumber="1225"><td class="num" id="LN1225">1225</td><td class="line">      <span class='keyword'>return</span> mem;</td></tr>
<tr class="codeline" data-linenumber="1226"><td class="num" id="LN1226">1226</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1227"><td class="num" id="LN1227">1227</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="1228"><td class="num" id="LN1228">1228</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1229"><td class="num" id="LN1229">1229</td><td class="line">  <span class='keyword'>if</span> (nb &lt;= ms-&gt;dvsize) {</td></tr>
<tr class="codeline" data-linenumber="1230"><td class="num" id="LN1230">1230</td><td class="line">    size_t rsize = ms-&gt;dvsize - nb;</td></tr>
<tr class="codeline" data-linenumber="1231"><td class="num" id="LN1231">1231</td><td class="line">    mchunkptr p = ms-&gt;dv;</td></tr>
<tr class="codeline" data-linenumber="1232"><td class="num" id="LN1232">1232</td><td class="line">    <span class='keyword'>if</span> (rsize &gt;= <span class='macro'>MIN_CHUNK_SIZE<span class='macro_popup'>(((sizeof(mchunk)) + (((size_t)8U) - ((size_t)1))) &amp; ~(((<br>size_t)8U) - ((size_t)1)))</span></span>) { <span class='comment'>/* split dv */</span></td></tr>
<tr class="codeline" data-linenumber="1233"><td class="num" id="LN1233">1233</td><td class="line">      mchunkptr r = ms-&gt;dv = <span class='macro'>chunk_plus_offset(p, nb)<span class='macro_popup'>((mchunkptr)(((char *)(p)) + (nb)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1234"><td class="num" id="LN1234">1234</td><td class="line">      ms-&gt;dvsize = rsize;</td></tr>
<tr class="codeline" data-linenumber="1235"><td class="num" id="LN1235">1235</td><td class="line">      <span class='macro'>set_size_and_pinuse_of_free_chunk(r, rsize)<span class='macro_popup'>((r)-&gt;head = (rsize|(((size_t)1))), (((mchunkptr)((char *)<br>(r) + (rsize)))-&gt;prev_foot = (rsize)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1236"><td class="num" id="LN1236">1236</td><td class="line">      <span class='macro'>set_size_and_pinuse_of_inuse_chunk(ms, p, nb)<span class='macro_popup'>((p)-&gt;head = (nb|(((size_t)1))|(((size_t)2))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1237"><td class="num" id="LN1237">1237</td><td class="line">    } <span class='keyword'>else</span> { <span class='comment'>/* exhaust dv */</span></td></tr>
<tr class="codeline" data-linenumber="1238"><td class="num" id="LN1238">1238</td><td class="line">      size_t dvs = ms-&gt;dvsize;</td></tr>
<tr class="codeline" data-linenumber="1239"><td class="num" id="LN1239">1239</td><td class="line">      ms-&gt;dvsize = 0;</td></tr>
<tr class="codeline" data-linenumber="1240"><td class="num" id="LN1240">1240</td><td class="line">      ms-&gt;dv = 0;</td></tr>
<tr class="codeline" data-linenumber="1241"><td class="num" id="LN1241">1241</td><td class="line">      <span class='macro'>set_inuse_and_pinuse(ms, p, dvs)<span class='macro_popup'>((p)-&gt;head = (dvs|(((size_t)1))|(((size_t)2))), ((mchunkptr<br>)(((char *)(p)) + (dvs)))-&gt;head |= (((size_t)1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1242"><td class="num" id="LN1242">1242</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1243"><td class="num" id="LN1243">1243</td><td class="line">    mem = <span class='macro'>chunk2mem(p)<span class='macro_popup'>((void *)((char *)(p) + ((sizeof(size_t))&lt;&lt;1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1244"><td class="num" id="LN1244">1244</td><td class="line">    <span class='keyword'>return</span> mem;</td></tr>
<tr class="codeline" data-linenumber="1245"><td class="num" id="LN1245">1245</td><td class="line">  } <span class='keyword'>else</span> <span class='keyword'>if</span> (nb &lt; ms-&gt;topsize) { <span class='comment'>/* Split top */</span></td></tr>
<tr class="codeline" data-linenumber="1246"><td class="num" id="LN1246">1246</td><td class="line">    size_t rsize = ms-&gt;topsize -= nb;</td></tr>
<tr class="codeline" data-linenumber="1247"><td class="num" id="LN1247">1247</td><td class="line">    mchunkptr p = ms-&gt;top;</td></tr>
<tr class="codeline" data-linenumber="1248"><td class="num" id="LN1248">1248</td><td class="line">    mchunkptr r = ms-&gt;top = <span class='macro'>chunk_plus_offset(p, nb)<span class='macro_popup'>((mchunkptr)(((char *)(p)) + (nb)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1249"><td class="num" id="LN1249">1249</td><td class="line">    r-&gt;head = rsize | <span class='macro'>PINUSE_BIT<span class='macro_popup'>(((size_t)1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1250"><td class="num" id="LN1250">1250</td><td class="line">    <span class='macro'>set_size_and_pinuse_of_inuse_chunk(ms, p, nb)<span class='macro_popup'>((p)-&gt;head = (nb|(((size_t)1))|(((size_t)2))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1251"><td class="num" id="LN1251">1251</td><td class="line">    mem = <span class='macro'>chunk2mem(p)<span class='macro_popup'>((void *)((char *)(p) + ((sizeof(size_t))&lt;&lt;1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1252"><td class="num" id="LN1252">1252</td><td class="line">    <span class='keyword'>return</span> mem;</td></tr>
<tr class="codeline" data-linenumber="1253"><td class="num" id="LN1253">1253</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="1254"><td class="num" id="LN1254">1254</td><td class="line">  <span class='keyword'>return</span> alloc_sys(ms, nb);</td></tr>
<tr class="codeline" data-linenumber="1255"><td class="num" id="LN1255">1255</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1256"><td class="num" id="LN1256">1256</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1257"><td class="num" id="LN1257">1257</td><td class="line"><span class='keyword'>static</span> <span class='macro'>LJ_NOINLINE<span class='macro_popup'>__attribute__((noinline))</span></span> <span class='keyword'>void</span> *lj_alloc_free(<span class='keyword'>void</span> *msp, <span class='keyword'>void</span> *ptr)</td></tr>
<tr class="codeline" data-linenumber="1258"><td class="num" id="LN1258">1258</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1259"><td class="num" id="LN1259">1259</td><td class="line">  <span class='keyword'>if</span> (ptr != 0) {</td></tr>
<tr class="codeline" data-linenumber="1260"><td class="num" id="LN1260">1260</td><td class="line">    mchunkptr p = <span class='macro'>mem2chunk(ptr)<span class='macro_popup'>((mchunkptr)((char *)(ptr) - ((sizeof(size_t))&lt;&lt;1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1261"><td class="num" id="LN1261">1261</td><td class="line">    mstate fm = (mstate)msp;</td></tr>
<tr class="codeline" data-linenumber="1262"><td class="num" id="LN1262">1262</td><td class="line">    size_t psize = <span class='macro'>chunksize(p)<span class='macro_popup'>((p)-&gt;head &amp; ~(((((size_t)1))|(((size_t)2)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1263"><td class="num" id="LN1263">1263</td><td class="line">    mchunkptr next = <span class='macro'>chunk_plus_offset(p, psize)<span class='macro_popup'>((mchunkptr)(((char *)(p)) + (psize)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1264"><td class="num" id="LN1264">1264</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>pinuse(p)<span class='macro_popup'>((p)-&gt;head &amp; (((size_t)1)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1265"><td class="num" id="LN1265">1265</td><td class="line">      size_t prevsize = p-&gt;prev_foot;</td></tr>
<tr class="codeline" data-linenumber="1266"><td class="num" id="LN1266">1266</td><td class="line">      <span class='keyword'>if</span> ((prevsize &amp; <span class='macro'>IS_DIRECT_BIT<span class='macro_popup'>(((size_t)1))</span></span>) != 0) {</td></tr>
<tr class="codeline" data-linenumber="1267"><td class="num" id="LN1267">1267</td><td class="line">	prevsize &amp;= ~<span class='macro'>IS_DIRECT_BIT<span class='macro_popup'>(((size_t)1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1268"><td class="num" id="LN1268">1268</td><td class="line">	psize += prevsize + <span class='macro'>DIRECT_FOOT_PAD<span class='macro_popup'>(((sizeof(size_t))&lt;&lt;2))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1269"><td class="num" id="LN1269">1269</td><td class="line">	CALL_MUNMAP((<span class='keyword'>char</span> *)p - prevsize, psize);</td></tr>
<tr class="codeline" data-linenumber="1270"><td class="num" id="LN1270">1270</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1271"><td class="num" id="LN1271">1271</td><td class="line">      } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1272"><td class="num" id="LN1272">1272</td><td class="line">	mchunkptr prev = <span class='macro'>chunk_minus_offset(p, prevsize)<span class='macro_popup'>((mchunkptr)(((char *)(p)) - (prevsize)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1273"><td class="num" id="LN1273">1273</td><td class="line">	psize += prevsize;</td></tr>
<tr class="codeline" data-linenumber="1274"><td class="num" id="LN1274">1274</td><td class="line">	p = prev;</td></tr>
<tr class="codeline" data-linenumber="1275"><td class="num" id="LN1275">1275</td><td class="line">	<span class='comment'>/* consolidate backward */</span></td></tr>
<tr class="codeline" data-linenumber="1276"><td class="num" id="LN1276">1276</td><td class="line">	<span class='keyword'>if</span> (p != fm-&gt;dv) {</td></tr>
<tr class="codeline" data-linenumber="1277"><td class="num" id="LN1277">1277</td><td class="line">	  <span class='macro'>unlink_chunk(fm, p, prevsize)<span class='macro_popup'>if ((((prevsize) &gt;&gt; (3U)) &lt; (32U))) { { mchunkptr F =<br> p-&gt;fd; mchunkptr B = p-&gt;bk; bindex_t I = ((prevsize) &gt;&gt;<br> (3U)); if (F == B) { ((fm)-&gt;smallmap &amp;= ~((binmap_t)(<br>1) &lt;&lt; (I))); } else { F-&gt;bk = B; B-&gt;fd = F; }} } else<br> { tchunkptr TP = (tchunkptr)(p); { tchunkptr XP = TP-&gt;parent<br>; tchunkptr R; if (TP-&gt;bk != TP) { tchunkptr F = TP-&gt;fd<br>; R = TP-&gt;bk; F-&gt;bk = R; R-&gt;fd = F; } else { tchunkptr<br> *RP; if (((R = *(RP = &amp;(TP-&gt;child[1]))) != 0) || ((R =<br> *(RP = &amp;(TP-&gt;child[0]))) != 0)) { tchunkptr *CP; while<br> ((*(CP = &amp;(R-&gt;child[1])) != 0) || (*(CP = &amp;(R-&gt;<br>child[0])) != 0)) { R = *(RP = CP); } *RP = 0; } } if (XP != 0<br>) { tbinptr *H = (&amp;((fm)-&gt;treebins[TP-&gt;index])); if<br> (TP == *H) { if ((*H = R) == 0) ((fm)-&gt;treemap &amp;= ~((<br>binmap_t)(1) &lt;&lt; (TP-&gt;index))); } else { if (XP-&gt;child<br>[0] == TP) XP-&gt;child[0] = R; else XP-&gt;child[1] = R; } if<br> (R != 0) { tchunkptr C0, C1; R-&gt;parent = XP; if ((C0 = TP<br>-&gt;child[0]) != 0) { R-&gt;child[0] = C0; C0-&gt;parent = R<br>; } if ((C1 = TP-&gt;child[1]) != 0) { R-&gt;child[1] = C1; C1<br>-&gt;parent = R; } } }}; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1278"><td class="num" id="LN1278">1278</td><td class="line">	} <span class='keyword'>else</span> <span class='keyword'>if</span> ((next-&gt;head &amp; <span class='macro'>INUSE_BITS<span class='macro_popup'>((((size_t)1))|(((size_t)2)))</span></span>) == <span class='macro'>INUSE_BITS<span class='macro_popup'>((((size_t)1))|(((size_t)2)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1279"><td class="num" id="LN1279">1279</td><td class="line">	  fm-&gt;dvsize = psize;</td></tr>
<tr class="codeline" data-linenumber="1280"><td class="num" id="LN1280">1280</td><td class="line">	  <span class='macro'>set_free_with_pinuse(p, psize, next)<span class='macro_popup'>(((next)-&gt;head &amp;= ~(((size_t)1))), ((p)-&gt;head = (psize<br>|(((size_t)1))), (((mchunkptr)((char *)(p) + (psize)))-&gt;prev_foot<br> = (psize))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1281"><td class="num" id="LN1281">1281</td><td class="line">	  <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1282"><td class="num" id="LN1282">1282</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1283"><td class="num" id="LN1283">1283</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="1284"><td class="num" id="LN1284">1284</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1285"><td class="num" id="LN1285">1285</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>cinuse(next)<span class='macro_popup'>((next)-&gt;head &amp; (((size_t)2)))</span></span>) {  <span class='comment'>/* consolidate forward */</span></td></tr>
<tr class="codeline" data-linenumber="1286"><td class="num" id="LN1286">1286</td><td class="line">      <span class='keyword'>if</span> (next == fm-&gt;top) {</td></tr>
<tr class="codeline" data-linenumber="1287"><td class="num" id="LN1287">1287</td><td class="line">	size_t tsize = fm-&gt;topsize += psize;</td></tr>
<tr class="codeline" data-linenumber="1288"><td class="num" id="LN1288">1288</td><td class="line">	fm-&gt;top = p;</td></tr>
<tr class="codeline" data-linenumber="1289"><td class="num" id="LN1289">1289</td><td class="line">	p-&gt;head = tsize | <span class='macro'>PINUSE_BIT<span class='macro_popup'>(((size_t)1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1290"><td class="num" id="LN1290">1290</td><td class="line">	<span class='keyword'>if</span> (p == fm-&gt;dv) {</td></tr>
<tr class="codeline" data-linenumber="1291"><td class="num" id="LN1291">1291</td><td class="line">	  fm-&gt;dv = 0;</td></tr>
<tr class="codeline" data-linenumber="1292"><td class="num" id="LN1292">1292</td><td class="line">	  fm-&gt;dvsize = 0;</td></tr>
<tr class="codeline" data-linenumber="1293"><td class="num" id="LN1293">1293</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1294"><td class="num" id="LN1294">1294</td><td class="line">	<span class='keyword'>if</span> (tsize &gt; fm-&gt;trim_check)</td></tr>
<tr class="codeline" data-linenumber="1295"><td class="num" id="LN1295">1295</td><td class="line">	  alloc_trim(fm, 0);</td></tr>
<tr class="codeline" data-linenumber="1296"><td class="num" id="LN1296">1296</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1297"><td class="num" id="LN1297">1297</td><td class="line">      } <span class='keyword'>else</span> <span class='keyword'>if</span> (next == fm-&gt;dv) {</td></tr>
<tr class="codeline" data-linenumber="1298"><td class="num" id="LN1298">1298</td><td class="line">	size_t dsize = fm-&gt;dvsize += psize;</td></tr>
<tr class="codeline" data-linenumber="1299"><td class="num" id="LN1299">1299</td><td class="line">	fm-&gt;dv = p;</td></tr>
<tr class="codeline" data-linenumber="1300"><td class="num" id="LN1300">1300</td><td class="line">	<span class='macro'>set_size_and_pinuse_of_free_chunk(p, dsize)<span class='macro_popup'>((p)-&gt;head = (dsize|(((size_t)1))), (((mchunkptr)((char *)<br>(p) + (dsize)))-&gt;prev_foot = (dsize)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1301"><td class="num" id="LN1301">1301</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1302"><td class="num" id="LN1302">1302</td><td class="line">      } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1303"><td class="num" id="LN1303">1303</td><td class="line">	size_t nsize = <span class='macro'>chunksize(next)<span class='macro_popup'>((next)-&gt;head &amp; ~(((((size_t)1))|(((size_t)2)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1304"><td class="num" id="LN1304">1304</td><td class="line">	psize += nsize;</td></tr>
<tr class="codeline" data-linenumber="1305"><td class="num" id="LN1305">1305</td><td class="line">	<span class='macro'>unlink_chunk(fm, next, nsize)<span class='macro_popup'>if ((((nsize) &gt;&gt; (3U)) &lt; (32U))) { { mchunkptr F = next<br>-&gt;fd; mchunkptr B = next-&gt;bk; bindex_t I = ((nsize) &gt;&gt;<br> (3U)); if (F == B) { ((fm)-&gt;smallmap &amp;= ~((binmap_t)(<br>1) &lt;&lt; (I))); } else { F-&gt;bk = B; B-&gt;fd = F; }} } else<br> { tchunkptr TP = (tchunkptr)(next); { tchunkptr XP = TP-&gt;<br>parent; tchunkptr R; if (TP-&gt;bk != TP) { tchunkptr F = TP-&gt;<br>fd; R = TP-&gt;bk; F-&gt;bk = R; R-&gt;fd = F; } else { tchunkptr<br> *RP; if (((R = *(RP = &amp;(TP-&gt;child[1]))) != 0) || ((R =<br> *(RP = &amp;(TP-&gt;child[0]))) != 0)) { tchunkptr *CP; while<br> ((*(CP = &amp;(R-&gt;child[1])) != 0) || (*(CP = &amp;(R-&gt;<br>child[0])) != 0)) { R = *(RP = CP); } *RP = 0; } } if (XP != 0<br>) { tbinptr *H = (&amp;((fm)-&gt;treebins[TP-&gt;index])); if<br> (TP == *H) { if ((*H = R) == 0) ((fm)-&gt;treemap &amp;= ~((<br>binmap_t)(1) &lt;&lt; (TP-&gt;index))); } else { if (XP-&gt;child<br>[0] == TP) XP-&gt;child[0] = R; else XP-&gt;child[1] = R; } if<br> (R != 0) { tchunkptr C0, C1; R-&gt;parent = XP; if ((C0 = TP<br>-&gt;child[0]) != 0) { R-&gt;child[0] = C0; C0-&gt;parent = R<br>; } if ((C1 = TP-&gt;child[1]) != 0) { R-&gt;child[1] = C1; C1<br>-&gt;parent = R; } } }}; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1306"><td class="num" id="LN1306">1306</td><td class="line">	<span class='macro'>set_size_and_pinuse_of_free_chunk(p, psize)<span class='macro_popup'>((p)-&gt;head = (psize|(((size_t)1))), (((mchunkptr)((char *)<br>(p) + (psize)))-&gt;prev_foot = (psize)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1307"><td class="num" id="LN1307">1307</td><td class="line">	<span class='keyword'>if</span> (p == fm-&gt;dv) {</td></tr>
<tr class="codeline" data-linenumber="1308"><td class="num" id="LN1308">1308</td><td class="line">	  fm-&gt;dvsize = psize;</td></tr>
<tr class="codeline" data-linenumber="1309"><td class="num" id="LN1309">1309</td><td class="line">	  <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1310"><td class="num" id="LN1310">1310</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1311"><td class="num" id="LN1311">1311</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="1312"><td class="num" id="LN1312">1312</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1313"><td class="num" id="LN1313">1313</td><td class="line">      <span class='macro'>set_free_with_pinuse(p, psize, next)<span class='macro_popup'>(((next)-&gt;head &amp;= ~(((size_t)1))), ((p)-&gt;head = (psize<br>|(((size_t)1))), (((mchunkptr)((char *)(p) + (psize)))-&gt;prev_foot<br> = (psize))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1314"><td class="num" id="LN1314">1314</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1315"><td class="num" id="LN1315">1315</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1316"><td class="num" id="LN1316">1316</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>is_small(psize)<span class='macro_popup'>(((psize) &gt;&gt; (3U)) &lt; (32U))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1317"><td class="num" id="LN1317">1317</td><td class="line">      <span class='macro'>insert_small_chunk(fm, p, psize)<span class='macro_popup'>{ bindex_t I = ((psize) &gt;&gt; (3U)); mchunkptr B = ((sbinptr<br>)((char *)&amp;((fm)-&gt;smallbins[(I)&lt;&lt;1]))); mchunkptr<br> F = B; if (!((fm)-&gt;smallmap &amp; ((binmap_t)(1) &lt;&lt;<br> (I)))) ((fm)-&gt;smallmap |= ((binmap_t)(1) &lt;&lt; (I))); else<br> F = B-&gt;fd; B-&gt;fd = p; F-&gt;bk = p; p-&gt;fd = F; p-&gt;<br>bk = B;}</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1318"><td class="num" id="LN1318">1318</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1319"><td class="num" id="LN1319">1319</td><td class="line">      tchunkptr tp = (tchunkptr)p;</td></tr>
<tr class="codeline" data-linenumber="1320"><td class="num" id="LN1320">1320</td><td class="line">      <span class='macro'>insert_large_chunk(fm, tp, psize)<span class='macro_popup'>{ tbinptr *H; bindex_t I; { unsigned int X = (unsigned int)(psize<br> &gt;&gt; (8U)); if (X == 0) { I = 0; } else if (X &gt; 0xFFFF<br>) { I = (32U)-1; } else { unsigned int K = ((uint32_t)(__builtin_clz<br>(X)^31)); I = (bindex_t)((K &lt;&lt; 1) + ((psize &gt;&gt; (K<br> + ((8U)-1)) &amp; 1))); }}; H = (&amp;((fm)-&gt;treebins[I])<br>); tp-&gt;index = I; tp-&gt;child[0] = tp-&gt;child[1] = 0; if<br> (!((fm)-&gt;treemap &amp; ((binmap_t)(1) &lt;&lt; (I)))) { (<br>(fm)-&gt;treemap |= ((binmap_t)(1) &lt;&lt; (I))); *H = tp; tp<br>-&gt;parent = (tchunkptr)H; tp-&gt;fd = tp-&gt;bk = tp; } else<br> { tchunkptr T = *H; size_t K = psize &lt;&lt; ((I == (32U)-1<br>)? 0 : (((sizeof(size_t) &lt;&lt; 3)-((size_t)1)) - (((I) &gt;&gt;<br> 1) + (8U) - 2))); for (;;) { if (((T)-&gt;head &amp; ~(((((size_t<br>)1))|(((size_t)2))))) != psize) { tchunkptr *C = &amp;(T-&gt;<br>child[(K &gt;&gt; ((sizeof(size_t) &lt;&lt; 3)-((size_t)1))) &amp;<br> 1]); K &lt;&lt;= 1; if (*C != 0) { T = *C; } else { *C = tp;<br> tp-&gt;parent = T; tp-&gt;fd = tp-&gt;bk = tp; break; } } else<br> { tchunkptr F = T-&gt;fd; T-&gt;fd = F-&gt;bk = tp; tp-&gt;fd<br> = F; tp-&gt;bk = T; tp-&gt;parent = 0; break; } } }}</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1321"><td class="num" id="LN1321">1321</td><td class="line">      <span class='keyword'>if</span> (--fm-&gt;release_checks == 0)</td></tr>
<tr class="codeline" data-linenumber="1322"><td class="num" id="LN1322">1322</td><td class="line">	release_unused_segments(fm);</td></tr>
<tr class="codeline" data-linenumber="1323"><td class="num" id="LN1323">1323</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1324"><td class="num" id="LN1324">1324</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="1325"><td class="num" id="LN1325">1325</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1326"><td class="num" id="LN1326">1326</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1327"><td class="num" id="LN1327">1327</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1328"><td class="num" id="LN1328">1328</td><td class="line"><span class='keyword'>static</span> <span class='macro'>LJ_NOINLINE<span class='macro_popup'>__attribute__((noinline))</span></span> <span class='keyword'>void</span> *lj_alloc_realloc(<span class='keyword'>void</span> *msp, <span class='keyword'>void</span> *ptr, size_t nsize)</td></tr>
<tr class="codeline" data-linenumber="1329"><td class="num" id="LN1329">1329</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1330"><td class="num" id="LN1330">1330</td><td class="line">  <span class='keyword'>if</span> (nsize &gt;= <span class='macro'>MAX_REQUEST<span class='macro_popup'>((~(((sizeof(mchunk)) + (((size_t)8U) - ((size_t)1))) &amp; ~<br>(((size_t)8U) - ((size_t)1)))+1) &lt;&lt; 2)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1331"><td class="num" id="LN1331">1331</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1332"><td class="num" id="LN1332">1332</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1333"><td class="num" id="LN1333">1333</td><td class="line">    mstate m = (mstate)msp;</td></tr>
<tr class="codeline" data-linenumber="1334"><td class="num" id="LN1334">1334</td><td class="line">    mchunkptr oldp = <span class='macro'>mem2chunk(ptr)<span class='macro_popup'>((mchunkptr)((char *)(ptr) - ((sizeof(size_t))&lt;&lt;1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1335"><td class="num" id="LN1335">1335</td><td class="line">    size_t oldsize = <span class='macro'>chunksize(oldp)<span class='macro_popup'>((oldp)-&gt;head &amp; ~(((((size_t)1))|(((size_t)2)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1336"><td class="num" id="LN1336">1336</td><td class="line">    mchunkptr next = <span class='macro'>chunk_plus_offset(oldp, oldsize)<span class='macro_popup'>((mchunkptr)(((char *)(oldp)) + (oldsize)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1337"><td class="num" id="LN1337">1337</td><td class="line">    mchunkptr newp = 0;</td></tr>
<tr class="codeline" data-linenumber="1338"><td class="num" id="LN1338">1338</td><td class="line">    size_t nb = <span class='macro'>request2size(nsize)<span class='macro_popup'>(((nsize) &lt; ((((sizeof(mchunk)) + (((size_t)8U) - ((size_t<br>)1))) &amp; ~(((size_t)8U) - ((size_t)1))) - ((sizeof(size_t)<br>)) - ((size_t)1)))? (((sizeof(mchunk)) + (((size_t)8U) - ((size_t<br>)1))) &amp; ~(((size_t)8U) - ((size_t)1))) : (((nsize) + ((sizeof<br>(size_t))) + (((size_t)8U) - ((size_t)1))) &amp; ~(((size_t)8U<br>) - ((size_t)1))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1339"><td class="num" id="LN1339">1339</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1340"><td class="num" id="LN1340">1340</td><td class="line">    <span class='comment'>/* Try to either shrink or extend into top. Else malloc-copy-free */</span></td></tr>
<tr class="codeline" data-linenumber="1341"><td class="num" id="LN1341">1341</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>is_direct(oldp)<span class='macro_popup'>(!((oldp)-&gt;head &amp; (((size_t)1))) &amp;&amp; ((oldp)-&gt;<br>prev_foot &amp; (((size_t)1))))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1342"><td class="num" id="LN1342">1342</td><td class="line">      newp = direct_resize(oldp, nb);  <span class='comment'>/* this may return NULL. */</span></td></tr>
<tr class="codeline" data-linenumber="1343"><td class="num" id="LN1343">1343</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (oldsize &gt;= nb) { <span class='comment'>/* already big enough */</span></td></tr>
<tr class="codeline" data-linenumber="1344"><td class="num" id="LN1344">1344</td><td class="line">      size_t rsize = oldsize - nb;</td></tr>
<tr class="codeline" data-linenumber="1345"><td class="num" id="LN1345">1345</td><td class="line">      newp = oldp;</td></tr>
<tr class="codeline" data-linenumber="1346"><td class="num" id="LN1346">1346</td><td class="line">      <span class='keyword'>if</span> (rsize &gt;= <span class='macro'>MIN_CHUNK_SIZE<span class='macro_popup'>(((sizeof(mchunk)) + (((size_t)8U) - ((size_t)1))) &amp; ~(((<br>size_t)8U) - ((size_t)1)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1347"><td class="num" id="LN1347">1347</td><td class="line">	mchunkptr rem = <span class='macro'>chunk_plus_offset(newp, nb)<span class='macro_popup'>((mchunkptr)(((char *)(newp)) + (nb)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1348"><td class="num" id="LN1348">1348</td><td class="line">	<span class='macro'>set_inuse(m, newp, nb)<span class='macro_popup'>((newp)-&gt;head = (((newp)-&gt;head &amp; (((size_t)1)))|nb|<br>(((size_t)2))), ((mchunkptr)(((char *)(newp)) + (nb)))-&gt;head<br> |= (((size_t)1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1349"><td class="num" id="LN1349">1349</td><td class="line">	<span class='macro'>set_inuse(m, rem, rsize)<span class='macro_popup'>((rem)-&gt;head = (((rem)-&gt;head &amp; (((size_t)1)))|rsize<br>|(((size_t)2))), ((mchunkptr)(((char *)(rem)) + (rsize)))-&gt;<br>head |= (((size_t)1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1350"><td class="num" id="LN1350">1350</td><td class="line">	lj_alloc_free(m, <span class='macro'>chunk2mem(rem)<span class='macro_popup'>((void *)((char *)(rem) + ((sizeof(size_t))&lt;&lt;1)))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1351"><td class="num" id="LN1351">1351</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="1352"><td class="num" id="LN1352">1352</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (next == m-&gt;top &amp;&amp; oldsize + m-&gt;topsize &gt; nb) {</td></tr>
<tr class="codeline" data-linenumber="1353"><td class="num" id="LN1353">1353</td><td class="line">      <span class='comment'>/* Expand into top */</span></td></tr>
<tr class="codeline" data-linenumber="1354"><td class="num" id="LN1354">1354</td><td class="line">      size_t newsize = oldsize + m-&gt;topsize;</td></tr>
<tr class="codeline" data-linenumber="1355"><td class="num" id="LN1355">1355</td><td class="line">      size_t newtopsize = newsize - nb;</td></tr>
<tr class="codeline" data-linenumber="1356"><td class="num" id="LN1356">1356</td><td class="line">      mchunkptr newtop = <span class='macro'>chunk_plus_offset(oldp, nb)<span class='macro_popup'>((mchunkptr)(((char *)(oldp)) + (nb)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1357"><td class="num" id="LN1357">1357</td><td class="line">      <span class='macro'>set_inuse(m, oldp, nb)<span class='macro_popup'>((oldp)-&gt;head = (((oldp)-&gt;head &amp; (((size_t)1)))|nb|<br>(((size_t)2))), ((mchunkptr)(((char *)(oldp)) + (nb)))-&gt;head<br> |= (((size_t)1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1358"><td class="num" id="LN1358">1358</td><td class="line">      newtop-&gt;head = newtopsize |<span class='macro'>PINUSE_BIT<span class='macro_popup'>(((size_t)1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1359"><td class="num" id="LN1359">1359</td><td class="line">      m-&gt;top = newtop;</td></tr>
<tr class="codeline" data-linenumber="1360"><td class="num" id="LN1360">1360</td><td class="line">      m-&gt;topsize = newtopsize;</td></tr>
<tr class="codeline" data-linenumber="1361"><td class="num" id="LN1361">1361</td><td class="line">      newp = oldp;</td></tr>
<tr class="codeline" data-linenumber="1362"><td class="num" id="LN1362">1362</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1363"><td class="num" id="LN1363">1363</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1364"><td class="num" id="LN1364">1364</td><td class="line">    <span class='keyword'>if</span> (newp != 0) {</td></tr>
<tr class="codeline" data-linenumber="1365"><td class="num" id="LN1365">1365</td><td class="line">      <span class='keyword'>return</span> <span class='macro'>chunk2mem(newp)<span class='macro_popup'>((void *)((char *)(newp) + ((sizeof(size_t))&lt;&lt;1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1366"><td class="num" id="LN1366">1366</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1367"><td class="num" id="LN1367">1367</td><td class="line">      <span class='keyword'>void</span> *newmem = lj_alloc_malloc(m, nsize);</td></tr>
<tr class="codeline" data-linenumber="1368"><td class="num" id="LN1368">1368</td><td class="line">      <span class='keyword'>if</span> (newmem != 0) {</td></tr>
<tr class="codeline" data-linenumber="1369"><td class="num" id="LN1369">1369</td><td class="line">	size_t oc = oldsize - <span class='macro'>overhead_for(oldp)<span class='macro_popup'>((!((oldp)-&gt;head &amp; (((size_t)1))) &amp;&amp; ((oldp)-&gt;<br>prev_foot &amp; (((size_t)1))))? (((sizeof(size_t))&lt;&lt;1)<br>) : ((sizeof(size_t))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1370"><td class="num" id="LN1370">1370</td><td class="line">	<span class="mrange">memcpy</span>(newmem, ptr, oc &lt; nsize ? oc : nsize);</td></tr>
<tr><td class="num"></td><td class="line"><div id="EndPath" class="msg msgEvent" style="margin-left:9ex; max-width:58em">Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11</div></td></tr>
<tr class="codeline" data-linenumber="1371"><td class="num" id="LN1371">1371</td><td class="line">	lj_alloc_free(m, ptr);</td></tr>
<tr class="codeline" data-linenumber="1372"><td class="num" id="LN1372">1372</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="1373"><td class="num" id="LN1373">1373</td><td class="line">      <span class='keyword'>return</span> newmem;</td></tr>
<tr class="codeline" data-linenumber="1374"><td class="num" id="LN1374">1374</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1375"><td class="num" id="LN1375">1375</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="1376"><td class="num" id="LN1376">1376</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1377"><td class="num" id="LN1377">1377</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1378"><td class="num" id="LN1378">1378</td><td class="line"><span class='keyword'>void</span> *lj_alloc_f(<span class='keyword'>void</span> *msp, <span class='keyword'>void</span> *ptr, size_t osize, size_t nsize)</td></tr>
<tr class="codeline" data-linenumber="1379"><td class="num" id="LN1379">1379</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1380"><td class="num" id="LN1380">1380</td><td class="line">  (<span class='keyword'>void</span>)osize;</td></tr>
<tr class="codeline" data-linenumber="1381"><td class="num" id="LN1381">1381</td><td class="line">  <span class='keyword'>if</span> (nsize == 0) {</td></tr>
<tr class="codeline" data-linenumber="1382"><td class="num" id="LN1382">1382</td><td class="line">    <span class='keyword'>return</span> lj_alloc_free(msp, ptr);</td></tr>
<tr class="codeline" data-linenumber="1383"><td class="num" id="LN1383">1383</td><td class="line">  } <span class='keyword'>else</span> <span class='keyword'>if</span> (ptr == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1384"><td class="num" id="LN1384">1384</td><td class="line">    <span class='keyword'>return</span> lj_alloc_malloc(msp, nsize);</td></tr>
<tr class="codeline" data-linenumber="1385"><td class="num" id="LN1385">1385</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1386"><td class="num" id="LN1386">1386</td><td class="line">    <span class='keyword'>return</span> lj_alloc_realloc(msp, ptr, nsize);</td></tr>
<tr class="codeline" data-linenumber="1387"><td class="num" id="LN1387">1387</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="1388"><td class="num" id="LN1388">1388</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1389"><td class="num" id="LN1389">1389</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1390"><td class="num" id="LN1390">1390</td><td class="line"><span class='directive'>#endif</span></td></tr>
</table></body></html>
