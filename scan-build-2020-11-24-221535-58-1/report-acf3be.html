<!doctype html>
<html>
<head>
<title>../deps/openssl/openssl/ssl/t1_lib.c</title>

<style type="text/css">
body { color:#000000; background-color:#ffffff }
body { font-family:Helvetica, sans-serif; font-size:10pt }
h1 { font-size:14pt }
.FileName { margin-top: 5px; margin-bottom: 5px; display: inline; }
.FileNav { margin-left: 5px; margin-right: 5px; display: inline; }
.FileNav a { text-decoration:none; font-size: larger; }
.divider { margin-top: 30px; margin-bottom: 30px; height: 15px; }
.divider { background-color: gray; }
.code { border-collapse:collapse; width:100%; }
.code { font-family: "Monospace", monospace; font-size:10pt }
.code { line-height: 1.2em }
.comment { color: green; font-style: oblique }
.keyword { color: blue }
.string_literal { color: red }
.directive { color: darkmagenta }

/* Macros and variables could have pop-up notes hidden by default.
  - Macro pop-up:    expansion of the macro
  - Variable pop-up: value (table) of the variable */
.macro_popup, .variable_popup { display: none; }

/* Pop-up appears on mouse-hover event. */
.macro:hover .macro_popup, .variable:hover .variable_popup {
  display: block;
  padding: 2px;
  -webkit-border-radius:5px;
  -webkit-box-shadow:1px 1px 7px #000;
  border-radius:5px;
  box-shadow:1px 1px 7px #000;
  position: absolute;
  top: -1em;
  left:10em;
  z-index: 1
}

.macro_popup {
  border: 2px solid red;
  background-color:#FFF0F0;
  font-weight: normal;
}

.variable_popup {
  border: 2px solid blue;
  background-color:#F0F0FF;
  font-weight: bold;
  font-family: Helvetica, sans-serif;
  font-size: 9pt;
}

/* Pop-up notes needs a relative position as a base where they pops up. */
.macro, .variable {
  background-color: PaleGoldenRod;
  position: relative;
}
.macro { color: DarkMagenta; }

#tooltiphint {
  position: fixed;
  width: 50em;
  margin-left: -25em;
  left: 50%;
  padding: 10px;
  border: 1px solid #b0b0b0;
  border-radius: 2px;
  box-shadow: 1px 1px 7px black;
  background-color: #c0c0c0;
  z-index: 2;
}

.num { width:2.5em; padding-right:2ex; background-color:#eeeeee }
.num { text-align:right; font-size:8pt }
.num { color:#444444 }
.line { padding-left: 1ex; border-left: 3px solid #ccc }
.line { white-space: pre }
.msg { -webkit-box-shadow:1px 1px 7px #000 }
.msg { box-shadow:1px 1px 7px #000 }
.msg { -webkit-border-radius:5px }
.msg { border-radius:5px }
.msg { font-family:Helvetica, sans-serif; font-size:8pt }
.msg { float:left }
.msg { padding:0.25em 1ex 0.25em 1ex }
.msg { margin-top:10px; margin-bottom:10px }
.msg { font-weight:bold }
.msg { max-width:60em; word-wrap: break-word; white-space: pre-wrap }
.msgT { padding:0x; spacing:0x }
.msgEvent { background-color:#fff8b4; color:#000000 }
.msgControl { background-color:#bbbbbb; color:#000000 }
.msgNote { background-color:#ddeeff; color:#000000 }
.mrange { background-color:#dfddf3 }
.mrange { border-bottom:1px solid #6F9DBE }
.PathIndex { font-weight: bold; padding:0px 5px; margin-right:5px; }
.PathIndex { -webkit-border-radius:8px }
.PathIndex { border-radius:8px }
.PathIndexEvent { background-color:#bfba87 }
.PathIndexControl { background-color:#8c8c8c }
.PathIndexPopUp { background-color: #879abc; }
.PathNav a { text-decoration:none; font-size: larger }
.CodeInsertionHint { font-weight: bold; background-color: #10dd10 }
.CodeRemovalHint { background-color:#de1010 }
.CodeRemovalHint { border-bottom:1px solid #6F9DBE }
.selected{ background-color:orange !important; }

table.simpletable {
  padding: 5px;
  font-size:12pt;
  margin:20px;
  border-collapse: collapse; border-spacing: 0px;
}
td.rowname {
  text-align: right;
  vertical-align: top;
  font-weight: bold;
  color:#444444;
  padding-right:2ex;
}

/* Hidden text. */
input.spoilerhider + label {
  cursor: pointer;
  text-decoration: underline;
  display: block;
}
input.spoilerhider {
 display: none;
}
input.spoilerhider ~ .spoiler {
  overflow: hidden;
  margin: 10px auto 0;
  height: 0;
  opacity: 0;
}
input.spoilerhider:checked + label + .spoiler{
  height: auto;
  opacity: 1;
}
</style>
</head>
<body>
<!-- BUGDESC Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11 -->

<!-- BUGTYPE Potential insecure memory buffer bounds restriction in call 'memcpy' -->

<!-- BUGCATEGORY Security -->

<!-- BUGFILE /tmp/sslab_clang/cpp_node/node/out/../deps/openssl/openssl/ssl/t1_lib.c -->

<!-- FILENAME t1_lib.c -->

<!-- FUNCTIONNAME nid_cb -->

<!-- ISSUEHASHCONTENTOFLINEINCONTEXT 2cb455eb403375abe2e2a663c1fd6778 -->

<!-- BUGLINE 395 -->

<!-- BUGCOLUMN 5 -->

<!-- BUGPATHLENGTH 1 -->

<!-- BUGMETAEND -->
<!-- REPORTHEADER -->
<h3>Bug Summary</h3>
<table class="simpletable">
<tr><td class="rowname">File:</td><td>out/../deps/openssl/openssl/ssl/t1_lib.c</td></tr>
<tr><td class="rowname">Warning:</td><td><a href="#EndPath">line 395, column 5</a><br />Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11</td></tr>

</table>
<!-- REPORTSUMMARYEXTRA -->
<h3>Annotated Source Code</h3>
<p>Press <a href="#" onclick="toggleHelp(); return false;">'?'</a>
   to see keyboard shortcuts</p>
<input type="checkbox" class="spoilerhider" id="showinvocation" />
<label for="showinvocation" >Show analyzer invocation</label>
<div class="spoiler">clang -cc1 -cc1 -triple x86_64-unknown-linux-gnu -analyze -disable-free -main-file-name t1_lib.c -analyzer-store=region -analyzer-opt-analyze-nested-blocks -analyzer-checker=core -analyzer-checker=apiModeling -analyzer-checker=unix -analyzer-checker=deadcode -analyzer-checker=security.insecureAPI.UncheckedReturn -analyzer-checker=security.insecureAPI.getpw -analyzer-checker=security.insecureAPI.gets -analyzer-checker=security.insecureAPI.mktemp -analyzer-checker=security.insecureAPI.mkstemp -analyzer-checker=security.insecureAPI.vfork -analyzer-checker=nullability.NullPassedToNonnull -analyzer-checker=nullability.NullReturnedFromNonnull -analyzer-output plist -w -setup-static-analyzer -mrelocation-model static -mframe-pointer=all -fmath-errno -fno-rounding-math -mconstructor-aliases -munwind-tables -target-cpu x86-64 -fno-split-dwarf-inlining -debugger-tuning=gdb -resource-dir /llvm-project/build/lib/clang/12.0.0 -D V8_DEPRECATION_WARNINGS -D V8_IMMINENT_DEPRECATION_WARNINGS -D __STDC_FORMAT_MACROS -D OPENSSL_NO_PINSHARED -D OPENSSL_THREADS -D OPENSSL_NO_HW -D OPENSSL_NO_QUIC=1 -D NDEBUG -D OPENSSL_USE_NODELETE -D L_ENDIAN -D OPENSSL_PIC -D OPENSSL_CPUID_OBJ -D OPENSSL_IA32_SSE2 -D OPENSSL_BN_ASM_MONT -D OPENSSL_BN_ASM_MONT5 -D OPENSSL_BN_ASM_GF2m -D SHA1_ASM -D SHA256_ASM -D SHA512_ASM -D KECCAK1600_ASM -D RC4_ASM -D MD5_ASM -D AESNI_ASM -D VPAES_ASM -D GHASH_ASM -D ECP_NISTZ256_ASM -D X25519_ASM -D POLY1305_ASM -D OPENSSLDIR="/etc/ssl" -D ENGINESDIR="/dev/null" -D TERMIOS -I ../deps/openssl/openssl -I ../deps/openssl/openssl/include -I ../deps/openssl/openssl/crypto -I ../deps/openssl/openssl/crypto/include -I ../deps/openssl/openssl/crypto/modes -I ../deps/openssl/openssl/crypto/ec/curve448 -I ../deps/openssl/openssl/crypto/ec/curve448/arch_32 -I ../deps/openssl/config -I ../deps/openssl/config/archs/linux-x86_64/asm -I ../deps/openssl/config/archs/linux-x86_64/asm/include -I ../deps/openssl/config/archs/linux-x86_64/asm/crypto -I ../deps/openssl/config/archs/linux-x86_64/asm/crypto/include/internal -internal-isystem /usr/local/include -internal-isystem /llvm-project/build/lib/clang/12.0.0/include -internal-externc-isystem /usr/include/x86_64-linux-gnu -internal-externc-isystem /include -internal-externc-isystem /usr/include -O3 -Wno-unused-parameter -Wno-missing-field-initializers -Wno-old-style-declaration -fdebug-compilation-dir /tmp/sslab_clang/cpp_node/node/out -ferror-limit 19 -fgnuc-version=4.2.1 -vectorize-loops -vectorize-slp -analyzer-checker core -analyzer-checker cplusplus -analyzer-checker nullability -analyzer-checker optin -analyzer-checker security -analyzer-checker unix -analyzer-checker osx -analyzer-checker fuchsia -analyzer-checker webkit -analyzer-output=html -faddrsig -o /tmp/scan-build-2020-11-24-221535-58-1 -x c ../deps/openssl/openssl/ssl/t1_lib.c
</div>
<div id='tooltiphint' hidden="true">
  <p>Keyboard shortcuts: </p>
  <ul>
    <li>Use 'j/k' keys for keyboard navigation</li>
    <li>Use 'Shift+S' to show/hide relevant lines</li>
    <li>Use '?' to toggle this window</li>
  </ul>
  <a href="#" onclick="toggleHelp(); return false;">Close</a>
</div>
<script type='text/javascript'>
var relevant_lines = {"1": {"395": 1}};

var filterCounterexample = function (hide) {
  var tables = document.getElementsByClassName("code");
  for (var t=0; t<tables.length; t++) {
    var table = tables[t];
    var file_id = table.getAttribute("data-fileid");
    var lines_in_fid = relevant_lines[file_id];
    if (!lines_in_fid) {
      lines_in_fid = {};
    }
    var lines = table.getElementsByClassName("codeline");
    for (var i=0; i<lines.length; i++) {
        var el = lines[i];
        var lineNo = el.getAttribute("data-linenumber");
        if (!lines_in_fid[lineNo]) {
          if (hide) {
            el.setAttribute("hidden", "");
          } else {
            el.removeAttribute("hidden");
          }
        }
    }
  }
}

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "S") {
    var checked = document.getElementsByName("showCounterexample")[0].checked;
    filterCounterexample(!checked);
    document.getElementsByName("showCounterexample")[0].checked = !checked;
  } else {
    return;
  }
  event.preventDefault();
}, true);

document.addEventListener("DOMContentLoaded", function() {
    document.querySelector('input[name="showCounterexample"]').onchange=
        function (event) {
      filterCounterexample(this.checked);
    };
});
</script>

<form>
    <input type="checkbox" name="showCounterexample" id="showCounterexample" />
    <label for="showCounterexample">
       Show only relevant lines
    </label>
</form>

<script type='text/javascript'>
var digitMatcher = new RegExp("[0-9]+");

var querySelectorAllArray = function(selector) {
  return Array.prototype.slice.call(
    document.querySelectorAll(selector));
}

document.addEventListener("DOMContentLoaded", function() {
    querySelectorAllArray(".PathNav > a").forEach(
        function(currentValue, currentIndex) {
            var hrefValue = currentValue.getAttribute("href");
            currentValue.onclick = function() {
                scrollTo(document.querySelector(hrefValue));
                return false;
            };
        });
});

var findNum = function() {
    var s = document.querySelector(".selected");
    if (!s || s.id == "EndPath") {
        return 0;
    }
    var out = parseInt(digitMatcher.exec(s.id)[0]);
    return out;
};

var scrollTo = function(el) {
    querySelectorAllArray(".selected").forEach(function(s) {
        s.classList.remove("selected");
    });
    el.classList.add("selected");
    window.scrollBy(0, el.getBoundingClientRect().top -
        (window.innerHeight / 2));
}

var move = function(num, up, numItems) {
  if (num == 1 && up || num == numItems - 1 && !up) {
    return 0;
  } else if (num == 0 && up) {
    return numItems - 1;
  } else if (num == 0 && !up) {
    return 1 % numItems;
  }
  return up ? num - 1 : num + 1;
}

var numToId = function(num) {
  if (num == 0) {
    return document.getElementById("EndPath")
  }
  return document.getElementById("Path" + num);
};

var navigateTo = function(up) {
  var numItems = document.querySelectorAll(
      ".line > .msgEvent, .line > .msgControl").length;
  var currentSelected = findNum();
  var newSelected = move(currentSelected, up, numItems);
  var newEl = numToId(newSelected, numItems);

  // Scroll element into center.
  scrollTo(newEl);
};

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "j") {
    navigateTo(/*up=*/false);
  } else if (event.key == "k") {
    navigateTo(/*up=*/true);
  } else {
    return;
  }
  event.preventDefault();
}, true);
</script>
  
<script type='text/javascript'>

var toggleHelp = function() {
    var hint = document.querySelector("#tooltiphint");
    var attributeName = "hidden";
    if (hint.hasAttribute(attributeName)) {
      hint.removeAttribute(attributeName);
    } else {
      hint.setAttribute("hidden", "true");
    }
};
window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "?") {
    toggleHelp();
  } else {
    return;
  }
  event.preventDefault();
});
</script>
<table class="code" data-fileid="1">
<tr class="codeline" data-linenumber="1"><td class="num" id="LN1">1</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2"><td class="num" id="LN2">2</td><td class="line"> <span class='comment'>* Copyright 1995-2020 The OpenSSL Project Authors. All Rights Reserved.</span></td></tr>
<tr class="codeline" data-linenumber="3"><td class="num" id="LN3">3</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="4"><td class="num" id="LN4">4</td><td class="line"> <span class='comment'>* Licensed under the OpenSSL license (the "License").  You may not use</span></td></tr>
<tr class="codeline" data-linenumber="5"><td class="num" id="LN5">5</td><td class="line"> <span class='comment'>* this file except in compliance with the License.  You can obtain a copy</span></td></tr>
<tr class="codeline" data-linenumber="6"><td class="num" id="LN6">6</td><td class="line"> <span class='comment'>* in the file LICENSE in the source distribution or at</span></td></tr>
<tr class="codeline" data-linenumber="7"><td class="num" id="LN7">7</td><td class="line"> <span class='comment'>* https://www.openssl.org/source/license.html</span></td></tr>
<tr class="codeline" data-linenumber="8"><td class="num" id="LN8">8</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="9"><td class="num" id="LN9">9</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="10"><td class="num" id="LN10">10</td><td class="line"><span class='directive'>#include &lt;stdio.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="11"><td class="num" id="LN11">11</td><td class="line"><span class='directive'>#include &lt;stdlib.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="12"><td class="num" id="LN12">12</td><td class="line"><span class='directive'>#include &lt;openssl/objects.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="13"><td class="num" id="LN13">13</td><td class="line"><span class='directive'>#include &lt;openssl/evp.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="14"><td class="num" id="LN14">14</td><td class="line"><span class='directive'>#include &lt;openssl/hmac.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="15"><td class="num" id="LN15">15</td><td class="line"><span class='directive'>#include &lt;openssl/ocsp.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="16"><td class="num" id="LN16">16</td><td class="line"><span class='directive'>#include &lt;openssl/conf.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="17"><td class="num" id="LN17">17</td><td class="line"><span class='directive'>#include &lt;openssl/x509v3.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="18"><td class="num" id="LN18">18</td><td class="line"><span class='directive'>#include &lt;openssl/dh.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="19"><td class="num" id="LN19">19</td><td class="line"><span class='directive'>#include &lt;openssl/bn.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="20"><td class="num" id="LN20">20</td><td class="line"><span class='directive'>#include "internal/nelem.h"</span></td></tr>
<tr class="codeline" data-linenumber="21"><td class="num" id="LN21">21</td><td class="line"><span class='directive'>#include "ssl_local.h"</span></td></tr>
<tr class="codeline" data-linenumber="22"><td class="num" id="LN22">22</td><td class="line"><span class='directive'>#include &lt;openssl/ct.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="23"><td class="num" id="LN23">23</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="24"><td class="num" id="LN24">24</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> SIGALG_LOOKUP *find_sig_alg(SSL *s, X509 *x, EVP_PKEY *pkey);</td></tr>
<tr class="codeline" data-linenumber="25"><td class="num" id="LN25">25</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls12_sigalg_allowed(<span class='keyword'>const</span> SSL *s, <span class='keyword'>int</span> op, <span class='keyword'>const</span> SIGALG_LOOKUP *lu);</td></tr>
<tr class="codeline" data-linenumber="26"><td class="num" id="LN26">26</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="27"><td class="num" id="LN27">27</td><td class="line">SSL3_ENC_METHOD <span class='keyword'>const</span> TLSv1_enc_data = {</td></tr>
<tr class="codeline" data-linenumber="28"><td class="num" id="LN28">28</td><td class="line">    tls1_enc,</td></tr>
<tr class="codeline" data-linenumber="29"><td class="num" id="LN29">29</td><td class="line">    tls1_mac,</td></tr>
<tr class="codeline" data-linenumber="30"><td class="num" id="LN30">30</td><td class="line">    tls1_setup_key_block,</td></tr>
<tr class="codeline" data-linenumber="31"><td class="num" id="LN31">31</td><td class="line">    tls1_generate_master_secret,</td></tr>
<tr class="codeline" data-linenumber="32"><td class="num" id="LN32">32</td><td class="line">    tls1_change_cipher_state,</td></tr>
<tr class="codeline" data-linenumber="33"><td class="num" id="LN33">33</td><td class="line">    tls1_final_finish_mac,</td></tr>
<tr class="codeline" data-linenumber="34"><td class="num" id="LN34">34</td><td class="line">    <span class='macro'>TLS_MD_CLIENT_FINISH_CONST<span class='macro_popup'>"client finished"</span></span>, <span class='macro'>TLS_MD_CLIENT_FINISH_CONST_SIZE<span class='macro_popup'>15</span></span>,</td></tr>
<tr class="codeline" data-linenumber="35"><td class="num" id="LN35">35</td><td class="line">    <span class='macro'>TLS_MD_SERVER_FINISH_CONST<span class='macro_popup'>"server finished"</span></span>, <span class='macro'>TLS_MD_SERVER_FINISH_CONST_SIZE<span class='macro_popup'>15</span></span>,</td></tr>
<tr class="codeline" data-linenumber="36"><td class="num" id="LN36">36</td><td class="line">    tls1_alert_code,</td></tr>
<tr class="codeline" data-linenumber="37"><td class="num" id="LN37">37</td><td class="line">    tls1_export_keying_material,</td></tr>
<tr class="codeline" data-linenumber="38"><td class="num" id="LN38">38</td><td class="line">    0,</td></tr>
<tr class="codeline" data-linenumber="39"><td class="num" id="LN39">39</td><td class="line">    ssl3_set_handshake_header,</td></tr>
<tr class="codeline" data-linenumber="40"><td class="num" id="LN40">40</td><td class="line">    tls_close_construct_packet,</td></tr>
<tr class="codeline" data-linenumber="41"><td class="num" id="LN41">41</td><td class="line">    ssl3_handshake_write</td></tr>
<tr class="codeline" data-linenumber="42"><td class="num" id="LN42">42</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="43"><td class="num" id="LN43">43</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="44"><td class="num" id="LN44">44</td><td class="line">SSL3_ENC_METHOD <span class='keyword'>const</span> TLSv1_1_enc_data = {</td></tr>
<tr class="codeline" data-linenumber="45"><td class="num" id="LN45">45</td><td class="line">    tls1_enc,</td></tr>
<tr class="codeline" data-linenumber="46"><td class="num" id="LN46">46</td><td class="line">    tls1_mac,</td></tr>
<tr class="codeline" data-linenumber="47"><td class="num" id="LN47">47</td><td class="line">    tls1_setup_key_block,</td></tr>
<tr class="codeline" data-linenumber="48"><td class="num" id="LN48">48</td><td class="line">    tls1_generate_master_secret,</td></tr>
<tr class="codeline" data-linenumber="49"><td class="num" id="LN49">49</td><td class="line">    tls1_change_cipher_state,</td></tr>
<tr class="codeline" data-linenumber="50"><td class="num" id="LN50">50</td><td class="line">    tls1_final_finish_mac,</td></tr>
<tr class="codeline" data-linenumber="51"><td class="num" id="LN51">51</td><td class="line">    <span class='macro'>TLS_MD_CLIENT_FINISH_CONST<span class='macro_popup'>"client finished"</span></span>, <span class='macro'>TLS_MD_CLIENT_FINISH_CONST_SIZE<span class='macro_popup'>15</span></span>,</td></tr>
<tr class="codeline" data-linenumber="52"><td class="num" id="LN52">52</td><td class="line">    <span class='macro'>TLS_MD_SERVER_FINISH_CONST<span class='macro_popup'>"server finished"</span></span>, <span class='macro'>TLS_MD_SERVER_FINISH_CONST_SIZE<span class='macro_popup'>15</span></span>,</td></tr>
<tr class="codeline" data-linenumber="53"><td class="num" id="LN53">53</td><td class="line">    tls1_alert_code,</td></tr>
<tr class="codeline" data-linenumber="54"><td class="num" id="LN54">54</td><td class="line">    tls1_export_keying_material,</td></tr>
<tr class="codeline" data-linenumber="55"><td class="num" id="LN55">55</td><td class="line">    <span class='macro'>SSL_ENC_FLAG_EXPLICIT_IV<span class='macro_popup'>0x1</span></span>,</td></tr>
<tr class="codeline" data-linenumber="56"><td class="num" id="LN56">56</td><td class="line">    ssl3_set_handshake_header,</td></tr>
<tr class="codeline" data-linenumber="57"><td class="num" id="LN57">57</td><td class="line">    tls_close_construct_packet,</td></tr>
<tr class="codeline" data-linenumber="58"><td class="num" id="LN58">58</td><td class="line">    ssl3_handshake_write</td></tr>
<tr class="codeline" data-linenumber="59"><td class="num" id="LN59">59</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="60"><td class="num" id="LN60">60</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="61"><td class="num" id="LN61">61</td><td class="line">SSL3_ENC_METHOD <span class='keyword'>const</span> TLSv1_2_enc_data = {</td></tr>
<tr class="codeline" data-linenumber="62"><td class="num" id="LN62">62</td><td class="line">    tls1_enc,</td></tr>
<tr class="codeline" data-linenumber="63"><td class="num" id="LN63">63</td><td class="line">    tls1_mac,</td></tr>
<tr class="codeline" data-linenumber="64"><td class="num" id="LN64">64</td><td class="line">    tls1_setup_key_block,</td></tr>
<tr class="codeline" data-linenumber="65"><td class="num" id="LN65">65</td><td class="line">    tls1_generate_master_secret,</td></tr>
<tr class="codeline" data-linenumber="66"><td class="num" id="LN66">66</td><td class="line">    tls1_change_cipher_state,</td></tr>
<tr class="codeline" data-linenumber="67"><td class="num" id="LN67">67</td><td class="line">    tls1_final_finish_mac,</td></tr>
<tr class="codeline" data-linenumber="68"><td class="num" id="LN68">68</td><td class="line">    <span class='macro'>TLS_MD_CLIENT_FINISH_CONST<span class='macro_popup'>"client finished"</span></span>, <span class='macro'>TLS_MD_CLIENT_FINISH_CONST_SIZE<span class='macro_popup'>15</span></span>,</td></tr>
<tr class="codeline" data-linenumber="69"><td class="num" id="LN69">69</td><td class="line">    <span class='macro'>TLS_MD_SERVER_FINISH_CONST<span class='macro_popup'>"server finished"</span></span>, <span class='macro'>TLS_MD_SERVER_FINISH_CONST_SIZE<span class='macro_popup'>15</span></span>,</td></tr>
<tr class="codeline" data-linenumber="70"><td class="num" id="LN70">70</td><td class="line">    tls1_alert_code,</td></tr>
<tr class="codeline" data-linenumber="71"><td class="num" id="LN71">71</td><td class="line">    tls1_export_keying_material,</td></tr>
<tr class="codeline" data-linenumber="72"><td class="num" id="LN72">72</td><td class="line">    <span class='macro'>SSL_ENC_FLAG_EXPLICIT_IV<span class='macro_popup'>0x1</span></span> | <span class='macro'>SSL_ENC_FLAG_SIGALGS<span class='macro_popup'>0x2</span></span> | <span class='macro'>SSL_ENC_FLAG_SHA256_PRF<span class='macro_popup'>0x4</span></span></td></tr>
<tr class="codeline" data-linenumber="73"><td class="num" id="LN73">73</td><td class="line">        | <span class='macro'>SSL_ENC_FLAG_TLS1_2_CIPHERS<span class='macro_popup'>0x10</span></span>,</td></tr>
<tr class="codeline" data-linenumber="74"><td class="num" id="LN74">74</td><td class="line">    ssl3_set_handshake_header,</td></tr>
<tr class="codeline" data-linenumber="75"><td class="num" id="LN75">75</td><td class="line">    tls_close_construct_packet,</td></tr>
<tr class="codeline" data-linenumber="76"><td class="num" id="LN76">76</td><td class="line">    ssl3_handshake_write</td></tr>
<tr class="codeline" data-linenumber="77"><td class="num" id="LN77">77</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="78"><td class="num" id="LN78">78</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="79"><td class="num" id="LN79">79</td><td class="line">SSL3_ENC_METHOD <span class='keyword'>const</span> TLSv1_3_enc_data = {</td></tr>
<tr class="codeline" data-linenumber="80"><td class="num" id="LN80">80</td><td class="line">    tls13_enc,</td></tr>
<tr class="codeline" data-linenumber="81"><td class="num" id="LN81">81</td><td class="line">    tls1_mac,</td></tr>
<tr class="codeline" data-linenumber="82"><td class="num" id="LN82">82</td><td class="line">    tls13_setup_key_block,</td></tr>
<tr class="codeline" data-linenumber="83"><td class="num" id="LN83">83</td><td class="line">    tls13_generate_master_secret,</td></tr>
<tr class="codeline" data-linenumber="84"><td class="num" id="LN84">84</td><td class="line">    tls13_change_cipher_state,</td></tr>
<tr class="codeline" data-linenumber="85"><td class="num" id="LN85">85</td><td class="line">    tls13_final_finish_mac,</td></tr>
<tr class="codeline" data-linenumber="86"><td class="num" id="LN86">86</td><td class="line">    <span class='macro'>TLS_MD_CLIENT_FINISH_CONST<span class='macro_popup'>"client finished"</span></span>, <span class='macro'>TLS_MD_CLIENT_FINISH_CONST_SIZE<span class='macro_popup'>15</span></span>,</td></tr>
<tr class="codeline" data-linenumber="87"><td class="num" id="LN87">87</td><td class="line">    <span class='macro'>TLS_MD_SERVER_FINISH_CONST<span class='macro_popup'>"server finished"</span></span>, <span class='macro'>TLS_MD_SERVER_FINISH_CONST_SIZE<span class='macro_popup'>15</span></span>,</td></tr>
<tr class="codeline" data-linenumber="88"><td class="num" id="LN88">88</td><td class="line">    tls13_alert_code,</td></tr>
<tr class="codeline" data-linenumber="89"><td class="num" id="LN89">89</td><td class="line">    tls13_export_keying_material,</td></tr>
<tr class="codeline" data-linenumber="90"><td class="num" id="LN90">90</td><td class="line">    <span class='macro'>SSL_ENC_FLAG_SIGALGS<span class='macro_popup'>0x2</span></span> | <span class='macro'>SSL_ENC_FLAG_SHA256_PRF<span class='macro_popup'>0x4</span></span>,</td></tr>
<tr class="codeline" data-linenumber="91"><td class="num" id="LN91">91</td><td class="line">    ssl3_set_handshake_header,</td></tr>
<tr class="codeline" data-linenumber="92"><td class="num" id="LN92">92</td><td class="line">    tls_close_construct_packet,</td></tr>
<tr class="codeline" data-linenumber="93"><td class="num" id="LN93">93</td><td class="line">    ssl3_handshake_write</td></tr>
<tr class="codeline" data-linenumber="94"><td class="num" id="LN94">94</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="95"><td class="num" id="LN95">95</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="96"><td class="num" id="LN96">96</td><td class="line"><span class='keyword'>long</span> tls1_default_timeout(<span class='keyword'>void</span>)</td></tr>
<tr class="codeline" data-linenumber="97"><td class="num" id="LN97">97</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="98"><td class="num" id="LN98">98</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="99"><td class="num" id="LN99">99</td><td class="line">     <span class='comment'>* 2 hours, the 24 hours mentioned in the TLSv1 spec is way too long for</span></td></tr>
<tr class="codeline" data-linenumber="100"><td class="num" id="LN100">100</td><td class="line">     <span class='comment'>* http, the cache would over fill</span></td></tr>
<tr class="codeline" data-linenumber="101"><td class="num" id="LN101">101</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="102"><td class="num" id="LN102">102</td><td class="line">    <span class='keyword'>return</span> (60 * 60 * 2);</td></tr>
<tr class="codeline" data-linenumber="103"><td class="num" id="LN103">103</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="104"><td class="num" id="LN104">104</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="105"><td class="num" id="LN105">105</td><td class="line"><span class='keyword'>int</span> tls1_new(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="106"><td class="num" id="LN106">106</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="107"><td class="num" id="LN107">107</td><td class="line">    <span class='keyword'>if</span> (!ssl3_new(s))</td></tr>
<tr class="codeline" data-linenumber="108"><td class="num" id="LN108">108</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="109"><td class="num" id="LN109">109</td><td class="line">    <span class='keyword'>if</span> (!s-&gt;method-&gt;ssl_clear(s))</td></tr>
<tr class="codeline" data-linenumber="110"><td class="num" id="LN110">110</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="111"><td class="num" id="LN111">111</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="112"><td class="num" id="LN112">112</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="113"><td class="num" id="LN113">113</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="114"><td class="num" id="LN114">114</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="115"><td class="num" id="LN115">115</td><td class="line"><span class='keyword'>void</span> tls1_free(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="116"><td class="num" id="LN116">116</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="117"><td class="num" id="LN117">117</td><td class="line">    <span class='macro'>OPENSSL_free(s-&gt;ext.session_ticket)<span class='macro_popup'>CRYPTO_free(s-&gt;ext.session_ticket, "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 117)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="118"><td class="num" id="LN118">118</td><td class="line">    ssl3_free(s);</td></tr>
<tr class="codeline" data-linenumber="119"><td class="num" id="LN119">119</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="120"><td class="num" id="LN120">120</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="121"><td class="num" id="LN121">121</td><td class="line"><span class='keyword'>int</span> tls1_clear(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="122"><td class="num" id="LN122">122</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="123"><td class="num" id="LN123">123</td><td class="line">    <span class='keyword'>if</span> (!ssl3_clear(s))</td></tr>
<tr class="codeline" data-linenumber="124"><td class="num" id="LN124">124</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="125"><td class="num" id="LN125">125</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="126"><td class="num" id="LN126">126</td><td class="line">    <span class='keyword'>if</span> (s-&gt;method-&gt;version == <span class='macro'>TLS_ANY_VERSION<span class='macro_popup'>0x10000</span></span>)</td></tr>
<tr class="codeline" data-linenumber="127"><td class="num" id="LN127">127</td><td class="line">        s-&gt;version = <span class='macro'>TLS_MAX_VERSION<span class='macro_popup'>0x0304</span></span>;</td></tr>
<tr class="codeline" data-linenumber="128"><td class="num" id="LN128">128</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="129"><td class="num" id="LN129">129</td><td class="line">        s-&gt;version = s-&gt;method-&gt;version;</td></tr>
<tr class="codeline" data-linenumber="130"><td class="num" id="LN130">130</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="131"><td class="num" id="LN131">131</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="132"><td class="num" id="LN132">132</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="133"><td class="num" id="LN133">133</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="134"><td class="num" id="LN134">134</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="135"><td class="num" id="LN135">135</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="136"><td class="num" id="LN136">136</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="137"><td class="num" id="LN137">137</td><td class="line"> <span class='comment'>* Table of curve information.</span></td></tr>
<tr class="codeline" data-linenumber="138"><td class="num" id="LN138">138</td><td class="line"> <span class='comment'>* Do not delete entries or reorder this array! It is used as a lookup</span></td></tr>
<tr class="codeline" data-linenumber="139"><td class="num" id="LN139">139</td><td class="line"> <span class='comment'>* table: the index of each entry is one less than the TLS curve id.</span></td></tr>
<tr class="codeline" data-linenumber="140"><td class="num" id="LN140">140</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="141"><td class="num" id="LN141">141</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> TLS_GROUP_INFO nid_list[] = {</td></tr>
<tr class="codeline" data-linenumber="142"><td class="num" id="LN142">142</td><td class="line">    {<span class='macro'>NID_sect163k1<span class='macro_popup'>721</span></span>, 80, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect163k1 (1) */</span></td></tr>
<tr class="codeline" data-linenumber="143"><td class="num" id="LN143">143</td><td class="line">    {<span class='macro'>NID_sect163r1<span class='macro_popup'>722</span></span>, 80, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect163r1 (2) */</span></td></tr>
<tr class="codeline" data-linenumber="144"><td class="num" id="LN144">144</td><td class="line">    {<span class='macro'>NID_sect163r2<span class='macro_popup'>723</span></span>, 80, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect163r2 (3) */</span></td></tr>
<tr class="codeline" data-linenumber="145"><td class="num" id="LN145">145</td><td class="line">    {<span class='macro'>NID_sect193r1<span class='macro_popup'>724</span></span>, 80, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect193r1 (4) */</span></td></tr>
<tr class="codeline" data-linenumber="146"><td class="num" id="LN146">146</td><td class="line">    {<span class='macro'>NID_sect193r2<span class='macro_popup'>725</span></span>, 80, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect193r2 (5) */</span></td></tr>
<tr class="codeline" data-linenumber="147"><td class="num" id="LN147">147</td><td class="line">    {<span class='macro'>NID_sect233k1<span class='macro_popup'>726</span></span>, 112, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect233k1 (6) */</span></td></tr>
<tr class="codeline" data-linenumber="148"><td class="num" id="LN148">148</td><td class="line">    {<span class='macro'>NID_sect233r1<span class='macro_popup'>727</span></span>, 112, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect233r1 (7) */</span></td></tr>
<tr class="codeline" data-linenumber="149"><td class="num" id="LN149">149</td><td class="line">    {<span class='macro'>NID_sect239k1<span class='macro_popup'>728</span></span>, 112, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect239k1 (8) */</span></td></tr>
<tr class="codeline" data-linenumber="150"><td class="num" id="LN150">150</td><td class="line">    {<span class='macro'>NID_sect283k1<span class='macro_popup'>729</span></span>, 128, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect283k1 (9) */</span></td></tr>
<tr class="codeline" data-linenumber="151"><td class="num" id="LN151">151</td><td class="line">    {<span class='macro'>NID_sect283r1<span class='macro_popup'>730</span></span>, 128, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect283r1 (10) */</span></td></tr>
<tr class="codeline" data-linenumber="152"><td class="num" id="LN152">152</td><td class="line">    {<span class='macro'>NID_sect409k1<span class='macro_popup'>731</span></span>, 192, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect409k1 (11) */</span></td></tr>
<tr class="codeline" data-linenumber="153"><td class="num" id="LN153">153</td><td class="line">    {<span class='macro'>NID_sect409r1<span class='macro_popup'>732</span></span>, 192, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect409r1 (12) */</span></td></tr>
<tr class="codeline" data-linenumber="154"><td class="num" id="LN154">154</td><td class="line">    {<span class='macro'>NID_sect571k1<span class='macro_popup'>733</span></span>, 256, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect571k1 (13) */</span></td></tr>
<tr class="codeline" data-linenumber="155"><td class="num" id="LN155">155</td><td class="line">    {<span class='macro'>NID_sect571r1<span class='macro_popup'>734</span></span>, 256, <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>}, <span class='comment'>/* sect571r1 (14) */</span></td></tr>
<tr class="codeline" data-linenumber="156"><td class="num" id="LN156">156</td><td class="line">    {<span class='macro'>NID_secp160k1<span class='macro_popup'>708</span></span>, 80, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* secp160k1 (15) */</span></td></tr>
<tr class="codeline" data-linenumber="157"><td class="num" id="LN157">157</td><td class="line">    {<span class='macro'>NID_secp160r1<span class='macro_popup'>709</span></span>, 80, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* secp160r1 (16) */</span></td></tr>
<tr class="codeline" data-linenumber="158"><td class="num" id="LN158">158</td><td class="line">    {<span class='macro'>NID_secp160r2<span class='macro_popup'>710</span></span>, 80, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* secp160r2 (17) */</span></td></tr>
<tr class="codeline" data-linenumber="159"><td class="num" id="LN159">159</td><td class="line">    {<span class='macro'>NID_secp192k1<span class='macro_popup'>711</span></span>, 80, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* secp192k1 (18) */</span></td></tr>
<tr class="codeline" data-linenumber="160"><td class="num" id="LN160">160</td><td class="line">    {<span class='macro'>NID_X9_62_prime192v1<span class='macro_popup'>409</span></span>, 80, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* secp192r1 (19) */</span></td></tr>
<tr class="codeline" data-linenumber="161"><td class="num" id="LN161">161</td><td class="line">    {<span class='macro'>NID_secp224k1<span class='macro_popup'>712</span></span>, 112, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* secp224k1 (20) */</span></td></tr>
<tr class="codeline" data-linenumber="162"><td class="num" id="LN162">162</td><td class="line">    {<span class='macro'>NID_secp224r1<span class='macro_popup'>713</span></span>, 112, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* secp224r1 (21) */</span></td></tr>
<tr class="codeline" data-linenumber="163"><td class="num" id="LN163">163</td><td class="line">    {<span class='macro'>NID_secp256k1<span class='macro_popup'>714</span></span>, 128, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* secp256k1 (22) */</span></td></tr>
<tr class="codeline" data-linenumber="164"><td class="num" id="LN164">164</td><td class="line">    {<span class='macro'>NID_X9_62_prime256v1<span class='macro_popup'>415</span></span>, 128, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* secp256r1 (23) */</span></td></tr>
<tr class="codeline" data-linenumber="165"><td class="num" id="LN165">165</td><td class="line">    {<span class='macro'>NID_secp384r1<span class='macro_popup'>715</span></span>, 192, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* secp384r1 (24) */</span></td></tr>
<tr class="codeline" data-linenumber="166"><td class="num" id="LN166">166</td><td class="line">    {<span class='macro'>NID_secp521r1<span class='macro_popup'>716</span></span>, 256, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* secp521r1 (25) */</span></td></tr>
<tr class="codeline" data-linenumber="167"><td class="num" id="LN167">167</td><td class="line">    {<span class='macro'>NID_brainpoolP256r1<span class='macro_popup'>927</span></span>, 128, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* brainpoolP256r1 (26) */</span></td></tr>
<tr class="codeline" data-linenumber="168"><td class="num" id="LN168">168</td><td class="line">    {<span class='macro'>NID_brainpoolP384r1<span class='macro_popup'>931</span></span>, 192, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* brainpoolP384r1 (27) */</span></td></tr>
<tr class="codeline" data-linenumber="169"><td class="num" id="LN169">169</td><td class="line">    {<span class='macro'>NID_brainpoolP512r1<span class='macro_popup'>933</span></span>, 256, <span class='macro'>TLS_CURVE_PRIME<span class='macro_popup'>0x0</span></span>}, <span class='comment'>/* brainpool512r1 (28) */</span></td></tr>
<tr class="codeline" data-linenumber="170"><td class="num" id="LN170">170</td><td class="line">    {<span class='macro'>EVP_PKEY_X25519<span class='macro_popup'>1034</span></span>, 128, <span class='macro'>TLS_CURVE_CUSTOM<span class='macro_popup'>0x2</span></span>}, <span class='comment'>/* X25519 (29) */</span></td></tr>
<tr class="codeline" data-linenumber="171"><td class="num" id="LN171">171</td><td class="line">    {<span class='macro'>EVP_PKEY_X448<span class='macro_popup'>1035</span></span>, 224, <span class='macro'>TLS_CURVE_CUSTOM<span class='macro_popup'>0x2</span></span>}, <span class='comment'>/* X448 (30) */</span></td></tr>
<tr class="codeline" data-linenumber="172"><td class="num" id="LN172">172</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="173"><td class="num" id="LN173">173</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="174"><td class="num" id="LN174">174</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> ecformats_default[] = {</td></tr>
<tr class="codeline" data-linenumber="175"><td class="num" id="LN175">175</td><td class="line">    <span class='macro'>TLSEXT_ECPOINTFORMAT_uncompressed<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="176"><td class="num" id="LN176">176</td><td class="line">    <span class='macro'>TLSEXT_ECPOINTFORMAT_ansiX962_compressed_prime<span class='macro_popup'>1</span></span>,</td></tr>
<tr class="codeline" data-linenumber="177"><td class="num" id="LN177">177</td><td class="line">    <span class='macro'>TLSEXT_ECPOINTFORMAT_ansiX962_compressed_char2<span class='macro_popup'>2</span></span></td></tr>
<tr class="codeline" data-linenumber="178"><td class="num" id="LN178">178</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="179"><td class="num" id="LN179">179</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="180"><td class="num" id="LN180">180</td><td class="line"><span class='comment'>/* The default curves */</span></td></tr>
<tr class="codeline" data-linenumber="181"><td class="num" id="LN181">181</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> uint16_t eccurves_default[] = {</td></tr>
<tr class="codeline" data-linenumber="182"><td class="num" id="LN182">182</td><td class="line">    29,                      <span class='comment'>/* X25519 (29) */</span></td></tr>
<tr class="codeline" data-linenumber="183"><td class="num" id="LN183">183</td><td class="line">    23,                      <span class='comment'>/* secp256r1 (23) */</span></td></tr>
<tr class="codeline" data-linenumber="184"><td class="num" id="LN184">184</td><td class="line">    30,                      <span class='comment'>/* X448 (30) */</span></td></tr>
<tr class="codeline" data-linenumber="185"><td class="num" id="LN185">185</td><td class="line">    25,                      <span class='comment'>/* secp521r1 (25) */</span></td></tr>
<tr class="codeline" data-linenumber="186"><td class="num" id="LN186">186</td><td class="line">    24,                      <span class='comment'>/* secp384r1 (24) */</span></td></tr>
<tr class="codeline" data-linenumber="187"><td class="num" id="LN187">187</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="188"><td class="num" id="LN188">188</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="189"><td class="num" id="LN189">189</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> uint16_t suiteb_curves[] = {</td></tr>
<tr class="codeline" data-linenumber="190"><td class="num" id="LN190">190</td><td class="line">    <span class='macro'>TLSEXT_curve_P_256<span class='macro_popup'>23</span></span>,</td></tr>
<tr class="codeline" data-linenumber="191"><td class="num" id="LN191">191</td><td class="line">    <span class='macro'>TLSEXT_curve_P_384<span class='macro_popup'>24</span></span></td></tr>
<tr class="codeline" data-linenumber="192"><td class="num" id="LN192">192</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="193"><td class="num" id="LN193">193</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="194"><td class="num" id="LN194">194</td><td class="line"><span class='keyword'>const</span> TLS_GROUP_INFO *tls1_group_id_lookup(uint16_t group_id)</td></tr>
<tr class="codeline" data-linenumber="195"><td class="num" id="LN195">195</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="196"><td class="num" id="LN196">196</td><td class="line">    <span class='comment'>/* ECC curves from RFC 4492 and RFC 7027 */</span></td></tr>
<tr class="codeline" data-linenumber="197"><td class="num" id="LN197">197</td><td class="line">    <span class='keyword'>if</span> (group_id &lt; 1 || group_id &gt; <span class='macro'>OSSL_NELEM(nid_list)<span class='macro_popup'>(sizeof(nid_list)/sizeof((nid_list)[0]))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="198"><td class="num" id="LN198">198</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="199"><td class="num" id="LN199">199</td><td class="line">    <span class='keyword'>return</span> &amp;nid_list[group_id - 1];</td></tr>
<tr class="codeline" data-linenumber="200"><td class="num" id="LN200">200</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="201"><td class="num" id="LN201">201</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="202"><td class="num" id="LN202">202</td><td class="line"><span class='keyword'>static</span> uint16_t tls1_nid2group_id(<span class='keyword'>int</span> nid)</td></tr>
<tr class="codeline" data-linenumber="203"><td class="num" id="LN203">203</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="204"><td class="num" id="LN204">204</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="205"><td class="num" id="LN205">205</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; <span class='macro'>OSSL_NELEM(nid_list)<span class='macro_popup'>(sizeof(nid_list)/sizeof((nid_list)[0]))</span></span>; i++) {</td></tr>
<tr class="codeline" data-linenumber="206"><td class="num" id="LN206">206</td><td class="line">        <span class='keyword'>if</span> (nid_list[i].nid == nid)</td></tr>
<tr class="codeline" data-linenumber="207"><td class="num" id="LN207">207</td><td class="line">            <span class='keyword'>return</span> (uint16_t)(i + 1);</td></tr>
<tr class="codeline" data-linenumber="208"><td class="num" id="LN208">208</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="209"><td class="num" id="LN209">209</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="210"><td class="num" id="LN210">210</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="211"><td class="num" id="LN211">211</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="212"><td class="num" id="LN212">212</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="213"><td class="num" id="LN213">213</td><td class="line"> <span class='comment'>* Set *pgroups to the supported groups list and *pgroupslen to</span></td></tr>
<tr class="codeline" data-linenumber="214"><td class="num" id="LN214">214</td><td class="line"> <span class='comment'>* the number of groups supported.</span></td></tr>
<tr class="codeline" data-linenumber="215"><td class="num" id="LN215">215</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="216"><td class="num" id="LN216">216</td><td class="line"><span class='keyword'>void</span> tls1_get_supported_groups(SSL *s, <span class='keyword'>const</span> uint16_t **pgroups,</td></tr>
<tr class="codeline" data-linenumber="217"><td class="num" id="LN217">217</td><td class="line">                               size_t *pgroupslen)</td></tr>
<tr class="codeline" data-linenumber="218"><td class="num" id="LN218">218</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="219"><td class="num" id="LN219">219</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="220"><td class="num" id="LN220">220</td><td class="line">    <span class='comment'>/* For Suite B mode only include P-256, P-384 */</span></td></tr>
<tr class="codeline" data-linenumber="221"><td class="num" id="LN221">221</td><td class="line">    <span class='keyword'>switch</span> (<span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="222"><td class="num" id="LN222">222</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>SSL_CERT_FLAG_SUITEB_128_LOS<span class='macro_popup'>0x30000</span></span>:</td></tr>
<tr class="codeline" data-linenumber="223"><td class="num" id="LN223">223</td><td class="line">        *pgroups = suiteb_curves;</td></tr>
<tr class="codeline" data-linenumber="224"><td class="num" id="LN224">224</td><td class="line">        *pgroupslen = <span class='macro'>OSSL_NELEM(suiteb_curves)<span class='macro_popup'>(sizeof(suiteb_curves)/sizeof((suiteb_curves)[0]))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="225"><td class="num" id="LN225">225</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="226"><td class="num" id="LN226">226</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="227"><td class="num" id="LN227">227</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>SSL_CERT_FLAG_SUITEB_128_LOS_ONLY<span class='macro_popup'>0x10000</span></span>:</td></tr>
<tr class="codeline" data-linenumber="228"><td class="num" id="LN228">228</td><td class="line">        *pgroups = suiteb_curves;</td></tr>
<tr class="codeline" data-linenumber="229"><td class="num" id="LN229">229</td><td class="line">        *pgroupslen = 1;</td></tr>
<tr class="codeline" data-linenumber="230"><td class="num" id="LN230">230</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="231"><td class="num" id="LN231">231</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="232"><td class="num" id="LN232">232</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>SSL_CERT_FLAG_SUITEB_192_LOS<span class='macro_popup'>0x20000</span></span>:</td></tr>
<tr class="codeline" data-linenumber="233"><td class="num" id="LN233">233</td><td class="line">        *pgroups = suiteb_curves + 1;</td></tr>
<tr class="codeline" data-linenumber="234"><td class="num" id="LN234">234</td><td class="line">        *pgroupslen = 1;</td></tr>
<tr class="codeline" data-linenumber="235"><td class="num" id="LN235">235</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="236"><td class="num" id="LN236">236</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="237"><td class="num" id="LN237">237</td><td class="line">    <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="238"><td class="num" id="LN238">238</td><td class="line">        <span class='keyword'>if</span> (s-&gt;ext.supportedgroups == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="239"><td class="num" id="LN239">239</td><td class="line">            *pgroups = eccurves_default;</td></tr>
<tr class="codeline" data-linenumber="240"><td class="num" id="LN240">240</td><td class="line">            *pgroupslen = <span class='macro'>OSSL_NELEM(eccurves_default)<span class='macro_popup'>(sizeof(eccurves_default)/sizeof((eccurves_default)[0]))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="241"><td class="num" id="LN241">241</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="242"><td class="num" id="LN242">242</td><td class="line">            *pgroups = s-&gt;ext.supportedgroups;</td></tr>
<tr class="codeline" data-linenumber="243"><td class="num" id="LN243">243</td><td class="line">            *pgroupslen = s-&gt;ext.supportedgroups_len;</td></tr>
<tr class="codeline" data-linenumber="244"><td class="num" id="LN244">244</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="245"><td class="num" id="LN245">245</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="246"><td class="num" id="LN246">246</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="247"><td class="num" id="LN247">247</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="248"><td class="num" id="LN248">248</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="249"><td class="num" id="LN249">249</td><td class="line"><span class='comment'>/* See if curve is allowed by security callback */</span></td></tr>
<tr class="codeline" data-linenumber="250"><td class="num" id="LN250">250</td><td class="line"><span class='keyword'>int</span> tls_curve_allowed(SSL *s, uint16_t curve, <span class='keyword'>int</span> op)</td></tr>
<tr class="codeline" data-linenumber="251"><td class="num" id="LN251">251</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="252"><td class="num" id="LN252">252</td><td class="line">    <span class='keyword'>const</span> TLS_GROUP_INFO *cinfo = tls1_group_id_lookup(curve);</td></tr>
<tr class="codeline" data-linenumber="253"><td class="num" id="LN253">253</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> ctmp[2];</td></tr>
<tr class="codeline" data-linenumber="254"><td class="num" id="LN254">254</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="255"><td class="num" id="LN255">255</td><td class="line">    <span class='keyword'>if</span> (cinfo == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="256"><td class="num" id="LN256">256</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="257"><td class="num" id="LN257">257</td><td class="line"><span class='directive'># ifdef OPENSSL_NO_EC2M</span></td></tr>
<tr class="codeline" data-linenumber="258"><td class="num" id="LN258">258</td><td class="line">    <span class='keyword'>if</span> (cinfo-&gt;flags &amp; <span class='macro'>TLS_CURVE_CHAR2<span class='macro_popup'>0x1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="259"><td class="num" id="LN259">259</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="260"><td class="num" id="LN260">260</td><td class="line"><span class='directive'># endif</span></td></tr>
<tr class="codeline" data-linenumber="261"><td class="num" id="LN261">261</td><td class="line">    ctmp[0] = curve &gt;&gt; 8;</td></tr>
<tr class="codeline" data-linenumber="262"><td class="num" id="LN262">262</td><td class="line">    ctmp[1] = curve &amp; 0xff;</td></tr>
<tr class="codeline" data-linenumber="263"><td class="num" id="LN263">263</td><td class="line">    <span class='keyword'>return</span> ssl_security(s, op, cinfo-&gt;secbits, cinfo-&gt;nid, (<span class='keyword'>void</span> *)ctmp);</td></tr>
<tr class="codeline" data-linenumber="264"><td class="num" id="LN264">264</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="265"><td class="num" id="LN265">265</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="266"><td class="num" id="LN266">266</td><td class="line"><span class='comment'>/* Return 1 if "id" is in "list" */</span></td></tr>
<tr class="codeline" data-linenumber="267"><td class="num" id="LN267">267</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls1_in_list(uint16_t id, <span class='keyword'>const</span> uint16_t *list, size_t listlen)</td></tr>
<tr class="codeline" data-linenumber="268"><td class="num" id="LN268">268</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="269"><td class="num" id="LN269">269</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="270"><td class="num" id="LN270">270</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; listlen; i++)</td></tr>
<tr class="codeline" data-linenumber="271"><td class="num" id="LN271">271</td><td class="line">        <span class='keyword'>if</span> (list[i] == id)</td></tr>
<tr class="codeline" data-linenumber="272"><td class="num" id="LN272">272</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="273"><td class="num" id="LN273">273</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="274"><td class="num" id="LN274">274</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="275"><td class="num" id="LN275">275</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="276"><td class="num" id="LN276">276</td><td class="line"><span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="277"><td class="num" id="LN277">277</td><td class="line"> <span class='comment'>* For nmatch &gt;= 0, return the id of the |nmatch|th shared group or 0</span></td></tr>
<tr class="codeline" data-linenumber="278"><td class="num" id="LN278">278</td><td class="line"> <span class='comment'>* if there is no match.</span></td></tr>
<tr class="codeline" data-linenumber="279"><td class="num" id="LN279">279</td><td class="line"> <span class='comment'>* For nmatch == -1, return number of matches</span></td></tr>
<tr class="codeline" data-linenumber="280"><td class="num" id="LN280">280</td><td class="line"> <span class='comment'>* For nmatch == -2, return the id of the group to use for</span></td></tr>
<tr class="codeline" data-linenumber="281"><td class="num" id="LN281">281</td><td class="line"> <span class='comment'>* a tmp key, or 0 if there is no match.</span></td></tr>
<tr class="codeline" data-linenumber="282"><td class="num" id="LN282">282</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="283"><td class="num" id="LN283">283</td><td class="line">uint16_t tls1_shared_group(SSL *s, <span class='keyword'>int</span> nmatch)</td></tr>
<tr class="codeline" data-linenumber="284"><td class="num" id="LN284">284</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="285"><td class="num" id="LN285">285</td><td class="line">    <span class='keyword'>const</span> uint16_t *pref, *supp;</td></tr>
<tr class="codeline" data-linenumber="286"><td class="num" id="LN286">286</td><td class="line">    size_t num_pref, num_supp, i;</td></tr>
<tr class="codeline" data-linenumber="287"><td class="num" id="LN287">287</td><td class="line">    <span class='keyword'>int</span> k;</td></tr>
<tr class="codeline" data-linenumber="288"><td class="num" id="LN288">288</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="289"><td class="num" id="LN289">289</td><td class="line">    <span class='comment'>/* Can't do anything on client side */</span></td></tr>
<tr class="codeline" data-linenumber="290"><td class="num" id="LN290">290</td><td class="line">    <span class='keyword'>if</span> (s-&gt;server == 0)</td></tr>
<tr class="codeline" data-linenumber="291"><td class="num" id="LN291">291</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="292"><td class="num" id="LN292">292</td><td class="line">    <span class='keyword'>if</span> (nmatch == -2) {</td></tr>
<tr class="codeline" data-linenumber="293"><td class="num" id="LN293">293</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="294"><td class="num" id="LN294">294</td><td class="line">            <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="295"><td class="num" id="LN295">295</td><td class="line">             <span class='comment'>* For Suite B ciphersuite determines curve: we already know</span></td></tr>
<tr class="codeline" data-linenumber="296"><td class="num" id="LN296">296</td><td class="line">             <span class='comment'>* these are acceptable due to previous checks.</span></td></tr>
<tr class="codeline" data-linenumber="297"><td class="num" id="LN297">297</td><td class="line">             <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="298"><td class="num" id="LN298">298</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>long</span> cid = s-&gt;s3-&gt;tmp.new_cipher-&gt;id;</td></tr>
<tr class="codeline" data-linenumber="299"><td class="num" id="LN299">299</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="300"><td class="num" id="LN300">300</td><td class="line">            <span class='keyword'>if</span> (cid == <span class='macro'>TLS1_CK_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256<span class='macro_popup'>0x0300C02B</span></span>)</td></tr>
<tr class="codeline" data-linenumber="301"><td class="num" id="LN301">301</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>TLSEXT_curve_P_256<span class='macro_popup'>23</span></span>;</td></tr>
<tr class="codeline" data-linenumber="302"><td class="num" id="LN302">302</td><td class="line">            <span class='keyword'>if</span> (cid == <span class='macro'>TLS1_CK_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384<span class='macro_popup'>0x0300C02C</span></span>)</td></tr>
<tr class="codeline" data-linenumber="303"><td class="num" id="LN303">303</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>TLSEXT_curve_P_384<span class='macro_popup'>24</span></span>;</td></tr>
<tr class="codeline" data-linenumber="304"><td class="num" id="LN304">304</td><td class="line">            <span class='comment'>/* Should never happen */</span></td></tr>
<tr class="codeline" data-linenumber="305"><td class="num" id="LN305">305</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="306"><td class="num" id="LN306">306</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="307"><td class="num" id="LN307">307</td><td class="line">        <span class='comment'>/* If not Suite B just return first preference shared curve */</span></td></tr>
<tr class="codeline" data-linenumber="308"><td class="num" id="LN308">308</td><td class="line">        nmatch = 0;</td></tr>
<tr class="codeline" data-linenumber="309"><td class="num" id="LN309">309</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="310"><td class="num" id="LN310">310</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="311"><td class="num" id="LN311">311</td><td class="line">     <span class='comment'>* If server preference set, our groups are the preference order</span></td></tr>
<tr class="codeline" data-linenumber="312"><td class="num" id="LN312">312</td><td class="line">     <span class='comment'>* otherwise peer decides.</span></td></tr>
<tr class="codeline" data-linenumber="313"><td class="num" id="LN313">313</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="314"><td class="num" id="LN314">314</td><td class="line">    <span class='keyword'>if</span> (s-&gt;options &amp; <span class='macro'>SSL_OP_CIPHER_SERVER_PREFERENCE<span class='macro_popup'>0x00400000U</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="315"><td class="num" id="LN315">315</td><td class="line">        tls1_get_supported_groups(s, &amp;pref, &amp;num_pref);</td></tr>
<tr class="codeline" data-linenumber="316"><td class="num" id="LN316">316</td><td class="line">        tls1_get_peer_groups(s, &amp;supp, &amp;num_supp);</td></tr>
<tr class="codeline" data-linenumber="317"><td class="num" id="LN317">317</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="318"><td class="num" id="LN318">318</td><td class="line">        tls1_get_peer_groups(s, &amp;pref, &amp;num_pref);</td></tr>
<tr class="codeline" data-linenumber="319"><td class="num" id="LN319">319</td><td class="line">        tls1_get_supported_groups(s, &amp;supp, &amp;num_supp);</td></tr>
<tr class="codeline" data-linenumber="320"><td class="num" id="LN320">320</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="321"><td class="num" id="LN321">321</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="322"><td class="num" id="LN322">322</td><td class="line">    <span class='keyword'>for</span> (k = 0, i = 0; i &lt; num_pref; i++) {</td></tr>
<tr class="codeline" data-linenumber="323"><td class="num" id="LN323">323</td><td class="line">        uint16_t id = pref[i];</td></tr>
<tr class="codeline" data-linenumber="324"><td class="num" id="LN324">324</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="325"><td class="num" id="LN325">325</td><td class="line">        <span class='keyword'>if</span> (!tls1_in_list(id, supp, num_supp)</td></tr>
<tr class="codeline" data-linenumber="326"><td class="num" id="LN326">326</td><td class="line">            || !tls_curve_allowed(s, id, <span class='macro'>SSL_SECOP_CURVE_SHARED<span class='macro_popup'>(5 | (2 &lt;&lt; 16))</span></span>))</td></tr>
<tr class="codeline" data-linenumber="327"><td class="num" id="LN327">327</td><td class="line">                    <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="328"><td class="num" id="LN328">328</td><td class="line">        <span class='keyword'>if</span> (nmatch == k)</td></tr>
<tr class="codeline" data-linenumber="329"><td class="num" id="LN329">329</td><td class="line">            <span class='keyword'>return</span> id;</td></tr>
<tr class="codeline" data-linenumber="330"><td class="num" id="LN330">330</td><td class="line">         k++;</td></tr>
<tr class="codeline" data-linenumber="331"><td class="num" id="LN331">331</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="332"><td class="num" id="LN332">332</td><td class="line">    <span class='keyword'>if</span> (nmatch == -1)</td></tr>
<tr class="codeline" data-linenumber="333"><td class="num" id="LN333">333</td><td class="line">        <span class='keyword'>return</span> k;</td></tr>
<tr class="codeline" data-linenumber="334"><td class="num" id="LN334">334</td><td class="line">    <span class='comment'>/* Out of range (nmatch &gt; k). */</span></td></tr>
<tr class="codeline" data-linenumber="335"><td class="num" id="LN335">335</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="336"><td class="num" id="LN336">336</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="337"><td class="num" id="LN337">337</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="338"><td class="num" id="LN338">338</td><td class="line"><span class='keyword'>int</span> tls1_set_groups(uint16_t **pext, size_t *pextlen,</td></tr>
<tr class="codeline" data-linenumber="339"><td class="num" id="LN339">339</td><td class="line">                    <span class='keyword'>int</span> *groups, size_t ngroups)</td></tr>
<tr class="codeline" data-linenumber="340"><td class="num" id="LN340">340</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="341"><td class="num" id="LN341">341</td><td class="line">    uint16_t *glist;</td></tr>
<tr class="codeline" data-linenumber="342"><td class="num" id="LN342">342</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="343"><td class="num" id="LN343">343</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="344"><td class="num" id="LN344">344</td><td class="line">     <span class='comment'>* Bitmap of groups included to detect duplicates: only works while group</span></td></tr>
<tr class="codeline" data-linenumber="345"><td class="num" id="LN345">345</td><td class="line">     <span class='comment'>* ids &lt; 32</span></td></tr>
<tr class="codeline" data-linenumber="346"><td class="num" id="LN346">346</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="347"><td class="num" id="LN347">347</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> dup_list = 0;</td></tr>
<tr class="codeline" data-linenumber="348"><td class="num" id="LN348">348</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="349"><td class="num" id="LN349">349</td><td class="line">    <span class='keyword'>if</span> (ngroups == 0) {</td></tr>
<tr class="codeline" data-linenumber="350"><td class="num" id="LN350">350</td><td class="line">        <span class='macro'>SSLerr(SSL_F_TLS1_SET_GROUPS, SSL_R_BAD_LENGTH)<span class='macro_popup'>ERR_put_error(20,(629),(271),"../deps/openssl/openssl/ssl/t1_lib.c"<br>,350)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="351"><td class="num" id="LN351">351</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="352"><td class="num" id="LN352">352</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="353"><td class="num" id="LN353">353</td><td class="line">    <span class='keyword'>if</span> ((glist = <span class='macro'>OPENSSL_malloc(ngroups * <span class='keyword'>sizeof</span>(*glist))<span class='macro_popup'>CRYPTO_malloc(ngroups * sizeof(*glist), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 353)</span></span>) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="354"><td class="num" id="LN354">354</td><td class="line">        <span class='macro'>SSLerr(SSL_F_TLS1_SET_GROUPS, ERR_R_MALLOC_FAILURE)<span class='macro_popup'>ERR_put_error(20,(629),((1|64)),"../deps/openssl/openssl/ssl/t1_lib.c"<br>,354)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="355"><td class="num" id="LN355">355</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="356"><td class="num" id="LN356">356</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="357"><td class="num" id="LN357">357</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; ngroups; i++) {</td></tr>
<tr class="codeline" data-linenumber="358"><td class="num" id="LN358">358</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>long</span> idmask;</td></tr>
<tr class="codeline" data-linenumber="359"><td class="num" id="LN359">359</td><td class="line">        uint16_t id;</td></tr>
<tr class="codeline" data-linenumber="360"><td class="num" id="LN360">360</td><td class="line">        <span class='comment'>/* TODO(TLS1.3): Convert for DH groups */</span></td></tr>
<tr class="codeline" data-linenumber="361"><td class="num" id="LN361">361</td><td class="line">        id = tls1_nid2group_id(groups[i]);</td></tr>
<tr class="codeline" data-linenumber="362"><td class="num" id="LN362">362</td><td class="line">        idmask = 1L &lt;&lt; id;</td></tr>
<tr class="codeline" data-linenumber="363"><td class="num" id="LN363">363</td><td class="line">        <span class='keyword'>if</span> (!id || (dup_list &amp; idmask)) {</td></tr>
<tr class="codeline" data-linenumber="364"><td class="num" id="LN364">364</td><td class="line">            <span class='macro'>OPENSSL_free(glist)<span class='macro_popup'>CRYPTO_free(glist, "../deps/openssl/openssl/ssl/t1_lib.c", 364<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="365"><td class="num" id="LN365">365</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="366"><td class="num" id="LN366">366</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="367"><td class="num" id="LN367">367</td><td class="line">        dup_list |= idmask;</td></tr>
<tr class="codeline" data-linenumber="368"><td class="num" id="LN368">368</td><td class="line">        glist[i] = id;</td></tr>
<tr class="codeline" data-linenumber="369"><td class="num" id="LN369">369</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="370"><td class="num" id="LN370">370</td><td class="line">    <span class='macro'>OPENSSL_free(*pext)<span class='macro_popup'>CRYPTO_free(*pext, "../deps/openssl/openssl/ssl/t1_lib.c", 370<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="371"><td class="num" id="LN371">371</td><td class="line">    *pext = glist;</td></tr>
<tr class="codeline" data-linenumber="372"><td class="num" id="LN372">372</td><td class="line">    *pextlen = ngroups;</td></tr>
<tr class="codeline" data-linenumber="373"><td class="num" id="LN373">373</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="374"><td class="num" id="LN374">374</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="375"><td class="num" id="LN375">375</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="376"><td class="num" id="LN376">376</td><td class="line"><span class='directive'># define <span class='macro'>MAX_CURVELIST<span class='macro_popup'>(sizeof(nid_list)/sizeof((nid_list)[0]))</span></span>   <span class='macro'>OSSL_NELEM(nid_list)<span class='macro_popup'>(sizeof(nid_list)/sizeof((nid_list)[0]))</span></span></span></td></tr>
<tr class="codeline" data-linenumber="377"><td class="num" id="LN377">377</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="378"><td class="num" id="LN378">378</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> {</td></tr>
<tr class="codeline" data-linenumber="379"><td class="num" id="LN379">379</td><td class="line">    size_t nidcnt;</td></tr>
<tr class="codeline" data-linenumber="380"><td class="num" id="LN380">380</td><td class="line">    <span class='keyword'>int</span> nid_arr[<span class='macro'>MAX_CURVELIST<span class='macro_popup'>(sizeof(nid_list)/sizeof((nid_list)[0]))</span></span>];</td></tr>
<tr class="codeline" data-linenumber="381"><td class="num" id="LN381">381</td><td class="line">} nid_cb_st;</td></tr>
<tr class="codeline" data-linenumber="382"><td class="num" id="LN382">382</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="383"><td class="num" id="LN383">383</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> nid_cb(<span class='keyword'>const</span> <span class='keyword'>char</span> *elem, <span class='keyword'>int</span> len, <span class='keyword'>void</span> *arg)</td></tr>
<tr class="codeline" data-linenumber="384"><td class="num" id="LN384">384</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="385"><td class="num" id="LN385">385</td><td class="line">    nid_cb_st *narg = arg;</td></tr>
<tr class="codeline" data-linenumber="386"><td class="num" id="LN386">386</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="387"><td class="num" id="LN387">387</td><td class="line">    <span class='keyword'>int</span> nid;</td></tr>
<tr class="codeline" data-linenumber="388"><td class="num" id="LN388">388</td><td class="line">    <span class='keyword'>char</span> etmp[20];</td></tr>
<tr class="codeline" data-linenumber="389"><td class="num" id="LN389">389</td><td class="line">    <span class='keyword'>if</span> (elem == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="390"><td class="num" id="LN390">390</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="391"><td class="num" id="LN391">391</td><td class="line">    <span class='keyword'>if</span> (narg-&gt;nidcnt == <span class='macro'>MAX_CURVELIST<span class='macro_popup'>(sizeof(nid_list)/sizeof((nid_list)[0]))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="392"><td class="num" id="LN392">392</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="393"><td class="num" id="LN393">393</td><td class="line">    <span class='keyword'>if</span> (len &gt; (<span class='keyword'>int</span>)(<span class='keyword'>sizeof</span>(etmp) - 1))</td></tr>
<tr class="codeline" data-linenumber="394"><td class="num" id="LN394">394</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="395"><td class="num" id="LN395">395</td><td class="line">    <span class="mrange">memcpy</span>(etmp, elem, len);</td></tr>
<tr><td class="num"></td><td class="line"><div id="EndPath" class="msg msgEvent" style="margin-left:5ex; max-width:58em">Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11</div></td></tr>
<tr class="codeline" data-linenumber="396"><td class="num" id="LN396">396</td><td class="line">    etmp[len] = 0;</td></tr>
<tr class="codeline" data-linenumber="397"><td class="num" id="LN397">397</td><td class="line">    nid = EC_curve_nist2nid(etmp);</td></tr>
<tr class="codeline" data-linenumber="398"><td class="num" id="LN398">398</td><td class="line">    <span class='keyword'>if</span> (nid == <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="399"><td class="num" id="LN399">399</td><td class="line">        nid = OBJ_sn2nid(etmp);</td></tr>
<tr class="codeline" data-linenumber="400"><td class="num" id="LN400">400</td><td class="line">    <span class='keyword'>if</span> (nid == <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="401"><td class="num" id="LN401">401</td><td class="line">        nid = OBJ_ln2nid(etmp);</td></tr>
<tr class="codeline" data-linenumber="402"><td class="num" id="LN402">402</td><td class="line">    <span class='keyword'>if</span> (nid == <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="403"><td class="num" id="LN403">403</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="404"><td class="num" id="LN404">404</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; narg-&gt;nidcnt; i++)</td></tr>
<tr class="codeline" data-linenumber="405"><td class="num" id="LN405">405</td><td class="line">        <span class='keyword'>if</span> (narg-&gt;nid_arr[i] == nid)</td></tr>
<tr class="codeline" data-linenumber="406"><td class="num" id="LN406">406</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="407"><td class="num" id="LN407">407</td><td class="line">    narg-&gt;nid_arr[narg-&gt;nidcnt++] = nid;</td></tr>
<tr class="codeline" data-linenumber="408"><td class="num" id="LN408">408</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="409"><td class="num" id="LN409">409</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="410"><td class="num" id="LN410">410</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="411"><td class="num" id="LN411">411</td><td class="line"><span class='comment'>/* Set groups based on a colon separate list */</span></td></tr>
<tr class="codeline" data-linenumber="412"><td class="num" id="LN412">412</td><td class="line"><span class='keyword'>int</span> tls1_set_groups_list(uint16_t **pext, size_t *pextlen, <span class='keyword'>const</span> <span class='keyword'>char</span> *str)</td></tr>
<tr class="codeline" data-linenumber="413"><td class="num" id="LN413">413</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="414"><td class="num" id="LN414">414</td><td class="line">    nid_cb_st ncb;</td></tr>
<tr class="codeline" data-linenumber="415"><td class="num" id="LN415">415</td><td class="line">    ncb.nidcnt = 0;</td></tr>
<tr class="codeline" data-linenumber="416"><td class="num" id="LN416">416</td><td class="line">    <span class='keyword'>if</span> (!CONF_parse_list(str, ':', 1, nid_cb, &amp;ncb))</td></tr>
<tr class="codeline" data-linenumber="417"><td class="num" id="LN417">417</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="418"><td class="num" id="LN418">418</td><td class="line">    <span class='keyword'>if</span> (pext == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="419"><td class="num" id="LN419">419</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="420"><td class="num" id="LN420">420</td><td class="line">    <span class='keyword'>return</span> tls1_set_groups(pext, pextlen, ncb.nid_arr, ncb.nidcnt);</td></tr>
<tr class="codeline" data-linenumber="421"><td class="num" id="LN421">421</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="422"><td class="num" id="LN422">422</td><td class="line"><span class='comment'>/* Return group id of a key */</span></td></tr>
<tr class="codeline" data-linenumber="423"><td class="num" id="LN423">423</td><td class="line"><span class='keyword'>static</span> uint16_t tls1_get_group_id(EVP_PKEY *pkey)</td></tr>
<tr class="codeline" data-linenumber="424"><td class="num" id="LN424">424</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="425"><td class="num" id="LN425">425</td><td class="line">    EC_KEY *ec = EVP_PKEY_get0_EC_KEY(pkey);</td></tr>
<tr class="codeline" data-linenumber="426"><td class="num" id="LN426">426</td><td class="line">    <span class='keyword'>const</span> EC_GROUP *grp;</td></tr>
<tr class="codeline" data-linenumber="427"><td class="num" id="LN427">427</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="428"><td class="num" id="LN428">428</td><td class="line">    <span class='keyword'>if</span> (ec == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="429"><td class="num" id="LN429">429</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="430"><td class="num" id="LN430">430</td><td class="line">    grp = EC_KEY_get0_group(ec);</td></tr>
<tr class="codeline" data-linenumber="431"><td class="num" id="LN431">431</td><td class="line">    <span class='keyword'>return</span> tls1_nid2group_id(EC_GROUP_get_curve_name(grp));</td></tr>
<tr class="codeline" data-linenumber="432"><td class="num" id="LN432">432</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="433"><td class="num" id="LN433">433</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="434"><td class="num" id="LN434">434</td><td class="line"><span class='comment'>/* Check a key is compatible with compression extension */</span></td></tr>
<tr class="codeline" data-linenumber="435"><td class="num" id="LN435">435</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls1_check_pkey_comp(SSL *s, EVP_PKEY *pkey)</td></tr>
<tr class="codeline" data-linenumber="436"><td class="num" id="LN436">436</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="437"><td class="num" id="LN437">437</td><td class="line">    <span class='keyword'>const</span> EC_KEY *ec;</td></tr>
<tr class="codeline" data-linenumber="438"><td class="num" id="LN438">438</td><td class="line">    <span class='keyword'>const</span> EC_GROUP *grp;</td></tr>
<tr class="codeline" data-linenumber="439"><td class="num" id="LN439">439</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> comp_id;</td></tr>
<tr class="codeline" data-linenumber="440"><td class="num" id="LN440">440</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="441"><td class="num" id="LN441">441</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="442"><td class="num" id="LN442">442</td><td class="line">    <span class='comment'>/* If not an EC key nothing to check */</span></td></tr>
<tr class="codeline" data-linenumber="443"><td class="num" id="LN443">443</td><td class="line">    <span class='keyword'>if</span> (EVP_PKEY_id(pkey) != <span class='macro'>EVP_PKEY_EC<span class='macro_popup'>408</span></span>)</td></tr>
<tr class="codeline" data-linenumber="444"><td class="num" id="LN444">444</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="445"><td class="num" id="LN445">445</td><td class="line">    ec = EVP_PKEY_get0_EC_KEY(pkey);</td></tr>
<tr class="codeline" data-linenumber="446"><td class="num" id="LN446">446</td><td class="line">    grp = EC_KEY_get0_group(ec);</td></tr>
<tr class="codeline" data-linenumber="447"><td class="num" id="LN447">447</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="448"><td class="num" id="LN448">448</td><td class="line">    <span class='comment'>/* Get required compression id */</span></td></tr>
<tr class="codeline" data-linenumber="449"><td class="num" id="LN449">449</td><td class="line">    <span class='keyword'>if</span> (EC_KEY_get_conv_form(ec) == POINT_CONVERSION_UNCOMPRESSED) {</td></tr>
<tr class="codeline" data-linenumber="450"><td class="num" id="LN450">450</td><td class="line">            comp_id = <span class='macro'>TLSEXT_ECPOINTFORMAT_uncompressed<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="451"><td class="num" id="LN451">451</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>SSL_IS_TLS13(s)<span class='macro_popup'>(!(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8) &amp;&amp;<br> (s)-&gt;method-&gt;version &gt;= 0x0304 &amp;&amp; (s)-&gt;method<br>-&gt;version != 0x10000)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="452"><td class="num" id="LN452">452</td><td class="line">            <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="453"><td class="num" id="LN453">453</td><td class="line">             <span class='comment'>* ec_point_formats extension is not used in TLSv1.3 so we ignore</span></td></tr>
<tr class="codeline" data-linenumber="454"><td class="num" id="LN454">454</td><td class="line">             <span class='comment'>* this check.</span></td></tr>
<tr class="codeline" data-linenumber="455"><td class="num" id="LN455">455</td><td class="line">             <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="456"><td class="num" id="LN456">456</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="457"><td class="num" id="LN457">457</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="458"><td class="num" id="LN458">458</td><td class="line">        <span class='keyword'>int</span> field_type = EC_METHOD_get_field_type(EC_GROUP_method_of(grp));</td></tr>
<tr class="codeline" data-linenumber="459"><td class="num" id="LN459">459</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="460"><td class="num" id="LN460">460</td><td class="line">        <span class='keyword'>if</span> (field_type == <span class='macro'>NID_X9_62_prime_field<span class='macro_popup'>406</span></span>)</td></tr>
<tr class="codeline" data-linenumber="461"><td class="num" id="LN461">461</td><td class="line">            comp_id = <span class='macro'>TLSEXT_ECPOINTFORMAT_ansiX962_compressed_prime<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="462"><td class="num" id="LN462">462</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (field_type == <span class='macro'>NID_X9_62_characteristic_two_field<span class='macro_popup'>407</span></span>)</td></tr>
<tr class="codeline" data-linenumber="463"><td class="num" id="LN463">463</td><td class="line">            comp_id = <span class='macro'>TLSEXT_ECPOINTFORMAT_ansiX962_compressed_char2<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="464"><td class="num" id="LN464">464</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="465"><td class="num" id="LN465">465</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="466"><td class="num" id="LN466">466</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="467"><td class="num" id="LN467">467</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="468"><td class="num" id="LN468">468</td><td class="line">     <span class='comment'>* If point formats extension present check it, otherwise everything is</span></td></tr>
<tr class="codeline" data-linenumber="469"><td class="num" id="LN469">469</td><td class="line">     <span class='comment'>* supported (see RFC4492).</span></td></tr>
<tr class="codeline" data-linenumber="470"><td class="num" id="LN470">470</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="471"><td class="num" id="LN471">471</td><td class="line">    <span class='keyword'>if</span> (s-&gt;ext.peer_ecpointformats == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="472"><td class="num" id="LN472">472</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="473"><td class="num" id="LN473">473</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="474"><td class="num" id="LN474">474</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; s-&gt;ext.peer_ecpointformats_len; i++) {</td></tr>
<tr class="codeline" data-linenumber="475"><td class="num" id="LN475">475</td><td class="line">        <span class='keyword'>if</span> (s-&gt;ext.peer_ecpointformats[i] == comp_id)</td></tr>
<tr class="codeline" data-linenumber="476"><td class="num" id="LN476">476</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="477"><td class="num" id="LN477">477</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="478"><td class="num" id="LN478">478</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="479"><td class="num" id="LN479">479</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="480"><td class="num" id="LN480">480</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="481"><td class="num" id="LN481">481</td><td class="line"><span class='comment'>/* Check a group id matches preferences */</span></td></tr>
<tr class="codeline" data-linenumber="482"><td class="num" id="LN482">482</td><td class="line"><span class='keyword'>int</span> tls1_check_group_id(SSL *s, uint16_t group_id, <span class='keyword'>int</span> check_own_groups)</td></tr>
<tr class="codeline" data-linenumber="483"><td class="num" id="LN483">483</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="484"><td class="num" id="LN484">484</td><td class="line">    <span class='keyword'>const</span> uint16_t *groups;</td></tr>
<tr class="codeline" data-linenumber="485"><td class="num" id="LN485">485</td><td class="line">    size_t groups_len;</td></tr>
<tr class="codeline" data-linenumber="486"><td class="num" id="LN486">486</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="487"><td class="num" id="LN487">487</td><td class="line">    <span class='keyword'>if</span> (group_id == 0)</td></tr>
<tr class="codeline" data-linenumber="488"><td class="num" id="LN488">488</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="489"><td class="num" id="LN489">489</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="490"><td class="num" id="LN490">490</td><td class="line">    <span class='comment'>/* Check for Suite B compliance */</span></td></tr>
<tr class="codeline" data-linenumber="491"><td class="num" id="LN491">491</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span> &amp;&amp; s-&gt;s3-&gt;tmp.new_cipher != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="492"><td class="num" id="LN492">492</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>long</span> cid = s-&gt;s3-&gt;tmp.new_cipher-&gt;id;</td></tr>
<tr class="codeline" data-linenumber="493"><td class="num" id="LN493">493</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="494"><td class="num" id="LN494">494</td><td class="line">        <span class='keyword'>if</span> (cid == <span class='macro'>TLS1_CK_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256<span class='macro_popup'>0x0300C02B</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="495"><td class="num" id="LN495">495</td><td class="line">            <span class='keyword'>if</span> (group_id != <span class='macro'>TLSEXT_curve_P_256<span class='macro_popup'>23</span></span>)</td></tr>
<tr class="codeline" data-linenumber="496"><td class="num" id="LN496">496</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="497"><td class="num" id="LN497">497</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (cid == <span class='macro'>TLS1_CK_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384<span class='macro_popup'>0x0300C02C</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="498"><td class="num" id="LN498">498</td><td class="line">            <span class='keyword'>if</span> (group_id != <span class='macro'>TLSEXT_curve_P_384<span class='macro_popup'>24</span></span>)</td></tr>
<tr class="codeline" data-linenumber="499"><td class="num" id="LN499">499</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="500"><td class="num" id="LN500">500</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="501"><td class="num" id="LN501">501</td><td class="line">            <span class='comment'>/* Should never happen */</span></td></tr>
<tr class="codeline" data-linenumber="502"><td class="num" id="LN502">502</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="503"><td class="num" id="LN503">503</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="504"><td class="num" id="LN504">504</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="505"><td class="num" id="LN505">505</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="506"><td class="num" id="LN506">506</td><td class="line">    <span class='keyword'>if</span> (check_own_groups) {</td></tr>
<tr class="codeline" data-linenumber="507"><td class="num" id="LN507">507</td><td class="line">        <span class='comment'>/* Check group is one of our preferences */</span></td></tr>
<tr class="codeline" data-linenumber="508"><td class="num" id="LN508">508</td><td class="line">        tls1_get_supported_groups(s, &amp;groups, &amp;groups_len);</td></tr>
<tr class="codeline" data-linenumber="509"><td class="num" id="LN509">509</td><td class="line">        <span class='keyword'>if</span> (!tls1_in_list(group_id, groups, groups_len))</td></tr>
<tr class="codeline" data-linenumber="510"><td class="num" id="LN510">510</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="511"><td class="num" id="LN511">511</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="512"><td class="num" id="LN512">512</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="513"><td class="num" id="LN513">513</td><td class="line">    <span class='keyword'>if</span> (!tls_curve_allowed(s, group_id, <span class='macro'>SSL_SECOP_CURVE_CHECK<span class='macro_popup'>(6 | (2 &lt;&lt; 16))</span></span>))</td></tr>
<tr class="codeline" data-linenumber="514"><td class="num" id="LN514">514</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="515"><td class="num" id="LN515">515</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="516"><td class="num" id="LN516">516</td><td class="line">    <span class='comment'>/* For clients, nothing more to check */</span></td></tr>
<tr class="codeline" data-linenumber="517"><td class="num" id="LN517">517</td><td class="line">    <span class='keyword'>if</span> (!s-&gt;server)</td></tr>
<tr class="codeline" data-linenumber="518"><td class="num" id="LN518">518</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="519"><td class="num" id="LN519">519</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="520"><td class="num" id="LN520">520</td><td class="line">    <span class='comment'>/* Check group is one of peers preferences */</span></td></tr>
<tr class="codeline" data-linenumber="521"><td class="num" id="LN521">521</td><td class="line">    tls1_get_peer_groups(s, &amp;groups, &amp;groups_len);</td></tr>
<tr class="codeline" data-linenumber="522"><td class="num" id="LN522">522</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="523"><td class="num" id="LN523">523</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="524"><td class="num" id="LN524">524</td><td class="line">     <span class='comment'>* RFC 4492 does not require the supported elliptic curves extension</span></td></tr>
<tr class="codeline" data-linenumber="525"><td class="num" id="LN525">525</td><td class="line">     <span class='comment'>* so if it is not sent we can just choose any curve.</span></td></tr>
<tr class="codeline" data-linenumber="526"><td class="num" id="LN526">526</td><td class="line">     <span class='comment'>* It is invalid to send an empty list in the supported groups</span></td></tr>
<tr class="codeline" data-linenumber="527"><td class="num" id="LN527">527</td><td class="line">     <span class='comment'>* extension, so groups_len == 0 always means no extension.</span></td></tr>
<tr class="codeline" data-linenumber="528"><td class="num" id="LN528">528</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="529"><td class="num" id="LN529">529</td><td class="line">    <span class='keyword'>if</span> (groups_len == 0)</td></tr>
<tr class="codeline" data-linenumber="530"><td class="num" id="LN530">530</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="531"><td class="num" id="LN531">531</td><td class="line">    <span class='keyword'>return</span> tls1_in_list(group_id, groups, groups_len);</td></tr>
<tr class="codeline" data-linenumber="532"><td class="num" id="LN532">532</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="533"><td class="num" id="LN533">533</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="534"><td class="num" id="LN534">534</td><td class="line"><span class='keyword'>void</span> tls1_get_formatlist(SSL *s, <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> **pformats,</td></tr>
<tr class="codeline" data-linenumber="535"><td class="num" id="LN535">535</td><td class="line">                         size_t *num_formats)</td></tr>
<tr class="codeline" data-linenumber="536"><td class="num" id="LN536">536</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="537"><td class="num" id="LN537">537</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="538"><td class="num" id="LN538">538</td><td class="line">     <span class='comment'>* If we have a custom point format list use it otherwise use default</span></td></tr>
<tr class="codeline" data-linenumber="539"><td class="num" id="LN539">539</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="540"><td class="num" id="LN540">540</td><td class="line">    <span class='keyword'>if</span> (s-&gt;ext.ecpointformats) {</td></tr>
<tr class="codeline" data-linenumber="541"><td class="num" id="LN541">541</td><td class="line">        *pformats = s-&gt;ext.ecpointformats;</td></tr>
<tr class="codeline" data-linenumber="542"><td class="num" id="LN542">542</td><td class="line">        *num_formats = s-&gt;ext.ecpointformats_len;</td></tr>
<tr class="codeline" data-linenumber="543"><td class="num" id="LN543">543</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="544"><td class="num" id="LN544">544</td><td class="line">        *pformats = ecformats_default;</td></tr>
<tr class="codeline" data-linenumber="545"><td class="num" id="LN545">545</td><td class="line">        <span class='comment'>/* For Suite B we don't support char2 fields */</span></td></tr>
<tr class="codeline" data-linenumber="546"><td class="num" id="LN546">546</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="547"><td class="num" id="LN547">547</td><td class="line">            *num_formats = <span class='keyword'>sizeof</span>(ecformats_default) - 1;</td></tr>
<tr class="codeline" data-linenumber="548"><td class="num" id="LN548">548</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="549"><td class="num" id="LN549">549</td><td class="line">            *num_formats = <span class='keyword'>sizeof</span>(ecformats_default);</td></tr>
<tr class="codeline" data-linenumber="550"><td class="num" id="LN550">550</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="551"><td class="num" id="LN551">551</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="552"><td class="num" id="LN552">552</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="553"><td class="num" id="LN553">553</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="554"><td class="num" id="LN554">554</td><td class="line"> <span class='comment'>* Check cert parameters compatible with extensions: currently just checks EC</span></td></tr>
<tr class="codeline" data-linenumber="555"><td class="num" id="LN555">555</td><td class="line"> <span class='comment'>* certificates have compatible curves and compression.</span></td></tr>
<tr class="codeline" data-linenumber="556"><td class="num" id="LN556">556</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="557"><td class="num" id="LN557">557</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls1_check_cert_param(SSL *s, X509 *x, <span class='keyword'>int</span> check_ee_md)</td></tr>
<tr class="codeline" data-linenumber="558"><td class="num" id="LN558">558</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="559"><td class="num" id="LN559">559</td><td class="line">    uint16_t group_id;</td></tr>
<tr class="codeline" data-linenumber="560"><td class="num" id="LN560">560</td><td class="line">    EVP_PKEY *pkey;</td></tr>
<tr class="codeline" data-linenumber="561"><td class="num" id="LN561">561</td><td class="line">    pkey = X509_get0_pubkey(x);</td></tr>
<tr class="codeline" data-linenumber="562"><td class="num" id="LN562">562</td><td class="line">    <span class='keyword'>if</span> (pkey == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="563"><td class="num" id="LN563">563</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="564"><td class="num" id="LN564">564</td><td class="line">    <span class='comment'>/* If not EC nothing to do */</span></td></tr>
<tr class="codeline" data-linenumber="565"><td class="num" id="LN565">565</td><td class="line">    <span class='keyword'>if</span> (EVP_PKEY_id(pkey) != <span class='macro'>EVP_PKEY_EC<span class='macro_popup'>408</span></span>)</td></tr>
<tr class="codeline" data-linenumber="566"><td class="num" id="LN566">566</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="567"><td class="num" id="LN567">567</td><td class="line">    <span class='comment'>/* Check compression */</span></td></tr>
<tr class="codeline" data-linenumber="568"><td class="num" id="LN568">568</td><td class="line">    <span class='keyword'>if</span> (!tls1_check_pkey_comp(s, pkey))</td></tr>
<tr class="codeline" data-linenumber="569"><td class="num" id="LN569">569</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="570"><td class="num" id="LN570">570</td><td class="line">    group_id = tls1_get_group_id(pkey);</td></tr>
<tr class="codeline" data-linenumber="571"><td class="num" id="LN571">571</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="572"><td class="num" id="LN572">572</td><td class="line">     <span class='comment'>* For a server we allow the certificate to not be in our list of supported</span></td></tr>
<tr class="codeline" data-linenumber="573"><td class="num" id="LN573">573</td><td class="line">     <span class='comment'>* groups.</span></td></tr>
<tr class="codeline" data-linenumber="574"><td class="num" id="LN574">574</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="575"><td class="num" id="LN575">575</td><td class="line">    <span class='keyword'>if</span> (!tls1_check_group_id(s, group_id, !s-&gt;server))</td></tr>
<tr class="codeline" data-linenumber="576"><td class="num" id="LN576">576</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="577"><td class="num" id="LN577">577</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="578"><td class="num" id="LN578">578</td><td class="line">     <span class='comment'>* Special case for suite B. We *MUST* sign using SHA256+P-256 or</span></td></tr>
<tr class="codeline" data-linenumber="579"><td class="num" id="LN579">579</td><td class="line">     <span class='comment'>* SHA384+P-384.</span></td></tr>
<tr class="codeline" data-linenumber="580"><td class="num" id="LN580">580</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="581"><td class="num" id="LN581">581</td><td class="line">    <span class='keyword'>if</span> (check_ee_md &amp;&amp; <span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="582"><td class="num" id="LN582">582</td><td class="line">        <span class='keyword'>int</span> check_md;</td></tr>
<tr class="codeline" data-linenumber="583"><td class="num" id="LN583">583</td><td class="line">        size_t i;</td></tr>
<tr class="codeline" data-linenumber="584"><td class="num" id="LN584">584</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="585"><td class="num" id="LN585">585</td><td class="line">        <span class='comment'>/* Check to see we have necessary signing algorithm */</span></td></tr>
<tr class="codeline" data-linenumber="586"><td class="num" id="LN586">586</td><td class="line">        <span class='keyword'>if</span> (group_id == <span class='macro'>TLSEXT_curve_P_256<span class='macro_popup'>23</span></span>)</td></tr>
<tr class="codeline" data-linenumber="587"><td class="num" id="LN587">587</td><td class="line">            check_md = <span class='macro'>NID_ecdsa_with_SHA256<span class='macro_popup'>794</span></span>;</td></tr>
<tr class="codeline" data-linenumber="588"><td class="num" id="LN588">588</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (group_id == <span class='macro'>TLSEXT_curve_P_384<span class='macro_popup'>24</span></span>)</td></tr>
<tr class="codeline" data-linenumber="589"><td class="num" id="LN589">589</td><td class="line">            check_md = <span class='macro'>NID_ecdsa_with_SHA384<span class='macro_popup'>795</span></span>;</td></tr>
<tr class="codeline" data-linenumber="590"><td class="num" id="LN590">590</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="591"><td class="num" id="LN591">591</td><td class="line">            <span class='keyword'>return</span> 0;           <span class='comment'>/* Should never happen */</span></td></tr>
<tr class="codeline" data-linenumber="592"><td class="num" id="LN592">592</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; s-&gt;shared_sigalgslen; i++) {</td></tr>
<tr class="codeline" data-linenumber="593"><td class="num" id="LN593">593</td><td class="line">            <span class='keyword'>if</span> (check_md == s-&gt;shared_sigalgs[i]-&gt;sigandhash)</td></tr>
<tr class="codeline" data-linenumber="594"><td class="num" id="LN594">594</td><td class="line">                <span class='keyword'>return</span> 1;;</td></tr>
<tr class="codeline" data-linenumber="595"><td class="num" id="LN595">595</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="596"><td class="num" id="LN596">596</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="597"><td class="num" id="LN597">597</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="598"><td class="num" id="LN598">598</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="599"><td class="num" id="LN599">599</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="600"><td class="num" id="LN600">600</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="601"><td class="num" id="LN601">601</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="602"><td class="num" id="LN602">602</td><td class="line"> <span class='comment'>* tls1_check_ec_tmp_key - Check EC temporary key compatibility</span></td></tr>
<tr class="codeline" data-linenumber="603"><td class="num" id="LN603">603</td><td class="line"> <span class='comment'>* @s: SSL connection</span></td></tr>
<tr class="codeline" data-linenumber="604"><td class="num" id="LN604">604</td><td class="line"> <span class='comment'>* @cid: Cipher ID we're considering using</span></td></tr>
<tr class="codeline" data-linenumber="605"><td class="num" id="LN605">605</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="606"><td class="num" id="LN606">606</td><td class="line"> <span class='comment'>* Checks that the kECDHE cipher suite we're considering using</span></td></tr>
<tr class="codeline" data-linenumber="607"><td class="num" id="LN607">607</td><td class="line"> <span class='comment'>* is compatible with the client extensions.</span></td></tr>
<tr class="codeline" data-linenumber="608"><td class="num" id="LN608">608</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="609"><td class="num" id="LN609">609</td><td class="line"> <span class='comment'>* Returns 0 when the cipher can't be used or 1 when it can.</span></td></tr>
<tr class="codeline" data-linenumber="610"><td class="num" id="LN610">610</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="611"><td class="num" id="LN611">611</td><td class="line"><span class='keyword'>int</span> tls1_check_ec_tmp_key(SSL *s, <span class='keyword'>unsigned</span> <span class='keyword'>long</span> cid)</td></tr>
<tr class="codeline" data-linenumber="612"><td class="num" id="LN612">612</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="613"><td class="num" id="LN613">613</td><td class="line">    <span class='comment'>/* If not Suite B just need a shared group */</span></td></tr>
<tr class="codeline" data-linenumber="614"><td class="num" id="LN614">614</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="615"><td class="num" id="LN615">615</td><td class="line">        <span class='keyword'>return</span> tls1_shared_group(s, 0) != 0;</td></tr>
<tr class="codeline" data-linenumber="616"><td class="num" id="LN616">616</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="617"><td class="num" id="LN617">617</td><td class="line">     <span class='comment'>* If Suite B, AES128 MUST use P-256 and AES256 MUST use P-384, no other</span></td></tr>
<tr class="codeline" data-linenumber="618"><td class="num" id="LN618">618</td><td class="line">     <span class='comment'>* curves permitted.</span></td></tr>
<tr class="codeline" data-linenumber="619"><td class="num" id="LN619">619</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="620"><td class="num" id="LN620">620</td><td class="line">    <span class='keyword'>if</span> (cid == <span class='macro'>TLS1_CK_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256<span class='macro_popup'>0x0300C02B</span></span>)</td></tr>
<tr class="codeline" data-linenumber="621"><td class="num" id="LN621">621</td><td class="line">        <span class='keyword'>return</span> tls1_check_group_id(s, <span class='macro'>TLSEXT_curve_P_256<span class='macro_popup'>23</span></span>, 1);</td></tr>
<tr class="codeline" data-linenumber="622"><td class="num" id="LN622">622</td><td class="line">    <span class='keyword'>if</span> (cid == <span class='macro'>TLS1_CK_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384<span class='macro_popup'>0x0300C02C</span></span>)</td></tr>
<tr class="codeline" data-linenumber="623"><td class="num" id="LN623">623</td><td class="line">        <span class='keyword'>return</span> tls1_check_group_id(s, <span class='macro'>TLSEXT_curve_P_384<span class='macro_popup'>24</span></span>, 1);</td></tr>
<tr class="codeline" data-linenumber="624"><td class="num" id="LN624">624</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="625"><td class="num" id="LN625">625</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="626"><td class="num" id="LN626">626</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="627"><td class="num" id="LN627">627</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="628"><td class="num" id="LN628">628</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="629"><td class="num" id="LN629">629</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="630"><td class="num" id="LN630">630</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls1_check_cert_param(SSL *s, X509 *x, <span class='keyword'>int</span> set_ee_md)</td></tr>
<tr class="codeline" data-linenumber="631"><td class="num" id="LN631">631</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="632"><td class="num" id="LN632">632</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="633"><td class="num" id="LN633">633</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="634"><td class="num" id="LN634">634</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="635"><td class="num" id="LN635">635</td><td class="line"><span class='directive'>#endif                          /* OPENSSL_NO_EC */</span></td></tr>
<tr class="codeline" data-linenumber="636"><td class="num" id="LN636">636</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="637"><td class="num" id="LN637">637</td><td class="line"><span class='comment'>/* Default sigalg schemes */</span></td></tr>
<tr class="codeline" data-linenumber="638"><td class="num" id="LN638">638</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> uint16_t tls12_sigalgs[] = {</td></tr>
<tr class="codeline" data-linenumber="639"><td class="num" id="LN639">639</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="640"><td class="num" id="LN640">640</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_ecdsa_secp256r1_sha256<span class='macro_popup'>0x0403</span></span>,</td></tr>
<tr class="codeline" data-linenumber="641"><td class="num" id="LN641">641</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_ecdsa_secp384r1_sha384<span class='macro_popup'>0x0503</span></span>,</td></tr>
<tr class="codeline" data-linenumber="642"><td class="num" id="LN642">642</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_ecdsa_secp521r1_sha512<span class='macro_popup'>0x0603</span></span>,</td></tr>
<tr class="codeline" data-linenumber="643"><td class="num" id="LN643">643</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_ed25519<span class='macro_popup'>0x0807</span></span>,</td></tr>
<tr class="codeline" data-linenumber="644"><td class="num" id="LN644">644</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_ed448<span class='macro_popup'>0x0808</span></span>,</td></tr>
<tr class="codeline" data-linenumber="645"><td class="num" id="LN645">645</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="646"><td class="num" id="LN646">646</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="647"><td class="num" id="LN647">647</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_rsa_pss_pss_sha256<span class='macro_popup'>0x0809</span></span>,</td></tr>
<tr class="codeline" data-linenumber="648"><td class="num" id="LN648">648</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_rsa_pss_pss_sha384<span class='macro_popup'>0x080a</span></span>,</td></tr>
<tr class="codeline" data-linenumber="649"><td class="num" id="LN649">649</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_rsa_pss_pss_sha512<span class='macro_popup'>0x080b</span></span>,</td></tr>
<tr class="codeline" data-linenumber="650"><td class="num" id="LN650">650</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_rsa_pss_rsae_sha256<span class='macro_popup'>0x0804</span></span>,</td></tr>
<tr class="codeline" data-linenumber="651"><td class="num" id="LN651">651</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_rsa_pss_rsae_sha384<span class='macro_popup'>0x0805</span></span>,</td></tr>
<tr class="codeline" data-linenumber="652"><td class="num" id="LN652">652</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_rsa_pss_rsae_sha512<span class='macro_popup'>0x0806</span></span>,</td></tr>
<tr class="codeline" data-linenumber="653"><td class="num" id="LN653">653</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="654"><td class="num" id="LN654">654</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_rsa_pkcs1_sha256<span class='macro_popup'>0x0401</span></span>,</td></tr>
<tr class="codeline" data-linenumber="655"><td class="num" id="LN655">655</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_rsa_pkcs1_sha384<span class='macro_popup'>0x0501</span></span>,</td></tr>
<tr class="codeline" data-linenumber="656"><td class="num" id="LN656">656</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_rsa_pkcs1_sha512<span class='macro_popup'>0x0601</span></span>,</td></tr>
<tr class="codeline" data-linenumber="657"><td class="num" id="LN657">657</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="658"><td class="num" id="LN658">658</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="659"><td class="num" id="LN659">659</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_ecdsa_sha224<span class='macro_popup'>0x0303</span></span>,</td></tr>
<tr class="codeline" data-linenumber="660"><td class="num" id="LN660">660</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_ecdsa_sha1<span class='macro_popup'>0x0203</span></span>,</td></tr>
<tr class="codeline" data-linenumber="661"><td class="num" id="LN661">661</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="662"><td class="num" id="LN662">662</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_rsa_pkcs1_sha224<span class='macro_popup'>0x0301</span></span>,</td></tr>
<tr class="codeline" data-linenumber="663"><td class="num" id="LN663">663</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_rsa_pkcs1_sha1<span class='macro_popup'>0x0201</span></span>,</td></tr>
<tr class="codeline" data-linenumber="664"><td class="num" id="LN664">664</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_DSA</span></td></tr>
<tr class="codeline" data-linenumber="665"><td class="num" id="LN665">665</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_dsa_sha224<span class='macro_popup'>0x0302</span></span>,</td></tr>
<tr class="codeline" data-linenumber="666"><td class="num" id="LN666">666</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_dsa_sha1<span class='macro_popup'>0x0202</span></span>,</td></tr>
<tr class="codeline" data-linenumber="667"><td class="num" id="LN667">667</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="668"><td class="num" id="LN668">668</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_dsa_sha256<span class='macro_popup'>0x0402</span></span>,</td></tr>
<tr class="codeline" data-linenumber="669"><td class="num" id="LN669">669</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_dsa_sha384<span class='macro_popup'>0x0502</span></span>,</td></tr>
<tr class="codeline" data-linenumber="670"><td class="num" id="LN670">670</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_dsa_sha512<span class='macro_popup'>0x0602</span></span>,</td></tr>
<tr class="codeline" data-linenumber="671"><td class="num" id="LN671">671</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="672"><td class="num" id="LN672">672</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_GOST</span></td></tr>
<tr class="codeline" data-linenumber="673"><td class="num" id="LN673">673</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_gostr34102012_256_gostr34112012_256<span class='macro_popup'>0xeeee</span></span>,</td></tr>
<tr class="codeline" data-linenumber="674"><td class="num" id="LN674">674</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_gostr34102012_512_gostr34112012_512<span class='macro_popup'>0xefef</span></span>,</td></tr>
<tr class="codeline" data-linenumber="675"><td class="num" id="LN675">675</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_gostr34102001_gostr3411<span class='macro_popup'>0xeded</span></span>,</td></tr>
<tr class="codeline" data-linenumber="676"><td class="num" id="LN676">676</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="677"><td class="num" id="LN677">677</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="678"><td class="num" id="LN678">678</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="679"><td class="num" id="LN679">679</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="680"><td class="num" id="LN680">680</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> uint16_t suiteb_sigalgs[] = {</td></tr>
<tr class="codeline" data-linenumber="681"><td class="num" id="LN681">681</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_ecdsa_secp256r1_sha256<span class='macro_popup'>0x0403</span></span>,</td></tr>
<tr class="codeline" data-linenumber="682"><td class="num" id="LN682">682</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_ecdsa_secp384r1_sha384<span class='macro_popup'>0x0503</span></span></td></tr>
<tr class="codeline" data-linenumber="683"><td class="num" id="LN683">683</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="684"><td class="num" id="LN684">684</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="685"><td class="num" id="LN685">685</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="686"><td class="num" id="LN686">686</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> SIGALG_LOOKUP sigalg_lookup_tbl[] = {</td></tr>
<tr class="codeline" data-linenumber="687"><td class="num" id="LN687">687</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="688"><td class="num" id="LN688">688</td><td class="line">    {<span class='string_literal'>"ecdsa_secp256r1_sha256"</span>, <span class='macro'>TLSEXT_SIGALG_ecdsa_secp256r1_sha256<span class='macro_popup'>0x0403</span></span>,</td></tr>
<tr class="codeline" data-linenumber="689"><td class="num" id="LN689">689</td><td class="line">     <span class='macro'>NID_sha256<span class='macro_popup'>672</span></span>, <span class='macro'>SSL_MD_SHA256_IDX<span class='macro_popup'>4</span></span>, <span class='macro'>EVP_PKEY_EC<span class='macro_popup'>408</span></span>, <span class='macro'>SSL_PKEY_ECC<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="690"><td class="num" id="LN690">690</td><td class="line">     <span class='macro'>NID_ecdsa_with_SHA256<span class='macro_popup'>794</span></span>, <span class='macro'>NID_X9_62_prime256v1<span class='macro_popup'>415</span></span>},</td></tr>
<tr class="codeline" data-linenumber="691"><td class="num" id="LN691">691</td><td class="line">    {<span class='string_literal'>"ecdsa_secp384r1_sha384"</span>, <span class='macro'>TLSEXT_SIGALG_ecdsa_secp384r1_sha384<span class='macro_popup'>0x0503</span></span>,</td></tr>
<tr class="codeline" data-linenumber="692"><td class="num" id="LN692">692</td><td class="line">     <span class='macro'>NID_sha384<span class='macro_popup'>673</span></span>, <span class='macro'>SSL_MD_SHA384_IDX<span class='macro_popup'>5</span></span>, <span class='macro'>EVP_PKEY_EC<span class='macro_popup'>408</span></span>, <span class='macro'>SSL_PKEY_ECC<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="693"><td class="num" id="LN693">693</td><td class="line">     <span class='macro'>NID_ecdsa_with_SHA384<span class='macro_popup'>795</span></span>, <span class='macro'>NID_secp384r1<span class='macro_popup'>715</span></span>},</td></tr>
<tr class="codeline" data-linenumber="694"><td class="num" id="LN694">694</td><td class="line">    {<span class='string_literal'>"ecdsa_secp521r1_sha512"</span>, <span class='macro'>TLSEXT_SIGALG_ecdsa_secp521r1_sha512<span class='macro_popup'>0x0603</span></span>,</td></tr>
<tr class="codeline" data-linenumber="695"><td class="num" id="LN695">695</td><td class="line">     <span class='macro'>NID_sha512<span class='macro_popup'>674</span></span>, <span class='macro'>SSL_MD_SHA512_IDX<span class='macro_popup'>11</span></span>, <span class='macro'>EVP_PKEY_EC<span class='macro_popup'>408</span></span>, <span class='macro'>SSL_PKEY_ECC<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="696"><td class="num" id="LN696">696</td><td class="line">     <span class='macro'>NID_ecdsa_with_SHA512<span class='macro_popup'>796</span></span>, <span class='macro'>NID_secp521r1<span class='macro_popup'>716</span></span>},</td></tr>
<tr class="codeline" data-linenumber="697"><td class="num" id="LN697">697</td><td class="line">    {<span class='string_literal'>"ed25519"</span>, <span class='macro'>TLSEXT_SIGALG_ed25519<span class='macro_popup'>0x0807</span></span>,</td></tr>
<tr class="codeline" data-linenumber="698"><td class="num" id="LN698">698</td><td class="line">     <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>, -1, <span class='macro'>EVP_PKEY_ED25519<span class='macro_popup'>1087</span></span>, <span class='macro'>SSL_PKEY_ED25519<span class='macro_popup'>7</span></span>,</td></tr>
<tr class="codeline" data-linenumber="699"><td class="num" id="LN699">699</td><td class="line">     <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>},</td></tr>
<tr class="codeline" data-linenumber="700"><td class="num" id="LN700">700</td><td class="line">    {<span class='string_literal'>"ed448"</span>, <span class='macro'>TLSEXT_SIGALG_ed448<span class='macro_popup'>0x0808</span></span>,</td></tr>
<tr class="codeline" data-linenumber="701"><td class="num" id="LN701">701</td><td class="line">     <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>, -1, <span class='macro'>EVP_PKEY_ED448<span class='macro_popup'>1088</span></span>, <span class='macro'>SSL_PKEY_ED448<span class='macro_popup'>8</span></span>,</td></tr>
<tr class="codeline" data-linenumber="702"><td class="num" id="LN702">702</td><td class="line">     <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>},</td></tr>
<tr class="codeline" data-linenumber="703"><td class="num" id="LN703">703</td><td class="line">    {<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>TLSEXT_SIGALG_ecdsa_sha224<span class='macro_popup'>0x0303</span></span>,</td></tr>
<tr class="codeline" data-linenumber="704"><td class="num" id="LN704">704</td><td class="line">     <span class='macro'>NID_sha224<span class='macro_popup'>675</span></span>, <span class='macro'>SSL_MD_SHA224_IDX<span class='macro_popup'>10</span></span>, <span class='macro'>EVP_PKEY_EC<span class='macro_popup'>408</span></span>, <span class='macro'>SSL_PKEY_ECC<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="705"><td class="num" id="LN705">705</td><td class="line">     <span class='macro'>NID_ecdsa_with_SHA224<span class='macro_popup'>793</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>},</td></tr>
<tr class="codeline" data-linenumber="706"><td class="num" id="LN706">706</td><td class="line">    {<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>TLSEXT_SIGALG_ecdsa_sha1<span class='macro_popup'>0x0203</span></span>,</td></tr>
<tr class="codeline" data-linenumber="707"><td class="num" id="LN707">707</td><td class="line">     <span class='macro'>NID_sha1<span class='macro_popup'>64</span></span>, <span class='macro'>SSL_MD_SHA1_IDX<span class='macro_popup'>1</span></span>, <span class='macro'>EVP_PKEY_EC<span class='macro_popup'>408</span></span>, <span class='macro'>SSL_PKEY_ECC<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="708"><td class="num" id="LN708">708</td><td class="line">     <span class='macro'>NID_ecdsa_with_SHA1<span class='macro_popup'>416</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>},</td></tr>
<tr class="codeline" data-linenumber="709"><td class="num" id="LN709">709</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="710"><td class="num" id="LN710">710</td><td class="line">    {<span class='string_literal'>"rsa_pss_rsae_sha256"</span>, <span class='macro'>TLSEXT_SIGALG_rsa_pss_rsae_sha256<span class='macro_popup'>0x0804</span></span>,</td></tr>
<tr class="codeline" data-linenumber="711"><td class="num" id="LN711">711</td><td class="line">     <span class='macro'>NID_sha256<span class='macro_popup'>672</span></span>, <span class='macro'>SSL_MD_SHA256_IDX<span class='macro_popup'>4</span></span>, <span class='macro'>EVP_PKEY_RSA_PSS<span class='macro_popup'>912</span></span>, <span class='macro'>SSL_PKEY_RSA<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="712"><td class="num" id="LN712">712</td><td class="line">     <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>},</td></tr>
<tr class="codeline" data-linenumber="713"><td class="num" id="LN713">713</td><td class="line">    {<span class='string_literal'>"rsa_pss_rsae_sha384"</span>, <span class='macro'>TLSEXT_SIGALG_rsa_pss_rsae_sha384<span class='macro_popup'>0x0805</span></span>,</td></tr>
<tr class="codeline" data-linenumber="714"><td class="num" id="LN714">714</td><td class="line">     <span class='macro'>NID_sha384<span class='macro_popup'>673</span></span>, <span class='macro'>SSL_MD_SHA384_IDX<span class='macro_popup'>5</span></span>, <span class='macro'>EVP_PKEY_RSA_PSS<span class='macro_popup'>912</span></span>, <span class='macro'>SSL_PKEY_RSA<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="715"><td class="num" id="LN715">715</td><td class="line">     <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>},</td></tr>
<tr class="codeline" data-linenumber="716"><td class="num" id="LN716">716</td><td class="line">    {<span class='string_literal'>"rsa_pss_rsae_sha512"</span>, <span class='macro'>TLSEXT_SIGALG_rsa_pss_rsae_sha512<span class='macro_popup'>0x0806</span></span>,</td></tr>
<tr class="codeline" data-linenumber="717"><td class="num" id="LN717">717</td><td class="line">     <span class='macro'>NID_sha512<span class='macro_popup'>674</span></span>, <span class='macro'>SSL_MD_SHA512_IDX<span class='macro_popup'>11</span></span>, <span class='macro'>EVP_PKEY_RSA_PSS<span class='macro_popup'>912</span></span>, <span class='macro'>SSL_PKEY_RSA<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="718"><td class="num" id="LN718">718</td><td class="line">     <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>},</td></tr>
<tr class="codeline" data-linenumber="719"><td class="num" id="LN719">719</td><td class="line">    {<span class='string_literal'>"rsa_pss_pss_sha256"</span>, <span class='macro'>TLSEXT_SIGALG_rsa_pss_pss_sha256<span class='macro_popup'>0x0809</span></span>,</td></tr>
<tr class="codeline" data-linenumber="720"><td class="num" id="LN720">720</td><td class="line">     <span class='macro'>NID_sha256<span class='macro_popup'>672</span></span>, <span class='macro'>SSL_MD_SHA256_IDX<span class='macro_popup'>4</span></span>, <span class='macro'>EVP_PKEY_RSA_PSS<span class='macro_popup'>912</span></span>, <span class='macro'>SSL_PKEY_RSA_PSS_SIGN<span class='macro_popup'>1</span></span>,</td></tr>
<tr class="codeline" data-linenumber="721"><td class="num" id="LN721">721</td><td class="line">     <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>},</td></tr>
<tr class="codeline" data-linenumber="722"><td class="num" id="LN722">722</td><td class="line">    {<span class='string_literal'>"rsa_pss_pss_sha384"</span>, <span class='macro'>TLSEXT_SIGALG_rsa_pss_pss_sha384<span class='macro_popup'>0x080a</span></span>,</td></tr>
<tr class="codeline" data-linenumber="723"><td class="num" id="LN723">723</td><td class="line">     <span class='macro'>NID_sha384<span class='macro_popup'>673</span></span>, <span class='macro'>SSL_MD_SHA384_IDX<span class='macro_popup'>5</span></span>, <span class='macro'>EVP_PKEY_RSA_PSS<span class='macro_popup'>912</span></span>, <span class='macro'>SSL_PKEY_RSA_PSS_SIGN<span class='macro_popup'>1</span></span>,</td></tr>
<tr class="codeline" data-linenumber="724"><td class="num" id="LN724">724</td><td class="line">     <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>},</td></tr>
<tr class="codeline" data-linenumber="725"><td class="num" id="LN725">725</td><td class="line">    {<span class='string_literal'>"rsa_pss_pss_sha512"</span>, <span class='macro'>TLSEXT_SIGALG_rsa_pss_pss_sha512<span class='macro_popup'>0x080b</span></span>,</td></tr>
<tr class="codeline" data-linenumber="726"><td class="num" id="LN726">726</td><td class="line">     <span class='macro'>NID_sha512<span class='macro_popup'>674</span></span>, <span class='macro'>SSL_MD_SHA512_IDX<span class='macro_popup'>11</span></span>, <span class='macro'>EVP_PKEY_RSA_PSS<span class='macro_popup'>912</span></span>, <span class='macro'>SSL_PKEY_RSA_PSS_SIGN<span class='macro_popup'>1</span></span>,</td></tr>
<tr class="codeline" data-linenumber="727"><td class="num" id="LN727">727</td><td class="line">     <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>},</td></tr>
<tr class="codeline" data-linenumber="728"><td class="num" id="LN728">728</td><td class="line">    {<span class='string_literal'>"rsa_pkcs1_sha256"</span>, <span class='macro'>TLSEXT_SIGALG_rsa_pkcs1_sha256<span class='macro_popup'>0x0401</span></span>,</td></tr>
<tr class="codeline" data-linenumber="729"><td class="num" id="LN729">729</td><td class="line">     <span class='macro'>NID_sha256<span class='macro_popup'>672</span></span>, <span class='macro'>SSL_MD_SHA256_IDX<span class='macro_popup'>4</span></span>, <span class='macro'>EVP_PKEY_RSA<span class='macro_popup'>6</span></span>, <span class='macro'>SSL_PKEY_RSA<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="730"><td class="num" id="LN730">730</td><td class="line">     <span class='macro'>NID_sha256WithRSAEncryption<span class='macro_popup'>668</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>},</td></tr>
<tr class="codeline" data-linenumber="731"><td class="num" id="LN731">731</td><td class="line">    {<span class='string_literal'>"rsa_pkcs1_sha384"</span>, <span class='macro'>TLSEXT_SIGALG_rsa_pkcs1_sha384<span class='macro_popup'>0x0501</span></span>,</td></tr>
<tr class="codeline" data-linenumber="732"><td class="num" id="LN732">732</td><td class="line">     <span class='macro'>NID_sha384<span class='macro_popup'>673</span></span>, <span class='macro'>SSL_MD_SHA384_IDX<span class='macro_popup'>5</span></span>, <span class='macro'>EVP_PKEY_RSA<span class='macro_popup'>6</span></span>, <span class='macro'>SSL_PKEY_RSA<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="733"><td class="num" id="LN733">733</td><td class="line">     <span class='macro'>NID_sha384WithRSAEncryption<span class='macro_popup'>669</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>},</td></tr>
<tr class="codeline" data-linenumber="734"><td class="num" id="LN734">734</td><td class="line">    {<span class='string_literal'>"rsa_pkcs1_sha512"</span>, <span class='macro'>TLSEXT_SIGALG_rsa_pkcs1_sha512<span class='macro_popup'>0x0601</span></span>,</td></tr>
<tr class="codeline" data-linenumber="735"><td class="num" id="LN735">735</td><td class="line">     <span class='macro'>NID_sha512<span class='macro_popup'>674</span></span>, <span class='macro'>SSL_MD_SHA512_IDX<span class='macro_popup'>11</span></span>, <span class='macro'>EVP_PKEY_RSA<span class='macro_popup'>6</span></span>, <span class='macro'>SSL_PKEY_RSA<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="736"><td class="num" id="LN736">736</td><td class="line">     <span class='macro'>NID_sha512WithRSAEncryption<span class='macro_popup'>670</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>},</td></tr>
<tr class="codeline" data-linenumber="737"><td class="num" id="LN737">737</td><td class="line">    {<span class='string_literal'>"rsa_pkcs1_sha224"</span>, <span class='macro'>TLSEXT_SIGALG_rsa_pkcs1_sha224<span class='macro_popup'>0x0301</span></span>,</td></tr>
<tr class="codeline" data-linenumber="738"><td class="num" id="LN738">738</td><td class="line">     <span class='macro'>NID_sha224<span class='macro_popup'>675</span></span>, <span class='macro'>SSL_MD_SHA224_IDX<span class='macro_popup'>10</span></span>, <span class='macro'>EVP_PKEY_RSA<span class='macro_popup'>6</span></span>, <span class='macro'>SSL_PKEY_RSA<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="739"><td class="num" id="LN739">739</td><td class="line">     <span class='macro'>NID_sha224WithRSAEncryption<span class='macro_popup'>671</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>},</td></tr>
<tr class="codeline" data-linenumber="740"><td class="num" id="LN740">740</td><td class="line">    {<span class='string_literal'>"rsa_pkcs1_sha1"</span>, <span class='macro'>TLSEXT_SIGALG_rsa_pkcs1_sha1<span class='macro_popup'>0x0201</span></span>,</td></tr>
<tr class="codeline" data-linenumber="741"><td class="num" id="LN741">741</td><td class="line">     <span class='macro'>NID_sha1<span class='macro_popup'>64</span></span>, <span class='macro'>SSL_MD_SHA1_IDX<span class='macro_popup'>1</span></span>, <span class='macro'>EVP_PKEY_RSA<span class='macro_popup'>6</span></span>, <span class='macro'>SSL_PKEY_RSA<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="742"><td class="num" id="LN742">742</td><td class="line">     <span class='macro'>NID_sha1WithRSAEncryption<span class='macro_popup'>65</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>},</td></tr>
<tr class="codeline" data-linenumber="743"><td class="num" id="LN743">743</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_DSA</span></td></tr>
<tr class="codeline" data-linenumber="744"><td class="num" id="LN744">744</td><td class="line">    {<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>TLSEXT_SIGALG_dsa_sha256<span class='macro_popup'>0x0402</span></span>,</td></tr>
<tr class="codeline" data-linenumber="745"><td class="num" id="LN745">745</td><td class="line">     <span class='macro'>NID_sha256<span class='macro_popup'>672</span></span>, <span class='macro'>SSL_MD_SHA256_IDX<span class='macro_popup'>4</span></span>, <span class='macro'>EVP_PKEY_DSA<span class='macro_popup'>116</span></span>, <span class='macro'>SSL_PKEY_DSA_SIGN<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="746"><td class="num" id="LN746">746</td><td class="line">     <span class='macro'>NID_dsa_with_SHA256<span class='macro_popup'>803</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>},</td></tr>
<tr class="codeline" data-linenumber="747"><td class="num" id="LN747">747</td><td class="line">    {<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>TLSEXT_SIGALG_dsa_sha384<span class='macro_popup'>0x0502</span></span>,</td></tr>
<tr class="codeline" data-linenumber="748"><td class="num" id="LN748">748</td><td class="line">     <span class='macro'>NID_sha384<span class='macro_popup'>673</span></span>, <span class='macro'>SSL_MD_SHA384_IDX<span class='macro_popup'>5</span></span>, <span class='macro'>EVP_PKEY_DSA<span class='macro_popup'>116</span></span>, <span class='macro'>SSL_PKEY_DSA_SIGN<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="749"><td class="num" id="LN749">749</td><td class="line">     <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>},</td></tr>
<tr class="codeline" data-linenumber="750"><td class="num" id="LN750">750</td><td class="line">    {<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>TLSEXT_SIGALG_dsa_sha512<span class='macro_popup'>0x0602</span></span>,</td></tr>
<tr class="codeline" data-linenumber="751"><td class="num" id="LN751">751</td><td class="line">     <span class='macro'>NID_sha512<span class='macro_popup'>674</span></span>, <span class='macro'>SSL_MD_SHA512_IDX<span class='macro_popup'>11</span></span>, <span class='macro'>EVP_PKEY_DSA<span class='macro_popup'>116</span></span>, <span class='macro'>SSL_PKEY_DSA_SIGN<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="752"><td class="num" id="LN752">752</td><td class="line">     <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>},</td></tr>
<tr class="codeline" data-linenumber="753"><td class="num" id="LN753">753</td><td class="line">    {<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>TLSEXT_SIGALG_dsa_sha224<span class='macro_popup'>0x0302</span></span>,</td></tr>
<tr class="codeline" data-linenumber="754"><td class="num" id="LN754">754</td><td class="line">     <span class='macro'>NID_sha224<span class='macro_popup'>675</span></span>, <span class='macro'>SSL_MD_SHA224_IDX<span class='macro_popup'>10</span></span>, <span class='macro'>EVP_PKEY_DSA<span class='macro_popup'>116</span></span>, <span class='macro'>SSL_PKEY_DSA_SIGN<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="755"><td class="num" id="LN755">755</td><td class="line">     <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>},</td></tr>
<tr class="codeline" data-linenumber="756"><td class="num" id="LN756">756</td><td class="line">    {<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>TLSEXT_SIGALG_dsa_sha1<span class='macro_popup'>0x0202</span></span>,</td></tr>
<tr class="codeline" data-linenumber="757"><td class="num" id="LN757">757</td><td class="line">     <span class='macro'>NID_sha1<span class='macro_popup'>64</span></span>, <span class='macro'>SSL_MD_SHA1_IDX<span class='macro_popup'>1</span></span>, <span class='macro'>EVP_PKEY_DSA<span class='macro_popup'>116</span></span>, <span class='macro'>SSL_PKEY_DSA_SIGN<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="758"><td class="num" id="LN758">758</td><td class="line">     <span class='macro'>NID_dsaWithSHA1<span class='macro_popup'>113</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>},</td></tr>
<tr class="codeline" data-linenumber="759"><td class="num" id="LN759">759</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="760"><td class="num" id="LN760">760</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_GOST</span></td></tr>
<tr class="codeline" data-linenumber="761"><td class="num" id="LN761">761</td><td class="line">    {<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>TLSEXT_SIGALG_gostr34102012_256_gostr34112012_256<span class='macro_popup'>0xeeee</span></span>,</td></tr>
<tr class="codeline" data-linenumber="762"><td class="num" id="LN762">762</td><td class="line">     <span class='macro'>NID_id_GostR3411_2012_256<span class='macro_popup'>982</span></span>, <span class='macro'>SSL_MD_GOST12_256_IDX<span class='macro_popup'>6</span></span>,</td></tr>
<tr class="codeline" data-linenumber="763"><td class="num" id="LN763">763</td><td class="line">     <span class='macro'>NID_id_GostR3410_2012_256<span class='macro_popup'>979</span></span>, <span class='macro'>SSL_PKEY_GOST12_256<span class='macro_popup'>5</span></span>,</td></tr>
<tr class="codeline" data-linenumber="764"><td class="num" id="LN764">764</td><td class="line">     <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>},</td></tr>
<tr class="codeline" data-linenumber="765"><td class="num" id="LN765">765</td><td class="line">    {<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>TLSEXT_SIGALG_gostr34102012_512_gostr34112012_512<span class='macro_popup'>0xefef</span></span>,</td></tr>
<tr class="codeline" data-linenumber="766"><td class="num" id="LN766">766</td><td class="line">     <span class='macro'>NID_id_GostR3411_2012_512<span class='macro_popup'>983</span></span>, <span class='macro'>SSL_MD_GOST12_512_IDX<span class='macro_popup'>8</span></span>,</td></tr>
<tr class="codeline" data-linenumber="767"><td class="num" id="LN767">767</td><td class="line">     <span class='macro'>NID_id_GostR3410_2012_512<span class='macro_popup'>980</span></span>, <span class='macro'>SSL_PKEY_GOST12_512<span class='macro_popup'>6</span></span>,</td></tr>
<tr class="codeline" data-linenumber="768"><td class="num" id="LN768">768</td><td class="line">     <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>},</td></tr>
<tr class="codeline" data-linenumber="769"><td class="num" id="LN769">769</td><td class="line">    {<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>TLSEXT_SIGALG_gostr34102001_gostr3411<span class='macro_popup'>0xeded</span></span>,</td></tr>
<tr class="codeline" data-linenumber="770"><td class="num" id="LN770">770</td><td class="line">     <span class='macro'>NID_id_GostR3411_94<span class='macro_popup'>809</span></span>, <span class='macro'>SSL_MD_GOST94_IDX<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="771"><td class="num" id="LN771">771</td><td class="line">     <span class='macro'>NID_id_GostR3410_2001<span class='macro_popup'>811</span></span>, <span class='macro'>SSL_PKEY_GOST01<span class='macro_popup'>4</span></span>,</td></tr>
<tr class="codeline" data-linenumber="772"><td class="num" id="LN772">772</td><td class="line">     <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>}</td></tr>
<tr class="codeline" data-linenumber="773"><td class="num" id="LN773">773</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="774"><td class="num" id="LN774">774</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="775"><td class="num" id="LN775">775</td><td class="line"><span class='comment'>/* Legacy sigalgs for TLS &lt; 1.2 RSA TLS signatures */</span></td></tr>
<tr class="codeline" data-linenumber="776"><td class="num" id="LN776">776</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> SIGALG_LOOKUP legacy_rsa_sigalg = {</td></tr>
<tr class="codeline" data-linenumber="777"><td class="num" id="LN777">777</td><td class="line">    <span class='string_literal'>"rsa_pkcs1_md5_sha1"</span>, 0,</td></tr>
<tr class="codeline" data-linenumber="778"><td class="num" id="LN778">778</td><td class="line">     <span class='macro'>NID_md5_sha1<span class='macro_popup'>114</span></span>, <span class='macro'>SSL_MD_MD5_SHA1_IDX<span class='macro_popup'>9</span></span>,</td></tr>
<tr class="codeline" data-linenumber="779"><td class="num" id="LN779">779</td><td class="line">     <span class='macro'>EVP_PKEY_RSA<span class='macro_popup'>6</span></span>, <span class='macro'>SSL_PKEY_RSA<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="780"><td class="num" id="LN780">780</td><td class="line">     <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>, <span class='macro'>NID_undef<span class='macro_popup'>0</span></span></td></tr>
<tr class="codeline" data-linenumber="781"><td class="num" id="LN781">781</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="782"><td class="num" id="LN782">782</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="783"><td class="num" id="LN783">783</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="784"><td class="num" id="LN784">784</td><td class="line"> <span class='comment'>* Default signature algorithm values used if signature algorithms not present.</span></td></tr>
<tr class="codeline" data-linenumber="785"><td class="num" id="LN785">785</td><td class="line"> <span class='comment'>* From RFC5246. Note: order must match certificate index order.</span></td></tr>
<tr class="codeline" data-linenumber="786"><td class="num" id="LN786">786</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="787"><td class="num" id="LN787">787</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> uint16_t tls_default_sigalg[] = {</td></tr>
<tr class="codeline" data-linenumber="788"><td class="num" id="LN788">788</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_rsa_pkcs1_sha1<span class='macro_popup'>0x0201</span></span>, <span class='comment'>/* SSL_PKEY_RSA */</span></td></tr>
<tr class="codeline" data-linenumber="789"><td class="num" id="LN789">789</td><td class="line">    0, <span class='comment'>/* SSL_PKEY_RSA_PSS_SIGN */</span></td></tr>
<tr class="codeline" data-linenumber="790"><td class="num" id="LN790">790</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_dsa_sha1<span class='macro_popup'>0x0202</span></span>, <span class='comment'>/* SSL_PKEY_DSA_SIGN */</span></td></tr>
<tr class="codeline" data-linenumber="791"><td class="num" id="LN791">791</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_ecdsa_sha1<span class='macro_popup'>0x0203</span></span>, <span class='comment'>/* SSL_PKEY_ECC */</span></td></tr>
<tr class="codeline" data-linenumber="792"><td class="num" id="LN792">792</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_gostr34102001_gostr3411<span class='macro_popup'>0xeded</span></span>, <span class='comment'>/* SSL_PKEY_GOST01 */</span></td></tr>
<tr class="codeline" data-linenumber="793"><td class="num" id="LN793">793</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_gostr34102012_256_gostr34112012_256<span class='macro_popup'>0xeeee</span></span>, <span class='comment'>/* SSL_PKEY_GOST12_256 */</span></td></tr>
<tr class="codeline" data-linenumber="794"><td class="num" id="LN794">794</td><td class="line">    <span class='macro'>TLSEXT_SIGALG_gostr34102012_512_gostr34112012_512<span class='macro_popup'>0xefef</span></span>, <span class='comment'>/* SSL_PKEY_GOST12_512 */</span></td></tr>
<tr class="codeline" data-linenumber="795"><td class="num" id="LN795">795</td><td class="line">    0, <span class='comment'>/* SSL_PKEY_ED25519 */</span></td></tr>
<tr class="codeline" data-linenumber="796"><td class="num" id="LN796">796</td><td class="line">    0, <span class='comment'>/* SSL_PKEY_ED448 */</span></td></tr>
<tr class="codeline" data-linenumber="797"><td class="num" id="LN797">797</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="798"><td class="num" id="LN798">798</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="799"><td class="num" id="LN799">799</td><td class="line"><span class='comment'>/* Lookup TLS signature algorithm */</span></td></tr>
<tr class="codeline" data-linenumber="800"><td class="num" id="LN800">800</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> SIGALG_LOOKUP *tls1_lookup_sigalg(uint16_t sigalg)</td></tr>
<tr class="codeline" data-linenumber="801"><td class="num" id="LN801">801</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="802"><td class="num" id="LN802">802</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="803"><td class="num" id="LN803">803</td><td class="line">    <span class='keyword'>const</span> SIGALG_LOOKUP *s;</td></tr>
<tr class="codeline" data-linenumber="804"><td class="num" id="LN804">804</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="805"><td class="num" id="LN805">805</td><td class="line">    <span class='keyword'>for</span> (i = 0, s = sigalg_lookup_tbl; i &lt; <span class='macro'>OSSL_NELEM(sigalg_lookup_tbl)<span class='macro_popup'>(sizeof(sigalg_lookup_tbl)/sizeof((sigalg_lookup_tbl)[0]))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="806"><td class="num" id="LN806">806</td><td class="line">         i++, s++) {</td></tr>
<tr class="codeline" data-linenumber="807"><td class="num" id="LN807">807</td><td class="line">        <span class='keyword'>if</span> (s-&gt;sigalg == sigalg)</td></tr>
<tr class="codeline" data-linenumber="808"><td class="num" id="LN808">808</td><td class="line">            <span class='keyword'>return</span> s;</td></tr>
<tr class="codeline" data-linenumber="809"><td class="num" id="LN809">809</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="810"><td class="num" id="LN810">810</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="811"><td class="num" id="LN811">811</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="812"><td class="num" id="LN812">812</td><td class="line"><span class='comment'>/* Lookup hash: return 0 if invalid or not enabled */</span></td></tr>
<tr class="codeline" data-linenumber="813"><td class="num" id="LN813">813</td><td class="line"><span class='keyword'>int</span> tls1_lookup_md(<span class='keyword'>const</span> SIGALG_LOOKUP *lu, <span class='keyword'>const</span> EVP_MD **pmd)</td></tr>
<tr class="codeline" data-linenumber="814"><td class="num" id="LN814">814</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="815"><td class="num" id="LN815">815</td><td class="line">    <span class='keyword'>const</span> EVP_MD *md;</td></tr>
<tr class="codeline" data-linenumber="816"><td class="num" id="LN816">816</td><td class="line">    <span class='keyword'>if</span> (lu == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="817"><td class="num" id="LN817">817</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="818"><td class="num" id="LN818">818</td><td class="line">    <span class='comment'>/* lu-&gt;hash == NID_undef means no associated digest */</span></td></tr>
<tr class="codeline" data-linenumber="819"><td class="num" id="LN819">819</td><td class="line">    <span class='keyword'>if</span> (lu-&gt;hash == <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="820"><td class="num" id="LN820">820</td><td class="line">        md = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="821"><td class="num" id="LN821">821</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="822"><td class="num" id="LN822">822</td><td class="line">        md = ssl_md(lu-&gt;hash_idx);</td></tr>
<tr class="codeline" data-linenumber="823"><td class="num" id="LN823">823</td><td class="line">        <span class='keyword'>if</span> (md == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="824"><td class="num" id="LN824">824</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="825"><td class="num" id="LN825">825</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="826"><td class="num" id="LN826">826</td><td class="line">    <span class='keyword'>if</span> (pmd)</td></tr>
<tr class="codeline" data-linenumber="827"><td class="num" id="LN827">827</td><td class="line">        *pmd = md;</td></tr>
<tr class="codeline" data-linenumber="828"><td class="num" id="LN828">828</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="829"><td class="num" id="LN829">829</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="830"><td class="num" id="LN830">830</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="831"><td class="num" id="LN831">831</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="832"><td class="num" id="LN832">832</td><td class="line"> <span class='comment'>* Check if key is large enough to generate RSA-PSS signature.</span></td></tr>
<tr class="codeline" data-linenumber="833"><td class="num" id="LN833">833</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="834"><td class="num" id="LN834">834</td><td class="line"> <span class='comment'>* The key must greater than or equal to 2 * hash length + 2.</span></td></tr>
<tr class="codeline" data-linenumber="835"><td class="num" id="LN835">835</td><td class="line"> <span class='comment'>* SHA512 has a hash length of 64 bytes, which is incompatible</span></td></tr>
<tr class="codeline" data-linenumber="836"><td class="num" id="LN836">836</td><td class="line"> <span class='comment'>* with a 128 byte (1024 bit) key.</span></td></tr>
<tr class="codeline" data-linenumber="837"><td class="num" id="LN837">837</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="838"><td class="num" id="LN838">838</td><td class="line"><span class='directive'>#define <span class='macro'>RSA_PSS_MINIMUM_KEY_SIZE(md)<span class='macro_popup'>(2 * EVP_MD_size(md) + 2)</span></span> (2 * EVP_MD_size(md) + 2)</span></td></tr>
<tr class="codeline" data-linenumber="839"><td class="num" id="LN839">839</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> rsa_pss_check_min_key_size(<span class='keyword'>const</span> RSA *rsa, <span class='keyword'>const</span> SIGALG_LOOKUP *lu)</td></tr>
<tr class="codeline" data-linenumber="840"><td class="num" id="LN840">840</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="841"><td class="num" id="LN841">841</td><td class="line">    <span class='keyword'>const</span> EVP_MD *md;</td></tr>
<tr class="codeline" data-linenumber="842"><td class="num" id="LN842">842</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="843"><td class="num" id="LN843">843</td><td class="line">    <span class='keyword'>if</span> (rsa == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="844"><td class="num" id="LN844">844</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="845"><td class="num" id="LN845">845</td><td class="line">    <span class='keyword'>if</span> (!tls1_lookup_md(lu, &amp;md) || md == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="846"><td class="num" id="LN846">846</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="847"><td class="num" id="LN847">847</td><td class="line">    <span class='keyword'>if</span> (RSA_size(rsa) &lt; <span class='macro'>RSA_PSS_MINIMUM_KEY_SIZE(md)<span class='macro_popup'>(2 * EVP_MD_size(md) + 2)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="848"><td class="num" id="LN848">848</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="849"><td class="num" id="LN849">849</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="850"><td class="num" id="LN850">850</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="851"><td class="num" id="LN851">851</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="852"><td class="num" id="LN852">852</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="853"><td class="num" id="LN853">853</td><td class="line"> <span class='comment'>* Returns a signature algorithm when the peer did not send a list of supported</span></td></tr>
<tr class="codeline" data-linenumber="854"><td class="num" id="LN854">854</td><td class="line"> <span class='comment'>* signature algorithms. The signature algorithm is fixed for the certificate</span></td></tr>
<tr class="codeline" data-linenumber="855"><td class="num" id="LN855">855</td><td class="line"> <span class='comment'>* type. |idx| is a certificate type index (SSL_PKEY_*). When |idx| is -1 the</span></td></tr>
<tr class="codeline" data-linenumber="856"><td class="num" id="LN856">856</td><td class="line"> <span class='comment'>* certificate type from |s| will be used.</span></td></tr>
<tr class="codeline" data-linenumber="857"><td class="num" id="LN857">857</td><td class="line"> <span class='comment'>* Returns the signature algorithm to use, or NULL on error.</span></td></tr>
<tr class="codeline" data-linenumber="858"><td class="num" id="LN858">858</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="859"><td class="num" id="LN859">859</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> SIGALG_LOOKUP *tls1_get_legacy_sigalg(<span class='keyword'>const</span> SSL *s, <span class='keyword'>int</span> idx)</td></tr>
<tr class="codeline" data-linenumber="860"><td class="num" id="LN860">860</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="861"><td class="num" id="LN861">861</td><td class="line">    <span class='keyword'>if</span> (idx == -1) {</td></tr>
<tr class="codeline" data-linenumber="862"><td class="num" id="LN862">862</td><td class="line">        <span class='keyword'>if</span> (s-&gt;server) {</td></tr>
<tr class="codeline" data-linenumber="863"><td class="num" id="LN863">863</td><td class="line">            size_t i;</td></tr>
<tr class="codeline" data-linenumber="864"><td class="num" id="LN864">864</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="865"><td class="num" id="LN865">865</td><td class="line">            <span class='comment'>/* Work out index corresponding to ciphersuite */</span></td></tr>
<tr class="codeline" data-linenumber="866"><td class="num" id="LN866">866</td><td class="line">            <span class='keyword'>for</span> (i = 0; i &lt; <span class='macro'>SSL_PKEY_NUM<span class='macro_popup'>9</span></span>; i++) {</td></tr>
<tr class="codeline" data-linenumber="867"><td class="num" id="LN867">867</td><td class="line">                <span class='keyword'>const</span> SSL_CERT_LOOKUP *clu = ssl_cert_lookup_by_idx(i);</td></tr>
<tr class="codeline" data-linenumber="868"><td class="num" id="LN868">868</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="869"><td class="num" id="LN869">869</td><td class="line">                <span class='keyword'>if</span> (clu-&gt;amask &amp; s-&gt;s3-&gt;tmp.new_cipher-&gt;algorithm_auth) {</td></tr>
<tr class="codeline" data-linenumber="870"><td class="num" id="LN870">870</td><td class="line">                    idx = i;</td></tr>
<tr class="codeline" data-linenumber="871"><td class="num" id="LN871">871</td><td class="line">                    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="872"><td class="num" id="LN872">872</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="873"><td class="num" id="LN873">873</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="874"><td class="num" id="LN874">874</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="875"><td class="num" id="LN875">875</td><td class="line">            <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="876"><td class="num" id="LN876">876</td><td class="line">             <span class='comment'>* Some GOST ciphersuites allow more than one signature algorithms</span></td></tr>
<tr class="codeline" data-linenumber="877"><td class="num" id="LN877">877</td><td class="line">             <span class='comment'>* */</span></td></tr>
<tr class="codeline" data-linenumber="878"><td class="num" id="LN878">878</td><td class="line">            <span class='keyword'>if</span> (idx == <span class='macro'>SSL_PKEY_GOST01<span class='macro_popup'>4</span></span> &amp;&amp; s-&gt;s3-&gt;tmp.new_cipher-&gt;algorithm_auth != <span class='macro'>SSL_aGOST01<span class='macro_popup'>0x00000020U</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="879"><td class="num" id="LN879">879</td><td class="line">                <span class='keyword'>int</span> real_idx;</td></tr>
<tr class="codeline" data-linenumber="880"><td class="num" id="LN880">880</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="881"><td class="num" id="LN881">881</td><td class="line">                <span class='keyword'>for</span> (real_idx = <span class='macro'>SSL_PKEY_GOST12_512<span class='macro_popup'>6</span></span>; real_idx &gt;= <span class='macro'>SSL_PKEY_GOST01<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="882"><td class="num" id="LN882">882</td><td class="line">                     real_idx--) {</td></tr>
<tr class="codeline" data-linenumber="883"><td class="num" id="LN883">883</td><td class="line">                    <span class='keyword'>if</span> (s-&gt;cert-&gt;pkeys[real_idx].privatekey != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="884"><td class="num" id="LN884">884</td><td class="line">                        idx = real_idx;</td></tr>
<tr class="codeline" data-linenumber="885"><td class="num" id="LN885">885</td><td class="line">                        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="886"><td class="num" id="LN886">886</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="887"><td class="num" id="LN887">887</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="888"><td class="num" id="LN888">888</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="889"><td class="num" id="LN889">889</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="890"><td class="num" id="LN890">890</td><td class="line">            idx = s-&gt;cert-&gt;key - s-&gt;cert-&gt;pkeys;</td></tr>
<tr class="codeline" data-linenumber="891"><td class="num" id="LN891">891</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="892"><td class="num" id="LN892">892</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="893"><td class="num" id="LN893">893</td><td class="line">    <span class='keyword'>if</span> (idx &lt; 0 || idx &gt;= (<span class='keyword'>int</span>)<span class='macro'>OSSL_NELEM(tls_default_sigalg)<span class='macro_popup'>(sizeof(tls_default_sigalg)/sizeof((tls_default_sigalg)[0]))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="894"><td class="num" id="LN894">894</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="895"><td class="num" id="LN895">895</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>SSL_USE_SIGALGS(s)<span class='macro_popup'>(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x2)</span></span> || idx != <span class='macro'>SSL_PKEY_RSA<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="896"><td class="num" id="LN896">896</td><td class="line">        <span class='keyword'>const</span> SIGALG_LOOKUP *lu = tls1_lookup_sigalg(tls_default_sigalg[idx]);</td></tr>
<tr class="codeline" data-linenumber="897"><td class="num" id="LN897">897</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="898"><td class="num" id="LN898">898</td><td class="line">        <span class='keyword'>if</span> (!tls1_lookup_md(lu, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="899"><td class="num" id="LN899">899</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="900"><td class="num" id="LN900">900</td><td class="line">        <span class='keyword'>if</span> (!tls12_sigalg_allowed(s, <span class='macro'>SSL_SECOP_SIGALG_SUPPORTED<span class='macro_popup'>(11 | (5 &lt;&lt; 16))</span></span>, lu))</td></tr>
<tr class="codeline" data-linenumber="901"><td class="num" id="LN901">901</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="902"><td class="num" id="LN902">902</td><td class="line">        <span class='keyword'>return</span> lu;</td></tr>
<tr class="codeline" data-linenumber="903"><td class="num" id="LN903">903</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="904"><td class="num" id="LN904">904</td><td class="line">    <span class='keyword'>if</span> (!tls12_sigalg_allowed(s, <span class='macro'>SSL_SECOP_SIGALG_SUPPORTED<span class='macro_popup'>(11 | (5 &lt;&lt; 16))</span></span>, &amp;legacy_rsa_sigalg))</td></tr>
<tr class="codeline" data-linenumber="905"><td class="num" id="LN905">905</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="906"><td class="num" id="LN906">906</td><td class="line">    <span class='keyword'>return</span> &amp;legacy_rsa_sigalg;</td></tr>
<tr class="codeline" data-linenumber="907"><td class="num" id="LN907">907</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="908"><td class="num" id="LN908">908</td><td class="line"><span class='comment'>/* Set peer sigalg based key type */</span></td></tr>
<tr class="codeline" data-linenumber="909"><td class="num" id="LN909">909</td><td class="line"><span class='keyword'>int</span> tls1_set_peer_legacy_sigalg(SSL *s, <span class='keyword'>const</span> EVP_PKEY *pkey)</td></tr>
<tr class="codeline" data-linenumber="910"><td class="num" id="LN910">910</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="911"><td class="num" id="LN911">911</td><td class="line">    size_t idx;</td></tr>
<tr class="codeline" data-linenumber="912"><td class="num" id="LN912">912</td><td class="line">    <span class='keyword'>const</span> SIGALG_LOOKUP *lu;</td></tr>
<tr class="codeline" data-linenumber="913"><td class="num" id="LN913">913</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="914"><td class="num" id="LN914">914</td><td class="line">    <span class='keyword'>if</span> (ssl_cert_lookup_by_pkey(pkey, &amp;idx) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="915"><td class="num" id="LN915">915</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="916"><td class="num" id="LN916">916</td><td class="line">    lu = tls1_get_legacy_sigalg(s, idx);</td></tr>
<tr class="codeline" data-linenumber="917"><td class="num" id="LN917">917</td><td class="line">    <span class='keyword'>if</span> (lu == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="918"><td class="num" id="LN918">918</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="919"><td class="num" id="LN919">919</td><td class="line">    s-&gt;s3-&gt;tmp.peer_sigalg = lu;</td></tr>
<tr class="codeline" data-linenumber="920"><td class="num" id="LN920">920</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="921"><td class="num" id="LN921">921</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="922"><td class="num" id="LN922">922</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="923"><td class="num" id="LN923">923</td><td class="line">size_t tls12_get_psigalgs(SSL *s, <span class='keyword'>int</span> sent, <span class='keyword'>const</span> uint16_t **psigs)</td></tr>
<tr class="codeline" data-linenumber="924"><td class="num" id="LN924">924</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="925"><td class="num" id="LN925">925</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="926"><td class="num" id="LN926">926</td><td class="line">     <span class='comment'>* If Suite B mode use Suite B sigalgs only, ignore any other</span></td></tr>
<tr class="codeline" data-linenumber="927"><td class="num" id="LN927">927</td><td class="line">     <span class='comment'>* preferences.</span></td></tr>
<tr class="codeline" data-linenumber="928"><td class="num" id="LN928">928</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="929"><td class="num" id="LN929">929</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="930"><td class="num" id="LN930">930</td><td class="line">    <span class='keyword'>switch</span> (<span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="931"><td class="num" id="LN931">931</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>SSL_CERT_FLAG_SUITEB_128_LOS<span class='macro_popup'>0x30000</span></span>:</td></tr>
<tr class="codeline" data-linenumber="932"><td class="num" id="LN932">932</td><td class="line">        *psigs = suiteb_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="933"><td class="num" id="LN933">933</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>OSSL_NELEM(suiteb_sigalgs)<span class='macro_popup'>(sizeof(suiteb_sigalgs)/sizeof((suiteb_sigalgs)[0]))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="934"><td class="num" id="LN934">934</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="935"><td class="num" id="LN935">935</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>SSL_CERT_FLAG_SUITEB_128_LOS_ONLY<span class='macro_popup'>0x10000</span></span>:</td></tr>
<tr class="codeline" data-linenumber="936"><td class="num" id="LN936">936</td><td class="line">        *psigs = suiteb_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="937"><td class="num" id="LN937">937</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="938"><td class="num" id="LN938">938</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="939"><td class="num" id="LN939">939</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>SSL_CERT_FLAG_SUITEB_192_LOS<span class='macro_popup'>0x20000</span></span>:</td></tr>
<tr class="codeline" data-linenumber="940"><td class="num" id="LN940">940</td><td class="line">        *psigs = suiteb_sigalgs + 1;</td></tr>
<tr class="codeline" data-linenumber="941"><td class="num" id="LN941">941</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="942"><td class="num" id="LN942">942</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="943"><td class="num" id="LN943">943</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="944"><td class="num" id="LN944">944</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="945"><td class="num" id="LN945">945</td><td class="line">     <span class='comment'>*  We use client_sigalgs (if not NULL) if we're a server</span></td></tr>
<tr class="codeline" data-linenumber="946"><td class="num" id="LN946">946</td><td class="line">     <span class='comment'>*  and sending a certificate request or if we're a client and</span></td></tr>
<tr class="codeline" data-linenumber="947"><td class="num" id="LN947">947</td><td class="line">     <span class='comment'>*  determining which shared algorithm to use.</span></td></tr>
<tr class="codeline" data-linenumber="948"><td class="num" id="LN948">948</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="949"><td class="num" id="LN949">949</td><td class="line">    <span class='keyword'>if</span> ((s-&gt;server == sent) &amp;&amp; s-&gt;cert-&gt;client_sigalgs != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="950"><td class="num" id="LN950">950</td><td class="line">        *psigs = s-&gt;cert-&gt;client_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="951"><td class="num" id="LN951">951</td><td class="line">        <span class='keyword'>return</span> s-&gt;cert-&gt;client_sigalgslen;</td></tr>
<tr class="codeline" data-linenumber="952"><td class="num" id="LN952">952</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (s-&gt;cert-&gt;conf_sigalgs) {</td></tr>
<tr class="codeline" data-linenumber="953"><td class="num" id="LN953">953</td><td class="line">        *psigs = s-&gt;cert-&gt;conf_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="954"><td class="num" id="LN954">954</td><td class="line">        <span class='keyword'>return</span> s-&gt;cert-&gt;conf_sigalgslen;</td></tr>
<tr class="codeline" data-linenumber="955"><td class="num" id="LN955">955</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="956"><td class="num" id="LN956">956</td><td class="line">        *psigs = tls12_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="957"><td class="num" id="LN957">957</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>OSSL_NELEM(tls12_sigalgs)<span class='macro_popup'>(sizeof(tls12_sigalgs)/sizeof((tls12_sigalgs)[0]))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="958"><td class="num" id="LN958">958</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="959"><td class="num" id="LN959">959</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="960"><td class="num" id="LN960">960</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="961"><td class="num" id="LN961">961</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="962"><td class="num" id="LN962">962</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="963"><td class="num" id="LN963">963</td><td class="line"> <span class='comment'>* Called by servers only. Checks that we have a sig alg that supports the</span></td></tr>
<tr class="codeline" data-linenumber="964"><td class="num" id="LN964">964</td><td class="line"> <span class='comment'>* specified EC curve.</span></td></tr>
<tr class="codeline" data-linenumber="965"><td class="num" id="LN965">965</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="966"><td class="num" id="LN966">966</td><td class="line"><span class='keyword'>int</span> tls_check_sigalg_curve(<span class='keyword'>const</span> SSL *s, <span class='keyword'>int</span> curve)</td></tr>
<tr class="codeline" data-linenumber="967"><td class="num" id="LN967">967</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="968"><td class="num" id="LN968">968</td><td class="line">   <span class='keyword'>const</span> uint16_t *sigs;</td></tr>
<tr class="codeline" data-linenumber="969"><td class="num" id="LN969">969</td><td class="line">   size_t siglen, i;</td></tr>
<tr class="codeline" data-linenumber="970"><td class="num" id="LN970">970</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="971"><td class="num" id="LN971">971</td><td class="line">    <span class='keyword'>if</span> (s-&gt;cert-&gt;conf_sigalgs) {</td></tr>
<tr class="codeline" data-linenumber="972"><td class="num" id="LN972">972</td><td class="line">        sigs = s-&gt;cert-&gt;conf_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="973"><td class="num" id="LN973">973</td><td class="line">        siglen = s-&gt;cert-&gt;conf_sigalgslen;</td></tr>
<tr class="codeline" data-linenumber="974"><td class="num" id="LN974">974</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="975"><td class="num" id="LN975">975</td><td class="line">        sigs = tls12_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="976"><td class="num" id="LN976">976</td><td class="line">        siglen = <span class='macro'>OSSL_NELEM(tls12_sigalgs)<span class='macro_popup'>(sizeof(tls12_sigalgs)/sizeof((tls12_sigalgs)[0]))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="977"><td class="num" id="LN977">977</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="978"><td class="num" id="LN978">978</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="979"><td class="num" id="LN979">979</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; siglen; i++) {</td></tr>
<tr class="codeline" data-linenumber="980"><td class="num" id="LN980">980</td><td class="line">        <span class='keyword'>const</span> SIGALG_LOOKUP *lu = tls1_lookup_sigalg(sigs[i]);</td></tr>
<tr class="codeline" data-linenumber="981"><td class="num" id="LN981">981</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="982"><td class="num" id="LN982">982</td><td class="line">        <span class='keyword'>if</span> (lu == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="983"><td class="num" id="LN983">983</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="984"><td class="num" id="LN984">984</td><td class="line">        <span class='keyword'>if</span> (lu-&gt;sig == <span class='macro'>EVP_PKEY_EC<span class='macro_popup'>408</span></span></td></tr>
<tr class="codeline" data-linenumber="985"><td class="num" id="LN985">985</td><td class="line">                &amp;&amp; lu-&gt;curve != <span class='macro'>NID_undef<span class='macro_popup'>0</span></span></td></tr>
<tr class="codeline" data-linenumber="986"><td class="num" id="LN986">986</td><td class="line">                &amp;&amp; curve == lu-&gt;curve)</td></tr>
<tr class="codeline" data-linenumber="987"><td class="num" id="LN987">987</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="988"><td class="num" id="LN988">988</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="989"><td class="num" id="LN989">989</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="990"><td class="num" id="LN990">990</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="991"><td class="num" id="LN991">991</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="992"><td class="num" id="LN992">992</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="993"><td class="num" id="LN993">993</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="994"><td class="num" id="LN994">994</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="995"><td class="num" id="LN995">995</td><td class="line"> <span class='comment'>* Return the number of security bits for the signature algorithm, or 0 on</span></td></tr>
<tr class="codeline" data-linenumber="996"><td class="num" id="LN996">996</td><td class="line"> <span class='comment'>* error.</span></td></tr>
<tr class="codeline" data-linenumber="997"><td class="num" id="LN997">997</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="998"><td class="num" id="LN998">998</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> sigalg_security_bits(<span class='keyword'>const</span> SIGALG_LOOKUP *lu)</td></tr>
<tr class="codeline" data-linenumber="999"><td class="num" id="LN999">999</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1000"><td class="num" id="LN1000">1000</td><td class="line">    <span class='keyword'>const</span> EVP_MD *md = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1001"><td class="num" id="LN1001">1001</td><td class="line">    <span class='keyword'>int</span> secbits = 0;</td></tr>
<tr class="codeline" data-linenumber="1002"><td class="num" id="LN1002">1002</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1003"><td class="num" id="LN1003">1003</td><td class="line">    <span class='keyword'>if</span> (!tls1_lookup_md(lu, &amp;md))</td></tr>
<tr class="codeline" data-linenumber="1004"><td class="num" id="LN1004">1004</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1005"><td class="num" id="LN1005">1005</td><td class="line">    <span class='keyword'>if</span> (md != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1006"><td class="num" id="LN1006">1006</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1007"><td class="num" id="LN1007">1007</td><td class="line">        <span class='comment'>/* Security bits: half digest bits */</span></td></tr>
<tr class="codeline" data-linenumber="1008"><td class="num" id="LN1008">1008</td><td class="line">        secbits = EVP_MD_size(md) * 4;</td></tr>
<tr class="codeline" data-linenumber="1009"><td class="num" id="LN1009">1009</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1010"><td class="num" id="LN1010">1010</td><td class="line">        <span class='comment'>/* Values from https://tools.ietf.org/html/rfc8032#section-8.5 */</span></td></tr>
<tr class="codeline" data-linenumber="1011"><td class="num" id="LN1011">1011</td><td class="line">        <span class='keyword'>if</span> (lu-&gt;sigalg == <span class='macro'>TLSEXT_SIGALG_ed25519<span class='macro_popup'>0x0807</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1012"><td class="num" id="LN1012">1012</td><td class="line">            secbits = 128;</td></tr>
<tr class="codeline" data-linenumber="1013"><td class="num" id="LN1013">1013</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (lu-&gt;sigalg == <span class='macro'>TLSEXT_SIGALG_ed448<span class='macro_popup'>0x0808</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1014"><td class="num" id="LN1014">1014</td><td class="line">            secbits = 224;</td></tr>
<tr class="codeline" data-linenumber="1015"><td class="num" id="LN1015">1015</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1016"><td class="num" id="LN1016">1016</td><td class="line">    <span class='keyword'>return</span> secbits;</td></tr>
<tr class="codeline" data-linenumber="1017"><td class="num" id="LN1017">1017</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1018"><td class="num" id="LN1018">1018</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1019"><td class="num" id="LN1019">1019</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1020"><td class="num" id="LN1020">1020</td><td class="line"> <span class='comment'>* Check signature algorithm is consistent with sent supported signature</span></td></tr>
<tr class="codeline" data-linenumber="1021"><td class="num" id="LN1021">1021</td><td class="line"> <span class='comment'>* algorithms and if so set relevant digest and signature scheme in</span></td></tr>
<tr class="codeline" data-linenumber="1022"><td class="num" id="LN1022">1022</td><td class="line"> <span class='comment'>* s.</span></td></tr>
<tr class="codeline" data-linenumber="1023"><td class="num" id="LN1023">1023</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1024"><td class="num" id="LN1024">1024</td><td class="line"><span class='keyword'>int</span> tls12_check_peer_sigalg(SSL *s, uint16_t sig, EVP_PKEY *pkey)</td></tr>
<tr class="codeline" data-linenumber="1025"><td class="num" id="LN1025">1025</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1026"><td class="num" id="LN1026">1026</td><td class="line">    <span class='keyword'>const</span> uint16_t *sent_sigs;</td></tr>
<tr class="codeline" data-linenumber="1027"><td class="num" id="LN1027">1027</td><td class="line">    <span class='keyword'>const</span> EVP_MD *md = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1028"><td class="num" id="LN1028">1028</td><td class="line">    <span class='keyword'>char</span> sigalgstr[2];</td></tr>
<tr class="codeline" data-linenumber="1029"><td class="num" id="LN1029">1029</td><td class="line">    size_t sent_sigslen, i, cidx;</td></tr>
<tr class="codeline" data-linenumber="1030"><td class="num" id="LN1030">1030</td><td class="line">    <span class='keyword'>int</span> pkeyid = EVP_PKEY_id(pkey);</td></tr>
<tr class="codeline" data-linenumber="1031"><td class="num" id="LN1031">1031</td><td class="line">    <span class='keyword'>const</span> SIGALG_LOOKUP *lu;</td></tr>
<tr class="codeline" data-linenumber="1032"><td class="num" id="LN1032">1032</td><td class="line">    <span class='keyword'>int</span> secbits = 0;</td></tr>
<tr class="codeline" data-linenumber="1033"><td class="num" id="LN1033">1033</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1034"><td class="num" id="LN1034">1034</td><td class="line">    <span class='comment'>/* Should never happen */</span></td></tr>
<tr class="codeline" data-linenumber="1035"><td class="num" id="LN1035">1035</td><td class="line">    <span class='keyword'>if</span> (pkeyid == -1)</td></tr>
<tr class="codeline" data-linenumber="1036"><td class="num" id="LN1036">1036</td><td class="line">        <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="1037"><td class="num" id="LN1037">1037</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>SSL_IS_TLS13(s)<span class='macro_popup'>(!(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8) &amp;&amp;<br> (s)-&gt;method-&gt;version &gt;= 0x0304 &amp;&amp; (s)-&gt;method<br>-&gt;version != 0x10000)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1038"><td class="num" id="LN1038">1038</td><td class="line">        <span class='comment'>/* Disallow DSA for TLS 1.3 */</span></td></tr>
<tr class="codeline" data-linenumber="1039"><td class="num" id="LN1039">1039</td><td class="line">        <span class='keyword'>if</span> (pkeyid == <span class='macro'>EVP_PKEY_DSA<span class='macro_popup'>116</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1040"><td class="num" id="LN1040">1040</td><td class="line">            <span class='macro'>SSLfatal(s, SSL_AD_ILLEGAL_PARAMETER, SSL_F_TLS12_CHECK_PEER_SIGALG,<span class='macro_popup'>ossl_statem_fatal((s), (47), (333), (370), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1041)</span></span></td></tr>
<tr class="codeline" data-linenumber="1041"><td class="num" id="LN1041">1041</td><td class="line">                     <span class='macro'>SSL_R_WRONG_SIGNATURE_TYPE)<span class='macro_popup'>ossl_statem_fatal((s), (47), (333), (370), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1041)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1042"><td class="num" id="LN1042">1042</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1043"><td class="num" id="LN1043">1043</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1044"><td class="num" id="LN1044">1044</td><td class="line">        <span class='comment'>/* Only allow PSS for TLS 1.3 */</span></td></tr>
<tr class="codeline" data-linenumber="1045"><td class="num" id="LN1045">1045</td><td class="line">        <span class='keyword'>if</span> (pkeyid == <span class='macro'>EVP_PKEY_RSA<span class='macro_popup'>6</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1046"><td class="num" id="LN1046">1046</td><td class="line">            pkeyid = <span class='macro'>EVP_PKEY_RSA_PSS<span class='macro_popup'>912</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1047"><td class="num" id="LN1047">1047</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1048"><td class="num" id="LN1048">1048</td><td class="line">    lu = tls1_lookup_sigalg(sig);</td></tr>
<tr class="codeline" data-linenumber="1049"><td class="num" id="LN1049">1049</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1050"><td class="num" id="LN1050">1050</td><td class="line">     <span class='comment'>* Check sigalgs is known. Disallow SHA1/SHA224 with TLS 1.3. Check key type</span></td></tr>
<tr class="codeline" data-linenumber="1051"><td class="num" id="LN1051">1051</td><td class="line">     <span class='comment'>* is consistent with signature: RSA keys can be used for RSA-PSS</span></td></tr>
<tr class="codeline" data-linenumber="1052"><td class="num" id="LN1052">1052</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1053"><td class="num" id="LN1053">1053</td><td class="line">    <span class='keyword'>if</span> (lu == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="1054"><td class="num" id="LN1054">1054</td><td class="line">        || (<span class='macro'>SSL_IS_TLS13(s)<span class='macro_popup'>(!(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8) &amp;&amp;<br> (s)-&gt;method-&gt;version &gt;= 0x0304 &amp;&amp; (s)-&gt;method<br>-&gt;version != 0x10000)</span></span> &amp;&amp; (lu-&gt;hash == <span class='macro'>NID_sha1<span class='macro_popup'>64</span></span> || lu-&gt;hash == <span class='macro'>NID_sha224<span class='macro_popup'>675</span></span>))</td></tr>
<tr class="codeline" data-linenumber="1055"><td class="num" id="LN1055">1055</td><td class="line">        || (pkeyid != lu-&gt;sig</td></tr>
<tr class="codeline" data-linenumber="1056"><td class="num" id="LN1056">1056</td><td class="line">        &amp;&amp; (lu-&gt;sig != <span class='macro'>EVP_PKEY_RSA_PSS<span class='macro_popup'>912</span></span> || pkeyid != <span class='macro'>EVP_PKEY_RSA<span class='macro_popup'>6</span></span>))) {</td></tr>
<tr class="codeline" data-linenumber="1057"><td class="num" id="LN1057">1057</td><td class="line">        <span class='macro'>SSLfatal(s, SSL_AD_ILLEGAL_PARAMETER, SSL_F_TLS12_CHECK_PEER_SIGALG,<span class='macro_popup'>ossl_statem_fatal((s), (47), (333), (370), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1058)</span></span></td></tr>
<tr class="codeline" data-linenumber="1058"><td class="num" id="LN1058">1058</td><td class="line">                 <span class='macro'>SSL_R_WRONG_SIGNATURE_TYPE)<span class='macro_popup'>ossl_statem_fatal((s), (47), (333), (370), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1058)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1059"><td class="num" id="LN1059">1059</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1060"><td class="num" id="LN1060">1060</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1061"><td class="num" id="LN1061">1061</td><td class="line">    <span class='comment'>/* Check the sigalg is consistent with the key OID */</span></td></tr>
<tr class="codeline" data-linenumber="1062"><td class="num" id="LN1062">1062</td><td class="line">    <span class='keyword'>if</span> (!ssl_cert_lookup_by_nid(EVP_PKEY_id(pkey), &amp;cidx)</td></tr>
<tr class="codeline" data-linenumber="1063"><td class="num" id="LN1063">1063</td><td class="line">            || lu-&gt;sig_idx != (<span class='keyword'>int</span>)cidx) {</td></tr>
<tr class="codeline" data-linenumber="1064"><td class="num" id="LN1064">1064</td><td class="line">        <span class='macro'>SSLfatal(s, SSL_AD_ILLEGAL_PARAMETER, SSL_F_TLS12_CHECK_PEER_SIGALG,<span class='macro_popup'>ossl_statem_fatal((s), (47), (333), (370), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1065)</span></span></td></tr>
<tr class="codeline" data-linenumber="1065"><td class="num" id="LN1065">1065</td><td class="line">                 <span class='macro'>SSL_R_WRONG_SIGNATURE_TYPE)<span class='macro_popup'>ossl_statem_fatal((s), (47), (333), (370), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1065)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1066"><td class="num" id="LN1066">1066</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1067"><td class="num" id="LN1067">1067</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1068"><td class="num" id="LN1068">1068</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1069"><td class="num" id="LN1069">1069</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="1070"><td class="num" id="LN1070">1070</td><td class="line">    <span class='keyword'>if</span> (pkeyid == <span class='macro'>EVP_PKEY_EC<span class='macro_popup'>408</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1071"><td class="num" id="LN1071">1071</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1072"><td class="num" id="LN1072">1072</td><td class="line">        <span class='comment'>/* Check point compression is permitted */</span></td></tr>
<tr class="codeline" data-linenumber="1073"><td class="num" id="LN1073">1073</td><td class="line">        <span class='keyword'>if</span> (!tls1_check_pkey_comp(s, pkey)) {</td></tr>
<tr class="codeline" data-linenumber="1074"><td class="num" id="LN1074">1074</td><td class="line">            <span class='macro'>SSLfatal(s, SSL_AD_ILLEGAL_PARAMETER,<span class='macro_popup'>ossl_statem_fatal((s), (47), (333), (162), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1076)</span></span></td></tr>
<tr class="codeline" data-linenumber="1075"><td class="num" id="LN1075">1075</td><td class="line">                     <span class='macro'>SSL_F_TLS12_CHECK_PEER_SIGALG,<span class='macro_popup'>ossl_statem_fatal((s), (47), (333), (162), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1076)</span></span></td></tr>
<tr class="codeline" data-linenumber="1076"><td class="num" id="LN1076">1076</td><td class="line">                     <span class='macro'>SSL_R_ILLEGAL_POINT_COMPRESSION)<span class='macro_popup'>ossl_statem_fatal((s), (47), (333), (162), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1076)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1077"><td class="num" id="LN1077">1077</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1078"><td class="num" id="LN1078">1078</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1079"><td class="num" id="LN1079">1079</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1080"><td class="num" id="LN1080">1080</td><td class="line">        <span class='comment'>/* For TLS 1.3 or Suite B check curve matches signature algorithm */</span></td></tr>
<tr class="codeline" data-linenumber="1081"><td class="num" id="LN1081">1081</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>SSL_IS_TLS13(s)<span class='macro_popup'>(!(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8) &amp;&amp;<br> (s)-&gt;method-&gt;version &gt;= 0x0304 &amp;&amp; (s)-&gt;method<br>-&gt;version != 0x10000)</span></span> || <span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1082"><td class="num" id="LN1082">1082</td><td class="line">            EC_KEY *ec = EVP_PKEY_get0_EC_KEY(pkey);</td></tr>
<tr class="codeline" data-linenumber="1083"><td class="num" id="LN1083">1083</td><td class="line">            <span class='keyword'>int</span> curve = EC_GROUP_get_curve_name(EC_KEY_get0_group(ec));</td></tr>
<tr class="codeline" data-linenumber="1084"><td class="num" id="LN1084">1084</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1085"><td class="num" id="LN1085">1085</td><td class="line">            <span class='keyword'>if</span> (lu-&gt;curve != <span class='macro'>NID_undef<span class='macro_popup'>0</span></span> &amp;&amp; curve != lu-&gt;curve) {</td></tr>
<tr class="codeline" data-linenumber="1086"><td class="num" id="LN1086">1086</td><td class="line">                <span class='macro'>SSLfatal(s, SSL_AD_ILLEGAL_PARAMETER,<span class='macro_popup'>ossl_statem_fatal((s), (47), (333), (378), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1087)</span></span></td></tr>
<tr class="codeline" data-linenumber="1087"><td class="num" id="LN1087">1087</td><td class="line">                         <span class='macro'>SSL_F_TLS12_CHECK_PEER_SIGALG, SSL_R_WRONG_CURVE)<span class='macro_popup'>ossl_statem_fatal((s), (47), (333), (378), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1087)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1088"><td class="num" id="LN1088">1088</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1089"><td class="num" id="LN1089">1089</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1090"><td class="num" id="LN1090">1090</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1091"><td class="num" id="LN1091">1091</td><td class="line">        <span class='keyword'>if</span> (!<span class='macro'>SSL_IS_TLS13(s)<span class='macro_popup'>(!(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8) &amp;&amp;<br> (s)-&gt;method-&gt;version &gt;= 0x0304 &amp;&amp; (s)-&gt;method<br>-&gt;version != 0x10000)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1092"><td class="num" id="LN1092">1092</td><td class="line">            <span class='comment'>/* Check curve matches extensions */</span></td></tr>
<tr class="codeline" data-linenumber="1093"><td class="num" id="LN1093">1093</td><td class="line">            <span class='keyword'>if</span> (!tls1_check_group_id(s, tls1_get_group_id(pkey), 1)) {</td></tr>
<tr class="codeline" data-linenumber="1094"><td class="num" id="LN1094">1094</td><td class="line">                <span class='macro'>SSLfatal(s, SSL_AD_ILLEGAL_PARAMETER,<span class='macro_popup'>ossl_statem_fatal((s), (47), (333), (378), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1095)</span></span></td></tr>
<tr class="codeline" data-linenumber="1095"><td class="num" id="LN1095">1095</td><td class="line">                         <span class='macro'>SSL_F_TLS12_CHECK_PEER_SIGALG, SSL_R_WRONG_CURVE)<span class='macro_popup'>ossl_statem_fatal((s), (47), (333), (378), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1095)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1096"><td class="num" id="LN1096">1096</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1097"><td class="num" id="LN1097">1097</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1098"><td class="num" id="LN1098">1098</td><td class="line">            <span class='keyword'>if</span> (<span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1099"><td class="num" id="LN1099">1099</td><td class="line">                <span class='comment'>/* Check sigalg matches a permissible Suite B value */</span></td></tr>
<tr class="codeline" data-linenumber="1100"><td class="num" id="LN1100">1100</td><td class="line">                <span class='keyword'>if</span> (sig != <span class='macro'>TLSEXT_SIGALG_ecdsa_secp256r1_sha256<span class='macro_popup'>0x0403</span></span></td></tr>
<tr class="codeline" data-linenumber="1101"><td class="num" id="LN1101">1101</td><td class="line">                    &amp;&amp; sig != <span class='macro'>TLSEXT_SIGALG_ecdsa_secp384r1_sha384<span class='macro_popup'>0x0503</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1102"><td class="num" id="LN1102">1102</td><td class="line">                    <span class='macro'>SSLfatal(s, SSL_AD_HANDSHAKE_FAILURE,<span class='macro_popup'>ossl_statem_fatal((s), (40), (333), (370), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1104)</span></span></td></tr>
<tr class="codeline" data-linenumber="1103"><td class="num" id="LN1103">1103</td><td class="line">                             <span class='macro'>SSL_F_TLS12_CHECK_PEER_SIGALG,<span class='macro_popup'>ossl_statem_fatal((s), (40), (333), (370), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1104)</span></span></td></tr>
<tr class="codeline" data-linenumber="1104"><td class="num" id="LN1104">1104</td><td class="line">                             <span class='macro'>SSL_R_WRONG_SIGNATURE_TYPE)<span class='macro_popup'>ossl_statem_fatal((s), (40), (333), (370), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1104)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1105"><td class="num" id="LN1105">1105</td><td class="line">                    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1106"><td class="num" id="LN1106">1106</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1107"><td class="num" id="LN1107">1107</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1108"><td class="num" id="LN1108">1108</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1109"><td class="num" id="LN1109">1109</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1110"><td class="num" id="LN1110">1110</td><td class="line">        <span class='macro'>SSLfatal(s, SSL_AD_HANDSHAKE_FAILURE, SSL_F_TLS12_CHECK_PEER_SIGALG,<span class='macro_popup'>ossl_statem_fatal((s), (40), (333), (370), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1111)</span></span></td></tr>
<tr class="codeline" data-linenumber="1111"><td class="num" id="LN1111">1111</td><td class="line">                 <span class='macro'>SSL_R_WRONG_SIGNATURE_TYPE)<span class='macro_popup'>ossl_statem_fatal((s), (40), (333), (370), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1111)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1112"><td class="num" id="LN1112">1112</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1113"><td class="num" id="LN1113">1113</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1114"><td class="num" id="LN1114">1114</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1115"><td class="num" id="LN1115">1115</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1116"><td class="num" id="LN1116">1116</td><td class="line">    <span class='comment'>/* Check signature matches a type we sent */</span></td></tr>
<tr class="codeline" data-linenumber="1117"><td class="num" id="LN1117">1117</td><td class="line">    sent_sigslen = tls12_get_psigalgs(s, 1, &amp;sent_sigs);</td></tr>
<tr class="codeline" data-linenumber="1118"><td class="num" id="LN1118">1118</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; sent_sigslen; i++, sent_sigs++) {</td></tr>
<tr class="codeline" data-linenumber="1119"><td class="num" id="LN1119">1119</td><td class="line">        <span class='keyword'>if</span> (sig == *sent_sigs)</td></tr>
<tr class="codeline" data-linenumber="1120"><td class="num" id="LN1120">1120</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1121"><td class="num" id="LN1121">1121</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1122"><td class="num" id="LN1122">1122</td><td class="line">    <span class='comment'>/* Allow fallback to SHA1 if not strict mode */</span></td></tr>
<tr class="codeline" data-linenumber="1123"><td class="num" id="LN1123">1123</td><td class="line">    <span class='keyword'>if</span> (i == sent_sigslen &amp;&amp; (lu-&gt;hash != <span class='macro'>NID_sha1<span class='macro_popup'>64</span></span></td></tr>
<tr class="codeline" data-linenumber="1124"><td class="num" id="LN1124">1124</td><td class="line">        || s-&gt;cert-&gt;cert_flags &amp; <span class='macro'>SSL_CERT_FLAGS_CHECK_TLS_STRICT<span class='macro_popup'>(0x30000|0x00000001U)</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="1125"><td class="num" id="LN1125">1125</td><td class="line">        <span class='macro'>SSLfatal(s, SSL_AD_HANDSHAKE_FAILURE, SSL_F_TLS12_CHECK_PEER_SIGALG,<span class='macro_popup'>ossl_statem_fatal((s), (40), (333), (370), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1126)</span></span></td></tr>
<tr class="codeline" data-linenumber="1126"><td class="num" id="LN1126">1126</td><td class="line">                 <span class='macro'>SSL_R_WRONG_SIGNATURE_TYPE)<span class='macro_popup'>ossl_statem_fatal((s), (40), (333), (370), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1126)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1127"><td class="num" id="LN1127">1127</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1128"><td class="num" id="LN1128">1128</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1129"><td class="num" id="LN1129">1129</td><td class="line">    <span class='keyword'>if</span> (!tls1_lookup_md(lu, &amp;md)) {</td></tr>
<tr class="codeline" data-linenumber="1130"><td class="num" id="LN1130">1130</td><td class="line">        <span class='macro'>SSLfatal(s, SSL_AD_HANDSHAKE_FAILURE, SSL_F_TLS12_CHECK_PEER_SIGALG,<span class='macro_popup'>ossl_statem_fatal((s), (40), (333), (368), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1131)</span></span></td></tr>
<tr class="codeline" data-linenumber="1131"><td class="num" id="LN1131">1131</td><td class="line">                 <span class='macro'>SSL_R_UNKNOWN_DIGEST)<span class='macro_popup'>ossl_statem_fatal((s), (40), (333), (368), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1131)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1132"><td class="num" id="LN1132">1132</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1133"><td class="num" id="LN1133">1133</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1134"><td class="num" id="LN1134">1134</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1135"><td class="num" id="LN1135">1135</td><td class="line">     <span class='comment'>* Make sure security callback allows algorithm. For historical</span></td></tr>
<tr class="codeline" data-linenumber="1136"><td class="num" id="LN1136">1136</td><td class="line">     <span class='comment'>* reasons we have to pass the sigalg as a two byte char array.</span></td></tr>
<tr class="codeline" data-linenumber="1137"><td class="num" id="LN1137">1137</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1138"><td class="num" id="LN1138">1138</td><td class="line">    sigalgstr[0] = (sig &gt;&gt; 8) &amp; 0xff;</td></tr>
<tr class="codeline" data-linenumber="1139"><td class="num" id="LN1139">1139</td><td class="line">    sigalgstr[1] = sig &amp; 0xff;</td></tr>
<tr class="codeline" data-linenumber="1140"><td class="num" id="LN1140">1140</td><td class="line">    secbits = sigalg_security_bits(lu);</td></tr>
<tr class="codeline" data-linenumber="1141"><td class="num" id="LN1141">1141</td><td class="line">    <span class='keyword'>if</span> (secbits == 0 ||</td></tr>
<tr class="codeline" data-linenumber="1142"><td class="num" id="LN1142">1142</td><td class="line">        !ssl_security(s, <span class='macro'>SSL_SECOP_SIGALG_CHECK<span class='macro_popup'>(13 | (5 &lt;&lt; 16))</span></span>, secbits,</td></tr>
<tr class="codeline" data-linenumber="1143"><td class="num" id="LN1143">1143</td><td class="line">                      md != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> ? EVP_MD_type(md) : <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1144"><td class="num" id="LN1144">1144</td><td class="line">                      (<span class='keyword'>void</span> *)sigalgstr)) {</td></tr>
<tr class="codeline" data-linenumber="1145"><td class="num" id="LN1145">1145</td><td class="line">        <span class='macro'>SSLfatal(s, SSL_AD_HANDSHAKE_FAILURE, SSL_F_TLS12_CHECK_PEER_SIGALG,<span class='macro_popup'>ossl_statem_fatal((s), (40), (333), (370), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1146)</span></span></td></tr>
<tr class="codeline" data-linenumber="1146"><td class="num" id="LN1146">1146</td><td class="line">                 <span class='macro'>SSL_R_WRONG_SIGNATURE_TYPE)<span class='macro_popup'>ossl_statem_fatal((s), (40), (333), (370), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1146)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1147"><td class="num" id="LN1147">1147</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1148"><td class="num" id="LN1148">1148</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1149"><td class="num" id="LN1149">1149</td><td class="line">    <span class='comment'>/* Store the sigalg the peer uses */</span></td></tr>
<tr class="codeline" data-linenumber="1150"><td class="num" id="LN1150">1150</td><td class="line">    s-&gt;s3-&gt;tmp.peer_sigalg = lu;</td></tr>
<tr class="codeline" data-linenumber="1151"><td class="num" id="LN1151">1151</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1152"><td class="num" id="LN1152">1152</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1153"><td class="num" id="LN1153">1153</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1154"><td class="num" id="LN1154">1154</td><td class="line"><span class='keyword'>int</span> SSL_get_peer_signature_type_nid(<span class='keyword'>const</span> SSL *s, <span class='keyword'>int</span> *pnid)</td></tr>
<tr class="codeline" data-linenumber="1155"><td class="num" id="LN1155">1155</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1156"><td class="num" id="LN1156">1156</td><td class="line">    <span class='keyword'>if</span> (s-&gt;s3-&gt;tmp.peer_sigalg == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1157"><td class="num" id="LN1157">1157</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1158"><td class="num" id="LN1158">1158</td><td class="line">    *pnid = s-&gt;s3-&gt;tmp.peer_sigalg-&gt;sig;</td></tr>
<tr class="codeline" data-linenumber="1159"><td class="num" id="LN1159">1159</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1160"><td class="num" id="LN1160">1160</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1161"><td class="num" id="LN1161">1161</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1162"><td class="num" id="LN1162">1162</td><td class="line"><span class='keyword'>int</span> SSL_get_signature_type_nid(<span class='keyword'>const</span> SSL *s, <span class='keyword'>int</span> *pnid)</td></tr>
<tr class="codeline" data-linenumber="1163"><td class="num" id="LN1163">1163</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1164"><td class="num" id="LN1164">1164</td><td class="line">    <span class='keyword'>if</span> (s-&gt;s3-&gt;tmp.sigalg == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1165"><td class="num" id="LN1165">1165</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1166"><td class="num" id="LN1166">1166</td><td class="line">    *pnid = s-&gt;s3-&gt;tmp.sigalg-&gt;sig;</td></tr>
<tr class="codeline" data-linenumber="1167"><td class="num" id="LN1167">1167</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1168"><td class="num" id="LN1168">1168</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1169"><td class="num" id="LN1169">1169</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1170"><td class="num" id="LN1170">1170</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1171"><td class="num" id="LN1171">1171</td><td class="line"> <span class='comment'>* Set a mask of disabled algorithms: an algorithm is disabled if it isn't</span></td></tr>
<tr class="codeline" data-linenumber="1172"><td class="num" id="LN1172">1172</td><td class="line"> <span class='comment'>* supported, doesn't appear in supported signature algorithms, isn't supported</span></td></tr>
<tr class="codeline" data-linenumber="1173"><td class="num" id="LN1173">1173</td><td class="line"> <span class='comment'>* by the enabled protocol versions or by the security level.</span></td></tr>
<tr class="codeline" data-linenumber="1174"><td class="num" id="LN1174">1174</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1175"><td class="num" id="LN1175">1175</td><td class="line"> <span class='comment'>* This function should only be used for checking which ciphers are supported</span></td></tr>
<tr class="codeline" data-linenumber="1176"><td class="num" id="LN1176">1176</td><td class="line"> <span class='comment'>* by the client.</span></td></tr>
<tr class="codeline" data-linenumber="1177"><td class="num" id="LN1177">1177</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1178"><td class="num" id="LN1178">1178</td><td class="line"> <span class='comment'>* Call ssl_cipher_disabled() to check that it's enabled or not.</span></td></tr>
<tr class="codeline" data-linenumber="1179"><td class="num" id="LN1179">1179</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1180"><td class="num" id="LN1180">1180</td><td class="line"><span class='keyword'>int</span> ssl_set_client_disabled(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="1181"><td class="num" id="LN1181">1181</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1182"><td class="num" id="LN1182">1182</td><td class="line">    s-&gt;s3-&gt;tmp.mask_a = 0;</td></tr>
<tr class="codeline" data-linenumber="1183"><td class="num" id="LN1183">1183</td><td class="line">    s-&gt;s3-&gt;tmp.mask_k = 0;</td></tr>
<tr class="codeline" data-linenumber="1184"><td class="num" id="LN1184">1184</td><td class="line">    ssl_set_sig_mask(&amp;s-&gt;s3-&gt;tmp.mask_a, s, <span class='macro'>SSL_SECOP_SIGALG_MASK<span class='macro_popup'>(14 | (5 &lt;&lt; 16))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1185"><td class="num" id="LN1185">1185</td><td class="line">    <span class='keyword'>if</span> (ssl_get_min_max_version(s, &amp;s-&gt;s3-&gt;tmp.min_ver,</td></tr>
<tr class="codeline" data-linenumber="1186"><td class="num" id="LN1186">1186</td><td class="line">                                &amp;s-&gt;s3-&gt;tmp.max_ver, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) != 0)</td></tr>
<tr class="codeline" data-linenumber="1187"><td class="num" id="LN1187">1187</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1188"><td class="num" id="LN1188">1188</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_PSK</span></td></tr>
<tr class="codeline" data-linenumber="1189"><td class="num" id="LN1189">1189</td><td class="line">    <span class='comment'>/* with PSK there must be client callback set */</span></td></tr>
<tr class="codeline" data-linenumber="1190"><td class="num" id="LN1190">1190</td><td class="line">    <span class='keyword'>if</span> (!s-&gt;psk_client_callback) {</td></tr>
<tr class="codeline" data-linenumber="1191"><td class="num" id="LN1191">1191</td><td class="line">        s-&gt;s3-&gt;tmp.mask_a |= <span class='macro'>SSL_aPSK<span class='macro_popup'>0x00000010U</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1192"><td class="num" id="LN1192">1192</td><td class="line">        s-&gt;s3-&gt;tmp.mask_k |= <span class='macro'>SSL_PSK<span class='macro_popup'>(0x00000008U | 0x00000040U | 0x00000080U | 0x00000100U)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1193"><td class="num" id="LN1193">1193</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1194"><td class="num" id="LN1194">1194</td><td class="line"><span class='directive'>#endif                          /* OPENSSL_NO_PSK */</span></td></tr>
<tr class="codeline" data-linenumber="1195"><td class="num" id="LN1195">1195</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_SRP</span></td></tr>
<tr class="codeline" data-linenumber="1196"><td class="num" id="LN1196">1196</td><td class="line">    <span class='keyword'>if</span> (!(s-&gt;srp_ctx.srp_Mask &amp; <span class='macro'>SSL_kSRP<span class='macro_popup'>0x00000020U</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="1197"><td class="num" id="LN1197">1197</td><td class="line">        s-&gt;s3-&gt;tmp.mask_a |= <span class='macro'>SSL_aSRP<span class='macro_popup'>0x00000040U</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1198"><td class="num" id="LN1198">1198</td><td class="line">        s-&gt;s3-&gt;tmp.mask_k |= <span class='macro'>SSL_kSRP<span class='macro_popup'>0x00000020U</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1199"><td class="num" id="LN1199">1199</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1200"><td class="num" id="LN1200">1200</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1201"><td class="num" id="LN1201">1201</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1202"><td class="num" id="LN1202">1202</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1203"><td class="num" id="LN1203">1203</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1204"><td class="num" id="LN1204">1204</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1205"><td class="num" id="LN1205">1205</td><td class="line"> <span class='comment'>* ssl_cipher_disabled - check that a cipher is disabled or not</span></td></tr>
<tr class="codeline" data-linenumber="1206"><td class="num" id="LN1206">1206</td><td class="line"> <span class='comment'>* @s: SSL connection that you want to use the cipher on</span></td></tr>
<tr class="codeline" data-linenumber="1207"><td class="num" id="LN1207">1207</td><td class="line"> <span class='comment'>* @c: cipher to check</span></td></tr>
<tr class="codeline" data-linenumber="1208"><td class="num" id="LN1208">1208</td><td class="line"> <span class='comment'>* @op: Security check that you want to do</span></td></tr>
<tr class="codeline" data-linenumber="1209"><td class="num" id="LN1209">1209</td><td class="line"> <span class='comment'>* @ecdhe: If set to 1 then TLSv1 ECDHE ciphers are also allowed in SSLv3</span></td></tr>
<tr class="codeline" data-linenumber="1210"><td class="num" id="LN1210">1210</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1211"><td class="num" id="LN1211">1211</td><td class="line"> <span class='comment'>* Returns 1 when it's disabled, 0 when enabled.</span></td></tr>
<tr class="codeline" data-linenumber="1212"><td class="num" id="LN1212">1212</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1213"><td class="num" id="LN1213">1213</td><td class="line"><span class='keyword'>int</span> ssl_cipher_disabled(<span class='keyword'>const</span> SSL *s, <span class='keyword'>const</span> SSL_CIPHER *c, <span class='keyword'>int</span> op, <span class='keyword'>int</span> ecdhe)</td></tr>
<tr class="codeline" data-linenumber="1214"><td class="num" id="LN1214">1214</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1215"><td class="num" id="LN1215">1215</td><td class="line">    <span class='keyword'>if</span> (c-&gt;algorithm_mkey &amp; s-&gt;s3-&gt;tmp.mask_k</td></tr>
<tr class="codeline" data-linenumber="1216"><td class="num" id="LN1216">1216</td><td class="line">        || c-&gt;algorithm_auth &amp; s-&gt;s3-&gt;tmp.mask_a)</td></tr>
<tr class="codeline" data-linenumber="1217"><td class="num" id="LN1217">1217</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1218"><td class="num" id="LN1218">1218</td><td class="line">    <span class='keyword'>if</span> (s-&gt;s3-&gt;tmp.max_ver == 0)</td></tr>
<tr class="codeline" data-linenumber="1219"><td class="num" id="LN1219">1219</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1220"><td class="num" id="LN1220">1220</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>SSL_IS_DTLS(s)<span class='macro_popup'>(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1221"><td class="num" id="LN1221">1221</td><td class="line">        <span class='keyword'>int</span> min_tls = c-&gt;min_tls;</td></tr>
<tr class="codeline" data-linenumber="1222"><td class="num" id="LN1222">1222</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1223"><td class="num" id="LN1223">1223</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1224"><td class="num" id="LN1224">1224</td><td class="line">         <span class='comment'>* For historical reasons we will allow ECHDE to be selected by a server</span></td></tr>
<tr class="codeline" data-linenumber="1225"><td class="num" id="LN1225">1225</td><td class="line">         <span class='comment'>* in SSLv3 if we are a client</span></td></tr>
<tr class="codeline" data-linenumber="1226"><td class="num" id="LN1226">1226</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1227"><td class="num" id="LN1227">1227</td><td class="line">        <span class='keyword'>if</span> (min_tls == <span class='macro'>TLS1_VERSION<span class='macro_popup'>0x0301</span></span> &amp;&amp; ecdhe</td></tr>
<tr class="codeline" data-linenumber="1228"><td class="num" id="LN1228">1228</td><td class="line">                &amp;&amp; (c-&gt;algorithm_mkey &amp; (<span class='macro'>SSL_kECDHE<span class='macro_popup'>0x00000004U</span></span> | <span class='macro'>SSL_kECDHEPSK<span class='macro_popup'>0x00000080U</span></span>)) != 0)</td></tr>
<tr class="codeline" data-linenumber="1229"><td class="num" id="LN1229">1229</td><td class="line">            min_tls = <span class='macro'>SSL3_VERSION<span class='macro_popup'>0x0300</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1230"><td class="num" id="LN1230">1230</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1231"><td class="num" id="LN1231">1231</td><td class="line">        <span class='keyword'>if</span> ((min_tls &gt; s-&gt;s3-&gt;tmp.max_ver) || (c-&gt;max_tls &lt; s-&gt;s3-&gt;tmp.min_ver))</td></tr>
<tr class="codeline" data-linenumber="1232"><td class="num" id="LN1232">1232</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1233"><td class="num" id="LN1233">1233</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1234"><td class="num" id="LN1234">1234</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>SSL_IS_DTLS(s)<span class='macro_popup'>(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8)</span></span> &amp;&amp; (<span class='macro'>DTLS_VERSION_GT(c-&gt;min_dtls, s-&gt;s3-&gt;tmp.max_ver)<span class='macro_popup'>((((c-&gt;min_dtls) == 0x0100) ? 0xff00 : (c-&gt;min_dtls)) &lt;<br> (((s-&gt;s3-&gt;tmp.max_ver) == 0x0100) ? 0xff00 : (s-&gt;s3<br>-&gt;tmp.max_ver)))</span></span></td></tr>
<tr class="codeline" data-linenumber="1235"><td class="num" id="LN1235">1235</td><td class="line">                           || <span class='macro'>DTLS_VERSION_LT(c-&gt;max_dtls, s-&gt;s3-&gt;tmp.min_ver)<span class='macro_popup'>((((c-&gt;max_dtls) == 0x0100) ? 0xff00 : (c-&gt;max_dtls)) &gt;<br> (((s-&gt;s3-&gt;tmp.min_ver) == 0x0100) ? 0xff00 : (s-&gt;s3<br>-&gt;tmp.min_ver)))</span></span>))</td></tr>
<tr class="codeline" data-linenumber="1236"><td class="num" id="LN1236">1236</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1237"><td class="num" id="LN1237">1237</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1238"><td class="num" id="LN1238">1238</td><td class="line">    <span class='keyword'>return</span> !ssl_security(s, op, c-&gt;strength_bits, 0, (<span class='keyword'>void</span> *)c);</td></tr>
<tr class="codeline" data-linenumber="1239"><td class="num" id="LN1239">1239</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1240"><td class="num" id="LN1240">1240</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1241"><td class="num" id="LN1241">1241</td><td class="line"><span class='keyword'>int</span> tls_use_ticket(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="1242"><td class="num" id="LN1242">1242</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1243"><td class="num" id="LN1243">1243</td><td class="line">    <span class='keyword'>if</span> ((s-&gt;options &amp; <span class='macro'>SSL_OP_NO_TICKET<span class='macro_popup'>0x00004000U</span></span>))</td></tr>
<tr class="codeline" data-linenumber="1244"><td class="num" id="LN1244">1244</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1245"><td class="num" id="LN1245">1245</td><td class="line">    <span class='keyword'>return</span> ssl_security(s, <span class='macro'>SSL_SECOP_TICKET<span class='macro_popup'>(10 | 0)</span></span>, 0, 0, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1246"><td class="num" id="LN1246">1246</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1247"><td class="num" id="LN1247">1247</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1248"><td class="num" id="LN1248">1248</td><td class="line"><span class='keyword'>int</span> tls1_set_server_sigalgs(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="1249"><td class="num" id="LN1249">1249</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1250"><td class="num" id="LN1250">1250</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="1251"><td class="num" id="LN1251">1251</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1252"><td class="num" id="LN1252">1252</td><td class="line">    <span class='comment'>/* Clear any shared signature algorithms */</span></td></tr>
<tr class="codeline" data-linenumber="1253"><td class="num" id="LN1253">1253</td><td class="line">    <span class='macro'>OPENSSL_free(s-&gt;shared_sigalgs)<span class='macro_popup'>CRYPTO_free(s-&gt;shared_sigalgs, "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1253)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1254"><td class="num" id="LN1254">1254</td><td class="line">    s-&gt;shared_sigalgs = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1255"><td class="num" id="LN1255">1255</td><td class="line">    s-&gt;shared_sigalgslen = 0;</td></tr>
<tr class="codeline" data-linenumber="1256"><td class="num" id="LN1256">1256</td><td class="line">    <span class='comment'>/* Clear certificate validity flags */</span></td></tr>
<tr class="codeline" data-linenumber="1257"><td class="num" id="LN1257">1257</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; <span class='macro'>SSL_PKEY_NUM<span class='macro_popup'>9</span></span>; i++)</td></tr>
<tr class="codeline" data-linenumber="1258"><td class="num" id="LN1258">1258</td><td class="line">        s-&gt;s3-&gt;tmp.valid_flags[i] = 0;</td></tr>
<tr class="codeline" data-linenumber="1259"><td class="num" id="LN1259">1259</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1260"><td class="num" id="LN1260">1260</td><td class="line">     <span class='comment'>* If peer sent no signature algorithms check to see if we support</span></td></tr>
<tr class="codeline" data-linenumber="1261"><td class="num" id="LN1261">1261</td><td class="line">     <span class='comment'>* the default algorithm for each certificate type</span></td></tr>
<tr class="codeline" data-linenumber="1262"><td class="num" id="LN1262">1262</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1263"><td class="num" id="LN1263">1263</td><td class="line">    <span class='keyword'>if</span> (s-&gt;s3-&gt;tmp.peer_cert_sigalgs == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="1264"><td class="num" id="LN1264">1264</td><td class="line">            &amp;&amp; s-&gt;s3-&gt;tmp.peer_sigalgs == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1265"><td class="num" id="LN1265">1265</td><td class="line">        <span class='keyword'>const</span> uint16_t *sent_sigs;</td></tr>
<tr class="codeline" data-linenumber="1266"><td class="num" id="LN1266">1266</td><td class="line">        size_t sent_sigslen = tls12_get_psigalgs(s, 1, &amp;sent_sigs);</td></tr>
<tr class="codeline" data-linenumber="1267"><td class="num" id="LN1267">1267</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1268"><td class="num" id="LN1268">1268</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; <span class='macro'>SSL_PKEY_NUM<span class='macro_popup'>9</span></span>; i++) {</td></tr>
<tr class="codeline" data-linenumber="1269"><td class="num" id="LN1269">1269</td><td class="line">            <span class='keyword'>const</span> SIGALG_LOOKUP *lu = tls1_get_legacy_sigalg(s, i);</td></tr>
<tr class="codeline" data-linenumber="1270"><td class="num" id="LN1270">1270</td><td class="line">            size_t j;</td></tr>
<tr class="codeline" data-linenumber="1271"><td class="num" id="LN1271">1271</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1272"><td class="num" id="LN1272">1272</td><td class="line">            <span class='keyword'>if</span> (lu == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1273"><td class="num" id="LN1273">1273</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1274"><td class="num" id="LN1274">1274</td><td class="line">            <span class='comment'>/* Check default matches a type we sent */</span></td></tr>
<tr class="codeline" data-linenumber="1275"><td class="num" id="LN1275">1275</td><td class="line">            <span class='keyword'>for</span> (j = 0; j &lt; sent_sigslen; j++) {</td></tr>
<tr class="codeline" data-linenumber="1276"><td class="num" id="LN1276">1276</td><td class="line">                <span class='keyword'>if</span> (lu-&gt;sigalg == sent_sigs[j]) {</td></tr>
<tr class="codeline" data-linenumber="1277"><td class="num" id="LN1277">1277</td><td class="line">                        s-&gt;s3-&gt;tmp.valid_flags[i] = <span class='macro'>CERT_PKEY_SIGN<span class='macro_popup'>0x2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1278"><td class="num" id="LN1278">1278</td><td class="line">                        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1279"><td class="num" id="LN1279">1279</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1280"><td class="num" id="LN1280">1280</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1281"><td class="num" id="LN1281">1281</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1282"><td class="num" id="LN1282">1282</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1283"><td class="num" id="LN1283">1283</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1284"><td class="num" id="LN1284">1284</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1285"><td class="num" id="LN1285">1285</td><td class="line">    <span class='keyword'>if</span> (!tls1_process_sigalgs(s)) {</td></tr>
<tr class="codeline" data-linenumber="1286"><td class="num" id="LN1286">1286</td><td class="line">        <span class='macro'>SSLfatal(s, SSL_AD_INTERNAL_ERROR,<span class='macro_popup'>ossl_statem_fatal((s), (80), (335), ((4|64)), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1287)</span></span></td></tr>
<tr class="codeline" data-linenumber="1287"><td class="num" id="LN1287">1287</td><td class="line">                 <span class='macro'>SSL_F_TLS1_SET_SERVER_SIGALGS, ERR_R_INTERNAL_ERROR)<span class='macro_popup'>ossl_statem_fatal((s), (80), (335), ((4|64)), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1287)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1288"><td class="num" id="LN1288">1288</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1289"><td class="num" id="LN1289">1289</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1290"><td class="num" id="LN1290">1290</td><td class="line">    <span class='keyword'>if</span> (s-&gt;shared_sigalgs != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1291"><td class="num" id="LN1291">1291</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1292"><td class="num" id="LN1292">1292</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1293"><td class="num" id="LN1293">1293</td><td class="line">    <span class='comment'>/* Fatal error if no shared signature algorithms */</span></td></tr>
<tr class="codeline" data-linenumber="1294"><td class="num" id="LN1294">1294</td><td class="line">    <span class='macro'>SSLfatal(s, SSL_AD_HANDSHAKE_FAILURE, SSL_F_TLS1_SET_SERVER_SIGALGS,<span class='macro_popup'>ossl_statem_fatal((s), (40), (335), (376), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1295)</span></span></td></tr>
<tr class="codeline" data-linenumber="1295"><td class="num" id="LN1295">1295</td><td class="line">             <span class='macro'>SSL_R_NO_SHARED_SIGNATURE_ALGORITHMS)<span class='macro_popup'>ossl_statem_fatal((s), (40), (335), (376), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1295)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1296"><td class="num" id="LN1296">1296</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1297"><td class="num" id="LN1297">1297</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1298"><td class="num" id="LN1298">1298</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1299"><td class="num" id="LN1299">1299</td><td class="line"><span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1300"><td class="num" id="LN1300">1300</td><td class="line"> <span class='comment'>* Gets the ticket information supplied by the client if any.</span></td></tr>
<tr class="codeline" data-linenumber="1301"><td class="num" id="LN1301">1301</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1302"><td class="num" id="LN1302">1302</td><td class="line"> <span class='comment'>*   hello: The parsed ClientHello data</span></td></tr>
<tr class="codeline" data-linenumber="1303"><td class="num" id="LN1303">1303</td><td class="line"> <span class='comment'>*   ret: (output) on return, if a ticket was decrypted, then this is set to</span></td></tr>
<tr class="codeline" data-linenumber="1304"><td class="num" id="LN1304">1304</td><td class="line"> <span class='comment'>*       point to the resulting session.</span></td></tr>
<tr class="codeline" data-linenumber="1305"><td class="num" id="LN1305">1305</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1306"><td class="num" id="LN1306">1306</td><td class="line">SSL_TICKET_STATUS tls_get_ticket_from_client(SSL *s, CLIENTHELLO_MSG *hello,</td></tr>
<tr class="codeline" data-linenumber="1307"><td class="num" id="LN1307">1307</td><td class="line">                                             SSL_SESSION **ret)</td></tr>
<tr class="codeline" data-linenumber="1308"><td class="num" id="LN1308">1308</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1309"><td class="num" id="LN1309">1309</td><td class="line">    size_t size;</td></tr>
<tr class="codeline" data-linenumber="1310"><td class="num" id="LN1310">1310</td><td class="line">    RAW_EXTENSION *ticketext;</td></tr>
<tr class="codeline" data-linenumber="1311"><td class="num" id="LN1311">1311</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1312"><td class="num" id="LN1312">1312</td><td class="line">    *ret = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1313"><td class="num" id="LN1313">1313</td><td class="line">    s-&gt;ext.ticket_expected = 0;</td></tr>
<tr class="codeline" data-linenumber="1314"><td class="num" id="LN1314">1314</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1315"><td class="num" id="LN1315">1315</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1316"><td class="num" id="LN1316">1316</td><td class="line">     <span class='comment'>* If tickets disabled or not supported by the protocol version</span></td></tr>
<tr class="codeline" data-linenumber="1317"><td class="num" id="LN1317">1317</td><td class="line">     <span class='comment'>* (e.g. TLSv1.3) behave as if no ticket present to permit stateful</span></td></tr>
<tr class="codeline" data-linenumber="1318"><td class="num" id="LN1318">1318</td><td class="line">     <span class='comment'>* resumption.</span></td></tr>
<tr class="codeline" data-linenumber="1319"><td class="num" id="LN1319">1319</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1320"><td class="num" id="LN1320">1320</td><td class="line">    <span class='keyword'>if</span> (s-&gt;version &lt;= <span class='macro'>SSL3_VERSION<span class='macro_popup'>0x0300</span></span> || !tls_use_ticket(s))</td></tr>
<tr class="codeline" data-linenumber="1321"><td class="num" id="LN1321">1321</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>SSL_TICKET_NONE<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1322"><td class="num" id="LN1322">1322</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1323"><td class="num" id="LN1323">1323</td><td class="line">    ticketext = &amp;hello-&gt;pre_proc_exts[TLSEXT_IDX_session_ticket];</td></tr>
<tr class="codeline" data-linenumber="1324"><td class="num" id="LN1324">1324</td><td class="line">    <span class='keyword'>if</span> (!ticketext-&gt;present)</td></tr>
<tr class="codeline" data-linenumber="1325"><td class="num" id="LN1325">1325</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>SSL_TICKET_NONE<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1326"><td class="num" id="LN1326">1326</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1327"><td class="num" id="LN1327">1327</td><td class="line">    size = PACKET_remaining(&amp;ticketext-&gt;data);</td></tr>
<tr class="codeline" data-linenumber="1328"><td class="num" id="LN1328">1328</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1329"><td class="num" id="LN1329">1329</td><td class="line">    <span class='keyword'>return</span> tls_decrypt_ticket(s, PACKET_data(&amp;ticketext-&gt;data), size,</td></tr>
<tr class="codeline" data-linenumber="1330"><td class="num" id="LN1330">1330</td><td class="line">                              hello-&gt;session_id, hello-&gt;session_id_len, ret);</td></tr>
<tr class="codeline" data-linenumber="1331"><td class="num" id="LN1331">1331</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1332"><td class="num" id="LN1332">1332</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1333"><td class="num" id="LN1333">1333</td><td class="line"><span class='comment'>/*-</span></td></tr>
<tr class="codeline" data-linenumber="1334"><td class="num" id="LN1334">1334</td><td class="line"> <span class='comment'>* tls_decrypt_ticket attempts to decrypt a session ticket.</span></td></tr>
<tr class="codeline" data-linenumber="1335"><td class="num" id="LN1335">1335</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1336"><td class="num" id="LN1336">1336</td><td class="line"> <span class='comment'>* If s-&gt;tls_session_secret_cb is set and we're not doing TLSv1.3 then we are</span></td></tr>
<tr class="codeline" data-linenumber="1337"><td class="num" id="LN1337">1337</td><td class="line"> <span class='comment'>* expecting a pre-shared key ciphersuite, in which case we have no use for</span></td></tr>
<tr class="codeline" data-linenumber="1338"><td class="num" id="LN1338">1338</td><td class="line"> <span class='comment'>* session tickets and one will never be decrypted, nor will</span></td></tr>
<tr class="codeline" data-linenumber="1339"><td class="num" id="LN1339">1339</td><td class="line"> <span class='comment'>* s-&gt;ext.ticket_expected be set to 1.</span></td></tr>
<tr class="codeline" data-linenumber="1340"><td class="num" id="LN1340">1340</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1341"><td class="num" id="LN1341">1341</td><td class="line"> <span class='comment'>* Side effects:</span></td></tr>
<tr class="codeline" data-linenumber="1342"><td class="num" id="LN1342">1342</td><td class="line"> <span class='comment'>*   Sets s-&gt;ext.ticket_expected to 1 if the server will have to issue</span></td></tr>
<tr class="codeline" data-linenumber="1343"><td class="num" id="LN1343">1343</td><td class="line"> <span class='comment'>*   a new session ticket to the client because the client indicated support</span></td></tr>
<tr class="codeline" data-linenumber="1344"><td class="num" id="LN1344">1344</td><td class="line"> <span class='comment'>*   (and s-&gt;tls_session_secret_cb is NULL) but the client either doesn't have</span></td></tr>
<tr class="codeline" data-linenumber="1345"><td class="num" id="LN1345">1345</td><td class="line"> <span class='comment'>*   a session ticket or we couldn't use the one it gave us, or if</span></td></tr>
<tr class="codeline" data-linenumber="1346"><td class="num" id="LN1346">1346</td><td class="line"> <span class='comment'>*   s-&gt;ctx-&gt;ext.ticket_key_cb asked to renew the client's ticket.</span></td></tr>
<tr class="codeline" data-linenumber="1347"><td class="num" id="LN1347">1347</td><td class="line"> <span class='comment'>*   Otherwise, s-&gt;ext.ticket_expected is set to 0.</span></td></tr>
<tr class="codeline" data-linenumber="1348"><td class="num" id="LN1348">1348</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1349"><td class="num" id="LN1349">1349</td><td class="line"> <span class='comment'>*   etick: points to the body of the session ticket extension.</span></td></tr>
<tr class="codeline" data-linenumber="1350"><td class="num" id="LN1350">1350</td><td class="line"> <span class='comment'>*   eticklen: the length of the session tickets extension.</span></td></tr>
<tr class="codeline" data-linenumber="1351"><td class="num" id="LN1351">1351</td><td class="line"> <span class='comment'>*   sess_id: points at the session ID.</span></td></tr>
<tr class="codeline" data-linenumber="1352"><td class="num" id="LN1352">1352</td><td class="line"> <span class='comment'>*   sesslen: the length of the session ID.</span></td></tr>
<tr class="codeline" data-linenumber="1353"><td class="num" id="LN1353">1353</td><td class="line"> <span class='comment'>*   psess: (output) on return, if a ticket was decrypted, then this is set to</span></td></tr>
<tr class="codeline" data-linenumber="1354"><td class="num" id="LN1354">1354</td><td class="line"> <span class='comment'>*       point to the resulting session.</span></td></tr>
<tr class="codeline" data-linenumber="1355"><td class="num" id="LN1355">1355</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1356"><td class="num" id="LN1356">1356</td><td class="line">SSL_TICKET_STATUS tls_decrypt_ticket(SSL *s, <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *etick,</td></tr>
<tr class="codeline" data-linenumber="1357"><td class="num" id="LN1357">1357</td><td class="line">                                     size_t eticklen, <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *sess_id,</td></tr>
<tr class="codeline" data-linenumber="1358"><td class="num" id="LN1358">1358</td><td class="line">                                     size_t sesslen, SSL_SESSION **psess)</td></tr>
<tr class="codeline" data-linenumber="1359"><td class="num" id="LN1359">1359</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1360"><td class="num" id="LN1360">1360</td><td class="line">    SSL_SESSION *sess = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1361"><td class="num" id="LN1361">1361</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *sdec;</td></tr>
<tr class="codeline" data-linenumber="1362"><td class="num" id="LN1362">1362</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p;</td></tr>
<tr class="codeline" data-linenumber="1363"><td class="num" id="LN1363">1363</td><td class="line">    <span class='keyword'>int</span> slen, renew_ticket = 0, declen;</td></tr>
<tr class="codeline" data-linenumber="1364"><td class="num" id="LN1364">1364</td><td class="line">    SSL_TICKET_STATUS ret = <span class='macro'>SSL_TICKET_FATAL_ERR_OTHER<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1365"><td class="num" id="LN1365">1365</td><td class="line">    size_t mlen;</td></tr>
<tr class="codeline" data-linenumber="1366"><td class="num" id="LN1366">1366</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> tick_hmac[<span class='macro'>EVP_MAX_MD_SIZE<span class='macro_popup'>64</span></span>];</td></tr>
<tr class="codeline" data-linenumber="1367"><td class="num" id="LN1367">1367</td><td class="line">    HMAC_CTX *hctx = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1368"><td class="num" id="LN1368">1368</td><td class="line">    EVP_CIPHER_CTX *ctx = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1369"><td class="num" id="LN1369">1369</td><td class="line">    SSL_CTX *tctx = s-&gt;session_ctx;</td></tr>
<tr class="codeline" data-linenumber="1370"><td class="num" id="LN1370">1370</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1371"><td class="num" id="LN1371">1371</td><td class="line">    <span class='keyword'>if</span> (eticklen == 0) {</td></tr>
<tr class="codeline" data-linenumber="1372"><td class="num" id="LN1372">1372</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1373"><td class="num" id="LN1373">1373</td><td class="line">         <span class='comment'>* The client will accept a ticket but doesn't currently have</span></td></tr>
<tr class="codeline" data-linenumber="1374"><td class="num" id="LN1374">1374</td><td class="line">         <span class='comment'>* one (TLSv1.2 and below), or treated as a fatal error in TLSv1.3</span></td></tr>
<tr class="codeline" data-linenumber="1375"><td class="num" id="LN1375">1375</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1376"><td class="num" id="LN1376">1376</td><td class="line">        ret = <span class='macro'>SSL_TICKET_EMPTY<span class='macro_popup'>3</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1377"><td class="num" id="LN1377">1377</td><td class="line">        <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="1378"><td class="num" id="LN1378">1378</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1379"><td class="num" id="LN1379">1379</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>SSL_IS_TLS13(s)<span class='macro_popup'>(!(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8) &amp;&amp;<br> (s)-&gt;method-&gt;version &gt;= 0x0304 &amp;&amp; (s)-&gt;method<br>-&gt;version != 0x10000)</span></span> &amp;&amp; s-&gt;ext.session_secret_cb) {</td></tr>
<tr class="codeline" data-linenumber="1380"><td class="num" id="LN1380">1380</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1381"><td class="num" id="LN1381">1381</td><td class="line">         <span class='comment'>* Indicate that the ticket couldn't be decrypted rather than</span></td></tr>
<tr class="codeline" data-linenumber="1382"><td class="num" id="LN1382">1382</td><td class="line">         <span class='comment'>* generating the session from ticket now, trigger</span></td></tr>
<tr class="codeline" data-linenumber="1383"><td class="num" id="LN1383">1383</td><td class="line">         <span class='comment'>* abbreviated handshake based on external mechanism to</span></td></tr>
<tr class="codeline" data-linenumber="1384"><td class="num" id="LN1384">1384</td><td class="line">         <span class='comment'>* calculate the master secret later.</span></td></tr>
<tr class="codeline" data-linenumber="1385"><td class="num" id="LN1385">1385</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1386"><td class="num" id="LN1386">1386</td><td class="line">        ret = <span class='macro'>SSL_TICKET_NO_DECRYPT<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1387"><td class="num" id="LN1387">1387</td><td class="line">        <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="1388"><td class="num" id="LN1388">1388</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1389"><td class="num" id="LN1389">1389</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1390"><td class="num" id="LN1390">1390</td><td class="line">    <span class='comment'>/* Need at least keyname + iv */</span></td></tr>
<tr class="codeline" data-linenumber="1391"><td class="num" id="LN1391">1391</td><td class="line">    <span class='keyword'>if</span> (eticklen &lt; <span class='macro'>TLSEXT_KEYNAME_LENGTH<span class='macro_popup'>16</span></span> + <span class='macro'>EVP_MAX_IV_LENGTH<span class='macro_popup'>16</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1392"><td class="num" id="LN1392">1392</td><td class="line">        ret = <span class='macro'>SSL_TICKET_NO_DECRYPT<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1393"><td class="num" id="LN1393">1393</td><td class="line">        <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="1394"><td class="num" id="LN1394">1394</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1395"><td class="num" id="LN1395">1395</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1396"><td class="num" id="LN1396">1396</td><td class="line">    <span class='comment'>/* Initialize session ticket encryption and HMAC contexts */</span></td></tr>
<tr class="codeline" data-linenumber="1397"><td class="num" id="LN1397">1397</td><td class="line">    hctx = HMAC_CTX_new();</td></tr>
<tr class="codeline" data-linenumber="1398"><td class="num" id="LN1398">1398</td><td class="line">    <span class='keyword'>if</span> (hctx == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1399"><td class="num" id="LN1399">1399</td><td class="line">        ret = <span class='macro'>SSL_TICKET_FATAL_ERR_MALLOC<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1400"><td class="num" id="LN1400">1400</td><td class="line">        <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="1401"><td class="num" id="LN1401">1401</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1402"><td class="num" id="LN1402">1402</td><td class="line">    ctx = EVP_CIPHER_CTX_new();</td></tr>
<tr class="codeline" data-linenumber="1403"><td class="num" id="LN1403">1403</td><td class="line">    <span class='keyword'>if</span> (ctx == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1404"><td class="num" id="LN1404">1404</td><td class="line">        ret = <span class='macro'>SSL_TICKET_FATAL_ERR_MALLOC<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1405"><td class="num" id="LN1405">1405</td><td class="line">        <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="1406"><td class="num" id="LN1406">1406</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1407"><td class="num" id="LN1407">1407</td><td class="line">    <span class='keyword'>if</span> (tctx-&gt;ext.ticket_key_cb) {</td></tr>
<tr class="codeline" data-linenumber="1408"><td class="num" id="LN1408">1408</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *nctick = (<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *)etick;</td></tr>
<tr class="codeline" data-linenumber="1409"><td class="num" id="LN1409">1409</td><td class="line">        <span class='keyword'>int</span> rv = tctx-&gt;ext.ticket_key_cb(s, nctick,</td></tr>
<tr class="codeline" data-linenumber="1410"><td class="num" id="LN1410">1410</td><td class="line">                                         nctick + <span class='macro'>TLSEXT_KEYNAME_LENGTH<span class='macro_popup'>16</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1411"><td class="num" id="LN1411">1411</td><td class="line">                                         ctx, hctx, 0);</td></tr>
<tr class="codeline" data-linenumber="1412"><td class="num" id="LN1412">1412</td><td class="line">        <span class='keyword'>if</span> (rv &lt; 0) {</td></tr>
<tr class="codeline" data-linenumber="1413"><td class="num" id="LN1413">1413</td><td class="line">            ret = <span class='macro'>SSL_TICKET_FATAL_ERR_OTHER<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1414"><td class="num" id="LN1414">1414</td><td class="line">            <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="1415"><td class="num" id="LN1415">1415</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1416"><td class="num" id="LN1416">1416</td><td class="line">        <span class='keyword'>if</span> (rv == 0) {</td></tr>
<tr class="codeline" data-linenumber="1417"><td class="num" id="LN1417">1417</td><td class="line">            ret = <span class='macro'>SSL_TICKET_NO_DECRYPT<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1418"><td class="num" id="LN1418">1418</td><td class="line">            <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="1419"><td class="num" id="LN1419">1419</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1420"><td class="num" id="LN1420">1420</td><td class="line">        <span class='keyword'>if</span> (rv == 2)</td></tr>
<tr class="codeline" data-linenumber="1421"><td class="num" id="LN1421">1421</td><td class="line">            renew_ticket = 1;</td></tr>
<tr class="codeline" data-linenumber="1422"><td class="num" id="LN1422">1422</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1423"><td class="num" id="LN1423">1423</td><td class="line">        <span class='comment'>/* Check key name matches */</span></td></tr>
<tr class="codeline" data-linenumber="1424"><td class="num" id="LN1424">1424</td><td class="line">        <span class='keyword'>if</span> (memcmp(etick, tctx-&gt;ext.tick_key_name,</td></tr>
<tr class="codeline" data-linenumber="1425"><td class="num" id="LN1425">1425</td><td class="line">                   <span class='macro'>TLSEXT_KEYNAME_LENGTH<span class='macro_popup'>16</span></span>) != 0) {</td></tr>
<tr class="codeline" data-linenumber="1426"><td class="num" id="LN1426">1426</td><td class="line">            ret = <span class='macro'>SSL_TICKET_NO_DECRYPT<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1427"><td class="num" id="LN1427">1427</td><td class="line">            <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="1428"><td class="num" id="LN1428">1428</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1429"><td class="num" id="LN1429">1429</td><td class="line">        <span class='keyword'>if</span> (HMAC_Init_ex(hctx, tctx-&gt;ext.secure-&gt;tick_hmac_key,</td></tr>
<tr class="codeline" data-linenumber="1430"><td class="num" id="LN1430">1430</td><td class="line">                         <span class='keyword'>sizeof</span>(tctx-&gt;ext.secure-&gt;tick_hmac_key),</td></tr>
<tr class="codeline" data-linenumber="1431"><td class="num" id="LN1431">1431</td><td class="line">                         EVP_sha256(), <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) &lt;= 0</td></tr>
<tr class="codeline" data-linenumber="1432"><td class="num" id="LN1432">1432</td><td class="line">            || EVP_DecryptInit_ex(ctx, EVP_aes_256_cbc(), <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1433"><td class="num" id="LN1433">1433</td><td class="line">                                  tctx-&gt;ext.secure-&gt;tick_aes_key,</td></tr>
<tr class="codeline" data-linenumber="1434"><td class="num" id="LN1434">1434</td><td class="line">                                  etick + <span class='macro'>TLSEXT_KEYNAME_LENGTH<span class='macro_popup'>16</span></span>) &lt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="1435"><td class="num" id="LN1435">1435</td><td class="line">            ret = <span class='macro'>SSL_TICKET_FATAL_ERR_OTHER<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1436"><td class="num" id="LN1436">1436</td><td class="line">            <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="1437"><td class="num" id="LN1437">1437</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1438"><td class="num" id="LN1438">1438</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>SSL_IS_TLS13(s)<span class='macro_popup'>(!(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8) &amp;&amp;<br> (s)-&gt;method-&gt;version &gt;= 0x0304 &amp;&amp; (s)-&gt;method<br>-&gt;version != 0x10000)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1439"><td class="num" id="LN1439">1439</td><td class="line">            renew_ticket = 1;</td></tr>
<tr class="codeline" data-linenumber="1440"><td class="num" id="LN1440">1440</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1441"><td class="num" id="LN1441">1441</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1442"><td class="num" id="LN1442">1442</td><td class="line">     <span class='comment'>* Attempt to process session ticket, first conduct sanity and integrity</span></td></tr>
<tr class="codeline" data-linenumber="1443"><td class="num" id="LN1443">1443</td><td class="line">     <span class='comment'>* checks on ticket.</span></td></tr>
<tr class="codeline" data-linenumber="1444"><td class="num" id="LN1444">1444</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1445"><td class="num" id="LN1445">1445</td><td class="line">    mlen = HMAC_size(hctx);</td></tr>
<tr class="codeline" data-linenumber="1446"><td class="num" id="LN1446">1446</td><td class="line">    <span class='keyword'>if</span> (mlen == 0) {</td></tr>
<tr class="codeline" data-linenumber="1447"><td class="num" id="LN1447">1447</td><td class="line">        ret = <span class='macro'>SSL_TICKET_FATAL_ERR_OTHER<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1448"><td class="num" id="LN1448">1448</td><td class="line">        <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="1449"><td class="num" id="LN1449">1449</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1450"><td class="num" id="LN1450">1450</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1451"><td class="num" id="LN1451">1451</td><td class="line">    <span class='comment'>/* Sanity check ticket length: must exceed keyname + IV + HMAC */</span></td></tr>
<tr class="codeline" data-linenumber="1452"><td class="num" id="LN1452">1452</td><td class="line">    <span class='keyword'>if</span> (eticklen &lt;=</td></tr>
<tr class="codeline" data-linenumber="1453"><td class="num" id="LN1453">1453</td><td class="line">        <span class='macro'>TLSEXT_KEYNAME_LENGTH<span class='macro_popup'>16</span></span> + EVP_CIPHER_CTX_iv_length(ctx) + mlen) {</td></tr>
<tr class="codeline" data-linenumber="1454"><td class="num" id="LN1454">1454</td><td class="line">        ret = <span class='macro'>SSL_TICKET_NO_DECRYPT<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1455"><td class="num" id="LN1455">1455</td><td class="line">        <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="1456"><td class="num" id="LN1456">1456</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1457"><td class="num" id="LN1457">1457</td><td class="line">    eticklen -= mlen;</td></tr>
<tr class="codeline" data-linenumber="1458"><td class="num" id="LN1458">1458</td><td class="line">    <span class='comment'>/* Check HMAC of encrypted ticket */</span></td></tr>
<tr class="codeline" data-linenumber="1459"><td class="num" id="LN1459">1459</td><td class="line">    <span class='keyword'>if</span> (HMAC_Update(hctx, etick, eticklen) &lt;= 0</td></tr>
<tr class="codeline" data-linenumber="1460"><td class="num" id="LN1460">1460</td><td class="line">        || HMAC_Final(hctx, tick_hmac, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) &lt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="1461"><td class="num" id="LN1461">1461</td><td class="line">        ret = <span class='macro'>SSL_TICKET_FATAL_ERR_OTHER<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1462"><td class="num" id="LN1462">1462</td><td class="line">        <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="1463"><td class="num" id="LN1463">1463</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1464"><td class="num" id="LN1464">1464</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1465"><td class="num" id="LN1465">1465</td><td class="line">    <span class='keyword'>if</span> (CRYPTO_memcmp(tick_hmac, etick + eticklen, mlen)) {</td></tr>
<tr class="codeline" data-linenumber="1466"><td class="num" id="LN1466">1466</td><td class="line">        ret = <span class='macro'>SSL_TICKET_NO_DECRYPT<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1467"><td class="num" id="LN1467">1467</td><td class="line">        <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="1468"><td class="num" id="LN1468">1468</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1469"><td class="num" id="LN1469">1469</td><td class="line">    <span class='comment'>/* Attempt to decrypt session data */</span></td></tr>
<tr class="codeline" data-linenumber="1470"><td class="num" id="LN1470">1470</td><td class="line">    <span class='comment'>/* Move p after IV to start of encrypted ticket, update length */</span></td></tr>
<tr class="codeline" data-linenumber="1471"><td class="num" id="LN1471">1471</td><td class="line">    p = etick + <span class='macro'>TLSEXT_KEYNAME_LENGTH<span class='macro_popup'>16</span></span> + EVP_CIPHER_CTX_iv_length(ctx);</td></tr>
<tr class="codeline" data-linenumber="1472"><td class="num" id="LN1472">1472</td><td class="line">    eticklen -= <span class='macro'>TLSEXT_KEYNAME_LENGTH<span class='macro_popup'>16</span></span> + EVP_CIPHER_CTX_iv_length(ctx);</td></tr>
<tr class="codeline" data-linenumber="1473"><td class="num" id="LN1473">1473</td><td class="line">    sdec = <span class='macro'>OPENSSL_malloc(eticklen)<span class='macro_popup'>CRYPTO_malloc(eticklen, "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1473)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1474"><td class="num" id="LN1474">1474</td><td class="line">    <span class='keyword'>if</span> (sdec == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || EVP_DecryptUpdate(ctx, sdec, &amp;slen, p,</td></tr>
<tr class="codeline" data-linenumber="1475"><td class="num" id="LN1475">1475</td><td class="line">                                          (<span class='keyword'>int</span>)eticklen) &lt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="1476"><td class="num" id="LN1476">1476</td><td class="line">        <span class='macro'>OPENSSL_free(sdec)<span class='macro_popup'>CRYPTO_free(sdec, "../deps/openssl/openssl/ssl/t1_lib.c", 1476<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1477"><td class="num" id="LN1477">1477</td><td class="line">        ret = <span class='macro'>SSL_TICKET_FATAL_ERR_OTHER<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1478"><td class="num" id="LN1478">1478</td><td class="line">        <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="1479"><td class="num" id="LN1479">1479</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1480"><td class="num" id="LN1480">1480</td><td class="line">    <span class='keyword'>if</span> (EVP_DecryptFinal(ctx, sdec + slen, &amp;declen) &lt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="1481"><td class="num" id="LN1481">1481</td><td class="line">        <span class='macro'>OPENSSL_free(sdec)<span class='macro_popup'>CRYPTO_free(sdec, "../deps/openssl/openssl/ssl/t1_lib.c", 1481<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1482"><td class="num" id="LN1482">1482</td><td class="line">        ret = <span class='macro'>SSL_TICKET_NO_DECRYPT<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1483"><td class="num" id="LN1483">1483</td><td class="line">        <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="1484"><td class="num" id="LN1484">1484</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1485"><td class="num" id="LN1485">1485</td><td class="line">    slen += declen;</td></tr>
<tr class="codeline" data-linenumber="1486"><td class="num" id="LN1486">1486</td><td class="line">    p = sdec;</td></tr>
<tr class="codeline" data-linenumber="1487"><td class="num" id="LN1487">1487</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1488"><td class="num" id="LN1488">1488</td><td class="line">    sess = d2i_SSL_SESSION(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, &amp;p, slen);</td></tr>
<tr class="codeline" data-linenumber="1489"><td class="num" id="LN1489">1489</td><td class="line">    slen -= p - sdec;</td></tr>
<tr class="codeline" data-linenumber="1490"><td class="num" id="LN1490">1490</td><td class="line">    <span class='macro'>OPENSSL_free(sdec)<span class='macro_popup'>CRYPTO_free(sdec, "../deps/openssl/openssl/ssl/t1_lib.c", 1490<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1491"><td class="num" id="LN1491">1491</td><td class="line">    <span class='keyword'>if</span> (sess) {</td></tr>
<tr class="codeline" data-linenumber="1492"><td class="num" id="LN1492">1492</td><td class="line">        <span class='comment'>/* Some additional consistency checks */</span></td></tr>
<tr class="codeline" data-linenumber="1493"><td class="num" id="LN1493">1493</td><td class="line">        <span class='keyword'>if</span> (slen != 0) {</td></tr>
<tr class="codeline" data-linenumber="1494"><td class="num" id="LN1494">1494</td><td class="line">            SSL_SESSION_free(sess);</td></tr>
<tr class="codeline" data-linenumber="1495"><td class="num" id="LN1495">1495</td><td class="line">            sess = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1496"><td class="num" id="LN1496">1496</td><td class="line">            ret = <span class='macro'>SSL_TICKET_NO_DECRYPT<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1497"><td class="num" id="LN1497">1497</td><td class="line">            <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="1498"><td class="num" id="LN1498">1498</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1499"><td class="num" id="LN1499">1499</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1500"><td class="num" id="LN1500">1500</td><td class="line">         <span class='comment'>* The session ID, if non-empty, is used by some clients to detect</span></td></tr>
<tr class="codeline" data-linenumber="1501"><td class="num" id="LN1501">1501</td><td class="line">         <span class='comment'>* that the ticket has been accepted. So we copy it to the session</span></td></tr>
<tr class="codeline" data-linenumber="1502"><td class="num" id="LN1502">1502</td><td class="line">         <span class='comment'>* structure. If it is empty set length to zero as required by</span></td></tr>
<tr class="codeline" data-linenumber="1503"><td class="num" id="LN1503">1503</td><td class="line">         <span class='comment'>* standard.</span></td></tr>
<tr class="codeline" data-linenumber="1504"><td class="num" id="LN1504">1504</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1505"><td class="num" id="LN1505">1505</td><td class="line">        <span class='keyword'>if</span> (sesslen) {</td></tr>
<tr class="codeline" data-linenumber="1506"><td class="num" id="LN1506">1506</td><td class="line">            memcpy(sess-&gt;session_id, sess_id, sesslen);</td></tr>
<tr class="codeline" data-linenumber="1507"><td class="num" id="LN1507">1507</td><td class="line">            sess-&gt;session_id_length = sesslen;</td></tr>
<tr class="codeline" data-linenumber="1508"><td class="num" id="LN1508">1508</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1509"><td class="num" id="LN1509">1509</td><td class="line">        <span class='keyword'>if</span> (renew_ticket)</td></tr>
<tr class="codeline" data-linenumber="1510"><td class="num" id="LN1510">1510</td><td class="line">            ret = <span class='macro'>SSL_TICKET_SUCCESS_RENEW<span class='macro_popup'>6</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1511"><td class="num" id="LN1511">1511</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1512"><td class="num" id="LN1512">1512</td><td class="line">            ret = <span class='macro'>SSL_TICKET_SUCCESS<span class='macro_popup'>5</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1513"><td class="num" id="LN1513">1513</td><td class="line">        <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="1514"><td class="num" id="LN1514">1514</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1515"><td class="num" id="LN1515">1515</td><td class="line">    ERR_clear_error();</td></tr>
<tr class="codeline" data-linenumber="1516"><td class="num" id="LN1516">1516</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1517"><td class="num" id="LN1517">1517</td><td class="line">     <span class='comment'>* For session parse failure, indicate that we need to send a new ticket.</span></td></tr>
<tr class="codeline" data-linenumber="1518"><td class="num" id="LN1518">1518</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1519"><td class="num" id="LN1519">1519</td><td class="line">    ret = <span class='macro'>SSL_TICKET_NO_DECRYPT<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1520"><td class="num" id="LN1520">1520</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1521"><td class="num" id="LN1521">1521</td><td class="line"> end:</td></tr>
<tr class="codeline" data-linenumber="1522"><td class="num" id="LN1522">1522</td><td class="line">    EVP_CIPHER_CTX_free(ctx);</td></tr>
<tr class="codeline" data-linenumber="1523"><td class="num" id="LN1523">1523</td><td class="line">    HMAC_CTX_free(hctx);</td></tr>
<tr class="codeline" data-linenumber="1524"><td class="num" id="LN1524">1524</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1525"><td class="num" id="LN1525">1525</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1526"><td class="num" id="LN1526">1526</td><td class="line">     <span class='comment'>* If set, the decrypt_ticket_cb() is called unless a fatal error was</span></td></tr>
<tr class="codeline" data-linenumber="1527"><td class="num" id="LN1527">1527</td><td class="line">     <span class='comment'>* detected above. The callback is responsible for checking |ret| before it</span></td></tr>
<tr class="codeline" data-linenumber="1528"><td class="num" id="LN1528">1528</td><td class="line">     <span class='comment'>* performs any action</span></td></tr>
<tr class="codeline" data-linenumber="1529"><td class="num" id="LN1529">1529</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1530"><td class="num" id="LN1530">1530</td><td class="line">    <span class='keyword'>if</span> (s-&gt;session_ctx-&gt;decrypt_ticket_cb != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="1531"><td class="num" id="LN1531">1531</td><td class="line">            &amp;&amp; (ret == <span class='macro'>SSL_TICKET_EMPTY<span class='macro_popup'>3</span></span></td></tr>
<tr class="codeline" data-linenumber="1532"><td class="num" id="LN1532">1532</td><td class="line">                || ret == <span class='macro'>SSL_TICKET_NO_DECRYPT<span class='macro_popup'>4</span></span></td></tr>
<tr class="codeline" data-linenumber="1533"><td class="num" id="LN1533">1533</td><td class="line">                || ret == <span class='macro'>SSL_TICKET_SUCCESS<span class='macro_popup'>5</span></span></td></tr>
<tr class="codeline" data-linenumber="1534"><td class="num" id="LN1534">1534</td><td class="line">                || ret == <span class='macro'>SSL_TICKET_SUCCESS_RENEW<span class='macro_popup'>6</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="1535"><td class="num" id="LN1535">1535</td><td class="line">        size_t keyname_len = eticklen;</td></tr>
<tr class="codeline" data-linenumber="1536"><td class="num" id="LN1536">1536</td><td class="line">        <span class='keyword'>int</span> retcb;</td></tr>
<tr class="codeline" data-linenumber="1537"><td class="num" id="LN1537">1537</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1538"><td class="num" id="LN1538">1538</td><td class="line">        <span class='keyword'>if</span> (keyname_len &gt; <span class='macro'>TLSEXT_KEYNAME_LENGTH<span class='macro_popup'>16</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1539"><td class="num" id="LN1539">1539</td><td class="line">            keyname_len = <span class='macro'>TLSEXT_KEYNAME_LENGTH<span class='macro_popup'>16</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1540"><td class="num" id="LN1540">1540</td><td class="line">        retcb = s-&gt;session_ctx-&gt;decrypt_ticket_cb(s, sess, etick, keyname_len,</td></tr>
<tr class="codeline" data-linenumber="1541"><td class="num" id="LN1541">1541</td><td class="line">                                                  ret,</td></tr>
<tr class="codeline" data-linenumber="1542"><td class="num" id="LN1542">1542</td><td class="line">                                                  s-&gt;session_ctx-&gt;ticket_cb_data);</td></tr>
<tr class="codeline" data-linenumber="1543"><td class="num" id="LN1543">1543</td><td class="line">        <span class='keyword'>switch</span> (retcb) {</td></tr>
<tr class="codeline" data-linenumber="1544"><td class="num" id="LN1544">1544</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>SSL_TICKET_RETURN_ABORT<span class='macro_popup'>0</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1545"><td class="num" id="LN1545">1545</td><td class="line">            ret = <span class='macro'>SSL_TICKET_FATAL_ERR_OTHER<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1546"><td class="num" id="LN1546">1546</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1547"><td class="num" id="LN1547">1547</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1548"><td class="num" id="LN1548">1548</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>SSL_TICKET_RETURN_IGNORE<span class='macro_popup'>1</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1549"><td class="num" id="LN1549">1549</td><td class="line">            ret = <span class='macro'>SSL_TICKET_NONE<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1550"><td class="num" id="LN1550">1550</td><td class="line">            SSL_SESSION_free(sess);</td></tr>
<tr class="codeline" data-linenumber="1551"><td class="num" id="LN1551">1551</td><td class="line">            sess = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1552"><td class="num" id="LN1552">1552</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1553"><td class="num" id="LN1553">1553</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1554"><td class="num" id="LN1554">1554</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>SSL_TICKET_RETURN_IGNORE_RENEW<span class='macro_popup'>2</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1555"><td class="num" id="LN1555">1555</td><td class="line">            <span class='keyword'>if</span> (ret != <span class='macro'>SSL_TICKET_EMPTY<span class='macro_popup'>3</span></span> &amp;&amp; ret != <span class='macro'>SSL_TICKET_NO_DECRYPT<span class='macro_popup'>4</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1556"><td class="num" id="LN1556">1556</td><td class="line">                ret = <span class='macro'>SSL_TICKET_NO_DECRYPT<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1557"><td class="num" id="LN1557">1557</td><td class="line">            <span class='comment'>/* else the value of |ret| will already do the right thing */</span></td></tr>
<tr class="codeline" data-linenumber="1558"><td class="num" id="LN1558">1558</td><td class="line">            SSL_SESSION_free(sess);</td></tr>
<tr class="codeline" data-linenumber="1559"><td class="num" id="LN1559">1559</td><td class="line">            sess = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1560"><td class="num" id="LN1560">1560</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1561"><td class="num" id="LN1561">1561</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1562"><td class="num" id="LN1562">1562</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>SSL_TICKET_RETURN_USE<span class='macro_popup'>3</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1563"><td class="num" id="LN1563">1563</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>SSL_TICKET_RETURN_USE_RENEW<span class='macro_popup'>4</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1564"><td class="num" id="LN1564">1564</td><td class="line">            <span class='keyword'>if</span> (ret != <span class='macro'>SSL_TICKET_SUCCESS<span class='macro_popup'>5</span></span></td></tr>
<tr class="codeline" data-linenumber="1565"><td class="num" id="LN1565">1565</td><td class="line">                    &amp;&amp; ret != <span class='macro'>SSL_TICKET_SUCCESS_RENEW<span class='macro_popup'>6</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1566"><td class="num" id="LN1566">1566</td><td class="line">                ret = <span class='macro'>SSL_TICKET_FATAL_ERR_OTHER<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1567"><td class="num" id="LN1567">1567</td><td class="line">            <span class='keyword'>else</span> <span class='keyword'>if</span> (retcb == <span class='macro'>SSL_TICKET_RETURN_USE<span class='macro_popup'>3</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1568"><td class="num" id="LN1568">1568</td><td class="line">                ret = <span class='macro'>SSL_TICKET_SUCCESS<span class='macro_popup'>5</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1569"><td class="num" id="LN1569">1569</td><td class="line">            <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1570"><td class="num" id="LN1570">1570</td><td class="line">                ret = <span class='macro'>SSL_TICKET_SUCCESS_RENEW<span class='macro_popup'>6</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1571"><td class="num" id="LN1571">1571</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1572"><td class="num" id="LN1572">1572</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1573"><td class="num" id="LN1573">1573</td><td class="line">        <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="1574"><td class="num" id="LN1574">1574</td><td class="line">            ret = <span class='macro'>SSL_TICKET_FATAL_ERR_OTHER<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1575"><td class="num" id="LN1575">1575</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1576"><td class="num" id="LN1576">1576</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1577"><td class="num" id="LN1577">1577</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1578"><td class="num" id="LN1578">1578</td><td class="line">    <span class='keyword'>if</span> (s-&gt;ext.session_secret_cb == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || <span class='macro'>SSL_IS_TLS13(s)<span class='macro_popup'>(!(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8) &amp;&amp;<br> (s)-&gt;method-&gt;version &gt;= 0x0304 &amp;&amp; (s)-&gt;method<br>-&gt;version != 0x10000)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1579"><td class="num" id="LN1579">1579</td><td class="line">        <span class='keyword'>switch</span> (ret) {</td></tr>
<tr class="codeline" data-linenumber="1580"><td class="num" id="LN1580">1580</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>SSL_TICKET_NO_DECRYPT<span class='macro_popup'>4</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1581"><td class="num" id="LN1581">1581</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>SSL_TICKET_SUCCESS_RENEW<span class='macro_popup'>6</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1582"><td class="num" id="LN1582">1582</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>SSL_TICKET_EMPTY<span class='macro_popup'>3</span></span>:</td></tr>
<tr class="codeline" data-linenumber="1583"><td class="num" id="LN1583">1583</td><td class="line">            s-&gt;ext.ticket_expected = 1;</td></tr>
<tr class="codeline" data-linenumber="1584"><td class="num" id="LN1584">1584</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1585"><td class="num" id="LN1585">1585</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1586"><td class="num" id="LN1586">1586</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1587"><td class="num" id="LN1587">1587</td><td class="line">    *psess = sess;</td></tr>
<tr class="codeline" data-linenumber="1588"><td class="num" id="LN1588">1588</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1589"><td class="num" id="LN1589">1589</td><td class="line">    <span class='keyword'>return</span> ret;</td></tr>
<tr class="codeline" data-linenumber="1590"><td class="num" id="LN1590">1590</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1591"><td class="num" id="LN1591">1591</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1592"><td class="num" id="LN1592">1592</td><td class="line"><span class='comment'>/* Check to see if a signature algorithm is allowed */</span></td></tr>
<tr class="codeline" data-linenumber="1593"><td class="num" id="LN1593">1593</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls12_sigalg_allowed(<span class='keyword'>const</span> SSL *s, <span class='keyword'>int</span> op, <span class='keyword'>const</span> SIGALG_LOOKUP *lu)</td></tr>
<tr class="codeline" data-linenumber="1594"><td class="num" id="LN1594">1594</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1595"><td class="num" id="LN1595">1595</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> sigalgstr[2];</td></tr>
<tr class="codeline" data-linenumber="1596"><td class="num" id="LN1596">1596</td><td class="line">    <span class='keyword'>int</span> secbits;</td></tr>
<tr class="codeline" data-linenumber="1597"><td class="num" id="LN1597">1597</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1598"><td class="num" id="LN1598">1598</td><td class="line">    <span class='comment'>/* See if sigalgs is recognised and if hash is enabled */</span></td></tr>
<tr class="codeline" data-linenumber="1599"><td class="num" id="LN1599">1599</td><td class="line">    <span class='keyword'>if</span> (!tls1_lookup_md(lu, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="1600"><td class="num" id="LN1600">1600</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1601"><td class="num" id="LN1601">1601</td><td class="line">    <span class='comment'>/* DSA is not allowed in TLS 1.3 */</span></td></tr>
<tr class="codeline" data-linenumber="1602"><td class="num" id="LN1602">1602</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>SSL_IS_TLS13(s)<span class='macro_popup'>(!(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8) &amp;&amp;<br> (s)-&gt;method-&gt;version &gt;= 0x0304 &amp;&amp; (s)-&gt;method<br>-&gt;version != 0x10000)</span></span> &amp;&amp; lu-&gt;sig == <span class='macro'>EVP_PKEY_DSA<span class='macro_popup'>116</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1603"><td class="num" id="LN1603">1603</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1604"><td class="num" id="LN1604">1604</td><td class="line">    <span class='comment'>/* TODO(OpenSSL1.2) fully axe DSA/etc. in ClientHello per TLS 1.3 spec */</span></td></tr>
<tr class="codeline" data-linenumber="1605"><td class="num" id="LN1605">1605</td><td class="line">    <span class='keyword'>if</span> (!s-&gt;server &amp;&amp; !<span class='macro'>SSL_IS_DTLS(s)<span class='macro_popup'>(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8)</span></span> &amp;&amp; s-&gt;s3-&gt;tmp.min_ver &gt;= <span class='macro'>TLS1_3_VERSION<span class='macro_popup'>0x0304</span></span></td></tr>
<tr class="codeline" data-linenumber="1606"><td class="num" id="LN1606">1606</td><td class="line">        &amp;&amp; (lu-&gt;sig == <span class='macro'>EVP_PKEY_DSA<span class='macro_popup'>116</span></span> || lu-&gt;hash_idx == <span class='macro'>SSL_MD_SHA1_IDX<span class='macro_popup'>1</span></span></td></tr>
<tr class="codeline" data-linenumber="1607"><td class="num" id="LN1607">1607</td><td class="line">            || lu-&gt;hash_idx == <span class='macro'>SSL_MD_MD5_IDX<span class='macro_popup'>0</span></span></td></tr>
<tr class="codeline" data-linenumber="1608"><td class="num" id="LN1608">1608</td><td class="line">            || lu-&gt;hash_idx == <span class='macro'>SSL_MD_SHA224_IDX<span class='macro_popup'>10</span></span>))</td></tr>
<tr class="codeline" data-linenumber="1609"><td class="num" id="LN1609">1609</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1610"><td class="num" id="LN1610">1610</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1611"><td class="num" id="LN1611">1611</td><td class="line">    <span class='comment'>/* See if public key algorithm allowed */</span></td></tr>
<tr class="codeline" data-linenumber="1612"><td class="num" id="LN1612">1612</td><td class="line">    <span class='keyword'>if</span> (ssl_cert_is_disabled(lu-&gt;sig_idx))</td></tr>
<tr class="codeline" data-linenumber="1613"><td class="num" id="LN1613">1613</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1614"><td class="num" id="LN1614">1614</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1615"><td class="num" id="LN1615">1615</td><td class="line">    <span class='keyword'>if</span> (lu-&gt;sig == <span class='macro'>NID_id_GostR3410_2012_256<span class='macro_popup'>979</span></span></td></tr>
<tr class="codeline" data-linenumber="1616"><td class="num" id="LN1616">1616</td><td class="line">            || lu-&gt;sig == <span class='macro'>NID_id_GostR3410_2012_512<span class='macro_popup'>980</span></span></td></tr>
<tr class="codeline" data-linenumber="1617"><td class="num" id="LN1617">1617</td><td class="line">            || lu-&gt;sig == <span class='macro'>NID_id_GostR3410_2001<span class='macro_popup'>811</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1618"><td class="num" id="LN1618">1618</td><td class="line">        <span class='comment'>/* We never allow GOST sig algs on the server with TLSv1.3 */</span></td></tr>
<tr class="codeline" data-linenumber="1619"><td class="num" id="LN1619">1619</td><td class="line">        <span class='keyword'>if</span> (s-&gt;server &amp;&amp; <span class='macro'>SSL_IS_TLS13(s)<span class='macro_popup'>(!(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8) &amp;&amp;<br> (s)-&gt;method-&gt;version &gt;= 0x0304 &amp;&amp; (s)-&gt;method<br>-&gt;version != 0x10000)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1620"><td class="num" id="LN1620">1620</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1621"><td class="num" id="LN1621">1621</td><td class="line">        <span class='keyword'>if</span> (!s-&gt;server</td></tr>
<tr class="codeline" data-linenumber="1622"><td class="num" id="LN1622">1622</td><td class="line">                &amp;&amp; s-&gt;method-&gt;version == <span class='macro'>TLS_ANY_VERSION<span class='macro_popup'>0x10000</span></span></td></tr>
<tr class="codeline" data-linenumber="1623"><td class="num" id="LN1623">1623</td><td class="line">                &amp;&amp; s-&gt;s3-&gt;tmp.max_ver &gt;= <span class='macro'>TLS1_3_VERSION<span class='macro_popup'>0x0304</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1624"><td class="num" id="LN1624">1624</td><td class="line">            <span class='keyword'>int</span> i, num;</td></tr>
<tr class="codeline" data-linenumber="1625"><td class="num" id="LN1625">1625</td><td class="line">            <span class='macro'>STACK_OF(SSL_CIPHER)<span class='macro_popup'>struct stack_st_SSL_CIPHER</span></span> *sk;</td></tr>
<tr class="codeline" data-linenumber="1626"><td class="num" id="LN1626">1626</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1627"><td class="num" id="LN1627">1627</td><td class="line">            <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1628"><td class="num" id="LN1628">1628</td><td class="line">             <span class='comment'>* We're a client that could negotiate TLSv1.3. We only allow GOST</span></td></tr>
<tr class="codeline" data-linenumber="1629"><td class="num" id="LN1629">1629</td><td class="line">             <span class='comment'>* sig algs if we could negotiate TLSv1.2 or below and we have GOST</span></td></tr>
<tr class="codeline" data-linenumber="1630"><td class="num" id="LN1630">1630</td><td class="line">             <span class='comment'>* ciphersuites enabled.</span></td></tr>
<tr class="codeline" data-linenumber="1631"><td class="num" id="LN1631">1631</td><td class="line">             <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1632"><td class="num" id="LN1632">1632</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1633"><td class="num" id="LN1633">1633</td><td class="line">            <span class='keyword'>if</span> (s-&gt;s3-&gt;tmp.min_ver &gt;= <span class='macro'>TLS1_3_VERSION<span class='macro_popup'>0x0304</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1634"><td class="num" id="LN1634">1634</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1635"><td class="num" id="LN1635">1635</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1636"><td class="num" id="LN1636">1636</td><td class="line">            sk = SSL_get_ciphers(s);</td></tr>
<tr class="codeline" data-linenumber="1637"><td class="num" id="LN1637">1637</td><td class="line">            num = sk != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> ? sk_SSL_CIPHER_num(sk) : 0;</td></tr>
<tr class="codeline" data-linenumber="1638"><td class="num" id="LN1638">1638</td><td class="line">            <span class='keyword'>for</span> (i = 0; i &lt; num; i++) {</td></tr>
<tr class="codeline" data-linenumber="1639"><td class="num" id="LN1639">1639</td><td class="line">                <span class='keyword'>const</span> SSL_CIPHER *c;</td></tr>
<tr class="codeline" data-linenumber="1640"><td class="num" id="LN1640">1640</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1641"><td class="num" id="LN1641">1641</td><td class="line">                c = sk_SSL_CIPHER_value(sk, i);</td></tr>
<tr class="codeline" data-linenumber="1642"><td class="num" id="LN1642">1642</td><td class="line">                <span class='comment'>/* Skip disabled ciphers */</span></td></tr>
<tr class="codeline" data-linenumber="1643"><td class="num" id="LN1643">1643</td><td class="line">                <span class='keyword'>if</span> (ssl_cipher_disabled(s, c, <span class='macro'>SSL_SECOP_CIPHER_SUPPORTED<span class='macro_popup'>(1 | (1 &lt;&lt; 16))</span></span>, 0))</td></tr>
<tr class="codeline" data-linenumber="1644"><td class="num" id="LN1644">1644</td><td class="line">                    <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1645"><td class="num" id="LN1645">1645</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1646"><td class="num" id="LN1646">1646</td><td class="line">                <span class='keyword'>if</span> ((c-&gt;algorithm_mkey &amp; <span class='macro'>SSL_kGOST<span class='macro_popup'>0x00000010U</span></span>) != 0)</td></tr>
<tr class="codeline" data-linenumber="1647"><td class="num" id="LN1647">1647</td><td class="line">                    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1648"><td class="num" id="LN1648">1648</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1649"><td class="num" id="LN1649">1649</td><td class="line">            <span class='keyword'>if</span> (i == num)</td></tr>
<tr class="codeline" data-linenumber="1650"><td class="num" id="LN1650">1650</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1651"><td class="num" id="LN1651">1651</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1652"><td class="num" id="LN1652">1652</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1653"><td class="num" id="LN1653">1653</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1654"><td class="num" id="LN1654">1654</td><td class="line">    <span class='comment'>/* Finally see if security callback allows it */</span></td></tr>
<tr class="codeline" data-linenumber="1655"><td class="num" id="LN1655">1655</td><td class="line">    secbits = sigalg_security_bits(lu);</td></tr>
<tr class="codeline" data-linenumber="1656"><td class="num" id="LN1656">1656</td><td class="line">    sigalgstr[0] = (lu-&gt;sigalg &gt;&gt; 8) &amp; 0xff;</td></tr>
<tr class="codeline" data-linenumber="1657"><td class="num" id="LN1657">1657</td><td class="line">    sigalgstr[1] = lu-&gt;sigalg &amp; 0xff;</td></tr>
<tr class="codeline" data-linenumber="1658"><td class="num" id="LN1658">1658</td><td class="line">    <span class='keyword'>return</span> ssl_security(s, op, secbits, lu-&gt;hash, (<span class='keyword'>void</span> *)sigalgstr);</td></tr>
<tr class="codeline" data-linenumber="1659"><td class="num" id="LN1659">1659</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1660"><td class="num" id="LN1660">1660</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1661"><td class="num" id="LN1661">1661</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1662"><td class="num" id="LN1662">1662</td><td class="line"> <span class='comment'>* Get a mask of disabled public key algorithms based on supported signature</span></td></tr>
<tr class="codeline" data-linenumber="1663"><td class="num" id="LN1663">1663</td><td class="line"> <span class='comment'>* algorithms. For example if no signature algorithm supports RSA then RSA is</span></td></tr>
<tr class="codeline" data-linenumber="1664"><td class="num" id="LN1664">1664</td><td class="line"> <span class='comment'>* disabled.</span></td></tr>
<tr class="codeline" data-linenumber="1665"><td class="num" id="LN1665">1665</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1666"><td class="num" id="LN1666">1666</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1667"><td class="num" id="LN1667">1667</td><td class="line"><span class='keyword'>void</span> ssl_set_sig_mask(uint32_t *pmask_a, SSL *s, <span class='keyword'>int</span> op)</td></tr>
<tr class="codeline" data-linenumber="1668"><td class="num" id="LN1668">1668</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1669"><td class="num" id="LN1669">1669</td><td class="line">    <span class='keyword'>const</span> uint16_t *sigalgs;</td></tr>
<tr class="codeline" data-linenumber="1670"><td class="num" id="LN1670">1670</td><td class="line">    size_t i, sigalgslen;</td></tr>
<tr class="codeline" data-linenumber="1671"><td class="num" id="LN1671">1671</td><td class="line">    uint32_t disabled_mask = <span class='macro'>SSL_aRSA<span class='macro_popup'>0x00000001U</span></span> | <span class='macro'>SSL_aDSS<span class='macro_popup'>0x00000002U</span></span> | <span class='macro'>SSL_aECDSA<span class='macro_popup'>0x00000008U</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1672"><td class="num" id="LN1672">1672</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1673"><td class="num" id="LN1673">1673</td><td class="line">     <span class='comment'>* Go through all signature algorithms seeing if we support any</span></td></tr>
<tr class="codeline" data-linenumber="1674"><td class="num" id="LN1674">1674</td><td class="line">     <span class='comment'>* in disabled_mask.</span></td></tr>
<tr class="codeline" data-linenumber="1675"><td class="num" id="LN1675">1675</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1676"><td class="num" id="LN1676">1676</td><td class="line">    sigalgslen = tls12_get_psigalgs(s, 1, &amp;sigalgs);</td></tr>
<tr class="codeline" data-linenumber="1677"><td class="num" id="LN1677">1677</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; sigalgslen; i++, sigalgs++) {</td></tr>
<tr class="codeline" data-linenumber="1678"><td class="num" id="LN1678">1678</td><td class="line">        <span class='keyword'>const</span> SIGALG_LOOKUP *lu = tls1_lookup_sigalg(*sigalgs);</td></tr>
<tr class="codeline" data-linenumber="1679"><td class="num" id="LN1679">1679</td><td class="line">        <span class='keyword'>const</span> SSL_CERT_LOOKUP *clu;</td></tr>
<tr class="codeline" data-linenumber="1680"><td class="num" id="LN1680">1680</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1681"><td class="num" id="LN1681">1681</td><td class="line">        <span class='keyword'>if</span> (lu == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1682"><td class="num" id="LN1682">1682</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1683"><td class="num" id="LN1683">1683</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1684"><td class="num" id="LN1684">1684</td><td class="line">        clu = ssl_cert_lookup_by_idx(lu-&gt;sig_idx);</td></tr>
<tr class="codeline" data-linenumber="1685"><td class="num" id="LN1685">1685</td><td class="line">	<span class='keyword'>if</span> (clu == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1686"><td class="num" id="LN1686">1686</td><td class="line">		<span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1687"><td class="num" id="LN1687">1687</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1688"><td class="num" id="LN1688">1688</td><td class="line">        <span class='comment'>/* If algorithm is disabled see if we can enable it */</span></td></tr>
<tr class="codeline" data-linenumber="1689"><td class="num" id="LN1689">1689</td><td class="line">        <span class='keyword'>if</span> ((clu-&gt;amask &amp; disabled_mask) != 0</td></tr>
<tr class="codeline" data-linenumber="1690"><td class="num" id="LN1690">1690</td><td class="line">                &amp;&amp; tls12_sigalg_allowed(s, op, lu))</td></tr>
<tr class="codeline" data-linenumber="1691"><td class="num" id="LN1691">1691</td><td class="line">            disabled_mask &amp;= ~clu-&gt;amask;</td></tr>
<tr class="codeline" data-linenumber="1692"><td class="num" id="LN1692">1692</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1693"><td class="num" id="LN1693">1693</td><td class="line">    *pmask_a |= disabled_mask;</td></tr>
<tr class="codeline" data-linenumber="1694"><td class="num" id="LN1694">1694</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1695"><td class="num" id="LN1695">1695</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1696"><td class="num" id="LN1696">1696</td><td class="line"><span class='keyword'>int</span> tls12_copy_sigalgs(SSL *s, WPACKET *pkt,</td></tr>
<tr class="codeline" data-linenumber="1697"><td class="num" id="LN1697">1697</td><td class="line">                       <span class='keyword'>const</span> uint16_t *psig, size_t psiglen)</td></tr>
<tr class="codeline" data-linenumber="1698"><td class="num" id="LN1698">1698</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1699"><td class="num" id="LN1699">1699</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="1700"><td class="num" id="LN1700">1700</td><td class="line">    <span class='keyword'>int</span> rv = 0;</td></tr>
<tr class="codeline" data-linenumber="1701"><td class="num" id="LN1701">1701</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1702"><td class="num" id="LN1702">1702</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; psiglen; i++, psig++) {</td></tr>
<tr class="codeline" data-linenumber="1703"><td class="num" id="LN1703">1703</td><td class="line">        <span class='keyword'>const</span> SIGALG_LOOKUP *lu = tls1_lookup_sigalg(*psig);</td></tr>
<tr class="codeline" data-linenumber="1704"><td class="num" id="LN1704">1704</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1705"><td class="num" id="LN1705">1705</td><td class="line">        <span class='keyword'>if</span> (!tls12_sigalg_allowed(s, <span class='macro'>SSL_SECOP_SIGALG_SUPPORTED<span class='macro_popup'>(11 | (5 &lt;&lt; 16))</span></span>, lu))</td></tr>
<tr class="codeline" data-linenumber="1706"><td class="num" id="LN1706">1706</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1707"><td class="num" id="LN1707">1707</td><td class="line">        <span class='keyword'>if</span> (!<span class='macro'>WPACKET_put_bytes_u16(pkt, *psig)<span class='macro_popup'>WPACKET_put_bytes__((pkt), (*psig), 2)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1708"><td class="num" id="LN1708">1708</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1709"><td class="num" id="LN1709">1709</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1710"><td class="num" id="LN1710">1710</td><td class="line">         <span class='comment'>* If TLS 1.3 must have at least one valid TLS 1.3 message</span></td></tr>
<tr class="codeline" data-linenumber="1711"><td class="num" id="LN1711">1711</td><td class="line">         <span class='comment'>* signing algorithm: i.e. neither RSA nor SHA1/SHA224</span></td></tr>
<tr class="codeline" data-linenumber="1712"><td class="num" id="LN1712">1712</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1713"><td class="num" id="LN1713">1713</td><td class="line">        <span class='keyword'>if</span> (rv == 0 &amp;&amp; (!<span class='macro'>SSL_IS_TLS13(s)<span class='macro_popup'>(!(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8) &amp;&amp;<br> (s)-&gt;method-&gt;version &gt;= 0x0304 &amp;&amp; (s)-&gt;method<br>-&gt;version != 0x10000)</span></span></td></tr>
<tr class="codeline" data-linenumber="1714"><td class="num" id="LN1714">1714</td><td class="line">            || (lu-&gt;sig != <span class='macro'>EVP_PKEY_RSA<span class='macro_popup'>6</span></span></td></tr>
<tr class="codeline" data-linenumber="1715"><td class="num" id="LN1715">1715</td><td class="line">                &amp;&amp; lu-&gt;hash != <span class='macro'>NID_sha1<span class='macro_popup'>64</span></span></td></tr>
<tr class="codeline" data-linenumber="1716"><td class="num" id="LN1716">1716</td><td class="line">                &amp;&amp; lu-&gt;hash != <span class='macro'>NID_sha224<span class='macro_popup'>675</span></span>)))</td></tr>
<tr class="codeline" data-linenumber="1717"><td class="num" id="LN1717">1717</td><td class="line">            rv = 1;</td></tr>
<tr class="codeline" data-linenumber="1718"><td class="num" id="LN1718">1718</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1719"><td class="num" id="LN1719">1719</td><td class="line">    <span class='keyword'>if</span> (rv == 0)</td></tr>
<tr class="codeline" data-linenumber="1720"><td class="num" id="LN1720">1720</td><td class="line">        <span class='macro'>SSLerr(SSL_F_TLS12_COPY_SIGALGS, SSL_R_NO_SUITABLE_SIGNATURE_ALGORITHM)<span class='macro_popup'>ERR_put_error(20,(533),(118),"../deps/openssl/openssl/ssl/t1_lib.c"<br>,1720)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1721"><td class="num" id="LN1721">1721</td><td class="line">    <span class='keyword'>return</span> rv;</td></tr>
<tr class="codeline" data-linenumber="1722"><td class="num" id="LN1722">1722</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1723"><td class="num" id="LN1723">1723</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1724"><td class="num" id="LN1724">1724</td><td class="line"><span class='comment'>/* Given preference and allowed sigalgs set shared sigalgs */</span></td></tr>
<tr class="codeline" data-linenumber="1725"><td class="num" id="LN1725">1725</td><td class="line"><span class='keyword'>static</span> size_t tls12_shared_sigalgs(SSL *s, <span class='keyword'>const</span> SIGALG_LOOKUP **shsig,</td></tr>
<tr class="codeline" data-linenumber="1726"><td class="num" id="LN1726">1726</td><td class="line">                                   <span class='keyword'>const</span> uint16_t *pref, size_t preflen,</td></tr>
<tr class="codeline" data-linenumber="1727"><td class="num" id="LN1727">1727</td><td class="line">                                   <span class='keyword'>const</span> uint16_t *allow, size_t allowlen)</td></tr>
<tr class="codeline" data-linenumber="1728"><td class="num" id="LN1728">1728</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1729"><td class="num" id="LN1729">1729</td><td class="line">    <span class='keyword'>const</span> uint16_t *ptmp, *atmp;</td></tr>
<tr class="codeline" data-linenumber="1730"><td class="num" id="LN1730">1730</td><td class="line">    size_t i, j, nmatch = 0;</td></tr>
<tr class="codeline" data-linenumber="1731"><td class="num" id="LN1731">1731</td><td class="line">    <span class='keyword'>for</span> (i = 0, ptmp = pref; i &lt; preflen; i++, ptmp++) {</td></tr>
<tr class="codeline" data-linenumber="1732"><td class="num" id="LN1732">1732</td><td class="line">        <span class='keyword'>const</span> SIGALG_LOOKUP *lu = tls1_lookup_sigalg(*ptmp);</td></tr>
<tr class="codeline" data-linenumber="1733"><td class="num" id="LN1733">1733</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1734"><td class="num" id="LN1734">1734</td><td class="line">        <span class='comment'>/* Skip disabled hashes or signature algorithms */</span></td></tr>
<tr class="codeline" data-linenumber="1735"><td class="num" id="LN1735">1735</td><td class="line">        <span class='keyword'>if</span> (!tls12_sigalg_allowed(s, <span class='macro'>SSL_SECOP_SIGALG_SHARED<span class='macro_popup'>(12 | (5 &lt;&lt; 16))</span></span>, lu))</td></tr>
<tr class="codeline" data-linenumber="1736"><td class="num" id="LN1736">1736</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1737"><td class="num" id="LN1737">1737</td><td class="line">        <span class='keyword'>for</span> (j = 0, atmp = allow; j &lt; allowlen; j++, atmp++) {</td></tr>
<tr class="codeline" data-linenumber="1738"><td class="num" id="LN1738">1738</td><td class="line">            <span class='keyword'>if</span> (*ptmp == *atmp) {</td></tr>
<tr class="codeline" data-linenumber="1739"><td class="num" id="LN1739">1739</td><td class="line">                nmatch++;</td></tr>
<tr class="codeline" data-linenumber="1740"><td class="num" id="LN1740">1740</td><td class="line">                <span class='keyword'>if</span> (shsig)</td></tr>
<tr class="codeline" data-linenumber="1741"><td class="num" id="LN1741">1741</td><td class="line">                    *shsig++ = lu;</td></tr>
<tr class="codeline" data-linenumber="1742"><td class="num" id="LN1742">1742</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1743"><td class="num" id="LN1743">1743</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1744"><td class="num" id="LN1744">1744</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1745"><td class="num" id="LN1745">1745</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1746"><td class="num" id="LN1746">1746</td><td class="line">    <span class='keyword'>return</span> nmatch;</td></tr>
<tr class="codeline" data-linenumber="1747"><td class="num" id="LN1747">1747</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1748"><td class="num" id="LN1748">1748</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1749"><td class="num" id="LN1749">1749</td><td class="line"><span class='comment'>/* Set shared signature algorithms for SSL structures */</span></td></tr>
<tr class="codeline" data-linenumber="1750"><td class="num" id="LN1750">1750</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls1_set_shared_sigalgs(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="1751"><td class="num" id="LN1751">1751</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1752"><td class="num" id="LN1752">1752</td><td class="line">    <span class='keyword'>const</span> uint16_t *pref, *allow, *conf;</td></tr>
<tr class="codeline" data-linenumber="1753"><td class="num" id="LN1753">1753</td><td class="line">    size_t preflen, allowlen, conflen;</td></tr>
<tr class="codeline" data-linenumber="1754"><td class="num" id="LN1754">1754</td><td class="line">    size_t nmatch;</td></tr>
<tr class="codeline" data-linenumber="1755"><td class="num" id="LN1755">1755</td><td class="line">    <span class='keyword'>const</span> SIGALG_LOOKUP **salgs = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1756"><td class="num" id="LN1756">1756</td><td class="line">    CERT *c = s-&gt;cert;</td></tr>
<tr class="codeline" data-linenumber="1757"><td class="num" id="LN1757">1757</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> is_suiteb = <span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1758"><td class="num" id="LN1758">1758</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1759"><td class="num" id="LN1759">1759</td><td class="line">    <span class='macro'>OPENSSL_free(s-&gt;shared_sigalgs)<span class='macro_popup'>CRYPTO_free(s-&gt;shared_sigalgs, "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1759)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1760"><td class="num" id="LN1760">1760</td><td class="line">    s-&gt;shared_sigalgs = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1761"><td class="num" id="LN1761">1761</td><td class="line">    s-&gt;shared_sigalgslen = 0;</td></tr>
<tr class="codeline" data-linenumber="1762"><td class="num" id="LN1762">1762</td><td class="line">    <span class='comment'>/* If client use client signature algorithms if not NULL */</span></td></tr>
<tr class="codeline" data-linenumber="1763"><td class="num" id="LN1763">1763</td><td class="line">    <span class='keyword'>if</span> (!s-&gt;server &amp;&amp; c-&gt;client_sigalgs &amp;&amp; !is_suiteb) {</td></tr>
<tr class="codeline" data-linenumber="1764"><td class="num" id="LN1764">1764</td><td class="line">        conf = c-&gt;client_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="1765"><td class="num" id="LN1765">1765</td><td class="line">        conflen = c-&gt;client_sigalgslen;</td></tr>
<tr class="codeline" data-linenumber="1766"><td class="num" id="LN1766">1766</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (c-&gt;conf_sigalgs &amp;&amp; !is_suiteb) {</td></tr>
<tr class="codeline" data-linenumber="1767"><td class="num" id="LN1767">1767</td><td class="line">        conf = c-&gt;conf_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="1768"><td class="num" id="LN1768">1768</td><td class="line">        conflen = c-&gt;conf_sigalgslen;</td></tr>
<tr class="codeline" data-linenumber="1769"><td class="num" id="LN1769">1769</td><td class="line">    } <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1770"><td class="num" id="LN1770">1770</td><td class="line">        conflen = tls12_get_psigalgs(s, 0, &amp;conf);</td></tr>
<tr class="codeline" data-linenumber="1771"><td class="num" id="LN1771">1771</td><td class="line">    <span class='keyword'>if</span> (s-&gt;options &amp; <span class='macro'>SSL_OP_CIPHER_SERVER_PREFERENCE<span class='macro_popup'>0x00400000U</span></span> || is_suiteb) {</td></tr>
<tr class="codeline" data-linenumber="1772"><td class="num" id="LN1772">1772</td><td class="line">        pref = conf;</td></tr>
<tr class="codeline" data-linenumber="1773"><td class="num" id="LN1773">1773</td><td class="line">        preflen = conflen;</td></tr>
<tr class="codeline" data-linenumber="1774"><td class="num" id="LN1774">1774</td><td class="line">        allow = s-&gt;s3-&gt;tmp.peer_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="1775"><td class="num" id="LN1775">1775</td><td class="line">        allowlen = s-&gt;s3-&gt;tmp.peer_sigalgslen;</td></tr>
<tr class="codeline" data-linenumber="1776"><td class="num" id="LN1776">1776</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1777"><td class="num" id="LN1777">1777</td><td class="line">        allow = conf;</td></tr>
<tr class="codeline" data-linenumber="1778"><td class="num" id="LN1778">1778</td><td class="line">        allowlen = conflen;</td></tr>
<tr class="codeline" data-linenumber="1779"><td class="num" id="LN1779">1779</td><td class="line">        pref = s-&gt;s3-&gt;tmp.peer_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="1780"><td class="num" id="LN1780">1780</td><td class="line">        preflen = s-&gt;s3-&gt;tmp.peer_sigalgslen;</td></tr>
<tr class="codeline" data-linenumber="1781"><td class="num" id="LN1781">1781</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1782"><td class="num" id="LN1782">1782</td><td class="line">    nmatch = tls12_shared_sigalgs(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, pref, preflen, allow, allowlen);</td></tr>
<tr class="codeline" data-linenumber="1783"><td class="num" id="LN1783">1783</td><td class="line">    <span class='keyword'>if</span> (nmatch) {</td></tr>
<tr class="codeline" data-linenumber="1784"><td class="num" id="LN1784">1784</td><td class="line">        <span class='keyword'>if</span> ((salgs = <span class='macro'>OPENSSL_malloc(nmatch * <span class='keyword'>sizeof</span>(*salgs))<span class='macro_popup'>CRYPTO_malloc(nmatch * sizeof(*salgs), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1784)</span></span>) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1785"><td class="num" id="LN1785">1785</td><td class="line">            <span class='macro'>SSLerr(SSL_F_TLS1_SET_SHARED_SIGALGS, ERR_R_MALLOC_FAILURE)<span class='macro_popup'>ERR_put_error(20,(631),((1|64)),"../deps/openssl/openssl/ssl/t1_lib.c"<br>,1785)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1786"><td class="num" id="LN1786">1786</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1787"><td class="num" id="LN1787">1787</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1788"><td class="num" id="LN1788">1788</td><td class="line">        nmatch = tls12_shared_sigalgs(s, salgs, pref, preflen, allow, allowlen);</td></tr>
<tr class="codeline" data-linenumber="1789"><td class="num" id="LN1789">1789</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1790"><td class="num" id="LN1790">1790</td><td class="line">        salgs = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1791"><td class="num" id="LN1791">1791</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1792"><td class="num" id="LN1792">1792</td><td class="line">    s-&gt;shared_sigalgs = salgs;</td></tr>
<tr class="codeline" data-linenumber="1793"><td class="num" id="LN1793">1793</td><td class="line">    s-&gt;shared_sigalgslen = nmatch;</td></tr>
<tr class="codeline" data-linenumber="1794"><td class="num" id="LN1794">1794</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1795"><td class="num" id="LN1795">1795</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1796"><td class="num" id="LN1796">1796</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1797"><td class="num" id="LN1797">1797</td><td class="line"><span class='keyword'>int</span> tls1_save_u16(PACKET *pkt, uint16_t **pdest, size_t *pdestlen)</td></tr>
<tr class="codeline" data-linenumber="1798"><td class="num" id="LN1798">1798</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1799"><td class="num" id="LN1799">1799</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> stmp;</td></tr>
<tr class="codeline" data-linenumber="1800"><td class="num" id="LN1800">1800</td><td class="line">    size_t size, i;</td></tr>
<tr class="codeline" data-linenumber="1801"><td class="num" id="LN1801">1801</td><td class="line">    uint16_t *buf;</td></tr>
<tr class="codeline" data-linenumber="1802"><td class="num" id="LN1802">1802</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1803"><td class="num" id="LN1803">1803</td><td class="line">    size = PACKET_remaining(pkt);</td></tr>
<tr class="codeline" data-linenumber="1804"><td class="num" id="LN1804">1804</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1805"><td class="num" id="LN1805">1805</td><td class="line">    <span class='comment'>/* Invalid data length */</span></td></tr>
<tr class="codeline" data-linenumber="1806"><td class="num" id="LN1806">1806</td><td class="line">    <span class='keyword'>if</span> (size == 0 || (size &amp; 1) != 0)</td></tr>
<tr class="codeline" data-linenumber="1807"><td class="num" id="LN1807">1807</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1808"><td class="num" id="LN1808">1808</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1809"><td class="num" id="LN1809">1809</td><td class="line">    size &gt;&gt;= 1;</td></tr>
<tr class="codeline" data-linenumber="1810"><td class="num" id="LN1810">1810</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1811"><td class="num" id="LN1811">1811</td><td class="line">    <span class='keyword'>if</span> ((buf = <span class='macro'>OPENSSL_malloc(size * <span class='keyword'>sizeof</span>(*buf))<span class='macro_popup'>CRYPTO_malloc(size * sizeof(*buf), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 1811)</span></span>) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)  {</td></tr>
<tr class="codeline" data-linenumber="1812"><td class="num" id="LN1812">1812</td><td class="line">        <span class='macro'>SSLerr(SSL_F_TLS1_SAVE_U16, ERR_R_MALLOC_FAILURE)<span class='macro_popup'>ERR_put_error(20,(628),((1|64)),"../deps/openssl/openssl/ssl/t1_lib.c"<br>,1812)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1813"><td class="num" id="LN1813">1813</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1814"><td class="num" id="LN1814">1814</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1815"><td class="num" id="LN1815">1815</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; size &amp;&amp; PACKET_get_net_2(pkt, &amp;stmp); i++)</td></tr>
<tr class="codeline" data-linenumber="1816"><td class="num" id="LN1816">1816</td><td class="line">        buf[i] = stmp;</td></tr>
<tr class="codeline" data-linenumber="1817"><td class="num" id="LN1817">1817</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1818"><td class="num" id="LN1818">1818</td><td class="line">    <span class='keyword'>if</span> (i != size) {</td></tr>
<tr class="codeline" data-linenumber="1819"><td class="num" id="LN1819">1819</td><td class="line">        <span class='macro'>OPENSSL_free(buf)<span class='macro_popup'>CRYPTO_free(buf, "../deps/openssl/openssl/ssl/t1_lib.c", 1819<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1820"><td class="num" id="LN1820">1820</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1821"><td class="num" id="LN1821">1821</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1822"><td class="num" id="LN1822">1822</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1823"><td class="num" id="LN1823">1823</td><td class="line">    <span class='macro'>OPENSSL_free(*pdest)<span class='macro_popup'>CRYPTO_free(*pdest, "../deps/openssl/openssl/ssl/t1_lib.c", 1823<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1824"><td class="num" id="LN1824">1824</td><td class="line">    *pdest = buf;</td></tr>
<tr class="codeline" data-linenumber="1825"><td class="num" id="LN1825">1825</td><td class="line">    *pdestlen = size;</td></tr>
<tr class="codeline" data-linenumber="1826"><td class="num" id="LN1826">1826</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1827"><td class="num" id="LN1827">1827</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1828"><td class="num" id="LN1828">1828</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1829"><td class="num" id="LN1829">1829</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1830"><td class="num" id="LN1830">1830</td><td class="line"><span class='keyword'>int</span> tls1_save_sigalgs(SSL *s, PACKET *pkt, <span class='keyword'>int</span> cert)</td></tr>
<tr class="codeline" data-linenumber="1831"><td class="num" id="LN1831">1831</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1832"><td class="num" id="LN1832">1832</td><td class="line">    <span class='comment'>/* Extension ignored for inappropriate versions */</span></td></tr>
<tr class="codeline" data-linenumber="1833"><td class="num" id="LN1833">1833</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>SSL_USE_SIGALGS(s)<span class='macro_popup'>(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x2)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1834"><td class="num" id="LN1834">1834</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1835"><td class="num" id="LN1835">1835</td><td class="line">    <span class='comment'>/* Should never happen */</span></td></tr>
<tr class="codeline" data-linenumber="1836"><td class="num" id="LN1836">1836</td><td class="line">    <span class='keyword'>if</span> (s-&gt;cert == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1837"><td class="num" id="LN1837">1837</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1838"><td class="num" id="LN1838">1838</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1839"><td class="num" id="LN1839">1839</td><td class="line">    <span class='keyword'>if</span> (cert)</td></tr>
<tr class="codeline" data-linenumber="1840"><td class="num" id="LN1840">1840</td><td class="line">        <span class='keyword'>return</span> tls1_save_u16(pkt, &amp;s-&gt;s3-&gt;tmp.peer_cert_sigalgs,</td></tr>
<tr class="codeline" data-linenumber="1841"><td class="num" id="LN1841">1841</td><td class="line">                             &amp;s-&gt;s3-&gt;tmp.peer_cert_sigalgslen);</td></tr>
<tr class="codeline" data-linenumber="1842"><td class="num" id="LN1842">1842</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1843"><td class="num" id="LN1843">1843</td><td class="line">        <span class='keyword'>return</span> tls1_save_u16(pkt, &amp;s-&gt;s3-&gt;tmp.peer_sigalgs,</td></tr>
<tr class="codeline" data-linenumber="1844"><td class="num" id="LN1844">1844</td><td class="line">                             &amp;s-&gt;s3-&gt;tmp.peer_sigalgslen);</td></tr>
<tr class="codeline" data-linenumber="1845"><td class="num" id="LN1845">1845</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1846"><td class="num" id="LN1846">1846</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1847"><td class="num" id="LN1847">1847</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1848"><td class="num" id="LN1848">1848</td><td class="line"><span class='comment'>/* Set preferred digest for each key type */</span></td></tr>
<tr class="codeline" data-linenumber="1849"><td class="num" id="LN1849">1849</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1850"><td class="num" id="LN1850">1850</td><td class="line"><span class='keyword'>int</span> tls1_process_sigalgs(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="1851"><td class="num" id="LN1851">1851</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1852"><td class="num" id="LN1852">1852</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="1853"><td class="num" id="LN1853">1853</td><td class="line">    uint32_t *pvalid = s-&gt;s3-&gt;tmp.valid_flags;</td></tr>
<tr class="codeline" data-linenumber="1854"><td class="num" id="LN1854">1854</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1855"><td class="num" id="LN1855">1855</td><td class="line">    <span class='keyword'>if</span> (!tls1_set_shared_sigalgs(s))</td></tr>
<tr class="codeline" data-linenumber="1856"><td class="num" id="LN1856">1856</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1857"><td class="num" id="LN1857">1857</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1858"><td class="num" id="LN1858">1858</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; <span class='macro'>SSL_PKEY_NUM<span class='macro_popup'>9</span></span>; i++)</td></tr>
<tr class="codeline" data-linenumber="1859"><td class="num" id="LN1859">1859</td><td class="line">        pvalid[i] = 0;</td></tr>
<tr class="codeline" data-linenumber="1860"><td class="num" id="LN1860">1860</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1861"><td class="num" id="LN1861">1861</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; s-&gt;shared_sigalgslen; i++) {</td></tr>
<tr class="codeline" data-linenumber="1862"><td class="num" id="LN1862">1862</td><td class="line">        <span class='keyword'>const</span> SIGALG_LOOKUP *sigptr = s-&gt;shared_sigalgs[i];</td></tr>
<tr class="codeline" data-linenumber="1863"><td class="num" id="LN1863">1863</td><td class="line">        <span class='keyword'>int</span> idx = sigptr-&gt;sig_idx;</td></tr>
<tr class="codeline" data-linenumber="1864"><td class="num" id="LN1864">1864</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1865"><td class="num" id="LN1865">1865</td><td class="line">        <span class='comment'>/* Ignore PKCS1 based sig algs in TLSv1.3 */</span></td></tr>
<tr class="codeline" data-linenumber="1866"><td class="num" id="LN1866">1866</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>SSL_IS_TLS13(s)<span class='macro_popup'>(!(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8) &amp;&amp;<br> (s)-&gt;method-&gt;version &gt;= 0x0304 &amp;&amp; (s)-&gt;method<br>-&gt;version != 0x10000)</span></span> &amp;&amp; sigptr-&gt;sig == <span class='macro'>EVP_PKEY_RSA<span class='macro_popup'>6</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1867"><td class="num" id="LN1867">1867</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1868"><td class="num" id="LN1868">1868</td><td class="line">        <span class='comment'>/* If not disabled indicate we can explicitly sign */</span></td></tr>
<tr class="codeline" data-linenumber="1869"><td class="num" id="LN1869">1869</td><td class="line">        <span class='keyword'>if</span> (pvalid[idx] == 0 &amp;&amp; !ssl_cert_is_disabled(idx))</td></tr>
<tr class="codeline" data-linenumber="1870"><td class="num" id="LN1870">1870</td><td class="line">            pvalid[idx] = <span class='macro'>CERT_PKEY_EXPLICIT_SIGN<span class='macro_popup'>0x100</span></span> | <span class='macro'>CERT_PKEY_SIGN<span class='macro_popup'>0x2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1871"><td class="num" id="LN1871">1871</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1872"><td class="num" id="LN1872">1872</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1873"><td class="num" id="LN1873">1873</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1874"><td class="num" id="LN1874">1874</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1875"><td class="num" id="LN1875">1875</td><td class="line"><span class='keyword'>int</span> SSL_get_sigalgs(SSL *s, <span class='keyword'>int</span> idx,</td></tr>
<tr class="codeline" data-linenumber="1876"><td class="num" id="LN1876">1876</td><td class="line">                    <span class='keyword'>int</span> *psign, <span class='keyword'>int</span> *phash, <span class='keyword'>int</span> *psignhash,</td></tr>
<tr class="codeline" data-linenumber="1877"><td class="num" id="LN1877">1877</td><td class="line">                    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *rsig, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *rhash)</td></tr>
<tr class="codeline" data-linenumber="1878"><td class="num" id="LN1878">1878</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1879"><td class="num" id="LN1879">1879</td><td class="line">    uint16_t *psig = s-&gt;s3-&gt;tmp.peer_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="1880"><td class="num" id="LN1880">1880</td><td class="line">    size_t numsigalgs = s-&gt;s3-&gt;tmp.peer_sigalgslen;</td></tr>
<tr class="codeline" data-linenumber="1881"><td class="num" id="LN1881">1881</td><td class="line">    <span class='keyword'>if</span> (psig == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || numsigalgs &gt; <span class='macro'>INT_MAX<span class='macro_popup'>2147483647</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1882"><td class="num" id="LN1882">1882</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1883"><td class="num" id="LN1883">1883</td><td class="line">    <span class='keyword'>if</span> (idx &gt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="1884"><td class="num" id="LN1884">1884</td><td class="line">        <span class='keyword'>const</span> SIGALG_LOOKUP *lu;</td></tr>
<tr class="codeline" data-linenumber="1885"><td class="num" id="LN1885">1885</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1886"><td class="num" id="LN1886">1886</td><td class="line">        <span class='keyword'>if</span> (idx &gt;= (<span class='keyword'>int</span>)numsigalgs)</td></tr>
<tr class="codeline" data-linenumber="1887"><td class="num" id="LN1887">1887</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1888"><td class="num" id="LN1888">1888</td><td class="line">        psig += idx;</td></tr>
<tr class="codeline" data-linenumber="1889"><td class="num" id="LN1889">1889</td><td class="line">        <span class='keyword'>if</span> (rhash != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1890"><td class="num" id="LN1890">1890</td><td class="line">            *rhash = (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>)((*psig &gt;&gt; 8) &amp; 0xff);</td></tr>
<tr class="codeline" data-linenumber="1891"><td class="num" id="LN1891">1891</td><td class="line">        <span class='keyword'>if</span> (rsig != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1892"><td class="num" id="LN1892">1892</td><td class="line">            *rsig = (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>)(*psig &amp; 0xff);</td></tr>
<tr class="codeline" data-linenumber="1893"><td class="num" id="LN1893">1893</td><td class="line">        lu = tls1_lookup_sigalg(*psig);</td></tr>
<tr class="codeline" data-linenumber="1894"><td class="num" id="LN1894">1894</td><td class="line">        <span class='keyword'>if</span> (psign != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1895"><td class="num" id="LN1895">1895</td><td class="line">            *psign = lu != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> ? lu-&gt;sig : <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1896"><td class="num" id="LN1896">1896</td><td class="line">        <span class='keyword'>if</span> (phash != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1897"><td class="num" id="LN1897">1897</td><td class="line">            *phash = lu != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> ? lu-&gt;hash : <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1898"><td class="num" id="LN1898">1898</td><td class="line">        <span class='keyword'>if</span> (psignhash != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1899"><td class="num" id="LN1899">1899</td><td class="line">            *psignhash = lu != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> ? lu-&gt;sigandhash : <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1900"><td class="num" id="LN1900">1900</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1901"><td class="num" id="LN1901">1901</td><td class="line">    <span class='keyword'>return</span> (<span class='keyword'>int</span>)numsigalgs;</td></tr>
<tr class="codeline" data-linenumber="1902"><td class="num" id="LN1902">1902</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1903"><td class="num" id="LN1903">1903</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1904"><td class="num" id="LN1904">1904</td><td class="line"><span class='keyword'>int</span> SSL_get_shared_sigalgs(SSL *s, <span class='keyword'>int</span> idx,</td></tr>
<tr class="codeline" data-linenumber="1905"><td class="num" id="LN1905">1905</td><td class="line">                           <span class='keyword'>int</span> *psign, <span class='keyword'>int</span> *phash, <span class='keyword'>int</span> *psignhash,</td></tr>
<tr class="codeline" data-linenumber="1906"><td class="num" id="LN1906">1906</td><td class="line">                           <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *rsig, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *rhash)</td></tr>
<tr class="codeline" data-linenumber="1907"><td class="num" id="LN1907">1907</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1908"><td class="num" id="LN1908">1908</td><td class="line">    <span class='keyword'>const</span> SIGALG_LOOKUP *shsigalgs;</td></tr>
<tr class="codeline" data-linenumber="1909"><td class="num" id="LN1909">1909</td><td class="line">    <span class='keyword'>if</span> (s-&gt;shared_sigalgs == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="1910"><td class="num" id="LN1910">1910</td><td class="line">        || idx &lt; 0</td></tr>
<tr class="codeline" data-linenumber="1911"><td class="num" id="LN1911">1911</td><td class="line">        || idx &gt;= (<span class='keyword'>int</span>)s-&gt;shared_sigalgslen</td></tr>
<tr class="codeline" data-linenumber="1912"><td class="num" id="LN1912">1912</td><td class="line">        || s-&gt;shared_sigalgslen &gt; <span class='macro'>INT_MAX<span class='macro_popup'>2147483647</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1913"><td class="num" id="LN1913">1913</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1914"><td class="num" id="LN1914">1914</td><td class="line">    shsigalgs = s-&gt;shared_sigalgs[idx];</td></tr>
<tr class="codeline" data-linenumber="1915"><td class="num" id="LN1915">1915</td><td class="line">    <span class='keyword'>if</span> (phash != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1916"><td class="num" id="LN1916">1916</td><td class="line">        *phash = shsigalgs-&gt;hash;</td></tr>
<tr class="codeline" data-linenumber="1917"><td class="num" id="LN1917">1917</td><td class="line">    <span class='keyword'>if</span> (psign != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1918"><td class="num" id="LN1918">1918</td><td class="line">        *psign = shsigalgs-&gt;sig;</td></tr>
<tr class="codeline" data-linenumber="1919"><td class="num" id="LN1919">1919</td><td class="line">    <span class='keyword'>if</span> (psignhash != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1920"><td class="num" id="LN1920">1920</td><td class="line">        *psignhash = shsigalgs-&gt;sigandhash;</td></tr>
<tr class="codeline" data-linenumber="1921"><td class="num" id="LN1921">1921</td><td class="line">    <span class='keyword'>if</span> (rsig != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1922"><td class="num" id="LN1922">1922</td><td class="line">        *rsig = (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>)(shsigalgs-&gt;sigalg &amp; 0xff);</td></tr>
<tr class="codeline" data-linenumber="1923"><td class="num" id="LN1923">1923</td><td class="line">    <span class='keyword'>if</span> (rhash != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1924"><td class="num" id="LN1924">1924</td><td class="line">        *rhash = (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>)((shsigalgs-&gt;sigalg &gt;&gt; 8) &amp; 0xff);</td></tr>
<tr class="codeline" data-linenumber="1925"><td class="num" id="LN1925">1925</td><td class="line">    <span class='keyword'>return</span> (<span class='keyword'>int</span>)s-&gt;shared_sigalgslen;</td></tr>
<tr class="codeline" data-linenumber="1926"><td class="num" id="LN1926">1926</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1927"><td class="num" id="LN1927">1927</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1928"><td class="num" id="LN1928">1928</td><td class="line"><span class='comment'>/* Maximum possible number of unique entries in sigalgs array */</span></td></tr>
<tr class="codeline" data-linenumber="1929"><td class="num" id="LN1929">1929</td><td class="line"><span class='directive'>#define <span class='macro'>TLS_MAX_SIGALGCNT<span class='macro_popup'>((sizeof(sigalg_lookup_tbl)/sizeof((sigalg_lookup_tbl)[0])) *<br> 2)</span></span> (<span class='macro'>OSSL_NELEM(sigalg_lookup_tbl)<span class='macro_popup'>(sizeof(sigalg_lookup_tbl)/sizeof((sigalg_lookup_tbl)[0]))</span></span> * 2)</span></td></tr>
<tr class="codeline" data-linenumber="1930"><td class="num" id="LN1930">1930</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1931"><td class="num" id="LN1931">1931</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> {</td></tr>
<tr class="codeline" data-linenumber="1932"><td class="num" id="LN1932">1932</td><td class="line">    size_t sigalgcnt;</td></tr>
<tr class="codeline" data-linenumber="1933"><td class="num" id="LN1933">1933</td><td class="line">    <span class='comment'>/* TLSEXT_SIGALG_XXX values */</span></td></tr>
<tr class="codeline" data-linenumber="1934"><td class="num" id="LN1934">1934</td><td class="line">    uint16_t sigalgs[<span class='macro'>TLS_MAX_SIGALGCNT<span class='macro_popup'>((sizeof(sigalg_lookup_tbl)/sizeof((sigalg_lookup_tbl)[0])) *<br> 2)</span></span>];</td></tr>
<tr class="codeline" data-linenumber="1935"><td class="num" id="LN1935">1935</td><td class="line">} sig_cb_st;</td></tr>
<tr class="codeline" data-linenumber="1936"><td class="num" id="LN1936">1936</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1937"><td class="num" id="LN1937">1937</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> get_sigorhash(<span class='keyword'>int</span> *psig, <span class='keyword'>int</span> *phash, <span class='keyword'>const</span> <span class='keyword'>char</span> *str)</td></tr>
<tr class="codeline" data-linenumber="1938"><td class="num" id="LN1938">1938</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1939"><td class="num" id="LN1939">1939</td><td class="line">    <span class='keyword'>if</span> (strcmp(str, <span class='string_literal'>"RSA"</span>) == 0) {</td></tr>
<tr class="codeline" data-linenumber="1940"><td class="num" id="LN1940">1940</td><td class="line">        *psig = <span class='macro'>EVP_PKEY_RSA<span class='macro_popup'>6</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1941"><td class="num" id="LN1941">1941</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (strcmp(str, <span class='string_literal'>"RSA-PSS"</span>) == 0 || strcmp(str, <span class='string_literal'>"PSS"</span>) == 0) {</td></tr>
<tr class="codeline" data-linenumber="1942"><td class="num" id="LN1942">1942</td><td class="line">        *psig = <span class='macro'>EVP_PKEY_RSA_PSS<span class='macro_popup'>912</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1943"><td class="num" id="LN1943">1943</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (strcmp(str, <span class='string_literal'>"DSA"</span>) == 0) {</td></tr>
<tr class="codeline" data-linenumber="1944"><td class="num" id="LN1944">1944</td><td class="line">        *psig = <span class='macro'>EVP_PKEY_DSA<span class='macro_popup'>116</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1945"><td class="num" id="LN1945">1945</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (strcmp(str, <span class='string_literal'>"ECDSA"</span>) == 0) {</td></tr>
<tr class="codeline" data-linenumber="1946"><td class="num" id="LN1946">1946</td><td class="line">        *psig = <span class='macro'>EVP_PKEY_EC<span class='macro_popup'>408</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1947"><td class="num" id="LN1947">1947</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1948"><td class="num" id="LN1948">1948</td><td class="line">        *phash = OBJ_sn2nid(str);</td></tr>
<tr class="codeline" data-linenumber="1949"><td class="num" id="LN1949">1949</td><td class="line">        <span class='keyword'>if</span> (*phash == <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1950"><td class="num" id="LN1950">1950</td><td class="line">            *phash = OBJ_ln2nid(str);</td></tr>
<tr class="codeline" data-linenumber="1951"><td class="num" id="LN1951">1951</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1952"><td class="num" id="LN1952">1952</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1953"><td class="num" id="LN1953">1953</td><td class="line"><span class='comment'>/* Maximum length of a signature algorithm string component */</span></td></tr>
<tr class="codeline" data-linenumber="1954"><td class="num" id="LN1954">1954</td><td class="line"><span class='directive'>#define <span class='macro'>TLS_MAX_SIGSTRING_LEN<span class='macro_popup'>40</span></span>   40</span></td></tr>
<tr class="codeline" data-linenumber="1955"><td class="num" id="LN1955">1955</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1956"><td class="num" id="LN1956">1956</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> sig_cb(<span class='keyword'>const</span> <span class='keyword'>char</span> *elem, <span class='keyword'>int</span> len, <span class='keyword'>void</span> *arg)</td></tr>
<tr class="codeline" data-linenumber="1957"><td class="num" id="LN1957">1957</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1958"><td class="num" id="LN1958">1958</td><td class="line">    sig_cb_st *sarg = arg;</td></tr>
<tr class="codeline" data-linenumber="1959"><td class="num" id="LN1959">1959</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="1960"><td class="num" id="LN1960">1960</td><td class="line">    <span class='keyword'>const</span> SIGALG_LOOKUP *s;</td></tr>
<tr class="codeline" data-linenumber="1961"><td class="num" id="LN1961">1961</td><td class="line">    <span class='keyword'>char</span> etmp[<span class='macro'>TLS_MAX_SIGSTRING_LEN<span class='macro_popup'>40</span></span>], *p;</td></tr>
<tr class="codeline" data-linenumber="1962"><td class="num" id="LN1962">1962</td><td class="line">    <span class='keyword'>int</span> sig_alg = <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>, hash_alg = <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1963"><td class="num" id="LN1963">1963</td><td class="line">    <span class='keyword'>if</span> (elem == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1964"><td class="num" id="LN1964">1964</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1965"><td class="num" id="LN1965">1965</td><td class="line">    <span class='keyword'>if</span> (sarg-&gt;sigalgcnt == <span class='macro'>TLS_MAX_SIGALGCNT<span class='macro_popup'>((sizeof(sigalg_lookup_tbl)/sizeof((sigalg_lookup_tbl)[0])) *<br> 2)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1966"><td class="num" id="LN1966">1966</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1967"><td class="num" id="LN1967">1967</td><td class="line">    <span class='keyword'>if</span> (len &gt; (<span class='keyword'>int</span>)(<span class='keyword'>sizeof</span>(etmp) - 1))</td></tr>
<tr class="codeline" data-linenumber="1968"><td class="num" id="LN1968">1968</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1969"><td class="num" id="LN1969">1969</td><td class="line">    memcpy(etmp, elem, len);</td></tr>
<tr class="codeline" data-linenumber="1970"><td class="num" id="LN1970">1970</td><td class="line">    etmp[len] = 0;</td></tr>
<tr class="codeline" data-linenumber="1971"><td class="num" id="LN1971">1971</td><td class="line">    p = strchr(etmp, '+');</td></tr>
<tr class="codeline" data-linenumber="1972"><td class="num" id="LN1972">1972</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1973"><td class="num" id="LN1973">1973</td><td class="line">     <span class='comment'>* We only allow SignatureSchemes listed in the sigalg_lookup_tbl;</span></td></tr>
<tr class="codeline" data-linenumber="1974"><td class="num" id="LN1974">1974</td><td class="line">     <span class='comment'>* if there's no '+' in the provided name, look for the new-style combined</span></td></tr>
<tr class="codeline" data-linenumber="1975"><td class="num" id="LN1975">1975</td><td class="line">     <span class='comment'>* name.  If not, match both sig+hash to find the needed SIGALG_LOOKUP.</span></td></tr>
<tr class="codeline" data-linenumber="1976"><td class="num" id="LN1976">1976</td><td class="line">     <span class='comment'>* Just sig+hash is not unique since TLS 1.3 adds rsa_pss_pss_* and</span></td></tr>
<tr class="codeline" data-linenumber="1977"><td class="num" id="LN1977">1977</td><td class="line">     <span class='comment'>* rsa_pss_rsae_* that differ only by public key OID; in such cases</span></td></tr>
<tr class="codeline" data-linenumber="1978"><td class="num" id="LN1978">1978</td><td class="line">     <span class='comment'>* we will pick the _rsae_ variant, by virtue of them appearing earlier</span></td></tr>
<tr class="codeline" data-linenumber="1979"><td class="num" id="LN1979">1979</td><td class="line">     <span class='comment'>* in the table.</span></td></tr>
<tr class="codeline" data-linenumber="1980"><td class="num" id="LN1980">1980</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1981"><td class="num" id="LN1981">1981</td><td class="line">    <span class='keyword'>if</span> (p == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1982"><td class="num" id="LN1982">1982</td><td class="line">        <span class='keyword'>for</span> (i = 0, s = sigalg_lookup_tbl; i &lt; <span class='macro'>OSSL_NELEM(sigalg_lookup_tbl)<span class='macro_popup'>(sizeof(sigalg_lookup_tbl)/sizeof((sigalg_lookup_tbl)[0]))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1983"><td class="num" id="LN1983">1983</td><td class="line">             i++, s++) {</td></tr>
<tr class="codeline" data-linenumber="1984"><td class="num" id="LN1984">1984</td><td class="line">            <span class='keyword'>if</span> (s-&gt;name != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; strcmp(etmp, s-&gt;name) == 0) {</td></tr>
<tr class="codeline" data-linenumber="1985"><td class="num" id="LN1985">1985</td><td class="line">                sarg-&gt;sigalgs[sarg-&gt;sigalgcnt++] = s-&gt;sigalg;</td></tr>
<tr class="codeline" data-linenumber="1986"><td class="num" id="LN1986">1986</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1987"><td class="num" id="LN1987">1987</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1988"><td class="num" id="LN1988">1988</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1989"><td class="num" id="LN1989">1989</td><td class="line">        <span class='keyword'>if</span> (i == <span class='macro'>OSSL_NELEM(sigalg_lookup_tbl)<span class='macro_popup'>(sizeof(sigalg_lookup_tbl)/sizeof((sigalg_lookup_tbl)[0]))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1990"><td class="num" id="LN1990">1990</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1991"><td class="num" id="LN1991">1991</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1992"><td class="num" id="LN1992">1992</td><td class="line">        *p = 0;</td></tr>
<tr class="codeline" data-linenumber="1993"><td class="num" id="LN1993">1993</td><td class="line">        p++;</td></tr>
<tr class="codeline" data-linenumber="1994"><td class="num" id="LN1994">1994</td><td class="line">        <span class='keyword'>if</span> (*p == 0)</td></tr>
<tr class="codeline" data-linenumber="1995"><td class="num" id="LN1995">1995</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1996"><td class="num" id="LN1996">1996</td><td class="line">        get_sigorhash(&amp;sig_alg, &amp;hash_alg, etmp);</td></tr>
<tr class="codeline" data-linenumber="1997"><td class="num" id="LN1997">1997</td><td class="line">        get_sigorhash(&amp;sig_alg, &amp;hash_alg, p);</td></tr>
<tr class="codeline" data-linenumber="1998"><td class="num" id="LN1998">1998</td><td class="line">        <span class='keyword'>if</span> (sig_alg == <span class='macro'>NID_undef<span class='macro_popup'>0</span></span> || hash_alg == <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1999"><td class="num" id="LN1999">1999</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2000"><td class="num" id="LN2000">2000</td><td class="line">        <span class='keyword'>for</span> (i = 0, s = sigalg_lookup_tbl; i &lt; <span class='macro'>OSSL_NELEM(sigalg_lookup_tbl)<span class='macro_popup'>(sizeof(sigalg_lookup_tbl)/sizeof((sigalg_lookup_tbl)[0]))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2001"><td class="num" id="LN2001">2001</td><td class="line">             i++, s++) {</td></tr>
<tr class="codeline" data-linenumber="2002"><td class="num" id="LN2002">2002</td><td class="line">            <span class='keyword'>if</span> (s-&gt;hash == hash_alg &amp;&amp; s-&gt;sig == sig_alg) {</td></tr>
<tr class="codeline" data-linenumber="2003"><td class="num" id="LN2003">2003</td><td class="line">                sarg-&gt;sigalgs[sarg-&gt;sigalgcnt++] = s-&gt;sigalg;</td></tr>
<tr class="codeline" data-linenumber="2004"><td class="num" id="LN2004">2004</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2005"><td class="num" id="LN2005">2005</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2006"><td class="num" id="LN2006">2006</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2007"><td class="num" id="LN2007">2007</td><td class="line">        <span class='keyword'>if</span> (i == <span class='macro'>OSSL_NELEM(sigalg_lookup_tbl)<span class='macro_popup'>(sizeof(sigalg_lookup_tbl)/sizeof((sigalg_lookup_tbl)[0]))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2008"><td class="num" id="LN2008">2008</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2009"><td class="num" id="LN2009">2009</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2010"><td class="num" id="LN2010">2010</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2011"><td class="num" id="LN2011">2011</td><td class="line">    <span class='comment'>/* Reject duplicates */</span></td></tr>
<tr class="codeline" data-linenumber="2012"><td class="num" id="LN2012">2012</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; sarg-&gt;sigalgcnt - 1; i++) {</td></tr>
<tr class="codeline" data-linenumber="2013"><td class="num" id="LN2013">2013</td><td class="line">        <span class='keyword'>if</span> (sarg-&gt;sigalgs[i] == sarg-&gt;sigalgs[sarg-&gt;sigalgcnt - 1]) {</td></tr>
<tr class="codeline" data-linenumber="2014"><td class="num" id="LN2014">2014</td><td class="line">            sarg-&gt;sigalgcnt--;</td></tr>
<tr class="codeline" data-linenumber="2015"><td class="num" id="LN2015">2015</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2016"><td class="num" id="LN2016">2016</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2017"><td class="num" id="LN2017">2017</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2018"><td class="num" id="LN2018">2018</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2019"><td class="num" id="LN2019">2019</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2020"><td class="num" id="LN2020">2020</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2021"><td class="num" id="LN2021">2021</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2022"><td class="num" id="LN2022">2022</td><td class="line"> <span class='comment'>* Set supported signature algorithms based on a colon separated list of the</span></td></tr>
<tr class="codeline" data-linenumber="2023"><td class="num" id="LN2023">2023</td><td class="line"> <span class='comment'>* form sig+hash e.g. RSA+SHA512:DSA+SHA512</span></td></tr>
<tr class="codeline" data-linenumber="2024"><td class="num" id="LN2024">2024</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2025"><td class="num" id="LN2025">2025</td><td class="line"><span class='keyword'>int</span> tls1_set_sigalgs_list(CERT *c, <span class='keyword'>const</span> <span class='keyword'>char</span> *str, <span class='keyword'>int</span> client)</td></tr>
<tr class="codeline" data-linenumber="2026"><td class="num" id="LN2026">2026</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2027"><td class="num" id="LN2027">2027</td><td class="line">    sig_cb_st sig;</td></tr>
<tr class="codeline" data-linenumber="2028"><td class="num" id="LN2028">2028</td><td class="line">    sig.sigalgcnt = 0;</td></tr>
<tr class="codeline" data-linenumber="2029"><td class="num" id="LN2029">2029</td><td class="line">    <span class='keyword'>if</span> (!CONF_parse_list(str, ':', 1, sig_cb, &amp;sig))</td></tr>
<tr class="codeline" data-linenumber="2030"><td class="num" id="LN2030">2030</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2031"><td class="num" id="LN2031">2031</td><td class="line">    <span class='keyword'>if</span> (c == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2032"><td class="num" id="LN2032">2032</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2033"><td class="num" id="LN2033">2033</td><td class="line">    <span class='keyword'>return</span> tls1_set_raw_sigalgs(c, sig.sigalgs, sig.sigalgcnt, client);</td></tr>
<tr class="codeline" data-linenumber="2034"><td class="num" id="LN2034">2034</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2035"><td class="num" id="LN2035">2035</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2036"><td class="num" id="LN2036">2036</td><td class="line"><span class='keyword'>int</span> tls1_set_raw_sigalgs(CERT *c, <span class='keyword'>const</span> uint16_t *psigs, size_t salglen,</td></tr>
<tr class="codeline" data-linenumber="2037"><td class="num" id="LN2037">2037</td><td class="line">                     <span class='keyword'>int</span> client)</td></tr>
<tr class="codeline" data-linenumber="2038"><td class="num" id="LN2038">2038</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2039"><td class="num" id="LN2039">2039</td><td class="line">    uint16_t *sigalgs;</td></tr>
<tr class="codeline" data-linenumber="2040"><td class="num" id="LN2040">2040</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2041"><td class="num" id="LN2041">2041</td><td class="line">    <span class='keyword'>if</span> ((sigalgs = <span class='macro'>OPENSSL_malloc(salglen * <span class='keyword'>sizeof</span>(*sigalgs))<span class='macro_popup'>CRYPTO_malloc(salglen * sizeof(*sigalgs), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 2041)</span></span>) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2042"><td class="num" id="LN2042">2042</td><td class="line">        <span class='macro'>SSLerr(SSL_F_TLS1_SET_RAW_SIGALGS, ERR_R_MALLOC_FAILURE)<span class='macro_popup'>ERR_put_error(20,(630),((1|64)),"../deps/openssl/openssl/ssl/t1_lib.c"<br>,2042)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2043"><td class="num" id="LN2043">2043</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2044"><td class="num" id="LN2044">2044</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2045"><td class="num" id="LN2045">2045</td><td class="line">    memcpy(sigalgs, psigs, salglen * <span class='keyword'>sizeof</span>(*sigalgs));</td></tr>
<tr class="codeline" data-linenumber="2046"><td class="num" id="LN2046">2046</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2047"><td class="num" id="LN2047">2047</td><td class="line">    <span class='keyword'>if</span> (client) {</td></tr>
<tr class="codeline" data-linenumber="2048"><td class="num" id="LN2048">2048</td><td class="line">        <span class='macro'>OPENSSL_free(c-&gt;client_sigalgs)<span class='macro_popup'>CRYPTO_free(c-&gt;client_sigalgs, "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 2048)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2049"><td class="num" id="LN2049">2049</td><td class="line">        c-&gt;client_sigalgs = sigalgs;</td></tr>
<tr class="codeline" data-linenumber="2050"><td class="num" id="LN2050">2050</td><td class="line">        c-&gt;client_sigalgslen = salglen;</td></tr>
<tr class="codeline" data-linenumber="2051"><td class="num" id="LN2051">2051</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2052"><td class="num" id="LN2052">2052</td><td class="line">        <span class='macro'>OPENSSL_free(c-&gt;conf_sigalgs)<span class='macro_popup'>CRYPTO_free(c-&gt;conf_sigalgs, "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 2052)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2053"><td class="num" id="LN2053">2053</td><td class="line">        c-&gt;conf_sigalgs = sigalgs;</td></tr>
<tr class="codeline" data-linenumber="2054"><td class="num" id="LN2054">2054</td><td class="line">        c-&gt;conf_sigalgslen = salglen;</td></tr>
<tr class="codeline" data-linenumber="2055"><td class="num" id="LN2055">2055</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2056"><td class="num" id="LN2056">2056</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2057"><td class="num" id="LN2057">2057</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2058"><td class="num" id="LN2058">2058</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2059"><td class="num" id="LN2059">2059</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2060"><td class="num" id="LN2060">2060</td><td class="line"><span class='keyword'>int</span> tls1_set_sigalgs(CERT *c, <span class='keyword'>const</span> <span class='keyword'>int</span> *psig_nids, size_t salglen, <span class='keyword'>int</span> client)</td></tr>
<tr class="codeline" data-linenumber="2061"><td class="num" id="LN2061">2061</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2062"><td class="num" id="LN2062">2062</td><td class="line">    uint16_t *sigalgs, *sptr;</td></tr>
<tr class="codeline" data-linenumber="2063"><td class="num" id="LN2063">2063</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="2064"><td class="num" id="LN2064">2064</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2065"><td class="num" id="LN2065">2065</td><td class="line">    <span class='keyword'>if</span> (salglen &amp; 1)</td></tr>
<tr class="codeline" data-linenumber="2066"><td class="num" id="LN2066">2066</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2067"><td class="num" id="LN2067">2067</td><td class="line">    <span class='keyword'>if</span> ((sigalgs = <span class='macro'>OPENSSL_malloc((salglen / 2) * <span class='keyword'>sizeof</span>(*sigalgs))<span class='macro_popup'>CRYPTO_malloc((salglen / 2) * sizeof(*sigalgs), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 2067)</span></span>) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2068"><td class="num" id="LN2068">2068</td><td class="line">        <span class='macro'>SSLerr(SSL_F_TLS1_SET_SIGALGS, ERR_R_MALLOC_FAILURE)<span class='macro_popup'>ERR_put_error(20,(632),((1|64)),"../deps/openssl/openssl/ssl/t1_lib.c"<br>,2068)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2069"><td class="num" id="LN2069">2069</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2070"><td class="num" id="LN2070">2070</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2071"><td class="num" id="LN2071">2071</td><td class="line">    <span class='keyword'>for</span> (i = 0, sptr = sigalgs; i &lt; salglen; i += 2) {</td></tr>
<tr class="codeline" data-linenumber="2072"><td class="num" id="LN2072">2072</td><td class="line">        size_t j;</td></tr>
<tr class="codeline" data-linenumber="2073"><td class="num" id="LN2073">2073</td><td class="line">        <span class='keyword'>const</span> SIGALG_LOOKUP *curr;</td></tr>
<tr class="codeline" data-linenumber="2074"><td class="num" id="LN2074">2074</td><td class="line">        <span class='keyword'>int</span> md_id = *psig_nids++;</td></tr>
<tr class="codeline" data-linenumber="2075"><td class="num" id="LN2075">2075</td><td class="line">        <span class='keyword'>int</span> sig_id = *psig_nids++;</td></tr>
<tr class="codeline" data-linenumber="2076"><td class="num" id="LN2076">2076</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2077"><td class="num" id="LN2077">2077</td><td class="line">        <span class='keyword'>for</span> (j = 0, curr = sigalg_lookup_tbl; j &lt; <span class='macro'>OSSL_NELEM(sigalg_lookup_tbl)<span class='macro_popup'>(sizeof(sigalg_lookup_tbl)/sizeof((sigalg_lookup_tbl)[0]))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2078"><td class="num" id="LN2078">2078</td><td class="line">             j++, curr++) {</td></tr>
<tr class="codeline" data-linenumber="2079"><td class="num" id="LN2079">2079</td><td class="line">            <span class='keyword'>if</span> (curr-&gt;hash == md_id &amp;&amp; curr-&gt;sig == sig_id) {</td></tr>
<tr class="codeline" data-linenumber="2080"><td class="num" id="LN2080">2080</td><td class="line">                *sptr++ = curr-&gt;sigalg;</td></tr>
<tr class="codeline" data-linenumber="2081"><td class="num" id="LN2081">2081</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2082"><td class="num" id="LN2082">2082</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2083"><td class="num" id="LN2083">2083</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2084"><td class="num" id="LN2084">2084</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2085"><td class="num" id="LN2085">2085</td><td class="line">        <span class='keyword'>if</span> (j == <span class='macro'>OSSL_NELEM(sigalg_lookup_tbl)<span class='macro_popup'>(sizeof(sigalg_lookup_tbl)/sizeof((sigalg_lookup_tbl)[0]))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2086"><td class="num" id="LN2086">2086</td><td class="line">            <span class='keyword'>goto</span> err;</td></tr>
<tr class="codeline" data-linenumber="2087"><td class="num" id="LN2087">2087</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2088"><td class="num" id="LN2088">2088</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2089"><td class="num" id="LN2089">2089</td><td class="line">    <span class='keyword'>if</span> (client) {</td></tr>
<tr class="codeline" data-linenumber="2090"><td class="num" id="LN2090">2090</td><td class="line">        <span class='macro'>OPENSSL_free(c-&gt;client_sigalgs)<span class='macro_popup'>CRYPTO_free(c-&gt;client_sigalgs, "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 2090)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2091"><td class="num" id="LN2091">2091</td><td class="line">        c-&gt;client_sigalgs = sigalgs;</td></tr>
<tr class="codeline" data-linenumber="2092"><td class="num" id="LN2092">2092</td><td class="line">        c-&gt;client_sigalgslen = salglen / 2;</td></tr>
<tr class="codeline" data-linenumber="2093"><td class="num" id="LN2093">2093</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2094"><td class="num" id="LN2094">2094</td><td class="line">        <span class='macro'>OPENSSL_free(c-&gt;conf_sigalgs)<span class='macro_popup'>CRYPTO_free(c-&gt;conf_sigalgs, "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 2094)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2095"><td class="num" id="LN2095">2095</td><td class="line">        c-&gt;conf_sigalgs = sigalgs;</td></tr>
<tr class="codeline" data-linenumber="2096"><td class="num" id="LN2096">2096</td><td class="line">        c-&gt;conf_sigalgslen = salglen / 2;</td></tr>
<tr class="codeline" data-linenumber="2097"><td class="num" id="LN2097">2097</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2098"><td class="num" id="LN2098">2098</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2099"><td class="num" id="LN2099">2099</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2100"><td class="num" id="LN2100">2100</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2101"><td class="num" id="LN2101">2101</td><td class="line"> err:</td></tr>
<tr class="codeline" data-linenumber="2102"><td class="num" id="LN2102">2102</td><td class="line">    <span class='macro'>OPENSSL_free(sigalgs)<span class='macro_popup'>CRYPTO_free(sigalgs, "../deps/openssl/openssl/ssl/t1_lib.c", 2102<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2103"><td class="num" id="LN2103">2103</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2104"><td class="num" id="LN2104">2104</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2105"><td class="num" id="LN2105">2105</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2106"><td class="num" id="LN2106">2106</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls1_check_sig_alg(SSL *s, X509 *x, <span class='keyword'>int</span> default_nid)</td></tr>
<tr class="codeline" data-linenumber="2107"><td class="num" id="LN2107">2107</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2108"><td class="num" id="LN2108">2108</td><td class="line">    <span class='keyword'>int</span> sig_nid, use_pc_sigalgs = 0;</td></tr>
<tr class="codeline" data-linenumber="2109"><td class="num" id="LN2109">2109</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="2110"><td class="num" id="LN2110">2110</td><td class="line">    <span class='keyword'>const</span> SIGALG_LOOKUP *sigalg;</td></tr>
<tr class="codeline" data-linenumber="2111"><td class="num" id="LN2111">2111</td><td class="line">    size_t sigalgslen;</td></tr>
<tr class="codeline" data-linenumber="2112"><td class="num" id="LN2112">2112</td><td class="line">    <span class='keyword'>if</span> (default_nid == -1)</td></tr>
<tr class="codeline" data-linenumber="2113"><td class="num" id="LN2113">2113</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2114"><td class="num" id="LN2114">2114</td><td class="line">    sig_nid = X509_get_signature_nid(x);</td></tr>
<tr class="codeline" data-linenumber="2115"><td class="num" id="LN2115">2115</td><td class="line">    <span class='keyword'>if</span> (default_nid)</td></tr>
<tr class="codeline" data-linenumber="2116"><td class="num" id="LN2116">2116</td><td class="line">        <span class='keyword'>return</span> sig_nid == default_nid ? 1 : 0;</td></tr>
<tr class="codeline" data-linenumber="2117"><td class="num" id="LN2117">2117</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2118"><td class="num" id="LN2118">2118</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>SSL_IS_TLS13(s)<span class='macro_popup'>(!(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8) &amp;&amp;<br> (s)-&gt;method-&gt;version &gt;= 0x0304 &amp;&amp; (s)-&gt;method<br>-&gt;version != 0x10000)</span></span> &amp;&amp; s-&gt;s3-&gt;tmp.peer_cert_sigalgs != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2119"><td class="num" id="LN2119">2119</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2120"><td class="num" id="LN2120">2120</td><td class="line">         <span class='comment'>* If we're in TLSv1.3 then we only get here if we're checking the</span></td></tr>
<tr class="codeline" data-linenumber="2121"><td class="num" id="LN2121">2121</td><td class="line">         <span class='comment'>* chain. If the peer has specified peer_cert_sigalgs then we use them</span></td></tr>
<tr class="codeline" data-linenumber="2122"><td class="num" id="LN2122">2122</td><td class="line">         <span class='comment'>* otherwise we default to normal sigalgs.</span></td></tr>
<tr class="codeline" data-linenumber="2123"><td class="num" id="LN2123">2123</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2124"><td class="num" id="LN2124">2124</td><td class="line">        sigalgslen = s-&gt;s3-&gt;tmp.peer_cert_sigalgslen;</td></tr>
<tr class="codeline" data-linenumber="2125"><td class="num" id="LN2125">2125</td><td class="line">        use_pc_sigalgs = 1;</td></tr>
<tr class="codeline" data-linenumber="2126"><td class="num" id="LN2126">2126</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2127"><td class="num" id="LN2127">2127</td><td class="line">        sigalgslen = s-&gt;shared_sigalgslen;</td></tr>
<tr class="codeline" data-linenumber="2128"><td class="num" id="LN2128">2128</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2129"><td class="num" id="LN2129">2129</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; sigalgslen; i++) {</td></tr>
<tr class="codeline" data-linenumber="2130"><td class="num" id="LN2130">2130</td><td class="line">        sigalg = use_pc_sigalgs</td></tr>
<tr class="codeline" data-linenumber="2131"><td class="num" id="LN2131">2131</td><td class="line">                 ? tls1_lookup_sigalg(s-&gt;s3-&gt;tmp.peer_cert_sigalgs[i])</td></tr>
<tr class="codeline" data-linenumber="2132"><td class="num" id="LN2132">2132</td><td class="line">                 : s-&gt;shared_sigalgs[i];</td></tr>
<tr class="codeline" data-linenumber="2133"><td class="num" id="LN2133">2133</td><td class="line">        <span class='keyword'>if</span> (sigalg != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; sig_nid == sigalg-&gt;sigandhash)</td></tr>
<tr class="codeline" data-linenumber="2134"><td class="num" id="LN2134">2134</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2135"><td class="num" id="LN2135">2135</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2136"><td class="num" id="LN2136">2136</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2137"><td class="num" id="LN2137">2137</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2138"><td class="num" id="LN2138">2138</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2139"><td class="num" id="LN2139">2139</td><td class="line"><span class='comment'>/* Check to see if a certificate issuer name matches list of CA names */</span></td></tr>
<tr class="codeline" data-linenumber="2140"><td class="num" id="LN2140">2140</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> ssl_check_ca_name(<span class='macro'>STACK_OF(X509_NAME)<span class='macro_popup'>struct stack_st_X509_NAME</span></span> *names, X509 *x)</td></tr>
<tr class="codeline" data-linenumber="2141"><td class="num" id="LN2141">2141</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2142"><td class="num" id="LN2142">2142</td><td class="line">    X509_NAME *nm;</td></tr>
<tr class="codeline" data-linenumber="2143"><td class="num" id="LN2143">2143</td><td class="line">    <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="2144"><td class="num" id="LN2144">2144</td><td class="line">    nm = X509_get_issuer_name(x);</td></tr>
<tr class="codeline" data-linenumber="2145"><td class="num" id="LN2145">2145</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; sk_X509_NAME_num(names); i++) {</td></tr>
<tr class="codeline" data-linenumber="2146"><td class="num" id="LN2146">2146</td><td class="line">        <span class='keyword'>if</span> (!X509_NAME_cmp(nm, sk_X509_NAME_value(names, i)))</td></tr>
<tr class="codeline" data-linenumber="2147"><td class="num" id="LN2147">2147</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2148"><td class="num" id="LN2148">2148</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2149"><td class="num" id="LN2149">2149</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2150"><td class="num" id="LN2150">2150</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2151"><td class="num" id="LN2151">2151</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2152"><td class="num" id="LN2152">2152</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2153"><td class="num" id="LN2153">2153</td><td class="line"> <span class='comment'>* Check certificate chain is consistent with TLS extensions and is usable by</span></td></tr>
<tr class="codeline" data-linenumber="2154"><td class="num" id="LN2154">2154</td><td class="line"> <span class='comment'>* server. This servers two purposes: it allows users to check chains before</span></td></tr>
<tr class="codeline" data-linenumber="2155"><td class="num" id="LN2155">2155</td><td class="line"> <span class='comment'>* passing them to the server and it allows the server to check chains before</span></td></tr>
<tr class="codeline" data-linenumber="2156"><td class="num" id="LN2156">2156</td><td class="line"> <span class='comment'>* attempting to use them.</span></td></tr>
<tr class="codeline" data-linenumber="2157"><td class="num" id="LN2157">2157</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2158"><td class="num" id="LN2158">2158</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2159"><td class="num" id="LN2159">2159</td><td class="line"><span class='comment'>/* Flags which need to be set for a certificate when strict mode not set */</span></td></tr>
<tr class="codeline" data-linenumber="2160"><td class="num" id="LN2160">2160</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2161"><td class="num" id="LN2161">2161</td><td class="line"><span class='directive'>#define <span class='macro'>CERT_PKEY_VALID_FLAGS<span class='macro_popup'>(0x10|0x40)</span></span> \</span></td></tr>
<tr class="codeline" data-linenumber="2162"><td class="num" id="LN2162">2162</td><td class="line">        <span class='directive'>(<span class='macro'>CERT_PKEY_EE_SIGNATURE<span class='macro_popup'>0x10</span></span>|<span class='macro'>CERT_PKEY_EE_PARAM<span class='macro_popup'>0x40</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="2163"><td class="num" id="LN2163">2163</td><td class="line"><span class='comment'>/* Strict mode flags */</span></td></tr>
<tr class="codeline" data-linenumber="2164"><td class="num" id="LN2164">2164</td><td class="line"><span class='directive'>#define <span class='macro'>CERT_PKEY_STRICT_FLAGS<span class='macro_popup'>((0x10|0x40)|0x20|0x80 | 0x200|0x400)</span></span> \</span></td></tr>
<tr class="codeline" data-linenumber="2165"><td class="num" id="LN2165">2165</td><td class="line">         <span class='directive'>(<span class='macro'>CERT_PKEY_VALID_FLAGS<span class='macro_popup'>(0x10|0x40)</span></span>|<span class='macro'>CERT_PKEY_CA_SIGNATURE<span class='macro_popup'>0x20</span></span>|<span class='macro'>CERT_PKEY_CA_PARAM<span class='macro_popup'>0x80</span></span> \</span></td></tr>
<tr class="codeline" data-linenumber="2166"><td class="num" id="LN2166">2166</td><td class="line">         <span class='directive'>| <span class='macro'>CERT_PKEY_ISSUER_NAME<span class='macro_popup'>0x200</span></span>|<span class='macro'>CERT_PKEY_CERT_TYPE<span class='macro_popup'>0x400</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="2167"><td class="num" id="LN2167">2167</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2168"><td class="num" id="LN2168">2168</td><td class="line"><span class='keyword'>int</span> tls1_check_chain(SSL *s, X509 *x, EVP_PKEY *pk, <span class='macro'>STACK_OF(X509)<span class='macro_popup'>struct stack_st_X509</span></span> *chain,</td></tr>
<tr class="codeline" data-linenumber="2169"><td class="num" id="LN2169">2169</td><td class="line">                     <span class='keyword'>int</span> idx)</td></tr>
<tr class="codeline" data-linenumber="2170"><td class="num" id="LN2170">2170</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2171"><td class="num" id="LN2171">2171</td><td class="line">    <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="2172"><td class="num" id="LN2172">2172</td><td class="line">    <span class='keyword'>int</span> rv = 0;</td></tr>
<tr class="codeline" data-linenumber="2173"><td class="num" id="LN2173">2173</td><td class="line">    <span class='keyword'>int</span> check_flags = 0, strict_mode;</td></tr>
<tr class="codeline" data-linenumber="2174"><td class="num" id="LN2174">2174</td><td class="line">    CERT_PKEY *cpk = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2175"><td class="num" id="LN2175">2175</td><td class="line">    CERT *c = s-&gt;cert;</td></tr>
<tr class="codeline" data-linenumber="2176"><td class="num" id="LN2176">2176</td><td class="line">    uint32_t *pvalid;</td></tr>
<tr class="codeline" data-linenumber="2177"><td class="num" id="LN2177">2177</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> suiteb_flags = <span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2178"><td class="num" id="LN2178">2178</td><td class="line">    <span class='comment'>/* idx == -1 means checking server chains */</span></td></tr>
<tr class="codeline" data-linenumber="2179"><td class="num" id="LN2179">2179</td><td class="line">    <span class='keyword'>if</span> (idx != -1) {</td></tr>
<tr class="codeline" data-linenumber="2180"><td class="num" id="LN2180">2180</td><td class="line">        <span class='comment'>/* idx == -2 means checking client certificate chains */</span></td></tr>
<tr class="codeline" data-linenumber="2181"><td class="num" id="LN2181">2181</td><td class="line">        <span class='keyword'>if</span> (idx == -2) {</td></tr>
<tr class="codeline" data-linenumber="2182"><td class="num" id="LN2182">2182</td><td class="line">            cpk = c-&gt;key;</td></tr>
<tr class="codeline" data-linenumber="2183"><td class="num" id="LN2183">2183</td><td class="line">            idx = (<span class='keyword'>int</span>)(cpk - c-&gt;pkeys);</td></tr>
<tr class="codeline" data-linenumber="2184"><td class="num" id="LN2184">2184</td><td class="line">        } <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2185"><td class="num" id="LN2185">2185</td><td class="line">            cpk = c-&gt;pkeys + idx;</td></tr>
<tr class="codeline" data-linenumber="2186"><td class="num" id="LN2186">2186</td><td class="line">        pvalid = s-&gt;s3-&gt;tmp.valid_flags + idx;</td></tr>
<tr class="codeline" data-linenumber="2187"><td class="num" id="LN2187">2187</td><td class="line">        x = cpk-&gt;x509;</td></tr>
<tr class="codeline" data-linenumber="2188"><td class="num" id="LN2188">2188</td><td class="line">        pk = cpk-&gt;privatekey;</td></tr>
<tr class="codeline" data-linenumber="2189"><td class="num" id="LN2189">2189</td><td class="line">        chain = cpk-&gt;chain;</td></tr>
<tr class="codeline" data-linenumber="2190"><td class="num" id="LN2190">2190</td><td class="line">        strict_mode = c-&gt;cert_flags &amp; <span class='macro'>SSL_CERT_FLAGS_CHECK_TLS_STRICT<span class='macro_popup'>(0x30000|0x00000001U)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2191"><td class="num" id="LN2191">2191</td><td class="line">        <span class='comment'>/* If no cert or key, forget it */</span></td></tr>
<tr class="codeline" data-linenumber="2192"><td class="num" id="LN2192">2192</td><td class="line">        <span class='keyword'>if</span> (!x || !pk)</td></tr>
<tr class="codeline" data-linenumber="2193"><td class="num" id="LN2193">2193</td><td class="line">            <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="2194"><td class="num" id="LN2194">2194</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2195"><td class="num" id="LN2195">2195</td><td class="line">        size_t certidx;</td></tr>
<tr class="codeline" data-linenumber="2196"><td class="num" id="LN2196">2196</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2197"><td class="num" id="LN2197">2197</td><td class="line">        <span class='keyword'>if</span> (!x || !pk)</td></tr>
<tr class="codeline" data-linenumber="2198"><td class="num" id="LN2198">2198</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2199"><td class="num" id="LN2199">2199</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2200"><td class="num" id="LN2200">2200</td><td class="line">        <span class='keyword'>if</span> (ssl_cert_lookup_by_pkey(pk, &amp;certidx) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2201"><td class="num" id="LN2201">2201</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2202"><td class="num" id="LN2202">2202</td><td class="line">        idx = certidx;</td></tr>
<tr class="codeline" data-linenumber="2203"><td class="num" id="LN2203">2203</td><td class="line">        pvalid = s-&gt;s3-&gt;tmp.valid_flags + idx;</td></tr>
<tr class="codeline" data-linenumber="2204"><td class="num" id="LN2204">2204</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2205"><td class="num" id="LN2205">2205</td><td class="line">        <span class='keyword'>if</span> (c-&gt;cert_flags &amp; <span class='macro'>SSL_CERT_FLAGS_CHECK_TLS_STRICT<span class='macro_popup'>(0x30000|0x00000001U)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2206"><td class="num" id="LN2206">2206</td><td class="line">            check_flags = <span class='macro'>CERT_PKEY_STRICT_FLAGS<span class='macro_popup'>((0x10|0x40)|0x20|0x80 | 0x200|0x400)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2207"><td class="num" id="LN2207">2207</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2208"><td class="num" id="LN2208">2208</td><td class="line">            check_flags = <span class='macro'>CERT_PKEY_VALID_FLAGS<span class='macro_popup'>(0x10|0x40)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2209"><td class="num" id="LN2209">2209</td><td class="line">        strict_mode = 1;</td></tr>
<tr class="codeline" data-linenumber="2210"><td class="num" id="LN2210">2210</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2211"><td class="num" id="LN2211">2211</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2212"><td class="num" id="LN2212">2212</td><td class="line">    <span class='keyword'>if</span> (suiteb_flags) {</td></tr>
<tr class="codeline" data-linenumber="2213"><td class="num" id="LN2213">2213</td><td class="line">        <span class='keyword'>int</span> ok;</td></tr>
<tr class="codeline" data-linenumber="2214"><td class="num" id="LN2214">2214</td><td class="line">        <span class='keyword'>if</span> (check_flags)</td></tr>
<tr class="codeline" data-linenumber="2215"><td class="num" id="LN2215">2215</td><td class="line">            check_flags |= <span class='macro'>CERT_PKEY_SUITEB<span class='macro_popup'>0x800</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2216"><td class="num" id="LN2216">2216</td><td class="line">        ok = X509_chain_check_suiteb(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, x, chain, suiteb_flags);</td></tr>
<tr class="codeline" data-linenumber="2217"><td class="num" id="LN2217">2217</td><td class="line">        <span class='keyword'>if</span> (ok == <span class='macro'>X509_V_OK<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2218"><td class="num" id="LN2218">2218</td><td class="line">            rv |= <span class='macro'>CERT_PKEY_SUITEB<span class='macro_popup'>0x800</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2219"><td class="num" id="LN2219">2219</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (!check_flags)</td></tr>
<tr class="codeline" data-linenumber="2220"><td class="num" id="LN2220">2220</td><td class="line">            <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="2221"><td class="num" id="LN2221">2221</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2222"><td class="num" id="LN2222">2222</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2223"><td class="num" id="LN2223">2223</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2224"><td class="num" id="LN2224">2224</td><td class="line">     <span class='comment'>* Check all signature algorithms are consistent with signature</span></td></tr>
<tr class="codeline" data-linenumber="2225"><td class="num" id="LN2225">2225</td><td class="line">     <span class='comment'>* algorithms extension if TLS 1.2 or later and strict mode.</span></td></tr>
<tr class="codeline" data-linenumber="2226"><td class="num" id="LN2226">2226</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2227"><td class="num" id="LN2227">2227</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>TLS1_get_version(s)<span class='macro_popup'>((SSL_version(s) &gt;&gt; 8) == 0x03 ? SSL_version(s) : 0)</span></span> &gt;= <span class='macro'>TLS1_2_VERSION<span class='macro_popup'>0x0303</span></span> &amp;&amp; strict_mode) {</td></tr>
<tr class="codeline" data-linenumber="2228"><td class="num" id="LN2228">2228</td><td class="line">        <span class='keyword'>int</span> default_nid;</td></tr>
<tr class="codeline" data-linenumber="2229"><td class="num" id="LN2229">2229</td><td class="line">        <span class='keyword'>int</span> rsign = 0;</td></tr>
<tr class="codeline" data-linenumber="2230"><td class="num" id="LN2230">2230</td><td class="line">        <span class='keyword'>if</span> (s-&gt;s3-&gt;tmp.peer_cert_sigalgs != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="2231"><td class="num" id="LN2231">2231</td><td class="line">                || s-&gt;s3-&gt;tmp.peer_sigalgs != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2232"><td class="num" id="LN2232">2232</td><td class="line">            default_nid = 0;</td></tr>
<tr class="codeline" data-linenumber="2233"><td class="num" id="LN2233">2233</td><td class="line">        <span class='comment'>/* If no sigalgs extension use defaults from RFC5246 */</span></td></tr>
<tr class="codeline" data-linenumber="2234"><td class="num" id="LN2234">2234</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2235"><td class="num" id="LN2235">2235</td><td class="line">            <span class='keyword'>switch</span> (idx) {</td></tr>
<tr class="codeline" data-linenumber="2236"><td class="num" id="LN2236">2236</td><td class="line">            <span class='keyword'>case</span> <span class='macro'>SSL_PKEY_RSA<span class='macro_popup'>0</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2237"><td class="num" id="LN2237">2237</td><td class="line">                rsign = <span class='macro'>EVP_PKEY_RSA<span class='macro_popup'>6</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2238"><td class="num" id="LN2238">2238</td><td class="line">                default_nid = <span class='macro'>NID_sha1WithRSAEncryption<span class='macro_popup'>65</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2239"><td class="num" id="LN2239">2239</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2240"><td class="num" id="LN2240">2240</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2241"><td class="num" id="LN2241">2241</td><td class="line">            <span class='keyword'>case</span> <span class='macro'>SSL_PKEY_DSA_SIGN<span class='macro_popup'>2</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2242"><td class="num" id="LN2242">2242</td><td class="line">                rsign = <span class='macro'>EVP_PKEY_DSA<span class='macro_popup'>116</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2243"><td class="num" id="LN2243">2243</td><td class="line">                default_nid = <span class='macro'>NID_dsaWithSHA1<span class='macro_popup'>113</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2244"><td class="num" id="LN2244">2244</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2245"><td class="num" id="LN2245">2245</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2246"><td class="num" id="LN2246">2246</td><td class="line">            <span class='keyword'>case</span> <span class='macro'>SSL_PKEY_ECC<span class='macro_popup'>3</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2247"><td class="num" id="LN2247">2247</td><td class="line">                rsign = <span class='macro'>EVP_PKEY_EC<span class='macro_popup'>408</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2248"><td class="num" id="LN2248">2248</td><td class="line">                default_nid = <span class='macro'>NID_ecdsa_with_SHA1<span class='macro_popup'>416</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2249"><td class="num" id="LN2249">2249</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2250"><td class="num" id="LN2250">2250</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2251"><td class="num" id="LN2251">2251</td><td class="line">            <span class='keyword'>case</span> <span class='macro'>SSL_PKEY_GOST01<span class='macro_popup'>4</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2252"><td class="num" id="LN2252">2252</td><td class="line">                rsign = <span class='macro'>NID_id_GostR3410_2001<span class='macro_popup'>811</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2253"><td class="num" id="LN2253">2253</td><td class="line">                default_nid = <span class='macro'>NID_id_GostR3411_94_with_GostR3410_2001<span class='macro_popup'>807</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2254"><td class="num" id="LN2254">2254</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2255"><td class="num" id="LN2255">2255</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2256"><td class="num" id="LN2256">2256</td><td class="line">            <span class='keyword'>case</span> <span class='macro'>SSL_PKEY_GOST12_256<span class='macro_popup'>5</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2257"><td class="num" id="LN2257">2257</td><td class="line">                rsign = <span class='macro'>NID_id_GostR3410_2012_256<span class='macro_popup'>979</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2258"><td class="num" id="LN2258">2258</td><td class="line">                default_nid = <span class='macro'>NID_id_tc26_signwithdigest_gost3410_2012_256<span class='macro_popup'>985</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2259"><td class="num" id="LN2259">2259</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2260"><td class="num" id="LN2260">2260</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2261"><td class="num" id="LN2261">2261</td><td class="line">            <span class='keyword'>case</span> <span class='macro'>SSL_PKEY_GOST12_512<span class='macro_popup'>6</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2262"><td class="num" id="LN2262">2262</td><td class="line">                rsign = <span class='macro'>NID_id_GostR3410_2012_512<span class='macro_popup'>980</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2263"><td class="num" id="LN2263">2263</td><td class="line">                default_nid = <span class='macro'>NID_id_tc26_signwithdigest_gost3410_2012_512<span class='macro_popup'>986</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2264"><td class="num" id="LN2264">2264</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2265"><td class="num" id="LN2265">2265</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2266"><td class="num" id="LN2266">2266</td><td class="line">            <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="2267"><td class="num" id="LN2267">2267</td><td class="line">                default_nid = -1;</td></tr>
<tr class="codeline" data-linenumber="2268"><td class="num" id="LN2268">2268</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2269"><td class="num" id="LN2269">2269</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2270"><td class="num" id="LN2270">2270</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2271"><td class="num" id="LN2271">2271</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2272"><td class="num" id="LN2272">2272</td><td class="line">         <span class='comment'>* If peer sent no signature algorithms extension and we have set</span></td></tr>
<tr class="codeline" data-linenumber="2273"><td class="num" id="LN2273">2273</td><td class="line">         <span class='comment'>* preferred signature algorithms check we support sha1.</span></td></tr>
<tr class="codeline" data-linenumber="2274"><td class="num" id="LN2274">2274</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2275"><td class="num" id="LN2275">2275</td><td class="line">        <span class='keyword'>if</span> (default_nid &gt; 0 &amp;&amp; c-&gt;conf_sigalgs) {</td></tr>
<tr class="codeline" data-linenumber="2276"><td class="num" id="LN2276">2276</td><td class="line">            size_t j;</td></tr>
<tr class="codeline" data-linenumber="2277"><td class="num" id="LN2277">2277</td><td class="line">            <span class='keyword'>const</span> uint16_t *p = c-&gt;conf_sigalgs;</td></tr>
<tr class="codeline" data-linenumber="2278"><td class="num" id="LN2278">2278</td><td class="line">            <span class='keyword'>for</span> (j = 0; j &lt; c-&gt;conf_sigalgslen; j++, p++) {</td></tr>
<tr class="codeline" data-linenumber="2279"><td class="num" id="LN2279">2279</td><td class="line">                <span class='keyword'>const</span> SIGALG_LOOKUP *lu = tls1_lookup_sigalg(*p);</td></tr>
<tr class="codeline" data-linenumber="2280"><td class="num" id="LN2280">2280</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2281"><td class="num" id="LN2281">2281</td><td class="line">                <span class='keyword'>if</span> (lu != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; lu-&gt;hash == <span class='macro'>NID_sha1<span class='macro_popup'>64</span></span> &amp;&amp; lu-&gt;sig == rsign)</td></tr>
<tr class="codeline" data-linenumber="2282"><td class="num" id="LN2282">2282</td><td class="line">                    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2283"><td class="num" id="LN2283">2283</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2284"><td class="num" id="LN2284">2284</td><td class="line">            <span class='keyword'>if</span> (j == c-&gt;conf_sigalgslen) {</td></tr>
<tr class="codeline" data-linenumber="2285"><td class="num" id="LN2285">2285</td><td class="line">                <span class='keyword'>if</span> (check_flags)</td></tr>
<tr class="codeline" data-linenumber="2286"><td class="num" id="LN2286">2286</td><td class="line">                    <span class='keyword'>goto</span> skip_sigs;</td></tr>
<tr class="codeline" data-linenumber="2287"><td class="num" id="LN2287">2287</td><td class="line">                <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2288"><td class="num" id="LN2288">2288</td><td class="line">                    <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="2289"><td class="num" id="LN2289">2289</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2290"><td class="num" id="LN2290">2290</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2291"><td class="num" id="LN2291">2291</td><td class="line">        <span class='comment'>/* Check signature algorithm of each cert in chain */</span></td></tr>
<tr class="codeline" data-linenumber="2292"><td class="num" id="LN2292">2292</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>SSL_IS_TLS13(s)<span class='macro_popup'>(!(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8) &amp;&amp;<br> (s)-&gt;method-&gt;version &gt;= 0x0304 &amp;&amp; (s)-&gt;method<br>-&gt;version != 0x10000)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2293"><td class="num" id="LN2293">2293</td><td class="line">            <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2294"><td class="num" id="LN2294">2294</td><td class="line">             <span class='comment'>* We only get here if the application has called SSL_check_chain(),</span></td></tr>
<tr class="codeline" data-linenumber="2295"><td class="num" id="LN2295">2295</td><td class="line">             <span class='comment'>* so check_flags is always set.</span></td></tr>
<tr class="codeline" data-linenumber="2296"><td class="num" id="LN2296">2296</td><td class="line">             <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2297"><td class="num" id="LN2297">2297</td><td class="line">            <span class='keyword'>if</span> (find_sig_alg(s, x, pk) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2298"><td class="num" id="LN2298">2298</td><td class="line">                rv |= <span class='macro'>CERT_PKEY_EE_SIGNATURE<span class='macro_popup'>0x10</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2299"><td class="num" id="LN2299">2299</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!tls1_check_sig_alg(s, x, default_nid)) {</td></tr>
<tr class="codeline" data-linenumber="2300"><td class="num" id="LN2300">2300</td><td class="line">            <span class='keyword'>if</span> (!check_flags)</td></tr>
<tr class="codeline" data-linenumber="2301"><td class="num" id="LN2301">2301</td><td class="line">                <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="2302"><td class="num" id="LN2302">2302</td><td class="line">        } <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2303"><td class="num" id="LN2303">2303</td><td class="line">            rv |= <span class='macro'>CERT_PKEY_EE_SIGNATURE<span class='macro_popup'>0x10</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2304"><td class="num" id="LN2304">2304</td><td class="line">        rv |= <span class='macro'>CERT_PKEY_CA_SIGNATURE<span class='macro_popup'>0x20</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2305"><td class="num" id="LN2305">2305</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; sk_X509_num(chain); i++) {</td></tr>
<tr class="codeline" data-linenumber="2306"><td class="num" id="LN2306">2306</td><td class="line">            <span class='keyword'>if</span> (!tls1_check_sig_alg(s, sk_X509_value(chain, i), default_nid)) {</td></tr>
<tr class="codeline" data-linenumber="2307"><td class="num" id="LN2307">2307</td><td class="line">                <span class='keyword'>if</span> (check_flags) {</td></tr>
<tr class="codeline" data-linenumber="2308"><td class="num" id="LN2308">2308</td><td class="line">                    rv &amp;= ~<span class='macro'>CERT_PKEY_CA_SIGNATURE<span class='macro_popup'>0x20</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2309"><td class="num" id="LN2309">2309</td><td class="line">                    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2310"><td class="num" id="LN2310">2310</td><td class="line">                } <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2311"><td class="num" id="LN2311">2311</td><td class="line">                    <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="2312"><td class="num" id="LN2312">2312</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2313"><td class="num" id="LN2313">2313</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2314"><td class="num" id="LN2314">2314</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2315"><td class="num" id="LN2315">2315</td><td class="line">    <span class='comment'>/* Else not TLS 1.2, so mark EE and CA signing algorithms OK */</span></td></tr>
<tr class="codeline" data-linenumber="2316"><td class="num" id="LN2316">2316</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (check_flags)</td></tr>
<tr class="codeline" data-linenumber="2317"><td class="num" id="LN2317">2317</td><td class="line">        rv |= <span class='macro'>CERT_PKEY_EE_SIGNATURE<span class='macro_popup'>0x10</span></span> | <span class='macro'>CERT_PKEY_CA_SIGNATURE<span class='macro_popup'>0x20</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2318"><td class="num" id="LN2318">2318</td><td class="line"> skip_sigs:</td></tr>
<tr class="codeline" data-linenumber="2319"><td class="num" id="LN2319">2319</td><td class="line">    <span class='comment'>/* Check cert parameters are consistent */</span></td></tr>
<tr class="codeline" data-linenumber="2320"><td class="num" id="LN2320">2320</td><td class="line">    <span class='keyword'>if</span> (tls1_check_cert_param(s, x, 1))</td></tr>
<tr class="codeline" data-linenumber="2321"><td class="num" id="LN2321">2321</td><td class="line">        rv |= <span class='macro'>CERT_PKEY_EE_PARAM<span class='macro_popup'>0x40</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2322"><td class="num" id="LN2322">2322</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (!check_flags)</td></tr>
<tr class="codeline" data-linenumber="2323"><td class="num" id="LN2323">2323</td><td class="line">        <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="2324"><td class="num" id="LN2324">2324</td><td class="line">    <span class='keyword'>if</span> (!s-&gt;server)</td></tr>
<tr class="codeline" data-linenumber="2325"><td class="num" id="LN2325">2325</td><td class="line">        rv |= <span class='macro'>CERT_PKEY_CA_PARAM<span class='macro_popup'>0x80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2326"><td class="num" id="LN2326">2326</td><td class="line">    <span class='comment'>/* In strict mode check rest of chain too */</span></td></tr>
<tr class="codeline" data-linenumber="2327"><td class="num" id="LN2327">2327</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (strict_mode) {</td></tr>
<tr class="codeline" data-linenumber="2328"><td class="num" id="LN2328">2328</td><td class="line">        rv |= <span class='macro'>CERT_PKEY_CA_PARAM<span class='macro_popup'>0x80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2329"><td class="num" id="LN2329">2329</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; sk_X509_num(chain); i++) {</td></tr>
<tr class="codeline" data-linenumber="2330"><td class="num" id="LN2330">2330</td><td class="line">            X509 *ca = sk_X509_value(chain, i);</td></tr>
<tr class="codeline" data-linenumber="2331"><td class="num" id="LN2331">2331</td><td class="line">            <span class='keyword'>if</span> (!tls1_check_cert_param(s, ca, 0)) {</td></tr>
<tr class="codeline" data-linenumber="2332"><td class="num" id="LN2332">2332</td><td class="line">                <span class='keyword'>if</span> (check_flags) {</td></tr>
<tr class="codeline" data-linenumber="2333"><td class="num" id="LN2333">2333</td><td class="line">                    rv &amp;= ~<span class='macro'>CERT_PKEY_CA_PARAM<span class='macro_popup'>0x80</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2334"><td class="num" id="LN2334">2334</td><td class="line">                    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2335"><td class="num" id="LN2335">2335</td><td class="line">                } <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2336"><td class="num" id="LN2336">2336</td><td class="line">                    <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="2337"><td class="num" id="LN2337">2337</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2338"><td class="num" id="LN2338">2338</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2339"><td class="num" id="LN2339">2339</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2340"><td class="num" id="LN2340">2340</td><td class="line">    <span class='keyword'>if</span> (!s-&gt;server &amp;&amp; strict_mode) {</td></tr>
<tr class="codeline" data-linenumber="2341"><td class="num" id="LN2341">2341</td><td class="line">        <span class='macro'>STACK_OF(X509_NAME)<span class='macro_popup'>struct stack_st_X509_NAME</span></span> *ca_dn;</td></tr>
<tr class="codeline" data-linenumber="2342"><td class="num" id="LN2342">2342</td><td class="line">        <span class='keyword'>int</span> check_type = 0;</td></tr>
<tr class="codeline" data-linenumber="2343"><td class="num" id="LN2343">2343</td><td class="line">        <span class='keyword'>switch</span> (EVP_PKEY_id(pk)) {</td></tr>
<tr class="codeline" data-linenumber="2344"><td class="num" id="LN2344">2344</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>EVP_PKEY_RSA<span class='macro_popup'>6</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2345"><td class="num" id="LN2345">2345</td><td class="line">            check_type = <span class='macro'>TLS_CT_RSA_SIGN<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2346"><td class="num" id="LN2346">2346</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2347"><td class="num" id="LN2347">2347</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>EVP_PKEY_DSA<span class='macro_popup'>116</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2348"><td class="num" id="LN2348">2348</td><td class="line">            check_type = <span class='macro'>TLS_CT_DSS_SIGN<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2349"><td class="num" id="LN2349">2349</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2350"><td class="num" id="LN2350">2350</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>EVP_PKEY_EC<span class='macro_popup'>408</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2351"><td class="num" id="LN2351">2351</td><td class="line">            check_type = <span class='macro'>TLS_CT_ECDSA_SIGN<span class='macro_popup'>64</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2352"><td class="num" id="LN2352">2352</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2353"><td class="num" id="LN2353">2353</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2354"><td class="num" id="LN2354">2354</td><td class="line">        <span class='keyword'>if</span> (check_type) {</td></tr>
<tr class="codeline" data-linenumber="2355"><td class="num" id="LN2355">2355</td><td class="line">            <span class='keyword'>const</span> uint8_t *ctypes = s-&gt;s3-&gt;tmp.ctype;</td></tr>
<tr class="codeline" data-linenumber="2356"><td class="num" id="LN2356">2356</td><td class="line">            size_t j;</td></tr>
<tr class="codeline" data-linenumber="2357"><td class="num" id="LN2357">2357</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2358"><td class="num" id="LN2358">2358</td><td class="line">            <span class='keyword'>for</span> (j = 0; j &lt; s-&gt;s3-&gt;tmp.ctype_len; j++, ctypes++) {</td></tr>
<tr class="codeline" data-linenumber="2359"><td class="num" id="LN2359">2359</td><td class="line">                <span class='keyword'>if</span> (*ctypes == check_type) {</td></tr>
<tr class="codeline" data-linenumber="2360"><td class="num" id="LN2360">2360</td><td class="line">                    rv |= <span class='macro'>CERT_PKEY_CERT_TYPE<span class='macro_popup'>0x400</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2361"><td class="num" id="LN2361">2361</td><td class="line">                    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2362"><td class="num" id="LN2362">2362</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2363"><td class="num" id="LN2363">2363</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2364"><td class="num" id="LN2364">2364</td><td class="line">            <span class='keyword'>if</span> (!(rv &amp; <span class='macro'>CERT_PKEY_CERT_TYPE<span class='macro_popup'>0x400</span></span>) &amp;&amp; !check_flags)</td></tr>
<tr class="codeline" data-linenumber="2365"><td class="num" id="LN2365">2365</td><td class="line">                <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="2366"><td class="num" id="LN2366">2366</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2367"><td class="num" id="LN2367">2367</td><td class="line">            rv |= <span class='macro'>CERT_PKEY_CERT_TYPE<span class='macro_popup'>0x400</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2368"><td class="num" id="LN2368">2368</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2369"><td class="num" id="LN2369">2369</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2370"><td class="num" id="LN2370">2370</td><td class="line">        ca_dn = s-&gt;s3-&gt;tmp.peer_ca_names;</td></tr>
<tr class="codeline" data-linenumber="2371"><td class="num" id="LN2371">2371</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2372"><td class="num" id="LN2372">2372</td><td class="line">        <span class='keyword'>if</span> (!sk_X509_NAME_num(ca_dn))</td></tr>
<tr class="codeline" data-linenumber="2373"><td class="num" id="LN2373">2373</td><td class="line">            rv |= <span class='macro'>CERT_PKEY_ISSUER_NAME<span class='macro_popup'>0x200</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2374"><td class="num" id="LN2374">2374</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2375"><td class="num" id="LN2375">2375</td><td class="line">        <span class='keyword'>if</span> (!(rv &amp; <span class='macro'>CERT_PKEY_ISSUER_NAME<span class='macro_popup'>0x200</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="2376"><td class="num" id="LN2376">2376</td><td class="line">            <span class='keyword'>if</span> (ssl_check_ca_name(ca_dn, x))</td></tr>
<tr class="codeline" data-linenumber="2377"><td class="num" id="LN2377">2377</td><td class="line">                rv |= <span class='macro'>CERT_PKEY_ISSUER_NAME<span class='macro_popup'>0x200</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2378"><td class="num" id="LN2378">2378</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2379"><td class="num" id="LN2379">2379</td><td class="line">        <span class='keyword'>if</span> (!(rv &amp; <span class='macro'>CERT_PKEY_ISSUER_NAME<span class='macro_popup'>0x200</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="2380"><td class="num" id="LN2380">2380</td><td class="line">            <span class='keyword'>for</span> (i = 0; i &lt; sk_X509_num(chain); i++) {</td></tr>
<tr class="codeline" data-linenumber="2381"><td class="num" id="LN2381">2381</td><td class="line">                X509 *xtmp = sk_X509_value(chain, i);</td></tr>
<tr class="codeline" data-linenumber="2382"><td class="num" id="LN2382">2382</td><td class="line">                <span class='keyword'>if</span> (ssl_check_ca_name(ca_dn, xtmp)) {</td></tr>
<tr class="codeline" data-linenumber="2383"><td class="num" id="LN2383">2383</td><td class="line">                    rv |= <span class='macro'>CERT_PKEY_ISSUER_NAME<span class='macro_popup'>0x200</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2384"><td class="num" id="LN2384">2384</td><td class="line">                    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2385"><td class="num" id="LN2385">2385</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2386"><td class="num" id="LN2386">2386</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2387"><td class="num" id="LN2387">2387</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2388"><td class="num" id="LN2388">2388</td><td class="line">        <span class='keyword'>if</span> (!check_flags &amp;&amp; !(rv &amp; <span class='macro'>CERT_PKEY_ISSUER_NAME<span class='macro_popup'>0x200</span></span>))</td></tr>
<tr class="codeline" data-linenumber="2389"><td class="num" id="LN2389">2389</td><td class="line">            <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="2390"><td class="num" id="LN2390">2390</td><td class="line">    } <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2391"><td class="num" id="LN2391">2391</td><td class="line">        rv |= <span class='macro'>CERT_PKEY_ISSUER_NAME<span class='macro_popup'>0x200</span></span> | <span class='macro'>CERT_PKEY_CERT_TYPE<span class='macro_popup'>0x400</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2392"><td class="num" id="LN2392">2392</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2393"><td class="num" id="LN2393">2393</td><td class="line">    <span class='keyword'>if</span> (!check_flags || (rv &amp; check_flags) == check_flags)</td></tr>
<tr class="codeline" data-linenumber="2394"><td class="num" id="LN2394">2394</td><td class="line">        rv |= <span class='macro'>CERT_PKEY_VALID<span class='macro_popup'>0x1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2395"><td class="num" id="LN2395">2395</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2396"><td class="num" id="LN2396">2396</td><td class="line"> end:</td></tr>
<tr class="codeline" data-linenumber="2397"><td class="num" id="LN2397">2397</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2398"><td class="num" id="LN2398">2398</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>TLS1_get_version(s)<span class='macro_popup'>((SSL_version(s) &gt;&gt; 8) == 0x03 ? SSL_version(s) : 0)</span></span> &gt;= <span class='macro'>TLS1_2_VERSION<span class='macro_popup'>0x0303</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2399"><td class="num" id="LN2399">2399</td><td class="line">        rv |= *pvalid &amp; (<span class='macro'>CERT_PKEY_EXPLICIT_SIGN<span class='macro_popup'>0x100</span></span> | <span class='macro'>CERT_PKEY_SIGN<span class='macro_popup'>0x2</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2400"><td class="num" id="LN2400">2400</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2401"><td class="num" id="LN2401">2401</td><td class="line">        rv |= <span class='macro'>CERT_PKEY_SIGN<span class='macro_popup'>0x2</span></span> | <span class='macro'>CERT_PKEY_EXPLICIT_SIGN<span class='macro_popup'>0x100</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2402"><td class="num" id="LN2402">2402</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2403"><td class="num" id="LN2403">2403</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2404"><td class="num" id="LN2404">2404</td><td class="line">     <span class='comment'>* When checking a CERT_PKEY structure all flags are irrelevant if the</span></td></tr>
<tr class="codeline" data-linenumber="2405"><td class="num" id="LN2405">2405</td><td class="line">     <span class='comment'>* chain is invalid.</span></td></tr>
<tr class="codeline" data-linenumber="2406"><td class="num" id="LN2406">2406</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2407"><td class="num" id="LN2407">2407</td><td class="line">    <span class='keyword'>if</span> (!check_flags) {</td></tr>
<tr class="codeline" data-linenumber="2408"><td class="num" id="LN2408">2408</td><td class="line">        <span class='keyword'>if</span> (rv &amp; <span class='macro'>CERT_PKEY_VALID<span class='macro_popup'>0x1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2409"><td class="num" id="LN2409">2409</td><td class="line">            *pvalid = rv;</td></tr>
<tr class="codeline" data-linenumber="2410"><td class="num" id="LN2410">2410</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2411"><td class="num" id="LN2411">2411</td><td class="line">            <span class='comment'>/* Preserve sign and explicit sign flag, clear rest */</span></td></tr>
<tr class="codeline" data-linenumber="2412"><td class="num" id="LN2412">2412</td><td class="line">            *pvalid &amp;= <span class='macro'>CERT_PKEY_EXPLICIT_SIGN<span class='macro_popup'>0x100</span></span> | <span class='macro'>CERT_PKEY_SIGN<span class='macro_popup'>0x2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2413"><td class="num" id="LN2413">2413</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2414"><td class="num" id="LN2414">2414</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2415"><td class="num" id="LN2415">2415</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2416"><td class="num" id="LN2416">2416</td><td class="line">    <span class='keyword'>return</span> rv;</td></tr>
<tr class="codeline" data-linenumber="2417"><td class="num" id="LN2417">2417</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2418"><td class="num" id="LN2418">2418</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2419"><td class="num" id="LN2419">2419</td><td class="line"><span class='comment'>/* Set validity of certificates in an SSL structure */</span></td></tr>
<tr class="codeline" data-linenumber="2420"><td class="num" id="LN2420">2420</td><td class="line"><span class='keyword'>void</span> tls1_set_cert_validity(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="2421"><td class="num" id="LN2421">2421</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2422"><td class="num" id="LN2422">2422</td><td class="line">    tls1_check_chain(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>SSL_PKEY_RSA<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2423"><td class="num" id="LN2423">2423</td><td class="line">    tls1_check_chain(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>SSL_PKEY_RSA_PSS_SIGN<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2424"><td class="num" id="LN2424">2424</td><td class="line">    tls1_check_chain(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>SSL_PKEY_DSA_SIGN<span class='macro_popup'>2</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2425"><td class="num" id="LN2425">2425</td><td class="line">    tls1_check_chain(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>SSL_PKEY_ECC<span class='macro_popup'>3</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2426"><td class="num" id="LN2426">2426</td><td class="line">    tls1_check_chain(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>SSL_PKEY_GOST01<span class='macro_popup'>4</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2427"><td class="num" id="LN2427">2427</td><td class="line">    tls1_check_chain(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>SSL_PKEY_GOST12_256<span class='macro_popup'>5</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2428"><td class="num" id="LN2428">2428</td><td class="line">    tls1_check_chain(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>SSL_PKEY_GOST12_512<span class='macro_popup'>6</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2429"><td class="num" id="LN2429">2429</td><td class="line">    tls1_check_chain(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>SSL_PKEY_ED25519<span class='macro_popup'>7</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2430"><td class="num" id="LN2430">2430</td><td class="line">    tls1_check_chain(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>SSL_PKEY_ED448<span class='macro_popup'>8</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2431"><td class="num" id="LN2431">2431</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2432"><td class="num" id="LN2432">2432</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2433"><td class="num" id="LN2433">2433</td><td class="line"><span class='comment'>/* User level utility function to check a chain is suitable */</span></td></tr>
<tr class="codeline" data-linenumber="2434"><td class="num" id="LN2434">2434</td><td class="line"><span class='keyword'>int</span> SSL_check_chain(SSL *s, X509 *x, EVP_PKEY *pk, <span class='macro'>STACK_OF(X509)<span class='macro_popup'>struct stack_st_X509</span></span> *chain)</td></tr>
<tr class="codeline" data-linenumber="2435"><td class="num" id="LN2435">2435</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2436"><td class="num" id="LN2436">2436</td><td class="line">    <span class='keyword'>return</span> tls1_check_chain(s, x, pk, chain, -1);</td></tr>
<tr class="codeline" data-linenumber="2437"><td class="num" id="LN2437">2437</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2438"><td class="num" id="LN2438">2438</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2439"><td class="num" id="LN2439">2439</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_DH</span></td></tr>
<tr class="codeline" data-linenumber="2440"><td class="num" id="LN2440">2440</td><td class="line">DH *ssl_get_auto_dh(SSL *s)</td></tr>
<tr class="codeline" data-linenumber="2441"><td class="num" id="LN2441">2441</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2442"><td class="num" id="LN2442">2442</td><td class="line">    <span class='keyword'>int</span> dh_secbits = 80;</td></tr>
<tr class="codeline" data-linenumber="2443"><td class="num" id="LN2443">2443</td><td class="line">    <span class='keyword'>if</span> (s-&gt;cert-&gt;dh_tmp_auto == 2)</td></tr>
<tr class="codeline" data-linenumber="2444"><td class="num" id="LN2444">2444</td><td class="line">        <span class='keyword'>return</span> DH_get_1024_160();</td></tr>
<tr class="codeline" data-linenumber="2445"><td class="num" id="LN2445">2445</td><td class="line">    <span class='keyword'>if</span> (s-&gt;s3-&gt;tmp.new_cipher-&gt;algorithm_auth &amp; (<span class='macro'>SSL_aNULL<span class='macro_popup'>0x00000004U</span></span> | <span class='macro'>SSL_aPSK<span class='macro_popup'>0x00000010U</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="2446"><td class="num" id="LN2446">2446</td><td class="line">        <span class='keyword'>if</span> (s-&gt;s3-&gt;tmp.new_cipher-&gt;strength_bits == 256)</td></tr>
<tr class="codeline" data-linenumber="2447"><td class="num" id="LN2447">2447</td><td class="line">            dh_secbits = 128;</td></tr>
<tr class="codeline" data-linenumber="2448"><td class="num" id="LN2448">2448</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2449"><td class="num" id="LN2449">2449</td><td class="line">            dh_secbits = 80;</td></tr>
<tr class="codeline" data-linenumber="2450"><td class="num" id="LN2450">2450</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2451"><td class="num" id="LN2451">2451</td><td class="line">        <span class='keyword'>if</span> (s-&gt;s3-&gt;tmp.cert == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2452"><td class="num" id="LN2452">2452</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2453"><td class="num" id="LN2453">2453</td><td class="line">        dh_secbits = EVP_PKEY_security_bits(s-&gt;s3-&gt;tmp.cert-&gt;privatekey);</td></tr>
<tr class="codeline" data-linenumber="2454"><td class="num" id="LN2454">2454</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2455"><td class="num" id="LN2455">2455</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2456"><td class="num" id="LN2456">2456</td><td class="line">    <span class='keyword'>if</span> (dh_secbits &gt;= 128) {</td></tr>
<tr class="codeline" data-linenumber="2457"><td class="num" id="LN2457">2457</td><td class="line">        DH *dhp = DH_new();</td></tr>
<tr class="codeline" data-linenumber="2458"><td class="num" id="LN2458">2458</td><td class="line">        BIGNUM *p, *g;</td></tr>
<tr class="codeline" data-linenumber="2459"><td class="num" id="LN2459">2459</td><td class="line">        <span class='keyword'>if</span> (dhp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2460"><td class="num" id="LN2460">2460</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2461"><td class="num" id="LN2461">2461</td><td class="line">        g = BN_new();</td></tr>
<tr class="codeline" data-linenumber="2462"><td class="num" id="LN2462">2462</td><td class="line">        <span class='keyword'>if</span> (g == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || !BN_set_word(g, 2)) {</td></tr>
<tr class="codeline" data-linenumber="2463"><td class="num" id="LN2463">2463</td><td class="line">            DH_free(dhp);</td></tr>
<tr class="codeline" data-linenumber="2464"><td class="num" id="LN2464">2464</td><td class="line">            BN_free(g);</td></tr>
<tr class="codeline" data-linenumber="2465"><td class="num" id="LN2465">2465</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2466"><td class="num" id="LN2466">2466</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2467"><td class="num" id="LN2467">2467</td><td class="line">        <span class='keyword'>if</span> (dh_secbits &gt;= 192)</td></tr>
<tr class="codeline" data-linenumber="2468"><td class="num" id="LN2468">2468</td><td class="line">            p = BN_get_rfc3526_prime_8192(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2469"><td class="num" id="LN2469">2469</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2470"><td class="num" id="LN2470">2470</td><td class="line">            p = BN_get_rfc3526_prime_3072(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2471"><td class="num" id="LN2471">2471</td><td class="line">        <span class='keyword'>if</span> (p == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || !DH_set0_pqg(dhp, p, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, g)) {</td></tr>
<tr class="codeline" data-linenumber="2472"><td class="num" id="LN2472">2472</td><td class="line">            DH_free(dhp);</td></tr>
<tr class="codeline" data-linenumber="2473"><td class="num" id="LN2473">2473</td><td class="line">            BN_free(p);</td></tr>
<tr class="codeline" data-linenumber="2474"><td class="num" id="LN2474">2474</td><td class="line">            BN_free(g);</td></tr>
<tr class="codeline" data-linenumber="2475"><td class="num" id="LN2475">2475</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2476"><td class="num" id="LN2476">2476</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2477"><td class="num" id="LN2477">2477</td><td class="line">        <span class='keyword'>return</span> dhp;</td></tr>
<tr class="codeline" data-linenumber="2478"><td class="num" id="LN2478">2478</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2479"><td class="num" id="LN2479">2479</td><td class="line">    <span class='keyword'>if</span> (dh_secbits &gt;= 112)</td></tr>
<tr class="codeline" data-linenumber="2480"><td class="num" id="LN2480">2480</td><td class="line">        <span class='keyword'>return</span> DH_get_2048_224();</td></tr>
<tr class="codeline" data-linenumber="2481"><td class="num" id="LN2481">2481</td><td class="line">    <span class='keyword'>return</span> DH_get_1024_160();</td></tr>
<tr class="codeline" data-linenumber="2482"><td class="num" id="LN2482">2482</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2483"><td class="num" id="LN2483">2483</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2484"><td class="num" id="LN2484">2484</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2485"><td class="num" id="LN2485">2485</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> ssl_security_cert_key(SSL *s, SSL_CTX *ctx, X509 *x, <span class='keyword'>int</span> op)</td></tr>
<tr class="codeline" data-linenumber="2486"><td class="num" id="LN2486">2486</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2487"><td class="num" id="LN2487">2487</td><td class="line">    <span class='keyword'>int</span> secbits = -1;</td></tr>
<tr class="codeline" data-linenumber="2488"><td class="num" id="LN2488">2488</td><td class="line">    EVP_PKEY *pkey = X509_get0_pubkey(x);</td></tr>
<tr class="codeline" data-linenumber="2489"><td class="num" id="LN2489">2489</td><td class="line">    <span class='keyword'>if</span> (pkey) {</td></tr>
<tr class="codeline" data-linenumber="2490"><td class="num" id="LN2490">2490</td><td class="line">        <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2491"><td class="num" id="LN2491">2491</td><td class="line">         <span class='comment'>* If no parameters this will return -1 and fail using the default</span></td></tr>
<tr class="codeline" data-linenumber="2492"><td class="num" id="LN2492">2492</td><td class="line">         <span class='comment'>* security callback for any non-zero security level. This will</span></td></tr>
<tr class="codeline" data-linenumber="2493"><td class="num" id="LN2493">2493</td><td class="line">         <span class='comment'>* reject keys which omit parameters but this only affects DSA and</span></td></tr>
<tr class="codeline" data-linenumber="2494"><td class="num" id="LN2494">2494</td><td class="line">         <span class='comment'>* omission of parameters is never (?) done in practice.</span></td></tr>
<tr class="codeline" data-linenumber="2495"><td class="num" id="LN2495">2495</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2496"><td class="num" id="LN2496">2496</td><td class="line">        secbits = EVP_PKEY_security_bits(pkey);</td></tr>
<tr class="codeline" data-linenumber="2497"><td class="num" id="LN2497">2497</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2498"><td class="num" id="LN2498">2498</td><td class="line">    <span class='keyword'>if</span> (s)</td></tr>
<tr class="codeline" data-linenumber="2499"><td class="num" id="LN2499">2499</td><td class="line">        <span class='keyword'>return</span> ssl_security(s, op, secbits, 0, x);</td></tr>
<tr class="codeline" data-linenumber="2500"><td class="num" id="LN2500">2500</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2501"><td class="num" id="LN2501">2501</td><td class="line">        <span class='keyword'>return</span> ssl_ctx_security(ctx, op, secbits, 0, x);</td></tr>
<tr class="codeline" data-linenumber="2502"><td class="num" id="LN2502">2502</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2503"><td class="num" id="LN2503">2503</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2504"><td class="num" id="LN2504">2504</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> ssl_security_cert_sig(SSL *s, SSL_CTX *ctx, X509 *x, <span class='keyword'>int</span> op)</td></tr>
<tr class="codeline" data-linenumber="2505"><td class="num" id="LN2505">2505</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2506"><td class="num" id="LN2506">2506</td><td class="line">    <span class='comment'>/* Lookup signature algorithm digest */</span></td></tr>
<tr class="codeline" data-linenumber="2507"><td class="num" id="LN2507">2507</td><td class="line">    <span class='keyword'>int</span> secbits, nid, pknid;</td></tr>
<tr class="codeline" data-linenumber="2508"><td class="num" id="LN2508">2508</td><td class="line">    <span class='comment'>/* Don't check signature if self signed */</span></td></tr>
<tr class="codeline" data-linenumber="2509"><td class="num" id="LN2509">2509</td><td class="line">    <span class='keyword'>if</span> ((X509_get_extension_flags(x) &amp; <span class='macro'>EXFLAG_SS<span class='macro_popup'>0x2000</span></span>) != 0)</td></tr>
<tr class="codeline" data-linenumber="2510"><td class="num" id="LN2510">2510</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2511"><td class="num" id="LN2511">2511</td><td class="line">    <span class='keyword'>if</span> (!X509_get_signature_info(x, &amp;nid, &amp;pknid, &amp;secbits, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="2512"><td class="num" id="LN2512">2512</td><td class="line">        secbits = -1;</td></tr>
<tr class="codeline" data-linenumber="2513"><td class="num" id="LN2513">2513</td><td class="line">    <span class='comment'>/* If digest NID not defined use signature NID */</span></td></tr>
<tr class="codeline" data-linenumber="2514"><td class="num" id="LN2514">2514</td><td class="line">    <span class='keyword'>if</span> (nid == <span class='macro'>NID_undef<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2515"><td class="num" id="LN2515">2515</td><td class="line">        nid = pknid;</td></tr>
<tr class="codeline" data-linenumber="2516"><td class="num" id="LN2516">2516</td><td class="line">    <span class='keyword'>if</span> (s)</td></tr>
<tr class="codeline" data-linenumber="2517"><td class="num" id="LN2517">2517</td><td class="line">        <span class='keyword'>return</span> ssl_security(s, op, secbits, nid, x);</td></tr>
<tr class="codeline" data-linenumber="2518"><td class="num" id="LN2518">2518</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2519"><td class="num" id="LN2519">2519</td><td class="line">        <span class='keyword'>return</span> ssl_ctx_security(ctx, op, secbits, nid, x);</td></tr>
<tr class="codeline" data-linenumber="2520"><td class="num" id="LN2520">2520</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2521"><td class="num" id="LN2521">2521</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2522"><td class="num" id="LN2522">2522</td><td class="line"><span class='keyword'>int</span> ssl_security_cert(SSL *s, SSL_CTX *ctx, X509 *x, <span class='keyword'>int</span> vfy, <span class='keyword'>int</span> is_ee)</td></tr>
<tr class="codeline" data-linenumber="2523"><td class="num" id="LN2523">2523</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2524"><td class="num" id="LN2524">2524</td><td class="line">    <span class='keyword'>if</span> (vfy)</td></tr>
<tr class="codeline" data-linenumber="2525"><td class="num" id="LN2525">2525</td><td class="line">        vfy = <span class='macro'>SSL_SECOP_PEER<span class='macro_popup'>0x1000</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2526"><td class="num" id="LN2526">2526</td><td class="line">    <span class='keyword'>if</span> (is_ee) {</td></tr>
<tr class="codeline" data-linenumber="2527"><td class="num" id="LN2527">2527</td><td class="line">        <span class='keyword'>if</span> (!ssl_security_cert_key(s, ctx, x, <span class='macro'>SSL_SECOP_EE_KEY<span class='macro_popup'>(16 | (6 &lt;&lt; 16))</span></span> | vfy))</td></tr>
<tr class="codeline" data-linenumber="2528"><td class="num" id="LN2528">2528</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>SSL_R_EE_KEY_TOO_SMALL<span class='macro_popup'>399</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2529"><td class="num" id="LN2529">2529</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2530"><td class="num" id="LN2530">2530</td><td class="line">        <span class='keyword'>if</span> (!ssl_security_cert_key(s, ctx, x, <span class='macro'>SSL_SECOP_CA_KEY<span class='macro_popup'>(17 | (6 &lt;&lt; 16))</span></span> | vfy))</td></tr>
<tr class="codeline" data-linenumber="2531"><td class="num" id="LN2531">2531</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>SSL_R_CA_KEY_TOO_SMALL<span class='macro_popup'>397</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2532"><td class="num" id="LN2532">2532</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2533"><td class="num" id="LN2533">2533</td><td class="line">    <span class='keyword'>if</span> (!ssl_security_cert_sig(s, ctx, x, <span class='macro'>SSL_SECOP_CA_MD<span class='macro_popup'>(18 | (6 &lt;&lt; 16))</span></span> | vfy))</td></tr>
<tr class="codeline" data-linenumber="2534"><td class="num" id="LN2534">2534</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>SSL_R_CA_MD_TOO_WEAK<span class='macro_popup'>398</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2535"><td class="num" id="LN2535">2535</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2536"><td class="num" id="LN2536">2536</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2537"><td class="num" id="LN2537">2537</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2538"><td class="num" id="LN2538">2538</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2539"><td class="num" id="LN2539">2539</td><td class="line"> <span class='comment'>* Check security of a chain, if |sk| includes the end entity certificate then</span></td></tr>
<tr class="codeline" data-linenumber="2540"><td class="num" id="LN2540">2540</td><td class="line"> <span class='comment'>* |x| is NULL. If |vfy| is 1 then we are verifying a peer chain and not sending</span></td></tr>
<tr class="codeline" data-linenumber="2541"><td class="num" id="LN2541">2541</td><td class="line"> <span class='comment'>* one to the peer. Return values: 1 if ok otherwise error code to use</span></td></tr>
<tr class="codeline" data-linenumber="2542"><td class="num" id="LN2542">2542</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2543"><td class="num" id="LN2543">2543</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2544"><td class="num" id="LN2544">2544</td><td class="line"><span class='keyword'>int</span> ssl_security_cert_chain(SSL *s, <span class='macro'>STACK_OF(X509)<span class='macro_popup'>struct stack_st_X509</span></span> *sk, X509 *x, <span class='keyword'>int</span> vfy)</td></tr>
<tr class="codeline" data-linenumber="2545"><td class="num" id="LN2545">2545</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2546"><td class="num" id="LN2546">2546</td><td class="line">    <span class='keyword'>int</span> rv, start_idx, i;</td></tr>
<tr class="codeline" data-linenumber="2547"><td class="num" id="LN2547">2547</td><td class="line">    <span class='keyword'>if</span> (x == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2548"><td class="num" id="LN2548">2548</td><td class="line">        x = sk_X509_value(sk, 0);</td></tr>
<tr class="codeline" data-linenumber="2549"><td class="num" id="LN2549">2549</td><td class="line">        start_idx = 1;</td></tr>
<tr class="codeline" data-linenumber="2550"><td class="num" id="LN2550">2550</td><td class="line">    } <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2551"><td class="num" id="LN2551">2551</td><td class="line">        start_idx = 0;</td></tr>
<tr class="codeline" data-linenumber="2552"><td class="num" id="LN2552">2552</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2553"><td class="num" id="LN2553">2553</td><td class="line">    rv = ssl_security_cert(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, x, vfy, 1);</td></tr>
<tr class="codeline" data-linenumber="2554"><td class="num" id="LN2554">2554</td><td class="line">    <span class='keyword'>if</span> (rv != 1)</td></tr>
<tr class="codeline" data-linenumber="2555"><td class="num" id="LN2555">2555</td><td class="line">        <span class='keyword'>return</span> rv;</td></tr>
<tr class="codeline" data-linenumber="2556"><td class="num" id="LN2556">2556</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2557"><td class="num" id="LN2557">2557</td><td class="line">    <span class='keyword'>for</span> (i = start_idx; i &lt; sk_X509_num(sk); i++) {</td></tr>
<tr class="codeline" data-linenumber="2558"><td class="num" id="LN2558">2558</td><td class="line">        x = sk_X509_value(sk, i);</td></tr>
<tr class="codeline" data-linenumber="2559"><td class="num" id="LN2559">2559</td><td class="line">        rv = ssl_security_cert(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, x, vfy, 0);</td></tr>
<tr class="codeline" data-linenumber="2560"><td class="num" id="LN2560">2560</td><td class="line">        <span class='keyword'>if</span> (rv != 1)</td></tr>
<tr class="codeline" data-linenumber="2561"><td class="num" id="LN2561">2561</td><td class="line">            <span class='keyword'>return</span> rv;</td></tr>
<tr class="codeline" data-linenumber="2562"><td class="num" id="LN2562">2562</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2563"><td class="num" id="LN2563">2563</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2564"><td class="num" id="LN2564">2564</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2565"><td class="num" id="LN2565">2565</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2566"><td class="num" id="LN2566">2566</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2567"><td class="num" id="LN2567">2567</td><td class="line"> <span class='comment'>* For TLS 1.2 servers check if we have a certificate which can be used</span></td></tr>
<tr class="codeline" data-linenumber="2568"><td class="num" id="LN2568">2568</td><td class="line"> <span class='comment'>* with the signature algorithm "lu" and return index of certificate.</span></td></tr>
<tr class="codeline" data-linenumber="2569"><td class="num" id="LN2569">2569</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2570"><td class="num" id="LN2570">2570</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2571"><td class="num" id="LN2571">2571</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> tls12_get_cert_sigalg_idx(<span class='keyword'>const</span> SSL *s, <span class='keyword'>const</span> SIGALG_LOOKUP *lu)</td></tr>
<tr class="codeline" data-linenumber="2572"><td class="num" id="LN2572">2572</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2573"><td class="num" id="LN2573">2573</td><td class="line">    <span class='keyword'>int</span> sig_idx = lu-&gt;sig_idx;</td></tr>
<tr class="codeline" data-linenumber="2574"><td class="num" id="LN2574">2574</td><td class="line">    <span class='keyword'>const</span> SSL_CERT_LOOKUP *clu = ssl_cert_lookup_by_idx(sig_idx);</td></tr>
<tr class="codeline" data-linenumber="2575"><td class="num" id="LN2575">2575</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2576"><td class="num" id="LN2576">2576</td><td class="line">    <span class='comment'>/* If not recognised or not supported by cipher mask it is not suitable */</span></td></tr>
<tr class="codeline" data-linenumber="2577"><td class="num" id="LN2577">2577</td><td class="line">    <span class='keyword'>if</span> (clu == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="2578"><td class="num" id="LN2578">2578</td><td class="line">            || (clu-&gt;amask &amp; s-&gt;s3-&gt;tmp.new_cipher-&gt;algorithm_auth) == 0</td></tr>
<tr class="codeline" data-linenumber="2579"><td class="num" id="LN2579">2579</td><td class="line">            || (clu-&gt;nid == <span class='macro'>EVP_PKEY_RSA_PSS<span class='macro_popup'>912</span></span></td></tr>
<tr class="codeline" data-linenumber="2580"><td class="num" id="LN2580">2580</td><td class="line">                &amp;&amp; (s-&gt;s3-&gt;tmp.new_cipher-&gt;algorithm_mkey &amp; <span class='macro'>SSL_kRSA<span class='macro_popup'>0x00000001U</span></span>) != 0))</td></tr>
<tr class="codeline" data-linenumber="2581"><td class="num" id="LN2581">2581</td><td class="line">        <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="2582"><td class="num" id="LN2582">2582</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2583"><td class="num" id="LN2583">2583</td><td class="line">    <span class='keyword'>return</span> s-&gt;s3-&gt;tmp.valid_flags[sig_idx] &amp; <span class='macro'>CERT_PKEY_VALID<span class='macro_popup'>0x1</span></span> ? sig_idx : -1;</td></tr>
<tr class="codeline" data-linenumber="2584"><td class="num" id="LN2584">2584</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2585"><td class="num" id="LN2585">2585</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2586"><td class="num" id="LN2586">2586</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2587"><td class="num" id="LN2587">2587</td><td class="line"> <span class='comment'>* Checks the given cert against signature_algorithm_cert restrictions sent by</span></td></tr>
<tr class="codeline" data-linenumber="2588"><td class="num" id="LN2588">2588</td><td class="line"> <span class='comment'>* the peer (if any) as well as whether the hash from the sigalg is usable with</span></td></tr>
<tr class="codeline" data-linenumber="2589"><td class="num" id="LN2589">2589</td><td class="line"> <span class='comment'>* the key.</span></td></tr>
<tr class="codeline" data-linenumber="2590"><td class="num" id="LN2590">2590</td><td class="line"> <span class='comment'>* Returns true if the cert is usable and false otherwise.</span></td></tr>
<tr class="codeline" data-linenumber="2591"><td class="num" id="LN2591">2591</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2592"><td class="num" id="LN2592">2592</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> check_cert_usable(SSL *s, <span class='keyword'>const</span> SIGALG_LOOKUP *sig, X509 *x,</td></tr>
<tr class="codeline" data-linenumber="2593"><td class="num" id="LN2593">2593</td><td class="line">                             EVP_PKEY *pkey)</td></tr>
<tr class="codeline" data-linenumber="2594"><td class="num" id="LN2594">2594</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2595"><td class="num" id="LN2595">2595</td><td class="line">    <span class='keyword'>const</span> SIGALG_LOOKUP *lu;</td></tr>
<tr class="codeline" data-linenumber="2596"><td class="num" id="LN2596">2596</td><td class="line">    <span class='keyword'>int</span> mdnid, pknid, default_mdnid;</td></tr>
<tr class="codeline" data-linenumber="2597"><td class="num" id="LN2597">2597</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="2598"><td class="num" id="LN2598">2598</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2599"><td class="num" id="LN2599">2599</td><td class="line">    <span class='comment'>/* If the EVP_PKEY reports a mandatory digest, allow nothing else. */</span></td></tr>
<tr class="codeline" data-linenumber="2600"><td class="num" id="LN2600">2600</td><td class="line">    ERR_set_mark();</td></tr>
<tr class="codeline" data-linenumber="2601"><td class="num" id="LN2601">2601</td><td class="line">    <span class='keyword'>if</span> (EVP_PKEY_get_default_digest_nid(pkey, &amp;default_mdnid) == 2 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2602"><td class="num" id="LN2602">2602</td><td class="line">        sig-&gt;hash != default_mdnid)</td></tr>
<tr class="codeline" data-linenumber="2603"><td class="num" id="LN2603">2603</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2604"><td class="num" id="LN2604">2604</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2605"><td class="num" id="LN2605">2605</td><td class="line">    <span class='comment'>/* If it didn't report a mandatory NID, for whatever reasons,</span></td></tr>
<tr class="codeline" data-linenumber="2606"><td class="num" id="LN2606">2606</td><td class="line">     <span class='comment'>* just clear the error and allow all hashes to be used. */</span></td></tr>
<tr class="codeline" data-linenumber="2607"><td class="num" id="LN2607">2607</td><td class="line">    ERR_pop_to_mark();</td></tr>
<tr class="codeline" data-linenumber="2608"><td class="num" id="LN2608">2608</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2609"><td class="num" id="LN2609">2609</td><td class="line">    <span class='keyword'>if</span> (s-&gt;s3-&gt;tmp.peer_cert_sigalgs != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2610"><td class="num" id="LN2610">2610</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; s-&gt;s3-&gt;tmp.peer_cert_sigalgslen; i++) {</td></tr>
<tr class="codeline" data-linenumber="2611"><td class="num" id="LN2611">2611</td><td class="line">            lu = tls1_lookup_sigalg(s-&gt;s3-&gt;tmp.peer_cert_sigalgs[i]);</td></tr>
<tr class="codeline" data-linenumber="2612"><td class="num" id="LN2612">2612</td><td class="line">            <span class='keyword'>if</span> (lu == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="2613"><td class="num" id="LN2613">2613</td><td class="line">                || !X509_get_signature_info(x, &amp;mdnid, &amp;pknid, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="2614"><td class="num" id="LN2614">2614</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2615"><td class="num" id="LN2615">2615</td><td class="line">            <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2616"><td class="num" id="LN2616">2616</td><td class="line">             <span class='comment'>* TODO this does not differentiate between the</span></td></tr>
<tr class="codeline" data-linenumber="2617"><td class="num" id="LN2617">2617</td><td class="line">             <span class='comment'>* rsa_pss_pss_* and rsa_pss_rsae_* schemes since we do not</span></td></tr>
<tr class="codeline" data-linenumber="2618"><td class="num" id="LN2618">2618</td><td class="line">             <span class='comment'>* have a chain here that lets us look at the key OID in the</span></td></tr>
<tr class="codeline" data-linenumber="2619"><td class="num" id="LN2619">2619</td><td class="line">             <span class='comment'>* signing certificate.</span></td></tr>
<tr class="codeline" data-linenumber="2620"><td class="num" id="LN2620">2620</td><td class="line">             <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2621"><td class="num" id="LN2621">2621</td><td class="line">            <span class='keyword'>if</span> (mdnid == lu-&gt;hash &amp;&amp; pknid == lu-&gt;sig)</td></tr>
<tr class="codeline" data-linenumber="2622"><td class="num" id="LN2622">2622</td><td class="line">                <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2623"><td class="num" id="LN2623">2623</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2624"><td class="num" id="LN2624">2624</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2625"><td class="num" id="LN2625">2625</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2626"><td class="num" id="LN2626">2626</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2627"><td class="num" id="LN2627">2627</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2628"><td class="num" id="LN2628">2628</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2629"><td class="num" id="LN2629">2629</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2630"><td class="num" id="LN2630">2630</td><td class="line"> <span class='comment'>* Returns true if |s| has a usable certificate configured for use</span></td></tr>
<tr class="codeline" data-linenumber="2631"><td class="num" id="LN2631">2631</td><td class="line"> <span class='comment'>* with signature scheme |sig|.</span></td></tr>
<tr class="codeline" data-linenumber="2632"><td class="num" id="LN2632">2632</td><td class="line"> <span class='comment'>* "Usable" includes a check for presence as well as applying</span></td></tr>
<tr class="codeline" data-linenumber="2633"><td class="num" id="LN2633">2633</td><td class="line"> <span class='comment'>* the signature_algorithm_cert restrictions sent by the peer (if any).</span></td></tr>
<tr class="codeline" data-linenumber="2634"><td class="num" id="LN2634">2634</td><td class="line"> <span class='comment'>* Returns false if no usable certificate is found.</span></td></tr>
<tr class="codeline" data-linenumber="2635"><td class="num" id="LN2635">2635</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2636"><td class="num" id="LN2636">2636</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> has_usable_cert(SSL *s, <span class='keyword'>const</span> SIGALG_LOOKUP *sig, <span class='keyword'>int</span> idx)</td></tr>
<tr class="codeline" data-linenumber="2637"><td class="num" id="LN2637">2637</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2638"><td class="num" id="LN2638">2638</td><td class="line">    <span class='comment'>/* TLS 1.2 callers can override sig-&gt;sig_idx, but not TLS 1.3 callers. */</span></td></tr>
<tr class="codeline" data-linenumber="2639"><td class="num" id="LN2639">2639</td><td class="line">    <span class='keyword'>if</span> (idx == -1)</td></tr>
<tr class="codeline" data-linenumber="2640"><td class="num" id="LN2640">2640</td><td class="line">        idx = sig-&gt;sig_idx;</td></tr>
<tr class="codeline" data-linenumber="2641"><td class="num" id="LN2641">2641</td><td class="line">    <span class='keyword'>if</span> (!ssl_has_cert(s, idx))</td></tr>
<tr class="codeline" data-linenumber="2642"><td class="num" id="LN2642">2642</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2643"><td class="num" id="LN2643">2643</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2644"><td class="num" id="LN2644">2644</td><td class="line">    <span class='keyword'>return</span> check_cert_usable(s, sig, s-&gt;cert-&gt;pkeys[idx].x509,</td></tr>
<tr class="codeline" data-linenumber="2645"><td class="num" id="LN2645">2645</td><td class="line">                             s-&gt;cert-&gt;pkeys[idx].privatekey);</td></tr>
<tr class="codeline" data-linenumber="2646"><td class="num" id="LN2646">2646</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2647"><td class="num" id="LN2647">2647</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2648"><td class="num" id="LN2648">2648</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2649"><td class="num" id="LN2649">2649</td><td class="line"> <span class='comment'>* Returns true if the supplied cert |x| and key |pkey| is usable with the</span></td></tr>
<tr class="codeline" data-linenumber="2650"><td class="num" id="LN2650">2650</td><td class="line"> <span class='comment'>* specified signature scheme |sig|, or false otherwise.</span></td></tr>
<tr class="codeline" data-linenumber="2651"><td class="num" id="LN2651">2651</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2652"><td class="num" id="LN2652">2652</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> is_cert_usable(SSL *s, <span class='keyword'>const</span> SIGALG_LOOKUP *sig, X509 *x,</td></tr>
<tr class="codeline" data-linenumber="2653"><td class="num" id="LN2653">2653</td><td class="line">                          EVP_PKEY *pkey)</td></tr>
<tr class="codeline" data-linenumber="2654"><td class="num" id="LN2654">2654</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2655"><td class="num" id="LN2655">2655</td><td class="line">    size_t idx;</td></tr>
<tr class="codeline" data-linenumber="2656"><td class="num" id="LN2656">2656</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2657"><td class="num" id="LN2657">2657</td><td class="line">    <span class='keyword'>if</span> (ssl_cert_lookup_by_pkey(pkey, &amp;idx) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2658"><td class="num" id="LN2658">2658</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2659"><td class="num" id="LN2659">2659</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2660"><td class="num" id="LN2660">2660</td><td class="line">    <span class='comment'>/* Check the key is consistent with the sig alg */</span></td></tr>
<tr class="codeline" data-linenumber="2661"><td class="num" id="LN2661">2661</td><td class="line">    <span class='keyword'>if</span> ((<span class='keyword'>int</span>)idx != sig-&gt;sig_idx)</td></tr>
<tr class="codeline" data-linenumber="2662"><td class="num" id="LN2662">2662</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2663"><td class="num" id="LN2663">2663</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2664"><td class="num" id="LN2664">2664</td><td class="line">    <span class='keyword'>return</span> check_cert_usable(s, sig, x, pkey);</td></tr>
<tr class="codeline" data-linenumber="2665"><td class="num" id="LN2665">2665</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2666"><td class="num" id="LN2666">2666</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2667"><td class="num" id="LN2667">2667</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2668"><td class="num" id="LN2668">2668</td><td class="line"> <span class='comment'>* Find a signature scheme that works with the supplied certificate |x| and key</span></td></tr>
<tr class="codeline" data-linenumber="2669"><td class="num" id="LN2669">2669</td><td class="line"> <span class='comment'>* |pkey|. |x| and |pkey| may be NULL in which case we additionally look at our</span></td></tr>
<tr class="codeline" data-linenumber="2670"><td class="num" id="LN2670">2670</td><td class="line"> <span class='comment'>* available certs/keys to find one that works.</span></td></tr>
<tr class="codeline" data-linenumber="2671"><td class="num" id="LN2671">2671</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2672"><td class="num" id="LN2672">2672</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> SIGALG_LOOKUP *find_sig_alg(SSL *s, X509 *x, EVP_PKEY *pkey)</td></tr>
<tr class="codeline" data-linenumber="2673"><td class="num" id="LN2673">2673</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2674"><td class="num" id="LN2674">2674</td><td class="line">    <span class='keyword'>const</span> SIGALG_LOOKUP *lu = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2675"><td class="num" id="LN2675">2675</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="2676"><td class="num" id="LN2676">2676</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="2677"><td class="num" id="LN2677">2677</td><td class="line">    <span class='keyword'>int</span> curve = -1;</td></tr>
<tr class="codeline" data-linenumber="2678"><td class="num" id="LN2678">2678</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2679"><td class="num" id="LN2679">2679</td><td class="line">    EVP_PKEY *tmppkey;</td></tr>
<tr class="codeline" data-linenumber="2680"><td class="num" id="LN2680">2680</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2681"><td class="num" id="LN2681">2681</td><td class="line">    <span class='comment'>/* Look for a shared sigalgs matching possible certificates */</span></td></tr>
<tr class="codeline" data-linenumber="2682"><td class="num" id="LN2682">2682</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; s-&gt;shared_sigalgslen; i++) {</td></tr>
<tr class="codeline" data-linenumber="2683"><td class="num" id="LN2683">2683</td><td class="line">        lu = s-&gt;shared_sigalgs[i];</td></tr>
<tr class="codeline" data-linenumber="2684"><td class="num" id="LN2684">2684</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2685"><td class="num" id="LN2685">2685</td><td class="line">        <span class='comment'>/* Skip SHA1, SHA224, DSA and RSA if not PSS */</span></td></tr>
<tr class="codeline" data-linenumber="2686"><td class="num" id="LN2686">2686</td><td class="line">        <span class='keyword'>if</span> (lu-&gt;hash == <span class='macro'>NID_sha1<span class='macro_popup'>64</span></span></td></tr>
<tr class="codeline" data-linenumber="2687"><td class="num" id="LN2687">2687</td><td class="line">            || lu-&gt;hash == <span class='macro'>NID_sha224<span class='macro_popup'>675</span></span></td></tr>
<tr class="codeline" data-linenumber="2688"><td class="num" id="LN2688">2688</td><td class="line">            || lu-&gt;sig == <span class='macro'>EVP_PKEY_DSA<span class='macro_popup'>116</span></span></td></tr>
<tr class="codeline" data-linenumber="2689"><td class="num" id="LN2689">2689</td><td class="line">            || lu-&gt;sig == <span class='macro'>EVP_PKEY_RSA<span class='macro_popup'>6</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2690"><td class="num" id="LN2690">2690</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2691"><td class="num" id="LN2691">2691</td><td class="line">        <span class='comment'>/* Check that we have a cert, and signature_algorithms_cert */</span></td></tr>
<tr class="codeline" data-linenumber="2692"><td class="num" id="LN2692">2692</td><td class="line">        <span class='keyword'>if</span> (!tls1_lookup_md(lu, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="2693"><td class="num" id="LN2693">2693</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2694"><td class="num" id="LN2694">2694</td><td class="line">        <span class='keyword'>if</span> ((pkey == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; !has_usable_cert(s, lu, -1))</td></tr>
<tr class="codeline" data-linenumber="2695"><td class="num" id="LN2695">2695</td><td class="line">                || (pkey != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; !is_cert_usable(s, lu, x, pkey)))</td></tr>
<tr class="codeline" data-linenumber="2696"><td class="num" id="LN2696">2696</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2697"><td class="num" id="LN2697">2697</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2698"><td class="num" id="LN2698">2698</td><td class="line">        tmppkey = (pkey != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) ? pkey</td></tr>
<tr class="codeline" data-linenumber="2699"><td class="num" id="LN2699">2699</td><td class="line">                                 : s-&gt;cert-&gt;pkeys[lu-&gt;sig_idx].privatekey;</td></tr>
<tr class="codeline" data-linenumber="2700"><td class="num" id="LN2700">2700</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2701"><td class="num" id="LN2701">2701</td><td class="line">        <span class='keyword'>if</span> (lu-&gt;sig == <span class='macro'>EVP_PKEY_EC<span class='macro_popup'>408</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2702"><td class="num" id="LN2702">2702</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="2703"><td class="num" id="LN2703">2703</td><td class="line">            <span class='keyword'>if</span> (curve == -1) {</td></tr>
<tr class="codeline" data-linenumber="2704"><td class="num" id="LN2704">2704</td><td class="line">                EC_KEY *ec = EVP_PKEY_get0_EC_KEY(tmppkey);</td></tr>
<tr class="codeline" data-linenumber="2705"><td class="num" id="LN2705">2705</td><td class="line">                curve = EC_GROUP_get_curve_name(EC_KEY_get0_group(ec));</td></tr>
<tr class="codeline" data-linenumber="2706"><td class="num" id="LN2706">2706</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2707"><td class="num" id="LN2707">2707</td><td class="line">            <span class='keyword'>if</span> (lu-&gt;curve != <span class='macro'>NID_undef<span class='macro_popup'>0</span></span> &amp;&amp; curve != lu-&gt;curve)</td></tr>
<tr class="codeline" data-linenumber="2708"><td class="num" id="LN2708">2708</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2709"><td class="num" id="LN2709">2709</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="2710"><td class="num" id="LN2710">2710</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2711"><td class="num" id="LN2711">2711</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2712"><td class="num" id="LN2712">2712</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (lu-&gt;sig == <span class='macro'>EVP_PKEY_RSA_PSS<span class='macro_popup'>912</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2713"><td class="num" id="LN2713">2713</td><td class="line">            <span class='comment'>/* validate that key is large enough for the signature algorithm */</span></td></tr>
<tr class="codeline" data-linenumber="2714"><td class="num" id="LN2714">2714</td><td class="line">            <span class='keyword'>if</span> (!rsa_pss_check_min_key_size(EVP_PKEY_get0(tmppkey), lu))</td></tr>
<tr class="codeline" data-linenumber="2715"><td class="num" id="LN2715">2715</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2716"><td class="num" id="LN2716">2716</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2717"><td class="num" id="LN2717">2717</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2718"><td class="num" id="LN2718">2718</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2719"><td class="num" id="LN2719">2719</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2720"><td class="num" id="LN2720">2720</td><td class="line">    <span class='keyword'>if</span> (i == s-&gt;shared_sigalgslen)</td></tr>
<tr class="codeline" data-linenumber="2721"><td class="num" id="LN2721">2721</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2722"><td class="num" id="LN2722">2722</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2723"><td class="num" id="LN2723">2723</td><td class="line">    <span class='keyword'>return</span> lu;</td></tr>
<tr class="codeline" data-linenumber="2724"><td class="num" id="LN2724">2724</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2725"><td class="num" id="LN2725">2725</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2726"><td class="num" id="LN2726">2726</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2727"><td class="num" id="LN2727">2727</td><td class="line"> <span class='comment'>* Choose an appropriate signature algorithm based on available certificates</span></td></tr>
<tr class="codeline" data-linenumber="2728"><td class="num" id="LN2728">2728</td><td class="line"> <span class='comment'>* Sets chosen certificate and signature algorithm.</span></td></tr>
<tr class="codeline" data-linenumber="2729"><td class="num" id="LN2729">2729</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2730"><td class="num" id="LN2730">2730</td><td class="line"> <span class='comment'>* For servers if we fail to find a required certificate it is a fatal error,</span></td></tr>
<tr class="codeline" data-linenumber="2731"><td class="num" id="LN2731">2731</td><td class="line"> <span class='comment'>* an appropriate error code is set and a TLS alert is sent.</span></td></tr>
<tr class="codeline" data-linenumber="2732"><td class="num" id="LN2732">2732</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2733"><td class="num" id="LN2733">2733</td><td class="line"> <span class='comment'>* For clients fatalerrs is set to 0. If a certificate is not suitable it is not</span></td></tr>
<tr class="codeline" data-linenumber="2734"><td class="num" id="LN2734">2734</td><td class="line"> <span class='comment'>* a fatal error: we will either try another certificate or not present one</span></td></tr>
<tr class="codeline" data-linenumber="2735"><td class="num" id="LN2735">2735</td><td class="line"> <span class='comment'>* to the server. In this case no error is set.</span></td></tr>
<tr class="codeline" data-linenumber="2736"><td class="num" id="LN2736">2736</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2737"><td class="num" id="LN2737">2737</td><td class="line"><span class='keyword'>int</span> tls_choose_sigalg(SSL *s, <span class='keyword'>int</span> fatalerrs)</td></tr>
<tr class="codeline" data-linenumber="2738"><td class="num" id="LN2738">2738</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2739"><td class="num" id="LN2739">2739</td><td class="line">    <span class='keyword'>const</span> SIGALG_LOOKUP *lu = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2740"><td class="num" id="LN2740">2740</td><td class="line">    <span class='keyword'>int</span> sig_idx = -1;</td></tr>
<tr class="codeline" data-linenumber="2741"><td class="num" id="LN2741">2741</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2742"><td class="num" id="LN2742">2742</td><td class="line">    s-&gt;s3-&gt;tmp.cert = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2743"><td class="num" id="LN2743">2743</td><td class="line">    s-&gt;s3-&gt;tmp.sigalg = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2744"><td class="num" id="LN2744">2744</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2745"><td class="num" id="LN2745">2745</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>SSL_IS_TLS13(s)<span class='macro_popup'>(!(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x8) &amp;&amp;<br> (s)-&gt;method-&gt;version &gt;= 0x0304 &amp;&amp; (s)-&gt;method<br>-&gt;version != 0x10000)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2746"><td class="num" id="LN2746">2746</td><td class="line">        lu = find_sig_alg(s, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2747"><td class="num" id="LN2747">2747</td><td class="line">        <span class='keyword'>if</span> (lu == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2748"><td class="num" id="LN2748">2748</td><td class="line">            <span class='keyword'>if</span> (!fatalerrs)</td></tr>
<tr class="codeline" data-linenumber="2749"><td class="num" id="LN2749">2749</td><td class="line">                <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2750"><td class="num" id="LN2750">2750</td><td class="line">            <span class='macro'>SSLfatal(s, SSL_AD_HANDSHAKE_FAILURE, SSL_F_TLS_CHOOSE_SIGALG,<span class='macro_popup'>ossl_statem_fatal((s), (40), (513), (118), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 2751)</span></span></td></tr>
<tr class="codeline" data-linenumber="2751"><td class="num" id="LN2751">2751</td><td class="line">                     <span class='macro'>SSL_R_NO_SUITABLE_SIGNATURE_ALGORITHM)<span class='macro_popup'>ossl_statem_fatal((s), (40), (513), (118), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 2751)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2752"><td class="num" id="LN2752">2752</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2753"><td class="num" id="LN2753">2753</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2754"><td class="num" id="LN2754">2754</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2755"><td class="num" id="LN2755">2755</td><td class="line">        <span class='comment'>/* If ciphersuite doesn't require a cert nothing to do */</span></td></tr>
<tr class="codeline" data-linenumber="2756"><td class="num" id="LN2756">2756</td><td class="line">        <span class='keyword'>if</span> (!(s-&gt;s3-&gt;tmp.new_cipher-&gt;algorithm_auth &amp; <span class='macro'>SSL_aCERT<span class='macro_popup'>(0x00000001U | 0x00000002U | 0x00000008U | 0x00000020U | 0x00000080U<br>)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="2757"><td class="num" id="LN2757">2757</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2758"><td class="num" id="LN2758">2758</td><td class="line">        <span class='keyword'>if</span> (!s-&gt;server &amp;&amp; !ssl_has_cert(s, s-&gt;cert-&gt;key - s-&gt;cert-&gt;pkeys))</td></tr>
<tr class="codeline" data-linenumber="2759"><td class="num" id="LN2759">2759</td><td class="line">                <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2760"><td class="num" id="LN2760">2760</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2761"><td class="num" id="LN2761">2761</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>SSL_USE_SIGALGS(s)<span class='macro_popup'>(s-&gt;method-&gt;ssl3_enc-&gt;enc_flags &amp; 0x2)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2762"><td class="num" id="LN2762">2762</td><td class="line">            size_t i;</td></tr>
<tr class="codeline" data-linenumber="2763"><td class="num" id="LN2763">2763</td><td class="line">            <span class='keyword'>if</span> (s-&gt;s3-&gt;tmp.peer_sigalgs != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2764"><td class="num" id="LN2764">2764</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="2765"><td class="num" id="LN2765">2765</td><td class="line">                <span class='keyword'>int</span> curve;</td></tr>
<tr class="codeline" data-linenumber="2766"><td class="num" id="LN2766">2766</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2767"><td class="num" id="LN2767">2767</td><td class="line">                <span class='comment'>/* For Suite B need to match signature algorithm to curve */</span></td></tr>
<tr class="codeline" data-linenumber="2768"><td class="num" id="LN2768">2768</td><td class="line">                <span class='keyword'>if</span> (<span class='macro'>tls1_suiteb(s)<span class='macro_popup'>(s-&gt;cert-&gt;cert_flags &amp; 0x30000)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2769"><td class="num" id="LN2769">2769</td><td class="line">                    EC_KEY *ec = EVP_PKEY_get0_EC_KEY(s-&gt;cert-&gt;pkeys[<span class='macro'>SSL_PKEY_ECC<span class='macro_popup'>3</span></span>].privatekey);</td></tr>
<tr class="codeline" data-linenumber="2770"><td class="num" id="LN2770">2770</td><td class="line">                    curve = EC_GROUP_get_curve_name(EC_KEY_get0_group(ec));</td></tr>
<tr class="codeline" data-linenumber="2771"><td class="num" id="LN2771">2771</td><td class="line">                } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2772"><td class="num" id="LN2772">2772</td><td class="line">                    curve = -1;</td></tr>
<tr class="codeline" data-linenumber="2773"><td class="num" id="LN2773">2773</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2774"><td class="num" id="LN2774">2774</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2775"><td class="num" id="LN2775">2775</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2776"><td class="num" id="LN2776">2776</td><td class="line">                <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2777"><td class="num" id="LN2777">2777</td><td class="line">                 <span class='comment'>* Find highest preference signature algorithm matching</span></td></tr>
<tr class="codeline" data-linenumber="2778"><td class="num" id="LN2778">2778</td><td class="line">                 <span class='comment'>* cert type</span></td></tr>
<tr class="codeline" data-linenumber="2779"><td class="num" id="LN2779">2779</td><td class="line">                 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2780"><td class="num" id="LN2780">2780</td><td class="line">                <span class='keyword'>for</span> (i = 0; i &lt; s-&gt;shared_sigalgslen; i++) {</td></tr>
<tr class="codeline" data-linenumber="2781"><td class="num" id="LN2781">2781</td><td class="line">                    lu = s-&gt;shared_sigalgs[i];</td></tr>
<tr class="codeline" data-linenumber="2782"><td class="num" id="LN2782">2782</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2783"><td class="num" id="LN2783">2783</td><td class="line">                    <span class='keyword'>if</span> (s-&gt;server) {</td></tr>
<tr class="codeline" data-linenumber="2784"><td class="num" id="LN2784">2784</td><td class="line">                        <span class='keyword'>if</span> ((sig_idx = tls12_get_cert_sigalg_idx(s, lu)) == -1)</td></tr>
<tr class="codeline" data-linenumber="2785"><td class="num" id="LN2785">2785</td><td class="line">                            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2786"><td class="num" id="LN2786">2786</td><td class="line">                    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2787"><td class="num" id="LN2787">2787</td><td class="line">                        <span class='keyword'>int</span> cc_idx = s-&gt;cert-&gt;key - s-&gt;cert-&gt;pkeys;</td></tr>
<tr class="codeline" data-linenumber="2788"><td class="num" id="LN2788">2788</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2789"><td class="num" id="LN2789">2789</td><td class="line">                        sig_idx = lu-&gt;sig_idx;</td></tr>
<tr class="codeline" data-linenumber="2790"><td class="num" id="LN2790">2790</td><td class="line">                        <span class='keyword'>if</span> (cc_idx != sig_idx)</td></tr>
<tr class="codeline" data-linenumber="2791"><td class="num" id="LN2791">2791</td><td class="line">                            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2792"><td class="num" id="LN2792">2792</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="2793"><td class="num" id="LN2793">2793</td><td class="line">                    <span class='comment'>/* Check that we have a cert, and sig_algs_cert */</span></td></tr>
<tr class="codeline" data-linenumber="2794"><td class="num" id="LN2794">2794</td><td class="line">                    <span class='keyword'>if</span> (!has_usable_cert(s, lu, sig_idx))</td></tr>
<tr class="codeline" data-linenumber="2795"><td class="num" id="LN2795">2795</td><td class="line">                        <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2796"><td class="num" id="LN2796">2796</td><td class="line">                    <span class='keyword'>if</span> (lu-&gt;sig == <span class='macro'>EVP_PKEY_RSA_PSS<span class='macro_popup'>912</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2797"><td class="num" id="LN2797">2797</td><td class="line">                        <span class='comment'>/* validate that key is large enough for the signature algorithm */</span></td></tr>
<tr class="codeline" data-linenumber="2798"><td class="num" id="LN2798">2798</td><td class="line">                        EVP_PKEY *pkey = s-&gt;cert-&gt;pkeys[sig_idx].privatekey;</td></tr>
<tr class="codeline" data-linenumber="2799"><td class="num" id="LN2799">2799</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2800"><td class="num" id="LN2800">2800</td><td class="line">                        <span class='keyword'>if</span> (!rsa_pss_check_min_key_size(EVP_PKEY_get0(pkey), lu))</td></tr>
<tr class="codeline" data-linenumber="2801"><td class="num" id="LN2801">2801</td><td class="line">                            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2802"><td class="num" id="LN2802">2802</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="2803"><td class="num" id="LN2803">2803</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_EC</span></td></tr>
<tr class="codeline" data-linenumber="2804"><td class="num" id="LN2804">2804</td><td class="line">                    <span class='keyword'>if</span> (curve == -1 || lu-&gt;curve == curve)</td></tr>
<tr class="codeline" data-linenumber="2805"><td class="num" id="LN2805">2805</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2806"><td class="num" id="LN2806">2806</td><td class="line">                        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2807"><td class="num" id="LN2807">2807</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2808"><td class="num" id="LN2808">2808</td><td class="line"><span class='directive'>#ifndef OPENSSL_NO_GOST</span></td></tr>
<tr class="codeline" data-linenumber="2809"><td class="num" id="LN2809">2809</td><td class="line">                <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2810"><td class="num" id="LN2810">2810</td><td class="line">                 <span class='comment'>* Some Windows-based implementations do not send GOST algorithms indication</span></td></tr>
<tr class="codeline" data-linenumber="2811"><td class="num" id="LN2811">2811</td><td class="line">                 <span class='comment'>* in supported_algorithms extension, so when we have GOST-based ciphersuite,</span></td></tr>
<tr class="codeline" data-linenumber="2812"><td class="num" id="LN2812">2812</td><td class="line">                 <span class='comment'>* we have to assume GOST support.</span></td></tr>
<tr class="codeline" data-linenumber="2813"><td class="num" id="LN2813">2813</td><td class="line">                 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2814"><td class="num" id="LN2814">2814</td><td class="line">                <span class='keyword'>if</span> (i == s-&gt;shared_sigalgslen &amp;&amp; s-&gt;s3-&gt;tmp.new_cipher-&gt;algorithm_auth &amp; (<span class='macro'>SSL_aGOST01<span class='macro_popup'>0x00000020U</span></span> | <span class='macro'>SSL_aGOST12<span class='macro_popup'>0x00000080U</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="2815"><td class="num" id="LN2815">2815</td><td class="line">                  <span class='keyword'>if</span> ((lu = tls1_get_legacy_sigalg(s, -1)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2816"><td class="num" id="LN2816">2816</td><td class="line">                    <span class='keyword'>if</span> (!fatalerrs)</td></tr>
<tr class="codeline" data-linenumber="2817"><td class="num" id="LN2817">2817</td><td class="line">                      <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2818"><td class="num" id="LN2818">2818</td><td class="line">                    <span class='macro'>SSLfatal(s, SSL_AD_HANDSHAKE_FAILURE,<span class='macro_popup'>ossl_statem_fatal((s), (40), (513), (118), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 2820)</span></span></td></tr>
<tr class="codeline" data-linenumber="2819"><td class="num" id="LN2819">2819</td><td class="line">                             <span class='macro'>SSL_F_TLS_CHOOSE_SIGALG,<span class='macro_popup'>ossl_statem_fatal((s), (40), (513), (118), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 2820)</span></span></td></tr>
<tr class="codeline" data-linenumber="2820"><td class="num" id="LN2820">2820</td><td class="line">                             <span class='macro'>SSL_R_NO_SUITABLE_SIGNATURE_ALGORITHM)<span class='macro_popup'>ossl_statem_fatal((s), (40), (513), (118), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 2820)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2821"><td class="num" id="LN2821">2821</td><td class="line">                    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2822"><td class="num" id="LN2822">2822</td><td class="line">                  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2823"><td class="num" id="LN2823">2823</td><td class="line">                    i = 0;</td></tr>
<tr class="codeline" data-linenumber="2824"><td class="num" id="LN2824">2824</td><td class="line">                    sig_idx = lu-&gt;sig_idx;</td></tr>
<tr class="codeline" data-linenumber="2825"><td class="num" id="LN2825">2825</td><td class="line">                  }</td></tr>
<tr class="codeline" data-linenumber="2826"><td class="num" id="LN2826">2826</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2827"><td class="num" id="LN2827">2827</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2828"><td class="num" id="LN2828">2828</td><td class="line">                <span class='keyword'>if</span> (i == s-&gt;shared_sigalgslen) {</td></tr>
<tr class="codeline" data-linenumber="2829"><td class="num" id="LN2829">2829</td><td class="line">                    <span class='keyword'>if</span> (!fatalerrs)</td></tr>
<tr class="codeline" data-linenumber="2830"><td class="num" id="LN2830">2830</td><td class="line">                        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2831"><td class="num" id="LN2831">2831</td><td class="line">                    <span class='macro'>SSLfatal(s, SSL_AD_HANDSHAKE_FAILURE,<span class='macro_popup'>ossl_statem_fatal((s), (40), (513), (118), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 2833)</span></span></td></tr>
<tr class="codeline" data-linenumber="2832"><td class="num" id="LN2832">2832</td><td class="line">                             <span class='macro'>SSL_F_TLS_CHOOSE_SIGALG,<span class='macro_popup'>ossl_statem_fatal((s), (40), (513), (118), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 2833)</span></span></td></tr>
<tr class="codeline" data-linenumber="2833"><td class="num" id="LN2833">2833</td><td class="line">                             <span class='macro'>SSL_R_NO_SUITABLE_SIGNATURE_ALGORITHM)<span class='macro_popup'>ossl_statem_fatal((s), (40), (513), (118), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 2833)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2834"><td class="num" id="LN2834">2834</td><td class="line">                    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2835"><td class="num" id="LN2835">2835</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2836"><td class="num" id="LN2836">2836</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2837"><td class="num" id="LN2837">2837</td><td class="line">                <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2838"><td class="num" id="LN2838">2838</td><td class="line">                 <span class='comment'>* If we have no sigalg use defaults</span></td></tr>
<tr class="codeline" data-linenumber="2839"><td class="num" id="LN2839">2839</td><td class="line">                 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2840"><td class="num" id="LN2840">2840</td><td class="line">                <span class='keyword'>const</span> uint16_t *sent_sigs;</td></tr>
<tr class="codeline" data-linenumber="2841"><td class="num" id="LN2841">2841</td><td class="line">                size_t sent_sigslen;</td></tr>
<tr class="codeline" data-linenumber="2842"><td class="num" id="LN2842">2842</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2843"><td class="num" id="LN2843">2843</td><td class="line">                <span class='keyword'>if</span> ((lu = tls1_get_legacy_sigalg(s, -1)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2844"><td class="num" id="LN2844">2844</td><td class="line">                    <span class='keyword'>if</span> (!fatalerrs)</td></tr>
<tr class="codeline" data-linenumber="2845"><td class="num" id="LN2845">2845</td><td class="line">                        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2846"><td class="num" id="LN2846">2846</td><td class="line">                    <span class='macro'>SSLfatal(s, SSL_AD_INTERNAL_ERROR, SSL_F_TLS_CHOOSE_SIGALG,<span class='macro_popup'>ossl_statem_fatal((s), (80), (513), ((4|64)), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 2847)</span></span></td></tr>
<tr class="codeline" data-linenumber="2847"><td class="num" id="LN2847">2847</td><td class="line">                             <span class='macro'>ERR_R_INTERNAL_ERROR)<span class='macro_popup'>ossl_statem_fatal((s), (80), (513), ((4|64)), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 2847)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2848"><td class="num" id="LN2848">2848</td><td class="line">                    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2849"><td class="num" id="LN2849">2849</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2850"><td class="num" id="LN2850">2850</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2851"><td class="num" id="LN2851">2851</td><td class="line">                <span class='comment'>/* Check signature matches a type we sent */</span></td></tr>
<tr class="codeline" data-linenumber="2852"><td class="num" id="LN2852">2852</td><td class="line">                sent_sigslen = tls12_get_psigalgs(s, 1, &amp;sent_sigs);</td></tr>
<tr class="codeline" data-linenumber="2853"><td class="num" id="LN2853">2853</td><td class="line">                <span class='keyword'>for</span> (i = 0; i &lt; sent_sigslen; i++, sent_sigs++) {</td></tr>
<tr class="codeline" data-linenumber="2854"><td class="num" id="LN2854">2854</td><td class="line">                    <span class='keyword'>if</span> (lu-&gt;sigalg == *sent_sigs</td></tr>
<tr class="codeline" data-linenumber="2855"><td class="num" id="LN2855">2855</td><td class="line">                            &amp;&amp; has_usable_cert(s, lu, lu-&gt;sig_idx))</td></tr>
<tr class="codeline" data-linenumber="2856"><td class="num" id="LN2856">2856</td><td class="line">                        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2857"><td class="num" id="LN2857">2857</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2858"><td class="num" id="LN2858">2858</td><td class="line">                <span class='keyword'>if</span> (i == sent_sigslen) {</td></tr>
<tr class="codeline" data-linenumber="2859"><td class="num" id="LN2859">2859</td><td class="line">                    <span class='keyword'>if</span> (!fatalerrs)</td></tr>
<tr class="codeline" data-linenumber="2860"><td class="num" id="LN2860">2860</td><td class="line">                        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2861"><td class="num" id="LN2861">2861</td><td class="line">                    <span class='macro'>SSLfatal(s, SSL_AD_ILLEGAL_PARAMETER,<span class='macro_popup'>ossl_statem_fatal((s), (47), (513), (370), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 2863)</span></span></td></tr>
<tr class="codeline" data-linenumber="2862"><td class="num" id="LN2862">2862</td><td class="line">                             <span class='macro'>SSL_F_TLS_CHOOSE_SIGALG,<span class='macro_popup'>ossl_statem_fatal((s), (47), (513), (370), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 2863)</span></span></td></tr>
<tr class="codeline" data-linenumber="2863"><td class="num" id="LN2863">2863</td><td class="line">                             <span class='macro'>SSL_R_WRONG_SIGNATURE_TYPE)<span class='macro_popup'>ossl_statem_fatal((s), (47), (513), (370), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 2863)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2864"><td class="num" id="LN2864">2864</td><td class="line">                    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2865"><td class="num" id="LN2865">2865</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2866"><td class="num" id="LN2866">2866</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2867"><td class="num" id="LN2867">2867</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2868"><td class="num" id="LN2868">2868</td><td class="line">            <span class='keyword'>if</span> ((lu = tls1_get_legacy_sigalg(s, -1)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2869"><td class="num" id="LN2869">2869</td><td class="line">                <span class='keyword'>if</span> (!fatalerrs)</td></tr>
<tr class="codeline" data-linenumber="2870"><td class="num" id="LN2870">2870</td><td class="line">                    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2871"><td class="num" id="LN2871">2871</td><td class="line">                <span class='macro'>SSLfatal(s, SSL_AD_INTERNAL_ERROR, SSL_F_TLS_CHOOSE_SIGALG,<span class='macro_popup'>ossl_statem_fatal((s), (80), (513), ((4|64)), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 2872)</span></span></td></tr>
<tr class="codeline" data-linenumber="2872"><td class="num" id="LN2872">2872</td><td class="line">                         <span class='macro'>ERR_R_INTERNAL_ERROR)<span class='macro_popup'>ossl_statem_fatal((s), (80), (513), ((4|64)), "../deps/openssl/openssl/ssl/t1_lib.c"<br>, 2872)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2873"><td class="num" id="LN2873">2873</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2874"><td class="num" id="LN2874">2874</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2875"><td class="num" id="LN2875">2875</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2876"><td class="num" id="LN2876">2876</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2877"><td class="num" id="LN2877">2877</td><td class="line">    <span class='keyword'>if</span> (sig_idx == -1)</td></tr>
<tr class="codeline" data-linenumber="2878"><td class="num" id="LN2878">2878</td><td class="line">        sig_idx = lu-&gt;sig_idx;</td></tr>
<tr class="codeline" data-linenumber="2879"><td class="num" id="LN2879">2879</td><td class="line">    s-&gt;s3-&gt;tmp.cert = &amp;s-&gt;cert-&gt;pkeys[sig_idx];</td></tr>
<tr class="codeline" data-linenumber="2880"><td class="num" id="LN2880">2880</td><td class="line">    s-&gt;cert-&gt;key = s-&gt;s3-&gt;tmp.cert;</td></tr>
<tr class="codeline" data-linenumber="2881"><td class="num" id="LN2881">2881</td><td class="line">    s-&gt;s3-&gt;tmp.sigalg = lu;</td></tr>
<tr class="codeline" data-linenumber="2882"><td class="num" id="LN2882">2882</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2883"><td class="num" id="LN2883">2883</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2884"><td class="num" id="LN2884">2884</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2885"><td class="num" id="LN2885">2885</td><td class="line"><span class='keyword'>int</span> SSL_CTX_set_tlsext_max_fragment_length(SSL_CTX *ctx, uint8_t mode)</td></tr>
<tr class="codeline" data-linenumber="2886"><td class="num" id="LN2886">2886</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2887"><td class="num" id="LN2887">2887</td><td class="line">    <span class='keyword'>if</span> (mode != <span class='macro'>TLSEXT_max_fragment_length_DISABLED<span class='macro_popup'>0</span></span></td></tr>
<tr class="codeline" data-linenumber="2888"><td class="num" id="LN2888">2888</td><td class="line">            &amp;&amp; !<span class='macro'>IS_MAX_FRAGMENT_LENGTH_EXT_VALID(mode)<span class='macro_popup'>(((mode) &gt;= 1) &amp;&amp; ((mode) &lt;= 4))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2889"><td class="num" id="LN2889">2889</td><td class="line">        <span class='macro'>SSLerr(SSL_F_SSL_CTX_SET_TLSEXT_MAX_FRAGMENT_LENGTH,<span class='macro_popup'>ERR_put_error(20,(551),(232),"../deps/openssl/openssl/ssl/t1_lib.c"<br>,2890)</span></span></td></tr>
<tr class="codeline" data-linenumber="2890"><td class="num" id="LN2890">2890</td><td class="line">               <span class='macro'>SSL_R_SSL3_EXT_INVALID_MAX_FRAGMENT_LENGTH)<span class='macro_popup'>ERR_put_error(20,(551),(232),"../deps/openssl/openssl/ssl/t1_lib.c"<br>,2890)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2891"><td class="num" id="LN2891">2891</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2892"><td class="num" id="LN2892">2892</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2893"><td class="num" id="LN2893">2893</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2894"><td class="num" id="LN2894">2894</td><td class="line">    ctx-&gt;ext.max_fragment_len_mode = mode;</td></tr>
<tr class="codeline" data-linenumber="2895"><td class="num" id="LN2895">2895</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2896"><td class="num" id="LN2896">2896</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2897"><td class="num" id="LN2897">2897</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2898"><td class="num" id="LN2898">2898</td><td class="line"><span class='keyword'>int</span> SSL_set_tlsext_max_fragment_length(SSL *ssl, uint8_t mode)</td></tr>
<tr class="codeline" data-linenumber="2899"><td class="num" id="LN2899">2899</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2900"><td class="num" id="LN2900">2900</td><td class="line">    <span class='keyword'>if</span> (mode != <span class='macro'>TLSEXT_max_fragment_length_DISABLED<span class='macro_popup'>0</span></span></td></tr>
<tr class="codeline" data-linenumber="2901"><td class="num" id="LN2901">2901</td><td class="line">            &amp;&amp; !<span class='macro'>IS_MAX_FRAGMENT_LENGTH_EXT_VALID(mode)<span class='macro_popup'>(((mode) &gt;= 1) &amp;&amp; ((mode) &lt;= 4))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2902"><td class="num" id="LN2902">2902</td><td class="line">        <span class='macro'>SSLerr(SSL_F_SSL_SET_TLSEXT_MAX_FRAGMENT_LENGTH,<span class='macro_popup'>ERR_put_error(20,(550),(232),"../deps/openssl/openssl/ssl/t1_lib.c"<br>,2903)</span></span></td></tr>
<tr class="codeline" data-linenumber="2903"><td class="num" id="LN2903">2903</td><td class="line">               <span class='macro'>SSL_R_SSL3_EXT_INVALID_MAX_FRAGMENT_LENGTH)<span class='macro_popup'>ERR_put_error(20,(550),(232),"../deps/openssl/openssl/ssl/t1_lib.c"<br>,2903)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2904"><td class="num" id="LN2904">2904</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2905"><td class="num" id="LN2905">2905</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2906"><td class="num" id="LN2906">2906</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2907"><td class="num" id="LN2907">2907</td><td class="line">    ssl-&gt;ext.max_fragment_len_mode = mode;</td></tr>
<tr class="codeline" data-linenumber="2908"><td class="num" id="LN2908">2908</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2909"><td class="num" id="LN2909">2909</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2910"><td class="num" id="LN2910">2910</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2911"><td class="num" id="LN2911">2911</td><td class="line">uint8_t SSL_SESSION_get_max_fragment_length(<span class='keyword'>const</span> SSL_SESSION *session)</td></tr>
<tr class="codeline" data-linenumber="2912"><td class="num" id="LN2912">2912</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2913"><td class="num" id="LN2913">2913</td><td class="line">    <span class='keyword'>return</span> session-&gt;ext.max_fragment_len_mode;</td></tr>
<tr class="codeline" data-linenumber="2914"><td class="num" id="LN2914">2914</td><td class="line">}</td></tr>
</table></body></html>
