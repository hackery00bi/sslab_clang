<!doctype html>
<html>
<head>
<title>lib_jit.c</title>

<style type="text/css">
body { color:#000000; background-color:#ffffff }
body { font-family:Helvetica, sans-serif; font-size:10pt }
h1 { font-size:14pt }
.FileName { margin-top: 5px; margin-bottom: 5px; display: inline; }
.FileNav { margin-left: 5px; margin-right: 5px; display: inline; }
.FileNav a { text-decoration:none; font-size: larger; }
.divider { margin-top: 30px; margin-bottom: 30px; height: 15px; }
.divider { background-color: gray; }
.code { border-collapse:collapse; width:100%; }
.code { font-family: "Monospace", monospace; font-size:10pt }
.code { line-height: 1.2em }
.comment { color: green; font-style: oblique }
.keyword { color: blue }
.string_literal { color: red }
.directive { color: darkmagenta }

/* Macros and variables could have pop-up notes hidden by default.
  - Macro pop-up:    expansion of the macro
  - Variable pop-up: value (table) of the variable */
.macro_popup, .variable_popup { display: none; }

/* Pop-up appears on mouse-hover event. */
.macro:hover .macro_popup, .variable:hover .variable_popup {
  display: block;
  padding: 2px;
  -webkit-border-radius:5px;
  -webkit-box-shadow:1px 1px 7px #000;
  border-radius:5px;
  box-shadow:1px 1px 7px #000;
  position: absolute;
  top: -1em;
  left:10em;
  z-index: 1
}

.macro_popup {
  border: 2px solid red;
  background-color:#FFF0F0;
  font-weight: normal;
}

.variable_popup {
  border: 2px solid blue;
  background-color:#F0F0FF;
  font-weight: bold;
  font-family: Helvetica, sans-serif;
  font-size: 9pt;
}

/* Pop-up notes needs a relative position as a base where they pops up. */
.macro, .variable {
  background-color: PaleGoldenRod;
  position: relative;
}
.macro { color: DarkMagenta; }

#tooltiphint {
  position: fixed;
  width: 50em;
  margin-left: -25em;
  left: 50%;
  padding: 10px;
  border: 1px solid #b0b0b0;
  border-radius: 2px;
  box-shadow: 1px 1px 7px black;
  background-color: #c0c0c0;
  z-index: 2;
}

.num { width:2.5em; padding-right:2ex; background-color:#eeeeee }
.num { text-align:right; font-size:8pt }
.num { color:#444444 }
.line { padding-left: 1ex; border-left: 3px solid #ccc }
.line { white-space: pre }
.msg { -webkit-box-shadow:1px 1px 7px #000 }
.msg { box-shadow:1px 1px 7px #000 }
.msg { -webkit-border-radius:5px }
.msg { border-radius:5px }
.msg { font-family:Helvetica, sans-serif; font-size:8pt }
.msg { float:left }
.msg { padding:0.25em 1ex 0.25em 1ex }
.msg { margin-top:10px; margin-bottom:10px }
.msg { font-weight:bold }
.msg { max-width:60em; word-wrap: break-word; white-space: pre-wrap }
.msgT { padding:0x; spacing:0x }
.msgEvent { background-color:#fff8b4; color:#000000 }
.msgControl { background-color:#bbbbbb; color:#000000 }
.msgNote { background-color:#ddeeff; color:#000000 }
.mrange { background-color:#dfddf3 }
.mrange { border-bottom:1px solid #6F9DBE }
.PathIndex { font-weight: bold; padding:0px 5px; margin-right:5px; }
.PathIndex { -webkit-border-radius:8px }
.PathIndex { border-radius:8px }
.PathIndexEvent { background-color:#bfba87 }
.PathIndexControl { background-color:#8c8c8c }
.PathIndexPopUp { background-color: #879abc; }
.PathNav a { text-decoration:none; font-size: larger }
.CodeInsertionHint { font-weight: bold; background-color: #10dd10 }
.CodeRemovalHint { background-color:#de1010 }
.CodeRemovalHint { border-bottom:1px solid #6F9DBE }
.selected{ background-color:orange !important; }

table.simpletable {
  padding: 5px;
  font-size:12pt;
  margin:20px;
  border-collapse: collapse; border-spacing: 0px;
}
td.rowname {
  text-align: right;
  vertical-align: top;
  font-weight: bold;
  color:#444444;
  padding-right:2ex;
}

/* Hidden text. */
input.spoilerhider + label {
  cursor: pointer;
  text-decoration: underline;
  display: block;
}
input.spoilerhider {
 display: none;
}
input.spoilerhider ~ .spoiler {
  overflow: hidden;
  margin: 10px auto 0;
  height: 0;
  opacity: 0;
}
input.spoilerhider:checked + label + .spoiler{
  height: auto;
  opacity: 1;
}
</style>
</head>
<body>
<!-- BUGDESC Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11 -->

<!-- BUGTYPE Potential insecure memory buffer bounds restriction in call 'memcpy' -->

<!-- BUGCATEGORY Security -->

<!-- BUGFILE /tmp/real/c_wrk/wrk0/obj/LuaJIT-2.0.4/src/lib_jit.c -->

<!-- FILENAME lib_jit.c -->

<!-- FUNCTIONNAME jit_init -->

<!-- ISSUEHASHCONTENTOFLINEINCONTEXT 6a7275ea440cfdbcd9ae8cf1433e7784 -->

<!-- BUGLINE 639 -->

<!-- BUGCOLUMN 3 -->

<!-- BUGPATHLENGTH 1 -->

<!-- BUGMETAEND -->
<!-- REPORTHEADER -->
<h3>Bug Summary</h3>
<table class="simpletable">
<tr><td class="rowname">File:</td><td>src/lib_jit.c</td></tr>
<tr><td class="rowname">Warning:</td><td><a href="#EndPath">line 639, column 3</a><br />Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11</td></tr>

</table>
<!-- REPORTSUMMARYEXTRA -->
<h3>Annotated Source Code</h3>
<p>Press <a href="#" onclick="toggleHelp(); return false;">'?'</a>
   to see keyboard shortcuts</p>
<input type="checkbox" class="spoilerhider" id="showinvocation" />
<label for="showinvocation" >Show analyzer invocation</label>
<div class="spoiler">clang -cc1 -cc1 -triple x86_64-unknown-linux-gnu -analyze -disable-free -main-file-name lib_jit.c -analyzer-store=region -analyzer-opt-analyze-nested-blocks -analyzer-checker=core -analyzer-checker=apiModeling -analyzer-checker=unix -analyzer-checker=deadcode -analyzer-checker=security.insecureAPI.UncheckedReturn -analyzer-checker=security.insecureAPI.getpw -analyzer-checker=security.insecureAPI.gets -analyzer-checker=security.insecureAPI.mktemp -analyzer-checker=security.insecureAPI.mkstemp -analyzer-checker=security.insecureAPI.vfork -analyzer-checker=nullability.NullPassedToNonnull -analyzer-checker=nullability.NullReturnedFromNonnull -analyzer-output plist -w -setup-static-analyzer -mrelocation-model static -mframe-pointer=none -fmath-errno -fno-rounding-math -mconstructor-aliases -munwind-tables -target-cpu x86-64 -fno-split-dwarf-inlining -debugger-tuning=gdb -resource-dir /llvm-project/build/lib/clang/12.0.0 -D _FILE_OFFSET_BITS=64 -D _LARGEFILE_SOURCE -U _FORTIFY_SOURCE -D LUA_ROOT="/tmp/real/c_wrk/wrk0/obj" -D LUA_MULTILIB="lib" -internal-isystem /usr/local/include -internal-isystem /llvm-project/build/lib/clang/12.0.0/include -internal-externc-isystem /usr/include/x86_64-linux-gnu -internal-externc-isystem /include -internal-externc-isystem /usr/include -O2 -fdebug-compilation-dir /tmp/real/c_wrk/wrk0/obj/LuaJIT-2.0.4/src -ferror-limit 19 -fgnuc-version=4.2.1 -vectorize-loops -vectorize-slp -analyzer-checker core -analyzer-checker cplusplus -analyzer-checker nullability -analyzer-checker optin -analyzer-checker security -analyzer-checker unix -analyzer-checker osx -analyzer-checker fuchsia -analyzer-checker webkit -analyzer-output=html -faddrsig -o /tmp/scan-build-2020-11-20-032833-32183-1 -x c lib_jit.c
</div>
<div id='tooltiphint' hidden="true">
  <p>Keyboard shortcuts: </p>
  <ul>
    <li>Use 'j/k' keys for keyboard navigation</li>
    <li>Use 'Shift+S' to show/hide relevant lines</li>
    <li>Use '?' to toggle this window</li>
  </ul>
  <a href="#" onclick="toggleHelp(); return false;">Close</a>
</div>
<script type='text/javascript'>
var relevant_lines = {"1": {"639": 1}};

var filterCounterexample = function (hide) {
  var tables = document.getElementsByClassName("code");
  for (var t=0; t<tables.length; t++) {
    var table = tables[t];
    var file_id = table.getAttribute("data-fileid");
    var lines_in_fid = relevant_lines[file_id];
    if (!lines_in_fid) {
      lines_in_fid = {};
    }
    var lines = table.getElementsByClassName("codeline");
    for (var i=0; i<lines.length; i++) {
        var el = lines[i];
        var lineNo = el.getAttribute("data-linenumber");
        if (!lines_in_fid[lineNo]) {
          if (hide) {
            el.setAttribute("hidden", "");
          } else {
            el.removeAttribute("hidden");
          }
        }
    }
  }
}

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "S") {
    var checked = document.getElementsByName("showCounterexample")[0].checked;
    filterCounterexample(!checked);
    document.getElementsByName("showCounterexample")[0].checked = !checked;
  } else {
    return;
  }
  event.preventDefault();
}, true);

document.addEventListener("DOMContentLoaded", function() {
    document.querySelector('input[name="showCounterexample"]').onchange=
        function (event) {
      filterCounterexample(this.checked);
    };
});
</script>

<form>
    <input type="checkbox" name="showCounterexample" id="showCounterexample" />
    <label for="showCounterexample">
       Show only relevant lines
    </label>
</form>

<script type='text/javascript'>
var digitMatcher = new RegExp("[0-9]+");

var querySelectorAllArray = function(selector) {
  return Array.prototype.slice.call(
    document.querySelectorAll(selector));
}

document.addEventListener("DOMContentLoaded", function() {
    querySelectorAllArray(".PathNav > a").forEach(
        function(currentValue, currentIndex) {
            var hrefValue = currentValue.getAttribute("href");
            currentValue.onclick = function() {
                scrollTo(document.querySelector(hrefValue));
                return false;
            };
        });
});

var findNum = function() {
    var s = document.querySelector(".selected");
    if (!s || s.id == "EndPath") {
        return 0;
    }
    var out = parseInt(digitMatcher.exec(s.id)[0]);
    return out;
};

var scrollTo = function(el) {
    querySelectorAllArray(".selected").forEach(function(s) {
        s.classList.remove("selected");
    });
    el.classList.add("selected");
    window.scrollBy(0, el.getBoundingClientRect().top -
        (window.innerHeight / 2));
}

var move = function(num, up, numItems) {
  if (num == 1 && up || num == numItems - 1 && !up) {
    return 0;
  } else if (num == 0 && up) {
    return numItems - 1;
  } else if (num == 0 && !up) {
    return 1 % numItems;
  }
  return up ? num - 1 : num + 1;
}

var numToId = function(num) {
  if (num == 0) {
    return document.getElementById("EndPath")
  }
  return document.getElementById("Path" + num);
};

var navigateTo = function(up) {
  var numItems = document.querySelectorAll(
      ".line > .msgEvent, .line > .msgControl").length;
  var currentSelected = findNum();
  var newSelected = move(currentSelected, up, numItems);
  var newEl = numToId(newSelected, numItems);

  // Scroll element into center.
  scrollTo(newEl);
};

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "j") {
    navigateTo(/*up=*/false);
  } else if (event.key == "k") {
    navigateTo(/*up=*/true);
  } else {
    return;
  }
  event.preventDefault();
}, true);
</script>
  
<script type='text/javascript'>

var toggleHelp = function() {
    var hint = document.querySelector("#tooltiphint");
    var attributeName = "hidden";
    if (hint.hasAttribute(attributeName)) {
      hint.removeAttribute(attributeName);
    } else {
      hint.setAttribute("hidden", "true");
    }
};
window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "?") {
    toggleHelp();
  } else {
    return;
  }
  event.preventDefault();
});
</script>
<table class="code" data-fileid="1">
<tr class="codeline" data-linenumber="1"><td class="num" id="LN1">1</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2"><td class="num" id="LN2">2</td><td class="line"><span class='comment'>** JIT library.</span></td></tr>
<tr class="codeline" data-linenumber="3"><td class="num" id="LN3">3</td><td class="line"><span class='comment'>** Copyright (C) 2005-2015 Mike Pall. See Copyright Notice in luajit.h</span></td></tr>
<tr class="codeline" data-linenumber="4"><td class="num" id="LN4">4</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="5"><td class="num" id="LN5">5</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="6"><td class="num" id="LN6">6</td><td class="line"><span class='directive'>#define lib_jit_c</span></td></tr>
<tr class="codeline" data-linenumber="7"><td class="num" id="LN7">7</td><td class="line"><span class='directive'>#define LUA_LIB</span></td></tr>
<tr class="codeline" data-linenumber="8"><td class="num" id="LN8">8</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="9"><td class="num" id="LN9">9</td><td class="line"><span class='directive'>#include "lua.h"</span></td></tr>
<tr class="codeline" data-linenumber="10"><td class="num" id="LN10">10</td><td class="line"><span class='directive'>#include "lauxlib.h"</span></td></tr>
<tr class="codeline" data-linenumber="11"><td class="num" id="LN11">11</td><td class="line"><span class='directive'>#include "lualib.h"</span></td></tr>
<tr class="codeline" data-linenumber="12"><td class="num" id="LN12">12</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="13"><td class="num" id="LN13">13</td><td class="line"><span class='directive'>#include "lj_arch.h"</span></td></tr>
<tr class="codeline" data-linenumber="14"><td class="num" id="LN14">14</td><td class="line"><span class='directive'>#include "lj_obj.h"</span></td></tr>
<tr class="codeline" data-linenumber="15"><td class="num" id="LN15">15</td><td class="line"><span class='directive'>#include "lj_err.h"</span></td></tr>
<tr class="codeline" data-linenumber="16"><td class="num" id="LN16">16</td><td class="line"><span class='directive'>#include "lj_debug.h"</span></td></tr>
<tr class="codeline" data-linenumber="17"><td class="num" id="LN17">17</td><td class="line"><span class='directive'>#include "lj_str.h"</span></td></tr>
<tr class="codeline" data-linenumber="18"><td class="num" id="LN18">18</td><td class="line"><span class='directive'>#include "lj_tab.h"</span></td></tr>
<tr class="codeline" data-linenumber="19"><td class="num" id="LN19">19</td><td class="line"><span class='directive'>#include "lj_bc.h"</span></td></tr>
<tr class="codeline" data-linenumber="20"><td class="num" id="LN20">20</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_HASJIT<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="21"><td class="num" id="LN21">21</td><td class="line"><span class='directive'>#include "lj_ir.h"</span></td></tr>
<tr class="codeline" data-linenumber="22"><td class="num" id="LN22">22</td><td class="line"><span class='directive'>#include "lj_jit.h"</span></td></tr>
<tr class="codeline" data-linenumber="23"><td class="num" id="LN23">23</td><td class="line"><span class='directive'>#include "lj_ircall.h"</span></td></tr>
<tr class="codeline" data-linenumber="24"><td class="num" id="LN24">24</td><td class="line"><span class='directive'>#include "lj_iropt.h"</span></td></tr>
<tr class="codeline" data-linenumber="25"><td class="num" id="LN25">25</td><td class="line"><span class='directive'>#include "lj_target.h"</span></td></tr>
<tr class="codeline" data-linenumber="26"><td class="num" id="LN26">26</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="27"><td class="num" id="LN27">27</td><td class="line"><span class='directive'>#include "lj_dispatch.h"</span></td></tr>
<tr class="codeline" data-linenumber="28"><td class="num" id="LN28">28</td><td class="line"><span class='directive'>#include "lj_vm.h"</span></td></tr>
<tr class="codeline" data-linenumber="29"><td class="num" id="LN29">29</td><td class="line"><span class='directive'>#include "lj_vmevent.h"</span></td></tr>
<tr class="codeline" data-linenumber="30"><td class="num" id="LN30">30</td><td class="line"><span class='directive'>#include "lj_lib.h"</span></td></tr>
<tr class="codeline" data-linenumber="31"><td class="num" id="LN31">31</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="32"><td class="num" id="LN32">32</td><td class="line"><span class='directive'>#include "luajit.h"</span></td></tr>
<tr class="codeline" data-linenumber="33"><td class="num" id="LN33">33</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="34"><td class="num" id="LN34">34</td><td class="line"><span class='comment'>/* -- jit.* functions ----------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="35"><td class="num" id="LN35">35</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="36"><td class="num" id="LN36">36</td><td class="line"><span class='directive'>#define LJLIB_MODULE_jit</span></td></tr>
<tr class="codeline" data-linenumber="37"><td class="num" id="LN37">37</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="38"><td class="num" id="LN38">38</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> setjitmode(lua_State *L, <span class='keyword'>int</span> mode)</td></tr>
<tr class="codeline" data-linenumber="39"><td class="num" id="LN39">39</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="40"><td class="num" id="LN40">40</td><td class="line">  <span class='keyword'>int</span> idx = 0;</td></tr>
<tr class="codeline" data-linenumber="41"><td class="num" id="LN41">41</td><td class="line">  <span class='keyword'>if</span> (L-&gt;base == L-&gt;top || <span class='macro'>tvisnil(L-&gt;base)<span class='macro_popup'>(((L-&gt;base)-&gt;it) == (~0u))</span></span>) {  <span class='comment'>/* jit.on/off/flush([nil]) */</span></td></tr>
<tr class="codeline" data-linenumber="42"><td class="num" id="LN42">42</td><td class="line">    mode |= LUAJIT_MODE_ENGINE;</td></tr>
<tr class="codeline" data-linenumber="43"><td class="num" id="LN43">43</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="44"><td class="num" id="LN44">44</td><td class="line">    <span class='comment'>/* jit.on/off/flush(func|proto, nil|true|false) */</span></td></tr>
<tr class="codeline" data-linenumber="45"><td class="num" id="LN45">45</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>tvisfunc(L-&gt;base)<span class='macro_popup'>(((L-&gt;base)-&gt;it) == (~8u))</span></span> || <span class='macro'>tvisproto(L-&gt;base)<span class='macro_popup'>(((L-&gt;base)-&gt;it) == (~7u))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="46"><td class="num" id="LN46">46</td><td class="line">      idx = 1;</td></tr>
<tr class="codeline" data-linenumber="47"><td class="num" id="LN47">47</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (!<span class='macro'>tvistrue(L-&gt;base)<span class='macro_popup'>(((L-&gt;base)-&gt;it) == (~2u))</span></span>)  <span class='comment'>/* jit.on/off/flush(true, nil|true|false) */</span></td></tr>
<tr class="codeline" data-linenumber="48"><td class="num" id="LN48">48</td><td class="line">      <span class='keyword'>goto</span> err;</td></tr>
<tr class="codeline" data-linenumber="49"><td class="num" id="LN49">49</td><td class="line">    <span class='keyword'>if</span> (L-&gt;base+1 &lt; L-&gt;top &amp;&amp; <span class='macro'>tvisbool(L-&gt;base+1)<span class='macro_popup'>((((L-&gt;base+1)-&gt;it) == (~1u)) || (((L-&gt;base+1)-&gt;it<br>) == (~2u)))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="50"><td class="num" id="LN50">50</td><td class="line">      mode |= <span class='macro'>boolV(L-&gt;base+1)<span class='macro_popup'>(((void)0), (((~1u) - (L-&gt;base+1)-&gt;it)))</span></span> ? LUAJIT_MODE_ALLFUNC : LUAJIT_MODE_ALLSUBFUNC;</td></tr>
<tr class="codeline" data-linenumber="51"><td class="num" id="LN51">51</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="52"><td class="num" id="LN52">52</td><td class="line">      mode |= LUAJIT_MODE_FUNC;</td></tr>
<tr class="codeline" data-linenumber="53"><td class="num" id="LN53">53</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="54"><td class="num" id="LN54">54</td><td class="line">  <span class='keyword'>if</span> (luaJIT_setmode(L, idx, mode) != 1) {</td></tr>
<tr class="codeline" data-linenumber="55"><td class="num" id="LN55">55</td><td class="line">    <span class='keyword'>if</span> ((mode &amp; <span class='macro'>LUAJIT_MODE_MASK<span class='macro_popup'>0x00ff</span></span>) == LUAJIT_MODE_ENGINE)</td></tr>
<tr class="codeline" data-linenumber="56"><td class="num" id="LN56">56</td><td class="line">      lj_err_caller(L, LJ_ERR_NOJIT);</td></tr>
<tr class="codeline" data-linenumber="57"><td class="num" id="LN57">57</td><td class="line">  err:</td></tr>
<tr class="codeline" data-linenumber="58"><td class="num" id="LN58">58</td><td class="line">    lj_err_argt(L, 1, <span class='macro'>LUA_TFUNCTION<span class='macro_popup'>6</span></span>);</td></tr>
<tr class="codeline" data-linenumber="59"><td class="num" id="LN59">59</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="60"><td class="num" id="LN60">60</td><td class="line">  <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="61"><td class="num" id="LN61">61</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="62"><td class="num" id="LN62">62</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="63"><td class="num" id="LN63">63</td><td class="line"><span class='macro'>LJLIB_CF(jit_on)<span class='macro_popup'>static int lj_cf_jit_on(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="64"><td class="num" id="LN64">64</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="65"><td class="num" id="LN65">65</td><td class="line">  <span class='keyword'>return</span> setjitmode(L, <span class='macro'>LUAJIT_MODE_ON<span class='macro_popup'>0x0100</span></span>);</td></tr>
<tr class="codeline" data-linenumber="66"><td class="num" id="LN66">66</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="67"><td class="num" id="LN67">67</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="68"><td class="num" id="LN68">68</td><td class="line"><span class='macro'>LJLIB_CF(jit_off)<span class='macro_popup'>static int lj_cf_jit_off(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="69"><td class="num" id="LN69">69</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="70"><td class="num" id="LN70">70</td><td class="line">  <span class='keyword'>return</span> setjitmode(L, <span class='macro'>LUAJIT_MODE_OFF<span class='macro_popup'>0x0000</span></span>);</td></tr>
<tr class="codeline" data-linenumber="71"><td class="num" id="LN71">71</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="72"><td class="num" id="LN72">72</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="73"><td class="num" id="LN73">73</td><td class="line"><span class='macro'>LJLIB_CF(jit_flush)<span class='macro_popup'>static int lj_cf_jit_flush(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="74"><td class="num" id="LN74">74</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="75"><td class="num" id="LN75">75</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_HASJIT<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="76"><td class="num" id="LN76">76</td><td class="line">  <span class='keyword'>if</span> (L-&gt;base &lt; L-&gt;top &amp;&amp; <span class='macro'>tvisnumber(L-&gt;base)<span class='macro_popup'>(((L-&gt;base)-&gt;it) &lt;= 0xfffeffffu)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="77"><td class="num" id="LN77">77</td><td class="line">    <span class='keyword'>int</span> traceno = lj_lib_checkint(L, 1);</td></tr>
<tr class="codeline" data-linenumber="78"><td class="num" id="LN78">78</td><td class="line">    luaJIT_setmode(L, traceno, <span class='macro'>LUAJIT_MODE_FLUSH<span class='macro_popup'>0x0200</span></span>|LUAJIT_MODE_TRACE);</td></tr>
<tr class="codeline" data-linenumber="79"><td class="num" id="LN79">79</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="80"><td class="num" id="LN80">80</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="81"><td class="num" id="LN81">81</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="82"><td class="num" id="LN82">82</td><td class="line">  <span class='keyword'>return</span> setjitmode(L, <span class='macro'>LUAJIT_MODE_FLUSH<span class='macro_popup'>0x0200</span></span>);</td></tr>
<tr class="codeline" data-linenumber="83"><td class="num" id="LN83">83</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="84"><td class="num" id="LN84">84</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="85"><td class="num" id="LN85">85</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_HASJIT<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="86"><td class="num" id="LN86">86</td><td class="line"><span class='comment'>/* Push a string for every flag bit that is set. */</span></td></tr>
<tr class="codeline" data-linenumber="87"><td class="num" id="LN87">87</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> flagbits_to_strings(lua_State *L, uint32_t flags, uint32_t base,</td></tr>
<tr class="codeline" data-linenumber="88"><td class="num" id="LN88">88</td><td class="line">				<span class='keyword'>const</span> <span class='keyword'>char</span> *str)</td></tr>
<tr class="codeline" data-linenumber="89"><td class="num" id="LN89">89</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="90"><td class="num" id="LN90">90</td><td class="line">  <span class='keyword'>for</span> (; *str; base &lt;&lt;= 1, str += 1+*str)</td></tr>
<tr class="codeline" data-linenumber="91"><td class="num" id="LN91">91</td><td class="line">    <span class='keyword'>if</span> (flags &amp; base)</td></tr>
<tr class="codeline" data-linenumber="92"><td class="num" id="LN92">92</td><td class="line">      setstrV(L, L-&gt;top++, lj_str_new(L, str+1, *(uint8_t *)str));</td></tr>
<tr class="codeline" data-linenumber="93"><td class="num" id="LN93">93</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="94"><td class="num" id="LN94">94</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="95"><td class="num" id="LN95">95</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="96"><td class="num" id="LN96">96</td><td class="line"><span class='macro'>LJLIB_CF(jit_status)<span class='macro_popup'>static int lj_cf_jit_status(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="97"><td class="num" id="LN97">97</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="98"><td class="num" id="LN98">98</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_HASJIT<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="99"><td class="num" id="LN99">99</td><td class="line">  jit_State *J = <span class='macro'>L2J(L)<span class='macro_popup'>(&amp;(((GG_State *)((char *)((((global_State *)(void *)(uintptr_t<br>)(L-&gt;glref).ptr32))) - ((int)__builtin_offsetof(GG_State, g<br>)))))-&gt;J)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="100"><td class="num" id="LN100">100</td><td class="line">  L-&gt;top = L-&gt;base;</td></tr>
<tr class="codeline" data-linenumber="101"><td class="num" id="LN101">101</td><td class="line">  <span class='macro'>setboolV(L-&gt;top++, (J-&gt;flags &amp; JIT_F_ON) ? 1 : 0)<span class='macro_popup'>((L-&gt;top++)-&gt;it = (~1u)-(uint32_t)((J-&gt;flags &amp; 0x00000001<br>) ? 1 : 0))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="102"><td class="num" id="LN102">102</td><td class="line">  flagbits_to_strings(L, J-&gt;flags, <span class='macro'>JIT_F_CPU_FIRST<span class='macro_popup'>0x00000010</span></span>, <span class='macro'>JIT_F_CPUSTRING<span class='macro_popup'>"\4CMOV\4SSE2\4SSE3\6SSE4.1\2P4\3AMD\2K8\4ATOM"</span></span>);</td></tr>
<tr class="codeline" data-linenumber="103"><td class="num" id="LN103">103</td><td class="line">  flagbits_to_strings(L, J-&gt;flags, <span class='macro'>JIT_F_OPT_FIRST<span class='macro_popup'>0x00010000</span></span>, <span class='macro'>JIT_F_OPTSTRING<span class='macro_popup'>"\4fold\3cse\3dce\3fwd\3dse\6narrow\4loop\3abc\4sink\4fuse"</span></span>);</td></tr>
<tr class="codeline" data-linenumber="104"><td class="num" id="LN104">104</td><td class="line">  <span class='keyword'>return</span> (<span class='keyword'>int</span>)(L-&gt;top - L-&gt;base);</td></tr>
<tr class="codeline" data-linenumber="105"><td class="num" id="LN105">105</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="106"><td class="num" id="LN106">106</td><td class="line">  <span class='macro'>setboolV(L-&gt;top++, 0)<span class='macro_popup'>((L-&gt;top++)-&gt;it = (~1u)-(uint32_t)(0))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="107"><td class="num" id="LN107">107</td><td class="line">  <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="108"><td class="num" id="LN108">108</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="109"><td class="num" id="LN109">109</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="110"><td class="num" id="LN110">110</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="111"><td class="num" id="LN111">111</td><td class="line"><span class='macro'>LJLIB_CF(jit_attach)<span class='macro_popup'>static int lj_cf_jit_attach(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="112"><td class="num" id="LN112">112</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="113"><td class="num" id="LN113">113</td><td class="line"><span class='directive'>#ifdef LUAJIT_DISABLE_VMEVENT</span></td></tr>
<tr class="codeline" data-linenumber="114"><td class="num" id="LN114">114</td><td class="line">  luaL_error(L, <span class='string_literal'>"vmevent API disabled"</span>);</td></tr>
<tr class="codeline" data-linenumber="115"><td class="num" id="LN115">115</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="116"><td class="num" id="LN116">116</td><td class="line">  GCfunc *fn = lj_lib_checkfunc(L, 1);</td></tr>
<tr class="codeline" data-linenumber="117"><td class="num" id="LN117">117</td><td class="line">  GCstr *s = lj_lib_optstr(L, 2);</td></tr>
<tr class="codeline" data-linenumber="118"><td class="num" id="LN118">118</td><td class="line">  luaL_findtable(L, <span class='macro'>LUA_REGISTRYINDEX<span class='macro_popup'>(-10000)</span></span>, <span class='macro'>LJ_VMEVENTS_REGKEY<span class='macro_popup'>"_VMEVENTS"</span></span>, <span class='macro'>LJ_VMEVENTS_HSIZE<span class='macro_popup'>4</span></span>);</td></tr>
<tr class="codeline" data-linenumber="119"><td class="num" id="LN119">119</td><td class="line">  <span class='keyword'>if</span> (s) {  <span class='comment'>/* Attach to given event. */</span></td></tr>
<tr class="codeline" data-linenumber="120"><td class="num" id="LN120">120</td><td class="line">    <span class='keyword'>const</span> uint8_t *p = (<span class='keyword'>const</span> uint8_t *)<span class='macro'>strdata(s)<span class='macro_popup'>((const char *)((s)+1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="121"><td class="num" id="LN121">121</td><td class="line">    uint32_t h = s-&gt;len;</td></tr>
<tr class="codeline" data-linenumber="122"><td class="num" id="LN122">122</td><td class="line">    <span class='keyword'>while</span> (*p) h = h ^ (<span class='macro'>lj_rol(h, 6)<span class='macro_popup'>(((h)&lt;&lt;(6)) | ((h)&gt;&gt;(-(int)(6)&amp;(8*sizeof(h)-1<br>))))</span></span> + *p++);</td></tr>
<tr class="codeline" data-linenumber="123"><td class="num" id="LN123">123</td><td class="line">    lua_pushvalue(L, 1);</td></tr>
<tr class="codeline" data-linenumber="124"><td class="num" id="LN124">124</td><td class="line">    lua_rawseti(L, -2, <span class='macro'>VMEVENT_HASHIDX(h)<span class='macro_popup'>((int)(h) &lt;&lt; 3)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="125"><td class="num" id="LN125">125</td><td class="line">    <span class='macro'>G(L)<span class='macro_popup'>(((global_State *)(void *)(uintptr_t)(L-&gt;glref).ptr32))</span></span>-&gt;vmevmask = <span class='macro'>VMEVENT_NOCACHE<span class='macro_popup'>255</span></span>;  <span class='comment'>/* Invalidate cache. */</span></td></tr>
<tr class="codeline" data-linenumber="126"><td class="num" id="LN126">126</td><td class="line">  } <span class='keyword'>else</span> {  <span class='comment'>/* Detach if no event given. */</span></td></tr>
<tr class="codeline" data-linenumber="127"><td class="num" id="LN127">127</td><td class="line">    <span class='macro'>setnilV(L-&gt;top++)<span class='macro_popup'>((L-&gt;top++)-&gt;it = (~0u))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="128"><td class="num" id="LN128">128</td><td class="line">    <span class='keyword'>while</span> (lua_next(L, -2)) {</td></tr>
<tr class="codeline" data-linenumber="129"><td class="num" id="LN129">129</td><td class="line">      L-&gt;top--;</td></tr>
<tr class="codeline" data-linenumber="130"><td class="num" id="LN130">130</td><td class="line">      <span class='keyword'>if</span> (<span class='macro'>tvisfunc(L-&gt;top)<span class='macro_popup'>(((L-&gt;top)-&gt;it) == (~8u))</span></span> &amp;&amp; <span class='macro'>funcV(L-&gt;top)<span class='macro_popup'>(((void)0), (&amp;(((GCobj *)(uintptr_t)((L-&gt;top)-&gt;gcr)<br>.gcptr32))-&gt;fn))</span></span> == fn) {</td></tr>
<tr class="codeline" data-linenumber="131"><td class="num" id="LN131">131</td><td class="line">	<span class='macro'>setnilV(lj_tab_set(L, tabV(L-&gt;top-2), L-&gt;top-1))<span class='macro_popup'>((lj_tab_set(L, (((void)0), (&amp;(((GCobj *)(uintptr_t)((L-&gt;<br>top-2)-&gt;gcr).gcptr32))-&gt;tab)), L-&gt;top-1))-&gt;it = (<br>~0u))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="132"><td class="num" id="LN132">132</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="133"><td class="num" id="LN133">133</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="134"><td class="num" id="LN134">134</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="135"><td class="num" id="LN135">135</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="136"><td class="num" id="LN136">136</td><td class="line">  <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="137"><td class="num" id="LN137">137</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="138"><td class="num" id="LN138">138</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="139"><td class="num" id="LN139">139</td><td class="line">LJLIB_PUSH(top-5) LJLIB_SET(os)</td></tr>
<tr class="codeline" data-linenumber="140"><td class="num" id="LN140">140</td><td class="line">LJLIB_PUSH(top-4) LJLIB_SET(arch)</td></tr>
<tr class="codeline" data-linenumber="141"><td class="num" id="LN141">141</td><td class="line">LJLIB_PUSH(top-3) LJLIB_SET(version_num)</td></tr>
<tr class="codeline" data-linenumber="142"><td class="num" id="LN142">142</td><td class="line">LJLIB_PUSH(top-2) LJLIB_SET(version)</td></tr>
<tr class="codeline" data-linenumber="143"><td class="num" id="LN143">143</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="144"><td class="num" id="LN144">144</td><td class="line"><span class='directive'>#include "lj_libdef.h"</span></td></tr>
<tr class="codeline" data-linenumber="145"><td class="num" id="LN145">145</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="146"><td class="num" id="LN146">146</td><td class="line"><span class='comment'>/* -- jit.util.* functions ------------------------------------------------ */</span></td></tr>
<tr class="codeline" data-linenumber="147"><td class="num" id="LN147">147</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="148"><td class="num" id="LN148">148</td><td class="line"><span class='directive'>#define LJLIB_MODULE_jit_util</span></td></tr>
<tr class="codeline" data-linenumber="149"><td class="num" id="LN149">149</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="150"><td class="num" id="LN150">150</td><td class="line"><span class='comment'>/* -- Reflection API for Lua functions ------------------------------------ */</span></td></tr>
<tr class="codeline" data-linenumber="151"><td class="num" id="LN151">151</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="152"><td class="num" id="LN152">152</td><td class="line"><span class='comment'>/* Return prototype of first argument (Lua function or prototype object) */</span></td></tr>
<tr class="codeline" data-linenumber="153"><td class="num" id="LN153">153</td><td class="line"><span class='keyword'>static</span> GCproto *check_Lproto(lua_State *L, <span class='keyword'>int</span> nolua)</td></tr>
<tr class="codeline" data-linenumber="154"><td class="num" id="LN154">154</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="155"><td class="num" id="LN155">155</td><td class="line">  TValue *o = L-&gt;base;</td></tr>
<tr class="codeline" data-linenumber="156"><td class="num" id="LN156">156</td><td class="line">  <span class='keyword'>if</span> (L-&gt;top &gt; o) {</td></tr>
<tr class="codeline" data-linenumber="157"><td class="num" id="LN157">157</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>tvisproto(o)<span class='macro_popup'>(((o)-&gt;it) == (~7u))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="158"><td class="num" id="LN158">158</td><td class="line">      <span class='keyword'>return</span> <span class='macro'>protoV(o)<span class='macro_popup'>(((void)0), (&amp;(((GCobj *)(uintptr_t)((o)-&gt;gcr).gcptr32<br>))-&gt;pt))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="159"><td class="num" id="LN159">159</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>tvisfunc(o)<span class='macro_popup'>(((o)-&gt;it) == (~8u))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="160"><td class="num" id="LN160">160</td><td class="line">      <span class='keyword'>if</span> (<span class='macro'>isluafunc(funcV(o))<span class='macro_popup'>(((((void)0), (&amp;(((GCobj *)(uintptr_t)((o)-&gt;gcr).gcptr32<br>))-&gt;fn)))-&gt;c.ffid == 0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="161"><td class="num" id="LN161">161</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>funcproto(funcV(o))<span class='macro_popup'>(((void)0), ((GCproto *)(((char *)(void *)(uintptr_t)(((((void<br>)0), (&amp;(((GCobj *)(uintptr_t)((o)-&gt;gcr).gcptr32))-&gt;<br>fn)))-&gt;l.pc).ptr32)-sizeof(GCproto))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="162"><td class="num" id="LN162">162</td><td class="line">      <span class='keyword'>else</span> <span class='keyword'>if</span> (nolua)</td></tr>
<tr class="codeline" data-linenumber="163"><td class="num" id="LN163">163</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="164"><td class="num" id="LN164">164</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="165"><td class="num" id="LN165">165</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="166"><td class="num" id="LN166">166</td><td class="line">  lj_err_argt(L, 1, <span class='macro'>LUA_TFUNCTION<span class='macro_popup'>6</span></span>);</td></tr>
<tr class="codeline" data-linenumber="167"><td class="num" id="LN167">167</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;  <span class='comment'>/* unreachable */</span></td></tr>
<tr class="codeline" data-linenumber="168"><td class="num" id="LN168">168</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="169"><td class="num" id="LN169">169</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="170"><td class="num" id="LN170">170</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> setintfield(lua_State *L, GCtab *t, <span class='keyword'>const</span> <span class='keyword'>char</span> *name, int32_t val)</td></tr>
<tr class="codeline" data-linenumber="171"><td class="num" id="LN171">171</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="172"><td class="num" id="LN172">172</td><td class="line">  setintV(lj_tab_setstr(L, t, <span class='macro'>lj_str_newz(L, name)<span class='macro_popup'>(lj_str_new(L, name, strlen(name)))</span></span>), val);</td></tr>
<tr class="codeline" data-linenumber="173"><td class="num" id="LN173">173</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="174"><td class="num" id="LN174">174</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="175"><td class="num" id="LN175">175</td><td class="line"><span class='comment'>/* local info = jit.util.funcinfo(func [,pc]) */</span></td></tr>
<tr class="codeline" data-linenumber="176"><td class="num" id="LN176">176</td><td class="line"><span class='macro'>LJLIB_CF(jit_util_funcinfo)<span class='macro_popup'>static int lj_cf_jit_util_funcinfo(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="177"><td class="num" id="LN177">177</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="178"><td class="num" id="LN178">178</td><td class="line">  GCproto *pt = check_Lproto(L, 1);</td></tr>
<tr class="codeline" data-linenumber="179"><td class="num" id="LN179">179</td><td class="line">  <span class='keyword'>if</span> (pt) {</td></tr>
<tr class="codeline" data-linenumber="180"><td class="num" id="LN180">180</td><td class="line">    BCPos pc = (BCPos)lj_lib_optint(L, 2, 0);</td></tr>
<tr class="codeline" data-linenumber="181"><td class="num" id="LN181">181</td><td class="line">    GCtab *t;</td></tr>
<tr class="codeline" data-linenumber="182"><td class="num" id="LN182">182</td><td class="line">    lua_createtable(L, 0, 16);  <span class='comment'>/* Increment hash size if fields are added. */</span></td></tr>
<tr class="codeline" data-linenumber="183"><td class="num" id="LN183">183</td><td class="line">    t = <span class='macro'>tabV(L-&gt;top-1)<span class='macro_popup'>(((void)0), (&amp;(((GCobj *)(uintptr_t)((L-&gt;top-1)-&gt;gcr<br>).gcptr32))-&gt;tab))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="184"><td class="num" id="LN184">184</td><td class="line">    setintfield(L, t, <span class='string_literal'>"linedefined"</span>, pt-&gt;firstline);</td></tr>
<tr class="codeline" data-linenumber="185"><td class="num" id="LN185">185</td><td class="line">    setintfield(L, t, <span class='string_literal'>"lastlinedefined"</span>, pt-&gt;firstline + pt-&gt;numline);</td></tr>
<tr class="codeline" data-linenumber="186"><td class="num" id="LN186">186</td><td class="line">    setintfield(L, t, <span class='string_literal'>"stackslots"</span>, pt-&gt;framesize);</td></tr>
<tr class="codeline" data-linenumber="187"><td class="num" id="LN187">187</td><td class="line">    setintfield(L, t, <span class='string_literal'>"params"</span>, pt-&gt;numparams);</td></tr>
<tr class="codeline" data-linenumber="188"><td class="num" id="LN188">188</td><td class="line">    setintfield(L, t, <span class='string_literal'>"bytecodes"</span>, (int32_t)pt-&gt;sizebc);</td></tr>
<tr class="codeline" data-linenumber="189"><td class="num" id="LN189">189</td><td class="line">    setintfield(L, t, <span class='string_literal'>"gcconsts"</span>, (int32_t)pt-&gt;sizekgc);</td></tr>
<tr class="codeline" data-linenumber="190"><td class="num" id="LN190">190</td><td class="line">    setintfield(L, t, <span class='string_literal'>"nconsts"</span>, (int32_t)pt-&gt;sizekn);</td></tr>
<tr class="codeline" data-linenumber="191"><td class="num" id="LN191">191</td><td class="line">    setintfield(L, t, <span class='string_literal'>"upvalues"</span>, (int32_t)pt-&gt;sizeuv);</td></tr>
<tr class="codeline" data-linenumber="192"><td class="num" id="LN192">192</td><td class="line">    <span class='keyword'>if</span> (pc &lt; pt-&gt;sizebc)</td></tr>
<tr class="codeline" data-linenumber="193"><td class="num" id="LN193">193</td><td class="line">      setintfield(L, t, <span class='string_literal'>"currentline"</span>, lj_debug_line(pt, pc));</td></tr>
<tr class="codeline" data-linenumber="194"><td class="num" id="LN194">194</td><td class="line">    lua_pushboolean(L, (pt-&gt;flags &amp; <span class='macro'>PROTO_VARARG<span class='macro_popup'>0x02</span></span>));</td></tr>
<tr class="codeline" data-linenumber="195"><td class="num" id="LN195">195</td><td class="line">    lua_setfield(L, -2, <span class='string_literal'>"isvararg"</span>);</td></tr>
<tr class="codeline" data-linenumber="196"><td class="num" id="LN196">196</td><td class="line">    lua_pushboolean(L, (pt-&gt;flags &amp; <span class='macro'>PROTO_CHILD<span class='macro_popup'>0x01</span></span>));</td></tr>
<tr class="codeline" data-linenumber="197"><td class="num" id="LN197">197</td><td class="line">    lua_setfield(L, -2, <span class='string_literal'>"children"</span>);</td></tr>
<tr class="codeline" data-linenumber="198"><td class="num" id="LN198">198</td><td class="line">    setstrV(L, L-&gt;top++, <span class='macro'>proto_chunkname(pt)<span class='macro_popup'>((&amp;((GCobj *)(uintptr_t)(((pt)-&gt;chunkname)).gcptr32)-&gt;<br>str))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="199"><td class="num" id="LN199">199</td><td class="line">    lua_setfield(L, -2, <span class='string_literal'>"source"</span>);</td></tr>
<tr class="codeline" data-linenumber="200"><td class="num" id="LN200">200</td><td class="line">    lj_debug_pushloc(L, pt, pc);</td></tr>
<tr class="codeline" data-linenumber="201"><td class="num" id="LN201">201</td><td class="line">    lua_setfield(L, -2, <span class='string_literal'>"loc"</span>);</td></tr>
<tr class="codeline" data-linenumber="202"><td class="num" id="LN202">202</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="203"><td class="num" id="LN203">203</td><td class="line">    GCfunc *fn = <span class='macro'>funcV(L-&gt;base)<span class='macro_popup'>(((void)0), (&amp;(((GCobj *)(uintptr_t)((L-&gt;base)-&gt;gcr<br>).gcptr32))-&gt;fn))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="204"><td class="num" id="LN204">204</td><td class="line">    GCtab *t;</td></tr>
<tr class="codeline" data-linenumber="205"><td class="num" id="LN205">205</td><td class="line">    lua_createtable(L, 0, 4);  <span class='comment'>/* Increment hash size if fields are added. */</span></td></tr>
<tr class="codeline" data-linenumber="206"><td class="num" id="LN206">206</td><td class="line">    t = <span class='macro'>tabV(L-&gt;top-1)<span class='macro_popup'>(((void)0), (&amp;(((GCobj *)(uintptr_t)((L-&gt;top-1)-&gt;gcr<br>).gcptr32))-&gt;tab))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="207"><td class="num" id="LN207">207</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>iscfunc(fn)<span class='macro_popup'>((fn)-&gt;c.ffid == 1)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="208"><td class="num" id="LN208">208</td><td class="line">      setintfield(L, t, <span class='string_literal'>"ffid"</span>, fn-&gt;c.ffid);</td></tr>
<tr class="codeline" data-linenumber="209"><td class="num" id="LN209">209</td><td class="line">    <span class='macro'>setintptrV(lj_tab_setstr(L, t, lj_str_newlit(L, <span class='string_literal'>"addr"</span>)),<span class='macro_popup'>setint64V((lj_tab_setstr(L, t, (lj_str_new(L, "" "addr", sizeof<br>("addr")-1)))), ((intptr_t)(void *)fn-&gt;c.f))</span></span></td></tr>
<tr class="codeline" data-linenumber="210"><td class="num" id="LN210">210</td><td class="line">	       <span class='macro'>(intptr_t)(<span class='keyword'>void</span> *)fn-&gt;c.f)<span class='macro_popup'>setint64V((lj_tab_setstr(L, t, (lj_str_new(L, "" "addr", sizeof<br>("addr")-1)))), ((intptr_t)(void *)fn-&gt;c.f))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="211"><td class="num" id="LN211">211</td><td class="line">    setintfield(L, t, <span class='string_literal'>"upvalues"</span>, fn-&gt;c.nupvalues);</td></tr>
<tr class="codeline" data-linenumber="212"><td class="num" id="LN212">212</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="213"><td class="num" id="LN213">213</td><td class="line">  <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="214"><td class="num" id="LN214">214</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="215"><td class="num" id="LN215">215</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="216"><td class="num" id="LN216">216</td><td class="line"><span class='comment'>/* local ins, m = jit.util.funcbc(func, pc) */</span></td></tr>
<tr class="codeline" data-linenumber="217"><td class="num" id="LN217">217</td><td class="line"><span class='macro'>LJLIB_CF(jit_util_funcbc)<span class='macro_popup'>static int lj_cf_jit_util_funcbc(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="218"><td class="num" id="LN218">218</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="219"><td class="num" id="LN219">219</td><td class="line">  GCproto *pt = check_Lproto(L, 0);</td></tr>
<tr class="codeline" data-linenumber="220"><td class="num" id="LN220">220</td><td class="line">  BCPos pc = (BCPos)lj_lib_checkint(L, 2);</td></tr>
<tr class="codeline" data-linenumber="221"><td class="num" id="LN221">221</td><td class="line">  <span class='keyword'>if</span> (pc &lt; pt-&gt;sizebc) {</td></tr>
<tr class="codeline" data-linenumber="222"><td class="num" id="LN222">222</td><td class="line">    BCIns ins = <span class='macro'>proto_bc(pt)<span class='macro_popup'>((BCIns *)((char *)(pt) + sizeof(GCproto)))</span></span>[pc];</td></tr>
<tr class="codeline" data-linenumber="223"><td class="num" id="LN223">223</td><td class="line">    BCOp op = <span class='macro'>bc_op(ins)<span class='macro_popup'>((BCOp)((ins)&amp;0xff))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="224"><td class="num" id="LN224">224</td><td class="line">    <span class='macro'>lua_assert(op &lt; BC__MAX)<span class='macro_popup'>((void)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="225"><td class="num" id="LN225">225</td><td class="line">    setintV(L-&gt;top, ins);</td></tr>
<tr class="codeline" data-linenumber="226"><td class="num" id="LN226">226</td><td class="line">    setintV(L-&gt;top+1, lj_bc_mode[op]);</td></tr>
<tr class="codeline" data-linenumber="227"><td class="num" id="LN227">227</td><td class="line">    L-&gt;top += 2;</td></tr>
<tr class="codeline" data-linenumber="228"><td class="num" id="LN228">228</td><td class="line">    <span class='keyword'>return</span> 2;</td></tr>
<tr class="codeline" data-linenumber="229"><td class="num" id="LN229">229</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="230"><td class="num" id="LN230">230</td><td class="line">  <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="231"><td class="num" id="LN231">231</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="232"><td class="num" id="LN232">232</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="233"><td class="num" id="LN233">233</td><td class="line"><span class='comment'>/* local k = jit.util.funck(func, idx) */</span></td></tr>
<tr class="codeline" data-linenumber="234"><td class="num" id="LN234">234</td><td class="line"><span class='macro'>LJLIB_CF(jit_util_funck)<span class='macro_popup'>static int lj_cf_jit_util_funck(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="235"><td class="num" id="LN235">235</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="236"><td class="num" id="LN236">236</td><td class="line">  GCproto *pt = check_Lproto(L, 0);</td></tr>
<tr class="codeline" data-linenumber="237"><td class="num" id="LN237">237</td><td class="line">  ptrdiff_t idx = (ptrdiff_t)lj_lib_checkint(L, 2);</td></tr>
<tr class="codeline" data-linenumber="238"><td class="num" id="LN238">238</td><td class="line">  <span class='keyword'>if</span> (idx &gt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="239"><td class="num" id="LN239">239</td><td class="line">    <span class='keyword'>if</span> (idx &lt; (ptrdiff_t)pt-&gt;sizekn) {</td></tr>
<tr class="codeline" data-linenumber="240"><td class="num" id="LN240">240</td><td class="line">      copyTV(L, L-&gt;top-1, <span class='macro'>proto_knumtv(pt, idx)<span class='macro_popup'>(((void)0), (&amp;((TValue *)(void *)(uintptr_t)((pt)-&gt;k).<br>ptr32)[(idx)]))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="241"><td class="num" id="LN241">241</td><td class="line">      <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="242"><td class="num" id="LN242">242</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="243"><td class="num" id="LN243">243</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="244"><td class="num" id="LN244">244</td><td class="line">    <span class='keyword'>if</span> (~idx &lt; (ptrdiff_t)pt-&gt;sizekgc) {</td></tr>
<tr class="codeline" data-linenumber="245"><td class="num" id="LN245">245</td><td class="line">      GCobj *gc = <span class='macro'>proto_kgc(pt, idx)<span class='macro_popup'>(((void)0), (((GCobj *)(uintptr_t)(((GCRef *)(void *)(uintptr_t<br>)((pt)-&gt;k).ptr32)[(idx)]).gcptr32)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="246"><td class="num" id="LN246">246</td><td class="line">      setgcV(L, L-&gt;top-1, gc, ~gc-&gt;gch.gct);</td></tr>
<tr class="codeline" data-linenumber="247"><td class="num" id="LN247">247</td><td class="line">      <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="248"><td class="num" id="LN248">248</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="249"><td class="num" id="LN249">249</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="250"><td class="num" id="LN250">250</td><td class="line">  <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="251"><td class="num" id="LN251">251</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="252"><td class="num" id="LN252">252</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="253"><td class="num" id="LN253">253</td><td class="line"><span class='comment'>/* local name = jit.util.funcuvname(func, idx) */</span></td></tr>
<tr class="codeline" data-linenumber="254"><td class="num" id="LN254">254</td><td class="line"><span class='macro'>LJLIB_CF(jit_util_funcuvname)<span class='macro_popup'>static int lj_cf_jit_util_funcuvname(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="255"><td class="num" id="LN255">255</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="256"><td class="num" id="LN256">256</td><td class="line">  GCproto *pt = check_Lproto(L, 0);</td></tr>
<tr class="codeline" data-linenumber="257"><td class="num" id="LN257">257</td><td class="line">  uint32_t idx = (uint32_t)lj_lib_checkint(L, 2);</td></tr>
<tr class="codeline" data-linenumber="258"><td class="num" id="LN258">258</td><td class="line">  <span class='keyword'>if</span> (idx &lt; pt-&gt;sizeuv) {</td></tr>
<tr class="codeline" data-linenumber="259"><td class="num" id="LN259">259</td><td class="line">    setstrV(L, L-&gt;top-1, <span class='macro'>lj_str_newz(L, lj_debug_uvname(pt, idx))<span class='macro_popup'>(lj_str_new(L, lj_debug_uvname(pt, idx), strlen(lj_debug_uvname<br>(pt, idx))))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="260"><td class="num" id="LN260">260</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="261"><td class="num" id="LN261">261</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="262"><td class="num" id="LN262">262</td><td class="line">  <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="263"><td class="num" id="LN263">263</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="264"><td class="num" id="LN264">264</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="265"><td class="num" id="LN265">265</td><td class="line"><span class='comment'>/* -- Reflection API for traces ------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="266"><td class="num" id="LN266">266</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="267"><td class="num" id="LN267">267</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_HASJIT<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="268"><td class="num" id="LN268">268</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="269"><td class="num" id="LN269">269</td><td class="line"><span class='comment'>/* Check trace argument. Must not throw for non-existent trace numbers. */</span></td></tr>
<tr class="codeline" data-linenumber="270"><td class="num" id="LN270">270</td><td class="line"><span class='keyword'>static</span> GCtrace *jit_checktrace(lua_State *L)</td></tr>
<tr class="codeline" data-linenumber="271"><td class="num" id="LN271">271</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="272"><td class="num" id="LN272">272</td><td class="line">  TraceNo tr = (TraceNo)lj_lib_checkint(L, 1);</td></tr>
<tr class="codeline" data-linenumber="273"><td class="num" id="LN273">273</td><td class="line">  jit_State *J = <span class='macro'>L2J(L)<span class='macro_popup'>(&amp;(((GG_State *)((char *)((((global_State *)(void *)(uintptr_t<br>)(L-&gt;glref).ptr32))) - ((int)__builtin_offsetof(GG_State, g<br>)))))-&gt;J)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="274"><td class="num" id="LN274">274</td><td class="line">  <span class='keyword'>if</span> (tr &gt; 0 &amp;&amp; tr &lt; J-&gt;sizetrace)</td></tr>
<tr class="codeline" data-linenumber="275"><td class="num" id="LN275">275</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>traceref(J, tr)<span class='macro_popup'>(((void)0), ((GCtrace *)((GCobj *)(uintptr_t)(J-&gt;trace[(tr<br>)]).gcptr32)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="276"><td class="num" id="LN276">276</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="277"><td class="num" id="LN277">277</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="278"><td class="num" id="LN278">278</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="279"><td class="num" id="LN279">279</td><td class="line"><span class='comment'>/* Names of link types. ORDER LJ_TRLINK */</span></td></tr>
<tr class="codeline" data-linenumber="280"><td class="num" id="LN280">280</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span> *<span class='keyword'>const</span> jit_trlinkname[] = {</td></tr>
<tr class="codeline" data-linenumber="281"><td class="num" id="LN281">281</td><td class="line">  <span class='string_literal'>"none"</span>, <span class='string_literal'>"root"</span>, <span class='string_literal'>"loop"</span>, <span class='string_literal'>"tail-recursion"</span>, <span class='string_literal'>"up-recursion"</span>, <span class='string_literal'>"down-recursion"</span>,</td></tr>
<tr class="codeline" data-linenumber="282"><td class="num" id="LN282">282</td><td class="line">  <span class='string_literal'>"interpreter"</span>, <span class='string_literal'>"return"</span></td></tr>
<tr class="codeline" data-linenumber="283"><td class="num" id="LN283">283</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="284"><td class="num" id="LN284">284</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="285"><td class="num" id="LN285">285</td><td class="line"><span class='comment'>/* local info = jit.util.traceinfo(tr) */</span></td></tr>
<tr class="codeline" data-linenumber="286"><td class="num" id="LN286">286</td><td class="line"><span class='macro'>LJLIB_CF(jit_util_traceinfo)<span class='macro_popup'>static int lj_cf_jit_util_traceinfo(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="287"><td class="num" id="LN287">287</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="288"><td class="num" id="LN288">288</td><td class="line">  GCtrace *T = jit_checktrace(L);</td></tr>
<tr class="codeline" data-linenumber="289"><td class="num" id="LN289">289</td><td class="line">  <span class='keyword'>if</span> (T) {</td></tr>
<tr class="codeline" data-linenumber="290"><td class="num" id="LN290">290</td><td class="line">    GCtab *t;</td></tr>
<tr class="codeline" data-linenumber="291"><td class="num" id="LN291">291</td><td class="line">    lua_createtable(L, 0, 8);  <span class='comment'>/* Increment hash size if fields are added. */</span></td></tr>
<tr class="codeline" data-linenumber="292"><td class="num" id="LN292">292</td><td class="line">    t = <span class='macro'>tabV(L-&gt;top-1)<span class='macro_popup'>(((void)0), (&amp;(((GCobj *)(uintptr_t)((L-&gt;top-1)-&gt;gcr<br>).gcptr32))-&gt;tab))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="293"><td class="num" id="LN293">293</td><td class="line">    setintfield(L, t, <span class='string_literal'>"nins"</span>, (int32_t)T-&gt;nins - REF_BIAS - 1);</td></tr>
<tr class="codeline" data-linenumber="294"><td class="num" id="LN294">294</td><td class="line">    setintfield(L, t, <span class='string_literal'>"nk"</span>, REF_BIAS - (int32_t)T-&gt;nk);</td></tr>
<tr class="codeline" data-linenumber="295"><td class="num" id="LN295">295</td><td class="line">    setintfield(L, t, <span class='string_literal'>"link"</span>, T-&gt;link);</td></tr>
<tr class="codeline" data-linenumber="296"><td class="num" id="LN296">296</td><td class="line">    setintfield(L, t, <span class='string_literal'>"nexit"</span>, T-&gt;nsnap);</td></tr>
<tr class="codeline" data-linenumber="297"><td class="num" id="LN297">297</td><td class="line">    setstrV(L, L-&gt;top++, <span class='macro'>lj_str_newz(L, jit_trlinkname[T-&gt;linktype])<span class='macro_popup'>(lj_str_new(L, jit_trlinkname[T-&gt;linktype], strlen(jit_trlinkname<br>[T-&gt;linktype])))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="298"><td class="num" id="LN298">298</td><td class="line">    lua_setfield(L, -2, <span class='string_literal'>"linktype"</span>);</td></tr>
<tr class="codeline" data-linenumber="299"><td class="num" id="LN299">299</td><td class="line">    <span class='comment'>/* There are many more fields. Add them only when needed. */</span></td></tr>
<tr class="codeline" data-linenumber="300"><td class="num" id="LN300">300</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="301"><td class="num" id="LN301">301</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="302"><td class="num" id="LN302">302</td><td class="line">  <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="303"><td class="num" id="LN303">303</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="304"><td class="num" id="LN304">304</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="305"><td class="num" id="LN305">305</td><td class="line"><span class='comment'>/* local m, ot, op1, op2, prev = jit.util.traceir(tr, idx) */</span></td></tr>
<tr class="codeline" data-linenumber="306"><td class="num" id="LN306">306</td><td class="line"><span class='macro'>LJLIB_CF(jit_util_traceir)<span class='macro_popup'>static int lj_cf_jit_util_traceir(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="307"><td class="num" id="LN307">307</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="308"><td class="num" id="LN308">308</td><td class="line">  GCtrace *T = jit_checktrace(L);</td></tr>
<tr class="codeline" data-linenumber="309"><td class="num" id="LN309">309</td><td class="line">  IRRef ref = (IRRef)lj_lib_checkint(L, 2) + REF_BIAS;</td></tr>
<tr class="codeline" data-linenumber="310"><td class="num" id="LN310">310</td><td class="line">  <span class='keyword'>if</span> (T &amp;&amp; ref &gt;= REF_BIAS &amp;&amp; ref &lt; T-&gt;nins) {</td></tr>
<tr class="codeline" data-linenumber="311"><td class="num" id="LN311">311</td><td class="line">    IRIns *ir = &amp;T-&gt;ir[ref];</td></tr>
<tr class="codeline" data-linenumber="312"><td class="num" id="LN312">312</td><td class="line">    int32_t m = lj_ir_mode[ir-&gt;o];</td></tr>
<tr class="codeline" data-linenumber="313"><td class="num" id="LN313">313</td><td class="line">    setintV(L-&gt;top-2, m);</td></tr>
<tr class="codeline" data-linenumber="314"><td class="num" id="LN314">314</td><td class="line">    setintV(L-&gt;top-1, ir-&gt;ot);</td></tr>
<tr class="codeline" data-linenumber="315"><td class="num" id="LN315">315</td><td class="line">    setintV(L-&gt;top++, (int32_t)ir-&gt;op1 - (<span class='macro'>irm_op1(m)<span class='macro_popup'>((IRMode)((m)&amp;3))</span></span>==IRMref ? REF_BIAS : 0));</td></tr>
<tr class="codeline" data-linenumber="316"><td class="num" id="LN316">316</td><td class="line">    setintV(L-&gt;top++, (int32_t)ir-&gt;op2 - (<span class='macro'>irm_op2(m)<span class='macro_popup'>((IRMode)(((m)&gt;&gt;2)&amp;3))</span></span>==IRMref ? REF_BIAS : 0));</td></tr>
<tr class="codeline" data-linenumber="317"><td class="num" id="LN317">317</td><td class="line">    setintV(L-&gt;top++, ir-&gt;prev);</td></tr>
<tr class="codeline" data-linenumber="318"><td class="num" id="LN318">318</td><td class="line">    <span class='keyword'>return</span> 5;</td></tr>
<tr class="codeline" data-linenumber="319"><td class="num" id="LN319">319</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="320"><td class="num" id="LN320">320</td><td class="line">  <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="321"><td class="num" id="LN321">321</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="322"><td class="num" id="LN322">322</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="323"><td class="num" id="LN323">323</td><td class="line"><span class='comment'>/* local k, t [, slot] = jit.util.tracek(tr, idx) */</span></td></tr>
<tr class="codeline" data-linenumber="324"><td class="num" id="LN324">324</td><td class="line"><span class='macro'>LJLIB_CF(jit_util_tracek)<span class='macro_popup'>static int lj_cf_jit_util_tracek(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="325"><td class="num" id="LN325">325</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="326"><td class="num" id="LN326">326</td><td class="line">  GCtrace *T = jit_checktrace(L);</td></tr>
<tr class="codeline" data-linenumber="327"><td class="num" id="LN327">327</td><td class="line">  IRRef ref = (IRRef)lj_lib_checkint(L, 2) + REF_BIAS;</td></tr>
<tr class="codeline" data-linenumber="328"><td class="num" id="LN328">328</td><td class="line">  <span class='keyword'>if</span> (T &amp;&amp; ref &gt;= T-&gt;nk &amp;&amp; ref &lt; REF_BIAS) {</td></tr>
<tr class="codeline" data-linenumber="329"><td class="num" id="LN329">329</td><td class="line">    IRIns *ir = &amp;T-&gt;ir[ref];</td></tr>
<tr class="codeline" data-linenumber="330"><td class="num" id="LN330">330</td><td class="line">    int32_t slot = -1;</td></tr>
<tr class="codeline" data-linenumber="331"><td class="num" id="LN331">331</td><td class="line">    <span class='keyword'>if</span> (ir-&gt;o == IR_KSLOT) {</td></tr>
<tr class="codeline" data-linenumber="332"><td class="num" id="LN332">332</td><td class="line">      slot = ir-&gt;op2;</td></tr>
<tr class="codeline" data-linenumber="333"><td class="num" id="LN333">333</td><td class="line">      ir = &amp;T-&gt;ir[ir-&gt;op1];</td></tr>
<tr class="codeline" data-linenumber="334"><td class="num" id="LN334">334</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="335"><td class="num" id="LN335">335</td><td class="line">    lj_ir_kvalue(L, L-&gt;top-2, ir);</td></tr>
<tr class="codeline" data-linenumber="336"><td class="num" id="LN336">336</td><td class="line">    setintV(L-&gt;top-1, (int32_t)<span class='macro'>irt_type(ir-&gt;t)<span class='macro_popup'>((IRType)((ir-&gt;t).irt &amp; IRT_TYPE))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="337"><td class="num" id="LN337">337</td><td class="line">    <span class='keyword'>if</span> (slot == -1)</td></tr>
<tr class="codeline" data-linenumber="338"><td class="num" id="LN338">338</td><td class="line">      <span class='keyword'>return</span> 2;</td></tr>
<tr class="codeline" data-linenumber="339"><td class="num" id="LN339">339</td><td class="line">    setintV(L-&gt;top++, slot);</td></tr>
<tr class="codeline" data-linenumber="340"><td class="num" id="LN340">340</td><td class="line">    <span class='keyword'>return</span> 3;</td></tr>
<tr class="codeline" data-linenumber="341"><td class="num" id="LN341">341</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="342"><td class="num" id="LN342">342</td><td class="line">  <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="343"><td class="num" id="LN343">343</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="344"><td class="num" id="LN344">344</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="345"><td class="num" id="LN345">345</td><td class="line"><span class='comment'>/* local snap = jit.util.tracesnap(tr, sn) */</span></td></tr>
<tr class="codeline" data-linenumber="346"><td class="num" id="LN346">346</td><td class="line"><span class='macro'>LJLIB_CF(jit_util_tracesnap)<span class='macro_popup'>static int lj_cf_jit_util_tracesnap(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="347"><td class="num" id="LN347">347</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="348"><td class="num" id="LN348">348</td><td class="line">  GCtrace *T = jit_checktrace(L);</td></tr>
<tr class="codeline" data-linenumber="349"><td class="num" id="LN349">349</td><td class="line">  SnapNo sn = (SnapNo)lj_lib_checkint(L, 2);</td></tr>
<tr class="codeline" data-linenumber="350"><td class="num" id="LN350">350</td><td class="line">  <span class='keyword'>if</span> (T &amp;&amp; sn &lt; T-&gt;nsnap) {</td></tr>
<tr class="codeline" data-linenumber="351"><td class="num" id="LN351">351</td><td class="line">    SnapShot *snap = &amp;T-&gt;snap[sn];</td></tr>
<tr class="codeline" data-linenumber="352"><td class="num" id="LN352">352</td><td class="line">    SnapEntry *map = &amp;T-&gt;snapmap[snap-&gt;mapofs];</td></tr>
<tr class="codeline" data-linenumber="353"><td class="num" id="LN353">353</td><td class="line">    MSize n, nent = snap-&gt;nent;</td></tr>
<tr class="codeline" data-linenumber="354"><td class="num" id="LN354">354</td><td class="line">    GCtab *t;</td></tr>
<tr class="codeline" data-linenumber="355"><td class="num" id="LN355">355</td><td class="line">    lua_createtable(L, nent+2, 0);</td></tr>
<tr class="codeline" data-linenumber="356"><td class="num" id="LN356">356</td><td class="line">    t = <span class='macro'>tabV(L-&gt;top-1)<span class='macro_popup'>(((void)0), (&amp;(((GCobj *)(uintptr_t)((L-&gt;top-1)-&gt;gcr<br>).gcptr32))-&gt;tab))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="357"><td class="num" id="LN357">357</td><td class="line">    setintV(<span class='macro'>lj_tab_setint(L, t, 0)<span class='macro_popup'>(((MSize)((0)) &lt; (MSize)((t))-&gt;asize) ? (&amp;(((TValue<br> *)(void *)(uintptr_t)(((t))-&gt;array).ptr32))[((0))]) : lj_tab_setinth<br>(L, (t), (0)))</span></span>, (int32_t)snap-&gt;ref - REF_BIAS);</td></tr>
<tr class="codeline" data-linenumber="358"><td class="num" id="LN358">358</td><td class="line">    setintV(<span class='macro'>lj_tab_setint(L, t, 1)<span class='macro_popup'>(((MSize)((1)) &lt; (MSize)((t))-&gt;asize) ? (&amp;(((TValue<br> *)(void *)(uintptr_t)(((t))-&gt;array).ptr32))[((1))]) : lj_tab_setinth<br>(L, (t), (1)))</span></span>, (int32_t)snap-&gt;nslots);</td></tr>
<tr class="codeline" data-linenumber="359"><td class="num" id="LN359">359</td><td class="line">    <span class='keyword'>for</span> (n = 0; n &lt; nent; n++)</td></tr>
<tr class="codeline" data-linenumber="360"><td class="num" id="LN360">360</td><td class="line">      setintV(<span class='macro'>lj_tab_setint(L, t, (int32_t)(n+2))<span class='macro_popup'>(((MSize)(((int32_t)(n+2))) &lt; (MSize)((t))-&gt;asize) ? (&amp;<br>(((TValue *)(void *)(uintptr_t)(((t))-&gt;array).ptr32))[(((int32_t<br>)(n+2)))]) : lj_tab_setinth(L, (t), ((int32_t)(n+2))))</span></span>, (int32_t)map[n]);</td></tr>
<tr class="codeline" data-linenumber="361"><td class="num" id="LN361">361</td><td class="line">    setintV(<span class='macro'>lj_tab_setint(L, t, (int32_t)(nent+2))<span class='macro_popup'>(((MSize)(((int32_t)(nent+2))) &lt; (MSize)((t))-&gt;asize) ?<br> (&amp;(((TValue *)(void *)(uintptr_t)(((t))-&gt;array).ptr32<br>))[(((int32_t)(nent+2)))]) : lj_tab_setinth(L, (t), ((int32_t<br>)(nent+2))))</span></span>, (int32_t)<span class='macro'>SNAP(255, 0, 0)<span class='macro_popup'>(((SnapEntry)(255) &lt;&lt; 24) + (0) + (0))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="362"><td class="num" id="LN362">362</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="363"><td class="num" id="LN363">363</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="364"><td class="num" id="LN364">364</td><td class="line">  <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="365"><td class="num" id="LN365">365</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="366"><td class="num" id="LN366">366</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="367"><td class="num" id="LN367">367</td><td class="line"><span class='comment'>/* local mcode, addr, loop = jit.util.tracemc(tr) */</span></td></tr>
<tr class="codeline" data-linenumber="368"><td class="num" id="LN368">368</td><td class="line"><span class='macro'>LJLIB_CF(jit_util_tracemc)<span class='macro_popup'>static int lj_cf_jit_util_tracemc(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="369"><td class="num" id="LN369">369</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="370"><td class="num" id="LN370">370</td><td class="line">  GCtrace *T = jit_checktrace(L);</td></tr>
<tr class="codeline" data-linenumber="371"><td class="num" id="LN371">371</td><td class="line">  <span class='keyword'>if</span> (T &amp;&amp; T-&gt;mcode != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="372"><td class="num" id="LN372">372</td><td class="line">    setstrV(L, L-&gt;top-1, lj_str_new(L, (<span class='keyword'>const</span> <span class='keyword'>char</span> *)T-&gt;mcode, T-&gt;szmcode));</td></tr>
<tr class="codeline" data-linenumber="373"><td class="num" id="LN373">373</td><td class="line">    <span class='macro'>setintptrV(L-&gt;top++, (intptr_t)(<span class='keyword'>void</span> *)T-&gt;mcode)<span class='macro_popup'>setint64V((L-&gt;top++), ((intptr_t)(void *)T-&gt;mcode))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="374"><td class="num" id="LN374">374</td><td class="line">    setintV(L-&gt;top++, T-&gt;mcloop);</td></tr>
<tr class="codeline" data-linenumber="375"><td class="num" id="LN375">375</td><td class="line">    <span class='keyword'>return</span> 3;</td></tr>
<tr class="codeline" data-linenumber="376"><td class="num" id="LN376">376</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="377"><td class="num" id="LN377">377</td><td class="line">  <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="378"><td class="num" id="LN378">378</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="379"><td class="num" id="LN379">379</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="380"><td class="num" id="LN380">380</td><td class="line"><span class='comment'>/* local addr = jit.util.traceexitstub([tr,] exitno) */</span></td></tr>
<tr class="codeline" data-linenumber="381"><td class="num" id="LN381">381</td><td class="line"><span class='macro'>LJLIB_CF(jit_util_traceexitstub)<span class='macro_popup'>static int lj_cf_jit_util_traceexitstub(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="382"><td class="num" id="LN382">382</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="383"><td class="num" id="LN383">383</td><td class="line"><span class='directive'>#ifdef <span class='macro'>EXITSTUBS_PER_GROUP<span class='macro_popup'>32</span></span></span></td></tr>
<tr class="codeline" data-linenumber="384"><td class="num" id="LN384">384</td><td class="line">  ExitNo exitno = (ExitNo)lj_lib_checkint(L, 1);</td></tr>
<tr class="codeline" data-linenumber="385"><td class="num" id="LN385">385</td><td class="line">  jit_State *J = <span class='macro'>L2J(L)<span class='macro_popup'>(&amp;(((GG_State *)((char *)((((global_State *)(void *)(uintptr_t<br>)(L-&gt;glref).ptr32))) - ((int)__builtin_offsetof(GG_State, g<br>)))))-&gt;J)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="386"><td class="num" id="LN386">386</td><td class="line">  <span class='keyword'>if</span> (exitno &lt; <span class='macro'>EXITSTUBS_PER_GROUP<span class='macro_popup'>32</span></span>*<span class='macro'>LJ_MAX_EXITSTUBGR<span class='macro_popup'>16</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="387"><td class="num" id="LN387">387</td><td class="line">    <span class='macro'>setintptrV(L-&gt;top-1, (intptr_t)(<span class='keyword'>void</span> *)exitstub_addr(J, exitno))<span class='macro_popup'>setint64V((L-&gt;top-1), ((intptr_t)(void *)((MCode *)exitstub_addr_<br>((char **)((J)-&gt;exitstubgroup), (exitno)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="388"><td class="num" id="LN388">388</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="389"><td class="num" id="LN389">389</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="390"><td class="num" id="LN390">390</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="391"><td class="num" id="LN391">391</td><td class="line">  <span class='keyword'>if</span> (L-&gt;top &gt; L-&gt;base+1) {  <span class='comment'>/* Don't throw for one-argument variant. */</span></td></tr>
<tr class="codeline" data-linenumber="392"><td class="num" id="LN392">392</td><td class="line">    GCtrace *T = jit_checktrace(L);</td></tr>
<tr class="codeline" data-linenumber="393"><td class="num" id="LN393">393</td><td class="line">    ExitNo exitno = (ExitNo)lj_lib_checkint(L, 2);</td></tr>
<tr class="codeline" data-linenumber="394"><td class="num" id="LN394">394</td><td class="line">    ExitNo maxexit = T-&gt;root ? T-&gt;nsnap+1 : T-&gt;nsnap;</td></tr>
<tr class="codeline" data-linenumber="395"><td class="num" id="LN395">395</td><td class="line">    <span class='keyword'>if</span> (T &amp;&amp; T-&gt;mcode != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; exitno &lt; maxexit) {</td></tr>
<tr class="codeline" data-linenumber="396"><td class="num" id="LN396">396</td><td class="line">      <span class='macro'>setintptrV(L-&gt;top-1, (intptr_t)(<span class='keyword'>void</span> *)exitstub_trace_addr(T, exitno))<span class='macro_popup'>setint64V((L-&gt;top-1), ((intptr_t)(void *)exitstub_trace_addr<br>(T, exitno)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="397"><td class="num" id="LN397">397</td><td class="line">      <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="398"><td class="num" id="LN398">398</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="399"><td class="num" id="LN399">399</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="400"><td class="num" id="LN400">400</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="401"><td class="num" id="LN401">401</td><td class="line">  <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="402"><td class="num" id="LN402">402</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="403"><td class="num" id="LN403">403</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="404"><td class="num" id="LN404">404</td><td class="line"><span class='comment'>/* local addr = jit.util.ircalladdr(idx) */</span></td></tr>
<tr class="codeline" data-linenumber="405"><td class="num" id="LN405">405</td><td class="line"><span class='macro'>LJLIB_CF(jit_util_ircalladdr)<span class='macro_popup'>static int lj_cf_jit_util_ircalladdr(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="406"><td class="num" id="LN406">406</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="407"><td class="num" id="LN407">407</td><td class="line">  uint32_t idx = (uint32_t)lj_lib_checkint(L, 1);</td></tr>
<tr class="codeline" data-linenumber="408"><td class="num" id="LN408">408</td><td class="line">  <span class='keyword'>if</span> (idx &lt; IRCALL__MAX) {</td></tr>
<tr class="codeline" data-linenumber="409"><td class="num" id="LN409">409</td><td class="line">    <span class='macro'>setintptrV(L-&gt;top-1, (intptr_t)(<span class='keyword'>void</span> *)lj_ir_callinfo[idx].func)<span class='macro_popup'>setint64V((L-&gt;top-1), ((intptr_t)(void *)lj_ir_callinfo[idx<br>].func))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="410"><td class="num" id="LN410">410</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="411"><td class="num" id="LN411">411</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="412"><td class="num" id="LN412">412</td><td class="line">  <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="413"><td class="num" id="LN413">413</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="414"><td class="num" id="LN414">414</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="415"><td class="num" id="LN415">415</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="416"><td class="num" id="LN416">416</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="417"><td class="num" id="LN417">417</td><td class="line"><span class='directive'>#include "lj_libdef.h"</span></td></tr>
<tr class="codeline" data-linenumber="418"><td class="num" id="LN418">418</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="419"><td class="num" id="LN419">419</td><td class="line"><span class='comment'>/* -- jit.opt module ------------------------------------------------------ */</span></td></tr>
<tr class="codeline" data-linenumber="420"><td class="num" id="LN420">420</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="421"><td class="num" id="LN421">421</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_HASJIT<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="422"><td class="num" id="LN422">422</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="423"><td class="num" id="LN423">423</td><td class="line"><span class='directive'>#define LJLIB_MODULE_jit_opt</span></td></tr>
<tr class="codeline" data-linenumber="424"><td class="num" id="LN424">424</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="425"><td class="num" id="LN425">425</td><td class="line"><span class='comment'>/* Parse optimization level. */</span></td></tr>
<tr class="codeline" data-linenumber="426"><td class="num" id="LN426">426</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> jitopt_level(jit_State *J, <span class='keyword'>const</span> <span class='keyword'>char</span> *str)</td></tr>
<tr class="codeline" data-linenumber="427"><td class="num" id="LN427">427</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="428"><td class="num" id="LN428">428</td><td class="line">  <span class='keyword'>if</span> (str[0] &gt;= '0' &amp;&amp; str[0] &lt;= '9' &amp;&amp; str[1] == '\0') {</td></tr>
<tr class="codeline" data-linenumber="429"><td class="num" id="LN429">429</td><td class="line">    uint32_t flags;</td></tr>
<tr class="codeline" data-linenumber="430"><td class="num" id="LN430">430</td><td class="line">    <span class='keyword'>if</span> (str[0] == '0') flags = <span class='macro'>JIT_F_OPT_0<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="431"><td class="num" id="LN431">431</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (str[0] == '1') flags = <span class='macro'>JIT_F_OPT_1<span class='macro_popup'>(0x00010000|0x00020000|0x00040000)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="432"><td class="num" id="LN432">432</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (str[0] == '2') flags = <span class='macro'>JIT_F_OPT_2<span class='macro_popup'>((0x00010000|0x00020000|0x00040000)|0x00200000|0x00400000)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="433"><td class="num" id="LN433">433</td><td class="line">    <span class='keyword'>else</span> flags = <span class='macro'>JIT_F_OPT_3<span class='macro_popup'>(((0x00010000|0x00020000|0x00040000)|0x00200000|0x00400000)| 0x00080000<br>|0x00100000|0x00800000|0x01000000|0x02000000)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="434"><td class="num" id="LN434">434</td><td class="line">    J-&gt;flags = (J-&gt;flags &amp; ~<span class='macro'>JIT_F_OPT_MASK<span class='macro_popup'>0x0fff0000</span></span>) | flags;</td></tr>
<tr class="codeline" data-linenumber="435"><td class="num" id="LN435">435</td><td class="line">    <span class='keyword'>return</span> 1;  <span class='comment'>/* Ok. */</span></td></tr>
<tr class="codeline" data-linenumber="436"><td class="num" id="LN436">436</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="437"><td class="num" id="LN437">437</td><td class="line">  <span class='keyword'>return</span> 0;  <span class='comment'>/* No match. */</span></td></tr>
<tr class="codeline" data-linenumber="438"><td class="num" id="LN438">438</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="439"><td class="num" id="LN439">439</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="440"><td class="num" id="LN440">440</td><td class="line"><span class='comment'>/* Parse optimization flag. */</span></td></tr>
<tr class="codeline" data-linenumber="441"><td class="num" id="LN441">441</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> jitopt_flag(jit_State *J, <span class='keyword'>const</span> <span class='keyword'>char</span> *str)</td></tr>
<tr class="codeline" data-linenumber="442"><td class="num" id="LN442">442</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="443"><td class="num" id="LN443">443</td><td class="line">  <span class='keyword'>const</span> <span class='keyword'>char</span> *lst = <span class='macro'>JIT_F_OPTSTRING<span class='macro_popup'>"\4fold\3cse\3dce\3fwd\3dse\6narrow\4loop\3abc\4sink\4fuse"</span></span>;</td></tr>
<tr class="codeline" data-linenumber="444"><td class="num" id="LN444">444</td><td class="line">  uint32_t opt;</td></tr>
<tr class="codeline" data-linenumber="445"><td class="num" id="LN445">445</td><td class="line">  <span class='keyword'>int</span> set = 1;</td></tr>
<tr class="codeline" data-linenumber="446"><td class="num" id="LN446">446</td><td class="line">  <span class='keyword'>if</span> (str[0] == '+') {</td></tr>
<tr class="codeline" data-linenumber="447"><td class="num" id="LN447">447</td><td class="line">    str++;</td></tr>
<tr class="codeline" data-linenumber="448"><td class="num" id="LN448">448</td><td class="line">  } <span class='keyword'>else</span> <span class='keyword'>if</span> (str[0] == '-') {</td></tr>
<tr class="codeline" data-linenumber="449"><td class="num" id="LN449">449</td><td class="line">    str++;</td></tr>
<tr class="codeline" data-linenumber="450"><td class="num" id="LN450">450</td><td class="line">    set = 0;</td></tr>
<tr class="codeline" data-linenumber="451"><td class="num" id="LN451">451</td><td class="line">  } <span class='keyword'>else</span> <span class='keyword'>if</span> (str[0] == 'n' &amp;&amp; str[1] == 'o') {</td></tr>
<tr class="codeline" data-linenumber="452"><td class="num" id="LN452">452</td><td class="line">    str += str[2] == '-' ? 3 : 2;</td></tr>
<tr class="codeline" data-linenumber="453"><td class="num" id="LN453">453</td><td class="line">    set = 0;</td></tr>
<tr class="codeline" data-linenumber="454"><td class="num" id="LN454">454</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="455"><td class="num" id="LN455">455</td><td class="line">  <span class='keyword'>for</span> (opt = <span class='macro'>JIT_F_OPT_FIRST<span class='macro_popup'>0x00010000</span></span>; ; opt &lt;&lt;= 1) {</td></tr>
<tr class="codeline" data-linenumber="456"><td class="num" id="LN456">456</td><td class="line">    size_t len = *(<span class='keyword'>const</span> uint8_t *)lst;</td></tr>
<tr class="codeline" data-linenumber="457"><td class="num" id="LN457">457</td><td class="line">    <span class='keyword'>if</span> (len == 0)</td></tr>
<tr class="codeline" data-linenumber="458"><td class="num" id="LN458">458</td><td class="line">      <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="459"><td class="num" id="LN459">459</td><td class="line">    <span class='keyword'>if</span> (strncmp(str, lst+1, len) == 0 &amp;&amp; str[len] == '\0') {</td></tr>
<tr class="codeline" data-linenumber="460"><td class="num" id="LN460">460</td><td class="line">      <span class='keyword'>if</span> (set) J-&gt;flags |= opt; <span class='keyword'>else</span> J-&gt;flags &amp;= ~opt;</td></tr>
<tr class="codeline" data-linenumber="461"><td class="num" id="LN461">461</td><td class="line">      <span class='keyword'>return</span> 1;  <span class='comment'>/* Ok. */</span></td></tr>
<tr class="codeline" data-linenumber="462"><td class="num" id="LN462">462</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="463"><td class="num" id="LN463">463</td><td class="line">    lst += 1+len;</td></tr>
<tr class="codeline" data-linenumber="464"><td class="num" id="LN464">464</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="465"><td class="num" id="LN465">465</td><td class="line">  <span class='keyword'>return</span> 0;  <span class='comment'>/* No match. */</span></td></tr>
<tr class="codeline" data-linenumber="466"><td class="num" id="LN466">466</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="467"><td class="num" id="LN467">467</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="468"><td class="num" id="LN468">468</td><td class="line"><span class='comment'>/* Parse optimization parameter. */</span></td></tr>
<tr class="codeline" data-linenumber="469"><td class="num" id="LN469">469</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> jitopt_param(jit_State *J, <span class='keyword'>const</span> <span class='keyword'>char</span> *str)</td></tr>
<tr class="codeline" data-linenumber="470"><td class="num" id="LN470">470</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="471"><td class="num" id="LN471">471</td><td class="line">  <span class='keyword'>const</span> <span class='keyword'>char</span> *lst = <span class='macro'>JIT_P_STRING<span class='macro_popup'>"\010" "maxtrace" "\011" "maxrecord" "\012" "maxirconst" "\007"<br> "maxside" "\007" "maxsnap" "\007" "hotloop" "\007" "hotexit"<br> "\007" "tryside" "\012" "instunroll" "\012" "loopunroll" "\012"<br> "callunroll" "\011" "recunroll" "\011" "sizemcode" "\010" "maxmcode"</span></span>;</td></tr>
<tr class="codeline" data-linenumber="472"><td class="num" id="LN472">472</td><td class="line">  <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="473"><td class="num" id="LN473">473</td><td class="line">  <span class='keyword'>for</span> (i = 0; i &lt; JIT_P__MAX; i++) {</td></tr>
<tr class="codeline" data-linenumber="474"><td class="num" id="LN474">474</td><td class="line">    size_t len = *(<span class='keyword'>const</span> uint8_t *)lst;</td></tr>
<tr class="codeline" data-linenumber="475"><td class="num" id="LN475">475</td><td class="line">    <span class='macro'>lua_assert(len != 0)<span class='macro_popup'>((void)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="476"><td class="num" id="LN476">476</td><td class="line">    <span class='keyword'>if</span> (strncmp(str, lst+1, len) == 0 &amp;&amp; str[len] == '=') {</td></tr>
<tr class="codeline" data-linenumber="477"><td class="num" id="LN477">477</td><td class="line">      int32_t n = 0;</td></tr>
<tr class="codeline" data-linenumber="478"><td class="num" id="LN478">478</td><td class="line">      <span class='keyword'>const</span> <span class='keyword'>char</span> *p = &amp;str[len+1];</td></tr>
<tr class="codeline" data-linenumber="479"><td class="num" id="LN479">479</td><td class="line">      <span class='keyword'>while</span> (*p &gt;= '0' &amp;&amp; *p &lt;= '9')</td></tr>
<tr class="codeline" data-linenumber="480"><td class="num" id="LN480">480</td><td class="line">	n = n*10 + (*p++ - '0');</td></tr>
<tr class="codeline" data-linenumber="481"><td class="num" id="LN481">481</td><td class="line">      <span class='keyword'>if</span> (*p) <span class='keyword'>return</span> 0;  <span class='comment'>/* Malformed number. */</span></td></tr>
<tr class="codeline" data-linenumber="482"><td class="num" id="LN482">482</td><td class="line">      J-&gt;param[i] = n;</td></tr>
<tr class="codeline" data-linenumber="483"><td class="num" id="LN483">483</td><td class="line">      <span class='keyword'>if</span> (i == JIT_P_hotloop)</td></tr>
<tr class="codeline" data-linenumber="484"><td class="num" id="LN484">484</td><td class="line">	lj_dispatch_init_hotcount(<span class='macro'>J2G(J)<span class='macro_popup'>(&amp;((GG_State *)((char *)(J) - ((int)__builtin_offsetof(GG_State<br>, J))))-&gt;g)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="485"><td class="num" id="LN485">485</td><td class="line">      <span class='keyword'>return</span> 1;  <span class='comment'>/* Ok. */</span></td></tr>
<tr class="codeline" data-linenumber="486"><td class="num" id="LN486">486</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="487"><td class="num" id="LN487">487</td><td class="line">    lst += 1+len;</td></tr>
<tr class="codeline" data-linenumber="488"><td class="num" id="LN488">488</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="489"><td class="num" id="LN489">489</td><td class="line">  <span class='keyword'>return</span> 0;  <span class='comment'>/* No match. */</span></td></tr>
<tr class="codeline" data-linenumber="490"><td class="num" id="LN490">490</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="491"><td class="num" id="LN491">491</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="492"><td class="num" id="LN492">492</td><td class="line"><span class='comment'>/* jit.opt.start(flags...) */</span></td></tr>
<tr class="codeline" data-linenumber="493"><td class="num" id="LN493">493</td><td class="line"><span class='macro'>LJLIB_CF(jit_opt_start)<span class='macro_popup'>static int lj_cf_jit_opt_start(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="494"><td class="num" id="LN494">494</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="495"><td class="num" id="LN495">495</td><td class="line">  jit_State *J = <span class='macro'>L2J(L)<span class='macro_popup'>(&amp;(((GG_State *)((char *)((((global_State *)(void *)(uintptr_t<br>)(L-&gt;glref).ptr32))) - ((int)__builtin_offsetof(GG_State, g<br>)))))-&gt;J)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="496"><td class="num" id="LN496">496</td><td class="line">  <span class='keyword'>int</span> nargs = (<span class='keyword'>int</span>)(L-&gt;top - L-&gt;base);</td></tr>
<tr class="codeline" data-linenumber="497"><td class="num" id="LN497">497</td><td class="line">  <span class='keyword'>if</span> (nargs == 0) {</td></tr>
<tr class="codeline" data-linenumber="498"><td class="num" id="LN498">498</td><td class="line">    J-&gt;flags = (J-&gt;flags &amp; ~<span class='macro'>JIT_F_OPT_MASK<span class='macro_popup'>0x0fff0000</span></span>) | <span class='macro'>JIT_F_OPT_DEFAULT<span class='macro_popup'>(((0x00010000|0x00020000|0x00040000)|0x00200000|0x00400000)| 0x00080000<br>|0x00100000|0x00800000|0x01000000|0x02000000)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="499"><td class="num" id="LN499">499</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="500"><td class="num" id="LN500">500</td><td class="line">    <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="501"><td class="num" id="LN501">501</td><td class="line">    <span class='keyword'>for</span> (i = 1; i &lt;= nargs; i++) {</td></tr>
<tr class="codeline" data-linenumber="502"><td class="num" id="LN502">502</td><td class="line">      <span class='keyword'>const</span> <span class='keyword'>char</span> *str = <span class='macro'>strdata(lj_lib_checkstr(L, i))<span class='macro_popup'>((const char *)((lj_lib_checkstr(L, i))+1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="503"><td class="num" id="LN503">503</td><td class="line">      <span class='keyword'>if</span> (!jitopt_level(J, str) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="504"><td class="num" id="LN504">504</td><td class="line">	  !jitopt_flag(J, str) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="505"><td class="num" id="LN505">505</td><td class="line">	  !jitopt_param(J, str))</td></tr>
<tr class="codeline" data-linenumber="506"><td class="num" id="LN506">506</td><td class="line">	lj_err_callerv(L, LJ_ERR_JITOPT, str);</td></tr>
<tr class="codeline" data-linenumber="507"><td class="num" id="LN507">507</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="508"><td class="num" id="LN508">508</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="509"><td class="num" id="LN509">509</td><td class="line">  <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="510"><td class="num" id="LN510">510</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="511"><td class="num" id="LN511">511</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="512"><td class="num" id="LN512">512</td><td class="line"><span class='directive'>#include "lj_libdef.h"</span></td></tr>
<tr class="codeline" data-linenumber="513"><td class="num" id="LN513">513</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="514"><td class="num" id="LN514">514</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="515"><td class="num" id="LN515">515</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="516"><td class="num" id="LN516">516</td><td class="line"><span class='comment'>/* -- JIT compiler initialization ----------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="517"><td class="num" id="LN517">517</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="518"><td class="num" id="LN518">518</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_HASJIT<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="519"><td class="num" id="LN519">519</td><td class="line"><span class='comment'>/* Default values for JIT parameters. */</span></td></tr>
<tr class="codeline" data-linenumber="520"><td class="num" id="LN520">520</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> int32_t jit_param_default[JIT_P__MAX+1] = {</td></tr>
<tr class="codeline" data-linenumber="521"><td class="num" id="LN521">521</td><td class="line"><span class='directive'>#define JIT_PARAMINIT(len, name, value)	(value),</span></td></tr>
<tr class="codeline" data-linenumber="522"><td class="num" id="LN522">522</td><td class="line"><span class='macro'>JIT_PARAMDEF(JIT_PARAMINIT)<span class='macro_popup'>JIT_PARAMINIT(\010, maxtrace, 1000) JIT_PARAMINIT(\011, maxrecord<br>, 4000) JIT_PARAMINIT(\012, maxirconst, 500) JIT_PARAMINIT(\007<br>, maxside, 100) JIT_PARAMINIT(\007, maxsnap, 500) JIT_PARAMINIT<br>(\007, hotloop, 56) JIT_PARAMINIT(\007, hotexit, 10) JIT_PARAMINIT<br>(\007, tryside, 4) JIT_PARAMINIT(\012, instunroll, 4) JIT_PARAMINIT<br>(\012, loopunroll, 15) JIT_PARAMINIT(\012, callunroll, 3) JIT_PARAMINIT<br>(\011, recunroll, 2) JIT_PARAMINIT(\011, sizemcode, 64) JIT_PARAMINIT<br>(\010, maxmcode, 512)</span></span></td></tr>
<tr class="codeline" data-linenumber="523"><td class="num" id="LN523">523</td><td class="line"><span class='directive'>#undef JIT_PARAMINIT</span></td></tr>
<tr class="codeline" data-linenumber="524"><td class="num" id="LN524">524</td><td class="line">  0</td></tr>
<tr class="codeline" data-linenumber="525"><td class="num" id="LN525">525</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="526"><td class="num" id="LN526">526</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="527"><td class="num" id="LN527">527</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="528"><td class="num" id="LN528">528</td><td class="line"><span class='directive'>#if LJ_TARGET_ARM &amp;&amp; <span class='macro'>LJ_TARGET_LINUX<span class='macro_popup'>(2 == 2)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="529"><td class="num" id="LN529">529</td><td class="line"><span class='directive'>#include &lt;sys/utsname.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="530"><td class="num" id="LN530">530</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="531"><td class="num" id="LN531">531</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="532"><td class="num" id="LN532">532</td><td class="line"><span class='comment'>/* Arch-dependent CPU detection. */</span></td></tr>
<tr class="codeline" data-linenumber="533"><td class="num" id="LN533">533</td><td class="line"><span class='keyword'>static</span> uint32_t jit_cpudetect(lua_State *L)</td></tr>
<tr class="codeline" data-linenumber="534"><td class="num" id="LN534">534</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="535"><td class="num" id="LN535">535</td><td class="line">  uint32_t flags = 0;</td></tr>
<tr class="codeline" data-linenumber="536"><td class="num" id="LN536">536</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_TARGET_X86ORX64<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="537"><td class="num" id="LN537">537</td><td class="line">  uint32_t vendor[4];</td></tr>
<tr class="codeline" data-linenumber="538"><td class="num" id="LN538">538</td><td class="line">  uint32_t features[4];</td></tr>
<tr class="codeline" data-linenumber="539"><td class="num" id="LN539">539</td><td class="line">  <span class='keyword'>if</span> (lj_vm_cpuid(0, vendor) &amp;&amp; lj_vm_cpuid(1, features)) {</td></tr>
<tr class="codeline" data-linenumber="540"><td class="num" id="LN540">540</td><td class="line"><span class='directive'>#if !<span class='macro'>LJ_HASJIT<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="541"><td class="num" id="LN541">541</td><td class="line"><span class='directive'>#define <span class='macro'>JIT_F_CMOV<span class='macro_popup'>0x00000010</span></span>	1</span></td></tr>
<tr class="codeline" data-linenumber="542"><td class="num" id="LN542">542</td><td class="line"><span class='directive'>#define <span class='macro'>JIT_F_SSE2<span class='macro_popup'>0x00000020</span></span>	2</span></td></tr>
<tr class="codeline" data-linenumber="543"><td class="num" id="LN543">543</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="544"><td class="num" id="LN544">544</td><td class="line">    flags |= ((features[3] &gt;&gt; 15)&amp;1) * <span class='macro'>JIT_F_CMOV<span class='macro_popup'>0x00000010</span></span>;</td></tr>
<tr class="codeline" data-linenumber="545"><td class="num" id="LN545">545</td><td class="line">    flags |= ((features[3] &gt;&gt; 26)&amp;1) * <span class='macro'>JIT_F_SSE2<span class='macro_popup'>0x00000020</span></span>;</td></tr>
<tr class="codeline" data-linenumber="546"><td class="num" id="LN546">546</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_HASJIT<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="547"><td class="num" id="LN547">547</td><td class="line">    flags |= ((features[2] &gt;&gt; 0)&amp;1) * <span class='macro'>JIT_F_SSE3<span class='macro_popup'>0x00000040</span></span>;</td></tr>
<tr class="codeline" data-linenumber="548"><td class="num" id="LN548">548</td><td class="line">    flags |= ((features[2] &gt;&gt; 19)&amp;1) * <span class='macro'>JIT_F_SSE4_1<span class='macro_popup'>0x00000080</span></span>;</td></tr>
<tr class="codeline" data-linenumber="549"><td class="num" id="LN549">549</td><td class="line">    <span class='keyword'>if</span> (vendor[2] == 0x6c65746e) {  <span class='comment'>/* Intel. */</span></td></tr>
<tr class="codeline" data-linenumber="550"><td class="num" id="LN550">550</td><td class="line">      <span class='keyword'>if</span> ((features[0] &amp; 0x0ff00f00) == 0x00000f00)  <span class='comment'>/* P4. */</span></td></tr>
<tr class="codeline" data-linenumber="551"><td class="num" id="LN551">551</td><td class="line">	flags |= <span class='macro'>JIT_F_P4<span class='macro_popup'>0x00000100</span></span>;  <span class='comment'>/* Currently unused. */</span></td></tr>
<tr class="codeline" data-linenumber="552"><td class="num" id="LN552">552</td><td class="line">      <span class='keyword'>else</span> <span class='keyword'>if</span> ((features[0] &amp; 0x0fff0ff0) == 0x000106c0)  <span class='comment'>/* Atom. */</span></td></tr>
<tr class="codeline" data-linenumber="553"><td class="num" id="LN553">553</td><td class="line">	flags |= <span class='macro'>JIT_F_LEA_AGU<span class='macro_popup'>0x00000800</span></span>;</td></tr>
<tr class="codeline" data-linenumber="554"><td class="num" id="LN554">554</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (vendor[2] == 0x444d4163) {  <span class='comment'>/* AMD. */</span></td></tr>
<tr class="codeline" data-linenumber="555"><td class="num" id="LN555">555</td><td class="line">      uint32_t fam = (features[0] &amp; 0x0ff00f00);</td></tr>
<tr class="codeline" data-linenumber="556"><td class="num" id="LN556">556</td><td class="line">      <span class='keyword'>if</span> (fam == 0x00000f00)  <span class='comment'>/* K8. */</span></td></tr>
<tr class="codeline" data-linenumber="557"><td class="num" id="LN557">557</td><td class="line">	flags |= <span class='macro'>JIT_F_SPLIT_XMM<span class='macro_popup'>0x00000400</span></span>;</td></tr>
<tr class="codeline" data-linenumber="558"><td class="num" id="LN558">558</td><td class="line">      <span class='keyword'>if</span> (fam &gt;= 0x00000f00)  <span class='comment'>/* K8, K10. */</span></td></tr>
<tr class="codeline" data-linenumber="559"><td class="num" id="LN559">559</td><td class="line">	flags |= <span class='macro'>JIT_F_PREFER_IMUL<span class='macro_popup'>0x00000200</span></span>;</td></tr>
<tr class="codeline" data-linenumber="560"><td class="num" id="LN560">560</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="561"><td class="num" id="LN561">561</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="562"><td class="num" id="LN562">562</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="563"><td class="num" id="LN563">563</td><td class="line">  <span class='comment'>/* Check for required instruction set support on x86 (unnecessary on x64). */</span></td></tr>
<tr class="codeline" data-linenumber="564"><td class="num" id="LN564">564</td><td class="line"><span class='directive'>#if LJ_TARGET_X86</span></td></tr>
<tr class="codeline" data-linenumber="565"><td class="num" id="LN565">565</td><td class="line"><span class='directive'>#if !defined(LUAJIT_CPU_NOCMOV)</span></td></tr>
<tr class="codeline" data-linenumber="566"><td class="num" id="LN566">566</td><td class="line">  <span class='keyword'>if</span> (!(flags &amp; <span class='macro'>JIT_F_CMOV<span class='macro_popup'>0x00000010</span></span>))</td></tr>
<tr class="codeline" data-linenumber="567"><td class="num" id="LN567">567</td><td class="line">    luaL_error(L, <span class='string_literal'>"CPU not supported"</span>);</td></tr>
<tr class="codeline" data-linenumber="568"><td class="num" id="LN568">568</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="569"><td class="num" id="LN569">569</td><td class="line"><span class='directive'>#if defined(LUAJIT_CPU_SSE2)</span></td></tr>
<tr class="codeline" data-linenumber="570"><td class="num" id="LN570">570</td><td class="line">  <span class='keyword'>if</span> (!(flags &amp; <span class='macro'>JIT_F_SSE2<span class='macro_popup'>0x00000020</span></span>))</td></tr>
<tr class="codeline" data-linenumber="571"><td class="num" id="LN571">571</td><td class="line">    luaL_error(L, <span class='string_literal'>"CPU does not support SSE2 (recompile without -DLUAJIT_CPU_SSE2)"</span>);</td></tr>
<tr class="codeline" data-linenumber="572"><td class="num" id="LN572">572</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="573"><td class="num" id="LN573">573</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="574"><td class="num" id="LN574">574</td><td class="line"><span class='directive'>#elif LJ_TARGET_ARM</span></td></tr>
<tr class="codeline" data-linenumber="575"><td class="num" id="LN575">575</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_HASJIT<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="576"><td class="num" id="LN576">576</td><td class="line">  <span class='keyword'>int</span> ver = LJ_ARCH_VERSION;  <span class='comment'>/* Compile-time ARM CPU detection. */</span></td></tr>
<tr class="codeline" data-linenumber="577"><td class="num" id="LN577">577</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_TARGET_LINUX<span class='macro_popup'>(2 == 2)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="578"><td class="num" id="LN578">578</td><td class="line">  <span class='keyword'>if</span> (ver &lt; 70) {  <span class='comment'>/* Runtime ARM CPU detection. */</span></td></tr>
<tr class="codeline" data-linenumber="579"><td class="num" id="LN579">579</td><td class="line">    <span class='keyword'>struct</span> utsname ut;</td></tr>
<tr class="codeline" data-linenumber="580"><td class="num" id="LN580">580</td><td class="line">    uname(&amp;ut);</td></tr>
<tr class="codeline" data-linenumber="581"><td class="num" id="LN581">581</td><td class="line">    <span class='keyword'>if</span> (strncmp(ut.machine, <span class='string_literal'>"armv"</span>, 4) == 0) {</td></tr>
<tr class="codeline" data-linenumber="582"><td class="num" id="LN582">582</td><td class="line">      <span class='keyword'>if</span> (ut.machine[4] &gt;= '7')</td></tr>
<tr class="codeline" data-linenumber="583"><td class="num" id="LN583">583</td><td class="line">	ver = 70;</td></tr>
<tr class="codeline" data-linenumber="584"><td class="num" id="LN584">584</td><td class="line">      <span class='keyword'>else</span> <span class='keyword'>if</span> (ut.machine[4] == '6')</td></tr>
<tr class="codeline" data-linenumber="585"><td class="num" id="LN585">585</td><td class="line">	ver = 60;</td></tr>
<tr class="codeline" data-linenumber="586"><td class="num" id="LN586">586</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="587"><td class="num" id="LN587">587</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="588"><td class="num" id="LN588">588</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="589"><td class="num" id="LN589">589</td><td class="line">  flags |= ver &gt;= 70 ? JIT_F_ARMV7 :</td></tr>
<tr class="codeline" data-linenumber="590"><td class="num" id="LN590">590</td><td class="line">	   ver &gt;= 61 ? JIT_F_ARMV6T2_ :</td></tr>
<tr class="codeline" data-linenumber="591"><td class="num" id="LN591">591</td><td class="line">	   ver &gt;= 60 ? JIT_F_ARMV6_ : 0;</td></tr>
<tr class="codeline" data-linenumber="592"><td class="num" id="LN592">592</td><td class="line">  flags |= <span class='macro'>LJ_ARCH_HASFPU<span class='macro_popup'>1</span></span> == 0 ? 0 : ver &gt;= 70 ? JIT_F_VFPV3 : JIT_F_VFPV2;</td></tr>
<tr class="codeline" data-linenumber="593"><td class="num" id="LN593">593</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="594"><td class="num" id="LN594">594</td><td class="line"><span class='directive'>#elif LJ_TARGET_PPC</span></td></tr>
<tr class="codeline" data-linenumber="595"><td class="num" id="LN595">595</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_HASJIT<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="596"><td class="num" id="LN596">596</td><td class="line"><span class='directive'>#if LJ_ARCH_SQRT</span></td></tr>
<tr class="codeline" data-linenumber="597"><td class="num" id="LN597">597</td><td class="line">  flags |= JIT_F_SQRT;</td></tr>
<tr class="codeline" data-linenumber="598"><td class="num" id="LN598">598</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="599"><td class="num" id="LN599">599</td><td class="line"><span class='directive'>#if LJ_ARCH_ROUND</span></td></tr>
<tr class="codeline" data-linenumber="600"><td class="num" id="LN600">600</td><td class="line">  flags |= JIT_F_ROUND;</td></tr>
<tr class="codeline" data-linenumber="601"><td class="num" id="LN601">601</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="602"><td class="num" id="LN602">602</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="603"><td class="num" id="LN603">603</td><td class="line"><span class='directive'>#elif LJ_TARGET_PPCSPE</span></td></tr>
<tr class="codeline" data-linenumber="604"><td class="num" id="LN604">604</td><td class="line">  <span class='comment'>/* Nothing to do. */</span></td></tr>
<tr class="codeline" data-linenumber="605"><td class="num" id="LN605">605</td><td class="line"><span class='directive'>#elif LJ_TARGET_MIPS</span></td></tr>
<tr class="codeline" data-linenumber="606"><td class="num" id="LN606">606</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_HASJIT<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="607"><td class="num" id="LN607">607</td><td class="line">  <span class='comment'>/* Compile-time MIPS CPU detection. */</span></td></tr>
<tr class="codeline" data-linenumber="608"><td class="num" id="LN608">608</td><td class="line"><span class='directive'>#if LJ_ARCH_VERSION &gt;= 20</span></td></tr>
<tr class="codeline" data-linenumber="609"><td class="num" id="LN609">609</td><td class="line">  flags |= JIT_F_MIPS32R2;</td></tr>
<tr class="codeline" data-linenumber="610"><td class="num" id="LN610">610</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="611"><td class="num" id="LN611">611</td><td class="line">  <span class='comment'>/* Runtime MIPS CPU detection. */</span></td></tr>
<tr class="codeline" data-linenumber="612"><td class="num" id="LN612">612</td><td class="line"><span class='directive'>#if defined(<span class='macro'>__GNUC__<span class='macro_popup'>4</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="613"><td class="num" id="LN613">613</td><td class="line">  <span class='keyword'>if</span> (!(flags &amp; JIT_F_MIPS32R2)) {</td></tr>
<tr class="codeline" data-linenumber="614"><td class="num" id="LN614">614</td><td class="line">    <span class='keyword'>int</span> x;</td></tr>
<tr class="codeline" data-linenumber="615"><td class="num" id="LN615">615</td><td class="line">    <span class='comment'>/* On MIPS32R1 rotr is treated as srl. rotr r2,r2,1 -&gt; srl r2,r2,1. */</span></td></tr>
<tr class="codeline" data-linenumber="616"><td class="num" id="LN616">616</td><td class="line">    <span class='keyword'>__asm__</span>(<span class='string_literal'>"li $2, 1\n\t.long 0x00221042\n\tmove %0, $2"</span> : <span class='string_literal'>"=r"</span>(x) : : <span class='string_literal'>"$2"</span>);</td></tr>
<tr class="codeline" data-linenumber="617"><td class="num" id="LN617">617</td><td class="line">    <span class='keyword'>if</span> (x) flags |= JIT_F_MIPS32R2;  <span class='comment'>/* Either 0x80000000 (R2) or 0 (R1). */</span></td></tr>
<tr class="codeline" data-linenumber="618"><td class="num" id="LN618">618</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="619"><td class="num" id="LN619">619</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="620"><td class="num" id="LN620">620</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="621"><td class="num" id="LN621">621</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="622"><td class="num" id="LN622">622</td><td class="line"><span class='directive'>#error "Missing CPU detection for this architecture"</span></td></tr>
<tr class="codeline" data-linenumber="623"><td class="num" id="LN623">623</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="624"><td class="num" id="LN624">624</td><td class="line">  <span class='macro'>UNUSED(L)<span class='macro_popup'>((void)(L))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="625"><td class="num" id="LN625">625</td><td class="line">  <span class='keyword'>return</span> flags;</td></tr>
<tr class="codeline" data-linenumber="626"><td class="num" id="LN626">626</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="627"><td class="num" id="LN627">627</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="628"><td class="num" id="LN628">628</td><td class="line"><span class='comment'>/* Initialize JIT compiler. */</span></td></tr>
<tr class="codeline" data-linenumber="629"><td class="num" id="LN629">629</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> jit_init(lua_State *L)</td></tr>
<tr class="codeline" data-linenumber="630"><td class="num" id="LN630">630</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="631"><td class="num" id="LN631">631</td><td class="line">  uint32_t flags = jit_cpudetect(L);</td></tr>
<tr class="codeline" data-linenumber="632"><td class="num" id="LN632">632</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_HASJIT<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="633"><td class="num" id="LN633">633</td><td class="line">  jit_State *J = <span class='macro'>L2J(L)<span class='macro_popup'>(&amp;(((GG_State *)((char *)((((global_State *)(void *)(uintptr_t<br>)(L-&gt;glref).ptr32))) - ((int)__builtin_offsetof(GG_State, g<br>)))))-&gt;J)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="634"><td class="num" id="LN634">634</td><td class="line"><span class='directive'>#if LJ_TARGET_X86</span></td></tr>
<tr class="codeline" data-linenumber="635"><td class="num" id="LN635">635</td><td class="line">  <span class='comment'>/* Silently turn off the JIT compiler on CPUs without SSE2. */</span></td></tr>
<tr class="codeline" data-linenumber="636"><td class="num" id="LN636">636</td><td class="line">  <span class='keyword'>if</span> ((flags &amp; <span class='macro'>JIT_F_SSE2<span class='macro_popup'>0x00000020</span></span>))</td></tr>
<tr class="codeline" data-linenumber="637"><td class="num" id="LN637">637</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="638"><td class="num" id="LN638">638</td><td class="line">    J-&gt;flags = flags | <span class='macro'>JIT_F_ON<span class='macro_popup'>0x00000001</span></span> | <span class='macro'>JIT_F_OPT_DEFAULT<span class='macro_popup'>(((0x00010000|0x00020000|0x00040000)|0x00200000|0x00400000)| 0x00080000<br>|0x00100000|0x00800000|0x01000000|0x02000000)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="639"><td class="num" id="LN639">639</td><td class="line">  <span class="mrange">memcpy</span>(J-&gt;param, jit_param_default, <span class='keyword'>sizeof</span>(J-&gt;param));</td></tr>
<tr><td class="num"></td><td class="line"><div id="EndPath" class="msg msgEvent" style="margin-left:3ex; max-width:58em">Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11</div></td></tr>
<tr class="codeline" data-linenumber="640"><td class="num" id="LN640">640</td><td class="line">  lj_dispatch_update(<span class='macro'>G(L)<span class='macro_popup'>(((global_State *)(void *)(uintptr_t)(L-&gt;glref).ptr32))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="641"><td class="num" id="LN641">641</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="642"><td class="num" id="LN642">642</td><td class="line">  <span class='macro'>UNUSED(flags)<span class='macro_popup'>((void)(flags))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="643"><td class="num" id="LN643">643</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="644"><td class="num" id="LN644">644</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="645"><td class="num" id="LN645">645</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="646"><td class="num" id="LN646">646</td><td class="line"><span class='macro'>LUALIB_API<span class='macro_popup'>extern</span></span> <span class='keyword'>int</span> luaopen_jit(lua_State *L)</td></tr>
<tr class="codeline" data-linenumber="647"><td class="num" id="LN647">647</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="648"><td class="num" id="LN648">648</td><td class="line">  <span class='macro'>lua_pushliteral(L, LJ_OS_NAME)<span class='macro_popup'>lua_pushlstring(L, "" "Linux", (sizeof("Linux")/sizeof(char))<br>-1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="649"><td class="num" id="LN649">649</td><td class="line">  <span class='macro'>lua_pushliteral(L, LJ_ARCH_NAME)<span class='macro_popup'>lua_pushlstring(L, "" "x64", (sizeof("x64")/sizeof(char))-1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="650"><td class="num" id="LN650">650</td><td class="line">  lua_pushinteger(L, <span class='macro'>LUAJIT_VERSION_NUM<span class='macro_popup'>20004</span></span>);</td></tr>
<tr class="codeline" data-linenumber="651"><td class="num" id="LN651">651</td><td class="line">  <span class='macro'>lua_pushliteral(L, LUAJIT_VERSION)<span class='macro_popup'>lua_pushlstring(L, "" "LuaJIT 2.0.4", (sizeof("LuaJIT 2.0.4")<br>/sizeof(char))-1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="652"><td class="num" id="LN652">652</td><td class="line">  <span class='macro'>LJ_LIB_REG(L, LUA_JITLIBNAME, jit)<span class='macro_popup'>lj_lib_register(L, "jit", lj_lib_init_jit, lj_lib_cf_jit)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="653"><td class="num" id="LN653">653</td><td class="line"><span class='directive'>#ifndef LUAJIT_DISABLE_JITUTIL</span></td></tr>
<tr class="codeline" data-linenumber="654"><td class="num" id="LN654">654</td><td class="line">  <span class='macro'>LJ_LIB_REG(L, <span class='string_literal'>"jit.util"</span>, jit_util)<span class='macro_popup'>lj_lib_register(L, "jit.util", lj_lib_init_jit_util, lj_lib_cf_jit_util<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="655"><td class="num" id="LN655">655</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="656"><td class="num" id="LN656">656</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_HASJIT<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="657"><td class="num" id="LN657">657</td><td class="line">  <span class='macro'>LJ_LIB_REG(L, <span class='string_literal'>"jit.opt"</span>, jit_opt)<span class='macro_popup'>lj_lib_register(L, "jit.opt", lj_lib_init_jit_opt, lj_lib_cf_jit_opt<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="658"><td class="num" id="LN658">658</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="659"><td class="num" id="LN659">659</td><td class="line">  L-&gt;top -= 2;</td></tr>
<tr class="codeline" data-linenumber="660"><td class="num" id="LN660">660</td><td class="line">  jit_init(L);</td></tr>
<tr class="codeline" data-linenumber="661"><td class="num" id="LN661">661</td><td class="line">  <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="662"><td class="num" id="LN662">662</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="663"><td class="num" id="LN663">663</td><td class="line"> </td></tr>
</table></body></html>
