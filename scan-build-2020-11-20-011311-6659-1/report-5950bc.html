<!doctype html>
<html>
<head>
<title>lib_string.c</title>

<style type="text/css">
body { color:#000000; background-color:#ffffff }
body { font-family:Helvetica, sans-serif; font-size:10pt }
h1 { font-size:14pt }
.FileName { margin-top: 5px; margin-bottom: 5px; display: inline; }
.FileNav { margin-left: 5px; margin-right: 5px; display: inline; }
.FileNav a { text-decoration:none; font-size: larger; }
.divider { margin-top: 30px; margin-bottom: 30px; height: 15px; }
.divider { background-color: gray; }
.code { border-collapse:collapse; width:100%; }
.code { font-family: "Monospace", monospace; font-size:10pt }
.code { line-height: 1.2em }
.comment { color: green; font-style: oblique }
.keyword { color: blue }
.string_literal { color: red }
.directive { color: darkmagenta }

/* Macros and variables could have pop-up notes hidden by default.
  - Macro pop-up:    expansion of the macro
  - Variable pop-up: value (table) of the variable */
.macro_popup, .variable_popup { display: none; }

/* Pop-up appears on mouse-hover event. */
.macro:hover .macro_popup, .variable:hover .variable_popup {
  display: block;
  padding: 2px;
  -webkit-border-radius:5px;
  -webkit-box-shadow:1px 1px 7px #000;
  border-radius:5px;
  box-shadow:1px 1px 7px #000;
  position: absolute;
  top: -1em;
  left:10em;
  z-index: 1
}

.macro_popup {
  border: 2px solid red;
  background-color:#FFF0F0;
  font-weight: normal;
}

.variable_popup {
  border: 2px solid blue;
  background-color:#F0F0FF;
  font-weight: bold;
  font-family: Helvetica, sans-serif;
  font-size: 9pt;
}

/* Pop-up notes needs a relative position as a base where they pops up. */
.macro, .variable {
  background-color: PaleGoldenRod;
  position: relative;
}
.macro { color: DarkMagenta; }

#tooltiphint {
  position: fixed;
  width: 50em;
  margin-left: -25em;
  left: 50%;
  padding: 10px;
  border: 1px solid #b0b0b0;
  border-radius: 2px;
  box-shadow: 1px 1px 7px black;
  background-color: #c0c0c0;
  z-index: 2;
}

.num { width:2.5em; padding-right:2ex; background-color:#eeeeee }
.num { text-align:right; font-size:8pt }
.num { color:#444444 }
.line { padding-left: 1ex; border-left: 3px solid #ccc }
.line { white-space: pre }
.msg { -webkit-box-shadow:1px 1px 7px #000 }
.msg { box-shadow:1px 1px 7px #000 }
.msg { -webkit-border-radius:5px }
.msg { border-radius:5px }
.msg { font-family:Helvetica, sans-serif; font-size:8pt }
.msg { float:left }
.msg { padding:0.25em 1ex 0.25em 1ex }
.msg { margin-top:10px; margin-bottom:10px }
.msg { font-weight:bold }
.msg { max-width:60em; word-wrap: break-word; white-space: pre-wrap }
.msgT { padding:0x; spacing:0x }
.msgEvent { background-color:#fff8b4; color:#000000 }
.msgControl { background-color:#bbbbbb; color:#000000 }
.msgNote { background-color:#ddeeff; color:#000000 }
.mrange { background-color:#dfddf3 }
.mrange { border-bottom:1px solid #6F9DBE }
.PathIndex { font-weight: bold; padding:0px 5px; margin-right:5px; }
.PathIndex { -webkit-border-radius:8px }
.PathIndex { border-radius:8px }
.PathIndexEvent { background-color:#bfba87 }
.PathIndexControl { background-color:#8c8c8c }
.PathIndexPopUp { background-color: #879abc; }
.PathNav a { text-decoration:none; font-size: larger }
.CodeInsertionHint { font-weight: bold; background-color: #10dd10 }
.CodeRemovalHint { background-color:#de1010 }
.CodeRemovalHint { border-bottom:1px solid #6F9DBE }
.selected{ background-color:orange !important; }

table.simpletable {
  padding: 5px;
  font-size:12pt;
  margin:20px;
  border-collapse: collapse; border-spacing: 0px;
}
td.rowname {
  text-align: right;
  vertical-align: top;
  font-weight: bold;
  color:#444444;
  padding-right:2ex;
}

/* Hidden text. */
input.spoilerhider + label {
  cursor: pointer;
  text-decoration: underline;
  display: block;
}
input.spoilerhider {
 display: none;
}
input.spoilerhider ~ .spoiler {
  overflow: hidden;
  margin: 10px auto 0;
  height: 0;
  opacity: 0;
}
input.spoilerhider:checked + label + .spoiler{
  height: auto;
  opacity: 1;
}
</style>
</head>
<body>
<!-- BUGDESC Call to function 'sprintf' is insecure as it does not provide bounding of the memory buffer or security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'sprintf_s' in case of C11 -->

<!-- BUGTYPE Potential insecure memory buffer bounds restriction in call 'sprintf' -->

<!-- BUGCATEGORY Security -->

<!-- BUGFILE /tmp/real/c_wrk/wrk5/deps/luajit/src/lib_string.c -->

<!-- FILENAME lib_string.c -->

<!-- FUNCTIONNAME lj_cf_string_format -->

<!-- ISSUEHASHCONTENTOFLINEINCONTEXT b964973564704b8a89f304192a5e9d48 -->

<!-- BUGLINE 883 -->

<!-- BUGCOLUMN 4 -->

<!-- BUGPATHLENGTH 1 -->

<!-- BUGMETAEND -->
<!-- REPORTHEADER -->
<h3>Bug Summary</h3>
<table class="simpletable">
<tr><td class="rowname">File:</td><td>deps/luajit/src/lib_string.c</td></tr>
<tr><td class="rowname">Warning:</td><td><a href="#EndPath">line 883, column 4</a><br />Call to function 'sprintf' is insecure as it does not provide bounding of the memory buffer or security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'sprintf_s' in case of C11</td></tr>

</table>
<!-- REPORTSUMMARYEXTRA -->
<h3>Annotated Source Code</h3>
<p>Press <a href="#" onclick="toggleHelp(); return false;">'?'</a>
   to see keyboard shortcuts</p>
<input type="checkbox" class="spoilerhider" id="showinvocation" />
<label for="showinvocation" >Show analyzer invocation</label>
<div class="spoiler">clang -cc1 -cc1 -triple x86_64-unknown-linux-gnu -analyze -disable-free -main-file-name lib_string.c -analyzer-store=region -analyzer-opt-analyze-nested-blocks -analyzer-checker=core -analyzer-checker=apiModeling -analyzer-checker=unix -analyzer-checker=deadcode -analyzer-checker=security.insecureAPI.UncheckedReturn -analyzer-checker=security.insecureAPI.getpw -analyzer-checker=security.insecureAPI.gets -analyzer-checker=security.insecureAPI.mktemp -analyzer-checker=security.insecureAPI.mkstemp -analyzer-checker=security.insecureAPI.vfork -analyzer-checker=nullability.NullPassedToNonnull -analyzer-checker=nullability.NullReturnedFromNonnull -analyzer-output plist -w -setup-static-analyzer -mrelocation-model static -mframe-pointer=none -fmath-errno -fno-rounding-math -mconstructor-aliases -munwind-tables -target-cpu x86-64 -fno-split-dwarf-inlining -debugger-tuning=gdb -resource-dir /llvm-project/build/lib/clang/12.0.0 -D _FILE_OFFSET_BITS=64 -D _LARGEFILE_SOURCE -U _FORTIFY_SOURCE -internal-isystem /usr/local/include -internal-isystem /llvm-project/build/lib/clang/12.0.0/include -internal-externc-isystem /usr/include/x86_64-linux-gnu -internal-externc-isystem /include -internal-externc-isystem /usr/include -O2 -fdebug-compilation-dir /tmp/real/c_wrk/wrk5/deps/luajit/src -ferror-limit 19 -fgnuc-version=4.2.1 -vectorize-loops -vectorize-slp -analyzer-checker core -analyzer-checker cplusplus -analyzer-checker nullability -analyzer-checker optin -analyzer-checker security -analyzer-checker unix -analyzer-checker osx -analyzer-checker fuchsia -analyzer-checker webkit -analyzer-output=html -faddrsig -o /tmp/scan-build-2020-11-20-011311-6659-1 -x c lib_string.c
</div>
<div id='tooltiphint' hidden="true">
  <p>Keyboard shortcuts: </p>
  <ul>
    <li>Use 'j/k' keys for keyboard navigation</li>
    <li>Use 'Shift+S' to show/hide relevant lines</li>
    <li>Use '?' to toggle this window</li>
  </ul>
  <a href="#" onclick="toggleHelp(); return false;">Close</a>
</div>
<script type='text/javascript'>
var relevant_lines = {"1": {"883": 1}};

var filterCounterexample = function (hide) {
  var tables = document.getElementsByClassName("code");
  for (var t=0; t<tables.length; t++) {
    var table = tables[t];
    var file_id = table.getAttribute("data-fileid");
    var lines_in_fid = relevant_lines[file_id];
    if (!lines_in_fid) {
      lines_in_fid = {};
    }
    var lines = table.getElementsByClassName("codeline");
    for (var i=0; i<lines.length; i++) {
        var el = lines[i];
        var lineNo = el.getAttribute("data-linenumber");
        if (!lines_in_fid[lineNo]) {
          if (hide) {
            el.setAttribute("hidden", "");
          } else {
            el.removeAttribute("hidden");
          }
        }
    }
  }
}

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "S") {
    var checked = document.getElementsByName("showCounterexample")[0].checked;
    filterCounterexample(!checked);
    document.getElementsByName("showCounterexample")[0].checked = !checked;
  } else {
    return;
  }
  event.preventDefault();
}, true);

document.addEventListener("DOMContentLoaded", function() {
    document.querySelector('input[name="showCounterexample"]').onchange=
        function (event) {
      filterCounterexample(this.checked);
    };
});
</script>

<form>
    <input type="checkbox" name="showCounterexample" id="showCounterexample" />
    <label for="showCounterexample">
       Show only relevant lines
    </label>
</form>

<script type='text/javascript'>
var digitMatcher = new RegExp("[0-9]+");

var querySelectorAllArray = function(selector) {
  return Array.prototype.slice.call(
    document.querySelectorAll(selector));
}

document.addEventListener("DOMContentLoaded", function() {
    querySelectorAllArray(".PathNav > a").forEach(
        function(currentValue, currentIndex) {
            var hrefValue = currentValue.getAttribute("href");
            currentValue.onclick = function() {
                scrollTo(document.querySelector(hrefValue));
                return false;
            };
        });
});

var findNum = function() {
    var s = document.querySelector(".selected");
    if (!s || s.id == "EndPath") {
        return 0;
    }
    var out = parseInt(digitMatcher.exec(s.id)[0]);
    return out;
};

var scrollTo = function(el) {
    querySelectorAllArray(".selected").forEach(function(s) {
        s.classList.remove("selected");
    });
    el.classList.add("selected");
    window.scrollBy(0, el.getBoundingClientRect().top -
        (window.innerHeight / 2));
}

var move = function(num, up, numItems) {
  if (num == 1 && up || num == numItems - 1 && !up) {
    return 0;
  } else if (num == 0 && up) {
    return numItems - 1;
  } else if (num == 0 && !up) {
    return 1 % numItems;
  }
  return up ? num - 1 : num + 1;
}

var numToId = function(num) {
  if (num == 0) {
    return document.getElementById("EndPath")
  }
  return document.getElementById("Path" + num);
};

var navigateTo = function(up) {
  var numItems = document.querySelectorAll(
      ".line > .msgEvent, .line > .msgControl").length;
  var currentSelected = findNum();
  var newSelected = move(currentSelected, up, numItems);
  var newEl = numToId(newSelected, numItems);

  // Scroll element into center.
  scrollTo(newEl);
};

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "j") {
    navigateTo(/*up=*/false);
  } else if (event.key == "k") {
    navigateTo(/*up=*/true);
  } else {
    return;
  }
  event.preventDefault();
}, true);
</script>
  
<script type='text/javascript'>

var toggleHelp = function() {
    var hint = document.querySelector("#tooltiphint");
    var attributeName = "hidden";
    if (hint.hasAttribute(attributeName)) {
      hint.removeAttribute(attributeName);
    } else {
      hint.setAttribute("hidden", "true");
    }
};
window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "?") {
    toggleHelp();
  } else {
    return;
  }
  event.preventDefault();
});
</script>
<table class="code" data-fileid="1">
<tr class="codeline" data-linenumber="1"><td class="num" id="LN1">1</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2"><td class="num" id="LN2">2</td><td class="line"><span class='comment'>** String library.</span></td></tr>
<tr class="codeline" data-linenumber="3"><td class="num" id="LN3">3</td><td class="line"><span class='comment'>** Copyright (C) 2005-2013 Mike Pall. See Copyright Notice in luajit.h</span></td></tr>
<tr class="codeline" data-linenumber="4"><td class="num" id="LN4">4</td><td class="line"><span class='comment'>**</span></td></tr>
<tr class="codeline" data-linenumber="5"><td class="num" id="LN5">5</td><td class="line"><span class='comment'>** Major portions taken verbatim or adapted from the Lua interpreter.</span></td></tr>
<tr class="codeline" data-linenumber="6"><td class="num" id="LN6">6</td><td class="line"><span class='comment'>** Copyright (C) 1994-2008 Lua.org, PUC-Rio. See Copyright Notice in lua.h</span></td></tr>
<tr class="codeline" data-linenumber="7"><td class="num" id="LN7">7</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="8"><td class="num" id="LN8">8</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="9"><td class="num" id="LN9">9</td><td class="line"><span class='directive'>#include &lt;stdio.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="10"><td class="num" id="LN10">10</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="11"><td class="num" id="LN11">11</td><td class="line"><span class='directive'>#define lib_string_c</span></td></tr>
<tr class="codeline" data-linenumber="12"><td class="num" id="LN12">12</td><td class="line"><span class='directive'>#define LUA_LIB</span></td></tr>
<tr class="codeline" data-linenumber="13"><td class="num" id="LN13">13</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="14"><td class="num" id="LN14">14</td><td class="line"><span class='directive'>#include "lua.h"</span></td></tr>
<tr class="codeline" data-linenumber="15"><td class="num" id="LN15">15</td><td class="line"><span class='directive'>#include "lauxlib.h"</span></td></tr>
<tr class="codeline" data-linenumber="16"><td class="num" id="LN16">16</td><td class="line"><span class='directive'>#include "lualib.h"</span></td></tr>
<tr class="codeline" data-linenumber="17"><td class="num" id="LN17">17</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="18"><td class="num" id="LN18">18</td><td class="line"><span class='directive'>#include "lj_obj.h"</span></td></tr>
<tr class="codeline" data-linenumber="19"><td class="num" id="LN19">19</td><td class="line"><span class='directive'>#include "lj_gc.h"</span></td></tr>
<tr class="codeline" data-linenumber="20"><td class="num" id="LN20">20</td><td class="line"><span class='directive'>#include "lj_err.h"</span></td></tr>
<tr class="codeline" data-linenumber="21"><td class="num" id="LN21">21</td><td class="line"><span class='directive'>#include "lj_str.h"</span></td></tr>
<tr class="codeline" data-linenumber="22"><td class="num" id="LN22">22</td><td class="line"><span class='directive'>#include "lj_tab.h"</span></td></tr>
<tr class="codeline" data-linenumber="23"><td class="num" id="LN23">23</td><td class="line"><span class='directive'>#include "lj_meta.h"</span></td></tr>
<tr class="codeline" data-linenumber="24"><td class="num" id="LN24">24</td><td class="line"><span class='directive'>#include "lj_state.h"</span></td></tr>
<tr class="codeline" data-linenumber="25"><td class="num" id="LN25">25</td><td class="line"><span class='directive'>#include "lj_ff.h"</span></td></tr>
<tr class="codeline" data-linenumber="26"><td class="num" id="LN26">26</td><td class="line"><span class='directive'>#include "lj_bcdump.h"</span></td></tr>
<tr class="codeline" data-linenumber="27"><td class="num" id="LN27">27</td><td class="line"><span class='directive'>#include "lj_char.h"</span></td></tr>
<tr class="codeline" data-linenumber="28"><td class="num" id="LN28">28</td><td class="line"><span class='directive'>#include "lj_lib.h"</span></td></tr>
<tr class="codeline" data-linenumber="29"><td class="num" id="LN29">29</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="30"><td class="num" id="LN30">30</td><td class="line"><span class='comment'>/* ------------------------------------------------------------------------ */</span></td></tr>
<tr class="codeline" data-linenumber="31"><td class="num" id="LN31">31</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="32"><td class="num" id="LN32">32</td><td class="line"><span class='directive'>#define LJLIB_MODULE_string</span></td></tr>
<tr class="codeline" data-linenumber="33"><td class="num" id="LN33">33</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="34"><td class="num" id="LN34">34</td><td class="line"><span class='macro'>LJLIB_ASM(string_len)<span class='macro_popup'>static int lj_ffh_string_len(lua_State *L)</span></span>		LJLIB_REC(.)</td></tr>
<tr class="codeline" data-linenumber="35"><td class="num" id="LN35">35</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="36"><td class="num" id="LN36">36</td><td class="line">  lj_lib_checkstr(L, 1);</td></tr>
<tr class="codeline" data-linenumber="37"><td class="num" id="LN37">37</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>FFH_RETRY<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="38"><td class="num" id="LN38">38</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="39"><td class="num" id="LN39">39</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="40"><td class="num" id="LN40">40</td><td class="line"><span class='macro'>LJLIB_ASM(string_byte)<span class='macro_popup'>static int lj_ffh_string_byte(lua_State *L)</span></span>		LJLIB_REC(string_range 0)</td></tr>
<tr class="codeline" data-linenumber="41"><td class="num" id="LN41">41</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="42"><td class="num" id="LN42">42</td><td class="line">  GCstr *s = lj_lib_checkstr(L, 1);</td></tr>
<tr class="codeline" data-linenumber="43"><td class="num" id="LN43">43</td><td class="line">  int32_t len = (int32_t)s-&gt;len;</td></tr>
<tr class="codeline" data-linenumber="44"><td class="num" id="LN44">44</td><td class="line">  int32_t start = lj_lib_optint(L, 2, 1);</td></tr>
<tr class="codeline" data-linenumber="45"><td class="num" id="LN45">45</td><td class="line">  int32_t stop = lj_lib_optint(L, 3, start);</td></tr>
<tr class="codeline" data-linenumber="46"><td class="num" id="LN46">46</td><td class="line">  int32_t n, i;</td></tr>
<tr class="codeline" data-linenumber="47"><td class="num" id="LN47">47</td><td class="line">  <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p;</td></tr>
<tr class="codeline" data-linenumber="48"><td class="num" id="LN48">48</td><td class="line">  <span class='keyword'>if</span> (stop &lt; 0) stop += len+1;</td></tr>
<tr class="codeline" data-linenumber="49"><td class="num" id="LN49">49</td><td class="line">  <span class='keyword'>if</span> (start &lt; 0) start += len+1;</td></tr>
<tr class="codeline" data-linenumber="50"><td class="num" id="LN50">50</td><td class="line">  <span class='keyword'>if</span> (start &lt;= 0) start = 1;</td></tr>
<tr class="codeline" data-linenumber="51"><td class="num" id="LN51">51</td><td class="line">  <span class='keyword'>if</span> (stop &gt; len) stop = len;</td></tr>
<tr class="codeline" data-linenumber="52"><td class="num" id="LN52">52</td><td class="line">  <span class='keyword'>if</span> (start &gt; stop) <span class='keyword'>return</span> <span class='macro'>FFH_RES(0)<span class='macro_popup'>((0)+1)</span></span>;  <span class='comment'>/* Empty interval: return no results. */</span></td></tr>
<tr class="codeline" data-linenumber="53"><td class="num" id="LN53">53</td><td class="line">  start--;</td></tr>
<tr class="codeline" data-linenumber="54"><td class="num" id="LN54">54</td><td class="line">  n = stop - start;</td></tr>
<tr class="codeline" data-linenumber="55"><td class="num" id="LN55">55</td><td class="line">  <span class='keyword'>if</span> ((uint32_t)n &gt; <span class='macro'>LUAI_MAXCSTACK<span class='macro_popup'>8000</span></span>)</td></tr>
<tr class="codeline" data-linenumber="56"><td class="num" id="LN56">56</td><td class="line">    lj_err_caller(L, LJ_ERR_STRSLC);</td></tr>
<tr class="codeline" data-linenumber="57"><td class="num" id="LN57">57</td><td class="line">  lj_state_checkstack(L, (MSize)n);</td></tr>
<tr class="codeline" data-linenumber="58"><td class="num" id="LN58">58</td><td class="line">  p = (<span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *)<span class='macro'>strdata(s)<span class='macro_popup'>((const char *)((s)+1))</span></span> + start;</td></tr>
<tr class="codeline" data-linenumber="59"><td class="num" id="LN59">59</td><td class="line">  <span class='keyword'>for</span> (i = 0; i &lt; n; i++)</td></tr>
<tr class="codeline" data-linenumber="60"><td class="num" id="LN60">60</td><td class="line">    setintV(L-&gt;base + i-1, p[i]);</td></tr>
<tr class="codeline" data-linenumber="61"><td class="num" id="LN61">61</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>FFH_RES(n)<span class='macro_popup'>((n)+1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="62"><td class="num" id="LN62">62</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="63"><td class="num" id="LN63">63</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="64"><td class="num" id="LN64">64</td><td class="line"><span class='macro'>LJLIB_ASM(string_char)<span class='macro_popup'>static int lj_ffh_string_char(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="65"><td class="num" id="LN65">65</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="66"><td class="num" id="LN66">66</td><td class="line">  <span class='keyword'>int</span> i, nargs = (<span class='keyword'>int</span>)(L-&gt;top - L-&gt;base);</td></tr>
<tr class="codeline" data-linenumber="67"><td class="num" id="LN67">67</td><td class="line">  <span class='keyword'>char</span> *buf = lj_str_needbuf(L, &amp;<span class='macro'>G(L)<span class='macro_popup'>(((global_State *)(void *)(uintptr_t)(L-&gt;glref).ptr32))</span></span>-&gt;tmpbuf, (size_t)nargs);</td></tr>
<tr class="codeline" data-linenumber="68"><td class="num" id="LN68">68</td><td class="line">  <span class='keyword'>for</span> (i = 1; i &lt;= nargs; i++) {</td></tr>
<tr class="codeline" data-linenumber="69"><td class="num" id="LN69">69</td><td class="line">    int32_t k = lj_lib_checkint(L, i);</td></tr>
<tr class="codeline" data-linenumber="70"><td class="num" id="LN70">70</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>checku8(k)<span class='macro_popup'>((k) == (int32_t)(uint8_t)(k))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="71"><td class="num" id="LN71">71</td><td class="line">      lj_err_arg(L, i, LJ_ERR_BADVAL);</td></tr>
<tr class="codeline" data-linenumber="72"><td class="num" id="LN72">72</td><td class="line">    buf[i-1] = (<span class='keyword'>char</span>)k;</td></tr>
<tr class="codeline" data-linenumber="73"><td class="num" id="LN73">73</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="74"><td class="num" id="LN74">74</td><td class="line">  setstrV(L, L-&gt;base-1, lj_str_new(L, buf, (size_t)nargs));</td></tr>
<tr class="codeline" data-linenumber="75"><td class="num" id="LN75">75</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>FFH_RES(1)<span class='macro_popup'>((1)+1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="76"><td class="num" id="LN76">76</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="77"><td class="num" id="LN77">77</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="78"><td class="num" id="LN78">78</td><td class="line"><span class='macro'>LJLIB_ASM(string_sub)<span class='macro_popup'>static int lj_ffh_string_sub(lua_State *L)</span></span>		LJLIB_REC(string_range 1)</td></tr>
<tr class="codeline" data-linenumber="79"><td class="num" id="LN79">79</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="80"><td class="num" id="LN80">80</td><td class="line">  lj_lib_checkstr(L, 1);</td></tr>
<tr class="codeline" data-linenumber="81"><td class="num" id="LN81">81</td><td class="line">  lj_lib_checkint(L, 2);</td></tr>
<tr class="codeline" data-linenumber="82"><td class="num" id="LN82">82</td><td class="line">  setintV(L-&gt;base+2, lj_lib_optint(L, 3, -1));</td></tr>
<tr class="codeline" data-linenumber="83"><td class="num" id="LN83">83</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>FFH_RETRY<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="84"><td class="num" id="LN84">84</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="85"><td class="num" id="LN85">85</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="86"><td class="num" id="LN86">86</td><td class="line"><span class='macro'>LJLIB_ASM(string_rep)<span class='macro_popup'>static int lj_ffh_string_rep(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="87"><td class="num" id="LN87">87</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="88"><td class="num" id="LN88">88</td><td class="line">  GCstr *s = lj_lib_checkstr(L, 1);</td></tr>
<tr class="codeline" data-linenumber="89"><td class="num" id="LN89">89</td><td class="line">  int32_t k = lj_lib_checkint(L, 2);</td></tr>
<tr class="codeline" data-linenumber="90"><td class="num" id="LN90">90</td><td class="line">  GCstr *sep = lj_lib_optstr(L, 3);</td></tr>
<tr class="codeline" data-linenumber="91"><td class="num" id="LN91">91</td><td class="line">  int32_t len = (int32_t)s-&gt;len;</td></tr>
<tr class="codeline" data-linenumber="92"><td class="num" id="LN92">92</td><td class="line">  global_State *g = <span class='macro'>G(L)<span class='macro_popup'>(((global_State *)(void *)(uintptr_t)(L-&gt;glref).ptr32))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="93"><td class="num" id="LN93">93</td><td class="line">  int64_t tlen;</td></tr>
<tr class="codeline" data-linenumber="94"><td class="num" id="LN94">94</td><td class="line">  <span class='keyword'>const</span> <span class='keyword'>char</span> *src;</td></tr>
<tr class="codeline" data-linenumber="95"><td class="num" id="LN95">95</td><td class="line">  <span class='keyword'>char</span> *buf;</td></tr>
<tr class="codeline" data-linenumber="96"><td class="num" id="LN96">96</td><td class="line">  <span class='keyword'>if</span> (k &lt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="97"><td class="num" id="LN97">97</td><td class="line">  empty:</td></tr>
<tr class="codeline" data-linenumber="98"><td class="num" id="LN98">98</td><td class="line">    setstrV(L, L-&gt;base-1, &amp;g-&gt;strempty);</td></tr>
<tr class="codeline" data-linenumber="99"><td class="num" id="LN99">99</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>FFH_RES(1)<span class='macro_popup'>((1)+1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="100"><td class="num" id="LN100">100</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="101"><td class="num" id="LN101">101</td><td class="line">  <span class='keyword'>if</span> (sep) {</td></tr>
<tr class="codeline" data-linenumber="102"><td class="num" id="LN102">102</td><td class="line">    tlen = (int64_t)len + sep-&gt;len;</td></tr>
<tr class="codeline" data-linenumber="103"><td class="num" id="LN103">103</td><td class="line">    <span class='keyword'>if</span> (tlen &gt; <span class='macro'>LJ_MAX_STR<span class='macro_popup'>0x7fffff00</span></span>)</td></tr>
<tr class="codeline" data-linenumber="104"><td class="num" id="LN104">104</td><td class="line">      lj_err_caller(L, LJ_ERR_STROV);</td></tr>
<tr class="codeline" data-linenumber="105"><td class="num" id="LN105">105</td><td class="line">    tlen *= k;</td></tr>
<tr class="codeline" data-linenumber="106"><td class="num" id="LN106">106</td><td class="line">    <span class='keyword'>if</span> (tlen &gt; <span class='macro'>LJ_MAX_STR<span class='macro_popup'>0x7fffff00</span></span>)</td></tr>
<tr class="codeline" data-linenumber="107"><td class="num" id="LN107">107</td><td class="line">      lj_err_caller(L, LJ_ERR_STROV);</td></tr>
<tr class="codeline" data-linenumber="108"><td class="num" id="LN108">108</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="109"><td class="num" id="LN109">109</td><td class="line">    tlen = (int64_t)k * len;</td></tr>
<tr class="codeline" data-linenumber="110"><td class="num" id="LN110">110</td><td class="line">    <span class='keyword'>if</span> (tlen &gt; <span class='macro'>LJ_MAX_STR<span class='macro_popup'>0x7fffff00</span></span>)</td></tr>
<tr class="codeline" data-linenumber="111"><td class="num" id="LN111">111</td><td class="line">      lj_err_caller(L, LJ_ERR_STROV);</td></tr>
<tr class="codeline" data-linenumber="112"><td class="num" id="LN112">112</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="113"><td class="num" id="LN113">113</td><td class="line">  <span class='keyword'>if</span> (tlen == 0) <span class='keyword'>goto</span> empty;</td></tr>
<tr class="codeline" data-linenumber="114"><td class="num" id="LN114">114</td><td class="line">  buf = lj_str_needbuf(L, &amp;g-&gt;tmpbuf, (MSize)tlen);</td></tr>
<tr class="codeline" data-linenumber="115"><td class="num" id="LN115">115</td><td class="line">  src = <span class='macro'>strdata(s)<span class='macro_popup'>((const char *)((s)+1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="116"><td class="num" id="LN116">116</td><td class="line">  <span class='keyword'>if</span> (sep) {</td></tr>
<tr class="codeline" data-linenumber="117"><td class="num" id="LN117">117</td><td class="line">    tlen -= sep-&gt;len;  <span class='comment'>/* Ignore trailing separator. */</span></td></tr>
<tr class="codeline" data-linenumber="118"><td class="num" id="LN118">118</td><td class="line">    <span class='keyword'>if</span> (k &gt; 1) {  <span class='comment'>/* Paste one string and one separator. */</span></td></tr>
<tr class="codeline" data-linenumber="119"><td class="num" id="LN119">119</td><td class="line">      int32_t i;</td></tr>
<tr class="codeline" data-linenumber="120"><td class="num" id="LN120">120</td><td class="line">      i = 0; <span class='keyword'>while</span> (i &lt; len) *buf++ = src[i++];</td></tr>
<tr class="codeline" data-linenumber="121"><td class="num" id="LN121">121</td><td class="line">      src = <span class='macro'>strdata(sep)<span class='macro_popup'>((const char *)((sep)+1))</span></span>; len = sep-&gt;len;</td></tr>
<tr class="codeline" data-linenumber="122"><td class="num" id="LN122">122</td><td class="line">      i = 0; <span class='keyword'>while</span> (i &lt; len) *buf++ = src[i++];</td></tr>
<tr class="codeline" data-linenumber="123"><td class="num" id="LN123">123</td><td class="line">      src = g-&gt;tmpbuf.buf; len += s-&gt;len; k--;  <span class='comment'>/* Now copy that k-1 times. */</span></td></tr>
<tr class="codeline" data-linenumber="124"><td class="num" id="LN124">124</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="125"><td class="num" id="LN125">125</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="126"><td class="num" id="LN126">126</td><td class="line">  <span class='keyword'>do</span> {</td></tr>
<tr class="codeline" data-linenumber="127"><td class="num" id="LN127">127</td><td class="line">    int32_t i = 0;</td></tr>
<tr class="codeline" data-linenumber="128"><td class="num" id="LN128">128</td><td class="line">    <span class='keyword'>do</span> { *buf++ = src[i++]; } <span class='keyword'>while</span> (i &lt; len);</td></tr>
<tr class="codeline" data-linenumber="129"><td class="num" id="LN129">129</td><td class="line">  } <span class='keyword'>while</span> (--k &gt; 0);</td></tr>
<tr class="codeline" data-linenumber="130"><td class="num" id="LN130">130</td><td class="line">  setstrV(L, L-&gt;base-1, lj_str_new(L, g-&gt;tmpbuf.buf, (size_t)tlen));</td></tr>
<tr class="codeline" data-linenumber="131"><td class="num" id="LN131">131</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>FFH_RES(1)<span class='macro_popup'>((1)+1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="132"><td class="num" id="LN132">132</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="133"><td class="num" id="LN133">133</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="134"><td class="num" id="LN134">134</td><td class="line"><span class='macro'>LJLIB_ASM(string_reverse)<span class='macro_popup'>static int lj_ffh_string_reverse(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="135"><td class="num" id="LN135">135</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="136"><td class="num" id="LN136">136</td><td class="line">  GCstr *s = lj_lib_checkstr(L, 1);</td></tr>
<tr class="codeline" data-linenumber="137"><td class="num" id="LN137">137</td><td class="line">  lj_str_needbuf(L, &amp;<span class='macro'>G(L)<span class='macro_popup'>(((global_State *)(void *)(uintptr_t)(L-&gt;glref).ptr32))</span></span>-&gt;tmpbuf, s-&gt;len);</td></tr>
<tr class="codeline" data-linenumber="138"><td class="num" id="LN138">138</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>FFH_RETRY<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="139"><td class="num" id="LN139">139</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="140"><td class="num" id="LN140">140</td><td class="line">LJLIB_ASM_(string_lower)</td></tr>
<tr class="codeline" data-linenumber="141"><td class="num" id="LN141">141</td><td class="line">LJLIB_ASM_(string_upper)</td></tr>
<tr class="codeline" data-linenumber="142"><td class="num" id="LN142">142</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="143"><td class="num" id="LN143">143</td><td class="line"><span class='comment'>/* ------------------------------------------------------------------------ */</span></td></tr>
<tr class="codeline" data-linenumber="144"><td class="num" id="LN144">144</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="145"><td class="num" id="LN145">145</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> writer_buf(lua_State *L, <span class='keyword'>const</span> <span class='keyword'>void</span> *p, size_t size, <span class='keyword'>void</span> *b)</td></tr>
<tr class="codeline" data-linenumber="146"><td class="num" id="LN146">146</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="147"><td class="num" id="LN147">147</td><td class="line">  luaL_addlstring((luaL_Buffer *)b, (<span class='keyword'>const</span> <span class='keyword'>char</span> *)p, size);</td></tr>
<tr class="codeline" data-linenumber="148"><td class="num" id="LN148">148</td><td class="line">  <span class='macro'>UNUSED(L)<span class='macro_popup'>((void)(L))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="149"><td class="num" id="LN149">149</td><td class="line">  <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="150"><td class="num" id="LN150">150</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="151"><td class="num" id="LN151">151</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="152"><td class="num" id="LN152">152</td><td class="line"><span class='macro'>LJLIB_CF(string_dump)<span class='macro_popup'>static int lj_cf_string_dump(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="153"><td class="num" id="LN153">153</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="154"><td class="num" id="LN154">154</td><td class="line">  GCfunc *fn = lj_lib_checkfunc(L, 1);</td></tr>
<tr class="codeline" data-linenumber="155"><td class="num" id="LN155">155</td><td class="line">  <span class='keyword'>int</span> strip = L-&gt;base+1 &lt; L-&gt;top &amp;&amp; <span class='macro'>tvistruecond(L-&gt;base+1)<span class='macro_popup'>(((L-&gt;base+1)-&gt;it) &lt; (~1u))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="156"><td class="num" id="LN156">156</td><td class="line">  luaL_Buffer b;</td></tr>
<tr class="codeline" data-linenumber="157"><td class="num" id="LN157">157</td><td class="line">  L-&gt;top = L-&gt;base+1;</td></tr>
<tr class="codeline" data-linenumber="158"><td class="num" id="LN158">158</td><td class="line">  luaL_buffinit(L, &amp;b);</td></tr>
<tr class="codeline" data-linenumber="159"><td class="num" id="LN159">159</td><td class="line">  <span class='keyword'>if</span> (!<span class='macro'>isluafunc(fn)<span class='macro_popup'>((fn)-&gt;c.ffid == 0)</span></span> || lj_bcwrite(L, <span class='macro'>funcproto(fn)<span class='macro_popup'>(((void)0), ((GCproto *)(((char *)(void *)(uintptr_t)((fn)-&gt;<br>l.pc).ptr32)-sizeof(GCproto))))</span></span>, writer_buf, &amp;b, strip))</td></tr>
<tr class="codeline" data-linenumber="160"><td class="num" id="LN160">160</td><td class="line">    lj_err_caller(L, LJ_ERR_STRDUMP);</td></tr>
<tr class="codeline" data-linenumber="161"><td class="num" id="LN161">161</td><td class="line">  luaL_pushresult(&amp;b);</td></tr>
<tr class="codeline" data-linenumber="162"><td class="num" id="LN162">162</td><td class="line">  <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="163"><td class="num" id="LN163">163</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="164"><td class="num" id="LN164">164</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="165"><td class="num" id="LN165">165</td><td class="line"><span class='comment'>/* ------------------------------------------------------------------------ */</span></td></tr>
<tr class="codeline" data-linenumber="166"><td class="num" id="LN166">166</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="167"><td class="num" id="LN167">167</td><td class="line"><span class='comment'>/* macro to `unsign' a character */</span></td></tr>
<tr class="codeline" data-linenumber="168"><td class="num" id="LN168">168</td><td class="line"><span class='directive'>#define <span class='macro'>uchar(c)<span class='macro_popup'>((unsigned char)(c))</span></span>        ((unsigned char)(c))</span></td></tr>
<tr class="codeline" data-linenumber="169"><td class="num" id="LN169">169</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="170"><td class="num" id="LN170">170</td><td class="line"><span class='directive'>#define <span class='macro'>CAP_UNFINISHED<span class='macro_popup'>(-1)</span></span>	(-1)</span></td></tr>
<tr class="codeline" data-linenumber="171"><td class="num" id="LN171">171</td><td class="line"><span class='directive'>#define <span class='macro'>CAP_POSITION<span class='macro_popup'>(-2)</span></span>	(-2)</span></td></tr>
<tr class="codeline" data-linenumber="172"><td class="num" id="LN172">172</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="173"><td class="num" id="LN173">173</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> MatchState {</td></tr>
<tr class="codeline" data-linenumber="174"><td class="num" id="LN174">174</td><td class="line">  <span class='keyword'>const</span> <span class='keyword'>char</span> *src_init;  <span class='comment'>/* init of source string */</span></td></tr>
<tr class="codeline" data-linenumber="175"><td class="num" id="LN175">175</td><td class="line">  <span class='keyword'>const</span> <span class='keyword'>char</span> *src_end;  <span class='comment'>/* end (`\0') of source string */</span></td></tr>
<tr class="codeline" data-linenumber="176"><td class="num" id="LN176">176</td><td class="line">  lua_State *L;</td></tr>
<tr class="codeline" data-linenumber="177"><td class="num" id="LN177">177</td><td class="line">  <span class='keyword'>int</span> level;  <span class='comment'>/* total number of captures (finished or unfinished) */</span></td></tr>
<tr class="codeline" data-linenumber="178"><td class="num" id="LN178">178</td><td class="line">  <span class='keyword'>int</span> depth;</td></tr>
<tr class="codeline" data-linenumber="179"><td class="num" id="LN179">179</td><td class="line">  <span class='keyword'>struct</span> {</td></tr>
<tr class="codeline" data-linenumber="180"><td class="num" id="LN180">180</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span> *init;</td></tr>
<tr class="codeline" data-linenumber="181"><td class="num" id="LN181">181</td><td class="line">    ptrdiff_t len;</td></tr>
<tr class="codeline" data-linenumber="182"><td class="num" id="LN182">182</td><td class="line">  } capture[<span class='macro'>LUA_MAXCAPTURES<span class='macro_popup'>32</span></span>];</td></tr>
<tr class="codeline" data-linenumber="183"><td class="num" id="LN183">183</td><td class="line">} MatchState;</td></tr>
<tr class="codeline" data-linenumber="184"><td class="num" id="LN184">184</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="185"><td class="num" id="LN185">185</td><td class="line"><span class='directive'>#define <span class='macro'>L_ESC<span class='macro_popup'>'%'</span></span>		'%'</span></td></tr>
<tr class="codeline" data-linenumber="186"><td class="num" id="LN186">186</td><td class="line"><span class='directive'>#define <span class='macro'>SPECIALS<span class='macro_popup'>"^$*+?.([%-"</span></span>	"^$*+?.([%-"</span></td></tr>
<tr class="codeline" data-linenumber="187"><td class="num" id="LN187">187</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="188"><td class="num" id="LN188">188</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> check_capture(MatchState *ms, <span class='keyword'>int</span> l)</td></tr>
<tr class="codeline" data-linenumber="189"><td class="num" id="LN189">189</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="190"><td class="num" id="LN190">190</td><td class="line">  l -= '1';</td></tr>
<tr class="codeline" data-linenumber="191"><td class="num" id="LN191">191</td><td class="line">  <span class='keyword'>if</span> (l &lt; 0 || l &gt;= ms-&gt;level || ms-&gt;capture[l].len == <span class='macro'>CAP_UNFINISHED<span class='macro_popup'>(-1)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="192"><td class="num" id="LN192">192</td><td class="line">    lj_err_caller(ms-&gt;L, LJ_ERR_STRCAPI);</td></tr>
<tr class="codeline" data-linenumber="193"><td class="num" id="LN193">193</td><td class="line">  <span class='keyword'>return</span> l;</td></tr>
<tr class="codeline" data-linenumber="194"><td class="num" id="LN194">194</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="195"><td class="num" id="LN195">195</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="196"><td class="num" id="LN196">196</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> capture_to_close(MatchState *ms)</td></tr>
<tr class="codeline" data-linenumber="197"><td class="num" id="LN197">197</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="198"><td class="num" id="LN198">198</td><td class="line">  <span class='keyword'>int</span> level = ms-&gt;level;</td></tr>
<tr class="codeline" data-linenumber="199"><td class="num" id="LN199">199</td><td class="line">  <span class='keyword'>for</span> (level--; level&gt;=0; level--)</td></tr>
<tr class="codeline" data-linenumber="200"><td class="num" id="LN200">200</td><td class="line">    <span class='keyword'>if</span> (ms-&gt;capture[level].len == <span class='macro'>CAP_UNFINISHED<span class='macro_popup'>(-1)</span></span>) <span class='keyword'>return</span> level;</td></tr>
<tr class="codeline" data-linenumber="201"><td class="num" id="LN201">201</td><td class="line">  lj_err_caller(ms-&gt;L, LJ_ERR_STRPATC);</td></tr>
<tr class="codeline" data-linenumber="202"><td class="num" id="LN202">202</td><td class="line">  <span class='keyword'>return</span> 0;  <span class='comment'>/* unreachable */</span></td></tr>
<tr class="codeline" data-linenumber="203"><td class="num" id="LN203">203</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="204"><td class="num" id="LN204">204</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="205"><td class="num" id="LN205">205</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span> *classend(MatchState *ms, <span class='keyword'>const</span> <span class='keyword'>char</span> *p)</td></tr>
<tr class="codeline" data-linenumber="206"><td class="num" id="LN206">206</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="207"><td class="num" id="LN207">207</td><td class="line">  <span class='keyword'>switch</span> (*p++) {</td></tr>
<tr class="codeline" data-linenumber="208"><td class="num" id="LN208">208</td><td class="line">  <span class='keyword'>case</span> <span class='macro'>L_ESC<span class='macro_popup'>'%'</span></span>:</td></tr>
<tr class="codeline" data-linenumber="209"><td class="num" id="LN209">209</td><td class="line">    <span class='keyword'>if</span> (*p == '\0')</td></tr>
<tr class="codeline" data-linenumber="210"><td class="num" id="LN210">210</td><td class="line">      lj_err_caller(ms-&gt;L, LJ_ERR_STRPATE);</td></tr>
<tr class="codeline" data-linenumber="211"><td class="num" id="LN211">211</td><td class="line">    <span class='keyword'>return</span> p+1;</td></tr>
<tr class="codeline" data-linenumber="212"><td class="num" id="LN212">212</td><td class="line">  <span class='keyword'>case</span> '[':</td></tr>
<tr class="codeline" data-linenumber="213"><td class="num" id="LN213">213</td><td class="line">    <span class='keyword'>if</span> (*p == '^') p++;</td></tr>
<tr class="codeline" data-linenumber="214"><td class="num" id="LN214">214</td><td class="line">    <span class='keyword'>do</span> {  <span class='comment'>/* look for a `]' */</span></td></tr>
<tr class="codeline" data-linenumber="215"><td class="num" id="LN215">215</td><td class="line">      <span class='keyword'>if</span> (*p == '\0')</td></tr>
<tr class="codeline" data-linenumber="216"><td class="num" id="LN216">216</td><td class="line">	lj_err_caller(ms-&gt;L, LJ_ERR_STRPATM);</td></tr>
<tr class="codeline" data-linenumber="217"><td class="num" id="LN217">217</td><td class="line">      <span class='keyword'>if</span> (*(p++) == <span class='macro'>L_ESC<span class='macro_popup'>'%'</span></span> &amp;&amp; *p != '\0')</td></tr>
<tr class="codeline" data-linenumber="218"><td class="num" id="LN218">218</td><td class="line">	p++;  <span class='comment'>/* skip escapes (e.g. `%]') */</span></td></tr>
<tr class="codeline" data-linenumber="219"><td class="num" id="LN219">219</td><td class="line">    } <span class='keyword'>while</span> (*p != ']');</td></tr>
<tr class="codeline" data-linenumber="220"><td class="num" id="LN220">220</td><td class="line">    <span class='keyword'>return</span> p+1;</td></tr>
<tr class="codeline" data-linenumber="221"><td class="num" id="LN221">221</td><td class="line">  <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="222"><td class="num" id="LN222">222</td><td class="line">    <span class='keyword'>return</span> p;</td></tr>
<tr class="codeline" data-linenumber="223"><td class="num" id="LN223">223</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="224"><td class="num" id="LN224">224</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="225"><td class="num" id="LN225">225</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="226"><td class="num" id="LN226">226</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> match_class_map[32] = {</td></tr>
<tr class="codeline" data-linenumber="227"><td class="num" id="LN227">227</td><td class="line">  0,<span class='macro'>LJ_CHAR_ALPHA<span class='macro_popup'>(0x40|0x20)</span></span>,0,<span class='macro'>LJ_CHAR_CNTRL<span class='macro_popup'>0x01</span></span>,<span class='macro'>LJ_CHAR_DIGIT<span class='macro_popup'>0x08</span></span>,0,0,<span class='macro'>LJ_CHAR_GRAPH<span class='macro_popup'>(((0x40|0x20)|0x08)|0x04)</span></span>,0,0,0,0,</td></tr>
<tr class="codeline" data-linenumber="228"><td class="num" id="LN228">228</td><td class="line">  <span class='macro'>LJ_CHAR_LOWER<span class='macro_popup'>0x40</span></span>,0,0,0,<span class='macro'>LJ_CHAR_PUNCT<span class='macro_popup'>0x04</span></span>,0,0,<span class='macro'>LJ_CHAR_SPACE<span class='macro_popup'>0x02</span></span>,0,</td></tr>
<tr class="codeline" data-linenumber="229"><td class="num" id="LN229">229</td><td class="line">  <span class='macro'>LJ_CHAR_UPPER<span class='macro_popup'>0x20</span></span>,0,<span class='macro'>LJ_CHAR_ALNUM<span class='macro_popup'>((0x40|0x20)|0x08)</span></span>,<span class='macro'>LJ_CHAR_XDIGIT<span class='macro_popup'>0x10</span></span>,0,0,0,0,0,0,0</td></tr>
<tr class="codeline" data-linenumber="230"><td class="num" id="LN230">230</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="231"><td class="num" id="LN231">231</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="232"><td class="num" id="LN232">232</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> match_class(<span class='keyword'>int</span> c, <span class='keyword'>int</span> cl)</td></tr>
<tr class="codeline" data-linenumber="233"><td class="num" id="LN233">233</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="234"><td class="num" id="LN234">234</td><td class="line">  <span class='keyword'>if</span> ((cl &amp; 0xc0) == 0x40) {</td></tr>
<tr class="codeline" data-linenumber="235"><td class="num" id="LN235">235</td><td class="line">    <span class='keyword'>int</span> t = match_class_map[(cl&amp;0x1f)];</td></tr>
<tr class="codeline" data-linenumber="236"><td class="num" id="LN236">236</td><td class="line">    <span class='keyword'>if</span> (t) {</td></tr>
<tr class="codeline" data-linenumber="237"><td class="num" id="LN237">237</td><td class="line">      t = <span class='macro'>lj_char_isa(c, t)<span class='macro_popup'>((lj_char_bits+1)[(c)] &amp; t)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="238"><td class="num" id="LN238">238</td><td class="line">      <span class='keyword'>return</span> (cl &amp; 0x20) ? t : !t;</td></tr>
<tr class="codeline" data-linenumber="239"><td class="num" id="LN239">239</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="240"><td class="num" id="LN240">240</td><td class="line">    <span class='keyword'>if</span> (cl == 'z') <span class='keyword'>return</span> c == 0;</td></tr>
<tr class="codeline" data-linenumber="241"><td class="num" id="LN241">241</td><td class="line">    <span class='keyword'>if</span> (cl == 'Z') <span class='keyword'>return</span> c != 0;</td></tr>
<tr class="codeline" data-linenumber="242"><td class="num" id="LN242">242</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="243"><td class="num" id="LN243">243</td><td class="line">  <span class='keyword'>return</span> (cl == c);</td></tr>
<tr class="codeline" data-linenumber="244"><td class="num" id="LN244">244</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="245"><td class="num" id="LN245">245</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="246"><td class="num" id="LN246">246</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> matchbracketclass(<span class='keyword'>int</span> c, <span class='keyword'>const</span> <span class='keyword'>char</span> *p, <span class='keyword'>const</span> <span class='keyword'>char</span> *ec)</td></tr>
<tr class="codeline" data-linenumber="247"><td class="num" id="LN247">247</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="248"><td class="num" id="LN248">248</td><td class="line">  <span class='keyword'>int</span> sig = 1;</td></tr>
<tr class="codeline" data-linenumber="249"><td class="num" id="LN249">249</td><td class="line">  <span class='keyword'>if</span> (*(p+1) == '^') {</td></tr>
<tr class="codeline" data-linenumber="250"><td class="num" id="LN250">250</td><td class="line">    sig = 0;</td></tr>
<tr class="codeline" data-linenumber="251"><td class="num" id="LN251">251</td><td class="line">    p++;  <span class='comment'>/* skip the `^' */</span></td></tr>
<tr class="codeline" data-linenumber="252"><td class="num" id="LN252">252</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="253"><td class="num" id="LN253">253</td><td class="line">  <span class='keyword'>while</span> (++p &lt; ec) {</td></tr>
<tr class="codeline" data-linenumber="254"><td class="num" id="LN254">254</td><td class="line">    <span class='keyword'>if</span> (*p == <span class='macro'>L_ESC<span class='macro_popup'>'%'</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="255"><td class="num" id="LN255">255</td><td class="line">      p++;</td></tr>
<tr class="codeline" data-linenumber="256"><td class="num" id="LN256">256</td><td class="line">      <span class='keyword'>if</span> (match_class(c, <span class='macro'>uchar(*p)<span class='macro_popup'>((unsigned char)(*p))</span></span>))</td></tr>
<tr class="codeline" data-linenumber="257"><td class="num" id="LN257">257</td><td class="line">	<span class='keyword'>return</span> sig;</td></tr>
<tr class="codeline" data-linenumber="258"><td class="num" id="LN258">258</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="259"><td class="num" id="LN259">259</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> ((*(p+1) == '-') &amp;&amp; (p+2 &lt; ec)) {</td></tr>
<tr class="codeline" data-linenumber="260"><td class="num" id="LN260">260</td><td class="line">      p+=2;</td></tr>
<tr class="codeline" data-linenumber="261"><td class="num" id="LN261">261</td><td class="line">      <span class='keyword'>if</span> (<span class='macro'>uchar(*(p-2))<span class='macro_popup'>((unsigned char)(*(p-2)))</span></span> &lt;= c &amp;&amp; c &lt;= <span class='macro'>uchar(*p)<span class='macro_popup'>((unsigned char)(*p))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="262"><td class="num" id="LN262">262</td><td class="line">	<span class='keyword'>return</span> sig;</td></tr>
<tr class="codeline" data-linenumber="263"><td class="num" id="LN263">263</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="264"><td class="num" id="LN264">264</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>uchar(*p)<span class='macro_popup'>((unsigned char)(*p))</span></span> == c) <span class='keyword'>return</span> sig;</td></tr>
<tr class="codeline" data-linenumber="265"><td class="num" id="LN265">265</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="266"><td class="num" id="LN266">266</td><td class="line">  <span class='keyword'>return</span> !sig;</td></tr>
<tr class="codeline" data-linenumber="267"><td class="num" id="LN267">267</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="268"><td class="num" id="LN268">268</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="269"><td class="num" id="LN269">269</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> singlematch(<span class='keyword'>int</span> c, <span class='keyword'>const</span> <span class='keyword'>char</span> *p, <span class='keyword'>const</span> <span class='keyword'>char</span> *ep)</td></tr>
<tr class="codeline" data-linenumber="270"><td class="num" id="LN270">270</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="271"><td class="num" id="LN271">271</td><td class="line">  <span class='keyword'>switch</span> (*p) {</td></tr>
<tr class="codeline" data-linenumber="272"><td class="num" id="LN272">272</td><td class="line">  <span class='keyword'>case</span> '.': <span class='keyword'>return</span> 1;  <span class='comment'>/* matches any char */</span></td></tr>
<tr class="codeline" data-linenumber="273"><td class="num" id="LN273">273</td><td class="line">  <span class='keyword'>case</span> <span class='macro'>L_ESC<span class='macro_popup'>'%'</span></span>: <span class='keyword'>return</span> match_class(c, <span class='macro'>uchar(*(p+1))<span class='macro_popup'>((unsigned char)(*(p+1)))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="274"><td class="num" id="LN274">274</td><td class="line">  <span class='keyword'>case</span> '[': <span class='keyword'>return</span> matchbracketclass(c, p, ep-1);</td></tr>
<tr class="codeline" data-linenumber="275"><td class="num" id="LN275">275</td><td class="line">  <span class='keyword'>default</span>:  <span class='keyword'>return</span> (<span class='macro'>uchar(*p)<span class='macro_popup'>((unsigned char)(*p))</span></span> == c);</td></tr>
<tr class="codeline" data-linenumber="276"><td class="num" id="LN276">276</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="277"><td class="num" id="LN277">277</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="278"><td class="num" id="LN278">278</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="279"><td class="num" id="LN279">279</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span> *match(MatchState *ms, <span class='keyword'>const</span> <span class='keyword'>char</span> *s, <span class='keyword'>const</span> <span class='keyword'>char</span> *p);</td></tr>
<tr class="codeline" data-linenumber="280"><td class="num" id="LN280">280</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="281"><td class="num" id="LN281">281</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span> *matchbalance(MatchState *ms, <span class='keyword'>const</span> <span class='keyword'>char</span> *s, <span class='keyword'>const</span> <span class='keyword'>char</span> *p)</td></tr>
<tr class="codeline" data-linenumber="282"><td class="num" id="LN282">282</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="283"><td class="num" id="LN283">283</td><td class="line">  <span class='keyword'>if</span> (*p == 0 || *(p+1) == 0)</td></tr>
<tr class="codeline" data-linenumber="284"><td class="num" id="LN284">284</td><td class="line">    lj_err_caller(ms-&gt;L, LJ_ERR_STRPATU);</td></tr>
<tr class="codeline" data-linenumber="285"><td class="num" id="LN285">285</td><td class="line">  <span class='keyword'>if</span> (*s != *p) {</td></tr>
<tr class="codeline" data-linenumber="286"><td class="num" id="LN286">286</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="287"><td class="num" id="LN287">287</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="288"><td class="num" id="LN288">288</td><td class="line">    <span class='keyword'>int</span> b = *p;</td></tr>
<tr class="codeline" data-linenumber="289"><td class="num" id="LN289">289</td><td class="line">    <span class='keyword'>int</span> e = *(p+1);</td></tr>
<tr class="codeline" data-linenumber="290"><td class="num" id="LN290">290</td><td class="line">    <span class='keyword'>int</span> cont = 1;</td></tr>
<tr class="codeline" data-linenumber="291"><td class="num" id="LN291">291</td><td class="line">    <span class='keyword'>while</span> (++s &lt; ms-&gt;src_end) {</td></tr>
<tr class="codeline" data-linenumber="292"><td class="num" id="LN292">292</td><td class="line">      <span class='keyword'>if</span> (*s == e) {</td></tr>
<tr class="codeline" data-linenumber="293"><td class="num" id="LN293">293</td><td class="line">	<span class='keyword'>if</span> (--cont == 0) <span class='keyword'>return</span> s+1;</td></tr>
<tr class="codeline" data-linenumber="294"><td class="num" id="LN294">294</td><td class="line">      } <span class='keyword'>else</span> <span class='keyword'>if</span> (*s == b) {</td></tr>
<tr class="codeline" data-linenumber="295"><td class="num" id="LN295">295</td><td class="line">	cont++;</td></tr>
<tr class="codeline" data-linenumber="296"><td class="num" id="LN296">296</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="297"><td class="num" id="LN297">297</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="298"><td class="num" id="LN298">298</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="299"><td class="num" id="LN299">299</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;  <span class='comment'>/* string ends out of balance */</span></td></tr>
<tr class="codeline" data-linenumber="300"><td class="num" id="LN300">300</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="301"><td class="num" id="LN301">301</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="302"><td class="num" id="LN302">302</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span> *max_expand(MatchState *ms, <span class='keyword'>const</span> <span class='keyword'>char</span> *s,</td></tr>
<tr class="codeline" data-linenumber="303"><td class="num" id="LN303">303</td><td class="line">			      <span class='keyword'>const</span> <span class='keyword'>char</span> *p, <span class='keyword'>const</span> <span class='keyword'>char</span> *ep)</td></tr>
<tr class="codeline" data-linenumber="304"><td class="num" id="LN304">304</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="305"><td class="num" id="LN305">305</td><td class="line">  ptrdiff_t i = 0;  <span class='comment'>/* counts maximum expand for item */</span></td></tr>
<tr class="codeline" data-linenumber="306"><td class="num" id="LN306">306</td><td class="line">  <span class='keyword'>while</span> ((s+i)&lt;ms-&gt;src_end &amp;&amp; singlematch(<span class='macro'>uchar(*(s+i))<span class='macro_popup'>((unsigned char)(*(s+i)))</span></span>, p, ep))</td></tr>
<tr class="codeline" data-linenumber="307"><td class="num" id="LN307">307</td><td class="line">    i++;</td></tr>
<tr class="codeline" data-linenumber="308"><td class="num" id="LN308">308</td><td class="line">  <span class='comment'>/* keeps trying to match with the maximum repetitions */</span></td></tr>
<tr class="codeline" data-linenumber="309"><td class="num" id="LN309">309</td><td class="line">  <span class='keyword'>while</span> (i&gt;=0) {</td></tr>
<tr class="codeline" data-linenumber="310"><td class="num" id="LN310">310</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span> *res = match(ms, (s+i), ep+1);</td></tr>
<tr class="codeline" data-linenumber="311"><td class="num" id="LN311">311</td><td class="line">    <span class='keyword'>if</span> (res) <span class='keyword'>return</span> res;</td></tr>
<tr class="codeline" data-linenumber="312"><td class="num" id="LN312">312</td><td class="line">    i--;  <span class='comment'>/* else didn't match; reduce 1 repetition to try again */</span></td></tr>
<tr class="codeline" data-linenumber="313"><td class="num" id="LN313">313</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="314"><td class="num" id="LN314">314</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="315"><td class="num" id="LN315">315</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="316"><td class="num" id="LN316">316</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="317"><td class="num" id="LN317">317</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span> *min_expand(MatchState *ms, <span class='keyword'>const</span> <span class='keyword'>char</span> *s,</td></tr>
<tr class="codeline" data-linenumber="318"><td class="num" id="LN318">318</td><td class="line">			      <span class='keyword'>const</span> <span class='keyword'>char</span> *p, <span class='keyword'>const</span> <span class='keyword'>char</span> *ep)</td></tr>
<tr class="codeline" data-linenumber="319"><td class="num" id="LN319">319</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="320"><td class="num" id="LN320">320</td><td class="line">  <span class='keyword'>for</span> (;;) {</td></tr>
<tr class="codeline" data-linenumber="321"><td class="num" id="LN321">321</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span> *res = match(ms, s, ep+1);</td></tr>
<tr class="codeline" data-linenumber="322"><td class="num" id="LN322">322</td><td class="line">    <span class='keyword'>if</span> (res != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="323"><td class="num" id="LN323">323</td><td class="line">      <span class='keyword'>return</span> res;</td></tr>
<tr class="codeline" data-linenumber="324"><td class="num" id="LN324">324</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (s&lt;ms-&gt;src_end &amp;&amp; singlematch(<span class='macro'>uchar(*s)<span class='macro_popup'>((unsigned char)(*s))</span></span>, p, ep))</td></tr>
<tr class="codeline" data-linenumber="325"><td class="num" id="LN325">325</td><td class="line">      s++;  <span class='comment'>/* try with one more repetition */</span></td></tr>
<tr class="codeline" data-linenumber="326"><td class="num" id="LN326">326</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="327"><td class="num" id="LN327">327</td><td class="line">      <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="328"><td class="num" id="LN328">328</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="329"><td class="num" id="LN329">329</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="330"><td class="num" id="LN330">330</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="331"><td class="num" id="LN331">331</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span> *start_capture(MatchState *ms, <span class='keyword'>const</span> <span class='keyword'>char</span> *s,</td></tr>
<tr class="codeline" data-linenumber="332"><td class="num" id="LN332">332</td><td class="line">				 <span class='keyword'>const</span> <span class='keyword'>char</span> *p, <span class='keyword'>int</span> what)</td></tr>
<tr class="codeline" data-linenumber="333"><td class="num" id="LN333">333</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="334"><td class="num" id="LN334">334</td><td class="line">  <span class='keyword'>const</span> <span class='keyword'>char</span> *res;</td></tr>
<tr class="codeline" data-linenumber="335"><td class="num" id="LN335">335</td><td class="line">  <span class='keyword'>int</span> level = ms-&gt;level;</td></tr>
<tr class="codeline" data-linenumber="336"><td class="num" id="LN336">336</td><td class="line">  <span class='keyword'>if</span> (level &gt;= <span class='macro'>LUA_MAXCAPTURES<span class='macro_popup'>32</span></span>) lj_err_caller(ms-&gt;L, LJ_ERR_STRCAPN);</td></tr>
<tr class="codeline" data-linenumber="337"><td class="num" id="LN337">337</td><td class="line">  ms-&gt;capture[level].init = s;</td></tr>
<tr class="codeline" data-linenumber="338"><td class="num" id="LN338">338</td><td class="line">  ms-&gt;capture[level].len = what;</td></tr>
<tr class="codeline" data-linenumber="339"><td class="num" id="LN339">339</td><td class="line">  ms-&gt;level = level+1;</td></tr>
<tr class="codeline" data-linenumber="340"><td class="num" id="LN340">340</td><td class="line">  <span class='keyword'>if</span> ((res=match(ms, s, p)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)  <span class='comment'>/* match failed? */</span></td></tr>
<tr class="codeline" data-linenumber="341"><td class="num" id="LN341">341</td><td class="line">    ms-&gt;level--;  <span class='comment'>/* undo capture */</span></td></tr>
<tr class="codeline" data-linenumber="342"><td class="num" id="LN342">342</td><td class="line">  <span class='keyword'>return</span> res;</td></tr>
<tr class="codeline" data-linenumber="343"><td class="num" id="LN343">343</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="344"><td class="num" id="LN344">344</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="345"><td class="num" id="LN345">345</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span> *end_capture(MatchState *ms, <span class='keyword'>const</span> <span class='keyword'>char</span> *s,</td></tr>
<tr class="codeline" data-linenumber="346"><td class="num" id="LN346">346</td><td class="line">			       <span class='keyword'>const</span> <span class='keyword'>char</span> *p)</td></tr>
<tr class="codeline" data-linenumber="347"><td class="num" id="LN347">347</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="348"><td class="num" id="LN348">348</td><td class="line">  <span class='keyword'>int</span> l = capture_to_close(ms);</td></tr>
<tr class="codeline" data-linenumber="349"><td class="num" id="LN349">349</td><td class="line">  <span class='keyword'>const</span> <span class='keyword'>char</span> *res;</td></tr>
<tr class="codeline" data-linenumber="350"><td class="num" id="LN350">350</td><td class="line">  ms-&gt;capture[l].len = s - ms-&gt;capture[l].init;  <span class='comment'>/* close capture */</span></td></tr>
<tr class="codeline" data-linenumber="351"><td class="num" id="LN351">351</td><td class="line">  <span class='keyword'>if</span> ((res = match(ms, s, p)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)  <span class='comment'>/* match failed? */</span></td></tr>
<tr class="codeline" data-linenumber="352"><td class="num" id="LN352">352</td><td class="line">    ms-&gt;capture[l].len = <span class='macro'>CAP_UNFINISHED<span class='macro_popup'>(-1)</span></span>;  <span class='comment'>/* undo capture */</span></td></tr>
<tr class="codeline" data-linenumber="353"><td class="num" id="LN353">353</td><td class="line">  <span class='keyword'>return</span> res;</td></tr>
<tr class="codeline" data-linenumber="354"><td class="num" id="LN354">354</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="355"><td class="num" id="LN355">355</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="356"><td class="num" id="LN356">356</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span> *match_capture(MatchState *ms, <span class='keyword'>const</span> <span class='keyword'>char</span> *s, <span class='keyword'>int</span> l)</td></tr>
<tr class="codeline" data-linenumber="357"><td class="num" id="LN357">357</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="358"><td class="num" id="LN358">358</td><td class="line">  size_t len;</td></tr>
<tr class="codeline" data-linenumber="359"><td class="num" id="LN359">359</td><td class="line">  l = check_capture(ms, l);</td></tr>
<tr class="codeline" data-linenumber="360"><td class="num" id="LN360">360</td><td class="line">  len = (size_t)ms-&gt;capture[l].len;</td></tr>
<tr class="codeline" data-linenumber="361"><td class="num" id="LN361">361</td><td class="line">  <span class='keyword'>if</span> ((size_t)(ms-&gt;src_end-s) &gt;= len &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="362"><td class="num" id="LN362">362</td><td class="line">      memcmp(ms-&gt;capture[l].init, s, len) == 0)</td></tr>
<tr class="codeline" data-linenumber="363"><td class="num" id="LN363">363</td><td class="line">    <span class='keyword'>return</span> s+len;</td></tr>
<tr class="codeline" data-linenumber="364"><td class="num" id="LN364">364</td><td class="line">  <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="365"><td class="num" id="LN365">365</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="366"><td class="num" id="LN366">366</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="367"><td class="num" id="LN367">367</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="368"><td class="num" id="LN368">368</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span> *match(MatchState *ms, <span class='keyword'>const</span> <span class='keyword'>char</span> *s, <span class='keyword'>const</span> <span class='keyword'>char</span> *p)</td></tr>
<tr class="codeline" data-linenumber="369"><td class="num" id="LN369">369</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="370"><td class="num" id="LN370">370</td><td class="line">  <span class='keyword'>if</span> (++ms-&gt;depth &gt; <span class='macro'>LJ_MAX_XLEVEL<span class='macro_popup'>200</span></span>)</td></tr>
<tr class="codeline" data-linenumber="371"><td class="num" id="LN371">371</td><td class="line">    lj_err_caller(ms-&gt;L, LJ_ERR_STRPATX);</td></tr>
<tr class="codeline" data-linenumber="372"><td class="num" id="LN372">372</td><td class="line">  init: <span class='comment'>/* using goto's to optimize tail recursion */</span></td></tr>
<tr class="codeline" data-linenumber="373"><td class="num" id="LN373">373</td><td class="line">  <span class='keyword'>switch</span> (*p) {</td></tr>
<tr class="codeline" data-linenumber="374"><td class="num" id="LN374">374</td><td class="line">  <span class='keyword'>case</span> '(':  <span class='comment'>/* start capture */</span></td></tr>
<tr class="codeline" data-linenumber="375"><td class="num" id="LN375">375</td><td class="line">    <span class='keyword'>if</span> (*(p+1) == ')')  <span class='comment'>/* position capture? */</span></td></tr>
<tr class="codeline" data-linenumber="376"><td class="num" id="LN376">376</td><td class="line">      s = start_capture(ms, s, p+2, <span class='macro'>CAP_POSITION<span class='macro_popup'>(-2)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="377"><td class="num" id="LN377">377</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="378"><td class="num" id="LN378">378</td><td class="line">      s = start_capture(ms, s, p+1, <span class='macro'>CAP_UNFINISHED<span class='macro_popup'>(-1)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="379"><td class="num" id="LN379">379</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="380"><td class="num" id="LN380">380</td><td class="line">  <span class='keyword'>case</span> ')':  <span class='comment'>/* end capture */</span></td></tr>
<tr class="codeline" data-linenumber="381"><td class="num" id="LN381">381</td><td class="line">    s = end_capture(ms, s, p+1);</td></tr>
<tr class="codeline" data-linenumber="382"><td class="num" id="LN382">382</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="383"><td class="num" id="LN383">383</td><td class="line">  <span class='keyword'>case</span> <span class='macro'>L_ESC<span class='macro_popup'>'%'</span></span>:</td></tr>
<tr class="codeline" data-linenumber="384"><td class="num" id="LN384">384</td><td class="line">    <span class='keyword'>switch</span> (*(p+1)) {</td></tr>
<tr class="codeline" data-linenumber="385"><td class="num" id="LN385">385</td><td class="line">    <span class='keyword'>case</span> 'b':  <span class='comment'>/* balanced string? */</span></td></tr>
<tr class="codeline" data-linenumber="386"><td class="num" id="LN386">386</td><td class="line">      s = matchbalance(ms, s, p+2);</td></tr>
<tr class="codeline" data-linenumber="387"><td class="num" id="LN387">387</td><td class="line">      <span class='keyword'>if</span> (s == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="388"><td class="num" id="LN388">388</td><td class="line">      p+=4;</td></tr>
<tr class="codeline" data-linenumber="389"><td class="num" id="LN389">389</td><td class="line">      <span class='keyword'>goto</span> init;  <span class='comment'>/* else s = match(ms, s, p+4); */</span></td></tr>
<tr class="codeline" data-linenumber="390"><td class="num" id="LN390">390</td><td class="line">    <span class='keyword'>case</span> 'f': {  <span class='comment'>/* frontier? */</span></td></tr>
<tr class="codeline" data-linenumber="391"><td class="num" id="LN391">391</td><td class="line">      <span class='keyword'>const</span> <span class='keyword'>char</span> *ep; <span class='keyword'>char</span> previous;</td></tr>
<tr class="codeline" data-linenumber="392"><td class="num" id="LN392">392</td><td class="line">      p += 2;</td></tr>
<tr class="codeline" data-linenumber="393"><td class="num" id="LN393">393</td><td class="line">      <span class='keyword'>if</span> (*p != '[')</td></tr>
<tr class="codeline" data-linenumber="394"><td class="num" id="LN394">394</td><td class="line">	lj_err_caller(ms-&gt;L, LJ_ERR_STRPATB);</td></tr>
<tr class="codeline" data-linenumber="395"><td class="num" id="LN395">395</td><td class="line">      ep = classend(ms, p);  <span class='comment'>/* points to what is next */</span></td></tr>
<tr class="codeline" data-linenumber="396"><td class="num" id="LN396">396</td><td class="line">      previous = (s == ms-&gt;src_init) ? '\0' : *(s-1);</td></tr>
<tr class="codeline" data-linenumber="397"><td class="num" id="LN397">397</td><td class="line">      <span class='keyword'>if</span> (matchbracketclass(<span class='macro'>uchar(previous)<span class='macro_popup'>((unsigned char)(previous))</span></span>, p, ep-1) ||</td></tr>
<tr class="codeline" data-linenumber="398"><td class="num" id="LN398">398</td><td class="line">	 !matchbracketclass(<span class='macro'>uchar(*s)<span class='macro_popup'>((unsigned char)(*s))</span></span>, p, ep-1)) { s = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>; <span class='keyword'>break</span>; }</td></tr>
<tr class="codeline" data-linenumber="399"><td class="num" id="LN399">399</td><td class="line">      p=ep;</td></tr>
<tr class="codeline" data-linenumber="400"><td class="num" id="LN400">400</td><td class="line">      <span class='keyword'>goto</span> init;  <span class='comment'>/* else s = match(ms, s, ep); */</span></td></tr>
<tr class="codeline" data-linenumber="401"><td class="num" id="LN401">401</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="402"><td class="num" id="LN402">402</td><td class="line">    <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="403"><td class="num" id="LN403">403</td><td class="line">      <span class='keyword'>if</span> (<span class='macro'>lj_char_isdigit(uchar(*(p+1)))<span class='macro_popup'>((lj_char_bits+1)[((((unsigned char)(*(p+1)))))] &amp; 0x08)</span></span>) {  <span class='comment'>/* capture results (%0-%9)? */</span></td></tr>
<tr class="codeline" data-linenumber="404"><td class="num" id="LN404">404</td><td class="line">	s = match_capture(ms, s, <span class='macro'>uchar(*(p+1))<span class='macro_popup'>((unsigned char)(*(p+1)))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="405"><td class="num" id="LN405">405</td><td class="line">	<span class='keyword'>if</span> (s == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="406"><td class="num" id="LN406">406</td><td class="line">	p+=2;</td></tr>
<tr class="codeline" data-linenumber="407"><td class="num" id="LN407">407</td><td class="line">	<span class='keyword'>goto</span> init;  <span class='comment'>/* else s = match(ms, s, p+2) */</span></td></tr>
<tr class="codeline" data-linenumber="408"><td class="num" id="LN408">408</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="409"><td class="num" id="LN409">409</td><td class="line">      <span class='keyword'>goto</span> dflt;  <span class='comment'>/* case default */</span></td></tr>
<tr class="codeline" data-linenumber="410"><td class="num" id="LN410">410</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="411"><td class="num" id="LN411">411</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="412"><td class="num" id="LN412">412</td><td class="line">  <span class='keyword'>case</span> '\0':  <span class='comment'>/* end of pattern */</span></td></tr>
<tr class="codeline" data-linenumber="413"><td class="num" id="LN413">413</td><td class="line">    <span class='keyword'>break</span>;  <span class='comment'>/* match succeeded */</span></td></tr>
<tr class="codeline" data-linenumber="414"><td class="num" id="LN414">414</td><td class="line">  <span class='keyword'>case</span> '$':</td></tr>
<tr class="codeline" data-linenumber="415"><td class="num" id="LN415">415</td><td class="line">    <span class='comment'>/* is the `$' the last char in pattern? */</span></td></tr>
<tr class="codeline" data-linenumber="416"><td class="num" id="LN416">416</td><td class="line">    <span class='keyword'>if</span> (*(p+1) != '\0') <span class='keyword'>goto</span> dflt;</td></tr>
<tr class="codeline" data-linenumber="417"><td class="num" id="LN417">417</td><td class="line">    <span class='keyword'>if</span> (s != ms-&gt;src_end) s = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;  <span class='comment'>/* check end of string */</span></td></tr>
<tr class="codeline" data-linenumber="418"><td class="num" id="LN418">418</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="419"><td class="num" id="LN419">419</td><td class="line">  <span class='keyword'>default</span>: dflt: {  <span class='comment'>/* it is a pattern item */</span></td></tr>
<tr class="codeline" data-linenumber="420"><td class="num" id="LN420">420</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span> *ep = classend(ms, p);  <span class='comment'>/* points to what is next */</span></td></tr>
<tr class="codeline" data-linenumber="421"><td class="num" id="LN421">421</td><td class="line">    <span class='keyword'>int</span> m = s&lt;ms-&gt;src_end &amp;&amp; singlematch(<span class='macro'>uchar(*s)<span class='macro_popup'>((unsigned char)(*s))</span></span>, p, ep);</td></tr>
<tr class="codeline" data-linenumber="422"><td class="num" id="LN422">422</td><td class="line">    <span class='keyword'>switch</span> (*ep) {</td></tr>
<tr class="codeline" data-linenumber="423"><td class="num" id="LN423">423</td><td class="line">    <span class='keyword'>case</span> '?': {  <span class='comment'>/* optional */</span></td></tr>
<tr class="codeline" data-linenumber="424"><td class="num" id="LN424">424</td><td class="line">      <span class='keyword'>const</span> <span class='keyword'>char</span> *res;</td></tr>
<tr class="codeline" data-linenumber="425"><td class="num" id="LN425">425</td><td class="line">      <span class='keyword'>if</span> (m &amp;&amp; ((res=match(ms, s+1, ep+1)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="426"><td class="num" id="LN426">426</td><td class="line">	s = res;</td></tr>
<tr class="codeline" data-linenumber="427"><td class="num" id="LN427">427</td><td class="line">	<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="428"><td class="num" id="LN428">428</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="429"><td class="num" id="LN429">429</td><td class="line">      p=ep+1;</td></tr>
<tr class="codeline" data-linenumber="430"><td class="num" id="LN430">430</td><td class="line">      <span class='keyword'>goto</span> init;  <span class='comment'>/* else s = match(ms, s, ep+1); */</span></td></tr>
<tr class="codeline" data-linenumber="431"><td class="num" id="LN431">431</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="432"><td class="num" id="LN432">432</td><td class="line">    <span class='keyword'>case</span> '*':  <span class='comment'>/* 0 or more repetitions */</span></td></tr>
<tr class="codeline" data-linenumber="433"><td class="num" id="LN433">433</td><td class="line">      s = max_expand(ms, s, p, ep);</td></tr>
<tr class="codeline" data-linenumber="434"><td class="num" id="LN434">434</td><td class="line">      <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="435"><td class="num" id="LN435">435</td><td class="line">    <span class='keyword'>case</span> '+':  <span class='comment'>/* 1 or more repetitions */</span></td></tr>
<tr class="codeline" data-linenumber="436"><td class="num" id="LN436">436</td><td class="line">      s = (m ? max_expand(ms, s+1, p, ep) : <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="437"><td class="num" id="LN437">437</td><td class="line">      <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="438"><td class="num" id="LN438">438</td><td class="line">    <span class='keyword'>case</span> '-':  <span class='comment'>/* 0 or more repetitions (minimum) */</span></td></tr>
<tr class="codeline" data-linenumber="439"><td class="num" id="LN439">439</td><td class="line">      s = min_expand(ms, s, p, ep);</td></tr>
<tr class="codeline" data-linenumber="440"><td class="num" id="LN440">440</td><td class="line">      <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="441"><td class="num" id="LN441">441</td><td class="line">    <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="442"><td class="num" id="LN442">442</td><td class="line">      <span class='keyword'>if</span> (m) { s++; p=ep; <span class='keyword'>goto</span> init; }  <span class='comment'>/* else s = match(ms, s+1, ep); */</span></td></tr>
<tr class="codeline" data-linenumber="443"><td class="num" id="LN443">443</td><td class="line">      s = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="444"><td class="num" id="LN444">444</td><td class="line">      <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="445"><td class="num" id="LN445">445</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="446"><td class="num" id="LN446">446</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="447"><td class="num" id="LN447">447</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="448"><td class="num" id="LN448">448</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="449"><td class="num" id="LN449">449</td><td class="line">  ms-&gt;depth--;</td></tr>
<tr class="codeline" data-linenumber="450"><td class="num" id="LN450">450</td><td class="line">  <span class='keyword'>return</span> s;</td></tr>
<tr class="codeline" data-linenumber="451"><td class="num" id="LN451">451</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="452"><td class="num" id="LN452">452</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="453"><td class="num" id="LN453">453</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span> *lmemfind(<span class='keyword'>const</span> <span class='keyword'>char</span> *s1, size_t l1,</td></tr>
<tr class="codeline" data-linenumber="454"><td class="num" id="LN454">454</td><td class="line">			    <span class='keyword'>const</span> <span class='keyword'>char</span> *s2, size_t l2)</td></tr>
<tr class="codeline" data-linenumber="455"><td class="num" id="LN455">455</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="456"><td class="num" id="LN456">456</td><td class="line">  <span class='keyword'>if</span> (l2 == 0) {</td></tr>
<tr class="codeline" data-linenumber="457"><td class="num" id="LN457">457</td><td class="line">    <span class='keyword'>return</span> s1;  <span class='comment'>/* empty strings are everywhere */</span></td></tr>
<tr class="codeline" data-linenumber="458"><td class="num" id="LN458">458</td><td class="line">  } <span class='keyword'>else</span> <span class='keyword'>if</span> (l2 &gt; l1) {</td></tr>
<tr class="codeline" data-linenumber="459"><td class="num" id="LN459">459</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;  <span class='comment'>/* avoids a negative `l1' */</span></td></tr>
<tr class="codeline" data-linenumber="460"><td class="num" id="LN460">460</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="461"><td class="num" id="LN461">461</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span> *init;  <span class='comment'>/* to search for a `*s2' inside `s1' */</span></td></tr>
<tr class="codeline" data-linenumber="462"><td class="num" id="LN462">462</td><td class="line">    l2--;  <span class='comment'>/* 1st char will be checked by `memchr' */</span></td></tr>
<tr class="codeline" data-linenumber="463"><td class="num" id="LN463">463</td><td class="line">    l1 = l1-l2;  <span class='comment'>/* `s2' cannot be found after that */</span></td></tr>
<tr class="codeline" data-linenumber="464"><td class="num" id="LN464">464</td><td class="line">    <span class='keyword'>while</span> (l1 &gt; 0 &amp;&amp; (init = (<span class='keyword'>const</span> <span class='keyword'>char</span> *)memchr(s1, *s2, l1)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="465"><td class="num" id="LN465">465</td><td class="line">      init++;   <span class='comment'>/* 1st char is already checked */</span></td></tr>
<tr class="codeline" data-linenumber="466"><td class="num" id="LN466">466</td><td class="line">      <span class='keyword'>if</span> (memcmp(init, s2+1, l2) == 0) {</td></tr>
<tr class="codeline" data-linenumber="467"><td class="num" id="LN467">467</td><td class="line">	<span class='keyword'>return</span> init-1;</td></tr>
<tr class="codeline" data-linenumber="468"><td class="num" id="LN468">468</td><td class="line">      } <span class='keyword'>else</span> {  <span class='comment'>/* correct `l1' and `s1' to try again */</span></td></tr>
<tr class="codeline" data-linenumber="469"><td class="num" id="LN469">469</td><td class="line">	l1 -= (size_t)(init-s1);</td></tr>
<tr class="codeline" data-linenumber="470"><td class="num" id="LN470">470</td><td class="line">	s1 = init;</td></tr>
<tr class="codeline" data-linenumber="471"><td class="num" id="LN471">471</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="472"><td class="num" id="LN472">472</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="473"><td class="num" id="LN473">473</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;  <span class='comment'>/* not found */</span></td></tr>
<tr class="codeline" data-linenumber="474"><td class="num" id="LN474">474</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="475"><td class="num" id="LN475">475</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="476"><td class="num" id="LN476">476</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="477"><td class="num" id="LN477">477</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> push_onecapture(MatchState *ms, <span class='keyword'>int</span> i, <span class='keyword'>const</span> <span class='keyword'>char</span> *s, <span class='keyword'>const</span> <span class='keyword'>char</span> *e)</td></tr>
<tr class="codeline" data-linenumber="478"><td class="num" id="LN478">478</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="479"><td class="num" id="LN479">479</td><td class="line">  <span class='keyword'>if</span> (i &gt;= ms-&gt;level) {</td></tr>
<tr class="codeline" data-linenumber="480"><td class="num" id="LN480">480</td><td class="line">    <span class='keyword'>if</span> (i == 0)  <span class='comment'>/* ms-&gt;level == 0, too */</span></td></tr>
<tr class="codeline" data-linenumber="481"><td class="num" id="LN481">481</td><td class="line">      lua_pushlstring(ms-&gt;L, s, (size_t)(e - s));  <span class='comment'>/* add whole match */</span></td></tr>
<tr class="codeline" data-linenumber="482"><td class="num" id="LN482">482</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="483"><td class="num" id="LN483">483</td><td class="line">      lj_err_caller(ms-&gt;L, LJ_ERR_STRCAPI);</td></tr>
<tr class="codeline" data-linenumber="484"><td class="num" id="LN484">484</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="485"><td class="num" id="LN485">485</td><td class="line">    ptrdiff_t l = ms-&gt;capture[i].len;</td></tr>
<tr class="codeline" data-linenumber="486"><td class="num" id="LN486">486</td><td class="line">    <span class='keyword'>if</span> (l == <span class='macro'>CAP_UNFINISHED<span class='macro_popup'>(-1)</span></span>) lj_err_caller(ms-&gt;L, LJ_ERR_STRCAPU);</td></tr>
<tr class="codeline" data-linenumber="487"><td class="num" id="LN487">487</td><td class="line">    <span class='keyword'>if</span> (l == <span class='macro'>CAP_POSITION<span class='macro_popup'>(-2)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="488"><td class="num" id="LN488">488</td><td class="line">      lua_pushinteger(ms-&gt;L, ms-&gt;capture[i].init - ms-&gt;src_init + 1);</td></tr>
<tr class="codeline" data-linenumber="489"><td class="num" id="LN489">489</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="490"><td class="num" id="LN490">490</td><td class="line">      lua_pushlstring(ms-&gt;L, ms-&gt;capture[i].init, (size_t)l);</td></tr>
<tr class="codeline" data-linenumber="491"><td class="num" id="LN491">491</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="492"><td class="num" id="LN492">492</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="493"><td class="num" id="LN493">493</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="494"><td class="num" id="LN494">494</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> push_captures(MatchState *ms, <span class='keyword'>const</span> <span class='keyword'>char</span> *s, <span class='keyword'>const</span> <span class='keyword'>char</span> *e)</td></tr>
<tr class="codeline" data-linenumber="495"><td class="num" id="LN495">495</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="496"><td class="num" id="LN496">496</td><td class="line">  <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="497"><td class="num" id="LN497">497</td><td class="line">  <span class='keyword'>int</span> nlevels = (ms-&gt;level == 0 &amp;&amp; s) ? 1 : ms-&gt;level;</td></tr>
<tr class="codeline" data-linenumber="498"><td class="num" id="LN498">498</td><td class="line">  luaL_checkstack(ms-&gt;L, nlevels, <span class='string_literal'>"too many captures"</span>);</td></tr>
<tr class="codeline" data-linenumber="499"><td class="num" id="LN499">499</td><td class="line">  <span class='keyword'>for</span> (i = 0; i &lt; nlevels; i++)</td></tr>
<tr class="codeline" data-linenumber="500"><td class="num" id="LN500">500</td><td class="line">    push_onecapture(ms, i, s, e);</td></tr>
<tr class="codeline" data-linenumber="501"><td class="num" id="LN501">501</td><td class="line">  <span class='keyword'>return</span> nlevels;  <span class='comment'>/* number of strings pushed */</span></td></tr>
<tr class="codeline" data-linenumber="502"><td class="num" id="LN502">502</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="503"><td class="num" id="LN503">503</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="504"><td class="num" id="LN504">504</td><td class="line"><span class='keyword'>static</span> ptrdiff_t posrelat(ptrdiff_t pos, size_t len)</td></tr>
<tr class="codeline" data-linenumber="505"><td class="num" id="LN505">505</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="506"><td class="num" id="LN506">506</td><td class="line">  <span class='comment'>/* relative string position: negative means back from end */</span></td></tr>
<tr class="codeline" data-linenumber="507"><td class="num" id="LN507">507</td><td class="line">  <span class='keyword'>if</span> (pos &lt; 0) pos += (ptrdiff_t)len + 1;</td></tr>
<tr class="codeline" data-linenumber="508"><td class="num" id="LN508">508</td><td class="line">  <span class='keyword'>return</span> (pos &gt;= 0) ? pos : 0;</td></tr>
<tr class="codeline" data-linenumber="509"><td class="num" id="LN509">509</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="510"><td class="num" id="LN510">510</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="511"><td class="num" id="LN511">511</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> str_find_aux(lua_State *L, <span class='keyword'>int</span> find)</td></tr>
<tr class="codeline" data-linenumber="512"><td class="num" id="LN512">512</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="513"><td class="num" id="LN513">513</td><td class="line">  size_t l1, l2;</td></tr>
<tr class="codeline" data-linenumber="514"><td class="num" id="LN514">514</td><td class="line">  <span class='keyword'>const</span> <span class='keyword'>char</span> *s = luaL_checklstring(L, 1, &amp;l1);</td></tr>
<tr class="codeline" data-linenumber="515"><td class="num" id="LN515">515</td><td class="line">  <span class='keyword'>const</span> <span class='keyword'>char</span> *p = luaL_checklstring(L, 2, &amp;l2);</td></tr>
<tr class="codeline" data-linenumber="516"><td class="num" id="LN516">516</td><td class="line">  ptrdiff_t init = posrelat(luaL_optinteger(L, 3, 1), l1) - 1;</td></tr>
<tr class="codeline" data-linenumber="517"><td class="num" id="LN517">517</td><td class="line">  <span class='keyword'>if</span> (init &lt; 0) {</td></tr>
<tr class="codeline" data-linenumber="518"><td class="num" id="LN518">518</td><td class="line">    init = 0;</td></tr>
<tr class="codeline" data-linenumber="519"><td class="num" id="LN519">519</td><td class="line">  } <span class='keyword'>else</span> <span class='keyword'>if</span> ((size_t)(init) &gt; l1) {</td></tr>
<tr class="codeline" data-linenumber="520"><td class="num" id="LN520">520</td><td class="line"><span class='directive'>#if <span class='macro'>LJ_52<span class='macro_popup'>0</span></span></span></td></tr>
<tr class="codeline" data-linenumber="521"><td class="num" id="LN521">521</td><td class="line">    <span class='macro'>setnilV(L-&gt;top-1)<span class='macro_popup'>((L-&gt;top-1)-&gt;it = (~0u))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="522"><td class="num" id="LN522">522</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="523"><td class="num" id="LN523">523</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="524"><td class="num" id="LN524">524</td><td class="line">    init = (ptrdiff_t)l1;</td></tr>
<tr class="codeline" data-linenumber="525"><td class="num" id="LN525">525</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="526"><td class="num" id="LN526">526</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="527"><td class="num" id="LN527">527</td><td class="line">  <span class='keyword'>if</span> (find &amp;&amp; (lua_toboolean(L, 4) ||  <span class='comment'>/* explicit request? */</span></td></tr>
<tr class="codeline" data-linenumber="528"><td class="num" id="LN528">528</td><td class="line">      strpbrk(p, <span class='macro'>SPECIALS<span class='macro_popup'>"^$*+?.([%-"</span></span>) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)) {  <span class='comment'>/* or no special characters? */</span></td></tr>
<tr class="codeline" data-linenumber="529"><td class="num" id="LN529">529</td><td class="line">    <span class='comment'>/* do a plain search */</span></td></tr>
<tr class="codeline" data-linenumber="530"><td class="num" id="LN530">530</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span> *s2 = lmemfind(s+init, l1-(size_t)init, p, l2);</td></tr>
<tr class="codeline" data-linenumber="531"><td class="num" id="LN531">531</td><td class="line">    <span class='keyword'>if</span> (s2) {</td></tr>
<tr class="codeline" data-linenumber="532"><td class="num" id="LN532">532</td><td class="line">      lua_pushinteger(L, s2-s+1);</td></tr>
<tr class="codeline" data-linenumber="533"><td class="num" id="LN533">533</td><td class="line">      lua_pushinteger(L, s2-s+(ptrdiff_t)l2);</td></tr>
<tr class="codeline" data-linenumber="534"><td class="num" id="LN534">534</td><td class="line">      <span class='keyword'>return</span> 2;</td></tr>
<tr class="codeline" data-linenumber="535"><td class="num" id="LN535">535</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="536"><td class="num" id="LN536">536</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="537"><td class="num" id="LN537">537</td><td class="line">    MatchState ms;</td></tr>
<tr class="codeline" data-linenumber="538"><td class="num" id="LN538">538</td><td class="line">    <span class='keyword'>int</span> anchor = (*p == '^') ? (p++, 1) : 0;</td></tr>
<tr class="codeline" data-linenumber="539"><td class="num" id="LN539">539</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span> *s1=s+init;</td></tr>
<tr class="codeline" data-linenumber="540"><td class="num" id="LN540">540</td><td class="line">    ms.L = L;</td></tr>
<tr class="codeline" data-linenumber="541"><td class="num" id="LN541">541</td><td class="line">    ms.src_init = s;</td></tr>
<tr class="codeline" data-linenumber="542"><td class="num" id="LN542">542</td><td class="line">    ms.src_end = s+l1;</td></tr>
<tr class="codeline" data-linenumber="543"><td class="num" id="LN543">543</td><td class="line">    <span class='keyword'>do</span> {</td></tr>
<tr class="codeline" data-linenumber="544"><td class="num" id="LN544">544</td><td class="line">      <span class='keyword'>const</span> <span class='keyword'>char</span> *res;</td></tr>
<tr class="codeline" data-linenumber="545"><td class="num" id="LN545">545</td><td class="line">      ms.level = ms.depth = 0;</td></tr>
<tr class="codeline" data-linenumber="546"><td class="num" id="LN546">546</td><td class="line">      <span class='keyword'>if</span> ((res=match(&amp;ms, s1, p)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="547"><td class="num" id="LN547">547</td><td class="line">	<span class='keyword'>if</span> (find) {</td></tr>
<tr class="codeline" data-linenumber="548"><td class="num" id="LN548">548</td><td class="line">	  lua_pushinteger(L, s1-s+1);  <span class='comment'>/* start */</span></td></tr>
<tr class="codeline" data-linenumber="549"><td class="num" id="LN549">549</td><td class="line">	  lua_pushinteger(L, res-s);   <span class='comment'>/* end */</span></td></tr>
<tr class="codeline" data-linenumber="550"><td class="num" id="LN550">550</td><td class="line">	  <span class='keyword'>return</span> push_captures(&amp;ms, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, 0) + 2;</td></tr>
<tr class="codeline" data-linenumber="551"><td class="num" id="LN551">551</td><td class="line">	} <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="552"><td class="num" id="LN552">552</td><td class="line">	  <span class='keyword'>return</span> push_captures(&amp;ms, s1, res);</td></tr>
<tr class="codeline" data-linenumber="553"><td class="num" id="LN553">553</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="554"><td class="num" id="LN554">554</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="555"><td class="num" id="LN555">555</td><td class="line">    } <span class='keyword'>while</span> (s1++ &lt; ms.src_end &amp;&amp; !anchor);</td></tr>
<tr class="codeline" data-linenumber="556"><td class="num" id="LN556">556</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="557"><td class="num" id="LN557">557</td><td class="line">  lua_pushnil(L);  <span class='comment'>/* not found */</span></td></tr>
<tr class="codeline" data-linenumber="558"><td class="num" id="LN558">558</td><td class="line">  <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="559"><td class="num" id="LN559">559</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="560"><td class="num" id="LN560">560</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="561"><td class="num" id="LN561">561</td><td class="line"><span class='macro'>LJLIB_CF(string_find)<span class='macro_popup'>static int lj_cf_string_find(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="562"><td class="num" id="LN562">562</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="563"><td class="num" id="LN563">563</td><td class="line">  <span class='keyword'>return</span> str_find_aux(L, 1);</td></tr>
<tr class="codeline" data-linenumber="564"><td class="num" id="LN564">564</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="565"><td class="num" id="LN565">565</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="566"><td class="num" id="LN566">566</td><td class="line"><span class='macro'>LJLIB_CF(string_match)<span class='macro_popup'>static int lj_cf_string_match(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="567"><td class="num" id="LN567">567</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="568"><td class="num" id="LN568">568</td><td class="line">  <span class='keyword'>return</span> str_find_aux(L, 0);</td></tr>
<tr class="codeline" data-linenumber="569"><td class="num" id="LN569">569</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="570"><td class="num" id="LN570">570</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="571"><td class="num" id="LN571">571</td><td class="line">LJLIB_NOREG <span class='macro'>LJLIB_CF(string_gmatch_aux)<span class='macro_popup'>static int lj_cf_string_gmatch_aux(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="572"><td class="num" id="LN572">572</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="573"><td class="num" id="LN573">573</td><td class="line">  <span class='keyword'>const</span> <span class='keyword'>char</span> *p = <span class='macro'>strVdata(lj_lib_upvalue(L, 2))<span class='macro_popup'>((const char *)(((((void)0), (&amp;(((GCobj *)(uintptr_t)(((&amp;<br>((GCobj *)(uintptr_t)((L-&gt;base-1)-&gt;fr.func).gcptr32)-&gt;<br>fn.c.upvalue[(2)-1]))-&gt;gcr).gcptr32))-&gt;str)))+1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="574"><td class="num" id="LN574">574</td><td class="line">  GCstr *str = <span class='macro'>strV(lj_lib_upvalue(L, 1))<span class='macro_popup'>(((void)0), (&amp;(((GCobj *)(uintptr_t)(((&amp;((GCobj *)(uintptr_t<br>)((L-&gt;base-1)-&gt;fr.func).gcptr32)-&gt;fn.c.upvalue[(1)-1<br>]))-&gt;gcr).gcptr32))-&gt;str))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="575"><td class="num" id="LN575">575</td><td class="line">  <span class='keyword'>const</span> <span class='keyword'>char</span> *s = <span class='macro'>strdata(str)<span class='macro_popup'>((const char *)((str)+1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="576"><td class="num" id="LN576">576</td><td class="line">  TValue *tvpos = <span class='macro'>lj_lib_upvalue(L, 3)<span class='macro_popup'>(&amp;((GCobj *)(uintptr_t)((L-&gt;base-1)-&gt;fr.func).gcptr32<br>)-&gt;fn.c.upvalue[(3)-1])</span></span>;</td></tr>
<tr class="codeline" data-linenumber="577"><td class="num" id="LN577">577</td><td class="line">  <span class='keyword'>const</span> <span class='keyword'>char</span> *src = s + tvpos-&gt;u32.lo;</td></tr>
<tr class="codeline" data-linenumber="578"><td class="num" id="LN578">578</td><td class="line">  MatchState ms;</td></tr>
<tr class="codeline" data-linenumber="579"><td class="num" id="LN579">579</td><td class="line">  ms.L = L;</td></tr>
<tr class="codeline" data-linenumber="580"><td class="num" id="LN580">580</td><td class="line">  ms.src_init = s;</td></tr>
<tr class="codeline" data-linenumber="581"><td class="num" id="LN581">581</td><td class="line">  ms.src_end = s + str-&gt;len;</td></tr>
<tr class="codeline" data-linenumber="582"><td class="num" id="LN582">582</td><td class="line">  <span class='keyword'>for</span> (; src &lt;= ms.src_end; src++) {</td></tr>
<tr class="codeline" data-linenumber="583"><td class="num" id="LN583">583</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span> *e;</td></tr>
<tr class="codeline" data-linenumber="584"><td class="num" id="LN584">584</td><td class="line">    ms.level = ms.depth = 0;</td></tr>
<tr class="codeline" data-linenumber="585"><td class="num" id="LN585">585</td><td class="line">    <span class='keyword'>if</span> ((e = match(&amp;ms, src, p)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="586"><td class="num" id="LN586">586</td><td class="line">      int32_t pos = (int32_t)(e - s);</td></tr>
<tr class="codeline" data-linenumber="587"><td class="num" id="LN587">587</td><td class="line">      <span class='keyword'>if</span> (e == src) pos++;  <span class='comment'>/* Ensure progress for empty match. */</span></td></tr>
<tr class="codeline" data-linenumber="588"><td class="num" id="LN588">588</td><td class="line">      tvpos-&gt;u32.lo = (uint32_t)pos;</td></tr>
<tr class="codeline" data-linenumber="589"><td class="num" id="LN589">589</td><td class="line">      <span class='keyword'>return</span> push_captures(&amp;ms, src, e);</td></tr>
<tr class="codeline" data-linenumber="590"><td class="num" id="LN590">590</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="591"><td class="num" id="LN591">591</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="592"><td class="num" id="LN592">592</td><td class="line">  <span class='keyword'>return</span> 0;  <span class='comment'>/* not found */</span></td></tr>
<tr class="codeline" data-linenumber="593"><td class="num" id="LN593">593</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="594"><td class="num" id="LN594">594</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="595"><td class="num" id="LN595">595</td><td class="line"><span class='macro'>LJLIB_CF(string_gmatch)<span class='macro_popup'>static int lj_cf_string_gmatch(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="596"><td class="num" id="LN596">596</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="597"><td class="num" id="LN597">597</td><td class="line">  lj_lib_checkstr(L, 1);</td></tr>
<tr class="codeline" data-linenumber="598"><td class="num" id="LN598">598</td><td class="line">  lj_lib_checkstr(L, 2);</td></tr>
<tr class="codeline" data-linenumber="599"><td class="num" id="LN599">599</td><td class="line">  L-&gt;top = L-&gt;base+3;</td></tr>
<tr class="codeline" data-linenumber="600"><td class="num" id="LN600">600</td><td class="line">  (L-&gt;top-1)-&gt;u64 = 0;</td></tr>
<tr class="codeline" data-linenumber="601"><td class="num" id="LN601">601</td><td class="line">  lj_lib_pushcc(L, lj_cf_string_gmatch_aux, FF_string_gmatch_aux, 3);</td></tr>
<tr class="codeline" data-linenumber="602"><td class="num" id="LN602">602</td><td class="line">  <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="603"><td class="num" id="LN603">603</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="604"><td class="num" id="LN604">604</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="605"><td class="num" id="LN605">605</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> add_s(MatchState *ms, luaL_Buffer *b, <span class='keyword'>const</span> <span class='keyword'>char</span> *s, <span class='keyword'>const</span> <span class='keyword'>char</span> *e)</td></tr>
<tr class="codeline" data-linenumber="606"><td class="num" id="LN606">606</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="607"><td class="num" id="LN607">607</td><td class="line">  size_t l, i;</td></tr>
<tr class="codeline" data-linenumber="608"><td class="num" id="LN608">608</td><td class="line">  <span class='keyword'>const</span> <span class='keyword'>char</span> *news = lua_tolstring(ms-&gt;L, 3, &amp;l);</td></tr>
<tr class="codeline" data-linenumber="609"><td class="num" id="LN609">609</td><td class="line">  <span class='keyword'>for</span> (i = 0; i &lt; l; i++) {</td></tr>
<tr class="codeline" data-linenumber="610"><td class="num" id="LN610">610</td><td class="line">    <span class='keyword'>if</span> (news[i] != <span class='macro'>L_ESC<span class='macro_popup'>'%'</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="611"><td class="num" id="LN611">611</td><td class="line">      <span class='macro'>luaL_addchar(b, news[i])<span class='macro_popup'>((void)((b)-&gt;p &lt; ((b)-&gt;buffer+(8192 &gt; 16384 ? 8192<br> : 8192)) || luaL_prepbuffer(b)), (*(b)-&gt;p++ = (char)(news<br>[i])))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="612"><td class="num" id="LN612">612</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="613"><td class="num" id="LN613">613</td><td class="line">      i++;  <span class='comment'>/* skip ESC */</span></td></tr>
<tr class="codeline" data-linenumber="614"><td class="num" id="LN614">614</td><td class="line">      <span class='keyword'>if</span> (!<span class='macro'>lj_char_isdigit(uchar(news[i]))<span class='macro_popup'>((lj_char_bits+1)[((((unsigned char)(news[i]))))] &amp; 0x08)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="615"><td class="num" id="LN615">615</td><td class="line">	<span class='macro'>luaL_addchar(b, news[i])<span class='macro_popup'>((void)((b)-&gt;p &lt; ((b)-&gt;buffer+(8192 &gt; 16384 ? 8192<br> : 8192)) || luaL_prepbuffer(b)), (*(b)-&gt;p++ = (char)(news<br>[i])))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="616"><td class="num" id="LN616">616</td><td class="line">      } <span class='keyword'>else</span> <span class='keyword'>if</span> (news[i] == '0') {</td></tr>
<tr class="codeline" data-linenumber="617"><td class="num" id="LN617">617</td><td class="line">	luaL_addlstring(b, s, (size_t)(e - s));</td></tr>
<tr class="codeline" data-linenumber="618"><td class="num" id="LN618">618</td><td class="line">      } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="619"><td class="num" id="LN619">619</td><td class="line">	push_onecapture(ms, news[i] - '1', s, e);</td></tr>
<tr class="codeline" data-linenumber="620"><td class="num" id="LN620">620</td><td class="line">	luaL_addvalue(b);  <span class='comment'>/* add capture to accumulated result */</span></td></tr>
<tr class="codeline" data-linenumber="621"><td class="num" id="LN621">621</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="622"><td class="num" id="LN622">622</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="623"><td class="num" id="LN623">623</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="624"><td class="num" id="LN624">624</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="625"><td class="num" id="LN625">625</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="626"><td class="num" id="LN626">626</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> add_value(MatchState *ms, luaL_Buffer *b,</td></tr>
<tr class="codeline" data-linenumber="627"><td class="num" id="LN627">627</td><td class="line">		      <span class='keyword'>const</span> <span class='keyword'>char</span> *s, <span class='keyword'>const</span> <span class='keyword'>char</span> *e)</td></tr>
<tr class="codeline" data-linenumber="628"><td class="num" id="LN628">628</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="629"><td class="num" id="LN629">629</td><td class="line">  lua_State *L = ms-&gt;L;</td></tr>
<tr class="codeline" data-linenumber="630"><td class="num" id="LN630">630</td><td class="line">  <span class='keyword'>switch</span> (lua_type(L, 3)) {</td></tr>
<tr class="codeline" data-linenumber="631"><td class="num" id="LN631">631</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TNUMBER<span class='macro_popup'>3</span></span>:</td></tr>
<tr class="codeline" data-linenumber="632"><td class="num" id="LN632">632</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TSTRING<span class='macro_popup'>4</span></span>: {</td></tr>
<tr class="codeline" data-linenumber="633"><td class="num" id="LN633">633</td><td class="line">      add_s(ms, b, s, e);</td></tr>
<tr class="codeline" data-linenumber="634"><td class="num" id="LN634">634</td><td class="line">      <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="635"><td class="num" id="LN635">635</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="636"><td class="num" id="LN636">636</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TFUNCTION<span class='macro_popup'>6</span></span>: {</td></tr>
<tr class="codeline" data-linenumber="637"><td class="num" id="LN637">637</td><td class="line">      <span class='keyword'>int</span> n;</td></tr>
<tr class="codeline" data-linenumber="638"><td class="num" id="LN638">638</td><td class="line">      lua_pushvalue(L, 3);</td></tr>
<tr class="codeline" data-linenumber="639"><td class="num" id="LN639">639</td><td class="line">      n = push_captures(ms, s, e);</td></tr>
<tr class="codeline" data-linenumber="640"><td class="num" id="LN640">640</td><td class="line">      lua_call(L, n, 1);</td></tr>
<tr class="codeline" data-linenumber="641"><td class="num" id="LN641">641</td><td class="line">      <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="642"><td class="num" id="LN642">642</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="643"><td class="num" id="LN643">643</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TTABLE<span class='macro_popup'>5</span></span>: {</td></tr>
<tr class="codeline" data-linenumber="644"><td class="num" id="LN644">644</td><td class="line">      push_onecapture(ms, 0, s, e);</td></tr>
<tr class="codeline" data-linenumber="645"><td class="num" id="LN645">645</td><td class="line">      lua_gettable(L, 3);</td></tr>
<tr class="codeline" data-linenumber="646"><td class="num" id="LN646">646</td><td class="line">      <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="647"><td class="num" id="LN647">647</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="648"><td class="num" id="LN648">648</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="649"><td class="num" id="LN649">649</td><td class="line">  <span class='keyword'>if</span> (!lua_toboolean(L, -1)) {  <span class='comment'>/* nil or false? */</span></td></tr>
<tr class="codeline" data-linenumber="650"><td class="num" id="LN650">650</td><td class="line">    <span class='macro'>lua_pop(L, 1)<span class='macro_popup'>lua_settop(L, -(1)-1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="651"><td class="num" id="LN651">651</td><td class="line">    lua_pushlstring(L, s, (size_t)(e - s));  <span class='comment'>/* keep original text */</span></td></tr>
<tr class="codeline" data-linenumber="652"><td class="num" id="LN652">652</td><td class="line">  } <span class='keyword'>else</span> <span class='keyword'>if</span> (!lua_isstring(L, -1)) {</td></tr>
<tr class="codeline" data-linenumber="653"><td class="num" id="LN653">653</td><td class="line">    lj_err_callerv(L, LJ_ERR_STRGSRV, <span class='macro'>luaL_typename(L, -1)<span class='macro_popup'>lua_typename(L, lua_type(L,(-1)))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="654"><td class="num" id="LN654">654</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="655"><td class="num" id="LN655">655</td><td class="line">  luaL_addvalue(b);  <span class='comment'>/* add result to accumulator */</span></td></tr>
<tr class="codeline" data-linenumber="656"><td class="num" id="LN656">656</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="657"><td class="num" id="LN657">657</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="658"><td class="num" id="LN658">658</td><td class="line"><span class='macro'>LJLIB_CF(string_gsub)<span class='macro_popup'>static int lj_cf_string_gsub(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="659"><td class="num" id="LN659">659</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="660"><td class="num" id="LN660">660</td><td class="line">  size_t srcl;</td></tr>
<tr class="codeline" data-linenumber="661"><td class="num" id="LN661">661</td><td class="line">  <span class='keyword'>const</span> <span class='keyword'>char</span> *src = luaL_checklstring(L, 1, &amp;srcl);</td></tr>
<tr class="codeline" data-linenumber="662"><td class="num" id="LN662">662</td><td class="line">  <span class='keyword'>const</span> <span class='keyword'>char</span> *p = <span class='macro'>luaL_checkstring(L, 2)<span class='macro_popup'>(luaL_checklstring(L, (2), ((void*)0)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="663"><td class="num" id="LN663">663</td><td class="line">  <span class='keyword'>int</span>  tr = lua_type(L, 3);</td></tr>
<tr class="codeline" data-linenumber="664"><td class="num" id="LN664">664</td><td class="line">  <span class='keyword'>int</span> max_s = <span class='macro'>luaL_optint(L, 4, (<span class='keyword'>int</span>)(srcl+1))<span class='macro_popup'>((int)luaL_optinteger(L, (4), ((int)(srcl+1))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="665"><td class="num" id="LN665">665</td><td class="line">  <span class='keyword'>int</span> anchor = (*p == '^') ? (p++, 1) : 0;</td></tr>
<tr class="codeline" data-linenumber="666"><td class="num" id="LN666">666</td><td class="line">  <span class='keyword'>int</span> n = 0;</td></tr>
<tr class="codeline" data-linenumber="667"><td class="num" id="LN667">667</td><td class="line">  MatchState ms;</td></tr>
<tr class="codeline" data-linenumber="668"><td class="num" id="LN668">668</td><td class="line">  luaL_Buffer b;</td></tr>
<tr class="codeline" data-linenumber="669"><td class="num" id="LN669">669</td><td class="line">  <span class='keyword'>if</span> (!(tr == <span class='macro'>LUA_TNUMBER<span class='macro_popup'>3</span></span> || tr == <span class='macro'>LUA_TSTRING<span class='macro_popup'>4</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="670"><td class="num" id="LN670">670</td><td class="line">	tr == <span class='macro'>LUA_TFUNCTION<span class='macro_popup'>6</span></span> || tr == <span class='macro'>LUA_TTABLE<span class='macro_popup'>5</span></span>))</td></tr>
<tr class="codeline" data-linenumber="671"><td class="num" id="LN671">671</td><td class="line">    lj_err_arg(L, 3, LJ_ERR_NOSFT);</td></tr>
<tr class="codeline" data-linenumber="672"><td class="num" id="LN672">672</td><td class="line">  luaL_buffinit(L, &amp;b);</td></tr>
<tr class="codeline" data-linenumber="673"><td class="num" id="LN673">673</td><td class="line">  ms.L = L;</td></tr>
<tr class="codeline" data-linenumber="674"><td class="num" id="LN674">674</td><td class="line">  ms.src_init = src;</td></tr>
<tr class="codeline" data-linenumber="675"><td class="num" id="LN675">675</td><td class="line">  ms.src_end = src+srcl;</td></tr>
<tr class="codeline" data-linenumber="676"><td class="num" id="LN676">676</td><td class="line">  <span class='keyword'>while</span> (n &lt; max_s) {</td></tr>
<tr class="codeline" data-linenumber="677"><td class="num" id="LN677">677</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span> *e;</td></tr>
<tr class="codeline" data-linenumber="678"><td class="num" id="LN678">678</td><td class="line">    ms.level = ms.depth = 0;</td></tr>
<tr class="codeline" data-linenumber="679"><td class="num" id="LN679">679</td><td class="line">    e = match(&amp;ms, src, p);</td></tr>
<tr class="codeline" data-linenumber="680"><td class="num" id="LN680">680</td><td class="line">    <span class='keyword'>if</span> (e) {</td></tr>
<tr class="codeline" data-linenumber="681"><td class="num" id="LN681">681</td><td class="line">      n++;</td></tr>
<tr class="codeline" data-linenumber="682"><td class="num" id="LN682">682</td><td class="line">      add_value(&amp;ms, &amp;b, src, e);</td></tr>
<tr class="codeline" data-linenumber="683"><td class="num" id="LN683">683</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="684"><td class="num" id="LN684">684</td><td class="line">    <span class='keyword'>if</span> (e &amp;&amp; e&gt;src) <span class='comment'>/* non empty match? */</span></td></tr>
<tr class="codeline" data-linenumber="685"><td class="num" id="LN685">685</td><td class="line">      src = e;  <span class='comment'>/* skip it */</span></td></tr>
<tr class="codeline" data-linenumber="686"><td class="num" id="LN686">686</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (src &lt; ms.src_end)</td></tr>
<tr class="codeline" data-linenumber="687"><td class="num" id="LN687">687</td><td class="line">      <span class='macro'>luaL_addchar(&amp;b, *src++)<span class='macro_popup'>((void)((&amp;b)-&gt;p &lt; ((&amp;b)-&gt;buffer+(8192 &gt; 16384<br> ? 8192 : 8192)) || luaL_prepbuffer(&amp;b)), (*(&amp;b)-&gt;<br>p++ = (char)(*src++)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="688"><td class="num" id="LN688">688</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="689"><td class="num" id="LN689">689</td><td class="line">      <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="690"><td class="num" id="LN690">690</td><td class="line">    <span class='keyword'>if</span> (anchor)</td></tr>
<tr class="codeline" data-linenumber="691"><td class="num" id="LN691">691</td><td class="line">      <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="692"><td class="num" id="LN692">692</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="693"><td class="num" id="LN693">693</td><td class="line">  luaL_addlstring(&amp;b, src, (size_t)(ms.src_end-src));</td></tr>
<tr class="codeline" data-linenumber="694"><td class="num" id="LN694">694</td><td class="line">  luaL_pushresult(&amp;b);</td></tr>
<tr class="codeline" data-linenumber="695"><td class="num" id="LN695">695</td><td class="line">  lua_pushinteger(L, n);  <span class='comment'>/* number of substitutions */</span></td></tr>
<tr class="codeline" data-linenumber="696"><td class="num" id="LN696">696</td><td class="line">  <span class='keyword'>return</span> 2;</td></tr>
<tr class="codeline" data-linenumber="697"><td class="num" id="LN697">697</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="698"><td class="num" id="LN698">698</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="699"><td class="num" id="LN699">699</td><td class="line"><span class='comment'>/* ------------------------------------------------------------------------ */</span></td></tr>
<tr class="codeline" data-linenumber="700"><td class="num" id="LN700">700</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="701"><td class="num" id="LN701">701</td><td class="line"><span class='comment'>/* maximum size of each formatted item (&gt; len(format('%99.99f', -1e308))) */</span></td></tr>
<tr class="codeline" data-linenumber="702"><td class="num" id="LN702">702</td><td class="line"><span class='directive'>#define <span class='macro'>MAX_FMTITEM<span class='macro_popup'>512</span></span>	512</span></td></tr>
<tr class="codeline" data-linenumber="703"><td class="num" id="LN703">703</td><td class="line"><span class='comment'>/* valid flags in a format specification */</span></td></tr>
<tr class="codeline" data-linenumber="704"><td class="num" id="LN704">704</td><td class="line"><span class='directive'>#define <span class='macro'>FMT_FLAGS<span class='macro_popup'>"-+ #0"</span></span>	"-+ #0"</span></td></tr>
<tr class="codeline" data-linenumber="705"><td class="num" id="LN705">705</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="706"><td class="num" id="LN706">706</td><td class="line"><span class='comment'>** maximum size of each format specification (such as '%-099.99d')</span></td></tr>
<tr class="codeline" data-linenumber="707"><td class="num" id="LN707">707</td><td class="line"><span class='comment'>** (+10 accounts for %99.99x plus margin of error)</span></td></tr>
<tr class="codeline" data-linenumber="708"><td class="num" id="LN708">708</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="709"><td class="num" id="LN709">709</td><td class="line"><span class='directive'>#define <span class='macro'>MAX_FMTSPEC<span class='macro_popup'>(sizeof("-+ #0") + sizeof("l") + 10)</span></span>	(sizeof(<span class='macro'>FMT_FLAGS<span class='macro_popup'>"-+ #0"</span></span>) + sizeof(<span class='macro'>LUA_INTFRMLEN<span class='macro_popup'>"l"</span></span>) + 10)</span></td></tr>
<tr class="codeline" data-linenumber="710"><td class="num" id="LN710">710</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="711"><td class="num" id="LN711">711</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> addquoted(lua_State *L, luaL_Buffer *b, <span class='keyword'>int</span> arg)</td></tr>
<tr class="codeline" data-linenumber="712"><td class="num" id="LN712">712</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="713"><td class="num" id="LN713">713</td><td class="line">  GCstr *str = lj_lib_checkstr(L, arg);</td></tr>
<tr class="codeline" data-linenumber="714"><td class="num" id="LN714">714</td><td class="line">  int32_t len = (int32_t)str-&gt;len;</td></tr>
<tr class="codeline" data-linenumber="715"><td class="num" id="LN715">715</td><td class="line">  <span class='keyword'>const</span> <span class='keyword'>char</span> *s = <span class='macro'>strdata(str)<span class='macro_popup'>((const char *)((str)+1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="716"><td class="num" id="LN716">716</td><td class="line">  <span class='macro'>luaL_addchar(b, '"')<span class='macro_popup'>((void)((b)-&gt;p &lt; ((b)-&gt;buffer+(8192 &gt; 16384 ? 8192<br> : 8192)) || luaL_prepbuffer(b)), (*(b)-&gt;p++ = (char)('"')<br>))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="717"><td class="num" id="LN717">717</td><td class="line">  <span class='keyword'>while</span> (len--) {</td></tr>
<tr class="codeline" data-linenumber="718"><td class="num" id="LN718">718</td><td class="line">    uint32_t c = <span class='macro'>uchar(*s)<span class='macro_popup'>((unsigned char)(*s))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="719"><td class="num" id="LN719">719</td><td class="line">    <span class='keyword'>if</span> (c == '"' || c == '\\' || c == '\n') {</td></tr>
<tr class="codeline" data-linenumber="720"><td class="num" id="LN720">720</td><td class="line">      <span class='macro'>luaL_addchar(b, '\\')<span class='macro_popup'>((void)((b)-&gt;p &lt; ((b)-&gt;buffer+(8192 &gt; 16384 ? 8192<br> : 8192)) || luaL_prepbuffer(b)), (*(b)-&gt;p++ = (char)('\\'<br>)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="721"><td class="num" id="LN721">721</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>lj_char_iscntrl(c)<span class='macro_popup'>((lj_char_bits+1)[((c))] &amp; 0x01)</span></span>) {  <span class='comment'>/* This can only be 0-31 or 127. */</span></td></tr>
<tr class="codeline" data-linenumber="722"><td class="num" id="LN722">722</td><td class="line">      uint32_t d;</td></tr>
<tr class="codeline" data-linenumber="723"><td class="num" id="LN723">723</td><td class="line">      <span class='macro'>luaL_addchar(b, '\\')<span class='macro_popup'>((void)((b)-&gt;p &lt; ((b)-&gt;buffer+(8192 &gt; 16384 ? 8192<br> : 8192)) || luaL_prepbuffer(b)), (*(b)-&gt;p++ = (char)('\\'<br>)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="724"><td class="num" id="LN724">724</td><td class="line">      <span class='keyword'>if</span> (c &gt;= 100 || <span class='macro'>lj_char_isdigit(uchar(s[1]))<span class='macro_popup'>((lj_char_bits+1)[((((unsigned char)(s[1]))))] &amp; 0x08)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="725"><td class="num" id="LN725">725</td><td class="line">	<span class='macro'>luaL_addchar(b, '0'+(c &gt;= 100))<span class='macro_popup'>((void)((b)-&gt;p &lt; ((b)-&gt;buffer+(8192 &gt; 16384 ? 8192<br> : 8192)) || luaL_prepbuffer(b)), (*(b)-&gt;p++ = (char)('0'+<br>(c &gt;= 100))))</span></span>; <span class='keyword'>if</span> (c &gt;= 100) c -= 100;</td></tr>
<tr class="codeline" data-linenumber="726"><td class="num" id="LN726">726</td><td class="line">	<span class='keyword'>goto</span> tens;</td></tr>
<tr class="codeline" data-linenumber="727"><td class="num" id="LN727">727</td><td class="line">      } <span class='keyword'>else</span> <span class='keyword'>if</span> (c &gt;= 10) {</td></tr>
<tr class="codeline" data-linenumber="728"><td class="num" id="LN728">728</td><td class="line">      tens:</td></tr>
<tr class="codeline" data-linenumber="729"><td class="num" id="LN729">729</td><td class="line">	d = (c * 205) &gt;&gt; 11; c -= d * 10; <span class='macro'>luaL_addchar(b, '0'+d)<span class='macro_popup'>((void)((b)-&gt;p &lt; ((b)-&gt;buffer+(8192 &gt; 16384 ? 8192<br> : 8192)) || luaL_prepbuffer(b)), (*(b)-&gt;p++ = (char)('0'+<br>d)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="730"><td class="num" id="LN730">730</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="731"><td class="num" id="LN731">731</td><td class="line">      c += '0';</td></tr>
<tr class="codeline" data-linenumber="732"><td class="num" id="LN732">732</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="733"><td class="num" id="LN733">733</td><td class="line">    <span class='macro'>luaL_addchar(b, c)<span class='macro_popup'>((void)((b)-&gt;p &lt; ((b)-&gt;buffer+(8192 &gt; 16384 ? 8192<br> : 8192)) || luaL_prepbuffer(b)), (*(b)-&gt;p++ = (char)(c)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="734"><td class="num" id="LN734">734</td><td class="line">    s++;</td></tr>
<tr class="codeline" data-linenumber="735"><td class="num" id="LN735">735</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="736"><td class="num" id="LN736">736</td><td class="line">  <span class='macro'>luaL_addchar(b, '"')<span class='macro_popup'>((void)((b)-&gt;p &lt; ((b)-&gt;buffer+(8192 &gt; 16384 ? 8192<br> : 8192)) || luaL_prepbuffer(b)), (*(b)-&gt;p++ = (char)('"')<br>))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="737"><td class="num" id="LN737">737</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="738"><td class="num" id="LN738">738</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="739"><td class="num" id="LN739">739</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span> *scanformat(lua_State *L, <span class='keyword'>const</span> <span class='keyword'>char</span> *strfrmt, <span class='keyword'>char</span> *form)</td></tr>
<tr class="codeline" data-linenumber="740"><td class="num" id="LN740">740</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="741"><td class="num" id="LN741">741</td><td class="line">  <span class='keyword'>const</span> <span class='keyword'>char</span> *p = strfrmt;</td></tr>
<tr class="codeline" data-linenumber="742"><td class="num" id="LN742">742</td><td class="line">  <span class='keyword'>while</span> (*p != '\0' &amp;&amp; strchr(<span class='macro'>FMT_FLAGS<span class='macro_popup'>"-+ #0"</span></span>, *p) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) p++;  <span class='comment'>/* skip flags */</span></td></tr>
<tr class="codeline" data-linenumber="743"><td class="num" id="LN743">743</td><td class="line">  <span class='keyword'>if</span> ((size_t)(p - strfrmt) &gt;= <span class='keyword'>sizeof</span>(<span class='macro'>FMT_FLAGS<span class='macro_popup'>"-+ #0"</span></span>))</td></tr>
<tr class="codeline" data-linenumber="744"><td class="num" id="LN744">744</td><td class="line">    lj_err_caller(L, LJ_ERR_STRFMTR);</td></tr>
<tr class="codeline" data-linenumber="745"><td class="num" id="LN745">745</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>lj_char_isdigit(uchar(*p))<span class='macro_popup'>((lj_char_bits+1)[((((unsigned char)(*p))))] &amp; 0x08)</span></span>) p++;  <span class='comment'>/* skip width */</span></td></tr>
<tr class="codeline" data-linenumber="746"><td class="num" id="LN746">746</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>lj_char_isdigit(uchar(*p))<span class='macro_popup'>((lj_char_bits+1)[((((unsigned char)(*p))))] &amp; 0x08)</span></span>) p++;  <span class='comment'>/* (2 digits at most) */</span></td></tr>
<tr class="codeline" data-linenumber="747"><td class="num" id="LN747">747</td><td class="line">  <span class='keyword'>if</span> (*p == '.') {</td></tr>
<tr class="codeline" data-linenumber="748"><td class="num" id="LN748">748</td><td class="line">    p++;</td></tr>
<tr class="codeline" data-linenumber="749"><td class="num" id="LN749">749</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>lj_char_isdigit(uchar(*p))<span class='macro_popup'>((lj_char_bits+1)[((((unsigned char)(*p))))] &amp; 0x08)</span></span>) p++;  <span class='comment'>/* skip precision */</span></td></tr>
<tr class="codeline" data-linenumber="750"><td class="num" id="LN750">750</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>lj_char_isdigit(uchar(*p))<span class='macro_popup'>((lj_char_bits+1)[((((unsigned char)(*p))))] &amp; 0x08)</span></span>) p++;  <span class='comment'>/* (2 digits at most) */</span></td></tr>
<tr class="codeline" data-linenumber="751"><td class="num" id="LN751">751</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="752"><td class="num" id="LN752">752</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>lj_char_isdigit(uchar(*p))<span class='macro_popup'>((lj_char_bits+1)[((((unsigned char)(*p))))] &amp; 0x08)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="753"><td class="num" id="LN753">753</td><td class="line">    lj_err_caller(L, LJ_ERR_STRFMTW);</td></tr>
<tr class="codeline" data-linenumber="754"><td class="num" id="LN754">754</td><td class="line">  *(form++) = '%';</td></tr>
<tr class="codeline" data-linenumber="755"><td class="num" id="LN755">755</td><td class="line">  strncpy(form, strfrmt, (size_t)(p - strfrmt + 1));</td></tr>
<tr class="codeline" data-linenumber="756"><td class="num" id="LN756">756</td><td class="line">  form += p - strfrmt + 1;</td></tr>
<tr class="codeline" data-linenumber="757"><td class="num" id="LN757">757</td><td class="line">  *form = '\0';</td></tr>
<tr class="codeline" data-linenumber="758"><td class="num" id="LN758">758</td><td class="line">  <span class='keyword'>return</span> p;</td></tr>
<tr class="codeline" data-linenumber="759"><td class="num" id="LN759">759</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="760"><td class="num" id="LN760">760</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="761"><td class="num" id="LN761">761</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> addintlen(<span class='keyword'>char</span> *form)</td></tr>
<tr class="codeline" data-linenumber="762"><td class="num" id="LN762">762</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="763"><td class="num" id="LN763">763</td><td class="line">  size_t l = strlen(form);</td></tr>
<tr class="codeline" data-linenumber="764"><td class="num" id="LN764">764</td><td class="line">  <span class='keyword'>char</span> spec = form[l - 1];</td></tr>
<tr class="codeline" data-linenumber="765"><td class="num" id="LN765">765</td><td class="line">  strcpy(form + l - 1, <span class='macro'>LUA_INTFRMLEN<span class='macro_popup'>"l"</span></span>);</td></tr>
<tr class="codeline" data-linenumber="766"><td class="num" id="LN766">766</td><td class="line">  form[l + <span class='keyword'>sizeof</span>(<span class='macro'>LUA_INTFRMLEN<span class='macro_popup'>"l"</span></span>) - 2] = spec;</td></tr>
<tr class="codeline" data-linenumber="767"><td class="num" id="LN767">767</td><td class="line">  form[l + <span class='keyword'>sizeof</span>(<span class='macro'>LUA_INTFRMLEN<span class='macro_popup'>"l"</span></span>) - 1] = '\0';</td></tr>
<tr class="codeline" data-linenumber="768"><td class="num" id="LN768">768</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="769"><td class="num" id="LN769">769</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="770"><td class="num" id="LN770">770</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='macro'>LUA_INTFRM_T<span class='macro_popup'>long</span></span> num2intfrm(lua_State *L, <span class='keyword'>int</span> arg)</td></tr>
<tr class="codeline" data-linenumber="771"><td class="num" id="LN771">771</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="772"><td class="num" id="LN772">772</td><td class="line">  <span class='keyword'>if</span> (<span class='keyword'>sizeof</span>(<span class='macro'>LUA_INTFRM_T<span class='macro_popup'>long</span></span>) == 4) {</td></tr>
<tr class="codeline" data-linenumber="773"><td class="num" id="LN773">773</td><td class="line">    <span class='keyword'>return</span> (<span class='macro'>LUA_INTFRM_T<span class='macro_popup'>long</span></span>)lj_lib_checkbit(L, arg);</td></tr>
<tr class="codeline" data-linenumber="774"><td class="num" id="LN774">774</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="775"><td class="num" id="LN775">775</td><td class="line">    cTValue *o;</td></tr>
<tr class="codeline" data-linenumber="776"><td class="num" id="LN776">776</td><td class="line">    <span class='macro'>lj_lib_checknumber(L, arg)<span class='macro_popup'>lj_lib_checknum((L), (arg))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="777"><td class="num" id="LN777">777</td><td class="line">    o = L-&gt;base+arg-1;</td></tr>
<tr class="codeline" data-linenumber="778"><td class="num" id="LN778">778</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>tvisint(o)<span class='macro_popup'>(0 &amp;&amp; ((o)-&gt;it) == 0xfffeffffu)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="779"><td class="num" id="LN779">779</td><td class="line">      <span class='keyword'>return</span> (<span class='macro'>LUA_INTFRM_T<span class='macro_popup'>long</span></span>)<span class='macro'>intV(o)<span class='macro_popup'>(((void)0), ((int32_t)(o)-&gt;i))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="780"><td class="num" id="LN780">780</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="781"><td class="num" id="LN781">781</td><td class="line">      <span class='keyword'>return</span> (<span class='macro'>LUA_INTFRM_T<span class='macro_popup'>long</span></span>)<span class='macro'>numV(o)<span class='macro_popup'>(((void)0), ((o)-&gt;n))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="782"><td class="num" id="LN782">782</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="783"><td class="num" id="LN783">783</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="784"><td class="num" id="LN784">784</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="785"><td class="num" id="LN785">785</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='macro'>LUA_INTFRM_T<span class='macro_popup'>long</span></span> num2uintfrm(lua_State *L, <span class='keyword'>int</span> arg)</td></tr>
<tr class="codeline" data-linenumber="786"><td class="num" id="LN786">786</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="787"><td class="num" id="LN787">787</td><td class="line">  <span class='keyword'>if</span> (<span class='keyword'>sizeof</span>(<span class='macro'>LUA_INTFRM_T<span class='macro_popup'>long</span></span>) == 4) {</td></tr>
<tr class="codeline" data-linenumber="788"><td class="num" id="LN788">788</td><td class="line">    <span class='keyword'>return</span> (<span class='keyword'>unsigned</span> <span class='macro'>LUA_INTFRM_T<span class='macro_popup'>long</span></span>)lj_lib_checkbit(L, arg);</td></tr>
<tr class="codeline" data-linenumber="789"><td class="num" id="LN789">789</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="790"><td class="num" id="LN790">790</td><td class="line">    cTValue *o;</td></tr>
<tr class="codeline" data-linenumber="791"><td class="num" id="LN791">791</td><td class="line">    <span class='macro'>lj_lib_checknumber(L, arg)<span class='macro_popup'>lj_lib_checknum((L), (arg))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="792"><td class="num" id="LN792">792</td><td class="line">    o = L-&gt;base+arg-1;</td></tr>
<tr class="codeline" data-linenumber="793"><td class="num" id="LN793">793</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>tvisint(o)<span class='macro_popup'>(0 &amp;&amp; ((o)-&gt;it) == 0xfffeffffu)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="794"><td class="num" id="LN794">794</td><td class="line">      <span class='keyword'>return</span> (<span class='keyword'>unsigned</span> <span class='macro'>LUA_INTFRM_T<span class='macro_popup'>long</span></span>)<span class='macro'>intV(o)<span class='macro_popup'>(((void)0), ((int32_t)(o)-&gt;i))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="795"><td class="num" id="LN795">795</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> ((int32_t)o-&gt;u32.hi &lt; 0)</td></tr>
<tr class="codeline" data-linenumber="796"><td class="num" id="LN796">796</td><td class="line">      <span class='keyword'>return</span> (<span class='keyword'>unsigned</span> <span class='macro'>LUA_INTFRM_T<span class='macro_popup'>long</span></span>)(<span class='macro'>LUA_INTFRM_T<span class='macro_popup'>long</span></span>)<span class='macro'>numV(o)<span class='macro_popup'>(((void)0), ((o)-&gt;n))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="797"><td class="num" id="LN797">797</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="798"><td class="num" id="LN798">798</td><td class="line">      <span class='keyword'>return</span> (<span class='keyword'>unsigned</span> <span class='macro'>LUA_INTFRM_T<span class='macro_popup'>long</span></span>)<span class='macro'>numV(o)<span class='macro_popup'>(((void)0), ((o)-&gt;n))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="799"><td class="num" id="LN799">799</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="800"><td class="num" id="LN800">800</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="801"><td class="num" id="LN801">801</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="802"><td class="num" id="LN802">802</td><td class="line"><span class='keyword'>static</span> GCstr *meta_tostring(lua_State *L, <span class='keyword'>int</span> arg)</td></tr>
<tr class="codeline" data-linenumber="803"><td class="num" id="LN803">803</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="804"><td class="num" id="LN804">804</td><td class="line">  TValue *o = L-&gt;base+arg-1;</td></tr>
<tr class="codeline" data-linenumber="805"><td class="num" id="LN805">805</td><td class="line">  cTValue *mo;</td></tr>
<tr class="codeline" data-linenumber="806"><td class="num" id="LN806">806</td><td class="line">  <span class='macro'>lua_assert(o &lt; L-&gt;top)<span class='macro_popup'>((void)0)</span></span>;  <span class='comment'>/* Caller already checks for existence. */</span></td></tr>
<tr class="codeline" data-linenumber="807"><td class="num" id="LN807">807</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>LJ_LIKELY(tvisstr(o))<span class='macro_popup'>__builtin_expect(!!((((o)-&gt;it) == (~4u))), 1)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="808"><td class="num" id="LN808">808</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>strV(o)<span class='macro_popup'>(((void)0), (&amp;(((GCobj *)(uintptr_t)((o)-&gt;gcr).gcptr32<br>))-&gt;str))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="809"><td class="num" id="LN809">809</td><td class="line">  <span class='keyword'>if</span> (!<span class='macro'>tvisnil(mo = lj_meta_lookup(L, o, MM_tostring))<span class='macro_popup'>(((mo = lj_meta_lookup(L, o, MM_tostring))-&gt;it) == (~0u))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="810"><td class="num" id="LN810">810</td><td class="line">    copyTV(L, L-&gt;top++, mo);</td></tr>
<tr class="codeline" data-linenumber="811"><td class="num" id="LN811">811</td><td class="line">    copyTV(L, L-&gt;top++, o);</td></tr>
<tr class="codeline" data-linenumber="812"><td class="num" id="LN812">812</td><td class="line">    lua_call(L, 1, 1);</td></tr>
<tr class="codeline" data-linenumber="813"><td class="num" id="LN813">813</td><td class="line">    L-&gt;top--;</td></tr>
<tr class="codeline" data-linenumber="814"><td class="num" id="LN814">814</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>tvisstr(L-&gt;top)<span class='macro_popup'>(((L-&gt;top)-&gt;it) == (~4u))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="815"><td class="num" id="LN815">815</td><td class="line">      <span class='keyword'>return</span> <span class='macro'>strV(L-&gt;top)<span class='macro_popup'>(((void)0), (&amp;(((GCobj *)(uintptr_t)((L-&gt;top)-&gt;gcr)<br>.gcptr32))-&gt;str))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="816"><td class="num" id="LN816">816</td><td class="line">    o = L-&gt;base+arg-1;</td></tr>
<tr class="codeline" data-linenumber="817"><td class="num" id="LN817">817</td><td class="line">    copyTV(L, o, L-&gt;top);</td></tr>
<tr class="codeline" data-linenumber="818"><td class="num" id="LN818">818</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="819"><td class="num" id="LN819">819</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>tvisnumber(o)<span class='macro_popup'>(((o)-&gt;it) &lt;= 0xfffeffffu)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="820"><td class="num" id="LN820">820</td><td class="line">    <span class='keyword'>return</span> lj_str_fromnumber(L, o);</td></tr>
<tr class="codeline" data-linenumber="821"><td class="num" id="LN821">821</td><td class="line">  } <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>tvisnil(o)<span class='macro_popup'>(((o)-&gt;it) == (~0u))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="822"><td class="num" id="LN822">822</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>lj_str_newlit(L, <span class='string_literal'>"nil"</span>)<span class='macro_popup'>(lj_str_new(L, "" "nil", sizeof("nil")-1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="823"><td class="num" id="LN823">823</td><td class="line">  } <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>tvisfalse(o)<span class='macro_popup'>(((o)-&gt;it) == (~1u))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="824"><td class="num" id="LN824">824</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>lj_str_newlit(L, <span class='string_literal'>"false"</span>)<span class='macro_popup'>(lj_str_new(L, "" "false", sizeof("false")-1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="825"><td class="num" id="LN825">825</td><td class="line">  } <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>tvistrue(o)<span class='macro_popup'>(((o)-&gt;it) == (~2u))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="826"><td class="num" id="LN826">826</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>lj_str_newlit(L, <span class='string_literal'>"true"</span>)<span class='macro_popup'>(lj_str_new(L, "" "true", sizeof("true")-1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="827"><td class="num" id="LN827">827</td><td class="line">  } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="828"><td class="num" id="LN828">828</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>tvisfunc(o)<span class='macro_popup'>(((o)-&gt;it) == (~8u))</span></span> &amp;&amp; <span class='macro'>isffunc(funcV(o))<span class='macro_popup'>(((((void)0), (&amp;(((GCobj *)(uintptr_t)((o)-&gt;gcr).gcptr32<br>))-&gt;fn)))-&gt;c.ffid &gt; 1)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="829"><td class="num" id="LN829">829</td><td class="line">      lj_str_pushf(L, <span class='string_literal'>"function: builtin#%d"</span>, <span class='macro'>funcV(o)<span class='macro_popup'>(((void)0), (&amp;(((GCobj *)(uintptr_t)((o)-&gt;gcr).gcptr32<br>))-&gt;fn))</span></span>-&gt;c.ffid);</td></tr>
<tr class="codeline" data-linenumber="830"><td class="num" id="LN830">830</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="831"><td class="num" id="LN831">831</td><td class="line">      lj_str_pushf(L, <span class='string_literal'>"%s: %p"</span>, <span class='macro'>lj_typename(o)<span class='macro_popup'>(lj_obj_itypename[((((o)-&gt;it) &lt;= 0xfffeffffu) ? ~(~13u)<br> : (((int32_t)((o)-&gt;it) &gt;&gt; 15) == -2) ? ~(~3u) : ~((<br>o)-&gt;it))])</span></span>, lua_topointer(L, arg));</td></tr>
<tr class="codeline" data-linenumber="832"><td class="num" id="LN832">832</td><td class="line">    L-&gt;top--;</td></tr>
<tr class="codeline" data-linenumber="833"><td class="num" id="LN833">833</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>strV(L-&gt;top)<span class='macro_popup'>(((void)0), (&amp;(((GCobj *)(uintptr_t)((L-&gt;top)-&gt;gcr)<br>.gcptr32))-&gt;str))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="834"><td class="num" id="LN834">834</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="835"><td class="num" id="LN835">835</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="836"><td class="num" id="LN836">836</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="837"><td class="num" id="LN837">837</td><td class="line"><span class='macro'>LJLIB_CF(string_format)<span class='macro_popup'>static int lj_cf_string_format(lua_State *L)</span></span></td></tr>
<tr class="codeline" data-linenumber="838"><td class="num" id="LN838">838</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="839"><td class="num" id="LN839">839</td><td class="line">  <span class='keyword'>int</span> arg = 1, top = (<span class='keyword'>int</span>)(L-&gt;top - L-&gt;base);</td></tr>
<tr class="codeline" data-linenumber="840"><td class="num" id="LN840">840</td><td class="line">  GCstr *fmt = lj_lib_checkstr(L, arg);</td></tr>
<tr class="codeline" data-linenumber="841"><td class="num" id="LN841">841</td><td class="line">  <span class='keyword'>const</span> <span class='keyword'>char</span> *strfrmt = <span class='macro'>strdata(fmt)<span class='macro_popup'>((const char *)((fmt)+1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="842"><td class="num" id="LN842">842</td><td class="line">  <span class='keyword'>const</span> <span class='keyword'>char</span> *strfrmt_end = strfrmt + fmt-&gt;len;</td></tr>
<tr class="codeline" data-linenumber="843"><td class="num" id="LN843">843</td><td class="line">  luaL_Buffer b;</td></tr>
<tr class="codeline" data-linenumber="844"><td class="num" id="LN844">844</td><td class="line">  luaL_buffinit(L, &amp;b);</td></tr>
<tr class="codeline" data-linenumber="845"><td class="num" id="LN845">845</td><td class="line">  <span class='keyword'>while</span> (strfrmt &lt; strfrmt_end) {</td></tr>
<tr class="codeline" data-linenumber="846"><td class="num" id="LN846">846</td><td class="line">    <span class='keyword'>if</span> (*strfrmt != <span class='macro'>L_ESC<span class='macro_popup'>'%'</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="847"><td class="num" id="LN847">847</td><td class="line">      <span class='macro'>luaL_addchar(&amp;b, *strfrmt++)<span class='macro_popup'>((void)((&amp;b)-&gt;p &lt; ((&amp;b)-&gt;buffer+(8192 &gt; 16384<br> ? 8192 : 8192)) || luaL_prepbuffer(&amp;b)), (*(&amp;b)-&gt;<br>p++ = (char)(*strfrmt++)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="848"><td class="num" id="LN848">848</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (*++strfrmt == <span class='macro'>L_ESC<span class='macro_popup'>'%'</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="849"><td class="num" id="LN849">849</td><td class="line">      <span class='macro'>luaL_addchar(&amp;b, *strfrmt++)<span class='macro_popup'>((void)((&amp;b)-&gt;p &lt; ((&amp;b)-&gt;buffer+(8192 &gt; 16384<br> ? 8192 : 8192)) || luaL_prepbuffer(&amp;b)), (*(&amp;b)-&gt;<br>p++ = (char)(*strfrmt++)))</span></span>;  <span class='comment'>/* %% */</span></td></tr>
<tr class="codeline" data-linenumber="850"><td class="num" id="LN850">850</td><td class="line">    } <span class='keyword'>else</span> { <span class='comment'>/* format item */</span></td></tr>
<tr class="codeline" data-linenumber="851"><td class="num" id="LN851">851</td><td class="line">      <span class='keyword'>char</span> form[<span class='macro'>MAX_FMTSPEC<span class='macro_popup'>(sizeof("-+ #0") + sizeof("l") + 10)</span></span>];  <span class='comment'>/* to store the format (`%...') */</span></td></tr>
<tr class="codeline" data-linenumber="852"><td class="num" id="LN852">852</td><td class="line">      <span class='keyword'>char</span> buff[<span class='macro'>MAX_FMTITEM<span class='macro_popup'>512</span></span>];  <span class='comment'>/* to store the formatted item */</span></td></tr>
<tr class="codeline" data-linenumber="853"><td class="num" id="LN853">853</td><td class="line">      <span class='keyword'>if</span> (++arg &gt; top)</td></tr>
<tr class="codeline" data-linenumber="854"><td class="num" id="LN854">854</td><td class="line">	luaL_argerror(L, arg, lj_obj_typename[0]);</td></tr>
<tr class="codeline" data-linenumber="855"><td class="num" id="LN855">855</td><td class="line">      strfrmt = scanformat(L, strfrmt, form);</td></tr>
<tr class="codeline" data-linenumber="856"><td class="num" id="LN856">856</td><td class="line">      <span class='keyword'>switch</span> (*strfrmt++) {</td></tr>
<tr class="codeline" data-linenumber="857"><td class="num" id="LN857">857</td><td class="line">      <span class='keyword'>case</span> 'c':</td></tr>
<tr class="codeline" data-linenumber="858"><td class="num" id="LN858">858</td><td class="line">	sprintf(buff, form, lj_lib_checkint(L, arg));</td></tr>
<tr class="codeline" data-linenumber="859"><td class="num" id="LN859">859</td><td class="line">	<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="860"><td class="num" id="LN860">860</td><td class="line">      <span class='keyword'>case</span> 'd':  <span class='keyword'>case</span> 'i':</td></tr>
<tr class="codeline" data-linenumber="861"><td class="num" id="LN861">861</td><td class="line">	addintlen(form);</td></tr>
<tr class="codeline" data-linenumber="862"><td class="num" id="LN862">862</td><td class="line">	sprintf(buff, form, num2intfrm(L, arg));</td></tr>
<tr class="codeline" data-linenumber="863"><td class="num" id="LN863">863</td><td class="line">	<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="864"><td class="num" id="LN864">864</td><td class="line">      <span class='keyword'>case</span> 'o':  <span class='keyword'>case</span> 'u':  <span class='keyword'>case</span> 'x':  <span class='keyword'>case</span> 'X':</td></tr>
<tr class="codeline" data-linenumber="865"><td class="num" id="LN865">865</td><td class="line">	addintlen(form);</td></tr>
<tr class="codeline" data-linenumber="866"><td class="num" id="LN866">866</td><td class="line">	sprintf(buff, form, num2uintfrm(L, arg));</td></tr>
<tr class="codeline" data-linenumber="867"><td class="num" id="LN867">867</td><td class="line">	<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="868"><td class="num" id="LN868">868</td><td class="line">      <span class='keyword'>case</span> 'e':  <span class='keyword'>case</span> 'E': <span class='keyword'>case</span> 'f': <span class='keyword'>case</span> 'g': <span class='keyword'>case</span> 'G': <span class='keyword'>case</span> 'a': <span class='keyword'>case</span> 'A': {</td></tr>
<tr class="codeline" data-linenumber="869"><td class="num" id="LN869">869</td><td class="line">	TValue tv;</td></tr>
<tr class="codeline" data-linenumber="870"><td class="num" id="LN870">870</td><td class="line">	tv.n = lj_lib_checknum(L, arg);</td></tr>
<tr class="codeline" data-linenumber="871"><td class="num" id="LN871">871</td><td class="line">	<span class='keyword'>if</span> (<span class='macro'>LJ_UNLIKELY((tv.u32.hi &lt;&lt; 1) &gt;= 0xffe00000)<span class='macro_popup'>__builtin_expect(!!((tv.u32.hi &lt;&lt; 1) &gt;= 0xffe00000),<br> 0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="872"><td class="num" id="LN872">872</td><td class="line">	  <span class='comment'>/* Canonicalize output of non-finite values. */</span></td></tr>
<tr class="codeline" data-linenumber="873"><td class="num" id="LN873">873</td><td class="line">	  <span class='keyword'>char</span> *p, nbuf[<span class='macro'>LJ_STR_NUMBUF<span class='macro_popup'>32</span></span>];</td></tr>
<tr class="codeline" data-linenumber="874"><td class="num" id="LN874">874</td><td class="line">	  size_t len = lj_str_bufnum(nbuf, &amp;tv);</td></tr>
<tr class="codeline" data-linenumber="875"><td class="num" id="LN875">875</td><td class="line">	  <span class='keyword'>if</span> (strfrmt[-1] &lt; 'a') {</td></tr>
<tr class="codeline" data-linenumber="876"><td class="num" id="LN876">876</td><td class="line">	    nbuf[len-3] = nbuf[len-3] - 0x20;</td></tr>
<tr class="codeline" data-linenumber="877"><td class="num" id="LN877">877</td><td class="line">	    nbuf[len-2] = nbuf[len-2] - 0x20;</td></tr>
<tr class="codeline" data-linenumber="878"><td class="num" id="LN878">878</td><td class="line">	    nbuf[len-1] = nbuf[len-1] - 0x20;</td></tr>
<tr class="codeline" data-linenumber="879"><td class="num" id="LN879">879</td><td class="line">	  }</td></tr>
<tr class="codeline" data-linenumber="880"><td class="num" id="LN880">880</td><td class="line">	  nbuf[len] = '\0';</td></tr>
<tr class="codeline" data-linenumber="881"><td class="num" id="LN881">881</td><td class="line">	  <span class='keyword'>for</span> (p = form; *p &lt; 'A' &amp;&amp; *p != '.'; p++) ;</td></tr>
<tr class="codeline" data-linenumber="882"><td class="num" id="LN882">882</td><td class="line">	  *p++ = 's'; *p = '\0';</td></tr>
<tr class="codeline" data-linenumber="883"><td class="num" id="LN883">883</td><td class="line">	  <span class="mrange">sprintf</span>(buff, form, nbuf);</td></tr>
<tr><td class="num"></td><td class="line"><div id="EndPath" class="msg msgEvent" style="margin-left:11ex; max-width:45em">Call to function 'sprintf' is insecure as it does not provide bounding of the memory buffer or security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'sprintf_s' in case of C11</div></td></tr>
<tr class="codeline" data-linenumber="884"><td class="num" id="LN884">884</td><td class="line">	  <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="885"><td class="num" id="LN885">885</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="886"><td class="num" id="LN886">886</td><td class="line">	sprintf(buff, form, (<span class='keyword'>double</span>)tv.n);</td></tr>
<tr class="codeline" data-linenumber="887"><td class="num" id="LN887">887</td><td class="line">	<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="888"><td class="num" id="LN888">888</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="889"><td class="num" id="LN889">889</td><td class="line">      <span class='keyword'>case</span> 'q':</td></tr>
<tr class="codeline" data-linenumber="890"><td class="num" id="LN890">890</td><td class="line">	addquoted(L, &amp;b, arg);</td></tr>
<tr class="codeline" data-linenumber="891"><td class="num" id="LN891">891</td><td class="line">	<span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="892"><td class="num" id="LN892">892</td><td class="line">      <span class='keyword'>case</span> 'p':</td></tr>
<tr class="codeline" data-linenumber="893"><td class="num" id="LN893">893</td><td class="line">	lj_str_pushf(L, <span class='string_literal'>"%p"</span>, lua_topointer(L, arg));</td></tr>
<tr class="codeline" data-linenumber="894"><td class="num" id="LN894">894</td><td class="line">	luaL_addvalue(&amp;b);</td></tr>
<tr class="codeline" data-linenumber="895"><td class="num" id="LN895">895</td><td class="line">	<span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="896"><td class="num" id="LN896">896</td><td class="line">      <span class='keyword'>case</span> 's': {</td></tr>
<tr class="codeline" data-linenumber="897"><td class="num" id="LN897">897</td><td class="line">	GCstr *str = meta_tostring(L, arg);</td></tr>
<tr class="codeline" data-linenumber="898"><td class="num" id="LN898">898</td><td class="line">	<span class='keyword'>if</span> (!strchr(form, '.') &amp;&amp; str-&gt;len &gt;= 100) {</td></tr>
<tr class="codeline" data-linenumber="899"><td class="num" id="LN899">899</td><td class="line">	  <span class='comment'>/* no precision and string is too long to be formatted;</span></td></tr>
<tr class="codeline" data-linenumber="900"><td class="num" id="LN900">900</td><td class="line">	     <span class='comment'>keep original string */</span></td></tr>
<tr class="codeline" data-linenumber="901"><td class="num" id="LN901">901</td><td class="line">	  setstrV(L, L-&gt;top++, str);</td></tr>
<tr class="codeline" data-linenumber="902"><td class="num" id="LN902">902</td><td class="line">	  luaL_addvalue(&amp;b);</td></tr>
<tr class="codeline" data-linenumber="903"><td class="num" id="LN903">903</td><td class="line">	  <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="904"><td class="num" id="LN904">904</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="905"><td class="num" id="LN905">905</td><td class="line">	sprintf(buff, form, <span class='macro'>strdata(str)<span class='macro_popup'>((const char *)((str)+1))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="906"><td class="num" id="LN906">906</td><td class="line">	<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="907"><td class="num" id="LN907">907</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="908"><td class="num" id="LN908">908</td><td class="line">      <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="909"><td class="num" id="LN909">909</td><td class="line">	lj_err_callerv(L, LJ_ERR_STRFMTO, *(strfrmt -1));</td></tr>
<tr class="codeline" data-linenumber="910"><td class="num" id="LN910">910</td><td class="line">	<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="911"><td class="num" id="LN911">911</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="912"><td class="num" id="LN912">912</td><td class="line">      luaL_addlstring(&amp;b, buff, strlen(buff));</td></tr>
<tr class="codeline" data-linenumber="913"><td class="num" id="LN913">913</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="914"><td class="num" id="LN914">914</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="915"><td class="num" id="LN915">915</td><td class="line">  luaL_pushresult(&amp;b);</td></tr>
<tr class="codeline" data-linenumber="916"><td class="num" id="LN916">916</td><td class="line">  <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="917"><td class="num" id="LN917">917</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="918"><td class="num" id="LN918">918</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="919"><td class="num" id="LN919">919</td><td class="line"><span class='comment'>/* ------------------------------------------------------------------------ */</span></td></tr>
<tr class="codeline" data-linenumber="920"><td class="num" id="LN920">920</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="921"><td class="num" id="LN921">921</td><td class="line"><span class='directive'>#include "lj_libdef.h"</span></td></tr>
<tr class="codeline" data-linenumber="922"><td class="num" id="LN922">922</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="923"><td class="num" id="LN923">923</td><td class="line"><span class='macro'>LUALIB_API<span class='macro_popup'>extern</span></span> <span class='keyword'>int</span> luaopen_string(lua_State *L)</td></tr>
<tr class="codeline" data-linenumber="924"><td class="num" id="LN924">924</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="925"><td class="num" id="LN925">925</td><td class="line">  GCtab *mt;</td></tr>
<tr class="codeline" data-linenumber="926"><td class="num" id="LN926">926</td><td class="line">  global_State *g;</td></tr>
<tr class="codeline" data-linenumber="927"><td class="num" id="LN927">927</td><td class="line">  <span class='macro'>LJ_LIB_REG(L, LUA_STRLIBNAME, string)<span class='macro_popup'>lj_lib_register(L, "string", lj_lib_init_string, lj_lib_cf_string<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="928"><td class="num" id="LN928">928</td><td class="line"><span class='directive'>#if defined(LUA_COMPAT_GFIND) &amp;&amp; !<span class='macro'>LJ_52<span class='macro_popup'>0</span></span></span></td></tr>
<tr class="codeline" data-linenumber="929"><td class="num" id="LN929">929</td><td class="line">  lua_getfield(L, -1, <span class='string_literal'>"gmatch"</span>);</td></tr>
<tr class="codeline" data-linenumber="930"><td class="num" id="LN930">930</td><td class="line">  lua_setfield(L, -2, <span class='string_literal'>"gfind"</span>);</td></tr>
<tr class="codeline" data-linenumber="931"><td class="num" id="LN931">931</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="932"><td class="num" id="LN932">932</td><td class="line">  mt = lj_tab_new(L, 0, 1);</td></tr>
<tr class="codeline" data-linenumber="933"><td class="num" id="LN933">933</td><td class="line">  <span class='comment'>/* NOBARRIER: basemt is a GC root. */</span></td></tr>
<tr class="codeline" data-linenumber="934"><td class="num" id="LN934">934</td><td class="line">  g = <span class='macro'>G(L)<span class='macro_popup'>(((global_State *)(void *)(uintptr_t)(L-&gt;glref).ptr32))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="935"><td class="num" id="LN935">935</td><td class="line">  <span class='macro'>setgcref(basemt_it(g, LJ_TSTR), obj2gco(mt))<span class='macro_popup'>((((g)-&gt;gcroot[GCROOT_BASEMT+~((~4u))])).gcptr32 = (uint32_t<br>)(uintptr_t)&amp;(((GCobj *)(mt)))-&gt;gch)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="936"><td class="num" id="LN936">936</td><td class="line">  settabV(L, lj_tab_setstr(L, mt, <span class='macro'>mmname_str(g, MM_index)<span class='macro_popup'>((&amp;((GCobj *)(uintptr_t)(((g)-&gt;gcroot[GCROOT_MMNAME+(MM_index<br>)])).gcptr32)-&gt;str))</span></span>), <span class='macro'>tabV(L-&gt;top-1)<span class='macro_popup'>(((void)0), (&amp;(((GCobj *)(uintptr_t)((L-&gt;top-1)-&gt;gcr<br>).gcptr32))-&gt;tab))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="937"><td class="num" id="LN937">937</td><td class="line">  mt-&gt;nomm = (uint8_t)(~(1u&lt;&lt;MM_index));</td></tr>
<tr class="codeline" data-linenumber="938"><td class="num" id="LN938">938</td><td class="line">  <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="939"><td class="num" id="LN939">939</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="940"><td class="num" id="LN940">940</td><td class="line"> </td></tr>
</table></body></html>
