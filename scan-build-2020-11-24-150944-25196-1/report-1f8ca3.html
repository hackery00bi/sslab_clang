<!doctype html>
<html>
<head>
<title>fileio.c</title>

<style type="text/css">
body { color:#000000; background-color:#ffffff }
body { font-family:Helvetica, sans-serif; font-size:10pt }
h1 { font-size:14pt }
.FileName { margin-top: 5px; margin-bottom: 5px; display: inline; }
.FileNav { margin-left: 5px; margin-right: 5px; display: inline; }
.FileNav a { text-decoration:none; font-size: larger; }
.divider { margin-top: 30px; margin-bottom: 30px; height: 15px; }
.divider { background-color: gray; }
.code { border-collapse:collapse; width:100%; }
.code { font-family: "Monospace", monospace; font-size:10pt }
.code { line-height: 1.2em }
.comment { color: green; font-style: oblique }
.keyword { color: blue }
.string_literal { color: red }
.directive { color: darkmagenta }

/* Macros and variables could have pop-up notes hidden by default.
  - Macro pop-up:    expansion of the macro
  - Variable pop-up: value (table) of the variable */
.macro_popup, .variable_popup { display: none; }

/* Pop-up appears on mouse-hover event. */
.macro:hover .macro_popup, .variable:hover .variable_popup {
  display: block;
  padding: 2px;
  -webkit-border-radius:5px;
  -webkit-box-shadow:1px 1px 7px #000;
  border-radius:5px;
  box-shadow:1px 1px 7px #000;
  position: absolute;
  top: -1em;
  left:10em;
  z-index: 1
}

.macro_popup {
  border: 2px solid red;
  background-color:#FFF0F0;
  font-weight: normal;
}

.variable_popup {
  border: 2px solid blue;
  background-color:#F0F0FF;
  font-weight: bold;
  font-family: Helvetica, sans-serif;
  font-size: 9pt;
}

/* Pop-up notes needs a relative position as a base where they pops up. */
.macro, .variable {
  background-color: PaleGoldenRod;
  position: relative;
}
.macro { color: DarkMagenta; }

#tooltiphint {
  position: fixed;
  width: 50em;
  margin-left: -25em;
  left: 50%;
  padding: 10px;
  border: 1px solid #b0b0b0;
  border-radius: 2px;
  box-shadow: 1px 1px 7px black;
  background-color: #c0c0c0;
  z-index: 2;
}

.num { width:2.5em; padding-right:2ex; background-color:#eeeeee }
.num { text-align:right; font-size:8pt }
.num { color:#444444 }
.line { padding-left: 1ex; border-left: 3px solid #ccc }
.line { white-space: pre }
.msg { -webkit-box-shadow:1px 1px 7px #000 }
.msg { box-shadow:1px 1px 7px #000 }
.msg { -webkit-border-radius:5px }
.msg { border-radius:5px }
.msg { font-family:Helvetica, sans-serif; font-size:8pt }
.msg { float:left }
.msg { padding:0.25em 1ex 0.25em 1ex }
.msg { margin-top:10px; margin-bottom:10px }
.msg { font-weight:bold }
.msg { max-width:60em; word-wrap: break-word; white-space: pre-wrap }
.msgT { padding:0x; spacing:0x }
.msgEvent { background-color:#fff8b4; color:#000000 }
.msgControl { background-color:#bbbbbb; color:#000000 }
.msgNote { background-color:#ddeeff; color:#000000 }
.mrange { background-color:#dfddf3 }
.mrange { border-bottom:1px solid #6F9DBE }
.PathIndex { font-weight: bold; padding:0px 5px; margin-right:5px; }
.PathIndex { -webkit-border-radius:8px }
.PathIndex { border-radius:8px }
.PathIndexEvent { background-color:#bfba87 }
.PathIndexControl { background-color:#8c8c8c }
.PathIndexPopUp { background-color: #879abc; }
.PathNav a { text-decoration:none; font-size: larger }
.CodeInsertionHint { font-weight: bold; background-color: #10dd10 }
.CodeRemovalHint { background-color:#de1010 }
.CodeRemovalHint { border-bottom:1px solid #6F9DBE }
.selected{ background-color:orange !important; }

table.simpletable {
  padding: 5px;
  font-size:12pt;
  margin:20px;
  border-collapse: collapse; border-spacing: 0px;
}
td.rowname {
  text-align: right;
  vertical-align: top;
  font-weight: bold;
  color:#444444;
  padding-right:2ex;
}

/* Hidden text. */
input.spoilerhider + label {
  cursor: pointer;
  text-decoration: underline;
  display: block;
}
input.spoilerhider {
 display: none;
}
input.spoilerhider ~ .spoiler {
  overflow: hidden;
  margin: 10px auto 0;
  height: 0;
  opacity: 0;
}
input.spoilerhider:checked + label + .spoiler{
  height: auto;
  opacity: 1;
}
</style>
</head>
<body>
<!-- BUGDESC Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11 -->

<!-- BUGTYPE Potential insecure memory buffer bounds restriction in call 'memcpy' -->

<!-- BUGCATEGORY Security -->

<!-- BUGFILE /tmp/sslab_clang/c_zstd/zstd/programs/fileio.c -->

<!-- FILENAME fileio.c -->

<!-- FUNCTIONNAME FIO_determineDstName -->

<!-- ISSUEHASHCONTENTOFLINEINCONTEXT d5453bba59a4ea0afae9f9b46d9f7fec -->

<!-- BUGLINE 2520 -->

<!-- BUGCOLUMN 9 -->

<!-- BUGPATHLENGTH 1 -->

<!-- BUGMETAEND -->
<!-- REPORTHEADER -->
<h3>Bug Summary</h3>
<table class="simpletable">
<tr><td class="rowname">File:</td><td>programs/fileio.c</td></tr>
<tr><td class="rowname">Warning:</td><td><a href="#EndPath">line 2520, column 9</a><br />Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11</td></tr>

</table>
<!-- REPORTSUMMARYEXTRA -->
<h3>Annotated Source Code</h3>
<p>Press <a href="#" onclick="toggleHelp(); return false;">'?'</a>
   to see keyboard shortcuts</p>
<input type="checkbox" class="spoilerhider" id="showinvocation" />
<label for="showinvocation" >Show analyzer invocation</label>
<div class="spoiler">clang -cc1 -cc1 -triple x86_64-unknown-linux-gnu -analyze -disable-free -main-file-name fileio.c -analyzer-store=region -analyzer-opt-analyze-nested-blocks -analyzer-checker=core -analyzer-checker=apiModeling -analyzer-checker=unix -analyzer-checker=deadcode -analyzer-checker=security.insecureAPI.UncheckedReturn -analyzer-checker=security.insecureAPI.getpw -analyzer-checker=security.insecureAPI.gets -analyzer-checker=security.insecureAPI.mktemp -analyzer-checker=security.insecureAPI.mkstemp -analyzer-checker=security.insecureAPI.vfork -analyzer-checker=nullability.NullPassedToNonnull -analyzer-checker=nullability.NullReturnedFromNonnull -analyzer-output plist -w -setup-static-analyzer -mrelocation-model static -mframe-pointer=none -fmath-errno -fno-rounding-math -mconstructor-aliases -munwind-tables -target-cpu x86-64 -fno-split-dwarf-inlining -debugger-tuning=gdb -resource-dir /llvm-project/build/lib/clang/12.0.0 -D BACKTRACE_ENABLE=0 -D XXH_NAMESPACE=ZSTD_ -D ZSTD_MULTITHREAD -D ZSTD_GZCOMPRESS -D ZSTD_GZDECOMPRESS -D ZSTD_LZMACOMPRESS -D ZSTD_LZMADECOMPRESS -D ZSTD_LZ4COMPRESS -D ZSTD_LZ4DECOMPRESS -D ZSTD_LEGACY_SUPPORT=5 -internal-isystem /usr/local/include -internal-isystem /llvm-project/build/lib/clang/12.0.0/include -internal-externc-isystem /usr/include/x86_64-linux-gnu -internal-externc-isystem /include -internal-externc-isystem /usr/include -O3 -fdebug-compilation-dir /tmp/sslab_clang/c_zstd/zstd/programs -ferror-limit 19 -fgnuc-version=4.2.1 -vectorize-loops -vectorize-slp -analyzer-checker core -analyzer-checker cplusplus -analyzer-checker nullability -analyzer-checker optin -analyzer-checker security -analyzer-checker unix -analyzer-checker osx -analyzer-checker fuchsia -analyzer-checker webkit -analyzer-output=html -faddrsig -o /tmp/scan-build-2020-11-24-150944-25196-1 -x c fileio.c
</div>
<div id='tooltiphint' hidden="true">
  <p>Keyboard shortcuts: </p>
  <ul>
    <li>Use 'j/k' keys for keyboard navigation</li>
    <li>Use 'Shift+S' to show/hide relevant lines</li>
    <li>Use '?' to toggle this window</li>
  </ul>
  <a href="#" onclick="toggleHelp(); return false;">Close</a>
</div>
<script type='text/javascript'>
var relevant_lines = {"1": {"2520": 1}};

var filterCounterexample = function (hide) {
  var tables = document.getElementsByClassName("code");
  for (var t=0; t<tables.length; t++) {
    var table = tables[t];
    var file_id = table.getAttribute("data-fileid");
    var lines_in_fid = relevant_lines[file_id];
    if (!lines_in_fid) {
      lines_in_fid = {};
    }
    var lines = table.getElementsByClassName("codeline");
    for (var i=0; i<lines.length; i++) {
        var el = lines[i];
        var lineNo = el.getAttribute("data-linenumber");
        if (!lines_in_fid[lineNo]) {
          if (hide) {
            el.setAttribute("hidden", "");
          } else {
            el.removeAttribute("hidden");
          }
        }
    }
  }
}

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "S") {
    var checked = document.getElementsByName("showCounterexample")[0].checked;
    filterCounterexample(!checked);
    document.getElementsByName("showCounterexample")[0].checked = !checked;
  } else {
    return;
  }
  event.preventDefault();
}, true);

document.addEventListener("DOMContentLoaded", function() {
    document.querySelector('input[name="showCounterexample"]').onchange=
        function (event) {
      filterCounterexample(this.checked);
    };
});
</script>

<form>
    <input type="checkbox" name="showCounterexample" id="showCounterexample" />
    <label for="showCounterexample">
       Show only relevant lines
    </label>
</form>

<script type='text/javascript'>
var digitMatcher = new RegExp("[0-9]+");

var querySelectorAllArray = function(selector) {
  return Array.prototype.slice.call(
    document.querySelectorAll(selector));
}

document.addEventListener("DOMContentLoaded", function() {
    querySelectorAllArray(".PathNav > a").forEach(
        function(currentValue, currentIndex) {
            var hrefValue = currentValue.getAttribute("href");
            currentValue.onclick = function() {
                scrollTo(document.querySelector(hrefValue));
                return false;
            };
        });
});

var findNum = function() {
    var s = document.querySelector(".selected");
    if (!s || s.id == "EndPath") {
        return 0;
    }
    var out = parseInt(digitMatcher.exec(s.id)[0]);
    return out;
};

var scrollTo = function(el) {
    querySelectorAllArray(".selected").forEach(function(s) {
        s.classList.remove("selected");
    });
    el.classList.add("selected");
    window.scrollBy(0, el.getBoundingClientRect().top -
        (window.innerHeight / 2));
}

var move = function(num, up, numItems) {
  if (num == 1 && up || num == numItems - 1 && !up) {
    return 0;
  } else if (num == 0 && up) {
    return numItems - 1;
  } else if (num == 0 && !up) {
    return 1 % numItems;
  }
  return up ? num - 1 : num + 1;
}

var numToId = function(num) {
  if (num == 0) {
    return document.getElementById("EndPath")
  }
  return document.getElementById("Path" + num);
};

var navigateTo = function(up) {
  var numItems = document.querySelectorAll(
      ".line > .msgEvent, .line > .msgControl").length;
  var currentSelected = findNum();
  var newSelected = move(currentSelected, up, numItems);
  var newEl = numToId(newSelected, numItems);

  // Scroll element into center.
  scrollTo(newEl);
};

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "j") {
    navigateTo(/*up=*/false);
  } else if (event.key == "k") {
    navigateTo(/*up=*/true);
  } else {
    return;
  }
  event.preventDefault();
}, true);
</script>
  
<script type='text/javascript'>

var toggleHelp = function() {
    var hint = document.querySelector("#tooltiphint");
    var attributeName = "hidden";
    if (hint.hasAttribute(attributeName)) {
      hint.removeAttribute(attributeName);
    } else {
      hint.setAttribute("hidden", "true");
    }
};
window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "?") {
    toggleHelp();
  } else {
    return;
  }
  event.preventDefault();
});
</script>
<table class="code" data-fileid="1">
<tr class="codeline" data-linenumber="1"><td class="num" id="LN1">1</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2"><td class="num" id="LN2">2</td><td class="line"> <span class='comment'>* Copyright (c) 2016-2020, Yann Collet, Facebook, Inc.</span></td></tr>
<tr class="codeline" data-linenumber="3"><td class="num" id="LN3">3</td><td class="line"> <span class='comment'>* All rights reserved.</span></td></tr>
<tr class="codeline" data-linenumber="4"><td class="num" id="LN4">4</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="5"><td class="num" id="LN5">5</td><td class="line"> <span class='comment'>* This source code is licensed under both the BSD-style license (found in the</span></td></tr>
<tr class="codeline" data-linenumber="6"><td class="num" id="LN6">6</td><td class="line"> <span class='comment'>* LICENSE file in the root directory of this source tree) and the GPLv2 (found</span></td></tr>
<tr class="codeline" data-linenumber="7"><td class="num" id="LN7">7</td><td class="line"> <span class='comment'>* in the COPYING file in the root directory of this source tree).</span></td></tr>
<tr class="codeline" data-linenumber="8"><td class="num" id="LN8">8</td><td class="line"> <span class='comment'>* You may select, at your option, one of the above-listed licenses.</span></td></tr>
<tr class="codeline" data-linenumber="9"><td class="num" id="LN9">9</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="10"><td class="num" id="LN10">10</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="11"><td class="num" id="LN11">11</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="12"><td class="num" id="LN12">12</td><td class="line"><span class='comment'>/* *************************************</span></td></tr>
<tr class="codeline" data-linenumber="13"><td class="num" id="LN13">13</td><td class="line"><span class='comment'>*  Compiler Options</span></td></tr>
<tr class="codeline" data-linenumber="14"><td class="num" id="LN14">14</td><td class="line"><span class='comment'>***************************************/</span></td></tr>
<tr class="codeline" data-linenumber="15"><td class="num" id="LN15">15</td><td class="line"><span class='directive'>#ifdef _MSC_VER   /* Visual */</span></td></tr>
<tr class="codeline" data-linenumber="16"><td class="num" id="LN16">16</td><td class="line"><span class='directive'>#  pragma warning(disable : 4127)  /* disable: C4127: conditional expression is constant */</span></td></tr>
<tr class="codeline" data-linenumber="17"><td class="num" id="LN17">17</td><td class="line"><span class='directive'>#  pragma warning(disable : 4204)  /* non-constant aggregate initializer */</span></td></tr>
<tr class="codeline" data-linenumber="18"><td class="num" id="LN18">18</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="19"><td class="num" id="LN19">19</td><td class="line"><span class='directive'>#if defined(__MINGW32__) &amp;&amp; !defined(_POSIX_SOURCE)</span></td></tr>
<tr class="codeline" data-linenumber="20"><td class="num" id="LN20">20</td><td class="line"><span class='directive'>#  define _POSIX_SOURCE 1          /* disable %llu warnings with MinGW on Windows */</span></td></tr>
<tr class="codeline" data-linenumber="21"><td class="num" id="LN21">21</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="22"><td class="num" id="LN22">22</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="23"><td class="num" id="LN23">23</td><td class="line"><span class='comment'>/*-*************************************</span></td></tr>
<tr class="codeline" data-linenumber="24"><td class="num" id="LN24">24</td><td class="line"><span class='comment'>*  Includes</span></td></tr>
<tr class="codeline" data-linenumber="25"><td class="num" id="LN25">25</td><td class="line"><span class='comment'>***************************************/</span></td></tr>
<tr class="codeline" data-linenumber="26"><td class="num" id="LN26">26</td><td class="line"><span class='directive'>#include "platform.h"   /* Large Files support, SET_BINARY_MODE */</span></td></tr>
<tr class="codeline" data-linenumber="27"><td class="num" id="LN27">27</td><td class="line"><span class='directive'>#include "util.h"       /* UTIL_getFileSize, UTIL_isRegularFile, UTIL_isSameFile */</span></td></tr>
<tr class="codeline" data-linenumber="28"><td class="num" id="LN28">28</td><td class="line"><span class='directive'>#include &lt;stdio.h&gt;      /* fprintf, fopen, fread, _fileno, stdin, stdout */</span></td></tr>
<tr class="codeline" data-linenumber="29"><td class="num" id="LN29">29</td><td class="line"><span class='directive'>#include &lt;stdlib.h&gt;     /* malloc, free */</span></td></tr>
<tr class="codeline" data-linenumber="30"><td class="num" id="LN30">30</td><td class="line"><span class='directive'>#include &lt;string.h&gt;     /* strcmp, strlen */</span></td></tr>
<tr class="codeline" data-linenumber="31"><td class="num" id="LN31">31</td><td class="line"><span class='directive'>#include &lt;assert.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="32"><td class="num" id="LN32">32</td><td class="line"><span class='directive'>#include &lt;<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>.h&gt;      /* errno */</span></td></tr>
<tr class="codeline" data-linenumber="33"><td class="num" id="LN33">33</td><td class="line"><span class='directive'>#include &lt;limits.h&gt;     /* INT_MAX */</span></td></tr>
<tr class="codeline" data-linenumber="34"><td class="num" id="LN34">34</td><td class="line"><span class='directive'>#include &lt;signal.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="35"><td class="num" id="LN35">35</td><td class="line"><span class='directive'>#include "timefn.h"     /* UTIL_getTime, UTIL_clockSpanMicro */</span></td></tr>
<tr class="codeline" data-linenumber="36"><td class="num" id="LN36">36</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="37"><td class="num" id="LN37">37</td><td class="line"><span class='directive'>#if defined (_MSC_VER)</span></td></tr>
<tr class="codeline" data-linenumber="38"><td class="num" id="LN38">38</td><td class="line"><span class='directive'>#  include &lt;sys/stat.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="39"><td class="num" id="LN39">39</td><td class="line"><span class='directive'>#  include &lt;io.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="40"><td class="num" id="LN40">40</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="41"><td class="num" id="LN41">41</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="42"><td class="num" id="LN42">42</td><td class="line"><span class='directive'>#include "../lib/common/mem.h"     /* U32, U64 */</span></td></tr>
<tr class="codeline" data-linenumber="43"><td class="num" id="LN43">43</td><td class="line"><span class='directive'>#include "fileio.h"</span></td></tr>
<tr class="codeline" data-linenumber="44"><td class="num" id="LN44">44</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="45"><td class="num" id="LN45">45</td><td class="line"><span class='directive'>#define ZSTD_STATIC_LINKING_ONLY   /* ZSTD_magicNumber, ZSTD_frameHeaderSize_max */</span></td></tr>
<tr class="codeline" data-linenumber="46"><td class="num" id="LN46">46</td><td class="line"><span class='directive'>#include "../lib/zstd.h"</span></td></tr>
<tr class="codeline" data-linenumber="47"><td class="num" id="LN47">47</td><td class="line"><span class='directive'>#include "../lib/common/zstd_errors.h"  /* ZSTD_error_frameParameter_windowTooLarge */</span></td></tr>
<tr class="codeline" data-linenumber="48"><td class="num" id="LN48">48</td><td class="line"><span class='directive'>#include "../lib/compress/zstd_compress_internal.h"</span></td></tr>
<tr class="codeline" data-linenumber="49"><td class="num" id="LN49">49</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="50"><td class="num" id="LN50">50</td><td class="line"><span class='directive'>#if defined(<span class='macro'>ZSTD_GZCOMPRESS<span class='macro_popup'>1</span></span>) || defined(<span class='macro'>ZSTD_GZDECOMPRESS<span class='macro_popup'>1</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="51"><td class="num" id="LN51">51</td><td class="line"><span class='directive'>#  include &lt;zlib.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="52"><td class="num" id="LN52">52</td><td class="line"><span class='directive'>#  if !defined(z_const)</span></td></tr>
<tr class="codeline" data-linenumber="53"><td class="num" id="LN53">53</td><td class="line"><span class='directive'>#    define z_const</span></td></tr>
<tr class="codeline" data-linenumber="54"><td class="num" id="LN54">54</td><td class="line"><span class='directive'>#  endif</span></td></tr>
<tr class="codeline" data-linenumber="55"><td class="num" id="LN55">55</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="56"><td class="num" id="LN56">56</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="57"><td class="num" id="LN57">57</td><td class="line"><span class='directive'>#if defined(<span class='macro'>ZSTD_LZMACOMPRESS<span class='macro_popup'>1</span></span>) || defined(<span class='macro'>ZSTD_LZMADECOMPRESS<span class='macro_popup'>1</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="58"><td class="num" id="LN58">58</td><td class="line"><span class='directive'>#  include &lt;lzma.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="59"><td class="num" id="LN59">59</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="60"><td class="num" id="LN60">60</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="61"><td class="num" id="LN61">61</td><td class="line"><span class='directive'>#define <span class='macro'>LZ4_MAGICNUMBER<span class='macro_popup'>0x184D2204</span></span> 0x184D2204</span></td></tr>
<tr class="codeline" data-linenumber="62"><td class="num" id="LN62">62</td><td class="line"><span class='directive'>#if defined(<span class='macro'>ZSTD_LZ4COMPRESS<span class='macro_popup'>1</span></span>) || defined(<span class='macro'>ZSTD_LZ4DECOMPRESS<span class='macro_popup'>1</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="63"><td class="num" id="LN63">63</td><td class="line"><span class='directive'>#  define LZ4F_ENABLE_OBSOLETE_ENUMS</span></td></tr>
<tr class="codeline" data-linenumber="64"><td class="num" id="LN64">64</td><td class="line"><span class='directive'>#  include &lt;lz4frame.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="65"><td class="num" id="LN65">65</td><td class="line"><span class='directive'>#  include &lt;lz4.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="66"><td class="num" id="LN66">66</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="67"><td class="num" id="LN67">67</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="68"><td class="num" id="LN68">68</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="69"><td class="num" id="LN69">69</td><td class="line"><span class='comment'>/*-*************************************</span></td></tr>
<tr class="codeline" data-linenumber="70"><td class="num" id="LN70">70</td><td class="line"><span class='comment'>*  Constants</span></td></tr>
<tr class="codeline" data-linenumber="71"><td class="num" id="LN71">71</td><td class="line"><span class='comment'>***************************************/</span></td></tr>
<tr class="codeline" data-linenumber="72"><td class="num" id="LN72">72</td><td class="line"><span class='directive'>#define <span class='macro'>ADAPT_WINDOWLOG_DEFAULT<span class='macro_popup'>23</span></span> 23   /* 8 MB */</span></td></tr>
<tr class="codeline" data-linenumber="73"><td class="num" id="LN73">73</td><td class="line"><span class='directive'>#define <span class='macro'>DICTSIZE_MAX<span class='macro_popup'>(32 *(1 &lt;&lt;20))</span></span> (32 <span class='macro'>MB<span class='macro_popup'>*(1 &lt;&lt;20)</span></span>)   /* protection against large input (attack scenario) */</span></td></tr>
<tr class="codeline" data-linenumber="74"><td class="num" id="LN74">74</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="75"><td class="num" id="LN75">75</td><td class="line"><span class='directive'>#define <span class='macro'>FNSPACE<span class='macro_popup'>30</span></span> 30</span></td></tr>
<tr class="codeline" data-linenumber="76"><td class="num" id="LN76">76</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="77"><td class="num" id="LN77">77</td><td class="line"><span class='comment'>/*-*************************************</span></td></tr>
<tr class="codeline" data-linenumber="78"><td class="num" id="LN78">78</td><td class="line"><span class='comment'>*  Macros</span></td></tr>
<tr class="codeline" data-linenumber="79"><td class="num" id="LN79">79</td><td class="line"><span class='comment'>***************************************/</span></td></tr>
<tr class="codeline" data-linenumber="80"><td class="num" id="LN80">80</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="81"><td class="num" id="LN81">81</td><td class="line"><span class='keyword'>struct</span> FIO_display_prefs_s {</td></tr>
<tr class="codeline" data-linenumber="82"><td class="num" id="LN82">82</td><td class="line">    <span class='keyword'>int</span> displayLevel;   <span class='comment'>/* 0 : no display;  1: errors;  2: + result + interaction + warnings;  3: + progression;  4: + information */</span></td></tr>
<tr class="codeline" data-linenumber="83"><td class="num" id="LN83">83</td><td class="line">    U32 noProgress;</td></tr>
<tr class="codeline" data-linenumber="84"><td class="num" id="LN84">84</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="85"><td class="num" id="LN85">85</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="86"><td class="num" id="LN86">86</td><td class="line"><span class='keyword'>static</span> FIO_display_prefs_t g_display_prefs = {2, 0};</td></tr>
<tr class="codeline" data-linenumber="87"><td class="num" id="LN87">87</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="88"><td class="num" id="LN88">88</td><td class="line"><span class='directive'>#define <span class='macro'>DISPLAY(...)<span class='macro_popup'>fprintf(stderr, ...)</span></span>         fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, __VA_ARGS__)</span></td></tr>
<tr class="codeline" data-linenumber="89"><td class="num" id="LN89">89</td><td class="line"><span class='directive'>#define <span class='macro'>DISPLAYOUT(...)<span class='macro_popup'>fprintf(stdout, ...)</span></span>      fprintf(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>, __VA_ARGS__)</span></td></tr>
<tr class="codeline" data-linenumber="90"><td class="num" id="LN90">90</td><td class="line"><span class='directive'>#define <span class='macro'>DISPLAYLEVEL(l, ...)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=l) { fprintf(stderr, ...<br>); } }</span></span> { if (g_display_prefs.displayLevel&gt;=l) { <span class='macro'>DISPLAY(__VA_ARGS__)<span class='macro_popup'>fprintf(stderr, __VA_ARGS__)</span></span>; } }</span></td></tr>
<tr class="codeline" data-linenumber="91"><td class="num" id="LN91">91</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="92"><td class="num" id="LN92">92</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> U64 g_refreshRate = <span class='macro'>SEC_TO_MICRO<span class='macro_popup'>((PTime)1000000)</span></span> / 6;</td></tr>
<tr class="codeline" data-linenumber="93"><td class="num" id="LN93">93</td><td class="line"><span class='keyword'>static</span> UTIL_time_t g_displayClock = <span class='macro'>UTIL_TIME_INITIALIZER<span class='macro_popup'>{ 0, 0 }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="94"><td class="num" id="LN94">94</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="95"><td class="num" id="LN95">95</td><td class="line"><span class='directive'>#define <span class='macro'>READY_FOR_UPDATE()<span class='macro_popup'>(!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro(g_displayClock<br>) &gt; g_refreshRate)</span></span> (!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro(g_displayClock) &gt; g_refreshRate)</span></td></tr>
<tr class="codeline" data-linenumber="96"><td class="num" id="LN96">96</td><td class="line"><span class='directive'>#define <span class='macro'>DELAY_NEXT_UPDATE()<span class='macro_popup'>{ g_displayClock = UTIL_getTime(); }</span></span> { g_displayClock = UTIL_getTime(); }</span></td></tr>
<tr class="codeline" data-linenumber="97"><td class="num" id="LN97">97</td><td class="line"><span class='directive'>#define <span class='macro'>DISPLAYUPDATE(l, ...)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=l &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, ...); if (g_display_prefs.displayLevel&gt;=4) fflush(stderr<br>); } } }</span></span> {                              \</span></td></tr>
<tr class="codeline" data-linenumber="98"><td class="num" id="LN98">98</td><td class="line">        <span class='directive'>if (g_display_prefs.displayLevel&gt;=l &amp;&amp; !g_display_prefs.noProgress) { \</span></td></tr>
<tr class="codeline" data-linenumber="99"><td class="num" id="LN99">99</td><td class="line">            <span class='directive'>if (<span class='macro'>READY_FOR_UPDATE()<span class='macro_popup'>(!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro(g_displayClock<br>) &gt; g_refreshRate)</span></span> || (g_display_prefs.displayLevel&gt;=4)) { \</span></td></tr>
<tr class="codeline" data-linenumber="100"><td class="num" id="LN100">100</td><td class="line">                <span class='directive'><span class='macro'>DELAY_NEXT_UPDATE()<span class='macro_popup'>{ g_displayClock = UTIL_getTime(); }</span></span>;                         \</span></td></tr>
<tr class="codeline" data-linenumber="101"><td class="num" id="LN101">101</td><td class="line">                <span class='directive'><span class='macro'>DISPLAY(__VA_ARGS__)<span class='macro_popup'>fprintf(stderr, __VA_ARGS__)</span></span>;                        \</span></td></tr>
<tr class="codeline" data-linenumber="102"><td class="num" id="LN102">102</td><td class="line">                <span class='directive'>if (g_display_prefs.displayLevel&gt;=4) fflush(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>);       \</span></td></tr>
<tr class="codeline" data-linenumber="103"><td class="num" id="LN103">103</td><td class="line">    <span class='directive'>}   }   }</span></td></tr>
<tr class="codeline" data-linenumber="104"><td class="num" id="LN104">104</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="105"><td class="num" id="LN105">105</td><td class="line"><span class='directive'>#undef MIN  /* in case it would be already defined */</span></td></tr>
<tr class="codeline" data-linenumber="106"><td class="num" id="LN106">106</td><td class="line"><span class='directive'>#define <span class='macro'>MIN(a,b)<span class='macro_popup'>((a) &lt; (b) ? (a) : (b))</span></span>    ((a) &lt; (b) ? (a) : (b))</span></td></tr>
<tr class="codeline" data-linenumber="107"><td class="num" id="LN107">107</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="108"><td class="num" id="LN108">108</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="109"><td class="num" id="LN109">109</td><td class="line"><span class='directive'>#define <span class='macro'>EXM_THROW(error, ...)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 109<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", error); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, ...); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, " \n"); } }; exit(error); }</span></span>                                             \</span></td></tr>
<tr class="codeline" data-linenumber="110"><td class="num" id="LN110">110</td><td class="line"><span class='directive'>{                                                                         \</span></td></tr>
<tr class="codeline" data-linenumber="111"><td class="num" id="LN111">111</td><td class="line">    <span class='directive'><span class='macro'>DISPLAYLEVEL(1, "zstd: ")<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: "<br>); } }</span></span>;                                            \</span></td></tr>
<tr class="codeline" data-linenumber="112"><td class="num" id="LN112">112</td><td class="line">    <span class='directive'><span class='macro'>DISPLAYLEVEL(5, "Error defined at %s, line %i : \n", __FILE__, __LINE__)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=5) { fprintf(stderr, "Error defined at %s, line %i : \n"<br>, "fileio.c", 112); } }</span></span>; \</span></td></tr>
<tr class="codeline" data-linenumber="113"><td class="num" id="LN113">113</td><td class="line">    <span class='directive'><span class='macro'>DISPLAYLEVEL(1, "error %i : ", error)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "error %i : "<br>, error); } }</span></span>;                                \</span></td></tr>
<tr class="codeline" data-linenumber="114"><td class="num" id="LN114">114</td><td class="line">    <span class='directive'><span class='macro'>DISPLAYLEVEL(1, __VA_ARGS__)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, __VA_ARGS__<br>); } }</span></span>;                                         \</span></td></tr>
<tr class="codeline" data-linenumber="115"><td class="num" id="LN115">115</td><td class="line">    <span class='directive'><span class='macro'>DISPLAYLEVEL(1, " \n")<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }</span></span>;                                               \</span></td></tr>
<tr class="codeline" data-linenumber="116"><td class="num" id="LN116">116</td><td class="line">    <span class='directive'>exit(error);                                                          \</span></td></tr>
<tr class="codeline" data-linenumber="117"><td class="num" id="LN117">117</td><td class="line"><span class='directive'>}</span></td></tr>
<tr class="codeline" data-linenumber="118"><td class="num" id="LN118">118</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="119"><td class="num" id="LN119">119</td><td class="line"><span class='directive'>#define <span class='macro'>CHECK_V(v, f)<span class='macro_popup'>v = f; if (ERR_isError(v)) { { if (g_display_prefs.displayLevel<br>&gt;=5) { fprintf(stderr, "%s \n", "f"); } }; { { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, "zstd: "); } }; { if (<br>g_display_prefs.displayLevel&gt;=5) { fprintf(stderr, "Error defined at %s, line %i : \n"<br>, "fileio.c", 119); } }; { if (g_display_prefs.displayLevel&gt;=<br>1) { fprintf(stderr, "error %i : ", 11); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName<br>(v)); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, " \n"); } }; exit(11); }; }</span></span>                                \</span></td></tr>
<tr class="codeline" data-linenumber="120"><td class="num" id="LN120">120</td><td class="line">    <span class='directive'>v = f;                                           \</span></td></tr>
<tr class="codeline" data-linenumber="121"><td class="num" id="LN121">121</td><td class="line">    <span class='directive'>if (<span class='macro'>ZSTD_isError<span class='macro_popup'>ERR_isError</span></span>(v)) {                           \</span></td></tr>
<tr class="codeline" data-linenumber="122"><td class="num" id="LN122">122</td><td class="line">        <span class='directive'><span class='macro'>DISPLAYLEVEL(5, "%s \n", #f)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=5) { fprintf(stderr, "%s \n"<br>, #f); } }</span></span>;                \</span></td></tr>
<tr class="codeline" data-linenumber="123"><td class="num" id="LN123">123</td><td class="line">        <span class='directive'><span class='macro'>EXM_THROW(11, "%s", ZSTD_getErrorName(v))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 123<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(v)); } }; {<br> if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }</span></span>;   \</span></td></tr>
<tr class="codeline" data-linenumber="124"><td class="num" id="LN124">124</td><td class="line">    <span class='directive'>}</span></td></tr>
<tr class="codeline" data-linenumber="125"><td class="num" id="LN125">125</td><td class="line"><span class='directive'>#define <span class='macro'>CHECK(f)<span class='macro_popup'>{ size_t err; err = f; if (ERR_isError(err)) { { if (g_display_prefs<br>.displayLevel&gt;=5) { fprintf(stderr, "%s \n", "f"); } }; { {<br> if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: "<br>); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf(stderr<br>, "Error defined at %s, line %i : \n", "fileio.c", 125); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "error %i : "<br>, 11); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "%s", ZSTD_getErrorName(err)); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(11);<br> }; }; }</span></span> { size_t err; <span class='macro'>CHECK_V(err, f)<span class='macro_popup'>err = f; if (ERR_isError(err)) { { if (g_display_prefs.displayLevel<br>&gt;=5) { fprintf(stderr, "%s \n", "f"); } }; { { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, "zstd: "); } }; { if (<br>g_display_prefs.displayLevel&gt;=5) { fprintf(stderr, "Error defined at %s, line %i : \n"<br>, "fileio.c", 125); } }; { if (g_display_prefs.displayLevel&gt;=<br>1) { fprintf(stderr, "error %i : ", 11); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName<br>(err)); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, " \n"); } }; exit(11); }; }</span></span>; }</span></td></tr>
<tr class="codeline" data-linenumber="126"><td class="num" id="LN126">126</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="127"><td class="num" id="LN127">127</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="128"><td class="num" id="LN128">128</td><td class="line"><span class='comment'>/*-************************************</span></td></tr>
<tr class="codeline" data-linenumber="129"><td class="num" id="LN129">129</td><td class="line"><span class='comment'>*  Signal (Ctrl-C trapping)</span></td></tr>
<tr class="codeline" data-linenumber="130"><td class="num" id="LN130">130</td><td class="line"><span class='comment'>**************************************/</span></td></tr>
<tr class="codeline" data-linenumber="131"><td class="num" id="LN131">131</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span>* g_artefact = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="132"><td class="num" id="LN132">132</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> INThandler(<span class='keyword'>int</span> sig)</td></tr>
<tr class="codeline" data-linenumber="133"><td class="num" id="LN133">133</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="134"><td class="num" id="LN134">134</td><td class="line">    <span class='macro'>assert(sig==SIGINT)<span class='macro_popup'>((void) sizeof ((sig==2) ? 1 : 0), __extension__ ({ if (sig==<br>2) ; else __assert_fail ("sig==SIGINT", "fileio.c", 134, __extension__<br> __PRETTY_FUNCTION__); }))</span></span>; (<span class='keyword'>void</span>)sig;</td></tr>
<tr class="codeline" data-linenumber="135"><td class="num" id="LN135">135</td><td class="line"><span class='directive'>#if !defined(_MSC_VER)</span></td></tr>
<tr class="codeline" data-linenumber="136"><td class="num" id="LN136">136</td><td class="line">    signal(sig, <span class='macro'>SIG_IGN<span class='macro_popup'>((__sighandler_t) 1)</span></span>);  <span class='comment'>/* this invocation generates a buggy warning in Visual Studio */</span></td></tr>
<tr class="codeline" data-linenumber="137"><td class="num" id="LN137">137</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="138"><td class="num" id="LN138">138</td><td class="line">    <span class='keyword'>if</span> (g_artefact) {</td></tr>
<tr class="codeline" data-linenumber="139"><td class="num" id="LN139">139</td><td class="line">        <span class='macro'>assert(UTIL_isRegularFile(g_artefact))<span class='macro_popup'>((void) sizeof ((UTIL_isRegularFile(g_artefact)) ? 1 : 0), __extension__<br> ({ if (UTIL_isRegularFile(g_artefact)) ; else __assert_fail (<br>"UTIL_isRegularFile(g_artefact)", "fileio.c", 139, __extension__<br> __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="140"><td class="num" id="LN140">140</td><td class="line">        remove(g_artefact);</td></tr>
<tr class="codeline" data-linenumber="141"><td class="num" id="LN141">141</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="142"><td class="num" id="LN142">142</td><td class="line">    <span class='macro'>DISPLAY(<span class='string_literal'>"\n"</span>)<span class='macro_popup'>fprintf(stderr, "\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="143"><td class="num" id="LN143">143</td><td class="line">    exit(2);</td></tr>
<tr class="codeline" data-linenumber="144"><td class="num" id="LN144">144</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="145"><td class="num" id="LN145">145</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> addHandler(<span class='keyword'>char</span> <span class='keyword'>const</span>* dstFileName)</td></tr>
<tr class="codeline" data-linenumber="146"><td class="num" id="LN146">146</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="147"><td class="num" id="LN147">147</td><td class="line">    <span class='keyword'>if</span> (UTIL_isRegularFile(dstFileName)) {</td></tr>
<tr class="codeline" data-linenumber="148"><td class="num" id="LN148">148</td><td class="line">        g_artefact = dstFileName;</td></tr>
<tr class="codeline" data-linenumber="149"><td class="num" id="LN149">149</td><td class="line">        signal(<span class='macro'>SIGINT<span class='macro_popup'>2</span></span>, INThandler);</td></tr>
<tr class="codeline" data-linenumber="150"><td class="num" id="LN150">150</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="151"><td class="num" id="LN151">151</td><td class="line">        g_artefact = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="152"><td class="num" id="LN152">152</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="153"><td class="num" id="LN153">153</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="154"><td class="num" id="LN154">154</td><td class="line"><span class='comment'>/* Idempotent */</span></td></tr>
<tr class="codeline" data-linenumber="155"><td class="num" id="LN155">155</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> clearHandler(<span class='keyword'>void</span>)</td></tr>
<tr class="codeline" data-linenumber="156"><td class="num" id="LN156">156</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="157"><td class="num" id="LN157">157</td><td class="line">    <span class='keyword'>if</span> (g_artefact) signal(<span class='macro'>SIGINT<span class='macro_popup'>2</span></span>, <span class='macro'>SIG_DFL<span class='macro_popup'>((__sighandler_t) 0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="158"><td class="num" id="LN158">158</td><td class="line">    g_artefact = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="159"><td class="num" id="LN159">159</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="160"><td class="num" id="LN160">160</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="161"><td class="num" id="LN161">161</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="162"><td class="num" id="LN162">162</td><td class="line"><span class='comment'>/*-*********************************************************</span></td></tr>
<tr class="codeline" data-linenumber="163"><td class="num" id="LN163">163</td><td class="line"><span class='comment'>*  Termination signal trapping (Print debug stack trace)</span></td></tr>
<tr class="codeline" data-linenumber="164"><td class="num" id="LN164">164</td><td class="line"><span class='comment'>***********************************************************/</span></td></tr>
<tr class="codeline" data-linenumber="165"><td class="num" id="LN165">165</td><td class="line"><span class='directive'>#if defined(__has_feature<span class='macro'>)<span class='macro_popup'>0</span></span> &amp;&amp; !defined(<span class='macro'>BACKTRACE_ENABLE<span class='macro_popup'>0</span></span>) /* Clang compiler */</span></td></tr>
<tr class="codeline" data-linenumber="166"><td class="num" id="LN166">166</td><td class="line"><span class='directive'>#  if (__has_feature(address_sanitizer<span class='macro'>)<span class='macro_popup'>0</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="167"><td class="num" id="LN167">167</td><td class="line"><span class='directive'>#    define <span class='macro'>BACKTRACE_ENABLE<span class='macro_popup'>0</span></span> 0</span></td></tr>
<tr class="codeline" data-linenumber="168"><td class="num" id="LN168">168</td><td class="line"><span class='directive'>#  endif /* __has_feature(address_sanitizer) */</span></td></tr>
<tr class="codeline" data-linenumber="169"><td class="num" id="LN169">169</td><td class="line"><span class='directive'>#elif defined(__SANITIZE_ADDRESS__) &amp;&amp; !defined(<span class='macro'>BACKTRACE_ENABLE<span class='macro_popup'>0</span></span>) /* GCC compiler */</span></td></tr>
<tr class="codeline" data-linenumber="170"><td class="num" id="LN170">170</td><td class="line"><span class='directive'>#  define <span class='macro'>BACKTRACE_ENABLE<span class='macro_popup'>0</span></span> 0</span></td></tr>
<tr class="codeline" data-linenumber="171"><td class="num" id="LN171">171</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="172"><td class="num" id="LN172">172</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="173"><td class="num" id="LN173">173</td><td class="line"><span class='directive'>#if !defined(<span class='macro'>BACKTRACE_ENABLE<span class='macro_popup'>0</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="174"><td class="num" id="LN174">174</td><td class="line"><span class='comment'>/* automatic detector : backtrace enabled by default on linux+glibc and osx */</span></td></tr>
<tr class="codeline" data-linenumber="175"><td class="num" id="LN175">175</td><td class="line"><span class='directive'>#  if (defined(<span class='macro'>__linux__<span class='macro_popup'>1</span></span>) &amp;&amp; (defined(<span class='macro'>__GLIBC__<span class='macro_popup'>2</span></span>) &amp;&amp; !defined(__UCLIBC__))) \</span></td></tr>
<tr class="codeline" data-linenumber="176"><td class="num" id="LN176">176</td><td class="line">     <span class='directive'>|| (defined(__APPLE__) &amp;&amp; defined(__MACH__))</span></td></tr>
<tr class="codeline" data-linenumber="177"><td class="num" id="LN177">177</td><td class="line"><span class='directive'>#    define <span class='macro'>BACKTRACE_ENABLE<span class='macro_popup'>0</span></span> 1</span></td></tr>
<tr class="codeline" data-linenumber="178"><td class="num" id="LN178">178</td><td class="line"><span class='directive'>#  else</span></td></tr>
<tr class="codeline" data-linenumber="179"><td class="num" id="LN179">179</td><td class="line"><span class='directive'>#    define <span class='macro'>BACKTRACE_ENABLE<span class='macro_popup'>0</span></span> 0</span></td></tr>
<tr class="codeline" data-linenumber="180"><td class="num" id="LN180">180</td><td class="line"><span class='directive'>#  endif</span></td></tr>
<tr class="codeline" data-linenumber="181"><td class="num" id="LN181">181</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="182"><td class="num" id="LN182">182</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="183"><td class="num" id="LN183">183</td><td class="line"><span class='comment'>/* note : after this point, BACKTRACE_ENABLE is necessarily defined */</span></td></tr>
<tr class="codeline" data-linenumber="184"><td class="num" id="LN184">184</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="185"><td class="num" id="LN185">185</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="186"><td class="num" id="LN186">186</td><td class="line"><span class='directive'>#if <span class='macro'>BACKTRACE_ENABLE<span class='macro_popup'>0</span></span></span></td></tr>
<tr class="codeline" data-linenumber="187"><td class="num" id="LN187">187</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="188"><td class="num" id="LN188">188</td><td class="line"><span class='directive'>#include &lt;execinfo.h&gt;   /* backtrace, backtrace_symbols */</span></td></tr>
<tr class="codeline" data-linenumber="189"><td class="num" id="LN189">189</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="190"><td class="num" id="LN190">190</td><td class="line"><span class='directive'>#define MAX_STACK_FRAMES    50</span></td></tr>
<tr class="codeline" data-linenumber="191"><td class="num" id="LN191">191</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="192"><td class="num" id="LN192">192</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> ABRThandler(<span class='keyword'>int</span> sig) {</td></tr>
<tr class="codeline" data-linenumber="193"><td class="num" id="LN193">193</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span>* name;</td></tr>
<tr class="codeline" data-linenumber="194"><td class="num" id="LN194">194</td><td class="line">    <span class='keyword'>void</span>* addrlist[MAX_STACK_FRAMES];</td></tr>
<tr class="codeline" data-linenumber="195"><td class="num" id="LN195">195</td><td class="line">    <span class='keyword'>char</span>** symbollist;</td></tr>
<tr class="codeline" data-linenumber="196"><td class="num" id="LN196">196</td><td class="line">    <span class='keyword'>int</span> addrlen, i;</td></tr>
<tr class="codeline" data-linenumber="197"><td class="num" id="LN197">197</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="198"><td class="num" id="LN198">198</td><td class="line">    <span class='keyword'>switch</span> (sig) {</td></tr>
<tr class="codeline" data-linenumber="199"><td class="num" id="LN199">199</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>SIGABRT<span class='macro_popup'>6</span></span>: name = <span class='string_literal'>"SIGABRT"</span>; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="200"><td class="num" id="LN200">200</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>SIGFPE<span class='macro_popup'>8</span></span>: name = <span class='string_literal'>"SIGFPE"</span>; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="201"><td class="num" id="LN201">201</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>SIGILL<span class='macro_popup'>4</span></span>: name = <span class='string_literal'>"SIGILL"</span>; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="202"><td class="num" id="LN202">202</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>SIGINT<span class='macro_popup'>2</span></span>: name = <span class='string_literal'>"SIGINT"</span>; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="203"><td class="num" id="LN203">203</td><td class="line">        <span class='keyword'>case</span> <span class='macro'>SIGSEGV<span class='macro_popup'>11</span></span>: name = <span class='string_literal'>"SIGSEGV"</span>; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="204"><td class="num" id="LN204">204</td><td class="line">        <span class='keyword'>default</span>: name = <span class='string_literal'>"UNKNOWN"</span>;</td></tr>
<tr class="codeline" data-linenumber="205"><td class="num" id="LN205">205</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="206"><td class="num" id="LN206">206</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="207"><td class="num" id="LN207">207</td><td class="line">    <span class='macro'>DISPLAY(<span class='string_literal'>"Caught %s signal, printing stack:\n"</span>, name)<span class='macro_popup'>fprintf(stderr, "Caught %s signal, printing stack:\n", name)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="208"><td class="num" id="LN208">208</td><td class="line">    <span class='comment'>/* Retrieve current stack addresses. */</span></td></tr>
<tr class="codeline" data-linenumber="209"><td class="num" id="LN209">209</td><td class="line">    addrlen = backtrace(addrlist, MAX_STACK_FRAMES);</td></tr>
<tr class="codeline" data-linenumber="210"><td class="num" id="LN210">210</td><td class="line">    <span class='keyword'>if</span> (addrlen == 0) {</td></tr>
<tr class="codeline" data-linenumber="211"><td class="num" id="LN211">211</td><td class="line">        <span class='macro'>DISPLAY(<span class='string_literal'>"\n"</span>)<span class='macro_popup'>fprintf(stderr, "\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="212"><td class="num" id="LN212">212</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="213"><td class="num" id="LN213">213</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="214"><td class="num" id="LN214">214</td><td class="line">    <span class='comment'>/* Create readable strings to each frame. */</span></td></tr>
<tr class="codeline" data-linenumber="215"><td class="num" id="LN215">215</td><td class="line">    symbollist = backtrace_symbols(addrlist, addrlen);</td></tr>
<tr class="codeline" data-linenumber="216"><td class="num" id="LN216">216</td><td class="line">    <span class='comment'>/* Print the stack trace, excluding calls handling the signal. */</span></td></tr>
<tr class="codeline" data-linenumber="217"><td class="num" id="LN217">217</td><td class="line">    <span class='keyword'>for</span> (i = <span class='macro'>ZSTD_START_SYMBOLLIST_FRAME<span class='macro_popup'>2</span></span>; i &lt; addrlen; i++) {</td></tr>
<tr class="codeline" data-linenumber="218"><td class="num" id="LN218">218</td><td class="line">        <span class='macro'>DISPLAY(<span class='string_literal'>"%s\n"</span>, symbollist[i])<span class='macro_popup'>fprintf(stderr, "%s\n", symbollist[i])</span></span>;</td></tr>
<tr class="codeline" data-linenumber="219"><td class="num" id="LN219">219</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="220"><td class="num" id="LN220">220</td><td class="line">    free(symbollist);</td></tr>
<tr class="codeline" data-linenumber="221"><td class="num" id="LN221">221</td><td class="line">    <span class='comment'>/* Reset and raise the signal so default handler runs. */</span></td></tr>
<tr class="codeline" data-linenumber="222"><td class="num" id="LN222">222</td><td class="line">    signal(sig, <span class='macro'>SIG_DFL<span class='macro_popup'>((__sighandler_t) 0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="223"><td class="num" id="LN223">223</td><td class="line">    raise(sig);</td></tr>
<tr class="codeline" data-linenumber="224"><td class="num" id="LN224">224</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="225"><td class="num" id="LN225">225</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="226"><td class="num" id="LN226">226</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="227"><td class="num" id="LN227">227</td><td class="line"><span class='keyword'>void</span> FIO_addAbortHandler()</td></tr>
<tr class="codeline" data-linenumber="228"><td class="num" id="LN228">228</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="229"><td class="num" id="LN229">229</td><td class="line"><span class='directive'>#if <span class='macro'>BACKTRACE_ENABLE<span class='macro_popup'>0</span></span></span></td></tr>
<tr class="codeline" data-linenumber="230"><td class="num" id="LN230">230</td><td class="line">    signal(<span class='macro'>SIGABRT<span class='macro_popup'>6</span></span>, ABRThandler);</td></tr>
<tr class="codeline" data-linenumber="231"><td class="num" id="LN231">231</td><td class="line">    signal(<span class='macro'>SIGFPE<span class='macro_popup'>8</span></span>, ABRThandler);</td></tr>
<tr class="codeline" data-linenumber="232"><td class="num" id="LN232">232</td><td class="line">    signal(<span class='macro'>SIGILL<span class='macro_popup'>4</span></span>, ABRThandler);</td></tr>
<tr class="codeline" data-linenumber="233"><td class="num" id="LN233">233</td><td class="line">    signal(<span class='macro'>SIGSEGV<span class='macro_popup'>11</span></span>, ABRThandler);</td></tr>
<tr class="codeline" data-linenumber="234"><td class="num" id="LN234">234</td><td class="line">    signal(<span class='macro'>SIGBUS<span class='macro_popup'>7</span></span>, ABRThandler);</td></tr>
<tr class="codeline" data-linenumber="235"><td class="num" id="LN235">235</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="236"><td class="num" id="LN236">236</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="237"><td class="num" id="LN237">237</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="238"><td class="num" id="LN238">238</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="239"><td class="num" id="LN239">239</td><td class="line"><span class='comment'>/*-************************************************************</span></td></tr>
<tr class="codeline" data-linenumber="240"><td class="num" id="LN240">240</td><td class="line"><span class='comment'>* Avoid fseek()'s 2GiB barrier with MSVC, macOS, *BSD, MinGW</span></td></tr>
<tr class="codeline" data-linenumber="241"><td class="num" id="LN241">241</td><td class="line"><span class='comment'>***************************************************************/</span></td></tr>
<tr class="codeline" data-linenumber="242"><td class="num" id="LN242">242</td><td class="line"><span class='directive'>#if defined(_MSC_VER) &amp;&amp; _MSC_VER &gt;= 1400</span></td></tr>
<tr class="codeline" data-linenumber="243"><td class="num" id="LN243">243</td><td class="line"><span class='directive'>#   define <span class='macro'>LONG_SEEK<span class='macro_popup'>fseek</span></span> _fseeki64</span></td></tr>
<tr class="codeline" data-linenumber="244"><td class="num" id="LN244">244</td><td class="line"><span class='directive'>#   define <span class='macro'>LONG_TELL<span class='macro_popup'>ftell</span></span> _ftelli64</span></td></tr>
<tr class="codeline" data-linenumber="245"><td class="num" id="LN245">245</td><td class="line"><span class='directive'>#elif !defined(<span class='macro'>__64BIT__<span class='macro_popup'>1</span></span>) &amp;&amp; (<span class='macro'>PLATFORM_POSIX_VERSION<span class='macro_popup'>200809L</span></span> &gt;= 200112L) /* No point defining Large file for 64 bit */</span></td></tr>
<tr class="codeline" data-linenumber="246"><td class="num" id="LN246">246</td><td class="line"><span class='directive'>#  define <span class='macro'>LONG_SEEK<span class='macro_popup'>fseek</span></span> fseeko</span></td></tr>
<tr class="codeline" data-linenumber="247"><td class="num" id="LN247">247</td><td class="line"><span class='directive'>#  define <span class='macro'>LONG_TELL<span class='macro_popup'>ftell</span></span> ftello</span></td></tr>
<tr class="codeline" data-linenumber="248"><td class="num" id="LN248">248</td><td class="line"><span class='directive'>#elif defined(__MINGW32__) &amp;&amp; !defined(__STRICT_ANSI__) &amp;&amp; !defined(__NO_MINGW_LFS) &amp;&amp; defined(__MSVCRT__)</span></td></tr>
<tr class="codeline" data-linenumber="249"><td class="num" id="LN249">249</td><td class="line"><span class='directive'>#   define <span class='macro'>LONG_SEEK<span class='macro_popup'>fseek</span></span> fseeko64</span></td></tr>
<tr class="codeline" data-linenumber="250"><td class="num" id="LN250">250</td><td class="line"><span class='directive'>#   define <span class='macro'>LONG_TELL<span class='macro_popup'>ftell</span></span> ftello64</span></td></tr>
<tr class="codeline" data-linenumber="251"><td class="num" id="LN251">251</td><td class="line"><span class='directive'>#elif defined(_WIN32) &amp;&amp; !defined(__DJGPP__)</span></td></tr>
<tr class="codeline" data-linenumber="252"><td class="num" id="LN252">252</td><td class="line"><span class='directive'>#   include &lt;windows.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="253"><td class="num" id="LN253">253</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>int</span> <span class='macro'>LONG_SEEK<span class='macro_popup'>fseek</span></span>(FILE* file, __int64 offset, <span class='keyword'>int</span> origin) {</td></tr>
<tr class="codeline" data-linenumber="254"><td class="num" id="LN254">254</td><td class="line">        LARGE_INTEGER off;</td></tr>
<tr class="codeline" data-linenumber="255"><td class="num" id="LN255">255</td><td class="line">        DWORD method;</td></tr>
<tr class="codeline" data-linenumber="256"><td class="num" id="LN256">256</td><td class="line">        off.QuadPart = offset;</td></tr>
<tr class="codeline" data-linenumber="257"><td class="num" id="LN257">257</td><td class="line">        <span class='keyword'>if</span> (origin == <span class='macro'>SEEK_END<span class='macro_popup'>2</span></span>)</td></tr>
<tr class="codeline" data-linenumber="258"><td class="num" id="LN258">258</td><td class="line">            method = FILE_END;</td></tr>
<tr class="codeline" data-linenumber="259"><td class="num" id="LN259">259</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (origin == <span class='macro'>SEEK_CUR<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="260"><td class="num" id="LN260">260</td><td class="line">            method = FILE_CURRENT;</td></tr>
<tr class="codeline" data-linenumber="261"><td class="num" id="LN261">261</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="262"><td class="num" id="LN262">262</td><td class="line">            method = FILE_BEGIN;</td></tr>
<tr class="codeline" data-linenumber="263"><td class="num" id="LN263">263</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="264"><td class="num" id="LN264">264</td><td class="line">        <span class='keyword'>if</span> (SetFilePointerEx((HANDLE) _get_osfhandle(_fileno(file)), off, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, method))</td></tr>
<tr class="codeline" data-linenumber="265"><td class="num" id="LN265">265</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="266"><td class="num" id="LN266">266</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="267"><td class="num" id="LN267">267</td><td class="line">            <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="268"><td class="num" id="LN268">268</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="269"><td class="num" id="LN269">269</td><td class="line">    <span class='keyword'>static</span> __int64 <span class='macro'>LONG_TELL<span class='macro_popup'>ftell</span></span>(FILE* file) {</td></tr>
<tr class="codeline" data-linenumber="270"><td class="num" id="LN270">270</td><td class="line">        LARGE_INTEGER off, newOff;</td></tr>
<tr class="codeline" data-linenumber="271"><td class="num" id="LN271">271</td><td class="line">        off.QuadPart = 0;</td></tr>
<tr class="codeline" data-linenumber="272"><td class="num" id="LN272">272</td><td class="line">        newOff.QuadPart = 0;</td></tr>
<tr class="codeline" data-linenumber="273"><td class="num" id="LN273">273</td><td class="line">        SetFilePointerEx((HANDLE) _get_osfhandle(_fileno(file)), off, &amp;newOff, FILE_CURRENT);</td></tr>
<tr class="codeline" data-linenumber="274"><td class="num" id="LN274">274</td><td class="line">        <span class='keyword'>return</span> newOff.QuadPart;</td></tr>
<tr class="codeline" data-linenumber="275"><td class="num" id="LN275">275</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="276"><td class="num" id="LN276">276</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="277"><td class="num" id="LN277">277</td><td class="line"><span class='directive'>#   define <span class='macro'>LONG_SEEK<span class='macro_popup'>fseek</span></span> fseek</span></td></tr>
<tr class="codeline" data-linenumber="278"><td class="num" id="LN278">278</td><td class="line"><span class='directive'>#   define <span class='macro'>LONG_TELL<span class='macro_popup'>ftell</span></span> ftell</span></td></tr>
<tr class="codeline" data-linenumber="279"><td class="num" id="LN279">279</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="280"><td class="num" id="LN280">280</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="281"><td class="num" id="LN281">281</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="282"><td class="num" id="LN282">282</td><td class="line"><span class='comment'>/*-*************************************</span></td></tr>
<tr class="codeline" data-linenumber="283"><td class="num" id="LN283">283</td><td class="line"><span class='comment'>*  Parameters: FIO_prefs_t</span></td></tr>
<tr class="codeline" data-linenumber="284"><td class="num" id="LN284">284</td><td class="line"><span class='comment'>***************************************/</span></td></tr>
<tr class="codeline" data-linenumber="285"><td class="num" id="LN285">285</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="286"><td class="num" id="LN286">286</td><td class="line"><span class='comment'>/* typedef'd to FIO_prefs_t within fileio.h */</span></td></tr>
<tr class="codeline" data-linenumber="287"><td class="num" id="LN287">287</td><td class="line"><span class='keyword'>struct</span> FIO_prefs_s {</td></tr>
<tr class="codeline" data-linenumber="288"><td class="num" id="LN288">288</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="289"><td class="num" id="LN289">289</td><td class="line">    <span class='comment'>/* Algorithm preferences */</span></td></tr>
<tr class="codeline" data-linenumber="290"><td class="num" id="LN290">290</td><td class="line">    FIO_compressionType_t compressionType;</td></tr>
<tr class="codeline" data-linenumber="291"><td class="num" id="LN291">291</td><td class="line">    U32 sparseFileSupport;   <span class='comment'>/* 0: no sparse allowed; 1: auto (file yes, stdout no); 2: force sparse */</span></td></tr>
<tr class="codeline" data-linenumber="292"><td class="num" id="LN292">292</td><td class="line">    <span class='keyword'>int</span> dictIDFlag;</td></tr>
<tr class="codeline" data-linenumber="293"><td class="num" id="LN293">293</td><td class="line">    <span class='keyword'>int</span> checksumFlag;</td></tr>
<tr class="codeline" data-linenumber="294"><td class="num" id="LN294">294</td><td class="line">    <span class='keyword'>int</span> blockSize;</td></tr>
<tr class="codeline" data-linenumber="295"><td class="num" id="LN295">295</td><td class="line">    <span class='keyword'>int</span> overlapLog;</td></tr>
<tr class="codeline" data-linenumber="296"><td class="num" id="LN296">296</td><td class="line">    U32 adaptiveMode;</td></tr>
<tr class="codeline" data-linenumber="297"><td class="num" id="LN297">297</td><td class="line">    <span class='keyword'>int</span> rsyncable;</td></tr>
<tr class="codeline" data-linenumber="298"><td class="num" id="LN298">298</td><td class="line">    <span class='keyword'>int</span> minAdaptLevel;</td></tr>
<tr class="codeline" data-linenumber="299"><td class="num" id="LN299">299</td><td class="line">    <span class='keyword'>int</span> maxAdaptLevel;</td></tr>
<tr class="codeline" data-linenumber="300"><td class="num" id="LN300">300</td><td class="line">    <span class='keyword'>int</span> ldmFlag;</td></tr>
<tr class="codeline" data-linenumber="301"><td class="num" id="LN301">301</td><td class="line">    <span class='keyword'>int</span> ldmHashLog;</td></tr>
<tr class="codeline" data-linenumber="302"><td class="num" id="LN302">302</td><td class="line">    <span class='keyword'>int</span> ldmMinMatch;</td></tr>
<tr class="codeline" data-linenumber="303"><td class="num" id="LN303">303</td><td class="line">    <span class='keyword'>int</span> ldmBucketSizeLog;</td></tr>
<tr class="codeline" data-linenumber="304"><td class="num" id="LN304">304</td><td class="line">    <span class='keyword'>int</span> ldmHashRateLog;</td></tr>
<tr class="codeline" data-linenumber="305"><td class="num" id="LN305">305</td><td class="line">    size_t streamSrcSize;</td></tr>
<tr class="codeline" data-linenumber="306"><td class="num" id="LN306">306</td><td class="line">    size_t targetCBlockSize;</td></tr>
<tr class="codeline" data-linenumber="307"><td class="num" id="LN307">307</td><td class="line">    <span class='keyword'>int</span> srcSizeHint;</td></tr>
<tr class="codeline" data-linenumber="308"><td class="num" id="LN308">308</td><td class="line">    <span class='keyword'>int</span> testMode;</td></tr>
<tr class="codeline" data-linenumber="309"><td class="num" id="LN309">309</td><td class="line">    ZSTD_literalCompressionMode_e literalCompressionMode;</td></tr>
<tr class="codeline" data-linenumber="310"><td class="num" id="LN310">310</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="311"><td class="num" id="LN311">311</td><td class="line">    <span class='comment'>/* IO preferences */</span></td></tr>
<tr class="codeline" data-linenumber="312"><td class="num" id="LN312">312</td><td class="line">    U32 removeSrcFile;</td></tr>
<tr class="codeline" data-linenumber="313"><td class="num" id="LN313">313</td><td class="line">    U32 overwrite;</td></tr>
<tr class="codeline" data-linenumber="314"><td class="num" id="LN314">314</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="315"><td class="num" id="LN315">315</td><td class="line">    <span class='comment'>/* Computation resources preferences */</span></td></tr>
<tr class="codeline" data-linenumber="316"><td class="num" id="LN316">316</td><td class="line">    <span class='keyword'>unsigned</span> memLimit;</td></tr>
<tr class="codeline" data-linenumber="317"><td class="num" id="LN317">317</td><td class="line">    <span class='keyword'>int</span> nbWorkers;</td></tr>
<tr class="codeline" data-linenumber="318"><td class="num" id="LN318">318</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="319"><td class="num" id="LN319">319</td><td class="line">    <span class='keyword'>int</span> excludeCompressedFiles;</td></tr>
<tr class="codeline" data-linenumber="320"><td class="num" id="LN320">320</td><td class="line">    <span class='keyword'>int</span> patchFromMode;</td></tr>
<tr class="codeline" data-linenumber="321"><td class="num" id="LN321">321</td><td class="line">    <span class='keyword'>int</span> contentSize;</td></tr>
<tr class="codeline" data-linenumber="322"><td class="num" id="LN322">322</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="323"><td class="num" id="LN323">323</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="324"><td class="num" id="LN324">324</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="325"><td class="num" id="LN325">325</td><td class="line"><span class='comment'>/*-*************************************</span></td></tr>
<tr class="codeline" data-linenumber="326"><td class="num" id="LN326">326</td><td class="line"><span class='comment'>*  Parameters: Initialization</span></td></tr>
<tr class="codeline" data-linenumber="327"><td class="num" id="LN327">327</td><td class="line"><span class='comment'>***************************************/</span></td></tr>
<tr class="codeline" data-linenumber="328"><td class="num" id="LN328">328</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="329"><td class="num" id="LN329">329</td><td class="line"><span class='directive'>#define <span class='macro'>FIO_OVERLAP_LOG_NOTSET<span class='macro_popup'>9999</span></span> 9999</span></td></tr>
<tr class="codeline" data-linenumber="330"><td class="num" id="LN330">330</td><td class="line"><span class='directive'>#define <span class='macro'>FIO_LDM_PARAM_NOTSET<span class='macro_popup'>9999</span></span> 9999</span></td></tr>
<tr class="codeline" data-linenumber="331"><td class="num" id="LN331">331</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="332"><td class="num" id="LN332">332</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="333"><td class="num" id="LN333">333</td><td class="line">FIO_prefs_t* FIO_createPreferences(<span class='keyword'>void</span>)</td></tr>
<tr class="codeline" data-linenumber="334"><td class="num" id="LN334">334</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="335"><td class="num" id="LN335">335</td><td class="line">    FIO_prefs_t* <span class='keyword'>const</span> ret = (FIO_prefs_t*)malloc(<span class='keyword'>sizeof</span>(FIO_prefs_t));</td></tr>
<tr class="codeline" data-linenumber="336"><td class="num" id="LN336">336</td><td class="line">    <span class='keyword'>if</span> (!ret) <span class='macro'>EXM_THROW(21, <span class='string_literal'>"Allocation error : not enough memory"</span>)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 336<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 21); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Allocation error : not enough memory"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; exit(21); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="337"><td class="num" id="LN337">337</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="338"><td class="num" id="LN338">338</td><td class="line">    ret-&gt;compressionType = FIO_zstdCompression;</td></tr>
<tr class="codeline" data-linenumber="339"><td class="num" id="LN339">339</td><td class="line">    ret-&gt;overwrite = 0;</td></tr>
<tr class="codeline" data-linenumber="340"><td class="num" id="LN340">340</td><td class="line">    ret-&gt;sparseFileSupport = <span class='macro'>ZSTD_SPARSE_DEFAULT<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="341"><td class="num" id="LN341">341</td><td class="line">    ret-&gt;dictIDFlag = 1;</td></tr>
<tr class="codeline" data-linenumber="342"><td class="num" id="LN342">342</td><td class="line">    ret-&gt;checksumFlag = 1;</td></tr>
<tr class="codeline" data-linenumber="343"><td class="num" id="LN343">343</td><td class="line">    ret-&gt;removeSrcFile = 0;</td></tr>
<tr class="codeline" data-linenumber="344"><td class="num" id="LN344">344</td><td class="line">    ret-&gt;memLimit = 0;</td></tr>
<tr class="codeline" data-linenumber="345"><td class="num" id="LN345">345</td><td class="line">    ret-&gt;nbWorkers = 1;</td></tr>
<tr class="codeline" data-linenumber="346"><td class="num" id="LN346">346</td><td class="line">    ret-&gt;blockSize = 0;</td></tr>
<tr class="codeline" data-linenumber="347"><td class="num" id="LN347">347</td><td class="line">    ret-&gt;overlapLog = <span class='macro'>FIO_OVERLAP_LOG_NOTSET<span class='macro_popup'>9999</span></span>;</td></tr>
<tr class="codeline" data-linenumber="348"><td class="num" id="LN348">348</td><td class="line">    ret-&gt;adaptiveMode = 0;</td></tr>
<tr class="codeline" data-linenumber="349"><td class="num" id="LN349">349</td><td class="line">    ret-&gt;rsyncable = 0;</td></tr>
<tr class="codeline" data-linenumber="350"><td class="num" id="LN350">350</td><td class="line">    ret-&gt;minAdaptLevel = -50;   <span class='comment'>/* initializing this value requires a constant, so ZSTD_minCLevel() doesn't work */</span></td></tr>
<tr class="codeline" data-linenumber="351"><td class="num" id="LN351">351</td><td class="line">    ret-&gt;maxAdaptLevel = 22;   <span class='comment'>/* initializing this value requires a constant, so ZSTD_maxCLevel() doesn't work */</span></td></tr>
<tr class="codeline" data-linenumber="352"><td class="num" id="LN352">352</td><td class="line">    ret-&gt;ldmFlag = 0;</td></tr>
<tr class="codeline" data-linenumber="353"><td class="num" id="LN353">353</td><td class="line">    ret-&gt;ldmHashLog = 0;</td></tr>
<tr class="codeline" data-linenumber="354"><td class="num" id="LN354">354</td><td class="line">    ret-&gt;ldmMinMatch = 0;</td></tr>
<tr class="codeline" data-linenumber="355"><td class="num" id="LN355">355</td><td class="line">    ret-&gt;ldmBucketSizeLog = <span class='macro'>FIO_LDM_PARAM_NOTSET<span class='macro_popup'>9999</span></span>;</td></tr>
<tr class="codeline" data-linenumber="356"><td class="num" id="LN356">356</td><td class="line">    ret-&gt;ldmHashRateLog = <span class='macro'>FIO_LDM_PARAM_NOTSET<span class='macro_popup'>9999</span></span>;</td></tr>
<tr class="codeline" data-linenumber="357"><td class="num" id="LN357">357</td><td class="line">    ret-&gt;streamSrcSize = 0;</td></tr>
<tr class="codeline" data-linenumber="358"><td class="num" id="LN358">358</td><td class="line">    ret-&gt;targetCBlockSize = 0;</td></tr>
<tr class="codeline" data-linenumber="359"><td class="num" id="LN359">359</td><td class="line">    ret-&gt;srcSizeHint = 0;</td></tr>
<tr class="codeline" data-linenumber="360"><td class="num" id="LN360">360</td><td class="line">    ret-&gt;testMode = 0;</td></tr>
<tr class="codeline" data-linenumber="361"><td class="num" id="LN361">361</td><td class="line">    ret-&gt;literalCompressionMode = ZSTD_lcm_auto;</td></tr>
<tr class="codeline" data-linenumber="362"><td class="num" id="LN362">362</td><td class="line">    ret-&gt;excludeCompressedFiles = 0;</td></tr>
<tr class="codeline" data-linenumber="363"><td class="num" id="LN363">363</td><td class="line">    <span class='keyword'>return</span> ret;</td></tr>
<tr class="codeline" data-linenumber="364"><td class="num" id="LN364">364</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="365"><td class="num" id="LN365">365</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="366"><td class="num" id="LN366">366</td><td class="line"><span class='keyword'>void</span> FIO_freePreferences(FIO_prefs_t* <span class='keyword'>const</span> prefs)</td></tr>
<tr class="codeline" data-linenumber="367"><td class="num" id="LN367">367</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="368"><td class="num" id="LN368">368</td><td class="line">    free(prefs);</td></tr>
<tr class="codeline" data-linenumber="369"><td class="num" id="LN369">369</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="370"><td class="num" id="LN370">370</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="371"><td class="num" id="LN371">371</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="372"><td class="num" id="LN372">372</td><td class="line"><span class='comment'>/*-*************************************</span></td></tr>
<tr class="codeline" data-linenumber="373"><td class="num" id="LN373">373</td><td class="line"><span class='comment'>*  Parameters: Display Options</span></td></tr>
<tr class="codeline" data-linenumber="374"><td class="num" id="LN374">374</td><td class="line"><span class='comment'>***************************************/</span></td></tr>
<tr class="codeline" data-linenumber="375"><td class="num" id="LN375">375</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="376"><td class="num" id="LN376">376</td><td class="line"><span class='keyword'>void</span> FIO_setNotificationLevel(<span class='keyword'>int</span> level) { g_display_prefs.displayLevel=level; }</td></tr>
<tr class="codeline" data-linenumber="377"><td class="num" id="LN377">377</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="378"><td class="num" id="LN378">378</td><td class="line"><span class='keyword'>void</span> FIO_setNoProgress(<span class='keyword'>unsigned</span> noProgress) { g_display_prefs.noProgress = noProgress; }</td></tr>
<tr class="codeline" data-linenumber="379"><td class="num" id="LN379">379</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="380"><td class="num" id="LN380">380</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="381"><td class="num" id="LN381">381</td><td class="line"><span class='comment'>/*-*************************************</span></td></tr>
<tr class="codeline" data-linenumber="382"><td class="num" id="LN382">382</td><td class="line"><span class='comment'>*  Parameters: Setters</span></td></tr>
<tr class="codeline" data-linenumber="383"><td class="num" id="LN383">383</td><td class="line"><span class='comment'>***************************************/</span></td></tr>
<tr class="codeline" data-linenumber="384"><td class="num" id="LN384">384</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="385"><td class="num" id="LN385">385</td><td class="line"><span class='keyword'>void</span> FIO_setCompressionType(FIO_prefs_t* <span class='keyword'>const</span> prefs, FIO_compressionType_t compressionType) { prefs-&gt;compressionType = compressionType; }</td></tr>
<tr class="codeline" data-linenumber="386"><td class="num" id="LN386">386</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="387"><td class="num" id="LN387">387</td><td class="line"><span class='keyword'>void</span> FIO_overwriteMode(FIO_prefs_t* <span class='keyword'>const</span> prefs) { prefs-&gt;overwrite = 1; }</td></tr>
<tr class="codeline" data-linenumber="388"><td class="num" id="LN388">388</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="389"><td class="num" id="LN389">389</td><td class="line"><span class='keyword'>void</span> FIO_setSparseWrite(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>unsigned</span> sparse) { prefs-&gt;sparseFileSupport = sparse; }</td></tr>
<tr class="codeline" data-linenumber="390"><td class="num" id="LN390">390</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="391"><td class="num" id="LN391">391</td><td class="line"><span class='keyword'>void</span> FIO_setDictIDFlag(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>int</span> dictIDFlag) { prefs-&gt;dictIDFlag = dictIDFlag; }</td></tr>
<tr class="codeline" data-linenumber="392"><td class="num" id="LN392">392</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="393"><td class="num" id="LN393">393</td><td class="line"><span class='keyword'>void</span> FIO_setChecksumFlag(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>int</span> checksumFlag) { prefs-&gt;checksumFlag = checksumFlag; }</td></tr>
<tr class="codeline" data-linenumber="394"><td class="num" id="LN394">394</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="395"><td class="num" id="LN395">395</td><td class="line"><span class='keyword'>void</span> FIO_setRemoveSrcFile(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>unsigned</span> flag) { prefs-&gt;removeSrcFile = (flag&gt;0); }</td></tr>
<tr class="codeline" data-linenumber="396"><td class="num" id="LN396">396</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="397"><td class="num" id="LN397">397</td><td class="line"><span class='keyword'>void</span> FIO_setMemLimit(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>unsigned</span> memLimit) { prefs-&gt;memLimit = memLimit; }</td></tr>
<tr class="codeline" data-linenumber="398"><td class="num" id="LN398">398</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="399"><td class="num" id="LN399">399</td><td class="line"><span class='keyword'>void</span> FIO_setNbWorkers(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>int</span> nbWorkers) {</td></tr>
<tr class="codeline" data-linenumber="400"><td class="num" id="LN400">400</td><td class="line"><span class='directive'>#ifndef <span class='macro'>ZSTD_MULTITHREAD<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="401"><td class="num" id="LN401">401</td><td class="line">    <span class='keyword'>if</span> (nbWorkers &gt; 0) <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"Note : multi-threading is disabled \n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2) { fprintf(stderr, "Note : multi-threading is disabled \n"<br>); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="402"><td class="num" id="LN402">402</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="403"><td class="num" id="LN403">403</td><td class="line">    prefs-&gt;nbWorkers = nbWorkers;</td></tr>
<tr class="codeline" data-linenumber="404"><td class="num" id="LN404">404</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="405"><td class="num" id="LN405">405</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="406"><td class="num" id="LN406">406</td><td class="line"><span class='keyword'>void</span> FIO_setExcludeCompressedFile(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>int</span> excludeCompressedFiles) { prefs-&gt;excludeCompressedFiles = excludeCompressedFiles; }</td></tr>
<tr class="codeline" data-linenumber="407"><td class="num" id="LN407">407</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="408"><td class="num" id="LN408">408</td><td class="line"><span class='keyword'>void</span> FIO_setBlockSize(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>int</span> blockSize) {</td></tr>
<tr class="codeline" data-linenumber="409"><td class="num" id="LN409">409</td><td class="line">    <span class='keyword'>if</span> (blockSize &amp;&amp; prefs-&gt;nbWorkers==0)</td></tr>
<tr class="codeline" data-linenumber="410"><td class="num" id="LN410">410</td><td class="line">        <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"Setting block size is useless in single-thread mode \n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2) { fprintf(stderr, "Setting block size is useless in single-thread mode \n"<br>); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="411"><td class="num" id="LN411">411</td><td class="line">    prefs-&gt;blockSize = blockSize;</td></tr>
<tr class="codeline" data-linenumber="412"><td class="num" id="LN412">412</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="413"><td class="num" id="LN413">413</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="414"><td class="num" id="LN414">414</td><td class="line"><span class='keyword'>void</span> FIO_setOverlapLog(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>int</span> overlapLog){</td></tr>
<tr class="codeline" data-linenumber="415"><td class="num" id="LN415">415</td><td class="line">    <span class='keyword'>if</span> (overlapLog &amp;&amp; prefs-&gt;nbWorkers==0)</td></tr>
<tr class="codeline" data-linenumber="416"><td class="num" id="LN416">416</td><td class="line">        <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"Setting overlapLog is useless in single-thread mode \n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2) { fprintf(stderr, "Setting overlapLog is useless in single-thread mode \n"<br>); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="417"><td class="num" id="LN417">417</td><td class="line">    prefs-&gt;overlapLog = overlapLog;</td></tr>
<tr class="codeline" data-linenumber="418"><td class="num" id="LN418">418</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="419"><td class="num" id="LN419">419</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="420"><td class="num" id="LN420">420</td><td class="line"><span class='keyword'>void</span> FIO_setAdaptiveMode(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>unsigned</span> adapt) {</td></tr>
<tr class="codeline" data-linenumber="421"><td class="num" id="LN421">421</td><td class="line">    <span class='keyword'>if</span> ((adapt&gt;0) &amp;&amp; (prefs-&gt;nbWorkers==0))</td></tr>
<tr class="codeline" data-linenumber="422"><td class="num" id="LN422">422</td><td class="line">        <span class='macro'>EXM_THROW(1, <span class='string_literal'>"Adaptive mode is not compatible with single thread mode \n"</span>)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 422<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 1); } }; { if (g_display_prefs.displayLevel&gt;=<br>1) { fprintf(stderr, "Adaptive mode is not compatible with single thread mode \n"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; exit(1); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="423"><td class="num" id="LN423">423</td><td class="line">    prefs-&gt;adaptiveMode = adapt;</td></tr>
<tr class="codeline" data-linenumber="424"><td class="num" id="LN424">424</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="425"><td class="num" id="LN425">425</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="426"><td class="num" id="LN426">426</td><td class="line"><span class='keyword'>void</span> FIO_setRsyncable(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>int</span> rsyncable) {</td></tr>
<tr class="codeline" data-linenumber="427"><td class="num" id="LN427">427</td><td class="line">    <span class='keyword'>if</span> ((rsyncable&gt;0) &amp;&amp; (prefs-&gt;nbWorkers==0))</td></tr>
<tr class="codeline" data-linenumber="428"><td class="num" id="LN428">428</td><td class="line">        <span class='macro'>EXM_THROW(1, <span class='string_literal'>"Rsyncable mode is not compatible with single thread mode \n"</span>)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 428<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 1); } }; { if (g_display_prefs.displayLevel&gt;=<br>1) { fprintf(stderr, "Rsyncable mode is not compatible with single thread mode \n"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; exit(1); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="429"><td class="num" id="LN429">429</td><td class="line">    prefs-&gt;rsyncable = rsyncable;</td></tr>
<tr class="codeline" data-linenumber="430"><td class="num" id="LN430">430</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="431"><td class="num" id="LN431">431</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="432"><td class="num" id="LN432">432</td><td class="line"><span class='keyword'>void</span> FIO_setStreamSrcSize(FIO_prefs_t* <span class='keyword'>const</span> prefs, size_t streamSrcSize) {</td></tr>
<tr class="codeline" data-linenumber="433"><td class="num" id="LN433">433</td><td class="line">    prefs-&gt;streamSrcSize = streamSrcSize;</td></tr>
<tr class="codeline" data-linenumber="434"><td class="num" id="LN434">434</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="435"><td class="num" id="LN435">435</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="436"><td class="num" id="LN436">436</td><td class="line"><span class='keyword'>void</span> FIO_setTargetCBlockSize(FIO_prefs_t* <span class='keyword'>const</span> prefs, size_t targetCBlockSize) {</td></tr>
<tr class="codeline" data-linenumber="437"><td class="num" id="LN437">437</td><td class="line">    prefs-&gt;targetCBlockSize = targetCBlockSize;</td></tr>
<tr class="codeline" data-linenumber="438"><td class="num" id="LN438">438</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="439"><td class="num" id="LN439">439</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="440"><td class="num" id="LN440">440</td><td class="line"><span class='keyword'>void</span> FIO_setSrcSizeHint(FIO_prefs_t* <span class='keyword'>const</span> prefs, size_t srcSizeHint) {</td></tr>
<tr class="codeline" data-linenumber="441"><td class="num" id="LN441">441</td><td class="line">    prefs-&gt;srcSizeHint = (<span class='keyword'>int</span>)<span class='macro'>MIN((size_t)INT_MAX, srcSizeHint)<span class='macro_popup'>(((size_t)2147483647) &lt; (srcSizeHint) ? ((size_t)2147483647<br>) : (srcSizeHint))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="442"><td class="num" id="LN442">442</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="443"><td class="num" id="LN443">443</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="444"><td class="num" id="LN444">444</td><td class="line"><span class='keyword'>void</span> FIO_setTestMode(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>int</span> testMode) {</td></tr>
<tr class="codeline" data-linenumber="445"><td class="num" id="LN445">445</td><td class="line">    prefs-&gt;testMode = (testMode!=0);</td></tr>
<tr class="codeline" data-linenumber="446"><td class="num" id="LN446">446</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="447"><td class="num" id="LN447">447</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="448"><td class="num" id="LN448">448</td><td class="line"><span class='keyword'>void</span> FIO_setLiteralCompressionMode(</td></tr>
<tr class="codeline" data-linenumber="449"><td class="num" id="LN449">449</td><td class="line">        FIO_prefs_t* <span class='keyword'>const</span> prefs,</td></tr>
<tr class="codeline" data-linenumber="450"><td class="num" id="LN450">450</td><td class="line">        ZSTD_literalCompressionMode_e mode) {</td></tr>
<tr class="codeline" data-linenumber="451"><td class="num" id="LN451">451</td><td class="line">    prefs-&gt;literalCompressionMode = mode;</td></tr>
<tr class="codeline" data-linenumber="452"><td class="num" id="LN452">452</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="453"><td class="num" id="LN453">453</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="454"><td class="num" id="LN454">454</td><td class="line"><span class='keyword'>void</span> FIO_setAdaptMin(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>int</span> minCLevel)</td></tr>
<tr class="codeline" data-linenumber="455"><td class="num" id="LN455">455</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="456"><td class="num" id="LN456">456</td><td class="line"><span class='directive'>#ifndef ZSTD_NOCOMPRESS</span></td></tr>
<tr class="codeline" data-linenumber="457"><td class="num" id="LN457">457</td><td class="line">    <span class='macro'>assert(minCLevel &gt;= ZSTD_minCLevel())<span class='macro_popup'>((void) sizeof ((minCLevel &gt;= ZSTD_minCLevel()) ? 1 : 0), __extension__<br> ({ if (minCLevel &gt;= ZSTD_minCLevel()) ; else __assert_fail<br> ("minCLevel &gt;= ZSTD_minCLevel()", "fileio.c", 457, __extension__<br> __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="458"><td class="num" id="LN458">458</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="459"><td class="num" id="LN459">459</td><td class="line">    prefs-&gt;minAdaptLevel = minCLevel;</td></tr>
<tr class="codeline" data-linenumber="460"><td class="num" id="LN460">460</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="461"><td class="num" id="LN461">461</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="462"><td class="num" id="LN462">462</td><td class="line"><span class='keyword'>void</span> FIO_setAdaptMax(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>int</span> maxCLevel)</td></tr>
<tr class="codeline" data-linenumber="463"><td class="num" id="LN463">463</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="464"><td class="num" id="LN464">464</td><td class="line">    prefs-&gt;maxAdaptLevel = maxCLevel;</td></tr>
<tr class="codeline" data-linenumber="465"><td class="num" id="LN465">465</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="466"><td class="num" id="LN466">466</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="467"><td class="num" id="LN467">467</td><td class="line"><span class='keyword'>void</span> FIO_setLdmFlag(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>unsigned</span> ldmFlag) {</td></tr>
<tr class="codeline" data-linenumber="468"><td class="num" id="LN468">468</td><td class="line">    prefs-&gt;ldmFlag = (ldmFlag&gt;0);</td></tr>
<tr class="codeline" data-linenumber="469"><td class="num" id="LN469">469</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="470"><td class="num" id="LN470">470</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="471"><td class="num" id="LN471">471</td><td class="line"><span class='keyword'>void</span> FIO_setLdmHashLog(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>int</span> ldmHashLog) {</td></tr>
<tr class="codeline" data-linenumber="472"><td class="num" id="LN472">472</td><td class="line">    prefs-&gt;ldmHashLog = ldmHashLog;</td></tr>
<tr class="codeline" data-linenumber="473"><td class="num" id="LN473">473</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="474"><td class="num" id="LN474">474</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="475"><td class="num" id="LN475">475</td><td class="line"><span class='keyword'>void</span> FIO_setLdmMinMatch(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>int</span> ldmMinMatch) {</td></tr>
<tr class="codeline" data-linenumber="476"><td class="num" id="LN476">476</td><td class="line">    prefs-&gt;ldmMinMatch = ldmMinMatch;</td></tr>
<tr class="codeline" data-linenumber="477"><td class="num" id="LN477">477</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="478"><td class="num" id="LN478">478</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="479"><td class="num" id="LN479">479</td><td class="line"><span class='keyword'>void</span> FIO_setLdmBucketSizeLog(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>int</span> ldmBucketSizeLog) {</td></tr>
<tr class="codeline" data-linenumber="480"><td class="num" id="LN480">480</td><td class="line">    prefs-&gt;ldmBucketSizeLog = ldmBucketSizeLog;</td></tr>
<tr class="codeline" data-linenumber="481"><td class="num" id="LN481">481</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="482"><td class="num" id="LN482">482</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="483"><td class="num" id="LN483">483</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="484"><td class="num" id="LN484">484</td><td class="line"><span class='keyword'>void</span> FIO_setLdmHashRateLog(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>int</span> ldmHashRateLog) {</td></tr>
<tr class="codeline" data-linenumber="485"><td class="num" id="LN485">485</td><td class="line">    prefs-&gt;ldmHashRateLog = ldmHashRateLog;</td></tr>
<tr class="codeline" data-linenumber="486"><td class="num" id="LN486">486</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="487"><td class="num" id="LN487">487</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="488"><td class="num" id="LN488">488</td><td class="line"><span class='keyword'>void</span> FIO_setPatchFromMode(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>int</span> value)</td></tr>
<tr class="codeline" data-linenumber="489"><td class="num" id="LN489">489</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="490"><td class="num" id="LN490">490</td><td class="line">    prefs-&gt;patchFromMode = value != 0;</td></tr>
<tr class="codeline" data-linenumber="491"><td class="num" id="LN491">491</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="492"><td class="num" id="LN492">492</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="493"><td class="num" id="LN493">493</td><td class="line"><span class='keyword'>void</span> FIO_setContentSize(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>int</span> value)</td></tr>
<tr class="codeline" data-linenumber="494"><td class="num" id="LN494">494</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="495"><td class="num" id="LN495">495</td><td class="line">    prefs-&gt;contentSize = value != 0;</td></tr>
<tr class="codeline" data-linenumber="496"><td class="num" id="LN496">496</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="497"><td class="num" id="LN497">497</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="498"><td class="num" id="LN498">498</td><td class="line"><span class='comment'>/*-*************************************</span></td></tr>
<tr class="codeline" data-linenumber="499"><td class="num" id="LN499">499</td><td class="line"><span class='comment'>*  Functions</span></td></tr>
<tr class="codeline" data-linenumber="500"><td class="num" id="LN500">500</td><td class="line"><span class='comment'>***************************************/</span></td></tr>
<tr class="codeline" data-linenumber="501"><td class="num" id="LN501">501</td><td class="line"><span class='comment'>/** FIO_remove() :</span></td></tr>
<tr class="codeline" data-linenumber="502"><td class="num" id="LN502">502</td><td class="line"> <span class='comment'>* @result : Unlink `fileName`, even if it's read-only */</span></td></tr>
<tr class="codeline" data-linenumber="503"><td class="num" id="LN503">503</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> FIO_remove(<span class='keyword'>const</span> <span class='keyword'>char</span>* path)</td></tr>
<tr class="codeline" data-linenumber="504"><td class="num" id="LN504">504</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="505"><td class="num" id="LN505">505</td><td class="line">    <span class='keyword'>if</span> (!UTIL_isRegularFile(path)) {</td></tr>
<tr class="codeline" data-linenumber="506"><td class="num" id="LN506">506</td><td class="line">        <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"zstd: Refusing to remove non-regular file %s \n"</span>, path)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2) { fprintf(stderr, "zstd: Refusing to remove non-regular file %s \n"<br>, path); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="507"><td class="num" id="LN507">507</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="508"><td class="num" id="LN508">508</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="509"><td class="num" id="LN509">509</td><td class="line"><span class='directive'>#if defined(_WIN32) || defined(WIN32)</span></td></tr>
<tr class="codeline" data-linenumber="510"><td class="num" id="LN510">510</td><td class="line">    <span class='comment'>/* windows doesn't allow remove read-only files,</span></td></tr>
<tr class="codeline" data-linenumber="511"><td class="num" id="LN511">511</td><td class="line">     <span class='comment'>* so try to make it writable first */</span></td></tr>
<tr class="codeline" data-linenumber="512"><td class="num" id="LN512">512</td><td class="line">    UTIL_chmod(path, _S_IWRITE);</td></tr>
<tr class="codeline" data-linenumber="513"><td class="num" id="LN513">513</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="514"><td class="num" id="LN514">514</td><td class="line">    <span class='keyword'>return</span> remove(path);</td></tr>
<tr class="codeline" data-linenumber="515"><td class="num" id="LN515">515</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="516"><td class="num" id="LN516">516</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="517"><td class="num" id="LN517">517</td><td class="line"><span class='comment'>/** FIO_openSrcFile() :</span></td></tr>
<tr class="codeline" data-linenumber="518"><td class="num" id="LN518">518</td><td class="line"> <span class='comment'>*  condition : `srcFileName` must be non-NULL.</span></td></tr>
<tr class="codeline" data-linenumber="519"><td class="num" id="LN519">519</td><td class="line"> <span class='comment'>* @result : FILE* to `srcFileName`, or NULL if it fails */</span></td></tr>
<tr class="codeline" data-linenumber="520"><td class="num" id="LN520">520</td><td class="line"><span class='keyword'>static</span> FILE* FIO_openSrcFile(<span class='keyword'>const</span> <span class='keyword'>char</span>* srcFileName)</td></tr>
<tr class="codeline" data-linenumber="521"><td class="num" id="LN521">521</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="522"><td class="num" id="LN522">522</td><td class="line">    <span class='macro'>assert(srcFileName != NULL)<span class='macro_popup'>((void) sizeof ((srcFileName != ((void*)0)) ? 1 : 0), __extension__<br> ({ if (srcFileName != ((void*)0)) ; else __assert_fail ("srcFileName != NULL"<br>, "fileio.c", 522, __extension__ __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="523"><td class="num" id="LN523">523</td><td class="line">    <span class='keyword'>if</span> (!strcmp (srcFileName, <span class='macro'>stdinmark<span class='macro_popup'>"/*stdin*\\"</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="524"><td class="num" id="LN524">524</td><td class="line">        <span class='macro'>DISPLAYLEVEL(4,<span class='string_literal'>"Using stdin for input \n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=4) { fprintf(stderr, "Using stdin for input \n"<br>); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="525"><td class="num" id="LN525">525</td><td class="line">        SET_BINARY_MODE(stdin);</td></tr>
<tr class="codeline" data-linenumber="526"><td class="num" id="LN526">526</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>stdin<span class='macro_popup'>stdin</span></span>;</td></tr>
<tr class="codeline" data-linenumber="527"><td class="num" id="LN527">527</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="528"><td class="num" id="LN528">528</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="529"><td class="num" id="LN529">529</td><td class="line">    <span class='keyword'>if</span> (!UTIL_fileExist(srcFileName)) {</td></tr>
<tr class="codeline" data-linenumber="530"><td class="num" id="LN530">530</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: can't stat %s : %s -- ignored \n"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: can't stat %s : %s -- ignored \n"<br>, srcFileName, strerror((*__errno_location ()))); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="531"><td class="num" id="LN531">531</td><td class="line">                        <span class='macro'>srcFileName, strerror(errno))<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: can't stat %s : %s -- ignored \n"<br>, srcFileName, strerror((*__errno_location ()))); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="532"><td class="num" id="LN532">532</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="533"><td class="num" id="LN533">533</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="534"><td class="num" id="LN534">534</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="535"><td class="num" id="LN535">535</td><td class="line">    <span class='keyword'>if</span> (!UTIL_isRegularFile(srcFileName)</td></tr>
<tr class="codeline" data-linenumber="536"><td class="num" id="LN536">536</td><td class="line">     &amp;&amp; !UTIL_isFIFO(srcFileName)</td></tr>
<tr class="codeline" data-linenumber="537"><td class="num" id="LN537">537</td><td class="line">    ) {</td></tr>
<tr class="codeline" data-linenumber="538"><td class="num" id="LN538">538</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s is not a regular file -- ignored \n"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s is not a regular file -- ignored \n"<br>, srcFileName); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="539"><td class="num" id="LN539">539</td><td class="line">                        <span class='macro'>srcFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s is not a regular file -- ignored \n"<br>, srcFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="540"><td class="num" id="LN540">540</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="541"><td class="num" id="LN541">541</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="542"><td class="num" id="LN542">542</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="543"><td class="num" id="LN543">543</td><td class="line">    {   FILE* <span class='keyword'>const</span> f = fopen(srcFileName, <span class='string_literal'>"rb"</span>);</td></tr>
<tr class="codeline" data-linenumber="544"><td class="num" id="LN544">544</td><td class="line">        <span class='keyword'>if</span> (f == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="545"><td class="num" id="LN545">545</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s: %s \n"</span>, srcFileName, strerror(errno))<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: %s \n"<br>, srcFileName, strerror((*__errno_location ()))); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="546"><td class="num" id="LN546">546</td><td class="line">        <span class='keyword'>return</span> f;</td></tr>
<tr class="codeline" data-linenumber="547"><td class="num" id="LN547">547</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="548"><td class="num" id="LN548">548</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="549"><td class="num" id="LN549">549</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="550"><td class="num" id="LN550">550</td><td class="line"><span class='comment'>/** FIO_openDstFile() :</span></td></tr>
<tr class="codeline" data-linenumber="551"><td class="num" id="LN551">551</td><td class="line"> <span class='comment'>*  condition : `dstFileName` must be non-NULL.</span></td></tr>
<tr class="codeline" data-linenumber="552"><td class="num" id="LN552">552</td><td class="line"> <span class='comment'>* @result : FILE* to `dstFileName`, or NULL if it fails */</span></td></tr>
<tr class="codeline" data-linenumber="553"><td class="num" id="LN553">553</td><td class="line"><span class='keyword'>static</span> FILE*</td></tr>
<tr class="codeline" data-linenumber="554"><td class="num" id="LN554">554</td><td class="line">FIO_openDstFile(FIO_prefs_t* <span class='keyword'>const</span> prefs,</td></tr>
<tr class="codeline" data-linenumber="555"><td class="num" id="LN555">555</td><td class="line">          <span class='keyword'>const</span> <span class='keyword'>char</span>* srcFileName, <span class='keyword'>const</span> <span class='keyword'>char</span>* dstFileName)</td></tr>
<tr class="codeline" data-linenumber="556"><td class="num" id="LN556">556</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="557"><td class="num" id="LN557">557</td><td class="line">    <span class='keyword'>if</span> (prefs-&gt;testMode) <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;  <span class='comment'>/* do not open file in test mode */</span></td></tr>
<tr class="codeline" data-linenumber="558"><td class="num" id="LN558">558</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="559"><td class="num" id="LN559">559</td><td class="line">    <span class='macro'>assert(dstFileName != NULL)<span class='macro_popup'>((void) sizeof ((dstFileName != ((void*)0)) ? 1 : 0), __extension__<br> ({ if (dstFileName != ((void*)0)) ; else __assert_fail ("dstFileName != NULL"<br>, "fileio.c", 559, __extension__ __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="560"><td class="num" id="LN560">560</td><td class="line">    <span class='keyword'>if</span> (!strcmp (dstFileName, <span class='macro'>stdoutmark<span class='macro_popup'>"/*stdout*\\"</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="561"><td class="num" id="LN561">561</td><td class="line">        <span class='macro'>DISPLAYLEVEL(4,<span class='string_literal'>"Using stdout for output \n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=4) { fprintf(stderr, "Using stdout for output \n"<br>); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="562"><td class="num" id="LN562">562</td><td class="line">        SET_BINARY_MODE(stdout);</td></tr>
<tr class="codeline" data-linenumber="563"><td class="num" id="LN563">563</td><td class="line">        <span class='keyword'>if</span> (prefs-&gt;sparseFileSupport == 1) {</td></tr>
<tr class="codeline" data-linenumber="564"><td class="num" id="LN564">564</td><td class="line">            prefs-&gt;sparseFileSupport = 0;</td></tr>
<tr class="codeline" data-linenumber="565"><td class="num" id="LN565">565</td><td class="line">            <span class='macro'>DISPLAYLEVEL(4, <span class='string_literal'>"Sparse File Support is automatically disabled on stdout ; try --sparse \n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=4) { fprintf(stderr, "Sparse File Support is automatically disabled on stdout ; try --sparse \n"<br>); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="566"><td class="num" id="LN566">566</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="567"><td class="num" id="LN567">567</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>stdout<span class='macro_popup'>stdout</span></span>;</td></tr>
<tr class="codeline" data-linenumber="568"><td class="num" id="LN568">568</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="569"><td class="num" id="LN569">569</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="570"><td class="num" id="LN570">570</td><td class="line">    <span class='comment'>/* ensure dst is not the same as src */</span></td></tr>
<tr class="codeline" data-linenumber="571"><td class="num" id="LN571">571</td><td class="line">    <span class='keyword'>if</span> (srcFileName != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; UTIL_isSameFile(srcFileName, dstFileName)) {</td></tr>
<tr class="codeline" data-linenumber="572"><td class="num" id="LN572">572</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: Refusing to open an output file which will overwrite the input file \n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: Refusing to open an output file which will overwrite the input file \n"<br>); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="573"><td class="num" id="LN573">573</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="574"><td class="num" id="LN574">574</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="575"><td class="num" id="LN575">575</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="576"><td class="num" id="LN576">576</td><td class="line">    <span class='keyword'>if</span> (prefs-&gt;sparseFileSupport == 1) {</td></tr>
<tr class="codeline" data-linenumber="577"><td class="num" id="LN577">577</td><td class="line">        prefs-&gt;sparseFileSupport = <span class='macro'>ZSTD_SPARSE_DEFAULT<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="578"><td class="num" id="LN578">578</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="579"><td class="num" id="LN579">579</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="580"><td class="num" id="LN580">580</td><td class="line">    <span class='keyword'>if</span> (UTIL_isRegularFile(dstFileName)) {</td></tr>
<tr class="codeline" data-linenumber="581"><td class="num" id="LN581">581</td><td class="line">        <span class='comment'>/* Check if destination file already exists */</span></td></tr>
<tr class="codeline" data-linenumber="582"><td class="num" id="LN582">582</td><td class="line">        FILE* <span class='keyword'>const</span> fCheck = fopen( dstFileName, <span class='string_literal'>"rb"</span> );</td></tr>
<tr class="codeline" data-linenumber="583"><td class="num" id="LN583">583</td><td class="line"><span class='directive'>#if !defined(_WIN32)</span></td></tr>
<tr class="codeline" data-linenumber="584"><td class="num" id="LN584">584</td><td class="line">        <span class='comment'>/* this test does not work on Windows :</span></td></tr>
<tr class="codeline" data-linenumber="585"><td class="num" id="LN585">585</td><td class="line">         <span class='comment'>* `NUL` and `nul` are detected as regular files */</span></td></tr>
<tr class="codeline" data-linenumber="586"><td class="num" id="LN586">586</td><td class="line">        <span class='keyword'>if</span> (!strcmp(dstFileName, <span class='macro'>nulmark<span class='macro_popup'>"/dev/null"</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="587"><td class="num" id="LN587">587</td><td class="line">            <span class='macro'>EXM_THROW(40, <span class='string_literal'>"%s is unexpectedly categorized as a regular file"</span>,<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 588<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 40); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s is unexpectedly categorized as a regular file"<br>, dstFileName); } }; { if (g_display_prefs.displayLevel&gt;=1<br>) { fprintf(stderr, " \n"); } }; exit(40); }</span></span></td></tr>
<tr class="codeline" data-linenumber="588"><td class="num" id="LN588">588</td><td class="line">                        <span class='macro'>dstFileName)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 588<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 40); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s is unexpectedly categorized as a regular file"<br>, dstFileName); } }; { if (g_display_prefs.displayLevel&gt;=1<br>) { fprintf(stderr, " \n"); } }; exit(40); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="589"><td class="num" id="LN589">589</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="590"><td class="num" id="LN590">590</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="591"><td class="num" id="LN591">591</td><td class="line">        <span class='keyword'>if</span> (fCheck != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {  <span class='comment'>/* dst file exists, authorization prompt */</span></td></tr>
<tr class="codeline" data-linenumber="592"><td class="num" id="LN592">592</td><td class="line">            fclose(fCheck);</td></tr>
<tr class="codeline" data-linenumber="593"><td class="num" id="LN593">593</td><td class="line">            <span class='keyword'>if</span> (!prefs-&gt;overwrite) {</td></tr>
<tr class="codeline" data-linenumber="594"><td class="num" id="LN594">594</td><td class="line">                <span class='keyword'>if</span> (g_display_prefs.displayLevel &lt;= 1) {</td></tr>
<tr class="codeline" data-linenumber="595"><td class="num" id="LN595">595</td><td class="line">                    <span class='comment'>/* No interaction possible */</span></td></tr>
<tr class="codeline" data-linenumber="596"><td class="num" id="LN596">596</td><td class="line">                    <span class='macro'>DISPLAY(<span class='string_literal'>"zstd: %s already exists; not overwritten  \n"</span>,<span class='macro_popup'>fprintf(stderr, "zstd: %s already exists; not overwritten  \n"<br>, dstFileName)</span></span></td></tr>
<tr class="codeline" data-linenumber="597"><td class="num" id="LN597">597</td><td class="line">                            <span class='macro'>dstFileName)<span class='macro_popup'>fprintf(stderr, "zstd: %s already exists; not overwritten  \n"<br>, dstFileName)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="598"><td class="num" id="LN598">598</td><td class="line">                    <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="599"><td class="num" id="LN599">599</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="600"><td class="num" id="LN600">600</td><td class="line">                <span class='macro'>DISPLAY(<span class='string_literal'>"zstd: %s already exists; overwrite (y/N) ? "</span>,<span class='macro_popup'>fprintf(stderr, "zstd: %s already exists; overwrite (y/N) ? "<br>, dstFileName)</span></span></td></tr>
<tr class="codeline" data-linenumber="601"><td class="num" id="LN601">601</td><td class="line">                        <span class='macro'>dstFileName)<span class='macro_popup'>fprintf(stderr, "zstd: %s already exists; overwrite (y/N) ? "<br>, dstFileName)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="602"><td class="num" id="LN602">602</td><td class="line">                {   <span class='keyword'>int</span> ch = getchar();</td></tr>
<tr class="codeline" data-linenumber="603"><td class="num" id="LN603">603</td><td class="line">                    <span class='keyword'>if</span> ((ch!='Y') &amp;&amp; (ch!='y')) {</td></tr>
<tr class="codeline" data-linenumber="604"><td class="num" id="LN604">604</td><td class="line">                        <span class='macro'>DISPLAY(<span class='string_literal'>"    not overwritten  \n"</span>)<span class='macro_popup'>fprintf(stderr, "    not overwritten  \n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="605"><td class="num" id="LN605">605</td><td class="line">                        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="606"><td class="num" id="LN606">606</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="607"><td class="num" id="LN607">607</td><td class="line">                    <span class='comment'>/* flush rest of input line */</span></td></tr>
<tr class="codeline" data-linenumber="608"><td class="num" id="LN608">608</td><td class="line">                    <span class='keyword'>while</span> ((ch!=<span class='macro'>EOF<span class='macro_popup'>(-1)</span></span>) &amp;&amp; (ch!='\n')) ch = getchar();</td></tr>
<tr class="codeline" data-linenumber="609"><td class="num" id="LN609">609</td><td class="line">            }   }</td></tr>
<tr class="codeline" data-linenumber="610"><td class="num" id="LN610">610</td><td class="line">            <span class='comment'>/* need to unlink */</span></td></tr>
<tr class="codeline" data-linenumber="611"><td class="num" id="LN611">611</td><td class="line">            FIO_remove(dstFileName);</td></tr>
<tr class="codeline" data-linenumber="612"><td class="num" id="LN612">612</td><td class="line">    }   }</td></tr>
<tr class="codeline" data-linenumber="613"><td class="num" id="LN613">613</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="614"><td class="num" id="LN614">614</td><td class="line">    {   FILE* <span class='keyword'>const</span> f = fopen( dstFileName, <span class='string_literal'>"wb"</span> );</td></tr>
<tr class="codeline" data-linenumber="615"><td class="num" id="LN615">615</td><td class="line">        <span class='keyword'>if</span> (f == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="616"><td class="num" id="LN616">616</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s: %s\n"</span>, dstFileName, strerror(errno))<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: %s\n"<br>, dstFileName, strerror((*__errno_location ()))); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="617"><td class="num" id="LN617">617</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (srcFileName != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="618"><td class="num" id="LN618">618</td><td class="line">               &amp;&amp; strcmp (srcFileName, <span class='macro'>stdinmark<span class='macro_popup'>"/*stdin*\\"</span></span>)</td></tr>
<tr class="codeline" data-linenumber="619"><td class="num" id="LN619">619</td><td class="line">               &amp;&amp; strcmp(dstFileName, <span class='macro'>nulmark<span class='macro_popup'>"/dev/null"</span></span>) ) {</td></tr>
<tr class="codeline" data-linenumber="620"><td class="num" id="LN620">620</td><td class="line">            <span class='comment'>/* reduce rights on newly created dst file while compression is ongoing */</span></td></tr>
<tr class="codeline" data-linenumber="621"><td class="num" id="LN621">621</td><td class="line">            UTIL_chmod(dstFileName, 00600);</td></tr>
<tr class="codeline" data-linenumber="622"><td class="num" id="LN622">622</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="623"><td class="num" id="LN623">623</td><td class="line">        <span class='keyword'>return</span> f;</td></tr>
<tr class="codeline" data-linenumber="624"><td class="num" id="LN624">624</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="625"><td class="num" id="LN625">625</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="626"><td class="num" id="LN626">626</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="627"><td class="num" id="LN627">627</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="628"><td class="num" id="LN628">628</td><td class="line"><span class='comment'>/*! FIO_createDictBuffer() :</span></td></tr>
<tr class="codeline" data-linenumber="629"><td class="num" id="LN629">629</td><td class="line"> <span class='comment'>*  creates a buffer, pointed by `*bufferPtr`,</span></td></tr>
<tr class="codeline" data-linenumber="630"><td class="num" id="LN630">630</td><td class="line"> <span class='comment'>*  loads `filename` content into it, up to DICTSIZE_MAX bytes.</span></td></tr>
<tr class="codeline" data-linenumber="631"><td class="num" id="LN631">631</td><td class="line"> <span class='comment'>* @return : loaded size</span></td></tr>
<tr class="codeline" data-linenumber="632"><td class="num" id="LN632">632</td><td class="line"> <span class='comment'>*  if fileName==NULL, returns 0 and a NULL pointer</span></td></tr>
<tr class="codeline" data-linenumber="633"><td class="num" id="LN633">633</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="634"><td class="num" id="LN634">634</td><td class="line"><span class='keyword'>static</span> size_t FIO_createDictBuffer(<span class='keyword'>void</span>** bufferPtr, <span class='keyword'>const</span> <span class='keyword'>char</span>* fileName, FIO_prefs_t* <span class='keyword'>const</span> prefs)</td></tr>
<tr class="codeline" data-linenumber="635"><td class="num" id="LN635">635</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="636"><td class="num" id="LN636">636</td><td class="line">    FILE* fileHandle;</td></tr>
<tr class="codeline" data-linenumber="637"><td class="num" id="LN637">637</td><td class="line">    U64 fileSize;</td></tr>
<tr class="codeline" data-linenumber="638"><td class="num" id="LN638">638</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="639"><td class="num" id="LN639">639</td><td class="line">    <span class='macro'>assert(bufferPtr != NULL)<span class='macro_popup'>((void) sizeof ((bufferPtr != ((void*)0)) ? 1 : 0), __extension__<br> ({ if (bufferPtr != ((void*)0)) ; else __assert_fail ("bufferPtr != NULL"<br>, "fileio.c", 639, __extension__ __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="640"><td class="num" id="LN640">640</td><td class="line">    *bufferPtr = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="641"><td class="num" id="LN641">641</td><td class="line">    <span class='keyword'>if</span> (fileName == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="642"><td class="num" id="LN642">642</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="643"><td class="num" id="LN643">643</td><td class="line">    <span class='macro'>DISPLAYLEVEL(4,<span class='string_literal'>"Loading %s as dictionary \n"</span>, fileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=4) { fprintf(stderr, "Loading %s as dictionary \n"<br>, fileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="644"><td class="num" id="LN644">644</td><td class="line">    fileHandle = fopen(fileName, <span class='string_literal'>"rb"</span>);</td></tr>
<tr class="codeline" data-linenumber="645"><td class="num" id="LN645">645</td><td class="line">    <span class='keyword'>if</span> (fileHandle==<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='macro'>EXM_THROW(31, <span class='string_literal'>"%s: %s"</span>, fileName, strerror(errno))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 645<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 31); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s: %s", fileName, strerror((*__errno_location<br> ()))); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, " \n"); } }; exit(31); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="646"><td class="num" id="LN646">646</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="647"><td class="num" id="LN647">647</td><td class="line">    fileSize = UTIL_getFileSize(fileName);</td></tr>
<tr class="codeline" data-linenumber="648"><td class="num" id="LN648">648</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="649"><td class="num" id="LN649">649</td><td class="line">        size_t <span class='keyword'>const</span> dictSizeMax = prefs-&gt;patchFromMode ? prefs-&gt;memLimit : <span class='macro'>DICTSIZE_MAX<span class='macro_popup'>(32 *(1 &lt;&lt;20))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="650"><td class="num" id="LN650">650</td><td class="line">        <span class='keyword'>if</span> (fileSize &gt;  dictSizeMax) {</td></tr>
<tr class="codeline" data-linenumber="651"><td class="num" id="LN651">651</td><td class="line">            <span class='macro'>EXM_THROW(32, <span class='string_literal'>"Dictionary file %s is too large (&gt; %u bytes)"</span>,<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 652<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 32); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Dictionary file %s is too large (&gt; %u bytes)"<br>, fileName, (unsigned)dictSizeMax); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(32);<br> }</span></span></td></tr>
<tr class="codeline" data-linenumber="652"><td class="num" id="LN652">652</td><td class="line">                            <span class='macro'>fileName,  (<span class='keyword'>unsigned</span>)dictSizeMax)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 652<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 32); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Dictionary file %s is too large (&gt; %u bytes)"<br>, fileName, (unsigned)dictSizeMax); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(32);<br> }</span></span>;   <span class='comment'>/* avoid extreme cases */</span></td></tr>
<tr class="codeline" data-linenumber="653"><td class="num" id="LN653">653</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="654"><td class="num" id="LN654">654</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="655"><td class="num" id="LN655">655</td><td class="line">    *bufferPtr = malloc((size_t)fileSize);</td></tr>
<tr class="codeline" data-linenumber="656"><td class="num" id="LN656">656</td><td class="line">    <span class='keyword'>if</span> (*bufferPtr==<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='macro'>EXM_THROW(34, <span class='string_literal'>"%s"</span>, strerror(errno))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 656<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 34); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", strerror((*__errno_location (<br>)))); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, " \n"); } }; exit(34); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="657"><td class="num" id="LN657">657</td><td class="line">    {   size_t <span class='keyword'>const</span> readSize = fread(*bufferPtr, 1, (size_t)fileSize, fileHandle);</td></tr>
<tr class="codeline" data-linenumber="658"><td class="num" id="LN658">658</td><td class="line">        <span class='keyword'>if</span> (readSize != fileSize)</td></tr>
<tr class="codeline" data-linenumber="659"><td class="num" id="LN659">659</td><td class="line">            <span class='macro'>EXM_THROW(35, <span class='string_literal'>"Error reading dictionary file %s : %s"</span>,<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 660<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 35); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Error reading dictionary file %s : %s"<br>, fileName, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(35);<br> }</span></span></td></tr>
<tr class="codeline" data-linenumber="660"><td class="num" id="LN660">660</td><td class="line">                    <span class='macro'>fileName, strerror(errno))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 660<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 35); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Error reading dictionary file %s : %s"<br>, fileName, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(35);<br> }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="661"><td class="num" id="LN661">661</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="662"><td class="num" id="LN662">662</td><td class="line">    fclose(fileHandle);</td></tr>
<tr class="codeline" data-linenumber="663"><td class="num" id="LN663">663</td><td class="line">    <span class='keyword'>return</span> (size_t)fileSize;</td></tr>
<tr class="codeline" data-linenumber="664"><td class="num" id="LN664">664</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="665"><td class="num" id="LN665">665</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="666"><td class="num" id="LN666">666</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="667"><td class="num" id="LN667">667</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="668"><td class="num" id="LN668">668</td><td class="line"><span class='comment'>/* FIO_checkFilenameCollisions() :</span></td></tr>
<tr class="codeline" data-linenumber="669"><td class="num" id="LN669">669</td><td class="line"> <span class='comment'>* Checks for and warns if there are any files that would have the same output path</span></td></tr>
<tr class="codeline" data-linenumber="670"><td class="num" id="LN670">670</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="671"><td class="num" id="LN671">671</td><td class="line"><span class='keyword'>int</span> FIO_checkFilenameCollisions(<span class='keyword'>const</span> <span class='keyword'>char</span>** filenameTable, <span class='keyword'>unsigned</span> nbFiles) {</td></tr>
<tr class="codeline" data-linenumber="672"><td class="num" id="LN672">672</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span> **filenameTableSorted, *c, *prevElem, *filename;</td></tr>
<tr class="codeline" data-linenumber="673"><td class="num" id="LN673">673</td><td class="line">    <span class='keyword'>unsigned</span> u;</td></tr>
<tr class="codeline" data-linenumber="674"><td class="num" id="LN674">674</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="675"><td class="num" id="LN675">675</td><td class="line">    <span class='directive'>#if defined(_MSC_VER) || defined(__MINGW32__) || defined (__MSVCRT__) /* windows support */</span></td></tr>
<tr class="codeline" data-linenumber="676"><td class="num" id="LN676">676</td><td class="line">    c = <span class='string_literal'>"\\"</span>;</td></tr>
<tr class="codeline" data-linenumber="677"><td class="num" id="LN677">677</td><td class="line">    <span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="678"><td class="num" id="LN678">678</td><td class="line">    c = <span class='string_literal'>"/"</span>;</td></tr>
<tr class="codeline" data-linenumber="679"><td class="num" id="LN679">679</td><td class="line">    <span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="680"><td class="num" id="LN680">680</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="681"><td class="num" id="LN681">681</td><td class="line">    filenameTableSorted = (<span class='keyword'>const</span> <span class='keyword'>char</span>**) malloc(<span class='keyword'>sizeof</span>(<span class='keyword'>char</span>*) * nbFiles);</td></tr>
<tr class="codeline" data-linenumber="682"><td class="num" id="LN682">682</td><td class="line">    <span class='keyword'>if</span> (!filenameTableSorted) {</td></tr>
<tr class="codeline" data-linenumber="683"><td class="num" id="LN683">683</td><td class="line">        <span class='macro'>DISPLAY(<span class='string_literal'>"Unable to malloc new str array, not checking for name collisions\n"</span>)<span class='macro_popup'>fprintf(stderr, "Unable to malloc new str array, not checking for name collisions\n"<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="684"><td class="num" id="LN684">684</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="685"><td class="num" id="LN685">685</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="686"><td class="num" id="LN686">686</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="687"><td class="num" id="LN687">687</td><td class="line">    <span class='keyword'>for</span> (u = 0; u &lt; nbFiles; ++u) {</td></tr>
<tr class="codeline" data-linenumber="688"><td class="num" id="LN688">688</td><td class="line">        filename = strrchr(filenameTable[u], c[0]);</td></tr>
<tr class="codeline" data-linenumber="689"><td class="num" id="LN689">689</td><td class="line">        <span class='keyword'>if</span> (filename == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="690"><td class="num" id="LN690">690</td><td class="line">            filenameTableSorted[u] = filenameTable[u];</td></tr>
<tr class="codeline" data-linenumber="691"><td class="num" id="LN691">691</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="692"><td class="num" id="LN692">692</td><td class="line">            filenameTableSorted[u] = filename+1;</td></tr>
<tr class="codeline" data-linenumber="693"><td class="num" id="LN693">693</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="694"><td class="num" id="LN694">694</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="695"><td class="num" id="LN695">695</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="696"><td class="num" id="LN696">696</td><td class="line">    qsort((<span class='keyword'>void</span>*)filenameTableSorted, nbFiles, <span class='keyword'>sizeof</span>(<span class='keyword'>char</span>*), UTIL_compareStr);</td></tr>
<tr class="codeline" data-linenumber="697"><td class="num" id="LN697">697</td><td class="line">    prevElem = filenameTableSorted[0];</td></tr>
<tr class="codeline" data-linenumber="698"><td class="num" id="LN698">698</td><td class="line">    <span class='keyword'>for</span> (u = 1; u &lt; nbFiles; ++u) {</td></tr>
<tr class="codeline" data-linenumber="699"><td class="num" id="LN699">699</td><td class="line">        <span class='keyword'>if</span> (strcmp(prevElem, filenameTableSorted[u]) == 0) {</td></tr>
<tr class="codeline" data-linenumber="700"><td class="num" id="LN700">700</td><td class="line">            <span class='macro'>DISPLAY(<span class='string_literal'>"WARNING: Two files have same filename: %s\n"</span>, prevElem)<span class='macro_popup'>fprintf(stderr, "WARNING: Two files have same filename: %s\n"<br>, prevElem)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="701"><td class="num" id="LN701">701</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="702"><td class="num" id="LN702">702</td><td class="line">        prevElem = filenameTableSorted[u];</td></tr>
<tr class="codeline" data-linenumber="703"><td class="num" id="LN703">703</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="704"><td class="num" id="LN704">704</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="705"><td class="num" id="LN705">705</td><td class="line">    free((<span class='keyword'>void</span>*)filenameTableSorted);</td></tr>
<tr class="codeline" data-linenumber="706"><td class="num" id="LN706">706</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="707"><td class="num" id="LN707">707</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="708"><td class="num" id="LN708">708</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="709"><td class="num" id="LN709">709</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span>*</td></tr>
<tr class="codeline" data-linenumber="710"><td class="num" id="LN710">710</td><td class="line">extractFilename(<span class='keyword'>const</span> <span class='keyword'>char</span>* path, <span class='keyword'>char</span> separator)</td></tr>
<tr class="codeline" data-linenumber="711"><td class="num" id="LN711">711</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="712"><td class="num" id="LN712">712</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span>* search = strrchr(path, separator);</td></tr>
<tr class="codeline" data-linenumber="713"><td class="num" id="LN713">713</td><td class="line">    <span class='keyword'>if</span> (search == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span> path;</td></tr>
<tr class="codeline" data-linenumber="714"><td class="num" id="LN714">714</td><td class="line">    <span class='keyword'>return</span> search+1;</td></tr>
<tr class="codeline" data-linenumber="715"><td class="num" id="LN715">715</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="716"><td class="num" id="LN716">716</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="717"><td class="num" id="LN717">717</td><td class="line"><span class='comment'>/* FIO_createFilename_fromOutDir() :</span></td></tr>
<tr class="codeline" data-linenumber="718"><td class="num" id="LN718">718</td><td class="line"> <span class='comment'>* Takes a source file name and specified output directory, and</span></td></tr>
<tr class="codeline" data-linenumber="719"><td class="num" id="LN719">719</td><td class="line"> <span class='comment'>* allocates memory for and returns a pointer to final path.</span></td></tr>
<tr class="codeline" data-linenumber="720"><td class="num" id="LN720">720</td><td class="line"> <span class='comment'>* This function never returns an error (it may abort() in case of pb)</span></td></tr>
<tr class="codeline" data-linenumber="721"><td class="num" id="LN721">721</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="722"><td class="num" id="LN722">722</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>char</span>*</td></tr>
<tr class="codeline" data-linenumber="723"><td class="num" id="LN723">723</td><td class="line">FIO_createFilename_fromOutDir(<span class='keyword'>const</span> <span class='keyword'>char</span>* path, <span class='keyword'>const</span> <span class='keyword'>char</span>* outDirName, <span class='keyword'>const</span> size_t suffixLen)</td></tr>
<tr class="codeline" data-linenumber="724"><td class="num" id="LN724">724</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="725"><td class="num" id="LN725">725</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span>* filenameStart;</td></tr>
<tr class="codeline" data-linenumber="726"><td class="num" id="LN726">726</td><td class="line">    <span class='keyword'>char</span> separator;</td></tr>
<tr class="codeline" data-linenumber="727"><td class="num" id="LN727">727</td><td class="line">    <span class='keyword'>char</span>* result;</td></tr>
<tr class="codeline" data-linenumber="728"><td class="num" id="LN728">728</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="729"><td class="num" id="LN729">729</td><td class="line"><span class='directive'>#if defined(_MSC_VER) || defined(__MINGW32__) || defined (__MSVCRT__) /* windows support */</span></td></tr>
<tr class="codeline" data-linenumber="730"><td class="num" id="LN730">730</td><td class="line">    separator = '\\';</td></tr>
<tr class="codeline" data-linenumber="731"><td class="num" id="LN731">731</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="732"><td class="num" id="LN732">732</td><td class="line">    separator = '/';</td></tr>
<tr class="codeline" data-linenumber="733"><td class="num" id="LN733">733</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="734"><td class="num" id="LN734">734</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="735"><td class="num" id="LN735">735</td><td class="line">    filenameStart = extractFilename(path, separator);</td></tr>
<tr class="codeline" data-linenumber="736"><td class="num" id="LN736">736</td><td class="line"><span class='directive'>#if defined(_MSC_VER) || defined(__MINGW32__) || defined (__MSVCRT__) /* windows support */</span></td></tr>
<tr class="codeline" data-linenumber="737"><td class="num" id="LN737">737</td><td class="line">    filenameStart = extractFilename(filenameStart, '/');  <span class='comment'>/* sometimes, '/' separator is also used on Windows (mingw+msys2) */</span></td></tr>
<tr class="codeline" data-linenumber="738"><td class="num" id="LN738">738</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="739"><td class="num" id="LN739">739</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="740"><td class="num" id="LN740">740</td><td class="line">    result = (<span class='keyword'>char</span>*) calloc(1, strlen(outDirName) + 1 + strlen(filenameStart) + suffixLen + 1);</td></tr>
<tr class="codeline" data-linenumber="741"><td class="num" id="LN741">741</td><td class="line">    <span class='keyword'>if</span> (!result) {</td></tr>
<tr class="codeline" data-linenumber="742"><td class="num" id="LN742">742</td><td class="line">        <span class='macro'>EXM_THROW(30, <span class='string_literal'>"zstd: FIO_createFilename_fromOutDir: %s"</span>, strerror(errno))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 742<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 30); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "zstd: FIO_createFilename_fromOutDir: %s"<br>, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(30);<br> }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="743"><td class="num" id="LN743">743</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="744"><td class="num" id="LN744">744</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="745"><td class="num" id="LN745">745</td><td class="line">    memcpy(result, outDirName, strlen(outDirName));</td></tr>
<tr class="codeline" data-linenumber="746"><td class="num" id="LN746">746</td><td class="line">    <span class='keyword'>if</span> (outDirName[strlen(outDirName)-1] == separator) {</td></tr>
<tr class="codeline" data-linenumber="747"><td class="num" id="LN747">747</td><td class="line">        memcpy(result + strlen(outDirName), filenameStart, strlen(filenameStart));</td></tr>
<tr class="codeline" data-linenumber="748"><td class="num" id="LN748">748</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="749"><td class="num" id="LN749">749</td><td class="line">        memcpy(result + strlen(outDirName), &amp;separator, 1);</td></tr>
<tr class="codeline" data-linenumber="750"><td class="num" id="LN750">750</td><td class="line">        memcpy(result + strlen(outDirName) + 1, filenameStart, strlen(filenameStart));</td></tr>
<tr class="codeline" data-linenumber="751"><td class="num" id="LN751">751</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="752"><td class="num" id="LN752">752</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="753"><td class="num" id="LN753">753</td><td class="line">    <span class='keyword'>return</span> result;</td></tr>
<tr class="codeline" data-linenumber="754"><td class="num" id="LN754">754</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="755"><td class="num" id="LN755">755</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="756"><td class="num" id="LN756">756</td><td class="line"><span class='comment'>/* FIO_highbit64() :</span></td></tr>
<tr class="codeline" data-linenumber="757"><td class="num" id="LN757">757</td><td class="line"> <span class='comment'>* gives position of highest bit.</span></td></tr>
<tr class="codeline" data-linenumber="758"><td class="num" id="LN758">758</td><td class="line"> <span class='comment'>* note : only works for v &gt; 0 !</span></td></tr>
<tr class="codeline" data-linenumber="759"><td class="num" id="LN759">759</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="760"><td class="num" id="LN760">760</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> FIO_highbit64(<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> v)</td></tr>
<tr class="codeline" data-linenumber="761"><td class="num" id="LN761">761</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="762"><td class="num" id="LN762">762</td><td class="line">    <span class='keyword'>unsigned</span> count = 0;</td></tr>
<tr class="codeline" data-linenumber="763"><td class="num" id="LN763">763</td><td class="line">    <span class='macro'>assert(v != 0)<span class='macro_popup'>((void) sizeof ((v != 0) ? 1 : 0), __extension__ ({ if (v != 0<br>) ; else __assert_fail ("v != 0", "fileio.c", 763, __extension__<br> __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="764"><td class="num" id="LN764">764</td><td class="line">    v &gt;&gt;= 1;</td></tr>
<tr class="codeline" data-linenumber="765"><td class="num" id="LN765">765</td><td class="line">    <span class='keyword'>while</span> (v) { v &gt;&gt;= 1; count++; }</td></tr>
<tr class="codeline" data-linenumber="766"><td class="num" id="LN766">766</td><td class="line">    <span class='keyword'>return</span> count;</td></tr>
<tr class="codeline" data-linenumber="767"><td class="num" id="LN767">767</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="768"><td class="num" id="LN768">768</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="769"><td class="num" id="LN769">769</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> FIO_adjustMemLimitForPatchFromMode(FIO_prefs_t* <span class='keyword'>const</span> prefs,</td></tr>
<tr class="codeline" data-linenumber="770"><td class="num" id="LN770">770</td><td class="line">                                    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> <span class='keyword'>const</span> dictSize,</td></tr>
<tr class="codeline" data-linenumber="771"><td class="num" id="LN771">771</td><td class="line">                                    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> <span class='keyword'>const</span> maxSrcFileSize)</td></tr>
<tr class="codeline" data-linenumber="772"><td class="num" id="LN772">772</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="773"><td class="num" id="LN773">773</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> maxSize = <span class='macro'>MAX(prefs-&gt;memLimit, MAX(dictSize, maxSrcFileSize))<span class='macro_popup'>((prefs-&gt;memLimit)&gt;(((dictSize)&gt;(maxSrcFileSize) ? (<br>dictSize) : (maxSrcFileSize))) ? (prefs-&gt;memLimit) : (((dictSize<br>)&gt;(maxSrcFileSize) ? (dictSize) : (maxSrcFileSize))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="774"><td class="num" id="LN774">774</td><td class="line">    <span class='macro'>assert(maxSize != UTIL_FILESIZE_UNKNOWN)<span class='macro_popup'>((void) sizeof ((maxSize != ((U64)(-1))) ? 1 : 0), __extension__<br> ({ if (maxSize != ((U64)(-1))) ; else __assert_fail ("maxSize != UTIL_FILESIZE_UNKNOWN"<br>, "fileio.c", 774, __extension__ __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="775"><td class="num" id="LN775">775</td><td class="line">    <span class='keyword'>if</span> (maxSize &gt; <span class='macro'>UINT_MAX<span class='macro_popup'>(2147483647 *2U +1U)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="776"><td class="num" id="LN776">776</td><td class="line">        <span class='macro'>EXM_THROW(42, <span class='string_literal'>"Can't handle files larger than %u GB\n"</span>, UINT_MAX/(1 GB) + 1)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 776<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 42); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Can't handle files larger than %u GB\n"<br>, (2147483647 *2U +1U)/(1 *(1U&lt;&lt;30)) + 1); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(42);<br> }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="777"><td class="num" id="LN777">777</td><td class="line">    FIO_setMemLimit(prefs, (<span class='keyword'>unsigned</span>)maxSize);</td></tr>
<tr class="codeline" data-linenumber="778"><td class="num" id="LN778">778</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="779"><td class="num" id="LN779">779</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="780"><td class="num" id="LN780">780</td><td class="line"><span class='directive'>#ifndef ZSTD_NOCOMPRESS</span></td></tr>
<tr class="codeline" data-linenumber="781"><td class="num" id="LN781">781</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="782"><td class="num" id="LN782">782</td><td class="line"><span class='comment'>/* **********************************************************************</span></td></tr>
<tr class="codeline" data-linenumber="783"><td class="num" id="LN783">783</td><td class="line"> <span class='comment'>*  Compression</span></td></tr>
<tr class="codeline" data-linenumber="784"><td class="num" id="LN784">784</td><td class="line"> <span class='comment'>************************************************************************/</span></td></tr>
<tr class="codeline" data-linenumber="785"><td class="num" id="LN785">785</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> {</td></tr>
<tr class="codeline" data-linenumber="786"><td class="num" id="LN786">786</td><td class="line">    FILE* srcFile;</td></tr>
<tr class="codeline" data-linenumber="787"><td class="num" id="LN787">787</td><td class="line">    FILE* dstFile;</td></tr>
<tr class="codeline" data-linenumber="788"><td class="num" id="LN788">788</td><td class="line">    <span class='keyword'>void</span>*  srcBuffer;</td></tr>
<tr class="codeline" data-linenumber="789"><td class="num" id="LN789">789</td><td class="line">    size_t srcBufferSize;</td></tr>
<tr class="codeline" data-linenumber="790"><td class="num" id="LN790">790</td><td class="line">    <span class='keyword'>void</span>*  dstBuffer;</td></tr>
<tr class="codeline" data-linenumber="791"><td class="num" id="LN791">791</td><td class="line">    size_t dstBufferSize;</td></tr>
<tr class="codeline" data-linenumber="792"><td class="num" id="LN792">792</td><td class="line">    <span class='keyword'>void</span>* dictBuffer;</td></tr>
<tr class="codeline" data-linenumber="793"><td class="num" id="LN793">793</td><td class="line">    size_t dictBufferSize;</td></tr>
<tr class="codeline" data-linenumber="794"><td class="num" id="LN794">794</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span>* dictFileName;</td></tr>
<tr class="codeline" data-linenumber="795"><td class="num" id="LN795">795</td><td class="line">    ZSTD_CStream* cctx;</td></tr>
<tr class="codeline" data-linenumber="796"><td class="num" id="LN796">796</td><td class="line">} cRess_t;</td></tr>
<tr class="codeline" data-linenumber="797"><td class="num" id="LN797">797</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="798"><td class="num" id="LN798">798</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> FIO_adjustParamsForPatchFromMode(FIO_prefs_t* <span class='keyword'>const</span> prefs,</td></tr>
<tr class="codeline" data-linenumber="799"><td class="num" id="LN799">799</td><td class="line">                                    ZSTD_compressionParameters* comprParams,</td></tr>
<tr class="codeline" data-linenumber="800"><td class="num" id="LN800">800</td><td class="line">                                    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> <span class='keyword'>const</span> dictSize,</td></tr>
<tr class="codeline" data-linenumber="801"><td class="num" id="LN801">801</td><td class="line">                                    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> <span class='keyword'>const</span> maxSrcFileSize,</td></tr>
<tr class="codeline" data-linenumber="802"><td class="num" id="LN802">802</td><td class="line">                                    <span class='keyword'>int</span> cLevel)</td></tr>
<tr class="codeline" data-linenumber="803"><td class="num" id="LN803">803</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="804"><td class="num" id="LN804">804</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>const</span> fileWindowLog = FIO_highbit64(maxSrcFileSize) + 1;</td></tr>
<tr class="codeline" data-linenumber="805"><td class="num" id="LN805">805</td><td class="line">    ZSTD_compressionParameters <span class='keyword'>const</span> cParams = ZSTD_getCParams(cLevel, (size_t)maxSrcFileSize, (size_t)dictSize);</td></tr>
<tr class="codeline" data-linenumber="806"><td class="num" id="LN806">806</td><td class="line">    FIO_adjustMemLimitForPatchFromMode(prefs, dictSize, maxSrcFileSize);</td></tr>
<tr class="codeline" data-linenumber="807"><td class="num" id="LN807">807</td><td class="line">    <span class='keyword'>if</span> (fileWindowLog &gt; <span class='macro'>ZSTD_WINDOWLOG_MAX<span class='macro_popup'>((int)(sizeof(size_t) == 4 ? 30 : 31))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="808"><td class="num" id="LN808">808</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"Max window log exceeded by file (compression ratio will suffer)\n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "Max window log exceeded by file (compression ratio will suffer)\n"<br>); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="809"><td class="num" id="LN809">809</td><td class="line">    comprParams-&gt;windowLog = <span class='macro'>MIN(ZSTD_WINDOWLOG_MAX, fileWindowLog)<span class='macro_popup'>((((int)(sizeof(size_t) == 4 ? 30 : 31))) &lt; (fileWindowLog<br>) ? (((int)(sizeof(size_t) == 4 ? 30 : 31))) : (fileWindowLog<br>))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="810"><td class="num" id="LN810">810</td><td class="line">    <span class='keyword'>if</span> (fileWindowLog &gt; ZSTD_cycleLog(cParams.hashLog, cParams.strategy)) {</td></tr>
<tr class="codeline" data-linenumber="811"><td class="num" id="LN811">811</td><td class="line">        <span class='keyword'>if</span> (!prefs-&gt;ldmFlag)</td></tr>
<tr class="codeline" data-linenumber="812"><td class="num" id="LN812">812</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"long mode automaticaly triggered\n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "long mode automaticaly triggered\n"<br>); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="813"><td class="num" id="LN813">813</td><td class="line">        FIO_setLdmFlag(prefs, 1);</td></tr>
<tr class="codeline" data-linenumber="814"><td class="num" id="LN814">814</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="815"><td class="num" id="LN815">815</td><td class="line">    <span class='keyword'>if</span> (cParams.strategy &gt;= ZSTD_btopt) {</td></tr>
<tr class="codeline" data-linenumber="816"><td class="num" id="LN816">816</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"[Optimal parser notes] Consider the following to improve patch size at the cost of speed:\n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "[Optimal parser notes] Consider the following to improve patch size at the cost of speed:\n"<br>); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="817"><td class="num" id="LN817">817</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"- Use --single-thread mode in the zstd cli\n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "- Use --single-thread mode in the zstd cli\n"<br>); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="818"><td class="num" id="LN818">818</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"- Set a larger targetLength (eg. --zstd=targetLength=4096)\n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "- Set a larger targetLength (eg. --zstd=targetLength=4096)\n"<br>); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="819"><td class="num" id="LN819">819</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"- Set a larger chainLog (eg. --zstd=chainLog=%u)\n"</span>, ZSTD_CHAINLOG_MAX)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "- Set a larger chainLog (eg. --zstd=chainLog=%u)\n"<br>, ((int)(sizeof(size_t) == 4 ? 29 : 30))); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="820"><td class="num" id="LN820">820</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"Also consdier playing around with searchLog and hashLog\n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "Also consdier playing around with searchLog and hashLog\n"<br>); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="821"><td class="num" id="LN821">821</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="822"><td class="num" id="LN822">822</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="823"><td class="num" id="LN823">823</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="824"><td class="num" id="LN824">824</td><td class="line"><span class='keyword'>static</span> cRess_t FIO_createCResources(FIO_prefs_t* <span class='keyword'>const</span> prefs,</td></tr>
<tr class="codeline" data-linenumber="825"><td class="num" id="LN825">825</td><td class="line">                                    <span class='keyword'>const</span> <span class='keyword'>char</span>* dictFileName, <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> <span class='keyword'>const</span> maxSrcFileSize,</td></tr>
<tr class="codeline" data-linenumber="826"><td class="num" id="LN826">826</td><td class="line">                                    <span class='keyword'>int</span> cLevel, ZSTD_compressionParameters comprParams) {</td></tr>
<tr class="codeline" data-linenumber="827"><td class="num" id="LN827">827</td><td class="line">    cRess_t ress;</td></tr>
<tr class="codeline" data-linenumber="828"><td class="num" id="LN828">828</td><td class="line">    memset(&amp;ress, 0, <span class='keyword'>sizeof</span>(ress));</td></tr>
<tr class="codeline" data-linenumber="829"><td class="num" id="LN829">829</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="830"><td class="num" id="LN830">830</td><td class="line">    <span class='macro'>DISPLAYLEVEL(6, <span class='string_literal'>"FIO_createCResources \n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=6) { fprintf(stderr, "FIO_createCResources \n"<br>); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="831"><td class="num" id="LN831">831</td><td class="line">    ress.cctx = ZSTD_createCCtx();</td></tr>
<tr class="codeline" data-linenumber="832"><td class="num" id="LN832">832</td><td class="line">    <span class='keyword'>if</span> (ress.cctx == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="833"><td class="num" id="LN833">833</td><td class="line">        <span class='macro'>EXM_THROW(30, <span class='string_literal'>"allocation error (%s): can't create ZSTD_CCtx"</span>,<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 834<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 30); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "allocation error (%s): can't create ZSTD_CCtx"<br>, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(30);<br> }</span></span></td></tr>
<tr class="codeline" data-linenumber="834"><td class="num" id="LN834">834</td><td class="line">                    <span class='macro'>strerror(errno))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 834<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 30); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "allocation error (%s): can't create ZSTD_CCtx"<br>, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(30);<br> }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="835"><td class="num" id="LN835">835</td><td class="line">    ress.srcBufferSize = ZSTD_CStreamInSize();</td></tr>
<tr class="codeline" data-linenumber="836"><td class="num" id="LN836">836</td><td class="line">    ress.srcBuffer = malloc(ress.srcBufferSize);</td></tr>
<tr class="codeline" data-linenumber="837"><td class="num" id="LN837">837</td><td class="line">    ress.dstBufferSize = ZSTD_CStreamOutSize();</td></tr>
<tr class="codeline" data-linenumber="838"><td class="num" id="LN838">838</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="839"><td class="num" id="LN839">839</td><td class="line">    <span class='comment'>/* need to update memLimit before calling createDictBuffer</span></td></tr>
<tr class="codeline" data-linenumber="840"><td class="num" id="LN840">840</td><td class="line">     <span class='comment'>* because of memLimit check inside it */</span></td></tr>
<tr class="codeline" data-linenumber="841"><td class="num" id="LN841">841</td><td class="line">    <span class='keyword'>if</span> (prefs-&gt;patchFromMode)</td></tr>
<tr class="codeline" data-linenumber="842"><td class="num" id="LN842">842</td><td class="line">        FIO_adjustParamsForPatchFromMode(prefs, &amp;comprParams, UTIL_getFileSize(dictFileName), maxSrcFileSize, cLevel);</td></tr>
<tr class="codeline" data-linenumber="843"><td class="num" id="LN843">843</td><td class="line">    ress.dstBuffer = malloc(ress.dstBufferSize);</td></tr>
<tr class="codeline" data-linenumber="844"><td class="num" id="LN844">844</td><td class="line">    ress.dictBufferSize = FIO_createDictBuffer(&amp;ress.dictBuffer, dictFileName, prefs);   <span class='comment'>/* works with dictFileName==NULL */</span></td></tr>
<tr class="codeline" data-linenumber="845"><td class="num" id="LN845">845</td><td class="line">    <span class='keyword'>if</span> (!ress.srcBuffer || !ress.dstBuffer)</td></tr>
<tr class="codeline" data-linenumber="846"><td class="num" id="LN846">846</td><td class="line">        <span class='macro'>EXM_THROW(31, <span class='string_literal'>"allocation error : not enough memory"</span>)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 846<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 31); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "allocation error : not enough memory"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; exit(31); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="847"><td class="num" id="LN847">847</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="848"><td class="num" id="LN848">848</td><td class="line">    <span class='comment'>/* Advanced parameters, including dictionary */</span></td></tr>
<tr class="codeline" data-linenumber="849"><td class="num" id="LN849">849</td><td class="line">    <span class='keyword'>if</span> (dictFileName &amp;&amp; (ress.dictBuffer==<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="850"><td class="num" id="LN850">850</td><td class="line">        <span class='macro'>EXM_THROW(32, <span class='string_literal'>"allocation error : can't create dictBuffer"</span>)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 850<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 32); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "allocation error : can't create dictBuffer"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; exit(32); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="851"><td class="num" id="LN851">851</td><td class="line">    ress.dictFileName = dictFileName;</td></tr>
<tr class="codeline" data-linenumber="852"><td class="num" id="LN852">852</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="853"><td class="num" id="LN853">853</td><td class="line">    <span class='keyword'>if</span> (prefs-&gt;adaptiveMode &amp;&amp; !prefs-&gt;ldmFlag &amp;&amp; !comprParams.windowLog)</td></tr>
<tr class="codeline" data-linenumber="854"><td class="num" id="LN854">854</td><td class="line">        comprParams.windowLog = <span class='macro'>ADAPT_WINDOWLOG_DEFAULT<span class='macro_popup'>23</span></span>;</td></tr>
<tr class="codeline" data-linenumber="855"><td class="num" id="LN855">855</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="856"><td class="num" id="LN856">856</td><td class="line">    <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_contentSizeFlag, prefs-&gt;contentSize) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_contentSizeFlag<br>, prefs-&gt;contentSize); if (ERR_isError(err)) { { if (g_display_prefs<br>.displayLevel&gt;=5) { fprintf(stderr, "%s \n", "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_contentSizeFlag, prefs-&gt;contentSize)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 856); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;  <span class='comment'>/* always enable content size when available (note: supposed to be default) */</span></td></tr>
<tr class="codeline" data-linenumber="857"><td class="num" id="LN857">857</td><td class="line">    <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_dictIDFlag, prefs-&gt;dictIDFlag) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_dictIDFlag<br>, prefs-&gt;dictIDFlag); if (ERR_isError(err)) { { if (g_display_prefs<br>.displayLevel&gt;=5) { fprintf(stderr, "%s \n", "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_dictIDFlag, prefs-&gt;dictIDFlag)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 857); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="858"><td class="num" id="LN858">858</td><td class="line">    <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_checksumFlag, prefs-&gt;checksumFlag) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_checksumFlag<br>, prefs-&gt;checksumFlag); if (ERR_isError(err)) { { if (g_display_prefs<br>.displayLevel&gt;=5) { fprintf(stderr, "%s \n", "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_checksumFlag, prefs-&gt;checksumFlag)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 858); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="859"><td class="num" id="LN859">859</td><td class="line">    <span class='comment'>/* compression level */</span></td></tr>
<tr class="codeline" data-linenumber="860"><td class="num" id="LN860">860</td><td class="line">    <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_compressionLevel, cLevel) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_compressionLevel<br>, cLevel); if (ERR_isError(err)) { { if (g_display_prefs.displayLevel<br>&gt;=5) { fprintf(stderr, "%s \n", "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_compressionLevel, cLevel)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 860); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="861"><td class="num" id="LN861">861</td><td class="line">    <span class='comment'>/* max compressed block size */</span></td></tr>
<tr class="codeline" data-linenumber="862"><td class="num" id="LN862">862</td><td class="line">    <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_targetCBlockSize, (<span class='keyword'>int</span>)prefs-&gt;targetCBlockSize) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_experimentalParam6<br>, (int)prefs-&gt;targetCBlockSize); if (ERR_isError(err)) { {<br> if (g_display_prefs.displayLevel&gt;=5) { fprintf(stderr, "%s \n"<br>, "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_experimentalParam6, (int)prefs-&gt;targetCBlockSize)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 862); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="863"><td class="num" id="LN863">863</td><td class="line">    <span class='comment'>/* source size hint */</span></td></tr>
<tr class="codeline" data-linenumber="864"><td class="num" id="LN864">864</td><td class="line">    <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_srcSizeHint, (<span class='keyword'>int</span>)prefs-&gt;srcSizeHint) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_experimentalParam7<br>, (int)prefs-&gt;srcSizeHint); if (ERR_isError(err)) { { if (<br>g_display_prefs.displayLevel&gt;=5) { fprintf(stderr, "%s \n"<br>, "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_experimentalParam7, (int)prefs-&gt;srcSizeHint)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 864); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="865"><td class="num" id="LN865">865</td><td class="line">    <span class='comment'>/* long distance matching */</span></td></tr>
<tr class="codeline" data-linenumber="866"><td class="num" id="LN866">866</td><td class="line">    <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_enableLongDistanceMatching, prefs-&gt;ldmFlag) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_enableLongDistanceMatching<br>, prefs-&gt;ldmFlag); if (ERR_isError(err)) { { if (g_display_prefs<br>.displayLevel&gt;=5) { fprintf(stderr, "%s \n", "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_enableLongDistanceMatching, prefs-&gt;ldmFlag)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 866); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="867"><td class="num" id="LN867">867</td><td class="line">    <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_ldmHashLog, prefs-&gt;ldmHashLog) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_ldmHashLog<br>, prefs-&gt;ldmHashLog); if (ERR_isError(err)) { { if (g_display_prefs<br>.displayLevel&gt;=5) { fprintf(stderr, "%s \n", "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_ldmHashLog, prefs-&gt;ldmHashLog)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 867); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="868"><td class="num" id="LN868">868</td><td class="line">    <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_ldmMinMatch, prefs-&gt;ldmMinMatch) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_ldmMinMatch<br>, prefs-&gt;ldmMinMatch); if (ERR_isError(err)) { { if (g_display_prefs<br>.displayLevel&gt;=5) { fprintf(stderr, "%s \n", "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_ldmMinMatch, prefs-&gt;ldmMinMatch)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 868); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="869"><td class="num" id="LN869">869</td><td class="line">    <span class='keyword'>if</span> (prefs-&gt;ldmBucketSizeLog != <span class='macro'>FIO_LDM_PARAM_NOTSET<span class='macro_popup'>9999</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="870"><td class="num" id="LN870">870</td><td class="line">        <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_ldmBucketSizeLog, prefs-&gt;ldmBucketSizeLog) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_ldmBucketSizeLog<br>, prefs-&gt;ldmBucketSizeLog); if (ERR_isError(err)) { { if (<br>g_display_prefs.displayLevel&gt;=5) { fprintf(stderr, "%s \n"<br>, "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_ldmBucketSizeLog, prefs-&gt;ldmBucketSizeLog)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 870); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="871"><td class="num" id="LN871">871</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="872"><td class="num" id="LN872">872</td><td class="line">    <span class='keyword'>if</span> (prefs-&gt;ldmHashRateLog != <span class='macro'>FIO_LDM_PARAM_NOTSET<span class='macro_popup'>9999</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="873"><td class="num" id="LN873">873</td><td class="line">        <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_ldmHashRateLog, prefs-&gt;ldmHashRateLog) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_ldmHashRateLog<br>, prefs-&gt;ldmHashRateLog); if (ERR_isError(err)) { { if (g_display_prefs<br>.displayLevel&gt;=5) { fprintf(stderr, "%s \n", "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_ldmHashRateLog, prefs-&gt;ldmHashRateLog)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 873); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="874"><td class="num" id="LN874">874</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="875"><td class="num" id="LN875">875</td><td class="line">    <span class='comment'>/* compression parameters */</span></td></tr>
<tr class="codeline" data-linenumber="876"><td class="num" id="LN876">876</td><td class="line">    <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_windowLog, (<span class='keyword'>int</span>)comprParams.windowLog) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_windowLog<br>, (int)comprParams.windowLog); if (ERR_isError(err)) { { if (<br>g_display_prefs.displayLevel&gt;=5) { fprintf(stderr, "%s \n"<br>, "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_windowLog, (int)comprParams.windowLog)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 876); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="877"><td class="num" id="LN877">877</td><td class="line">    <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_chainLog, (<span class='keyword'>int</span>)comprParams.chainLog) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_chainLog<br>, (int)comprParams.chainLog); if (ERR_isError(err)) { { if (g_display_prefs<br>.displayLevel&gt;=5) { fprintf(stderr, "%s \n", "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_chainLog, (int)comprParams.chainLog)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 877); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="878"><td class="num" id="LN878">878</td><td class="line">    <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_hashLog, (<span class='keyword'>int</span>)comprParams.hashLog) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_hashLog<br>, (int)comprParams.hashLog); if (ERR_isError(err)) { { if (g_display_prefs<br>.displayLevel&gt;=5) { fprintf(stderr, "%s \n", "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_hashLog, (int)comprParams.hashLog)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 878); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="879"><td class="num" id="LN879">879</td><td class="line">    <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_searchLog, (<span class='keyword'>int</span>)comprParams.searchLog) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_searchLog<br>, (int)comprParams.searchLog); if (ERR_isError(err)) { { if (<br>g_display_prefs.displayLevel&gt;=5) { fprintf(stderr, "%s \n"<br>, "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_searchLog, (int)comprParams.searchLog)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 879); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="880"><td class="num" id="LN880">880</td><td class="line">    <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_minMatch, (<span class='keyword'>int</span>)comprParams.minMatch) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_minMatch<br>, (int)comprParams.minMatch); if (ERR_isError(err)) { { if (g_display_prefs<br>.displayLevel&gt;=5) { fprintf(stderr, "%s \n", "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_minMatch, (int)comprParams.minMatch)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 880); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="881"><td class="num" id="LN881">881</td><td class="line">    <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_targetLength, (<span class='keyword'>int</span>)comprParams.targetLength) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_targetLength<br>, (int)comprParams.targetLength); if (ERR_isError(err)) { { if<br> (g_display_prefs.displayLevel&gt;=5) { fprintf(stderr, "%s \n"<br>, "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_targetLength, (int)comprParams.targetLength)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 881); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="882"><td class="num" id="LN882">882</td><td class="line">    <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_strategy, comprParams.strategy) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_strategy<br>, comprParams.strategy); if (ERR_isError(err)) { { if (g_display_prefs<br>.displayLevel&gt;=5) { fprintf(stderr, "%s \n", "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_strategy, comprParams.strategy)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 882); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="883"><td class="num" id="LN883">883</td><td class="line">    <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_literalCompressionMode, (<span class='keyword'>int</span>)prefs-&gt;literalCompressionMode) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_experimentalParam5<br>, (int)prefs-&gt;literalCompressionMode); if (ERR_isError(err<br>)) { { if (g_display_prefs.displayLevel&gt;=5) { fprintf(stderr<br>, "%s \n", "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_experimentalParam5, (int)prefs-&gt;literalCompressionMode)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 883); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="884"><td class="num" id="LN884">884</td><td class="line">    <span class='comment'>/* multi-threading */</span></td></tr>
<tr class="codeline" data-linenumber="885"><td class="num" id="LN885">885</td><td class="line"><span class='directive'>#ifdef <span class='macro'>ZSTD_MULTITHREAD<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="886"><td class="num" id="LN886">886</td><td class="line">    <span class='macro'>DISPLAYLEVEL(5,<span class='string_literal'>"set nb workers = %u \n"</span>, prefs-&gt;nbWorkers)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=5) { fprintf(stderr, "set nb workers = %u \n"<br>, prefs-&gt;nbWorkers); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="887"><td class="num" id="LN887">887</td><td class="line">    <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_nbWorkers, prefs-&gt;nbWorkers) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_nbWorkers<br>, prefs-&gt;nbWorkers); if (ERR_isError(err)) { { if (g_display_prefs<br>.displayLevel&gt;=5) { fprintf(stderr, "%s \n", "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_nbWorkers, prefs-&gt;nbWorkers)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 887); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="888"><td class="num" id="LN888">888</td><td class="line">    <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_jobSize, prefs-&gt;blockSize) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_jobSize<br>, prefs-&gt;blockSize); if (ERR_isError(err)) { { if (g_display_prefs<br>.displayLevel&gt;=5) { fprintf(stderr, "%s \n", "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_jobSize, prefs-&gt;blockSize)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 888); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="889"><td class="num" id="LN889">889</td><td class="line">    <span class='keyword'>if</span> (prefs-&gt;overlapLog != <span class='macro'>FIO_OVERLAP_LOG_NOTSET<span class='macro_popup'>9999</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="890"><td class="num" id="LN890">890</td><td class="line">        <span class='macro'>DISPLAYLEVEL(3,<span class='string_literal'>"set overlapLog = %u \n"</span>, prefs-&gt;overlapLog)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=3) { fprintf(stderr, "set overlapLog = %u \n"<br>, prefs-&gt;overlapLog); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="891"><td class="num" id="LN891">891</td><td class="line">        <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_overlapLog, prefs-&gt;overlapLog) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_overlapLog<br>, prefs-&gt;overlapLog); if (ERR_isError(err)) { { if (g_display_prefs<br>.displayLevel&gt;=5) { fprintf(stderr, "%s \n", "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_overlapLog, prefs-&gt;overlapLog)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 891); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="892"><td class="num" id="LN892">892</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="893"><td class="num" id="LN893">893</td><td class="line">    <span class='macro'>CHECK( ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_rsyncable, prefs-&gt;rsyncable) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_experimentalParam1<br>, prefs-&gt;rsyncable); if (ERR_isError(err)) { { if (g_display_prefs<br>.displayLevel&gt;=5) { fprintf(stderr, "%s \n", "ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_experimentalParam1, prefs-&gt;rsyncable)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 893); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="894"><td class="num" id="LN894">894</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="895"><td class="num" id="LN895">895</td><td class="line">    <span class='comment'>/* dictionary */</span></td></tr>
<tr class="codeline" data-linenumber="896"><td class="num" id="LN896">896</td><td class="line">    <span class='keyword'>if</span> (prefs-&gt;patchFromMode) {</td></tr>
<tr class="codeline" data-linenumber="897"><td class="num" id="LN897">897</td><td class="line">        <span class='macro'>CHECK( ZSTD_CCtx_refPrefix(ress.cctx, ress.dictBuffer, ress.dictBufferSize) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_refPrefix(ress.cctx, ress.dictBuffer<br>, ress.dictBufferSize); if (ERR_isError(err)) { { if (g_display_prefs<br>.displayLevel&gt;=5) { fprintf(stderr, "%s \n", "ZSTD_CCtx_refPrefix(ress.cctx, ress.dictBuffer, ress.dictBufferSize)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 897); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="898"><td class="num" id="LN898">898</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="899"><td class="num" id="LN899">899</td><td class="line">        <span class='macro'>CHECK( ZSTD_CCtx_loadDictionary(ress.cctx, ress.dictBuffer, ress.dictBufferSize) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_loadDictionary(ress.cctx, ress.<br>dictBuffer, ress.dictBufferSize); if (ERR_isError(err)) { { if<br> (g_display_prefs.displayLevel&gt;=5) { fprintf(stderr, "%s \n"<br>, "ZSTD_CCtx_loadDictionary(ress.cctx, ress.dictBuffer, ress.dictBufferSize)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 899); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="900"><td class="num" id="LN900">900</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="901"><td class="num" id="LN901">901</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="902"><td class="num" id="LN902">902</td><td class="line">    <span class='keyword'>return</span> ress;</td></tr>
<tr class="codeline" data-linenumber="903"><td class="num" id="LN903">903</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="904"><td class="num" id="LN904">904</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="905"><td class="num" id="LN905">905</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> FIO_freeCResources(cRess_t ress)</td></tr>
<tr class="codeline" data-linenumber="906"><td class="num" id="LN906">906</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="907"><td class="num" id="LN907">907</td><td class="line">    free(ress.srcBuffer);</td></tr>
<tr class="codeline" data-linenumber="908"><td class="num" id="LN908">908</td><td class="line">    free(ress.dstBuffer);</td></tr>
<tr class="codeline" data-linenumber="909"><td class="num" id="LN909">909</td><td class="line">    free(ress.dictBuffer);</td></tr>
<tr class="codeline" data-linenumber="910"><td class="num" id="LN910">910</td><td class="line">    ZSTD_freeCStream(ress.cctx);   <span class='comment'>/* never fails */</span></td></tr>
<tr class="codeline" data-linenumber="911"><td class="num" id="LN911">911</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="912"><td class="num" id="LN912">912</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="913"><td class="num" id="LN913">913</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="914"><td class="num" id="LN914">914</td><td class="line"><span class='directive'>#ifdef <span class='macro'>ZSTD_GZCOMPRESS<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="915"><td class="num" id="LN915">915</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span></td></tr>
<tr class="codeline" data-linenumber="916"><td class="num" id="LN916">916</td><td class="line">FIO_compressGzFrame(<span class='keyword'>const</span> cRess_t* ress,  <span class='comment'>/* buffers &amp; handlers are used, but not changed */</span></td></tr>
<tr class="codeline" data-linenumber="917"><td class="num" id="LN917">917</td><td class="line">                    <span class='keyword'>const</span> <span class='keyword'>char</span>* srcFileName, U64 <span class='keyword'>const</span> srcFileSize,</td></tr>
<tr class="codeline" data-linenumber="918"><td class="num" id="LN918">918</td><td class="line">                    <span class='keyword'>int</span> compressionLevel, U64* readsize)</td></tr>
<tr class="codeline" data-linenumber="919"><td class="num" id="LN919">919</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="920"><td class="num" id="LN920">920</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> inFileSize = 0, outFileSize = 0;</td></tr>
<tr class="codeline" data-linenumber="921"><td class="num" id="LN921">921</td><td class="line">    z_stream strm;</td></tr>
<tr class="codeline" data-linenumber="922"><td class="num" id="LN922">922</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="923"><td class="num" id="LN923">923</td><td class="line">    <span class='keyword'>if</span> (compressionLevel &gt; <span class='macro'>Z_BEST_COMPRESSION<span class='macro_popup'>9</span></span>)</td></tr>
<tr class="codeline" data-linenumber="924"><td class="num" id="LN924">924</td><td class="line">        compressionLevel = <span class='macro'>Z_BEST_COMPRESSION<span class='macro_popup'>9</span></span>;</td></tr>
<tr class="codeline" data-linenumber="925"><td class="num" id="LN925">925</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="926"><td class="num" id="LN926">926</td><td class="line">    strm.zalloc = <span class='macro'>Z_NULL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="927"><td class="num" id="LN927">927</td><td class="line">    strm.zfree = <span class='macro'>Z_NULL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="928"><td class="num" id="LN928">928</td><td class="line">    strm.opaque = <span class='macro'>Z_NULL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="929"><td class="num" id="LN929">929</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="930"><td class="num" id="LN930">930</td><td class="line">    {   <span class='keyword'>int</span> <span class='keyword'>const</span> ret = <span class='macro'>deflateInit2(&amp;strm, compressionLevel, Z_DEFLATED,<span class='macro_popup'>deflateInit2_((&amp;strm),(compressionLevel),(8),(15 + 16),(8<br>), (0), "1.2.11", (int)sizeof(z_stream))</span></span></td></tr>
<tr class="codeline" data-linenumber="931"><td class="num" id="LN931">931</td><td class="line">                        <span class='macro'>15 <span class='comment'>/* maxWindowLogSize */</span> + 16 <span class='comment'>/* gzip only */</span>,<span class='macro_popup'>deflateInit2_((&amp;strm),(compressionLevel),(8),(15 + 16),(8<br>), (0), "1.2.11", (int)sizeof(z_stream))</span></span></td></tr>
<tr class="codeline" data-linenumber="932"><td class="num" id="LN932">932</td><td class="line">                        <span class='macro'>8, Z_DEFAULT_STRATEGY)<span class='macro_popup'>deflateInit2_((&amp;strm),(compressionLevel),(8),(15 + 16),(8<br>), (0), "1.2.11", (int)sizeof(z_stream))</span></span>; <span class='comment'>/* see http://www.zlib.net/manual.html */</span></td></tr>
<tr class="codeline" data-linenumber="933"><td class="num" id="LN933">933</td><td class="line">        <span class='keyword'>if</span> (ret != <span class='macro'>Z_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="934"><td class="num" id="LN934">934</td><td class="line">            <span class='macro'>EXM_THROW(71, <span class='string_literal'>"zstd: %s: deflateInit2 error %d \n"</span>, srcFileName, ret)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 934<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 71); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "zstd: %s: deflateInit2 error %d \n"<br>, srcFileName, ret); } }; { if (g_display_prefs.displayLevel&gt;=<br>1) { fprintf(stderr, " \n"); } }; exit(71); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="935"><td class="num" id="LN935">935</td><td class="line">    }   }</td></tr>
<tr class="codeline" data-linenumber="936"><td class="num" id="LN936">936</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="937"><td class="num" id="LN937">937</td><td class="line">    strm.next_in = 0;</td></tr>
<tr class="codeline" data-linenumber="938"><td class="num" id="LN938">938</td><td class="line">    strm.avail_in = 0;</td></tr>
<tr class="codeline" data-linenumber="939"><td class="num" id="LN939">939</td><td class="line">    strm.next_out = (Bytef*)ress-&gt;dstBuffer;</td></tr>
<tr class="codeline" data-linenumber="940"><td class="num" id="LN940">940</td><td class="line">    strm.avail_out = (uInt)ress-&gt;dstBufferSize;</td></tr>
<tr class="codeline" data-linenumber="941"><td class="num" id="LN941">941</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="942"><td class="num" id="LN942">942</td><td class="line">    <span class='keyword'>while</span> (1) {</td></tr>
<tr class="codeline" data-linenumber="943"><td class="num" id="LN943">943</td><td class="line">        <span class='keyword'>int</span> ret;</td></tr>
<tr class="codeline" data-linenumber="944"><td class="num" id="LN944">944</td><td class="line">        <span class='keyword'>if</span> (strm.avail_in == 0) {</td></tr>
<tr class="codeline" data-linenumber="945"><td class="num" id="LN945">945</td><td class="line">            size_t <span class='keyword'>const</span> inSize = fread(ress-&gt;srcBuffer, 1, ress-&gt;srcBufferSize, ress-&gt;srcFile);</td></tr>
<tr class="codeline" data-linenumber="946"><td class="num" id="LN946">946</td><td class="line">            <span class='keyword'>if</span> (inSize == 0) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="947"><td class="num" id="LN947">947</td><td class="line">            inFileSize += inSize;</td></tr>
<tr class="codeline" data-linenumber="948"><td class="num" id="LN948">948</td><td class="line">            strm.next_in = (z_const <span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)ress-&gt;srcBuffer;</td></tr>
<tr class="codeline" data-linenumber="949"><td class="num" id="LN949">949</td><td class="line">            strm.avail_in = (uInt)inSize;</td></tr>
<tr class="codeline" data-linenumber="950"><td class="num" id="LN950">950</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="951"><td class="num" id="LN951">951</td><td class="line">        ret = deflate(&amp;strm, <span class='macro'>Z_NO_FLUSH<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="952"><td class="num" id="LN952">952</td><td class="line">        <span class='keyword'>if</span> (ret != <span class='macro'>Z_OK<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="953"><td class="num" id="LN953">953</td><td class="line">            <span class='macro'>EXM_THROW(72, <span class='string_literal'>"zstd: %s: deflate error %d \n"</span>, srcFileName, ret)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 953<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 72); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "zstd: %s: deflate error %d \n", srcFileName<br>, ret); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, " \n"); } }; exit(72); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="954"><td class="num" id="LN954">954</td><td class="line">        {   size_t <span class='keyword'>const</span> cSize = ress-&gt;dstBufferSize - strm.avail_out;</td></tr>
<tr class="codeline" data-linenumber="955"><td class="num" id="LN955">955</td><td class="line">            <span class='keyword'>if</span> (cSize) {</td></tr>
<tr class="codeline" data-linenumber="956"><td class="num" id="LN956">956</td><td class="line">                <span class='keyword'>if</span> (fwrite(ress-&gt;dstBuffer, 1, cSize, ress-&gt;dstFile) != cSize)</td></tr>
<tr class="codeline" data-linenumber="957"><td class="num" id="LN957">957</td><td class="line">                    <span class='macro'>EXM_THROW(73, <span class='string_literal'>"Write error : cannot write to output file : %s "</span>, strerror(errno))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 957<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 73); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Write error : cannot write to output file : %s "<br>, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(73);<br> }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="958"><td class="num" id="LN958">958</td><td class="line">                outFileSize += cSize;</td></tr>
<tr class="codeline" data-linenumber="959"><td class="num" id="LN959">959</td><td class="line">                strm.next_out = (Bytef*)ress-&gt;dstBuffer;</td></tr>
<tr class="codeline" data-linenumber="960"><td class="num" id="LN960">960</td><td class="line">                strm.avail_out = (uInt)ress-&gt;dstBufferSize;</td></tr>
<tr class="codeline" data-linenumber="961"><td class="num" id="LN961">961</td><td class="line">        }   }</td></tr>
<tr class="codeline" data-linenumber="962"><td class="num" id="LN962">962</td><td class="line">        <span class='keyword'>if</span> (srcFileSize == <span class='macro'>UTIL_FILESIZE_UNKNOWN<span class='macro_popup'>((U64)(-1))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="963"><td class="num" id="LN963">963</td><td class="line">            <span class='macro'>DISPLAYUPDATE(2, <span class='string_literal'>"\rRead : %u MB ==&gt; %.2f%% "</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\rRead : %u MB ==&gt; %.2f%% ", (unsigned)(inFileSize&gt;&gt;<br>20), (double)outFileSize/inFileSize*100); if (g_display_prefs<br>.displayLevel&gt;=4) fflush(stderr); } } }</span></span></td></tr>
<tr class="codeline" data-linenumber="964"><td class="num" id="LN964">964</td><td class="line">                            <span class='macro'>(<span class='keyword'>unsigned</span>)(inFileSize&gt;&gt;20),<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\rRead : %u MB ==&gt; %.2f%% ", (unsigned)(inFileSize&gt;&gt;<br>20), (double)outFileSize/inFileSize*100); if (g_display_prefs<br>.displayLevel&gt;=4) fflush(stderr); } } }</span></span></td></tr>
<tr class="codeline" data-linenumber="965"><td class="num" id="LN965">965</td><td class="line">                            <span class='macro'>(<span class='keyword'>double</span>)outFileSize/inFileSize*100)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\rRead : %u MB ==&gt; %.2f%% ", (unsigned)(inFileSize&gt;&gt;<br>20), (double)outFileSize/inFileSize*100); if (g_display_prefs<br>.displayLevel&gt;=4) fflush(stderr); } } }</span></span></td></tr>
<tr class="codeline" data-linenumber="966"><td class="num" id="LN966">966</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="967"><td class="num" id="LN967">967</td><td class="line">            <span class='macro'>DISPLAYUPDATE(2, <span class='string_literal'>"\rRead : %u / %u MB ==&gt; %.2f%% "</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\rRead : %u / %u MB ==&gt; %.2f%% ", (unsigned)(inFileSize<br>&gt;&gt;20), (unsigned)(srcFileSize&gt;&gt;20), (double)outFileSize<br>/inFileSize*100); if (g_display_prefs.displayLevel&gt;=4) fflush<br>(stderr); } } }</span></span></td></tr>
<tr class="codeline" data-linenumber="968"><td class="num" id="LN968">968</td><td class="line">                            <span class='macro'>(<span class='keyword'>unsigned</span>)(inFileSize&gt;&gt;20), (<span class='keyword'>unsigned</span>)(srcFileSize&gt;&gt;20),<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\rRead : %u / %u MB ==&gt; %.2f%% ", (unsigned)(inFileSize<br>&gt;&gt;20), (unsigned)(srcFileSize&gt;&gt;20), (double)outFileSize<br>/inFileSize*100); if (g_display_prefs.displayLevel&gt;=4) fflush<br>(stderr); } } }</span></span></td></tr>
<tr class="codeline" data-linenumber="969"><td class="num" id="LN969">969</td><td class="line">                            <span class='macro'>(<span class='keyword'>double</span>)outFileSize/inFileSize*100)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\rRead : %u / %u MB ==&gt; %.2f%% ", (unsigned)(inFileSize<br>&gt;&gt;20), (unsigned)(srcFileSize&gt;&gt;20), (double)outFileSize<br>/inFileSize*100); if (g_display_prefs.displayLevel&gt;=4) fflush<br>(stderr); } } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="970"><td class="num" id="LN970">970</td><td class="line">    }   }</td></tr>
<tr class="codeline" data-linenumber="971"><td class="num" id="LN971">971</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="972"><td class="num" id="LN972">972</td><td class="line">    <span class='keyword'>while</span> (1) {</td></tr>
<tr class="codeline" data-linenumber="973"><td class="num" id="LN973">973</td><td class="line">        <span class='keyword'>int</span> <span class='keyword'>const</span> ret = deflate(&amp;strm, <span class='macro'>Z_FINISH<span class='macro_popup'>4</span></span>);</td></tr>
<tr class="codeline" data-linenumber="974"><td class="num" id="LN974">974</td><td class="line">        {   size_t <span class='keyword'>const</span> cSize = ress-&gt;dstBufferSize - strm.avail_out;</td></tr>
<tr class="codeline" data-linenumber="975"><td class="num" id="LN975">975</td><td class="line">            <span class='keyword'>if</span> (cSize) {</td></tr>
<tr class="codeline" data-linenumber="976"><td class="num" id="LN976">976</td><td class="line">                <span class='keyword'>if</span> (fwrite(ress-&gt;dstBuffer, 1, cSize, ress-&gt;dstFile) != cSize)</td></tr>
<tr class="codeline" data-linenumber="977"><td class="num" id="LN977">977</td><td class="line">                    <span class='macro'>EXM_THROW(75, <span class='string_literal'>"Write error : %s "</span>, strerror(errno))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 977<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 75); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Write error : %s ", strerror((*__errno_location<br> ()))); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, " \n"); } }; exit(75); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="978"><td class="num" id="LN978">978</td><td class="line">                outFileSize += cSize;</td></tr>
<tr class="codeline" data-linenumber="979"><td class="num" id="LN979">979</td><td class="line">                strm.next_out = (Bytef*)ress-&gt;dstBuffer;</td></tr>
<tr class="codeline" data-linenumber="980"><td class="num" id="LN980">980</td><td class="line">                strm.avail_out = (uInt)ress-&gt;dstBufferSize;</td></tr>
<tr class="codeline" data-linenumber="981"><td class="num" id="LN981">981</td><td class="line">        }   }</td></tr>
<tr class="codeline" data-linenumber="982"><td class="num" id="LN982">982</td><td class="line">        <span class='keyword'>if</span> (ret == <span class='macro'>Z_STREAM_END<span class='macro_popup'>1</span></span>) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="983"><td class="num" id="LN983">983</td><td class="line">        <span class='keyword'>if</span> (ret != <span class='macro'>Z_BUF_ERROR<span class='macro_popup'>(-5)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="984"><td class="num" id="LN984">984</td><td class="line">            <span class='macro'>EXM_THROW(77, <span class='string_literal'>"zstd: %s: deflate error %d \n"</span>, srcFileName, ret)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 984<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 77); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "zstd: %s: deflate error %d \n", srcFileName<br>, ret); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, " \n"); } }; exit(77); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="985"><td class="num" id="LN985">985</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="986"><td class="num" id="LN986">986</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="987"><td class="num" id="LN987">987</td><td class="line">    {   <span class='keyword'>int</span> <span class='keyword'>const</span> ret = deflateEnd(&amp;strm);</td></tr>
<tr class="codeline" data-linenumber="988"><td class="num" id="LN988">988</td><td class="line">        <span class='keyword'>if</span> (ret != <span class='macro'>Z_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="989"><td class="num" id="LN989">989</td><td class="line">            <span class='macro'>EXM_THROW(79, <span class='string_literal'>"zstd: %s: deflateEnd error %d \n"</span>, srcFileName, ret)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 989<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 79); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "zstd: %s: deflateEnd error %d \n",<br> srcFileName, ret); } }; { if (g_display_prefs.displayLevel&gt;=<br>1) { fprintf(stderr, " \n"); } }; exit(79); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="990"><td class="num" id="LN990">990</td><td class="line">    }   }</td></tr>
<tr class="codeline" data-linenumber="991"><td class="num" id="LN991">991</td><td class="line">    *readsize = inFileSize;</td></tr>
<tr class="codeline" data-linenumber="992"><td class="num" id="LN992">992</td><td class="line">    <span class='keyword'>return</span> outFileSize;</td></tr>
<tr class="codeline" data-linenumber="993"><td class="num" id="LN993">993</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="994"><td class="num" id="LN994">994</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="995"><td class="num" id="LN995">995</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="996"><td class="num" id="LN996">996</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="997"><td class="num" id="LN997">997</td><td class="line"><span class='directive'>#ifdef <span class='macro'>ZSTD_LZMACOMPRESS<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="998"><td class="num" id="LN998">998</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span></td></tr>
<tr class="codeline" data-linenumber="999"><td class="num" id="LN999">999</td><td class="line">FIO_compressLzmaFrame(cRess_t* ress,</td></tr>
<tr class="codeline" data-linenumber="1000"><td class="num" id="LN1000">1000</td><td class="line">                      <span class='keyword'>const</span> <span class='keyword'>char</span>* srcFileName, U64 <span class='keyword'>const</span> srcFileSize,</td></tr>
<tr class="codeline" data-linenumber="1001"><td class="num" id="LN1001">1001</td><td class="line">                      <span class='keyword'>int</span> compressionLevel, U64* readsize, <span class='keyword'>int</span> plain_lzma)</td></tr>
<tr class="codeline" data-linenumber="1002"><td class="num" id="LN1002">1002</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1003"><td class="num" id="LN1003">1003</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> inFileSize = 0, outFileSize = 0;</td></tr>
<tr class="codeline" data-linenumber="1004"><td class="num" id="LN1004">1004</td><td class="line">    lzma_stream strm = <span class='macro'>LZMA_STREAM_INIT<span class='macro_popup'>{ ((void*)0), 0, 0, ((void*)0), 0, 0, ((void*)0), ((void*)0),<br> ((void*)0), ((void*)0), ((void*)0), ((void*)0), 0, 0, 0, 0, LZMA_RESERVED_ENUM<br>, LZMA_RESERVED_ENUM }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1005"><td class="num" id="LN1005">1005</td><td class="line">    lzma_action action = LZMA_RUN;</td></tr>
<tr class="codeline" data-linenumber="1006"><td class="num" id="LN1006">1006</td><td class="line">    lzma_ret ret;</td></tr>
<tr class="codeline" data-linenumber="1007"><td class="num" id="LN1007">1007</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1008"><td class="num" id="LN1008">1008</td><td class="line">    <span class='keyword'>if</span> (compressionLevel &lt; 0) compressionLevel = 0;</td></tr>
<tr class="codeline" data-linenumber="1009"><td class="num" id="LN1009">1009</td><td class="line">    <span class='keyword'>if</span> (compressionLevel &gt; 9) compressionLevel = 9;</td></tr>
<tr class="codeline" data-linenumber="1010"><td class="num" id="LN1010">1010</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1011"><td class="num" id="LN1011">1011</td><td class="line">    <span class='keyword'>if</span> (plain_lzma) {</td></tr>
<tr class="codeline" data-linenumber="1012"><td class="num" id="LN1012">1012</td><td class="line">        lzma_options_lzma opt_lzma;</td></tr>
<tr class="codeline" data-linenumber="1013"><td class="num" id="LN1013">1013</td><td class="line">        <span class='keyword'>if</span> (lzma_lzma_preset(&amp;opt_lzma, compressionLevel))</td></tr>
<tr class="codeline" data-linenumber="1014"><td class="num" id="LN1014">1014</td><td class="line">            <span class='macro'>EXM_THROW(81, <span class='string_literal'>"zstd: %s: lzma_lzma_preset error"</span>, srcFileName)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1014<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 81); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "zstd: %s: lzma_lzma_preset error",<br> srcFileName); } }; { if (g_display_prefs.displayLevel&gt;=1)<br> { fprintf(stderr, " \n"); } }; exit(81); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1015"><td class="num" id="LN1015">1015</td><td class="line">        ret = lzma_alone_encoder(&amp;strm, &amp;opt_lzma); <span class='comment'>/* LZMA */</span></td></tr>
<tr class="codeline" data-linenumber="1016"><td class="num" id="LN1016">1016</td><td class="line">        <span class='keyword'>if</span> (ret != LZMA_OK)</td></tr>
<tr class="codeline" data-linenumber="1017"><td class="num" id="LN1017">1017</td><td class="line">            <span class='macro'>EXM_THROW(82, <span class='string_literal'>"zstd: %s: lzma_alone_encoder error %d"</span>, srcFileName, ret)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1017<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 82); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "zstd: %s: lzma_alone_encoder error %d"<br>, srcFileName, ret); } }; { if (g_display_prefs.displayLevel&gt;=<br>1) { fprintf(stderr, " \n"); } }; exit(82); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1018"><td class="num" id="LN1018">1018</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1019"><td class="num" id="LN1019">1019</td><td class="line">        ret = lzma_easy_encoder(&amp;strm, compressionLevel, LZMA_CHECK_CRC64); <span class='comment'>/* XZ */</span></td></tr>
<tr class="codeline" data-linenumber="1020"><td class="num" id="LN1020">1020</td><td class="line">        <span class='keyword'>if</span> (ret != LZMA_OK)</td></tr>
<tr class="codeline" data-linenumber="1021"><td class="num" id="LN1021">1021</td><td class="line">            <span class='macro'>EXM_THROW(83, <span class='string_literal'>"zstd: %s: lzma_easy_encoder error %d"</span>, srcFileName, ret)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1021<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 83); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "zstd: %s: lzma_easy_encoder error %d"<br>, srcFileName, ret); } }; { if (g_display_prefs.displayLevel&gt;=<br>1) { fprintf(stderr, " \n"); } }; exit(83); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1022"><td class="num" id="LN1022">1022</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1023"><td class="num" id="LN1023">1023</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1024"><td class="num" id="LN1024">1024</td><td class="line">    strm.next_in = 0;</td></tr>
<tr class="codeline" data-linenumber="1025"><td class="num" id="LN1025">1025</td><td class="line">    strm.avail_in = 0;</td></tr>
<tr class="codeline" data-linenumber="1026"><td class="num" id="LN1026">1026</td><td class="line">    strm.next_out = (BYTE*)ress-&gt;dstBuffer;</td></tr>
<tr class="codeline" data-linenumber="1027"><td class="num" id="LN1027">1027</td><td class="line">    strm.avail_out = ress-&gt;dstBufferSize;</td></tr>
<tr class="codeline" data-linenumber="1028"><td class="num" id="LN1028">1028</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1029"><td class="num" id="LN1029">1029</td><td class="line">    <span class='keyword'>while</span> (1) {</td></tr>
<tr class="codeline" data-linenumber="1030"><td class="num" id="LN1030">1030</td><td class="line">        <span class='keyword'>if</span> (strm.avail_in == 0) {</td></tr>
<tr class="codeline" data-linenumber="1031"><td class="num" id="LN1031">1031</td><td class="line">            size_t <span class='keyword'>const</span> inSize = fread(ress-&gt;srcBuffer, 1, ress-&gt;srcBufferSize, ress-&gt;srcFile);</td></tr>
<tr class="codeline" data-linenumber="1032"><td class="num" id="LN1032">1032</td><td class="line">            <span class='keyword'>if</span> (inSize == 0) action = LZMA_FINISH;</td></tr>
<tr class="codeline" data-linenumber="1033"><td class="num" id="LN1033">1033</td><td class="line">            inFileSize += inSize;</td></tr>
<tr class="codeline" data-linenumber="1034"><td class="num" id="LN1034">1034</td><td class="line">            strm.next_in = (BYTE <span class='keyword'>const</span>*)ress-&gt;srcBuffer;</td></tr>
<tr class="codeline" data-linenumber="1035"><td class="num" id="LN1035">1035</td><td class="line">            strm.avail_in = inSize;</td></tr>
<tr class="codeline" data-linenumber="1036"><td class="num" id="LN1036">1036</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1037"><td class="num" id="LN1037">1037</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1038"><td class="num" id="LN1038">1038</td><td class="line">        ret = lzma_code(&amp;strm, action);</td></tr>
<tr class="codeline" data-linenumber="1039"><td class="num" id="LN1039">1039</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1040"><td class="num" id="LN1040">1040</td><td class="line">        <span class='keyword'>if</span> (ret != LZMA_OK &amp;&amp; ret != LZMA_STREAM_END)</td></tr>
<tr class="codeline" data-linenumber="1041"><td class="num" id="LN1041">1041</td><td class="line">            <span class='macro'>EXM_THROW(84, <span class='string_literal'>"zstd: %s: lzma_code encoding error %d"</span>, srcFileName, ret)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1041<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 84); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "zstd: %s: lzma_code encoding error %d"<br>, srcFileName, ret); } }; { if (g_display_prefs.displayLevel&gt;=<br>1) { fprintf(stderr, " \n"); } }; exit(84); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1042"><td class="num" id="LN1042">1042</td><td class="line">        {   size_t <span class='keyword'>const</span> compBytes = ress-&gt;dstBufferSize - strm.avail_out;</td></tr>
<tr class="codeline" data-linenumber="1043"><td class="num" id="LN1043">1043</td><td class="line">            <span class='keyword'>if</span> (compBytes) {</td></tr>
<tr class="codeline" data-linenumber="1044"><td class="num" id="LN1044">1044</td><td class="line">                <span class='keyword'>if</span> (fwrite(ress-&gt;dstBuffer, 1, compBytes, ress-&gt;dstFile) != compBytes)</td></tr>
<tr class="codeline" data-linenumber="1045"><td class="num" id="LN1045">1045</td><td class="line">                    <span class='macro'>EXM_THROW(85, <span class='string_literal'>"Write error : %s"</span>, strerror(errno))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1045<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 85); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Write error : %s", strerror((*__errno_location<br> ()))); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, " \n"); } }; exit(85); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1046"><td class="num" id="LN1046">1046</td><td class="line">                outFileSize += compBytes;</td></tr>
<tr class="codeline" data-linenumber="1047"><td class="num" id="LN1047">1047</td><td class="line">                strm.next_out = (BYTE*)ress-&gt;dstBuffer;</td></tr>
<tr class="codeline" data-linenumber="1048"><td class="num" id="LN1048">1048</td><td class="line">                strm.avail_out = ress-&gt;dstBufferSize;</td></tr>
<tr class="codeline" data-linenumber="1049"><td class="num" id="LN1049">1049</td><td class="line">        }   }</td></tr>
<tr class="codeline" data-linenumber="1050"><td class="num" id="LN1050">1050</td><td class="line">        <span class='keyword'>if</span> (srcFileSize == <span class='macro'>UTIL_FILESIZE_UNKNOWN<span class='macro_popup'>((U64)(-1))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1051"><td class="num" id="LN1051">1051</td><td class="line">            <span class='macro'>DISPLAYUPDATE(2, <span class='string_literal'>"\rRead : %u MB ==&gt; %.2f%%"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\rRead : %u MB ==&gt; %.2f%%", (unsigned)(inFileSize&gt;&gt;<br>20), (double)outFileSize/inFileSize*100); if (g_display_prefs<br>.displayLevel&gt;=4) fflush(stderr); } } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1052"><td class="num" id="LN1052">1052</td><td class="line">                            <span class='macro'>(<span class='keyword'>unsigned</span>)(inFileSize&gt;&gt;20),<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\rRead : %u MB ==&gt; %.2f%%", (unsigned)(inFileSize&gt;&gt;<br>20), (double)outFileSize/inFileSize*100); if (g_display_prefs<br>.displayLevel&gt;=4) fflush(stderr); } } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1053"><td class="num" id="LN1053">1053</td><td class="line">                            <span class='macro'>(<span class='keyword'>double</span>)outFileSize/inFileSize*100)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\rRead : %u MB ==&gt; %.2f%%", (unsigned)(inFileSize&gt;&gt;<br>20), (double)outFileSize/inFileSize*100); if (g_display_prefs<br>.displayLevel&gt;=4) fflush(stderr); } } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1054"><td class="num" id="LN1054">1054</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1055"><td class="num" id="LN1055">1055</td><td class="line">            <span class='macro'>DISPLAYUPDATE(2, <span class='string_literal'>"\rRead : %u / %u MB ==&gt; %.2f%%"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\rRead : %u / %u MB ==&gt; %.2f%%", (unsigned)(inFileSize&gt;&gt;<br>20), (unsigned)(srcFileSize&gt;&gt;20), (double)outFileSize/inFileSize<br>*100); if (g_display_prefs.displayLevel&gt;=4) fflush(stderr)<br>; } } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1056"><td class="num" id="LN1056">1056</td><td class="line">                            <span class='macro'>(<span class='keyword'>unsigned</span>)(inFileSize&gt;&gt;20), (<span class='keyword'>unsigned</span>)(srcFileSize&gt;&gt;20),<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\rRead : %u / %u MB ==&gt; %.2f%%", (unsigned)(inFileSize&gt;&gt;<br>20), (unsigned)(srcFileSize&gt;&gt;20), (double)outFileSize/inFileSize<br>*100); if (g_display_prefs.displayLevel&gt;=4) fflush(stderr)<br>; } } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1057"><td class="num" id="LN1057">1057</td><td class="line">                            <span class='macro'>(<span class='keyword'>double</span>)outFileSize/inFileSize*100)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\rRead : %u / %u MB ==&gt; %.2f%%", (unsigned)(inFileSize&gt;&gt;<br>20), (unsigned)(srcFileSize&gt;&gt;20), (double)outFileSize/inFileSize<br>*100); if (g_display_prefs.displayLevel&gt;=4) fflush(stderr)<br>; } } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1058"><td class="num" id="LN1058">1058</td><td class="line">        <span class='keyword'>if</span> (ret == LZMA_STREAM_END) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1059"><td class="num" id="LN1059">1059</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1060"><td class="num" id="LN1060">1060</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1061"><td class="num" id="LN1061">1061</td><td class="line">    lzma_end(&amp;strm);</td></tr>
<tr class="codeline" data-linenumber="1062"><td class="num" id="LN1062">1062</td><td class="line">    *readsize = inFileSize;</td></tr>
<tr class="codeline" data-linenumber="1063"><td class="num" id="LN1063">1063</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1064"><td class="num" id="LN1064">1064</td><td class="line">    <span class='keyword'>return</span> outFileSize;</td></tr>
<tr class="codeline" data-linenumber="1065"><td class="num" id="LN1065">1065</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1066"><td class="num" id="LN1066">1066</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1067"><td class="num" id="LN1067">1067</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1068"><td class="num" id="LN1068">1068</td><td class="line"><span class='directive'>#ifdef <span class='macro'>ZSTD_LZ4COMPRESS<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="1069"><td class="num" id="LN1069">1069</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1070"><td class="num" id="LN1070">1070</td><td class="line"><span class='directive'>#if <span class='macro'>LZ4_VERSION_NUMBER<span class='macro_popup'>(1 *100*100 + 7 *100 + 1)</span></span> &lt;= 10600</span></td></tr>
<tr class="codeline" data-linenumber="1071"><td class="num" id="LN1071">1071</td><td class="line"><span class='directive'>#define LZ4F_blockLinked blockLinked</span></td></tr>
<tr class="codeline" data-linenumber="1072"><td class="num" id="LN1072">1072</td><td class="line"><span class='directive'>#define LZ4F_max64KB max64KB</span></td></tr>
<tr class="codeline" data-linenumber="1073"><td class="num" id="LN1073">1073</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1074"><td class="num" id="LN1074">1074</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1075"><td class="num" id="LN1075">1075</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> FIO_LZ4_GetBlockSize_FromBlockId (<span class='keyword'>int</span> id) { <span class='keyword'>return</span> (1 &lt;&lt; (8 + (2 * id))); }</td></tr>
<tr class="codeline" data-linenumber="1076"><td class="num" id="LN1076">1076</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1077"><td class="num" id="LN1077">1077</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span></td></tr>
<tr class="codeline" data-linenumber="1078"><td class="num" id="LN1078">1078</td><td class="line">FIO_compressLz4Frame(cRess_t* ress,</td></tr>
<tr class="codeline" data-linenumber="1079"><td class="num" id="LN1079">1079</td><td class="line">                     <span class='keyword'>const</span> <span class='keyword'>char</span>* srcFileName, U64 <span class='keyword'>const</span> srcFileSize,</td></tr>
<tr class="codeline" data-linenumber="1080"><td class="num" id="LN1080">1080</td><td class="line">                     <span class='keyword'>int</span> compressionLevel, <span class='keyword'>int</span> checksumFlag,</td></tr>
<tr class="codeline" data-linenumber="1081"><td class="num" id="LN1081">1081</td><td class="line">                     U64* readsize)</td></tr>
<tr class="codeline" data-linenumber="1082"><td class="num" id="LN1082">1082</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1083"><td class="num" id="LN1083">1083</td><td class="line">    <span class='keyword'>const</span> size_t blockSize = FIO_LZ4_GetBlockSize_FromBlockId(LZ4F_max64KB);</td></tr>
<tr class="codeline" data-linenumber="1084"><td class="num" id="LN1084">1084</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> inFileSize = 0, outFileSize = 0;</td></tr>
<tr class="codeline" data-linenumber="1085"><td class="num" id="LN1085">1085</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1086"><td class="num" id="LN1086">1086</td><td class="line">    LZ4F_preferences_t prefs;</td></tr>
<tr class="codeline" data-linenumber="1087"><td class="num" id="LN1087">1087</td><td class="line">    LZ4F_compressionContext_t ctx;</td></tr>
<tr class="codeline" data-linenumber="1088"><td class="num" id="LN1088">1088</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1089"><td class="num" id="LN1089">1089</td><td class="line">    LZ4F_errorCode_t <span class='keyword'>const</span> errorCode = LZ4F_createCompressionContext(&amp;ctx, <span class='macro'>LZ4F_VERSION<span class='macro_popup'>100</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1090"><td class="num" id="LN1090">1090</td><td class="line">    <span class='keyword'>if</span> (LZ4F_isError(errorCode))</td></tr>
<tr class="codeline" data-linenumber="1091"><td class="num" id="LN1091">1091</td><td class="line">        <span class='macro'>EXM_THROW(31, <span class='string_literal'>"zstd: failed to create lz4 compression context"</span>)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1091<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 31); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "zstd: failed to create lz4 compression context"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; exit(31); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1092"><td class="num" id="LN1092">1092</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1093"><td class="num" id="LN1093">1093</td><td class="line">    memset(&amp;prefs, 0, <span class='keyword'>sizeof</span>(prefs));</td></tr>
<tr class="codeline" data-linenumber="1094"><td class="num" id="LN1094">1094</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1095"><td class="num" id="LN1095">1095</td><td class="line">    <span class='macro'>assert(blockSize &lt;= ress-&gt;srcBufferSize)<span class='macro_popup'>((void) sizeof ((blockSize &lt;= ress-&gt;srcBufferSize) ? 1 :<br> 0), __extension__ ({ if (blockSize &lt;= ress-&gt;srcBufferSize<br>) ; else __assert_fail ("blockSize &lt;= ress-&gt;srcBufferSize"<br>, "fileio.c", 1095, __extension__ __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1096"><td class="num" id="LN1096">1096</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1097"><td class="num" id="LN1097">1097</td><td class="line">    prefs.autoFlush = 1;</td></tr>
<tr class="codeline" data-linenumber="1098"><td class="num" id="LN1098">1098</td><td class="line">    prefs.compressionLevel = compressionLevel;</td></tr>
<tr class="codeline" data-linenumber="1099"><td class="num" id="LN1099">1099</td><td class="line">    prefs.frameInfo.blockMode = LZ4F_blockLinked;</td></tr>
<tr class="codeline" data-linenumber="1100"><td class="num" id="LN1100">1100</td><td class="line">    prefs.frameInfo.blockSizeID = LZ4F_max64KB;</td></tr>
<tr class="codeline" data-linenumber="1101"><td class="num" id="LN1101">1101</td><td class="line">    prefs.frameInfo.contentChecksumFlag = (contentChecksum_t)checksumFlag;</td></tr>
<tr class="codeline" data-linenumber="1102"><td class="num" id="LN1102">1102</td><td class="line"><span class='directive'>#if <span class='macro'>LZ4_VERSION_NUMBER<span class='macro_popup'>(1 *100*100 + 7 *100 + 1)</span></span> &gt;= 10600</span></td></tr>
<tr class="codeline" data-linenumber="1103"><td class="num" id="LN1103">1103</td><td class="line">    prefs.frameInfo.contentSize = (srcFileSize==<span class='macro'>UTIL_FILESIZE_UNKNOWN<span class='macro_popup'>((U64)(-1))</span></span>) ? 0 : srcFileSize;</td></tr>
<tr class="codeline" data-linenumber="1104"><td class="num" id="LN1104">1104</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1105"><td class="num" id="LN1105">1105</td><td class="line">    <span class='macro'>assert(LZ4F_compressBound(blockSize, &amp;prefs) &lt;= ress-&gt;dstBufferSize)<span class='macro_popup'>((void) sizeof ((LZ4F_compressBound(blockSize, &amp;prefs) &lt;=<br> ress-&gt;dstBufferSize) ? 1 : 0), __extension__ ({ if (LZ4F_compressBound<br>(blockSize, &amp;prefs) &lt;= ress-&gt;dstBufferSize) ; else __assert_fail<br> ("LZ4F_compressBound(blockSize, &amp;prefs) &lt;= ress-&gt;dstBufferSize"<br>, "fileio.c", 1105, __extension__ __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1106"><td class="num" id="LN1106">1106</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1107"><td class="num" id="LN1107">1107</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1108"><td class="num" id="LN1108">1108</td><td class="line">        size_t readSize;</td></tr>
<tr class="codeline" data-linenumber="1109"><td class="num" id="LN1109">1109</td><td class="line">        size_t headerSize = LZ4F_compressBegin(ctx, ress-&gt;dstBuffer, ress-&gt;dstBufferSize, &amp;prefs);</td></tr>
<tr class="codeline" data-linenumber="1110"><td class="num" id="LN1110">1110</td><td class="line">        <span class='keyword'>if</span> (LZ4F_isError(headerSize))</td></tr>
<tr class="codeline" data-linenumber="1111"><td class="num" id="LN1111">1111</td><td class="line">            <span class='macro'>EXM_THROW(33, <span class='string_literal'>"File header generation failed : %s"</span>,<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1112<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 33); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "File header generation failed : %s"<br>, LZ4F_getErrorName(headerSize)); } }; { if (g_display_prefs.<br>displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(33); }</span></span></td></tr>
<tr class="codeline" data-linenumber="1112"><td class="num" id="LN1112">1112</td><td class="line">                            <span class='macro'>LZ4F_getErrorName(headerSize))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1112<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 33); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "File header generation failed : %s"<br>, LZ4F_getErrorName(headerSize)); } }; { if (g_display_prefs.<br>displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(33); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1113"><td class="num" id="LN1113">1113</td><td class="line">        <span class='keyword'>if</span> (fwrite(ress-&gt;dstBuffer, 1, headerSize, ress-&gt;dstFile) != headerSize)</td></tr>
<tr class="codeline" data-linenumber="1114"><td class="num" id="LN1114">1114</td><td class="line">            <span class='macro'>EXM_THROW(34, <span class='string_literal'>"Write error : %s (cannot write header)"</span>, strerror(errno))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1114<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 34); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Write error : %s (cannot write header)"<br>, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(34);<br> }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1115"><td class="num" id="LN1115">1115</td><td class="line">        outFileSize += headerSize;</td></tr>
<tr class="codeline" data-linenumber="1116"><td class="num" id="LN1116">1116</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1117"><td class="num" id="LN1117">1117</td><td class="line">        <span class='comment'>/* Read first block */</span></td></tr>
<tr class="codeline" data-linenumber="1118"><td class="num" id="LN1118">1118</td><td class="line">        readSize  = fread(ress-&gt;srcBuffer, (size_t)1, (size_t)blockSize, ress-&gt;srcFile);</td></tr>
<tr class="codeline" data-linenumber="1119"><td class="num" id="LN1119">1119</td><td class="line">        inFileSize += readSize;</td></tr>
<tr class="codeline" data-linenumber="1120"><td class="num" id="LN1120">1120</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1121"><td class="num" id="LN1121">1121</td><td class="line">        <span class='comment'>/* Main Loop */</span></td></tr>
<tr class="codeline" data-linenumber="1122"><td class="num" id="LN1122">1122</td><td class="line">        <span class='keyword'>while</span> (readSize&gt;0) {</td></tr>
<tr class="codeline" data-linenumber="1123"><td class="num" id="LN1123">1123</td><td class="line">            size_t <span class='keyword'>const</span> outSize = LZ4F_compressUpdate(ctx,</td></tr>
<tr class="codeline" data-linenumber="1124"><td class="num" id="LN1124">1124</td><td class="line">                                        ress-&gt;dstBuffer, ress-&gt;dstBufferSize,</td></tr>
<tr class="codeline" data-linenumber="1125"><td class="num" id="LN1125">1125</td><td class="line">                                        ress-&gt;srcBuffer, readSize, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1126"><td class="num" id="LN1126">1126</td><td class="line">            <span class='keyword'>if</span> (LZ4F_isError(outSize))</td></tr>
<tr class="codeline" data-linenumber="1127"><td class="num" id="LN1127">1127</td><td class="line">                <span class='macro'>EXM_THROW(35, <span class='string_literal'>"zstd: %s: lz4 compression failed : %s"</span>,<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1128<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 35); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "zstd: %s: lz4 compression failed : %s"<br>, srcFileName, LZ4F_getErrorName(outSize)); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(35);<br> }</span></span></td></tr>
<tr class="codeline" data-linenumber="1128"><td class="num" id="LN1128">1128</td><td class="line">                            <span class='macro'>srcFileName, LZ4F_getErrorName(outSize))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1128<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 35); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "zstd: %s: lz4 compression failed : %s"<br>, srcFileName, LZ4F_getErrorName(outSize)); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(35);<br> }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1129"><td class="num" id="LN1129">1129</td><td class="line">            outFileSize += outSize;</td></tr>
<tr class="codeline" data-linenumber="1130"><td class="num" id="LN1130">1130</td><td class="line">            <span class='keyword'>if</span> (srcFileSize == <span class='macro'>UTIL_FILESIZE_UNKNOWN<span class='macro_popup'>((U64)(-1))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1131"><td class="num" id="LN1131">1131</td><td class="line">                <span class='macro'>DISPLAYUPDATE(2, <span class='string_literal'>"\rRead : %u MB ==&gt; %.2f%%"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\rRead : %u MB ==&gt; %.2f%%", (unsigned)(inFileSize&gt;&gt;<br>20), (double)outFileSize/inFileSize*100); if (g_display_prefs<br>.displayLevel&gt;=4) fflush(stderr); } } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1132"><td class="num" id="LN1132">1132</td><td class="line">                                <span class='macro'>(<span class='keyword'>unsigned</span>)(inFileSize&gt;&gt;20),<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\rRead : %u MB ==&gt; %.2f%%", (unsigned)(inFileSize&gt;&gt;<br>20), (double)outFileSize/inFileSize*100); if (g_display_prefs<br>.displayLevel&gt;=4) fflush(stderr); } } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1133"><td class="num" id="LN1133">1133</td><td class="line">                                <span class='macro'>(<span class='keyword'>double</span>)outFileSize/inFileSize*100)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\rRead : %u MB ==&gt; %.2f%%", (unsigned)(inFileSize&gt;&gt;<br>20), (double)outFileSize/inFileSize*100); if (g_display_prefs<br>.displayLevel&gt;=4) fflush(stderr); } } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1134"><td class="num" id="LN1134">1134</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1135"><td class="num" id="LN1135">1135</td><td class="line">                <span class='macro'>DISPLAYUPDATE(2, <span class='string_literal'>"\rRead : %u / %u MB ==&gt; %.2f%%"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\rRead : %u / %u MB ==&gt; %.2f%%", (unsigned)(inFileSize&gt;&gt;<br>20), (unsigned)(srcFileSize&gt;&gt;20), (double)outFileSize/inFileSize<br>*100); if (g_display_prefs.displayLevel&gt;=4) fflush(stderr)<br>; } } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1136"><td class="num" id="LN1136">1136</td><td class="line">                                <span class='macro'>(<span class='keyword'>unsigned</span>)(inFileSize&gt;&gt;20), (<span class='keyword'>unsigned</span>)(srcFileSize&gt;&gt;20),<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\rRead : %u / %u MB ==&gt; %.2f%%", (unsigned)(inFileSize&gt;&gt;<br>20), (unsigned)(srcFileSize&gt;&gt;20), (double)outFileSize/inFileSize<br>*100); if (g_display_prefs.displayLevel&gt;=4) fflush(stderr)<br>; } } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1137"><td class="num" id="LN1137">1137</td><td class="line">                                <span class='macro'>(<span class='keyword'>double</span>)outFileSize/inFileSize*100)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\rRead : %u / %u MB ==&gt; %.2f%%", (unsigned)(inFileSize&gt;&gt;<br>20), (unsigned)(srcFileSize&gt;&gt;20), (double)outFileSize/inFileSize<br>*100); if (g_display_prefs.displayLevel&gt;=4) fflush(stderr)<br>; } } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1138"><td class="num" id="LN1138">1138</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1139"><td class="num" id="LN1139">1139</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1140"><td class="num" id="LN1140">1140</td><td class="line">            <span class='comment'>/* Write Block */</span></td></tr>
<tr class="codeline" data-linenumber="1141"><td class="num" id="LN1141">1141</td><td class="line">            {   size_t <span class='keyword'>const</span> sizeCheck = fwrite(ress-&gt;dstBuffer, 1, outSize, ress-&gt;dstFile);</td></tr>
<tr class="codeline" data-linenumber="1142"><td class="num" id="LN1142">1142</td><td class="line">                <span class='keyword'>if</span> (sizeCheck != outSize)</td></tr>
<tr class="codeline" data-linenumber="1143"><td class="num" id="LN1143">1143</td><td class="line">                    <span class='macro'>EXM_THROW(36, <span class='string_literal'>"Write error : %s"</span>, strerror(errno))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1143<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 36); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Write error : %s", strerror((*__errno_location<br> ()))); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, " \n"); } }; exit(36); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1144"><td class="num" id="LN1144">1144</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1145"><td class="num" id="LN1145">1145</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1146"><td class="num" id="LN1146">1146</td><td class="line">            <span class='comment'>/* Read next block */</span></td></tr>
<tr class="codeline" data-linenumber="1147"><td class="num" id="LN1147">1147</td><td class="line">            readSize  = fread(ress-&gt;srcBuffer, (size_t)1, (size_t)blockSize, ress-&gt;srcFile);</td></tr>
<tr class="codeline" data-linenumber="1148"><td class="num" id="LN1148">1148</td><td class="line">            inFileSize += readSize;</td></tr>
<tr class="codeline" data-linenumber="1149"><td class="num" id="LN1149">1149</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1150"><td class="num" id="LN1150">1150</td><td class="line">        <span class='keyword'>if</span> (ferror(ress-&gt;srcFile)) <span class='macro'>EXM_THROW(37, <span class='string_literal'>"Error reading %s "</span>, srcFileName)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1150<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 37); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Error reading %s ", srcFileName); }<br> }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; exit(37); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1151"><td class="num" id="LN1151">1151</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1152"><td class="num" id="LN1152">1152</td><td class="line">        <span class='comment'>/* End of Stream mark */</span></td></tr>
<tr class="codeline" data-linenumber="1153"><td class="num" id="LN1153">1153</td><td class="line">        headerSize = LZ4F_compressEnd(ctx, ress-&gt;dstBuffer, ress-&gt;dstBufferSize, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1154"><td class="num" id="LN1154">1154</td><td class="line">        <span class='keyword'>if</span> (LZ4F_isError(headerSize))</td></tr>
<tr class="codeline" data-linenumber="1155"><td class="num" id="LN1155">1155</td><td class="line">            <span class='macro'>EXM_THROW(38, <span class='string_literal'>"zstd: %s: lz4 end of file generation failed : %s"</span>,<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1156<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 38); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "zstd: %s: lz4 end of file generation failed : %s"<br>, srcFileName, LZ4F_getErrorName(headerSize)); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(38);<br> }</span></span></td></tr>
<tr class="codeline" data-linenumber="1156"><td class="num" id="LN1156">1156</td><td class="line">                        <span class='macro'>srcFileName, LZ4F_getErrorName(headerSize))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1156<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 38); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "zstd: %s: lz4 end of file generation failed : %s"<br>, srcFileName, LZ4F_getErrorName(headerSize)); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(38);<br> }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1157"><td class="num" id="LN1157">1157</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1158"><td class="num" id="LN1158">1158</td><td class="line">        {   size_t <span class='keyword'>const</span> sizeCheck = fwrite(ress-&gt;dstBuffer, 1, headerSize, ress-&gt;dstFile);</td></tr>
<tr class="codeline" data-linenumber="1159"><td class="num" id="LN1159">1159</td><td class="line">            <span class='keyword'>if</span> (sizeCheck != headerSize)</td></tr>
<tr class="codeline" data-linenumber="1160"><td class="num" id="LN1160">1160</td><td class="line">                <span class='macro'>EXM_THROW(39, <span class='string_literal'>"Write error : %s (cannot write end of stream)"</span>,<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1161<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 39); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Write error : %s (cannot write end of stream)"<br>, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(39);<br> }</span></span></td></tr>
<tr class="codeline" data-linenumber="1161"><td class="num" id="LN1161">1161</td><td class="line">                            <span class='macro'>strerror(errno))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1161<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 39); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Write error : %s (cannot write end of stream)"<br>, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(39);<br> }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1162"><td class="num" id="LN1162">1162</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1163"><td class="num" id="LN1163">1163</td><td class="line">        outFileSize += headerSize;</td></tr>
<tr class="codeline" data-linenumber="1164"><td class="num" id="LN1164">1164</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1165"><td class="num" id="LN1165">1165</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1166"><td class="num" id="LN1166">1166</td><td class="line">    *readsize = inFileSize;</td></tr>
<tr class="codeline" data-linenumber="1167"><td class="num" id="LN1167">1167</td><td class="line">    LZ4F_freeCompressionContext(ctx);</td></tr>
<tr class="codeline" data-linenumber="1168"><td class="num" id="LN1168">1168</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1169"><td class="num" id="LN1169">1169</td><td class="line">    <span class='keyword'>return</span> outFileSize;</td></tr>
<tr class="codeline" data-linenumber="1170"><td class="num" id="LN1170">1170</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1171"><td class="num" id="LN1171">1171</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1172"><td class="num" id="LN1172">1172</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1173"><td class="num" id="LN1173">1173</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1174"><td class="num" id="LN1174">1174</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span></td></tr>
<tr class="codeline" data-linenumber="1175"><td class="num" id="LN1175">1175</td><td class="line">FIO_compressZstdFrame(FIO_prefs_t* <span class='keyword'>const</span> prefs,</td></tr>
<tr class="codeline" data-linenumber="1176"><td class="num" id="LN1176">1176</td><td class="line">                      <span class='keyword'>const</span> cRess_t* ressPtr,</td></tr>
<tr class="codeline" data-linenumber="1177"><td class="num" id="LN1177">1177</td><td class="line">                      <span class='keyword'>const</span> <span class='keyword'>char</span>* srcFileName, U64 fileSize,</td></tr>
<tr class="codeline" data-linenumber="1178"><td class="num" id="LN1178">1178</td><td class="line">                      <span class='keyword'>int</span> compressionLevel, U64* readsize)</td></tr>
<tr class="codeline" data-linenumber="1179"><td class="num" id="LN1179">1179</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1180"><td class="num" id="LN1180">1180</td><td class="line">    cRess_t <span class='keyword'>const</span> ress = *ressPtr;</td></tr>
<tr class="codeline" data-linenumber="1181"><td class="num" id="LN1181">1181</td><td class="line">    FILE* <span class='keyword'>const</span> srcFile = ress.srcFile;</td></tr>
<tr class="codeline" data-linenumber="1182"><td class="num" id="LN1182">1182</td><td class="line">    FILE* <span class='keyword'>const</span> dstFile = ress.dstFile;</td></tr>
<tr class="codeline" data-linenumber="1183"><td class="num" id="LN1183">1183</td><td class="line">    U64 compressedfilesize = 0;</td></tr>
<tr class="codeline" data-linenumber="1184"><td class="num" id="LN1184">1184</td><td class="line">    ZSTD_EndDirective directive = ZSTD_e_continue;</td></tr>
<tr class="codeline" data-linenumber="1185"><td class="num" id="LN1185">1185</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1186"><td class="num" id="LN1186">1186</td><td class="line">    <span class='comment'>/* stats */</span></td></tr>
<tr class="codeline" data-linenumber="1187"><td class="num" id="LN1187">1187</td><td class="line">    ZSTD_frameProgression previous_zfp_update = { 0, 0, 0, 0, 0, 0 };</td></tr>
<tr class="codeline" data-linenumber="1188"><td class="num" id="LN1188">1188</td><td class="line">    ZSTD_frameProgression previous_zfp_correction = { 0, 0, 0, 0, 0, 0 };</td></tr>
<tr class="codeline" data-linenumber="1189"><td class="num" id="LN1189">1189</td><td class="line">    <span class='keyword'>typedef</span> <span class='keyword'>enum</span> { noChange, slower, faster } speedChange_e;</td></tr>
<tr class="codeline" data-linenumber="1190"><td class="num" id="LN1190">1190</td><td class="line">    speedChange_e speedChange = noChange;</td></tr>
<tr class="codeline" data-linenumber="1191"><td class="num" id="LN1191">1191</td><td class="line">    <span class='keyword'>unsigned</span> flushWaiting = 0;</td></tr>
<tr class="codeline" data-linenumber="1192"><td class="num" id="LN1192">1192</td><td class="line">    <span class='keyword'>unsigned</span> inputPresented = 0;</td></tr>
<tr class="codeline" data-linenumber="1193"><td class="num" id="LN1193">1193</td><td class="line">    <span class='keyword'>unsigned</span> inputBlocked = 0;</td></tr>
<tr class="codeline" data-linenumber="1194"><td class="num" id="LN1194">1194</td><td class="line">    <span class='keyword'>unsigned</span> lastJobID = 0;</td></tr>
<tr class="codeline" data-linenumber="1195"><td class="num" id="LN1195">1195</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1196"><td class="num" id="LN1196">1196</td><td class="line">    <span class='macro'>DISPLAYLEVEL(6, <span class='string_literal'>"compression using zstd format \n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=6) { fprintf(stderr, "compression using zstd format \n"<br>); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1197"><td class="num" id="LN1197">1197</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1198"><td class="num" id="LN1198">1198</td><td class="line">    <span class='comment'>/* init */</span></td></tr>
<tr class="codeline" data-linenumber="1199"><td class="num" id="LN1199">1199</td><td class="line">    <span class='keyword'>if</span> (fileSize != <span class='macro'>UTIL_FILESIZE_UNKNOWN<span class='macro_popup'>((U64)(-1))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1200"><td class="num" id="LN1200">1200</td><td class="line">        <span class='macro'>CHECK(ZSTD_CCtx_setPledgedSrcSize(ress.cctx, fileSize))<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setPledgedSrcSize(ress.cctx, fileSize<br>); if (ERR_isError(err)) { { if (g_display_prefs.displayLevel<br>&gt;=5) { fprintf(stderr, "%s \n", "ZSTD_CCtx_setPledgedSrcSize(ress.cctx, fileSize)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 1200); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1201"><td class="num" id="LN1201">1201</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (prefs-&gt;streamSrcSize &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="1202"><td class="num" id="LN1202">1202</td><td class="line">      <span class='comment'>/* unknown source size; use the declared stream size */</span></td></tr>
<tr class="codeline" data-linenumber="1203"><td class="num" id="LN1203">1203</td><td class="line">      <span class='macro'>CHECK( ZSTD_CCtx_setPledgedSrcSize(ress.cctx, prefs-&gt;streamSrcSize) )<span class='macro_popup'>{ size_t err; err = ZSTD_CCtx_setPledgedSrcSize(ress.cctx, prefs<br>-&gt;streamSrcSize); if (ERR_isError(err)) { { if (g_display_prefs<br>.displayLevel&gt;=5) { fprintf(stderr, "%s \n", "ZSTD_CCtx_setPledgedSrcSize(ress.cctx, prefs-&gt;streamSrcSize)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 1203); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1204"><td class="num" id="LN1204">1204</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1205"><td class="num" id="LN1205">1205</td><td class="line">    (<span class='keyword'>void</span>)srcFileName;</td></tr>
<tr class="codeline" data-linenumber="1206"><td class="num" id="LN1206">1206</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1207"><td class="num" id="LN1207">1207</td><td class="line">    <span class='comment'>/* Main compression loop */</span></td></tr>
<tr class="codeline" data-linenumber="1208"><td class="num" id="LN1208">1208</td><td class="line">    <span class='keyword'>do</span> {</td></tr>
<tr class="codeline" data-linenumber="1209"><td class="num" id="LN1209">1209</td><td class="line">        size_t stillToFlush;</td></tr>
<tr class="codeline" data-linenumber="1210"><td class="num" id="LN1210">1210</td><td class="line">        <span class='comment'>/* Fill input Buffer */</span></td></tr>
<tr class="codeline" data-linenumber="1211"><td class="num" id="LN1211">1211</td><td class="line">        size_t <span class='keyword'>const</span> inSize = fread(ress.srcBuffer, (size_t)1, ress.srcBufferSize, srcFile);</td></tr>
<tr class="codeline" data-linenumber="1212"><td class="num" id="LN1212">1212</td><td class="line">        ZSTD_inBuffer inBuff = { ress.srcBuffer, inSize, 0 };</td></tr>
<tr class="codeline" data-linenumber="1213"><td class="num" id="LN1213">1213</td><td class="line">        <span class='macro'>DISPLAYLEVEL(6, <span class='string_literal'>"fread %u bytes from source \n"</span>, (<span class='keyword'>unsigned</span>)inSize)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=6) { fprintf(stderr, "fread %u bytes from source \n"<br>, (unsigned)inSize); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1214"><td class="num" id="LN1214">1214</td><td class="line">        *readsize += inSize;</td></tr>
<tr class="codeline" data-linenumber="1215"><td class="num" id="LN1215">1215</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1216"><td class="num" id="LN1216">1216</td><td class="line">        <span class='keyword'>if</span> ((inSize == 0) || (*readsize == fileSize))</td></tr>
<tr class="codeline" data-linenumber="1217"><td class="num" id="LN1217">1217</td><td class="line">            directive = ZSTD_e_end;</td></tr>
<tr class="codeline" data-linenumber="1218"><td class="num" id="LN1218">1218</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1219"><td class="num" id="LN1219">1219</td><td class="line">        stillToFlush = 1;</td></tr>
<tr class="codeline" data-linenumber="1220"><td class="num" id="LN1220">1220</td><td class="line">        <span class='keyword'>while</span> ((inBuff.pos != inBuff.size)   <span class='comment'>/* input buffer must be entirely ingested */</span></td></tr>
<tr class="codeline" data-linenumber="1221"><td class="num" id="LN1221">1221</td><td class="line">            || (directive == ZSTD_e_end &amp;&amp; stillToFlush != 0) ) {</td></tr>
<tr class="codeline" data-linenumber="1222"><td class="num" id="LN1222">1222</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1223"><td class="num" id="LN1223">1223</td><td class="line">            size_t <span class='keyword'>const</span> oldIPos = inBuff.pos;</td></tr>
<tr class="codeline" data-linenumber="1224"><td class="num" id="LN1224">1224</td><td class="line">            ZSTD_outBuffer outBuff = { ress.dstBuffer, ress.dstBufferSize, 0 };</td></tr>
<tr class="codeline" data-linenumber="1225"><td class="num" id="LN1225">1225</td><td class="line">            size_t <span class='keyword'>const</span> toFlushNow = ZSTD_toFlushNow(ress.cctx);</td></tr>
<tr class="codeline" data-linenumber="1226"><td class="num" id="LN1226">1226</td><td class="line">            <span class='macro'>CHECK_V(stillToFlush, ZSTD_compressStream2(ress.cctx, &amp;outBuff, &amp;inBuff, directive))<span class='macro_popup'>stillToFlush = ZSTD_compressStream2(ress.cctx, &amp;outBuff, &amp;<br>inBuff, directive); if (ERR_isError(stillToFlush)) { { if (g_display_prefs<br>.displayLevel&gt;=5) { fprintf(stderr, "%s \n", "ZSTD_compressStream2(ress.cctx, &amp;outBuff, &amp;inBuff, directive)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 1226); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(stillToFlush<br>)); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(<br>stderr, " \n"); } }; exit(11); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1227"><td class="num" id="LN1227">1227</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1228"><td class="num" id="LN1228">1228</td><td class="line">            <span class='comment'>/* count stats */</span></td></tr>
<tr class="codeline" data-linenumber="1229"><td class="num" id="LN1229">1229</td><td class="line">            inputPresented++;</td></tr>
<tr class="codeline" data-linenumber="1230"><td class="num" id="LN1230">1230</td><td class="line">            <span class='keyword'>if</span> (oldIPos == inBuff.pos) inputBlocked++;  <span class='comment'>/* input buffer is full and can't take any more : input speed is faster than consumption rate */</span></td></tr>
<tr class="codeline" data-linenumber="1231"><td class="num" id="LN1231">1231</td><td class="line">            <span class='keyword'>if</span> (!toFlushNow) flushWaiting = 1;</td></tr>
<tr class="codeline" data-linenumber="1232"><td class="num" id="LN1232">1232</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1233"><td class="num" id="LN1233">1233</td><td class="line">            <span class='comment'>/* Write compressed stream */</span></td></tr>
<tr class="codeline" data-linenumber="1234"><td class="num" id="LN1234">1234</td><td class="line">            <span class='macro'>DISPLAYLEVEL(6, <span class='string_literal'>"ZSTD_compress_generic(end:%u) =&gt; input pos(%u)&lt;=(%u)size ; output generated %u bytes \n"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=6) { fprintf(stderr, "ZSTD_compress_generic(end:%u) =&gt; input pos(%u)&lt;=(%u)size ; output generated %u bytes \n"<br>, (unsigned)directive, (unsigned)inBuff.pos, (unsigned)inBuff<br>.size, (unsigned)outBuff.pos); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1235"><td class="num" id="LN1235">1235</td><td class="line">                            <span class='macro'>(<span class='keyword'>unsigned</span>)directive, (<span class='keyword'>unsigned</span>)inBuff.pos, (<span class='keyword'>unsigned</span>)inBuff.size, (<span class='keyword'>unsigned</span>)outBuff.pos)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=6) { fprintf(stderr, "ZSTD_compress_generic(end:%u) =&gt; input pos(%u)&lt;=(%u)size ; output generated %u bytes \n"<br>, (unsigned)directive, (unsigned)inBuff.pos, (unsigned)inBuff<br>.size, (unsigned)outBuff.pos); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1236"><td class="num" id="LN1236">1236</td><td class="line">            <span class='keyword'>if</span> (outBuff.pos) {</td></tr>
<tr class="codeline" data-linenumber="1237"><td class="num" id="LN1237">1237</td><td class="line">                size_t <span class='keyword'>const</span> sizeCheck = fwrite(ress.dstBuffer, 1, outBuff.pos, dstFile);</td></tr>
<tr class="codeline" data-linenumber="1238"><td class="num" id="LN1238">1238</td><td class="line">                <span class='keyword'>if</span> (sizeCheck != outBuff.pos)</td></tr>
<tr class="codeline" data-linenumber="1239"><td class="num" id="LN1239">1239</td><td class="line">                    <span class='macro'>EXM_THROW(25, <span class='string_literal'>"Write error : %s (cannot write compressed block)"</span>,<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1240<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 25); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Write error : %s (cannot write compressed block)"<br>, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(25);<br> }</span></span></td></tr>
<tr class="codeline" data-linenumber="1240"><td class="num" id="LN1240">1240</td><td class="line">                                    <span class='macro'>strerror(errno))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1240<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 25); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Write error : %s (cannot write compressed block)"<br>, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(25);<br> }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1241"><td class="num" id="LN1241">1241</td><td class="line">                compressedfilesize += outBuff.pos;</td></tr>
<tr class="codeline" data-linenumber="1242"><td class="num" id="LN1242">1242</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1243"><td class="num" id="LN1243">1243</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1244"><td class="num" id="LN1244">1244</td><td class="line">            <span class='comment'>/* display notification; and adapt compression level */</span></td></tr>
<tr class="codeline" data-linenumber="1245"><td class="num" id="LN1245">1245</td><td class="line">            <span class='keyword'>if</span> (<span class='macro'>READY_FOR_UPDATE()<span class='macro_popup'>(!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro(g_displayClock<br>) &gt; g_refreshRate)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1246"><td class="num" id="LN1246">1246</td><td class="line">                ZSTD_frameProgression <span class='keyword'>const</span> zfp = ZSTD_getFrameProgression(ress.cctx);</td></tr>
<tr class="codeline" data-linenumber="1247"><td class="num" id="LN1247">1247</td><td class="line">                <span class='keyword'>double</span> <span class='keyword'>const</span> cShare = (<span class='keyword'>double</span>)zfp.produced / (zfp.consumed + !zfp.consumed<span class='comment'>/*avoid div0*/</span>) * 100;</td></tr>
<tr class="codeline" data-linenumber="1248"><td class="num" id="LN1248">1248</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1249"><td class="num" id="LN1249">1249</td><td class="line">                <span class='comment'>/* display progress notifications */</span></td></tr>
<tr class="codeline" data-linenumber="1250"><td class="num" id="LN1250">1250</td><td class="line">                <span class='keyword'>if</span> (g_display_prefs.displayLevel &gt;= 3) {</td></tr>
<tr class="codeline" data-linenumber="1251"><td class="num" id="LN1251">1251</td><td class="line">                    <span class='macro'>DISPLAYUPDATE(3, <span class='string_literal'>"\r(L%i) Buffered :%4u MB - Consumed :%4u MB - Compressed :%4u MB =&gt; %.2f%% "</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=3 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\r(L%i) Buffered :%4u MB - Consumed :%4u MB - Compressed :%4u MB =&gt; %.2f%% "<br>, compressionLevel, (unsigned)((zfp.ingested - zfp.consumed) &gt;&gt;<br> 20), (unsigned)(zfp.consumed &gt;&gt; 20), (unsigned)(zfp.produced<br> &gt;&gt; 20), cShare); if (g_display_prefs.displayLevel&gt;=<br>4) fflush(stderr); } } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1252"><td class="num" id="LN1252">1252</td><td class="line">                                <span class='macro'>compressionLevel,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=3 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\r(L%i) Buffered :%4u MB - Consumed :%4u MB - Compressed :%4u MB =&gt; %.2f%% "<br>, compressionLevel, (unsigned)((zfp.ingested - zfp.consumed) &gt;&gt;<br> 20), (unsigned)(zfp.consumed &gt;&gt; 20), (unsigned)(zfp.produced<br> &gt;&gt; 20), cShare); if (g_display_prefs.displayLevel&gt;=<br>4) fflush(stderr); } } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1253"><td class="num" id="LN1253">1253</td><td class="line">                                <span class='macro'>(<span class='keyword'>unsigned</span>)((zfp.ingested - zfp.consumed) &gt;&gt; 20),<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=3 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\r(L%i) Buffered :%4u MB - Consumed :%4u MB - Compressed :%4u MB =&gt; %.2f%% "<br>, compressionLevel, (unsigned)((zfp.ingested - zfp.consumed) &gt;&gt;<br> 20), (unsigned)(zfp.consumed &gt;&gt; 20), (unsigned)(zfp.produced<br> &gt;&gt; 20), cShare); if (g_display_prefs.displayLevel&gt;=<br>4) fflush(stderr); } } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1254"><td class="num" id="LN1254">1254</td><td class="line">                                <span class='macro'>(<span class='keyword'>unsigned</span>)(zfp.consumed &gt;&gt; 20),<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=3 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\r(L%i) Buffered :%4u MB - Consumed :%4u MB - Compressed :%4u MB =&gt; %.2f%% "<br>, compressionLevel, (unsigned)((zfp.ingested - zfp.consumed) &gt;&gt;<br> 20), (unsigned)(zfp.consumed &gt;&gt; 20), (unsigned)(zfp.produced<br> &gt;&gt; 20), cShare); if (g_display_prefs.displayLevel&gt;=<br>4) fflush(stderr); } } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1255"><td class="num" id="LN1255">1255</td><td class="line">                                <span class='macro'>(<span class='keyword'>unsigned</span>)(zfp.produced &gt;&gt; 20),<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=3 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\r(L%i) Buffered :%4u MB - Consumed :%4u MB - Compressed :%4u MB =&gt; %.2f%% "<br>, compressionLevel, (unsigned)((zfp.ingested - zfp.consumed) &gt;&gt;<br> 20), (unsigned)(zfp.consumed &gt;&gt; 20), (unsigned)(zfp.produced<br> &gt;&gt; 20), cShare); if (g_display_prefs.displayLevel&gt;=<br>4) fflush(stderr); } } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1256"><td class="num" id="LN1256">1256</td><td class="line">                                <span class='macro'>cShare )<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=3 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\r(L%i) Buffered :%4u MB - Consumed :%4u MB - Compressed :%4u MB =&gt; %.2f%% "<br>, compressionLevel, (unsigned)((zfp.ingested - zfp.consumed) &gt;&gt;<br> 20), (unsigned)(zfp.consumed &gt;&gt; 20), (unsigned)(zfp.produced<br> &gt;&gt; 20), cShare); if (g_display_prefs.displayLevel&gt;=<br>4) fflush(stderr); } } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1257"><td class="num" id="LN1257">1257</td><td class="line">                } <span class='keyword'>else</span> {   <span class='comment'>/* summarized notifications if == 2; */</span></td></tr>
<tr class="codeline" data-linenumber="1258"><td class="num" id="LN1258">1258</td><td class="line">                    <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"\rRead : %u "</span>, (<span class='keyword'>unsigned</span>)(zfp.consumed &gt;&gt; 20))<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2) { fprintf(stderr, "\rRead : %u "<br>, (unsigned)(zfp.consumed &gt;&gt; 20)); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1259"><td class="num" id="LN1259">1259</td><td class="line">                    <span class='keyword'>if</span> (fileSize != <span class='macro'>UTIL_FILESIZE_UNKNOWN<span class='macro_popup'>((U64)(-1))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1260"><td class="num" id="LN1260">1260</td><td class="line">                        <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"/ %u "</span>, (<span class='keyword'>unsigned</span>)(fileSize &gt;&gt; 20))<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2) { fprintf(stderr, "/ %u "<br>, (unsigned)(fileSize &gt;&gt; 20)); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1261"><td class="num" id="LN1261">1261</td><td class="line">                    <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"MB ==&gt; %2.f%% "</span>, cShare)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2) { fprintf(stderr, "MB ==&gt; %2.f%% "<br>, cShare); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1262"><td class="num" id="LN1262">1262</td><td class="line">                    <span class='macro'>DELAY_NEXT_UPDATE()<span class='macro_popup'>{ g_displayClock = UTIL_getTime(); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1263"><td class="num" id="LN1263">1263</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1264"><td class="num" id="LN1264">1264</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1265"><td class="num" id="LN1265">1265</td><td class="line">                <span class='comment'>/* adaptive mode : statistics measurement and speed correction */</span></td></tr>
<tr class="codeline" data-linenumber="1266"><td class="num" id="LN1266">1266</td><td class="line">                <span class='keyword'>if</span> (prefs-&gt;adaptiveMode) {</td></tr>
<tr class="codeline" data-linenumber="1267"><td class="num" id="LN1267">1267</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1268"><td class="num" id="LN1268">1268</td><td class="line">                    <span class='comment'>/* check output speed */</span></td></tr>
<tr class="codeline" data-linenumber="1269"><td class="num" id="LN1269">1269</td><td class="line">                    <span class='keyword'>if</span> (zfp.currentJobID &gt; 1) {  <span class='comment'>/* only possible if nbWorkers &gt;= 1 */</span></td></tr>
<tr class="codeline" data-linenumber="1270"><td class="num" id="LN1270">1270</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1271"><td class="num" id="LN1271">1271</td><td class="line">                        <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> newlyProduced = zfp.produced - previous_zfp_update.produced;</td></tr>
<tr class="codeline" data-linenumber="1272"><td class="num" id="LN1272">1272</td><td class="line">                        <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> newlyFlushed = zfp.flushed - previous_zfp_update.flushed;</td></tr>
<tr class="codeline" data-linenumber="1273"><td class="num" id="LN1273">1273</td><td class="line">                        <span class='macro'>assert(zfp.produced &gt;= previous_zfp_update.produced)<span class='macro_popup'>((void) sizeof ((zfp.produced &gt;= previous_zfp_update.produced<br>) ? 1 : 0), __extension__ ({ if (zfp.produced &gt;= previous_zfp_update<br>.produced) ; else __assert_fail ("zfp.produced &gt;= previous_zfp_update.produced"<br>, "fileio.c", 1273, __extension__ __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1274"><td class="num" id="LN1274">1274</td><td class="line">                        <span class='macro'>assert(prefs-&gt;nbWorkers &gt;= 1)<span class='macro_popup'>((void) sizeof ((prefs-&gt;nbWorkers &gt;= 1) ? 1 : 0), __extension__<br> ({ if (prefs-&gt;nbWorkers &gt;= 1) ; else __assert_fail ("prefs-&gt;nbWorkers &gt;= 1"<br>, "fileio.c", 1274, __extension__ __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1275"><td class="num" id="LN1275">1275</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1276"><td class="num" id="LN1276">1276</td><td class="line">                        <span class='comment'>/* test if compression is blocked</span></td></tr>
<tr class="codeline" data-linenumber="1277"><td class="num" id="LN1277">1277</td><td class="line">                         <span class='comment'>* either because output is slow and all buffers are full</span></td></tr>
<tr class="codeline" data-linenumber="1278"><td class="num" id="LN1278">1278</td><td class="line">                         <span class='comment'>* or because input is slow and no job can start while waiting for at least one buffer to be filled.</span></td></tr>
<tr class="codeline" data-linenumber="1279"><td class="num" id="LN1279">1279</td><td class="line">                         <span class='comment'>* note : exclude starting part, since currentJobID &gt; 1 */</span></td></tr>
<tr class="codeline" data-linenumber="1280"><td class="num" id="LN1280">1280</td><td class="line">                        <span class='keyword'>if</span> ( (zfp.consumed == previous_zfp_update.consumed)   <span class='comment'>/* no data compressed : no data available, or no more buffer to compress to, OR compression is really slow (compression of a single block is slower than update rate)*/</span></td></tr>
<tr class="codeline" data-linenumber="1281"><td class="num" id="LN1281">1281</td><td class="line">                          &amp;&amp; (zfp.nbActiveWorkers == 0)                       <span class='comment'>/* confirmed : no compression ongoing */</span></td></tr>
<tr class="codeline" data-linenumber="1282"><td class="num" id="LN1282">1282</td><td class="line">                          ) {</td></tr>
<tr class="codeline" data-linenumber="1283"><td class="num" id="LN1283">1283</td><td class="line">                            <span class='macro'>DISPLAYLEVEL(6, <span class='string_literal'>"all buffers full : compression stopped =&gt; slow down \n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=6) { fprintf(stderr, "all buffers full : compression stopped =&gt; slow down \n"<br>); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1284"><td class="num" id="LN1284">1284</td><td class="line">                            speedChange = slower;</td></tr>
<tr class="codeline" data-linenumber="1285"><td class="num" id="LN1285">1285</td><td class="line">                        }</td></tr>
<tr class="codeline" data-linenumber="1286"><td class="num" id="LN1286">1286</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1287"><td class="num" id="LN1287">1287</td><td class="line">                        previous_zfp_update = zfp;</td></tr>
<tr class="codeline" data-linenumber="1288"><td class="num" id="LN1288">1288</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1289"><td class="num" id="LN1289">1289</td><td class="line">                        <span class='keyword'>if</span> ( (newlyProduced &gt; (newlyFlushed * 9 / 8))   <span class='comment'>/* compression produces more data than output can flush (though production can be spiky, due to work unit : (N==4)*block sizes) */</span></td></tr>
<tr class="codeline" data-linenumber="1290"><td class="num" id="LN1290">1290</td><td class="line">                          &amp;&amp; (flushWaiting == 0)                        <span class='comment'>/* flush speed was never slowed by lack of production, so it's operating at max capacity */</span></td></tr>
<tr class="codeline" data-linenumber="1291"><td class="num" id="LN1291">1291</td><td class="line">                          ) {</td></tr>
<tr class="codeline" data-linenumber="1292"><td class="num" id="LN1292">1292</td><td class="line">                            <span class='macro'>DISPLAYLEVEL(6, <span class='string_literal'>"compression faster than flush (%llu &gt; %llu), and flushed was never slowed down by lack of production =&gt; slow down \n"</span>, newlyProduced, newlyFlushed)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=6) { fprintf(stderr, "compression faster than flush (%llu &gt; %llu), and flushed was never slowed down by lack of production =&gt; slow down \n"<br>, newlyProduced, newlyFlushed); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1293"><td class="num" id="LN1293">1293</td><td class="line">                            speedChange = slower;</td></tr>
<tr class="codeline" data-linenumber="1294"><td class="num" id="LN1294">1294</td><td class="line">                        }</td></tr>
<tr class="codeline" data-linenumber="1295"><td class="num" id="LN1295">1295</td><td class="line">                        flushWaiting = 0;</td></tr>
<tr class="codeline" data-linenumber="1296"><td class="num" id="LN1296">1296</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="1297"><td class="num" id="LN1297">1297</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1298"><td class="num" id="LN1298">1298</td><td class="line">                    <span class='comment'>/* course correct only if there is at least one new job completed */</span></td></tr>
<tr class="codeline" data-linenumber="1299"><td class="num" id="LN1299">1299</td><td class="line">                    <span class='keyword'>if</span> (zfp.currentJobID &gt; lastJobID) {</td></tr>
<tr class="codeline" data-linenumber="1300"><td class="num" id="LN1300">1300</td><td class="line">                        <span class='macro'>DISPLAYLEVEL(6, <span class='string_literal'>"compression level adaptation check \n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=6) { fprintf(stderr, "compression level adaptation check \n"<br>); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1301"><td class="num" id="LN1301">1301</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1302"><td class="num" id="LN1302">1302</td><td class="line">                        <span class='comment'>/* check input speed */</span></td></tr>
<tr class="codeline" data-linenumber="1303"><td class="num" id="LN1303">1303</td><td class="line">                        <span class='keyword'>if</span> (zfp.currentJobID &gt; (<span class='keyword'>unsigned</span>)(prefs-&gt;nbWorkers+1)) {   <span class='comment'>/* warm up period, to fill all workers */</span></td></tr>
<tr class="codeline" data-linenumber="1304"><td class="num" id="LN1304">1304</td><td class="line">                            <span class='keyword'>if</span> (inputBlocked &lt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="1305"><td class="num" id="LN1305">1305</td><td class="line">                                <span class='macro'>DISPLAYLEVEL(6, <span class='string_literal'>"input is never blocked =&gt; input is slower than ingestion \n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=6) { fprintf(stderr, "input is never blocked =&gt; input is slower than ingestion \n"<br>); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1306"><td class="num" id="LN1306">1306</td><td class="line">                                speedChange = slower;</td></tr>
<tr class="codeline" data-linenumber="1307"><td class="num" id="LN1307">1307</td><td class="line">                            } <span class='keyword'>else</span> <span class='keyword'>if</span> (speedChange == noChange) {</td></tr>
<tr class="codeline" data-linenumber="1308"><td class="num" id="LN1308">1308</td><td class="line">                                <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> newlyIngested = zfp.ingested - previous_zfp_correction.ingested;</td></tr>
<tr class="codeline" data-linenumber="1309"><td class="num" id="LN1309">1309</td><td class="line">                                <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> newlyConsumed = zfp.consumed - previous_zfp_correction.consumed;</td></tr>
<tr class="codeline" data-linenumber="1310"><td class="num" id="LN1310">1310</td><td class="line">                                <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> newlyProduced = zfp.produced - previous_zfp_correction.produced;</td></tr>
<tr class="codeline" data-linenumber="1311"><td class="num" id="LN1311">1311</td><td class="line">                                <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> newlyFlushed  = zfp.flushed  - previous_zfp_correction.flushed;</td></tr>
<tr class="codeline" data-linenumber="1312"><td class="num" id="LN1312">1312</td><td class="line">                                previous_zfp_correction = zfp;</td></tr>
<tr class="codeline" data-linenumber="1313"><td class="num" id="LN1313">1313</td><td class="line">                                <span class='macro'>assert(inputPresented &gt; 0)<span class='macro_popup'>((void) sizeof ((inputPresented &gt; 0) ? 1 : 0), __extension__<br> ({ if (inputPresented &gt; 0) ; else __assert_fail ("inputPresented &gt; 0"<br>, "fileio.c", 1313, __extension__ __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1314"><td class="num" id="LN1314">1314</td><td class="line">                                <span class='macro'>DISPLAYLEVEL(6, <span class='string_literal'>"input blocked %u/%u(%.2f) - ingested:%u vs %u:consumed - flushed:%u vs %u:produced \n"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=6) { fprintf(stderr, "input blocked %u/%u(%.2f) - ingested:%u vs %u:consumed - flushed:%u vs %u:produced \n"<br>, inputBlocked, inputPresented, (double)inputBlocked/inputPresented<br>*100, (unsigned)newlyIngested, (unsigned)newlyConsumed, (unsigned<br>)newlyFlushed, (unsigned)newlyProduced); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1315"><td class="num" id="LN1315">1315</td><td class="line">                                                <span class='macro'>inputBlocked, inputPresented, (<span class='keyword'>double</span>)inputBlocked/inputPresented*100,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=6) { fprintf(stderr, "input blocked %u/%u(%.2f) - ingested:%u vs %u:consumed - flushed:%u vs %u:produced \n"<br>, inputBlocked, inputPresented, (double)inputBlocked/inputPresented<br>*100, (unsigned)newlyIngested, (unsigned)newlyConsumed, (unsigned<br>)newlyFlushed, (unsigned)newlyProduced); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1316"><td class="num" id="LN1316">1316</td><td class="line">                                                <span class='macro'>(<span class='keyword'>unsigned</span>)newlyIngested, (<span class='keyword'>unsigned</span>)newlyConsumed,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=6) { fprintf(stderr, "input blocked %u/%u(%.2f) - ingested:%u vs %u:consumed - flushed:%u vs %u:produced \n"<br>, inputBlocked, inputPresented, (double)inputBlocked/inputPresented<br>*100, (unsigned)newlyIngested, (unsigned)newlyConsumed, (unsigned<br>)newlyFlushed, (unsigned)newlyProduced); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1317"><td class="num" id="LN1317">1317</td><td class="line">                                                <span class='macro'>(<span class='keyword'>unsigned</span>)newlyFlushed, (<span class='keyword'>unsigned</span>)newlyProduced)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=6) { fprintf(stderr, "input blocked %u/%u(%.2f) - ingested:%u vs %u:consumed - flushed:%u vs %u:produced \n"<br>, inputBlocked, inputPresented, (double)inputBlocked/inputPresented<br>*100, (unsigned)newlyIngested, (unsigned)newlyConsumed, (unsigned<br>)newlyFlushed, (unsigned)newlyProduced); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1318"><td class="num" id="LN1318">1318</td><td class="line">                                <span class='keyword'>if</span> ( (inputBlocked &gt; inputPresented / 8)     <span class='comment'>/* input is waiting often, because input buffers is full : compression or output too slow */</span></td></tr>
<tr class="codeline" data-linenumber="1319"><td class="num" id="LN1319">1319</td><td class="line">                                  &amp;&amp; (newlyFlushed * 33 / 32 &gt; newlyProduced)  <span class='comment'>/* flush everything that is produced */</span></td></tr>
<tr class="codeline" data-linenumber="1320"><td class="num" id="LN1320">1320</td><td class="line">                                  &amp;&amp; (newlyIngested * 33 / 32 &gt; newlyConsumed) <span class='comment'>/* input speed as fast or faster than compression speed */</span></td></tr>
<tr class="codeline" data-linenumber="1321"><td class="num" id="LN1321">1321</td><td class="line">                                ) {</td></tr>
<tr class="codeline" data-linenumber="1322"><td class="num" id="LN1322">1322</td><td class="line">                                    <span class='macro'>DISPLAYLEVEL(6, <span class='string_literal'>"recommend faster as in(%llu) &gt;= (%llu)comp(%llu) &lt;= out(%llu) \n"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=6) { fprintf(stderr, "recommend faster as in(%llu) &gt;= (%llu)comp(%llu) &lt;= out(%llu) \n"<br>, newlyIngested, newlyConsumed, newlyProduced, newlyFlushed);<br> } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1323"><td class="num" id="LN1323">1323</td><td class="line">                                                    <span class='macro'>newlyIngested, newlyConsumed, newlyProduced, newlyFlushed)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=6) { fprintf(stderr, "recommend faster as in(%llu) &gt;= (%llu)comp(%llu) &lt;= out(%llu) \n"<br>, newlyIngested, newlyConsumed, newlyProduced, newlyFlushed);<br> } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1324"><td class="num" id="LN1324">1324</td><td class="line">                                    speedChange = faster;</td></tr>
<tr class="codeline" data-linenumber="1325"><td class="num" id="LN1325">1325</td><td class="line">                                }</td></tr>
<tr class="codeline" data-linenumber="1326"><td class="num" id="LN1326">1326</td><td class="line">                            }</td></tr>
<tr class="codeline" data-linenumber="1327"><td class="num" id="LN1327">1327</td><td class="line">                            inputBlocked = 0;</td></tr>
<tr class="codeline" data-linenumber="1328"><td class="num" id="LN1328">1328</td><td class="line">                            inputPresented = 0;</td></tr>
<tr class="codeline" data-linenumber="1329"><td class="num" id="LN1329">1329</td><td class="line">                        }</td></tr>
<tr class="codeline" data-linenumber="1330"><td class="num" id="LN1330">1330</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1331"><td class="num" id="LN1331">1331</td><td class="line">                        <span class='keyword'>if</span> (speedChange == slower) {</td></tr>
<tr class="codeline" data-linenumber="1332"><td class="num" id="LN1332">1332</td><td class="line">                            <span class='macro'>DISPLAYLEVEL(6, <span class='string_literal'>"slower speed , higher compression \n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=6) { fprintf(stderr, "slower speed , higher compression \n"<br>); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1333"><td class="num" id="LN1333">1333</td><td class="line">                            compressionLevel ++;</td></tr>
<tr class="codeline" data-linenumber="1334"><td class="num" id="LN1334">1334</td><td class="line">                            <span class='keyword'>if</span> (compressionLevel &gt; ZSTD_maxCLevel()) compressionLevel = ZSTD_maxCLevel();</td></tr>
<tr class="codeline" data-linenumber="1335"><td class="num" id="LN1335">1335</td><td class="line">                            <span class='keyword'>if</span> (compressionLevel &gt; prefs-&gt;maxAdaptLevel) compressionLevel = prefs-&gt;maxAdaptLevel;</td></tr>
<tr class="codeline" data-linenumber="1336"><td class="num" id="LN1336">1336</td><td class="line">                            compressionLevel += (compressionLevel == 0);   <span class='comment'>/* skip 0 */</span></td></tr>
<tr class="codeline" data-linenumber="1337"><td class="num" id="LN1337">1337</td><td class="line">                            ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_compressionLevel, compressionLevel);</td></tr>
<tr class="codeline" data-linenumber="1338"><td class="num" id="LN1338">1338</td><td class="line">                        }</td></tr>
<tr class="codeline" data-linenumber="1339"><td class="num" id="LN1339">1339</td><td class="line">                        <span class='keyword'>if</span> (speedChange == faster) {</td></tr>
<tr class="codeline" data-linenumber="1340"><td class="num" id="LN1340">1340</td><td class="line">                            <span class='macro'>DISPLAYLEVEL(6, <span class='string_literal'>"faster speed , lighter compression \n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=6) { fprintf(stderr, "faster speed , lighter compression \n"<br>); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1341"><td class="num" id="LN1341">1341</td><td class="line">                            compressionLevel --;</td></tr>
<tr class="codeline" data-linenumber="1342"><td class="num" id="LN1342">1342</td><td class="line">                            <span class='keyword'>if</span> (compressionLevel &lt; prefs-&gt;minAdaptLevel) compressionLevel = prefs-&gt;minAdaptLevel;</td></tr>
<tr class="codeline" data-linenumber="1343"><td class="num" id="LN1343">1343</td><td class="line">                            compressionLevel -= (compressionLevel == 0);   <span class='comment'>/* skip 0 */</span></td></tr>
<tr class="codeline" data-linenumber="1344"><td class="num" id="LN1344">1344</td><td class="line">                            ZSTD_CCtx_setParameter(ress.cctx, ZSTD_c_compressionLevel, compressionLevel);</td></tr>
<tr class="codeline" data-linenumber="1345"><td class="num" id="LN1345">1345</td><td class="line">                        }</td></tr>
<tr class="codeline" data-linenumber="1346"><td class="num" id="LN1346">1346</td><td class="line">                        speedChange = noChange;</td></tr>
<tr class="codeline" data-linenumber="1347"><td class="num" id="LN1347">1347</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1348"><td class="num" id="LN1348">1348</td><td class="line">                        lastJobID = zfp.currentJobID;</td></tr>
<tr class="codeline" data-linenumber="1349"><td class="num" id="LN1349">1349</td><td class="line">                    }  <span class='comment'>/* if (zfp.currentJobID &gt; lastJobID) */</span></td></tr>
<tr class="codeline" data-linenumber="1350"><td class="num" id="LN1350">1350</td><td class="line">                }  <span class='comment'>/* if (g_adaptiveMode) */</span></td></tr>
<tr class="codeline" data-linenumber="1351"><td class="num" id="LN1351">1351</td><td class="line">            }  <span class='comment'>/* if (READY_FOR_UPDATE()) */</span></td></tr>
<tr class="codeline" data-linenumber="1352"><td class="num" id="LN1352">1352</td><td class="line">        }  <span class='comment'>/* while ((inBuff.pos != inBuff.size) */</span></td></tr>
<tr class="codeline" data-linenumber="1353"><td class="num" id="LN1353">1353</td><td class="line">    } <span class='keyword'>while</span> (directive != ZSTD_e_end);</td></tr>
<tr class="codeline" data-linenumber="1354"><td class="num" id="LN1354">1354</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1355"><td class="num" id="LN1355">1355</td><td class="line">    <span class='keyword'>if</span> (ferror(srcFile)) {</td></tr>
<tr class="codeline" data-linenumber="1356"><td class="num" id="LN1356">1356</td><td class="line">        <span class='macro'>EXM_THROW(26, <span class='string_literal'>"Read error : I/O error"</span>)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1356<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 26); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Read error : I/O error"); } }; { if<br> (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(26); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1357"><td class="num" id="LN1357">1357</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1358"><td class="num" id="LN1358">1358</td><td class="line">    <span class='keyword'>if</span> (fileSize != <span class='macro'>UTIL_FILESIZE_UNKNOWN<span class='macro_popup'>((U64)(-1))</span></span> &amp;&amp; *readsize != fileSize) {</td></tr>
<tr class="codeline" data-linenumber="1359"><td class="num" id="LN1359">1359</td><td class="line">        <span class='macro'>EXM_THROW(27, <span class='string_literal'>"Read error : Incomplete read : %llu / %llu B"</span>,<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1360<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 27); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Read error : Incomplete read : %llu / %llu B"<br>, (unsigned long long)*readsize, (unsigned long long)fileSize<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; exit(27); }</span></span></td></tr>
<tr class="codeline" data-linenumber="1360"><td class="num" id="LN1360">1360</td><td class="line">                <span class='macro'>(<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>)*readsize, (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>)fileSize)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1360<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 27); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Read error : Incomplete read : %llu / %llu B"<br>, (unsigned long long)*readsize, (unsigned long long)fileSize<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; exit(27); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1361"><td class="num" id="LN1361">1361</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1362"><td class="num" id="LN1362">1362</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1363"><td class="num" id="LN1363">1363</td><td class="line">    <span class='keyword'>return</span> compressedfilesize;</td></tr>
<tr class="codeline" data-linenumber="1364"><td class="num" id="LN1364">1364</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1365"><td class="num" id="LN1365">1365</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1366"><td class="num" id="LN1366">1366</td><td class="line"><span class='comment'>/*! FIO_compressFilename_internal() :</span></td></tr>
<tr class="codeline" data-linenumber="1367"><td class="num" id="LN1367">1367</td><td class="line"> <span class='comment'>*  same as FIO_compressFilename_extRess(), with `ress.desFile` already opened.</span></td></tr>
<tr class="codeline" data-linenumber="1368"><td class="num" id="LN1368">1368</td><td class="line"> <span class='comment'>*  @return : 0 : compression completed correctly,</span></td></tr>
<tr class="codeline" data-linenumber="1369"><td class="num" id="LN1369">1369</td><td class="line"> <span class='comment'>*            1 : missing or pb opening srcFileName</span></td></tr>
<tr class="codeline" data-linenumber="1370"><td class="num" id="LN1370">1370</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1371"><td class="num" id="LN1371">1371</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="1372"><td class="num" id="LN1372">1372</td><td class="line">FIO_compressFilename_internal(FIO_prefs_t* <span class='keyword'>const</span> prefs,</td></tr>
<tr class="codeline" data-linenumber="1373"><td class="num" id="LN1373">1373</td><td class="line">                              cRess_t ress,</td></tr>
<tr class="codeline" data-linenumber="1374"><td class="num" id="LN1374">1374</td><td class="line">                              <span class='keyword'>const</span> <span class='keyword'>char</span>* dstFileName, <span class='keyword'>const</span> <span class='keyword'>char</span>* srcFileName,</td></tr>
<tr class="codeline" data-linenumber="1375"><td class="num" id="LN1375">1375</td><td class="line">                              <span class='keyword'>int</span> compressionLevel)</td></tr>
<tr class="codeline" data-linenumber="1376"><td class="num" id="LN1376">1376</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1377"><td class="num" id="LN1377">1377</td><td class="line">    UTIL_time_t <span class='keyword'>const</span> timeStart = UTIL_getTime();</td></tr>
<tr class="codeline" data-linenumber="1378"><td class="num" id="LN1378">1378</td><td class="line">    clock_t <span class='keyword'>const</span> cpuStart = clock();</td></tr>
<tr class="codeline" data-linenumber="1379"><td class="num" id="LN1379">1379</td><td class="line">    U64 readsize = 0;</td></tr>
<tr class="codeline" data-linenumber="1380"><td class="num" id="LN1380">1380</td><td class="line">    U64 compressedfilesize = 0;</td></tr>
<tr class="codeline" data-linenumber="1381"><td class="num" id="LN1381">1381</td><td class="line">    U64 <span class='keyword'>const</span> fileSize = UTIL_getFileSize(srcFileName);</td></tr>
<tr class="codeline" data-linenumber="1382"><td class="num" id="LN1382">1382</td><td class="line">    <span class='macro'>DISPLAYLEVEL(5, <span class='string_literal'>"%s: %u bytes \n"</span>, srcFileName, (<span class='keyword'>unsigned</span>)fileSize)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=5) { fprintf(stderr, "%s: %u bytes \n"<br>, srcFileName, (unsigned)fileSize); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1383"><td class="num" id="LN1383">1383</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1384"><td class="num" id="LN1384">1384</td><td class="line">    <span class='comment'>/* compression format selection */</span></td></tr>
<tr class="codeline" data-linenumber="1385"><td class="num" id="LN1385">1385</td><td class="line">    <span class='keyword'>switch</span> (prefs-&gt;compressionType) {</td></tr>
<tr class="codeline" data-linenumber="1386"><td class="num" id="LN1386">1386</td><td class="line">        <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="1387"><td class="num" id="LN1387">1387</td><td class="line">        <span class='keyword'>case</span> FIO_zstdCompression:</td></tr>
<tr class="codeline" data-linenumber="1388"><td class="num" id="LN1388">1388</td><td class="line">            compressedfilesize = FIO_compressZstdFrame(prefs, &amp;ress, srcFileName, fileSize, compressionLevel, &amp;readsize);</td></tr>
<tr class="codeline" data-linenumber="1389"><td class="num" id="LN1389">1389</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1390"><td class="num" id="LN1390">1390</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1391"><td class="num" id="LN1391">1391</td><td class="line">        <span class='keyword'>case</span> FIO_gzipCompression:</td></tr>
<tr class="codeline" data-linenumber="1392"><td class="num" id="LN1392">1392</td><td class="line"><span class='directive'>#ifdef <span class='macro'>ZSTD_GZCOMPRESS<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="1393"><td class="num" id="LN1393">1393</td><td class="line">            compressedfilesize = FIO_compressGzFrame(&amp;ress, srcFileName, fileSize, compressionLevel, &amp;readsize);</td></tr>
<tr class="codeline" data-linenumber="1394"><td class="num" id="LN1394">1394</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="1395"><td class="num" id="LN1395">1395</td><td class="line">            (<span class='keyword'>void</span>)compressionLevel;</td></tr>
<tr class="codeline" data-linenumber="1396"><td class="num" id="LN1396">1396</td><td class="line">            <span class='macro'>EXM_THROW(20, <span class='string_literal'>"zstd: %s: file cannot be compressed as gzip (zstd compiled without ZSTD_GZCOMPRESS) -- ignored \n"</span>,<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1397<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 20); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "zstd: %s: file cannot be compressed as gzip (zstd compiled without ZSTD_GZCOMPRESS) -- ignored \n"<br>, srcFileName); } }; { if (g_display_prefs.displayLevel&gt;=1<br>) { fprintf(stderr, " \n"); } }; exit(20); }</span></span></td></tr>
<tr class="codeline" data-linenumber="1397"><td class="num" id="LN1397">1397</td><td class="line">                            <span class='macro'>srcFileName)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1397<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 20); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "zstd: %s: file cannot be compressed as gzip (zstd compiled without ZSTD_GZCOMPRESS) -- ignored \n"<br>, srcFileName); } }; { if (g_display_prefs.displayLevel&gt;=1<br>) { fprintf(stderr, " \n"); } }; exit(20); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1398"><td class="num" id="LN1398">1398</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1399"><td class="num" id="LN1399">1399</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1400"><td class="num" id="LN1400">1400</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1401"><td class="num" id="LN1401">1401</td><td class="line">        <span class='keyword'>case</span> FIO_xzCompression:</td></tr>
<tr class="codeline" data-linenumber="1402"><td class="num" id="LN1402">1402</td><td class="line">        <span class='keyword'>case</span> FIO_lzmaCompression:</td></tr>
<tr class="codeline" data-linenumber="1403"><td class="num" id="LN1403">1403</td><td class="line"><span class='directive'>#ifdef <span class='macro'>ZSTD_LZMACOMPRESS<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="1404"><td class="num" id="LN1404">1404</td><td class="line">            compressedfilesize = FIO_compressLzmaFrame(&amp;ress, srcFileName, fileSize, compressionLevel, &amp;readsize, prefs-&gt;compressionType==FIO_lzmaCompression);</td></tr>
<tr class="codeline" data-linenumber="1405"><td class="num" id="LN1405">1405</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="1406"><td class="num" id="LN1406">1406</td><td class="line">            (<span class='keyword'>void</span>)compressionLevel;</td></tr>
<tr class="codeline" data-linenumber="1407"><td class="num" id="LN1407">1407</td><td class="line">            <span class='macro'>EXM_THROW(20, <span class='string_literal'>"zstd: %s: file cannot be compressed as xz/lzma (zstd compiled without ZSTD_LZMACOMPRESS) -- ignored \n"</span>,<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1408<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 20); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "zstd: %s: file cannot be compressed as xz/lzma (zstd compiled without ZSTD_LZMACOMPRESS) -- ignored \n"<br>, srcFileName); } }; { if (g_display_prefs.displayLevel&gt;=1<br>) { fprintf(stderr, " \n"); } }; exit(20); }</span></span></td></tr>
<tr class="codeline" data-linenumber="1408"><td class="num" id="LN1408">1408</td><td class="line">                            <span class='macro'>srcFileName)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1408<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 20); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "zstd: %s: file cannot be compressed as xz/lzma (zstd compiled without ZSTD_LZMACOMPRESS) -- ignored \n"<br>, srcFileName); } }; { if (g_display_prefs.displayLevel&gt;=1<br>) { fprintf(stderr, " \n"); } }; exit(20); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1409"><td class="num" id="LN1409">1409</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1410"><td class="num" id="LN1410">1410</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1411"><td class="num" id="LN1411">1411</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1412"><td class="num" id="LN1412">1412</td><td class="line">        <span class='keyword'>case</span> FIO_lz4Compression:</td></tr>
<tr class="codeline" data-linenumber="1413"><td class="num" id="LN1413">1413</td><td class="line"><span class='directive'>#ifdef <span class='macro'>ZSTD_LZ4COMPRESS<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="1414"><td class="num" id="LN1414">1414</td><td class="line">            compressedfilesize = FIO_compressLz4Frame(&amp;ress, srcFileName, fileSize, compressionLevel, prefs-&gt;checksumFlag, &amp;readsize);</td></tr>
<tr class="codeline" data-linenumber="1415"><td class="num" id="LN1415">1415</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="1416"><td class="num" id="LN1416">1416</td><td class="line">            (<span class='keyword'>void</span>)compressionLevel;</td></tr>
<tr class="codeline" data-linenumber="1417"><td class="num" id="LN1417">1417</td><td class="line">            <span class='macro'>EXM_THROW(20, <span class='string_literal'>"zstd: %s: file cannot be compressed as lz4 (zstd compiled without ZSTD_LZ4COMPRESS) -- ignored \n"</span>,<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1418<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 20); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "zstd: %s: file cannot be compressed as lz4 (zstd compiled without ZSTD_LZ4COMPRESS) -- ignored \n"<br>, srcFileName); } }; { if (g_display_prefs.displayLevel&gt;=1<br>) { fprintf(stderr, " \n"); } }; exit(20); }</span></span></td></tr>
<tr class="codeline" data-linenumber="1418"><td class="num" id="LN1418">1418</td><td class="line">                            <span class='macro'>srcFileName)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1418<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 20); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "zstd: %s: file cannot be compressed as lz4 (zstd compiled without ZSTD_LZ4COMPRESS) -- ignored \n"<br>, srcFileName); } }; { if (g_display_prefs.displayLevel&gt;=1<br>) { fprintf(stderr, " \n"); } }; exit(20); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1419"><td class="num" id="LN1419">1419</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1420"><td class="num" id="LN1420">1420</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1421"><td class="num" id="LN1421">1421</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1422"><td class="num" id="LN1422">1422</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1423"><td class="num" id="LN1423">1423</td><td class="line">    <span class='comment'>/* Status */</span></td></tr>
<tr class="codeline" data-linenumber="1424"><td class="num" id="LN1424">1424</td><td class="line">    <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"\r%79s\r"</span>, <span class='string_literal'>""</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2) { fprintf(stderr, "\r%79s\r"<br>, ""); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1425"><td class="num" id="LN1425">1425</td><td class="line">    <span class='keyword'>if</span> (readsize == 0) {</td></tr>
<tr class="codeline" data-linenumber="1426"><td class="num" id="LN1426">1426</td><td class="line">        <span class='macro'>DISPLAYLEVEL(2,<span class='string_literal'>"%-20s :  (%6llu =&gt; %6llu bytes, %s) \n"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2) { fprintf(stderr, "%-20s :  (%6llu =&gt; %6llu bytes, %s) \n"<br>, srcFileName, (unsigned long long)readsize, (unsigned long long<br>) compressedfilesize, dstFileName); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1427"><td class="num" id="LN1427">1427</td><td class="line">            <span class='macro'>srcFileName,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2) { fprintf(stderr, "%-20s :  (%6llu =&gt; %6llu bytes, %s) \n"<br>, srcFileName, (unsigned long long)readsize, (unsigned long long<br>) compressedfilesize, dstFileName); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1428"><td class="num" id="LN1428">1428</td><td class="line">            <span class='macro'>(<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>)readsize, (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>) compressedfilesize,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2) { fprintf(stderr, "%-20s :  (%6llu =&gt; %6llu bytes, %s) \n"<br>, srcFileName, (unsigned long long)readsize, (unsigned long long<br>) compressedfilesize, dstFileName); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1429"><td class="num" id="LN1429">1429</td><td class="line">            <span class='macro'>dstFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2) { fprintf(stderr, "%-20s :  (%6llu =&gt; %6llu bytes, %s) \n"<br>, srcFileName, (unsigned long long)readsize, (unsigned long long<br>) compressedfilesize, dstFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1430"><td class="num" id="LN1430">1430</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1431"><td class="num" id="LN1431">1431</td><td class="line">        <span class='macro'>DISPLAYLEVEL(2,<span class='string_literal'>"%-20s :%6.2f%%   (%6llu =&gt; %6llu bytes, %s) \n"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2) { fprintf(stderr, "%-20s :%6.2f%%   (%6llu =&gt; %6llu bytes, %s) \n"<br>, srcFileName, (double)compressedfilesize / readsize * 100, (<br>unsigned long long)readsize, (unsigned long long) compressedfilesize<br>, dstFileName); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1432"><td class="num" id="LN1432">1432</td><td class="line">            <span class='macro'>srcFileName,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2) { fprintf(stderr, "%-20s :%6.2f%%   (%6llu =&gt; %6llu bytes, %s) \n"<br>, srcFileName, (double)compressedfilesize / readsize * 100, (<br>unsigned long long)readsize, (unsigned long long) compressedfilesize<br>, dstFileName); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1433"><td class="num" id="LN1433">1433</td><td class="line">            <span class='macro'>(<span class='keyword'>double</span>)compressedfilesize / readsize * 100,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2) { fprintf(stderr, "%-20s :%6.2f%%   (%6llu =&gt; %6llu bytes, %s) \n"<br>, srcFileName, (double)compressedfilesize / readsize * 100, (<br>unsigned long long)readsize, (unsigned long long) compressedfilesize<br>, dstFileName); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1434"><td class="num" id="LN1434">1434</td><td class="line">            <span class='macro'>(<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>)readsize, (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>) compressedfilesize,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2) { fprintf(stderr, "%-20s :%6.2f%%   (%6llu =&gt; %6llu bytes, %s) \n"<br>, srcFileName, (double)compressedfilesize / readsize * 100, (<br>unsigned long long)readsize, (unsigned long long) compressedfilesize<br>, dstFileName); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1435"><td class="num" id="LN1435">1435</td><td class="line">            <span class='macro'>dstFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2) { fprintf(stderr, "%-20s :%6.2f%%   (%6llu =&gt; %6llu bytes, %s) \n"<br>, srcFileName, (double)compressedfilesize / readsize * 100, (<br>unsigned long long)readsize, (unsigned long long) compressedfilesize<br>, dstFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1436"><td class="num" id="LN1436">1436</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1437"><td class="num" id="LN1437">1437</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1438"><td class="num" id="LN1438">1438</td><td class="line">    <span class='comment'>/* Elapsed Time and CPU Load */</span></td></tr>
<tr class="codeline" data-linenumber="1439"><td class="num" id="LN1439">1439</td><td class="line">    {   clock_t <span class='keyword'>const</span> cpuEnd = clock();</td></tr>
<tr class="codeline" data-linenumber="1440"><td class="num" id="LN1440">1440</td><td class="line">        <span class='keyword'>double</span> <span class='keyword'>const</span> cpuLoad_s = (<span class='keyword'>double</span>)(cpuEnd - cpuStart) / <span class='macro'>CLOCKS_PER_SEC<span class='macro_popup'>((__clock_t) 1000000)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1441"><td class="num" id="LN1441">1441</td><td class="line">        U64 <span class='keyword'>const</span> timeLength_ns = UTIL_clockSpanNano(timeStart);</td></tr>
<tr class="codeline" data-linenumber="1442"><td class="num" id="LN1442">1442</td><td class="line">        <span class='keyword'>double</span> <span class='keyword'>const</span> timeLength_s = (<span class='keyword'>double</span>)timeLength_ns / 1000000000;</td></tr>
<tr class="codeline" data-linenumber="1443"><td class="num" id="LN1443">1443</td><td class="line">        <span class='keyword'>double</span> <span class='keyword'>const</span> cpuLoad_pct = (cpuLoad_s / timeLength_s) * 100;</td></tr>
<tr class="codeline" data-linenumber="1444"><td class="num" id="LN1444">1444</td><td class="line">        <span class='macro'>DISPLAYLEVEL(4, <span class='string_literal'>"%-20s : Completed in %.2f sec  (cpu load : %.0f%%)\n"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=4) { fprintf(stderr, "%-20s : Completed in %.2f sec  (cpu load : %.0f%%)\n"<br>, srcFileName, timeLength_s, cpuLoad_pct); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1445"><td class="num" id="LN1445">1445</td><td class="line">                        <span class='macro'>srcFileName, timeLength_s, cpuLoad_pct)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=4) { fprintf(stderr, "%-20s : Completed in %.2f sec  (cpu load : %.0f%%)\n"<br>, srcFileName, timeLength_s, cpuLoad_pct); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1446"><td class="num" id="LN1446">1446</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1447"><td class="num" id="LN1447">1447</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1448"><td class="num" id="LN1448">1448</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1449"><td class="num" id="LN1449">1449</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1450"><td class="num" id="LN1450">1450</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1451"><td class="num" id="LN1451">1451</td><td class="line"><span class='comment'>/*! FIO_compressFilename_dstFile() :</span></td></tr>
<tr class="codeline" data-linenumber="1452"><td class="num" id="LN1452">1452</td><td class="line"> <span class='comment'>*  open dstFileName, or pass-through if ress.dstFile != NULL,</span></td></tr>
<tr class="codeline" data-linenumber="1453"><td class="num" id="LN1453">1453</td><td class="line"> <span class='comment'>*  then start compression with FIO_compressFilename_internal().</span></td></tr>
<tr class="codeline" data-linenumber="1454"><td class="num" id="LN1454">1454</td><td class="line"> <span class='comment'>*  Manages source removal (--rm) and file permissions transfer.</span></td></tr>
<tr class="codeline" data-linenumber="1455"><td class="num" id="LN1455">1455</td><td class="line"> <span class='comment'>*  note : ress.srcFile must be != NULL,</span></td></tr>
<tr class="codeline" data-linenumber="1456"><td class="num" id="LN1456">1456</td><td class="line"> <span class='comment'>*  so reach this function through FIO_compressFilename_srcFile().</span></td></tr>
<tr class="codeline" data-linenumber="1457"><td class="num" id="LN1457">1457</td><td class="line"> <span class='comment'>*  @return : 0 : compression completed correctly,</span></td></tr>
<tr class="codeline" data-linenumber="1458"><td class="num" id="LN1458">1458</td><td class="line"> <span class='comment'>*            1 : pb</span></td></tr>
<tr class="codeline" data-linenumber="1459"><td class="num" id="LN1459">1459</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1460"><td class="num" id="LN1460">1460</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> FIO_compressFilename_dstFile(FIO_prefs_t* <span class='keyword'>const</span> prefs,</td></tr>
<tr class="codeline" data-linenumber="1461"><td class="num" id="LN1461">1461</td><td class="line">                                        cRess_t ress,</td></tr>
<tr class="codeline" data-linenumber="1462"><td class="num" id="LN1462">1462</td><td class="line">                                        <span class='keyword'>const</span> <span class='keyword'>char</span>* dstFileName,</td></tr>
<tr class="codeline" data-linenumber="1463"><td class="num" id="LN1463">1463</td><td class="line">                                        <span class='keyword'>const</span> <span class='keyword'>char</span>* srcFileName,</td></tr>
<tr class="codeline" data-linenumber="1464"><td class="num" id="LN1464">1464</td><td class="line">                                        <span class='keyword'>int</span> compressionLevel)</td></tr>
<tr class="codeline" data-linenumber="1465"><td class="num" id="LN1465">1465</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1466"><td class="num" id="LN1466">1466</td><td class="line">    <span class='keyword'>int</span> closeDstFile = 0;</td></tr>
<tr class="codeline" data-linenumber="1467"><td class="num" id="LN1467">1467</td><td class="line">    <span class='keyword'>int</span> result;</td></tr>
<tr class="codeline" data-linenumber="1468"><td class="num" id="LN1468">1468</td><td class="line">    stat_t statbuf;</td></tr>
<tr class="codeline" data-linenumber="1469"><td class="num" id="LN1469">1469</td><td class="line">    <span class='keyword'>int</span> transfer_permissions = 0;</td></tr>
<tr class="codeline" data-linenumber="1470"><td class="num" id="LN1470">1470</td><td class="line">    <span class='macro'>assert(ress.srcFile != NULL)<span class='macro_popup'>((void) sizeof ((ress.srcFile != ((void*)0)) ? 1 : 0), __extension__<br> ({ if (ress.srcFile != ((void*)0)) ; else __assert_fail ("ress.srcFile != NULL"<br>, "fileio.c", 1470, __extension__ __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1471"><td class="num" id="LN1471">1471</td><td class="line">    <span class='keyword'>if</span> (ress.dstFile == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1472"><td class="num" id="LN1472">1472</td><td class="line">        closeDstFile = 1;</td></tr>
<tr class="codeline" data-linenumber="1473"><td class="num" id="LN1473">1473</td><td class="line">        <span class='macro'>DISPLAYLEVEL(6, <span class='string_literal'>"FIO_compressFilename_dstFile: opening dst: %s \n"</span>, dstFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=6) { fprintf(stderr, "FIO_compressFilename_dstFile: opening dst: %s \n"<br>, dstFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1474"><td class="num" id="LN1474">1474</td><td class="line">        ress.dstFile = FIO_openDstFile(prefs, srcFileName, dstFileName);</td></tr>
<tr class="codeline" data-linenumber="1475"><td class="num" id="LN1475">1475</td><td class="line">        <span class='keyword'>if</span> (ress.dstFile==<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span> 1;  <span class='comment'>/* could not open dstFileName */</span></td></tr>
<tr class="codeline" data-linenumber="1476"><td class="num" id="LN1476">1476</td><td class="line">        <span class='comment'>/* Must only be added after FIO_openDstFile() succeeds.</span></td></tr>
<tr class="codeline" data-linenumber="1477"><td class="num" id="LN1477">1477</td><td class="line">         <span class='comment'>* Otherwise we may delete the destination file if it already exists,</span></td></tr>
<tr class="codeline" data-linenumber="1478"><td class="num" id="LN1478">1478</td><td class="line">         <span class='comment'>* and the user presses Ctrl-C when asked if they wish to overwrite.</span></td></tr>
<tr class="codeline" data-linenumber="1479"><td class="num" id="LN1479">1479</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1480"><td class="num" id="LN1480">1480</td><td class="line">        addHandler(dstFileName);</td></tr>
<tr class="codeline" data-linenumber="1481"><td class="num" id="LN1481">1481</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1482"><td class="num" id="LN1482">1482</td><td class="line">        <span class='keyword'>if</span> ( strcmp (srcFileName, <span class='macro'>stdinmark<span class='macro_popup'>"/*stdin*\\"</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1483"><td class="num" id="LN1483">1483</td><td class="line">          &amp;&amp; UTIL_getFileStat(srcFileName, &amp;statbuf))</td></tr>
<tr class="codeline" data-linenumber="1484"><td class="num" id="LN1484">1484</td><td class="line">            transfer_permissions = 1;</td></tr>
<tr class="codeline" data-linenumber="1485"><td class="num" id="LN1485">1485</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1486"><td class="num" id="LN1486">1486</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1487"><td class="num" id="LN1487">1487</td><td class="line">    result = FIO_compressFilename_internal(prefs, ress, dstFileName, srcFileName, compressionLevel);</td></tr>
<tr class="codeline" data-linenumber="1488"><td class="num" id="LN1488">1488</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1489"><td class="num" id="LN1489">1489</td><td class="line">    <span class='keyword'>if</span> (closeDstFile) {</td></tr>
<tr class="codeline" data-linenumber="1490"><td class="num" id="LN1490">1490</td><td class="line">        FILE* <span class='keyword'>const</span> dstFile = ress.dstFile;</td></tr>
<tr class="codeline" data-linenumber="1491"><td class="num" id="LN1491">1491</td><td class="line">        ress.dstFile = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1492"><td class="num" id="LN1492">1492</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1493"><td class="num" id="LN1493">1493</td><td class="line">        clearHandler();</td></tr>
<tr class="codeline" data-linenumber="1494"><td class="num" id="LN1494">1494</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1495"><td class="num" id="LN1495">1495</td><td class="line">        <span class='macro'>DISPLAYLEVEL(6, <span class='string_literal'>"FIO_compressFilename_dstFile: closing dst: %s \n"</span>, dstFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=6) { fprintf(stderr, "FIO_compressFilename_dstFile: closing dst: %s \n"<br>, dstFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1496"><td class="num" id="LN1496">1496</td><td class="line">        <span class='keyword'>if</span> (fclose(dstFile)) { <span class='comment'>/* error closing dstFile */</span></td></tr>
<tr class="codeline" data-linenumber="1497"><td class="num" id="LN1497">1497</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s: %s \n"</span>, dstFileName, strerror(errno))<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: %s \n"<br>, dstFileName, strerror((*__errno_location ()))); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1498"><td class="num" id="LN1498">1498</td><td class="line">            result=1;</td></tr>
<tr class="codeline" data-linenumber="1499"><td class="num" id="LN1499">1499</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1500"><td class="num" id="LN1500">1500</td><td class="line">        <span class='keyword'>if</span> ( (result != 0)  <span class='comment'>/* operation failure */</span></td></tr>
<tr class="codeline" data-linenumber="1501"><td class="num" id="LN1501">1501</td><td class="line">          &amp;&amp; strcmp(dstFileName, <span class='macro'>nulmark<span class='macro_popup'>"/dev/null"</span></span>)     <span class='comment'>/* special case : don't remove() /dev/null */</span></td></tr>
<tr class="codeline" data-linenumber="1502"><td class="num" id="LN1502">1502</td><td class="line">          &amp;&amp; strcmp(dstFileName, <span class='macro'>stdoutmark<span class='macro_popup'>"/*stdout*\\"</span></span>)  <span class='comment'>/* special case : don't remove() stdout */</span></td></tr>
<tr class="codeline" data-linenumber="1503"><td class="num" id="LN1503">1503</td><td class="line">          ) {</td></tr>
<tr class="codeline" data-linenumber="1504"><td class="num" id="LN1504">1504</td><td class="line">            FIO_remove(dstFileName); <span class='comment'>/* remove compression artefact; note don't do anything special if remove() fails */</span></td></tr>
<tr class="codeline" data-linenumber="1505"><td class="num" id="LN1505">1505</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> ( strcmp(dstFileName, <span class='macro'>stdoutmark<span class='macro_popup'>"/*stdout*\\"</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1506"><td class="num" id="LN1506">1506</td><td class="line">                 &amp;&amp; strcmp(dstFileName, <span class='macro'>nulmark<span class='macro_popup'>"/dev/null"</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1507"><td class="num" id="LN1507">1507</td><td class="line">                 &amp;&amp; transfer_permissions) {</td></tr>
<tr class="codeline" data-linenumber="1508"><td class="num" id="LN1508">1508</td><td class="line">            <span class='macro'>DISPLAYLEVEL(6, <span class='string_literal'>"FIO_compressFilename_dstFile: transfering permissions into dst: %s \n"</span>, dstFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=6) { fprintf(stderr, "FIO_compressFilename_dstFile: transfering permissions into dst: %s \n"<br>, dstFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1509"><td class="num" id="LN1509">1509</td><td class="line">            UTIL_setFileStat(dstFileName, &amp;statbuf);</td></tr>
<tr class="codeline" data-linenumber="1510"><td class="num" id="LN1510">1510</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1511"><td class="num" id="LN1511">1511</td><td class="line">            <span class='macro'>DISPLAYLEVEL(6, <span class='string_literal'>"FIO_compressFilename_dstFile: do not transfer permissions into dst: %s \n"</span>, dstFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=6) { fprintf(stderr, "FIO_compressFilename_dstFile: do not transfer permissions into dst: %s \n"<br>, dstFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1512"><td class="num" id="LN1512">1512</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1513"><td class="num" id="LN1513">1513</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1514"><td class="num" id="LN1514">1514</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1515"><td class="num" id="LN1515">1515</td><td class="line">    <span class='keyword'>return</span> result;</td></tr>
<tr class="codeline" data-linenumber="1516"><td class="num" id="LN1516">1516</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1517"><td class="num" id="LN1517">1517</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1518"><td class="num" id="LN1518">1518</td><td class="line"><span class='comment'>/* List used to compare file extensions (used with --exclude-compressed flag)</span></td></tr>
<tr class="codeline" data-linenumber="1519"><td class="num" id="LN1519">1519</td><td class="line"><span class='comment'>* Different from the suffixList and should only apply to ZSTD compress operationResult</span></td></tr>
<tr class="codeline" data-linenumber="1520"><td class="num" id="LN1520">1520</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1521"><td class="num" id="LN1521">1521</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span> *compressedFileExtensions[] = {</td></tr>
<tr class="codeline" data-linenumber="1522"><td class="num" id="LN1522">1522</td><td class="line">    <span class='macro'>ZSTD_EXTENSION<span class='macro_popup'>".zst"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1523"><td class="num" id="LN1523">1523</td><td class="line">    <span class='macro'>TZSTD_EXTENSION<span class='macro_popup'>".tzst"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1524"><td class="num" id="LN1524">1524</td><td class="line">    <span class='macro'>GZ_EXTENSION<span class='macro_popup'>".gz"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1525"><td class="num" id="LN1525">1525</td><td class="line">    <span class='macro'>TGZ_EXTENSION<span class='macro_popup'>".tgz"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1526"><td class="num" id="LN1526">1526</td><td class="line">    <span class='macro'>LZMA_EXTENSION<span class='macro_popup'>".lzma"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1527"><td class="num" id="LN1527">1527</td><td class="line">    <span class='macro'>XZ_EXTENSION<span class='macro_popup'>".xz"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1528"><td class="num" id="LN1528">1528</td><td class="line">    <span class='macro'>TXZ_EXTENSION<span class='macro_popup'>".txz"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1529"><td class="num" id="LN1529">1529</td><td class="line">    <span class='macro'>LZ4_EXTENSION<span class='macro_popup'>".lz4"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1530"><td class="num" id="LN1530">1530</td><td class="line">    <span class='macro'>TLZ4_EXTENSION<span class='macro_popup'>".tlz4"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1531"><td class="num" id="LN1531">1531</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="1532"><td class="num" id="LN1532">1532</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="1533"><td class="num" id="LN1533">1533</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1534"><td class="num" id="LN1534">1534</td><td class="line"><span class='comment'>/*! FIO_compressFilename_srcFile() :</span></td></tr>
<tr class="codeline" data-linenumber="1535"><td class="num" id="LN1535">1535</td><td class="line"> <span class='comment'>*  @return : 0 : compression completed correctly,</span></td></tr>
<tr class="codeline" data-linenumber="1536"><td class="num" id="LN1536">1536</td><td class="line"> <span class='comment'>*            1 : missing or pb opening srcFileName</span></td></tr>
<tr class="codeline" data-linenumber="1537"><td class="num" id="LN1537">1537</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1538"><td class="num" id="LN1538">1538</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="1539"><td class="num" id="LN1539">1539</td><td class="line">FIO_compressFilename_srcFile(FIO_prefs_t* <span class='keyword'>const</span> prefs,</td></tr>
<tr class="codeline" data-linenumber="1540"><td class="num" id="LN1540">1540</td><td class="line">                             cRess_t ress,</td></tr>
<tr class="codeline" data-linenumber="1541"><td class="num" id="LN1541">1541</td><td class="line">                             <span class='keyword'>const</span> <span class='keyword'>char</span>* dstFileName,</td></tr>
<tr class="codeline" data-linenumber="1542"><td class="num" id="LN1542">1542</td><td class="line">                             <span class='keyword'>const</span> <span class='keyword'>char</span>* srcFileName,</td></tr>
<tr class="codeline" data-linenumber="1543"><td class="num" id="LN1543">1543</td><td class="line">                             <span class='keyword'>int</span> compressionLevel)</td></tr>
<tr class="codeline" data-linenumber="1544"><td class="num" id="LN1544">1544</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1545"><td class="num" id="LN1545">1545</td><td class="line">    <span class='keyword'>int</span> result;</td></tr>
<tr class="codeline" data-linenumber="1546"><td class="num" id="LN1546">1546</td><td class="line">    <span class='macro'>DISPLAYLEVEL(6, <span class='string_literal'>"FIO_compressFilename_srcFile: %s \n"</span>, srcFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=6) { fprintf(stderr, "FIO_compressFilename_srcFile: %s \n"<br>, srcFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1547"><td class="num" id="LN1547">1547</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1548"><td class="num" id="LN1548">1548</td><td class="line">    <span class='comment'>/* ensure src is not a directory */</span></td></tr>
<tr class="codeline" data-linenumber="1549"><td class="num" id="LN1549">1549</td><td class="line">    <span class='keyword'>if</span> (UTIL_isDirectory(srcFileName)) {</td></tr>
<tr class="codeline" data-linenumber="1550"><td class="num" id="LN1550">1550</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s is a directory -- ignored \n"</span>, srcFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s is a directory -- ignored \n"<br>, srcFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1551"><td class="num" id="LN1551">1551</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1552"><td class="num" id="LN1552">1552</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1553"><td class="num" id="LN1553">1553</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1554"><td class="num" id="LN1554">1554</td><td class="line">    <span class='comment'>/* ensure src is not the same as dict (if present) */</span></td></tr>
<tr class="codeline" data-linenumber="1555"><td class="num" id="LN1555">1555</td><td class="line">    <span class='keyword'>if</span> (ress.dictFileName != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; UTIL_isSameFile(srcFileName, ress.dictFileName)) {</td></tr>
<tr class="codeline" data-linenumber="1556"><td class="num" id="LN1556">1556</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: cannot use %s as an input file and dictionary \n"</span>, srcFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: cannot use %s as an input file and dictionary \n"<br>, srcFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1557"><td class="num" id="LN1557">1557</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1558"><td class="num" id="LN1558">1558</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1559"><td class="num" id="LN1559">1559</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1560"><td class="num" id="LN1560">1560</td><td class="line">    <span class='comment'>/* Check if "srcFile" is compressed. Only done if --exclude-compressed flag is used</span></td></tr>
<tr class="codeline" data-linenumber="1561"><td class="num" id="LN1561">1561</td><td class="line">    <span class='comment'>* YES =&gt; ZSTD will skip compression of the file and will return 0.</span></td></tr>
<tr class="codeline" data-linenumber="1562"><td class="num" id="LN1562">1562</td><td class="line">    <span class='comment'>* NO =&gt; ZSTD will resume with compress operation.</span></td></tr>
<tr class="codeline" data-linenumber="1563"><td class="num" id="LN1563">1563</td><td class="line">    <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1564"><td class="num" id="LN1564">1564</td><td class="line">    <span class='keyword'>if</span> (prefs-&gt;excludeCompressedFiles == 1 &amp;&amp; UTIL_isCompressedFile(srcFileName, compressedFileExtensions)) {</td></tr>
<tr class="codeline" data-linenumber="1565"><td class="num" id="LN1565">1565</td><td class="line">        <span class='macro'>DISPLAYLEVEL(4, <span class='string_literal'>"File is already compressed : %s \n"</span>, srcFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=4) { fprintf(stderr, "File is already compressed : %s \n"<br>, srcFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1566"><td class="num" id="LN1566">1566</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1567"><td class="num" id="LN1567">1567</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1568"><td class="num" id="LN1568">1568</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1569"><td class="num" id="LN1569">1569</td><td class="line">    ress.srcFile = FIO_openSrcFile(srcFileName);</td></tr>
<tr class="codeline" data-linenumber="1570"><td class="num" id="LN1570">1570</td><td class="line">    <span class='keyword'>if</span> (ress.srcFile == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span> 1;   <span class='comment'>/* srcFile could not be opened */</span></td></tr>
<tr class="codeline" data-linenumber="1571"><td class="num" id="LN1571">1571</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1572"><td class="num" id="LN1572">1572</td><td class="line">    result = FIO_compressFilename_dstFile(prefs, ress, dstFileName, srcFileName, compressionLevel);</td></tr>
<tr class="codeline" data-linenumber="1573"><td class="num" id="LN1573">1573</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1574"><td class="num" id="LN1574">1574</td><td class="line">    fclose(ress.srcFile);</td></tr>
<tr class="codeline" data-linenumber="1575"><td class="num" id="LN1575">1575</td><td class="line">    ress.srcFile = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1576"><td class="num" id="LN1576">1576</td><td class="line">    <span class='keyword'>if</span> ( prefs-&gt;removeSrcFile   <span class='comment'>/* --rm */</span></td></tr>
<tr class="codeline" data-linenumber="1577"><td class="num" id="LN1577">1577</td><td class="line">      &amp;&amp; result == 0       <span class='comment'>/* success */</span></td></tr>
<tr class="codeline" data-linenumber="1578"><td class="num" id="LN1578">1578</td><td class="line">      &amp;&amp; strcmp(srcFileName, <span class='macro'>stdinmark<span class='macro_popup'>"/*stdin*\\"</span></span>)   <span class='comment'>/* exception : don't erase stdin */</span></td></tr>
<tr class="codeline" data-linenumber="1579"><td class="num" id="LN1579">1579</td><td class="line">      ) {</td></tr>
<tr class="codeline" data-linenumber="1580"><td class="num" id="LN1580">1580</td><td class="line">        <span class='comment'>/* We must clear the handler, since after this point calling it would</span></td></tr>
<tr class="codeline" data-linenumber="1581"><td class="num" id="LN1581">1581</td><td class="line">         <span class='comment'>* delete both the source and destination files.</span></td></tr>
<tr class="codeline" data-linenumber="1582"><td class="num" id="LN1582">1582</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1583"><td class="num" id="LN1583">1583</td><td class="line">        clearHandler();</td></tr>
<tr class="codeline" data-linenumber="1584"><td class="num" id="LN1584">1584</td><td class="line">        <span class='keyword'>if</span> (FIO_remove(srcFileName))</td></tr>
<tr class="codeline" data-linenumber="1585"><td class="num" id="LN1585">1585</td><td class="line">            <span class='macro'>EXM_THROW(1, <span class='string_literal'>"zstd: %s: %s"</span>, srcFileName, strerror(errno))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1585<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 1); } }; { if (g_display_prefs.displayLevel&gt;=<br>1) { fprintf(stderr, "zstd: %s: %s", srcFileName, strerror((*<br>__errno_location ()))); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, " \n"); } }; exit(1); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1586"><td class="num" id="LN1586">1586</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1587"><td class="num" id="LN1587">1587</td><td class="line">    <span class='keyword'>return</span> result;</td></tr>
<tr class="codeline" data-linenumber="1588"><td class="num" id="LN1588">1588</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1589"><td class="num" id="LN1589">1589</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1590"><td class="num" id="LN1590">1590</td><td class="line"><span class='keyword'>int</span> FIO_compressFilename(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>const</span> <span class='keyword'>char</span>* dstFileName,</td></tr>
<tr class="codeline" data-linenumber="1591"><td class="num" id="LN1591">1591</td><td class="line">                         <span class='keyword'>const</span> <span class='keyword'>char</span>* srcFileName, <span class='keyword'>const</span> <span class='keyword'>char</span>* dictFileName,</td></tr>
<tr class="codeline" data-linenumber="1592"><td class="num" id="LN1592">1592</td><td class="line">                         <span class='keyword'>int</span> compressionLevel, ZSTD_compressionParameters comprParams)</td></tr>
<tr class="codeline" data-linenumber="1593"><td class="num" id="LN1593">1593</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1594"><td class="num" id="LN1594">1594</td><td class="line">    cRess_t <span class='keyword'>const</span> ress = FIO_createCResources(prefs, dictFileName, UTIL_getFileSize(srcFileName), compressionLevel, comprParams);</td></tr>
<tr class="codeline" data-linenumber="1595"><td class="num" id="LN1595">1595</td><td class="line">    <span class='keyword'>int</span> <span class='keyword'>const</span> result = FIO_compressFilename_srcFile(prefs, ress, dstFileName, srcFileName, compressionLevel);</td></tr>
<tr class="codeline" data-linenumber="1596"><td class="num" id="LN1596">1596</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1597"><td class="num" id="LN1597">1597</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1598"><td class="num" id="LN1598">1598</td><td class="line">    FIO_freeCResources(ress);</td></tr>
<tr class="codeline" data-linenumber="1599"><td class="num" id="LN1599">1599</td><td class="line">    <span class='keyword'>return</span> result;</td></tr>
<tr class="codeline" data-linenumber="1600"><td class="num" id="LN1600">1600</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1601"><td class="num" id="LN1601">1601</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1602"><td class="num" id="LN1602">1602</td><td class="line"><span class='comment'>/* FIO_determineCompressedName() :</span></td></tr>
<tr class="codeline" data-linenumber="1603"><td class="num" id="LN1603">1603</td><td class="line"> <span class='comment'>* create a destination filename for compressed srcFileName.</span></td></tr>
<tr class="codeline" data-linenumber="1604"><td class="num" id="LN1604">1604</td><td class="line"> <span class='comment'>* @return a pointer to it.</span></td></tr>
<tr class="codeline" data-linenumber="1605"><td class="num" id="LN1605">1605</td><td class="line"> <span class='comment'>* This function never returns an error (it may abort() in case of pb)</span></td></tr>
<tr class="codeline" data-linenumber="1606"><td class="num" id="LN1606">1606</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1607"><td class="num" id="LN1607">1607</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span>*</td></tr>
<tr class="codeline" data-linenumber="1608"><td class="num" id="LN1608">1608</td><td class="line">FIO_determineCompressedName(<span class='keyword'>const</span> <span class='keyword'>char</span>* srcFileName, <span class='keyword'>const</span> <span class='keyword'>char</span>* outDirName, <span class='keyword'>const</span> <span class='keyword'>char</span>* suffix)</td></tr>
<tr class="codeline" data-linenumber="1609"><td class="num" id="LN1609">1609</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1610"><td class="num" id="LN1610">1610</td><td class="line">    <span class='keyword'>static</span> size_t dfnbCapacity = 0;</td></tr>
<tr class="codeline" data-linenumber="1611"><td class="num" id="LN1611">1611</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>char</span>* dstFileNameBuffer = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;   <span class='comment'>/* using static allocation : this function cannot be multi-threaded */</span></td></tr>
<tr class="codeline" data-linenumber="1612"><td class="num" id="LN1612">1612</td><td class="line">    <span class='keyword'>char</span>* outDirFilename = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1613"><td class="num" id="LN1613">1613</td><td class="line">    size_t sfnSize = strlen(srcFileName);</td></tr>
<tr class="codeline" data-linenumber="1614"><td class="num" id="LN1614">1614</td><td class="line">    size_t <span class='keyword'>const</span> srcSuffixLen = strlen(suffix);</td></tr>
<tr class="codeline" data-linenumber="1615"><td class="num" id="LN1615">1615</td><td class="line">    <span class='keyword'>if</span> (outDirName) {</td></tr>
<tr class="codeline" data-linenumber="1616"><td class="num" id="LN1616">1616</td><td class="line">        outDirFilename = FIO_createFilename_fromOutDir(srcFileName, outDirName, srcSuffixLen);</td></tr>
<tr class="codeline" data-linenumber="1617"><td class="num" id="LN1617">1617</td><td class="line">        sfnSize = strlen(outDirFilename);</td></tr>
<tr class="codeline" data-linenumber="1618"><td class="num" id="LN1618">1618</td><td class="line">        <span class='macro'>assert(outDirFilename != NULL)<span class='macro_popup'>((void) sizeof ((outDirFilename != ((void*)0)) ? 1 : 0), __extension__<br> ({ if (outDirFilename != ((void*)0)) ; else __assert_fail ("outDirFilename != NULL"<br>, "fileio.c", 1618, __extension__ __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1619"><td class="num" id="LN1619">1619</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1620"><td class="num" id="LN1620">1620</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1621"><td class="num" id="LN1621">1621</td><td class="line">    <span class='keyword'>if</span> (dfnbCapacity &lt;= sfnSize+srcSuffixLen+1) {</td></tr>
<tr class="codeline" data-linenumber="1622"><td class="num" id="LN1622">1622</td><td class="line">        <span class='comment'>/* resize buffer for dstName */</span></td></tr>
<tr class="codeline" data-linenumber="1623"><td class="num" id="LN1623">1623</td><td class="line">        free(dstFileNameBuffer);</td></tr>
<tr class="codeline" data-linenumber="1624"><td class="num" id="LN1624">1624</td><td class="line">        dfnbCapacity = sfnSize + srcSuffixLen + 30;</td></tr>
<tr class="codeline" data-linenumber="1625"><td class="num" id="LN1625">1625</td><td class="line">        dstFileNameBuffer = (<span class='keyword'>char</span>*)malloc(dfnbCapacity);</td></tr>
<tr class="codeline" data-linenumber="1626"><td class="num" id="LN1626">1626</td><td class="line">        <span class='keyword'>if</span> (!dstFileNameBuffer) {</td></tr>
<tr class="codeline" data-linenumber="1627"><td class="num" id="LN1627">1627</td><td class="line">            <span class='macro'>EXM_THROW(30, <span class='string_literal'>"zstd: %s"</span>, strerror(errno))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1627<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 30); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "zstd: %s", strerror((*__errno_location<br> ()))); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, " \n"); } }; exit(30); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1628"><td class="num" id="LN1628">1628</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1629"><td class="num" id="LN1629">1629</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1630"><td class="num" id="LN1630">1630</td><td class="line">    <span class='macro'>assert(dstFileNameBuffer != NULL)<span class='macro_popup'>((void) sizeof ((dstFileNameBuffer != ((void*)0)) ? 1 : 0), __extension__<br> ({ if (dstFileNameBuffer != ((void*)0)) ; else __assert_fail<br> ("dstFileNameBuffer != NULL", "fileio.c", 1630, __extension__<br> __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1631"><td class="num" id="LN1631">1631</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1632"><td class="num" id="LN1632">1632</td><td class="line">    <span class='keyword'>if</span> (outDirFilename) {</td></tr>
<tr class="codeline" data-linenumber="1633"><td class="num" id="LN1633">1633</td><td class="line">        memcpy(dstFileNameBuffer, outDirFilename, sfnSize);</td></tr>
<tr class="codeline" data-linenumber="1634"><td class="num" id="LN1634">1634</td><td class="line">        free(outDirFilename);</td></tr>
<tr class="codeline" data-linenumber="1635"><td class="num" id="LN1635">1635</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1636"><td class="num" id="LN1636">1636</td><td class="line">        memcpy(dstFileNameBuffer, srcFileName, sfnSize);</td></tr>
<tr class="codeline" data-linenumber="1637"><td class="num" id="LN1637">1637</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1638"><td class="num" id="LN1638">1638</td><td class="line">    memcpy(dstFileNameBuffer+sfnSize, suffix, srcSuffixLen+1 <span class='comment'>/* Include terminating null */</span>);</td></tr>
<tr class="codeline" data-linenumber="1639"><td class="num" id="LN1639">1639</td><td class="line">    <span class='keyword'>return</span> dstFileNameBuffer;</td></tr>
<tr class="codeline" data-linenumber="1640"><td class="num" id="LN1640">1640</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1641"><td class="num" id="LN1641">1641</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1642"><td class="num" id="LN1642">1642</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> FIO_getLargestFileSize(<span class='keyword'>const</span> <span class='keyword'>char</span>** inFileNames, <span class='keyword'>unsigned</span> nbFiles)</td></tr>
<tr class="codeline" data-linenumber="1643"><td class="num" id="LN1643">1643</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1644"><td class="num" id="LN1644">1644</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="1645"><td class="num" id="LN1645">1645</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> fileSize, maxFileSize = 0;</td></tr>
<tr class="codeline" data-linenumber="1646"><td class="num" id="LN1646">1646</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; nbFiles; i++) {</td></tr>
<tr class="codeline" data-linenumber="1647"><td class="num" id="LN1647">1647</td><td class="line">        fileSize = UTIL_getFileSize(inFileNames[i]);</td></tr>
<tr class="codeline" data-linenumber="1648"><td class="num" id="LN1648">1648</td><td class="line">        maxFileSize = fileSize &gt; maxFileSize ? fileSize : maxFileSize;</td></tr>
<tr class="codeline" data-linenumber="1649"><td class="num" id="LN1649">1649</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1650"><td class="num" id="LN1650">1650</td><td class="line">    <span class='keyword'>return</span> maxFileSize;</td></tr>
<tr class="codeline" data-linenumber="1651"><td class="num" id="LN1651">1651</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1652"><td class="num" id="LN1652">1652</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1653"><td class="num" id="LN1653">1653</td><td class="line"><span class='comment'>/* FIO_compressMultipleFilenames() :</span></td></tr>
<tr class="codeline" data-linenumber="1654"><td class="num" id="LN1654">1654</td><td class="line"> <span class='comment'>* compress nbFiles files</span></td></tr>
<tr class="codeline" data-linenumber="1655"><td class="num" id="LN1655">1655</td><td class="line"> <span class='comment'>* into either one destination (outFileName),</span></td></tr>
<tr class="codeline" data-linenumber="1656"><td class="num" id="LN1656">1656</td><td class="line"> <span class='comment'>* or into one file each (outFileName == NULL, but suffix != NULL),</span></td></tr>
<tr class="codeline" data-linenumber="1657"><td class="num" id="LN1657">1657</td><td class="line"> <span class='comment'>* or into a destination folder (specified with -O)</span></td></tr>
<tr class="codeline" data-linenumber="1658"><td class="num" id="LN1658">1658</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1659"><td class="num" id="LN1659">1659</td><td class="line"><span class='keyword'>int</span> FIO_compressMultipleFilenames(FIO_prefs_t* <span class='keyword'>const</span> prefs,</td></tr>
<tr class="codeline" data-linenumber="1660"><td class="num" id="LN1660">1660</td><td class="line">                                  <span class='keyword'>const</span> <span class='keyword'>char</span>** inFileNamesTable, <span class='keyword'>unsigned</span> nbFiles,</td></tr>
<tr class="codeline" data-linenumber="1661"><td class="num" id="LN1661">1661</td><td class="line">                                  <span class='keyword'>const</span> <span class='keyword'>char</span>* outDirName,</td></tr>
<tr class="codeline" data-linenumber="1662"><td class="num" id="LN1662">1662</td><td class="line">                                  <span class='keyword'>const</span> <span class='keyword'>char</span>* outFileName, <span class='keyword'>const</span> <span class='keyword'>char</span>* suffix,</td></tr>
<tr class="codeline" data-linenumber="1663"><td class="num" id="LN1663">1663</td><td class="line">                                  <span class='keyword'>const</span> <span class='keyword'>char</span>* dictFileName, <span class='keyword'>int</span> compressionLevel,</td></tr>
<tr class="codeline" data-linenumber="1664"><td class="num" id="LN1664">1664</td><td class="line">                                  ZSTD_compressionParameters comprParams)</td></tr>
<tr class="codeline" data-linenumber="1665"><td class="num" id="LN1665">1665</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1666"><td class="num" id="LN1666">1666</td><td class="line">    <span class='keyword'>int</span> error = 0;</td></tr>
<tr class="codeline" data-linenumber="1667"><td class="num" id="LN1667">1667</td><td class="line">    cRess_t ress = FIO_createCResources(prefs, dictFileName,</td></tr>
<tr class="codeline" data-linenumber="1668"><td class="num" id="LN1668">1668</td><td class="line">        FIO_getLargestFileSize(inFileNamesTable, nbFiles),</td></tr>
<tr class="codeline" data-linenumber="1669"><td class="num" id="LN1669">1669</td><td class="line">        compressionLevel, comprParams);</td></tr>
<tr class="codeline" data-linenumber="1670"><td class="num" id="LN1670">1670</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1671"><td class="num" id="LN1671">1671</td><td class="line">    <span class='comment'>/* init */</span></td></tr>
<tr class="codeline" data-linenumber="1672"><td class="num" id="LN1672">1672</td><td class="line">    <span class='macro'>assert(outFileName != NULL || suffix != NULL)<span class='macro_popup'>((void) sizeof ((outFileName != ((void*)0) || suffix != ((void<br>*)0)) ? 1 : 0), __extension__ ({ if (outFileName != ((void*)0<br>) || suffix != ((void*)0)) ; else __assert_fail ("outFileName != NULL || suffix != NULL"<br>, "fileio.c", 1672, __extension__ __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1673"><td class="num" id="LN1673">1673</td><td class="line">    <span class='keyword'>if</span> (outFileName != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {   <span class='comment'>/* output into a single destination (stdout typically) */</span></td></tr>
<tr class="codeline" data-linenumber="1674"><td class="num" id="LN1674">1674</td><td class="line">        ress.dstFile = FIO_openDstFile(prefs, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, outFileName);</td></tr>
<tr class="codeline" data-linenumber="1675"><td class="num" id="LN1675">1675</td><td class="line">        <span class='keyword'>if</span> (ress.dstFile == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {  <span class='comment'>/* could not open outFileName */</span></td></tr>
<tr class="codeline" data-linenumber="1676"><td class="num" id="LN1676">1676</td><td class="line">            error = 1;</td></tr>
<tr class="codeline" data-linenumber="1677"><td class="num" id="LN1677">1677</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1678"><td class="num" id="LN1678">1678</td><td class="line">            <span class='keyword'>unsigned</span> u;</td></tr>
<tr class="codeline" data-linenumber="1679"><td class="num" id="LN1679">1679</td><td class="line">            <span class='keyword'>for</span> (u=0; u&lt;nbFiles; u++)</td></tr>
<tr class="codeline" data-linenumber="1680"><td class="num" id="LN1680">1680</td><td class="line">                error |= FIO_compressFilename_srcFile(prefs, ress, outFileName, inFileNamesTable[u], compressionLevel);</td></tr>
<tr class="codeline" data-linenumber="1681"><td class="num" id="LN1681">1681</td><td class="line">            <span class='keyword'>if</span> (fclose(ress.dstFile))</td></tr>
<tr class="codeline" data-linenumber="1682"><td class="num" id="LN1682">1682</td><td class="line">                <span class='macro'>EXM_THROW(29, <span class='string_literal'>"Write error (%s) : cannot properly close %s"</span>,<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1683<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 29); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Write error (%s) : cannot properly close %s"<br>, strerror((*__errno_location ())), outFileName); } }; { if (<br>g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n");<br> } }; exit(29); }</span></span></td></tr>
<tr class="codeline" data-linenumber="1683"><td class="num" id="LN1683">1683</td><td class="line">                            <span class='macro'>strerror(errno), outFileName)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1683<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 29); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Write error (%s) : cannot properly close %s"<br>, strerror((*__errno_location ())), outFileName); } }; { if (<br>g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n");<br> } }; exit(29); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1684"><td class="num" id="LN1684">1684</td><td class="line">            ress.dstFile = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1685"><td class="num" id="LN1685">1685</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1686"><td class="num" id="LN1686">1686</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1687"><td class="num" id="LN1687">1687</td><td class="line">        <span class='keyword'>unsigned</span> u;</td></tr>
<tr class="codeline" data-linenumber="1688"><td class="num" id="LN1688">1688</td><td class="line">        <span class='keyword'>for</span> (u=0; u&lt;nbFiles; u++) {</td></tr>
<tr class="codeline" data-linenumber="1689"><td class="num" id="LN1689">1689</td><td class="line">            <span class='keyword'>const</span> <span class='keyword'>char</span>* <span class='keyword'>const</span> srcFileName = inFileNamesTable[u];</td></tr>
<tr class="codeline" data-linenumber="1690"><td class="num" id="LN1690">1690</td><td class="line">            <span class='keyword'>const</span> <span class='keyword'>char</span>* <span class='keyword'>const</span> dstFileName = FIO_determineCompressedName(srcFileName, outDirName, suffix);  <span class='comment'>/* cannot fail */</span></td></tr>
<tr class="codeline" data-linenumber="1691"><td class="num" id="LN1691">1691</td><td class="line">            error |= FIO_compressFilename_srcFile(prefs, ress, dstFileName, srcFileName, compressionLevel);</td></tr>
<tr class="codeline" data-linenumber="1692"><td class="num" id="LN1692">1692</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1693"><td class="num" id="LN1693">1693</td><td class="line">        <span class='keyword'>if</span> (outDirName)</td></tr>
<tr class="codeline" data-linenumber="1694"><td class="num" id="LN1694">1694</td><td class="line">            FIO_checkFilenameCollisions(inFileNamesTable ,nbFiles);</td></tr>
<tr class="codeline" data-linenumber="1695"><td class="num" id="LN1695">1695</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1696"><td class="num" id="LN1696">1696</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1697"><td class="num" id="LN1697">1697</td><td class="line">    FIO_freeCResources(ress);</td></tr>
<tr class="codeline" data-linenumber="1698"><td class="num" id="LN1698">1698</td><td class="line">    <span class='keyword'>return</span> error;</td></tr>
<tr class="codeline" data-linenumber="1699"><td class="num" id="LN1699">1699</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1700"><td class="num" id="LN1700">1700</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1701"><td class="num" id="LN1701">1701</td><td class="line"><span class='directive'>#endif /* #ifndef ZSTD_NOCOMPRESS */</span></td></tr>
<tr class="codeline" data-linenumber="1702"><td class="num" id="LN1702">1702</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1703"><td class="num" id="LN1703">1703</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1704"><td class="num" id="LN1704">1704</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1705"><td class="num" id="LN1705">1705</td><td class="line"><span class='directive'>#ifndef ZSTD_NODECOMPRESS</span></td></tr>
<tr class="codeline" data-linenumber="1706"><td class="num" id="LN1706">1706</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1707"><td class="num" id="LN1707">1707</td><td class="line"><span class='comment'>/* **************************************************************************</span></td></tr>
<tr class="codeline" data-linenumber="1708"><td class="num" id="LN1708">1708</td><td class="line"> <span class='comment'>*  Decompression</span></td></tr>
<tr class="codeline" data-linenumber="1709"><td class="num" id="LN1709">1709</td><td class="line"> <span class='comment'>***************************************************************************/</span></td></tr>
<tr class="codeline" data-linenumber="1710"><td class="num" id="LN1710">1710</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> {</td></tr>
<tr class="codeline" data-linenumber="1711"><td class="num" id="LN1711">1711</td><td class="line">    <span class='keyword'>void</span>*  srcBuffer;</td></tr>
<tr class="codeline" data-linenumber="1712"><td class="num" id="LN1712">1712</td><td class="line">    size_t srcBufferSize;</td></tr>
<tr class="codeline" data-linenumber="1713"><td class="num" id="LN1713">1713</td><td class="line">    size_t srcBufferLoaded;</td></tr>
<tr class="codeline" data-linenumber="1714"><td class="num" id="LN1714">1714</td><td class="line">    <span class='keyword'>void</span>*  dstBuffer;</td></tr>
<tr class="codeline" data-linenumber="1715"><td class="num" id="LN1715">1715</td><td class="line">    size_t dstBufferSize;</td></tr>
<tr class="codeline" data-linenumber="1716"><td class="num" id="LN1716">1716</td><td class="line">    ZSTD_DStream* dctx;</td></tr>
<tr class="codeline" data-linenumber="1717"><td class="num" id="LN1717">1717</td><td class="line">    FILE*  dstFile;</td></tr>
<tr class="codeline" data-linenumber="1718"><td class="num" id="LN1718">1718</td><td class="line">} dRess_t;</td></tr>
<tr class="codeline" data-linenumber="1719"><td class="num" id="LN1719">1719</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1720"><td class="num" id="LN1720">1720</td><td class="line"><span class='keyword'>static</span> dRess_t FIO_createDResources(FIO_prefs_t* <span class='keyword'>const</span> prefs, <span class='keyword'>const</span> <span class='keyword'>char</span>* dictFileName)</td></tr>
<tr class="codeline" data-linenumber="1721"><td class="num" id="LN1721">1721</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1722"><td class="num" id="LN1722">1722</td><td class="line">    dRess_t ress;</td></tr>
<tr class="codeline" data-linenumber="1723"><td class="num" id="LN1723">1723</td><td class="line">    memset(&amp;ress, 0, <span class='keyword'>sizeof</span>(ress));</td></tr>
<tr class="codeline" data-linenumber="1724"><td class="num" id="LN1724">1724</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1725"><td class="num" id="LN1725">1725</td><td class="line">    <span class='keyword'>if</span> (prefs-&gt;patchFromMode)</td></tr>
<tr class="codeline" data-linenumber="1726"><td class="num" id="LN1726">1726</td><td class="line">        FIO_adjustMemLimitForPatchFromMode(prefs, UTIL_getFileSize(dictFileName), 0 <span class='comment'>/* just use the dict size */</span>);</td></tr>
<tr class="codeline" data-linenumber="1727"><td class="num" id="LN1727">1727</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1728"><td class="num" id="LN1728">1728</td><td class="line">    <span class='comment'>/* Allocation */</span></td></tr>
<tr class="codeline" data-linenumber="1729"><td class="num" id="LN1729">1729</td><td class="line">    ress.dctx = ZSTD_createDStream();</td></tr>
<tr class="codeline" data-linenumber="1730"><td class="num" id="LN1730">1730</td><td class="line">    <span class='keyword'>if</span> (ress.dctx==<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1731"><td class="num" id="LN1731">1731</td><td class="line">        <span class='macro'>EXM_THROW(60, <span class='string_literal'>"Error: %s : can't create ZSTD_DStream"</span>, strerror(errno))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1731<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 60); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Error: %s : can't create ZSTD_DStream"<br>, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(60);<br> }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1732"><td class="num" id="LN1732">1732</td><td class="line">    <span class='macro'>CHECK( ZSTD_DCtx_setMaxWindowSize(ress.dctx, prefs-&gt;memLimit) )<span class='macro_popup'>{ size_t err; err = ZSTD_DCtx_setMaxWindowSize(ress.dctx, prefs<br>-&gt;memLimit); if (ERR_isError(err)) { { if (g_display_prefs<br>.displayLevel&gt;=5) { fprintf(stderr, "%s \n", "ZSTD_DCtx_setMaxWindowSize(ress.dctx, prefs-&gt;memLimit)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 1732); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1733"><td class="num" id="LN1733">1733</td><td class="line">    ress.srcBufferSize = ZSTD_DStreamInSize();</td></tr>
<tr class="codeline" data-linenumber="1734"><td class="num" id="LN1734">1734</td><td class="line">    ress.srcBuffer = malloc(ress.srcBufferSize);</td></tr>
<tr class="codeline" data-linenumber="1735"><td class="num" id="LN1735">1735</td><td class="line">    ress.dstBufferSize = ZSTD_DStreamOutSize();</td></tr>
<tr class="codeline" data-linenumber="1736"><td class="num" id="LN1736">1736</td><td class="line">    ress.dstBuffer = malloc(ress.dstBufferSize);</td></tr>
<tr class="codeline" data-linenumber="1737"><td class="num" id="LN1737">1737</td><td class="line">    <span class='keyword'>if</span> (!ress.srcBuffer || !ress.dstBuffer)</td></tr>
<tr class="codeline" data-linenumber="1738"><td class="num" id="LN1738">1738</td><td class="line">        <span class='macro'>EXM_THROW(61, <span class='string_literal'>"Allocation error : not enough memory"</span>)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1738<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 61); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Allocation error : not enough memory"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; exit(61); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1739"><td class="num" id="LN1739">1739</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1740"><td class="num" id="LN1740">1740</td><td class="line">    <span class='comment'>/* dictionary */</span></td></tr>
<tr class="codeline" data-linenumber="1741"><td class="num" id="LN1741">1741</td><td class="line">    {   <span class='keyword'>void</span>* dictBuffer;</td></tr>
<tr class="codeline" data-linenumber="1742"><td class="num" id="LN1742">1742</td><td class="line">        size_t <span class='keyword'>const</span> dictBufferSize = FIO_createDictBuffer(&amp;dictBuffer, dictFileName, prefs);</td></tr>
<tr class="codeline" data-linenumber="1743"><td class="num" id="LN1743">1743</td><td class="line">        <span class='macro'>CHECK( ZSTD_initDStream_usingDict(ress.dctx, dictBuffer, dictBufferSize) )<span class='macro_popup'>{ size_t err; err = ZSTD_initDStream_usingDict(ress.dctx, dictBuffer<br>, dictBufferSize); if (ERR_isError(err)) { { if (g_display_prefs<br>.displayLevel&gt;=5) { fprintf(stderr, "%s \n", "ZSTD_initDStream_usingDict(ress.dctx, dictBuffer, dictBufferSize)"<br>); } }; { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=<br>5) { fprintf(stderr, "Error defined at %s, line %i : \n", "fileio.c"<br>, 1743); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "error %i : ", 11); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } };<br> { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1744"><td class="num" id="LN1744">1744</td><td class="line">        free(dictBuffer);</td></tr>
<tr class="codeline" data-linenumber="1745"><td class="num" id="LN1745">1745</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1746"><td class="num" id="LN1746">1746</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1747"><td class="num" id="LN1747">1747</td><td class="line">    <span class='keyword'>return</span> ress;</td></tr>
<tr class="codeline" data-linenumber="1748"><td class="num" id="LN1748">1748</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1749"><td class="num" id="LN1749">1749</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1750"><td class="num" id="LN1750">1750</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> FIO_freeDResources(dRess_t ress)</td></tr>
<tr class="codeline" data-linenumber="1751"><td class="num" id="LN1751">1751</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1752"><td class="num" id="LN1752">1752</td><td class="line">    <span class='macro'>CHECK( ZSTD_freeDStream(ress.dctx) )<span class='macro_popup'>{ size_t err; err = ZSTD_freeDStream(ress.dctx); if (ERR_isError<br>(err)) { { if (g_display_prefs.displayLevel&gt;=5) { fprintf(<br>stderr, "%s \n", "ZSTD_freeDStream(ress.dctx)"); } }; { { if (<br>g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: "<br>); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf(stderr<br>, "Error defined at %s, line %i : \n", "fileio.c", 1752); } }<br>; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "error %i : ", 11); } }; { if (g_display_prefs.displayLevel&gt;=<br>1) { fprintf(stderr, "%s", ZSTD_getErrorName(err)); } }; { if<br> (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; exit(11); }; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1753"><td class="num" id="LN1753">1753</td><td class="line">    free(ress.srcBuffer);</td></tr>
<tr class="codeline" data-linenumber="1754"><td class="num" id="LN1754">1754</td><td class="line">    free(ress.dstBuffer);</td></tr>
<tr class="codeline" data-linenumber="1755"><td class="num" id="LN1755">1755</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1756"><td class="num" id="LN1756">1756</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1757"><td class="num" id="LN1757">1757</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1758"><td class="num" id="LN1758">1758</td><td class="line"><span class='comment'>/** FIO_fwriteSparse() :</span></td></tr>
<tr class="codeline" data-linenumber="1759"><td class="num" id="LN1759">1759</td><td class="line"><span class='comment'>*  @return : storedSkips,</span></td></tr>
<tr class="codeline" data-linenumber="1760"><td class="num" id="LN1760">1760</td><td class="line"><span class='comment'>*            argument for next call to FIO_fwriteSparse() or FIO_fwriteSparseEnd() */</span></td></tr>
<tr class="codeline" data-linenumber="1761"><td class="num" id="LN1761">1761</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span></td></tr>
<tr class="codeline" data-linenumber="1762"><td class="num" id="LN1762">1762</td><td class="line">FIO_fwriteSparse(FILE* file,</td></tr>
<tr class="codeline" data-linenumber="1763"><td class="num" id="LN1763">1763</td><td class="line">                 <span class='keyword'>const</span> <span class='keyword'>void</span>* buffer, size_t bufferSize,</td></tr>
<tr class="codeline" data-linenumber="1764"><td class="num" id="LN1764">1764</td><td class="line">                 <span class='keyword'>const</span> FIO_prefs_t* <span class='keyword'>const</span> prefs,</td></tr>
<tr class="codeline" data-linenumber="1765"><td class="num" id="LN1765">1765</td><td class="line">                 <span class='keyword'>unsigned</span> storedSkips)</td></tr>
<tr class="codeline" data-linenumber="1766"><td class="num" id="LN1766">1766</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1767"><td class="num" id="LN1767">1767</td><td class="line">    <span class='keyword'>const</span> size_t* <span class='keyword'>const</span> bufferT = (<span class='keyword'>const</span> size_t*)buffer;   <span class='comment'>/* Buffer is supposed malloc'ed, hence aligned on size_t */</span></td></tr>
<tr class="codeline" data-linenumber="1768"><td class="num" id="LN1768">1768</td><td class="line">    size_t bufferSizeT = bufferSize / <span class='keyword'>sizeof</span>(size_t);</td></tr>
<tr class="codeline" data-linenumber="1769"><td class="num" id="LN1769">1769</td><td class="line">    <span class='keyword'>const</span> size_t* <span class='keyword'>const</span> bufferTEnd = bufferT + bufferSizeT;</td></tr>
<tr class="codeline" data-linenumber="1770"><td class="num" id="LN1770">1770</td><td class="line">    <span class='keyword'>const</span> size_t* ptrT = bufferT;</td></tr>
<tr class="codeline" data-linenumber="1771"><td class="num" id="LN1771">1771</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>const</span> size_t segmentSizeT = (32 <span class='macro'>KB<span class='macro_popup'>*(1 &lt;&lt;10)</span></span>) / <span class='keyword'>sizeof</span>(size_t);   <span class='comment'>/* check every 32 KB */</span></td></tr>
<tr class="codeline" data-linenumber="1772"><td class="num" id="LN1772">1772</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1773"><td class="num" id="LN1773">1773</td><td class="line">    <span class='keyword'>if</span> (prefs-&gt;testMode) <span class='keyword'>return</span> 0;  <span class='comment'>/* do not output anything in test mode */</span></td></tr>
<tr class="codeline" data-linenumber="1774"><td class="num" id="LN1774">1774</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1775"><td class="num" id="LN1775">1775</td><td class="line">    <span class='keyword'>if</span> (!prefs-&gt;sparseFileSupport) {  <span class='comment'>/* normal write */</span></td></tr>
<tr class="codeline" data-linenumber="1776"><td class="num" id="LN1776">1776</td><td class="line">        size_t <span class='keyword'>const</span> sizeCheck = fwrite(buffer, 1, bufferSize, file);</td></tr>
<tr class="codeline" data-linenumber="1777"><td class="num" id="LN1777">1777</td><td class="line">        <span class='keyword'>if</span> (sizeCheck != bufferSize)</td></tr>
<tr class="codeline" data-linenumber="1778"><td class="num" id="LN1778">1778</td><td class="line">            <span class='macro'>EXM_THROW(70, <span class='string_literal'>"Write error : cannot write decoded block : %s"</span>,<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1779<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 70); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Write error : cannot write decoded block : %s"<br>, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(70);<br> }</span></span></td></tr>
<tr class="codeline" data-linenumber="1779"><td class="num" id="LN1779">1779</td><td class="line">                            <span class='macro'>strerror(errno))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1779<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 70); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Write error : cannot write decoded block : %s"<br>, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(70);<br> }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1780"><td class="num" id="LN1780">1780</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1781"><td class="num" id="LN1781">1781</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1782"><td class="num" id="LN1782">1782</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1783"><td class="num" id="LN1783">1783</td><td class="line">    <span class='comment'>/* avoid int overflow */</span></td></tr>
<tr class="codeline" data-linenumber="1784"><td class="num" id="LN1784">1784</td><td class="line">    <span class='keyword'>if</span> (storedSkips &gt; 1 <span class='macro'>GB<span class='macro_popup'>*(1U&lt;&lt;30)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1785"><td class="num" id="LN1785">1785</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>LONG_SEEK<span class='macro_popup'>fseek</span></span>(file, 1 <span class='macro'>GB<span class='macro_popup'>*(1U&lt;&lt;30)</span></span>, <span class='macro'>SEEK_CUR<span class='macro_popup'>1</span></span>) != 0)</td></tr>
<tr class="codeline" data-linenumber="1786"><td class="num" id="LN1786">1786</td><td class="line">            <span class='macro'>EXM_THROW(91, <span class='string_literal'>"1 GB skip error (sparse file support)"</span>)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1786<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 91); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "1 GB skip error (sparse file support)"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; exit(91); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1787"><td class="num" id="LN1787">1787</td><td class="line">        storedSkips -= 1 <span class='macro'>GB<span class='macro_popup'>*(1U&lt;&lt;30)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1788"><td class="num" id="LN1788">1788</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1789"><td class="num" id="LN1789">1789</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1790"><td class="num" id="LN1790">1790</td><td class="line">    <span class='keyword'>while</span> (ptrT &lt; bufferTEnd) {</td></tr>
<tr class="codeline" data-linenumber="1791"><td class="num" id="LN1791">1791</td><td class="line">        size_t nb0T;</td></tr>
<tr class="codeline" data-linenumber="1792"><td class="num" id="LN1792">1792</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1793"><td class="num" id="LN1793">1793</td><td class="line">        <span class='comment'>/* adjust last segment if &lt; 32 KB */</span></td></tr>
<tr class="codeline" data-linenumber="1794"><td class="num" id="LN1794">1794</td><td class="line">        size_t seg0SizeT = segmentSizeT;</td></tr>
<tr class="codeline" data-linenumber="1795"><td class="num" id="LN1795">1795</td><td class="line">        <span class='keyword'>if</span> (seg0SizeT &gt; bufferSizeT) seg0SizeT = bufferSizeT;</td></tr>
<tr class="codeline" data-linenumber="1796"><td class="num" id="LN1796">1796</td><td class="line">        bufferSizeT -= seg0SizeT;</td></tr>
<tr class="codeline" data-linenumber="1797"><td class="num" id="LN1797">1797</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1798"><td class="num" id="LN1798">1798</td><td class="line">        <span class='comment'>/* count leading zeroes */</span></td></tr>
<tr class="codeline" data-linenumber="1799"><td class="num" id="LN1799">1799</td><td class="line">        <span class='keyword'>for</span> (nb0T=0; (nb0T &lt; seg0SizeT) &amp;&amp; (ptrT[nb0T] == 0); nb0T++) ;</td></tr>
<tr class="codeline" data-linenumber="1800"><td class="num" id="LN1800">1800</td><td class="line">        storedSkips += (<span class='keyword'>unsigned</span>)(nb0T * <span class='keyword'>sizeof</span>(size_t));</td></tr>
<tr class="codeline" data-linenumber="1801"><td class="num" id="LN1801">1801</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1802"><td class="num" id="LN1802">1802</td><td class="line">        <span class='keyword'>if</span> (nb0T != seg0SizeT) {   <span class='comment'>/* not all 0s */</span></td></tr>
<tr class="codeline" data-linenumber="1803"><td class="num" id="LN1803">1803</td><td class="line">            size_t <span class='keyword'>const</span> nbNon0ST = seg0SizeT - nb0T;</td></tr>
<tr class="codeline" data-linenumber="1804"><td class="num" id="LN1804">1804</td><td class="line">            <span class='comment'>/* skip leading zeros */</span></td></tr>
<tr class="codeline" data-linenumber="1805"><td class="num" id="LN1805">1805</td><td class="line">            <span class='keyword'>if</span> (<span class='macro'>LONG_SEEK<span class='macro_popup'>fseek</span></span>(file, storedSkips, <span class='macro'>SEEK_CUR<span class='macro_popup'>1</span></span>) != 0)</td></tr>
<tr class="codeline" data-linenumber="1806"><td class="num" id="LN1806">1806</td><td class="line">                <span class='macro'>EXM_THROW(92, <span class='string_literal'>"Sparse skip error ; try --no-sparse"</span>)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1806<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 92); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Sparse skip error ; try --no-sparse"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; exit(92); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1807"><td class="num" id="LN1807">1807</td><td class="line">            storedSkips = 0;</td></tr>
<tr class="codeline" data-linenumber="1808"><td class="num" id="LN1808">1808</td><td class="line">            <span class='comment'>/* write the rest */</span></td></tr>
<tr class="codeline" data-linenumber="1809"><td class="num" id="LN1809">1809</td><td class="line">            <span class='keyword'>if</span> (fwrite(ptrT + nb0T, <span class='keyword'>sizeof</span>(size_t), nbNon0ST, file) != nbNon0ST)</td></tr>
<tr class="codeline" data-linenumber="1810"><td class="num" id="LN1810">1810</td><td class="line">                <span class='macro'>EXM_THROW(93, <span class='string_literal'>"Write error : cannot write decoded block : %s"</span>,<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1811<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 93); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Write error : cannot write decoded block : %s"<br>, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(93);<br> }</span></span></td></tr>
<tr class="codeline" data-linenumber="1811"><td class="num" id="LN1811">1811</td><td class="line">                            <span class='macro'>strerror(errno))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1811<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 93); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Write error : cannot write decoded block : %s"<br>, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(93);<br> }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1812"><td class="num" id="LN1812">1812</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1813"><td class="num" id="LN1813">1813</td><td class="line">        ptrT += seg0SizeT;</td></tr>
<tr class="codeline" data-linenumber="1814"><td class="num" id="LN1814">1814</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1815"><td class="num" id="LN1815">1815</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1816"><td class="num" id="LN1816">1816</td><td class="line">    {   <span class='keyword'>static</span> size_t <span class='keyword'>const</span> maskT = <span class='keyword'>sizeof</span>(size_t)-1;</td></tr>
<tr class="codeline" data-linenumber="1817"><td class="num" id="LN1817">1817</td><td class="line">        <span class='keyword'>if</span> (bufferSize &amp; maskT) {</td></tr>
<tr class="codeline" data-linenumber="1818"><td class="num" id="LN1818">1818</td><td class="line">            <span class='comment'>/* size not multiple of sizeof(size_t) : implies end of block */</span></td></tr>
<tr class="codeline" data-linenumber="1819"><td class="num" id="LN1819">1819</td><td class="line">            <span class='keyword'>const</span> <span class='keyword'>char</span>* <span class='keyword'>const</span> restStart = (<span class='keyword'>const</span> <span class='keyword'>char</span>*)bufferTEnd;</td></tr>
<tr class="codeline" data-linenumber="1820"><td class="num" id="LN1820">1820</td><td class="line">            <span class='keyword'>const</span> <span class='keyword'>char</span>* restPtr = restStart;</td></tr>
<tr class="codeline" data-linenumber="1821"><td class="num" id="LN1821">1821</td><td class="line">            <span class='keyword'>const</span> <span class='keyword'>char</span>* <span class='keyword'>const</span> restEnd = (<span class='keyword'>const</span> <span class='keyword'>char</span>*)buffer + bufferSize;</td></tr>
<tr class="codeline" data-linenumber="1822"><td class="num" id="LN1822">1822</td><td class="line">            <span class='macro'>assert(restEnd &gt; restStart &amp;&amp; restEnd &lt; restStart + <span class='keyword'>sizeof</span>(size_t))<span class='macro_popup'>((void) sizeof ((restEnd &gt; restStart &amp;&amp; restEnd &lt;<br> restStart + sizeof(size_t)) ? 1 : 0), __extension__ ({ if (restEnd<br> &gt; restStart &amp;&amp; restEnd &lt; restStart + sizeof(size_t<br>)) ; else __assert_fail ("restEnd &gt; restStart &amp;&amp; restEnd &lt; restStart + sizeof(size_t)"<br>, "fileio.c", 1822, __extension__ __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1823"><td class="num" id="LN1823">1823</td><td class="line">            <span class='keyword'>for</span> ( ; (restPtr &lt; restEnd) &amp;&amp; (*restPtr == 0); restPtr++) ;</td></tr>
<tr class="codeline" data-linenumber="1824"><td class="num" id="LN1824">1824</td><td class="line">            storedSkips += (<span class='keyword'>unsigned</span>) (restPtr - restStart);</td></tr>
<tr class="codeline" data-linenumber="1825"><td class="num" id="LN1825">1825</td><td class="line">            <span class='keyword'>if</span> (restPtr != restEnd) {</td></tr>
<tr class="codeline" data-linenumber="1826"><td class="num" id="LN1826">1826</td><td class="line">                <span class='comment'>/* not all remaining bytes are 0 */</span></td></tr>
<tr class="codeline" data-linenumber="1827"><td class="num" id="LN1827">1827</td><td class="line">                size_t <span class='keyword'>const</span> restSize = (size_t)(restEnd - restPtr);</td></tr>
<tr class="codeline" data-linenumber="1828"><td class="num" id="LN1828">1828</td><td class="line">                <span class='keyword'>if</span> (<span class='macro'>LONG_SEEK<span class='macro_popup'>fseek</span></span>(file, storedSkips, <span class='macro'>SEEK_CUR<span class='macro_popup'>1</span></span>) != 0)</td></tr>
<tr class="codeline" data-linenumber="1829"><td class="num" id="LN1829">1829</td><td class="line">                    <span class='macro'>EXM_THROW(92, <span class='string_literal'>"Sparse skip error ; try --no-sparse"</span>)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1829<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 92); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Sparse skip error ; try --no-sparse"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; exit(92); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1830"><td class="num" id="LN1830">1830</td><td class="line">                <span class='keyword'>if</span> (fwrite(restPtr, 1, restSize, file) != restSize)</td></tr>
<tr class="codeline" data-linenumber="1831"><td class="num" id="LN1831">1831</td><td class="line">                    <span class='macro'>EXM_THROW(95, <span class='string_literal'>"Write error : cannot write end of decoded block : %s"</span>,<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1832<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 95); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Write error : cannot write end of decoded block : %s"<br>, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(95);<br> }</span></span></td></tr>
<tr class="codeline" data-linenumber="1832"><td class="num" id="LN1832">1832</td><td class="line">                        <span class='macro'>strerror(errno))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1832<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 95); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Write error : cannot write end of decoded block : %s"<br>, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(95);<br> }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1833"><td class="num" id="LN1833">1833</td><td class="line">                storedSkips = 0;</td></tr>
<tr class="codeline" data-linenumber="1834"><td class="num" id="LN1834">1834</td><td class="line">    }   }   }</td></tr>
<tr class="codeline" data-linenumber="1835"><td class="num" id="LN1835">1835</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1836"><td class="num" id="LN1836">1836</td><td class="line">    <span class='keyword'>return</span> storedSkips;</td></tr>
<tr class="codeline" data-linenumber="1837"><td class="num" id="LN1837">1837</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1838"><td class="num" id="LN1838">1838</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1839"><td class="num" id="LN1839">1839</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="1840"><td class="num" id="LN1840">1840</td><td class="line">FIO_fwriteSparseEnd(<span class='keyword'>const</span> FIO_prefs_t* <span class='keyword'>const</span> prefs, FILE* file, <span class='keyword'>unsigned</span> storedSkips)</td></tr>
<tr class="codeline" data-linenumber="1841"><td class="num" id="LN1841">1841</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1842"><td class="num" id="LN1842">1842</td><td class="line">    <span class='keyword'>if</span> (prefs-&gt;testMode) <span class='macro'>assert(storedSkips == 0)<span class='macro_popup'>((void) sizeof ((storedSkips == 0) ? 1 : 0), __extension__ ({<br> if (storedSkips == 0) ; else __assert_fail ("storedSkips == 0"<br>, "fileio.c", 1842, __extension__ __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1843"><td class="num" id="LN1843">1843</td><td class="line">    <span class='keyword'>if</span> (storedSkips&gt;0) {</td></tr>
<tr class="codeline" data-linenumber="1844"><td class="num" id="LN1844">1844</td><td class="line">        <span class='macro'>assert(prefs-&gt;sparseFileSupport &gt; 0)<span class='macro_popup'>((void) sizeof ((prefs-&gt;sparseFileSupport &gt; 0) ? 1 : 0)<br>, __extension__ ({ if (prefs-&gt;sparseFileSupport &gt; 0) ; else<br> __assert_fail ("prefs-&gt;sparseFileSupport &gt; 0", "fileio.c"<br>, 1844, __extension__ __PRETTY_FUNCTION__); }))</span></span>;  <span class='comment'>/* storedSkips&gt;0 implies sparse support is enabled */</span></td></tr>
<tr class="codeline" data-linenumber="1845"><td class="num" id="LN1845">1845</td><td class="line">        (<span class='keyword'>void</span>)prefs;   <span class='comment'>/* assert can be disabled, in which case prefs becomes unused */</span></td></tr>
<tr class="codeline" data-linenumber="1846"><td class="num" id="LN1846">1846</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>LONG_SEEK<span class='macro_popup'>fseek</span></span>(file, storedSkips-1, <span class='macro'>SEEK_CUR<span class='macro_popup'>1</span></span>) != 0)</td></tr>
<tr class="codeline" data-linenumber="1847"><td class="num" id="LN1847">1847</td><td class="line">            <span class='macro'>EXM_THROW(69, <span class='string_literal'>"Final skip error (sparse file support)"</span>)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1847<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 69); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Final skip error (sparse file support)"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; exit(69); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1848"><td class="num" id="LN1848">1848</td><td class="line">        <span class='comment'>/* last zero must be explicitly written,</span></td></tr>
<tr class="codeline" data-linenumber="1849"><td class="num" id="LN1849">1849</td><td class="line">         <span class='comment'>* so that skipped ones get implicitly translated as zero by FS */</span></td></tr>
<tr class="codeline" data-linenumber="1850"><td class="num" id="LN1850">1850</td><td class="line">        {   <span class='keyword'>const</span> <span class='keyword'>char</span> lastZeroByte[1] = { 0 };</td></tr>
<tr class="codeline" data-linenumber="1851"><td class="num" id="LN1851">1851</td><td class="line">            <span class='keyword'>if</span> (fwrite(lastZeroByte, 1, 1, file) != 1)</td></tr>
<tr class="codeline" data-linenumber="1852"><td class="num" id="LN1852">1852</td><td class="line">                <span class='macro'>EXM_THROW(69, <span class='string_literal'>"Write error : cannot write last zero : %s"</span>, strerror(errno))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 1852<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 69); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Write error : cannot write last zero : %s"<br>, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(69);<br> }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1853"><td class="num" id="LN1853">1853</td><td class="line">    }   }</td></tr>
<tr class="codeline" data-linenumber="1854"><td class="num" id="LN1854">1854</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1855"><td class="num" id="LN1855">1855</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1856"><td class="num" id="LN1856">1856</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1857"><td class="num" id="LN1857">1857</td><td class="line"><span class='comment'>/** FIO_passThrough() : just copy input into output, for compatibility with gzip -df mode</span></td></tr>
<tr class="codeline" data-linenumber="1858"><td class="num" id="LN1858">1858</td><td class="line">    <span class='comment'>@return : 0 (no error) */</span></td></tr>
<tr class="codeline" data-linenumber="1859"><td class="num" id="LN1859">1859</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> FIO_passThrough(<span class='keyword'>const</span> FIO_prefs_t* <span class='keyword'>const</span> prefs,</td></tr>
<tr class="codeline" data-linenumber="1860"><td class="num" id="LN1860">1860</td><td class="line">                           FILE* foutput, FILE* finput,</td></tr>
<tr class="codeline" data-linenumber="1861"><td class="num" id="LN1861">1861</td><td class="line">                           <span class='keyword'>void</span>* buffer, size_t bufferSize,</td></tr>
<tr class="codeline" data-linenumber="1862"><td class="num" id="LN1862">1862</td><td class="line">                           size_t alreadyLoaded)</td></tr>
<tr class="codeline" data-linenumber="1863"><td class="num" id="LN1863">1863</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1864"><td class="num" id="LN1864">1864</td><td class="line">    size_t <span class='keyword'>const</span> blockSize = <span class='macro'>MIN(64 KB, bufferSize)<span class='macro_popup'>((64 *(1 &lt;&lt;10)) &lt; (bufferSize) ? (64 *(1 &lt;&lt;10)<br>) : (bufferSize))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1865"><td class="num" id="LN1865">1865</td><td class="line">    size_t readFromInput;</td></tr>
<tr class="codeline" data-linenumber="1866"><td class="num" id="LN1866">1866</td><td class="line">    <span class='keyword'>unsigned</span> storedSkips = 0;</td></tr>
<tr class="codeline" data-linenumber="1867"><td class="num" id="LN1867">1867</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1868"><td class="num" id="LN1868">1868</td><td class="line">    <span class='comment'>/* assumption : ress-&gt;srcBufferLoaded bytes already loaded and stored within buffer */</span></td></tr>
<tr class="codeline" data-linenumber="1869"><td class="num" id="LN1869">1869</td><td class="line">    {   size_t <span class='keyword'>const</span> sizeCheck = fwrite(buffer, 1, alreadyLoaded, foutput);</td></tr>
<tr class="codeline" data-linenumber="1870"><td class="num" id="LN1870">1870</td><td class="line">        <span class='keyword'>if</span> (sizeCheck != alreadyLoaded) {</td></tr>
<tr class="codeline" data-linenumber="1871"><td class="num" id="LN1871">1871</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"Pass-through write error : %s\n"</span>, strerror(errno))<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "Pass-through write error : %s\n"<br>, strerror((*__errno_location ()))); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1872"><td class="num" id="LN1872">1872</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1873"><td class="num" id="LN1873">1873</td><td class="line">    }   }</td></tr>
<tr class="codeline" data-linenumber="1874"><td class="num" id="LN1874">1874</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1875"><td class="num" id="LN1875">1875</td><td class="line">    <span class='keyword'>do</span> {</td></tr>
<tr class="codeline" data-linenumber="1876"><td class="num" id="LN1876">1876</td><td class="line">        readFromInput = fread(buffer, 1, blockSize, finput);</td></tr>
<tr class="codeline" data-linenumber="1877"><td class="num" id="LN1877">1877</td><td class="line">        storedSkips = FIO_fwriteSparse(foutput, buffer, readFromInput, prefs, storedSkips);</td></tr>
<tr class="codeline" data-linenumber="1878"><td class="num" id="LN1878">1878</td><td class="line">    } <span class='keyword'>while</span> (readFromInput == blockSize);</td></tr>
<tr class="codeline" data-linenumber="1879"><td class="num" id="LN1879">1879</td><td class="line">    <span class='keyword'>if</span> (ferror(finput)) {</td></tr>
<tr class="codeline" data-linenumber="1880"><td class="num" id="LN1880">1880</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"Pass-through read error : %s\n"</span>, strerror(errno))<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "Pass-through read error : %s\n"<br>, strerror((*__errno_location ()))); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1881"><td class="num" id="LN1881">1881</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1882"><td class="num" id="LN1882">1882</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1883"><td class="num" id="LN1883">1883</td><td class="line">    <span class='macro'>assert(feof(finput))<span class='macro_popup'>((void) sizeof ((feof(finput)) ? 1 : 0), __extension__ ({ if (<br>feof(finput)) ; else __assert_fail ("feof(finput)", "fileio.c"<br>, 1883, __extension__ __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1884"><td class="num" id="LN1884">1884</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1885"><td class="num" id="LN1885">1885</td><td class="line">    FIO_fwriteSparseEnd(prefs, foutput, storedSkips);</td></tr>
<tr class="codeline" data-linenumber="1886"><td class="num" id="LN1886">1886</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1887"><td class="num" id="LN1887">1887</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1888"><td class="num" id="LN1888">1888</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1889"><td class="num" id="LN1889">1889</td><td class="line"><span class='comment'>/* FIO_zstdErrorHelp() :</span></td></tr>
<tr class="codeline" data-linenumber="1890"><td class="num" id="LN1890">1890</td><td class="line"> <span class='comment'>* detailed error message when requested window size is too large */</span></td></tr>
<tr class="codeline" data-linenumber="1891"><td class="num" id="LN1891">1891</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="1892"><td class="num" id="LN1892">1892</td><td class="line">FIO_zstdErrorHelp(<span class='keyword'>const</span> FIO_prefs_t* <span class='keyword'>const</span> prefs,</td></tr>
<tr class="codeline" data-linenumber="1893"><td class="num" id="LN1893">1893</td><td class="line">                  <span class='keyword'>const</span> dRess_t* ress,</td></tr>
<tr class="codeline" data-linenumber="1894"><td class="num" id="LN1894">1894</td><td class="line">                  size_t err, <span class='keyword'>const</span> <span class='keyword'>char</span>* srcFileName)</td></tr>
<tr class="codeline" data-linenumber="1895"><td class="num" id="LN1895">1895</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1896"><td class="num" id="LN1896">1896</td><td class="line">    ZSTD_frameHeader header;</td></tr>
<tr class="codeline" data-linenumber="1897"><td class="num" id="LN1897">1897</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1898"><td class="num" id="LN1898">1898</td><td class="line">    <span class='comment'>/* Help message only for one specific error */</span></td></tr>
<tr class="codeline" data-linenumber="1899"><td class="num" id="LN1899">1899</td><td class="line">    <span class='keyword'>if</span> (ZSTD_getErrorCode(err) != ZSTD_error_frameParameter_windowTooLarge)</td></tr>
<tr class="codeline" data-linenumber="1900"><td class="num" id="LN1900">1900</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1901"><td class="num" id="LN1901">1901</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1902"><td class="num" id="LN1902">1902</td><td class="line">    <span class='comment'>/* Try to decode the frame header */</span></td></tr>
<tr class="codeline" data-linenumber="1903"><td class="num" id="LN1903">1903</td><td class="line">    err = ZSTD_getFrameHeader(&amp;header, ress-&gt;srcBuffer, ress-&gt;srcBufferLoaded);</td></tr>
<tr class="codeline" data-linenumber="1904"><td class="num" id="LN1904">1904</td><td class="line">    <span class='keyword'>if</span> (err == 0) {</td></tr>
<tr class="codeline" data-linenumber="1905"><td class="num" id="LN1905">1905</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> <span class='keyword'>const</span> windowSize = header.windowSize;</td></tr>
<tr class="codeline" data-linenumber="1906"><td class="num" id="LN1906">1906</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>const</span> windowLog = FIO_highbit64(windowSize) + ((windowSize &amp; (windowSize - 1)) != 0);</td></tr>
<tr class="codeline" data-linenumber="1907"><td class="num" id="LN1907">1907</td><td class="line">        <span class='macro'>assert(prefs-&gt;memLimit &gt; 0)<span class='macro_popup'>((void) sizeof ((prefs-&gt;memLimit &gt; 0) ? 1 : 0), __extension__<br> ({ if (prefs-&gt;memLimit &gt; 0) ; else __assert_fail ("prefs-&gt;memLimit &gt; 0"<br>, "fileio.c", 1907, __extension__ __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1908"><td class="num" id="LN1908">1908</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"%s : Window size larger than maximum : %llu &gt; %u \n"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "%s : Window size larger than maximum : %llu &gt; %u \n"<br>, srcFileName, windowSize, prefs-&gt;memLimit); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1909"><td class="num" id="LN1909">1909</td><td class="line">                        <span class='macro'>srcFileName, windowSize, prefs-&gt;memLimit)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "%s : Window size larger than maximum : %llu &gt; %u \n"<br>, srcFileName, windowSize, prefs-&gt;memLimit); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1910"><td class="num" id="LN1910">1910</td><td class="line">        <span class='keyword'>if</span> (windowLog &lt;= <span class='macro'>ZSTD_WINDOWLOG_MAX<span class='macro_popup'>((int)(sizeof(size_t) == 4 ? 30 : 31))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1911"><td class="num" id="LN1911">1911</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>const</span> windowMB = (<span class='keyword'>unsigned</span>)((windowSize &gt;&gt; 20) + ((windowSize &amp; ((1 <span class='macro'>MB<span class='macro_popup'>*(1 &lt;&lt;20)</span></span>) - 1)) != 0));</td></tr>
<tr class="codeline" data-linenumber="1912"><td class="num" id="LN1912">1912</td><td class="line">            <span class='macro'>assert(windowSize &lt; (U64)(1ULL &lt;&lt; 52))<span class='macro_popup'>((void) sizeof ((windowSize &lt; (U64)(1ULL &lt;&lt; 52)) ? 1<br> : 0), __extension__ ({ if (windowSize &lt; (U64)(1ULL &lt;&lt;<br> 52)) ; else __assert_fail ("windowSize &lt; (U64)(1ULL &lt;&lt; 52)"<br>, "fileio.c", 1912, __extension__ __PRETTY_FUNCTION__); }))</span></span>;   <span class='comment'>/* ensure now overflow for windowMB */</span></td></tr>
<tr class="codeline" data-linenumber="1913"><td class="num" id="LN1913">1913</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"%s : Use --long=%u or --memory=%uMB \n"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "%s : Use --long=%u or --memory=%uMB \n"<br>, srcFileName, windowLog, windowMB); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1914"><td class="num" id="LN1914">1914</td><td class="line">                            <span class='macro'>srcFileName, windowLog, windowMB)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "%s : Use --long=%u or --memory=%uMB \n"<br>, srcFileName, windowLog, windowMB); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1915"><td class="num" id="LN1915">1915</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1916"><td class="num" id="LN1916">1916</td><td class="line">    }   }</td></tr>
<tr class="codeline" data-linenumber="1917"><td class="num" id="LN1917">1917</td><td class="line">    <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"%s : Window log larger than ZSTD_WINDOWLOG_MAX=%u; not supported \n"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "%s : Window log larger than ZSTD_WINDOWLOG_MAX=%u; not supported \n"<br>, srcFileName, ((int)(sizeof(size_t) == 4 ? 30 : 31))); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1918"><td class="num" id="LN1918">1918</td><td class="line">                    <span class='macro'>srcFileName, ZSTD_WINDOWLOG_MAX)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "%s : Window log larger than ZSTD_WINDOWLOG_MAX=%u; not supported \n"<br>, srcFileName, ((int)(sizeof(size_t) == 4 ? 30 : 31))); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1919"><td class="num" id="LN1919">1919</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1920"><td class="num" id="LN1920">1920</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1921"><td class="num" id="LN1921">1921</td><td class="line"><span class='comment'>/** FIO_decompressFrame() :</span></td></tr>
<tr class="codeline" data-linenumber="1922"><td class="num" id="LN1922">1922</td><td class="line"> <span class='comment'>*  @return : size of decoded zstd frame, or an error code</span></td></tr>
<tr class="codeline" data-linenumber="1923"><td class="num" id="LN1923">1923</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1924"><td class="num" id="LN1924">1924</td><td class="line"><span class='directive'>#define <span class='macro'>FIO_ERROR_FRAME_DECODING<span class='macro_popup'>((unsigned long long)(-2))</span></span>   ((unsigned long long)(-2))</span></td></tr>
<tr class="codeline" data-linenumber="1925"><td class="num" id="LN1925">1925</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span></td></tr>
<tr class="codeline" data-linenumber="1926"><td class="num" id="LN1926">1926</td><td class="line">FIO_decompressZstdFrame(dRess_t* ress, FILE* finput,</td></tr>
<tr class="codeline" data-linenumber="1927"><td class="num" id="LN1927">1927</td><td class="line">                        <span class='keyword'>const</span> FIO_prefs_t* <span class='keyword'>const</span> prefs,</td></tr>
<tr class="codeline" data-linenumber="1928"><td class="num" id="LN1928">1928</td><td class="line">                        <span class='keyword'>const</span> <span class='keyword'>char</span>* srcFileName,</td></tr>
<tr class="codeline" data-linenumber="1929"><td class="num" id="LN1929">1929</td><td class="line">                        U64 alreadyDecoded)  <span class='comment'>/* for multi-frames streams */</span></td></tr>
<tr class="codeline" data-linenumber="1930"><td class="num" id="LN1930">1930</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1931"><td class="num" id="LN1931">1931</td><td class="line">    U64 frameSize = 0;</td></tr>
<tr class="codeline" data-linenumber="1932"><td class="num" id="LN1932">1932</td><td class="line">    U32 storedSkips = 0;</td></tr>
<tr class="codeline" data-linenumber="1933"><td class="num" id="LN1933">1933</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1934"><td class="num" id="LN1934">1934</td><td class="line">    <span class='comment'>/* display last 20 characters only */</span></td></tr>
<tr class="codeline" data-linenumber="1935"><td class="num" id="LN1935">1935</td><td class="line">    {   size_t <span class='keyword'>const</span> srcFileLength = strlen(srcFileName);</td></tr>
<tr class="codeline" data-linenumber="1936"><td class="num" id="LN1936">1936</td><td class="line">        <span class='keyword'>if</span> (srcFileLength&gt;20) srcFileName += srcFileLength-20;</td></tr>
<tr class="codeline" data-linenumber="1937"><td class="num" id="LN1937">1937</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1938"><td class="num" id="LN1938">1938</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1939"><td class="num" id="LN1939">1939</td><td class="line">    ZSTD_resetDStream(ress-&gt;dctx);</td></tr>
<tr class="codeline" data-linenumber="1940"><td class="num" id="LN1940">1940</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1941"><td class="num" id="LN1941">1941</td><td class="line">    <span class='comment'>/* Header loading : ensures ZSTD_getFrameHeader() will succeed */</span></td></tr>
<tr class="codeline" data-linenumber="1942"><td class="num" id="LN1942">1942</td><td class="line">    {   size_t <span class='keyword'>const</span> toDecode = <span class='macro'>ZSTD_FRAMEHEADERSIZE_MAX<span class='macro_popup'>18</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1943"><td class="num" id="LN1943">1943</td><td class="line">        <span class='keyword'>if</span> (ress-&gt;srcBufferLoaded &lt; toDecode) {</td></tr>
<tr class="codeline" data-linenumber="1944"><td class="num" id="LN1944">1944</td><td class="line">            size_t <span class='keyword'>const</span> toRead = toDecode - ress-&gt;srcBufferLoaded;</td></tr>
<tr class="codeline" data-linenumber="1945"><td class="num" id="LN1945">1945</td><td class="line">            <span class='keyword'>void</span>* <span class='keyword'>const</span> startPosition = (<span class='keyword'>char</span>*)ress-&gt;srcBuffer + ress-&gt;srcBufferLoaded;</td></tr>
<tr class="codeline" data-linenumber="1946"><td class="num" id="LN1946">1946</td><td class="line">            ress-&gt;srcBufferLoaded += fread(startPosition, 1, toRead, finput);</td></tr>
<tr class="codeline" data-linenumber="1947"><td class="num" id="LN1947">1947</td><td class="line">    }   }</td></tr>
<tr class="codeline" data-linenumber="1948"><td class="num" id="LN1948">1948</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1949"><td class="num" id="LN1949">1949</td><td class="line">    <span class='comment'>/* Main decompression Loop */</span></td></tr>
<tr class="codeline" data-linenumber="1950"><td class="num" id="LN1950">1950</td><td class="line">    <span class='keyword'>while</span> (1) {</td></tr>
<tr class="codeline" data-linenumber="1951"><td class="num" id="LN1951">1951</td><td class="line">        ZSTD_inBuffer  inBuff = { ress-&gt;srcBuffer, ress-&gt;srcBufferLoaded, 0 };</td></tr>
<tr class="codeline" data-linenumber="1952"><td class="num" id="LN1952">1952</td><td class="line">        ZSTD_outBuffer outBuff= { ress-&gt;dstBuffer, ress-&gt;dstBufferSize, 0 };</td></tr>
<tr class="codeline" data-linenumber="1953"><td class="num" id="LN1953">1953</td><td class="line">        size_t <span class='keyword'>const</span> readSizeHint = ZSTD_decompressStream(ress-&gt;dctx, &amp;outBuff, &amp;inBuff);</td></tr>
<tr class="codeline" data-linenumber="1954"><td class="num" id="LN1954">1954</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>ZSTD_isError<span class='macro_popup'>ERR_isError</span></span>(readSizeHint)) {</td></tr>
<tr class="codeline" data-linenumber="1955"><td class="num" id="LN1955">1955</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"%s : Decoding error (36) : %s \n"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "%s : Decoding error (36) : %s \n"<br>, srcFileName, ZSTD_getErrorName(readSizeHint)); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1956"><td class="num" id="LN1956">1956</td><td class="line">                            <span class='macro'>srcFileName, ZSTD_getErrorName(readSizeHint))<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "%s : Decoding error (36) : %s \n"<br>, srcFileName, ZSTD_getErrorName(readSizeHint)); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1957"><td class="num" id="LN1957">1957</td><td class="line">            FIO_zstdErrorHelp(prefs, ress, readSizeHint, srcFileName);</td></tr>
<tr class="codeline" data-linenumber="1958"><td class="num" id="LN1958">1958</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>FIO_ERROR_FRAME_DECODING<span class='macro_popup'>((unsigned long long)(-2))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1959"><td class="num" id="LN1959">1959</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1960"><td class="num" id="LN1960">1960</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1961"><td class="num" id="LN1961">1961</td><td class="line">        <span class='comment'>/* Write block */</span></td></tr>
<tr class="codeline" data-linenumber="1962"><td class="num" id="LN1962">1962</td><td class="line">        storedSkips = FIO_fwriteSparse(ress-&gt;dstFile, ress-&gt;dstBuffer, outBuff.pos, prefs, storedSkips);</td></tr>
<tr class="codeline" data-linenumber="1963"><td class="num" id="LN1963">1963</td><td class="line">        frameSize += outBuff.pos;</td></tr>
<tr class="codeline" data-linenumber="1964"><td class="num" id="LN1964">1964</td><td class="line">        <span class='macro'>DISPLAYUPDATE(2, <span class='string_literal'>"\r%-20.20s : %u MB...     "</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\r%-20.20s : %u MB...     ", srcFileName, (unsigned)((alreadyDecoded<br>+frameSize)&gt;&gt;20)); if (g_display_prefs.displayLevel&gt;=<br>4) fflush(stderr); } } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1965"><td class="num" id="LN1965">1965</td><td class="line">                         <span class='macro'>srcFileName, (<span class='keyword'>unsigned</span>)((alreadyDecoded+frameSize)&gt;&gt;20) )<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\r%-20.20s : %u MB...     ", srcFileName, (unsigned)((alreadyDecoded<br>+frameSize)&gt;&gt;20)); if (g_display_prefs.displayLevel&gt;=<br>4) fflush(stderr); } } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1966"><td class="num" id="LN1966">1966</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1967"><td class="num" id="LN1967">1967</td><td class="line">        <span class='keyword'>if</span> (inBuff.pos &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="1968"><td class="num" id="LN1968">1968</td><td class="line">            memmove(ress-&gt;srcBuffer, (<span class='keyword'>char</span>*)ress-&gt;srcBuffer + inBuff.pos, inBuff.size - inBuff.pos);</td></tr>
<tr class="codeline" data-linenumber="1969"><td class="num" id="LN1969">1969</td><td class="line">            ress-&gt;srcBufferLoaded -= inBuff.pos;</td></tr>
<tr class="codeline" data-linenumber="1970"><td class="num" id="LN1970">1970</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1971"><td class="num" id="LN1971">1971</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1972"><td class="num" id="LN1972">1972</td><td class="line">        <span class='keyword'>if</span> (readSizeHint == 0) <span class='keyword'>break</span>;   <span class='comment'>/* end of frame */</span></td></tr>
<tr class="codeline" data-linenumber="1973"><td class="num" id="LN1973">1973</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1974"><td class="num" id="LN1974">1974</td><td class="line">        <span class='comment'>/* Fill input buffer */</span></td></tr>
<tr class="codeline" data-linenumber="1975"><td class="num" id="LN1975">1975</td><td class="line">        {   size_t <span class='keyword'>const</span> toDecode = <span class='macro'>MIN(readSizeHint, ress-&gt;srcBufferSize)<span class='macro_popup'>((readSizeHint) &lt; (ress-&gt;srcBufferSize) ? (readSizeHint<br>) : (ress-&gt;srcBufferSize))</span></span>;  <span class='comment'>/* support large skippable frames */</span></td></tr>
<tr class="codeline" data-linenumber="1976"><td class="num" id="LN1976">1976</td><td class="line">            <span class='keyword'>if</span> (ress-&gt;srcBufferLoaded &lt; toDecode) {</td></tr>
<tr class="codeline" data-linenumber="1977"><td class="num" id="LN1977">1977</td><td class="line">                size_t <span class='keyword'>const</span> toRead = toDecode - ress-&gt;srcBufferLoaded;   <span class='comment'>/* &gt; 0 */</span></td></tr>
<tr class="codeline" data-linenumber="1978"><td class="num" id="LN1978">1978</td><td class="line">                <span class='keyword'>void</span>* <span class='keyword'>const</span> startPosition = (<span class='keyword'>char</span>*)ress-&gt;srcBuffer + ress-&gt;srcBufferLoaded;</td></tr>
<tr class="codeline" data-linenumber="1979"><td class="num" id="LN1979">1979</td><td class="line">                size_t <span class='keyword'>const</span> readSize = fread(startPosition, 1, toRead, finput);</td></tr>
<tr class="codeline" data-linenumber="1980"><td class="num" id="LN1980">1980</td><td class="line">                <span class='keyword'>if</span> (readSize==0) {</td></tr>
<tr class="codeline" data-linenumber="1981"><td class="num" id="LN1981">1981</td><td class="line">                    <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"%s : Read error (39) : premature end \n"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "%s : Read error (39) : premature end \n"<br>, srcFileName); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="1982"><td class="num" id="LN1982">1982</td><td class="line">                                    <span class='macro'>srcFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "%s : Read error (39) : premature end \n"<br>, srcFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1983"><td class="num" id="LN1983">1983</td><td class="line">                    <span class='keyword'>return</span> <span class='macro'>FIO_ERROR_FRAME_DECODING<span class='macro_popup'>((unsigned long long)(-2))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1984"><td class="num" id="LN1984">1984</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1985"><td class="num" id="LN1985">1985</td><td class="line">                ress-&gt;srcBufferLoaded += readSize;</td></tr>
<tr class="codeline" data-linenumber="1986"><td class="num" id="LN1986">1986</td><td class="line">    }   }   }</td></tr>
<tr class="codeline" data-linenumber="1987"><td class="num" id="LN1987">1987</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1988"><td class="num" id="LN1988">1988</td><td class="line">    FIO_fwriteSparseEnd(prefs, ress-&gt;dstFile, storedSkips);</td></tr>
<tr class="codeline" data-linenumber="1989"><td class="num" id="LN1989">1989</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1990"><td class="num" id="LN1990">1990</td><td class="line">    <span class='keyword'>return</span> frameSize;</td></tr>
<tr class="codeline" data-linenumber="1991"><td class="num" id="LN1991">1991</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1992"><td class="num" id="LN1992">1992</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1993"><td class="num" id="LN1993">1993</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1994"><td class="num" id="LN1994">1994</td><td class="line"><span class='directive'>#ifdef <span class='macro'>ZSTD_GZDECOMPRESS<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="1995"><td class="num" id="LN1995">1995</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span></td></tr>
<tr class="codeline" data-linenumber="1996"><td class="num" id="LN1996">1996</td><td class="line">FIO_decompressGzFrame(dRess_t* ress, FILE* srcFile,</td></tr>
<tr class="codeline" data-linenumber="1997"><td class="num" id="LN1997">1997</td><td class="line">                      <span class='keyword'>const</span> FIO_prefs_t* <span class='keyword'>const</span> prefs,</td></tr>
<tr class="codeline" data-linenumber="1998"><td class="num" id="LN1998">1998</td><td class="line">                      <span class='keyword'>const</span> <span class='keyword'>char</span>* srcFileName)</td></tr>
<tr class="codeline" data-linenumber="1999"><td class="num" id="LN1999">1999</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2000"><td class="num" id="LN2000">2000</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> outFileSize = 0;</td></tr>
<tr class="codeline" data-linenumber="2001"><td class="num" id="LN2001">2001</td><td class="line">    z_stream strm;</td></tr>
<tr class="codeline" data-linenumber="2002"><td class="num" id="LN2002">2002</td><td class="line">    <span class='keyword'>int</span> flush = <span class='macro'>Z_NO_FLUSH<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2003"><td class="num" id="LN2003">2003</td><td class="line">    <span class='keyword'>int</span> decodingError = 0;</td></tr>
<tr class="codeline" data-linenumber="2004"><td class="num" id="LN2004">2004</td><td class="line">    <span class='keyword'>unsigned</span> storedSkips = 0;</td></tr>
<tr class="codeline" data-linenumber="2005"><td class="num" id="LN2005">2005</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2006"><td class="num" id="LN2006">2006</td><td class="line">    strm.zalloc = <span class='macro'>Z_NULL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2007"><td class="num" id="LN2007">2007</td><td class="line">    strm.zfree = <span class='macro'>Z_NULL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2008"><td class="num" id="LN2008">2008</td><td class="line">    strm.opaque = <span class='macro'>Z_NULL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2009"><td class="num" id="LN2009">2009</td><td class="line">    strm.next_in = 0;</td></tr>
<tr class="codeline" data-linenumber="2010"><td class="num" id="LN2010">2010</td><td class="line">    strm.avail_in = 0;</td></tr>
<tr class="codeline" data-linenumber="2011"><td class="num" id="LN2011">2011</td><td class="line">    <span class='comment'>/* see http://www.zlib.net/manual.html */</span></td></tr>
<tr class="codeline" data-linenumber="2012"><td class="num" id="LN2012">2012</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>inflateInit2(&amp;strm, 15 <span class='comment'>/* maxWindowLogSize */</span> + 16 <span class='comment'>/* gzip only */</span>)<span class='macro_popup'>inflateInit2_((&amp;strm), (15 + 16), "1.2.11", (int)sizeof(z_stream<br>))</span></span> != <span class='macro'>Z_OK<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2013"><td class="num" id="LN2013">2013</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>FIO_ERROR_FRAME_DECODING<span class='macro_popup'>((unsigned long long)(-2))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2014"><td class="num" id="LN2014">2014</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2015"><td class="num" id="LN2015">2015</td><td class="line">    strm.next_out = (Bytef*)ress-&gt;dstBuffer;</td></tr>
<tr class="codeline" data-linenumber="2016"><td class="num" id="LN2016">2016</td><td class="line">    strm.avail_out = (uInt)ress-&gt;dstBufferSize;</td></tr>
<tr class="codeline" data-linenumber="2017"><td class="num" id="LN2017">2017</td><td class="line">    strm.avail_in = (uInt)ress-&gt;srcBufferLoaded;</td></tr>
<tr class="codeline" data-linenumber="2018"><td class="num" id="LN2018">2018</td><td class="line">    strm.next_in = (z_const <span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)ress-&gt;srcBuffer;</td></tr>
<tr class="codeline" data-linenumber="2019"><td class="num" id="LN2019">2019</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2020"><td class="num" id="LN2020">2020</td><td class="line">    <span class='keyword'>for</span> ( ; ; ) {</td></tr>
<tr class="codeline" data-linenumber="2021"><td class="num" id="LN2021">2021</td><td class="line">        <span class='keyword'>int</span> ret;</td></tr>
<tr class="codeline" data-linenumber="2022"><td class="num" id="LN2022">2022</td><td class="line">        <span class='keyword'>if</span> (strm.avail_in == 0) {</td></tr>
<tr class="codeline" data-linenumber="2023"><td class="num" id="LN2023">2023</td><td class="line">            ress-&gt;srcBufferLoaded = fread(ress-&gt;srcBuffer, 1, ress-&gt;srcBufferSize, srcFile);</td></tr>
<tr class="codeline" data-linenumber="2024"><td class="num" id="LN2024">2024</td><td class="line">            <span class='keyword'>if</span> (ress-&gt;srcBufferLoaded == 0) flush = <span class='macro'>Z_FINISH<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2025"><td class="num" id="LN2025">2025</td><td class="line">            strm.next_in = (z_const <span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)ress-&gt;srcBuffer;</td></tr>
<tr class="codeline" data-linenumber="2026"><td class="num" id="LN2026">2026</td><td class="line">            strm.avail_in = (uInt)ress-&gt;srcBufferLoaded;</td></tr>
<tr class="codeline" data-linenumber="2027"><td class="num" id="LN2027">2027</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2028"><td class="num" id="LN2028">2028</td><td class="line">        ret = inflate(&amp;strm, flush);</td></tr>
<tr class="codeline" data-linenumber="2029"><td class="num" id="LN2029">2029</td><td class="line">        <span class='keyword'>if</span> (ret == <span class='macro'>Z_BUF_ERROR<span class='macro_popup'>(-5)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2030"><td class="num" id="LN2030">2030</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s: premature gz end \n"</span>, srcFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: premature gz end \n"<br>, srcFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2031"><td class="num" id="LN2031">2031</td><td class="line">            decodingError = 1; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2032"><td class="num" id="LN2032">2032</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2033"><td class="num" id="LN2033">2033</td><td class="line">        <span class='keyword'>if</span> (ret != <span class='macro'>Z_OK<span class='macro_popup'>0</span></span> &amp;&amp; ret != <span class='macro'>Z_STREAM_END<span class='macro_popup'>1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2034"><td class="num" id="LN2034">2034</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s: inflate error %d \n"</span>, srcFileName, ret)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: inflate error %d \n"<br>, srcFileName, ret); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2035"><td class="num" id="LN2035">2035</td><td class="line">            decodingError = 1; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2036"><td class="num" id="LN2036">2036</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2037"><td class="num" id="LN2037">2037</td><td class="line">        {   size_t <span class='keyword'>const</span> decompBytes = ress-&gt;dstBufferSize - strm.avail_out;</td></tr>
<tr class="codeline" data-linenumber="2038"><td class="num" id="LN2038">2038</td><td class="line">            <span class='keyword'>if</span> (decompBytes) {</td></tr>
<tr class="codeline" data-linenumber="2039"><td class="num" id="LN2039">2039</td><td class="line">                storedSkips = FIO_fwriteSparse(ress-&gt;dstFile, ress-&gt;dstBuffer, decompBytes, prefs, storedSkips);</td></tr>
<tr class="codeline" data-linenumber="2040"><td class="num" id="LN2040">2040</td><td class="line">                outFileSize += decompBytes;</td></tr>
<tr class="codeline" data-linenumber="2041"><td class="num" id="LN2041">2041</td><td class="line">                strm.next_out = (Bytef*)ress-&gt;dstBuffer;</td></tr>
<tr class="codeline" data-linenumber="2042"><td class="num" id="LN2042">2042</td><td class="line">                strm.avail_out = (uInt)ress-&gt;dstBufferSize;</td></tr>
<tr class="codeline" data-linenumber="2043"><td class="num" id="LN2043">2043</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2044"><td class="num" id="LN2044">2044</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2045"><td class="num" id="LN2045">2045</td><td class="line">        <span class='keyword'>if</span> (ret == <span class='macro'>Z_STREAM_END<span class='macro_popup'>1</span></span>) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2046"><td class="num" id="LN2046">2046</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2047"><td class="num" id="LN2047">2047</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2048"><td class="num" id="LN2048">2048</td><td class="line">    <span class='keyword'>if</span> (strm.avail_in &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="2049"><td class="num" id="LN2049">2049</td><td class="line">        memmove(ress-&gt;srcBuffer, strm.next_in, strm.avail_in);</td></tr>
<tr class="codeline" data-linenumber="2050"><td class="num" id="LN2050">2050</td><td class="line">    ress-&gt;srcBufferLoaded = strm.avail_in;</td></tr>
<tr class="codeline" data-linenumber="2051"><td class="num" id="LN2051">2051</td><td class="line">    <span class='keyword'>if</span> ( (inflateEnd(&amp;strm) != <span class='macro'>Z_OK<span class='macro_popup'>0</span></span>)  <span class='comment'>/* release resources ; error detected */</span></td></tr>
<tr class="codeline" data-linenumber="2052"><td class="num" id="LN2052">2052</td><td class="line">      &amp;&amp; (decodingError==0) ) {</td></tr>
<tr class="codeline" data-linenumber="2053"><td class="num" id="LN2053">2053</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s: inflateEnd error \n"</span>, srcFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: inflateEnd error \n"<br>, srcFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2054"><td class="num" id="LN2054">2054</td><td class="line">        decodingError = 1;</td></tr>
<tr class="codeline" data-linenumber="2055"><td class="num" id="LN2055">2055</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2056"><td class="num" id="LN2056">2056</td><td class="line">    FIO_fwriteSparseEnd(prefs, ress-&gt;dstFile, storedSkips);</td></tr>
<tr class="codeline" data-linenumber="2057"><td class="num" id="LN2057">2057</td><td class="line">    <span class='keyword'>return</span> decodingError ? <span class='macro'>FIO_ERROR_FRAME_DECODING<span class='macro_popup'>((unsigned long long)(-2))</span></span> : outFileSize;</td></tr>
<tr class="codeline" data-linenumber="2058"><td class="num" id="LN2058">2058</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2059"><td class="num" id="LN2059">2059</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2060"><td class="num" id="LN2060">2060</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2061"><td class="num" id="LN2061">2061</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2062"><td class="num" id="LN2062">2062</td><td class="line"><span class='directive'>#ifdef <span class='macro'>ZSTD_LZMADECOMPRESS<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="2063"><td class="num" id="LN2063">2063</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span></td></tr>
<tr class="codeline" data-linenumber="2064"><td class="num" id="LN2064">2064</td><td class="line">FIO_decompressLzmaFrame(dRess_t* ress, FILE* srcFile,</td></tr>
<tr class="codeline" data-linenumber="2065"><td class="num" id="LN2065">2065</td><td class="line">                        <span class='keyword'>const</span> FIO_prefs_t* <span class='keyword'>const</span> prefs,</td></tr>
<tr class="codeline" data-linenumber="2066"><td class="num" id="LN2066">2066</td><td class="line">                        <span class='keyword'>const</span> <span class='keyword'>char</span>* srcFileName, <span class='keyword'>int</span> plain_lzma)</td></tr>
<tr class="codeline" data-linenumber="2067"><td class="num" id="LN2067">2067</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2068"><td class="num" id="LN2068">2068</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> outFileSize = 0;</td></tr>
<tr class="codeline" data-linenumber="2069"><td class="num" id="LN2069">2069</td><td class="line">    lzma_stream strm = <span class='macro'>LZMA_STREAM_INIT<span class='macro_popup'>{ ((void*)0), 0, 0, ((void*)0), 0, 0, ((void*)0), ((void*)0),<br> ((void*)0), ((void*)0), ((void*)0), ((void*)0), 0, 0, 0, 0, LZMA_RESERVED_ENUM<br>, LZMA_RESERVED_ENUM }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2070"><td class="num" id="LN2070">2070</td><td class="line">    lzma_action action = LZMA_RUN;</td></tr>
<tr class="codeline" data-linenumber="2071"><td class="num" id="LN2071">2071</td><td class="line">    lzma_ret initRet;</td></tr>
<tr class="codeline" data-linenumber="2072"><td class="num" id="LN2072">2072</td><td class="line">    <span class='keyword'>int</span> decodingError = 0;</td></tr>
<tr class="codeline" data-linenumber="2073"><td class="num" id="LN2073">2073</td><td class="line">    <span class='keyword'>unsigned</span> storedSkips = 0;</td></tr>
<tr class="codeline" data-linenumber="2074"><td class="num" id="LN2074">2074</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2075"><td class="num" id="LN2075">2075</td><td class="line">    strm.next_in = 0;</td></tr>
<tr class="codeline" data-linenumber="2076"><td class="num" id="LN2076">2076</td><td class="line">    strm.avail_in = 0;</td></tr>
<tr class="codeline" data-linenumber="2077"><td class="num" id="LN2077">2077</td><td class="line">    <span class='keyword'>if</span> (plain_lzma) {</td></tr>
<tr class="codeline" data-linenumber="2078"><td class="num" id="LN2078">2078</td><td class="line">        initRet = lzma_alone_decoder(&amp;strm, <span class='macro'>UINT64_MAX<span class='macro_popup'>(18446744073709551615UL)</span></span>); <span class='comment'>/* LZMA */</span></td></tr>
<tr class="codeline" data-linenumber="2079"><td class="num" id="LN2079">2079</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2080"><td class="num" id="LN2080">2080</td><td class="line">        initRet = lzma_stream_decoder(&amp;strm, <span class='macro'>UINT64_MAX<span class='macro_popup'>(18446744073709551615UL)</span></span>, 0); <span class='comment'>/* XZ */</span></td></tr>
<tr class="codeline" data-linenumber="2081"><td class="num" id="LN2081">2081</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2082"><td class="num" id="LN2082">2082</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2083"><td class="num" id="LN2083">2083</td><td class="line">    <span class='keyword'>if</span> (initRet != LZMA_OK) {</td></tr>
<tr class="codeline" data-linenumber="2084"><td class="num" id="LN2084">2084</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s: %s error %d \n"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: %s error %d \n"<br>, plain_lzma ? "lzma_alone_decoder" : "lzma_stream_decoder", srcFileName<br>, initRet); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="2085"><td class="num" id="LN2085">2085</td><td class="line">                        <span class='macro'>plain_lzma ? <span class='string_literal'>"lzma_alone_decoder"</span> : <span class='string_literal'>"lzma_stream_decoder"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: %s error %d \n"<br>, plain_lzma ? "lzma_alone_decoder" : "lzma_stream_decoder", srcFileName<br>, initRet); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="2086"><td class="num" id="LN2086">2086</td><td class="line">                        <span class='macro'>srcFileName, initRet)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: %s error %d \n"<br>, plain_lzma ? "lzma_alone_decoder" : "lzma_stream_decoder", srcFileName<br>, initRet); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2087"><td class="num" id="LN2087">2087</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>FIO_ERROR_FRAME_DECODING<span class='macro_popup'>((unsigned long long)(-2))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2088"><td class="num" id="LN2088">2088</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2089"><td class="num" id="LN2089">2089</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2090"><td class="num" id="LN2090">2090</td><td class="line">    strm.next_out = (BYTE*)ress-&gt;dstBuffer;</td></tr>
<tr class="codeline" data-linenumber="2091"><td class="num" id="LN2091">2091</td><td class="line">    strm.avail_out = ress-&gt;dstBufferSize;</td></tr>
<tr class="codeline" data-linenumber="2092"><td class="num" id="LN2092">2092</td><td class="line">    strm.next_in = (BYTE <span class='keyword'>const</span>*)ress-&gt;srcBuffer;</td></tr>
<tr class="codeline" data-linenumber="2093"><td class="num" id="LN2093">2093</td><td class="line">    strm.avail_in = ress-&gt;srcBufferLoaded;</td></tr>
<tr class="codeline" data-linenumber="2094"><td class="num" id="LN2094">2094</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2095"><td class="num" id="LN2095">2095</td><td class="line">    <span class='keyword'>for</span> ( ; ; ) {</td></tr>
<tr class="codeline" data-linenumber="2096"><td class="num" id="LN2096">2096</td><td class="line">        lzma_ret ret;</td></tr>
<tr class="codeline" data-linenumber="2097"><td class="num" id="LN2097">2097</td><td class="line">        <span class='keyword'>if</span> (strm.avail_in == 0) {</td></tr>
<tr class="codeline" data-linenumber="2098"><td class="num" id="LN2098">2098</td><td class="line">            ress-&gt;srcBufferLoaded = fread(ress-&gt;srcBuffer, 1, ress-&gt;srcBufferSize, srcFile);</td></tr>
<tr class="codeline" data-linenumber="2099"><td class="num" id="LN2099">2099</td><td class="line">            <span class='keyword'>if</span> (ress-&gt;srcBufferLoaded == 0) action = LZMA_FINISH;</td></tr>
<tr class="codeline" data-linenumber="2100"><td class="num" id="LN2100">2100</td><td class="line">            strm.next_in = (BYTE <span class='keyword'>const</span>*)ress-&gt;srcBuffer;</td></tr>
<tr class="codeline" data-linenumber="2101"><td class="num" id="LN2101">2101</td><td class="line">            strm.avail_in = ress-&gt;srcBufferLoaded;</td></tr>
<tr class="codeline" data-linenumber="2102"><td class="num" id="LN2102">2102</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2103"><td class="num" id="LN2103">2103</td><td class="line">        ret = lzma_code(&amp;strm, action);</td></tr>
<tr class="codeline" data-linenumber="2104"><td class="num" id="LN2104">2104</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2105"><td class="num" id="LN2105">2105</td><td class="line">        <span class='keyword'>if</span> (ret == LZMA_BUF_ERROR) {</td></tr>
<tr class="codeline" data-linenumber="2106"><td class="num" id="LN2106">2106</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s: premature lzma end \n"</span>, srcFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: premature lzma end \n"<br>, srcFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2107"><td class="num" id="LN2107">2107</td><td class="line">            decodingError = 1; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2108"><td class="num" id="LN2108">2108</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2109"><td class="num" id="LN2109">2109</td><td class="line">        <span class='keyword'>if</span> (ret != LZMA_OK &amp;&amp; ret != LZMA_STREAM_END) {</td></tr>
<tr class="codeline" data-linenumber="2110"><td class="num" id="LN2110">2110</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s: lzma_code decoding error %d \n"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: lzma_code decoding error %d \n"<br>, srcFileName, ret); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="2111"><td class="num" id="LN2111">2111</td><td class="line">                            <span class='macro'>srcFileName, ret)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: lzma_code decoding error %d \n"<br>, srcFileName, ret); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2112"><td class="num" id="LN2112">2112</td><td class="line">            decodingError = 1; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2113"><td class="num" id="LN2113">2113</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2114"><td class="num" id="LN2114">2114</td><td class="line">        {   size_t <span class='keyword'>const</span> decompBytes = ress-&gt;dstBufferSize - strm.avail_out;</td></tr>
<tr class="codeline" data-linenumber="2115"><td class="num" id="LN2115">2115</td><td class="line">            <span class='keyword'>if</span> (decompBytes) {</td></tr>
<tr class="codeline" data-linenumber="2116"><td class="num" id="LN2116">2116</td><td class="line">                storedSkips = FIO_fwriteSparse(ress-&gt;dstFile, ress-&gt;dstBuffer, decompBytes, prefs, storedSkips);</td></tr>
<tr class="codeline" data-linenumber="2117"><td class="num" id="LN2117">2117</td><td class="line">                outFileSize += decompBytes;</td></tr>
<tr class="codeline" data-linenumber="2118"><td class="num" id="LN2118">2118</td><td class="line">                strm.next_out = (BYTE*)ress-&gt;dstBuffer;</td></tr>
<tr class="codeline" data-linenumber="2119"><td class="num" id="LN2119">2119</td><td class="line">                strm.avail_out = ress-&gt;dstBufferSize;</td></tr>
<tr class="codeline" data-linenumber="2120"><td class="num" id="LN2120">2120</td><td class="line">        }   }</td></tr>
<tr class="codeline" data-linenumber="2121"><td class="num" id="LN2121">2121</td><td class="line">        <span class='keyword'>if</span> (ret == LZMA_STREAM_END) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2122"><td class="num" id="LN2122">2122</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2123"><td class="num" id="LN2123">2123</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2124"><td class="num" id="LN2124">2124</td><td class="line">    <span class='keyword'>if</span> (strm.avail_in &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="2125"><td class="num" id="LN2125">2125</td><td class="line">        memmove(ress-&gt;srcBuffer, strm.next_in, strm.avail_in);</td></tr>
<tr class="codeline" data-linenumber="2126"><td class="num" id="LN2126">2126</td><td class="line">    ress-&gt;srcBufferLoaded = strm.avail_in;</td></tr>
<tr class="codeline" data-linenumber="2127"><td class="num" id="LN2127">2127</td><td class="line">    lzma_end(&amp;strm);</td></tr>
<tr class="codeline" data-linenumber="2128"><td class="num" id="LN2128">2128</td><td class="line">    FIO_fwriteSparseEnd(prefs, ress-&gt;dstFile, storedSkips);</td></tr>
<tr class="codeline" data-linenumber="2129"><td class="num" id="LN2129">2129</td><td class="line">    <span class='keyword'>return</span> decodingError ? <span class='macro'>FIO_ERROR_FRAME_DECODING<span class='macro_popup'>((unsigned long long)(-2))</span></span> : outFileSize;</td></tr>
<tr class="codeline" data-linenumber="2130"><td class="num" id="LN2130">2130</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2131"><td class="num" id="LN2131">2131</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2132"><td class="num" id="LN2132">2132</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2133"><td class="num" id="LN2133">2133</td><td class="line"><span class='directive'>#ifdef <span class='macro'>ZSTD_LZ4DECOMPRESS<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="2134"><td class="num" id="LN2134">2134</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span></td></tr>
<tr class="codeline" data-linenumber="2135"><td class="num" id="LN2135">2135</td><td class="line">FIO_decompressLz4Frame(dRess_t* ress, FILE* srcFile,</td></tr>
<tr class="codeline" data-linenumber="2136"><td class="num" id="LN2136">2136</td><td class="line">                       <span class='keyword'>const</span> FIO_prefs_t* <span class='keyword'>const</span> prefs,</td></tr>
<tr class="codeline" data-linenumber="2137"><td class="num" id="LN2137">2137</td><td class="line">                       <span class='keyword'>const</span> <span class='keyword'>char</span>* srcFileName)</td></tr>
<tr class="codeline" data-linenumber="2138"><td class="num" id="LN2138">2138</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2139"><td class="num" id="LN2139">2139</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> filesize = 0;</td></tr>
<tr class="codeline" data-linenumber="2140"><td class="num" id="LN2140">2140</td><td class="line">    LZ4F_errorCode_t nextToLoad;</td></tr>
<tr class="codeline" data-linenumber="2141"><td class="num" id="LN2141">2141</td><td class="line">    LZ4F_decompressionContext_t dCtx;</td></tr>
<tr class="codeline" data-linenumber="2142"><td class="num" id="LN2142">2142</td><td class="line">    LZ4F_errorCode_t <span class='keyword'>const</span> errorCode = LZ4F_createDecompressionContext(&amp;dCtx, <span class='macro'>LZ4F_VERSION<span class='macro_popup'>100</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2143"><td class="num" id="LN2143">2143</td><td class="line">    <span class='keyword'>int</span> decodingError = 0;</td></tr>
<tr class="codeline" data-linenumber="2144"><td class="num" id="LN2144">2144</td><td class="line">    <span class='keyword'>unsigned</span> storedSkips = 0;</td></tr>
<tr class="codeline" data-linenumber="2145"><td class="num" id="LN2145">2145</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2146"><td class="num" id="LN2146">2146</td><td class="line">    <span class='keyword'>if</span> (LZ4F_isError(errorCode)) {</td></tr>
<tr class="codeline" data-linenumber="2147"><td class="num" id="LN2147">2147</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: failed to create lz4 decompression context \n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: failed to create lz4 decompression context \n"<br>); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2148"><td class="num" id="LN2148">2148</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>FIO_ERROR_FRAME_DECODING<span class='macro_popup'>((unsigned long long)(-2))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2149"><td class="num" id="LN2149">2149</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2150"><td class="num" id="LN2150">2150</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2151"><td class="num" id="LN2151">2151</td><td class="line">    <span class='comment'>/* Init feed with magic number (already consumed from FILE* sFile) */</span></td></tr>
<tr class="codeline" data-linenumber="2152"><td class="num" id="LN2152">2152</td><td class="line">    {   size_t inSize = 4;</td></tr>
<tr class="codeline" data-linenumber="2153"><td class="num" id="LN2153">2153</td><td class="line">        size_t outSize= 0;</td></tr>
<tr class="codeline" data-linenumber="2154"><td class="num" id="LN2154">2154</td><td class="line">        MEM_writeLE32(ress-&gt;srcBuffer, <span class='macro'>LZ4_MAGICNUMBER<span class='macro_popup'>0x184D2204</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2155"><td class="num" id="LN2155">2155</td><td class="line">        nextToLoad = LZ4F_decompress(dCtx, ress-&gt;dstBuffer, &amp;outSize, ress-&gt;srcBuffer, &amp;inSize, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2156"><td class="num" id="LN2156">2156</td><td class="line">        <span class='keyword'>if</span> (LZ4F_isError(nextToLoad)) {</td></tr>
<tr class="codeline" data-linenumber="2157"><td class="num" id="LN2157">2157</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s: lz4 header error : %s \n"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: lz4 header error : %s \n"<br>, srcFileName, LZ4F_getErrorName(nextToLoad)); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="2158"><td class="num" id="LN2158">2158</td><td class="line">                            <span class='macro'>srcFileName, LZ4F_getErrorName(nextToLoad))<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: lz4 header error : %s \n"<br>, srcFileName, LZ4F_getErrorName(nextToLoad)); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2159"><td class="num" id="LN2159">2159</td><td class="line">            LZ4F_freeDecompressionContext(dCtx);</td></tr>
<tr class="codeline" data-linenumber="2160"><td class="num" id="LN2160">2160</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>FIO_ERROR_FRAME_DECODING<span class='macro_popup'>((unsigned long long)(-2))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2161"><td class="num" id="LN2161">2161</td><td class="line">    }   }</td></tr>
<tr class="codeline" data-linenumber="2162"><td class="num" id="LN2162">2162</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2163"><td class="num" id="LN2163">2163</td><td class="line">    <span class='comment'>/* Main Loop */</span></td></tr>
<tr class="codeline" data-linenumber="2164"><td class="num" id="LN2164">2164</td><td class="line">    <span class='keyword'>for</span> (;nextToLoad;) {</td></tr>
<tr class="codeline" data-linenumber="2165"><td class="num" id="LN2165">2165</td><td class="line">        size_t readSize;</td></tr>
<tr class="codeline" data-linenumber="2166"><td class="num" id="LN2166">2166</td><td class="line">        size_t pos = 0;</td></tr>
<tr class="codeline" data-linenumber="2167"><td class="num" id="LN2167">2167</td><td class="line">        size_t decodedBytes = ress-&gt;dstBufferSize;</td></tr>
<tr class="codeline" data-linenumber="2168"><td class="num" id="LN2168">2168</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2169"><td class="num" id="LN2169">2169</td><td class="line">        <span class='comment'>/* Read input */</span></td></tr>
<tr class="codeline" data-linenumber="2170"><td class="num" id="LN2170">2170</td><td class="line">        <span class='keyword'>if</span> (nextToLoad &gt; ress-&gt;srcBufferSize) nextToLoad = ress-&gt;srcBufferSize;</td></tr>
<tr class="codeline" data-linenumber="2171"><td class="num" id="LN2171">2171</td><td class="line">        readSize = fread(ress-&gt;srcBuffer, 1, nextToLoad, srcFile);</td></tr>
<tr class="codeline" data-linenumber="2172"><td class="num" id="LN2172">2172</td><td class="line">        <span class='keyword'>if</span> (!readSize) <span class='keyword'>break</span>;   <span class='comment'>/* reached end of file or stream */</span></td></tr>
<tr class="codeline" data-linenumber="2173"><td class="num" id="LN2173">2173</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2174"><td class="num" id="LN2174">2174</td><td class="line">        <span class='keyword'>while</span> ((pos &lt; readSize) || (decodedBytes == ress-&gt;dstBufferSize)) {  <span class='comment'>/* still to read, or still to flush */</span></td></tr>
<tr class="codeline" data-linenumber="2175"><td class="num" id="LN2175">2175</td><td class="line">            <span class='comment'>/* Decode Input (at least partially) */</span></td></tr>
<tr class="codeline" data-linenumber="2176"><td class="num" id="LN2176">2176</td><td class="line">            size_t remaining = readSize - pos;</td></tr>
<tr class="codeline" data-linenumber="2177"><td class="num" id="LN2177">2177</td><td class="line">            decodedBytes = ress-&gt;dstBufferSize;</td></tr>
<tr class="codeline" data-linenumber="2178"><td class="num" id="LN2178">2178</td><td class="line">            nextToLoad = LZ4F_decompress(dCtx, ress-&gt;dstBuffer, &amp;decodedBytes, (<span class='keyword'>char</span>*)(ress-&gt;srcBuffer)+pos, &amp;remaining, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2179"><td class="num" id="LN2179">2179</td><td class="line">            <span class='keyword'>if</span> (LZ4F_isError(nextToLoad)) {</td></tr>
<tr class="codeline" data-linenumber="2180"><td class="num" id="LN2180">2180</td><td class="line">                <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s: lz4 decompression error : %s \n"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: lz4 decompression error : %s \n"<br>, srcFileName, LZ4F_getErrorName(nextToLoad)); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="2181"><td class="num" id="LN2181">2181</td><td class="line">                                <span class='macro'>srcFileName, LZ4F_getErrorName(nextToLoad))<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: lz4 decompression error : %s \n"<br>, srcFileName, LZ4F_getErrorName(nextToLoad)); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2182"><td class="num" id="LN2182">2182</td><td class="line">                decodingError = 1; nextToLoad = 0; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2183"><td class="num" id="LN2183">2183</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2184"><td class="num" id="LN2184">2184</td><td class="line">            pos += remaining;</td></tr>
<tr class="codeline" data-linenumber="2185"><td class="num" id="LN2185">2185</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2186"><td class="num" id="LN2186">2186</td><td class="line">            <span class='comment'>/* Write Block */</span></td></tr>
<tr class="codeline" data-linenumber="2187"><td class="num" id="LN2187">2187</td><td class="line">            <span class='keyword'>if</span> (decodedBytes) {</td></tr>
<tr class="codeline" data-linenumber="2188"><td class="num" id="LN2188">2188</td><td class="line">                storedSkips = FIO_fwriteSparse(ress-&gt;dstFile, ress-&gt;dstBuffer, decodedBytes, prefs, storedSkips);</td></tr>
<tr class="codeline" data-linenumber="2189"><td class="num" id="LN2189">2189</td><td class="line">                filesize += decodedBytes;</td></tr>
<tr class="codeline" data-linenumber="2190"><td class="num" id="LN2190">2190</td><td class="line">                <span class='macro'>DISPLAYUPDATE(2, <span class='string_literal'>"\rDecompressed : %u MB  "</span>, (<span class='keyword'>unsigned</span>)(filesize&gt;&gt;20))<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2 &amp;&amp; !g_display_prefs<br>.noProgress) { if ((!g_display_prefs.noProgress &amp;&amp; UTIL_clockSpanMicro<br>(g_displayClock) &gt; g_refreshRate) || (g_display_prefs.displayLevel<br>&gt;=4)) { { g_displayClock = UTIL_getTime(); }; fprintf(stderr<br>, "\rDecompressed : %u MB  ", (unsigned)(filesize&gt;&gt;20))<br>; if (g_display_prefs.displayLevel&gt;=4) fflush(stderr); } }<br> }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2191"><td class="num" id="LN2191">2191</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2192"><td class="num" id="LN2192">2192</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2193"><td class="num" id="LN2193">2193</td><td class="line">            <span class='keyword'>if</span> (!nextToLoad) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2194"><td class="num" id="LN2194">2194</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2195"><td class="num" id="LN2195">2195</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2196"><td class="num" id="LN2196">2196</td><td class="line">    <span class='comment'>/* can be out because readSize == 0, which could be an fread() error */</span></td></tr>
<tr class="codeline" data-linenumber="2197"><td class="num" id="LN2197">2197</td><td class="line">    <span class='keyword'>if</span> (ferror(srcFile)) {</td></tr>
<tr class="codeline" data-linenumber="2198"><td class="num" id="LN2198">2198</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s: read error \n"</span>, srcFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: read error \n"<br>, srcFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2199"><td class="num" id="LN2199">2199</td><td class="line">        decodingError=1;</td></tr>
<tr class="codeline" data-linenumber="2200"><td class="num" id="LN2200">2200</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2201"><td class="num" id="LN2201">2201</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2202"><td class="num" id="LN2202">2202</td><td class="line">    <span class='keyword'>if</span> (nextToLoad!=0) {</td></tr>
<tr class="codeline" data-linenumber="2203"><td class="num" id="LN2203">2203</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s: unfinished lz4 stream \n"</span>, srcFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: unfinished lz4 stream \n"<br>, srcFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2204"><td class="num" id="LN2204">2204</td><td class="line">        decodingError=1;</td></tr>
<tr class="codeline" data-linenumber="2205"><td class="num" id="LN2205">2205</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2206"><td class="num" id="LN2206">2206</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2207"><td class="num" id="LN2207">2207</td><td class="line">    LZ4F_freeDecompressionContext(dCtx);</td></tr>
<tr class="codeline" data-linenumber="2208"><td class="num" id="LN2208">2208</td><td class="line">    ress-&gt;srcBufferLoaded = 0; <span class='comment'>/* LZ4F will reach exact frame boundary */</span></td></tr>
<tr class="codeline" data-linenumber="2209"><td class="num" id="LN2209">2209</td><td class="line">    FIO_fwriteSparseEnd(prefs, ress-&gt;dstFile, storedSkips);</td></tr>
<tr class="codeline" data-linenumber="2210"><td class="num" id="LN2210">2210</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2211"><td class="num" id="LN2211">2211</td><td class="line">    <span class='keyword'>return</span> decodingError ? <span class='macro'>FIO_ERROR_FRAME_DECODING<span class='macro_popup'>((unsigned long long)(-2))</span></span> : filesize;</td></tr>
<tr class="codeline" data-linenumber="2212"><td class="num" id="LN2212">2212</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2213"><td class="num" id="LN2213">2213</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2214"><td class="num" id="LN2214">2214</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2215"><td class="num" id="LN2215">2215</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2216"><td class="num" id="LN2216">2216</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2217"><td class="num" id="LN2217">2217</td><td class="line"><span class='comment'>/** FIO_decompressFrames() :</span></td></tr>
<tr class="codeline" data-linenumber="2218"><td class="num" id="LN2218">2218</td><td class="line"> <span class='comment'>*  Find and decode frames inside srcFile</span></td></tr>
<tr class="codeline" data-linenumber="2219"><td class="num" id="LN2219">2219</td><td class="line"> <span class='comment'>*  srcFile presumed opened and valid</span></td></tr>
<tr class="codeline" data-linenumber="2220"><td class="num" id="LN2220">2220</td><td class="line"> <span class='comment'>* @return : 0 : OK</span></td></tr>
<tr class="codeline" data-linenumber="2221"><td class="num" id="LN2221">2221</td><td class="line"> <span class='comment'>*           1 : error</span></td></tr>
<tr class="codeline" data-linenumber="2222"><td class="num" id="LN2222">2222</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2223"><td class="num" id="LN2223">2223</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> FIO_decompressFrames(dRess_t ress, FILE* srcFile,</td></tr>
<tr class="codeline" data-linenumber="2224"><td class="num" id="LN2224">2224</td><td class="line">                          <span class='keyword'>const</span> FIO_prefs_t* <span class='keyword'>const</span> prefs,</td></tr>
<tr class="codeline" data-linenumber="2225"><td class="num" id="LN2225">2225</td><td class="line">                          <span class='keyword'>const</span> <span class='keyword'>char</span>* dstFileName, <span class='keyword'>const</span> <span class='keyword'>char</span>* srcFileName)</td></tr>
<tr class="codeline" data-linenumber="2226"><td class="num" id="LN2226">2226</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2227"><td class="num" id="LN2227">2227</td><td class="line">    <span class='keyword'>unsigned</span> readSomething = 0;</td></tr>
<tr class="codeline" data-linenumber="2228"><td class="num" id="LN2228">2228</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> filesize = 0;</td></tr>
<tr class="codeline" data-linenumber="2229"><td class="num" id="LN2229">2229</td><td class="line">    <span class='macro'>assert(srcFile != NULL)<span class='macro_popup'>((void) sizeof ((srcFile != ((void*)0)) ? 1 : 0), __extension__<br> ({ if (srcFile != ((void*)0)) ; else __assert_fail ("srcFile != NULL"<br>, "fileio.c", 2229, __extension__ __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2230"><td class="num" id="LN2230">2230</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2231"><td class="num" id="LN2231">2231</td><td class="line">    <span class='comment'>/* for each frame */</span></td></tr>
<tr class="codeline" data-linenumber="2232"><td class="num" id="LN2232">2232</td><td class="line">    <span class='keyword'>for</span> ( ; ; ) {</td></tr>
<tr class="codeline" data-linenumber="2233"><td class="num" id="LN2233">2233</td><td class="line">        <span class='comment'>/* check magic number -&gt; version */</span></td></tr>
<tr class="codeline" data-linenumber="2234"><td class="num" id="LN2234">2234</td><td class="line">        size_t <span class='keyword'>const</span> toRead = 4;</td></tr>
<tr class="codeline" data-linenumber="2235"><td class="num" id="LN2235">2235</td><td class="line">        <span class='keyword'>const</span> BYTE* <span class='keyword'>const</span> buf = (<span class='keyword'>const</span> BYTE*)ress.srcBuffer;</td></tr>
<tr class="codeline" data-linenumber="2236"><td class="num" id="LN2236">2236</td><td class="line">        <span class='keyword'>if</span> (ress.srcBufferLoaded &lt; toRead)  <span class='comment'>/* load up to 4 bytes for header */</span></td></tr>
<tr class="codeline" data-linenumber="2237"><td class="num" id="LN2237">2237</td><td class="line">            ress.srcBufferLoaded += fread((<span class='keyword'>char</span>*)ress.srcBuffer + ress.srcBufferLoaded,</td></tr>
<tr class="codeline" data-linenumber="2238"><td class="num" id="LN2238">2238</td><td class="line">                                          (size_t)1, toRead - ress.srcBufferLoaded, srcFile);</td></tr>
<tr class="codeline" data-linenumber="2239"><td class="num" id="LN2239">2239</td><td class="line">        <span class='keyword'>if</span> (ress.srcBufferLoaded==0) {</td></tr>
<tr class="codeline" data-linenumber="2240"><td class="num" id="LN2240">2240</td><td class="line">            <span class='keyword'>if</span> (readSomething==0) {  <span class='comment'>/* srcFile is empty (which is invalid) */</span></td></tr>
<tr class="codeline" data-linenumber="2241"><td class="num" id="LN2241">2241</td><td class="line">                <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s: unexpected end of file \n"</span>, srcFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: unexpected end of file \n"<br>, srcFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2242"><td class="num" id="LN2242">2242</td><td class="line">                <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2243"><td class="num" id="LN2243">2243</td><td class="line">            }  <span class='comment'>/* else, just reached frame boundary */</span></td></tr>
<tr class="codeline" data-linenumber="2244"><td class="num" id="LN2244">2244</td><td class="line">            <span class='keyword'>break</span>;   <span class='comment'>/* no more input */</span></td></tr>
<tr class="codeline" data-linenumber="2245"><td class="num" id="LN2245">2245</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2246"><td class="num" id="LN2246">2246</td><td class="line">        readSomething = 1;   <span class='comment'>/* there is at least 1 byte in srcFile */</span></td></tr>
<tr class="codeline" data-linenumber="2247"><td class="num" id="LN2247">2247</td><td class="line">        <span class='keyword'>if</span> (ress.srcBufferLoaded &lt; toRead) {</td></tr>
<tr class="codeline" data-linenumber="2248"><td class="num" id="LN2248">2248</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s: unknown header \n"</span>, srcFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: unknown header \n"<br>, srcFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2249"><td class="num" id="LN2249">2249</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2250"><td class="num" id="LN2250">2250</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2251"><td class="num" id="LN2251">2251</td><td class="line">        <span class='keyword'>if</span> (ZSTD_isFrame(buf, ress.srcBufferLoaded)) {</td></tr>
<tr class="codeline" data-linenumber="2252"><td class="num" id="LN2252">2252</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> <span class='keyword'>const</span> frameSize = FIO_decompressZstdFrame(&amp;ress, srcFile, prefs, srcFileName, filesize);</td></tr>
<tr class="codeline" data-linenumber="2253"><td class="num" id="LN2253">2253</td><td class="line">            <span class='keyword'>if</span> (frameSize == <span class='macro'>FIO_ERROR_FRAME_DECODING<span class='macro_popup'>((unsigned long long)(-2))</span></span>) <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2254"><td class="num" id="LN2254">2254</td><td class="line">            filesize += frameSize;</td></tr>
<tr class="codeline" data-linenumber="2255"><td class="num" id="LN2255">2255</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (buf[0] == 31 &amp;&amp; buf[1] == 139) { <span class='comment'>/* gz magic number */</span></td></tr>
<tr class="codeline" data-linenumber="2256"><td class="num" id="LN2256">2256</td><td class="line"><span class='directive'>#ifdef <span class='macro'>ZSTD_GZDECOMPRESS<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="2257"><td class="num" id="LN2257">2257</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> <span class='keyword'>const</span> frameSize = FIO_decompressGzFrame(&amp;ress, srcFile, prefs, srcFileName);</td></tr>
<tr class="codeline" data-linenumber="2258"><td class="num" id="LN2258">2258</td><td class="line">            <span class='keyword'>if</span> (frameSize == <span class='macro'>FIO_ERROR_FRAME_DECODING<span class='macro_popup'>((unsigned long long)(-2))</span></span>) <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2259"><td class="num" id="LN2259">2259</td><td class="line">            filesize += frameSize;</td></tr>
<tr class="codeline" data-linenumber="2260"><td class="num" id="LN2260">2260</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="2261"><td class="num" id="LN2261">2261</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s: gzip file cannot be uncompressed (zstd compiled without HAVE_ZLIB) -- ignored \n"</span>, srcFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: gzip file cannot be uncompressed (zstd compiled without HAVE_ZLIB) -- ignored \n"<br>, srcFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2262"><td class="num" id="LN2262">2262</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2263"><td class="num" id="LN2263">2263</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2264"><td class="num" id="LN2264">2264</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> ((buf[0] == 0xFD &amp;&amp; buf[1] == 0x37)  <span class='comment'>/* xz magic number */</span></td></tr>
<tr class="codeline" data-linenumber="2265"><td class="num" id="LN2265">2265</td><td class="line">                || (buf[0] == 0x5D &amp;&amp; buf[1] == 0x00)) { <span class='comment'>/* lzma header (no magic number) */</span></td></tr>
<tr class="codeline" data-linenumber="2266"><td class="num" id="LN2266">2266</td><td class="line"><span class='directive'>#ifdef <span class='macro'>ZSTD_LZMADECOMPRESS<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="2267"><td class="num" id="LN2267">2267</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> <span class='keyword'>const</span> frameSize = FIO_decompressLzmaFrame(&amp;ress, srcFile, prefs, srcFileName, buf[0] != 0xFD);</td></tr>
<tr class="codeline" data-linenumber="2268"><td class="num" id="LN2268">2268</td><td class="line">            <span class='keyword'>if</span> (frameSize == <span class='macro'>FIO_ERROR_FRAME_DECODING<span class='macro_popup'>((unsigned long long)(-2))</span></span>) <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2269"><td class="num" id="LN2269">2269</td><td class="line">            filesize += frameSize;</td></tr>
<tr class="codeline" data-linenumber="2270"><td class="num" id="LN2270">2270</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="2271"><td class="num" id="LN2271">2271</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s: xz/lzma file cannot be uncompressed (zstd compiled without HAVE_LZMA) -- ignored \n"</span>, srcFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: xz/lzma file cannot be uncompressed (zstd compiled without HAVE_LZMA) -- ignored \n"<br>, srcFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2272"><td class="num" id="LN2272">2272</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2273"><td class="num" id="LN2273">2273</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2274"><td class="num" id="LN2274">2274</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (MEM_readLE32(buf) == <span class='macro'>LZ4_MAGICNUMBER<span class='macro_popup'>0x184D2204</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2275"><td class="num" id="LN2275">2275</td><td class="line"><span class='directive'>#ifdef <span class='macro'>ZSTD_LZ4DECOMPRESS<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="2276"><td class="num" id="LN2276">2276</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> <span class='keyword'>const</span> frameSize = FIO_decompressLz4Frame(&amp;ress, srcFile, prefs, srcFileName);</td></tr>
<tr class="codeline" data-linenumber="2277"><td class="num" id="LN2277">2277</td><td class="line">            <span class='keyword'>if</span> (frameSize == <span class='macro'>FIO_ERROR_FRAME_DECODING<span class='macro_popup'>((unsigned long long)(-2))</span></span>) <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2278"><td class="num" id="LN2278">2278</td><td class="line">            filesize += frameSize;</td></tr>
<tr class="codeline" data-linenumber="2279"><td class="num" id="LN2279">2279</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="2280"><td class="num" id="LN2280">2280</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s: lz4 file cannot be uncompressed (zstd compiled without HAVE_LZ4) -- ignored \n"</span>, srcFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: lz4 file cannot be uncompressed (zstd compiled without HAVE_LZ4) -- ignored \n"<br>, srcFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2281"><td class="num" id="LN2281">2281</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2282"><td class="num" id="LN2282">2282</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2283"><td class="num" id="LN2283">2283</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> ((prefs-&gt;overwrite) &amp;&amp; !strcmp (dstFileName, <span class='macro'>stdoutmark<span class='macro_popup'>"/*stdout*\\"</span></span>)) {  <span class='comment'>/* pass-through mode */</span></td></tr>
<tr class="codeline" data-linenumber="2284"><td class="num" id="LN2284">2284</td><td class="line">            <span class='keyword'>return</span> FIO_passThrough(prefs,</td></tr>
<tr class="codeline" data-linenumber="2285"><td class="num" id="LN2285">2285</td><td class="line">                                   ress.dstFile, srcFile,</td></tr>
<tr class="codeline" data-linenumber="2286"><td class="num" id="LN2286">2286</td><td class="line">                                   ress.srcBuffer, ress.srcBufferSize,</td></tr>
<tr class="codeline" data-linenumber="2287"><td class="num" id="LN2287">2287</td><td class="line">                                   ress.srcBufferLoaded);</td></tr>
<tr class="codeline" data-linenumber="2288"><td class="num" id="LN2288">2288</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2289"><td class="num" id="LN2289">2289</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s: unsupported format \n"</span>, srcFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: unsupported format \n"<br>, srcFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2290"><td class="num" id="LN2290">2290</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2291"><td class="num" id="LN2291">2291</td><td class="line">    }   }  <span class='comment'>/* for each frame */</span></td></tr>
<tr class="codeline" data-linenumber="2292"><td class="num" id="LN2292">2292</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2293"><td class="num" id="LN2293">2293</td><td class="line">    <span class='comment'>/* Final Status */</span></td></tr>
<tr class="codeline" data-linenumber="2294"><td class="num" id="LN2294">2294</td><td class="line">    <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"\r%79s\r"</span>, <span class='string_literal'>""</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2) { fprintf(stderr, "\r%79s\r"<br>, ""); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2295"><td class="num" id="LN2295">2295</td><td class="line">    <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"%-20s: %llu bytes \n"</span>, srcFileName, filesize)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=2) { fprintf(stderr, "%-20s: %llu bytes \n"<br>, srcFileName, filesize); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2296"><td class="num" id="LN2296">2296</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2297"><td class="num" id="LN2297">2297</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2298"><td class="num" id="LN2298">2298</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2299"><td class="num" id="LN2299">2299</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2300"><td class="num" id="LN2300">2300</td><td class="line"><span class='comment'>/** FIO_decompressDstFile() :</span></td></tr>
<tr class="codeline" data-linenumber="2301"><td class="num" id="LN2301">2301</td><td class="line">    <span class='comment'>open `dstFileName`,</span></td></tr>
<tr class="codeline" data-linenumber="2302"><td class="num" id="LN2302">2302</td><td class="line">    <span class='comment'>or path-through if ress.dstFile is already != 0,</span></td></tr>
<tr class="codeline" data-linenumber="2303"><td class="num" id="LN2303">2303</td><td class="line">    <span class='comment'>then start decompression process (FIO_decompressFrames()).</span></td></tr>
<tr class="codeline" data-linenumber="2304"><td class="num" id="LN2304">2304</td><td class="line">    <span class='comment'>@return : 0 : OK</span></td></tr>
<tr class="codeline" data-linenumber="2305"><td class="num" id="LN2305">2305</td><td class="line">              <span class='comment'>1 : operation aborted</span></td></tr>
<tr class="codeline" data-linenumber="2306"><td class="num" id="LN2306">2306</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2307"><td class="num" id="LN2307">2307</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> FIO_decompressDstFile(FIO_prefs_t* <span class='keyword'>const</span> prefs,</td></tr>
<tr class="codeline" data-linenumber="2308"><td class="num" id="LN2308">2308</td><td class="line">                                 dRess_t ress, FILE* srcFile,</td></tr>
<tr class="codeline" data-linenumber="2309"><td class="num" id="LN2309">2309</td><td class="line">                                 <span class='keyword'>const</span> <span class='keyword'>char</span>* dstFileName, <span class='keyword'>const</span> <span class='keyword'>char</span>* srcFileName)</td></tr>
<tr class="codeline" data-linenumber="2310"><td class="num" id="LN2310">2310</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2311"><td class="num" id="LN2311">2311</td><td class="line">    <span class='keyword'>int</span> result;</td></tr>
<tr class="codeline" data-linenumber="2312"><td class="num" id="LN2312">2312</td><td class="line">    stat_t statbuf;</td></tr>
<tr class="codeline" data-linenumber="2313"><td class="num" id="LN2313">2313</td><td class="line">    <span class='keyword'>int</span> transfer_permissions = 0;</td></tr>
<tr class="codeline" data-linenumber="2314"><td class="num" id="LN2314">2314</td><td class="line">    <span class='keyword'>int</span> releaseDstFile = 0;</td></tr>
<tr class="codeline" data-linenumber="2315"><td class="num" id="LN2315">2315</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2316"><td class="num" id="LN2316">2316</td><td class="line">    <span class='keyword'>if</span> ((ress.dstFile == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) &amp;&amp; (prefs-&gt;testMode==0)) {</td></tr>
<tr class="codeline" data-linenumber="2317"><td class="num" id="LN2317">2317</td><td class="line">        releaseDstFile = 1;</td></tr>
<tr class="codeline" data-linenumber="2318"><td class="num" id="LN2318">2318</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2319"><td class="num" id="LN2319">2319</td><td class="line">        ress.dstFile = FIO_openDstFile(prefs, srcFileName, dstFileName);</td></tr>
<tr class="codeline" data-linenumber="2320"><td class="num" id="LN2320">2320</td><td class="line">        <span class='keyword'>if</span> (ress.dstFile==<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2321"><td class="num" id="LN2321">2321</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2322"><td class="num" id="LN2322">2322</td><td class="line">        <span class='comment'>/* Must only be added after FIO_openDstFile() succeeds.</span></td></tr>
<tr class="codeline" data-linenumber="2323"><td class="num" id="LN2323">2323</td><td class="line">         <span class='comment'>* Otherwise we may delete the destination file if it already exists,</span></td></tr>
<tr class="codeline" data-linenumber="2324"><td class="num" id="LN2324">2324</td><td class="line">         <span class='comment'>* and the user presses Ctrl-C when asked if they wish to overwrite.</span></td></tr>
<tr class="codeline" data-linenumber="2325"><td class="num" id="LN2325">2325</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2326"><td class="num" id="LN2326">2326</td><td class="line">        addHandler(dstFileName);</td></tr>
<tr class="codeline" data-linenumber="2327"><td class="num" id="LN2327">2327</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2328"><td class="num" id="LN2328">2328</td><td class="line">        <span class='keyword'>if</span> ( strcmp(srcFileName, <span class='macro'>stdinmark<span class='macro_popup'>"/*stdin*\\"</span></span>)   <span class='comment'>/* special case : don't transfer permissions from stdin */</span></td></tr>
<tr class="codeline" data-linenumber="2329"><td class="num" id="LN2329">2329</td><td class="line">          &amp;&amp; UTIL_getFileStat(srcFileName, &amp;statbuf) )</td></tr>
<tr class="codeline" data-linenumber="2330"><td class="num" id="LN2330">2330</td><td class="line">            transfer_permissions = 1;</td></tr>
<tr class="codeline" data-linenumber="2331"><td class="num" id="LN2331">2331</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2332"><td class="num" id="LN2332">2332</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2333"><td class="num" id="LN2333">2333</td><td class="line">    result = FIO_decompressFrames(ress, srcFile, prefs, dstFileName, srcFileName);</td></tr>
<tr class="codeline" data-linenumber="2334"><td class="num" id="LN2334">2334</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2335"><td class="num" id="LN2335">2335</td><td class="line">    <span class='keyword'>if</span> (releaseDstFile) {</td></tr>
<tr class="codeline" data-linenumber="2336"><td class="num" id="LN2336">2336</td><td class="line">        FILE* <span class='keyword'>const</span> dstFile = ress.dstFile;</td></tr>
<tr class="codeline" data-linenumber="2337"><td class="num" id="LN2337">2337</td><td class="line">        clearHandler();</td></tr>
<tr class="codeline" data-linenumber="2338"><td class="num" id="LN2338">2338</td><td class="line">        ress.dstFile = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2339"><td class="num" id="LN2339">2339</td><td class="line">        <span class='keyword'>if</span> (fclose(dstFile)) {</td></tr>
<tr class="codeline" data-linenumber="2340"><td class="num" id="LN2340">2340</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s: %s \n"</span>, dstFileName, strerror(errno))<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: %s \n"<br>, dstFileName, strerror((*__errno_location ()))); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2341"><td class="num" id="LN2341">2341</td><td class="line">            result = 1;</td></tr>
<tr class="codeline" data-linenumber="2342"><td class="num" id="LN2342">2342</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2343"><td class="num" id="LN2343">2343</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2344"><td class="num" id="LN2344">2344</td><td class="line">        <span class='keyword'>if</span> ( (result != 0)  <span class='comment'>/* operation failure */</span></td></tr>
<tr class="codeline" data-linenumber="2345"><td class="num" id="LN2345">2345</td><td class="line">          &amp;&amp; strcmp(dstFileName, <span class='macro'>nulmark<span class='macro_popup'>"/dev/null"</span></span>)     <span class='comment'>/* special case : don't remove() /dev/null (#316) */</span></td></tr>
<tr class="codeline" data-linenumber="2346"><td class="num" id="LN2346">2346</td><td class="line">          &amp;&amp; strcmp(dstFileName, <span class='macro'>stdoutmark<span class='macro_popup'>"/*stdout*\\"</span></span>)  <span class='comment'>/* special case : don't remove() stdout */</span></td></tr>
<tr class="codeline" data-linenumber="2347"><td class="num" id="LN2347">2347</td><td class="line">          ) {</td></tr>
<tr class="codeline" data-linenumber="2348"><td class="num" id="LN2348">2348</td><td class="line">            FIO_remove(dstFileName);  <span class='comment'>/* remove decompression artefact; note: don't do anything special if remove() fails */</span></td></tr>
<tr class="codeline" data-linenumber="2349"><td class="num" id="LN2349">2349</td><td class="line">        } <span class='keyword'>else</span> {  <span class='comment'>/* operation success */</span></td></tr>
<tr class="codeline" data-linenumber="2350"><td class="num" id="LN2350">2350</td><td class="line">            <span class='keyword'>if</span> ( strcmp(dstFileName, <span class='macro'>stdoutmark<span class='macro_popup'>"/*stdout*\\"</span></span>) <span class='comment'>/* special case : don't chmod stdout */</span></td></tr>
<tr class="codeline" data-linenumber="2351"><td class="num" id="LN2351">2351</td><td class="line">              &amp;&amp; strcmp(dstFileName, <span class='macro'>nulmark<span class='macro_popup'>"/dev/null"</span></span>)    <span class='comment'>/* special case : don't chmod /dev/null */</span></td></tr>
<tr class="codeline" data-linenumber="2352"><td class="num" id="LN2352">2352</td><td class="line">              &amp;&amp; transfer_permissions )          <span class='comment'>/* file permissions correctly extracted from src */</span></td></tr>
<tr class="codeline" data-linenumber="2353"><td class="num" id="LN2353">2353</td><td class="line">                UTIL_setFileStat(dstFileName, &amp;statbuf);  <span class='comment'>/* transfer file permissions from src into dst */</span></td></tr>
<tr class="codeline" data-linenumber="2354"><td class="num" id="LN2354">2354</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2355"><td class="num" id="LN2355">2355</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2356"><td class="num" id="LN2356">2356</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2357"><td class="num" id="LN2357">2357</td><td class="line">    <span class='keyword'>return</span> result;</td></tr>
<tr class="codeline" data-linenumber="2358"><td class="num" id="LN2358">2358</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2359"><td class="num" id="LN2359">2359</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2360"><td class="num" id="LN2360">2360</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2361"><td class="num" id="LN2361">2361</td><td class="line"><span class='comment'>/** FIO_decompressSrcFile() :</span></td></tr>
<tr class="codeline" data-linenumber="2362"><td class="num" id="LN2362">2362</td><td class="line">    <span class='comment'>Open `srcFileName`, transfer control to decompressDstFile()</span></td></tr>
<tr class="codeline" data-linenumber="2363"><td class="num" id="LN2363">2363</td><td class="line">    <span class='comment'>@return : 0 : OK</span></td></tr>
<tr class="codeline" data-linenumber="2364"><td class="num" id="LN2364">2364</td><td class="line">              <span class='comment'>1 : error</span></td></tr>
<tr class="codeline" data-linenumber="2365"><td class="num" id="LN2365">2365</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2366"><td class="num" id="LN2366">2366</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> FIO_decompressSrcFile(FIO_prefs_t* <span class='keyword'>const</span> prefs, dRess_t ress, <span class='keyword'>const</span> <span class='keyword'>char</span>* dstFileName, <span class='keyword'>const</span> <span class='keyword'>char</span>* srcFileName)</td></tr>
<tr class="codeline" data-linenumber="2367"><td class="num" id="LN2367">2367</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2368"><td class="num" id="LN2368">2368</td><td class="line">    FILE* srcFile;</td></tr>
<tr class="codeline" data-linenumber="2369"><td class="num" id="LN2369">2369</td><td class="line">    <span class='keyword'>int</span> result;</td></tr>
<tr class="codeline" data-linenumber="2370"><td class="num" id="LN2370">2370</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2371"><td class="num" id="LN2371">2371</td><td class="line">    <span class='keyword'>if</span> (UTIL_isDirectory(srcFileName)) {</td></tr>
<tr class="codeline" data-linenumber="2372"><td class="num" id="LN2372">2372</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s is a directory -- ignored \n"</span>, srcFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s is a directory -- ignored \n"<br>, srcFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2373"><td class="num" id="LN2373">2373</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2374"><td class="num" id="LN2374">2374</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2375"><td class="num" id="LN2375">2375</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2376"><td class="num" id="LN2376">2376</td><td class="line">    srcFile = FIO_openSrcFile(srcFileName);</td></tr>
<tr class="codeline" data-linenumber="2377"><td class="num" id="LN2377">2377</td><td class="line">    <span class='keyword'>if</span> (srcFile==<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2378"><td class="num" id="LN2378">2378</td><td class="line">    ress.srcBufferLoaded = 0;</td></tr>
<tr class="codeline" data-linenumber="2379"><td class="num" id="LN2379">2379</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2380"><td class="num" id="LN2380">2380</td><td class="line">    result = FIO_decompressDstFile(prefs, ress, srcFile, dstFileName, srcFileName);</td></tr>
<tr class="codeline" data-linenumber="2381"><td class="num" id="LN2381">2381</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2382"><td class="num" id="LN2382">2382</td><td class="line">    <span class='comment'>/* Close file */</span></td></tr>
<tr class="codeline" data-linenumber="2383"><td class="num" id="LN2383">2383</td><td class="line">    <span class='keyword'>if</span> (fclose(srcFile)) {</td></tr>
<tr class="codeline" data-linenumber="2384"><td class="num" id="LN2384">2384</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s: %s \n"</span>, srcFileName, strerror(errno))<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: %s \n"<br>, srcFileName, strerror((*__errno_location ()))); } }</span></span>;  <span class='comment'>/* error should not happen */</span></td></tr>
<tr class="codeline" data-linenumber="2385"><td class="num" id="LN2385">2385</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2386"><td class="num" id="LN2386">2386</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2387"><td class="num" id="LN2387">2387</td><td class="line">    <span class='keyword'>if</span> ( prefs-&gt;removeSrcFile  <span class='comment'>/* --rm */</span></td></tr>
<tr class="codeline" data-linenumber="2388"><td class="num" id="LN2388">2388</td><td class="line">      &amp;&amp; (result==0)      <span class='comment'>/* decompression successful */</span></td></tr>
<tr class="codeline" data-linenumber="2389"><td class="num" id="LN2389">2389</td><td class="line">      &amp;&amp; strcmp(srcFileName, <span class='macro'>stdinmark<span class='macro_popup'>"/*stdin*\\"</span></span>) ) <span class='comment'>/* not stdin */</span> {</td></tr>
<tr class="codeline" data-linenumber="2390"><td class="num" id="LN2390">2390</td><td class="line">        <span class='comment'>/* We must clear the handler, since after this point calling it would</span></td></tr>
<tr class="codeline" data-linenumber="2391"><td class="num" id="LN2391">2391</td><td class="line">         <span class='comment'>* delete both the source and destination files.</span></td></tr>
<tr class="codeline" data-linenumber="2392"><td class="num" id="LN2392">2392</td><td class="line">         <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2393"><td class="num" id="LN2393">2393</td><td class="line">        clearHandler();</td></tr>
<tr class="codeline" data-linenumber="2394"><td class="num" id="LN2394">2394</td><td class="line">        <span class='keyword'>if</span> (FIO_remove(srcFileName)) {</td></tr>
<tr class="codeline" data-linenumber="2395"><td class="num" id="LN2395">2395</td><td class="line">            <span class='comment'>/* failed to remove src file */</span></td></tr>
<tr class="codeline" data-linenumber="2396"><td class="num" id="LN2396">2396</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: %s: %s \n"</span>, srcFileName, strerror(errno))<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: %s \n"<br>, srcFileName, strerror((*__errno_location ()))); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2397"><td class="num" id="LN2397">2397</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2398"><td class="num" id="LN2398">2398</td><td class="line">    }   }</td></tr>
<tr class="codeline" data-linenumber="2399"><td class="num" id="LN2399">2399</td><td class="line">    <span class='keyword'>return</span> result;</td></tr>
<tr class="codeline" data-linenumber="2400"><td class="num" id="LN2400">2400</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2401"><td class="num" id="LN2401">2401</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2402"><td class="num" id="LN2402">2402</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2403"><td class="num" id="LN2403">2403</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2404"><td class="num" id="LN2404">2404</td><td class="line"><span class='keyword'>int</span> FIO_decompressFilename(FIO_prefs_t* <span class='keyword'>const</span> prefs,</td></tr>
<tr class="codeline" data-linenumber="2405"><td class="num" id="LN2405">2405</td><td class="line">                           <span class='keyword'>const</span> <span class='keyword'>char</span>* dstFileName, <span class='keyword'>const</span> <span class='keyword'>char</span>* srcFileName,</td></tr>
<tr class="codeline" data-linenumber="2406"><td class="num" id="LN2406">2406</td><td class="line">                           <span class='keyword'>const</span> <span class='keyword'>char</span>* dictFileName)</td></tr>
<tr class="codeline" data-linenumber="2407"><td class="num" id="LN2407">2407</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2408"><td class="num" id="LN2408">2408</td><td class="line">    dRess_t <span class='keyword'>const</span> ress = FIO_createDResources(prefs, dictFileName);</td></tr>
<tr class="codeline" data-linenumber="2409"><td class="num" id="LN2409">2409</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2410"><td class="num" id="LN2410">2410</td><td class="line">    <span class='keyword'>int</span> <span class='keyword'>const</span> decodingError = FIO_decompressSrcFile(prefs, ress, dstFileName, srcFileName);</td></tr>
<tr class="codeline" data-linenumber="2411"><td class="num" id="LN2411">2411</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2412"><td class="num" id="LN2412">2412</td><td class="line">    FIO_freeDResources(ress);</td></tr>
<tr class="codeline" data-linenumber="2413"><td class="num" id="LN2413">2413</td><td class="line">    <span class='keyword'>return</span> decodingError;</td></tr>
<tr class="codeline" data-linenumber="2414"><td class="num" id="LN2414">2414</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2415"><td class="num" id="LN2415">2415</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2416"><td class="num" id="LN2416">2416</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span> *suffixList[] = {</td></tr>
<tr class="codeline" data-linenumber="2417"><td class="num" id="LN2417">2417</td><td class="line">    <span class='macro'>ZSTD_EXTENSION<span class='macro_popup'>".zst"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2418"><td class="num" id="LN2418">2418</td><td class="line">    <span class='macro'>TZSTD_EXTENSION<span class='macro_popup'>".tzst"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2419"><td class="num" id="LN2419">2419</td><td class="line"><span class='directive'>#ifdef <span class='macro'>ZSTD_GZDECOMPRESS<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="2420"><td class="num" id="LN2420">2420</td><td class="line">    <span class='macro'>GZ_EXTENSION<span class='macro_popup'>".gz"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2421"><td class="num" id="LN2421">2421</td><td class="line">    <span class='macro'>TGZ_EXTENSION<span class='macro_popup'>".tgz"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2422"><td class="num" id="LN2422">2422</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2423"><td class="num" id="LN2423">2423</td><td class="line"><span class='directive'>#ifdef <span class='macro'>ZSTD_LZMADECOMPRESS<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="2424"><td class="num" id="LN2424">2424</td><td class="line">    <span class='macro'>LZMA_EXTENSION<span class='macro_popup'>".lzma"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2425"><td class="num" id="LN2425">2425</td><td class="line">    <span class='macro'>XZ_EXTENSION<span class='macro_popup'>".xz"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2426"><td class="num" id="LN2426">2426</td><td class="line">    <span class='macro'>TXZ_EXTENSION<span class='macro_popup'>".txz"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2427"><td class="num" id="LN2427">2427</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2428"><td class="num" id="LN2428">2428</td><td class="line"><span class='directive'>#ifdef <span class='macro'>ZSTD_LZ4DECOMPRESS<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="2429"><td class="num" id="LN2429">2429</td><td class="line">    <span class='macro'>LZ4_EXTENSION<span class='macro_popup'>".lz4"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2430"><td class="num" id="LN2430">2430</td><td class="line">    <span class='macro'>TLZ4_EXTENSION<span class='macro_popup'>".tlz4"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2431"><td class="num" id="LN2431">2431</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2432"><td class="num" id="LN2432">2432</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="2433"><td class="num" id="LN2433">2433</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="2434"><td class="num" id="LN2434">2434</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2435"><td class="num" id="LN2435">2435</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span> *suffixListStr =</td></tr>
<tr class="codeline" data-linenumber="2436"><td class="num" id="LN2436">2436</td><td class="line">    <span class='macro'>ZSTD_EXTENSION<span class='macro_popup'>".zst"</span></span> <span class='string_literal'>"/"</span> <span class='macro'>TZSTD_EXTENSION<span class='macro_popup'>".tzst"</span></span></td></tr>
<tr class="codeline" data-linenumber="2437"><td class="num" id="LN2437">2437</td><td class="line"><span class='directive'>#ifdef <span class='macro'>ZSTD_GZDECOMPRESS<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="2438"><td class="num" id="LN2438">2438</td><td class="line">    <span class='string_literal'>"/"</span> <span class='macro'>GZ_EXTENSION<span class='macro_popup'>".gz"</span></span> <span class='string_literal'>"/"</span> <span class='macro'>TGZ_EXTENSION<span class='macro_popup'>".tgz"</span></span></td></tr>
<tr class="codeline" data-linenumber="2439"><td class="num" id="LN2439">2439</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2440"><td class="num" id="LN2440">2440</td><td class="line"><span class='directive'>#ifdef <span class='macro'>ZSTD_LZMADECOMPRESS<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="2441"><td class="num" id="LN2441">2441</td><td class="line">    <span class='string_literal'>"/"</span> <span class='macro'>LZMA_EXTENSION<span class='macro_popup'>".lzma"</span></span> <span class='string_literal'>"/"</span> <span class='macro'>XZ_EXTENSION<span class='macro_popup'>".xz"</span></span> <span class='string_literal'>"/"</span> <span class='macro'>TXZ_EXTENSION<span class='macro_popup'>".txz"</span></span></td></tr>
<tr class="codeline" data-linenumber="2442"><td class="num" id="LN2442">2442</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2443"><td class="num" id="LN2443">2443</td><td class="line"><span class='directive'>#ifdef <span class='macro'>ZSTD_LZ4DECOMPRESS<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="2444"><td class="num" id="LN2444">2444</td><td class="line">    <span class='string_literal'>"/"</span> <span class='macro'>LZ4_EXTENSION<span class='macro_popup'>".lz4"</span></span> <span class='string_literal'>"/"</span> <span class='macro'>TLZ4_EXTENSION<span class='macro_popup'>".tlz4"</span></span></td></tr>
<tr class="codeline" data-linenumber="2445"><td class="num" id="LN2445">2445</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2446"><td class="num" id="LN2446">2446</td><td class="line">;</td></tr>
<tr class="codeline" data-linenumber="2447"><td class="num" id="LN2447">2447</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2448"><td class="num" id="LN2448">2448</td><td class="line"><span class='comment'>/* FIO_determineDstName() :</span></td></tr>
<tr class="codeline" data-linenumber="2449"><td class="num" id="LN2449">2449</td><td class="line"> <span class='comment'>* create a destination filename from a srcFileName.</span></td></tr>
<tr class="codeline" data-linenumber="2450"><td class="num" id="LN2450">2450</td><td class="line"> <span class='comment'>* @return a pointer to it.</span></td></tr>
<tr class="codeline" data-linenumber="2451"><td class="num" id="LN2451">2451</td><td class="line"> <span class='comment'>* @return == NULL if there is an error */</span></td></tr>
<tr class="codeline" data-linenumber="2452"><td class="num" id="LN2452">2452</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>char</span>*</td></tr>
<tr class="codeline" data-linenumber="2453"><td class="num" id="LN2453">2453</td><td class="line">FIO_determineDstName(<span class='keyword'>const</span> <span class='keyword'>char</span>* srcFileName, <span class='keyword'>const</span> <span class='keyword'>char</span>* outDirName)</td></tr>
<tr class="codeline" data-linenumber="2454"><td class="num" id="LN2454">2454</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2455"><td class="num" id="LN2455">2455</td><td class="line">    <span class='keyword'>static</span> size_t dfnbCapacity = 0;</td></tr>
<tr class="codeline" data-linenumber="2456"><td class="num" id="LN2456">2456</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>char</span>* dstFileNameBuffer = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;   <span class='comment'>/* using static allocation : this function cannot be multi-threaded */</span></td></tr>
<tr class="codeline" data-linenumber="2457"><td class="num" id="LN2457">2457</td><td class="line">    size_t dstFileNameEndPos;</td></tr>
<tr class="codeline" data-linenumber="2458"><td class="num" id="LN2458">2458</td><td class="line">    <span class='keyword'>char</span>* outDirFilename = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2459"><td class="num" id="LN2459">2459</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span>* dstSuffix = <span class='string_literal'>""</span>;</td></tr>
<tr class="codeline" data-linenumber="2460"><td class="num" id="LN2460">2460</td><td class="line">    size_t dstSuffixLen = 0;</td></tr>
<tr class="codeline" data-linenumber="2461"><td class="num" id="LN2461">2461</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2462"><td class="num" id="LN2462">2462</td><td class="line">    size_t sfnSize = strlen(srcFileName);</td></tr>
<tr class="codeline" data-linenumber="2463"><td class="num" id="LN2463">2463</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2464"><td class="num" id="LN2464">2464</td><td class="line">    size_t srcSuffixLen;</td></tr>
<tr class="codeline" data-linenumber="2465"><td class="num" id="LN2465">2465</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span>* <span class='keyword'>const</span> srcSuffix = strrchr(srcFileName, '.');</td></tr>
<tr class="codeline" data-linenumber="2466"><td class="num" id="LN2466">2466</td><td class="line">    <span class='keyword'>if</span> (srcSuffix == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2467"><td class="num" id="LN2467">2467</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: unknown suffix (%s expected). "<br> "Can't derive the output file name. " "Specify it with -o dstFileName. Ignoring.\n"<br>, srcFileName, suffixListStr); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="2468"><td class="num" id="LN2468">2468</td><td class="line">            <span class='string_literal'><span class='macro'>"zstd: %s: unknown suffix (%s expected). "<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: unknown suffix (%s expected). "<br> "Can't derive the output file name. " "Specify it with -o dstFileName. Ignoring.\n"<br>, srcFileName, suffixListStr); } }</span></span></span></td></tr>
<tr class="codeline" data-linenumber="2469"><td class="num" id="LN2469">2469</td><td class="line">            <span class='string_literal'><span class='macro'>"Can't derive the output file name. "<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: unknown suffix (%s expected). "<br> "Can't derive the output file name. " "Specify it with -o dstFileName. Ignoring.\n"<br>, srcFileName, suffixListStr); } }</span></span></span></td></tr>
<tr class="codeline" data-linenumber="2470"><td class="num" id="LN2470">2470</td><td class="line">            <span class='string_literal'><span class='macro'>"Specify it with -o dstFileName. Ignoring.\n"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: unknown suffix (%s expected). "<br> "Can't derive the output file name. " "Specify it with -o dstFileName. Ignoring.\n"<br>, srcFileName, suffixListStr); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="2471"><td class="num" id="LN2471">2471</td><td class="line">            <span class='macro'>srcFileName, suffixListStr)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: unknown suffix (%s expected). "<br> "Can't derive the output file name. " "Specify it with -o dstFileName. Ignoring.\n"<br>, srcFileName, suffixListStr); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2472"><td class="num" id="LN2472">2472</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2473"><td class="num" id="LN2473">2473</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2474"><td class="num" id="LN2474">2474</td><td class="line">    srcSuffixLen = strlen(srcSuffix);</td></tr>
<tr class="codeline" data-linenumber="2475"><td class="num" id="LN2475">2475</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2476"><td class="num" id="LN2476">2476</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2477"><td class="num" id="LN2477">2477</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>char</span>** matchedSuffixPtr;</td></tr>
<tr class="codeline" data-linenumber="2478"><td class="num" id="LN2478">2478</td><td class="line">        <span class='keyword'>for</span> (matchedSuffixPtr = suffixList; *matchedSuffixPtr != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>; matchedSuffixPtr++) {</td></tr>
<tr class="codeline" data-linenumber="2479"><td class="num" id="LN2479">2479</td><td class="line">            <span class='keyword'>if</span> (!strcmp(*matchedSuffixPtr, srcSuffix)) {</td></tr>
<tr class="codeline" data-linenumber="2480"><td class="num" id="LN2480">2480</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2481"><td class="num" id="LN2481">2481</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2482"><td class="num" id="LN2482">2482</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2483"><td class="num" id="LN2483">2483</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2484"><td class="num" id="LN2484">2484</td><td class="line">        <span class='comment'>/* check suffix is authorized */</span></td></tr>
<tr class="codeline" data-linenumber="2485"><td class="num" id="LN2485">2485</td><td class="line">        <span class='keyword'>if</span> (sfnSize &lt;= srcSuffixLen || *matchedSuffixPtr == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2486"><td class="num" id="LN2486">2486</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: unknown suffix (%s expected). "<br> "Can't derive the output file name. " "Specify it with -o dstFileName. Ignoring.\n"<br>, srcFileName, suffixListStr); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="2487"><td class="num" id="LN2487">2487</td><td class="line">                <span class='string_literal'><span class='macro'>"zstd: %s: unknown suffix (%s expected). "<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: unknown suffix (%s expected). "<br> "Can't derive the output file name. " "Specify it with -o dstFileName. Ignoring.\n"<br>, srcFileName, suffixListStr); } }</span></span></span></td></tr>
<tr class="codeline" data-linenumber="2488"><td class="num" id="LN2488">2488</td><td class="line">                <span class='string_literal'><span class='macro'>"Can't derive the output file name. "<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: unknown suffix (%s expected). "<br> "Can't derive the output file name. " "Specify it with -o dstFileName. Ignoring.\n"<br>, srcFileName, suffixListStr); } }</span></span></span></td></tr>
<tr class="codeline" data-linenumber="2489"><td class="num" id="LN2489">2489</td><td class="line">                <span class='string_literal'><span class='macro'>"Specify it with -o dstFileName. Ignoring.\n"</span>,<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: unknown suffix (%s expected). "<br> "Can't derive the output file name. " "Specify it with -o dstFileName. Ignoring.\n"<br>, srcFileName, suffixListStr); } }</span></span></td></tr>
<tr class="codeline" data-linenumber="2490"><td class="num" id="LN2490">2490</td><td class="line">                <span class='macro'>srcFileName, suffixListStr)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: %s: unknown suffix (%s expected). "<br> "Can't derive the output file name. " "Specify it with -o dstFileName. Ignoring.\n"<br>, srcFileName, suffixListStr); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2491"><td class="num" id="LN2491">2491</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2492"><td class="num" id="LN2492">2492</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2493"><td class="num" id="LN2493">2493</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2494"><td class="num" id="LN2494">2494</td><td class="line">        <span class='keyword'>if</span> ((*matchedSuffixPtr)[1] == 't') {</td></tr>
<tr class="codeline" data-linenumber="2495"><td class="num" id="LN2495">2495</td><td class="line">            dstSuffix = <span class='string_literal'>".tar"</span>;</td></tr>
<tr class="codeline" data-linenumber="2496"><td class="num" id="LN2496">2496</td><td class="line">            dstSuffixLen = strlen(dstSuffix);</td></tr>
<tr class="codeline" data-linenumber="2497"><td class="num" id="LN2497">2497</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2498"><td class="num" id="LN2498">2498</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2499"><td class="num" id="LN2499">2499</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2500"><td class="num" id="LN2500">2500</td><td class="line">    <span class='keyword'>if</span> (outDirName) {</td></tr>
<tr class="codeline" data-linenumber="2501"><td class="num" id="LN2501">2501</td><td class="line">        outDirFilename = FIO_createFilename_fromOutDir(srcFileName, outDirName, 0);</td></tr>
<tr class="codeline" data-linenumber="2502"><td class="num" id="LN2502">2502</td><td class="line">        sfnSize = strlen(outDirFilename);</td></tr>
<tr class="codeline" data-linenumber="2503"><td class="num" id="LN2503">2503</td><td class="line">        <span class='macro'>assert(outDirFilename != NULL)<span class='macro_popup'>((void) sizeof ((outDirFilename != ((void*)0)) ? 1 : 0), __extension__<br> ({ if (outDirFilename != ((void*)0)) ; else __assert_fail ("outDirFilename != NULL"<br>, "fileio.c", 2503, __extension__ __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2504"><td class="num" id="LN2504">2504</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2505"><td class="num" id="LN2505">2505</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2506"><td class="num" id="LN2506">2506</td><td class="line">    <span class='keyword'>if</span> (dfnbCapacity+srcSuffixLen &lt;= sfnSize+1+dstSuffixLen) {</td></tr>
<tr class="codeline" data-linenumber="2507"><td class="num" id="LN2507">2507</td><td class="line">        <span class='comment'>/* allocate enough space to write dstFilename into it */</span></td></tr>
<tr class="codeline" data-linenumber="2508"><td class="num" id="LN2508">2508</td><td class="line">        free(dstFileNameBuffer);</td></tr>
<tr class="codeline" data-linenumber="2509"><td class="num" id="LN2509">2509</td><td class="line">        dfnbCapacity = sfnSize + 20;</td></tr>
<tr class="codeline" data-linenumber="2510"><td class="num" id="LN2510">2510</td><td class="line">        dstFileNameBuffer = (<span class='keyword'>char</span>*)malloc(dfnbCapacity);</td></tr>
<tr class="codeline" data-linenumber="2511"><td class="num" id="LN2511">2511</td><td class="line">        <span class='keyword'>if</span> (dstFileNameBuffer==<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2512"><td class="num" id="LN2512">2512</td><td class="line">            <span class='macro'>EXM_THROW(74, <span class='string_literal'>"%s : not enough memory for dstFileName"</span>,<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 2513<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 74); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s : not enough memory for dstFileName"<br>, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(74);<br> }</span></span></td></tr>
<tr class="codeline" data-linenumber="2513"><td class="num" id="LN2513">2513</td><td class="line">                      <span class='macro'>strerror(errno))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 2513<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 74); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "%s : not enough memory for dstFileName"<br>, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(74);<br> }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2514"><td class="num" id="LN2514">2514</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2515"><td class="num" id="LN2515">2515</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2516"><td class="num" id="LN2516">2516</td><td class="line">    <span class='comment'>/* return dst name == src name truncated from suffix */</span></td></tr>
<tr class="codeline" data-linenumber="2517"><td class="num" id="LN2517">2517</td><td class="line">    <span class='macro'>assert(dstFileNameBuffer != NULL)<span class='macro_popup'>((void) sizeof ((dstFileNameBuffer != ((void*)0)) ? 1 : 0), __extension__<br> ({ if (dstFileNameBuffer != ((void*)0)) ; else __assert_fail<br> ("dstFileNameBuffer != NULL", "fileio.c", 2517, __extension__<br> __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2518"><td class="num" id="LN2518">2518</td><td class="line">    dstFileNameEndPos = sfnSize - srcSuffixLen;</td></tr>
<tr class="codeline" data-linenumber="2519"><td class="num" id="LN2519">2519</td><td class="line">    <span class='keyword'>if</span> (outDirFilename) {</td></tr>
<tr class="codeline" data-linenumber="2520"><td class="num" id="LN2520">2520</td><td class="line">        <span class="mrange">memcpy</span>(dstFileNameBuffer, outDirFilename, dstFileNameEndPos);</td></tr>
<tr><td class="num"></td><td class="line"><div id="EndPath" class="msg msgEvent" style="margin-left:9ex; max-width:58em">Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11</div></td></tr>
<tr class="codeline" data-linenumber="2521"><td class="num" id="LN2521">2521</td><td class="line">        free(outDirFilename);</td></tr>
<tr class="codeline" data-linenumber="2522"><td class="num" id="LN2522">2522</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2523"><td class="num" id="LN2523">2523</td><td class="line">        memcpy(dstFileNameBuffer, srcFileName, dstFileNameEndPos);</td></tr>
<tr class="codeline" data-linenumber="2524"><td class="num" id="LN2524">2524</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2525"><td class="num" id="LN2525">2525</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2526"><td class="num" id="LN2526">2526</td><td class="line">    <span class='comment'>/* The short tar extensions tzst, tgz, txz and tlz4 files should have "tar"</span></td></tr>
<tr class="codeline" data-linenumber="2527"><td class="num" id="LN2527">2527</td><td class="line">     <span class='comment'>* extension on decompression. Also writes terminating null. */</span></td></tr>
<tr class="codeline" data-linenumber="2528"><td class="num" id="LN2528">2528</td><td class="line">    strcpy(dstFileNameBuffer + dstFileNameEndPos, dstSuffix);</td></tr>
<tr class="codeline" data-linenumber="2529"><td class="num" id="LN2529">2529</td><td class="line">    <span class='keyword'>return</span> dstFileNameBuffer;</td></tr>
<tr class="codeline" data-linenumber="2530"><td class="num" id="LN2530">2530</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2531"><td class="num" id="LN2531">2531</td><td class="line">    <span class='comment'>/* note : dstFileNameBuffer memory is not going to be free */</span></td></tr>
<tr class="codeline" data-linenumber="2532"><td class="num" id="LN2532">2532</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2533"><td class="num" id="LN2533">2533</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2534"><td class="num" id="LN2534">2534</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2535"><td class="num" id="LN2535">2535</td><td class="line"><span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="2536"><td class="num" id="LN2536">2536</td><td class="line">FIO_decompressMultipleFilenames(FIO_prefs_t* <span class='keyword'>const</span> prefs,</td></tr>
<tr class="codeline" data-linenumber="2537"><td class="num" id="LN2537">2537</td><td class="line">                                <span class='keyword'>const</span> <span class='keyword'>char</span>** srcNamesTable, <span class='keyword'>unsigned</span> nbFiles,</td></tr>
<tr class="codeline" data-linenumber="2538"><td class="num" id="LN2538">2538</td><td class="line">                                <span class='keyword'>const</span> <span class='keyword'>char</span>* outDirName, <span class='keyword'>const</span> <span class='keyword'>char</span>* outFileName,</td></tr>
<tr class="codeline" data-linenumber="2539"><td class="num" id="LN2539">2539</td><td class="line">                                <span class='keyword'>const</span> <span class='keyword'>char</span>* dictFileName)</td></tr>
<tr class="codeline" data-linenumber="2540"><td class="num" id="LN2540">2540</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2541"><td class="num" id="LN2541">2541</td><td class="line">    <span class='keyword'>int</span> error = 0;</td></tr>
<tr class="codeline" data-linenumber="2542"><td class="num" id="LN2542">2542</td><td class="line">    dRess_t ress = FIO_createDResources(prefs, dictFileName);</td></tr>
<tr class="codeline" data-linenumber="2543"><td class="num" id="LN2543">2543</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2544"><td class="num" id="LN2544">2544</td><td class="line">    <span class='keyword'>if</span> (outFileName) {</td></tr>
<tr class="codeline" data-linenumber="2545"><td class="num" id="LN2545">2545</td><td class="line">        <span class='keyword'>unsigned</span> u;</td></tr>
<tr class="codeline" data-linenumber="2546"><td class="num" id="LN2546">2546</td><td class="line">        <span class='keyword'>if</span> (!prefs-&gt;testMode) {</td></tr>
<tr class="codeline" data-linenumber="2547"><td class="num" id="LN2547">2547</td><td class="line">            ress.dstFile = FIO_openDstFile(prefs, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, outFileName);</td></tr>
<tr class="codeline" data-linenumber="2548"><td class="num" id="LN2548">2548</td><td class="line">            <span class='keyword'>if</span> (ress.dstFile == 0) <span class='macro'>EXM_THROW(19, <span class='string_literal'>"cannot open %s"</span>, outFileName)<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 2548<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 19); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "cannot open %s", outFileName); } }<br>; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> " \n"); } }; exit(19); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2549"><td class="num" id="LN2549">2549</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2550"><td class="num" id="LN2550">2550</td><td class="line">        <span class='keyword'>for</span> (u=0; u&lt;nbFiles; u++)</td></tr>
<tr class="codeline" data-linenumber="2551"><td class="num" id="LN2551">2551</td><td class="line">            error |= FIO_decompressSrcFile(prefs, ress, outFileName, srcNamesTable[u]);</td></tr>
<tr class="codeline" data-linenumber="2552"><td class="num" id="LN2552">2552</td><td class="line">        <span class='keyword'>if</span> ((!prefs-&gt;testMode) &amp;&amp; (fclose(ress.dstFile)))</td></tr>
<tr class="codeline" data-linenumber="2553"><td class="num" id="LN2553">2553</td><td class="line">            <span class='macro'>EXM_THROW(72, <span class='string_literal'>"Write error : %s : cannot properly close output file"</span>,<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 2554<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 72); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Write error : %s : cannot properly close output file"<br>, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(72);<br> }</span></span></td></tr>
<tr class="codeline" data-linenumber="2554"><td class="num" id="LN2554">2554</td><td class="line">                        <span class='macro'>strerror(errno))<span class='macro_popup'>{ { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> "zstd: "); } }; { if (g_display_prefs.displayLevel&gt;=5) { fprintf<br>(stderr, "Error defined at %s, line %i : \n", "fileio.c", 2554<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, "error %i : ", 72); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Write error : %s : cannot properly close output file"<br>, strerror((*__errno_location ()))); } }; { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, " \n"); } }; exit(72);<br> }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2555"><td class="num" id="LN2555">2555</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2556"><td class="num" id="LN2556">2556</td><td class="line">        <span class='keyword'>unsigned</span> u;</td></tr>
<tr class="codeline" data-linenumber="2557"><td class="num" id="LN2557">2557</td><td class="line">        <span class='keyword'>for</span> (u=0; u&lt;nbFiles; u++) {   <span class='comment'>/* create dstFileName */</span></td></tr>
<tr class="codeline" data-linenumber="2558"><td class="num" id="LN2558">2558</td><td class="line">            <span class='keyword'>const</span> <span class='keyword'>char</span>* <span class='keyword'>const</span> srcFileName = srcNamesTable[u];</td></tr>
<tr class="codeline" data-linenumber="2559"><td class="num" id="LN2559">2559</td><td class="line">            <span class='keyword'>const</span> <span class='keyword'>char</span>* <span class='keyword'>const</span> dstFileName = FIO_determineDstName(srcFileName, outDirName);</td></tr>
<tr class="codeline" data-linenumber="2560"><td class="num" id="LN2560">2560</td><td class="line">            <span class='keyword'>if</span> (dstFileName == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) { error=1; <span class='keyword'>continue</span>; }</td></tr>
<tr class="codeline" data-linenumber="2561"><td class="num" id="LN2561">2561</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2562"><td class="num" id="LN2562">2562</td><td class="line">            error |= FIO_decompressSrcFile(prefs, ress, dstFileName, srcFileName);</td></tr>
<tr class="codeline" data-linenumber="2563"><td class="num" id="LN2563">2563</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2564"><td class="num" id="LN2564">2564</td><td class="line">        <span class='keyword'>if</span> (outDirName)</td></tr>
<tr class="codeline" data-linenumber="2565"><td class="num" id="LN2565">2565</td><td class="line">            FIO_checkFilenameCollisions(srcNamesTable ,nbFiles);</td></tr>
<tr class="codeline" data-linenumber="2566"><td class="num" id="LN2566">2566</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2567"><td class="num" id="LN2567">2567</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2568"><td class="num" id="LN2568">2568</td><td class="line">    FIO_freeDResources(ress);</td></tr>
<tr class="codeline" data-linenumber="2569"><td class="num" id="LN2569">2569</td><td class="line">    <span class='keyword'>return</span> error;</td></tr>
<tr class="codeline" data-linenumber="2570"><td class="num" id="LN2570">2570</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2571"><td class="num" id="LN2571">2571</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2572"><td class="num" id="LN2572">2572</td><td class="line"><span class='comment'>/* **************************************************************************</span></td></tr>
<tr class="codeline" data-linenumber="2573"><td class="num" id="LN2573">2573</td><td class="line"> <span class='comment'>*  .zst file info (--list command)</span></td></tr>
<tr class="codeline" data-linenumber="2574"><td class="num" id="LN2574">2574</td><td class="line"> <span class='comment'>***************************************************************************/</span></td></tr>
<tr class="codeline" data-linenumber="2575"><td class="num" id="LN2575">2575</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2576"><td class="num" id="LN2576">2576</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> {</td></tr>
<tr class="codeline" data-linenumber="2577"><td class="num" id="LN2577">2577</td><td class="line">    U64 decompressedSize;</td></tr>
<tr class="codeline" data-linenumber="2578"><td class="num" id="LN2578">2578</td><td class="line">    U64 compressedSize;</td></tr>
<tr class="codeline" data-linenumber="2579"><td class="num" id="LN2579">2579</td><td class="line">    U64 windowSize;</td></tr>
<tr class="codeline" data-linenumber="2580"><td class="num" id="LN2580">2580</td><td class="line">    <span class='keyword'>int</span> numActualFrames;</td></tr>
<tr class="codeline" data-linenumber="2581"><td class="num" id="LN2581">2581</td><td class="line">    <span class='keyword'>int</span> numSkippableFrames;</td></tr>
<tr class="codeline" data-linenumber="2582"><td class="num" id="LN2582">2582</td><td class="line">    <span class='keyword'>int</span> decompUnavailable;</td></tr>
<tr class="codeline" data-linenumber="2583"><td class="num" id="LN2583">2583</td><td class="line">    <span class='keyword'>int</span> usesCheck;</td></tr>
<tr class="codeline" data-linenumber="2584"><td class="num" id="LN2584">2584</td><td class="line">    U32 nbFiles;</td></tr>
<tr class="codeline" data-linenumber="2585"><td class="num" id="LN2585">2585</td><td class="line">} fileInfo_t;</td></tr>
<tr class="codeline" data-linenumber="2586"><td class="num" id="LN2586">2586</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2587"><td class="num" id="LN2587">2587</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>enum</span> {</td></tr>
<tr class="codeline" data-linenumber="2588"><td class="num" id="LN2588">2588</td><td class="line">  info_success=0,</td></tr>
<tr class="codeline" data-linenumber="2589"><td class="num" id="LN2589">2589</td><td class="line">  info_frame_error=1,</td></tr>
<tr class="codeline" data-linenumber="2590"><td class="num" id="LN2590">2590</td><td class="line">  info_not_zstd=2,</td></tr>
<tr class="codeline" data-linenumber="2591"><td class="num" id="LN2591">2591</td><td class="line">  info_file_error=3,</td></tr>
<tr class="codeline" data-linenumber="2592"><td class="num" id="LN2592">2592</td><td class="line">  info_truncated_input=4,</td></tr>
<tr class="codeline" data-linenumber="2593"><td class="num" id="LN2593">2593</td><td class="line">} InfoError;</td></tr>
<tr class="codeline" data-linenumber="2594"><td class="num" id="LN2594">2594</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2595"><td class="num" id="LN2595">2595</td><td class="line"><span class='directive'>#define <span class='macro'>ERROR_IF(c,n,...)<span class='macro_popup'>{ if (c) { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, ...); } }; { if (g_display_prefs.displayLevel&gt;=1)<br> { fprintf(stderr, " \n"); } }; return n; } }</span></span> {             \</span></td></tr>
<tr class="codeline" data-linenumber="2596"><td class="num" id="LN2596">2596</td><td class="line">    <span class='directive'>if (c) {                           \</span></td></tr>
<tr class="codeline" data-linenumber="2597"><td class="num" id="LN2597">2597</td><td class="line">        <span class='directive'><span class='macro'>DISPLAYLEVEL(1, __VA_ARGS__)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, __VA_ARGS__<br>); } }</span></span>;  \</span></td></tr>
<tr class="codeline" data-linenumber="2598"><td class="num" id="LN2598">2598</td><td class="line">        <span class='directive'><span class='macro'>DISPLAYLEVEL(1, " \n")<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }</span></span>;        \</span></td></tr>
<tr class="codeline" data-linenumber="2599"><td class="num" id="LN2599">2599</td><td class="line">        <span class='directive'>return n;                      \</span></td></tr>
<tr class="codeline" data-linenumber="2600"><td class="num" id="LN2600">2600</td><td class="line">    <span class='directive'>}                                  \</span></td></tr>
<tr class="codeline" data-linenumber="2601"><td class="num" id="LN2601">2601</td><td class="line"><span class='directive'>}</span></td></tr>
<tr class="codeline" data-linenumber="2602"><td class="num" id="LN2602">2602</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2603"><td class="num" id="LN2603">2603</td><td class="line"><span class='keyword'>static</span> InfoError</td></tr>
<tr class="codeline" data-linenumber="2604"><td class="num" id="LN2604">2604</td><td class="line">FIO_analyzeFrames(fileInfo_t* info, FILE* <span class='keyword'>const</span> srcFile)</td></tr>
<tr class="codeline" data-linenumber="2605"><td class="num" id="LN2605">2605</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2606"><td class="num" id="LN2606">2606</td><td class="line">    <span class='comment'>/* begin analyzing frame */</span></td></tr>
<tr class="codeline" data-linenumber="2607"><td class="num" id="LN2607">2607</td><td class="line">    <span class='keyword'>for</span> ( ; ; ) {</td></tr>
<tr class="codeline" data-linenumber="2608"><td class="num" id="LN2608">2608</td><td class="line">        BYTE headerBuffer[<span class='macro'>ZSTD_FRAMEHEADERSIZE_MAX<span class='macro_popup'>18</span></span>];</td></tr>
<tr class="codeline" data-linenumber="2609"><td class="num" id="LN2609">2609</td><td class="line">        size_t <span class='keyword'>const</span> numBytesRead = fread(headerBuffer, 1, <span class='keyword'>sizeof</span>(headerBuffer), srcFile);</td></tr>
<tr class="codeline" data-linenumber="2610"><td class="num" id="LN2610">2610</td><td class="line">        <span class='keyword'>if</span> (numBytesRead &lt; <span class='macro'>ZSTD_FRAMEHEADERSIZE_MIN(ZSTD_f_zstd1)<span class='macro_popup'>((ZSTD_f_zstd1) == ZSTD_f_zstd1 ? 6 : 2)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2611"><td class="num" id="LN2611">2611</td><td class="line">            <span class='keyword'>if</span> ( feof(srcFile)</td></tr>
<tr class="codeline" data-linenumber="2612"><td class="num" id="LN2612">2612</td><td class="line">              &amp;&amp; (numBytesRead == 0)</td></tr>
<tr class="codeline" data-linenumber="2613"><td class="num" id="LN2613">2613</td><td class="line">              &amp;&amp; (info-&gt;compressedSize &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="2614"><td class="num" id="LN2614">2614</td><td class="line">              &amp;&amp; (info-&gt;compressedSize != <span class='macro'>UTIL_FILESIZE_UNKNOWN<span class='macro_popup'>((U64)(-1))</span></span>) ) {</td></tr>
<tr class="codeline" data-linenumber="2615"><td class="num" id="LN2615">2615</td><td class="line">                <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> file_position = (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>) <span class='macro'>LONG_TELL<span class='macro_popup'>ftell</span></span>(srcFile);</td></tr>
<tr class="codeline" data-linenumber="2616"><td class="num" id="LN2616">2616</td><td class="line">                <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> file_size = (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>) info-&gt;compressedSize;</td></tr>
<tr class="codeline" data-linenumber="2617"><td class="num" id="LN2617">2617</td><td class="line">                <span class='macro'>ERROR_IF(file_position != file_size, info_truncated_input,<span class='macro_popup'>{ if (file_position != file_size) { { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Error: seeked to position %llu, which is beyond file size of %llu\n"<br>, file_position, file_size); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, " \n"); } }; return info_truncated_input<br>; } }</span></span></td></tr>
<tr class="codeline" data-linenumber="2618"><td class="num" id="LN2618">2618</td><td class="line">                  <span class='string_literal'><span class='macro'>"Error: seeked to position %llu, which is beyond file size of %llu\n"</span>,<span class='macro_popup'>{ if (file_position != file_size) { { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Error: seeked to position %llu, which is beyond file size of %llu\n"<br>, file_position, file_size); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, " \n"); } }; return info_truncated_input<br>; } }</span></span></td></tr>
<tr class="codeline" data-linenumber="2619"><td class="num" id="LN2619">2619</td><td class="line">                  <span class='macro'>file_position,<span class='macro_popup'>{ if (file_position != file_size) { { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Error: seeked to position %llu, which is beyond file size of %llu\n"<br>, file_position, file_size); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, " \n"); } }; return info_truncated_input<br>; } }</span></span></td></tr>
<tr class="codeline" data-linenumber="2620"><td class="num" id="LN2620">2620</td><td class="line">                  <span class='macro'>file_size)<span class='macro_popup'>{ if (file_position != file_size) { { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Error: seeked to position %llu, which is beyond file size of %llu\n"<br>, file_position, file_size); } }; { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, " \n"); } }; return info_truncated_input<br>; } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2621"><td class="num" id="LN2621">2621</td><td class="line">                <span class='keyword'>break</span>;  <span class='comment'>/* correct end of file =&gt; success */</span></td></tr>
<tr class="codeline" data-linenumber="2622"><td class="num" id="LN2622">2622</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2623"><td class="num" id="LN2623">2623</td><td class="line">            <span class='macro'>ERROR_IF(feof(srcFile), info_not_zstd, <span class='string_literal'>"Error: reached end of file with incomplete frame"</span>)<span class='macro_popup'>{ if (feof(srcFile)) { { if (g_display_prefs.displayLevel&gt;=<br>1) { fprintf(stderr, "Error: reached end of file with incomplete frame"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; return info_not_zstd; } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2624"><td class="num" id="LN2624">2624</td><td class="line">            <span class='macro'>ERROR_IF(1, info_frame_error, <span class='string_literal'>"Error: did not reach end of file but ran out of frames"</span>)<span class='macro_popup'>{ if (1) { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "Error: did not reach end of file but ran out of frames"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; return info_frame_error; } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2625"><td class="num" id="LN2625">2625</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2626"><td class="num" id="LN2626">2626</td><td class="line">        {   U32 <span class='keyword'>const</span> magicNumber = MEM_readLE32(headerBuffer);</td></tr>
<tr class="codeline" data-linenumber="2627"><td class="num" id="LN2627">2627</td><td class="line">            <span class='comment'>/* Zstandard frame */</span></td></tr>
<tr class="codeline" data-linenumber="2628"><td class="num" id="LN2628">2628</td><td class="line">            <span class='keyword'>if</span> (magicNumber == <span class='macro'>ZSTD_MAGICNUMBER<span class='macro_popup'>0xFD2FB528</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2629"><td class="num" id="LN2629">2629</td><td class="line">                ZSTD_frameHeader header;</td></tr>
<tr class="codeline" data-linenumber="2630"><td class="num" id="LN2630">2630</td><td class="line">                U64 <span class='keyword'>const</span> frameContentSize = ZSTD_getFrameContentSize(headerBuffer, numBytesRead);</td></tr>
<tr class="codeline" data-linenumber="2631"><td class="num" id="LN2631">2631</td><td class="line">                <span class='keyword'>if</span> ( frameContentSize == <span class='macro'>ZSTD_CONTENTSIZE_ERROR<span class='macro_popup'>(0ULL - 2)</span></span></td></tr>
<tr class="codeline" data-linenumber="2632"><td class="num" id="LN2632">2632</td><td class="line">                  || frameContentSize == <span class='macro'>ZSTD_CONTENTSIZE_UNKNOWN<span class='macro_popup'>(0ULL - 1)</span></span> ) {</td></tr>
<tr class="codeline" data-linenumber="2633"><td class="num" id="LN2633">2633</td><td class="line">                    info-&gt;decompUnavailable = 1;</td></tr>
<tr class="codeline" data-linenumber="2634"><td class="num" id="LN2634">2634</td><td class="line">                } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2635"><td class="num" id="LN2635">2635</td><td class="line">                    info-&gt;decompressedSize += frameContentSize;</td></tr>
<tr class="codeline" data-linenumber="2636"><td class="num" id="LN2636">2636</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2637"><td class="num" id="LN2637">2637</td><td class="line">                <span class='macro'>ERROR_IF(ZSTD_getFrameHeader(&amp;header, headerBuffer, numBytesRead) != 0,<span class='macro_popup'>{ if (ZSTD_getFrameHeader(&amp;header, headerBuffer, numBytesRead<br>) != 0) { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "Error: could not decode frame header"); } }; { if (<br>g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n");<br> } }; return info_frame_error; } }</span></span></td></tr>
<tr class="codeline" data-linenumber="2638"><td class="num" id="LN2638">2638</td><td class="line">                        <span class='macro'>info_frame_error, <span class='string_literal'>"Error: could not decode frame header"</span>)<span class='macro_popup'>{ if (ZSTD_getFrameHeader(&amp;header, headerBuffer, numBytesRead<br>) != 0) { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "Error: could not decode frame header"); } }; { if (<br>g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n");<br> } }; return info_frame_error; } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2639"><td class="num" id="LN2639">2639</td><td class="line">                info-&gt;windowSize = header.windowSize;</td></tr>
<tr class="codeline" data-linenumber="2640"><td class="num" id="LN2640">2640</td><td class="line">                <span class='comment'>/* move to the end of the frame header */</span></td></tr>
<tr class="codeline" data-linenumber="2641"><td class="num" id="LN2641">2641</td><td class="line">                {   size_t <span class='keyword'>const</span> headerSize = ZSTD_frameHeaderSize(headerBuffer, numBytesRead);</td></tr>
<tr class="codeline" data-linenumber="2642"><td class="num" id="LN2642">2642</td><td class="line">                    <span class='macro'>ERROR_IF(ZSTD_isError(headerSize), info_frame_error, <span class='string_literal'>"Error: could not determine frame header size"</span>)<span class='macro_popup'>{ if (ERR_isError(headerSize)) { { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Error: could not determine frame header size"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; return info_frame_error; } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2643"><td class="num" id="LN2643">2643</td><td class="line">                    <span class='macro'>ERROR_IF(fseek(srcFile, ((<span class='keyword'>long</span>)headerSize)-((<span class='keyword'>long</span>)numBytesRead), SEEK_CUR) != 0,<span class='macro_popup'>{ if (fseek(srcFile, ((long)headerSize)-((long)numBytesRead),<br> 1) != 0) { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "Error: could not move to end of frame header"); } }<br>; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> " \n"); } }; return info_frame_error; } }</span></span></td></tr>
<tr class="codeline" data-linenumber="2644"><td class="num" id="LN2644">2644</td><td class="line">                            <span class='macro'>info_frame_error, <span class='string_literal'>"Error: could not move to end of frame header"</span>)<span class='macro_popup'>{ if (fseek(srcFile, ((long)headerSize)-((long)numBytesRead),<br> 1) != 0) { { if (g_display_prefs.displayLevel&gt;=1) { fprintf<br>(stderr, "Error: could not move to end of frame header"); } }<br>; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr,<br> " \n"); } }; return info_frame_error; } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2645"><td class="num" id="LN2645">2645</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2646"><td class="num" id="LN2646">2646</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2647"><td class="num" id="LN2647">2647</td><td class="line">                <span class='comment'>/* skip all blocks in the frame */</span></td></tr>
<tr class="codeline" data-linenumber="2648"><td class="num" id="LN2648">2648</td><td class="line">                {   <span class='keyword'>int</span> lastBlock = 0;</td></tr>
<tr class="codeline" data-linenumber="2649"><td class="num" id="LN2649">2649</td><td class="line">                    <span class='keyword'>do</span> {</td></tr>
<tr class="codeline" data-linenumber="2650"><td class="num" id="LN2650">2650</td><td class="line">                        BYTE blockHeaderBuffer[3];</td></tr>
<tr class="codeline" data-linenumber="2651"><td class="num" id="LN2651">2651</td><td class="line">                        <span class='macro'>ERROR_IF(fread(blockHeaderBuffer, 1, 3, srcFile) != 3,<span class='macro_popup'>{ if (fread(blockHeaderBuffer, 1, 3, srcFile) != 3) { { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, "Error while reading block header"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; return info_frame_error; } }</span></span></td></tr>
<tr class="codeline" data-linenumber="2652"><td class="num" id="LN2652">2652</td><td class="line">                                <span class='macro'>info_frame_error, <span class='string_literal'>"Error while reading block header"</span>)<span class='macro_popup'>{ if (fread(blockHeaderBuffer, 1, 3, srcFile) != 3) { { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, "Error while reading block header"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; return info_frame_error; } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2653"><td class="num" id="LN2653">2653</td><td class="line">                        {   U32 <span class='keyword'>const</span> blockHeader = MEM_readLE24(blockHeaderBuffer);</td></tr>
<tr class="codeline" data-linenumber="2654"><td class="num" id="LN2654">2654</td><td class="line">                            U32 <span class='keyword'>const</span> blockTypeID = (blockHeader &gt;&gt; 1) &amp; 3;</td></tr>
<tr class="codeline" data-linenumber="2655"><td class="num" id="LN2655">2655</td><td class="line">                            U32 <span class='keyword'>const</span> isRLE = (blockTypeID == 1);</td></tr>
<tr class="codeline" data-linenumber="2656"><td class="num" id="LN2656">2656</td><td class="line">                            U32 <span class='keyword'>const</span> isWrongBlock = (blockTypeID == 3);</td></tr>
<tr class="codeline" data-linenumber="2657"><td class="num" id="LN2657">2657</td><td class="line">                            <span class='keyword'>long</span> <span class='keyword'>const</span> blockSize = isRLE ? 1 : (<span class='keyword'>long</span>)(blockHeader &gt;&gt; 3);</td></tr>
<tr class="codeline" data-linenumber="2658"><td class="num" id="LN2658">2658</td><td class="line">                            <span class='macro'>ERROR_IF(isWrongBlock, info_frame_error, <span class='string_literal'>"Error: unsupported block type"</span>)<span class='macro_popup'>{ if (isWrongBlock) { { if (g_display_prefs.displayLevel&gt;=<br>1) { fprintf(stderr, "Error: unsupported block type"); } }; {<br> if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, " \n"<br>); } }; return info_frame_error; } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2659"><td class="num" id="LN2659">2659</td><td class="line">                            lastBlock = blockHeader &amp; 1;</td></tr>
<tr class="codeline" data-linenumber="2660"><td class="num" id="LN2660">2660</td><td class="line">                            <span class='macro'>ERROR_IF(fseek(srcFile, blockSize, SEEK_CUR) != 0,<span class='macro_popup'>{ if (fseek(srcFile, blockSize, 1) != 0) { { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, "Error: could not skip to end of block"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; return info_frame_error; } }</span></span></td></tr>
<tr class="codeline" data-linenumber="2661"><td class="num" id="LN2661">2661</td><td class="line">                                    <span class='macro'>info_frame_error, <span class='string_literal'>"Error: could not skip to end of block"</span>)<span class='macro_popup'>{ if (fseek(srcFile, blockSize, 1) != 0) { { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, "Error: could not skip to end of block"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; return info_frame_error; } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2662"><td class="num" id="LN2662">2662</td><td class="line">                        }</td></tr>
<tr class="codeline" data-linenumber="2663"><td class="num" id="LN2663">2663</td><td class="line">                    } <span class='keyword'>while</span> (lastBlock != 1);</td></tr>
<tr class="codeline" data-linenumber="2664"><td class="num" id="LN2664">2664</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2665"><td class="num" id="LN2665">2665</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2666"><td class="num" id="LN2666">2666</td><td class="line">                <span class='comment'>/* check if checksum is used */</span></td></tr>
<tr class="codeline" data-linenumber="2667"><td class="num" id="LN2667">2667</td><td class="line">                {   BYTE <span class='keyword'>const</span> frameHeaderDescriptor = headerBuffer[4];</td></tr>
<tr class="codeline" data-linenumber="2668"><td class="num" id="LN2668">2668</td><td class="line">                    <span class='keyword'>int</span> <span class='keyword'>const</span> contentChecksumFlag = (frameHeaderDescriptor &amp; (1 &lt;&lt; 2)) &gt;&gt; 2;</td></tr>
<tr class="codeline" data-linenumber="2669"><td class="num" id="LN2669">2669</td><td class="line">                    <span class='keyword'>if</span> (contentChecksumFlag) {</td></tr>
<tr class="codeline" data-linenumber="2670"><td class="num" id="LN2670">2670</td><td class="line">                        info-&gt;usesCheck = 1;</td></tr>
<tr class="codeline" data-linenumber="2671"><td class="num" id="LN2671">2671</td><td class="line">                        <span class='macro'>ERROR_IF(fseek(srcFile, 4, SEEK_CUR) != 0,<span class='macro_popup'>{ if (fseek(srcFile, 4, 1) != 0) { { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Error: could not skip past checksum"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; return info_frame_error; } }</span></span></td></tr>
<tr class="codeline" data-linenumber="2672"><td class="num" id="LN2672">2672</td><td class="line">                                <span class='macro'>info_frame_error, <span class='string_literal'>"Error: could not skip past checksum"</span>)<span class='macro_popup'>{ if (fseek(srcFile, 4, 1) != 0) { { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Error: could not skip past checksum"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; return info_frame_error; } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2673"><td class="num" id="LN2673">2673</td><td class="line">                }   }</td></tr>
<tr class="codeline" data-linenumber="2674"><td class="num" id="LN2674">2674</td><td class="line">                info-&gt;numActualFrames++;</td></tr>
<tr class="codeline" data-linenumber="2675"><td class="num" id="LN2675">2675</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2676"><td class="num" id="LN2676">2676</td><td class="line">            <span class='comment'>/* Skippable frame */</span></td></tr>
<tr class="codeline" data-linenumber="2677"><td class="num" id="LN2677">2677</td><td class="line">            <span class='keyword'>else</span> <span class='keyword'>if</span> ((magicNumber &amp; <span class='macro'>ZSTD_MAGIC_SKIPPABLE_MASK<span class='macro_popup'>0xFFFFFFF0</span></span>) == <span class='macro'>ZSTD_MAGIC_SKIPPABLE_START<span class='macro_popup'>0x184D2A50</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2678"><td class="num" id="LN2678">2678</td><td class="line">                U32 <span class='keyword'>const</span> frameSize = MEM_readLE32(headerBuffer + 4);</td></tr>
<tr class="codeline" data-linenumber="2679"><td class="num" id="LN2679">2679</td><td class="line">                <span class='keyword'>long</span> <span class='keyword'>const</span> seek = (<span class='keyword'>long</span>)(8 + frameSize - numBytesRead);</td></tr>
<tr class="codeline" data-linenumber="2680"><td class="num" id="LN2680">2680</td><td class="line">                <span class='macro'>ERROR_IF(LONG_SEEK(srcFile, seek, SEEK_CUR) != 0,<span class='macro_popup'>{ if (fseek(srcFile, seek, 1) != 0) { { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Error: could not find end of skippable frame"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; return info_frame_error; } }</span></span></td></tr>
<tr class="codeline" data-linenumber="2681"><td class="num" id="LN2681">2681</td><td class="line">                        <span class='macro'>info_frame_error, <span class='string_literal'>"Error: could not find end of skippable frame"</span>)<span class='macro_popup'>{ if (fseek(srcFile, seek, 1) != 0) { { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Error: could not find end of skippable frame"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; return info_frame_error; } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2682"><td class="num" id="LN2682">2682</td><td class="line">                info-&gt;numSkippableFrames++;</td></tr>
<tr class="codeline" data-linenumber="2683"><td class="num" id="LN2683">2683</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2684"><td class="num" id="LN2684">2684</td><td class="line">            <span class='comment'>/* unknown content */</span></td></tr>
<tr class="codeline" data-linenumber="2685"><td class="num" id="LN2685">2685</td><td class="line">            <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2686"><td class="num" id="LN2686">2686</td><td class="line">                <span class='keyword'>return</span> info_not_zstd;</td></tr>
<tr class="codeline" data-linenumber="2687"><td class="num" id="LN2687">2687</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2688"><td class="num" id="LN2688">2688</td><td class="line">        }  <span class='comment'>/* magic number analysis */</span></td></tr>
<tr class="codeline" data-linenumber="2689"><td class="num" id="LN2689">2689</td><td class="line">    }  <span class='comment'>/* end analyzing frames */</span></td></tr>
<tr class="codeline" data-linenumber="2690"><td class="num" id="LN2690">2690</td><td class="line">    <span class='keyword'>return</span> info_success;</td></tr>
<tr class="codeline" data-linenumber="2691"><td class="num" id="LN2691">2691</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2692"><td class="num" id="LN2692">2692</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2693"><td class="num" id="LN2693">2693</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2694"><td class="num" id="LN2694">2694</td><td class="line"><span class='keyword'>static</span> InfoError</td></tr>
<tr class="codeline" data-linenumber="2695"><td class="num" id="LN2695">2695</td><td class="line">getFileInfo_fileConfirmed(fileInfo_t* info, <span class='keyword'>const</span> <span class='keyword'>char</span>* inFileName)</td></tr>
<tr class="codeline" data-linenumber="2696"><td class="num" id="LN2696">2696</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2697"><td class="num" id="LN2697">2697</td><td class="line">    InfoError status;</td></tr>
<tr class="codeline" data-linenumber="2698"><td class="num" id="LN2698">2698</td><td class="line">    FILE* <span class='keyword'>const</span> srcFile = FIO_openSrcFile(inFileName);</td></tr>
<tr class="codeline" data-linenumber="2699"><td class="num" id="LN2699">2699</td><td class="line">    <span class='macro'>ERROR_IF(srcFile == NULL, info_file_error, <span class='string_literal'>"Error: could not open source file %s"</span>, inFileName)<span class='macro_popup'>{ if (srcFile == ((void*)0)) { { if (g_display_prefs.displayLevel<br>&gt;=1) { fprintf(stderr, "Error: could not open source file %s"<br>, inFileName); } }; { if (g_display_prefs.displayLevel&gt;=1)<br> { fprintf(stderr, " \n"); } }; return info_file_error; } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2700"><td class="num" id="LN2700">2700</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2701"><td class="num" id="LN2701">2701</td><td class="line">    info-&gt;compressedSize = UTIL_getFileSize(inFileName);</td></tr>
<tr class="codeline" data-linenumber="2702"><td class="num" id="LN2702">2702</td><td class="line">    status = FIO_analyzeFrames(info, srcFile);</td></tr>
<tr class="codeline" data-linenumber="2703"><td class="num" id="LN2703">2703</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2704"><td class="num" id="LN2704">2704</td><td class="line">    fclose(srcFile);</td></tr>
<tr class="codeline" data-linenumber="2705"><td class="num" id="LN2705">2705</td><td class="line">    info-&gt;nbFiles = 1;</td></tr>
<tr class="codeline" data-linenumber="2706"><td class="num" id="LN2706">2706</td><td class="line">    <span class='keyword'>return</span> status;</td></tr>
<tr class="codeline" data-linenumber="2707"><td class="num" id="LN2707">2707</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2708"><td class="num" id="LN2708">2708</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2709"><td class="num" id="LN2709">2709</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2710"><td class="num" id="LN2710">2710</td><td class="line"><span class='comment'>/** getFileInfo() :</span></td></tr>
<tr class="codeline" data-linenumber="2711"><td class="num" id="LN2711">2711</td><td class="line"> <span class='comment'>*  Reads information from file, stores in *info</span></td></tr>
<tr class="codeline" data-linenumber="2712"><td class="num" id="LN2712">2712</td><td class="line"> <span class='comment'>* @return : InfoError status</span></td></tr>
<tr class="codeline" data-linenumber="2713"><td class="num" id="LN2713">2713</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2714"><td class="num" id="LN2714">2714</td><td class="line"><span class='keyword'>static</span> InfoError</td></tr>
<tr class="codeline" data-linenumber="2715"><td class="num" id="LN2715">2715</td><td class="line">getFileInfo(fileInfo_t* info, <span class='keyword'>const</span> <span class='keyword'>char</span>* srcFileName)</td></tr>
<tr class="codeline" data-linenumber="2716"><td class="num" id="LN2716">2716</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2717"><td class="num" id="LN2717">2717</td><td class="line">    <span class='macro'>ERROR_IF(!UTIL_isRegularFile(srcFileName),<span class='macro_popup'>{ if (!UTIL_isRegularFile(srcFileName)) { { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, "Error : %s is not a file"<br>, srcFileName); } }; { if (g_display_prefs.displayLevel&gt;=1<br>) { fprintf(stderr, " \n"); } }; return info_file_error; } }</span></span></td></tr>
<tr class="codeline" data-linenumber="2718"><td class="num" id="LN2718">2718</td><td class="line">            <span class='macro'>info_file_error, <span class='string_literal'>"Error : %s is not a file"</span>, srcFileName)<span class='macro_popup'>{ if (!UTIL_isRegularFile(srcFileName)) { { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, "Error : %s is not a file"<br>, srcFileName); } }; { if (g_display_prefs.displayLevel&gt;=1<br>) { fprintf(stderr, " \n"); } }; return info_file_error; } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2719"><td class="num" id="LN2719">2719</td><td class="line">    <span class='keyword'>return</span> getFileInfo_fileConfirmed(info, srcFileName);</td></tr>
<tr class="codeline" data-linenumber="2720"><td class="num" id="LN2720">2720</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2721"><td class="num" id="LN2721">2721</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2722"><td class="num" id="LN2722">2722</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2723"><td class="num" id="LN2723">2723</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="2724"><td class="num" id="LN2724">2724</td><td class="line">displayInfo(<span class='keyword'>const</span> <span class='keyword'>char</span>* inFileName, <span class='keyword'>const</span> fileInfo_t* info, <span class='keyword'>int</span> displayLevel)</td></tr>
<tr class="codeline" data-linenumber="2725"><td class="num" id="LN2725">2725</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2726"><td class="num" id="LN2726">2726</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>const</span> unit = info-&gt;compressedSize &lt; (1 <span class='macro'>MB<span class='macro_popup'>*(1 &lt;&lt;20)</span></span>) ? (1 <span class='macro'>KB<span class='macro_popup'>*(1 &lt;&lt;10)</span></span>) : (1 <span class='macro'>MB<span class='macro_popup'>*(1 &lt;&lt;20)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2727"><td class="num" id="LN2727">2727</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span>* <span class='keyword'>const</span> unitStr = info-&gt;compressedSize &lt; (1 <span class='macro'>MB<span class='macro_popup'>*(1 &lt;&lt;20)</span></span>) ? <span class='string_literal'>"KB"</span> : <span class='string_literal'>"MB"</span>;</td></tr>
<tr class="codeline" data-linenumber="2728"><td class="num" id="LN2728">2728</td><td class="line">    <span class='keyword'>double</span> <span class='keyword'>const</span> windowSizeUnit = (<span class='keyword'>double</span>)info-&gt;windowSize / unit;</td></tr>
<tr class="codeline" data-linenumber="2729"><td class="num" id="LN2729">2729</td><td class="line">    <span class='keyword'>double</span> <span class='keyword'>const</span> compressedSizeUnit = (<span class='keyword'>double</span>)info-&gt;compressedSize / unit;</td></tr>
<tr class="codeline" data-linenumber="2730"><td class="num" id="LN2730">2730</td><td class="line">    <span class='keyword'>double</span> <span class='keyword'>const</span> decompressedSizeUnit = (<span class='keyword'>double</span>)info-&gt;decompressedSize / unit;</td></tr>
<tr class="codeline" data-linenumber="2731"><td class="num" id="LN2731">2731</td><td class="line">    <span class='keyword'>double</span> <span class='keyword'>const</span> ratio = (info-&gt;compressedSize == 0) ? 0 : ((<span class='keyword'>double</span>)info-&gt;decompressedSize)/info-&gt;compressedSize;</td></tr>
<tr class="codeline" data-linenumber="2732"><td class="num" id="LN2732">2732</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span>* <span class='keyword'>const</span> checkString = (info-&gt;usesCheck ? <span class='string_literal'>"XXH64"</span> : <span class='string_literal'>"None"</span>);</td></tr>
<tr class="codeline" data-linenumber="2733"><td class="num" id="LN2733">2733</td><td class="line">    <span class='keyword'>if</span> (displayLevel &lt;= 2) {</td></tr>
<tr class="codeline" data-linenumber="2734"><td class="num" id="LN2734">2734</td><td class="line">        <span class='keyword'>if</span> (!info-&gt;decompUnavailable) {</td></tr>
<tr class="codeline" data-linenumber="2735"><td class="num" id="LN2735">2735</td><td class="line">            <span class='macro'>DISPLAYOUT(<span class='string_literal'>"%6d  %5d  %7.2f %2s  %9.2f %2s  %5.3f  %5s  %s\n"</span>,<span class='macro_popup'>fprintf(stdout, "%6d  %5d  %7.2f %2s  %9.2f %2s  %5.3f  %5s  %s\n"<br>, info-&gt;numSkippableFrames + info-&gt;numActualFrames, info<br>-&gt;numSkippableFrames, compressedSizeUnit, unitStr, decompressedSizeUnit<br>, unitStr, ratio, checkString, inFileName)</span></span></td></tr>
<tr class="codeline" data-linenumber="2736"><td class="num" id="LN2736">2736</td><td class="line">                    <span class='macro'>info-&gt;numSkippableFrames + info-&gt;numActualFrames,<span class='macro_popup'>fprintf(stdout, "%6d  %5d  %7.2f %2s  %9.2f %2s  %5.3f  %5s  %s\n"<br>, info-&gt;numSkippableFrames + info-&gt;numActualFrames, info<br>-&gt;numSkippableFrames, compressedSizeUnit, unitStr, decompressedSizeUnit<br>, unitStr, ratio, checkString, inFileName)</span></span></td></tr>
<tr class="codeline" data-linenumber="2737"><td class="num" id="LN2737">2737</td><td class="line">                    <span class='macro'>info-&gt;numSkippableFrames,<span class='macro_popup'>fprintf(stdout, "%6d  %5d  %7.2f %2s  %9.2f %2s  %5.3f  %5s  %s\n"<br>, info-&gt;numSkippableFrames + info-&gt;numActualFrames, info<br>-&gt;numSkippableFrames, compressedSizeUnit, unitStr, decompressedSizeUnit<br>, unitStr, ratio, checkString, inFileName)</span></span></td></tr>
<tr class="codeline" data-linenumber="2738"><td class="num" id="LN2738">2738</td><td class="line">                    <span class='macro'>compressedSizeUnit, unitStr, decompressedSizeUnit, unitStr,<span class='macro_popup'>fprintf(stdout, "%6d  %5d  %7.2f %2s  %9.2f %2s  %5.3f  %5s  %s\n"<br>, info-&gt;numSkippableFrames + info-&gt;numActualFrames, info<br>-&gt;numSkippableFrames, compressedSizeUnit, unitStr, decompressedSizeUnit<br>, unitStr, ratio, checkString, inFileName)</span></span></td></tr>
<tr class="codeline" data-linenumber="2739"><td class="num" id="LN2739">2739</td><td class="line">                    <span class='macro'>ratio, checkString, inFileName)<span class='macro_popup'>fprintf(stdout, "%6d  %5d  %7.2f %2s  %9.2f %2s  %5.3f  %5s  %s\n"<br>, info-&gt;numSkippableFrames + info-&gt;numActualFrames, info<br>-&gt;numSkippableFrames, compressedSizeUnit, unitStr, decompressedSizeUnit<br>, unitStr, ratio, checkString, inFileName)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2740"><td class="num" id="LN2740">2740</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2741"><td class="num" id="LN2741">2741</td><td class="line">            <span class='macro'>DISPLAYOUT(<span class='string_literal'>"%6d  %5d  %7.2f %2s                       %5s  %s\n"</span>,<span class='macro_popup'>fprintf(stdout, "%6d  %5d  %7.2f %2s                       %5s  %s\n"<br>, info-&gt;numSkippableFrames + info-&gt;numActualFrames, info<br>-&gt;numSkippableFrames, compressedSizeUnit, unitStr, checkString<br>, inFileName)</span></span></td></tr>
<tr class="codeline" data-linenumber="2742"><td class="num" id="LN2742">2742</td><td class="line">                    <span class='macro'>info-&gt;numSkippableFrames + info-&gt;numActualFrames,<span class='macro_popup'>fprintf(stdout, "%6d  %5d  %7.2f %2s                       %5s  %s\n"<br>, info-&gt;numSkippableFrames + info-&gt;numActualFrames, info<br>-&gt;numSkippableFrames, compressedSizeUnit, unitStr, checkString<br>, inFileName)</span></span></td></tr>
<tr class="codeline" data-linenumber="2743"><td class="num" id="LN2743">2743</td><td class="line">                    <span class='macro'>info-&gt;numSkippableFrames,<span class='macro_popup'>fprintf(stdout, "%6d  %5d  %7.2f %2s                       %5s  %s\n"<br>, info-&gt;numSkippableFrames + info-&gt;numActualFrames, info<br>-&gt;numSkippableFrames, compressedSizeUnit, unitStr, checkString<br>, inFileName)</span></span></td></tr>
<tr class="codeline" data-linenumber="2744"><td class="num" id="LN2744">2744</td><td class="line">                    <span class='macro'>compressedSizeUnit, unitStr,<span class='macro_popup'>fprintf(stdout, "%6d  %5d  %7.2f %2s                       %5s  %s\n"<br>, info-&gt;numSkippableFrames + info-&gt;numActualFrames, info<br>-&gt;numSkippableFrames, compressedSizeUnit, unitStr, checkString<br>, inFileName)</span></span></td></tr>
<tr class="codeline" data-linenumber="2745"><td class="num" id="LN2745">2745</td><td class="line">                    <span class='macro'>checkString, inFileName)<span class='macro_popup'>fprintf(stdout, "%6d  %5d  %7.2f %2s                       %5s  %s\n"<br>, info-&gt;numSkippableFrames + info-&gt;numActualFrames, info<br>-&gt;numSkippableFrames, compressedSizeUnit, unitStr, checkString<br>, inFileName)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2746"><td class="num" id="LN2746">2746</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2747"><td class="num" id="LN2747">2747</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2748"><td class="num" id="LN2748">2748</td><td class="line">        <span class='macro'>DISPLAYOUT(<span class='string_literal'>"%s \n"</span>, inFileName)<span class='macro_popup'>fprintf(stdout, "%s \n", inFileName)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2749"><td class="num" id="LN2749">2749</td><td class="line">        <span class='macro'>DISPLAYOUT(<span class='string_literal'>"# Zstandard Frames: %d\n"</span>, info-&gt;numActualFrames)<span class='macro_popup'>fprintf(stdout, "# Zstandard Frames: %d\n", info-&gt;numActualFrames<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2750"><td class="num" id="LN2750">2750</td><td class="line">        <span class='keyword'>if</span> (info-&gt;numSkippableFrames)</td></tr>
<tr class="codeline" data-linenumber="2751"><td class="num" id="LN2751">2751</td><td class="line">            <span class='macro'>DISPLAYOUT(<span class='string_literal'>"# Skippable Frames: %d\n"</span>, info-&gt;numSkippableFrames)<span class='macro_popup'>fprintf(stdout, "# Skippable Frames: %d\n", info-&gt;numSkippableFrames<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2752"><td class="num" id="LN2752">2752</td><td class="line">        <span class='macro'>DISPLAYOUT(<span class='string_literal'>"Window Size: %.2f %2s (%llu B)\n"</span>,<span class='macro_popup'>fprintf(stdout, "Window Size: %.2f %2s (%llu B)\n", windowSizeUnit<br>, unitStr, (unsigned long long)info-&gt;windowSize)</span></span></td></tr>
<tr class="codeline" data-linenumber="2753"><td class="num" id="LN2753">2753</td><td class="line">                   <span class='macro'>windowSizeUnit, unitStr,<span class='macro_popup'>fprintf(stdout, "Window Size: %.2f %2s (%llu B)\n", windowSizeUnit<br>, unitStr, (unsigned long long)info-&gt;windowSize)</span></span></td></tr>
<tr class="codeline" data-linenumber="2754"><td class="num" id="LN2754">2754</td><td class="line">                   <span class='macro'>(<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>)info-&gt;windowSize)<span class='macro_popup'>fprintf(stdout, "Window Size: %.2f %2s (%llu B)\n", windowSizeUnit<br>, unitStr, (unsigned long long)info-&gt;windowSize)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2755"><td class="num" id="LN2755">2755</td><td class="line">        <span class='macro'>DISPLAYOUT(<span class='string_literal'>"Compressed Size: %.2f %2s (%llu B)\n"</span>,<span class='macro_popup'>fprintf(stdout, "Compressed Size: %.2f %2s (%llu B)\n", compressedSizeUnit<br>, unitStr, (unsigned long long)info-&gt;compressedSize)</span></span></td></tr>
<tr class="codeline" data-linenumber="2756"><td class="num" id="LN2756">2756</td><td class="line">                    <span class='macro'>compressedSizeUnit, unitStr,<span class='macro_popup'>fprintf(stdout, "Compressed Size: %.2f %2s (%llu B)\n", compressedSizeUnit<br>, unitStr, (unsigned long long)info-&gt;compressedSize)</span></span></td></tr>
<tr class="codeline" data-linenumber="2757"><td class="num" id="LN2757">2757</td><td class="line">                    <span class='macro'>(<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>)info-&gt;compressedSize)<span class='macro_popup'>fprintf(stdout, "Compressed Size: %.2f %2s (%llu B)\n", compressedSizeUnit<br>, unitStr, (unsigned long long)info-&gt;compressedSize)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2758"><td class="num" id="LN2758">2758</td><td class="line">        <span class='keyword'>if</span> (!info-&gt;decompUnavailable) {</td></tr>
<tr class="codeline" data-linenumber="2759"><td class="num" id="LN2759">2759</td><td class="line">            <span class='macro'>DISPLAYOUT(<span class='string_literal'>"Decompressed Size: %.2f %2s (%llu B)\n"</span>,<span class='macro_popup'>fprintf(stdout, "Decompressed Size: %.2f %2s (%llu B)\n", decompressedSizeUnit<br>, unitStr, (unsigned long long)info-&gt;decompressedSize)</span></span></td></tr>
<tr class="codeline" data-linenumber="2760"><td class="num" id="LN2760">2760</td><td class="line">                    <span class='macro'>decompressedSizeUnit, unitStr,<span class='macro_popup'>fprintf(stdout, "Decompressed Size: %.2f %2s (%llu B)\n", decompressedSizeUnit<br>, unitStr, (unsigned long long)info-&gt;decompressedSize)</span></span></td></tr>
<tr class="codeline" data-linenumber="2761"><td class="num" id="LN2761">2761</td><td class="line">                    <span class='macro'>(<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>)info-&gt;decompressedSize)<span class='macro_popup'>fprintf(stdout, "Decompressed Size: %.2f %2s (%llu B)\n", decompressedSizeUnit<br>, unitStr, (unsigned long long)info-&gt;decompressedSize)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2762"><td class="num" id="LN2762">2762</td><td class="line">            <span class='macro'>DISPLAYOUT(<span class='string_literal'>"Ratio: %.4f\n"</span>, ratio)<span class='macro_popup'>fprintf(stdout, "Ratio: %.4f\n", ratio)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2763"><td class="num" id="LN2763">2763</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2764"><td class="num" id="LN2764">2764</td><td class="line">        <span class='macro'>DISPLAYOUT(<span class='string_literal'>"Check: %s\n"</span>, checkString)<span class='macro_popup'>fprintf(stdout, "Check: %s\n", checkString)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2765"><td class="num" id="LN2765">2765</td><td class="line">        <span class='macro'>DISPLAYOUT(<span class='string_literal'>"\n"</span>)<span class='macro_popup'>fprintf(stdout, "\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2766"><td class="num" id="LN2766">2766</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2767"><td class="num" id="LN2767">2767</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2768"><td class="num" id="LN2768">2768</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2769"><td class="num" id="LN2769">2769</td><td class="line"><span class='keyword'>static</span> fileInfo_t FIO_addFInfo(fileInfo_t fi1, fileInfo_t fi2)</td></tr>
<tr class="codeline" data-linenumber="2770"><td class="num" id="LN2770">2770</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2771"><td class="num" id="LN2771">2771</td><td class="line">    fileInfo_t total;</td></tr>
<tr class="codeline" data-linenumber="2772"><td class="num" id="LN2772">2772</td><td class="line">    memset(&amp;total, 0, <span class='keyword'>sizeof</span>(total));</td></tr>
<tr class="codeline" data-linenumber="2773"><td class="num" id="LN2773">2773</td><td class="line">    total.numActualFrames = fi1.numActualFrames + fi2.numActualFrames;</td></tr>
<tr class="codeline" data-linenumber="2774"><td class="num" id="LN2774">2774</td><td class="line">    total.numSkippableFrames = fi1.numSkippableFrames + fi2.numSkippableFrames;</td></tr>
<tr class="codeline" data-linenumber="2775"><td class="num" id="LN2775">2775</td><td class="line">    total.compressedSize = fi1.compressedSize + fi2.compressedSize;</td></tr>
<tr class="codeline" data-linenumber="2776"><td class="num" id="LN2776">2776</td><td class="line">    total.decompressedSize = fi1.decompressedSize + fi2.decompressedSize;</td></tr>
<tr class="codeline" data-linenumber="2777"><td class="num" id="LN2777">2777</td><td class="line">    total.decompUnavailable = fi1.decompUnavailable | fi2.decompUnavailable;</td></tr>
<tr class="codeline" data-linenumber="2778"><td class="num" id="LN2778">2778</td><td class="line">    total.usesCheck = fi1.usesCheck &amp; fi2.usesCheck;</td></tr>
<tr class="codeline" data-linenumber="2779"><td class="num" id="LN2779">2779</td><td class="line">    total.nbFiles = fi1.nbFiles + fi2.nbFiles;</td></tr>
<tr class="codeline" data-linenumber="2780"><td class="num" id="LN2780">2780</td><td class="line">    <span class='keyword'>return</span> total;</td></tr>
<tr class="codeline" data-linenumber="2781"><td class="num" id="LN2781">2781</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2782"><td class="num" id="LN2782">2782</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2783"><td class="num" id="LN2783">2783</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="2784"><td class="num" id="LN2784">2784</td><td class="line">FIO_listFile(fileInfo_t* total, <span class='keyword'>const</span> <span class='keyword'>char</span>* inFileName, <span class='keyword'>int</span> displayLevel)</td></tr>
<tr class="codeline" data-linenumber="2785"><td class="num" id="LN2785">2785</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2786"><td class="num" id="LN2786">2786</td><td class="line">    fileInfo_t info;</td></tr>
<tr class="codeline" data-linenumber="2787"><td class="num" id="LN2787">2787</td><td class="line">    memset(&amp;info, 0, <span class='keyword'>sizeof</span>(info));</td></tr>
<tr class="codeline" data-linenumber="2788"><td class="num" id="LN2788">2788</td><td class="line">    {   InfoError <span class='keyword'>const</span> error = getFileInfo(&amp;info, inFileName);</td></tr>
<tr class="codeline" data-linenumber="2789"><td class="num" id="LN2789">2789</td><td class="line">        <span class='keyword'>switch</span> (error) {</td></tr>
<tr class="codeline" data-linenumber="2790"><td class="num" id="LN2790">2790</td><td class="line">            <span class='keyword'>case</span> info_frame_error:</td></tr>
<tr class="codeline" data-linenumber="2791"><td class="num" id="LN2791">2791</td><td class="line">                <span class='comment'>/* display error, but provide output */</span></td></tr>
<tr class="codeline" data-linenumber="2792"><td class="num" id="LN2792">2792</td><td class="line">                <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"Error while parsing \"%s\" \n"</span>, inFileName)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "Error while parsing \"%s\" \n"<br>, inFileName); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2793"><td class="num" id="LN2793">2793</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2794"><td class="num" id="LN2794">2794</td><td class="line">            <span class='keyword'>case</span> info_not_zstd:</td></tr>
<tr class="codeline" data-linenumber="2795"><td class="num" id="LN2795">2795</td><td class="line">                <span class='macro'>DISPLAYOUT(<span class='string_literal'>"File \"%s\" not compressed by zstd \n"</span>, inFileName)<span class='macro_popup'>fprintf(stdout, "File \"%s\" not compressed by zstd \n", inFileName<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2796"><td class="num" id="LN2796">2796</td><td class="line">                <span class='keyword'>if</span> (displayLevel &gt; 2) <span class='macro'>DISPLAYOUT(<span class='string_literal'>"\n"</span>)<span class='macro_popup'>fprintf(stdout, "\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2797"><td class="num" id="LN2797">2797</td><td class="line">                <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2798"><td class="num" id="LN2798">2798</td><td class="line">            <span class='keyword'>case</span> info_file_error:</td></tr>
<tr class="codeline" data-linenumber="2799"><td class="num" id="LN2799">2799</td><td class="line">                <span class='comment'>/* error occurred while opening the file */</span></td></tr>
<tr class="codeline" data-linenumber="2800"><td class="num" id="LN2800">2800</td><td class="line">                <span class='keyword'>if</span> (displayLevel &gt; 2) <span class='macro'>DISPLAYOUT(<span class='string_literal'>"\n"</span>)<span class='macro_popup'>fprintf(stdout, "\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2801"><td class="num" id="LN2801">2801</td><td class="line">                <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2802"><td class="num" id="LN2802">2802</td><td class="line">            <span class='keyword'>case</span> info_truncated_input:</td></tr>
<tr class="codeline" data-linenumber="2803"><td class="num" id="LN2803">2803</td><td class="line">                <span class='macro'>DISPLAYOUT(<span class='string_literal'>"File \"%s\" is truncated \n"</span>, inFileName)<span class='macro_popup'>fprintf(stdout, "File \"%s\" is truncated \n", inFileName)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2804"><td class="num" id="LN2804">2804</td><td class="line">                <span class='keyword'>if</span> (displayLevel &gt; 2) <span class='macro'>DISPLAYOUT(<span class='string_literal'>"\n"</span>)<span class='macro_popup'>fprintf(stdout, "\n")</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2805"><td class="num" id="LN2805">2805</td><td class="line">                <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2806"><td class="num" id="LN2806">2806</td><td class="line">            <span class='keyword'>case</span> info_success:</td></tr>
<tr class="codeline" data-linenumber="2807"><td class="num" id="LN2807">2807</td><td class="line">            <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="2808"><td class="num" id="LN2808">2808</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2809"><td class="num" id="LN2809">2809</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2810"><td class="num" id="LN2810">2810</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2811"><td class="num" id="LN2811">2811</td><td class="line">        displayInfo(inFileName, &amp;info, displayLevel);</td></tr>
<tr class="codeline" data-linenumber="2812"><td class="num" id="LN2812">2812</td><td class="line">        *total = FIO_addFInfo(*total, info);</td></tr>
<tr class="codeline" data-linenumber="2813"><td class="num" id="LN2813">2813</td><td class="line">        <span class='macro'>assert(error == info_success || error == info_frame_error)<span class='macro_popup'>((void) sizeof ((error == info_success || error == info_frame_error<br>) ? 1 : 0), __extension__ ({ if (error == info_success || error<br> == info_frame_error) ; else __assert_fail ("error == info_success || error == info_frame_error"<br>, "fileio.c", 2813, __extension__ __PRETTY_FUNCTION__); }))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2814"><td class="num" id="LN2814">2814</td><td class="line">        <span class='keyword'>return</span> (<span class='keyword'>int</span>)error;</td></tr>
<tr class="codeline" data-linenumber="2815"><td class="num" id="LN2815">2815</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2816"><td class="num" id="LN2816">2816</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2817"><td class="num" id="LN2817">2817</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2818"><td class="num" id="LN2818">2818</td><td class="line"><span class='keyword'>int</span> FIO_listMultipleFiles(<span class='keyword'>unsigned</span> numFiles, <span class='keyword'>const</span> <span class='keyword'>char</span>** filenameTable, <span class='keyword'>int</span> displayLevel)</td></tr>
<tr class="codeline" data-linenumber="2819"><td class="num" id="LN2819">2819</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2820"><td class="num" id="LN2820">2820</td><td class="line">    <span class='comment'>/* ensure no specified input is stdin (needs fseek() capability) */</span></td></tr>
<tr class="codeline" data-linenumber="2821"><td class="num" id="LN2821">2821</td><td class="line">    {   <span class='keyword'>unsigned</span> u;</td></tr>
<tr class="codeline" data-linenumber="2822"><td class="num" id="LN2822">2822</td><td class="line">        <span class='keyword'>for</span> (u=0; u&lt;numFiles;u++) {</td></tr>
<tr class="codeline" data-linenumber="2823"><td class="num" id="LN2823">2823</td><td class="line">            <span class='macro'>ERROR_IF(!strcmp (filenameTable[u], stdinmark),<span class='macro_popup'>{ if (!strcmp (filenameTable[u], "/*stdin*\\")) { { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, "zstd: --list does not support reading from standard input"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; return 1; } }</span></span></td></tr>
<tr class="codeline" data-linenumber="2824"><td class="num" id="LN2824">2824</td><td class="line">                    <span class='macro'>1, <span class='string_literal'>"zstd: --list does not support reading from standard input"</span>)<span class='macro_popup'>{ if (!strcmp (filenameTable[u], "/*stdin*\\")) { { if (g_display_prefs<br>.displayLevel&gt;=1) { fprintf(stderr, "zstd: --list does not support reading from standard input"<br>); } }; { if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr<br>, " \n"); } }; return 1; } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2825"><td class="num" id="LN2825">2825</td><td class="line">    }   }</td></tr>
<tr class="codeline" data-linenumber="2826"><td class="num" id="LN2826">2826</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2827"><td class="num" id="LN2827">2827</td><td class="line">    <span class='keyword'>if</span> (numFiles == 0) {</td></tr>
<tr class="codeline" data-linenumber="2828"><td class="num" id="LN2828">2828</td><td class="line">        <span class='keyword'>if</span> (!<span class='macro'>IS_CONSOLE(stdin)<span class='macro_popup'>isatty(fileno(stdin))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2829"><td class="num" id="LN2829">2829</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"zstd: --list does not support reading from standard input \n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "zstd: --list does not support reading from standard input \n"<br>); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2830"><td class="num" id="LN2830">2830</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2831"><td class="num" id="LN2831">2831</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"No files given \n"</span>)<span class='macro_popup'>{ if (g_display_prefs.displayLevel&gt;=1) { fprintf(stderr, "No files given \n"<br>); } }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2832"><td class="num" id="LN2832">2832</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2833"><td class="num" id="LN2833">2833</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2834"><td class="num" id="LN2834">2834</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2835"><td class="num" id="LN2835">2835</td><td class="line">    <span class='keyword'>if</span> (displayLevel &lt;= 2) {</td></tr>
<tr class="codeline" data-linenumber="2836"><td class="num" id="LN2836">2836</td><td class="line">        <span class='macro'>DISPLAYOUT(<span class='string_literal'>"Frames  Skips  Compressed  Uncompressed  Ratio  Check  Filename\n"</span>)<span class='macro_popup'>fprintf(stdout, "Frames  Skips  Compressed  Uncompressed  Ratio  Check  Filename\n"<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2837"><td class="num" id="LN2837">2837</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2838"><td class="num" id="LN2838">2838</td><td class="line">    {   <span class='keyword'>int</span> error = 0;</td></tr>
<tr class="codeline" data-linenumber="2839"><td class="num" id="LN2839">2839</td><td class="line">        fileInfo_t total;</td></tr>
<tr class="codeline" data-linenumber="2840"><td class="num" id="LN2840">2840</td><td class="line">        memset(&amp;total, 0, <span class='keyword'>sizeof</span>(total));</td></tr>
<tr class="codeline" data-linenumber="2841"><td class="num" id="LN2841">2841</td><td class="line">        total.usesCheck = 1;</td></tr>
<tr class="codeline" data-linenumber="2842"><td class="num" id="LN2842">2842</td><td class="line">        <span class='comment'>/* --list each file, and check for any error */</span></td></tr>
<tr class="codeline" data-linenumber="2843"><td class="num" id="LN2843">2843</td><td class="line">        {   <span class='keyword'>unsigned</span> u;</td></tr>
<tr class="codeline" data-linenumber="2844"><td class="num" id="LN2844">2844</td><td class="line">            <span class='keyword'>for</span> (u=0; u&lt;numFiles;u++) {</td></tr>
<tr class="codeline" data-linenumber="2845"><td class="num" id="LN2845">2845</td><td class="line">                error |= FIO_listFile(&amp;total, filenameTable[u], displayLevel);</td></tr>
<tr class="codeline" data-linenumber="2846"><td class="num" id="LN2846">2846</td><td class="line">        }   }</td></tr>
<tr class="codeline" data-linenumber="2847"><td class="num" id="LN2847">2847</td><td class="line">        <span class='keyword'>if</span> (numFiles &gt; 1 &amp;&amp; displayLevel &lt;= 2) {   <span class='comment'>/* display total */</span></td></tr>
<tr class="codeline" data-linenumber="2848"><td class="num" id="LN2848">2848</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>const</span> unit = total.compressedSize &lt; (1 <span class='macro'>MB<span class='macro_popup'>*(1 &lt;&lt;20)</span></span>) ? (1 <span class='macro'>KB<span class='macro_popup'>*(1 &lt;&lt;10)</span></span>) : (1 <span class='macro'>MB<span class='macro_popup'>*(1 &lt;&lt;20)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2849"><td class="num" id="LN2849">2849</td><td class="line">            <span class='keyword'>const</span> <span class='keyword'>char</span>* <span class='keyword'>const</span> unitStr = total.compressedSize &lt; (1 <span class='macro'>MB<span class='macro_popup'>*(1 &lt;&lt;20)</span></span>) ? <span class='string_literal'>"KB"</span> : <span class='string_literal'>"MB"</span>;</td></tr>
<tr class="codeline" data-linenumber="2850"><td class="num" id="LN2850">2850</td><td class="line">            <span class='keyword'>double</span> <span class='keyword'>const</span> compressedSizeUnit = (<span class='keyword'>double</span>)total.compressedSize / unit;</td></tr>
<tr class="codeline" data-linenumber="2851"><td class="num" id="LN2851">2851</td><td class="line">            <span class='keyword'>double</span> <span class='keyword'>const</span> decompressedSizeUnit = (<span class='keyword'>double</span>)total.decompressedSize / unit;</td></tr>
<tr class="codeline" data-linenumber="2852"><td class="num" id="LN2852">2852</td><td class="line">            <span class='keyword'>double</span> <span class='keyword'>const</span> ratio = (total.compressedSize == 0) ? 0 : ((<span class='keyword'>double</span>)total.decompressedSize)/total.compressedSize;</td></tr>
<tr class="codeline" data-linenumber="2853"><td class="num" id="LN2853">2853</td><td class="line">            <span class='keyword'>const</span> <span class='keyword'>char</span>* <span class='keyword'>const</span> checkString = (total.usesCheck ? <span class='string_literal'>"XXH64"</span> : <span class='string_literal'>""</span>);</td></tr>
<tr class="codeline" data-linenumber="2854"><td class="num" id="LN2854">2854</td><td class="line">            <span class='macro'>DISPLAYOUT(<span class='string_literal'>"----------------------------------------------------------------- \n"</span>)<span class='macro_popup'>fprintf(stdout, "----------------------------------------------------------------- \n"<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2855"><td class="num" id="LN2855">2855</td><td class="line">            <span class='keyword'>if</span> (total.decompUnavailable) {</td></tr>
<tr class="codeline" data-linenumber="2856"><td class="num" id="LN2856">2856</td><td class="line">                <span class='macro'>DISPLAYOUT(<span class='string_literal'>"%6d  %5d  %7.2f %2s                       %5s  %u files\n"</span>,<span class='macro_popup'>fprintf(stdout, "%6d  %5d  %7.2f %2s                       %5s  %u files\n"<br>, total.numSkippableFrames + total.numActualFrames, total.numSkippableFrames<br>, compressedSizeUnit, unitStr, checkString, (unsigned)total.nbFiles<br>)</span></span></td></tr>
<tr class="codeline" data-linenumber="2857"><td class="num" id="LN2857">2857</td><td class="line">                        <span class='macro'>total.numSkippableFrames + total.numActualFrames,<span class='macro_popup'>fprintf(stdout, "%6d  %5d  %7.2f %2s                       %5s  %u files\n"<br>, total.numSkippableFrames + total.numActualFrames, total.numSkippableFrames<br>, compressedSizeUnit, unitStr, checkString, (unsigned)total.nbFiles<br>)</span></span></td></tr>
<tr class="codeline" data-linenumber="2858"><td class="num" id="LN2858">2858</td><td class="line">                        <span class='macro'>total.numSkippableFrames,<span class='macro_popup'>fprintf(stdout, "%6d  %5d  %7.2f %2s                       %5s  %u files\n"<br>, total.numSkippableFrames + total.numActualFrames, total.numSkippableFrames<br>, compressedSizeUnit, unitStr, checkString, (unsigned)total.nbFiles<br>)</span></span></td></tr>
<tr class="codeline" data-linenumber="2859"><td class="num" id="LN2859">2859</td><td class="line">                        <span class='macro'>compressedSizeUnit, unitStr,<span class='macro_popup'>fprintf(stdout, "%6d  %5d  %7.2f %2s                       %5s  %u files\n"<br>, total.numSkippableFrames + total.numActualFrames, total.numSkippableFrames<br>, compressedSizeUnit, unitStr, checkString, (unsigned)total.nbFiles<br>)</span></span></td></tr>
<tr class="codeline" data-linenumber="2860"><td class="num" id="LN2860">2860</td><td class="line">                        <span class='macro'>checkString, (<span class='keyword'>unsigned</span>)total.nbFiles)<span class='macro_popup'>fprintf(stdout, "%6d  %5d  %7.2f %2s                       %5s  %u files\n"<br>, total.numSkippableFrames + total.numActualFrames, total.numSkippableFrames<br>, compressedSizeUnit, unitStr, checkString, (unsigned)total.nbFiles<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2861"><td class="num" id="LN2861">2861</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2862"><td class="num" id="LN2862">2862</td><td class="line">                <span class='macro'>DISPLAYOUT(<span class='string_literal'>"%6d  %5d  %7.2f %2s  %9.2f %2s  %5.3f  %5s  %u files\n"</span>,<span class='macro_popup'>fprintf(stdout, "%6d  %5d  %7.2f %2s  %9.2f %2s  %5.3f  %5s  %u files\n"<br>, total.numSkippableFrames + total.numActualFrames, total.numSkippableFrames<br>, compressedSizeUnit, unitStr, decompressedSizeUnit, unitStr,<br> ratio, checkString, (unsigned)total.nbFiles)</span></span></td></tr>
<tr class="codeline" data-linenumber="2863"><td class="num" id="LN2863">2863</td><td class="line">                        <span class='macro'>total.numSkippableFrames + total.numActualFrames,<span class='macro_popup'>fprintf(stdout, "%6d  %5d  %7.2f %2s  %9.2f %2s  %5.3f  %5s  %u files\n"<br>, total.numSkippableFrames + total.numActualFrames, total.numSkippableFrames<br>, compressedSizeUnit, unitStr, decompressedSizeUnit, unitStr,<br> ratio, checkString, (unsigned)total.nbFiles)</span></span></td></tr>
<tr class="codeline" data-linenumber="2864"><td class="num" id="LN2864">2864</td><td class="line">                        <span class='macro'>total.numSkippableFrames,<span class='macro_popup'>fprintf(stdout, "%6d  %5d  %7.2f %2s  %9.2f %2s  %5.3f  %5s  %u files\n"<br>, total.numSkippableFrames + total.numActualFrames, total.numSkippableFrames<br>, compressedSizeUnit, unitStr, decompressedSizeUnit, unitStr,<br> ratio, checkString, (unsigned)total.nbFiles)</span></span></td></tr>
<tr class="codeline" data-linenumber="2865"><td class="num" id="LN2865">2865</td><td class="line">                        <span class='macro'>compressedSizeUnit, unitStr, decompressedSizeUnit, unitStr,<span class='macro_popup'>fprintf(stdout, "%6d  %5d  %7.2f %2s  %9.2f %2s  %5.3f  %5s  %u files\n"<br>, total.numSkippableFrames + total.numActualFrames, total.numSkippableFrames<br>, compressedSizeUnit, unitStr, decompressedSizeUnit, unitStr,<br> ratio, checkString, (unsigned)total.nbFiles)</span></span></td></tr>
<tr class="codeline" data-linenumber="2866"><td class="num" id="LN2866">2866</td><td class="line">                        <span class='macro'>ratio, checkString, (<span class='keyword'>unsigned</span>)total.nbFiles)<span class='macro_popup'>fprintf(stdout, "%6d  %5d  %7.2f %2s  %9.2f %2s  %5.3f  %5s  %u files\n"<br>, total.numSkippableFrames + total.numActualFrames, total.numSkippableFrames<br>, compressedSizeUnit, unitStr, decompressedSizeUnit, unitStr,<br> ratio, checkString, (unsigned)total.nbFiles)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2867"><td class="num" id="LN2867">2867</td><td class="line">        }   }</td></tr>
<tr class="codeline" data-linenumber="2868"><td class="num" id="LN2868">2868</td><td class="line">        <span class='keyword'>return</span> error;</td></tr>
<tr class="codeline" data-linenumber="2869"><td class="num" id="LN2869">2869</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2870"><td class="num" id="LN2870">2870</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2871"><td class="num" id="LN2871">2871</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2872"><td class="num" id="LN2872">2872</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2873"><td class="num" id="LN2873">2873</td><td class="line"><span class='directive'>#endif /* #ifndef ZSTD_NODECOMPRESS */</span></td></tr>
</table></body></html>
