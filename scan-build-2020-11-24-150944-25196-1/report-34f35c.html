<!doctype html>
<html>
<head>
<title>../lib/dictBuilder/zdict.c</title>

<style type="text/css">
body { color:#000000; background-color:#ffffff }
body { font-family:Helvetica, sans-serif; font-size:10pt }
h1 { font-size:14pt }
.FileName { margin-top: 5px; margin-bottom: 5px; display: inline; }
.FileNav { margin-left: 5px; margin-right: 5px; display: inline; }
.FileNav a { text-decoration:none; font-size: larger; }
.divider { margin-top: 30px; margin-bottom: 30px; height: 15px; }
.divider { background-color: gray; }
.code { border-collapse:collapse; width:100%; }
.code { font-family: "Monospace", monospace; font-size:10pt }
.code { line-height: 1.2em }
.comment { color: green; font-style: oblique }
.keyword { color: blue }
.string_literal { color: red }
.directive { color: darkmagenta }

/* Macros and variables could have pop-up notes hidden by default.
  - Macro pop-up:    expansion of the macro
  - Variable pop-up: value (table) of the variable */
.macro_popup, .variable_popup { display: none; }

/* Pop-up appears on mouse-hover event. */
.macro:hover .macro_popup, .variable:hover .variable_popup {
  display: block;
  padding: 2px;
  -webkit-border-radius:5px;
  -webkit-box-shadow:1px 1px 7px #000;
  border-radius:5px;
  box-shadow:1px 1px 7px #000;
  position: absolute;
  top: -1em;
  left:10em;
  z-index: 1
}

.macro_popup {
  border: 2px solid red;
  background-color:#FFF0F0;
  font-weight: normal;
}

.variable_popup {
  border: 2px solid blue;
  background-color:#F0F0FF;
  font-weight: bold;
  font-family: Helvetica, sans-serif;
  font-size: 9pt;
}

/* Pop-up notes needs a relative position as a base where they pops up. */
.macro, .variable {
  background-color: PaleGoldenRod;
  position: relative;
}
.macro { color: DarkMagenta; }

#tooltiphint {
  position: fixed;
  width: 50em;
  margin-left: -25em;
  left: 50%;
  padding: 10px;
  border: 1px solid #b0b0b0;
  border-radius: 2px;
  box-shadow: 1px 1px 7px black;
  background-color: #c0c0c0;
  z-index: 2;
}

.num { width:2.5em; padding-right:2ex; background-color:#eeeeee }
.num { text-align:right; font-size:8pt }
.num { color:#444444 }
.line { padding-left: 1ex; border-left: 3px solid #ccc }
.line { white-space: pre }
.msg { -webkit-box-shadow:1px 1px 7px #000 }
.msg { box-shadow:1px 1px 7px #000 }
.msg { -webkit-border-radius:5px }
.msg { border-radius:5px }
.msg { font-family:Helvetica, sans-serif; font-size:8pt }
.msg { float:left }
.msg { padding:0.25em 1ex 0.25em 1ex }
.msg { margin-top:10px; margin-bottom:10px }
.msg { font-weight:bold }
.msg { max-width:60em; word-wrap: break-word; white-space: pre-wrap }
.msgT { padding:0x; spacing:0x }
.msgEvent { background-color:#fff8b4; color:#000000 }
.msgControl { background-color:#bbbbbb; color:#000000 }
.msgNote { background-color:#ddeeff; color:#000000 }
.mrange { background-color:#dfddf3 }
.mrange { border-bottom:1px solid #6F9DBE }
.PathIndex { font-weight: bold; padding:0px 5px; margin-right:5px; }
.PathIndex { -webkit-border-radius:8px }
.PathIndex { border-radius:8px }
.PathIndexEvent { background-color:#bfba87 }
.PathIndexControl { background-color:#8c8c8c }
.PathIndexPopUp { background-color: #879abc; }
.PathNav a { text-decoration:none; font-size: larger }
.CodeInsertionHint { font-weight: bold; background-color: #10dd10 }
.CodeRemovalHint { background-color:#de1010 }
.CodeRemovalHint { border-bottom:1px solid #6F9DBE }
.selected{ background-color:orange !important; }

table.simpletable {
  padding: 5px;
  font-size:12pt;
  margin:20px;
  border-collapse: collapse; border-spacing: 0px;
}
td.rowname {
  text-align: right;
  vertical-align: top;
  font-weight: bold;
  color:#444444;
  padding-right:2ex;
}

/* Hidden text. */
input.spoilerhider + label {
  cursor: pointer;
  text-decoration: underline;
  display: block;
}
input.spoilerhider {
 display: none;
}
input.spoilerhider ~ .spoiler {
  overflow: hidden;
  margin: 10px auto 0;
  height: 0;
  opacity: 0;
}
input.spoilerhider:checked + label + .spoiler{
  height: auto;
  opacity: 1;
}
</style>
</head>
<body>
<!-- BUGDESC Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11 -->

<!-- BUGTYPE Potential insecure memory buffer bounds restriction in call 'memcpy' -->

<!-- BUGCATEGORY Security -->

<!-- BUGFILE /tmp/sslab_clang/c_zstd/zstd/programs/../lib/dictBuilder/zdict.c -->

<!-- FILENAME zdict.c -->

<!-- FUNCTIONNAME ZDICT_trainFromBuffer_legacy -->

<!-- ISSUEHASHCONTENTOFLINEINCONTEXT 1a8b71896268cb4dd7807a4f1b38dd16 -->

<!-- BUGLINE 1098 -->

<!-- BUGCOLUMN 5 -->

<!-- BUGPATHLENGTH 1 -->

<!-- BUGMETAEND -->
<!-- REPORTHEADER -->
<h3>Bug Summary</h3>
<table class="simpletable">
<tr><td class="rowname">File:</td><td>programs/../lib/dictBuilder/zdict.c</td></tr>
<tr><td class="rowname">Warning:</td><td><a href="#EndPath">line 1098, column 5</a><br />Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11</td></tr>

</table>
<!-- REPORTSUMMARYEXTRA -->
<h3>Annotated Source Code</h3>
<p>Press <a href="#" onclick="toggleHelp(); return false;">'?'</a>
   to see keyboard shortcuts</p>
<input type="checkbox" class="spoilerhider" id="showinvocation" />
<label for="showinvocation" >Show analyzer invocation</label>
<div class="spoiler">clang -cc1 -cc1 -triple x86_64-unknown-linux-gnu -analyze -disable-free -main-file-name zdict.c -analyzer-store=region -analyzer-opt-analyze-nested-blocks -analyzer-checker=core -analyzer-checker=apiModeling -analyzer-checker=unix -analyzer-checker=deadcode -analyzer-checker=security.insecureAPI.UncheckedReturn -analyzer-checker=security.insecureAPI.getpw -analyzer-checker=security.insecureAPI.gets -analyzer-checker=security.insecureAPI.mktemp -analyzer-checker=security.insecureAPI.mkstemp -analyzer-checker=security.insecureAPI.vfork -analyzer-checker=nullability.NullPassedToNonnull -analyzer-checker=nullability.NullReturnedFromNonnull -analyzer-output plist -w -setup-static-analyzer -mrelocation-model static -mframe-pointer=none -fmath-errno -fno-rounding-math -mconstructor-aliases -munwind-tables -target-cpu x86-64 -fno-split-dwarf-inlining -debugger-tuning=gdb -resource-dir /llvm-project/build/lib/clang/12.0.0 -D XXH_NAMESPACE=ZSTD_ -D ZSTD_MULTITHREAD -D ZSTD_GZCOMPRESS -D ZSTD_GZDECOMPRESS -D ZSTD_LZMACOMPRESS -D ZSTD_LZMADECOMPRESS -D ZSTD_LZ4COMPRESS -D ZSTD_LZ4DECOMPRESS -D ZSTD_LEGACY_SUPPORT=5 -D BACKTRACE_ENABLE=0 -internal-isystem /usr/local/include -internal-isystem /llvm-project/build/lib/clang/12.0.0/include -internal-externc-isystem /usr/include/x86_64-linux-gnu -internal-externc-isystem /include -internal-externc-isystem /usr/include -O3 -fdebug-compilation-dir /tmp/sslab_clang/c_zstd/zstd/programs -ferror-limit 19 -fgnuc-version=4.2.1 -vectorize-loops -vectorize-slp -analyzer-checker core -analyzer-checker cplusplus -analyzer-checker nullability -analyzer-checker optin -analyzer-checker security -analyzer-checker unix -analyzer-checker osx -analyzer-checker fuchsia -analyzer-checker webkit -analyzer-output=html -faddrsig -o /tmp/scan-build-2020-11-24-150944-25196-1 -x c ../lib/dictBuilder/zdict.c
</div>
<div id='tooltiphint' hidden="true">
  <p>Keyboard shortcuts: </p>
  <ul>
    <li>Use 'j/k' keys for keyboard navigation</li>
    <li>Use 'Shift+S' to show/hide relevant lines</li>
    <li>Use '?' to toggle this window</li>
  </ul>
  <a href="#" onclick="toggleHelp(); return false;">Close</a>
</div>
<script type='text/javascript'>
var relevant_lines = {"1": {"1098": 1}};

var filterCounterexample = function (hide) {
  var tables = document.getElementsByClassName("code");
  for (var t=0; t<tables.length; t++) {
    var table = tables[t];
    var file_id = table.getAttribute("data-fileid");
    var lines_in_fid = relevant_lines[file_id];
    if (!lines_in_fid) {
      lines_in_fid = {};
    }
    var lines = table.getElementsByClassName("codeline");
    for (var i=0; i<lines.length; i++) {
        var el = lines[i];
        var lineNo = el.getAttribute("data-linenumber");
        if (!lines_in_fid[lineNo]) {
          if (hide) {
            el.setAttribute("hidden", "");
          } else {
            el.removeAttribute("hidden");
          }
        }
    }
  }
}

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "S") {
    var checked = document.getElementsByName("showCounterexample")[0].checked;
    filterCounterexample(!checked);
    document.getElementsByName("showCounterexample")[0].checked = !checked;
  } else {
    return;
  }
  event.preventDefault();
}, true);

document.addEventListener("DOMContentLoaded", function() {
    document.querySelector('input[name="showCounterexample"]').onchange=
        function (event) {
      filterCounterexample(this.checked);
    };
});
</script>

<form>
    <input type="checkbox" name="showCounterexample" id="showCounterexample" />
    <label for="showCounterexample">
       Show only relevant lines
    </label>
</form>

<script type='text/javascript'>
var digitMatcher = new RegExp("[0-9]+");

var querySelectorAllArray = function(selector) {
  return Array.prototype.slice.call(
    document.querySelectorAll(selector));
}

document.addEventListener("DOMContentLoaded", function() {
    querySelectorAllArray(".PathNav > a").forEach(
        function(currentValue, currentIndex) {
            var hrefValue = currentValue.getAttribute("href");
            currentValue.onclick = function() {
                scrollTo(document.querySelector(hrefValue));
                return false;
            };
        });
});

var findNum = function() {
    var s = document.querySelector(".selected");
    if (!s || s.id == "EndPath") {
        return 0;
    }
    var out = parseInt(digitMatcher.exec(s.id)[0]);
    return out;
};

var scrollTo = function(el) {
    querySelectorAllArray(".selected").forEach(function(s) {
        s.classList.remove("selected");
    });
    el.classList.add("selected");
    window.scrollBy(0, el.getBoundingClientRect().top -
        (window.innerHeight / 2));
}

var move = function(num, up, numItems) {
  if (num == 1 && up || num == numItems - 1 && !up) {
    return 0;
  } else if (num == 0 && up) {
    return numItems - 1;
  } else if (num == 0 && !up) {
    return 1 % numItems;
  }
  return up ? num - 1 : num + 1;
}

var numToId = function(num) {
  if (num == 0) {
    return document.getElementById("EndPath")
  }
  return document.getElementById("Path" + num);
};

var navigateTo = function(up) {
  var numItems = document.querySelectorAll(
      ".line > .msgEvent, .line > .msgControl").length;
  var currentSelected = findNum();
  var newSelected = move(currentSelected, up, numItems);
  var newEl = numToId(newSelected, numItems);

  // Scroll element into center.
  scrollTo(newEl);
};

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "j") {
    navigateTo(/*up=*/false);
  } else if (event.key == "k") {
    navigateTo(/*up=*/true);
  } else {
    return;
  }
  event.preventDefault();
}, true);
</script>
  
<script type='text/javascript'>

var toggleHelp = function() {
    var hint = document.querySelector("#tooltiphint");
    var attributeName = "hidden";
    if (hint.hasAttribute(attributeName)) {
      hint.removeAttribute(attributeName);
    } else {
      hint.setAttribute("hidden", "true");
    }
};
window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "?") {
    toggleHelp();
  } else {
    return;
  }
  event.preventDefault();
});
</script>
<table class="code" data-fileid="1">
<tr class="codeline" data-linenumber="1"><td class="num" id="LN1">1</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2"><td class="num" id="LN2">2</td><td class="line"> <span class='comment'>* Copyright (c) 2016-2020, Yann Collet, Facebook, Inc.</span></td></tr>
<tr class="codeline" data-linenumber="3"><td class="num" id="LN3">3</td><td class="line"> <span class='comment'>* All rights reserved.</span></td></tr>
<tr class="codeline" data-linenumber="4"><td class="num" id="LN4">4</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="5"><td class="num" id="LN5">5</td><td class="line"> <span class='comment'>* This source code is licensed under both the BSD-style license (found in the</span></td></tr>
<tr class="codeline" data-linenumber="6"><td class="num" id="LN6">6</td><td class="line"> <span class='comment'>* LICENSE file in the root directory of this source tree) and the GPLv2 (found</span></td></tr>
<tr class="codeline" data-linenumber="7"><td class="num" id="LN7">7</td><td class="line"> <span class='comment'>* in the COPYING file in the root directory of this source tree).</span></td></tr>
<tr class="codeline" data-linenumber="8"><td class="num" id="LN8">8</td><td class="line"> <span class='comment'>* You may select, at your option, one of the above-listed licenses.</span></td></tr>
<tr class="codeline" data-linenumber="9"><td class="num" id="LN9">9</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="10"><td class="num" id="LN10">10</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="11"><td class="num" id="LN11">11</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="12"><td class="num" id="LN12">12</td><td class="line"><span class='comment'>/*-**************************************</span></td></tr>
<tr class="codeline" data-linenumber="13"><td class="num" id="LN13">13</td><td class="line"><span class='comment'>*  Tuning parameters</span></td></tr>
<tr class="codeline" data-linenumber="14"><td class="num" id="LN14">14</td><td class="line"><span class='comment'>****************************************/</span></td></tr>
<tr class="codeline" data-linenumber="15"><td class="num" id="LN15">15</td><td class="line"><span class='directive'>#define <span class='macro'>MINRATIO<span class='macro_popup'>4</span></span> 4   /* minimum nb of apparition to be selected in dictionary */</span></td></tr>
<tr class="codeline" data-linenumber="16"><td class="num" id="LN16">16</td><td class="line"><span class='directive'>#define <span class='macro'>ZDICT_MAX_SAMPLES_SIZE<span class='macro_popup'>(2000U &lt;&lt; 20)</span></span> (2000U &lt;&lt; 20)</span></td></tr>
<tr class="codeline" data-linenumber="17"><td class="num" id="LN17">17</td><td class="line"><span class='directive'>#define <span class='macro'>ZDICT_MIN_SAMPLES_SIZE<span class='macro_popup'>(128 * 4)</span></span> (<span class='macro'>ZDICT_CONTENTSIZE_MIN<span class='macro_popup'>128</span></span> * <span class='macro'>MINRATIO<span class='macro_popup'>4</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="18"><td class="num" id="LN18">18</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="19"><td class="num" id="LN19">19</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="20"><td class="num" id="LN20">20</td><td class="line"><span class='comment'>/*-**************************************</span></td></tr>
<tr class="codeline" data-linenumber="21"><td class="num" id="LN21">21</td><td class="line"><span class='comment'>*  Compiler Options</span></td></tr>
<tr class="codeline" data-linenumber="22"><td class="num" id="LN22">22</td><td class="line"><span class='comment'>****************************************/</span></td></tr>
<tr class="codeline" data-linenumber="23"><td class="num" id="LN23">23</td><td class="line"><span class='comment'>/* Unix Large Files support (&gt;4GB) */</span></td></tr>
<tr class="codeline" data-linenumber="24"><td class="num" id="LN24">24</td><td class="line"><span class='directive'>#define <span class='macro'>_FILE_OFFSET_BITS<span class='macro_popup'>64</span></span> 64</span></td></tr>
<tr class="codeline" data-linenumber="25"><td class="num" id="LN25">25</td><td class="line"><span class='directive'>#if (defined(__sun__) &amp;&amp; (!defined(<span class='macro'>__LP64__<span class='macro_popup'>1</span></span>)))   /* Sun Solaris 32-bits requires specific definitions */</span></td></tr>
<tr class="codeline" data-linenumber="26"><td class="num" id="LN26">26</td><td class="line"><span class='directive'>#  define _LARGEFILE_SOURCE</span></td></tr>
<tr class="codeline" data-linenumber="27"><td class="num" id="LN27">27</td><td class="line"><span class='directive'>#elif ! defined(<span class='macro'>__LP64__<span class='macro_popup'>1</span></span>)                        /* No point defining Large file for 64 bit */</span></td></tr>
<tr class="codeline" data-linenumber="28"><td class="num" id="LN28">28</td><td class="line"><span class='directive'>#  define _LARGEFILE64_SOURCE</span></td></tr>
<tr class="codeline" data-linenumber="29"><td class="num" id="LN29">29</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="30"><td class="num" id="LN30">30</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="31"><td class="num" id="LN31">31</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="32"><td class="num" id="LN32">32</td><td class="line"><span class='comment'>/*-*************************************</span></td></tr>
<tr class="codeline" data-linenumber="33"><td class="num" id="LN33">33</td><td class="line"><span class='comment'>*  Dependencies</span></td></tr>
<tr class="codeline" data-linenumber="34"><td class="num" id="LN34">34</td><td class="line"><span class='comment'>***************************************/</span></td></tr>
<tr class="codeline" data-linenumber="35"><td class="num" id="LN35">35</td><td class="line"><span class='directive'>#include &lt;stdlib.h&gt;        /* malloc, free */</span></td></tr>
<tr class="codeline" data-linenumber="36"><td class="num" id="LN36">36</td><td class="line"><span class='directive'>#include &lt;string.h&gt;        /* memset */</span></td></tr>
<tr class="codeline" data-linenumber="37"><td class="num" id="LN37">37</td><td class="line"><span class='directive'>#include &lt;stdio.h&gt;         /* fprintf, fopen, ftello64 */</span></td></tr>
<tr class="codeline" data-linenumber="38"><td class="num" id="LN38">38</td><td class="line"><span class='directive'>#include &lt;time.h&gt;          /* clock */</span></td></tr>
<tr class="codeline" data-linenumber="39"><td class="num" id="LN39">39</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="40"><td class="num" id="LN40">40</td><td class="line"><span class='directive'>#include "../common/mem.h"           /* read */</span></td></tr>
<tr class="codeline" data-linenumber="41"><td class="num" id="LN41">41</td><td class="line"><span class='directive'>#include "../common/fse.h"           /* FSE_normalizeCount, FSE_writeNCount */</span></td></tr>
<tr class="codeline" data-linenumber="42"><td class="num" id="LN42">42</td><td class="line"><span class='directive'>#define HUF_STATIC_LINKING_ONLY</span></td></tr>
<tr class="codeline" data-linenumber="43"><td class="num" id="LN43">43</td><td class="line"><span class='directive'>#include "../common/huf.h"           /* HUF_buildCTable, HUF_writeCTable */</span></td></tr>
<tr class="codeline" data-linenumber="44"><td class="num" id="LN44">44</td><td class="line"><span class='directive'>#include "../common/zstd_internal.h" /* includes zstd.h */</span></td></tr>
<tr class="codeline" data-linenumber="45"><td class="num" id="LN45">45</td><td class="line"><span class='directive'>#include "../common/xxhash.h"        /* XXH64 */</span></td></tr>
<tr class="codeline" data-linenumber="46"><td class="num" id="LN46">46</td><td class="line"><span class='directive'>#include "divsufsort.h"</span></td></tr>
<tr class="codeline" data-linenumber="47"><td class="num" id="LN47">47</td><td class="line"><span class='directive'>#ifndef ZDICT_STATIC_LINKING_ONLY</span></td></tr>
<tr class="codeline" data-linenumber="48"><td class="num" id="LN48">48</td><td class="line"><span class='directive'>#  define ZDICT_STATIC_LINKING_ONLY</span></td></tr>
<tr class="codeline" data-linenumber="49"><td class="num" id="LN49">49</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="50"><td class="num" id="LN50">50</td><td class="line"><span class='directive'>#include "zdict.h"</span></td></tr>
<tr class="codeline" data-linenumber="51"><td class="num" id="LN51">51</td><td class="line"><span class='directive'>#include "../compress/zstd_compress_internal.h" /* ZSTD_loadCEntropy() */</span></td></tr>
<tr class="codeline" data-linenumber="52"><td class="num" id="LN52">52</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="53"><td class="num" id="LN53">53</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="54"><td class="num" id="LN54">54</td><td class="line"><span class='comment'>/*-*************************************</span></td></tr>
<tr class="codeline" data-linenumber="55"><td class="num" id="LN55">55</td><td class="line"><span class='comment'>*  Constants</span></td></tr>
<tr class="codeline" data-linenumber="56"><td class="num" id="LN56">56</td><td class="line"><span class='comment'>***************************************/</span></td></tr>
<tr class="codeline" data-linenumber="57"><td class="num" id="LN57">57</td><td class="line"><span class='directive'>#define <span class='macro'>KB<span class='macro_popup'>*(1 &lt;&lt;10)</span></span> *(1 &lt;&lt;10)</span></td></tr>
<tr class="codeline" data-linenumber="58"><td class="num" id="LN58">58</td><td class="line"><span class='directive'>#define <span class='macro'>MB<span class='macro_popup'>*(1 &lt;&lt;20)</span></span> *(1 &lt;&lt;20)</span></td></tr>
<tr class="codeline" data-linenumber="59"><td class="num" id="LN59">59</td><td class="line"><span class='directive'>#define <span class='macro'>GB<span class='macro_popup'>*(1U&lt;&lt;30)</span></span> *(1U&lt;&lt;30)</span></td></tr>
<tr class="codeline" data-linenumber="60"><td class="num" id="LN60">60</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="61"><td class="num" id="LN61">61</td><td class="line"><span class='directive'>#define <span class='macro'>DICTLISTSIZE_DEFAULT<span class='macro_popup'>10000</span></span> 10000</span></td></tr>
<tr class="codeline" data-linenumber="62"><td class="num" id="LN62">62</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="63"><td class="num" id="LN63">63</td><td class="line"><span class='directive'>#define <span class='macro'>NOISELENGTH<span class='macro_popup'>32</span></span> 32</span></td></tr>
<tr class="codeline" data-linenumber="64"><td class="num" id="LN64">64</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="65"><td class="num" id="LN65">65</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>int</span> g_compressionLevel_default = 3;</td></tr>
<tr class="codeline" data-linenumber="66"><td class="num" id="LN66">66</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> U32 g_selectivity_default = 9;</td></tr>
<tr class="codeline" data-linenumber="67"><td class="num" id="LN67">67</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="68"><td class="num" id="LN68">68</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="69"><td class="num" id="LN69">69</td><td class="line"><span class='comment'>/*-*************************************</span></td></tr>
<tr class="codeline" data-linenumber="70"><td class="num" id="LN70">70</td><td class="line"><span class='comment'>*  Console display</span></td></tr>
<tr class="codeline" data-linenumber="71"><td class="num" id="LN71">71</td><td class="line"><span class='comment'>***************************************/</span></td></tr>
<tr class="codeline" data-linenumber="72"><td class="num" id="LN72">72</td><td class="line"><span class='directive'>#define <span class='macro'>DISPLAY(...)<span class='macro_popup'>{ fprintf(stderr, ...); fflush( stderr ); }</span></span>         { fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>, __VA_ARGS__); fflush( <span class='macro'>stderr<span class='macro_popup'>stderr</span></span> ); }</span></td></tr>
<tr class="codeline" data-linenumber="73"><td class="num" id="LN73">73</td><td class="line"><span class='directive'>#define <span class='macro'>DISPLAYLEVEL(l, ...)<span class='macro_popup'>if (notificationLevel&gt;=l) { { fprintf(stderr, ...); fflush<br>( stderr ); }; }</span></span> if (notificationLevel&gt;=l) { <span class='macro'>DISPLAY(__VA_ARGS__)<span class='macro_popup'>{ fprintf(stderr, __VA_ARGS__); fflush( stderr ); }</span></span>; }    /* 0 : no display;   1: errors;   2: default;  3: details;  4: debug */</span></td></tr>
<tr class="codeline" data-linenumber="74"><td class="num" id="LN74">74</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="75"><td class="num" id="LN75">75</td><td class="line"><span class='keyword'>static</span> clock_t ZDICT_clockSpan(clock_t nPrevious) { <span class='keyword'>return</span> clock() - nPrevious; }</td></tr>
<tr class="codeline" data-linenumber="76"><td class="num" id="LN76">76</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="77"><td class="num" id="LN77">77</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> ZDICT_printHex(<span class='keyword'>const</span> <span class='keyword'>void</span>* ptr, size_t length)</td></tr>
<tr class="codeline" data-linenumber="78"><td class="num" id="LN78">78</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="79"><td class="num" id="LN79">79</td><td class="line">    <span class='keyword'>const</span> BYTE* <span class='keyword'>const</span> b = (<span class='keyword'>const</span> BYTE*)ptr;</td></tr>
<tr class="codeline" data-linenumber="80"><td class="num" id="LN80">80</td><td class="line">    size_t u;</td></tr>
<tr class="codeline" data-linenumber="81"><td class="num" id="LN81">81</td><td class="line">    <span class='keyword'>for</span> (u=0; u&lt;length; u++) {</td></tr>
<tr class="codeline" data-linenumber="82"><td class="num" id="LN82">82</td><td class="line">        BYTE c = b[u];</td></tr>
<tr class="codeline" data-linenumber="83"><td class="num" id="LN83">83</td><td class="line">        <span class='keyword'>if</span> (c&lt;32 || c&gt;126) c = '.';   <span class='comment'>/* non-printable char */</span></td></tr>
<tr class="codeline" data-linenumber="84"><td class="num" id="LN84">84</td><td class="line">        <span class='macro'>DISPLAY(<span class='string_literal'>"%c"</span>, c)<span class='macro_popup'>{ fprintf(stderr, "%c", c); fflush( stderr ); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="85"><td class="num" id="LN85">85</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="86"><td class="num" id="LN86">86</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="87"><td class="num" id="LN87">87</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="88"><td class="num" id="LN88">88</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="89"><td class="num" id="LN89">89</td><td class="line"><span class='comment'>/*-********************************************************</span></td></tr>
<tr class="codeline" data-linenumber="90"><td class="num" id="LN90">90</td><td class="line"><span class='comment'>*  Helper functions</span></td></tr>
<tr class="codeline" data-linenumber="91"><td class="num" id="LN91">91</td><td class="line"><span class='comment'>**********************************************************/</span></td></tr>
<tr class="codeline" data-linenumber="92"><td class="num" id="LN92">92</td><td class="line"><span class='keyword'>unsigned</span> ZDICT_isError(size_t errorCode) { <span class='keyword'>return</span> ERR_isError(errorCode); }</td></tr>
<tr class="codeline" data-linenumber="93"><td class="num" id="LN93">93</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="94"><td class="num" id="LN94">94</td><td class="line"><span class='keyword'>const</span> <span class='keyword'>char</span>* ZDICT_getErrorName(size_t errorCode) { <span class='keyword'>return</span> ERR_getErrorName(errorCode); }</td></tr>
<tr class="codeline" data-linenumber="95"><td class="num" id="LN95">95</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="96"><td class="num" id="LN96">96</td><td class="line"><span class='keyword'>unsigned</span> ZDICT_getDictID(<span class='keyword'>const</span> <span class='keyword'>void</span>* dictBuffer, size_t dictSize)</td></tr>
<tr class="codeline" data-linenumber="97"><td class="num" id="LN97">97</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="98"><td class="num" id="LN98">98</td><td class="line">    <span class='keyword'>if</span> (dictSize &lt; 8) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="99"><td class="num" id="LN99">99</td><td class="line">    <span class='keyword'>if</span> (MEM_readLE32(dictBuffer) != <span class='macro'>ZSTD_MAGIC_DICTIONARY<span class='macro_popup'>0xEC30A437</span></span>) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="100"><td class="num" id="LN100">100</td><td class="line">    <span class='keyword'>return</span> MEM_readLE32((<span class='keyword'>const</span> <span class='keyword'>char</span>*)dictBuffer + 4);</td></tr>
<tr class="codeline" data-linenumber="101"><td class="num" id="LN101">101</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="102"><td class="num" id="LN102">102</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="103"><td class="num" id="LN103">103</td><td class="line">size_t ZDICT_getDictHeaderSize(<span class='keyword'>const</span> <span class='keyword'>void</span>* dictBuffer, size_t dictSize)</td></tr>
<tr class="codeline" data-linenumber="104"><td class="num" id="LN104">104</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="105"><td class="num" id="LN105">105</td><td class="line">    size_t headerSize;</td></tr>
<tr class="codeline" data-linenumber="106"><td class="num" id="LN106">106</td><td class="line">    <span class='keyword'>if</span> (dictSize &lt;= 8 || MEM_readLE32(dictBuffer) != <span class='macro'>ZSTD_MAGIC_DICTIONARY<span class='macro_popup'>0xEC30A437</span></span>) <span class='keyword'>return</span> <span class='macro'>ERROR(dictionary_corrupted)<span class='macro_popup'>((size_t)-ZSTD_error_dictionary_corrupted)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="107"><td class="num" id="LN107">107</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="108"><td class="num" id="LN108">108</td><td class="line">    {   <span class='keyword'>unsigned</span> offcodeMaxValue = <span class='macro'>MaxOff<span class='macro_popup'>31</span></span>;</td></tr>
<tr class="codeline" data-linenumber="109"><td class="num" id="LN109">109</td><td class="line">        ZSTD_compressedBlockState_t* bs = (ZSTD_compressedBlockState_t*)malloc(<span class='keyword'>sizeof</span>(ZSTD_compressedBlockState_t));</td></tr>
<tr class="codeline" data-linenumber="110"><td class="num" id="LN110">110</td><td class="line">        U32* wksp = (U32*)malloc(<span class='macro'>HUF_WORKSPACE_SIZE<span class='macro_popup'>((6 &lt;&lt; 10) + 256)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="111"><td class="num" id="LN111">111</td><td class="line">        <span class='keyword'>short</span>* offcodeNCount = (<span class='keyword'>short</span>*)malloc((<span class='macro'>MaxOff<span class='macro_popup'>31</span></span>+1)*<span class='keyword'>sizeof</span>(<span class='keyword'>short</span>));</td></tr>
<tr class="codeline" data-linenumber="112"><td class="num" id="LN112">112</td><td class="line">        <span class='keyword'>if</span> (!bs || !wksp || !offcodeNCount) {</td></tr>
<tr class="codeline" data-linenumber="113"><td class="num" id="LN113">113</td><td class="line">            headerSize = <span class='macro'>ERROR(memory_allocation)<span class='macro_popup'>((size_t)-ZSTD_error_memory_allocation)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="114"><td class="num" id="LN114">114</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="115"><td class="num" id="LN115">115</td><td class="line">            ZSTD_reset_compressedBlockState(bs);</td></tr>
<tr class="codeline" data-linenumber="116"><td class="num" id="LN116">116</td><td class="line">            headerSize = ZSTD_loadCEntropy(bs, wksp, offcodeNCount, &amp;offcodeMaxValue, dictBuffer, dictSize);</td></tr>
<tr class="codeline" data-linenumber="117"><td class="num" id="LN117">117</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="118"><td class="num" id="LN118">118</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="119"><td class="num" id="LN119">119</td><td class="line">        free(bs);</td></tr>
<tr class="codeline" data-linenumber="120"><td class="num" id="LN120">120</td><td class="line">        free(wksp);</td></tr>
<tr class="codeline" data-linenumber="121"><td class="num" id="LN121">121</td><td class="line">        free(offcodeNCount);</td></tr>
<tr class="codeline" data-linenumber="122"><td class="num" id="LN122">122</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="123"><td class="num" id="LN123">123</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="124"><td class="num" id="LN124">124</td><td class="line">    <span class='keyword'>return</span> headerSize;</td></tr>
<tr class="codeline" data-linenumber="125"><td class="num" id="LN125">125</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="126"><td class="num" id="LN126">126</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="127"><td class="num" id="LN127">127</td><td class="line"><span class='comment'>/*-********************************************************</span></td></tr>
<tr class="codeline" data-linenumber="128"><td class="num" id="LN128">128</td><td class="line"><span class='comment'>*  Dictionary training functions</span></td></tr>
<tr class="codeline" data-linenumber="129"><td class="num" id="LN129">129</td><td class="line"><span class='comment'>**********************************************************/</span></td></tr>
<tr class="codeline" data-linenumber="130"><td class="num" id="LN130">130</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> ZDICT_NbCommonBytes (size_t val)</td></tr>
<tr class="codeline" data-linenumber="131"><td class="num" id="LN131">131</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="132"><td class="num" id="LN132">132</td><td class="line">    <span class='keyword'>if</span> (MEM_isLittleEndian()) {</td></tr>
<tr class="codeline" data-linenumber="133"><td class="num" id="LN133">133</td><td class="line">        <span class='keyword'>if</span> (MEM_64bits()) {</td></tr>
<tr class="codeline" data-linenumber="134"><td class="num" id="LN134">134</td><td class="line"><span class='directive'>#       if defined(_MSC_VER) &amp;&amp; defined(_WIN64)</span></td></tr>
<tr class="codeline" data-linenumber="135"><td class="num" id="LN135">135</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>long</span> r = 0;</td></tr>
<tr class="codeline" data-linenumber="136"><td class="num" id="LN136">136</td><td class="line">            _BitScanForward64( &amp;r, (U64)val );</td></tr>
<tr class="codeline" data-linenumber="137"><td class="num" id="LN137">137</td><td class="line">            <span class='keyword'>return</span> (<span class='keyword'>unsigned</span>)(r&gt;&gt;3);</td></tr>
<tr class="codeline" data-linenumber="138"><td class="num" id="LN138">138</td><td class="line"><span class='directive'>#       elif defined(<span class='macro'>__GNUC__<span class='macro_popup'>4</span></span>) &amp;&amp; (<span class='macro'>__GNUC__<span class='macro_popup'>4</span></span> &gt;= 3)</span></td></tr>
<tr class="codeline" data-linenumber="139"><td class="num" id="LN139">139</td><td class="line">            <span class='keyword'>return</span> (__builtin_ctzll((U64)val) &gt;&gt; 3);</td></tr>
<tr class="codeline" data-linenumber="140"><td class="num" id="LN140">140</td><td class="line"><span class='directive'>#       else</span></td></tr>
<tr class="codeline" data-linenumber="141"><td class="num" id="LN141">141</td><td class="line">            <span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>int</span> DeBruijnBytePos[64] = { 0, 0, 0, 0, 0, 1, 1, 2, 0, 3, 1, 3, 1, 4, 2, 7, 0, 2, 3, 6, 1, 5, 3, 5, 1, 3, 4, 4, 2, 5, 6, 7, 7, 0, 1, 2, 3, 3, 4, 6, 2, 6, 5, 5, 3, 4, 5, 6, 7, 1, 2, 4, 6, 4, 4, 5, 7, 2, 6, 5, 7, 6, 7, 7 };</td></tr>
<tr class="codeline" data-linenumber="142"><td class="num" id="LN142">142</td><td class="line">            <span class='keyword'>return</span> DeBruijnBytePos[((U64)((val &amp; -(<span class='keyword'>long</span> <span class='keyword'>long</span>)val) * 0x0218A392CDABBD3FULL)) &gt;&gt; 58];</td></tr>
<tr class="codeline" data-linenumber="143"><td class="num" id="LN143">143</td><td class="line"><span class='directive'>#       endif</span></td></tr>
<tr class="codeline" data-linenumber="144"><td class="num" id="LN144">144</td><td class="line">        } <span class='keyword'>else</span> { <span class='comment'>/* 32 bits */</span></td></tr>
<tr class="codeline" data-linenumber="145"><td class="num" id="LN145">145</td><td class="line"><span class='directive'>#       if defined(_MSC_VER)</span></td></tr>
<tr class="codeline" data-linenumber="146"><td class="num" id="LN146">146</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>long</span> r=0;</td></tr>
<tr class="codeline" data-linenumber="147"><td class="num" id="LN147">147</td><td class="line">            _BitScanForward( &amp;r, (U32)val );</td></tr>
<tr class="codeline" data-linenumber="148"><td class="num" id="LN148">148</td><td class="line">            <span class='keyword'>return</span> (<span class='keyword'>unsigned</span>)(r&gt;&gt;3);</td></tr>
<tr class="codeline" data-linenumber="149"><td class="num" id="LN149">149</td><td class="line"><span class='directive'>#       elif defined(<span class='macro'>__GNUC__<span class='macro_popup'>4</span></span>) &amp;&amp; (<span class='macro'>__GNUC__<span class='macro_popup'>4</span></span> &gt;= 3)</span></td></tr>
<tr class="codeline" data-linenumber="150"><td class="num" id="LN150">150</td><td class="line">            <span class='keyword'>return</span> (__builtin_ctz((U32)val) &gt;&gt; 3);</td></tr>
<tr class="codeline" data-linenumber="151"><td class="num" id="LN151">151</td><td class="line"><span class='directive'>#       else</span></td></tr>
<tr class="codeline" data-linenumber="152"><td class="num" id="LN152">152</td><td class="line">            <span class='keyword'>static</span> <span class='keyword'>const</span> <span class='keyword'>int</span> DeBruijnBytePos[32] = { 0, 0, 3, 0, 3, 1, 3, 0, 3, 2, 2, 1, 3, 2, 0, 1, 3, 3, 1, 2, 2, 2, 2, 0, 3, 1, 2, 0, 1, 0, 1, 1 };</td></tr>
<tr class="codeline" data-linenumber="153"><td class="num" id="LN153">153</td><td class="line">            <span class='keyword'>return</span> DeBruijnBytePos[((U32)((val &amp; -(S32)val) * 0x077CB531U)) &gt;&gt; 27];</td></tr>
<tr class="codeline" data-linenumber="154"><td class="num" id="LN154">154</td><td class="line"><span class='directive'>#       endif</span></td></tr>
<tr class="codeline" data-linenumber="155"><td class="num" id="LN155">155</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="156"><td class="num" id="LN156">156</td><td class="line">    } <span class='keyword'>else</span> {  <span class='comment'>/* Big Endian CPU */</span></td></tr>
<tr class="codeline" data-linenumber="157"><td class="num" id="LN157">157</td><td class="line">        <span class='keyword'>if</span> (MEM_64bits()) {</td></tr>
<tr class="codeline" data-linenumber="158"><td class="num" id="LN158">158</td><td class="line"><span class='directive'>#       if defined(_MSC_VER) &amp;&amp; defined(_WIN64)</span></td></tr>
<tr class="codeline" data-linenumber="159"><td class="num" id="LN159">159</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>long</span> r = 0;</td></tr>
<tr class="codeline" data-linenumber="160"><td class="num" id="LN160">160</td><td class="line">            _BitScanReverse64( &amp;r, val );</td></tr>
<tr class="codeline" data-linenumber="161"><td class="num" id="LN161">161</td><td class="line">            <span class='keyword'>return</span> (<span class='keyword'>unsigned</span>)(r&gt;&gt;3);</td></tr>
<tr class="codeline" data-linenumber="162"><td class="num" id="LN162">162</td><td class="line"><span class='directive'>#       elif defined(<span class='macro'>__GNUC__<span class='macro_popup'>4</span></span>) &amp;&amp; (<span class='macro'>__GNUC__<span class='macro_popup'>4</span></span> &gt;= 3)</span></td></tr>
<tr class="codeline" data-linenumber="163"><td class="num" id="LN163">163</td><td class="line">            <span class='keyword'>return</span> (__builtin_clzll(val) &gt;&gt; 3);</td></tr>
<tr class="codeline" data-linenumber="164"><td class="num" id="LN164">164</td><td class="line"><span class='directive'>#       else</span></td></tr>
<tr class="codeline" data-linenumber="165"><td class="num" id="LN165">165</td><td class="line">            <span class='keyword'>unsigned</span> r;</td></tr>
<tr class="codeline" data-linenumber="166"><td class="num" id="LN166">166</td><td class="line">            <span class='keyword'>const</span> <span class='keyword'>unsigned</span> n32 = <span class='keyword'>sizeof</span>(size_t)*4;   <span class='comment'>/* calculate this way due to compiler complaining in 32-bits mode */</span></td></tr>
<tr class="codeline" data-linenumber="167"><td class="num" id="LN167">167</td><td class="line">            <span class='keyword'>if</span> (!(val&gt;&gt;n32)) { r=4; } <span class='keyword'>else</span> { r=0; val&gt;&gt;=n32; }</td></tr>
<tr class="codeline" data-linenumber="168"><td class="num" id="LN168">168</td><td class="line">            <span class='keyword'>if</span> (!(val&gt;&gt;16)) { r+=2; val&gt;&gt;=8; } <span class='keyword'>else</span> { val&gt;&gt;=24; }</td></tr>
<tr class="codeline" data-linenumber="169"><td class="num" id="LN169">169</td><td class="line">            r += (!val);</td></tr>
<tr class="codeline" data-linenumber="170"><td class="num" id="LN170">170</td><td class="line">            <span class='keyword'>return</span> r;</td></tr>
<tr class="codeline" data-linenumber="171"><td class="num" id="LN171">171</td><td class="line"><span class='directive'>#       endif</span></td></tr>
<tr class="codeline" data-linenumber="172"><td class="num" id="LN172">172</td><td class="line">        } <span class='keyword'>else</span> { <span class='comment'>/* 32 bits */</span></td></tr>
<tr class="codeline" data-linenumber="173"><td class="num" id="LN173">173</td><td class="line"><span class='directive'>#       if defined(_MSC_VER)</span></td></tr>
<tr class="codeline" data-linenumber="174"><td class="num" id="LN174">174</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>long</span> r = 0;</td></tr>
<tr class="codeline" data-linenumber="175"><td class="num" id="LN175">175</td><td class="line">            _BitScanReverse( &amp;r, (<span class='keyword'>unsigned</span> <span class='keyword'>long</span>)val );</td></tr>
<tr class="codeline" data-linenumber="176"><td class="num" id="LN176">176</td><td class="line">            <span class='keyword'>return</span> (<span class='keyword'>unsigned</span>)(r&gt;&gt;3);</td></tr>
<tr class="codeline" data-linenumber="177"><td class="num" id="LN177">177</td><td class="line"><span class='directive'>#       elif defined(<span class='macro'>__GNUC__<span class='macro_popup'>4</span></span>) &amp;&amp; (<span class='macro'>__GNUC__<span class='macro_popup'>4</span></span> &gt;= 3)</span></td></tr>
<tr class="codeline" data-linenumber="178"><td class="num" id="LN178">178</td><td class="line">            <span class='keyword'>return</span> (__builtin_clz((U32)val) &gt;&gt; 3);</td></tr>
<tr class="codeline" data-linenumber="179"><td class="num" id="LN179">179</td><td class="line"><span class='directive'>#       else</span></td></tr>
<tr class="codeline" data-linenumber="180"><td class="num" id="LN180">180</td><td class="line">            <span class='keyword'>unsigned</span> r;</td></tr>
<tr class="codeline" data-linenumber="181"><td class="num" id="LN181">181</td><td class="line">            <span class='keyword'>if</span> (!(val&gt;&gt;16)) { r=2; val&gt;&gt;=8; } <span class='keyword'>else</span> { r=0; val&gt;&gt;=24; }</td></tr>
<tr class="codeline" data-linenumber="182"><td class="num" id="LN182">182</td><td class="line">            r += (!val);</td></tr>
<tr class="codeline" data-linenumber="183"><td class="num" id="LN183">183</td><td class="line">            <span class='keyword'>return</span> r;</td></tr>
<tr class="codeline" data-linenumber="184"><td class="num" id="LN184">184</td><td class="line"><span class='directive'>#       endif</span></td></tr>
<tr class="codeline" data-linenumber="185"><td class="num" id="LN185">185</td><td class="line">    }   }</td></tr>
<tr class="codeline" data-linenumber="186"><td class="num" id="LN186">186</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="187"><td class="num" id="LN187">187</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="188"><td class="num" id="LN188">188</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="189"><td class="num" id="LN189">189</td><td class="line"><span class='comment'>/*! ZDICT_count() :</span></td></tr>
<tr class="codeline" data-linenumber="190"><td class="num" id="LN190">190</td><td class="line">    <span class='comment'>Count the nb of common bytes between 2 pointers.</span></td></tr>
<tr class="codeline" data-linenumber="191"><td class="num" id="LN191">191</td><td class="line">    <span class='comment'>Note : this function presumes end of buffer followed by noisy guard band.</span></td></tr>
<tr class="codeline" data-linenumber="192"><td class="num" id="LN192">192</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="193"><td class="num" id="LN193">193</td><td class="line"><span class='keyword'>static</span> size_t ZDICT_count(<span class='keyword'>const</span> <span class='keyword'>void</span>* pIn, <span class='keyword'>const</span> <span class='keyword'>void</span>* pMatch)</td></tr>
<tr class="codeline" data-linenumber="194"><td class="num" id="LN194">194</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="195"><td class="num" id="LN195">195</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span>* <span class='keyword'>const</span> pStart = (<span class='keyword'>const</span> <span class='keyword'>char</span>*)pIn;</td></tr>
<tr class="codeline" data-linenumber="196"><td class="num" id="LN196">196</td><td class="line">    <span class='keyword'>for</span> (;;) {</td></tr>
<tr class="codeline" data-linenumber="197"><td class="num" id="LN197">197</td><td class="line">        size_t <span class='keyword'>const</span> diff = MEM_readST(pMatch) ^ MEM_readST(pIn);</td></tr>
<tr class="codeline" data-linenumber="198"><td class="num" id="LN198">198</td><td class="line">        <span class='keyword'>if</span> (!diff) {</td></tr>
<tr class="codeline" data-linenumber="199"><td class="num" id="LN199">199</td><td class="line">            pIn = (<span class='keyword'>const</span> <span class='keyword'>char</span>*)pIn+<span class='keyword'>sizeof</span>(size_t);</td></tr>
<tr class="codeline" data-linenumber="200"><td class="num" id="LN200">200</td><td class="line">            pMatch = (<span class='keyword'>const</span> <span class='keyword'>char</span>*)pMatch+<span class='keyword'>sizeof</span>(size_t);</td></tr>
<tr class="codeline" data-linenumber="201"><td class="num" id="LN201">201</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="202"><td class="num" id="LN202">202</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="203"><td class="num" id="LN203">203</td><td class="line">        pIn = (<span class='keyword'>const</span> <span class='keyword'>char</span>*)pIn+ZDICT_NbCommonBytes(diff);</td></tr>
<tr class="codeline" data-linenumber="204"><td class="num" id="LN204">204</td><td class="line">        <span class='keyword'>return</span> (size_t)((<span class='keyword'>const</span> <span class='keyword'>char</span>*)pIn - pStart);</td></tr>
<tr class="codeline" data-linenumber="205"><td class="num" id="LN205">205</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="206"><td class="num" id="LN206">206</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="207"><td class="num" id="LN207">207</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="208"><td class="num" id="LN208">208</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="209"><td class="num" id="LN209">209</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> {</td></tr>
<tr class="codeline" data-linenumber="210"><td class="num" id="LN210">210</td><td class="line">    U32 pos;</td></tr>
<tr class="codeline" data-linenumber="211"><td class="num" id="LN211">211</td><td class="line">    U32 length;</td></tr>
<tr class="codeline" data-linenumber="212"><td class="num" id="LN212">212</td><td class="line">    U32 savings;</td></tr>
<tr class="codeline" data-linenumber="213"><td class="num" id="LN213">213</td><td class="line">} dictItem;</td></tr>
<tr class="codeline" data-linenumber="214"><td class="num" id="LN214">214</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="215"><td class="num" id="LN215">215</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> ZDICT_initDictItem(dictItem* d)</td></tr>
<tr class="codeline" data-linenumber="216"><td class="num" id="LN216">216</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="217"><td class="num" id="LN217">217</td><td class="line">    d-&gt;pos = 1;</td></tr>
<tr class="codeline" data-linenumber="218"><td class="num" id="LN218">218</td><td class="line">    d-&gt;length = 0;</td></tr>
<tr class="codeline" data-linenumber="219"><td class="num" id="LN219">219</td><td class="line">    d-&gt;savings = (U32)(-1);</td></tr>
<tr class="codeline" data-linenumber="220"><td class="num" id="LN220">220</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="221"><td class="num" id="LN221">221</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="222"><td class="num" id="LN222">222</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="223"><td class="num" id="LN223">223</td><td class="line"><span class='directive'>#define <span class='macro'>LLIMIT<span class='macro_popup'>64</span></span> 64          /* heuristic determined experimentally */</span></td></tr>
<tr class="codeline" data-linenumber="224"><td class="num" id="LN224">224</td><td class="line"><span class='directive'>#define <span class='macro'>MINMATCHLENGTH<span class='macro_popup'>7</span></span> 7   /* heuristic determined experimentally */</span></td></tr>
<tr class="codeline" data-linenumber="225"><td class="num" id="LN225">225</td><td class="line"><span class='keyword'>static</span> dictItem ZDICT_analyzePos(</td></tr>
<tr class="codeline" data-linenumber="226"><td class="num" id="LN226">226</td><td class="line">                       BYTE* doneMarks,</td></tr>
<tr class="codeline" data-linenumber="227"><td class="num" id="LN227">227</td><td class="line">                       <span class='keyword'>const</span> <span class='keyword'>int</span>* suffix, U32 start,</td></tr>
<tr class="codeline" data-linenumber="228"><td class="num" id="LN228">228</td><td class="line">                       <span class='keyword'>const</span> <span class='keyword'>void</span>* buffer, U32 minRatio, U32 notificationLevel)</td></tr>
<tr class="codeline" data-linenumber="229"><td class="num" id="LN229">229</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="230"><td class="num" id="LN230">230</td><td class="line">    U32 lengthList[<span class='macro'>LLIMIT<span class='macro_popup'>64</span></span>] = {0};</td></tr>
<tr class="codeline" data-linenumber="231"><td class="num" id="LN231">231</td><td class="line">    U32 cumulLength[<span class='macro'>LLIMIT<span class='macro_popup'>64</span></span>] = {0};</td></tr>
<tr class="codeline" data-linenumber="232"><td class="num" id="LN232">232</td><td class="line">    U32 savings[<span class='macro'>LLIMIT<span class='macro_popup'>64</span></span>] = {0};</td></tr>
<tr class="codeline" data-linenumber="233"><td class="num" id="LN233">233</td><td class="line">    <span class='keyword'>const</span> BYTE* b = (<span class='keyword'>const</span> BYTE*)buffer;</td></tr>
<tr class="codeline" data-linenumber="234"><td class="num" id="LN234">234</td><td class="line">    size_t maxLength = <span class='macro'>LLIMIT<span class='macro_popup'>64</span></span>;</td></tr>
<tr class="codeline" data-linenumber="235"><td class="num" id="LN235">235</td><td class="line">    size_t pos = suffix[start];</td></tr>
<tr class="codeline" data-linenumber="236"><td class="num" id="LN236">236</td><td class="line">    U32 end = start;</td></tr>
<tr class="codeline" data-linenumber="237"><td class="num" id="LN237">237</td><td class="line">    dictItem solution;</td></tr>
<tr class="codeline" data-linenumber="238"><td class="num" id="LN238">238</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="239"><td class="num" id="LN239">239</td><td class="line">    <span class='comment'>/* init */</span></td></tr>
<tr class="codeline" data-linenumber="240"><td class="num" id="LN240">240</td><td class="line">    memset(&amp;solution, 0, <span class='keyword'>sizeof</span>(solution));</td></tr>
<tr class="codeline" data-linenumber="241"><td class="num" id="LN241">241</td><td class="line">    doneMarks[pos] = 1;</td></tr>
<tr class="codeline" data-linenumber="242"><td class="num" id="LN242">242</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="243"><td class="num" id="LN243">243</td><td class="line">    <span class='comment'>/* trivial repetition cases */</span></td></tr>
<tr class="codeline" data-linenumber="244"><td class="num" id="LN244">244</td><td class="line">    <span class='keyword'>if</span> ( (MEM_read16(b+pos+0) == MEM_read16(b+pos+2))</td></tr>
<tr class="codeline" data-linenumber="245"><td class="num" id="LN245">245</td><td class="line">       ||(MEM_read16(b+pos+1) == MEM_read16(b+pos+3))</td></tr>
<tr class="codeline" data-linenumber="246"><td class="num" id="LN246">246</td><td class="line">       ||(MEM_read16(b+pos+2) == MEM_read16(b+pos+4)) ) {</td></tr>
<tr class="codeline" data-linenumber="247"><td class="num" id="LN247">247</td><td class="line">        <span class='comment'>/* skip and mark segment */</span></td></tr>
<tr class="codeline" data-linenumber="248"><td class="num" id="LN248">248</td><td class="line">        U16 <span class='keyword'>const</span> pattern16 = MEM_read16(b+pos+4);</td></tr>
<tr class="codeline" data-linenumber="249"><td class="num" id="LN249">249</td><td class="line">        U32 u, patternEnd = 6;</td></tr>
<tr class="codeline" data-linenumber="250"><td class="num" id="LN250">250</td><td class="line">        <span class='keyword'>while</span> (MEM_read16(b+pos+patternEnd) == pattern16) patternEnd+=2 ;</td></tr>
<tr class="codeline" data-linenumber="251"><td class="num" id="LN251">251</td><td class="line">        <span class='keyword'>if</span> (b[pos+patternEnd] == b[pos+patternEnd-1]) patternEnd++;</td></tr>
<tr class="codeline" data-linenumber="252"><td class="num" id="LN252">252</td><td class="line">        <span class='keyword'>for</span> (u=1; u&lt;patternEnd; u++)</td></tr>
<tr class="codeline" data-linenumber="253"><td class="num" id="LN253">253</td><td class="line">            doneMarks[pos+u] = 1;</td></tr>
<tr class="codeline" data-linenumber="254"><td class="num" id="LN254">254</td><td class="line">        <span class='keyword'>return</span> solution;</td></tr>
<tr class="codeline" data-linenumber="255"><td class="num" id="LN255">255</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="256"><td class="num" id="LN256">256</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="257"><td class="num" id="LN257">257</td><td class="line">    <span class='comment'>/* look forward */</span></td></tr>
<tr class="codeline" data-linenumber="258"><td class="num" id="LN258">258</td><td class="line">    {   size_t length;</td></tr>
<tr class="codeline" data-linenumber="259"><td class="num" id="LN259">259</td><td class="line">        <span class='keyword'>do</span> {</td></tr>
<tr class="codeline" data-linenumber="260"><td class="num" id="LN260">260</td><td class="line">            end++;</td></tr>
<tr class="codeline" data-linenumber="261"><td class="num" id="LN261">261</td><td class="line">            length = ZDICT_count(b + pos, b + suffix[end]);</td></tr>
<tr class="codeline" data-linenumber="262"><td class="num" id="LN262">262</td><td class="line">        } <span class='keyword'>while</span> (length &gt;= <span class='macro'>MINMATCHLENGTH<span class='macro_popup'>7</span></span>);</td></tr>
<tr class="codeline" data-linenumber="263"><td class="num" id="LN263">263</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="264"><td class="num" id="LN264">264</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="265"><td class="num" id="LN265">265</td><td class="line">    <span class='comment'>/* look backward */</span></td></tr>
<tr class="codeline" data-linenumber="266"><td class="num" id="LN266">266</td><td class="line">    {   size_t length;</td></tr>
<tr class="codeline" data-linenumber="267"><td class="num" id="LN267">267</td><td class="line">        <span class='keyword'>do</span> {</td></tr>
<tr class="codeline" data-linenumber="268"><td class="num" id="LN268">268</td><td class="line">            length = ZDICT_count(b + pos, b + *(suffix+start-1));</td></tr>
<tr class="codeline" data-linenumber="269"><td class="num" id="LN269">269</td><td class="line">            <span class='keyword'>if</span> (length &gt;=<span class='macro'>MINMATCHLENGTH<span class='macro_popup'>7</span></span>) start--;</td></tr>
<tr class="codeline" data-linenumber="270"><td class="num" id="LN270">270</td><td class="line">        } <span class='keyword'>while</span>(length &gt;= <span class='macro'>MINMATCHLENGTH<span class='macro_popup'>7</span></span>);</td></tr>
<tr class="codeline" data-linenumber="271"><td class="num" id="LN271">271</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="272"><td class="num" id="LN272">272</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="273"><td class="num" id="LN273">273</td><td class="line">    <span class='comment'>/* exit if not found a minimum nb of repetitions */</span></td></tr>
<tr class="codeline" data-linenumber="274"><td class="num" id="LN274">274</td><td class="line">    <span class='keyword'>if</span> (end-start &lt; minRatio) {</td></tr>
<tr class="codeline" data-linenumber="275"><td class="num" id="LN275">275</td><td class="line">        U32 idx;</td></tr>
<tr class="codeline" data-linenumber="276"><td class="num" id="LN276">276</td><td class="line">        <span class='keyword'>for</span>(idx=start; idx&lt;end; idx++)</td></tr>
<tr class="codeline" data-linenumber="277"><td class="num" id="LN277">277</td><td class="line">            doneMarks[suffix[idx]] = 1;</td></tr>
<tr class="codeline" data-linenumber="278"><td class="num" id="LN278">278</td><td class="line">        <span class='keyword'>return</span> solution;</td></tr>
<tr class="codeline" data-linenumber="279"><td class="num" id="LN279">279</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="280"><td class="num" id="LN280">280</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="281"><td class="num" id="LN281">281</td><td class="line">    {   <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="282"><td class="num" id="LN282">282</td><td class="line">        U32 mml;</td></tr>
<tr class="codeline" data-linenumber="283"><td class="num" id="LN283">283</td><td class="line">        U32 refinedStart = start;</td></tr>
<tr class="codeline" data-linenumber="284"><td class="num" id="LN284">284</td><td class="line">        U32 refinedEnd = end;</td></tr>
<tr class="codeline" data-linenumber="285"><td class="num" id="LN285">285</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="286"><td class="num" id="LN286">286</td><td class="line">        <span class='macro'>DISPLAYLEVEL(4, <span class='string_literal'>"\n"</span>)<span class='macro_popup'>if (notificationLevel&gt;=4) { { fprintf(stderr, "\n"); fflush<br>( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="287"><td class="num" id="LN287">287</td><td class="line">        <span class='macro'>DISPLAYLEVEL(4, <span class='string_literal'>"found %3u matches of length &gt;= %i at pos %7u  "</span>, (<span class='keyword'>unsigned</span>)(end-start), MINMATCHLENGTH, (<span class='keyword'>unsigned</span>)pos)<span class='macro_popup'>if (notificationLevel&gt;=4) { { fprintf(stderr, "found %3u matches of length &gt;= %i at pos %7u  "<br>, (unsigned)(end-start), 7, (unsigned)pos); fflush( stderr );<br> }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="288"><td class="num" id="LN288">288</td><td class="line">        <span class='macro'>DISPLAYLEVEL(4, <span class='string_literal'>"\n"</span>)<span class='macro_popup'>if (notificationLevel&gt;=4) { { fprintf(stderr, "\n"); fflush<br>( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="289"><td class="num" id="LN289">289</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="290"><td class="num" id="LN290">290</td><td class="line">        <span class='keyword'>for</span> (mml = <span class='macro'>MINMATCHLENGTH<span class='macro_popup'>7</span></span> ; ; mml++) {</td></tr>
<tr class="codeline" data-linenumber="291"><td class="num" id="LN291">291</td><td class="line">            BYTE currentChar = 0;</td></tr>
<tr class="codeline" data-linenumber="292"><td class="num" id="LN292">292</td><td class="line">            U32 currentCount = 0;</td></tr>
<tr class="codeline" data-linenumber="293"><td class="num" id="LN293">293</td><td class="line">            U32 currentID = refinedStart;</td></tr>
<tr class="codeline" data-linenumber="294"><td class="num" id="LN294">294</td><td class="line">            U32 id;</td></tr>
<tr class="codeline" data-linenumber="295"><td class="num" id="LN295">295</td><td class="line">            U32 selectedCount = 0;</td></tr>
<tr class="codeline" data-linenumber="296"><td class="num" id="LN296">296</td><td class="line">            U32 selectedID = currentID;</td></tr>
<tr class="codeline" data-linenumber="297"><td class="num" id="LN297">297</td><td class="line">            <span class='keyword'>for</span> (id =refinedStart; id &lt; refinedEnd; id++) {</td></tr>
<tr class="codeline" data-linenumber="298"><td class="num" id="LN298">298</td><td class="line">                <span class='keyword'>if</span> (b[suffix[id] + mml] != currentChar) {</td></tr>
<tr class="codeline" data-linenumber="299"><td class="num" id="LN299">299</td><td class="line">                    <span class='keyword'>if</span> (currentCount &gt; selectedCount) {</td></tr>
<tr class="codeline" data-linenumber="300"><td class="num" id="LN300">300</td><td class="line">                        selectedCount = currentCount;</td></tr>
<tr class="codeline" data-linenumber="301"><td class="num" id="LN301">301</td><td class="line">                        selectedID = currentID;</td></tr>
<tr class="codeline" data-linenumber="302"><td class="num" id="LN302">302</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="303"><td class="num" id="LN303">303</td><td class="line">                    currentID = id;</td></tr>
<tr class="codeline" data-linenumber="304"><td class="num" id="LN304">304</td><td class="line">                    currentChar = b[ suffix[id] + mml];</td></tr>
<tr class="codeline" data-linenumber="305"><td class="num" id="LN305">305</td><td class="line">                    currentCount = 0;</td></tr>
<tr class="codeline" data-linenumber="306"><td class="num" id="LN306">306</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="307"><td class="num" id="LN307">307</td><td class="line">                currentCount ++;</td></tr>
<tr class="codeline" data-linenumber="308"><td class="num" id="LN308">308</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="309"><td class="num" id="LN309">309</td><td class="line">            <span class='keyword'>if</span> (currentCount &gt; selectedCount) {  <span class='comment'>/* for last */</span></td></tr>
<tr class="codeline" data-linenumber="310"><td class="num" id="LN310">310</td><td class="line">                selectedCount = currentCount;</td></tr>
<tr class="codeline" data-linenumber="311"><td class="num" id="LN311">311</td><td class="line">                selectedID = currentID;</td></tr>
<tr class="codeline" data-linenumber="312"><td class="num" id="LN312">312</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="313"><td class="num" id="LN313">313</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="314"><td class="num" id="LN314">314</td><td class="line">            <span class='keyword'>if</span> (selectedCount &lt; minRatio)</td></tr>
<tr class="codeline" data-linenumber="315"><td class="num" id="LN315">315</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="316"><td class="num" id="LN316">316</td><td class="line">            refinedStart = selectedID;</td></tr>
<tr class="codeline" data-linenumber="317"><td class="num" id="LN317">317</td><td class="line">            refinedEnd = refinedStart + selectedCount;</td></tr>
<tr class="codeline" data-linenumber="318"><td class="num" id="LN318">318</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="319"><td class="num" id="LN319">319</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="320"><td class="num" id="LN320">320</td><td class="line">        <span class='comment'>/* evaluate gain based on new dict */</span></td></tr>
<tr class="codeline" data-linenumber="321"><td class="num" id="LN321">321</td><td class="line">        start = refinedStart;</td></tr>
<tr class="codeline" data-linenumber="322"><td class="num" id="LN322">322</td><td class="line">        pos = suffix[refinedStart];</td></tr>
<tr class="codeline" data-linenumber="323"><td class="num" id="LN323">323</td><td class="line">        end = start;</td></tr>
<tr class="codeline" data-linenumber="324"><td class="num" id="LN324">324</td><td class="line">        memset(lengthList, 0, <span class='keyword'>sizeof</span>(lengthList));</td></tr>
<tr class="codeline" data-linenumber="325"><td class="num" id="LN325">325</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="326"><td class="num" id="LN326">326</td><td class="line">        <span class='comment'>/* look forward */</span></td></tr>
<tr class="codeline" data-linenumber="327"><td class="num" id="LN327">327</td><td class="line">        {   size_t length;</td></tr>
<tr class="codeline" data-linenumber="328"><td class="num" id="LN328">328</td><td class="line">            <span class='keyword'>do</span> {</td></tr>
<tr class="codeline" data-linenumber="329"><td class="num" id="LN329">329</td><td class="line">                end++;</td></tr>
<tr class="codeline" data-linenumber="330"><td class="num" id="LN330">330</td><td class="line">                length = ZDICT_count(b + pos, b + suffix[end]);</td></tr>
<tr class="codeline" data-linenumber="331"><td class="num" id="LN331">331</td><td class="line">                <span class='keyword'>if</span> (length &gt;= <span class='macro'>LLIMIT<span class='macro_popup'>64</span></span>) length = <span class='macro'>LLIMIT<span class='macro_popup'>64</span></span>-1;</td></tr>
<tr class="codeline" data-linenumber="332"><td class="num" id="LN332">332</td><td class="line">                lengthList[length]++;</td></tr>
<tr class="codeline" data-linenumber="333"><td class="num" id="LN333">333</td><td class="line">            } <span class='keyword'>while</span> (length &gt;=<span class='macro'>MINMATCHLENGTH<span class='macro_popup'>7</span></span>);</td></tr>
<tr class="codeline" data-linenumber="334"><td class="num" id="LN334">334</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="335"><td class="num" id="LN335">335</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="336"><td class="num" id="LN336">336</td><td class="line">        <span class='comment'>/* look backward */</span></td></tr>
<tr class="codeline" data-linenumber="337"><td class="num" id="LN337">337</td><td class="line">        {   size_t length = <span class='macro'>MINMATCHLENGTH<span class='macro_popup'>7</span></span>;</td></tr>
<tr class="codeline" data-linenumber="338"><td class="num" id="LN338">338</td><td class="line">            <span class='keyword'>while</span> ((length &gt;= <span class='macro'>MINMATCHLENGTH<span class='macro_popup'>7</span></span>) &amp; (start &gt; 0)) {</td></tr>
<tr class="codeline" data-linenumber="339"><td class="num" id="LN339">339</td><td class="line">                length = ZDICT_count(b + pos, b + suffix[start - 1]);</td></tr>
<tr class="codeline" data-linenumber="340"><td class="num" id="LN340">340</td><td class="line">                <span class='keyword'>if</span> (length &gt;= <span class='macro'>LLIMIT<span class='macro_popup'>64</span></span>) length = <span class='macro'>LLIMIT<span class='macro_popup'>64</span></span> - 1;</td></tr>
<tr class="codeline" data-linenumber="341"><td class="num" id="LN341">341</td><td class="line">                lengthList[length]++;</td></tr>
<tr class="codeline" data-linenumber="342"><td class="num" id="LN342">342</td><td class="line">                <span class='keyword'>if</span> (length &gt;= <span class='macro'>MINMATCHLENGTH<span class='macro_popup'>7</span></span>) start--;</td></tr>
<tr class="codeline" data-linenumber="343"><td class="num" id="LN343">343</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="344"><td class="num" id="LN344">344</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="345"><td class="num" id="LN345">345</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="346"><td class="num" id="LN346">346</td><td class="line">        <span class='comment'>/* largest useful length */</span></td></tr>
<tr class="codeline" data-linenumber="347"><td class="num" id="LN347">347</td><td class="line">        memset(cumulLength, 0, <span class='keyword'>sizeof</span>(cumulLength));</td></tr>
<tr class="codeline" data-linenumber="348"><td class="num" id="LN348">348</td><td class="line">        cumulLength[maxLength-1] = lengthList[maxLength-1];</td></tr>
<tr class="codeline" data-linenumber="349"><td class="num" id="LN349">349</td><td class="line">        <span class='keyword'>for</span> (i=(<span class='keyword'>int</span>)(maxLength-2); i&gt;=0; i--)</td></tr>
<tr class="codeline" data-linenumber="350"><td class="num" id="LN350">350</td><td class="line">            cumulLength[i] = cumulLength[i+1] + lengthList[i];</td></tr>
<tr class="codeline" data-linenumber="351"><td class="num" id="LN351">351</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="352"><td class="num" id="LN352">352</td><td class="line">        <span class='keyword'>for</span> (i=<span class='macro'>LLIMIT<span class='macro_popup'>64</span></span>-1; i&gt;=<span class='macro'>MINMATCHLENGTH<span class='macro_popup'>7</span></span>; i--) <span class='keyword'>if</span> (cumulLength[i]&gt;=minRatio) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="353"><td class="num" id="LN353">353</td><td class="line">        maxLength = i;</td></tr>
<tr class="codeline" data-linenumber="354"><td class="num" id="LN354">354</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="355"><td class="num" id="LN355">355</td><td class="line">        <span class='comment'>/* reduce maxLength in case of final into repetitive data */</span></td></tr>
<tr class="codeline" data-linenumber="356"><td class="num" id="LN356">356</td><td class="line">        {   U32 l = (U32)maxLength;</td></tr>
<tr class="codeline" data-linenumber="357"><td class="num" id="LN357">357</td><td class="line">            BYTE <span class='keyword'>const</span> c = b[pos + maxLength-1];</td></tr>
<tr class="codeline" data-linenumber="358"><td class="num" id="LN358">358</td><td class="line">            <span class='keyword'>while</span> (b[pos+l-2]==c) l--;</td></tr>
<tr class="codeline" data-linenumber="359"><td class="num" id="LN359">359</td><td class="line">            maxLength = l;</td></tr>
<tr class="codeline" data-linenumber="360"><td class="num" id="LN360">360</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="361"><td class="num" id="LN361">361</td><td class="line">        <span class='keyword'>if</span> (maxLength &lt; <span class='macro'>MINMATCHLENGTH<span class='macro_popup'>7</span></span>) <span class='keyword'>return</span> solution;   <span class='comment'>/* skip : no long-enough solution */</span></td></tr>
<tr class="codeline" data-linenumber="362"><td class="num" id="LN362">362</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="363"><td class="num" id="LN363">363</td><td class="line">        <span class='comment'>/* calculate savings */</span></td></tr>
<tr class="codeline" data-linenumber="364"><td class="num" id="LN364">364</td><td class="line">        savings[5] = 0;</td></tr>
<tr class="codeline" data-linenumber="365"><td class="num" id="LN365">365</td><td class="line">        <span class='keyword'>for</span> (i=<span class='macro'>MINMATCHLENGTH<span class='macro_popup'>7</span></span>; i&lt;=(<span class='keyword'>int</span>)maxLength; i++)</td></tr>
<tr class="codeline" data-linenumber="366"><td class="num" id="LN366">366</td><td class="line">            savings[i] = savings[i-1] + (lengthList[i] * (i-3));</td></tr>
<tr class="codeline" data-linenumber="367"><td class="num" id="LN367">367</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="368"><td class="num" id="LN368">368</td><td class="line">        <span class='macro'>DISPLAYLEVEL(4, <span class='string_literal'>"Selected dict at position %u, of length %u : saves %u (ratio: %.2f)  \n"</span>,<span class='macro_popup'>if (notificationLevel&gt;=4) { { fprintf(stderr, "Selected dict at position %u, of length %u : saves %u (ratio: %.2f)  \n"<br>, (unsigned)pos, (unsigned)maxLength, (unsigned)savings[maxLength<br>], (double)savings[maxLength] / maxLength); fflush( stderr );<br> }; }</span></span></td></tr>
<tr class="codeline" data-linenumber="369"><td class="num" id="LN369">369</td><td class="line">                     <span class='macro'>(<span class='keyword'>unsigned</span>)pos, (<span class='keyword'>unsigned</span>)maxLength, (<span class='keyword'>unsigned</span>)savings[maxLength], (<span class='keyword'>double</span>)savings[maxLength] / maxLength)<span class='macro_popup'>if (notificationLevel&gt;=4) { { fprintf(stderr, "Selected dict at position %u, of length %u : saves %u (ratio: %.2f)  \n"<br>, (unsigned)pos, (unsigned)maxLength, (unsigned)savings[maxLength<br>], (double)savings[maxLength] / maxLength); fflush( stderr );<br> }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="370"><td class="num" id="LN370">370</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="371"><td class="num" id="LN371">371</td><td class="line">        solution.pos = (U32)pos;</td></tr>
<tr class="codeline" data-linenumber="372"><td class="num" id="LN372">372</td><td class="line">        solution.length = (U32)maxLength;</td></tr>
<tr class="codeline" data-linenumber="373"><td class="num" id="LN373">373</td><td class="line">        solution.savings = savings[maxLength];</td></tr>
<tr class="codeline" data-linenumber="374"><td class="num" id="LN374">374</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="375"><td class="num" id="LN375">375</td><td class="line">        <span class='comment'>/* mark positions done */</span></td></tr>
<tr class="codeline" data-linenumber="376"><td class="num" id="LN376">376</td><td class="line">        {   U32 id;</td></tr>
<tr class="codeline" data-linenumber="377"><td class="num" id="LN377">377</td><td class="line">            <span class='keyword'>for</span> (id=start; id&lt;end; id++) {</td></tr>
<tr class="codeline" data-linenumber="378"><td class="num" id="LN378">378</td><td class="line">                U32 p, pEnd, length;</td></tr>
<tr class="codeline" data-linenumber="379"><td class="num" id="LN379">379</td><td class="line">                U32 <span class='keyword'>const</span> testedPos = suffix[id];</td></tr>
<tr class="codeline" data-linenumber="380"><td class="num" id="LN380">380</td><td class="line">                <span class='keyword'>if</span> (testedPos == pos)</td></tr>
<tr class="codeline" data-linenumber="381"><td class="num" id="LN381">381</td><td class="line">                    length = solution.length;</td></tr>
<tr class="codeline" data-linenumber="382"><td class="num" id="LN382">382</td><td class="line">                <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="383"><td class="num" id="LN383">383</td><td class="line">                    length = (U32)ZDICT_count(b+pos, b+testedPos);</td></tr>
<tr class="codeline" data-linenumber="384"><td class="num" id="LN384">384</td><td class="line">                    <span class='keyword'>if</span> (length &gt; solution.length) length = solution.length;</td></tr>
<tr class="codeline" data-linenumber="385"><td class="num" id="LN385">385</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="386"><td class="num" id="LN386">386</td><td class="line">                pEnd = (U32)(testedPos + length);</td></tr>
<tr class="codeline" data-linenumber="387"><td class="num" id="LN387">387</td><td class="line">                <span class='keyword'>for</span> (p=testedPos; p&lt;pEnd; p++)</td></tr>
<tr class="codeline" data-linenumber="388"><td class="num" id="LN388">388</td><td class="line">                    doneMarks[p] = 1;</td></tr>
<tr class="codeline" data-linenumber="389"><td class="num" id="LN389">389</td><td class="line">    }   }   }</td></tr>
<tr class="codeline" data-linenumber="390"><td class="num" id="LN390">390</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="391"><td class="num" id="LN391">391</td><td class="line">    <span class='keyword'>return</span> solution;</td></tr>
<tr class="codeline" data-linenumber="392"><td class="num" id="LN392">392</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="393"><td class="num" id="LN393">393</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="394"><td class="num" id="LN394">394</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="395"><td class="num" id="LN395">395</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> isIncluded(<span class='keyword'>const</span> <span class='keyword'>void</span>* in, <span class='keyword'>const</span> <span class='keyword'>void</span>* container, size_t length)</td></tr>
<tr class="codeline" data-linenumber="396"><td class="num" id="LN396">396</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="397"><td class="num" id="LN397">397</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span>* <span class='keyword'>const</span> ip = (<span class='keyword'>const</span> <span class='keyword'>char</span>*) in;</td></tr>
<tr class="codeline" data-linenumber="398"><td class="num" id="LN398">398</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span>* <span class='keyword'>const</span> into = (<span class='keyword'>const</span> <span class='keyword'>char</span>*) container;</td></tr>
<tr class="codeline" data-linenumber="399"><td class="num" id="LN399">399</td><td class="line">    size_t u;</td></tr>
<tr class="codeline" data-linenumber="400"><td class="num" id="LN400">400</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="401"><td class="num" id="LN401">401</td><td class="line">    <span class='keyword'>for</span> (u=0; u&lt;length; u++) {  <span class='comment'>/* works because end of buffer is a noisy guard band */</span></td></tr>
<tr class="codeline" data-linenumber="402"><td class="num" id="LN402">402</td><td class="line">        <span class='keyword'>if</span> (ip[u] != into[u]) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="403"><td class="num" id="LN403">403</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="404"><td class="num" id="LN404">404</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="405"><td class="num" id="LN405">405</td><td class="line">    <span class='keyword'>return</span> u==length;</td></tr>
<tr class="codeline" data-linenumber="406"><td class="num" id="LN406">406</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="407"><td class="num" id="LN407">407</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="408"><td class="num" id="LN408">408</td><td class="line"><span class='comment'>/*! ZDICT_tryMerge() :</span></td></tr>
<tr class="codeline" data-linenumber="409"><td class="num" id="LN409">409</td><td class="line">    <span class='comment'>check if dictItem can be merged, do it if possible</span></td></tr>
<tr class="codeline" data-linenumber="410"><td class="num" id="LN410">410</td><td class="line">    <span class='comment'>@return : id of destination elt, 0 if not merged</span></td></tr>
<tr class="codeline" data-linenumber="411"><td class="num" id="LN411">411</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="412"><td class="num" id="LN412">412</td><td class="line"><span class='keyword'>static</span> U32 ZDICT_tryMerge(dictItem* table, dictItem elt, U32 eltNbToSkip, <span class='keyword'>const</span> <span class='keyword'>void</span>* buffer)</td></tr>
<tr class="codeline" data-linenumber="413"><td class="num" id="LN413">413</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="414"><td class="num" id="LN414">414</td><td class="line">    <span class='keyword'>const</span> U32 tableSize = table-&gt;pos;</td></tr>
<tr class="codeline" data-linenumber="415"><td class="num" id="LN415">415</td><td class="line">    <span class='keyword'>const</span> U32 eltEnd = elt.pos + elt.length;</td></tr>
<tr class="codeline" data-linenumber="416"><td class="num" id="LN416">416</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span>* <span class='keyword'>const</span> buf = (<span class='keyword'>const</span> <span class='keyword'>char</span>*) buffer;</td></tr>
<tr class="codeline" data-linenumber="417"><td class="num" id="LN417">417</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="418"><td class="num" id="LN418">418</td><td class="line">    <span class='comment'>/* tail overlap */</span></td></tr>
<tr class="codeline" data-linenumber="419"><td class="num" id="LN419">419</td><td class="line">    U32 u; <span class='keyword'>for</span> (u=1; u&lt;tableSize; u++) {</td></tr>
<tr class="codeline" data-linenumber="420"><td class="num" id="LN420">420</td><td class="line">        <span class='keyword'>if</span> (u==eltNbToSkip) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="421"><td class="num" id="LN421">421</td><td class="line">        <span class='keyword'>if</span> ((table[u].pos &gt; elt.pos) &amp;&amp; (table[u].pos &lt;= eltEnd)) {  <span class='comment'>/* overlap, existing &gt; new */</span></td></tr>
<tr class="codeline" data-linenumber="422"><td class="num" id="LN422">422</td><td class="line">            <span class='comment'>/* append */</span></td></tr>
<tr class="codeline" data-linenumber="423"><td class="num" id="LN423">423</td><td class="line">            U32 <span class='keyword'>const</span> addedLength = table[u].pos - elt.pos;</td></tr>
<tr class="codeline" data-linenumber="424"><td class="num" id="LN424">424</td><td class="line">            table[u].length += addedLength;</td></tr>
<tr class="codeline" data-linenumber="425"><td class="num" id="LN425">425</td><td class="line">            table[u].pos = elt.pos;</td></tr>
<tr class="codeline" data-linenumber="426"><td class="num" id="LN426">426</td><td class="line">            table[u].savings += elt.savings * addedLength / elt.length;   <span class='comment'>/* rough approx */</span></td></tr>
<tr class="codeline" data-linenumber="427"><td class="num" id="LN427">427</td><td class="line">            table[u].savings += elt.length / 8;    <span class='comment'>/* rough approx bonus */</span></td></tr>
<tr class="codeline" data-linenumber="428"><td class="num" id="LN428">428</td><td class="line">            elt = table[u];</td></tr>
<tr class="codeline" data-linenumber="429"><td class="num" id="LN429">429</td><td class="line">            <span class='comment'>/* sort : improve rank */</span></td></tr>
<tr class="codeline" data-linenumber="430"><td class="num" id="LN430">430</td><td class="line">            <span class='keyword'>while</span> ((u&gt;1) &amp;&amp; (table[u-1].savings &lt; elt.savings))</td></tr>
<tr class="codeline" data-linenumber="431"><td class="num" id="LN431">431</td><td class="line">            table[u] = table[u-1], u--;</td></tr>
<tr class="codeline" data-linenumber="432"><td class="num" id="LN432">432</td><td class="line">            table[u] = elt;</td></tr>
<tr class="codeline" data-linenumber="433"><td class="num" id="LN433">433</td><td class="line">            <span class='keyword'>return</span> u;</td></tr>
<tr class="codeline" data-linenumber="434"><td class="num" id="LN434">434</td><td class="line">    }   }</td></tr>
<tr class="codeline" data-linenumber="435"><td class="num" id="LN435">435</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="436"><td class="num" id="LN436">436</td><td class="line">    <span class='comment'>/* front overlap */</span></td></tr>
<tr class="codeline" data-linenumber="437"><td class="num" id="LN437">437</td><td class="line">    <span class='keyword'>for</span> (u=1; u&lt;tableSize; u++) {</td></tr>
<tr class="codeline" data-linenumber="438"><td class="num" id="LN438">438</td><td class="line">        <span class='keyword'>if</span> (u==eltNbToSkip) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="439"><td class="num" id="LN439">439</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="440"><td class="num" id="LN440">440</td><td class="line">        <span class='keyword'>if</span> ((table[u].pos + table[u].length &gt;= elt.pos) &amp;&amp; (table[u].pos &lt; elt.pos)) {  <span class='comment'>/* overlap, existing &lt; new */</span></td></tr>
<tr class="codeline" data-linenumber="441"><td class="num" id="LN441">441</td><td class="line">            <span class='comment'>/* append */</span></td></tr>
<tr class="codeline" data-linenumber="442"><td class="num" id="LN442">442</td><td class="line">            <span class='keyword'>int</span> <span class='keyword'>const</span> addedLength = (<span class='keyword'>int</span>)eltEnd - (table[u].pos + table[u].length);</td></tr>
<tr class="codeline" data-linenumber="443"><td class="num" id="LN443">443</td><td class="line">            table[u].savings += elt.length / 8;    <span class='comment'>/* rough approx bonus */</span></td></tr>
<tr class="codeline" data-linenumber="444"><td class="num" id="LN444">444</td><td class="line">            <span class='keyword'>if</span> (addedLength &gt; 0) {   <span class='comment'>/* otherwise, elt fully included into existing */</span></td></tr>
<tr class="codeline" data-linenumber="445"><td class="num" id="LN445">445</td><td class="line">                table[u].length += addedLength;</td></tr>
<tr class="codeline" data-linenumber="446"><td class="num" id="LN446">446</td><td class="line">                table[u].savings += elt.savings * addedLength / elt.length;   <span class='comment'>/* rough approx */</span></td></tr>
<tr class="codeline" data-linenumber="447"><td class="num" id="LN447">447</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="448"><td class="num" id="LN448">448</td><td class="line">            <span class='comment'>/* sort : improve rank */</span></td></tr>
<tr class="codeline" data-linenumber="449"><td class="num" id="LN449">449</td><td class="line">            elt = table[u];</td></tr>
<tr class="codeline" data-linenumber="450"><td class="num" id="LN450">450</td><td class="line">            <span class='keyword'>while</span> ((u&gt;1) &amp;&amp; (table[u-1].savings &lt; elt.savings))</td></tr>
<tr class="codeline" data-linenumber="451"><td class="num" id="LN451">451</td><td class="line">                table[u] = table[u-1], u--;</td></tr>
<tr class="codeline" data-linenumber="452"><td class="num" id="LN452">452</td><td class="line">            table[u] = elt;</td></tr>
<tr class="codeline" data-linenumber="453"><td class="num" id="LN453">453</td><td class="line">            <span class='keyword'>return</span> u;</td></tr>
<tr class="codeline" data-linenumber="454"><td class="num" id="LN454">454</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="455"><td class="num" id="LN455">455</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="456"><td class="num" id="LN456">456</td><td class="line">        <span class='keyword'>if</span> (MEM_read64(buf + table[u].pos) == MEM_read64(buf + elt.pos + 1)) {</td></tr>
<tr class="codeline" data-linenumber="457"><td class="num" id="LN457">457</td><td class="line">            <span class='keyword'>if</span> (isIncluded(buf + table[u].pos, buf + elt.pos + 1, table[u].length)) {</td></tr>
<tr class="codeline" data-linenumber="458"><td class="num" id="LN458">458</td><td class="line">                size_t <span class='keyword'>const</span> addedLength = <span class='macro'>MAX( (<span class='keyword'>int</span>)elt.length - (<span class='keyword'>int</span>)table[u].length , 1 )<span class='macro_popup'>(((int)elt.length - (int)table[u].length)&gt;(1) ? ((int)elt.<br>length - (int)table[u].length) : (1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="459"><td class="num" id="LN459">459</td><td class="line">                table[u].pos = elt.pos;</td></tr>
<tr class="codeline" data-linenumber="460"><td class="num" id="LN460">460</td><td class="line">                table[u].savings += (U32)(elt.savings * addedLength / elt.length);</td></tr>
<tr class="codeline" data-linenumber="461"><td class="num" id="LN461">461</td><td class="line">                table[u].length = <span class='macro'>MIN(elt.length, table[u].length + 1)<span class='macro_popup'>((elt.length)&lt;(table[u].length + 1) ? (elt.length) : (table<br>[u].length + 1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="462"><td class="num" id="LN462">462</td><td class="line">                <span class='keyword'>return</span> u;</td></tr>
<tr class="codeline" data-linenumber="463"><td class="num" id="LN463">463</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="464"><td class="num" id="LN464">464</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="465"><td class="num" id="LN465">465</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="466"><td class="num" id="LN466">466</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="467"><td class="num" id="LN467">467</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="468"><td class="num" id="LN468">468</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="469"><td class="num" id="LN469">469</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="470"><td class="num" id="LN470">470</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="471"><td class="num" id="LN471">471</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> ZDICT_removeDictItem(dictItem* table, U32 id)</td></tr>
<tr class="codeline" data-linenumber="472"><td class="num" id="LN472">472</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="473"><td class="num" id="LN473">473</td><td class="line">    <span class='comment'>/* convention : table[0].pos stores nb of elts */</span></td></tr>
<tr class="codeline" data-linenumber="474"><td class="num" id="LN474">474</td><td class="line">    U32 <span class='keyword'>const</span> max = table[0].pos;</td></tr>
<tr class="codeline" data-linenumber="475"><td class="num" id="LN475">475</td><td class="line">    U32 u;</td></tr>
<tr class="codeline" data-linenumber="476"><td class="num" id="LN476">476</td><td class="line">    <span class='keyword'>if</span> (!id) <span class='keyword'>return</span>;   <span class='comment'>/* protection, should never happen */</span></td></tr>
<tr class="codeline" data-linenumber="477"><td class="num" id="LN477">477</td><td class="line">    <span class='keyword'>for</span> (u=id; u&lt;max-1; u++)</td></tr>
<tr class="codeline" data-linenumber="478"><td class="num" id="LN478">478</td><td class="line">        table[u] = table[u+1];</td></tr>
<tr class="codeline" data-linenumber="479"><td class="num" id="LN479">479</td><td class="line">    table-&gt;pos--;</td></tr>
<tr class="codeline" data-linenumber="480"><td class="num" id="LN480">480</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="481"><td class="num" id="LN481">481</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="482"><td class="num" id="LN482">482</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="483"><td class="num" id="LN483">483</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> ZDICT_insertDictItem(dictItem* table, U32 maxSize, dictItem elt, <span class='keyword'>const</span> <span class='keyword'>void</span>* buffer)</td></tr>
<tr class="codeline" data-linenumber="484"><td class="num" id="LN484">484</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="485"><td class="num" id="LN485">485</td><td class="line">    <span class='comment'>/* merge if possible */</span></td></tr>
<tr class="codeline" data-linenumber="486"><td class="num" id="LN486">486</td><td class="line">    U32 mergeId = ZDICT_tryMerge(table, elt, 0, buffer);</td></tr>
<tr class="codeline" data-linenumber="487"><td class="num" id="LN487">487</td><td class="line">    <span class='keyword'>if</span> (mergeId) {</td></tr>
<tr class="codeline" data-linenumber="488"><td class="num" id="LN488">488</td><td class="line">        U32 newMerge = 1;</td></tr>
<tr class="codeline" data-linenumber="489"><td class="num" id="LN489">489</td><td class="line">        <span class='keyword'>while</span> (newMerge) {</td></tr>
<tr class="codeline" data-linenumber="490"><td class="num" id="LN490">490</td><td class="line">            newMerge = ZDICT_tryMerge(table, table[mergeId], mergeId, buffer);</td></tr>
<tr class="codeline" data-linenumber="491"><td class="num" id="LN491">491</td><td class="line">            <span class='keyword'>if</span> (newMerge) ZDICT_removeDictItem(table, mergeId);</td></tr>
<tr class="codeline" data-linenumber="492"><td class="num" id="LN492">492</td><td class="line">            mergeId = newMerge;</td></tr>
<tr class="codeline" data-linenumber="493"><td class="num" id="LN493">493</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="494"><td class="num" id="LN494">494</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="495"><td class="num" id="LN495">495</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="496"><td class="num" id="LN496">496</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="497"><td class="num" id="LN497">497</td><td class="line">    <span class='comment'>/* insert */</span></td></tr>
<tr class="codeline" data-linenumber="498"><td class="num" id="LN498">498</td><td class="line">    {   U32 current;</td></tr>
<tr class="codeline" data-linenumber="499"><td class="num" id="LN499">499</td><td class="line">        U32 nextElt = table-&gt;pos;</td></tr>
<tr class="codeline" data-linenumber="500"><td class="num" id="LN500">500</td><td class="line">        <span class='keyword'>if</span> (nextElt &gt;= maxSize) nextElt = maxSize-1;</td></tr>
<tr class="codeline" data-linenumber="501"><td class="num" id="LN501">501</td><td class="line">        current = nextElt-1;</td></tr>
<tr class="codeline" data-linenumber="502"><td class="num" id="LN502">502</td><td class="line">        <span class='keyword'>while</span> (table[current].savings &lt; elt.savings) {</td></tr>
<tr class="codeline" data-linenumber="503"><td class="num" id="LN503">503</td><td class="line">            table[current+1] = table[current];</td></tr>
<tr class="codeline" data-linenumber="504"><td class="num" id="LN504">504</td><td class="line">            current--;</td></tr>
<tr class="codeline" data-linenumber="505"><td class="num" id="LN505">505</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="506"><td class="num" id="LN506">506</td><td class="line">        table[current+1] = elt;</td></tr>
<tr class="codeline" data-linenumber="507"><td class="num" id="LN507">507</td><td class="line">        table-&gt;pos = nextElt+1;</td></tr>
<tr class="codeline" data-linenumber="508"><td class="num" id="LN508">508</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="509"><td class="num" id="LN509">509</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="510"><td class="num" id="LN510">510</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="511"><td class="num" id="LN511">511</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="512"><td class="num" id="LN512">512</td><td class="line"><span class='keyword'>static</span> U32 ZDICT_dictSize(<span class='keyword'>const</span> dictItem* dictList)</td></tr>
<tr class="codeline" data-linenumber="513"><td class="num" id="LN513">513</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="514"><td class="num" id="LN514">514</td><td class="line">    U32 u, dictSize = 0;</td></tr>
<tr class="codeline" data-linenumber="515"><td class="num" id="LN515">515</td><td class="line">    <span class='keyword'>for</span> (u=1; u&lt;dictList[0].pos; u++)</td></tr>
<tr class="codeline" data-linenumber="516"><td class="num" id="LN516">516</td><td class="line">        dictSize += dictList[u].length;</td></tr>
<tr class="codeline" data-linenumber="517"><td class="num" id="LN517">517</td><td class="line">    <span class='keyword'>return</span> dictSize;</td></tr>
<tr class="codeline" data-linenumber="518"><td class="num" id="LN518">518</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="519"><td class="num" id="LN519">519</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="520"><td class="num" id="LN520">520</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="521"><td class="num" id="LN521">521</td><td class="line"><span class='keyword'>static</span> size_t ZDICT_trainBuffer_legacy(dictItem* dictList, U32 dictListSize,</td></tr>
<tr class="codeline" data-linenumber="522"><td class="num" id="LN522">522</td><td class="line">                            <span class='keyword'>const</span> <span class='keyword'>void</span>* <span class='keyword'>const</span> buffer, size_t bufferSize,   <span class='comment'>/* buffer must end with noisy guard band */</span></td></tr>
<tr class="codeline" data-linenumber="523"><td class="num" id="LN523">523</td><td class="line">                            <span class='keyword'>const</span> size_t* fileSizes, <span class='keyword'>unsigned</span> nbFiles,</td></tr>
<tr class="codeline" data-linenumber="524"><td class="num" id="LN524">524</td><td class="line">                            <span class='keyword'>unsigned</span> minRatio, U32 notificationLevel)</td></tr>
<tr class="codeline" data-linenumber="525"><td class="num" id="LN525">525</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="526"><td class="num" id="LN526">526</td><td class="line">    <span class='keyword'>int</span>* <span class='keyword'>const</span> suffix0 = (<span class='keyword'>int</span>*)malloc((bufferSize+2)*<span class='keyword'>sizeof</span>(*suffix0));</td></tr>
<tr class="codeline" data-linenumber="527"><td class="num" id="LN527">527</td><td class="line">    <span class='keyword'>int</span>* <span class='keyword'>const</span> suffix = suffix0+1;</td></tr>
<tr class="codeline" data-linenumber="528"><td class="num" id="LN528">528</td><td class="line">    U32* reverseSuffix = (U32*)malloc((bufferSize)*<span class='keyword'>sizeof</span>(*reverseSuffix));</td></tr>
<tr class="codeline" data-linenumber="529"><td class="num" id="LN529">529</td><td class="line">    BYTE* doneMarks = (BYTE*)malloc((bufferSize+16)*<span class='keyword'>sizeof</span>(*doneMarks));   <span class='comment'>/* +16 for overflow security */</span></td></tr>
<tr class="codeline" data-linenumber="530"><td class="num" id="LN530">530</td><td class="line">    U32* filePos = (U32*)malloc(nbFiles * <span class='keyword'>sizeof</span>(*filePos));</td></tr>
<tr class="codeline" data-linenumber="531"><td class="num" id="LN531">531</td><td class="line">    size_t result = 0;</td></tr>
<tr class="codeline" data-linenumber="532"><td class="num" id="LN532">532</td><td class="line">    clock_t displayClock = 0;</td></tr>
<tr class="codeline" data-linenumber="533"><td class="num" id="LN533">533</td><td class="line">    clock_t <span class='keyword'>const</span> refreshRate = <span class='macro'>CLOCKS_PER_SEC<span class='macro_popup'>((__clock_t) 1000000)</span></span> * 3 / 10;</td></tr>
<tr class="codeline" data-linenumber="534"><td class="num" id="LN534">534</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="535"><td class="num" id="LN535">535</td><td class="line"><span class='directive'>#   define <span class='macro'>DISPLAYUPDATE(l, ...)<span class='macro_popup'>if (notificationLevel&gt;=l) { if (ZDICT_clockSpan(displayClock<br>) &gt; refreshRate) { displayClock = clock(); { fprintf(stderr<br>, ...); fflush( stderr ); }; if (notificationLevel&gt;=4) fflush<br>(stderr); } }</span></span> if (notificationLevel&gt;=l) { \</span></td></tr>
<tr class="codeline" data-linenumber="536"><td class="num" id="LN536">536</td><td class="line">            <span class='directive'>if (ZDICT_clockSpan(displayClock) &gt; refreshRate)  \</span></td></tr>
<tr class="codeline" data-linenumber="537"><td class="num" id="LN537">537</td><td class="line">            <span class='directive'>{ displayClock = clock(); <span class='macro'>DISPLAY(__VA_ARGS__)<span class='macro_popup'>{ fprintf(stderr, __VA_ARGS__); fflush( stderr ); }</span></span>; \</span></td></tr>
<tr class="codeline" data-linenumber="538"><td class="num" id="LN538">538</td><td class="line">            <span class='directive'>if (notificationLevel&gt;=4) fflush(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>); } }</span></td></tr>
<tr class="codeline" data-linenumber="539"><td class="num" id="LN539">539</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="540"><td class="num" id="LN540">540</td><td class="line">    <span class='comment'>/* init */</span></td></tr>
<tr class="codeline" data-linenumber="541"><td class="num" id="LN541">541</td><td class="line">    <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"\r%70s\r"</span>, <span class='string_literal'>""</span>)<span class='macro_popup'>if (notificationLevel&gt;=2) { { fprintf(stderr, "\r%70s\r", ""<br>); fflush( stderr ); }; }</span></span>;   <span class='comment'>/* clean display line */</span></td></tr>
<tr class="codeline" data-linenumber="542"><td class="num" id="LN542">542</td><td class="line">    <span class='keyword'>if</span> (!suffix0 || !reverseSuffix || !doneMarks || !filePos) {</td></tr>
<tr class="codeline" data-linenumber="543"><td class="num" id="LN543">543</td><td class="line">        result = <span class='macro'>ERROR(memory_allocation)<span class='macro_popup'>((size_t)-ZSTD_error_memory_allocation)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="544"><td class="num" id="LN544">544</td><td class="line">        <span class='keyword'>goto</span> _cleanup;</td></tr>
<tr class="codeline" data-linenumber="545"><td class="num" id="LN545">545</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="546"><td class="num" id="LN546">546</td><td class="line">    <span class='keyword'>if</span> (minRatio &lt; <span class='macro'>MINRATIO<span class='macro_popup'>4</span></span>) minRatio = <span class='macro'>MINRATIO<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="547"><td class="num" id="LN547">547</td><td class="line">    memset(doneMarks, 0, bufferSize+16);</td></tr>
<tr class="codeline" data-linenumber="548"><td class="num" id="LN548">548</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="549"><td class="num" id="LN549">549</td><td class="line">    <span class='comment'>/* limit sample set size (divsufsort limitation)*/</span></td></tr>
<tr class="codeline" data-linenumber="550"><td class="num" id="LN550">550</td><td class="line">    <span class='keyword'>if</span> (bufferSize &gt; <span class='macro'>ZDICT_MAX_SAMPLES_SIZE<span class='macro_popup'>(2000U &lt;&lt; 20)</span></span>) <span class='macro'>DISPLAYLEVEL(3, <span class='string_literal'>"sample set too large : reduced to %u MB ...\n"</span>, (<span class='keyword'>unsigned</span>)(ZDICT_MAX_SAMPLES_SIZE&gt;&gt;20))<span class='macro_popup'>if (notificationLevel&gt;=3) { { fprintf(stderr, "sample set too large : reduced to %u MB ...\n"<br>, (unsigned)((2000U &lt;&lt; 20)&gt;&gt;20)); fflush( stderr )<br>; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="551"><td class="num" id="LN551">551</td><td class="line">    <span class='keyword'>while</span> (bufferSize &gt; <span class='macro'>ZDICT_MAX_SAMPLES_SIZE<span class='macro_popup'>(2000U &lt;&lt; 20)</span></span>) bufferSize -= fileSizes[--nbFiles];</td></tr>
<tr class="codeline" data-linenumber="552"><td class="num" id="LN552">552</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="553"><td class="num" id="LN553">553</td><td class="line">    <span class='comment'>/* sort */</span></td></tr>
<tr class="codeline" data-linenumber="554"><td class="num" id="LN554">554</td><td class="line">    <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"sorting %u files of total size %u MB ...\n"</span>, nbFiles, (<span class='keyword'>unsigned</span>)(bufferSize&gt;&gt;20))<span class='macro_popup'>if (notificationLevel&gt;=2) { { fprintf(stderr, "sorting %u files of total size %u MB ...\n"<br>, nbFiles, (unsigned)(bufferSize&gt;&gt;20)); fflush( stderr )<br>; }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="555"><td class="num" id="LN555">555</td><td class="line">    {   <span class='keyword'>int</span> <span class='keyword'>const</span> divSuftSortResult = divsufsort((<span class='keyword'>const</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)buffer, suffix, (<span class='keyword'>int</span>)bufferSize, 0);</td></tr>
<tr class="codeline" data-linenumber="556"><td class="num" id="LN556">556</td><td class="line">        <span class='keyword'>if</span> (divSuftSortResult != 0) { result = <span class='macro'>ERROR(GENERIC)<span class='macro_popup'>((size_t)-ZSTD_error_GENERIC)</span></span>; <span class='keyword'>goto</span> _cleanup; }</td></tr>
<tr class="codeline" data-linenumber="557"><td class="num" id="LN557">557</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="558"><td class="num" id="LN558">558</td><td class="line">    suffix[bufferSize] = (<span class='keyword'>int</span>)bufferSize;   <span class='comment'>/* leads into noise */</span></td></tr>
<tr class="codeline" data-linenumber="559"><td class="num" id="LN559">559</td><td class="line">    suffix0[0] = (<span class='keyword'>int</span>)bufferSize;           <span class='comment'>/* leads into noise */</span></td></tr>
<tr class="codeline" data-linenumber="560"><td class="num" id="LN560">560</td><td class="line">    <span class='comment'>/* build reverse suffix sort */</span></td></tr>
<tr class="codeline" data-linenumber="561"><td class="num" id="LN561">561</td><td class="line">    {   size_t pos;</td></tr>
<tr class="codeline" data-linenumber="562"><td class="num" id="LN562">562</td><td class="line">        <span class='keyword'>for</span> (pos=0; pos &lt; bufferSize; pos++)</td></tr>
<tr class="codeline" data-linenumber="563"><td class="num" id="LN563">563</td><td class="line">            reverseSuffix[suffix[pos]] = (U32)pos;</td></tr>
<tr class="codeline" data-linenumber="564"><td class="num" id="LN564">564</td><td class="line">        <span class='comment'>/* note filePos tracks borders between samples.</span></td></tr>
<tr class="codeline" data-linenumber="565"><td class="num" id="LN565">565</td><td class="line">           <span class='comment'>It's not used at this stage, but planned to become useful in a later update */</span></td></tr>
<tr class="codeline" data-linenumber="566"><td class="num" id="LN566">566</td><td class="line">        filePos[0] = 0;</td></tr>
<tr class="codeline" data-linenumber="567"><td class="num" id="LN567">567</td><td class="line">        <span class='keyword'>for</span> (pos=1; pos&lt;nbFiles; pos++)</td></tr>
<tr class="codeline" data-linenumber="568"><td class="num" id="LN568">568</td><td class="line">            filePos[pos] = (U32)(filePos[pos-1] + fileSizes[pos-1]);</td></tr>
<tr class="codeline" data-linenumber="569"><td class="num" id="LN569">569</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="570"><td class="num" id="LN570">570</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="571"><td class="num" id="LN571">571</td><td class="line">    <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"finding patterns ... \n"</span>)<span class='macro_popup'>if (notificationLevel&gt;=2) { { fprintf(stderr, "finding patterns ... \n"<br>); fflush( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="572"><td class="num" id="LN572">572</td><td class="line">    <span class='macro'>DISPLAYLEVEL(3, <span class='string_literal'>"minimum ratio : %u \n"</span>, minRatio)<span class='macro_popup'>if (notificationLevel&gt;=3) { { fprintf(stderr, "minimum ratio : %u \n"<br>, minRatio); fflush( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="573"><td class="num" id="LN573">573</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="574"><td class="num" id="LN574">574</td><td class="line">    {   U32 cursor; <span class='keyword'>for</span> (cursor=0; cursor &lt; bufferSize; ) {</td></tr>
<tr class="codeline" data-linenumber="575"><td class="num" id="LN575">575</td><td class="line">            dictItem solution;</td></tr>
<tr class="codeline" data-linenumber="576"><td class="num" id="LN576">576</td><td class="line">            <span class='keyword'>if</span> (doneMarks[cursor]) { cursor++; <span class='keyword'>continue</span>; }</td></tr>
<tr class="codeline" data-linenumber="577"><td class="num" id="LN577">577</td><td class="line">            solution = ZDICT_analyzePos(doneMarks, suffix, reverseSuffix[cursor], buffer, minRatio, notificationLevel);</td></tr>
<tr class="codeline" data-linenumber="578"><td class="num" id="LN578">578</td><td class="line">            <span class='keyword'>if</span> (solution.length==0) { cursor++; <span class='keyword'>continue</span>; }</td></tr>
<tr class="codeline" data-linenumber="579"><td class="num" id="LN579">579</td><td class="line">            ZDICT_insertDictItem(dictList, dictListSize, solution, buffer);</td></tr>
<tr class="codeline" data-linenumber="580"><td class="num" id="LN580">580</td><td class="line">            cursor += solution.length;</td></tr>
<tr class="codeline" data-linenumber="581"><td class="num" id="LN581">581</td><td class="line">            <span class='macro'>DISPLAYUPDATE(2, <span class='string_literal'>"\r%4.2f %% \r"</span>, (<span class='keyword'>double</span>)cursor / bufferSize * 100)<span class='macro_popup'>if (notificationLevel&gt;=2) { if (ZDICT_clockSpan(displayClock<br>) &gt; refreshRate) { displayClock = clock(); { fprintf(stderr<br>, "\r%4.2f %% \r", (double)cursor / bufferSize * 100); fflush<br>( stderr ); }; if (notificationLevel&gt;=4) fflush(stderr); }<br> }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="582"><td class="num" id="LN582">582</td><td class="line">    }   }</td></tr>
<tr class="codeline" data-linenumber="583"><td class="num" id="LN583">583</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="584"><td class="num" id="LN584">584</td><td class="line">_cleanup:</td></tr>
<tr class="codeline" data-linenumber="585"><td class="num" id="LN585">585</td><td class="line">    free(suffix0);</td></tr>
<tr class="codeline" data-linenumber="586"><td class="num" id="LN586">586</td><td class="line">    free(reverseSuffix);</td></tr>
<tr class="codeline" data-linenumber="587"><td class="num" id="LN587">587</td><td class="line">    free(doneMarks);</td></tr>
<tr class="codeline" data-linenumber="588"><td class="num" id="LN588">588</td><td class="line">    free(filePos);</td></tr>
<tr class="codeline" data-linenumber="589"><td class="num" id="LN589">589</td><td class="line">    <span class='keyword'>return</span> result;</td></tr>
<tr class="codeline" data-linenumber="590"><td class="num" id="LN590">590</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="591"><td class="num" id="LN591">591</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="592"><td class="num" id="LN592">592</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="593"><td class="num" id="LN593">593</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> ZDICT_fillNoise(<span class='keyword'>void</span>* buffer, size_t length)</td></tr>
<tr class="codeline" data-linenumber="594"><td class="num" id="LN594">594</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="595"><td class="num" id="LN595">595</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>const</span> prime1 = 2654435761U;</td></tr>
<tr class="codeline" data-linenumber="596"><td class="num" id="LN596">596</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>const</span> prime2 = 2246822519U;</td></tr>
<tr class="codeline" data-linenumber="597"><td class="num" id="LN597">597</td><td class="line">    <span class='keyword'>unsigned</span> acc = prime1;</td></tr>
<tr class="codeline" data-linenumber="598"><td class="num" id="LN598">598</td><td class="line">    size_t p=0;</td></tr>
<tr class="codeline" data-linenumber="599"><td class="num" id="LN599">599</td><td class="line">    <span class='keyword'>for</span> (p=0; p&lt;length; p++) {</td></tr>
<tr class="codeline" data-linenumber="600"><td class="num" id="LN600">600</td><td class="line">        acc *= prime2;</td></tr>
<tr class="codeline" data-linenumber="601"><td class="num" id="LN601">601</td><td class="line">        ((<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)buffer)[p] = (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>)(acc &gt;&gt; 21);</td></tr>
<tr class="codeline" data-linenumber="602"><td class="num" id="LN602">602</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="603"><td class="num" id="LN603">603</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="604"><td class="num" id="LN604">604</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="605"><td class="num" id="LN605">605</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="606"><td class="num" id="LN606">606</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span></td></tr>
<tr class="codeline" data-linenumber="607"><td class="num" id="LN607">607</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="608"><td class="num" id="LN608">608</td><td class="line">    ZSTD_CDict* dict;    <span class='comment'>/* dictionary */</span></td></tr>
<tr class="codeline" data-linenumber="609"><td class="num" id="LN609">609</td><td class="line">    ZSTD_CCtx* zc;     <span class='comment'>/* working context */</span></td></tr>
<tr class="codeline" data-linenumber="610"><td class="num" id="LN610">610</td><td class="line">    <span class='keyword'>void</span>* workPlace;   <span class='comment'>/* must be ZSTD_BLOCKSIZE_MAX allocated */</span></td></tr>
<tr class="codeline" data-linenumber="611"><td class="num" id="LN611">611</td><td class="line">} EStats_ress_t;</td></tr>
<tr class="codeline" data-linenumber="612"><td class="num" id="LN612">612</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="613"><td class="num" id="LN613">613</td><td class="line"><span class='directive'>#define <span class='macro'>MAXREPOFFSET<span class='macro_popup'>1024</span></span> 1024</span></td></tr>
<tr class="codeline" data-linenumber="614"><td class="num" id="LN614">614</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="615"><td class="num" id="LN615">615</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> ZDICT_countEStats(EStats_ress_t esr, <span class='keyword'>const</span> ZSTD_parameters* params,</td></tr>
<tr class="codeline" data-linenumber="616"><td class="num" id="LN616">616</td><td class="line">                              <span class='keyword'>unsigned</span>* countLit, <span class='keyword'>unsigned</span>* offsetcodeCount, <span class='keyword'>unsigned</span>* matchlengthCount, <span class='keyword'>unsigned</span>* litlengthCount, U32* repOffsets,</td></tr>
<tr class="codeline" data-linenumber="617"><td class="num" id="LN617">617</td><td class="line">                              <span class='keyword'>const</span> <span class='keyword'>void</span>* src, size_t srcSize,</td></tr>
<tr class="codeline" data-linenumber="618"><td class="num" id="LN618">618</td><td class="line">                              U32 notificationLevel)</td></tr>
<tr class="codeline" data-linenumber="619"><td class="num" id="LN619">619</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="620"><td class="num" id="LN620">620</td><td class="line">    size_t <span class='keyword'>const</span> blockSizeMax = <span class='macro'>MIN (ZSTD_BLOCKSIZE_MAX, 1 &lt;&lt; params-&gt;cParams.windowLog)<span class='macro_popup'>(((1&lt;&lt;17))&lt;(1 &lt;&lt; params-&gt;cParams.windowLog)<br> ? ((1&lt;&lt;17)) : (1 &lt;&lt; params-&gt;cParams.windowLog<br>))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="621"><td class="num" id="LN621">621</td><td class="line">    size_t cSize;</td></tr>
<tr class="codeline" data-linenumber="622"><td class="num" id="LN622">622</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="623"><td class="num" id="LN623">623</td><td class="line">    <span class='keyword'>if</span> (srcSize &gt; blockSizeMax) srcSize = blockSizeMax;   <span class='comment'>/* protection vs large samples */</span></td></tr>
<tr class="codeline" data-linenumber="624"><td class="num" id="LN624">624</td><td class="line">    {   size_t <span class='keyword'>const</span> errorCode = ZSTD_compressBegin_usingCDict(esr.zc, esr.dict);</td></tr>
<tr class="codeline" data-linenumber="625"><td class="num" id="LN625">625</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>ZSTD_isError<span class='macro_popup'>ERR_isError</span></span>(errorCode)) { <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"warning : ZSTD_compressBegin_usingCDict failed \n"</span>)<span class='macro_popup'>if (notificationLevel&gt;=1) { { fprintf(stderr, "warning : ZSTD_compressBegin_usingCDict failed \n"<br>); fflush( stderr ); }; }</span></span>; <span class='keyword'>return</span>; }</td></tr>
<tr class="codeline" data-linenumber="626"><td class="num" id="LN626">626</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="627"><td class="num" id="LN627">627</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="628"><td class="num" id="LN628">628</td><td class="line">    cSize = ZSTD_compressBlock(esr.zc, esr.workPlace, <span class='macro'>ZSTD_BLOCKSIZE_MAX<span class='macro_popup'>(1&lt;&lt;17)</span></span>, src, srcSize);</td></tr>
<tr class="codeline" data-linenumber="629"><td class="num" id="LN629">629</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>ZSTD_isError<span class='macro_popup'>ERR_isError</span></span>(cSize)) { <span class='macro'>DISPLAYLEVEL(3, <span class='string_literal'>"warning : could not compress sample size %u \n"</span>, (<span class='keyword'>unsigned</span>)srcSize)<span class='macro_popup'>if (notificationLevel&gt;=3) { { fprintf(stderr, "warning : could not compress sample size %u \n"<br>, (unsigned)srcSize); fflush( stderr ); }; }</span></span>; <span class='keyword'>return</span>; }</td></tr>
<tr class="codeline" data-linenumber="630"><td class="num" id="LN630">630</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="631"><td class="num" id="LN631">631</td><td class="line">    <span class='keyword'>if</span> (cSize) {  <span class='comment'>/* if == 0; block is not compressible */</span></td></tr>
<tr class="codeline" data-linenumber="632"><td class="num" id="LN632">632</td><td class="line">        <span class='keyword'>const</span> seqStore_t* <span class='keyword'>const</span> seqStorePtr = ZSTD_getSeqStore(esr.zc);</td></tr>
<tr class="codeline" data-linenumber="633"><td class="num" id="LN633">633</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="634"><td class="num" id="LN634">634</td><td class="line">        <span class='comment'>/* literals stats */</span></td></tr>
<tr class="codeline" data-linenumber="635"><td class="num" id="LN635">635</td><td class="line">        {   <span class='keyword'>const</span> BYTE* bytePtr;</td></tr>
<tr class="codeline" data-linenumber="636"><td class="num" id="LN636">636</td><td class="line">            <span class='keyword'>for</span>(bytePtr = seqStorePtr-&gt;litStart; bytePtr &lt; seqStorePtr-&gt;lit; bytePtr++)</td></tr>
<tr class="codeline" data-linenumber="637"><td class="num" id="LN637">637</td><td class="line">                countLit[*bytePtr]++;</td></tr>
<tr class="codeline" data-linenumber="638"><td class="num" id="LN638">638</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="639"><td class="num" id="LN639">639</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="640"><td class="num" id="LN640">640</td><td class="line">        <span class='comment'>/* seqStats */</span></td></tr>
<tr class="codeline" data-linenumber="641"><td class="num" id="LN641">641</td><td class="line">        {   U32 <span class='keyword'>const</span> nbSeq = (U32)(seqStorePtr-&gt;sequences - seqStorePtr-&gt;sequencesStart);</td></tr>
<tr class="codeline" data-linenumber="642"><td class="num" id="LN642">642</td><td class="line">            ZSTD_seqToCodes(seqStorePtr);</td></tr>
<tr class="codeline" data-linenumber="643"><td class="num" id="LN643">643</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="644"><td class="num" id="LN644">644</td><td class="line">            {   <span class='keyword'>const</span> BYTE* codePtr = seqStorePtr-&gt;ofCode;</td></tr>
<tr class="codeline" data-linenumber="645"><td class="num" id="LN645">645</td><td class="line">                U32 u;</td></tr>
<tr class="codeline" data-linenumber="646"><td class="num" id="LN646">646</td><td class="line">                <span class='keyword'>for</span> (u=0; u&lt;nbSeq; u++) offsetcodeCount[codePtr[u]]++;</td></tr>
<tr class="codeline" data-linenumber="647"><td class="num" id="LN647">647</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="648"><td class="num" id="LN648">648</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="649"><td class="num" id="LN649">649</td><td class="line">            {   <span class='keyword'>const</span> BYTE* codePtr = seqStorePtr-&gt;mlCode;</td></tr>
<tr class="codeline" data-linenumber="650"><td class="num" id="LN650">650</td><td class="line">                U32 u;</td></tr>
<tr class="codeline" data-linenumber="651"><td class="num" id="LN651">651</td><td class="line">                <span class='keyword'>for</span> (u=0; u&lt;nbSeq; u++) matchlengthCount[codePtr[u]]++;</td></tr>
<tr class="codeline" data-linenumber="652"><td class="num" id="LN652">652</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="653"><td class="num" id="LN653">653</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="654"><td class="num" id="LN654">654</td><td class="line">            {   <span class='keyword'>const</span> BYTE* codePtr = seqStorePtr-&gt;llCode;</td></tr>
<tr class="codeline" data-linenumber="655"><td class="num" id="LN655">655</td><td class="line">                U32 u;</td></tr>
<tr class="codeline" data-linenumber="656"><td class="num" id="LN656">656</td><td class="line">                <span class='keyword'>for</span> (u=0; u&lt;nbSeq; u++) litlengthCount[codePtr[u]]++;</td></tr>
<tr class="codeline" data-linenumber="657"><td class="num" id="LN657">657</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="658"><td class="num" id="LN658">658</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="659"><td class="num" id="LN659">659</td><td class="line">            <span class='keyword'>if</span> (nbSeq &gt;= 2) { <span class='comment'>/* rep offsets */</span></td></tr>
<tr class="codeline" data-linenumber="660"><td class="num" id="LN660">660</td><td class="line">                <span class='keyword'>const</span> seqDef* <span class='keyword'>const</span> seq = seqStorePtr-&gt;sequencesStart;</td></tr>
<tr class="codeline" data-linenumber="661"><td class="num" id="LN661">661</td><td class="line">                U32 offset1 = seq[0].offset - 3;</td></tr>
<tr class="codeline" data-linenumber="662"><td class="num" id="LN662">662</td><td class="line">                U32 offset2 = seq[1].offset - 3;</td></tr>
<tr class="codeline" data-linenumber="663"><td class="num" id="LN663">663</td><td class="line">                <span class='keyword'>if</span> (offset1 &gt;= <span class='macro'>MAXREPOFFSET<span class='macro_popup'>1024</span></span>) offset1 = 0;</td></tr>
<tr class="codeline" data-linenumber="664"><td class="num" id="LN664">664</td><td class="line">                <span class='keyword'>if</span> (offset2 &gt;= <span class='macro'>MAXREPOFFSET<span class='macro_popup'>1024</span></span>) offset2 = 0;</td></tr>
<tr class="codeline" data-linenumber="665"><td class="num" id="LN665">665</td><td class="line">                repOffsets[offset1] += 3;</td></tr>
<tr class="codeline" data-linenumber="666"><td class="num" id="LN666">666</td><td class="line">                repOffsets[offset2] += 1;</td></tr>
<tr class="codeline" data-linenumber="667"><td class="num" id="LN667">667</td><td class="line">    }   }   }</td></tr>
<tr class="codeline" data-linenumber="668"><td class="num" id="LN668">668</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="669"><td class="num" id="LN669">669</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="670"><td class="num" id="LN670">670</td><td class="line"><span class='keyword'>static</span> size_t ZDICT_totalSampleSize(<span class='keyword'>const</span> size_t* fileSizes, <span class='keyword'>unsigned</span> nbFiles)</td></tr>
<tr class="codeline" data-linenumber="671"><td class="num" id="LN671">671</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="672"><td class="num" id="LN672">672</td><td class="line">    size_t total=0;</td></tr>
<tr class="codeline" data-linenumber="673"><td class="num" id="LN673">673</td><td class="line">    <span class='keyword'>unsigned</span> u;</td></tr>
<tr class="codeline" data-linenumber="674"><td class="num" id="LN674">674</td><td class="line">    <span class='keyword'>for</span> (u=0; u&lt;nbFiles; u++) total += fileSizes[u];</td></tr>
<tr class="codeline" data-linenumber="675"><td class="num" id="LN675">675</td><td class="line">    <span class='keyword'>return</span> total;</td></tr>
<tr class="codeline" data-linenumber="676"><td class="num" id="LN676">676</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="677"><td class="num" id="LN677">677</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="678"><td class="num" id="LN678">678</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> { U32 offset; U32 count; } offsetCount_t;</td></tr>
<tr class="codeline" data-linenumber="679"><td class="num" id="LN679">679</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="680"><td class="num" id="LN680">680</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> ZDICT_insertSortCount(offsetCount_t table[<span class='macro'>ZSTD_REP_NUM<span class='macro_popup'>3</span></span>+1], U32 val, U32 count)</td></tr>
<tr class="codeline" data-linenumber="681"><td class="num" id="LN681">681</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="682"><td class="num" id="LN682">682</td><td class="line">    U32 u;</td></tr>
<tr class="codeline" data-linenumber="683"><td class="num" id="LN683">683</td><td class="line">    table[<span class='macro'>ZSTD_REP_NUM<span class='macro_popup'>3</span></span>].offset = val;</td></tr>
<tr class="codeline" data-linenumber="684"><td class="num" id="LN684">684</td><td class="line">    table[<span class='macro'>ZSTD_REP_NUM<span class='macro_popup'>3</span></span>].count = count;</td></tr>
<tr class="codeline" data-linenumber="685"><td class="num" id="LN685">685</td><td class="line">    <span class='keyword'>for</span> (u=<span class='macro'>ZSTD_REP_NUM<span class='macro_popup'>3</span></span>; u&gt;0; u--) {</td></tr>
<tr class="codeline" data-linenumber="686"><td class="num" id="LN686">686</td><td class="line">        offsetCount_t tmp;</td></tr>
<tr class="codeline" data-linenumber="687"><td class="num" id="LN687">687</td><td class="line">        <span class='keyword'>if</span> (table[u-1].count &gt;= table[u].count) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="688"><td class="num" id="LN688">688</td><td class="line">        tmp = table[u-1];</td></tr>
<tr class="codeline" data-linenumber="689"><td class="num" id="LN689">689</td><td class="line">        table[u-1] = table[u];</td></tr>
<tr class="codeline" data-linenumber="690"><td class="num" id="LN690">690</td><td class="line">        table[u] = tmp;</td></tr>
<tr class="codeline" data-linenumber="691"><td class="num" id="LN691">691</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="692"><td class="num" id="LN692">692</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="693"><td class="num" id="LN693">693</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="694"><td class="num" id="LN694">694</td><td class="line"><span class='comment'>/* ZDICT_flatLit() :</span></td></tr>
<tr class="codeline" data-linenumber="695"><td class="num" id="LN695">695</td><td class="line"> <span class='comment'>* rewrite `countLit` to contain a mostly flat but still compressible distribution of literals.</span></td></tr>
<tr class="codeline" data-linenumber="696"><td class="num" id="LN696">696</td><td class="line"> <span class='comment'>* necessary to avoid generating a non-compressible distribution that HUF_writeCTable() cannot encode.</span></td></tr>
<tr class="codeline" data-linenumber="697"><td class="num" id="LN697">697</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="698"><td class="num" id="LN698">698</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> ZDICT_flatLit(<span class='keyword'>unsigned</span>* countLit)</td></tr>
<tr class="codeline" data-linenumber="699"><td class="num" id="LN699">699</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="700"><td class="num" id="LN700">700</td><td class="line">    <span class='keyword'>int</span> u;</td></tr>
<tr class="codeline" data-linenumber="701"><td class="num" id="LN701">701</td><td class="line">    <span class='keyword'>for</span> (u=1; u&lt;256; u++) countLit[u] = 2;</td></tr>
<tr class="codeline" data-linenumber="702"><td class="num" id="LN702">702</td><td class="line">    countLit[0]   = 4;</td></tr>
<tr class="codeline" data-linenumber="703"><td class="num" id="LN703">703</td><td class="line">    countLit[253] = 1;</td></tr>
<tr class="codeline" data-linenumber="704"><td class="num" id="LN704">704</td><td class="line">    countLit[254] = 1;</td></tr>
<tr class="codeline" data-linenumber="705"><td class="num" id="LN705">705</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="706"><td class="num" id="LN706">706</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="707"><td class="num" id="LN707">707</td><td class="line"><span class='directive'>#define <span class='macro'>OFFCODE_MAX<span class='macro_popup'>30</span></span> 30  /* only applicable to first block */</span></td></tr>
<tr class="codeline" data-linenumber="708"><td class="num" id="LN708">708</td><td class="line"><span class='keyword'>static</span> size_t ZDICT_analyzeEntropy(<span class='keyword'>void</span>*  dstBuffer, size_t maxDstSize,</td></tr>
<tr class="codeline" data-linenumber="709"><td class="num" id="LN709">709</td><td class="line">                                   <span class='keyword'>unsigned</span> compressionLevel,</td></tr>
<tr class="codeline" data-linenumber="710"><td class="num" id="LN710">710</td><td class="line">                             <span class='keyword'>const</span> <span class='keyword'>void</span>*  srcBuffer, <span class='keyword'>const</span> size_t* fileSizes, <span class='keyword'>unsigned</span> nbFiles,</td></tr>
<tr class="codeline" data-linenumber="711"><td class="num" id="LN711">711</td><td class="line">                             <span class='keyword'>const</span> <span class='keyword'>void</span>* dictBuffer, size_t  dictBufferSize,</td></tr>
<tr class="codeline" data-linenumber="712"><td class="num" id="LN712">712</td><td class="line">                                   <span class='keyword'>unsigned</span> notificationLevel)</td></tr>
<tr class="codeline" data-linenumber="713"><td class="num" id="LN713">713</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="714"><td class="num" id="LN714">714</td><td class="line">    <span class='keyword'>unsigned</span> countLit[256];</td></tr>
<tr class="codeline" data-linenumber="715"><td class="num" id="LN715">715</td><td class="line">    <span class='macro'>HUF_CREATE_STATIC_CTABLE(hufTable, 255)<span class='macro_popup'>U32 hufTablehb[((255)+1)]; void* hufTablehv = &amp;(hufTablehb<br>); HUF_CElt* hufTable = (HUF_CElt*)(hufTablehv)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="716"><td class="num" id="LN716">716</td><td class="line">    <span class='keyword'>unsigned</span> offcodeCount[<span class='macro'>OFFCODE_MAX<span class='macro_popup'>30</span></span>+1];</td></tr>
<tr class="codeline" data-linenumber="717"><td class="num" id="LN717">717</td><td class="line">    <span class='keyword'>short</span> offcodeNCount[<span class='macro'>OFFCODE_MAX<span class='macro_popup'>30</span></span>+1];</td></tr>
<tr class="codeline" data-linenumber="718"><td class="num" id="LN718">718</td><td class="line">    U32 offcodeMax = ZSTD_highbit32((U32)(dictBufferSize + 128 <span class='macro'>KB<span class='macro_popup'>*(1 &lt;&lt;10)</span></span>));</td></tr>
<tr class="codeline" data-linenumber="719"><td class="num" id="LN719">719</td><td class="line">    <span class='keyword'>unsigned</span> matchLengthCount[<span class='macro'>MaxML<span class='macro_popup'>52</span></span>+1];</td></tr>
<tr class="codeline" data-linenumber="720"><td class="num" id="LN720">720</td><td class="line">    <span class='keyword'>short</span> matchLengthNCount[<span class='macro'>MaxML<span class='macro_popup'>52</span></span>+1];</td></tr>
<tr class="codeline" data-linenumber="721"><td class="num" id="LN721">721</td><td class="line">    <span class='keyword'>unsigned</span> litLengthCount[<span class='macro'>MaxLL<span class='macro_popup'>35</span></span>+1];</td></tr>
<tr class="codeline" data-linenumber="722"><td class="num" id="LN722">722</td><td class="line">    <span class='keyword'>short</span> litLengthNCount[<span class='macro'>MaxLL<span class='macro_popup'>35</span></span>+1];</td></tr>
<tr class="codeline" data-linenumber="723"><td class="num" id="LN723">723</td><td class="line">    U32 repOffset[<span class='macro'>MAXREPOFFSET<span class='macro_popup'>1024</span></span>];</td></tr>
<tr class="codeline" data-linenumber="724"><td class="num" id="LN724">724</td><td class="line">    offsetCount_t bestRepOffset[<span class='macro'>ZSTD_REP_NUM<span class='macro_popup'>3</span></span>+1];</td></tr>
<tr class="codeline" data-linenumber="725"><td class="num" id="LN725">725</td><td class="line">    EStats_ress_t esr = { <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> };</td></tr>
<tr class="codeline" data-linenumber="726"><td class="num" id="LN726">726</td><td class="line">    ZSTD_parameters params;</td></tr>
<tr class="codeline" data-linenumber="727"><td class="num" id="LN727">727</td><td class="line">    U32 u, huffLog = 11, Offlog = <span class='macro'>OffFSELog<span class='macro_popup'>8</span></span>, mlLog = <span class='macro'>MLFSELog<span class='macro_popup'>9</span></span>, llLog = <span class='macro'>LLFSELog<span class='macro_popup'>9</span></span>, total;</td></tr>
<tr class="codeline" data-linenumber="728"><td class="num" id="LN728">728</td><td class="line">    size_t pos = 0, errorCode;</td></tr>
<tr class="codeline" data-linenumber="729"><td class="num" id="LN729">729</td><td class="line">    size_t eSize = 0;</td></tr>
<tr class="codeline" data-linenumber="730"><td class="num" id="LN730">730</td><td class="line">    size_t <span class='keyword'>const</span> totalSrcSize = ZDICT_totalSampleSize(fileSizes, nbFiles);</td></tr>
<tr class="codeline" data-linenumber="731"><td class="num" id="LN731">731</td><td class="line">    size_t <span class='keyword'>const</span> averageSampleSize = totalSrcSize / (nbFiles + !nbFiles);</td></tr>
<tr class="codeline" data-linenumber="732"><td class="num" id="LN732">732</td><td class="line">    BYTE* dstPtr = (BYTE*)dstBuffer;</td></tr>
<tr class="codeline" data-linenumber="733"><td class="num" id="LN733">733</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="734"><td class="num" id="LN734">734</td><td class="line">    <span class='comment'>/* init */</span></td></tr>
<tr class="codeline" data-linenumber="735"><td class="num" id="LN735">735</td><td class="line">    <span class='macro'>DEBUGLOG(4, <span class='string_literal'>"ZDICT_analyzeEntropy"</span>)<span class='macro_popup'>{}</span></span>;</td></tr>
<tr class="codeline" data-linenumber="736"><td class="num" id="LN736">736</td><td class="line">    <span class='keyword'>if</span> (offcodeMax&gt;<span class='macro'>OFFCODE_MAX<span class='macro_popup'>30</span></span>) { eSize = <span class='macro'>ERROR(dictionaryCreation_failed)<span class='macro_popup'>((size_t)-ZSTD_error_dictionaryCreation_failed)</span></span>; <span class='keyword'>goto</span> _cleanup; }   <span class='comment'>/* too large dictionary */</span></td></tr>
<tr class="codeline" data-linenumber="737"><td class="num" id="LN737">737</td><td class="line">    <span class='keyword'>for</span> (u=0; u&lt;256; u++) countLit[u] = 1;   <span class='comment'>/* any character must be described */</span></td></tr>
<tr class="codeline" data-linenumber="738"><td class="num" id="LN738">738</td><td class="line">    <span class='keyword'>for</span> (u=0; u&lt;=offcodeMax; u++) offcodeCount[u] = 1;</td></tr>
<tr class="codeline" data-linenumber="739"><td class="num" id="LN739">739</td><td class="line">    <span class='keyword'>for</span> (u=0; u&lt;=<span class='macro'>MaxML<span class='macro_popup'>52</span></span>; u++) matchLengthCount[u] = 1;</td></tr>
<tr class="codeline" data-linenumber="740"><td class="num" id="LN740">740</td><td class="line">    <span class='keyword'>for</span> (u=0; u&lt;=<span class='macro'>MaxLL<span class='macro_popup'>35</span></span>; u++) litLengthCount[u] = 1;</td></tr>
<tr class="codeline" data-linenumber="741"><td class="num" id="LN741">741</td><td class="line">    memset(repOffset, 0, <span class='keyword'>sizeof</span>(repOffset));</td></tr>
<tr class="codeline" data-linenumber="742"><td class="num" id="LN742">742</td><td class="line">    repOffset[1] = repOffset[4] = repOffset[8] = 1;</td></tr>
<tr class="codeline" data-linenumber="743"><td class="num" id="LN743">743</td><td class="line">    memset(bestRepOffset, 0, <span class='keyword'>sizeof</span>(bestRepOffset));</td></tr>
<tr class="codeline" data-linenumber="744"><td class="num" id="LN744">744</td><td class="line">    <span class='keyword'>if</span> (compressionLevel==0) compressionLevel = g_compressionLevel_default;</td></tr>
<tr class="codeline" data-linenumber="745"><td class="num" id="LN745">745</td><td class="line">    params = ZSTD_getParams(compressionLevel, averageSampleSize, dictBufferSize);</td></tr>
<tr class="codeline" data-linenumber="746"><td class="num" id="LN746">746</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="747"><td class="num" id="LN747">747</td><td class="line">    esr.dict = ZSTD_createCDict_advanced(dictBuffer, dictBufferSize, ZSTD_dlm_byRef, ZSTD_dct_rawContent, params.cParams, ZSTD_defaultCMem);</td></tr>
<tr class="codeline" data-linenumber="748"><td class="num" id="LN748">748</td><td class="line">    esr.zc = ZSTD_createCCtx();</td></tr>
<tr class="codeline" data-linenumber="749"><td class="num" id="LN749">749</td><td class="line">    esr.workPlace = malloc(<span class='macro'>ZSTD_BLOCKSIZE_MAX<span class='macro_popup'>(1&lt;&lt;17)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="750"><td class="num" id="LN750">750</td><td class="line">    <span class='keyword'>if</span> (!esr.dict || !esr.zc || !esr.workPlace) {</td></tr>
<tr class="codeline" data-linenumber="751"><td class="num" id="LN751">751</td><td class="line">        eSize = <span class='macro'>ERROR(memory_allocation)<span class='macro_popup'>((size_t)-ZSTD_error_memory_allocation)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="752"><td class="num" id="LN752">752</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"Not enough memory \n"</span>)<span class='macro_popup'>if (notificationLevel&gt;=1) { { fprintf(stderr, "Not enough memory \n"<br>); fflush( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="753"><td class="num" id="LN753">753</td><td class="line">        <span class='keyword'>goto</span> _cleanup;</td></tr>
<tr class="codeline" data-linenumber="754"><td class="num" id="LN754">754</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="755"><td class="num" id="LN755">755</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="756"><td class="num" id="LN756">756</td><td class="line">    <span class='comment'>/* collect stats on all samples */</span></td></tr>
<tr class="codeline" data-linenumber="757"><td class="num" id="LN757">757</td><td class="line">    <span class='keyword'>for</span> (u=0; u&lt;nbFiles; u++) {</td></tr>
<tr class="codeline" data-linenumber="758"><td class="num" id="LN758">758</td><td class="line">        ZDICT_countEStats(esr, &amp;params,</td></tr>
<tr class="codeline" data-linenumber="759"><td class="num" id="LN759">759</td><td class="line">                          countLit, offcodeCount, matchLengthCount, litLengthCount, repOffset,</td></tr>
<tr class="codeline" data-linenumber="760"><td class="num" id="LN760">760</td><td class="line">                         (<span class='keyword'>const</span> <span class='keyword'>char</span>*)srcBuffer + pos, fileSizes[u],</td></tr>
<tr class="codeline" data-linenumber="761"><td class="num" id="LN761">761</td><td class="line">                          notificationLevel);</td></tr>
<tr class="codeline" data-linenumber="762"><td class="num" id="LN762">762</td><td class="line">        pos += fileSizes[u];</td></tr>
<tr class="codeline" data-linenumber="763"><td class="num" id="LN763">763</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="764"><td class="num" id="LN764">764</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="765"><td class="num" id="LN765">765</td><td class="line">    <span class='comment'>/* analyze, build stats, starting with literals */</span></td></tr>
<tr class="codeline" data-linenumber="766"><td class="num" id="LN766">766</td><td class="line">    {   size_t maxNbBits = HUF_buildCTable (hufTable, countLit, 255, huffLog);</td></tr>
<tr class="codeline" data-linenumber="767"><td class="num" id="LN767">767</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>HUF_isError<span class='macro_popup'>ERR_isError</span></span>(maxNbBits)) {</td></tr>
<tr class="codeline" data-linenumber="768"><td class="num" id="LN768">768</td><td class="line">            eSize = maxNbBits;</td></tr>
<tr class="codeline" data-linenumber="769"><td class="num" id="LN769">769</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>" HUF_buildCTable error \n"</span>)<span class='macro_popup'>if (notificationLevel&gt;=1) { { fprintf(stderr, " HUF_buildCTable error \n"<br>); fflush( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="770"><td class="num" id="LN770">770</td><td class="line">            <span class='keyword'>goto</span> _cleanup;</td></tr>
<tr class="codeline" data-linenumber="771"><td class="num" id="LN771">771</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="772"><td class="num" id="LN772">772</td><td class="line">        <span class='keyword'>if</span> (maxNbBits==8) {  <span class='comment'>/* not compressible : will fail on HUF_writeCTable() */</span></td></tr>
<tr class="codeline" data-linenumber="773"><td class="num" id="LN773">773</td><td class="line">            <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"warning : pathological dataset : literals are not compressible : samples are noisy or too regular \n"</span>)<span class='macro_popup'>if (notificationLevel&gt;=2) { { fprintf(stderr, "warning : pathological dataset : literals are not compressible : samples are noisy or too regular \n"<br>); fflush( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="774"><td class="num" id="LN774">774</td><td class="line">            ZDICT_flatLit(countLit);  <span class='comment'>/* replace distribution by a fake "mostly flat but still compressible" distribution, that HUF_writeCTable() can encode */</span></td></tr>
<tr class="codeline" data-linenumber="775"><td class="num" id="LN775">775</td><td class="line">            maxNbBits = HUF_buildCTable (hufTable, countLit, 255, huffLog);</td></tr>
<tr class="codeline" data-linenumber="776"><td class="num" id="LN776">776</td><td class="line">            <span class='macro'>assert(maxNbBits==9)<span class='macro_popup'>((void)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="777"><td class="num" id="LN777">777</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="778"><td class="num" id="LN778">778</td><td class="line">        huffLog = (U32)maxNbBits;</td></tr>
<tr class="codeline" data-linenumber="779"><td class="num" id="LN779">779</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="780"><td class="num" id="LN780">780</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="781"><td class="num" id="LN781">781</td><td class="line">    <span class='comment'>/* looking for most common first offsets */</span></td></tr>
<tr class="codeline" data-linenumber="782"><td class="num" id="LN782">782</td><td class="line">    {   U32 offset;</td></tr>
<tr class="codeline" data-linenumber="783"><td class="num" id="LN783">783</td><td class="line">        <span class='keyword'>for</span> (offset=1; offset&lt;<span class='macro'>MAXREPOFFSET<span class='macro_popup'>1024</span></span>; offset++)</td></tr>
<tr class="codeline" data-linenumber="784"><td class="num" id="LN784">784</td><td class="line">            ZDICT_insertSortCount(bestRepOffset, offset, repOffset[offset]);</td></tr>
<tr class="codeline" data-linenumber="785"><td class="num" id="LN785">785</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="786"><td class="num" id="LN786">786</td><td class="line">    <span class='comment'>/* note : the result of this phase should be used to better appreciate the impact on statistics */</span></td></tr>
<tr class="codeline" data-linenumber="787"><td class="num" id="LN787">787</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="788"><td class="num" id="LN788">788</td><td class="line">    total=0; <span class='keyword'>for</span> (u=0; u&lt;=offcodeMax; u++) total+=offcodeCount[u];</td></tr>
<tr class="codeline" data-linenumber="789"><td class="num" id="LN789">789</td><td class="line">    errorCode = FSE_normalizeCount(offcodeNCount, Offlog, offcodeCount, total, offcodeMax);</td></tr>
<tr class="codeline" data-linenumber="790"><td class="num" id="LN790">790</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>FSE_isError<span class='macro_popup'>ERR_isError</span></span>(errorCode)) {</td></tr>
<tr class="codeline" data-linenumber="791"><td class="num" id="LN791">791</td><td class="line">        eSize = errorCode;</td></tr>
<tr class="codeline" data-linenumber="792"><td class="num" id="LN792">792</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"FSE_normalizeCount error with offcodeCount \n"</span>)<span class='macro_popup'>if (notificationLevel&gt;=1) { { fprintf(stderr, "FSE_normalizeCount error with offcodeCount \n"<br>); fflush( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="793"><td class="num" id="LN793">793</td><td class="line">        <span class='keyword'>goto</span> _cleanup;</td></tr>
<tr class="codeline" data-linenumber="794"><td class="num" id="LN794">794</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="795"><td class="num" id="LN795">795</td><td class="line">    Offlog = (U32)errorCode;</td></tr>
<tr class="codeline" data-linenumber="796"><td class="num" id="LN796">796</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="797"><td class="num" id="LN797">797</td><td class="line">    total=0; <span class='keyword'>for</span> (u=0; u&lt;=<span class='macro'>MaxML<span class='macro_popup'>52</span></span>; u++) total+=matchLengthCount[u];</td></tr>
<tr class="codeline" data-linenumber="798"><td class="num" id="LN798">798</td><td class="line">    errorCode = FSE_normalizeCount(matchLengthNCount, mlLog, matchLengthCount, total, <span class='macro'>MaxML<span class='macro_popup'>52</span></span>);</td></tr>
<tr class="codeline" data-linenumber="799"><td class="num" id="LN799">799</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>FSE_isError<span class='macro_popup'>ERR_isError</span></span>(errorCode)) {</td></tr>
<tr class="codeline" data-linenumber="800"><td class="num" id="LN800">800</td><td class="line">        eSize = errorCode;</td></tr>
<tr class="codeline" data-linenumber="801"><td class="num" id="LN801">801</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"FSE_normalizeCount error with matchLengthCount \n"</span>)<span class='macro_popup'>if (notificationLevel&gt;=1) { { fprintf(stderr, "FSE_normalizeCount error with matchLengthCount \n"<br>); fflush( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="802"><td class="num" id="LN802">802</td><td class="line">        <span class='keyword'>goto</span> _cleanup;</td></tr>
<tr class="codeline" data-linenumber="803"><td class="num" id="LN803">803</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="804"><td class="num" id="LN804">804</td><td class="line">    mlLog = (U32)errorCode;</td></tr>
<tr class="codeline" data-linenumber="805"><td class="num" id="LN805">805</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="806"><td class="num" id="LN806">806</td><td class="line">    total=0; <span class='keyword'>for</span> (u=0; u&lt;=<span class='macro'>MaxLL<span class='macro_popup'>35</span></span>; u++) total+=litLengthCount[u];</td></tr>
<tr class="codeline" data-linenumber="807"><td class="num" id="LN807">807</td><td class="line">    errorCode = FSE_normalizeCount(litLengthNCount, llLog, litLengthCount, total, <span class='macro'>MaxLL<span class='macro_popup'>35</span></span>);</td></tr>
<tr class="codeline" data-linenumber="808"><td class="num" id="LN808">808</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>FSE_isError<span class='macro_popup'>ERR_isError</span></span>(errorCode)) {</td></tr>
<tr class="codeline" data-linenumber="809"><td class="num" id="LN809">809</td><td class="line">        eSize = errorCode;</td></tr>
<tr class="codeline" data-linenumber="810"><td class="num" id="LN810">810</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"FSE_normalizeCount error with litLengthCount \n"</span>)<span class='macro_popup'>if (notificationLevel&gt;=1) { { fprintf(stderr, "FSE_normalizeCount error with litLengthCount \n"<br>); fflush( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="811"><td class="num" id="LN811">811</td><td class="line">        <span class='keyword'>goto</span> _cleanup;</td></tr>
<tr class="codeline" data-linenumber="812"><td class="num" id="LN812">812</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="813"><td class="num" id="LN813">813</td><td class="line">    llLog = (U32)errorCode;</td></tr>
<tr class="codeline" data-linenumber="814"><td class="num" id="LN814">814</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="815"><td class="num" id="LN815">815</td><td class="line">    <span class='comment'>/* write result to buffer */</span></td></tr>
<tr class="codeline" data-linenumber="816"><td class="num" id="LN816">816</td><td class="line">    {   size_t <span class='keyword'>const</span> hhSize = HUF_writeCTable(dstPtr, maxDstSize, hufTable, 255, huffLog);</td></tr>
<tr class="codeline" data-linenumber="817"><td class="num" id="LN817">817</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>HUF_isError<span class='macro_popup'>ERR_isError</span></span>(hhSize)) {</td></tr>
<tr class="codeline" data-linenumber="818"><td class="num" id="LN818">818</td><td class="line">            eSize = hhSize;</td></tr>
<tr class="codeline" data-linenumber="819"><td class="num" id="LN819">819</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"HUF_writeCTable error \n"</span>)<span class='macro_popup'>if (notificationLevel&gt;=1) { { fprintf(stderr, "HUF_writeCTable error \n"<br>); fflush( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="820"><td class="num" id="LN820">820</td><td class="line">            <span class='keyword'>goto</span> _cleanup;</td></tr>
<tr class="codeline" data-linenumber="821"><td class="num" id="LN821">821</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="822"><td class="num" id="LN822">822</td><td class="line">        dstPtr += hhSize;</td></tr>
<tr class="codeline" data-linenumber="823"><td class="num" id="LN823">823</td><td class="line">        maxDstSize -= hhSize;</td></tr>
<tr class="codeline" data-linenumber="824"><td class="num" id="LN824">824</td><td class="line">        eSize += hhSize;</td></tr>
<tr class="codeline" data-linenumber="825"><td class="num" id="LN825">825</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="826"><td class="num" id="LN826">826</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="827"><td class="num" id="LN827">827</td><td class="line">    {   size_t <span class='keyword'>const</span> ohSize = FSE_writeNCount(dstPtr, maxDstSize, offcodeNCount, <span class='macro'>OFFCODE_MAX<span class='macro_popup'>30</span></span>, Offlog);</td></tr>
<tr class="codeline" data-linenumber="828"><td class="num" id="LN828">828</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>FSE_isError<span class='macro_popup'>ERR_isError</span></span>(ohSize)) {</td></tr>
<tr class="codeline" data-linenumber="829"><td class="num" id="LN829">829</td><td class="line">            eSize = ohSize;</td></tr>
<tr class="codeline" data-linenumber="830"><td class="num" id="LN830">830</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"FSE_writeNCount error with offcodeNCount \n"</span>)<span class='macro_popup'>if (notificationLevel&gt;=1) { { fprintf(stderr, "FSE_writeNCount error with offcodeNCount \n"<br>); fflush( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="831"><td class="num" id="LN831">831</td><td class="line">            <span class='keyword'>goto</span> _cleanup;</td></tr>
<tr class="codeline" data-linenumber="832"><td class="num" id="LN832">832</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="833"><td class="num" id="LN833">833</td><td class="line">        dstPtr += ohSize;</td></tr>
<tr class="codeline" data-linenumber="834"><td class="num" id="LN834">834</td><td class="line">        maxDstSize -= ohSize;</td></tr>
<tr class="codeline" data-linenumber="835"><td class="num" id="LN835">835</td><td class="line">        eSize += ohSize;</td></tr>
<tr class="codeline" data-linenumber="836"><td class="num" id="LN836">836</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="837"><td class="num" id="LN837">837</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="838"><td class="num" id="LN838">838</td><td class="line">    {   size_t <span class='keyword'>const</span> mhSize = FSE_writeNCount(dstPtr, maxDstSize, matchLengthNCount, <span class='macro'>MaxML<span class='macro_popup'>52</span></span>, mlLog);</td></tr>
<tr class="codeline" data-linenumber="839"><td class="num" id="LN839">839</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>FSE_isError<span class='macro_popup'>ERR_isError</span></span>(mhSize)) {</td></tr>
<tr class="codeline" data-linenumber="840"><td class="num" id="LN840">840</td><td class="line">            eSize = mhSize;</td></tr>
<tr class="codeline" data-linenumber="841"><td class="num" id="LN841">841</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"FSE_writeNCount error with matchLengthNCount \n"</span>)<span class='macro_popup'>if (notificationLevel&gt;=1) { { fprintf(stderr, "FSE_writeNCount error with matchLengthNCount \n"<br>); fflush( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="842"><td class="num" id="LN842">842</td><td class="line">            <span class='keyword'>goto</span> _cleanup;</td></tr>
<tr class="codeline" data-linenumber="843"><td class="num" id="LN843">843</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="844"><td class="num" id="LN844">844</td><td class="line">        dstPtr += mhSize;</td></tr>
<tr class="codeline" data-linenumber="845"><td class="num" id="LN845">845</td><td class="line">        maxDstSize -= mhSize;</td></tr>
<tr class="codeline" data-linenumber="846"><td class="num" id="LN846">846</td><td class="line">        eSize += mhSize;</td></tr>
<tr class="codeline" data-linenumber="847"><td class="num" id="LN847">847</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="848"><td class="num" id="LN848">848</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="849"><td class="num" id="LN849">849</td><td class="line">    {   size_t <span class='keyword'>const</span> lhSize = FSE_writeNCount(dstPtr, maxDstSize, litLengthNCount, <span class='macro'>MaxLL<span class='macro_popup'>35</span></span>, llLog);</td></tr>
<tr class="codeline" data-linenumber="850"><td class="num" id="LN850">850</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>FSE_isError<span class='macro_popup'>ERR_isError</span></span>(lhSize)) {</td></tr>
<tr class="codeline" data-linenumber="851"><td class="num" id="LN851">851</td><td class="line">            eSize = lhSize;</td></tr>
<tr class="codeline" data-linenumber="852"><td class="num" id="LN852">852</td><td class="line">            <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"FSE_writeNCount error with litlengthNCount \n"</span>)<span class='macro_popup'>if (notificationLevel&gt;=1) { { fprintf(stderr, "FSE_writeNCount error with litlengthNCount \n"<br>); fflush( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="853"><td class="num" id="LN853">853</td><td class="line">            <span class='keyword'>goto</span> _cleanup;</td></tr>
<tr class="codeline" data-linenumber="854"><td class="num" id="LN854">854</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="855"><td class="num" id="LN855">855</td><td class="line">        dstPtr += lhSize;</td></tr>
<tr class="codeline" data-linenumber="856"><td class="num" id="LN856">856</td><td class="line">        maxDstSize -= lhSize;</td></tr>
<tr class="codeline" data-linenumber="857"><td class="num" id="LN857">857</td><td class="line">        eSize += lhSize;</td></tr>
<tr class="codeline" data-linenumber="858"><td class="num" id="LN858">858</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="859"><td class="num" id="LN859">859</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="860"><td class="num" id="LN860">860</td><td class="line">    <span class='keyword'>if</span> (maxDstSize&lt;12) {</td></tr>
<tr class="codeline" data-linenumber="861"><td class="num" id="LN861">861</td><td class="line">        eSize = <span class='macro'>ERROR(dstSize_tooSmall)<span class='macro_popup'>((size_t)-ZSTD_error_dstSize_tooSmall)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="862"><td class="num" id="LN862">862</td><td class="line">        <span class='macro'>DISPLAYLEVEL(1, <span class='string_literal'>"not enough space to write RepOffsets \n"</span>)<span class='macro_popup'>if (notificationLevel&gt;=1) { { fprintf(stderr, "not enough space to write RepOffsets \n"<br>); fflush( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="863"><td class="num" id="LN863">863</td><td class="line">        <span class='keyword'>goto</span> _cleanup;</td></tr>
<tr class="codeline" data-linenumber="864"><td class="num" id="LN864">864</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="865"><td class="num" id="LN865">865</td><td class="line"><span class='directive'># if 0</span></td></tr>
<tr class="codeline" data-linenumber="866"><td class="num" id="LN866">866</td><td class="line">    MEM_writeLE32(dstPtr+0, bestRepOffset[0].offset);</td></tr>
<tr class="codeline" data-linenumber="867"><td class="num" id="LN867">867</td><td class="line">    MEM_writeLE32(dstPtr+4, bestRepOffset[1].offset);</td></tr>
<tr class="codeline" data-linenumber="868"><td class="num" id="LN868">868</td><td class="line">    MEM_writeLE32(dstPtr+8, bestRepOffset[2].offset);</td></tr>
<tr class="codeline" data-linenumber="869"><td class="num" id="LN869">869</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="870"><td class="num" id="LN870">870</td><td class="line">    <span class='comment'>/* at this stage, we don't use the result of "most common first offset",</span></td></tr>
<tr class="codeline" data-linenumber="871"><td class="num" id="LN871">871</td><td class="line">       <span class='comment'>as the impact of statistics is not properly evaluated */</span></td></tr>
<tr class="codeline" data-linenumber="872"><td class="num" id="LN872">872</td><td class="line">    MEM_writeLE32(dstPtr+0, repStartValue[0]);</td></tr>
<tr class="codeline" data-linenumber="873"><td class="num" id="LN873">873</td><td class="line">    MEM_writeLE32(dstPtr+4, repStartValue[1]);</td></tr>
<tr class="codeline" data-linenumber="874"><td class="num" id="LN874">874</td><td class="line">    MEM_writeLE32(dstPtr+8, repStartValue[2]);</td></tr>
<tr class="codeline" data-linenumber="875"><td class="num" id="LN875">875</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="876"><td class="num" id="LN876">876</td><td class="line">    eSize += 12;</td></tr>
<tr class="codeline" data-linenumber="877"><td class="num" id="LN877">877</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="878"><td class="num" id="LN878">878</td><td class="line">_cleanup:</td></tr>
<tr class="codeline" data-linenumber="879"><td class="num" id="LN879">879</td><td class="line">    ZSTD_freeCDict(esr.dict);</td></tr>
<tr class="codeline" data-linenumber="880"><td class="num" id="LN880">880</td><td class="line">    ZSTD_freeCCtx(esr.zc);</td></tr>
<tr class="codeline" data-linenumber="881"><td class="num" id="LN881">881</td><td class="line">    free(esr.workPlace);</td></tr>
<tr class="codeline" data-linenumber="882"><td class="num" id="LN882">882</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="883"><td class="num" id="LN883">883</td><td class="line">    <span class='keyword'>return</span> eSize;</td></tr>
<tr class="codeline" data-linenumber="884"><td class="num" id="LN884">884</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="885"><td class="num" id="LN885">885</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="886"><td class="num" id="LN886">886</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="887"><td class="num" id="LN887">887</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="888"><td class="num" id="LN888">888</td><td class="line">size_t ZDICT_finalizeDictionary(<span class='keyword'>void</span>* dictBuffer, size_t dictBufferCapacity,</td></tr>
<tr class="codeline" data-linenumber="889"><td class="num" id="LN889">889</td><td class="line">                          <span class='keyword'>const</span> <span class='keyword'>void</span>* customDictContent, size_t dictContentSize,</td></tr>
<tr class="codeline" data-linenumber="890"><td class="num" id="LN890">890</td><td class="line">                          <span class='keyword'>const</span> <span class='keyword'>void</span>* samplesBuffer, <span class='keyword'>const</span> size_t* samplesSizes,</td></tr>
<tr class="codeline" data-linenumber="891"><td class="num" id="LN891">891</td><td class="line">                          <span class='keyword'>unsigned</span> nbSamples, ZDICT_params_t params)</td></tr>
<tr class="codeline" data-linenumber="892"><td class="num" id="LN892">892</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="893"><td class="num" id="LN893">893</td><td class="line">    size_t hSize;</td></tr>
<tr class="codeline" data-linenumber="894"><td class="num" id="LN894">894</td><td class="line"><span class='directive'>#define <span class='macro'>HBUFFSIZE<span class='macro_popup'>256</span></span> 256   /* should prove large enough for all entropy headers */</span></td></tr>
<tr class="codeline" data-linenumber="895"><td class="num" id="LN895">895</td><td class="line">    BYTE header[<span class='macro'>HBUFFSIZE<span class='macro_popup'>256</span></span>];</td></tr>
<tr class="codeline" data-linenumber="896"><td class="num" id="LN896">896</td><td class="line">    <span class='keyword'>int</span> <span class='keyword'>const</span> compressionLevel = (params.compressionLevel == 0) ? g_compressionLevel_default : params.compressionLevel;</td></tr>
<tr class="codeline" data-linenumber="897"><td class="num" id="LN897">897</td><td class="line">    U32 <span class='keyword'>const</span> notificationLevel = params.notificationLevel;</td></tr>
<tr class="codeline" data-linenumber="898"><td class="num" id="LN898">898</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="899"><td class="num" id="LN899">899</td><td class="line">    <span class='comment'>/* check conditions */</span></td></tr>
<tr class="codeline" data-linenumber="900"><td class="num" id="LN900">900</td><td class="line">    <span class='macro'>DEBUGLOG(4, <span class='string_literal'>"ZDICT_finalizeDictionary"</span>)<span class='macro_popup'>{}</span></span>;</td></tr>
<tr class="codeline" data-linenumber="901"><td class="num" id="LN901">901</td><td class="line">    <span class='keyword'>if</span> (dictBufferCapacity &lt; dictContentSize) <span class='keyword'>return</span> <span class='macro'>ERROR(dstSize_tooSmall)<span class='macro_popup'>((size_t)-ZSTD_error_dstSize_tooSmall)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="902"><td class="num" id="LN902">902</td><td class="line">    <span class='keyword'>if</span> (dictContentSize &lt; <span class='macro'>ZDICT_CONTENTSIZE_MIN<span class='macro_popup'>128</span></span>) <span class='keyword'>return</span> <span class='macro'>ERROR(srcSize_wrong)<span class='macro_popup'>((size_t)-ZSTD_error_srcSize_wrong)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="903"><td class="num" id="LN903">903</td><td class="line">    <span class='keyword'>if</span> (dictBufferCapacity &lt; <span class='macro'>ZDICT_DICTSIZE_MIN<span class='macro_popup'>256</span></span>) <span class='keyword'>return</span> <span class='macro'>ERROR(dstSize_tooSmall)<span class='macro_popup'>((size_t)-ZSTD_error_dstSize_tooSmall)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="904"><td class="num" id="LN904">904</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="905"><td class="num" id="LN905">905</td><td class="line">    <span class='comment'>/* dictionary header */</span></td></tr>
<tr class="codeline" data-linenumber="906"><td class="num" id="LN906">906</td><td class="line">    MEM_writeLE32(header, <span class='macro'>ZSTD_MAGIC_DICTIONARY<span class='macro_popup'>0xEC30A437</span></span>);</td></tr>
<tr class="codeline" data-linenumber="907"><td class="num" id="LN907">907</td><td class="line">    {   U64 <span class='keyword'>const</span> randomID = <span class='macro'>XXH64<span class='macro_popup'>ZSTD_XXH64</span></span>(customDictContent, dictContentSize, 0);</td></tr>
<tr class="codeline" data-linenumber="908"><td class="num" id="LN908">908</td><td class="line">        U32 <span class='keyword'>const</span> compliantID = (randomID % ((1U&lt;&lt;31)-32768)) + 32768;</td></tr>
<tr class="codeline" data-linenumber="909"><td class="num" id="LN909">909</td><td class="line">        U32 <span class='keyword'>const</span> dictID = params.dictID ? params.dictID : compliantID;</td></tr>
<tr class="codeline" data-linenumber="910"><td class="num" id="LN910">910</td><td class="line">        MEM_writeLE32(header+4, dictID);</td></tr>
<tr class="codeline" data-linenumber="911"><td class="num" id="LN911">911</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="912"><td class="num" id="LN912">912</td><td class="line">    hSize = 8;</td></tr>
<tr class="codeline" data-linenumber="913"><td class="num" id="LN913">913</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="914"><td class="num" id="LN914">914</td><td class="line">    <span class='comment'>/* entropy tables */</span></td></tr>
<tr class="codeline" data-linenumber="915"><td class="num" id="LN915">915</td><td class="line">    <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"\r%70s\r"</span>, <span class='string_literal'>""</span>)<span class='macro_popup'>if (notificationLevel&gt;=2) { { fprintf(stderr, "\r%70s\r", ""<br>); fflush( stderr ); }; }</span></span>;   <span class='comment'>/* clean display line */</span></td></tr>
<tr class="codeline" data-linenumber="916"><td class="num" id="LN916">916</td><td class="line">    <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"statistics ... \n"</span>)<span class='macro_popup'>if (notificationLevel&gt;=2) { { fprintf(stderr, "statistics ... \n"<br>); fflush( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="917"><td class="num" id="LN917">917</td><td class="line">    {   size_t <span class='keyword'>const</span> eSize = ZDICT_analyzeEntropy(header+hSize, <span class='macro'>HBUFFSIZE<span class='macro_popup'>256</span></span>-hSize,</td></tr>
<tr class="codeline" data-linenumber="918"><td class="num" id="LN918">918</td><td class="line">                                  compressionLevel,</td></tr>
<tr class="codeline" data-linenumber="919"><td class="num" id="LN919">919</td><td class="line">                                  samplesBuffer, samplesSizes, nbSamples,</td></tr>
<tr class="codeline" data-linenumber="920"><td class="num" id="LN920">920</td><td class="line">                                  customDictContent, dictContentSize,</td></tr>
<tr class="codeline" data-linenumber="921"><td class="num" id="LN921">921</td><td class="line">                                  notificationLevel);</td></tr>
<tr class="codeline" data-linenumber="922"><td class="num" id="LN922">922</td><td class="line">        <span class='keyword'>if</span> (ZDICT_isError(eSize)) <span class='keyword'>return</span> eSize;</td></tr>
<tr class="codeline" data-linenumber="923"><td class="num" id="LN923">923</td><td class="line">        hSize += eSize;</td></tr>
<tr class="codeline" data-linenumber="924"><td class="num" id="LN924">924</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="925"><td class="num" id="LN925">925</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="926"><td class="num" id="LN926">926</td><td class="line">    <span class='comment'>/* copy elements in final buffer ; note : src and dst buffer can overlap */</span></td></tr>
<tr class="codeline" data-linenumber="927"><td class="num" id="LN927">927</td><td class="line">    <span class='keyword'>if</span> (hSize + dictContentSize &gt; dictBufferCapacity) dictContentSize = dictBufferCapacity - hSize;</td></tr>
<tr class="codeline" data-linenumber="928"><td class="num" id="LN928">928</td><td class="line">    {   size_t <span class='keyword'>const</span> dictSize = hSize + dictContentSize;</td></tr>
<tr class="codeline" data-linenumber="929"><td class="num" id="LN929">929</td><td class="line">        <span class='keyword'>char</span>* dictEnd = (<span class='keyword'>char</span>*)dictBuffer + dictSize;</td></tr>
<tr class="codeline" data-linenumber="930"><td class="num" id="LN930">930</td><td class="line">        memmove(dictEnd - dictContentSize, customDictContent, dictContentSize);</td></tr>
<tr class="codeline" data-linenumber="931"><td class="num" id="LN931">931</td><td class="line">        memcpy(dictBuffer, header, hSize);</td></tr>
<tr class="codeline" data-linenumber="932"><td class="num" id="LN932">932</td><td class="line">        <span class='keyword'>return</span> dictSize;</td></tr>
<tr class="codeline" data-linenumber="933"><td class="num" id="LN933">933</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="934"><td class="num" id="LN934">934</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="935"><td class="num" id="LN935">935</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="936"><td class="num" id="LN936">936</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="937"><td class="num" id="LN937">937</td><td class="line"><span class='keyword'>static</span> size_t ZDICT_addEntropyTablesFromBuffer_advanced(</td></tr>
<tr class="codeline" data-linenumber="938"><td class="num" id="LN938">938</td><td class="line">        <span class='keyword'>void</span>* dictBuffer, size_t dictContentSize, size_t dictBufferCapacity,</td></tr>
<tr class="codeline" data-linenumber="939"><td class="num" id="LN939">939</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>void</span>* samplesBuffer, <span class='keyword'>const</span> size_t* samplesSizes, <span class='keyword'>unsigned</span> nbSamples,</td></tr>
<tr class="codeline" data-linenumber="940"><td class="num" id="LN940">940</td><td class="line">        ZDICT_params_t params)</td></tr>
<tr class="codeline" data-linenumber="941"><td class="num" id="LN941">941</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="942"><td class="num" id="LN942">942</td><td class="line">    <span class='keyword'>int</span> <span class='keyword'>const</span> compressionLevel = (params.compressionLevel == 0) ? g_compressionLevel_default : params.compressionLevel;</td></tr>
<tr class="codeline" data-linenumber="943"><td class="num" id="LN943">943</td><td class="line">    U32 <span class='keyword'>const</span> notificationLevel = params.notificationLevel;</td></tr>
<tr class="codeline" data-linenumber="944"><td class="num" id="LN944">944</td><td class="line">    size_t hSize = 8;</td></tr>
<tr class="codeline" data-linenumber="945"><td class="num" id="LN945">945</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="946"><td class="num" id="LN946">946</td><td class="line">    <span class='comment'>/* calculate entropy tables */</span></td></tr>
<tr class="codeline" data-linenumber="947"><td class="num" id="LN947">947</td><td class="line">    <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"\r%70s\r"</span>, <span class='string_literal'>""</span>)<span class='macro_popup'>if (notificationLevel&gt;=2) { { fprintf(stderr, "\r%70s\r", ""<br>); fflush( stderr ); }; }</span></span>;   <span class='comment'>/* clean display line */</span></td></tr>
<tr class="codeline" data-linenumber="948"><td class="num" id="LN948">948</td><td class="line">    <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"statistics ... \n"</span>)<span class='macro_popup'>if (notificationLevel&gt;=2) { { fprintf(stderr, "statistics ... \n"<br>); fflush( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="949"><td class="num" id="LN949">949</td><td class="line">    {   size_t <span class='keyword'>const</span> eSize = ZDICT_analyzeEntropy((<span class='keyword'>char</span>*)dictBuffer+hSize, dictBufferCapacity-hSize,</td></tr>
<tr class="codeline" data-linenumber="950"><td class="num" id="LN950">950</td><td class="line">                                  compressionLevel,</td></tr>
<tr class="codeline" data-linenumber="951"><td class="num" id="LN951">951</td><td class="line">                                  samplesBuffer, samplesSizes, nbSamples,</td></tr>
<tr class="codeline" data-linenumber="952"><td class="num" id="LN952">952</td><td class="line">                                  (<span class='keyword'>char</span>*)dictBuffer + dictBufferCapacity - dictContentSize, dictContentSize,</td></tr>
<tr class="codeline" data-linenumber="953"><td class="num" id="LN953">953</td><td class="line">                                  notificationLevel);</td></tr>
<tr class="codeline" data-linenumber="954"><td class="num" id="LN954">954</td><td class="line">        <span class='keyword'>if</span> (ZDICT_isError(eSize)) <span class='keyword'>return</span> eSize;</td></tr>
<tr class="codeline" data-linenumber="955"><td class="num" id="LN955">955</td><td class="line">        hSize += eSize;</td></tr>
<tr class="codeline" data-linenumber="956"><td class="num" id="LN956">956</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="957"><td class="num" id="LN957">957</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="958"><td class="num" id="LN958">958</td><td class="line">    <span class='comment'>/* add dictionary header (after entropy tables) */</span></td></tr>
<tr class="codeline" data-linenumber="959"><td class="num" id="LN959">959</td><td class="line">    MEM_writeLE32(dictBuffer, <span class='macro'>ZSTD_MAGIC_DICTIONARY<span class='macro_popup'>0xEC30A437</span></span>);</td></tr>
<tr class="codeline" data-linenumber="960"><td class="num" id="LN960">960</td><td class="line">    {   U64 <span class='keyword'>const</span> randomID = <span class='macro'>XXH64<span class='macro_popup'>ZSTD_XXH64</span></span>((<span class='keyword'>char</span>*)dictBuffer + dictBufferCapacity - dictContentSize, dictContentSize, 0);</td></tr>
<tr class="codeline" data-linenumber="961"><td class="num" id="LN961">961</td><td class="line">        U32 <span class='keyword'>const</span> compliantID = (randomID % ((1U&lt;&lt;31)-32768)) + 32768;</td></tr>
<tr class="codeline" data-linenumber="962"><td class="num" id="LN962">962</td><td class="line">        U32 <span class='keyword'>const</span> dictID = params.dictID ? params.dictID : compliantID;</td></tr>
<tr class="codeline" data-linenumber="963"><td class="num" id="LN963">963</td><td class="line">        MEM_writeLE32((<span class='keyword'>char</span>*)dictBuffer+4, dictID);</td></tr>
<tr class="codeline" data-linenumber="964"><td class="num" id="LN964">964</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="965"><td class="num" id="LN965">965</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="966"><td class="num" id="LN966">966</td><td class="line">    <span class='keyword'>if</span> (hSize + dictContentSize &lt; dictBufferCapacity)</td></tr>
<tr class="codeline" data-linenumber="967"><td class="num" id="LN967">967</td><td class="line">        memmove((<span class='keyword'>char</span>*)dictBuffer + hSize, (<span class='keyword'>char</span>*)dictBuffer + dictBufferCapacity - dictContentSize, dictContentSize);</td></tr>
<tr class="codeline" data-linenumber="968"><td class="num" id="LN968">968</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>MIN(dictBufferCapacity, hSize+dictContentSize)<span class='macro_popup'>((dictBufferCapacity)&lt;(hSize+dictContentSize) ? (dictBufferCapacity<br>) : (hSize+dictContentSize))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="969"><td class="num" id="LN969">969</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="970"><td class="num" id="LN970">970</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="971"><td class="num" id="LN971">971</td><td class="line"><span class='comment'>/* Hidden declaration for dbio.c */</span></td></tr>
<tr class="codeline" data-linenumber="972"><td class="num" id="LN972">972</td><td class="line">size_t ZDICT_trainFromBuffer_unsafe_legacy(</td></tr>
<tr class="codeline" data-linenumber="973"><td class="num" id="LN973">973</td><td class="line">                            <span class='keyword'>void</span>* dictBuffer, size_t maxDictSize,</td></tr>
<tr class="codeline" data-linenumber="974"><td class="num" id="LN974">974</td><td class="line">                            <span class='keyword'>const</span> <span class='keyword'>void</span>* samplesBuffer, <span class='keyword'>const</span> size_t* samplesSizes, <span class='keyword'>unsigned</span> nbSamples,</td></tr>
<tr class="codeline" data-linenumber="975"><td class="num" id="LN975">975</td><td class="line">                            ZDICT_legacy_params_t params);</td></tr>
<tr class="codeline" data-linenumber="976"><td class="num" id="LN976">976</td><td class="line"><span class='comment'>/*! ZDICT_trainFromBuffer_unsafe_legacy() :</span></td></tr>
<tr class="codeline" data-linenumber="977"><td class="num" id="LN977">977</td><td class="line"><span class='comment'>*   Warning : `samplesBuffer` must be followed by noisy guard band.</span></td></tr>
<tr class="codeline" data-linenumber="978"><td class="num" id="LN978">978</td><td class="line"><span class='comment'>*   @return : size of dictionary, or an error code which can be tested with ZDICT_isError()</span></td></tr>
<tr class="codeline" data-linenumber="979"><td class="num" id="LN979">979</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="980"><td class="num" id="LN980">980</td><td class="line">size_t ZDICT_trainFromBuffer_unsafe_legacy(</td></tr>
<tr class="codeline" data-linenumber="981"><td class="num" id="LN981">981</td><td class="line">                            <span class='keyword'>void</span>* dictBuffer, size_t maxDictSize,</td></tr>
<tr class="codeline" data-linenumber="982"><td class="num" id="LN982">982</td><td class="line">                            <span class='keyword'>const</span> <span class='keyword'>void</span>* samplesBuffer, <span class='keyword'>const</span> size_t* samplesSizes, <span class='keyword'>unsigned</span> nbSamples,</td></tr>
<tr class="codeline" data-linenumber="983"><td class="num" id="LN983">983</td><td class="line">                            ZDICT_legacy_params_t params)</td></tr>
<tr class="codeline" data-linenumber="984"><td class="num" id="LN984">984</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="985"><td class="num" id="LN985">985</td><td class="line">    U32 <span class='keyword'>const</span> dictListSize = <span class='macro'>MAX(MAX(DICTLISTSIZE_DEFAULT, nbSamples), (U32)(maxDictSize/16))<span class='macro_popup'>((((10000)&gt;(nbSamples) ? (10000) : (nbSamples)))&gt;((U32)<br>(maxDictSize/16)) ? (((10000)&gt;(nbSamples) ? (10000) : (nbSamples<br>))) : ((U32)(maxDictSize/16)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="986"><td class="num" id="LN986">986</td><td class="line">    dictItem* <span class='keyword'>const</span> dictList = (dictItem*)malloc(dictListSize * <span class='keyword'>sizeof</span>(*dictList));</td></tr>
<tr class="codeline" data-linenumber="987"><td class="num" id="LN987">987</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>const</span> selectivity = params.selectivityLevel == 0 ? g_selectivity_default : params.selectivityLevel;</td></tr>
<tr class="codeline" data-linenumber="988"><td class="num" id="LN988">988</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>const</span> minRep = (selectivity &gt; 30) ? <span class='macro'>MINRATIO<span class='macro_popup'>4</span></span> : nbSamples &gt;&gt; selectivity;</td></tr>
<tr class="codeline" data-linenumber="989"><td class="num" id="LN989">989</td><td class="line">    size_t <span class='keyword'>const</span> targetDictSize = maxDictSize;</td></tr>
<tr class="codeline" data-linenumber="990"><td class="num" id="LN990">990</td><td class="line">    size_t <span class='keyword'>const</span> samplesBuffSize = ZDICT_totalSampleSize(samplesSizes, nbSamples);</td></tr>
<tr class="codeline" data-linenumber="991"><td class="num" id="LN991">991</td><td class="line">    size_t dictSize = 0;</td></tr>
<tr class="codeline" data-linenumber="992"><td class="num" id="LN992">992</td><td class="line">    U32 <span class='keyword'>const</span> notificationLevel = params.zParams.notificationLevel;</td></tr>
<tr class="codeline" data-linenumber="993"><td class="num" id="LN993">993</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="994"><td class="num" id="LN994">994</td><td class="line">    <span class='comment'>/* checks */</span></td></tr>
<tr class="codeline" data-linenumber="995"><td class="num" id="LN995">995</td><td class="line">    <span class='keyword'>if</span> (!dictList) <span class='keyword'>return</span> <span class='macro'>ERROR(memory_allocation)<span class='macro_popup'>((size_t)-ZSTD_error_memory_allocation)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="996"><td class="num" id="LN996">996</td><td class="line">    <span class='keyword'>if</span> (maxDictSize &lt; <span class='macro'>ZDICT_DICTSIZE_MIN<span class='macro_popup'>256</span></span>) { free(dictList); <span class='keyword'>return</span> <span class='macro'>ERROR(dstSize_tooSmall)<span class='macro_popup'>((size_t)-ZSTD_error_dstSize_tooSmall)</span></span>; }   <span class='comment'>/* requested dictionary size is too small */</span></td></tr>
<tr class="codeline" data-linenumber="997"><td class="num" id="LN997">997</td><td class="line">    <span class='keyword'>if</span> (samplesBuffSize &lt; <span class='macro'>ZDICT_MIN_SAMPLES_SIZE<span class='macro_popup'>(128 * 4)</span></span>) { free(dictList); <span class='keyword'>return</span> <span class='macro'>ERROR(dictionaryCreation_failed)<span class='macro_popup'>((size_t)-ZSTD_error_dictionaryCreation_failed)</span></span>; }   <span class='comment'>/* not enough source to create dictionary */</span></td></tr>
<tr class="codeline" data-linenumber="998"><td class="num" id="LN998">998</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="999"><td class="num" id="LN999">999</td><td class="line">    <span class='comment'>/* init */</span></td></tr>
<tr class="codeline" data-linenumber="1000"><td class="num" id="LN1000">1000</td><td class="line">    ZDICT_initDictItem(dictList);</td></tr>
<tr class="codeline" data-linenumber="1001"><td class="num" id="LN1001">1001</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1002"><td class="num" id="LN1002">1002</td><td class="line">    <span class='comment'>/* build dictionary */</span></td></tr>
<tr class="codeline" data-linenumber="1003"><td class="num" id="LN1003">1003</td><td class="line">    ZDICT_trainBuffer_legacy(dictList, dictListSize,</td></tr>
<tr class="codeline" data-linenumber="1004"><td class="num" id="LN1004">1004</td><td class="line">                       samplesBuffer, samplesBuffSize,</td></tr>
<tr class="codeline" data-linenumber="1005"><td class="num" id="LN1005">1005</td><td class="line">                       samplesSizes, nbSamples,</td></tr>
<tr class="codeline" data-linenumber="1006"><td class="num" id="LN1006">1006</td><td class="line">                       minRep, notificationLevel);</td></tr>
<tr class="codeline" data-linenumber="1007"><td class="num" id="LN1007">1007</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1008"><td class="num" id="LN1008">1008</td><td class="line">    <span class='comment'>/* display best matches */</span></td></tr>
<tr class="codeline" data-linenumber="1009"><td class="num" id="LN1009">1009</td><td class="line">    <span class='keyword'>if</span> (params.zParams.notificationLevel&gt;= 3) {</td></tr>
<tr class="codeline" data-linenumber="1010"><td class="num" id="LN1010">1010</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>const</span> nb = <span class='macro'>MIN(25, dictList[0].pos)<span class='macro_popup'>((25)&lt;(dictList[0].pos) ? (25) : (dictList[0].pos))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1011"><td class="num" id="LN1011">1011</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>const</span> dictContentSize = ZDICT_dictSize(dictList);</td></tr>
<tr class="codeline" data-linenumber="1012"><td class="num" id="LN1012">1012</td><td class="line">        <span class='keyword'>unsigned</span> u;</td></tr>
<tr class="codeline" data-linenumber="1013"><td class="num" id="LN1013">1013</td><td class="line">        <span class='macro'>DISPLAYLEVEL(3, <span class='string_literal'>"\n %u segments found, of total size %u \n"</span>, (<span class='keyword'>unsigned</span>)dictList[0].pos-1, dictContentSize)<span class='macro_popup'>if (notificationLevel&gt;=3) { { fprintf(stderr, "\n %u segments found, of total size %u \n"<br>, (unsigned)dictList[0].pos-1, dictContentSize); fflush( stderr<br> ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1014"><td class="num" id="LN1014">1014</td><td class="line">        <span class='macro'>DISPLAYLEVEL(3, <span class='string_literal'>"list %u best segments \n"</span>, nb-1)<span class='macro_popup'>if (notificationLevel&gt;=3) { { fprintf(stderr, "list %u best segments \n"<br>, nb-1); fflush( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1015"><td class="num" id="LN1015">1015</td><td class="line">        <span class='keyword'>for</span> (u=1; u&lt;nb; u++) {</td></tr>
<tr class="codeline" data-linenumber="1016"><td class="num" id="LN1016">1016</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>const</span> pos = dictList[u].pos;</td></tr>
<tr class="codeline" data-linenumber="1017"><td class="num" id="LN1017">1017</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>const</span> length = dictList[u].length;</td></tr>
<tr class="codeline" data-linenumber="1018"><td class="num" id="LN1018">1018</td><td class="line">            U32 <span class='keyword'>const</span> printedLength = <span class='macro'>MIN(40, length)<span class='macro_popup'>((40)&lt;(length) ? (40) : (length))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1019"><td class="num" id="LN1019">1019</td><td class="line">            <span class='keyword'>if</span> ((pos &gt; samplesBuffSize) || ((pos + length) &gt; samplesBuffSize)) {</td></tr>
<tr class="codeline" data-linenumber="1020"><td class="num" id="LN1020">1020</td><td class="line">                free(dictList);</td></tr>
<tr class="codeline" data-linenumber="1021"><td class="num" id="LN1021">1021</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>ERROR(GENERIC)<span class='macro_popup'>((size_t)-ZSTD_error_GENERIC)</span></span>;   <span class='comment'>/* should never happen */</span></td></tr>
<tr class="codeline" data-linenumber="1022"><td class="num" id="LN1022">1022</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1023"><td class="num" id="LN1023">1023</td><td class="line">            <span class='macro'>DISPLAYLEVEL(3, <span class='string_literal'>"%3u:%3u bytes at pos %8u, savings %7u bytes |"</span>,<span class='macro_popup'>if (notificationLevel&gt;=3) { { fprintf(stderr, "%3u:%3u bytes at pos %8u, savings %7u bytes |"<br>, u, length, pos, (unsigned)dictList[u].savings); fflush( stderr<br> ); }; }</span></span></td></tr>
<tr class="codeline" data-linenumber="1024"><td class="num" id="LN1024">1024</td><td class="line">                         <span class='macro'>u, length, pos, (<span class='keyword'>unsigned</span>)dictList[u].savings)<span class='macro_popup'>if (notificationLevel&gt;=3) { { fprintf(stderr, "%3u:%3u bytes at pos %8u, savings %7u bytes |"<br>, u, length, pos, (unsigned)dictList[u].savings); fflush( stderr<br> ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1025"><td class="num" id="LN1025">1025</td><td class="line">            ZDICT_printHex((<span class='keyword'>const</span> <span class='keyword'>char</span>*)samplesBuffer+pos, printedLength);</td></tr>
<tr class="codeline" data-linenumber="1026"><td class="num" id="LN1026">1026</td><td class="line">            <span class='macro'>DISPLAYLEVEL(3, <span class='string_literal'>"| \n"</span>)<span class='macro_popup'>if (notificationLevel&gt;=3) { { fprintf(stderr, "| \n"); fflush<br>( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1027"><td class="num" id="LN1027">1027</td><td class="line">    }   }</td></tr>
<tr class="codeline" data-linenumber="1028"><td class="num" id="LN1028">1028</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1029"><td class="num" id="LN1029">1029</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1030"><td class="num" id="LN1030">1030</td><td class="line">    <span class='comment'>/* create dictionary */</span></td></tr>
<tr class="codeline" data-linenumber="1031"><td class="num" id="LN1031">1031</td><td class="line">    {   <span class='keyword'>unsigned</span> dictContentSize = ZDICT_dictSize(dictList);</td></tr>
<tr class="codeline" data-linenumber="1032"><td class="num" id="LN1032">1032</td><td class="line">        <span class='keyword'>if</span> (dictContentSize &lt; <span class='macro'>ZDICT_CONTENTSIZE_MIN<span class='macro_popup'>128</span></span>) { free(dictList); <span class='keyword'>return</span> <span class='macro'>ERROR(dictionaryCreation_failed)<span class='macro_popup'>((size_t)-ZSTD_error_dictionaryCreation_failed)</span></span>; }   <span class='comment'>/* dictionary content too small */</span></td></tr>
<tr class="codeline" data-linenumber="1033"><td class="num" id="LN1033">1033</td><td class="line">        <span class='keyword'>if</span> (dictContentSize &lt; targetDictSize/4) {</td></tr>
<tr class="codeline" data-linenumber="1034"><td class="num" id="LN1034">1034</td><td class="line">            <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"!  warning : selected content significantly smaller than requested (%u &lt; %u) \n"</span>, dictContentSize, (<span class='keyword'>unsigned</span>)maxDictSize)<span class='macro_popup'>if (notificationLevel&gt;=2) { { fprintf(stderr, "!  warning : selected content significantly smaller than requested (%u &lt; %u) \n"<br>, dictContentSize, (unsigned)maxDictSize); fflush( stderr ); }<br>; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1035"><td class="num" id="LN1035">1035</td><td class="line">            <span class='keyword'>if</span> (samplesBuffSize &lt; 10 * targetDictSize)</td></tr>
<tr class="codeline" data-linenumber="1036"><td class="num" id="LN1036">1036</td><td class="line">                <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"!  consider increasing the number of samples (total size : %u MB)\n"</span>, (<span class='keyword'>unsigned</span>)(samplesBuffSize&gt;&gt;20))<span class='macro_popup'>if (notificationLevel&gt;=2) { { fprintf(stderr, "!  consider increasing the number of samples (total size : %u MB)\n"<br>, (unsigned)(samplesBuffSize&gt;&gt;20)); fflush( stderr ); }<br>; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1037"><td class="num" id="LN1037">1037</td><td class="line">            <span class='keyword'>if</span> (minRep &gt; <span class='macro'>MINRATIO<span class='macro_popup'>4</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1038"><td class="num" id="LN1038">1038</td><td class="line">                <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"!  consider increasing selectivity to produce larger dictionary (-s%u) \n"</span>, selectivity+1)<span class='macro_popup'>if (notificationLevel&gt;=2) { { fprintf(stderr, "!  consider increasing selectivity to produce larger dictionary (-s%u) \n"<br>, selectivity+1); fflush( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1039"><td class="num" id="LN1039">1039</td><td class="line">                <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"!  note : larger dictionaries are not necessarily better, test its efficiency on samples \n"</span>)<span class='macro_popup'>if (notificationLevel&gt;=2) { { fprintf(stderr, "!  note : larger dictionaries are not necessarily better, test its efficiency on samples \n"<br>); fflush( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1040"><td class="num" id="LN1040">1040</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1041"><td class="num" id="LN1041">1041</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1042"><td class="num" id="LN1042">1042</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1043"><td class="num" id="LN1043">1043</td><td class="line">        <span class='keyword'>if</span> ((dictContentSize &gt; targetDictSize*3) &amp;&amp; (nbSamples &gt; 2*<span class='macro'>MINRATIO<span class='macro_popup'>4</span></span>) &amp;&amp; (selectivity&gt;1)) {</td></tr>
<tr class="codeline" data-linenumber="1044"><td class="num" id="LN1044">1044</td><td class="line">            <span class='keyword'>unsigned</span> proposedSelectivity = selectivity-1;</td></tr>
<tr class="codeline" data-linenumber="1045"><td class="num" id="LN1045">1045</td><td class="line">            <span class='keyword'>while</span> ((nbSamples &gt;&gt; proposedSelectivity) &lt;= <span class='macro'>MINRATIO<span class='macro_popup'>4</span></span>) { proposedSelectivity--; }</td></tr>
<tr class="codeline" data-linenumber="1046"><td class="num" id="LN1046">1046</td><td class="line">            <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"!  note : calculated dictionary significantly larger than requested (%u &gt; %u) \n"</span>, dictContentSize, (<span class='keyword'>unsigned</span>)maxDictSize)<span class='macro_popup'>if (notificationLevel&gt;=2) { { fprintf(stderr, "!  note : calculated dictionary significantly larger than requested (%u &gt; %u) \n"<br>, dictContentSize, (unsigned)maxDictSize); fflush( stderr ); }<br>; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1047"><td class="num" id="LN1047">1047</td><td class="line">            <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"!  consider increasing dictionary size, or produce denser dictionary (-s%u) \n"</span>, proposedSelectivity)<span class='macro_popup'>if (notificationLevel&gt;=2) { { fprintf(stderr, "!  consider increasing dictionary size, or produce denser dictionary (-s%u) \n"<br>, proposedSelectivity); fflush( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1048"><td class="num" id="LN1048">1048</td><td class="line">            <span class='macro'>DISPLAYLEVEL(2, <span class='string_literal'>"!  always test dictionary efficiency on real samples \n"</span>)<span class='macro_popup'>if (notificationLevel&gt;=2) { { fprintf(stderr, "!  always test dictionary efficiency on real samples \n"<br>); fflush( stderr ); }; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1049"><td class="num" id="LN1049">1049</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1050"><td class="num" id="LN1050">1050</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1051"><td class="num" id="LN1051">1051</td><td class="line">        <span class='comment'>/* limit dictionary size */</span></td></tr>
<tr class="codeline" data-linenumber="1052"><td class="num" id="LN1052">1052</td><td class="line">        {   U32 <span class='keyword'>const</span> max = dictList-&gt;pos;   <span class='comment'>/* convention : nb of useful elts within dictList */</span></td></tr>
<tr class="codeline" data-linenumber="1053"><td class="num" id="LN1053">1053</td><td class="line">            U32 currentSize = 0;</td></tr>
<tr class="codeline" data-linenumber="1054"><td class="num" id="LN1054">1054</td><td class="line">            U32 n; <span class='keyword'>for</span> (n=1; n&lt;max; n++) {</td></tr>
<tr class="codeline" data-linenumber="1055"><td class="num" id="LN1055">1055</td><td class="line">                currentSize += dictList[n].length;</td></tr>
<tr class="codeline" data-linenumber="1056"><td class="num" id="LN1056">1056</td><td class="line">                <span class='keyword'>if</span> (currentSize &gt; targetDictSize) { currentSize -= dictList[n].length; <span class='keyword'>break</span>; }</td></tr>
<tr class="codeline" data-linenumber="1057"><td class="num" id="LN1057">1057</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1058"><td class="num" id="LN1058">1058</td><td class="line">            dictList-&gt;pos = n;</td></tr>
<tr class="codeline" data-linenumber="1059"><td class="num" id="LN1059">1059</td><td class="line">            dictContentSize = currentSize;</td></tr>
<tr class="codeline" data-linenumber="1060"><td class="num" id="LN1060">1060</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1061"><td class="num" id="LN1061">1061</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1062"><td class="num" id="LN1062">1062</td><td class="line">        <span class='comment'>/* build dict content */</span></td></tr>
<tr class="codeline" data-linenumber="1063"><td class="num" id="LN1063">1063</td><td class="line">        {   U32 u;</td></tr>
<tr class="codeline" data-linenumber="1064"><td class="num" id="LN1064">1064</td><td class="line">            BYTE* ptr = (BYTE*)dictBuffer + maxDictSize;</td></tr>
<tr class="codeline" data-linenumber="1065"><td class="num" id="LN1065">1065</td><td class="line">            <span class='keyword'>for</span> (u=1; u&lt;dictList-&gt;pos; u++) {</td></tr>
<tr class="codeline" data-linenumber="1066"><td class="num" id="LN1066">1066</td><td class="line">                U32 l = dictList[u].length;</td></tr>
<tr class="codeline" data-linenumber="1067"><td class="num" id="LN1067">1067</td><td class="line">                ptr -= l;</td></tr>
<tr class="codeline" data-linenumber="1068"><td class="num" id="LN1068">1068</td><td class="line">                <span class='keyword'>if</span> (ptr&lt;(BYTE*)dictBuffer) { free(dictList); <span class='keyword'>return</span> <span class='macro'>ERROR(GENERIC)<span class='macro_popup'>((size_t)-ZSTD_error_GENERIC)</span></span>; }   <span class='comment'>/* should not happen */</span></td></tr>
<tr class="codeline" data-linenumber="1069"><td class="num" id="LN1069">1069</td><td class="line">                memcpy(ptr, (<span class='keyword'>const</span> <span class='keyword'>char</span>*)samplesBuffer+dictList[u].pos, l);</td></tr>
<tr class="codeline" data-linenumber="1070"><td class="num" id="LN1070">1070</td><td class="line">        }   }</td></tr>
<tr class="codeline" data-linenumber="1071"><td class="num" id="LN1071">1071</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1072"><td class="num" id="LN1072">1072</td><td class="line">        dictSize = ZDICT_addEntropyTablesFromBuffer_advanced(dictBuffer, dictContentSize, maxDictSize,</td></tr>
<tr class="codeline" data-linenumber="1073"><td class="num" id="LN1073">1073</td><td class="line">                                                             samplesBuffer, samplesSizes, nbSamples,</td></tr>
<tr class="codeline" data-linenumber="1074"><td class="num" id="LN1074">1074</td><td class="line">                                                             params.zParams);</td></tr>
<tr class="codeline" data-linenumber="1075"><td class="num" id="LN1075">1075</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1076"><td class="num" id="LN1076">1076</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1077"><td class="num" id="LN1077">1077</td><td class="line">    <span class='comment'>/* clean up */</span></td></tr>
<tr class="codeline" data-linenumber="1078"><td class="num" id="LN1078">1078</td><td class="line">    free(dictList);</td></tr>
<tr class="codeline" data-linenumber="1079"><td class="num" id="LN1079">1079</td><td class="line">    <span class='keyword'>return</span> dictSize;</td></tr>
<tr class="codeline" data-linenumber="1080"><td class="num" id="LN1080">1080</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1081"><td class="num" id="LN1081">1081</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1082"><td class="num" id="LN1082">1082</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1083"><td class="num" id="LN1083">1083</td><td class="line"><span class='comment'>/* ZDICT_trainFromBuffer_legacy() :</span></td></tr>
<tr class="codeline" data-linenumber="1084"><td class="num" id="LN1084">1084</td><td class="line"> <span class='comment'>* issue : samplesBuffer need to be followed by a noisy guard band.</span></td></tr>
<tr class="codeline" data-linenumber="1085"><td class="num" id="LN1085">1085</td><td class="line"> <span class='comment'>* work around : duplicate the buffer, and add the noise */</span></td></tr>
<tr class="codeline" data-linenumber="1086"><td class="num" id="LN1086">1086</td><td class="line">size_t ZDICT_trainFromBuffer_legacy(<span class='keyword'>void</span>* dictBuffer, size_t dictBufferCapacity,</td></tr>
<tr class="codeline" data-linenumber="1087"><td class="num" id="LN1087">1087</td><td class="line">                              <span class='keyword'>const</span> <span class='keyword'>void</span>* samplesBuffer, <span class='keyword'>const</span> size_t* samplesSizes, <span class='keyword'>unsigned</span> nbSamples,</td></tr>
<tr class="codeline" data-linenumber="1088"><td class="num" id="LN1088">1088</td><td class="line">                              ZDICT_legacy_params_t params)</td></tr>
<tr class="codeline" data-linenumber="1089"><td class="num" id="LN1089">1089</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1090"><td class="num" id="LN1090">1090</td><td class="line">    size_t result;</td></tr>
<tr class="codeline" data-linenumber="1091"><td class="num" id="LN1091">1091</td><td class="line">    <span class='keyword'>void</span>* newBuff;</td></tr>
<tr class="codeline" data-linenumber="1092"><td class="num" id="LN1092">1092</td><td class="line">    size_t <span class='keyword'>const</span> sBuffSize = ZDICT_totalSampleSize(samplesSizes, nbSamples);</td></tr>
<tr class="codeline" data-linenumber="1093"><td class="num" id="LN1093">1093</td><td class="line">    <span class='keyword'>if</span> (sBuffSize &lt; <span class='macro'>ZDICT_MIN_SAMPLES_SIZE<span class='macro_popup'>(128 * 4)</span></span>) <span class='keyword'>return</span> 0;   <span class='comment'>/* not enough content =&gt; no dictionary */</span></td></tr>
<tr class="codeline" data-linenumber="1094"><td class="num" id="LN1094">1094</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1095"><td class="num" id="LN1095">1095</td><td class="line">    newBuff = malloc(sBuffSize + <span class='macro'>NOISELENGTH<span class='macro_popup'>32</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1096"><td class="num" id="LN1096">1096</td><td class="line">    <span class='keyword'>if</span> (!newBuff) <span class='keyword'>return</span> <span class='macro'>ERROR(memory_allocation)<span class='macro_popup'>((size_t)-ZSTD_error_memory_allocation)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1097"><td class="num" id="LN1097">1097</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1098"><td class="num" id="LN1098">1098</td><td class="line">    <span class="mrange">memcpy</span>(newBuff, samplesBuffer, sBuffSize);</td></tr>
<tr><td class="num"></td><td class="line"><div id="EndPath" class="msg msgEvent" style="margin-left:5ex; max-width:58em">Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11</div></td></tr>
<tr class="codeline" data-linenumber="1099"><td class="num" id="LN1099">1099</td><td class="line">    ZDICT_fillNoise((<span class='keyword'>char</span>*)newBuff + sBuffSize, <span class='macro'>NOISELENGTH<span class='macro_popup'>32</span></span>);   <span class='comment'>/* guard band, for end of buffer condition */</span></td></tr>
<tr class="codeline" data-linenumber="1100"><td class="num" id="LN1100">1100</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1101"><td class="num" id="LN1101">1101</td><td class="line">    result =</td></tr>
<tr class="codeline" data-linenumber="1102"><td class="num" id="LN1102">1102</td><td class="line">        ZDICT_trainFromBuffer_unsafe_legacy(dictBuffer, dictBufferCapacity, newBuff,</td></tr>
<tr class="codeline" data-linenumber="1103"><td class="num" id="LN1103">1103</td><td class="line">                                            samplesSizes, nbSamples, params);</td></tr>
<tr class="codeline" data-linenumber="1104"><td class="num" id="LN1104">1104</td><td class="line">    free(newBuff);</td></tr>
<tr class="codeline" data-linenumber="1105"><td class="num" id="LN1105">1105</td><td class="line">    <span class='keyword'>return</span> result;</td></tr>
<tr class="codeline" data-linenumber="1106"><td class="num" id="LN1106">1106</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1107"><td class="num" id="LN1107">1107</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1108"><td class="num" id="LN1108">1108</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1109"><td class="num" id="LN1109">1109</td><td class="line">size_t ZDICT_trainFromBuffer(<span class='keyword'>void</span>* dictBuffer, size_t dictBufferCapacity,</td></tr>
<tr class="codeline" data-linenumber="1110"><td class="num" id="LN1110">1110</td><td class="line">                             <span class='keyword'>const</span> <span class='keyword'>void</span>* samplesBuffer, <span class='keyword'>const</span> size_t* samplesSizes, <span class='keyword'>unsigned</span> nbSamples)</td></tr>
<tr class="codeline" data-linenumber="1111"><td class="num" id="LN1111">1111</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1112"><td class="num" id="LN1112">1112</td><td class="line">    ZDICT_fastCover_params_t params;</td></tr>
<tr class="codeline" data-linenumber="1113"><td class="num" id="LN1113">1113</td><td class="line">    <span class='macro'>DEBUGLOG(3, <span class='string_literal'>"ZDICT_trainFromBuffer"</span>)<span class='macro_popup'>{}</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1114"><td class="num" id="LN1114">1114</td><td class="line">    memset(&amp;params, 0, <span class='keyword'>sizeof</span>(params));</td></tr>
<tr class="codeline" data-linenumber="1115"><td class="num" id="LN1115">1115</td><td class="line">    params.d = 8;</td></tr>
<tr class="codeline" data-linenumber="1116"><td class="num" id="LN1116">1116</td><td class="line">    params.steps = 4;</td></tr>
<tr class="codeline" data-linenumber="1117"><td class="num" id="LN1117">1117</td><td class="line">    <span class='comment'>/* Default to level 6 since no compression level information is available */</span></td></tr>
<tr class="codeline" data-linenumber="1118"><td class="num" id="LN1118">1118</td><td class="line">    params.zParams.compressionLevel = 3;</td></tr>
<tr class="codeline" data-linenumber="1119"><td class="num" id="LN1119">1119</td><td class="line"><span class='directive'>#if defined(<span class='macro'>DEBUGLEVEL<span class='macro_popup'>0</span></span>) &amp;&amp; (<span class='macro'>DEBUGLEVEL<span class='macro_popup'>0</span></span>&gt;=1)</span></td></tr>
<tr class="codeline" data-linenumber="1120"><td class="num" id="LN1120">1120</td><td class="line">    params.zParams.notificationLevel = <span class='macro'>DEBUGLEVEL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1121"><td class="num" id="LN1121">1121</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1122"><td class="num" id="LN1122">1122</td><td class="line">    <span class='keyword'>return</span> ZDICT_optimizeTrainFromBuffer_fastCover(dictBuffer, dictBufferCapacity,</td></tr>
<tr class="codeline" data-linenumber="1123"><td class="num" id="LN1123">1123</td><td class="line">                                               samplesBuffer, samplesSizes, nbSamples,</td></tr>
<tr class="codeline" data-linenumber="1124"><td class="num" id="LN1124">1124</td><td class="line">                                               &amp;params);</td></tr>
<tr class="codeline" data-linenumber="1125"><td class="num" id="LN1125">1125</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1126"><td class="num" id="LN1126">1126</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1127"><td class="num" id="LN1127">1127</td><td class="line">size_t ZDICT_addEntropyTablesFromBuffer(<span class='keyword'>void</span>* dictBuffer, size_t dictContentSize, size_t dictBufferCapacity,</td></tr>
<tr class="codeline" data-linenumber="1128"><td class="num" id="LN1128">1128</td><td class="line">                                  <span class='keyword'>const</span> <span class='keyword'>void</span>* samplesBuffer, <span class='keyword'>const</span> size_t* samplesSizes, <span class='keyword'>unsigned</span> nbSamples)</td></tr>
<tr class="codeline" data-linenumber="1129"><td class="num" id="LN1129">1129</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1130"><td class="num" id="LN1130">1130</td><td class="line">    ZDICT_params_t params;</td></tr>
<tr class="codeline" data-linenumber="1131"><td class="num" id="LN1131">1131</td><td class="line">    memset(&amp;params, 0, <span class='keyword'>sizeof</span>(params));</td></tr>
<tr class="codeline" data-linenumber="1132"><td class="num" id="LN1132">1132</td><td class="line">    <span class='keyword'>return</span> ZDICT_addEntropyTablesFromBuffer_advanced(dictBuffer, dictContentSize, dictBufferCapacity,</td></tr>
<tr class="codeline" data-linenumber="1133"><td class="num" id="LN1133">1133</td><td class="line">                                                     samplesBuffer, samplesSizes, nbSamples,</td></tr>
<tr class="codeline" data-linenumber="1134"><td class="num" id="LN1134">1134</td><td class="line">                                                     params);</td></tr>
<tr class="codeline" data-linenumber="1135"><td class="num" id="LN1135">1135</td><td class="line">}</td></tr>
</table></body></html>
