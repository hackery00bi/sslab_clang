<!doctype html>
<html>
<head>
<title>memline.c</title>

<style type="text/css">
body { color:#000000; background-color:#ffffff }
body { font-family:Helvetica, sans-serif; font-size:10pt }
h1 { font-size:14pt }
.FileName { margin-top: 5px; margin-bottom: 5px; display: inline; }
.FileNav { margin-left: 5px; margin-right: 5px; display: inline; }
.FileNav a { text-decoration:none; font-size: larger; }
.divider { margin-top: 30px; margin-bottom: 30px; height: 15px; }
.divider { background-color: gray; }
.code { border-collapse:collapse; width:100%; }
.code { font-family: "Monospace", monospace; font-size:10pt }
.code { line-height: 1.2em }
.comment { color: green; font-style: oblique }
.keyword { color: blue }
.string_literal { color: red }
.directive { color: darkmagenta }

/* Macros and variables could have pop-up notes hidden by default.
  - Macro pop-up:    expansion of the macro
  - Variable pop-up: value (table) of the variable */
.macro_popup, .variable_popup { display: none; }

/* Pop-up appears on mouse-hover event. */
.macro:hover .macro_popup, .variable:hover .variable_popup {
  display: block;
  padding: 2px;
  -webkit-border-radius:5px;
  -webkit-box-shadow:1px 1px 7px #000;
  border-radius:5px;
  box-shadow:1px 1px 7px #000;
  position: absolute;
  top: -1em;
  left:10em;
  z-index: 1
}

.macro_popup {
  border: 2px solid red;
  background-color:#FFF0F0;
  font-weight: normal;
}

.variable_popup {
  border: 2px solid blue;
  background-color:#F0F0FF;
  font-weight: bold;
  font-family: Helvetica, sans-serif;
  font-size: 9pt;
}

/* Pop-up notes needs a relative position as a base where they pops up. */
.macro, .variable {
  background-color: PaleGoldenRod;
  position: relative;
}
.macro { color: DarkMagenta; }

#tooltiphint {
  position: fixed;
  width: 50em;
  margin-left: -25em;
  left: 50%;
  padding: 10px;
  border: 1px solid #b0b0b0;
  border-radius: 2px;
  box-shadow: 1px 1px 7px black;
  background-color: #c0c0c0;
  z-index: 2;
}

.num { width:2.5em; padding-right:2ex; background-color:#eeeeee }
.num { text-align:right; font-size:8pt }
.num { color:#444444 }
.line { padding-left: 1ex; border-left: 3px solid #ccc }
.line { white-space: pre }
.msg { -webkit-box-shadow:1px 1px 7px #000 }
.msg { box-shadow:1px 1px 7px #000 }
.msg { -webkit-border-radius:5px }
.msg { border-radius:5px }
.msg { font-family:Helvetica, sans-serif; font-size:8pt }
.msg { float:left }
.msg { padding:0.25em 1ex 0.25em 1ex }
.msg { margin-top:10px; margin-bottom:10px }
.msg { font-weight:bold }
.msg { max-width:60em; word-wrap: break-word; white-space: pre-wrap }
.msgT { padding:0x; spacing:0x }
.msgEvent { background-color:#fff8b4; color:#000000 }
.msgControl { background-color:#bbbbbb; color:#000000 }
.msgNote { background-color:#ddeeff; color:#000000 }
.mrange { background-color:#dfddf3 }
.mrange { border-bottom:1px solid #6F9DBE }
.PathIndex { font-weight: bold; padding:0px 5px; margin-right:5px; }
.PathIndex { -webkit-border-radius:8px }
.PathIndex { border-radius:8px }
.PathIndexEvent { background-color:#bfba87 }
.PathIndexControl { background-color:#8c8c8c }
.PathIndexPopUp { background-color: #879abc; }
.PathNav a { text-decoration:none; font-size: larger }
.CodeInsertionHint { font-weight: bold; background-color: #10dd10 }
.CodeRemovalHint { background-color:#de1010 }
.CodeRemovalHint { border-bottom:1px solid #6F9DBE }
.selected{ background-color:orange !important; }

table.simpletable {
  padding: 5px;
  font-size:12pt;
  margin:20px;
  border-collapse: collapse; border-spacing: 0px;
}
td.rowname {
  text-align: right;
  vertical-align: top;
  font-weight: bold;
  color:#444444;
  padding-right:2ex;
}

/* Hidden text. */
input.spoilerhider + label {
  cursor: pointer;
  text-decoration: underline;
  display: block;
}
input.spoilerhider {
 display: none;
}
input.spoilerhider ~ .spoiler {
  overflow: hidden;
  margin: 10px auto 0;
  height: 0;
  opacity: 0;
}
input.spoilerhider:checked + label + .spoiler{
  height: auto;
  opacity: 1;
}
</style>
</head>
<body>
<!-- BUGDESC Call to function 'strcpy' is insecure as it does not provide bounding of the memory buffer. Replace unbounded copy functions with analogous functions that support length arguments such as 'strlcpy'. CWE-119 -->

<!-- BUGTYPE Potential insecure memory buffer bounds restriction in call 'strcpy' -->

<!-- BUGCATEGORY Security -->

<!-- BUGFILE /tmp/sslab_clang/c_vim/vim/src/memline.c -->

<!-- FILENAME memline.c -->

<!-- FUNCTIONNAME make_percent_swname -->

<!-- ISSUEHASHCONTENTOFLINEINCONTEXT 06c8496b6e12cf2afc19ec6b30de7e21 -->

<!-- BUGLINE 2030 -->

<!-- BUGCOLUMN 6 -->

<!-- BUGPATHLENGTH 1 -->

<!-- BUGMETAEND -->
<!-- REPORTHEADER -->
<h3>Bug Summary</h3>
<table class="simpletable">
<tr><td class="rowname">File:</td><td>memline.c</td></tr>
<tr><td class="rowname">Warning:</td><td><a href="#EndPath">line 2030, column 6</a><br />Call to function 'strcpy' is insecure as it does not provide bounding of the memory buffer. Replace unbounded copy functions with analogous functions that support length arguments such as 'strlcpy'. CWE-119</td></tr>

</table>
<!-- REPORTSUMMARYEXTRA -->
<h3>Annotated Source Code</h3>
<p>Press <a href="#" onclick="toggleHelp(); return false;">'?'</a>
   to see keyboard shortcuts</p>
<input type="checkbox" class="spoilerhider" id="showinvocation" />
<label for="showinvocation" >Show analyzer invocation</label>
<div class="spoiler">clang -cc1 -cc1 -triple x86_64-unknown-linux-gnu -analyze -disable-free -main-file-name memline.c -analyzer-store=region -analyzer-opt-analyze-nested-blocks -analyzer-checker=core -analyzer-checker=apiModeling -analyzer-checker=unix -analyzer-checker=deadcode -analyzer-checker=security.insecureAPI.UncheckedReturn -analyzer-checker=security.insecureAPI.getpw -analyzer-checker=security.insecureAPI.gets -analyzer-checker=security.insecureAPI.mktemp -analyzer-checker=security.insecureAPI.mkstemp -analyzer-checker=security.insecureAPI.vfork -analyzer-checker=nullability.NullPassedToNonnull -analyzer-checker=nullability.NullReturnedFromNonnull -analyzer-output plist -w -setup-static-analyzer -mrelocation-model static -mframe-pointer=none -fmath-errno -fno-rounding-math -mconstructor-aliases -munwind-tables -target-cpu x86-64 -fno-split-dwarf-inlining -debugger-tuning=gdb -resource-dir /llvm-project/build/lib/clang/12.0.0 -I . -I proto -D HAVE_CONFIG_H -U _FORTIFY_SOURCE -D _FORTIFY_SOURCE=1 -internal-isystem /usr/local/include -internal-isystem /llvm-project/build/lib/clang/12.0.0/include -internal-externc-isystem /usr/include/x86_64-linux-gnu -internal-externc-isystem /include -internal-externc-isystem /usr/include -O2 -fdebug-compilation-dir /tmp/sslab_clang/c_vim/vim/src -ferror-limit 19 -fgnuc-version=4.2.1 -vectorize-loops -vectorize-slp -analyzer-checker core -analyzer-checker cplusplus -analyzer-checker nullability -analyzer-checker optin -analyzer-checker security -analyzer-checker unix -analyzer-checker osx -analyzer-checker fuchsia -analyzer-checker webkit -analyzer-output=html -faddrsig -o /tmp/scan-build-2020-11-24-134443-313-1 -x c memline.c
</div>
<div id='tooltiphint' hidden="true">
  <p>Keyboard shortcuts: </p>
  <ul>
    <li>Use 'j/k' keys for keyboard navigation</li>
    <li>Use 'Shift+S' to show/hide relevant lines</li>
    <li>Use '?' to toggle this window</li>
  </ul>
  <a href="#" onclick="toggleHelp(); return false;">Close</a>
</div>
<script type='text/javascript'>
var relevant_lines = {"1": {"2030": 1}};

var filterCounterexample = function (hide) {
  var tables = document.getElementsByClassName("code");
  for (var t=0; t<tables.length; t++) {
    var table = tables[t];
    var file_id = table.getAttribute("data-fileid");
    var lines_in_fid = relevant_lines[file_id];
    if (!lines_in_fid) {
      lines_in_fid = {};
    }
    var lines = table.getElementsByClassName("codeline");
    for (var i=0; i<lines.length; i++) {
        var el = lines[i];
        var lineNo = el.getAttribute("data-linenumber");
        if (!lines_in_fid[lineNo]) {
          if (hide) {
            el.setAttribute("hidden", "");
          } else {
            el.removeAttribute("hidden");
          }
        }
    }
  }
}

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "S") {
    var checked = document.getElementsByName("showCounterexample")[0].checked;
    filterCounterexample(!checked);
    document.getElementsByName("showCounterexample")[0].checked = !checked;
  } else {
    return;
  }
  event.preventDefault();
}, true);

document.addEventListener("DOMContentLoaded", function() {
    document.querySelector('input[name="showCounterexample"]').onchange=
        function (event) {
      filterCounterexample(this.checked);
    };
});
</script>

<form>
    <input type="checkbox" name="showCounterexample" id="showCounterexample" />
    <label for="showCounterexample">
       Show only relevant lines
    </label>
</form>

<script type='text/javascript'>
var digitMatcher = new RegExp("[0-9]+");

var querySelectorAllArray = function(selector) {
  return Array.prototype.slice.call(
    document.querySelectorAll(selector));
}

document.addEventListener("DOMContentLoaded", function() {
    querySelectorAllArray(".PathNav > a").forEach(
        function(currentValue, currentIndex) {
            var hrefValue = currentValue.getAttribute("href");
            currentValue.onclick = function() {
                scrollTo(document.querySelector(hrefValue));
                return false;
            };
        });
});

var findNum = function() {
    var s = document.querySelector(".selected");
    if (!s || s.id == "EndPath") {
        return 0;
    }
    var out = parseInt(digitMatcher.exec(s.id)[0]);
    return out;
};

var scrollTo = function(el) {
    querySelectorAllArray(".selected").forEach(function(s) {
        s.classList.remove("selected");
    });
    el.classList.add("selected");
    window.scrollBy(0, el.getBoundingClientRect().top -
        (window.innerHeight / 2));
}

var move = function(num, up, numItems) {
  if (num == 1 && up || num == numItems - 1 && !up) {
    return 0;
  } else if (num == 0 && up) {
    return numItems - 1;
  } else if (num == 0 && !up) {
    return 1 % numItems;
  }
  return up ? num - 1 : num + 1;
}

var numToId = function(num) {
  if (num == 0) {
    return document.getElementById("EndPath")
  }
  return document.getElementById("Path" + num);
};

var navigateTo = function(up) {
  var numItems = document.querySelectorAll(
      ".line > .msgEvent, .line > .msgControl").length;
  var currentSelected = findNum();
  var newSelected = move(currentSelected, up, numItems);
  var newEl = numToId(newSelected, numItems);

  // Scroll element into center.
  scrollTo(newEl);
};

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "j") {
    navigateTo(/*up=*/false);
  } else if (event.key == "k") {
    navigateTo(/*up=*/true);
  } else {
    return;
  }
  event.preventDefault();
}, true);
</script>
  
<script type='text/javascript'>

var toggleHelp = function() {
    var hint = document.querySelector("#tooltiphint");
    var attributeName = "hidden";
    if (hint.hasAttribute(attributeName)) {
      hint.removeAttribute(attributeName);
    } else {
      hint.setAttribute("hidden", "true");
    }
};
window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "?") {
    toggleHelp();
  } else {
    return;
  }
  event.preventDefault();
});
</script>
<table class="code" data-fileid="1">
<tr class="codeline" data-linenumber="1"><td class="num" id="LN1">1</td><td class="line"><span class='comment'>/* vi:set ts=8 sts=4 sw=4 noet:</span></td></tr>
<tr class="codeline" data-linenumber="2"><td class="num" id="LN2">2</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3"><td class="num" id="LN3">3</td><td class="line"> <span class='comment'>* VIM - Vi IMproved	by Bram Moolenaar</span></td></tr>
<tr class="codeline" data-linenumber="4"><td class="num" id="LN4">4</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="5"><td class="num" id="LN5">5</td><td class="line"> <span class='comment'>* Do ":help uganda"  in Vim to read copying and usage conditions.</span></td></tr>
<tr class="codeline" data-linenumber="6"><td class="num" id="LN6">6</td><td class="line"> <span class='comment'>* Do ":help credits" in Vim to see a list of people who contributed.</span></td></tr>
<tr class="codeline" data-linenumber="7"><td class="num" id="LN7">7</td><td class="line"> <span class='comment'>* See README.txt for an overview of the Vim source code.</span></td></tr>
<tr class="codeline" data-linenumber="8"><td class="num" id="LN8">8</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="9"><td class="num" id="LN9">9</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="10"><td class="num" id="LN10">10</td><td class="line"><span class='comment'>// for debugging</span></td></tr>
<tr class="codeline" data-linenumber="11"><td class="num" id="LN11">11</td><td class="line"><span class='comment'>// #define CHECK(c, s)	do { if (c) emsg((s)); } while (0)</span></td></tr>
<tr class="codeline" data-linenumber="12"><td class="num" id="LN12">12</td><td class="line"><span class='directive'>#define <span class='macro'>CHECK(c, s)<span class='macro_popup'>do { } while (0)</span></span>	do { /**/ } while (0)</span></td></tr>
<tr class="codeline" data-linenumber="13"><td class="num" id="LN13">13</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="14"><td class="num" id="LN14">14</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="15"><td class="num" id="LN15">15</td><td class="line"> <span class='comment'>* memline.c: Contains the functions for appending, deleting and changing the</span></td></tr>
<tr class="codeline" data-linenumber="16"><td class="num" id="LN16">16</td><td class="line"> <span class='comment'>* text lines. The memfile functions are used to store the information in</span></td></tr>
<tr class="codeline" data-linenumber="17"><td class="num" id="LN17">17</td><td class="line"> <span class='comment'>* blocks of memory, backed up by a file. The structure of the information is</span></td></tr>
<tr class="codeline" data-linenumber="18"><td class="num" id="LN18">18</td><td class="line"> <span class='comment'>* a tree.  The root of the tree is a pointer block. The leaves of the tree</span></td></tr>
<tr class="codeline" data-linenumber="19"><td class="num" id="LN19">19</td><td class="line"> <span class='comment'>* are data blocks. In between may be several layers of pointer blocks,</span></td></tr>
<tr class="codeline" data-linenumber="20"><td class="num" id="LN20">20</td><td class="line"> <span class='comment'>* forming branches.</span></td></tr>
<tr class="codeline" data-linenumber="21"><td class="num" id="LN21">21</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="22"><td class="num" id="LN22">22</td><td class="line"> <span class='comment'>* Three types of blocks are used:</span></td></tr>
<tr class="codeline" data-linenumber="23"><td class="num" id="LN23">23</td><td class="line"> <span class='comment'>* - Block nr 0 contains information for recovery</span></td></tr>
<tr class="codeline" data-linenumber="24"><td class="num" id="LN24">24</td><td class="line"> <span class='comment'>* - Pointer blocks contain list of pointers to other blocks.</span></td></tr>
<tr class="codeline" data-linenumber="25"><td class="num" id="LN25">25</td><td class="line"> <span class='comment'>* - Data blocks contain the actual text.</span></td></tr>
<tr class="codeline" data-linenumber="26"><td class="num" id="LN26">26</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="27"><td class="num" id="LN27">27</td><td class="line"> <span class='comment'>* Block nr 0 contains the block0 structure (see below).</span></td></tr>
<tr class="codeline" data-linenumber="28"><td class="num" id="LN28">28</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="29"><td class="num" id="LN29">29</td><td class="line"> <span class='comment'>* Block nr 1 is the first pointer block. It is the root of the tree.</span></td></tr>
<tr class="codeline" data-linenumber="30"><td class="num" id="LN30">30</td><td class="line"> <span class='comment'>* Other pointer blocks are branches.</span></td></tr>
<tr class="codeline" data-linenumber="31"><td class="num" id="LN31">31</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="32"><td class="num" id="LN32">32</td><td class="line"> <span class='comment'>*  If a line is too big to fit in a single page, the block containing that</span></td></tr>
<tr class="codeline" data-linenumber="33"><td class="num" id="LN33">33</td><td class="line"> <span class='comment'>*  line is made big enough to hold the line. It may span several pages.</span></td></tr>
<tr class="codeline" data-linenumber="34"><td class="num" id="LN34">34</td><td class="line"> <span class='comment'>*  Otherwise all blocks are one page.</span></td></tr>
<tr class="codeline" data-linenumber="35"><td class="num" id="LN35">35</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="36"><td class="num" id="LN36">36</td><td class="line"> <span class='comment'>*  A data block that was filled when starting to edit a file and was not</span></td></tr>
<tr class="codeline" data-linenumber="37"><td class="num" id="LN37">37</td><td class="line"> <span class='comment'>*  changed since then, can have a negative block number. This means that it</span></td></tr>
<tr class="codeline" data-linenumber="38"><td class="num" id="LN38">38</td><td class="line"> <span class='comment'>*  has not yet been assigned a place in the file. When recovering, the lines</span></td></tr>
<tr class="codeline" data-linenumber="39"><td class="num" id="LN39">39</td><td class="line"> <span class='comment'>*  in this data block can be read from the original file. When the block is</span></td></tr>
<tr class="codeline" data-linenumber="40"><td class="num" id="LN40">40</td><td class="line"> <span class='comment'>*  changed (lines appended/deleted/changed) or when it is flushed it gets a</span></td></tr>
<tr class="codeline" data-linenumber="41"><td class="num" id="LN41">41</td><td class="line"> <span class='comment'>*  positive number. Use mf_trans_del() to get the new number, before calling</span></td></tr>
<tr class="codeline" data-linenumber="42"><td class="num" id="LN42">42</td><td class="line"> <span class='comment'>*  mf_get().</span></td></tr>
<tr class="codeline" data-linenumber="43"><td class="num" id="LN43">43</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="44"><td class="num" id="LN44">44</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="45"><td class="num" id="LN45">45</td><td class="line"><span class='directive'>#include "vim.h"</span></td></tr>
<tr class="codeline" data-linenumber="46"><td class="num" id="LN46">46</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="47"><td class="num" id="LN47">47</td><td class="line"><span class='directive'>#ifndef <span class='macro'>UNIX<span class='macro_popup'>1</span></span>		// it's in os_unix.h for Unix</span></td></tr>
<tr class="codeline" data-linenumber="48"><td class="num" id="LN48">48</td><td class="line"><span class='directive'># include &lt;time.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="49"><td class="num" id="LN49">49</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="50"><td class="num" id="LN50">50</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="51"><td class="num" id="LN51">51</td><td class="line"><span class='directive'>#if defined(SASC) || defined(__amigaos4__)</span></td></tr>
<tr class="codeline" data-linenumber="52"><td class="num" id="LN52">52</td><td class="line"><span class='directive'># include &lt;proto/dos.h&gt;	    // for Open() and Close()</span></td></tr>
<tr class="codeline" data-linenumber="53"><td class="num" id="LN53">53</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="54"><td class="num" id="LN54">54</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="55"><td class="num" id="LN55">55</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> block0		ZERO_BL;    <span class='comment'>// contents of the first block</span></td></tr>
<tr class="codeline" data-linenumber="56"><td class="num" id="LN56">56</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> pointer_block	PTR_BL;	    <span class='comment'>// contents of a pointer block</span></td></tr>
<tr class="codeline" data-linenumber="57"><td class="num" id="LN57">57</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> data_block	DATA_BL;    <span class='comment'>// contents of a data block</span></td></tr>
<tr class="codeline" data-linenumber="58"><td class="num" id="LN58">58</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> pointer_entry	PTR_EN;	    <span class='comment'>// block/line-count pair</span></td></tr>
<tr class="codeline" data-linenumber="59"><td class="num" id="LN59">59</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="60"><td class="num" id="LN60">60</td><td class="line"><span class='directive'>#define <span class='macro'>DATA_ID<span class='macro_popup'>(('d' &lt;&lt; 8) + 'a')</span></span>	       (('d' &lt;&lt; 8) + 'a')   // data block id</span></td></tr>
<tr class="codeline" data-linenumber="61"><td class="num" id="LN61">61</td><td class="line"><span class='directive'>#define <span class='macro'>PTR_ID<span class='macro_popup'>(('p' &lt;&lt; 8) + 't')</span></span>	       (('p' &lt;&lt; 8) + 't')   // pointer block id</span></td></tr>
<tr class="codeline" data-linenumber="62"><td class="num" id="LN62">62</td><td class="line"><span class='directive'>#define <span class='macro'>BLOCK0_ID0<span class='macro_popup'>'b'</span></span>     'b'		    // block 0 id 0</span></td></tr>
<tr class="codeline" data-linenumber="63"><td class="num" id="LN63">63</td><td class="line"><span class='directive'>#define <span class='macro'>BLOCK0_ID1<span class='macro_popup'>'0'</span></span>     '0'		    // block 0 id 1</span></td></tr>
<tr class="codeline" data-linenumber="64"><td class="num" id="LN64">64</td><td class="line"><span class='directive'>#define <span class='macro'>BLOCK0_ID1_C0<span class='macro_popup'>'c'</span></span>  'c'		    // block 0 id 1 'cm' 0</span></td></tr>
<tr class="codeline" data-linenumber="65"><td class="num" id="LN65">65</td><td class="line"><span class='directive'>#define <span class='macro'>BLOCK0_ID1_C1<span class='macro_popup'>'C'</span></span>  'C'		    // block 0 id 1 'cm' 1</span></td></tr>
<tr class="codeline" data-linenumber="66"><td class="num" id="LN66">66</td><td class="line"><span class='directive'>#define <span class='macro'>BLOCK0_ID1_C2<span class='macro_popup'>'d'</span></span>  'd'		    // block 0 id 1 'cm' 2</span></td></tr>
<tr class="codeline" data-linenumber="67"><td class="num" id="LN67">67</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="68"><td class="num" id="LN68">68</td><td class="line"><span class='directive'>#if defined(FEAT_CRYPT)</span></td></tr>
<tr class="codeline" data-linenumber="69"><td class="num" id="LN69">69</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> id1_codes[] = {</td></tr>
<tr class="codeline" data-linenumber="70"><td class="num" id="LN70">70</td><td class="line">    <span class='macro'>BLOCK0_ID1_C0<span class='macro_popup'>'c'</span></span>,  <span class='comment'>// CRYPT_M_ZIP</span></td></tr>
<tr class="codeline" data-linenumber="71"><td class="num" id="LN71">71</td><td class="line">    <span class='macro'>BLOCK0_ID1_C1<span class='macro_popup'>'C'</span></span>,  <span class='comment'>// CRYPT_M_BF</span></td></tr>
<tr class="codeline" data-linenumber="72"><td class="num" id="LN72">72</td><td class="line">    <span class='macro'>BLOCK0_ID1_C2<span class='macro_popup'>'d'</span></span>,  <span class='comment'>// CRYPT_M_BF2</span></td></tr>
<tr class="codeline" data-linenumber="73"><td class="num" id="LN73">73</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="74"><td class="num" id="LN74">74</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="75"><td class="num" id="LN75">75</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="76"><td class="num" id="LN76">76</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="77"><td class="num" id="LN77">77</td><td class="line"> <span class='comment'>* pointer to a block, used in a pointer block</span></td></tr>
<tr class="codeline" data-linenumber="78"><td class="num" id="LN78">78</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="79"><td class="num" id="LN79">79</td><td class="line"><span class='keyword'>struct</span> pointer_entry</td></tr>
<tr class="codeline" data-linenumber="80"><td class="num" id="LN80">80</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="81"><td class="num" id="LN81">81</td><td class="line">    blocknr_T	pe_bnum;	<span class='comment'>// block number</span></td></tr>
<tr class="codeline" data-linenumber="82"><td class="num" id="LN82">82</td><td class="line">    linenr_T	pe_line_count;	<span class='comment'>// number of lines in this branch</span></td></tr>
<tr class="codeline" data-linenumber="83"><td class="num" id="LN83">83</td><td class="line">    linenr_T	pe_old_lnum;	<span class='comment'>// lnum for this block (for recovery)</span></td></tr>
<tr class="codeline" data-linenumber="84"><td class="num" id="LN84">84</td><td class="line">    <span class='keyword'>int</span>		pe_page_count;	<span class='comment'>// number of pages in block pe_bnum</span></td></tr>
<tr class="codeline" data-linenumber="85"><td class="num" id="LN85">85</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="86"><td class="num" id="LN86">86</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="87"><td class="num" id="LN87">87</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="88"><td class="num" id="LN88">88</td><td class="line"> <span class='comment'>* A pointer block contains a list of branches in the tree.</span></td></tr>
<tr class="codeline" data-linenumber="89"><td class="num" id="LN89">89</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="90"><td class="num" id="LN90">90</td><td class="line"><span class='keyword'>struct</span> pointer_block</td></tr>
<tr class="codeline" data-linenumber="91"><td class="num" id="LN91">91</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="92"><td class="num" id="LN92">92</td><td class="line">    short_u	pb_id;		<span class='comment'>// ID for pointer block: PTR_ID</span></td></tr>
<tr class="codeline" data-linenumber="93"><td class="num" id="LN93">93</td><td class="line">    short_u	pb_count;	<span class='comment'>// number of pointers in this block</span></td></tr>
<tr class="codeline" data-linenumber="94"><td class="num" id="LN94">94</td><td class="line">    short_u	pb_count_max;	<span class='comment'>// maximum value for pb_count</span></td></tr>
<tr class="codeline" data-linenumber="95"><td class="num" id="LN95">95</td><td class="line">    PTR_EN	pb_pointer[1];	<span class='comment'>// list of pointers to blocks (actually longer)</span></td></tr>
<tr class="codeline" data-linenumber="96"><td class="num" id="LN96">96</td><td class="line">				<span class='comment'>// followed by empty space until end of page</span></td></tr>
<tr class="codeline" data-linenumber="97"><td class="num" id="LN97">97</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="98"><td class="num" id="LN98">98</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="99"><td class="num" id="LN99">99</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="100"><td class="num" id="LN100">100</td><td class="line"> <span class='comment'>* A data block is a leaf in the tree.</span></td></tr>
<tr class="codeline" data-linenumber="101"><td class="num" id="LN101">101</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="102"><td class="num" id="LN102">102</td><td class="line"> <span class='comment'>* The text of the lines is at the end of the block. The text of the first line</span></td></tr>
<tr class="codeline" data-linenumber="103"><td class="num" id="LN103">103</td><td class="line"> <span class='comment'>* in the block is put at the end, the text of the second line in front of it,</span></td></tr>
<tr class="codeline" data-linenumber="104"><td class="num" id="LN104">104</td><td class="line"> <span class='comment'>* etc. Thus the order of the lines is the opposite of the line number.</span></td></tr>
<tr class="codeline" data-linenumber="105"><td class="num" id="LN105">105</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="106"><td class="num" id="LN106">106</td><td class="line"><span class='keyword'>struct</span> data_block</td></tr>
<tr class="codeline" data-linenumber="107"><td class="num" id="LN107">107</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="108"><td class="num" id="LN108">108</td><td class="line">    short_u	db_id;		<span class='comment'>// ID for data block: DATA_ID</span></td></tr>
<tr class="codeline" data-linenumber="109"><td class="num" id="LN109">109</td><td class="line">    <span class='keyword'>unsigned</span>	db_free;	<span class='comment'>// free space available</span></td></tr>
<tr class="codeline" data-linenumber="110"><td class="num" id="LN110">110</td><td class="line">    <span class='keyword'>unsigned</span>	db_txt_start;	<span class='comment'>// byte where text starts</span></td></tr>
<tr class="codeline" data-linenumber="111"><td class="num" id="LN111">111</td><td class="line">    <span class='keyword'>unsigned</span>	db_txt_end;	<span class='comment'>// byte just after data block</span></td></tr>
<tr class="codeline" data-linenumber="112"><td class="num" id="LN112">112</td><td class="line">    linenr_T	db_line_count;	<span class='comment'>// number of lines in this block</span></td></tr>
<tr class="codeline" data-linenumber="113"><td class="num" id="LN113">113</td><td class="line">    <span class='keyword'>unsigned</span>	db_index[1];	<span class='comment'>// index for start of line (actually bigger)</span></td></tr>
<tr class="codeline" data-linenumber="114"><td class="num" id="LN114">114</td><td class="line">				<span class='comment'>// followed by empty space up to db_txt_start</span></td></tr>
<tr class="codeline" data-linenumber="115"><td class="num" id="LN115">115</td><td class="line">				<span class='comment'>// followed by the text in the lines until</span></td></tr>
<tr class="codeline" data-linenumber="116"><td class="num" id="LN116">116</td><td class="line">				<span class='comment'>// end of page</span></td></tr>
<tr class="codeline" data-linenumber="117"><td class="num" id="LN117">117</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="118"><td class="num" id="LN118">118</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="119"><td class="num" id="LN119">119</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="120"><td class="num" id="LN120">120</td><td class="line"> <span class='comment'>* The low bits of db_index hold the actual index. The topmost bit is</span></td></tr>
<tr class="codeline" data-linenumber="121"><td class="num" id="LN121">121</td><td class="line"> <span class='comment'>* used for the global command to be able to mark a line.</span></td></tr>
<tr class="codeline" data-linenumber="122"><td class="num" id="LN122">122</td><td class="line"> <span class='comment'>* This method is not clean, but otherwise there would be at least one extra</span></td></tr>
<tr class="codeline" data-linenumber="123"><td class="num" id="LN123">123</td><td class="line"> <span class='comment'>* byte used for each line.</span></td></tr>
<tr class="codeline" data-linenumber="124"><td class="num" id="LN124">124</td><td class="line"> <span class='comment'>* The mark has to be in this place to keep it with the correct line when other</span></td></tr>
<tr class="codeline" data-linenumber="125"><td class="num" id="LN125">125</td><td class="line"> <span class='comment'>* lines are inserted or deleted.</span></td></tr>
<tr class="codeline" data-linenumber="126"><td class="num" id="LN126">126</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="127"><td class="num" id="LN127">127</td><td class="line"><span class='directive'>#define <span class='macro'>DB_MARKED<span class='macro_popup'>((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1))</span></span>	((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1))</span></td></tr>
<tr class="codeline" data-linenumber="128"><td class="num" id="LN128">128</td><td class="line"><span class='directive'>#define <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>	(~<span class='macro'>DB_MARKED<span class='macro_popup'>((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="129"><td class="num" id="LN129">129</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="130"><td class="num" id="LN130">130</td><td class="line"><span class='directive'>#define <span class='macro'>INDEX_SIZE<span class='macro_popup'>(sizeof(unsigned))</span></span>  (sizeof(unsigned))	    // size of one db_index entry</span></td></tr>
<tr class="codeline" data-linenumber="131"><td class="num" id="LN131">131</td><td class="line"><span class='directive'>#define <span class='macro'>HEADER_SIZE<span class='macro_popup'>(sizeof(DATA_BL) - (sizeof(unsigned)))</span></span> (sizeof(DATA_BL) - <span class='macro'>INDEX_SIZE<span class='macro_popup'>(sizeof(unsigned))</span></span>)  // size of data block header</span></td></tr>
<tr class="codeline" data-linenumber="132"><td class="num" id="LN132">132</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="133"><td class="num" id="LN133">133</td><td class="line"><span class='directive'>#define <span class='macro'>B0_FNAME_SIZE_ORG<span class='macro_popup'>900</span></span>	900	// what it was in older versions</span></td></tr>
<tr class="codeline" data-linenumber="134"><td class="num" id="LN134">134</td><td class="line"><span class='directive'>#define <span class='macro'>B0_FNAME_SIZE_NOCRYPT<span class='macro_popup'>898</span></span>	898	// 2 bytes used for other things</span></td></tr>
<tr class="codeline" data-linenumber="135"><td class="num" id="LN135">135</td><td class="line"><span class='directive'>#define <span class='macro'>B0_FNAME_SIZE_CRYPT<span class='macro_popup'>890</span></span>	890	// 10 bytes used for other things</span></td></tr>
<tr class="codeline" data-linenumber="136"><td class="num" id="LN136">136</td><td class="line"><span class='directive'>#define <span class='macro'>B0_UNAME_SIZE<span class='macro_popup'>40</span></span>		40</span></td></tr>
<tr class="codeline" data-linenumber="137"><td class="num" id="LN137">137</td><td class="line"><span class='directive'>#define <span class='macro'>B0_HNAME_SIZE<span class='macro_popup'>40</span></span>		40</span></td></tr>
<tr class="codeline" data-linenumber="138"><td class="num" id="LN138">138</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="139"><td class="num" id="LN139">139</td><td class="line"> <span class='comment'>* Restrict the numbers to 32 bits, otherwise most compilers will complain.</span></td></tr>
<tr class="codeline" data-linenumber="140"><td class="num" id="LN140">140</td><td class="line"> <span class='comment'>* This won't detect a 64 bit machine that only swaps a byte in the top 32</span></td></tr>
<tr class="codeline" data-linenumber="141"><td class="num" id="LN141">141</td><td class="line"> <span class='comment'>* bits, but that is crazy anyway.</span></td></tr>
<tr class="codeline" data-linenumber="142"><td class="num" id="LN142">142</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="143"><td class="num" id="LN143">143</td><td class="line"><span class='directive'>#define <span class='macro'>B0_MAGIC_LONG<span class='macro_popup'>0x30313233L</span></span>	0x30313233L</span></td></tr>
<tr class="codeline" data-linenumber="144"><td class="num" id="LN144">144</td><td class="line"><span class='directive'>#define <span class='macro'>B0_MAGIC_INT<span class='macro_popup'>0x20212223L</span></span>	0x20212223L</span></td></tr>
<tr class="codeline" data-linenumber="145"><td class="num" id="LN145">145</td><td class="line"><span class='directive'>#define <span class='macro'>B0_MAGIC_SHORT<span class='macro_popup'>0x10111213L</span></span>	0x10111213L</span></td></tr>
<tr class="codeline" data-linenumber="146"><td class="num" id="LN146">146</td><td class="line"><span class='directive'>#define <span class='macro'>B0_MAGIC_CHAR<span class='macro_popup'>0x55</span></span>	0x55</span></td></tr>
<tr class="codeline" data-linenumber="147"><td class="num" id="LN147">147</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="148"><td class="num" id="LN148">148</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="149"><td class="num" id="LN149">149</td><td class="line"> <span class='comment'>* Block zero holds all info about the swap file.</span></td></tr>
<tr class="codeline" data-linenumber="150"><td class="num" id="LN150">150</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="151"><td class="num" id="LN151">151</td><td class="line"> <span class='comment'>* NOTE: DEFINITION OF BLOCK 0 SHOULD NOT CHANGE! It would make all existing</span></td></tr>
<tr class="codeline" data-linenumber="152"><td class="num" id="LN152">152</td><td class="line"> <span class='comment'>* swap files unusable!</span></td></tr>
<tr class="codeline" data-linenumber="153"><td class="num" id="LN153">153</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="154"><td class="num" id="LN154">154</td><td class="line"> <span class='comment'>* If size of block0 changes anyway, adjust MIN_SWAP_PAGE_SIZE in vim.h!!</span></td></tr>
<tr class="codeline" data-linenumber="155"><td class="num" id="LN155">155</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="156"><td class="num" id="LN156">156</td><td class="line"> <span class='comment'>* This block is built up of single bytes, to make it portable across</span></td></tr>
<tr class="codeline" data-linenumber="157"><td class="num" id="LN157">157</td><td class="line"> <span class='comment'>* different machines. b0_magic_* is used to check the byte order and size of</span></td></tr>
<tr class="codeline" data-linenumber="158"><td class="num" id="LN158">158</td><td class="line"> <span class='comment'>* variables, because the rest of the swap file is not portable.</span></td></tr>
<tr class="codeline" data-linenumber="159"><td class="num" id="LN159">159</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="160"><td class="num" id="LN160">160</td><td class="line"><span class='keyword'>struct</span> block0</td></tr>
<tr class="codeline" data-linenumber="161"><td class="num" id="LN161">161</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="162"><td class="num" id="LN162">162</td><td class="line">    char_u	b0_id[2];	<span class='comment'>// id for block 0: BLOCK0_ID0 and BLOCK0_ID1,</span></td></tr>
<tr class="codeline" data-linenumber="163"><td class="num" id="LN163">163</td><td class="line">				<span class='comment'>// BLOCK0_ID1_C0, BLOCK0_ID1_C1, etc.</span></td></tr>
<tr class="codeline" data-linenumber="164"><td class="num" id="LN164">164</td><td class="line">    char_u	b0_version[10];	<span class='comment'>// Vim version string</span></td></tr>
<tr class="codeline" data-linenumber="165"><td class="num" id="LN165">165</td><td class="line">    char_u	b0_page_size[4];<span class='comment'>// number of bytes per page</span></td></tr>
<tr class="codeline" data-linenumber="166"><td class="num" id="LN166">166</td><td class="line">    char_u	b0_mtime[4];	<span class='comment'>// last modification time of file</span></td></tr>
<tr class="codeline" data-linenumber="167"><td class="num" id="LN167">167</td><td class="line">    char_u	b0_ino[4];	<span class='comment'>// inode of b0_fname</span></td></tr>
<tr class="codeline" data-linenumber="168"><td class="num" id="LN168">168</td><td class="line">    char_u	b0_pid[4];	<span class='comment'>// process id of creator (or 0)</span></td></tr>
<tr class="codeline" data-linenumber="169"><td class="num" id="LN169">169</td><td class="line">    char_u	b0_uname[<span class='macro'>B0_UNAME_SIZE<span class='macro_popup'>40</span></span>]; <span class='comment'>// name of user (uid if no name)</span></td></tr>
<tr class="codeline" data-linenumber="170"><td class="num" id="LN170">170</td><td class="line">    char_u	b0_hname[<span class='macro'>B0_HNAME_SIZE<span class='macro_popup'>40</span></span>]; <span class='comment'>// host name (if it has a name)</span></td></tr>
<tr class="codeline" data-linenumber="171"><td class="num" id="LN171">171</td><td class="line">    char_u	b0_fname[<span class='macro'>B0_FNAME_SIZE_ORG<span class='macro_popup'>900</span></span>]; <span class='comment'>// name of file being edited</span></td></tr>
<tr class="codeline" data-linenumber="172"><td class="num" id="LN172">172</td><td class="line">    <span class='keyword'>long</span>	b0_magic_long;	<span class='comment'>// check for byte order of long</span></td></tr>
<tr class="codeline" data-linenumber="173"><td class="num" id="LN173">173</td><td class="line">    <span class='keyword'>int</span>		b0_magic_int;	<span class='comment'>// check for byte order of int</span></td></tr>
<tr class="codeline" data-linenumber="174"><td class="num" id="LN174">174</td><td class="line">    <span class='keyword'>short</span>	b0_magic_short;	<span class='comment'>// check for byte order of short</span></td></tr>
<tr class="codeline" data-linenumber="175"><td class="num" id="LN175">175</td><td class="line">    char_u	b0_magic_char;	<span class='comment'>// check for last char</span></td></tr>
<tr class="codeline" data-linenumber="176"><td class="num" id="LN176">176</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="177"><td class="num" id="LN177">177</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="178"><td class="num" id="LN178">178</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="179"><td class="num" id="LN179">179</td><td class="line"> <span class='comment'>* Note: b0_dirty and b0_flags are put at the end of the file name.  For very</span></td></tr>
<tr class="codeline" data-linenumber="180"><td class="num" id="LN180">180</td><td class="line"> <span class='comment'>* long file names in older versions of Vim they are invalid.</span></td></tr>
<tr class="codeline" data-linenumber="181"><td class="num" id="LN181">181</td><td class="line"> <span class='comment'>* The 'fileencoding' comes before b0_flags, with a NUL in front.  But only</span></td></tr>
<tr class="codeline" data-linenumber="182"><td class="num" id="LN182">182</td><td class="line"> <span class='comment'>* when there is room, for very long file names it's omitted.</span></td></tr>
<tr class="codeline" data-linenumber="183"><td class="num" id="LN183">183</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="184"><td class="num" id="LN184">184</td><td class="line"><span class='directive'>#define <span class='macro'>B0_DIRTY<span class='macro_popup'>0x55</span></span>	0x55</span></td></tr>
<tr class="codeline" data-linenumber="185"><td class="num" id="LN185">185</td><td class="line"><span class='directive'>#define <span class='macro'>b0_dirty<span class='macro_popup'>b0_fname[900 - 1]</span></span>	b0_fname[<span class='macro'>B0_FNAME_SIZE_ORG<span class='macro_popup'>900</span></span> - 1]</span></td></tr>
<tr class="codeline" data-linenumber="186"><td class="num" id="LN186">186</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="187"><td class="num" id="LN187">187</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="188"><td class="num" id="LN188">188</td><td class="line"> <span class='comment'>* The b0_flags field is new in Vim 7.0.</span></td></tr>
<tr class="codeline" data-linenumber="189"><td class="num" id="LN189">189</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="190"><td class="num" id="LN190">190</td><td class="line"><span class='directive'>#define <span class='macro'>b0_flags<span class='macro_popup'>b0_fname[900 - 2]</span></span>	b0_fname[<span class='macro'>B0_FNAME_SIZE_ORG<span class='macro_popup'>900</span></span> - 2]</span></td></tr>
<tr class="codeline" data-linenumber="191"><td class="num" id="LN191">191</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="192"><td class="num" id="LN192">192</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="193"><td class="num" id="LN193">193</td><td class="line"> <span class='comment'>* Crypt seed goes here, 8 bytes.  New in Vim 7.3.</span></td></tr>
<tr class="codeline" data-linenumber="194"><td class="num" id="LN194">194</td><td class="line"> <span class='comment'>* Without encryption these bytes may be used for 'fenc'.</span></td></tr>
<tr class="codeline" data-linenumber="195"><td class="num" id="LN195">195</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="196"><td class="num" id="LN196">196</td><td class="line"><span class='directive'>#define <span class='macro'>b0_seed<span class='macro_popup'>b0_fname[900 - 2 - 8]</span></span>		b0_fname[<span class='macro'>B0_FNAME_SIZE_ORG<span class='macro_popup'>900</span></span> - 2 - <span class='macro'>MF_SEED_LEN<span class='macro_popup'>8</span></span>]</span></td></tr>
<tr class="codeline" data-linenumber="197"><td class="num" id="LN197">197</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="198"><td class="num" id="LN198">198</td><td class="line"><span class='comment'>// The lowest two bits contain the fileformat.  Zero means it's not set</span></td></tr>
<tr class="codeline" data-linenumber="199"><td class="num" id="LN199">199</td><td class="line"><span class='comment'>// (compatible with Vim 6.x), otherwise it's EOL_UNIX + 1, EOL_DOS + 1 or</span></td></tr>
<tr class="codeline" data-linenumber="200"><td class="num" id="LN200">200</td><td class="line"><span class='comment'>// EOL_MAC + 1.</span></td></tr>
<tr class="codeline" data-linenumber="201"><td class="num" id="LN201">201</td><td class="line"><span class='directive'>#define <span class='macro'>B0_FF_MASK<span class='macro_popup'>3</span></span>	3</span></td></tr>
<tr class="codeline" data-linenumber="202"><td class="num" id="LN202">202</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="203"><td class="num" id="LN203">203</td><td class="line"><span class='comment'>// Swap file is in directory of edited file.  Used to find the file from</span></td></tr>
<tr class="codeline" data-linenumber="204"><td class="num" id="LN204">204</td><td class="line"><span class='comment'>// different mount points.</span></td></tr>
<tr class="codeline" data-linenumber="205"><td class="num" id="LN205">205</td><td class="line"><span class='directive'>#define <span class='macro'>B0_SAME_DIR<span class='macro_popup'>4</span></span>	4</span></td></tr>
<tr class="codeline" data-linenumber="206"><td class="num" id="LN206">206</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="207"><td class="num" id="LN207">207</td><td class="line"><span class='comment'>// The 'fileencoding' is at the end of b0_fname[], with a NUL in front of it.</span></td></tr>
<tr class="codeline" data-linenumber="208"><td class="num" id="LN208">208</td><td class="line"><span class='comment'>// When empty there is only the NUL.</span></td></tr>
<tr class="codeline" data-linenumber="209"><td class="num" id="LN209">209</td><td class="line"><span class='directive'>#define <span class='macro'>B0_HAS_FENC<span class='macro_popup'>8</span></span>	8</span></td></tr>
<tr class="codeline" data-linenumber="210"><td class="num" id="LN210">210</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="211"><td class="num" id="LN211">211</td><td class="line"><span class='directive'>#define <span class='macro'>STACK_INCR<span class='macro_popup'>5</span></span>	5	// nr of entries added to ml_stack at a time</span></td></tr>
<tr class="codeline" data-linenumber="212"><td class="num" id="LN212">212</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="213"><td class="num" id="LN213">213</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="214"><td class="num" id="LN214">214</td><td class="line"> <span class='comment'>* The line number where the first mark may be is remembered.</span></td></tr>
<tr class="codeline" data-linenumber="215"><td class="num" id="LN215">215</td><td class="line"> <span class='comment'>* If it is 0 there are no marks at all.</span></td></tr>
<tr class="codeline" data-linenumber="216"><td class="num" id="LN216">216</td><td class="line"> <span class='comment'>* (always used for the current buffer only, no buffer change possible while</span></td></tr>
<tr class="codeline" data-linenumber="217"><td class="num" id="LN217">217</td><td class="line"> <span class='comment'>* executing a global command).</span></td></tr>
<tr class="codeline" data-linenumber="218"><td class="num" id="LN218">218</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="219"><td class="num" id="LN219">219</td><td class="line"><span class='keyword'>static</span> linenr_T	lowest_marked = 0;</td></tr>
<tr class="codeline" data-linenumber="220"><td class="num" id="LN220">220</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="221"><td class="num" id="LN221">221</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="222"><td class="num" id="LN222">222</td><td class="line"> <span class='comment'>* arguments for ml_find_line()</span></td></tr>
<tr class="codeline" data-linenumber="223"><td class="num" id="LN223">223</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="224"><td class="num" id="LN224">224</td><td class="line"><span class='directive'>#define <span class='macro'>ML_DELETE<span class='macro_popup'>0x11</span></span>	0x11	    // delete line</span></td></tr>
<tr class="codeline" data-linenumber="225"><td class="num" id="LN225">225</td><td class="line"><span class='directive'>#define <span class='macro'>ML_INSERT<span class='macro_popup'>0x12</span></span>	0x12	    // insert line</span></td></tr>
<tr class="codeline" data-linenumber="226"><td class="num" id="LN226">226</td><td class="line"><span class='directive'>#define <span class='macro'>ML_FIND<span class='macro_popup'>0x13</span></span>		0x13	    // just find the line</span></td></tr>
<tr class="codeline" data-linenumber="227"><td class="num" id="LN227">227</td><td class="line"><span class='directive'>#define <span class='macro'>ML_FLUSH<span class='macro_popup'>0x02</span></span>	0x02	    // flush locked block</span></td></tr>
<tr class="codeline" data-linenumber="228"><td class="num" id="LN228">228</td><td class="line"><span class='directive'>#define <span class='macro'>ML_SIMPLE(x)<span class='macro_popup'>(x &amp; 0x10)</span></span>	(x &amp; 0x10)  // DEL, INS or FIND</span></td></tr>
<tr class="codeline" data-linenumber="229"><td class="num" id="LN229">229</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="230"><td class="num" id="LN230">230</td><td class="line"><span class='comment'>// argument for ml_upd_block0()</span></td></tr>
<tr class="codeline" data-linenumber="231"><td class="num" id="LN231">231</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>enum</span> {</td></tr>
<tr class="codeline" data-linenumber="232"><td class="num" id="LN232">232</td><td class="line">      UB_FNAME = 0	<span class='comment'>// update timestamp and filename</span></td></tr>
<tr class="codeline" data-linenumber="233"><td class="num" id="LN233">233</td><td class="line">    , UB_SAME_DIR       <span class='comment'>// update the B0_SAME_DIR flag</span></td></tr>
<tr class="codeline" data-linenumber="234"><td class="num" id="LN234">234</td><td class="line">    , UB_CRYPT		<span class='comment'>// update crypt key</span></td></tr>
<tr class="codeline" data-linenumber="235"><td class="num" id="LN235">235</td><td class="line">} upd_block0_T;</td></tr>
<tr class="codeline" data-linenumber="236"><td class="num" id="LN236">236</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="237"><td class="num" id="LN237">237</td><td class="line"><span class='directive'>#ifdef FEAT_CRYPT</span></td></tr>
<tr class="codeline" data-linenumber="238"><td class="num" id="LN238">238</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> ml_set_b0_crypt(buf_T *buf, ZERO_BL *b0p);</td></tr>
<tr class="codeline" data-linenumber="239"><td class="num" id="LN239">239</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="240"><td class="num" id="LN240">240</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> ml_upd_block0(buf_T *buf, upd_block0_T what);</td></tr>
<tr class="codeline" data-linenumber="241"><td class="num" id="LN241">241</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> set_b0_fname(ZERO_BL *, buf_T *buf);</td></tr>
<tr class="codeline" data-linenumber="242"><td class="num" id="LN242">242</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> set_b0_dir_flag(ZERO_BL *b0p, buf_T *buf);</td></tr>
<tr class="codeline" data-linenumber="243"><td class="num" id="LN243">243</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> add_b0_fenc(ZERO_BL *b0p, buf_T *buf);</td></tr>
<tr class="codeline" data-linenumber="244"><td class="num" id="LN244">244</td><td class="line"><span class='keyword'>static</span> time_t swapfile_info(char_u *);</td></tr>
<tr class="codeline" data-linenumber="245"><td class="num" id="LN245">245</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> recov_file_names(char_u **, char_u *, <span class='keyword'>int</span> prepend_dot);</td></tr>
<tr class="codeline" data-linenumber="246"><td class="num" id="LN246">246</td><td class="line"><span class='keyword'>static</span> char_u *findswapname(buf_T *, char_u **, char_u *);</td></tr>
<tr class="codeline" data-linenumber="247"><td class="num" id="LN247">247</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> ml_flush_line(buf_T *);</td></tr>
<tr class="codeline" data-linenumber="248"><td class="num" id="LN248">248</td><td class="line"><span class='keyword'>static</span> bhdr_T *ml_new_data(memfile_T *, <span class='keyword'>int</span>, <span class='keyword'>int</span>);</td></tr>
<tr class="codeline" data-linenumber="249"><td class="num" id="LN249">249</td><td class="line"><span class='keyword'>static</span> bhdr_T *ml_new_ptr(memfile_T *);</td></tr>
<tr class="codeline" data-linenumber="250"><td class="num" id="LN250">250</td><td class="line"><span class='keyword'>static</span> bhdr_T *ml_find_line(buf_T *, linenr_T, <span class='keyword'>int</span>);</td></tr>
<tr class="codeline" data-linenumber="251"><td class="num" id="LN251">251</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> ml_add_stack(buf_T *);</td></tr>
<tr class="codeline" data-linenumber="252"><td class="num" id="LN252">252</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> ml_lineadd(buf_T *, <span class='keyword'>int</span>);</td></tr>
<tr class="codeline" data-linenumber="253"><td class="num" id="LN253">253</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> b0_magic_wrong(ZERO_BL *);</td></tr>
<tr class="codeline" data-linenumber="254"><td class="num" id="LN254">254</td><td class="line"><span class='directive'>#ifdef CHECK_INODE</span></td></tr>
<tr class="codeline" data-linenumber="255"><td class="num" id="LN255">255</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> fnamecmp_ino(char_u *, char_u *, <span class='keyword'>long</span>);</td></tr>
<tr class="codeline" data-linenumber="256"><td class="num" id="LN256">256</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="257"><td class="num" id="LN257">257</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> long_to_char(<span class='keyword'>long</span>, char_u *);</td></tr>
<tr class="codeline" data-linenumber="258"><td class="num" id="LN258">258</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>long</span> char_to_long(char_u *);</td></tr>
<tr class="codeline" data-linenumber="259"><td class="num" id="LN259">259</td><td class="line"><span class='directive'>#ifdef FEAT_CRYPT</span></td></tr>
<tr class="codeline" data-linenumber="260"><td class="num" id="LN260">260</td><td class="line"><span class='keyword'>static</span> cryptstate_T *ml_crypt_prepare(memfile_T *mfp, off_T offset, <span class='keyword'>int</span> reading);</td></tr>
<tr class="codeline" data-linenumber="261"><td class="num" id="LN261">261</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="262"><td class="num" id="LN262">262</td><td class="line"><span class='directive'>#ifdef FEAT_BYTEOFF</span></td></tr>
<tr class="codeline" data-linenumber="263"><td class="num" id="LN263">263</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> ml_updatechunk(buf_T *buf, <span class='keyword'>long</span> line, <span class='keyword'>long</span> len, <span class='keyword'>int</span> updtype);</td></tr>
<tr class="codeline" data-linenumber="264"><td class="num" id="LN264">264</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="265"><td class="num" id="LN265">265</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="266"><td class="num" id="LN266">266</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="267"><td class="num" id="LN267">267</td><td class="line"> <span class='comment'>* Open a new memline for "buf".</span></td></tr>
<tr class="codeline" data-linenumber="268"><td class="num" id="LN268">268</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="269"><td class="num" id="LN269">269</td><td class="line"> <span class='comment'>* Return FAIL for failure, OK otherwise.</span></td></tr>
<tr class="codeline" data-linenumber="270"><td class="num" id="LN270">270</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="271"><td class="num" id="LN271">271</td><td class="line">    <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="272"><td class="num" id="LN272">272</td><td class="line">ml_open(buf_T *buf)</td></tr>
<tr class="codeline" data-linenumber="273"><td class="num" id="LN273">273</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="274"><td class="num" id="LN274">274</td><td class="line">    memfile_T	*mfp;</td></tr>
<tr class="codeline" data-linenumber="275"><td class="num" id="LN275">275</td><td class="line">    bhdr_T	*hp = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="276"><td class="num" id="LN276">276</td><td class="line">    ZERO_BL	*b0p;</td></tr>
<tr class="codeline" data-linenumber="277"><td class="num" id="LN277">277</td><td class="line">    PTR_BL	*pp;</td></tr>
<tr class="codeline" data-linenumber="278"><td class="num" id="LN278">278</td><td class="line">    DATA_BL	*dp;</td></tr>
<tr class="codeline" data-linenumber="279"><td class="num" id="LN279">279</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="280"><td class="num" id="LN280">280</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="281"><td class="num" id="LN281">281</td><td class="line">     <span class='comment'>* init fields in memline struct</span></td></tr>
<tr class="codeline" data-linenumber="282"><td class="num" id="LN282">282</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="283"><td class="num" id="LN283">283</td><td class="line">    buf-&gt;b_ml.ml_stack_size = 0; <span class='comment'>// no stack yet</span></td></tr>
<tr class="codeline" data-linenumber="284"><td class="num" id="LN284">284</td><td class="line">    buf-&gt;b_ml.ml_stack = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;	<span class='comment'>// no stack yet</span></td></tr>
<tr class="codeline" data-linenumber="285"><td class="num" id="LN285">285</td><td class="line">    buf-&gt;b_ml.ml_stack_top = 0;	<span class='comment'>// nothing in the stack</span></td></tr>
<tr class="codeline" data-linenumber="286"><td class="num" id="LN286">286</td><td class="line">    buf-&gt;b_ml.ml_locked = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;	<span class='comment'>// no cached block</span></td></tr>
<tr class="codeline" data-linenumber="287"><td class="num" id="LN287">287</td><td class="line">    buf-&gt;b_ml.ml_line_lnum = 0;	<span class='comment'>// no cached line</span></td></tr>
<tr class="codeline" data-linenumber="288"><td class="num" id="LN288">288</td><td class="line"><span class='directive'>#ifdef FEAT_BYTEOFF</span></td></tr>
<tr class="codeline" data-linenumber="289"><td class="num" id="LN289">289</td><td class="line">    buf-&gt;b_ml.ml_chunksize = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="290"><td class="num" id="LN290">290</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="291"><td class="num" id="LN291">291</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="292"><td class="num" id="LN292">292</td><td class="line">    <span class='keyword'>if</span> (cmdmod.cmod_flags &amp; <span class='macro'>CMOD_NOSWAPFILE<span class='macro_popup'>0x2000</span></span>)</td></tr>
<tr class="codeline" data-linenumber="293"><td class="num" id="LN293">293</td><td class="line">	buf-&gt;b_p_swf = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="294"><td class="num" id="LN294">294</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="295"><td class="num" id="LN295">295</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="296"><td class="num" id="LN296">296</td><td class="line">     <span class='comment'>* When 'updatecount' is non-zero swap file may be opened later.</span></td></tr>
<tr class="codeline" data-linenumber="297"><td class="num" id="LN297">297</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="298"><td class="num" id="LN298">298</td><td class="line">    <span class='keyword'>if</span> (p_uc &amp;&amp; buf-&gt;b_p_swf)</td></tr>
<tr class="codeline" data-linenumber="299"><td class="num" id="LN299">299</td><td class="line">	buf-&gt;b_may_swap = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="300"><td class="num" id="LN300">300</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="301"><td class="num" id="LN301">301</td><td class="line">	buf-&gt;b_may_swap = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="302"><td class="num" id="LN302">302</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="303"><td class="num" id="LN303">303</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="304"><td class="num" id="LN304">304</td><td class="line">     <span class='comment'>* Open the memfile.  No swap file is created yet.</span></td></tr>
<tr class="codeline" data-linenumber="305"><td class="num" id="LN305">305</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="306"><td class="num" id="LN306">306</td><td class="line">    mfp = mf_open(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, 0);</td></tr>
<tr class="codeline" data-linenumber="307"><td class="num" id="LN307">307</td><td class="line">    <span class='keyword'>if</span> (mfp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="308"><td class="num" id="LN308">308</td><td class="line">	<span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="309"><td class="num" id="LN309">309</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="310"><td class="num" id="LN310">310</td><td class="line">    buf-&gt;b_ml.ml_mfp = mfp;</td></tr>
<tr class="codeline" data-linenumber="311"><td class="num" id="LN311">311</td><td class="line"><span class='directive'>#ifdef FEAT_CRYPT</span></td></tr>
<tr class="codeline" data-linenumber="312"><td class="num" id="LN312">312</td><td class="line">    mfp-&gt;mf_buffer = buf;</td></tr>
<tr class="codeline" data-linenumber="313"><td class="num" id="LN313">313</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="314"><td class="num" id="LN314">314</td><td class="line">    buf-&gt;b_ml.ml_flags = <span class='macro'>ML_EMPTY<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="315"><td class="num" id="LN315">315</td><td class="line">    buf-&gt;b_ml.ml_line_count = 1;</td></tr>
<tr class="codeline" data-linenumber="316"><td class="num" id="LN316">316</td><td class="line"><span class='directive'>#ifdef FEAT_LINEBREAK</span></td></tr>
<tr class="codeline" data-linenumber="317"><td class="num" id="LN317">317</td><td class="line">    curwin-&gt;w_nrwidth_line_count = 0;</td></tr>
<tr class="codeline" data-linenumber="318"><td class="num" id="LN318">318</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="319"><td class="num" id="LN319">319</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="320"><td class="num" id="LN320">320</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="321"><td class="num" id="LN321">321</td><td class="line"> <span class='comment'>* fill block0 struct and write page 0</span></td></tr>
<tr class="codeline" data-linenumber="322"><td class="num" id="LN322">322</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="323"><td class="num" id="LN323">323</td><td class="line">    <span class='keyword'>if</span> ((hp = mf_new(mfp, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>, 1)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="324"><td class="num" id="LN324">324</td><td class="line">	<span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="325"><td class="num" id="LN325">325</td><td class="line">    <span class='keyword'>if</span> (hp-&gt;<span class='macro'>bh_bnum<span class='macro_popup'>bh_hashitem.mhi_key</span></span> != 0)</td></tr>
<tr class="codeline" data-linenumber="326"><td class="num" id="LN326">326</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="327"><td class="num" id="LN327">327</td><td class="line">	iemsg(<span class='macro'>_(<span class='string_literal'>"E298: Didn't get block nr 0?"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E298: Didn't get block nr 0?"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="328"><td class="num" id="LN328">328</td><td class="line">	<span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="329"><td class="num" id="LN329">329</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="330"><td class="num" id="LN330">330</td><td class="line">    b0p = (ZERO_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="331"><td class="num" id="LN331">331</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="332"><td class="num" id="LN332">332</td><td class="line">    b0p-&gt;b0_id[0] = <span class='macro'>BLOCK0_ID0<span class='macro_popup'>'b'</span></span>;</td></tr>
<tr class="codeline" data-linenumber="333"><td class="num" id="LN333">333</td><td class="line">    b0p-&gt;b0_id[1] = <span class='macro'>BLOCK0_ID1<span class='macro_popup'>'0'</span></span>;</td></tr>
<tr class="codeline" data-linenumber="334"><td class="num" id="LN334">334</td><td class="line">    b0p-&gt;b0_magic_long = (<span class='keyword'>long</span>)<span class='macro'>B0_MAGIC_LONG<span class='macro_popup'>0x30313233L</span></span>;</td></tr>
<tr class="codeline" data-linenumber="335"><td class="num" id="LN335">335</td><td class="line">    b0p-&gt;b0_magic_int = (<span class='keyword'>int</span>)<span class='macro'>B0_MAGIC_INT<span class='macro_popup'>0x20212223L</span></span>;</td></tr>
<tr class="codeline" data-linenumber="336"><td class="num" id="LN336">336</td><td class="line">    b0p-&gt;b0_magic_short = (<span class='keyword'>short</span>)<span class='macro'>B0_MAGIC_SHORT<span class='macro_popup'>0x10111213L</span></span>;</td></tr>
<tr class="codeline" data-linenumber="337"><td class="num" id="LN337">337</td><td class="line">    b0p-&gt;b0_magic_char = <span class='macro'>B0_MAGIC_CHAR<span class='macro_popup'>0x55</span></span>;</td></tr>
<tr class="codeline" data-linenumber="338"><td class="num" id="LN338">338</td><td class="line">    <span class='macro'>mch_memmove(b0p-&gt;b0_version, <span class='string_literal'>"VIM "</span>, 4)<span class='macro_popup'>memmove((char *)(b0p-&gt;b0_version), (char *)("VIM "), 4)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="339"><td class="num" id="LN339">339</td><td class="line">    <span class='macro'>STRNCPY(b0p-&gt;b0_version + 4, Version, 6)<span class='macro_popup'>strncpy((char *)(b0p-&gt;b0_version + 4), (char *)(Version), (<br>size_t)(6))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="340"><td class="num" id="LN340">340</td><td class="line">    long_to_char((<span class='keyword'>long</span>)mfp-&gt;mf_page_size, b0p-&gt;b0_page_size);</td></tr>
<tr class="codeline" data-linenumber="341"><td class="num" id="LN341">341</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="342"><td class="num" id="LN342">342</td><td class="line"><span class='directive'>#ifdef FEAT_SPELL</span></td></tr>
<tr class="codeline" data-linenumber="343"><td class="num" id="LN343">343</td><td class="line">    <span class='keyword'>if</span> (!buf-&gt;b_spell)</td></tr>
<tr class="codeline" data-linenumber="344"><td class="num" id="LN344">344</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="345"><td class="num" id="LN345">345</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="346"><td class="num" id="LN346">346</td><td class="line">	b0p-&gt;<span class='macro'>b0_dirty<span class='macro_popup'>b0_fname[900 - 1]</span></span> = buf-&gt;b_changed ? <span class='macro'>B0_DIRTY<span class='macro_popup'>0x55</span></span> : 0;</td></tr>
<tr class="codeline" data-linenumber="347"><td class="num" id="LN347">347</td><td class="line">	b0p-&gt;<span class='macro'>b0_flags<span class='macro_popup'>b0_fname[900 - 2]</span></span> = get_fileformat(buf) + 1;</td></tr>
<tr class="codeline" data-linenumber="348"><td class="num" id="LN348">348</td><td class="line">	set_b0_fname(b0p, buf);</td></tr>
<tr class="codeline" data-linenumber="349"><td class="num" id="LN349">349</td><td class="line">	(<span class='keyword'>void</span>)get_user_name(b0p-&gt;b0_uname, <span class='macro'>B0_UNAME_SIZE<span class='macro_popup'>40</span></span>);</td></tr>
<tr class="codeline" data-linenumber="350"><td class="num" id="LN350">350</td><td class="line">	b0p-&gt;b0_uname[<span class='macro'>B0_UNAME_SIZE<span class='macro_popup'>40</span></span> - 1] = <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>;</td></tr>
<tr class="codeline" data-linenumber="351"><td class="num" id="LN351">351</td><td class="line">	mch_get_host_name(b0p-&gt;b0_hname, <span class='macro'>B0_HNAME_SIZE<span class='macro_popup'>40</span></span>);</td></tr>
<tr class="codeline" data-linenumber="352"><td class="num" id="LN352">352</td><td class="line">	b0p-&gt;b0_hname[<span class='macro'>B0_HNAME_SIZE<span class='macro_popup'>40</span></span> - 1] = <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>;</td></tr>
<tr class="codeline" data-linenumber="353"><td class="num" id="LN353">353</td><td class="line">	long_to_char(mch_get_pid(), b0p-&gt;b0_pid);</td></tr>
<tr class="codeline" data-linenumber="354"><td class="num" id="LN354">354</td><td class="line"><span class='directive'>#ifdef FEAT_CRYPT</span></td></tr>
<tr class="codeline" data-linenumber="355"><td class="num" id="LN355">355</td><td class="line">	ml_set_b0_crypt(buf, b0p);</td></tr>
<tr class="codeline" data-linenumber="356"><td class="num" id="LN356">356</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="357"><td class="num" id="LN357">357</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="358"><td class="num" id="LN358">358</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="359"><td class="num" id="LN359">359</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="360"><td class="num" id="LN360">360</td><td class="line">     <span class='comment'>* Always sync block number 0 to disk, so we can check the file name in</span></td></tr>
<tr class="codeline" data-linenumber="361"><td class="num" id="LN361">361</td><td class="line">     <span class='comment'>* the swap file in findswapname(). Don't do this for a help files or</span></td></tr>
<tr class="codeline" data-linenumber="362"><td class="num" id="LN362">362</td><td class="line">     <span class='comment'>* a spell buffer though.</span></td></tr>
<tr class="codeline" data-linenumber="363"><td class="num" id="LN363">363</td><td class="line">     <span class='comment'>* Only works when there's a swapfile, otherwise it's done when the file</span></td></tr>
<tr class="codeline" data-linenumber="364"><td class="num" id="LN364">364</td><td class="line">     <span class='comment'>* is created.</span></td></tr>
<tr class="codeline" data-linenumber="365"><td class="num" id="LN365">365</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="366"><td class="num" id="LN366">366</td><td class="line">    mf_put(mfp, hp, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="367"><td class="num" id="LN367">367</td><td class="line">    <span class='keyword'>if</span> (!buf-&gt;b_help &amp;&amp; !<span class='macro'>B_SPELL(buf)<span class='macro_popup'>((buf)-&gt;b_spell)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="368"><td class="num" id="LN368">368</td><td class="line">	(<span class='keyword'>void</span>)mf_sync(mfp, 0);</td></tr>
<tr class="codeline" data-linenumber="369"><td class="num" id="LN369">369</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="370"><td class="num" id="LN370">370</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="371"><td class="num" id="LN371">371</td><td class="line">     <span class='comment'>* Fill in root pointer block and write page 1.</span></td></tr>
<tr class="codeline" data-linenumber="372"><td class="num" id="LN372">372</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="373"><td class="num" id="LN373">373</td><td class="line">    <span class='keyword'>if</span> ((hp = ml_new_ptr(mfp)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="374"><td class="num" id="LN374">374</td><td class="line">	<span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="375"><td class="num" id="LN375">375</td><td class="line">    <span class='keyword'>if</span> (hp-&gt;<span class='macro'>bh_bnum<span class='macro_popup'>bh_hashitem.mhi_key</span></span> != 1)</td></tr>
<tr class="codeline" data-linenumber="376"><td class="num" id="LN376">376</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="377"><td class="num" id="LN377">377</td><td class="line">	iemsg(<span class='macro'>_(<span class='string_literal'>"E298: Didn't get block nr 1?"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E298: Didn't get block nr 1?"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="378"><td class="num" id="LN378">378</td><td class="line">	<span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="379"><td class="num" id="LN379">379</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="380"><td class="num" id="LN380">380</td><td class="line">    pp = (PTR_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="381"><td class="num" id="LN381">381</td><td class="line">    pp-&gt;pb_count = 1;</td></tr>
<tr class="codeline" data-linenumber="382"><td class="num" id="LN382">382</td><td class="line">    pp-&gt;pb_pointer[0].pe_bnum = 2;</td></tr>
<tr class="codeline" data-linenumber="383"><td class="num" id="LN383">383</td><td class="line">    pp-&gt;pb_pointer[0].pe_page_count = 1;</td></tr>
<tr class="codeline" data-linenumber="384"><td class="num" id="LN384">384</td><td class="line">    pp-&gt;pb_pointer[0].pe_old_lnum = 1;</td></tr>
<tr class="codeline" data-linenumber="385"><td class="num" id="LN385">385</td><td class="line">    pp-&gt;pb_pointer[0].pe_line_count = 1;    <span class='comment'>// line count after insertion</span></td></tr>
<tr class="codeline" data-linenumber="386"><td class="num" id="LN386">386</td><td class="line">    mf_put(mfp, hp, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="387"><td class="num" id="LN387">387</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="388"><td class="num" id="LN388">388</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="389"><td class="num" id="LN389">389</td><td class="line">     <span class='comment'>* Allocate first data block and create an empty line 1.</span></td></tr>
<tr class="codeline" data-linenumber="390"><td class="num" id="LN390">390</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="391"><td class="num" id="LN391">391</td><td class="line">    <span class='keyword'>if</span> ((hp = ml_new_data(mfp, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>, 1)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="392"><td class="num" id="LN392">392</td><td class="line">	<span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="393"><td class="num" id="LN393">393</td><td class="line">    <span class='keyword'>if</span> (hp-&gt;<span class='macro'>bh_bnum<span class='macro_popup'>bh_hashitem.mhi_key</span></span> != 2)</td></tr>
<tr class="codeline" data-linenumber="394"><td class="num" id="LN394">394</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="395"><td class="num" id="LN395">395</td><td class="line">	iemsg(<span class='macro'>_(<span class='string_literal'>"E298: Didn't get block nr 2?"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E298: Didn't get block nr 2?"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="396"><td class="num" id="LN396">396</td><td class="line">	<span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="397"><td class="num" id="LN397">397</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="398"><td class="num" id="LN398">398</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="399"><td class="num" id="LN399">399</td><td class="line">    dp = (DATA_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="400"><td class="num" id="LN400">400</td><td class="line">    dp-&gt;db_index[0] = --dp-&gt;db_txt_start;	<span class='comment'>// at end of block</span></td></tr>
<tr class="codeline" data-linenumber="401"><td class="num" id="LN401">401</td><td class="line">    dp-&gt;db_free -= 1 + <span class='macro'>INDEX_SIZE<span class='macro_popup'>(sizeof(unsigned))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="402"><td class="num" id="LN402">402</td><td class="line">    dp-&gt;db_line_count = 1;</td></tr>
<tr class="codeline" data-linenumber="403"><td class="num" id="LN403">403</td><td class="line">    *((char_u *)dp + dp-&gt;db_txt_start) = <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>;	<span class='comment'>// empty line</span></td></tr>
<tr class="codeline" data-linenumber="404"><td class="num" id="LN404">404</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="405"><td class="num" id="LN405">405</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>OK<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="406"><td class="num" id="LN406">406</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="407"><td class="num" id="LN407">407</td><td class="line">error:</td></tr>
<tr class="codeline" data-linenumber="408"><td class="num" id="LN408">408</td><td class="line">    <span class='keyword'>if</span> (mfp != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="409"><td class="num" id="LN409">409</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="410"><td class="num" id="LN410">410</td><td class="line">	<span class='keyword'>if</span> (hp)</td></tr>
<tr class="codeline" data-linenumber="411"><td class="num" id="LN411">411</td><td class="line">	    mf_put(mfp, hp, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="412"><td class="num" id="LN412">412</td><td class="line">	mf_close(mfp, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);	    <span class='comment'>// will also free(mfp-&gt;mf_fname)</span></td></tr>
<tr class="codeline" data-linenumber="413"><td class="num" id="LN413">413</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="414"><td class="num" id="LN414">414</td><td class="line">    buf-&gt;b_ml.ml_mfp = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="415"><td class="num" id="LN415">415</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>FAIL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="416"><td class="num" id="LN416">416</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="417"><td class="num" id="LN417">417</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="418"><td class="num" id="LN418">418</td><td class="line"><span class='directive'>#if defined(FEAT_CRYPT) || defined(PROTO)</span></td></tr>
<tr class="codeline" data-linenumber="419"><td class="num" id="LN419">419</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="420"><td class="num" id="LN420">420</td><td class="line"> <span class='comment'>* Prepare encryption for "buf" for the current key and method.</span></td></tr>
<tr class="codeline" data-linenumber="421"><td class="num" id="LN421">421</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="422"><td class="num" id="LN422">422</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="423"><td class="num" id="LN423">423</td><td class="line">ml_set_mfp_crypt(buf_T *buf)</td></tr>
<tr class="codeline" data-linenumber="424"><td class="num" id="LN424">424</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="425"><td class="num" id="LN425">425</td><td class="line">    <span class='keyword'>if</span> (*buf-&gt;b_p_key != <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>)</td></tr>
<tr class="codeline" data-linenumber="426"><td class="num" id="LN426">426</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="427"><td class="num" id="LN427">427</td><td class="line">	<span class='keyword'>int</span> method_nr = crypt_get_method_nr(buf);</td></tr>
<tr class="codeline" data-linenumber="428"><td class="num" id="LN428">428</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="429"><td class="num" id="LN429">429</td><td class="line">	<span class='keyword'>if</span> (method_nr &gt; <span class='macro'>CRYPT_M_ZIP<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="430"><td class="num" id="LN430">430</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="431"><td class="num" id="LN431">431</td><td class="line">	    <span class='comment'>// Generate a seed and store it in the memfile.</span></td></tr>
<tr class="codeline" data-linenumber="432"><td class="num" id="LN432">432</td><td class="line">	    sha2_seed(buf-&gt;b_ml.ml_mfp-&gt;mf_seed, <span class='macro'>MF_SEED_LEN<span class='macro_popup'>8</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, 0);</td></tr>
<tr class="codeline" data-linenumber="433"><td class="num" id="LN433">433</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="434"><td class="num" id="LN434">434</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="435"><td class="num" id="LN435">435</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="436"><td class="num" id="LN436">436</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="437"><td class="num" id="LN437">437</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="438"><td class="num" id="LN438">438</td><td class="line"> <span class='comment'>* Prepare encryption for "buf" with block 0 "b0p".</span></td></tr>
<tr class="codeline" data-linenumber="439"><td class="num" id="LN439">439</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="440"><td class="num" id="LN440">440</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="441"><td class="num" id="LN441">441</td><td class="line">ml_set_b0_crypt(buf_T *buf, ZERO_BL *b0p)</td></tr>
<tr class="codeline" data-linenumber="442"><td class="num" id="LN442">442</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="443"><td class="num" id="LN443">443</td><td class="line">    <span class='keyword'>if</span> (*buf-&gt;b_p_key == <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>)</td></tr>
<tr class="codeline" data-linenumber="444"><td class="num" id="LN444">444</td><td class="line">	b0p-&gt;b0_id[1] = <span class='macro'>BLOCK0_ID1<span class='macro_popup'>'0'</span></span>;</td></tr>
<tr class="codeline" data-linenumber="445"><td class="num" id="LN445">445</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="446"><td class="num" id="LN446">446</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="447"><td class="num" id="LN447">447</td><td class="line">	<span class='keyword'>int</span> method_nr = crypt_get_method_nr(buf);</td></tr>
<tr class="codeline" data-linenumber="448"><td class="num" id="LN448">448</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="449"><td class="num" id="LN449">449</td><td class="line">	b0p-&gt;b0_id[1] = id1_codes[method_nr];</td></tr>
<tr class="codeline" data-linenumber="450"><td class="num" id="LN450">450</td><td class="line">	<span class='keyword'>if</span> (method_nr &gt; <span class='macro'>CRYPT_M_ZIP<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="451"><td class="num" id="LN451">451</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="452"><td class="num" id="LN452">452</td><td class="line">	    <span class='comment'>// Generate a seed and store it in block 0 and in the memfile.</span></td></tr>
<tr class="codeline" data-linenumber="453"><td class="num" id="LN453">453</td><td class="line">	    sha2_seed(&amp;b0p-&gt;<span class='macro'>b0_seed<span class='macro_popup'>b0_fname[900 - 2 - 8]</span></span>, <span class='macro'>MF_SEED_LEN<span class='macro_popup'>8</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, 0);</td></tr>
<tr class="codeline" data-linenumber="454"><td class="num" id="LN454">454</td><td class="line">	    <span class='macro'>mch_memmove(buf-&gt;b_ml.ml_mfp-&gt;mf_seed, &amp;b0p-&gt;b0_seed, MF_SEED_LEN)<span class='macro_popup'>memmove((char *)(buf-&gt;b_ml.ml_mfp-&gt;mf_seed), (char *)(&amp;<br>b0p-&gt;b0_fname[900 - 2 - 8]), 8)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="455"><td class="num" id="LN455">455</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="456"><td class="num" id="LN456">456</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="457"><td class="num" id="LN457">457</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="458"><td class="num" id="LN458">458</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="459"><td class="num" id="LN459">459</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="460"><td class="num" id="LN460">460</td><td class="line"> <span class='comment'>* Called after the crypt key or 'cryptmethod' was changed for "buf".</span></td></tr>
<tr class="codeline" data-linenumber="461"><td class="num" id="LN461">461</td><td class="line"> <span class='comment'>* Will apply this to the swapfile.</span></td></tr>
<tr class="codeline" data-linenumber="462"><td class="num" id="LN462">462</td><td class="line"> <span class='comment'>* "old_key" is the previous key.  It is equal to buf-&gt;b_p_key when</span></td></tr>
<tr class="codeline" data-linenumber="463"><td class="num" id="LN463">463</td><td class="line"> <span class='comment'>* 'cryptmethod' is changed.</span></td></tr>
<tr class="codeline" data-linenumber="464"><td class="num" id="LN464">464</td><td class="line"> <span class='comment'>* "old_cm" is the previous 'cryptmethod'.  It is equal to the current</span></td></tr>
<tr class="codeline" data-linenumber="465"><td class="num" id="LN465">465</td><td class="line"> <span class='comment'>* 'cryptmethod' when 'key' is changed.</span></td></tr>
<tr class="codeline" data-linenumber="466"><td class="num" id="LN466">466</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="467"><td class="num" id="LN467">467</td><td class="line">    <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="468"><td class="num" id="LN468">468</td><td class="line">ml_set_crypt_key(</td></tr>
<tr class="codeline" data-linenumber="469"><td class="num" id="LN469">469</td><td class="line">    buf_T	*buf,</td></tr>
<tr class="codeline" data-linenumber="470"><td class="num" id="LN470">470</td><td class="line">    char_u	*old_key,</td></tr>
<tr class="codeline" data-linenumber="471"><td class="num" id="LN471">471</td><td class="line">    char_u	*old_cm)</td></tr>
<tr class="codeline" data-linenumber="472"><td class="num" id="LN472">472</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="473"><td class="num" id="LN473">473</td><td class="line">    memfile_T	*mfp = buf-&gt;b_ml.ml_mfp;</td></tr>
<tr class="codeline" data-linenumber="474"><td class="num" id="LN474">474</td><td class="line">    bhdr_T	*hp;</td></tr>
<tr class="codeline" data-linenumber="475"><td class="num" id="LN475">475</td><td class="line">    <span class='keyword'>int</span>		page_count;</td></tr>
<tr class="codeline" data-linenumber="476"><td class="num" id="LN476">476</td><td class="line">    <span class='keyword'>int</span>		idx;</td></tr>
<tr class="codeline" data-linenumber="477"><td class="num" id="LN477">477</td><td class="line">    <span class='keyword'>long</span>	error;</td></tr>
<tr class="codeline" data-linenumber="478"><td class="num" id="LN478">478</td><td class="line">    infoptr_T	*ip;</td></tr>
<tr class="codeline" data-linenumber="479"><td class="num" id="LN479">479</td><td class="line">    PTR_BL	*pp;</td></tr>
<tr class="codeline" data-linenumber="480"><td class="num" id="LN480">480</td><td class="line">    DATA_BL	*dp;</td></tr>
<tr class="codeline" data-linenumber="481"><td class="num" id="LN481">481</td><td class="line">    blocknr_T	bnum;</td></tr>
<tr class="codeline" data-linenumber="482"><td class="num" id="LN482">482</td><td class="line">    <span class='keyword'>int</span>		top;</td></tr>
<tr class="codeline" data-linenumber="483"><td class="num" id="LN483">483</td><td class="line">    <span class='keyword'>int</span>		old_method;</td></tr>
<tr class="codeline" data-linenumber="484"><td class="num" id="LN484">484</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="485"><td class="num" id="LN485">485</td><td class="line">    <span class='keyword'>if</span> (mfp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="486"><td class="num" id="LN486">486</td><td class="line">	<span class='keyword'>return</span>;  <span class='comment'>// no memfile yet, nothing to do</span></td></tr>
<tr class="codeline" data-linenumber="487"><td class="num" id="LN487">487</td><td class="line">    old_method = crypt_method_nr_from_name(old_cm);</td></tr>
<tr class="codeline" data-linenumber="488"><td class="num" id="LN488">488</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="489"><td class="num" id="LN489">489</td><td class="line">    <span class='comment'>// First make sure the swapfile is in a consistent state, using the old</span></td></tr>
<tr class="codeline" data-linenumber="490"><td class="num" id="LN490">490</td><td class="line">    <span class='comment'>// key and method.</span></td></tr>
<tr class="codeline" data-linenumber="491"><td class="num" id="LN491">491</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="492"><td class="num" id="LN492">492</td><td class="line">	char_u *new_key = buf-&gt;b_p_key;</td></tr>
<tr class="codeline" data-linenumber="493"><td class="num" id="LN493">493</td><td class="line">	char_u *new_buf_cm = buf-&gt;b_p_cm;</td></tr>
<tr class="codeline" data-linenumber="494"><td class="num" id="LN494">494</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="495"><td class="num" id="LN495">495</td><td class="line">	buf-&gt;b_p_key = old_key;</td></tr>
<tr class="codeline" data-linenumber="496"><td class="num" id="LN496">496</td><td class="line">	buf-&gt;b_p_cm = old_cm;</td></tr>
<tr class="codeline" data-linenumber="497"><td class="num" id="LN497">497</td><td class="line">	ml_preserve(buf, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="498"><td class="num" id="LN498">498</td><td class="line">	buf-&gt;b_p_key = new_key;</td></tr>
<tr class="codeline" data-linenumber="499"><td class="num" id="LN499">499</td><td class="line">	buf-&gt;b_p_cm = new_buf_cm;</td></tr>
<tr class="codeline" data-linenumber="500"><td class="num" id="LN500">500</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="501"><td class="num" id="LN501">501</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="502"><td class="num" id="LN502">502</td><td class="line">    <span class='comment'>// Set the key, method and seed to be used for reading, these must be the</span></td></tr>
<tr class="codeline" data-linenumber="503"><td class="num" id="LN503">503</td><td class="line">    <span class='comment'>// old values.</span></td></tr>
<tr class="codeline" data-linenumber="504"><td class="num" id="LN504">504</td><td class="line">    mfp-&gt;mf_old_key = old_key;</td></tr>
<tr class="codeline" data-linenumber="505"><td class="num" id="LN505">505</td><td class="line">    mfp-&gt;mf_old_cm = old_method;</td></tr>
<tr class="codeline" data-linenumber="506"><td class="num" id="LN506">506</td><td class="line">    <span class='keyword'>if</span> (old_method &gt; 0 &amp;&amp; *old_key != <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>)</td></tr>
<tr class="codeline" data-linenumber="507"><td class="num" id="LN507">507</td><td class="line">	<span class='macro'>mch_memmove(mfp-&gt;mf_old_seed, mfp-&gt;mf_seed, MF_SEED_LEN)<span class='macro_popup'>memmove((char *)(mfp-&gt;mf_old_seed), (char *)(mfp-&gt;mf_seed<br>), 8)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="508"><td class="num" id="LN508">508</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="509"><td class="num" id="LN509">509</td><td class="line">    <span class='comment'>// Update block 0 with the crypt flag and may set a new seed.</span></td></tr>
<tr class="codeline" data-linenumber="510"><td class="num" id="LN510">510</td><td class="line">    ml_upd_block0(buf, UB_CRYPT);</td></tr>
<tr class="codeline" data-linenumber="511"><td class="num" id="LN511">511</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="512"><td class="num" id="LN512">512</td><td class="line">    <span class='keyword'>if</span> (mfp-&gt;mf_infile_count &gt; 2)</td></tr>
<tr class="codeline" data-linenumber="513"><td class="num" id="LN513">513</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="514"><td class="num" id="LN514">514</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="515"><td class="num" id="LN515">515</td><td class="line">	 <span class='comment'>* Need to read back all data blocks from disk, decrypt them with the</span></td></tr>
<tr class="codeline" data-linenumber="516"><td class="num" id="LN516">516</td><td class="line">	 <span class='comment'>* old key/method and mark them to be written. The algorithm is</span></td></tr>
<tr class="codeline" data-linenumber="517"><td class="num" id="LN517">517</td><td class="line">	 <span class='comment'>* similar to what happens in ml_recover(), but we skip negative block</span></td></tr>
<tr class="codeline" data-linenumber="518"><td class="num" id="LN518">518</td><td class="line">	 <span class='comment'>* numbers.</span></td></tr>
<tr class="codeline" data-linenumber="519"><td class="num" id="LN519">519</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="520"><td class="num" id="LN520">520</td><td class="line">	ml_flush_line(buf);		    <span class='comment'>// flush buffered line</span></td></tr>
<tr class="codeline" data-linenumber="521"><td class="num" id="LN521">521</td><td class="line">	(<span class='keyword'>void</span>)ml_find_line(buf, (linenr_T)0, <span class='macro'>ML_FLUSH<span class='macro_popup'>0x02</span></span>); <span class='comment'>// flush locked block</span></td></tr>
<tr class="codeline" data-linenumber="522"><td class="num" id="LN522">522</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="523"><td class="num" id="LN523">523</td><td class="line">	hp = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="524"><td class="num" id="LN524">524</td><td class="line">	bnum = 1;		<span class='comment'>// start with block 1</span></td></tr>
<tr class="codeline" data-linenumber="525"><td class="num" id="LN525">525</td><td class="line">	page_count = 1;		<span class='comment'>// which is 1 page</span></td></tr>
<tr class="codeline" data-linenumber="526"><td class="num" id="LN526">526</td><td class="line">	idx = 0;		<span class='comment'>// start with first index in block 1</span></td></tr>
<tr class="codeline" data-linenumber="527"><td class="num" id="LN527">527</td><td class="line">	error = 0;</td></tr>
<tr class="codeline" data-linenumber="528"><td class="num" id="LN528">528</td><td class="line">	buf-&gt;b_ml.ml_stack_top = 0;</td></tr>
<tr class="codeline" data-linenumber="529"><td class="num" id="LN529">529</td><td class="line">	<span class='macro'>VIM_CLEAR(buf-&gt;b_ml.ml_stack)<span class='macro_popup'>do { if ((buf-&gt;b_ml.ml_stack) != ((void*)0)) { vim_free(buf<br>-&gt;b_ml.ml_stack); (buf-&gt;b_ml.ml_stack) = ((void*)0); } }<br> while (0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="530"><td class="num" id="LN530">530</td><td class="line">	buf-&gt;b_ml.ml_stack_size = 0;	<span class='comment'>// no stack yet</span></td></tr>
<tr class="codeline" data-linenumber="531"><td class="num" id="LN531">531</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="532"><td class="num" id="LN532">532</td><td class="line">	<span class='keyword'>for</span> ( ; !got_int; line_breakcheck())</td></tr>
<tr class="codeline" data-linenumber="533"><td class="num" id="LN533">533</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="534"><td class="num" id="LN534">534</td><td class="line">	    <span class='keyword'>if</span> (hp != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="535"><td class="num" id="LN535">535</td><td class="line">		mf_put(mfp, hp, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);	<span class='comment'>// release previous block</span></td></tr>
<tr class="codeline" data-linenumber="536"><td class="num" id="LN536">536</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="537"><td class="num" id="LN537">537</td><td class="line">	    <span class='comment'>// get the block (pointer or data)</span></td></tr>
<tr class="codeline" data-linenumber="538"><td class="num" id="LN538">538</td><td class="line">	    <span class='keyword'>if</span> ((hp = mf_get(mfp, (blocknr_T)bnum, page_count)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="539"><td class="num" id="LN539">539</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="540"><td class="num" id="LN540">540</td><td class="line">		<span class='keyword'>if</span> (bnum == 1)</td></tr>
<tr class="codeline" data-linenumber="541"><td class="num" id="LN541">541</td><td class="line">		    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="542"><td class="num" id="LN542">542</td><td class="line">		++error;</td></tr>
<tr class="codeline" data-linenumber="543"><td class="num" id="LN543">543</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="544"><td class="num" id="LN544">544</td><td class="line">	    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="545"><td class="num" id="LN545">545</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="546"><td class="num" id="LN546">546</td><td class="line">		pp = (PTR_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="547"><td class="num" id="LN547">547</td><td class="line">		<span class='keyword'>if</span> (pp-&gt;pb_id == <span class='macro'>PTR_ID<span class='macro_popup'>(('p' &lt;&lt; 8) + 't')</span></span>)	<span class='comment'>// it is a pointer block</span></td></tr>
<tr class="codeline" data-linenumber="548"><td class="num" id="LN548">548</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="549"><td class="num" id="LN549">549</td><td class="line">		    <span class='keyword'>if</span> (pp-&gt;pb_count == 0)</td></tr>
<tr class="codeline" data-linenumber="550"><td class="num" id="LN550">550</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="551"><td class="num" id="LN551">551</td><td class="line">			<span class='comment'>// empty block?</span></td></tr>
<tr class="codeline" data-linenumber="552"><td class="num" id="LN552">552</td><td class="line">			++error;</td></tr>
<tr class="codeline" data-linenumber="553"><td class="num" id="LN553">553</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="554"><td class="num" id="LN554">554</td><td class="line">		    <span class='keyword'>else</span> <span class='keyword'>if</span> (idx &lt; (<span class='keyword'>int</span>)pp-&gt;pb_count)	<span class='comment'>// go a block deeper</span></td></tr>
<tr class="codeline" data-linenumber="555"><td class="num" id="LN555">555</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="556"><td class="num" id="LN556">556</td><td class="line">			<span class='keyword'>if</span> (pp-&gt;pb_pointer[idx].pe_bnum &lt; 0)</td></tr>
<tr class="codeline" data-linenumber="557"><td class="num" id="LN557">557</td><td class="line">			{</td></tr>
<tr class="codeline" data-linenumber="558"><td class="num" id="LN558">558</td><td class="line">			    <span class='comment'>// Skip data block with negative block number.</span></td></tr>
<tr class="codeline" data-linenumber="559"><td class="num" id="LN559">559</td><td class="line">			    <span class='comment'>// Should not happen, because of the ml_preserve()</span></td></tr>
<tr class="codeline" data-linenumber="560"><td class="num" id="LN560">560</td><td class="line">			    <span class='comment'>// above. Get same block again for next index.</span></td></tr>
<tr class="codeline" data-linenumber="561"><td class="num" id="LN561">561</td><td class="line">			    ++idx;</td></tr>
<tr class="codeline" data-linenumber="562"><td class="num" id="LN562">562</td><td class="line">			    <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="563"><td class="num" id="LN563">563</td><td class="line">			}</td></tr>
<tr class="codeline" data-linenumber="564"><td class="num" id="LN564">564</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="565"><td class="num" id="LN565">565</td><td class="line">			<span class='comment'>// going one block deeper in the tree, new entry in</span></td></tr>
<tr class="codeline" data-linenumber="566"><td class="num" id="LN566">566</td><td class="line">			<span class='comment'>// stack</span></td></tr>
<tr class="codeline" data-linenumber="567"><td class="num" id="LN567">567</td><td class="line">			<span class='keyword'>if</span> ((top = ml_add_stack(buf)) &lt; 0)</td></tr>
<tr class="codeline" data-linenumber="568"><td class="num" id="LN568">568</td><td class="line">			{</td></tr>
<tr class="codeline" data-linenumber="569"><td class="num" id="LN569">569</td><td class="line">			    ++error;</td></tr>
<tr class="codeline" data-linenumber="570"><td class="num" id="LN570">570</td><td class="line">			    <span class='keyword'>break</span>;		    <span class='comment'>// out of memory</span></td></tr>
<tr class="codeline" data-linenumber="571"><td class="num" id="LN571">571</td><td class="line">			}</td></tr>
<tr class="codeline" data-linenumber="572"><td class="num" id="LN572">572</td><td class="line">			ip = &amp;(buf-&gt;b_ml.ml_stack[top]);</td></tr>
<tr class="codeline" data-linenumber="573"><td class="num" id="LN573">573</td><td class="line">			ip-&gt;ip_bnum = bnum;</td></tr>
<tr class="codeline" data-linenumber="574"><td class="num" id="LN574">574</td><td class="line">			ip-&gt;ip_index = idx;</td></tr>
<tr class="codeline" data-linenumber="575"><td class="num" id="LN575">575</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="576"><td class="num" id="LN576">576</td><td class="line">			bnum = pp-&gt;pb_pointer[idx].pe_bnum;</td></tr>
<tr class="codeline" data-linenumber="577"><td class="num" id="LN577">577</td><td class="line">			page_count = pp-&gt;pb_pointer[idx].pe_page_count;</td></tr>
<tr class="codeline" data-linenumber="578"><td class="num" id="LN578">578</td><td class="line">			idx = 0;</td></tr>
<tr class="codeline" data-linenumber="579"><td class="num" id="LN579">579</td><td class="line">			<span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="580"><td class="num" id="LN580">580</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="581"><td class="num" id="LN581">581</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="582"><td class="num" id="LN582">582</td><td class="line">		<span class='keyword'>else</span>	    <span class='comment'>// not a pointer block</span></td></tr>
<tr class="codeline" data-linenumber="583"><td class="num" id="LN583">583</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="584"><td class="num" id="LN584">584</td><td class="line">		    dp = (DATA_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="585"><td class="num" id="LN585">585</td><td class="line">		    <span class='keyword'>if</span> (dp-&gt;db_id != <span class='macro'>DATA_ID<span class='macro_popup'>(('d' &lt;&lt; 8) + 'a')</span></span>)	<span class='comment'>// block id wrong</span></td></tr>
<tr class="codeline" data-linenumber="586"><td class="num" id="LN586">586</td><td class="line">			++error;</td></tr>
<tr class="codeline" data-linenumber="587"><td class="num" id="LN587">587</td><td class="line">		    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="588"><td class="num" id="LN588">588</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="589"><td class="num" id="LN589">589</td><td class="line">			<span class='comment'>// It is a data block, need to write it back to disk.</span></td></tr>
<tr class="codeline" data-linenumber="590"><td class="num" id="LN590">590</td><td class="line">			mf_put(mfp, hp, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="591"><td class="num" id="LN591">591</td><td class="line">			hp = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="592"><td class="num" id="LN592">592</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="593"><td class="num" id="LN593">593</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="594"><td class="num" id="LN594">594</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="595"><td class="num" id="LN595">595</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="596"><td class="num" id="LN596">596</td><td class="line">	    <span class='keyword'>if</span> (buf-&gt;b_ml.ml_stack_top == 0)	<span class='comment'>// finished</span></td></tr>
<tr class="codeline" data-linenumber="597"><td class="num" id="LN597">597</td><td class="line">		<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="598"><td class="num" id="LN598">598</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="599"><td class="num" id="LN599">599</td><td class="line">	    <span class='comment'>// go one block up in the tree</span></td></tr>
<tr class="codeline" data-linenumber="600"><td class="num" id="LN600">600</td><td class="line">	    ip = &amp;(buf-&gt;b_ml.ml_stack[--(buf-&gt;b_ml.ml_stack_top)]);</td></tr>
<tr class="codeline" data-linenumber="601"><td class="num" id="LN601">601</td><td class="line">	    bnum = ip-&gt;ip_bnum;</td></tr>
<tr class="codeline" data-linenumber="602"><td class="num" id="LN602">602</td><td class="line">	    idx = ip-&gt;ip_index + 1;	    <span class='comment'>// go to next index</span></td></tr>
<tr class="codeline" data-linenumber="603"><td class="num" id="LN603">603</td><td class="line">	    page_count = 1;</td></tr>
<tr class="codeline" data-linenumber="604"><td class="num" id="LN604">604</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="605"><td class="num" id="LN605">605</td><td class="line">	<span class='keyword'>if</span> (hp != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="606"><td class="num" id="LN606">606</td><td class="line">	    mf_put(mfp, hp, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);  <span class='comment'>// release previous block</span></td></tr>
<tr class="codeline" data-linenumber="607"><td class="num" id="LN607">607</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="608"><td class="num" id="LN608">608</td><td class="line">	<span class='keyword'>if</span> (error &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="609"><td class="num" id="LN609">609</td><td class="line">	    emsg(<span class='macro'>_(<span class='string_literal'>"E843: Error while updating swap file crypt"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E843: Error while updating swap file crypt"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="610"><td class="num" id="LN610">610</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="611"><td class="num" id="LN611">611</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="612"><td class="num" id="LN612">612</td><td class="line">    mfp-&gt;mf_old_key = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="613"><td class="num" id="LN613">613</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="614"><td class="num" id="LN614">614</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="615"><td class="num" id="LN615">615</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="616"><td class="num" id="LN616">616</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="617"><td class="num" id="LN617">617</td><td class="line"> <span class='comment'>* ml_setname() is called when the file name of "buf" has been changed.</span></td></tr>
<tr class="codeline" data-linenumber="618"><td class="num" id="LN618">618</td><td class="line"> <span class='comment'>* It may rename the swap file.</span></td></tr>
<tr class="codeline" data-linenumber="619"><td class="num" id="LN619">619</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="620"><td class="num" id="LN620">620</td><td class="line">    <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="621"><td class="num" id="LN621">621</td><td class="line">ml_setname(buf_T *buf)</td></tr>
<tr class="codeline" data-linenumber="622"><td class="num" id="LN622">622</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="623"><td class="num" id="LN623">623</td><td class="line">    <span class='keyword'>int</span>		success = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="624"><td class="num" id="LN624">624</td><td class="line">    memfile_T	*mfp;</td></tr>
<tr class="codeline" data-linenumber="625"><td class="num" id="LN625">625</td><td class="line">    char_u	*fname;</td></tr>
<tr class="codeline" data-linenumber="626"><td class="num" id="LN626">626</td><td class="line">    char_u	*dirp;</td></tr>
<tr class="codeline" data-linenumber="627"><td class="num" id="LN627">627</td><td class="line"><span class='directive'>#if defined(MSWIN)</span></td></tr>
<tr class="codeline" data-linenumber="628"><td class="num" id="LN628">628</td><td class="line">    char_u	*p;</td></tr>
<tr class="codeline" data-linenumber="629"><td class="num" id="LN629">629</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="630"><td class="num" id="LN630">630</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="631"><td class="num" id="LN631">631</td><td class="line">    mfp = buf-&gt;b_ml.ml_mfp;</td></tr>
<tr class="codeline" data-linenumber="632"><td class="num" id="LN632">632</td><td class="line">    <span class='keyword'>if</span> (mfp-&gt;mf_fd &lt; 0)		    <span class='comment'>// there is no swap file yet</span></td></tr>
<tr class="codeline" data-linenumber="633"><td class="num" id="LN633">633</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="634"><td class="num" id="LN634">634</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="635"><td class="num" id="LN635">635</td><td class="line">	 <span class='comment'>* When 'updatecount' is 0 and 'noswapfile' there is no swap file.</span></td></tr>
<tr class="codeline" data-linenumber="636"><td class="num" id="LN636">636</td><td class="line">	 <span class='comment'>* For help files we will make a swap file now.</span></td></tr>
<tr class="codeline" data-linenumber="637"><td class="num" id="LN637">637</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="638"><td class="num" id="LN638">638</td><td class="line">	<span class='keyword'>if</span> (p_uc != 0 &amp;&amp; (cmdmod.cmod_flags &amp; <span class='macro'>CMOD_NOSWAPFILE<span class='macro_popup'>0x2000</span></span>) == 0)</td></tr>
<tr class="codeline" data-linenumber="639"><td class="num" id="LN639">639</td><td class="line">	    ml_open_file(buf);	    <span class='comment'>// create a swap file</span></td></tr>
<tr class="codeline" data-linenumber="640"><td class="num" id="LN640">640</td><td class="line">	<span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="641"><td class="num" id="LN641">641</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="642"><td class="num" id="LN642">642</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="643"><td class="num" id="LN643">643</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="644"><td class="num" id="LN644">644</td><td class="line">     <span class='comment'>* Try all directories in the 'directory' option.</span></td></tr>
<tr class="codeline" data-linenumber="645"><td class="num" id="LN645">645</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="646"><td class="num" id="LN646">646</td><td class="line">    dirp = p_dir;</td></tr>
<tr class="codeline" data-linenumber="647"><td class="num" id="LN647">647</td><td class="line">    <span class='keyword'>for</span> (;;)</td></tr>
<tr class="codeline" data-linenumber="648"><td class="num" id="LN648">648</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="649"><td class="num" id="LN649">649</td><td class="line">	<span class='keyword'>if</span> (*dirp == <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>)	    <span class='comment'>// tried all directories, fail</span></td></tr>
<tr class="codeline" data-linenumber="650"><td class="num" id="LN650">650</td><td class="line">	    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="651"><td class="num" id="LN651">651</td><td class="line">	fname = findswapname(buf, &amp;dirp, mfp-&gt;mf_fname);</td></tr>
<tr class="codeline" data-linenumber="652"><td class="num" id="LN652">652</td><td class="line">						    <span class='comment'>// alloc's fname</span></td></tr>
<tr class="codeline" data-linenumber="653"><td class="num" id="LN653">653</td><td class="line">	<span class='keyword'>if</span> (dirp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)	    <span class='comment'>// out of memory</span></td></tr>
<tr class="codeline" data-linenumber="654"><td class="num" id="LN654">654</td><td class="line">	    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="655"><td class="num" id="LN655">655</td><td class="line">	<span class='keyword'>if</span> (fname == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)	    <span class='comment'>// no file name found for this dir</span></td></tr>
<tr class="codeline" data-linenumber="656"><td class="num" id="LN656">656</td><td class="line">	    <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="657"><td class="num" id="LN657">657</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="658"><td class="num" id="LN658">658</td><td class="line"><span class='directive'>#if defined(MSWIN)</span></td></tr>
<tr class="codeline" data-linenumber="659"><td class="num" id="LN659">659</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="660"><td class="num" id="LN660">660</td><td class="line">	 <span class='comment'>* Set full pathname for swap file now, because a ":!cd dir" may</span></td></tr>
<tr class="codeline" data-linenumber="661"><td class="num" id="LN661">661</td><td class="line">	 <span class='comment'>* change directory without us knowing it.</span></td></tr>
<tr class="codeline" data-linenumber="662"><td class="num" id="LN662">662</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="663"><td class="num" id="LN663">663</td><td class="line">	p = FullName_save(fname, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="664"><td class="num" id="LN664">664</td><td class="line">	vim_free(fname);</td></tr>
<tr class="codeline" data-linenumber="665"><td class="num" id="LN665">665</td><td class="line">	fname = p;</td></tr>
<tr class="codeline" data-linenumber="666"><td class="num" id="LN666">666</td><td class="line">	<span class='keyword'>if</span> (fname == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="667"><td class="num" id="LN667">667</td><td class="line">	    <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="668"><td class="num" id="LN668">668</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="669"><td class="num" id="LN669">669</td><td class="line">	<span class='comment'>// if the file name is the same we don't have to do anything</span></td></tr>
<tr class="codeline" data-linenumber="670"><td class="num" id="LN670">670</td><td class="line">	<span class='keyword'>if</span> (<span class='macro'>fnamecmp(fname, mfp-&gt;mf_fname)<span class='macro_popup'>vim_fnamecmp((char_u *)(fname), (char_u *)(mfp-&gt;mf_fname))</span></span> == 0)</td></tr>
<tr class="codeline" data-linenumber="671"><td class="num" id="LN671">671</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="672"><td class="num" id="LN672">672</td><td class="line">	    vim_free(fname);</td></tr>
<tr class="codeline" data-linenumber="673"><td class="num" id="LN673">673</td><td class="line">	    success = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="674"><td class="num" id="LN674">674</td><td class="line">	    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="675"><td class="num" id="LN675">675</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="676"><td class="num" id="LN676">676</td><td class="line">	<span class='comment'>// need to close the swap file before renaming</span></td></tr>
<tr class="codeline" data-linenumber="677"><td class="num" id="LN677">677</td><td class="line">	<span class='keyword'>if</span> (mfp-&gt;mf_fd &gt;= 0)</td></tr>
<tr class="codeline" data-linenumber="678"><td class="num" id="LN678">678</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="679"><td class="num" id="LN679">679</td><td class="line">	    close(mfp-&gt;mf_fd);</td></tr>
<tr class="codeline" data-linenumber="680"><td class="num" id="LN680">680</td><td class="line">	    mfp-&gt;mf_fd = -1;</td></tr>
<tr class="codeline" data-linenumber="681"><td class="num" id="LN681">681</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="682"><td class="num" id="LN682">682</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="683"><td class="num" id="LN683">683</td><td class="line">	<span class='comment'>// try to rename the swap file</span></td></tr>
<tr class="codeline" data-linenumber="684"><td class="num" id="LN684">684</td><td class="line">	<span class='keyword'>if</span> (vim_rename(mfp-&gt;mf_fname, fname) == 0)</td></tr>
<tr class="codeline" data-linenumber="685"><td class="num" id="LN685">685</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="686"><td class="num" id="LN686">686</td><td class="line">	    success = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="687"><td class="num" id="LN687">687</td><td class="line">	    vim_free(mfp-&gt;mf_fname);</td></tr>
<tr class="codeline" data-linenumber="688"><td class="num" id="LN688">688</td><td class="line">	    mfp-&gt;mf_fname = fname;</td></tr>
<tr class="codeline" data-linenumber="689"><td class="num" id="LN689">689</td><td class="line">	    vim_free(mfp-&gt;mf_ffname);</td></tr>
<tr class="codeline" data-linenumber="690"><td class="num" id="LN690">690</td><td class="line"><span class='directive'>#if defined(MSWIN)</span></td></tr>
<tr class="codeline" data-linenumber="691"><td class="num" id="LN691">691</td><td class="line">	    mfp-&gt;mf_ffname = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;  <span class='comment'>// mf_fname is full pathname already</span></td></tr>
<tr class="codeline" data-linenumber="692"><td class="num" id="LN692">692</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="693"><td class="num" id="LN693">693</td><td class="line">	    mf_set_ffname(mfp);</td></tr>
<tr class="codeline" data-linenumber="694"><td class="num" id="LN694">694</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="695"><td class="num" id="LN695">695</td><td class="line">	    ml_upd_block0(buf, UB_SAME_DIR);</td></tr>
<tr class="codeline" data-linenumber="696"><td class="num" id="LN696">696</td><td class="line">	    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="697"><td class="num" id="LN697">697</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="698"><td class="num" id="LN698">698</td><td class="line">	vim_free(fname);	    <span class='comment'>// this fname didn't work, try another</span></td></tr>
<tr class="codeline" data-linenumber="699"><td class="num" id="LN699">699</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="700"><td class="num" id="LN700">700</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="701"><td class="num" id="LN701">701</td><td class="line">    <span class='keyword'>if</span> (mfp-&gt;mf_fd == -1)	    <span class='comment'>// need to (re)open the swap file</span></td></tr>
<tr class="codeline" data-linenumber="702"><td class="num" id="LN702">702</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="703"><td class="num" id="LN703">703</td><td class="line">	mfp-&gt;mf_fd = <span class='macro'>mch_open((<span class='keyword'>char</span> *)mfp-&gt;mf_fname, O_RDWR | O_EXTRA, 0)<span class='macro_popup'>open(((char *)mfp-&gt;mf_fname), (02 | 0), (0))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="704"><td class="num" id="LN704">704</td><td class="line">	<span class='keyword'>if</span> (mfp-&gt;mf_fd &lt; 0)</td></tr>
<tr class="codeline" data-linenumber="705"><td class="num" id="LN705">705</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="706"><td class="num" id="LN706">706</td><td class="line">	    <span class='comment'>// could not (re)open the swap file, what can we do????</span></td></tr>
<tr class="codeline" data-linenumber="707"><td class="num" id="LN707">707</td><td class="line">	    emsg(<span class='macro'>_(<span class='string_literal'>"E301: Oops, lost the swap file!!!"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E301: Oops, lost the swap file!!!"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="708"><td class="num" id="LN708">708</td><td class="line">	    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="709"><td class="num" id="LN709">709</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="710"><td class="num" id="LN710">710</td><td class="line"><span class='directive'>#ifdef <span class='macro'>HAVE_FD_CLOEXEC<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="711"><td class="num" id="LN711">711</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="712"><td class="num" id="LN712">712</td><td class="line">	    <span class='keyword'>int</span> fdflags = fcntl(mfp-&gt;mf_fd, <span class='macro'>F_GETFD<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="713"><td class="num" id="LN713">713</td><td class="line">	    <span class='keyword'>if</span> (fdflags &gt;= 0 &amp;&amp; (fdflags &amp; <span class='macro'>FD_CLOEXEC<span class='macro_popup'>1</span></span>) == 0)</td></tr>
<tr class="codeline" data-linenumber="714"><td class="num" id="LN714">714</td><td class="line">		(<span class='keyword'>void</span>)fcntl(mfp-&gt;mf_fd, <span class='macro'>F_SETFD<span class='macro_popup'>2</span></span>, fdflags | <span class='macro'>FD_CLOEXEC<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="715"><td class="num" id="LN715">715</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="716"><td class="num" id="LN716">716</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="717"><td class="num" id="LN717">717</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="718"><td class="num" id="LN718">718</td><td class="line">    <span class='keyword'>if</span> (!success)</td></tr>
<tr class="codeline" data-linenumber="719"><td class="num" id="LN719">719</td><td class="line">	emsg(<span class='macro'>_(<span class='string_literal'>"E302: Could not rename swap file"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E302: Could not rename swap file"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="720"><td class="num" id="LN720">720</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="721"><td class="num" id="LN721">721</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="722"><td class="num" id="LN722">722</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="723"><td class="num" id="LN723">723</td><td class="line"> <span class='comment'>* Open a file for the memfile for all buffers that are not readonly or have</span></td></tr>
<tr class="codeline" data-linenumber="724"><td class="num" id="LN724">724</td><td class="line"> <span class='comment'>* been modified.</span></td></tr>
<tr class="codeline" data-linenumber="725"><td class="num" id="LN725">725</td><td class="line"> <span class='comment'>* Used when 'updatecount' changes from zero to non-zero.</span></td></tr>
<tr class="codeline" data-linenumber="726"><td class="num" id="LN726">726</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="727"><td class="num" id="LN727">727</td><td class="line">    <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="728"><td class="num" id="LN728">728</td><td class="line">ml_open_files(<span class='keyword'>void</span>)</td></tr>
<tr class="codeline" data-linenumber="729"><td class="num" id="LN729">729</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="730"><td class="num" id="LN730">730</td><td class="line">    buf_T	*buf;</td></tr>
<tr class="codeline" data-linenumber="731"><td class="num" id="LN731">731</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="732"><td class="num" id="LN732">732</td><td class="line">    <span class='macro'>FOR_ALL_BUFFERS(buf)<span class='macro_popup'>for ((buf) = firstbuf; (buf) != ((void*)0); (buf) = (buf)-&gt;<br>b_next)</span></span></td></tr>
<tr class="codeline" data-linenumber="733"><td class="num" id="LN733">733</td><td class="line">	<span class='keyword'>if</span> (!buf-&gt;b_p_ro || buf-&gt;b_changed)</td></tr>
<tr class="codeline" data-linenumber="734"><td class="num" id="LN734">734</td><td class="line">	    ml_open_file(buf);</td></tr>
<tr class="codeline" data-linenumber="735"><td class="num" id="LN735">735</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="736"><td class="num" id="LN736">736</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="737"><td class="num" id="LN737">737</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="738"><td class="num" id="LN738">738</td><td class="line"> <span class='comment'>* Open a swap file for an existing memfile, if there is no swap file yet.</span></td></tr>
<tr class="codeline" data-linenumber="739"><td class="num" id="LN739">739</td><td class="line"> <span class='comment'>* If we are unable to find a file name, mf_fname will be NULL</span></td></tr>
<tr class="codeline" data-linenumber="740"><td class="num" id="LN740">740</td><td class="line"> <span class='comment'>* and the memfile will be in memory only (no recovery possible).</span></td></tr>
<tr class="codeline" data-linenumber="741"><td class="num" id="LN741">741</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="742"><td class="num" id="LN742">742</td><td class="line">    <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="743"><td class="num" id="LN743">743</td><td class="line">ml_open_file(buf_T *buf)</td></tr>
<tr class="codeline" data-linenumber="744"><td class="num" id="LN744">744</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="745"><td class="num" id="LN745">745</td><td class="line">    memfile_T	*mfp;</td></tr>
<tr class="codeline" data-linenumber="746"><td class="num" id="LN746">746</td><td class="line">    char_u	*fname;</td></tr>
<tr class="codeline" data-linenumber="747"><td class="num" id="LN747">747</td><td class="line">    char_u	*dirp;</td></tr>
<tr class="codeline" data-linenumber="748"><td class="num" id="LN748">748</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="749"><td class="num" id="LN749">749</td><td class="line">    mfp = buf-&gt;b_ml.ml_mfp;</td></tr>
<tr class="codeline" data-linenumber="750"><td class="num" id="LN750">750</td><td class="line">    <span class='keyword'>if</span> (mfp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || mfp-&gt;mf_fd &gt;= 0 || !buf-&gt;b_p_swf</td></tr>
<tr class="codeline" data-linenumber="751"><td class="num" id="LN751">751</td><td class="line">				      || (cmdmod.cmod_flags &amp; <span class='macro'>CMOD_NOSWAPFILE<span class='macro_popup'>0x2000</span></span>))</td></tr>
<tr class="codeline" data-linenumber="752"><td class="num" id="LN752">752</td><td class="line">	<span class='keyword'>return</span>;		<span class='comment'>// nothing to do</span></td></tr>
<tr class="codeline" data-linenumber="753"><td class="num" id="LN753">753</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="754"><td class="num" id="LN754">754</td><td class="line"><span class='directive'>#ifdef FEAT_SPELL</span></td></tr>
<tr class="codeline" data-linenumber="755"><td class="num" id="LN755">755</td><td class="line">    <span class='comment'>// For a spell buffer use a temp file name.</span></td></tr>
<tr class="codeline" data-linenumber="756"><td class="num" id="LN756">756</td><td class="line">    <span class='keyword'>if</span> (buf-&gt;b_spell)</td></tr>
<tr class="codeline" data-linenumber="757"><td class="num" id="LN757">757</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="758"><td class="num" id="LN758">758</td><td class="line">	fname = vim_tempname('s', <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="759"><td class="num" id="LN759">759</td><td class="line">	<span class='keyword'>if</span> (fname != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="760"><td class="num" id="LN760">760</td><td class="line">	    (<span class='keyword'>void</span>)mf_open_file(mfp, fname);	<span class='comment'>// consumes fname!</span></td></tr>
<tr class="codeline" data-linenumber="761"><td class="num" id="LN761">761</td><td class="line">	buf-&gt;b_may_swap = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="762"><td class="num" id="LN762">762</td><td class="line">	<span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="763"><td class="num" id="LN763">763</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="764"><td class="num" id="LN764">764</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="765"><td class="num" id="LN765">765</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="766"><td class="num" id="LN766">766</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="767"><td class="num" id="LN767">767</td><td class="line">     <span class='comment'>* Try all directories in 'directory' option.</span></td></tr>
<tr class="codeline" data-linenumber="768"><td class="num" id="LN768">768</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="769"><td class="num" id="LN769">769</td><td class="line">    dirp = p_dir;</td></tr>
<tr class="codeline" data-linenumber="770"><td class="num" id="LN770">770</td><td class="line">    <span class='keyword'>for</span> (;;)</td></tr>
<tr class="codeline" data-linenumber="771"><td class="num" id="LN771">771</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="772"><td class="num" id="LN772">772</td><td class="line">	<span class='keyword'>if</span> (*dirp == <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>)</td></tr>
<tr class="codeline" data-linenumber="773"><td class="num" id="LN773">773</td><td class="line">	    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="774"><td class="num" id="LN774">774</td><td class="line">	<span class='comment'>// There is a small chance that between choosing the swap file name</span></td></tr>
<tr class="codeline" data-linenumber="775"><td class="num" id="LN775">775</td><td class="line">	<span class='comment'>// and creating it, another Vim creates the file.  In that case the</span></td></tr>
<tr class="codeline" data-linenumber="776"><td class="num" id="LN776">776</td><td class="line">	<span class='comment'>// creation will fail and we will use another directory.</span></td></tr>
<tr class="codeline" data-linenumber="777"><td class="num" id="LN777">777</td><td class="line">	fname = findswapname(buf, &amp;dirp, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>); <span class='comment'>// allocates fname</span></td></tr>
<tr class="codeline" data-linenumber="778"><td class="num" id="LN778">778</td><td class="line">	<span class='keyword'>if</span> (dirp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="779"><td class="num" id="LN779">779</td><td class="line">	    <span class='keyword'>break</span>;  <span class='comment'>// out of memory</span></td></tr>
<tr class="codeline" data-linenumber="780"><td class="num" id="LN780">780</td><td class="line">	<span class='keyword'>if</span> (fname == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="781"><td class="num" id="LN781">781</td><td class="line">	    <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="782"><td class="num" id="LN782">782</td><td class="line">	<span class='keyword'>if</span> (mf_open_file(mfp, fname) == <span class='macro'>OK<span class='macro_popup'>1</span></span>)	<span class='comment'>// consumes fname!</span></td></tr>
<tr class="codeline" data-linenumber="783"><td class="num" id="LN783">783</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="784"><td class="num" id="LN784">784</td><td class="line"><span class='directive'>#if defined(MSWIN)</span></td></tr>
<tr class="codeline" data-linenumber="785"><td class="num" id="LN785">785</td><td class="line">	    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="786"><td class="num" id="LN786">786</td><td class="line">	     <span class='comment'>* set full pathname for swap file now, because a ":!cd dir" may</span></td></tr>
<tr class="codeline" data-linenumber="787"><td class="num" id="LN787">787</td><td class="line">	     <span class='comment'>* change directory without us knowing it.</span></td></tr>
<tr class="codeline" data-linenumber="788"><td class="num" id="LN788">788</td><td class="line">	     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="789"><td class="num" id="LN789">789</td><td class="line">	    mf_fullname(mfp);</td></tr>
<tr class="codeline" data-linenumber="790"><td class="num" id="LN790">790</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="791"><td class="num" id="LN791">791</td><td class="line">	    ml_upd_block0(buf, UB_SAME_DIR);</td></tr>
<tr class="codeline" data-linenumber="792"><td class="num" id="LN792">792</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="793"><td class="num" id="LN793">793</td><td class="line">	    <span class='comment'>// Flush block zero, so others can read it</span></td></tr>
<tr class="codeline" data-linenumber="794"><td class="num" id="LN794">794</td><td class="line">	    <span class='keyword'>if</span> (mf_sync(mfp, <span class='macro'>MFS_ZERO<span class='macro_popup'>8</span></span>) == <span class='macro'>OK<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="795"><td class="num" id="LN795">795</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="796"><td class="num" id="LN796">796</td><td class="line">		<span class='comment'>// Mark all blocks that should be in the swapfile as dirty.</span></td></tr>
<tr class="codeline" data-linenumber="797"><td class="num" id="LN797">797</td><td class="line">		<span class='comment'>// Needed for when the 'swapfile' option was reset, so that</span></td></tr>
<tr class="codeline" data-linenumber="798"><td class="num" id="LN798">798</td><td class="line">		<span class='comment'>// the swap file was deleted, and then on again.</span></td></tr>
<tr class="codeline" data-linenumber="799"><td class="num" id="LN799">799</td><td class="line">		mf_set_dirty(mfp);</td></tr>
<tr class="codeline" data-linenumber="800"><td class="num" id="LN800">800</td><td class="line">		<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="801"><td class="num" id="LN801">801</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="802"><td class="num" id="LN802">802</td><td class="line">	    <span class='comment'>// Writing block 0 failed: close the file and try another dir</span></td></tr>
<tr class="codeline" data-linenumber="803"><td class="num" id="LN803">803</td><td class="line">	    mf_close_file(buf, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="804"><td class="num" id="LN804">804</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="805"><td class="num" id="LN805">805</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="806"><td class="num" id="LN806">806</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="807"><td class="num" id="LN807">807</td><td class="line">    <span class='keyword'>if</span> (*p_dir != <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span> &amp;&amp; mfp-&gt;mf_fname == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="808"><td class="num" id="LN808">808</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="809"><td class="num" id="LN809">809</td><td class="line">	need_wait_return = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;	<span class='comment'>// call wait_return later</span></td></tr>
<tr class="codeline" data-linenumber="810"><td class="num" id="LN810">810</td><td class="line">	++no_wait_return;</td></tr>
<tr class="codeline" data-linenumber="811"><td class="num" id="LN811">811</td><td class="line">	(<span class='keyword'>void</span>)semsg(<span class='macro'>_(<span class='string_literal'>"E303: Unable to open swap file for \"%s\", recovery impossible"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E303: Unable to open swap file for \"%s\", recovery impossible"<br>), 5)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="812"><td class="num" id="LN812">812</td><td class="line">		    buf_spname(buf) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> ? buf_spname(buf) : buf-&gt;b_fname);</td></tr>
<tr class="codeline" data-linenumber="813"><td class="num" id="LN813">813</td><td class="line">	--no_wait_return;</td></tr>
<tr class="codeline" data-linenumber="814"><td class="num" id="LN814">814</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="815"><td class="num" id="LN815">815</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="816"><td class="num" id="LN816">816</td><td class="line">    <span class='comment'>// don't try to open a swap file again</span></td></tr>
<tr class="codeline" data-linenumber="817"><td class="num" id="LN817">817</td><td class="line">    buf-&gt;b_may_swap = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="818"><td class="num" id="LN818">818</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="819"><td class="num" id="LN819">819</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="820"><td class="num" id="LN820">820</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="821"><td class="num" id="LN821">821</td><td class="line"> <span class='comment'>* If still need to create a swap file, and starting to edit a not-readonly</span></td></tr>
<tr class="codeline" data-linenumber="822"><td class="num" id="LN822">822</td><td class="line"> <span class='comment'>* file, or reading into an existing buffer, create a swap file now.</span></td></tr>
<tr class="codeline" data-linenumber="823"><td class="num" id="LN823">823</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="824"><td class="num" id="LN824">824</td><td class="line">    <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="825"><td class="num" id="LN825">825</td><td class="line">check_need_swap(</td></tr>
<tr class="codeline" data-linenumber="826"><td class="num" id="LN826">826</td><td class="line">    <span class='keyword'>int</span>	    newfile)		<span class='comment'>// reading file into new buffer</span></td></tr>
<tr class="codeline" data-linenumber="827"><td class="num" id="LN827">827</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="828"><td class="num" id="LN828">828</td><td class="line">    <span class='keyword'>int</span> old_msg_silent = msg_silent; <span class='comment'>// might be reset by an E325 message</span></td></tr>
<tr class="codeline" data-linenumber="829"><td class="num" id="LN829">829</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="830"><td class="num" id="LN830">830</td><td class="line">    <span class='keyword'>if</span> (curbuf-&gt;b_may_swap &amp;&amp; (!curbuf-&gt;b_p_ro || !newfile))</td></tr>
<tr class="codeline" data-linenumber="831"><td class="num" id="LN831">831</td><td class="line">	ml_open_file(curbuf);</td></tr>
<tr class="codeline" data-linenumber="832"><td class="num" id="LN832">832</td><td class="line">    msg_silent = old_msg_silent;</td></tr>
<tr class="codeline" data-linenumber="833"><td class="num" id="LN833">833</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="834"><td class="num" id="LN834">834</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="835"><td class="num" id="LN835">835</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="836"><td class="num" id="LN836">836</td><td class="line"> <span class='comment'>* Close memline for buffer 'buf'.</span></td></tr>
<tr class="codeline" data-linenumber="837"><td class="num" id="LN837">837</td><td class="line"> <span class='comment'>* If 'del_file' is TRUE, delete the swap file</span></td></tr>
<tr class="codeline" data-linenumber="838"><td class="num" id="LN838">838</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="839"><td class="num" id="LN839">839</td><td class="line">    <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="840"><td class="num" id="LN840">840</td><td class="line">ml_close(buf_T *buf, <span class='keyword'>int</span> del_file)</td></tr>
<tr class="codeline" data-linenumber="841"><td class="num" id="LN841">841</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="842"><td class="num" id="LN842">842</td><td class="line">    <span class='keyword'>if</span> (buf-&gt;b_ml.ml_mfp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)		<span class='comment'>// not open</span></td></tr>
<tr class="codeline" data-linenumber="843"><td class="num" id="LN843">843</td><td class="line">	<span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="844"><td class="num" id="LN844">844</td><td class="line">    mf_close(buf-&gt;b_ml.ml_mfp, del_file);	<span class='comment'>// close the .swp file</span></td></tr>
<tr class="codeline" data-linenumber="845"><td class="num" id="LN845">845</td><td class="line">    <span class='keyword'>if</span> (buf-&gt;b_ml.ml_line_lnum != 0 &amp;&amp; (buf-&gt;b_ml.ml_flags &amp; <span class='macro'>ML_LINE_DIRTY<span class='macro_popup'>2</span></span>))</td></tr>
<tr class="codeline" data-linenumber="846"><td class="num" id="LN846">846</td><td class="line">	vim_free(buf-&gt;b_ml.ml_line_ptr);</td></tr>
<tr class="codeline" data-linenumber="847"><td class="num" id="LN847">847</td><td class="line">    vim_free(buf-&gt;b_ml.ml_stack);</td></tr>
<tr class="codeline" data-linenumber="848"><td class="num" id="LN848">848</td><td class="line"><span class='directive'>#ifdef FEAT_BYTEOFF</span></td></tr>
<tr class="codeline" data-linenumber="849"><td class="num" id="LN849">849</td><td class="line">    <span class='macro'>VIM_CLEAR(buf-&gt;b_ml.ml_chunksize)<span class='macro_popup'>do { if ((buf-&gt;b_ml.ml_chunksize) != ((void*)0)) { vim_free<br>(buf-&gt;b_ml.ml_chunksize); (buf-&gt;b_ml.ml_chunksize) = ((<br>void*)0); } } while (0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="850"><td class="num" id="LN850">850</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="851"><td class="num" id="LN851">851</td><td class="line">    buf-&gt;b_ml.ml_mfp = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="852"><td class="num" id="LN852">852</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="853"><td class="num" id="LN853">853</td><td class="line">    <span class='comment'>// Reset the "recovered" flag, give the ATTENTION prompt the next time</span></td></tr>
<tr class="codeline" data-linenumber="854"><td class="num" id="LN854">854</td><td class="line">    <span class='comment'>// this buffer is loaded.</span></td></tr>
<tr class="codeline" data-linenumber="855"><td class="num" id="LN855">855</td><td class="line">    buf-&gt;b_flags &amp;= ~<span class='macro'>BF_RECOVERED<span class='macro_popup'>0x01</span></span>;</td></tr>
<tr class="codeline" data-linenumber="856"><td class="num" id="LN856">856</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="857"><td class="num" id="LN857">857</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="858"><td class="num" id="LN858">858</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="859"><td class="num" id="LN859">859</td><td class="line"> <span class='comment'>* Close all existing memlines and memfiles.</span></td></tr>
<tr class="codeline" data-linenumber="860"><td class="num" id="LN860">860</td><td class="line"> <span class='comment'>* Only used when exiting.</span></td></tr>
<tr class="codeline" data-linenumber="861"><td class="num" id="LN861">861</td><td class="line"> <span class='comment'>* When 'del_file' is TRUE, delete the memfiles.</span></td></tr>
<tr class="codeline" data-linenumber="862"><td class="num" id="LN862">862</td><td class="line"> <span class='comment'>* But don't delete files that were ":preserve"d when we are POSIX compatible.</span></td></tr>
<tr class="codeline" data-linenumber="863"><td class="num" id="LN863">863</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="864"><td class="num" id="LN864">864</td><td class="line">    <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="865"><td class="num" id="LN865">865</td><td class="line">ml_close_all(<span class='keyword'>int</span> del_file)</td></tr>
<tr class="codeline" data-linenumber="866"><td class="num" id="LN866">866</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="867"><td class="num" id="LN867">867</td><td class="line">    buf_T	*buf;</td></tr>
<tr class="codeline" data-linenumber="868"><td class="num" id="LN868">868</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="869"><td class="num" id="LN869">869</td><td class="line">    <span class='macro'>FOR_ALL_BUFFERS(buf)<span class='macro_popup'>for ((buf) = firstbuf; (buf) != ((void*)0); (buf) = (buf)-&gt;<br>b_next)</span></span></td></tr>
<tr class="codeline" data-linenumber="870"><td class="num" id="LN870">870</td><td class="line">	ml_close(buf, del_file &amp;&amp; ((buf-&gt;b_flags &amp; <span class='macro'>BF_PRESERVED<span class='macro_popup'>0x100</span></span>) == 0</td></tr>
<tr class="codeline" data-linenumber="871"><td class="num" id="LN871">871</td><td class="line">				 || vim_strchr(p_cpo, <span class='macro'>CPO_PRESERVE<span class='macro_popup'>'&amp;'</span></span>) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>));</td></tr>
<tr class="codeline" data-linenumber="872"><td class="num" id="LN872">872</td><td class="line"><span class='directive'>#ifdef FEAT_SPELL</span></td></tr>
<tr class="codeline" data-linenumber="873"><td class="num" id="LN873">873</td><td class="line">    spell_delete_wordlist();	<span class='comment'>// delete the internal wordlist</span></td></tr>
<tr class="codeline" data-linenumber="874"><td class="num" id="LN874">874</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="875"><td class="num" id="LN875">875</td><td class="line"><span class='directive'>#ifdef <span class='macro'>TEMPDIRNAMES<span class='macro_popup'>"$TMPDIR", "/tmp", ".", "$HOME"</span></span></span></td></tr>
<tr class="codeline" data-linenumber="876"><td class="num" id="LN876">876</td><td class="line">    vim_deltempdir();		<span class='comment'>// delete created temp directory</span></td></tr>
<tr class="codeline" data-linenumber="877"><td class="num" id="LN877">877</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="878"><td class="num" id="LN878">878</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="879"><td class="num" id="LN879">879</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="880"><td class="num" id="LN880">880</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="881"><td class="num" id="LN881">881</td><td class="line"> <span class='comment'>* Close all memfiles for not modified buffers.</span></td></tr>
<tr class="codeline" data-linenumber="882"><td class="num" id="LN882">882</td><td class="line"> <span class='comment'>* Only use just before exiting!</span></td></tr>
<tr class="codeline" data-linenumber="883"><td class="num" id="LN883">883</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="884"><td class="num" id="LN884">884</td><td class="line">    <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="885"><td class="num" id="LN885">885</td><td class="line">ml_close_notmod(<span class='keyword'>void</span>)</td></tr>
<tr class="codeline" data-linenumber="886"><td class="num" id="LN886">886</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="887"><td class="num" id="LN887">887</td><td class="line">    buf_T	*buf;</td></tr>
<tr class="codeline" data-linenumber="888"><td class="num" id="LN888">888</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="889"><td class="num" id="LN889">889</td><td class="line">    <span class='macro'>FOR_ALL_BUFFERS(buf)<span class='macro_popup'>for ((buf) = firstbuf; (buf) != ((void*)0); (buf) = (buf)-&gt;<br>b_next)</span></span></td></tr>
<tr class="codeline" data-linenumber="890"><td class="num" id="LN890">890</td><td class="line">	<span class='keyword'>if</span> (!bufIsChanged(buf))</td></tr>
<tr class="codeline" data-linenumber="891"><td class="num" id="LN891">891</td><td class="line">	    ml_close(buf, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);    <span class='comment'>// close all not-modified buffers</span></td></tr>
<tr class="codeline" data-linenumber="892"><td class="num" id="LN892">892</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="893"><td class="num" id="LN893">893</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="894"><td class="num" id="LN894">894</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="895"><td class="num" id="LN895">895</td><td class="line"> <span class='comment'>* Update the timestamp in the .swp file.</span></td></tr>
<tr class="codeline" data-linenumber="896"><td class="num" id="LN896">896</td><td class="line"> <span class='comment'>* Used when the file has been written.</span></td></tr>
<tr class="codeline" data-linenumber="897"><td class="num" id="LN897">897</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="898"><td class="num" id="LN898">898</td><td class="line">    <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="899"><td class="num" id="LN899">899</td><td class="line">ml_timestamp(buf_T *buf)</td></tr>
<tr class="codeline" data-linenumber="900"><td class="num" id="LN900">900</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="901"><td class="num" id="LN901">901</td><td class="line">    ml_upd_block0(buf, UB_FNAME);</td></tr>
<tr class="codeline" data-linenumber="902"><td class="num" id="LN902">902</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="903"><td class="num" id="LN903">903</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="904"><td class="num" id="LN904">904</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="905"><td class="num" id="LN905">905</td><td class="line"> <span class='comment'>* Return FAIL when the ID of "b0p" is wrong.</span></td></tr>
<tr class="codeline" data-linenumber="906"><td class="num" id="LN906">906</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="907"><td class="num" id="LN907">907</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="908"><td class="num" id="LN908">908</td><td class="line">ml_check_b0_id(ZERO_BL *b0p)</td></tr>
<tr class="codeline" data-linenumber="909"><td class="num" id="LN909">909</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="910"><td class="num" id="LN910">910</td><td class="line">    <span class='keyword'>if</span> (b0p-&gt;b0_id[0] != <span class='macro'>BLOCK0_ID0<span class='macro_popup'>'b'</span></span></td></tr>
<tr class="codeline" data-linenumber="911"><td class="num" id="LN911">911</td><td class="line">	    || (b0p-&gt;b0_id[1] != <span class='macro'>BLOCK0_ID1<span class='macro_popup'>'0'</span></span></td></tr>
<tr class="codeline" data-linenumber="912"><td class="num" id="LN912">912</td><td class="line">		&amp;&amp; b0p-&gt;b0_id[1] != <span class='macro'>BLOCK0_ID1_C0<span class='macro_popup'>'c'</span></span></td></tr>
<tr class="codeline" data-linenumber="913"><td class="num" id="LN913">913</td><td class="line">		&amp;&amp; b0p-&gt;b0_id[1] != <span class='macro'>BLOCK0_ID1_C1<span class='macro_popup'>'C'</span></span></td></tr>
<tr class="codeline" data-linenumber="914"><td class="num" id="LN914">914</td><td class="line">		&amp;&amp; b0p-&gt;b0_id[1] != <span class='macro'>BLOCK0_ID1_C2<span class='macro_popup'>'d'</span></span>)</td></tr>
<tr class="codeline" data-linenumber="915"><td class="num" id="LN915">915</td><td class="line">	    )</td></tr>
<tr class="codeline" data-linenumber="916"><td class="num" id="LN916">916</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>FAIL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="917"><td class="num" id="LN917">917</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>OK<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="918"><td class="num" id="LN918">918</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="919"><td class="num" id="LN919">919</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="920"><td class="num" id="LN920">920</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="921"><td class="num" id="LN921">921</td><td class="line"> <span class='comment'>* Update the timestamp or the B0_SAME_DIR flag of the .swp file.</span></td></tr>
<tr class="codeline" data-linenumber="922"><td class="num" id="LN922">922</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="923"><td class="num" id="LN923">923</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="924"><td class="num" id="LN924">924</td><td class="line">ml_upd_block0(buf_T *buf, upd_block0_T what)</td></tr>
<tr class="codeline" data-linenumber="925"><td class="num" id="LN925">925</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="926"><td class="num" id="LN926">926</td><td class="line">    memfile_T	*mfp;</td></tr>
<tr class="codeline" data-linenumber="927"><td class="num" id="LN927">927</td><td class="line">    bhdr_T	*hp;</td></tr>
<tr class="codeline" data-linenumber="928"><td class="num" id="LN928">928</td><td class="line">    ZERO_BL	*b0p;</td></tr>
<tr class="codeline" data-linenumber="929"><td class="num" id="LN929">929</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="930"><td class="num" id="LN930">930</td><td class="line">    mfp = buf-&gt;b_ml.ml_mfp;</td></tr>
<tr class="codeline" data-linenumber="931"><td class="num" id="LN931">931</td><td class="line">    <span class='keyword'>if</span> (mfp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="932"><td class="num" id="LN932">932</td><td class="line">	<span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="933"><td class="num" id="LN933">933</td><td class="line">    hp = mf_get(mfp, (blocknr_T)0, 1);</td></tr>
<tr class="codeline" data-linenumber="934"><td class="num" id="LN934">934</td><td class="line">    <span class='keyword'>if</span> (hp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="935"><td class="num" id="LN935">935</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="936"><td class="num" id="LN936">936</td><td class="line"><span class='directive'>#ifdef FEAT_CRYPT</span></td></tr>
<tr class="codeline" data-linenumber="937"><td class="num" id="LN937">937</td><td class="line">	<span class='comment'>// Possibly update the seed in the memfile before there is a block0.</span></td></tr>
<tr class="codeline" data-linenumber="938"><td class="num" id="LN938">938</td><td class="line">	<span class='keyword'>if</span> (what == UB_CRYPT)</td></tr>
<tr class="codeline" data-linenumber="939"><td class="num" id="LN939">939</td><td class="line">	    ml_set_mfp_crypt(buf);</td></tr>
<tr class="codeline" data-linenumber="940"><td class="num" id="LN940">940</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="941"><td class="num" id="LN941">941</td><td class="line">	<span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="942"><td class="num" id="LN942">942</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="943"><td class="num" id="LN943">943</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="944"><td class="num" id="LN944">944</td><td class="line">    b0p = (ZERO_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="945"><td class="num" id="LN945">945</td><td class="line">    <span class='keyword'>if</span> (ml_check_b0_id(b0p) == <span class='macro'>FAIL<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="946"><td class="num" id="LN946">946</td><td class="line">	iemsg(<span class='macro'>_(<span class='string_literal'>"E304: ml_upd_block0(): Didn't get block 0??"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E304: ml_upd_block0(): Didn't get block 0??"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="947"><td class="num" id="LN947">947</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="948"><td class="num" id="LN948">948</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="949"><td class="num" id="LN949">949</td><td class="line">	<span class='keyword'>if</span> (what == UB_FNAME)</td></tr>
<tr class="codeline" data-linenumber="950"><td class="num" id="LN950">950</td><td class="line">	    set_b0_fname(b0p, buf);</td></tr>
<tr class="codeline" data-linenumber="951"><td class="num" id="LN951">951</td><td class="line"><span class='directive'>#ifdef FEAT_CRYPT</span></td></tr>
<tr class="codeline" data-linenumber="952"><td class="num" id="LN952">952</td><td class="line">	<span class='keyword'>else</span> <span class='keyword'>if</span> (what == UB_CRYPT)</td></tr>
<tr class="codeline" data-linenumber="953"><td class="num" id="LN953">953</td><td class="line">	    ml_set_b0_crypt(buf, b0p);</td></tr>
<tr class="codeline" data-linenumber="954"><td class="num" id="LN954">954</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="955"><td class="num" id="LN955">955</td><td class="line">	<span class='keyword'>else</span> <span class='comment'>// what == UB_SAME_DIR</span></td></tr>
<tr class="codeline" data-linenumber="956"><td class="num" id="LN956">956</td><td class="line">	    set_b0_dir_flag(b0p, buf);</td></tr>
<tr class="codeline" data-linenumber="957"><td class="num" id="LN957">957</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="958"><td class="num" id="LN958">958</td><td class="line">    mf_put(mfp, hp, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="959"><td class="num" id="LN959">959</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="960"><td class="num" id="LN960">960</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="961"><td class="num" id="LN961">961</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="962"><td class="num" id="LN962">962</td><td class="line"> <span class='comment'>* Write file name and timestamp into block 0 of a swap file.</span></td></tr>
<tr class="codeline" data-linenumber="963"><td class="num" id="LN963">963</td><td class="line"> <span class='comment'>* Also set buf-&gt;b_mtime.</span></td></tr>
<tr class="codeline" data-linenumber="964"><td class="num" id="LN964">964</td><td class="line"> <span class='comment'>* Don't use NameBuff[]!!!</span></td></tr>
<tr class="codeline" data-linenumber="965"><td class="num" id="LN965">965</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="966"><td class="num" id="LN966">966</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="967"><td class="num" id="LN967">967</td><td class="line">set_b0_fname(ZERO_BL *b0p, buf_T *buf)</td></tr>
<tr class="codeline" data-linenumber="968"><td class="num" id="LN968">968</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="969"><td class="num" id="LN969">969</td><td class="line">    stat_T	st;</td></tr>
<tr class="codeline" data-linenumber="970"><td class="num" id="LN970">970</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="971"><td class="num" id="LN971">971</td><td class="line">    <span class='keyword'>if</span> (buf-&gt;b_ffname == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="972"><td class="num" id="LN972">972</td><td class="line">	b0p-&gt;b0_fname[0] = <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>;</td></tr>
<tr class="codeline" data-linenumber="973"><td class="num" id="LN973">973</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="974"><td class="num" id="LN974">974</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="975"><td class="num" id="LN975">975</td><td class="line"><span class='directive'>#if defined(MSWIN) || defined(AMIGA)</span></td></tr>
<tr class="codeline" data-linenumber="976"><td class="num" id="LN976">976</td><td class="line">	<span class='comment'>// Systems that cannot translate "~user" back into a path: copy the</span></td></tr>
<tr class="codeline" data-linenumber="977"><td class="num" id="LN977">977</td><td class="line">	<span class='comment'>// file name unmodified.  Do use slashes instead of backslashes for</span></td></tr>
<tr class="codeline" data-linenumber="978"><td class="num" id="LN978">978</td><td class="line">	<span class='comment'>// portability.</span></td></tr>
<tr class="codeline" data-linenumber="979"><td class="num" id="LN979">979</td><td class="line">	vim_strncpy(b0p-&gt;b0_fname, buf-&gt;b_ffname, <span class='macro'>B0_FNAME_SIZE_CRYPT<span class='macro_popup'>890</span></span> - 1);</td></tr>
<tr class="codeline" data-linenumber="980"><td class="num" id="LN980">980</td><td class="line"><span class='directive'># ifdef BACKSLASH_IN_FILENAME</span></td></tr>
<tr class="codeline" data-linenumber="981"><td class="num" id="LN981">981</td><td class="line">	forward_slash(b0p-&gt;b0_fname);</td></tr>
<tr class="codeline" data-linenumber="982"><td class="num" id="LN982">982</td><td class="line"><span class='directive'># endif</span></td></tr>
<tr class="codeline" data-linenumber="983"><td class="num" id="LN983">983</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="984"><td class="num" id="LN984">984</td><td class="line">	size_t	flen, ulen;</td></tr>
<tr class="codeline" data-linenumber="985"><td class="num" id="LN985">985</td><td class="line">	char_u	uname[<span class='macro'>B0_UNAME_SIZE<span class='macro_popup'>40</span></span>];</td></tr>
<tr class="codeline" data-linenumber="986"><td class="num" id="LN986">986</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="987"><td class="num" id="LN987">987</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="988"><td class="num" id="LN988">988</td><td class="line">	 <span class='comment'>* For a file under the home directory of the current user, we try to</span></td></tr>
<tr class="codeline" data-linenumber="989"><td class="num" id="LN989">989</td><td class="line">	 <span class='comment'>* replace the home directory path with "~user". This helps when</span></td></tr>
<tr class="codeline" data-linenumber="990"><td class="num" id="LN990">990</td><td class="line">	 <span class='comment'>* editing the same file on different machines over a network.</span></td></tr>
<tr class="codeline" data-linenumber="991"><td class="num" id="LN991">991</td><td class="line">	 <span class='comment'>* First replace home dir path with "~/" with home_replace().</span></td></tr>
<tr class="codeline" data-linenumber="992"><td class="num" id="LN992">992</td><td class="line">	 <span class='comment'>* Then insert the user name to get "~user/".</span></td></tr>
<tr class="codeline" data-linenumber="993"><td class="num" id="LN993">993</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="994"><td class="num" id="LN994">994</td><td class="line">	home_replace(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, buf-&gt;b_ffname, b0p-&gt;b0_fname,</td></tr>
<tr class="codeline" data-linenumber="995"><td class="num" id="LN995">995</td><td class="line">						   <span class='macro'>B0_FNAME_SIZE_CRYPT<span class='macro_popup'>890</span></span>, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="996"><td class="num" id="LN996">996</td><td class="line">	<span class='keyword'>if</span> (b0p-&gt;b0_fname[0] == '~')</td></tr>
<tr class="codeline" data-linenumber="997"><td class="num" id="LN997">997</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="998"><td class="num" id="LN998">998</td><td class="line">	    flen = <span class='macro'>STRLEN(b0p-&gt;b0_fname)<span class='macro_popup'>strlen((char *)(b0p-&gt;b0_fname))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="999"><td class="num" id="LN999">999</td><td class="line">	    <span class='comment'>// If there is no user name or it is too long, don't use "~/"</span></td></tr>
<tr class="codeline" data-linenumber="1000"><td class="num" id="LN1000">1000</td><td class="line">	    <span class='keyword'>if</span> (get_user_name(uname, <span class='macro'>B0_UNAME_SIZE<span class='macro_popup'>40</span></span>) == <span class='macro'>FAIL<span class='macro_popup'>0</span></span></td></tr>
<tr class="codeline" data-linenumber="1001"><td class="num" id="LN1001">1001</td><td class="line">		   || (ulen = <span class='macro'>STRLEN(uname)<span class='macro_popup'>strlen((char *)(uname))</span></span>) + flen &gt; <span class='macro'>B0_FNAME_SIZE_CRYPT<span class='macro_popup'>890</span></span> - 1)</td></tr>
<tr class="codeline" data-linenumber="1002"><td class="num" id="LN1002">1002</td><td class="line">		vim_strncpy(b0p-&gt;b0_fname, buf-&gt;b_ffname,</td></tr>
<tr class="codeline" data-linenumber="1003"><td class="num" id="LN1003">1003</td><td class="line">						     <span class='macro'>B0_FNAME_SIZE_CRYPT<span class='macro_popup'>890</span></span> - 1);</td></tr>
<tr class="codeline" data-linenumber="1004"><td class="num" id="LN1004">1004</td><td class="line">	    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1005"><td class="num" id="LN1005">1005</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="1006"><td class="num" id="LN1006">1006</td><td class="line">		<span class='macro'>mch_memmove(b0p-&gt;b0_fname + ulen + 1, b0p-&gt;b0_fname + 1, flen)<span class='macro_popup'>memmove((char *)(b0p-&gt;b0_fname + ulen + 1), (char *)(b0p-&gt;<br>b0_fname + 1), flen)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1007"><td class="num" id="LN1007">1007</td><td class="line">		<span class='macro'>mch_memmove(b0p-&gt;b0_fname + 1, uname, ulen)<span class='macro_popup'>memmove((char *)(b0p-&gt;b0_fname + 1), (char *)(uname), ulen<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1008"><td class="num" id="LN1008">1008</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="1009"><td class="num" id="LN1009">1009</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1010"><td class="num" id="LN1010">1010</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1011"><td class="num" id="LN1011">1011</td><td class="line">	<span class='keyword'>if</span> (<span class='macro'>mch_stat((<span class='keyword'>char</span> *)buf-&gt;b_ffname, &amp;st)<span class='macro_popup'>stat(((char *)buf-&gt;b_ffname), (&amp;st))</span></span> &gt;= 0)</td></tr>
<tr class="codeline" data-linenumber="1012"><td class="num" id="LN1012">1012</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="1013"><td class="num" id="LN1013">1013</td><td class="line">	    long_to_char((<span class='keyword'>long</span>)st.<span class='macro'>st_mtime<span class='macro_popup'>st_mtim.tv_sec</span></span>, b0p-&gt;b0_mtime);</td></tr>
<tr class="codeline" data-linenumber="1014"><td class="num" id="LN1014">1014</td><td class="line"><span class='directive'>#ifdef CHECK_INODE</span></td></tr>
<tr class="codeline" data-linenumber="1015"><td class="num" id="LN1015">1015</td><td class="line">	    long_to_char((<span class='keyword'>long</span>)st.st_ino, b0p-&gt;b0_ino);</td></tr>
<tr class="codeline" data-linenumber="1016"><td class="num" id="LN1016">1016</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1017"><td class="num" id="LN1017">1017</td><td class="line">	    buf_store_time(buf, &amp;st, buf-&gt;b_ffname);</td></tr>
<tr class="codeline" data-linenumber="1018"><td class="num" id="LN1018">1018</td><td class="line">	    buf-&gt;b_mtime_read = buf-&gt;b_mtime;</td></tr>
<tr class="codeline" data-linenumber="1019"><td class="num" id="LN1019">1019</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1020"><td class="num" id="LN1020">1020</td><td class="line">	<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1021"><td class="num" id="LN1021">1021</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="1022"><td class="num" id="LN1022">1022</td><td class="line">	    long_to_char(0L, b0p-&gt;b0_mtime);</td></tr>
<tr class="codeline" data-linenumber="1023"><td class="num" id="LN1023">1023</td><td class="line"><span class='directive'>#ifdef CHECK_INODE</span></td></tr>
<tr class="codeline" data-linenumber="1024"><td class="num" id="LN1024">1024</td><td class="line">	    long_to_char(0L, b0p-&gt;b0_ino);</td></tr>
<tr class="codeline" data-linenumber="1025"><td class="num" id="LN1025">1025</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1026"><td class="num" id="LN1026">1026</td><td class="line">	    buf-&gt;b_mtime = 0;</td></tr>
<tr class="codeline" data-linenumber="1027"><td class="num" id="LN1027">1027</td><td class="line">	    buf-&gt;b_mtime_read = 0;</td></tr>
<tr class="codeline" data-linenumber="1028"><td class="num" id="LN1028">1028</td><td class="line">	    buf-&gt;b_orig_size = 0;</td></tr>
<tr class="codeline" data-linenumber="1029"><td class="num" id="LN1029">1029</td><td class="line">	    buf-&gt;b_orig_mode = 0;</td></tr>
<tr class="codeline" data-linenumber="1030"><td class="num" id="LN1030">1030</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1031"><td class="num" id="LN1031">1031</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1032"><td class="num" id="LN1032">1032</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1033"><td class="num" id="LN1033">1033</td><td class="line">    <span class='comment'>// Also add the 'fileencoding' if there is room.</span></td></tr>
<tr class="codeline" data-linenumber="1034"><td class="num" id="LN1034">1034</td><td class="line">    add_b0_fenc(b0p, curbuf);</td></tr>
<tr class="codeline" data-linenumber="1035"><td class="num" id="LN1035">1035</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1036"><td class="num" id="LN1036">1036</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1037"><td class="num" id="LN1037">1037</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1038"><td class="num" id="LN1038">1038</td><td class="line"> <span class='comment'>* Update the B0_SAME_DIR flag of the swap file.  It's set if the file and the</span></td></tr>
<tr class="codeline" data-linenumber="1039"><td class="num" id="LN1039">1039</td><td class="line"> <span class='comment'>* swapfile for "buf" are in the same directory.</span></td></tr>
<tr class="codeline" data-linenumber="1040"><td class="num" id="LN1040">1040</td><td class="line"> <span class='comment'>* This is fail safe: if we are not sure the directories are equal the flag is</span></td></tr>
<tr class="codeline" data-linenumber="1041"><td class="num" id="LN1041">1041</td><td class="line"> <span class='comment'>* not set.</span></td></tr>
<tr class="codeline" data-linenumber="1042"><td class="num" id="LN1042">1042</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1043"><td class="num" id="LN1043">1043</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="1044"><td class="num" id="LN1044">1044</td><td class="line">set_b0_dir_flag(ZERO_BL *b0p, buf_T *buf)</td></tr>
<tr class="codeline" data-linenumber="1045"><td class="num" id="LN1045">1045</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1046"><td class="num" id="LN1046">1046</td><td class="line">    <span class='keyword'>if</span> (same_directory(buf-&gt;b_ml.ml_mfp-&gt;mf_fname, buf-&gt;b_ffname))</td></tr>
<tr class="codeline" data-linenumber="1047"><td class="num" id="LN1047">1047</td><td class="line">	b0p-&gt;<span class='macro'>b0_flags<span class='macro_popup'>b0_fname[900 - 2]</span></span> |= <span class='macro'>B0_SAME_DIR<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1048"><td class="num" id="LN1048">1048</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1049"><td class="num" id="LN1049">1049</td><td class="line">	b0p-&gt;<span class='macro'>b0_flags<span class='macro_popup'>b0_fname[900 - 2]</span></span> &amp;= ~<span class='macro'>B0_SAME_DIR<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1050"><td class="num" id="LN1050">1050</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1051"><td class="num" id="LN1051">1051</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1052"><td class="num" id="LN1052">1052</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1053"><td class="num" id="LN1053">1053</td><td class="line"> <span class='comment'>* When there is room, add the 'fileencoding' to block zero.</span></td></tr>
<tr class="codeline" data-linenumber="1054"><td class="num" id="LN1054">1054</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1055"><td class="num" id="LN1055">1055</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="1056"><td class="num" id="LN1056">1056</td><td class="line">add_b0_fenc(</td></tr>
<tr class="codeline" data-linenumber="1057"><td class="num" id="LN1057">1057</td><td class="line">    ZERO_BL	*b0p,</td></tr>
<tr class="codeline" data-linenumber="1058"><td class="num" id="LN1058">1058</td><td class="line">    buf_T	*buf)</td></tr>
<tr class="codeline" data-linenumber="1059"><td class="num" id="LN1059">1059</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1060"><td class="num" id="LN1060">1060</td><td class="line">    <span class='keyword'>int</span>		n;</td></tr>
<tr class="codeline" data-linenumber="1061"><td class="num" id="LN1061">1061</td><td class="line">    <span class='keyword'>int</span>		size = <span class='macro'>B0_FNAME_SIZE_NOCRYPT<span class='macro_popup'>898</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1062"><td class="num" id="LN1062">1062</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1063"><td class="num" id="LN1063">1063</td><td class="line"><span class='directive'>#ifdef FEAT_CRYPT</span></td></tr>
<tr class="codeline" data-linenumber="1064"><td class="num" id="LN1064">1064</td><td class="line">    <span class='comment'>// Without encryption use the same offset as in Vim 7.2 to be compatible.</span></td></tr>
<tr class="codeline" data-linenumber="1065"><td class="num" id="LN1065">1065</td><td class="line">    <span class='comment'>// With encryption it's OK to move elsewhere, the swap file is not</span></td></tr>
<tr class="codeline" data-linenumber="1066"><td class="num" id="LN1066">1066</td><td class="line">    <span class='comment'>// compatible anyway.</span></td></tr>
<tr class="codeline" data-linenumber="1067"><td class="num" id="LN1067">1067</td><td class="line">    <span class='keyword'>if</span> (*buf-&gt;b_p_key != <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1068"><td class="num" id="LN1068">1068</td><td class="line">	size = <span class='macro'>B0_FNAME_SIZE_CRYPT<span class='macro_popup'>890</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1069"><td class="num" id="LN1069">1069</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1070"><td class="num" id="LN1070">1070</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1071"><td class="num" id="LN1071">1071</td><td class="line">    n = (<span class='keyword'>int</span>)<span class='macro'>STRLEN(buf-&gt;b_p_fenc)<span class='macro_popup'>strlen((char *)(buf-&gt;b_p_fenc))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1072"><td class="num" id="LN1072">1072</td><td class="line">    <span class='keyword'>if</span> ((<span class='keyword'>int</span>)<span class='macro'>STRLEN(b0p-&gt;b0_fname)<span class='macro_popup'>strlen((char *)(b0p-&gt;b0_fname))</span></span> + n + 1 &gt; size)</td></tr>
<tr class="codeline" data-linenumber="1073"><td class="num" id="LN1073">1073</td><td class="line">	b0p-&gt;<span class='macro'>b0_flags<span class='macro_popup'>b0_fname[900 - 2]</span></span> &amp;= ~<span class='macro'>B0_HAS_FENC<span class='macro_popup'>8</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1074"><td class="num" id="LN1074">1074</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1075"><td class="num" id="LN1075">1075</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1076"><td class="num" id="LN1076">1076</td><td class="line">	<span class='macro'>mch_memmove((<span class='keyword'>char</span> *)b0p-&gt;b0_fname + size - n,<span class='macro_popup'>memmove((char *)((char *)b0p-&gt;b0_fname + size - n), (char *<br>)((char *)buf-&gt;b_p_fenc), (size_t)n)</span></span></td></tr>
<tr class="codeline" data-linenumber="1077"><td class="num" id="LN1077">1077</td><td class="line">					    <span class='macro'>(<span class='keyword'>char</span> *)buf-&gt;b_p_fenc, (size_t)n)<span class='macro_popup'>memmove((char *)((char *)b0p-&gt;b0_fname + size - n), (char *<br>)((char *)buf-&gt;b_p_fenc), (size_t)n)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1078"><td class="num" id="LN1078">1078</td><td class="line">	*(b0p-&gt;b0_fname + size - n - 1) = <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1079"><td class="num" id="LN1079">1079</td><td class="line">	b0p-&gt;<span class='macro'>b0_flags<span class='macro_popup'>b0_fname[900 - 2]</span></span> |= <span class='macro'>B0_HAS_FENC<span class='macro_popup'>8</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1080"><td class="num" id="LN1080">1080</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1081"><td class="num" id="LN1081">1081</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1082"><td class="num" id="LN1082">1082</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1083"><td class="num" id="LN1083">1083</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1084"><td class="num" id="LN1084">1084</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1085"><td class="num" id="LN1085">1085</td><td class="line"> <span class='comment'>* Try to recover curbuf from the .swp file.</span></td></tr>
<tr class="codeline" data-linenumber="1086"><td class="num" id="LN1086">1086</td><td class="line"> <span class='comment'>* If "checkext" is TRUE, check the extension and detect whether it is</span></td></tr>
<tr class="codeline" data-linenumber="1087"><td class="num" id="LN1087">1087</td><td class="line"> <span class='comment'>* a swap file.</span></td></tr>
<tr class="codeline" data-linenumber="1088"><td class="num" id="LN1088">1088</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1089"><td class="num" id="LN1089">1089</td><td class="line">    <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="1090"><td class="num" id="LN1090">1090</td><td class="line">ml_recover(<span class='keyword'>int</span> checkext)</td></tr>
<tr class="codeline" data-linenumber="1091"><td class="num" id="LN1091">1091</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1092"><td class="num" id="LN1092">1092</td><td class="line">    buf_T	*buf = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1093"><td class="num" id="LN1093">1093</td><td class="line">    memfile_T	*mfp = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1094"><td class="num" id="LN1094">1094</td><td class="line">    char_u	*fname;</td></tr>
<tr class="codeline" data-linenumber="1095"><td class="num" id="LN1095">1095</td><td class="line">    char_u	*fname_used = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1096"><td class="num" id="LN1096">1096</td><td class="line">    bhdr_T	*hp = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1097"><td class="num" id="LN1097">1097</td><td class="line">    ZERO_BL	*b0p;</td></tr>
<tr class="codeline" data-linenumber="1098"><td class="num" id="LN1098">1098</td><td class="line">    <span class='keyword'>int</span>		b0_ff;</td></tr>
<tr class="codeline" data-linenumber="1099"><td class="num" id="LN1099">1099</td><td class="line">    char_u	*b0_fenc = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1100"><td class="num" id="LN1100">1100</td><td class="line"><span class='directive'>#ifdef FEAT_CRYPT</span></td></tr>
<tr class="codeline" data-linenumber="1101"><td class="num" id="LN1101">1101</td><td class="line">    <span class='keyword'>int</span>		b0_cm = -1;</td></tr>
<tr class="codeline" data-linenumber="1102"><td class="num" id="LN1102">1102</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1103"><td class="num" id="LN1103">1103</td><td class="line">    PTR_BL	*pp;</td></tr>
<tr class="codeline" data-linenumber="1104"><td class="num" id="LN1104">1104</td><td class="line">    DATA_BL	*dp;</td></tr>
<tr class="codeline" data-linenumber="1105"><td class="num" id="LN1105">1105</td><td class="line">    infoptr_T	*ip;</td></tr>
<tr class="codeline" data-linenumber="1106"><td class="num" id="LN1106">1106</td><td class="line">    blocknr_T	bnum;</td></tr>
<tr class="codeline" data-linenumber="1107"><td class="num" id="LN1107">1107</td><td class="line">    <span class='keyword'>int</span>		page_count;</td></tr>
<tr class="codeline" data-linenumber="1108"><td class="num" id="LN1108">1108</td><td class="line">    stat_T	org_stat, swp_stat;</td></tr>
<tr class="codeline" data-linenumber="1109"><td class="num" id="LN1109">1109</td><td class="line">    <span class='keyword'>int</span>		len;</td></tr>
<tr class="codeline" data-linenumber="1110"><td class="num" id="LN1110">1110</td><td class="line">    <span class='keyword'>int</span>		directly;</td></tr>
<tr class="codeline" data-linenumber="1111"><td class="num" id="LN1111">1111</td><td class="line">    linenr_T	lnum;</td></tr>
<tr class="codeline" data-linenumber="1112"><td class="num" id="LN1112">1112</td><td class="line">    char_u	*p;</td></tr>
<tr class="codeline" data-linenumber="1113"><td class="num" id="LN1113">1113</td><td class="line">    <span class='keyword'>int</span>		i;</td></tr>
<tr class="codeline" data-linenumber="1114"><td class="num" id="LN1114">1114</td><td class="line">    <span class='keyword'>long</span>	error;</td></tr>
<tr class="codeline" data-linenumber="1115"><td class="num" id="LN1115">1115</td><td class="line">    <span class='keyword'>int</span>		cannot_open;</td></tr>
<tr class="codeline" data-linenumber="1116"><td class="num" id="LN1116">1116</td><td class="line">    linenr_T	line_count;</td></tr>
<tr class="codeline" data-linenumber="1117"><td class="num" id="LN1117">1117</td><td class="line">    <span class='keyword'>int</span>		has_error;</td></tr>
<tr class="codeline" data-linenumber="1118"><td class="num" id="LN1118">1118</td><td class="line">    <span class='keyword'>int</span>		idx;</td></tr>
<tr class="codeline" data-linenumber="1119"><td class="num" id="LN1119">1119</td><td class="line">    <span class='keyword'>int</span>		top;</td></tr>
<tr class="codeline" data-linenumber="1120"><td class="num" id="LN1120">1120</td><td class="line">    <span class='keyword'>int</span>		txt_start;</td></tr>
<tr class="codeline" data-linenumber="1121"><td class="num" id="LN1121">1121</td><td class="line">    off_T	size;</td></tr>
<tr class="codeline" data-linenumber="1122"><td class="num" id="LN1122">1122</td><td class="line">    <span class='keyword'>int</span>		called_from_main;</td></tr>
<tr class="codeline" data-linenumber="1123"><td class="num" id="LN1123">1123</td><td class="line">    <span class='keyword'>int</span>		serious_error = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1124"><td class="num" id="LN1124">1124</td><td class="line">    <span class='keyword'>long</span>	mtime;</td></tr>
<tr class="codeline" data-linenumber="1125"><td class="num" id="LN1125">1125</td><td class="line">    <span class='keyword'>int</span>		attr;</td></tr>
<tr class="codeline" data-linenumber="1126"><td class="num" id="LN1126">1126</td><td class="line">    <span class='keyword'>int</span>		orig_file_status = <span class='macro'>NOTDONE<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1127"><td class="num" id="LN1127">1127</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1128"><td class="num" id="LN1128">1128</td><td class="line">    recoverymode = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1129"><td class="num" id="LN1129">1129</td><td class="line">    called_from_main = (curbuf-&gt;b_ml.ml_mfp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1130"><td class="num" id="LN1130">1130</td><td class="line">    attr = <span class='macro'>HL_ATTR(HLF_E)<span class='macro_popup'>highlight_attr[(int)(HLF_E)]</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1131"><td class="num" id="LN1131">1131</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1132"><td class="num" id="LN1132">1132</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1133"><td class="num" id="LN1133">1133</td><td class="line">     <span class='comment'>* If the file name ends in ".s[a-w][a-z]" we assume this is the swap file.</span></td></tr>
<tr class="codeline" data-linenumber="1134"><td class="num" id="LN1134">1134</td><td class="line">     <span class='comment'>* Otherwise a search is done to find the swap file(s).</span></td></tr>
<tr class="codeline" data-linenumber="1135"><td class="num" id="LN1135">1135</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1136"><td class="num" id="LN1136">1136</td><td class="line">    fname = curbuf-&gt;b_fname;</td></tr>
<tr class="codeline" data-linenumber="1137"><td class="num" id="LN1137">1137</td><td class="line">    <span class='keyword'>if</span> (fname == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)		    <span class='comment'>// When there is no file name</span></td></tr>
<tr class="codeline" data-linenumber="1138"><td class="num" id="LN1138">1138</td><td class="line">	fname = (char_u *)<span class='string_literal'>""</span>;</td></tr>
<tr class="codeline" data-linenumber="1139"><td class="num" id="LN1139">1139</td><td class="line">    len = (<span class='keyword'>int</span>)<span class='macro'>STRLEN(fname)<span class='macro_popup'>strlen((char *)(fname))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1140"><td class="num" id="LN1140">1140</td><td class="line">    <span class='keyword'>if</span> (checkext &amp;&amp; len &gt;= 4 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1141"><td class="num" id="LN1141">1141</td><td class="line"><span class='directive'>#if defined(VMS)</span></td></tr>
<tr class="codeline" data-linenumber="1142"><td class="num" id="LN1142">1142</td><td class="line">	    <span class='macro'>STRNICMP(fname + len - 4, <span class='string_literal'>"_s"</span>, 2)<span class='macro_popup'>strncasecmp((char *)(fname + len - 4), (char *)("_s"), (size_t<br>)(2))</span></span></td></tr>
<tr class="codeline" data-linenumber="1143"><td class="num" id="LN1143">1143</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="1144"><td class="num" id="LN1144">1144</td><td class="line">	    <span class='macro'>STRNICMP(fname + len - 4, <span class='string_literal'>".s"</span>, 2)<span class='macro_popup'>strncasecmp((char *)(fname + len - 4), (char *)(".s"), (size_t<br>)(2))</span></span></td></tr>
<tr class="codeline" data-linenumber="1145"><td class="num" id="LN1145">1145</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1146"><td class="num" id="LN1146">1146</td><td class="line">						== 0</td></tr>
<tr class="codeline" data-linenumber="1147"><td class="num" id="LN1147">1147</td><td class="line">		&amp;&amp; vim_strchr((char_u *)<span class='string_literal'>"abcdefghijklmnopqrstuvw"</span>,</td></tr>
<tr class="codeline" data-linenumber="1148"><td class="num" id="LN1148">1148</td><td class="line">					   <span class='macro'>TOLOWER_ASC(fname[len - 2])<span class='macro_popup'>(((fname[len - 2]) &lt; 'A' || (fname[len - 2]) &gt; 'Z') ? (<br>fname[len - 2]) : (fname[len - 2]) + ('a' - 'A'))</span></span>) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="1149"><td class="num" id="LN1149">1149</td><td class="line">		&amp;&amp; <span class='macro'>ASCII_ISALPHA(fname[len - 1])<span class='macro_popup'>(((unsigned)(fname[len - 1]) - 'A' &lt; 26) || ((unsigned)(fname<br>[len - 1]) - 'a' &lt; 26))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1150"><td class="num" id="LN1150">1150</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1151"><td class="num" id="LN1151">1151</td><td class="line">	directly = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1152"><td class="num" id="LN1152">1152</td><td class="line">	fname_used = vim_strsave(fname); <span class='comment'>// make a copy for mf_open()</span></td></tr>
<tr class="codeline" data-linenumber="1153"><td class="num" id="LN1153">1153</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1154"><td class="num" id="LN1154">1154</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1155"><td class="num" id="LN1155">1155</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1156"><td class="num" id="LN1156">1156</td><td class="line">	directly = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1157"><td class="num" id="LN1157">1157</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1158"><td class="num" id="LN1158">1158</td><td class="line">	<span class='comment'>// count the number of matching swap files</span></td></tr>
<tr class="codeline" data-linenumber="1159"><td class="num" id="LN1159">1159</td><td class="line">	len = recover_names(fname, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>, 0, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1160"><td class="num" id="LN1160">1160</td><td class="line">	<span class='keyword'>if</span> (len == 0)		    <span class='comment'>// no swap files found</span></td></tr>
<tr class="codeline" data-linenumber="1161"><td class="num" id="LN1161">1161</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="1162"><td class="num" id="LN1162">1162</td><td class="line">	    semsg(<span class='macro'>_(<span class='string_literal'>"E305: No swap file found for %s"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E305: No swap file found for %s"<br>), 5)</span></span>, fname);</td></tr>
<tr class="codeline" data-linenumber="1163"><td class="num" id="LN1163">1163</td><td class="line">	    <span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="1164"><td class="num" id="LN1164">1164</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1165"><td class="num" id="LN1165">1165</td><td class="line">	<span class='keyword'>if</span> (len == 1)		    <span class='comment'>// one swap file found, use it</span></td></tr>
<tr class="codeline" data-linenumber="1166"><td class="num" id="LN1166">1166</td><td class="line">	    i = 1;</td></tr>
<tr class="codeline" data-linenumber="1167"><td class="num" id="LN1167">1167</td><td class="line">	<span class='keyword'>else</span>			    <span class='comment'>// several swap files found, choose</span></td></tr>
<tr class="codeline" data-linenumber="1168"><td class="num" id="LN1168">1168</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="1169"><td class="num" id="LN1169">1169</td><td class="line">	    <span class='comment'>// list the names of the swap files</span></td></tr>
<tr class="codeline" data-linenumber="1170"><td class="num" id="LN1170">1170</td><td class="line">	    (<span class='keyword'>void</span>)recover_names(fname, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>, 0, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1171"><td class="num" id="LN1171">1171</td><td class="line">	    msg_putchar('\n');</td></tr>
<tr class="codeline" data-linenumber="1172"><td class="num" id="LN1172">1172</td><td class="line">	    msg_puts(<span class='macro'>_(<span class='string_literal'>"Enter number of swap file to use (0 to quit): "</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("Enter number of swap file to use (0 to quit): "<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1173"><td class="num" id="LN1173">1173</td><td class="line">	    i = get_number(<span class='macro'>FALSE<span class='macro_popup'>0</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1174"><td class="num" id="LN1174">1174</td><td class="line">	    <span class='keyword'>if</span> (i &lt; 1 || i &gt; len)</td></tr>
<tr class="codeline" data-linenumber="1175"><td class="num" id="LN1175">1175</td><td class="line">		<span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="1176"><td class="num" id="LN1176">1176</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1177"><td class="num" id="LN1177">1177</td><td class="line">	<span class='comment'>// get the swap file name that will be used</span></td></tr>
<tr class="codeline" data-linenumber="1178"><td class="num" id="LN1178">1178</td><td class="line">	(<span class='keyword'>void</span>)recover_names(fname, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>, i, &amp;fname_used);</td></tr>
<tr class="codeline" data-linenumber="1179"><td class="num" id="LN1179">1179</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1180"><td class="num" id="LN1180">1180</td><td class="line">    <span class='keyword'>if</span> (fname_used == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1181"><td class="num" id="LN1181">1181</td><td class="line">	<span class='keyword'>goto</span> theend;			<span class='comment'>// out of memory</span></td></tr>
<tr class="codeline" data-linenumber="1182"><td class="num" id="LN1182">1182</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1183"><td class="num" id="LN1183">1183</td><td class="line">    <span class='comment'>// When called from main() still need to initialize storage structure</span></td></tr>
<tr class="codeline" data-linenumber="1184"><td class="num" id="LN1184">1184</td><td class="line">    <span class='keyword'>if</span> (called_from_main &amp;&amp; ml_open(curbuf) == <span class='macro'>FAIL<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1185"><td class="num" id="LN1185">1185</td><td class="line">	getout(1);</td></tr>
<tr class="codeline" data-linenumber="1186"><td class="num" id="LN1186">1186</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1187"><td class="num" id="LN1187">1187</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1188"><td class="num" id="LN1188">1188</td><td class="line">     <span class='comment'>* Allocate a buffer structure for the swap file that is used for recovery.</span></td></tr>
<tr class="codeline" data-linenumber="1189"><td class="num" id="LN1189">1189</td><td class="line">     <span class='comment'>* Only the memline and crypt information in it are really used.</span></td></tr>
<tr class="codeline" data-linenumber="1190"><td class="num" id="LN1190">1190</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1191"><td class="num" id="LN1191">1191</td><td class="line">    buf = <span class='macro'>ALLOC_ONE(buf_T)<span class='macro_popup'>(buf_T *)alloc(sizeof(buf_T))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1192"><td class="num" id="LN1192">1192</td><td class="line">    <span class='keyword'>if</span> (buf == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1193"><td class="num" id="LN1193">1193</td><td class="line">	<span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="1194"><td class="num" id="LN1194">1194</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1195"><td class="num" id="LN1195">1195</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1196"><td class="num" id="LN1196">1196</td><td class="line">     <span class='comment'>* init fields in memline struct</span></td></tr>
<tr class="codeline" data-linenumber="1197"><td class="num" id="LN1197">1197</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1198"><td class="num" id="LN1198">1198</td><td class="line">    buf-&gt;b_ml.ml_stack_size = 0;	<span class='comment'>// no stack yet</span></td></tr>
<tr class="codeline" data-linenumber="1199"><td class="num" id="LN1199">1199</td><td class="line">    buf-&gt;b_ml.ml_stack = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;		<span class='comment'>// no stack yet</span></td></tr>
<tr class="codeline" data-linenumber="1200"><td class="num" id="LN1200">1200</td><td class="line">    buf-&gt;b_ml.ml_stack_top = 0;		<span class='comment'>// nothing in the stack</span></td></tr>
<tr class="codeline" data-linenumber="1201"><td class="num" id="LN1201">1201</td><td class="line">    buf-&gt;b_ml.ml_line_lnum = 0;		<span class='comment'>// no cached line</span></td></tr>
<tr class="codeline" data-linenumber="1202"><td class="num" id="LN1202">1202</td><td class="line">    buf-&gt;b_ml.ml_locked = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;		<span class='comment'>// no locked block</span></td></tr>
<tr class="codeline" data-linenumber="1203"><td class="num" id="LN1203">1203</td><td class="line">    buf-&gt;b_ml.ml_flags = 0;</td></tr>
<tr class="codeline" data-linenumber="1204"><td class="num" id="LN1204">1204</td><td class="line"><span class='directive'>#ifdef FEAT_CRYPT</span></td></tr>
<tr class="codeline" data-linenumber="1205"><td class="num" id="LN1205">1205</td><td class="line">    buf-&gt;b_p_key = empty_option;</td></tr>
<tr class="codeline" data-linenumber="1206"><td class="num" id="LN1206">1206</td><td class="line">    buf-&gt;b_p_cm = empty_option;</td></tr>
<tr class="codeline" data-linenumber="1207"><td class="num" id="LN1207">1207</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1208"><td class="num" id="LN1208">1208</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1209"><td class="num" id="LN1209">1209</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1210"><td class="num" id="LN1210">1210</td><td class="line">     <span class='comment'>* open the memfile from the old swap file</span></td></tr>
<tr class="codeline" data-linenumber="1211"><td class="num" id="LN1211">1211</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1212"><td class="num" id="LN1212">1212</td><td class="line">    p = vim_strsave(fname_used); <span class='comment'>// save "fname_used" for the message:</span></td></tr>
<tr class="codeline" data-linenumber="1213"><td class="num" id="LN1213">1213</td><td class="line">				 <span class='comment'>// mf_open() will consume "fname_used"!</span></td></tr>
<tr class="codeline" data-linenumber="1214"><td class="num" id="LN1214">1214</td><td class="line">    mfp = mf_open(fname_used, <span class='macro'>O_RDONLY<span class='macro_popup'>00</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1215"><td class="num" id="LN1215">1215</td><td class="line">    fname_used = p;</td></tr>
<tr class="codeline" data-linenumber="1216"><td class="num" id="LN1216">1216</td><td class="line">    <span class='keyword'>if</span> (mfp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || mfp-&gt;mf_fd &lt; 0)</td></tr>
<tr class="codeline" data-linenumber="1217"><td class="num" id="LN1217">1217</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1218"><td class="num" id="LN1218">1218</td><td class="line">	<span class='keyword'>if</span> (fname_used != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1219"><td class="num" id="LN1219">1219</td><td class="line">	    semsg(<span class='macro'>_(<span class='string_literal'>"E306: Cannot open %s"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E306: Cannot open %s"), 5)</span></span>, fname_used);</td></tr>
<tr class="codeline" data-linenumber="1220"><td class="num" id="LN1220">1220</td><td class="line">	<span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="1221"><td class="num" id="LN1221">1221</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1222"><td class="num" id="LN1222">1222</td><td class="line">    buf-&gt;b_ml.ml_mfp = mfp;</td></tr>
<tr class="codeline" data-linenumber="1223"><td class="num" id="LN1223">1223</td><td class="line"><span class='directive'>#ifdef FEAT_CRYPT</span></td></tr>
<tr class="codeline" data-linenumber="1224"><td class="num" id="LN1224">1224</td><td class="line">    mfp-&gt;mf_buffer = buf;</td></tr>
<tr class="codeline" data-linenumber="1225"><td class="num" id="LN1225">1225</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1226"><td class="num" id="LN1226">1226</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1227"><td class="num" id="LN1227">1227</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1228"><td class="num" id="LN1228">1228</td><td class="line">     <span class='comment'>* The page size set in mf_open() might be different from the page size</span></td></tr>
<tr class="codeline" data-linenumber="1229"><td class="num" id="LN1229">1229</td><td class="line">     <span class='comment'>* used in the swap file, we must get it from block 0.  But to read block</span></td></tr>
<tr class="codeline" data-linenumber="1230"><td class="num" id="LN1230">1230</td><td class="line">     <span class='comment'>* 0 we need a page size.  Use the minimal size for block 0 here, it will</span></td></tr>
<tr class="codeline" data-linenumber="1231"><td class="num" id="LN1231">1231</td><td class="line">     <span class='comment'>* be set to the real value below.</span></td></tr>
<tr class="codeline" data-linenumber="1232"><td class="num" id="LN1232">1232</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1233"><td class="num" id="LN1233">1233</td><td class="line">    mfp-&gt;mf_page_size = <span class='macro'>MIN_SWAP_PAGE_SIZE<span class='macro_popup'>1048</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1234"><td class="num" id="LN1234">1234</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1235"><td class="num" id="LN1235">1235</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1236"><td class="num" id="LN1236">1236</td><td class="line">     <span class='comment'>* try to read block 0</span></td></tr>
<tr class="codeline" data-linenumber="1237"><td class="num" id="LN1237">1237</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1238"><td class="num" id="LN1238">1238</td><td class="line">    <span class='keyword'>if</span> ((hp = mf_get(mfp, (blocknr_T)0, 1)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1239"><td class="num" id="LN1239">1239</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1240"><td class="num" id="LN1240">1240</td><td class="line">	msg_start();</td></tr>
<tr class="codeline" data-linenumber="1241"><td class="num" id="LN1241">1241</td><td class="line">	msg_puts_attr(<span class='macro'>_(<span class='string_literal'>"Unable to read block 0 from "</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("Unable to read block 0 from "<br>), 5)</span></span>, attr | <span class='macro'>MSG_HIST<span class='macro_popup'>0x1000</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1242"><td class="num" id="LN1242">1242</td><td class="line">	msg_outtrans_attr(mfp-&gt;mf_fname, attr | <span class='macro'>MSG_HIST<span class='macro_popup'>0x1000</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1243"><td class="num" id="LN1243">1243</td><td class="line">	msg_puts_attr(<span class='macro'>_(<span class='string_literal'>"\nMaybe no changes were made or Vim did not update the swap file."</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("\nMaybe no changes were made or Vim did not update the swap file."<br>), 5)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1244"><td class="num" id="LN1244">1244</td><td class="line">		attr | <span class='macro'>MSG_HIST<span class='macro_popup'>0x1000</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1245"><td class="num" id="LN1245">1245</td><td class="line">	msg_end();</td></tr>
<tr class="codeline" data-linenumber="1246"><td class="num" id="LN1246">1246</td><td class="line">	<span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="1247"><td class="num" id="LN1247">1247</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1248"><td class="num" id="LN1248">1248</td><td class="line">    b0p = (ZERO_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="1249"><td class="num" id="LN1249">1249</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>STRNCMP(b0p-&gt;b0_version, <span class='string_literal'>"VIM 3.0"</span>, 7)<span class='macro_popup'>strncmp((char *)(b0p-&gt;b0_version), (char *)("VIM 3.0"), (size_t<br>)(7))</span></span> == 0)</td></tr>
<tr class="codeline" data-linenumber="1250"><td class="num" id="LN1250">1250</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1251"><td class="num" id="LN1251">1251</td><td class="line">	msg_start();</td></tr>
<tr class="codeline" data-linenumber="1252"><td class="num" id="LN1252">1252</td><td class="line">	msg_outtrans_attr(mfp-&gt;mf_fname, <span class='macro'>MSG_HIST<span class='macro_popup'>0x1000</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1253"><td class="num" id="LN1253">1253</td><td class="line">	msg_puts_attr(<span class='macro'>_(<span class='string_literal'>" cannot be used with this version of Vim.\n"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)(" cannot be used with this version of Vim.\n"<br>), 5)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1254"><td class="num" id="LN1254">1254</td><td class="line">								    <span class='macro'>MSG_HIST<span class='macro_popup'>0x1000</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1255"><td class="num" id="LN1255">1255</td><td class="line">	msg_puts_attr(<span class='macro'>_(<span class='string_literal'>"Use Vim version 3.0.\n"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("Use Vim version 3.0.\n"), 5)</span></span>, <span class='macro'>MSG_HIST<span class='macro_popup'>0x1000</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1256"><td class="num" id="LN1256">1256</td><td class="line">	msg_end();</td></tr>
<tr class="codeline" data-linenumber="1257"><td class="num" id="LN1257">1257</td><td class="line">	<span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="1258"><td class="num" id="LN1258">1258</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1259"><td class="num" id="LN1259">1259</td><td class="line">    <span class='keyword'>if</span> (ml_check_b0_id(b0p) == <span class='macro'>FAIL<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1260"><td class="num" id="LN1260">1260</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1261"><td class="num" id="LN1261">1261</td><td class="line">	semsg(<span class='macro'>_(<span class='string_literal'>"E307: %s does not look like a Vim swap file"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E307: %s does not look like a Vim swap file"<br>), 5)</span></span>, mfp-&gt;mf_fname);</td></tr>
<tr class="codeline" data-linenumber="1262"><td class="num" id="LN1262">1262</td><td class="line">	<span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="1263"><td class="num" id="LN1263">1263</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1264"><td class="num" id="LN1264">1264</td><td class="line">    <span class='keyword'>if</span> (b0_magic_wrong(b0p))</td></tr>
<tr class="codeline" data-linenumber="1265"><td class="num" id="LN1265">1265</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1266"><td class="num" id="LN1266">1266</td><td class="line">	msg_start();</td></tr>
<tr class="codeline" data-linenumber="1267"><td class="num" id="LN1267">1267</td><td class="line">	msg_outtrans_attr(mfp-&gt;mf_fname, attr | <span class='macro'>MSG_HIST<span class='macro_popup'>0x1000</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1268"><td class="num" id="LN1268">1268</td><td class="line"><span class='directive'>#if defined(MSWIN)</span></td></tr>
<tr class="codeline" data-linenumber="1269"><td class="num" id="LN1269">1269</td><td class="line">	<span class='keyword'>if</span> (<span class='macro'>STRNCMP(b0p-&gt;b0_hname, <span class='string_literal'>"PC "</span>, 3)<span class='macro_popup'>strncmp((char *)(b0p-&gt;b0_hname), (char *)("PC "), (size_t)<br>(3))</span></span> == 0)</td></tr>
<tr class="codeline" data-linenumber="1270"><td class="num" id="LN1270">1270</td><td class="line">	    msg_puts_attr(<span class='macro'>_(<span class='string_literal'>" cannot be used with this version of Vim.\n"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)(" cannot be used with this version of Vim.\n"<br>), 5)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1271"><td class="num" id="LN1271">1271</td><td class="line">							     attr | <span class='macro'>MSG_HIST<span class='macro_popup'>0x1000</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1272"><td class="num" id="LN1272">1272</td><td class="line">	<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1273"><td class="num" id="LN1273">1273</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1274"><td class="num" id="LN1274">1274</td><td class="line">	    msg_puts_attr(<span class='macro'>_(<span class='string_literal'>" cannot be used on this computer.\n"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)(" cannot be used on this computer.\n"<br>), 5)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1275"><td class="num" id="LN1275">1275</td><td class="line">							     attr | <span class='macro'>MSG_HIST<span class='macro_popup'>0x1000</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1276"><td class="num" id="LN1276">1276</td><td class="line">	msg_puts_attr(<span class='macro'>_(<span class='string_literal'>"The file was created on "</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("The file was created on "), 5<br>)</span></span>, attr | <span class='macro'>MSG_HIST<span class='macro_popup'>0x1000</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1277"><td class="num" id="LN1277">1277</td><td class="line">	<span class='comment'>// avoid going past the end of a corrupted hostname</span></td></tr>
<tr class="codeline" data-linenumber="1278"><td class="num" id="LN1278">1278</td><td class="line">	b0p-&gt;b0_fname[0] = <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1279"><td class="num" id="LN1279">1279</td><td class="line">	msg_puts_attr((<span class='keyword'>char</span> *)b0p-&gt;b0_hname, attr | <span class='macro'>MSG_HIST<span class='macro_popup'>0x1000</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1280"><td class="num" id="LN1280">1280</td><td class="line">	msg_puts_attr(<span class='macro'>_(<span class='string_literal'>",\nor the file has been damaged."</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)(",\nor the file has been damaged."<br>), 5)</span></span>, attr | <span class='macro'>MSG_HIST<span class='macro_popup'>0x1000</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1281"><td class="num" id="LN1281">1281</td><td class="line">	msg_end();</td></tr>
<tr class="codeline" data-linenumber="1282"><td class="num" id="LN1282">1282</td><td class="line">	<span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="1283"><td class="num" id="LN1283">1283</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1284"><td class="num" id="LN1284">1284</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1285"><td class="num" id="LN1285">1285</td><td class="line"><span class='directive'>#ifdef FEAT_CRYPT</span></td></tr>
<tr class="codeline" data-linenumber="1286"><td class="num" id="LN1286">1286</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; (<span class='keyword'>int</span>)(<span class='keyword'>sizeof</span>(id1_codes) / <span class='keyword'>sizeof</span>(<span class='keyword'>int</span>)); ++i)</td></tr>
<tr class="codeline" data-linenumber="1287"><td class="num" id="LN1287">1287</td><td class="line">	<span class='keyword'>if</span> (id1_codes[i] == b0p-&gt;b0_id[1])</td></tr>
<tr class="codeline" data-linenumber="1288"><td class="num" id="LN1288">1288</td><td class="line">	    b0_cm = i;</td></tr>
<tr class="codeline" data-linenumber="1289"><td class="num" id="LN1289">1289</td><td class="line">    <span class='keyword'>if</span> (b0_cm &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="1290"><td class="num" id="LN1290">1290</td><td class="line">	<span class='macro'>mch_memmove(mfp-&gt;mf_seed, &amp;b0p-&gt;b0_seed, MF_SEED_LEN)<span class='macro_popup'>memmove((char *)(mfp-&gt;mf_seed), (char *)(&amp;b0p-&gt;b0_fname<br>[900 - 2 - 8]), 8)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1291"><td class="num" id="LN1291">1291</td><td class="line">    crypt_set_cm_option(buf, b0_cm &lt; 0 ? 0 : b0_cm);</td></tr>
<tr class="codeline" data-linenumber="1292"><td class="num" id="LN1292">1292</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="1293"><td class="num" id="LN1293">1293</td><td class="line">    <span class='keyword'>if</span> (b0p-&gt;b0_id[1] != <span class='macro'>BLOCK0_ID1<span class='macro_popup'>'0'</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1294"><td class="num" id="LN1294">1294</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1295"><td class="num" id="LN1295">1295</td><td class="line">	semsg(<span class='macro'>_(<span class='string_literal'>"E833: %s is encrypted and this version of Vim does not support encryption"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E833: %s is encrypted and this version of Vim does not support encryption"<br>), 5)</span></span>, mfp-&gt;mf_fname);</td></tr>
<tr class="codeline" data-linenumber="1296"><td class="num" id="LN1296">1296</td><td class="line">	<span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="1297"><td class="num" id="LN1297">1297</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1298"><td class="num" id="LN1298">1298</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1299"><td class="num" id="LN1299">1299</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1300"><td class="num" id="LN1300">1300</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1301"><td class="num" id="LN1301">1301</td><td class="line">     <span class='comment'>* If we guessed the wrong page size, we have to recalculate the</span></td></tr>
<tr class="codeline" data-linenumber="1302"><td class="num" id="LN1302">1302</td><td class="line">     <span class='comment'>* highest block number in the file.</span></td></tr>
<tr class="codeline" data-linenumber="1303"><td class="num" id="LN1303">1303</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1304"><td class="num" id="LN1304">1304</td><td class="line">    <span class='keyword'>if</span> (mfp-&gt;mf_page_size != (<span class='keyword'>unsigned</span>)char_to_long(b0p-&gt;b0_page_size))</td></tr>
<tr class="codeline" data-linenumber="1305"><td class="num" id="LN1305">1305</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1306"><td class="num" id="LN1306">1306</td><td class="line">	<span class='keyword'>unsigned</span> previous_page_size = mfp-&gt;mf_page_size;</td></tr>
<tr class="codeline" data-linenumber="1307"><td class="num" id="LN1307">1307</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1308"><td class="num" id="LN1308">1308</td><td class="line">	mf_new_page_size(mfp, (<span class='keyword'>unsigned</span>)char_to_long(b0p-&gt;b0_page_size));</td></tr>
<tr class="codeline" data-linenumber="1309"><td class="num" id="LN1309">1309</td><td class="line">	<span class='keyword'>if</span> (mfp-&gt;mf_page_size &lt; previous_page_size)</td></tr>
<tr class="codeline" data-linenumber="1310"><td class="num" id="LN1310">1310</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="1311"><td class="num" id="LN1311">1311</td><td class="line">	    msg_start();</td></tr>
<tr class="codeline" data-linenumber="1312"><td class="num" id="LN1312">1312</td><td class="line">	    msg_outtrans_attr(mfp-&gt;mf_fname, attr | <span class='macro'>MSG_HIST<span class='macro_popup'>0x1000</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1313"><td class="num" id="LN1313">1313</td><td class="line">	    msg_puts_attr(<span class='macro'>_(<span class='string_literal'>" has been damaged (page size is smaller than minimum value).\n"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)(" has been damaged (page size is smaller than minimum value).\n"<br>), 5)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1314"><td class="num" id="LN1314">1314</td><td class="line">			attr | <span class='macro'>MSG_HIST<span class='macro_popup'>0x1000</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1315"><td class="num" id="LN1315">1315</td><td class="line">	    msg_end();</td></tr>
<tr class="codeline" data-linenumber="1316"><td class="num" id="LN1316">1316</td><td class="line">	    <span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="1317"><td class="num" id="LN1317">1317</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1318"><td class="num" id="LN1318">1318</td><td class="line">	<span class='keyword'>if</span> ((size = <span class='macro'>vim_lseek<span class='macro_popup'>lseek</span></span>(mfp-&gt;mf_fd, (off_T)0L, <span class='macro'>SEEK_END<span class='macro_popup'>2</span></span>)) &lt;= 0)</td></tr>
<tr class="codeline" data-linenumber="1319"><td class="num" id="LN1319">1319</td><td class="line">	    mfp-&gt;mf_blocknr_max = 0;	    <span class='comment'>// no file or empty file</span></td></tr>
<tr class="codeline" data-linenumber="1320"><td class="num" id="LN1320">1320</td><td class="line">	<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1321"><td class="num" id="LN1321">1321</td><td class="line">	    mfp-&gt;mf_blocknr_max = (blocknr_T)(size / mfp-&gt;mf_page_size);</td></tr>
<tr class="codeline" data-linenumber="1322"><td class="num" id="LN1322">1322</td><td class="line">	mfp-&gt;mf_infile_count = mfp-&gt;mf_blocknr_max;</td></tr>
<tr class="codeline" data-linenumber="1323"><td class="num" id="LN1323">1323</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1324"><td class="num" id="LN1324">1324</td><td class="line">	<span class='comment'>// need to reallocate the memory used to store the data</span></td></tr>
<tr class="codeline" data-linenumber="1325"><td class="num" id="LN1325">1325</td><td class="line">	p = alloc(mfp-&gt;mf_page_size);</td></tr>
<tr class="codeline" data-linenumber="1326"><td class="num" id="LN1326">1326</td><td class="line">	<span class='keyword'>if</span> (p == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1327"><td class="num" id="LN1327">1327</td><td class="line">	    <span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="1328"><td class="num" id="LN1328">1328</td><td class="line">	<span class='macro'>mch_memmove(p, hp-&gt;bh_data, previous_page_size)<span class='macro_popup'>memmove((char *)(p), (char *)(hp-&gt;bh_data), previous_page_size<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1329"><td class="num" id="LN1329">1329</td><td class="line">	vim_free(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="1330"><td class="num" id="LN1330">1330</td><td class="line">	hp-&gt;bh_data = p;</td></tr>
<tr class="codeline" data-linenumber="1331"><td class="num" id="LN1331">1331</td><td class="line">	b0p = (ZERO_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="1332"><td class="num" id="LN1332">1332</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1333"><td class="num" id="LN1333">1333</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1334"><td class="num" id="LN1334">1334</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1335"><td class="num" id="LN1335">1335</td><td class="line">     <span class='comment'>* If .swp file name given directly, use name from swap file for buffer.</span></td></tr>
<tr class="codeline" data-linenumber="1336"><td class="num" id="LN1336">1336</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1337"><td class="num" id="LN1337">1337</td><td class="line">    <span class='keyword'>if</span> (directly)</td></tr>
<tr class="codeline" data-linenumber="1338"><td class="num" id="LN1338">1338</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1339"><td class="num" id="LN1339">1339</td><td class="line">	expand_env(b0p-&gt;b0_fname, NameBuff, <span class='macro'>MAXPATHL<span class='macro_popup'>4096</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1340"><td class="num" id="LN1340">1340</td><td class="line">	<span class='keyword'>if</span> (setfname(curbuf, NameBuff, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>) == <span class='macro'>FAIL<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1341"><td class="num" id="LN1341">1341</td><td class="line">	    <span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="1342"><td class="num" id="LN1342">1342</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1343"><td class="num" id="LN1343">1343</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1344"><td class="num" id="LN1344">1344</td><td class="line">    home_replace(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, mfp-&gt;mf_fname, NameBuff, <span class='macro'>MAXPATHL<span class='macro_popup'>4096</span></span>, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1345"><td class="num" id="LN1345">1345</td><td class="line">    smsg(<span class='macro'>_(<span class='string_literal'>"Using swap file \"%s\""</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("Using swap file \"%s\""), 5)</span></span>, NameBuff);</td></tr>
<tr class="codeline" data-linenumber="1346"><td class="num" id="LN1346">1346</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1347"><td class="num" id="LN1347">1347</td><td class="line">    <span class='keyword'>if</span> (buf_spname(curbuf) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1348"><td class="num" id="LN1348">1348</td><td class="line">	vim_strncpy(NameBuff, buf_spname(curbuf), <span class='macro'>MAXPATHL<span class='macro_popup'>4096</span></span> - 1);</td></tr>
<tr class="codeline" data-linenumber="1349"><td class="num" id="LN1349">1349</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1350"><td class="num" id="LN1350">1350</td><td class="line">	home_replace(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, curbuf-&gt;b_ffname, NameBuff, <span class='macro'>MAXPATHL<span class='macro_popup'>4096</span></span>, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1351"><td class="num" id="LN1351">1351</td><td class="line">    smsg(<span class='macro'>_(<span class='string_literal'>"Original file \"%s\""</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("Original file \"%s\""), 5)</span></span>, NameBuff);</td></tr>
<tr class="codeline" data-linenumber="1352"><td class="num" id="LN1352">1352</td><td class="line">    msg_putchar('\n');</td></tr>
<tr class="codeline" data-linenumber="1353"><td class="num" id="LN1353">1353</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1354"><td class="num" id="LN1354">1354</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1355"><td class="num" id="LN1355">1355</td><td class="line">     <span class='comment'>* check date of swap file and original file</span></td></tr>
<tr class="codeline" data-linenumber="1356"><td class="num" id="LN1356">1356</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1357"><td class="num" id="LN1357">1357</td><td class="line">    mtime = char_to_long(b0p-&gt;b0_mtime);</td></tr>
<tr class="codeline" data-linenumber="1358"><td class="num" id="LN1358">1358</td><td class="line">    <span class='keyword'>if</span> (curbuf-&gt;b_ffname != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="1359"><td class="num" id="LN1359">1359</td><td class="line">	    &amp;&amp; <span class='macro'>mch_stat((<span class='keyword'>char</span> *)curbuf-&gt;b_ffname, &amp;org_stat)<span class='macro_popup'>stat(((char *)curbuf-&gt;b_ffname), (&amp;org_stat))</span></span> != -1</td></tr>
<tr class="codeline" data-linenumber="1360"><td class="num" id="LN1360">1360</td><td class="line">	    &amp;&amp; ((<span class='macro'>mch_stat((<span class='keyword'>char</span> *)mfp-&gt;mf_fname, &amp;swp_stat)<span class='macro_popup'>stat(((char *)mfp-&gt;mf_fname), (&amp;swp_stat))</span></span> != -1</td></tr>
<tr class="codeline" data-linenumber="1361"><td class="num" id="LN1361">1361</td><td class="line">		    &amp;&amp; org_stat.<span class='macro'>st_mtime<span class='macro_popup'>st_mtim.tv_sec</span></span> &gt; swp_stat.<span class='macro'>st_mtime<span class='macro_popup'>st_mtim.tv_sec</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1362"><td class="num" id="LN1362">1362</td><td class="line">		|| org_stat.<span class='macro'>st_mtime<span class='macro_popup'>st_mtim.tv_sec</span></span> != mtime))</td></tr>
<tr class="codeline" data-linenumber="1363"><td class="num" id="LN1363">1363</td><td class="line">	emsg(<span class='macro'>_(<span class='string_literal'>"E308: Warning: Original file may have been changed"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E308: Warning: Original file may have been changed"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1364"><td class="num" id="LN1364">1364</td><td class="line">    out_flush();</td></tr>
<tr class="codeline" data-linenumber="1365"><td class="num" id="LN1365">1365</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1366"><td class="num" id="LN1366">1366</td><td class="line">    <span class='comment'>// Get the 'fileformat' and 'fileencoding' from block zero.</span></td></tr>
<tr class="codeline" data-linenumber="1367"><td class="num" id="LN1367">1367</td><td class="line">    b0_ff = (b0p-&gt;<span class='macro'>b0_flags<span class='macro_popup'>b0_fname[900 - 2]</span></span> &amp; <span class='macro'>B0_FF_MASK<span class='macro_popup'>3</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1368"><td class="num" id="LN1368">1368</td><td class="line">    <span class='keyword'>if</span> (b0p-&gt;<span class='macro'>b0_flags<span class='macro_popup'>b0_fname[900 - 2]</span></span> &amp; <span class='macro'>B0_HAS_FENC<span class='macro_popup'>8</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1369"><td class="num" id="LN1369">1369</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1370"><td class="num" id="LN1370">1370</td><td class="line">	<span class='keyword'>int</span> fnsize = <span class='macro'>B0_FNAME_SIZE_NOCRYPT<span class='macro_popup'>898</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1371"><td class="num" id="LN1371">1371</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1372"><td class="num" id="LN1372">1372</td><td class="line"><span class='directive'>#ifdef FEAT_CRYPT</span></td></tr>
<tr class="codeline" data-linenumber="1373"><td class="num" id="LN1373">1373</td><td class="line">	<span class='comment'>// Use the same size as in add_b0_fenc().</span></td></tr>
<tr class="codeline" data-linenumber="1374"><td class="num" id="LN1374">1374</td><td class="line">	<span class='keyword'>if</span> (b0p-&gt;b0_id[1] != <span class='macro'>BLOCK0_ID1<span class='macro_popup'>'0'</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1375"><td class="num" id="LN1375">1375</td><td class="line">	    fnsize = <span class='macro'>B0_FNAME_SIZE_CRYPT<span class='macro_popup'>890</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1376"><td class="num" id="LN1376">1376</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1377"><td class="num" id="LN1377">1377</td><td class="line">	<span class='keyword'>for</span> (p = b0p-&gt;b0_fname + fnsize; p &gt; b0p-&gt;b0_fname &amp;&amp; p[-1] != <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>; --p)</td></tr>
<tr class="codeline" data-linenumber="1378"><td class="num" id="LN1378">1378</td><td class="line">	    ;</td></tr>
<tr class="codeline" data-linenumber="1379"><td class="num" id="LN1379">1379</td><td class="line">	b0_fenc = vim_strnsave(p, b0p-&gt;b0_fname + fnsize - p);</td></tr>
<tr class="codeline" data-linenumber="1380"><td class="num" id="LN1380">1380</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1381"><td class="num" id="LN1381">1381</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1382"><td class="num" id="LN1382">1382</td><td class="line">    mf_put(mfp, hp, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);	<span class='comment'>// release block 0</span></td></tr>
<tr class="codeline" data-linenumber="1383"><td class="num" id="LN1383">1383</td><td class="line">    hp = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1384"><td class="num" id="LN1384">1384</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1385"><td class="num" id="LN1385">1385</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1386"><td class="num" id="LN1386">1386</td><td class="line">     <span class='comment'>* Now that we are sure that the file is going to be recovered, clear the</span></td></tr>
<tr class="codeline" data-linenumber="1387"><td class="num" id="LN1387">1387</td><td class="line">     <span class='comment'>* contents of the current buffer.</span></td></tr>
<tr class="codeline" data-linenumber="1388"><td class="num" id="LN1388">1388</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1389"><td class="num" id="LN1389">1389</td><td class="line">    <span class='keyword'>while</span> (!(curbuf-&gt;b_ml.ml_flags &amp; <span class='macro'>ML_EMPTY<span class='macro_popup'>1</span></span>))</td></tr>
<tr class="codeline" data-linenumber="1390"><td class="num" id="LN1390">1390</td><td class="line">	ml_delete((linenr_T)1);</td></tr>
<tr class="codeline" data-linenumber="1391"><td class="num" id="LN1391">1391</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1392"><td class="num" id="LN1392">1392</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1393"><td class="num" id="LN1393">1393</td><td class="line">     <span class='comment'>* Try reading the original file to obtain the values of 'fileformat',</span></td></tr>
<tr class="codeline" data-linenumber="1394"><td class="num" id="LN1394">1394</td><td class="line">     <span class='comment'>* 'fileencoding', etc.  Ignore errors.  The text itself is not used.</span></td></tr>
<tr class="codeline" data-linenumber="1395"><td class="num" id="LN1395">1395</td><td class="line">     <span class='comment'>* When the file is encrypted the user is asked to enter the key.</span></td></tr>
<tr class="codeline" data-linenumber="1396"><td class="num" id="LN1396">1396</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1397"><td class="num" id="LN1397">1397</td><td class="line">    <span class='keyword'>if</span> (curbuf-&gt;b_ffname != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1398"><td class="num" id="LN1398">1398</td><td class="line">	orig_file_status = readfile(curbuf-&gt;b_ffname, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, (linenr_T)0,</td></tr>
<tr class="codeline" data-linenumber="1399"><td class="num" id="LN1399">1399</td><td class="line">			      (linenr_T)0, (linenr_T)<span class='macro'>MAXLNUM<span class='macro_popup'>9223372036854775807L</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>READ_NEW<span class='macro_popup'>0x01</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1400"><td class="num" id="LN1400">1400</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1401"><td class="num" id="LN1401">1401</td><td class="line"><span class='directive'>#ifdef FEAT_CRYPT</span></td></tr>
<tr class="codeline" data-linenumber="1402"><td class="num" id="LN1402">1402</td><td class="line">    <span class='keyword'>if</span> (b0_cm &gt;= 0)</td></tr>
<tr class="codeline" data-linenumber="1403"><td class="num" id="LN1403">1403</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1404"><td class="num" id="LN1404">1404</td><td class="line">	<span class='comment'>// Need to ask the user for the crypt key.  If this fails we continue</span></td></tr>
<tr class="codeline" data-linenumber="1405"><td class="num" id="LN1405">1405</td><td class="line">	<span class='comment'>// without a key, will probably get garbage text.</span></td></tr>
<tr class="codeline" data-linenumber="1406"><td class="num" id="LN1406">1406</td><td class="line">	<span class='keyword'>if</span> (*curbuf-&gt;b_p_key != <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1407"><td class="num" id="LN1407">1407</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="1408"><td class="num" id="LN1408">1408</td><td class="line">	    smsg(<span class='macro'>_(<span class='string_literal'>"Swap file is encrypted: \"%s\""</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("Swap file is encrypted: \"%s\""<br>), 5)</span></span>, fname_used);</td></tr>
<tr class="codeline" data-linenumber="1409"><td class="num" id="LN1409">1409</td><td class="line">	    msg_puts(<span class='macro'>_(<span class='string_literal'>"\nIf you entered a new crypt key but did not write the text file,"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("\nIf you entered a new crypt key but did not write the text file,"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1410"><td class="num" id="LN1410">1410</td><td class="line">	    msg_puts(<span class='macro'>_(<span class='string_literal'>"\nenter the new crypt key."</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("\nenter the new crypt key.")<br>, 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1411"><td class="num" id="LN1411">1411</td><td class="line">	    msg_puts(<span class='macro'>_(<span class='string_literal'>"\nIf you wrote the text file after changing the crypt key press enter"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("\nIf you wrote the text file after changing the crypt key press enter"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1412"><td class="num" id="LN1412">1412</td><td class="line">	    msg_puts(<span class='macro'>_(<span class='string_literal'>"\nto use the same key for text file and swap file"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("\nto use the same key for text file and swap file"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1413"><td class="num" id="LN1413">1413</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1414"><td class="num" id="LN1414">1414</td><td class="line">	<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1415"><td class="num" id="LN1415">1415</td><td class="line">	    smsg(<span class='macro'>_(need_key_msg)<span class='macro_popup'>dcgettext (((void*)0), (char *)(need_key_msg), 5)</span></span>, fname_used);</td></tr>
<tr class="codeline" data-linenumber="1416"><td class="num" id="LN1416">1416</td><td class="line">	buf-&gt;b_p_key = crypt_get_key(<span class='macro'>FALSE<span class='macro_popup'>0</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1417"><td class="num" id="LN1417">1417</td><td class="line">	<span class='keyword'>if</span> (buf-&gt;b_p_key == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1418"><td class="num" id="LN1418">1418</td><td class="line">	    buf-&gt;b_p_key = curbuf-&gt;b_p_key;</td></tr>
<tr class="codeline" data-linenumber="1419"><td class="num" id="LN1419">1419</td><td class="line">	<span class='keyword'>else</span> <span class='keyword'>if</span> (*buf-&gt;b_p_key == <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1420"><td class="num" id="LN1420">1420</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="1421"><td class="num" id="LN1421">1421</td><td class="line">	    vim_free(buf-&gt;b_p_key);</td></tr>
<tr class="codeline" data-linenumber="1422"><td class="num" id="LN1422">1422</td><td class="line">	    buf-&gt;b_p_key = curbuf-&gt;b_p_key;</td></tr>
<tr class="codeline" data-linenumber="1423"><td class="num" id="LN1423">1423</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1424"><td class="num" id="LN1424">1424</td><td class="line">	<span class='keyword'>if</span> (buf-&gt;b_p_key == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1425"><td class="num" id="LN1425">1425</td><td class="line">	    buf-&gt;b_p_key = empty_option;</td></tr>
<tr class="codeline" data-linenumber="1426"><td class="num" id="LN1426">1426</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1427"><td class="num" id="LN1427">1427</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1428"><td class="num" id="LN1428">1428</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1429"><td class="num" id="LN1429">1429</td><td class="line">    <span class='comment'>// Use the 'fileformat' and 'fileencoding' as stored in the swap file.</span></td></tr>
<tr class="codeline" data-linenumber="1430"><td class="num" id="LN1430">1430</td><td class="line">    <span class='keyword'>if</span> (b0_ff != 0)</td></tr>
<tr class="codeline" data-linenumber="1431"><td class="num" id="LN1431">1431</td><td class="line">	set_fileformat(b0_ff - 1, <span class='macro'>OPT_LOCAL<span class='macro_popup'>0x04</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1432"><td class="num" id="LN1432">1432</td><td class="line">    <span class='keyword'>if</span> (b0_fenc != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1433"><td class="num" id="LN1433">1433</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1434"><td class="num" id="LN1434">1434</td><td class="line">	set_option_value((char_u *)<span class='string_literal'>"fenc"</span>, 0L, b0_fenc, <span class='macro'>OPT_LOCAL<span class='macro_popup'>0x04</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1435"><td class="num" id="LN1435">1435</td><td class="line">	vim_free(b0_fenc);</td></tr>
<tr class="codeline" data-linenumber="1436"><td class="num" id="LN1436">1436</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1437"><td class="num" id="LN1437">1437</td><td class="line">    unchanged(curbuf, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1438"><td class="num" id="LN1438">1438</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1439"><td class="num" id="LN1439">1439</td><td class="line">    bnum = 1;		<span class='comment'>// start with block 1</span></td></tr>
<tr class="codeline" data-linenumber="1440"><td class="num" id="LN1440">1440</td><td class="line">    page_count = 1;	<span class='comment'>// which is 1 page</span></td></tr>
<tr class="codeline" data-linenumber="1441"><td class="num" id="LN1441">1441</td><td class="line">    lnum = 0;		<span class='comment'>// append after line 0 in curbuf</span></td></tr>
<tr class="codeline" data-linenumber="1442"><td class="num" id="LN1442">1442</td><td class="line">    line_count = 0;</td></tr>
<tr class="codeline" data-linenumber="1443"><td class="num" id="LN1443">1443</td><td class="line">    idx = 0;		<span class='comment'>// start with first index in block 1</span></td></tr>
<tr class="codeline" data-linenumber="1444"><td class="num" id="LN1444">1444</td><td class="line">    error = 0;</td></tr>
<tr class="codeline" data-linenumber="1445"><td class="num" id="LN1445">1445</td><td class="line">    buf-&gt;b_ml.ml_stack_top = 0;</td></tr>
<tr class="codeline" data-linenumber="1446"><td class="num" id="LN1446">1446</td><td class="line">    buf-&gt;b_ml.ml_stack = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1447"><td class="num" id="LN1447">1447</td><td class="line">    buf-&gt;b_ml.ml_stack_size = 0;	<span class='comment'>// no stack yet</span></td></tr>
<tr class="codeline" data-linenumber="1448"><td class="num" id="LN1448">1448</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1449"><td class="num" id="LN1449">1449</td><td class="line">    <span class='keyword'>if</span> (curbuf-&gt;b_ffname == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1450"><td class="num" id="LN1450">1450</td><td class="line">	cannot_open = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1451"><td class="num" id="LN1451">1451</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1452"><td class="num" id="LN1452">1452</td><td class="line">	cannot_open = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1453"><td class="num" id="LN1453">1453</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1454"><td class="num" id="LN1454">1454</td><td class="line">    serious_error = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1455"><td class="num" id="LN1455">1455</td><td class="line">    <span class='keyword'>for</span> ( ; !got_int; line_breakcheck())</td></tr>
<tr class="codeline" data-linenumber="1456"><td class="num" id="LN1456">1456</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1457"><td class="num" id="LN1457">1457</td><td class="line">	<span class='keyword'>if</span> (hp != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1458"><td class="num" id="LN1458">1458</td><td class="line">	    mf_put(mfp, hp, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);	<span class='comment'>// release previous block</span></td></tr>
<tr class="codeline" data-linenumber="1459"><td class="num" id="LN1459">1459</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1460"><td class="num" id="LN1460">1460</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1461"><td class="num" id="LN1461">1461</td><td class="line">	 <span class='comment'>* get block</span></td></tr>
<tr class="codeline" data-linenumber="1462"><td class="num" id="LN1462">1462</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1463"><td class="num" id="LN1463">1463</td><td class="line">	<span class='keyword'>if</span> ((hp = mf_get(mfp, (blocknr_T)bnum, page_count)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1464"><td class="num" id="LN1464">1464</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="1465"><td class="num" id="LN1465">1465</td><td class="line">	    <span class='keyword'>if</span> (bnum == 1)</td></tr>
<tr class="codeline" data-linenumber="1466"><td class="num" id="LN1466">1466</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="1467"><td class="num" id="LN1467">1467</td><td class="line">		semsg(<span class='macro'>_(<span class='string_literal'>"E309: Unable to read block 1 from %s"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E309: Unable to read block 1 from %s"<br>), 5)</span></span>, mfp-&gt;mf_fname);</td></tr>
<tr class="codeline" data-linenumber="1468"><td class="num" id="LN1468">1468</td><td class="line">		<span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="1469"><td class="num" id="LN1469">1469</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="1470"><td class="num" id="LN1470">1470</td><td class="line">	    ++error;</td></tr>
<tr class="codeline" data-linenumber="1471"><td class="num" id="LN1471">1471</td><td class="line">	    ml_append(lnum++, (char_u *)<span class='macro'>_(<span class='string_literal'>"???MANY LINES MISSING"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("???MANY LINES MISSING"), 5)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1472"><td class="num" id="LN1472">1472</td><td class="line">							    (colnr_T)0, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1473"><td class="num" id="LN1473">1473</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1474"><td class="num" id="LN1474">1474</td><td class="line">	<span class='keyword'>else</span>		<span class='comment'>// there is a block</span></td></tr>
<tr class="codeline" data-linenumber="1475"><td class="num" id="LN1475">1475</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="1476"><td class="num" id="LN1476">1476</td><td class="line">	    pp = (PTR_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="1477"><td class="num" id="LN1477">1477</td><td class="line">	    <span class='keyword'>if</span> (pp-&gt;pb_id == <span class='macro'>PTR_ID<span class='macro_popup'>(('p' &lt;&lt; 8) + 't')</span></span>)		<span class='comment'>// it is a pointer block</span></td></tr>
<tr class="codeline" data-linenumber="1478"><td class="num" id="LN1478">1478</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="1479"><td class="num" id="LN1479">1479</td><td class="line">		<span class='comment'>// check line count when using pointer block first time</span></td></tr>
<tr class="codeline" data-linenumber="1480"><td class="num" id="LN1480">1480</td><td class="line">		<span class='keyword'>if</span> (idx == 0 &amp;&amp; line_count != 0)</td></tr>
<tr class="codeline" data-linenumber="1481"><td class="num" id="LN1481">1481</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="1482"><td class="num" id="LN1482">1482</td><td class="line">		    <span class='keyword'>for</span> (i = 0; i &lt; (<span class='keyword'>int</span>)pp-&gt;pb_count; ++i)</td></tr>
<tr class="codeline" data-linenumber="1483"><td class="num" id="LN1483">1483</td><td class="line">			line_count -= pp-&gt;pb_pointer[i].pe_line_count;</td></tr>
<tr class="codeline" data-linenumber="1484"><td class="num" id="LN1484">1484</td><td class="line">		    <span class='keyword'>if</span> (line_count != 0)</td></tr>
<tr class="codeline" data-linenumber="1485"><td class="num" id="LN1485">1485</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="1486"><td class="num" id="LN1486">1486</td><td class="line">			++error;</td></tr>
<tr class="codeline" data-linenumber="1487"><td class="num" id="LN1487">1487</td><td class="line">			ml_append(lnum++, (char_u *)<span class='macro'>_(<span class='string_literal'>"???LINE COUNT WRONG"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("???LINE COUNT WRONG"), 5)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1488"><td class="num" id="LN1488">1488</td><td class="line">							    (colnr_T)0, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1489"><td class="num" id="LN1489">1489</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="1490"><td class="num" id="LN1490">1490</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="1491"><td class="num" id="LN1491">1491</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1492"><td class="num" id="LN1492">1492</td><td class="line">		<span class='keyword'>if</span> (pp-&gt;pb_count == 0)</td></tr>
<tr class="codeline" data-linenumber="1493"><td class="num" id="LN1493">1493</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="1494"><td class="num" id="LN1494">1494</td><td class="line">		    ml_append(lnum++, (char_u *)<span class='macro'>_(<span class='string_literal'>"???EMPTY BLOCK"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("???EMPTY BLOCK"), 5)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1495"><td class="num" id="LN1495">1495</td><td class="line">							    (colnr_T)0, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1496"><td class="num" id="LN1496">1496</td><td class="line">		    ++error;</td></tr>
<tr class="codeline" data-linenumber="1497"><td class="num" id="LN1497">1497</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="1498"><td class="num" id="LN1498">1498</td><td class="line">		<span class='keyword'>else</span> <span class='keyword'>if</span> (idx &lt; (<span class='keyword'>int</span>)pp-&gt;pb_count)	<span class='comment'>// go a block deeper</span></td></tr>
<tr class="codeline" data-linenumber="1499"><td class="num" id="LN1499">1499</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="1500"><td class="num" id="LN1500">1500</td><td class="line">		    <span class='keyword'>if</span> (pp-&gt;pb_pointer[idx].pe_bnum &lt; 0)</td></tr>
<tr class="codeline" data-linenumber="1501"><td class="num" id="LN1501">1501</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="1502"><td class="num" id="LN1502">1502</td><td class="line">			<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1503"><td class="num" id="LN1503">1503</td><td class="line">			 <span class='comment'>* Data block with negative block number.</span></td></tr>
<tr class="codeline" data-linenumber="1504"><td class="num" id="LN1504">1504</td><td class="line">			 <span class='comment'>* Try to read lines from the original file.</span></td></tr>
<tr class="codeline" data-linenumber="1505"><td class="num" id="LN1505">1505</td><td class="line">			 <span class='comment'>* This is slow, but it works.</span></td></tr>
<tr class="codeline" data-linenumber="1506"><td class="num" id="LN1506">1506</td><td class="line">			 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1507"><td class="num" id="LN1507">1507</td><td class="line">			<span class='keyword'>if</span> (!cannot_open)</td></tr>
<tr class="codeline" data-linenumber="1508"><td class="num" id="LN1508">1508</td><td class="line">			{</td></tr>
<tr class="codeline" data-linenumber="1509"><td class="num" id="LN1509">1509</td><td class="line">			    line_count = pp-&gt;pb_pointer[idx].pe_line_count;</td></tr>
<tr class="codeline" data-linenumber="1510"><td class="num" id="LN1510">1510</td><td class="line">			    <span class='keyword'>if</span> (readfile(curbuf-&gt;b_ffname, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, lnum,</td></tr>
<tr class="codeline" data-linenumber="1511"><td class="num" id="LN1511">1511</td><td class="line">					pp-&gt;pb_pointer[idx].pe_old_lnum - 1,</td></tr>
<tr class="codeline" data-linenumber="1512"><td class="num" id="LN1512">1512</td><td class="line">					line_count, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, 0) != <span class='macro'>OK<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1513"><td class="num" id="LN1513">1513</td><td class="line">				cannot_open = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1514"><td class="num" id="LN1514">1514</td><td class="line">			    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1515"><td class="num" id="LN1515">1515</td><td class="line">				lnum += line_count;</td></tr>
<tr class="codeline" data-linenumber="1516"><td class="num" id="LN1516">1516</td><td class="line">			}</td></tr>
<tr class="codeline" data-linenumber="1517"><td class="num" id="LN1517">1517</td><td class="line">			<span class='keyword'>if</span> (cannot_open)</td></tr>
<tr class="codeline" data-linenumber="1518"><td class="num" id="LN1518">1518</td><td class="line">			{</td></tr>
<tr class="codeline" data-linenumber="1519"><td class="num" id="LN1519">1519</td><td class="line">			    ++error;</td></tr>
<tr class="codeline" data-linenumber="1520"><td class="num" id="LN1520">1520</td><td class="line">			    ml_append(lnum++, (char_u *)<span class='macro'>_(<span class='string_literal'>"???LINES MISSING"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("???LINES MISSING"), 5)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1521"><td class="num" id="LN1521">1521</td><td class="line">							    (colnr_T)0, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1522"><td class="num" id="LN1522">1522</td><td class="line">			}</td></tr>
<tr class="codeline" data-linenumber="1523"><td class="num" id="LN1523">1523</td><td class="line">			++idx;	    <span class='comment'>// get same block again for next index</span></td></tr>
<tr class="codeline" data-linenumber="1524"><td class="num" id="LN1524">1524</td><td class="line">			<span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1525"><td class="num" id="LN1525">1525</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="1526"><td class="num" id="LN1526">1526</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1527"><td class="num" id="LN1527">1527</td><td class="line">		    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1528"><td class="num" id="LN1528">1528</td><td class="line">		     <span class='comment'>* going one block deeper in the tree</span></td></tr>
<tr class="codeline" data-linenumber="1529"><td class="num" id="LN1529">1529</td><td class="line">		     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1530"><td class="num" id="LN1530">1530</td><td class="line">		    <span class='keyword'>if</span> ((top = ml_add_stack(buf)) &lt; 0)	<span class='comment'>// new entry in stack</span></td></tr>
<tr class="codeline" data-linenumber="1531"><td class="num" id="LN1531">1531</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="1532"><td class="num" id="LN1532">1532</td><td class="line">			++error;</td></tr>
<tr class="codeline" data-linenumber="1533"><td class="num" id="LN1533">1533</td><td class="line">			<span class='keyword'>break</span>;		    <span class='comment'>// out of memory</span></td></tr>
<tr class="codeline" data-linenumber="1534"><td class="num" id="LN1534">1534</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="1535"><td class="num" id="LN1535">1535</td><td class="line">		    ip = &amp;(buf-&gt;b_ml.ml_stack[top]);</td></tr>
<tr class="codeline" data-linenumber="1536"><td class="num" id="LN1536">1536</td><td class="line">		    ip-&gt;ip_bnum = bnum;</td></tr>
<tr class="codeline" data-linenumber="1537"><td class="num" id="LN1537">1537</td><td class="line">		    ip-&gt;ip_index = idx;</td></tr>
<tr class="codeline" data-linenumber="1538"><td class="num" id="LN1538">1538</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1539"><td class="num" id="LN1539">1539</td><td class="line">		    bnum = pp-&gt;pb_pointer[idx].pe_bnum;</td></tr>
<tr class="codeline" data-linenumber="1540"><td class="num" id="LN1540">1540</td><td class="line">		    line_count = pp-&gt;pb_pointer[idx].pe_line_count;</td></tr>
<tr class="codeline" data-linenumber="1541"><td class="num" id="LN1541">1541</td><td class="line">		    page_count = pp-&gt;pb_pointer[idx].pe_page_count;</td></tr>
<tr class="codeline" data-linenumber="1542"><td class="num" id="LN1542">1542</td><td class="line">		    idx = 0;</td></tr>
<tr class="codeline" data-linenumber="1543"><td class="num" id="LN1543">1543</td><td class="line">		    <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1544"><td class="num" id="LN1544">1544</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="1545"><td class="num" id="LN1545">1545</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="1546"><td class="num" id="LN1546">1546</td><td class="line">	    <span class='keyword'>else</span>	    <span class='comment'>// not a pointer block</span></td></tr>
<tr class="codeline" data-linenumber="1547"><td class="num" id="LN1547">1547</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="1548"><td class="num" id="LN1548">1548</td><td class="line">		dp = (DATA_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="1549"><td class="num" id="LN1549">1549</td><td class="line">		<span class='keyword'>if</span> (dp-&gt;db_id != <span class='macro'>DATA_ID<span class='macro_popup'>(('d' &lt;&lt; 8) + 'a')</span></span>)	<span class='comment'>// block id wrong</span></td></tr>
<tr class="codeline" data-linenumber="1550"><td class="num" id="LN1550">1550</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="1551"><td class="num" id="LN1551">1551</td><td class="line">		    <span class='keyword'>if</span> (bnum == 1)</td></tr>
<tr class="codeline" data-linenumber="1552"><td class="num" id="LN1552">1552</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="1553"><td class="num" id="LN1553">1553</td><td class="line">			semsg(<span class='macro'>_(<span class='string_literal'>"E310: Block 1 ID wrong (%s not a .swp file?)"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E310: Block 1 ID wrong (%s not a .swp file?)"<br>), 5)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1554"><td class="num" id="LN1554">1554</td><td class="line">							       mfp-&gt;mf_fname);</td></tr>
<tr class="codeline" data-linenumber="1555"><td class="num" id="LN1555">1555</td><td class="line">			<span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="1556"><td class="num" id="LN1556">1556</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="1557"><td class="num" id="LN1557">1557</td><td class="line">		    ++error;</td></tr>
<tr class="codeline" data-linenumber="1558"><td class="num" id="LN1558">1558</td><td class="line">		    ml_append(lnum++, (char_u *)<span class='macro'>_(<span class='string_literal'>"???BLOCK MISSING"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("???BLOCK MISSING"), 5)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1559"><td class="num" id="LN1559">1559</td><td class="line">							    (colnr_T)0, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1560"><td class="num" id="LN1560">1560</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="1561"><td class="num" id="LN1561">1561</td><td class="line">		<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1562"><td class="num" id="LN1562">1562</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="1563"><td class="num" id="LN1563">1563</td><td class="line">		    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1564"><td class="num" id="LN1564">1564</td><td class="line">		     <span class='comment'>* it is a data block</span></td></tr>
<tr class="codeline" data-linenumber="1565"><td class="num" id="LN1565">1565</td><td class="line">		     <span class='comment'>* Append all the lines in this block</span></td></tr>
<tr class="codeline" data-linenumber="1566"><td class="num" id="LN1566">1566</td><td class="line">		     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1567"><td class="num" id="LN1567">1567</td><td class="line">		    has_error = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1568"><td class="num" id="LN1568">1568</td><td class="line">			<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1569"><td class="num" id="LN1569">1569</td><td class="line">			 <span class='comment'>* check length of block</span></td></tr>
<tr class="codeline" data-linenumber="1570"><td class="num" id="LN1570">1570</td><td class="line">			 <span class='comment'>* if wrong, use length in pointer block</span></td></tr>
<tr class="codeline" data-linenumber="1571"><td class="num" id="LN1571">1571</td><td class="line">			 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1572"><td class="num" id="LN1572">1572</td><td class="line">		    <span class='keyword'>if</span> (page_count * mfp-&gt;mf_page_size != dp-&gt;db_txt_end)</td></tr>
<tr class="codeline" data-linenumber="1573"><td class="num" id="LN1573">1573</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="1574"><td class="num" id="LN1574">1574</td><td class="line">			ml_append(lnum++, (char_u *)<span class='macro'>_(<span class='string_literal'>"??? from here until ???END lines may be messed up"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("??? from here until ???END lines may be messed up"<br>), 5)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1575"><td class="num" id="LN1575">1575</td><td class="line">							    (colnr_T)0, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1576"><td class="num" id="LN1576">1576</td><td class="line">			++error;</td></tr>
<tr class="codeline" data-linenumber="1577"><td class="num" id="LN1577">1577</td><td class="line">			has_error = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1578"><td class="num" id="LN1578">1578</td><td class="line">			dp-&gt;db_txt_end = page_count * mfp-&gt;mf_page_size;</td></tr>
<tr class="codeline" data-linenumber="1579"><td class="num" id="LN1579">1579</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="1580"><td class="num" id="LN1580">1580</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1581"><td class="num" id="LN1581">1581</td><td class="line">			<span class='comment'>// make sure there is a NUL at the end of the block</span></td></tr>
<tr class="codeline" data-linenumber="1582"><td class="num" id="LN1582">1582</td><td class="line">		    *((char_u *)dp + dp-&gt;db_txt_end - 1) = <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1583"><td class="num" id="LN1583">1583</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1584"><td class="num" id="LN1584">1584</td><td class="line">			<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1585"><td class="num" id="LN1585">1585</td><td class="line">			 <span class='comment'>* check number of lines in block</span></td></tr>
<tr class="codeline" data-linenumber="1586"><td class="num" id="LN1586">1586</td><td class="line">			 <span class='comment'>* if wrong, use count in data block</span></td></tr>
<tr class="codeline" data-linenumber="1587"><td class="num" id="LN1587">1587</td><td class="line">			 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1588"><td class="num" id="LN1588">1588</td><td class="line">		    <span class='keyword'>if</span> (line_count != dp-&gt;db_line_count)</td></tr>
<tr class="codeline" data-linenumber="1589"><td class="num" id="LN1589">1589</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="1590"><td class="num" id="LN1590">1590</td><td class="line">			ml_append(lnum++, (char_u *)<span class='macro'>_(<span class='string_literal'>"??? from here until ???END lines may have been inserted/deleted"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("??? from here until ???END lines may have been inserted/deleted"<br>), 5)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1591"><td class="num" id="LN1591">1591</td><td class="line">							    (colnr_T)0, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1592"><td class="num" id="LN1592">1592</td><td class="line">			++error;</td></tr>
<tr class="codeline" data-linenumber="1593"><td class="num" id="LN1593">1593</td><td class="line">			has_error = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1594"><td class="num" id="LN1594">1594</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="1595"><td class="num" id="LN1595">1595</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1596"><td class="num" id="LN1596">1596</td><td class="line">		    <span class='keyword'>for</span> (i = 0; i &lt; dp-&gt;db_line_count; ++i)</td></tr>
<tr class="codeline" data-linenumber="1597"><td class="num" id="LN1597">1597</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="1598"><td class="num" id="LN1598">1598</td><td class="line">			txt_start = (dp-&gt;db_index[i] &amp; <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1599"><td class="num" id="LN1599">1599</td><td class="line">			<span class='keyword'>if</span> (txt_start &lt;= (<span class='keyword'>int</span>)<span class='macro'>HEADER_SIZE<span class='macro_popup'>(sizeof(DATA_BL) - (sizeof(unsigned)))</span></span></td></tr>
<tr class="codeline" data-linenumber="1600"><td class="num" id="LN1600">1600</td><td class="line">					  || txt_start &gt;= (<span class='keyword'>int</span>)dp-&gt;db_txt_end)</td></tr>
<tr class="codeline" data-linenumber="1601"><td class="num" id="LN1601">1601</td><td class="line">			{</td></tr>
<tr class="codeline" data-linenumber="1602"><td class="num" id="LN1602">1602</td><td class="line">			    p = (char_u *)<span class='string_literal'>"???"</span>;</td></tr>
<tr class="codeline" data-linenumber="1603"><td class="num" id="LN1603">1603</td><td class="line">			    ++error;</td></tr>
<tr class="codeline" data-linenumber="1604"><td class="num" id="LN1604">1604</td><td class="line">			}</td></tr>
<tr class="codeline" data-linenumber="1605"><td class="num" id="LN1605">1605</td><td class="line">			<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1606"><td class="num" id="LN1606">1606</td><td class="line">			    p = (char_u *)dp + txt_start;</td></tr>
<tr class="codeline" data-linenumber="1607"><td class="num" id="LN1607">1607</td><td class="line">			ml_append(lnum++, p, (colnr_T)0, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1608"><td class="num" id="LN1608">1608</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="1609"><td class="num" id="LN1609">1609</td><td class="line">		    <span class='keyword'>if</span> (has_error)</td></tr>
<tr class="codeline" data-linenumber="1610"><td class="num" id="LN1610">1610</td><td class="line">			ml_append(lnum++, (char_u *)<span class='macro'>_(<span class='string_literal'>"???END"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("???END"), 5)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1611"><td class="num" id="LN1611">1611</td><td class="line">							    (colnr_T)0, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1612"><td class="num" id="LN1612">1612</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="1613"><td class="num" id="LN1613">1613</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="1614"><td class="num" id="LN1614">1614</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1615"><td class="num" id="LN1615">1615</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1616"><td class="num" id="LN1616">1616</td><td class="line">	<span class='keyword'>if</span> (buf-&gt;b_ml.ml_stack_top == 0)	<span class='comment'>// finished</span></td></tr>
<tr class="codeline" data-linenumber="1617"><td class="num" id="LN1617">1617</td><td class="line">	    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1618"><td class="num" id="LN1618">1618</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1619"><td class="num" id="LN1619">1619</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1620"><td class="num" id="LN1620">1620</td><td class="line">	 <span class='comment'>* go one block up in the tree</span></td></tr>
<tr class="codeline" data-linenumber="1621"><td class="num" id="LN1621">1621</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1622"><td class="num" id="LN1622">1622</td><td class="line">	ip = &amp;(buf-&gt;b_ml.ml_stack[--(buf-&gt;b_ml.ml_stack_top)]);</td></tr>
<tr class="codeline" data-linenumber="1623"><td class="num" id="LN1623">1623</td><td class="line">	bnum = ip-&gt;ip_bnum;</td></tr>
<tr class="codeline" data-linenumber="1624"><td class="num" id="LN1624">1624</td><td class="line">	idx = ip-&gt;ip_index + 1;	    <span class='comment'>// go to next index</span></td></tr>
<tr class="codeline" data-linenumber="1625"><td class="num" id="LN1625">1625</td><td class="line">	page_count = 1;</td></tr>
<tr class="codeline" data-linenumber="1626"><td class="num" id="LN1626">1626</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1627"><td class="num" id="LN1627">1627</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1628"><td class="num" id="LN1628">1628</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1629"><td class="num" id="LN1629">1629</td><td class="line">     <span class='comment'>* Compare the buffer contents with the original file.  When they differ</span></td></tr>
<tr class="codeline" data-linenumber="1630"><td class="num" id="LN1630">1630</td><td class="line">     <span class='comment'>* set the 'modified' flag.</span></td></tr>
<tr class="codeline" data-linenumber="1631"><td class="num" id="LN1631">1631</td><td class="line">     <span class='comment'>* Lines 1 - lnum are the new contents.</span></td></tr>
<tr class="codeline" data-linenumber="1632"><td class="num" id="LN1632">1632</td><td class="line">     <span class='comment'>* Lines lnum + 1 to ml_line_count are the original contents.</span></td></tr>
<tr class="codeline" data-linenumber="1633"><td class="num" id="LN1633">1633</td><td class="line">     <span class='comment'>* Line ml_line_count + 1 in the dummy empty line.</span></td></tr>
<tr class="codeline" data-linenumber="1634"><td class="num" id="LN1634">1634</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1635"><td class="num" id="LN1635">1635</td><td class="line">    <span class='keyword'>if</span> (orig_file_status != <span class='macro'>OK<span class='macro_popup'>1</span></span> || curbuf-&gt;b_ml.ml_line_count != lnum * 2 + 1)</td></tr>
<tr class="codeline" data-linenumber="1636"><td class="num" id="LN1636">1636</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1637"><td class="num" id="LN1637">1637</td><td class="line">	<span class='comment'>// Recovering an empty file results in two lines and the first line is</span></td></tr>
<tr class="codeline" data-linenumber="1638"><td class="num" id="LN1638">1638</td><td class="line">	<span class='comment'>// empty.  Don't set the modified flag then.</span></td></tr>
<tr class="codeline" data-linenumber="1639"><td class="num" id="LN1639">1639</td><td class="line">	<span class='keyword'>if</span> (!(curbuf-&gt;b_ml.ml_line_count == 2 &amp;&amp; *ml_get(1) == <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>))</td></tr>
<tr class="codeline" data-linenumber="1640"><td class="num" id="LN1640">1640</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="1641"><td class="num" id="LN1641">1641</td><td class="line">	    changed_internal();</td></tr>
<tr class="codeline" data-linenumber="1642"><td class="num" id="LN1642">1642</td><td class="line">	    ++<span class='macro'>CHANGEDTICK(curbuf)<span class='macro_popup'>((curbuf)-&gt;b_ct_di.di_tv.vval.v_number)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1643"><td class="num" id="LN1643">1643</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1644"><td class="num" id="LN1644">1644</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1645"><td class="num" id="LN1645">1645</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1646"><td class="num" id="LN1646">1646</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1647"><td class="num" id="LN1647">1647</td><td class="line">	<span class='keyword'>for</span> (idx = 1; idx &lt;= lnum; ++idx)</td></tr>
<tr class="codeline" data-linenumber="1648"><td class="num" id="LN1648">1648</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="1649"><td class="num" id="LN1649">1649</td><td class="line">	    <span class='comment'>// Need to copy one line, fetching the other one may flush it.</span></td></tr>
<tr class="codeline" data-linenumber="1650"><td class="num" id="LN1650">1650</td><td class="line">	    p = vim_strsave(ml_get(idx));</td></tr>
<tr class="codeline" data-linenumber="1651"><td class="num" id="LN1651">1651</td><td class="line">	    i = <span class='macro'>STRCMP(p, ml_get(idx + lnum))<span class='macro_popup'>strcmp((char *)(p), (char *)(ml_get(idx + lnum)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1652"><td class="num" id="LN1652">1652</td><td class="line">	    vim_free(p);</td></tr>
<tr class="codeline" data-linenumber="1653"><td class="num" id="LN1653">1653</td><td class="line">	    <span class='keyword'>if</span> (i != 0)</td></tr>
<tr class="codeline" data-linenumber="1654"><td class="num" id="LN1654">1654</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="1655"><td class="num" id="LN1655">1655</td><td class="line">		changed_internal();</td></tr>
<tr class="codeline" data-linenumber="1656"><td class="num" id="LN1656">1656</td><td class="line">		++<span class='macro'>CHANGEDTICK(curbuf)<span class='macro_popup'>((curbuf)-&gt;b_ct_di.di_tv.vval.v_number)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1657"><td class="num" id="LN1657">1657</td><td class="line">		<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1658"><td class="num" id="LN1658">1658</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="1659"><td class="num" id="LN1659">1659</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1660"><td class="num" id="LN1660">1660</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1661"><td class="num" id="LN1661">1661</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1662"><td class="num" id="LN1662">1662</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1663"><td class="num" id="LN1663">1663</td><td class="line">     <span class='comment'>* Delete the lines from the original file and the dummy line from the</span></td></tr>
<tr class="codeline" data-linenumber="1664"><td class="num" id="LN1664">1664</td><td class="line">     <span class='comment'>* empty buffer.  These will now be after the last line in the buffer.</span></td></tr>
<tr class="codeline" data-linenumber="1665"><td class="num" id="LN1665">1665</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1666"><td class="num" id="LN1666">1666</td><td class="line">    <span class='keyword'>while</span> (curbuf-&gt;b_ml.ml_line_count &gt; lnum</td></tr>
<tr class="codeline" data-linenumber="1667"><td class="num" id="LN1667">1667</td><td class="line">				       &amp;&amp; !(curbuf-&gt;b_ml.ml_flags &amp; <span class='macro'>ML_EMPTY<span class='macro_popup'>1</span></span>))</td></tr>
<tr class="codeline" data-linenumber="1668"><td class="num" id="LN1668">1668</td><td class="line">	ml_delete(curbuf-&gt;b_ml.ml_line_count);</td></tr>
<tr class="codeline" data-linenumber="1669"><td class="num" id="LN1669">1669</td><td class="line">    curbuf-&gt;b_flags |= <span class='macro'>BF_RECOVERED<span class='macro_popup'>0x01</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1670"><td class="num" id="LN1670">1670</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1671"><td class="num" id="LN1671">1671</td><td class="line">    recoverymode = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1672"><td class="num" id="LN1672">1672</td><td class="line">    <span class='keyword'>if</span> (got_int)</td></tr>
<tr class="codeline" data-linenumber="1673"><td class="num" id="LN1673">1673</td><td class="line">	emsg(<span class='macro'>_(<span class='string_literal'>"E311: Recovery Interrupted"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E311: Recovery Interrupted")<br>, 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1674"><td class="num" id="LN1674">1674</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (error)</td></tr>
<tr class="codeline" data-linenumber="1675"><td class="num" id="LN1675">1675</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1676"><td class="num" id="LN1676">1676</td><td class="line">	++no_wait_return;</td></tr>
<tr class="codeline" data-linenumber="1677"><td class="num" id="LN1677">1677</td><td class="line">	msg(<span class='string_literal'>"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;"</span>);</td></tr>
<tr class="codeline" data-linenumber="1678"><td class="num" id="LN1678">1678</td><td class="line">	emsg(<span class='macro'>_(<span class='string_literal'>"E312: Errors detected while recovering; look for lines starting with ???"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E312: Errors detected while recovering; look for lines starting with ???"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1679"><td class="num" id="LN1679">1679</td><td class="line">	--no_wait_return;</td></tr>
<tr class="codeline" data-linenumber="1680"><td class="num" id="LN1680">1680</td><td class="line">	msg(<span class='macro'>_(<span class='string_literal'>"See \":help E312\" for more information."</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("See \":help E312\" for more information."<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1681"><td class="num" id="LN1681">1681</td><td class="line">	msg(<span class='string_literal'>"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;"</span>);</td></tr>
<tr class="codeline" data-linenumber="1682"><td class="num" id="LN1682">1682</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1683"><td class="num" id="LN1683">1683</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1684"><td class="num" id="LN1684">1684</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1685"><td class="num" id="LN1685">1685</td><td class="line">	<span class='keyword'>if</span> (curbuf-&gt;b_changed)</td></tr>
<tr class="codeline" data-linenumber="1686"><td class="num" id="LN1686">1686</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="1687"><td class="num" id="LN1687">1687</td><td class="line">	    msg(<span class='macro'>_(<span class='string_literal'>"Recovery completed. You should check if everything is OK."</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("Recovery completed. You should check if everything is OK."<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1688"><td class="num" id="LN1688">1688</td><td class="line">	    msg_puts(<span class='macro'>_(<span class='string_literal'>"\n(You might want to write out this file under another name\n"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("\n(You might want to write out this file under another name\n"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1689"><td class="num" id="LN1689">1689</td><td class="line">	    msg_puts(<span class='macro'>_(<span class='string_literal'>"and run diff with the original file to check for changes)"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("and run diff with the original file to check for changes)"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1690"><td class="num" id="LN1690">1690</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1691"><td class="num" id="LN1691">1691</td><td class="line">	<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1692"><td class="num" id="LN1692">1692</td><td class="line">	    msg(<span class='macro'>_(<span class='string_literal'>"Recovery completed. Buffer contents equals file contents."</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("Recovery completed. Buffer contents equals file contents."<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1693"><td class="num" id="LN1693">1693</td><td class="line">	msg_puts(<span class='macro'>_(<span class='string_literal'>"\nYou may want to delete the .swp file now."</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("\nYou may want to delete the .swp file now."<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1694"><td class="num" id="LN1694">1694</td><td class="line"><span class='directive'>#if defined(<span class='macro'>UNIX<span class='macro_popup'>1</span></span>) || defined(MSWIN)</span></td></tr>
<tr class="codeline" data-linenumber="1695"><td class="num" id="LN1695">1695</td><td class="line">	<span class='keyword'>if</span> (mch_process_running(char_to_long(b0p-&gt;b0_pid)))</td></tr>
<tr class="codeline" data-linenumber="1696"><td class="num" id="LN1696">1696</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="1697"><td class="num" id="LN1697">1697</td><td class="line">	    <span class='comment'>// Warn there could be an active Vim on the same file, the user may</span></td></tr>
<tr class="codeline" data-linenumber="1698"><td class="num" id="LN1698">1698</td><td class="line">	    <span class='comment'>// want to kill it.</span></td></tr>
<tr class="codeline" data-linenumber="1699"><td class="num" id="LN1699">1699</td><td class="line">	    msg_puts(<span class='macro'>_(<span class='string_literal'>"\nNote: process STILL RUNNING: "</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("\nNote: process STILL RUNNING: "<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1700"><td class="num" id="LN1700">1700</td><td class="line">	    msg_outnum(char_to_long(b0p-&gt;b0_pid));</td></tr>
<tr class="codeline" data-linenumber="1701"><td class="num" id="LN1701">1701</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1702"><td class="num" id="LN1702">1702</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1703"><td class="num" id="LN1703">1703</td><td class="line">	msg_puts(<span class='string_literal'>"\n\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1704"><td class="num" id="LN1704">1704</td><td class="line">	cmdline_row = msg_row;</td></tr>
<tr class="codeline" data-linenumber="1705"><td class="num" id="LN1705">1705</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1706"><td class="num" id="LN1706">1706</td><td class="line"><span class='directive'>#ifdef FEAT_CRYPT</span></td></tr>
<tr class="codeline" data-linenumber="1707"><td class="num" id="LN1707">1707</td><td class="line">    <span class='keyword'>if</span> (*buf-&gt;b_p_key != <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span> &amp;&amp; <span class='macro'>STRCMP(curbuf-&gt;b_p_key, buf-&gt;b_p_key)<span class='macro_popup'>strcmp((char *)(curbuf-&gt;b_p_key), (char *)(buf-&gt;b_p_key<br>))</span></span> != 0)</td></tr>
<tr class="codeline" data-linenumber="1708"><td class="num" id="LN1708">1708</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1709"><td class="num" id="LN1709">1709</td><td class="line">	msg_puts(<span class='macro'>_(<span class='string_literal'>"Using crypt key from swap file for the text file.\n"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("Using crypt key from swap file for the text file.\n"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1710"><td class="num" id="LN1710">1710</td><td class="line">	set_option_value((char_u *)<span class='string_literal'>"key"</span>, 0L, buf-&gt;b_p_key, <span class='macro'>OPT_LOCAL<span class='macro_popup'>0x04</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1711"><td class="num" id="LN1711">1711</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1712"><td class="num" id="LN1712">1712</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1713"><td class="num" id="LN1713">1713</td><td class="line">    redraw_curbuf_later(<span class='macro'>NOT_VALID<span class='macro_popup'>40</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1714"><td class="num" id="LN1714">1714</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1715"><td class="num" id="LN1715">1715</td><td class="line">theend:</td></tr>
<tr class="codeline" data-linenumber="1716"><td class="num" id="LN1716">1716</td><td class="line">    vim_free(fname_used);</td></tr>
<tr class="codeline" data-linenumber="1717"><td class="num" id="LN1717">1717</td><td class="line">    recoverymode = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1718"><td class="num" id="LN1718">1718</td><td class="line">    <span class='keyword'>if</span> (mfp != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1719"><td class="num" id="LN1719">1719</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1720"><td class="num" id="LN1720">1720</td><td class="line">	<span class='keyword'>if</span> (hp != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1721"><td class="num" id="LN1721">1721</td><td class="line">	    mf_put(mfp, hp, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1722"><td class="num" id="LN1722">1722</td><td class="line">	mf_close(mfp, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);	    <span class='comment'>// will also vim_free(mfp-&gt;mf_fname)</span></td></tr>
<tr class="codeline" data-linenumber="1723"><td class="num" id="LN1723">1723</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1724"><td class="num" id="LN1724">1724</td><td class="line">    <span class='keyword'>if</span> (buf != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1725"><td class="num" id="LN1725">1725</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1726"><td class="num" id="LN1726">1726</td><td class="line"><span class='directive'>#ifdef FEAT_CRYPT</span></td></tr>
<tr class="codeline" data-linenumber="1727"><td class="num" id="LN1727">1727</td><td class="line">	<span class='keyword'>if</span> (buf-&gt;b_p_key != curbuf-&gt;b_p_key)</td></tr>
<tr class="codeline" data-linenumber="1728"><td class="num" id="LN1728">1728</td><td class="line">	    free_string_option(buf-&gt;b_p_key);</td></tr>
<tr class="codeline" data-linenumber="1729"><td class="num" id="LN1729">1729</td><td class="line">	free_string_option(buf-&gt;b_p_cm);</td></tr>
<tr class="codeline" data-linenumber="1730"><td class="num" id="LN1730">1730</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1731"><td class="num" id="LN1731">1731</td><td class="line">	vim_free(buf-&gt;b_ml.ml_stack);</td></tr>
<tr class="codeline" data-linenumber="1732"><td class="num" id="LN1732">1732</td><td class="line">	vim_free(buf);</td></tr>
<tr class="codeline" data-linenumber="1733"><td class="num" id="LN1733">1733</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1734"><td class="num" id="LN1734">1734</td><td class="line">    <span class='keyword'>if</span> (serious_error &amp;&amp; called_from_main)</td></tr>
<tr class="codeline" data-linenumber="1735"><td class="num" id="LN1735">1735</td><td class="line">	ml_close(curbuf, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1736"><td class="num" id="LN1736">1736</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1737"><td class="num" id="LN1737">1737</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1738"><td class="num" id="LN1738">1738</td><td class="line">	apply_autocmds(EVENT_BUFREADPOST, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, curbuf-&gt;b_fname, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>, curbuf);</td></tr>
<tr class="codeline" data-linenumber="1739"><td class="num" id="LN1739">1739</td><td class="line">	apply_autocmds(EVENT_BUFWINENTER, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, curbuf-&gt;b_fname, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>, curbuf);</td></tr>
<tr class="codeline" data-linenumber="1740"><td class="num" id="LN1740">1740</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1741"><td class="num" id="LN1741">1741</td><td class="line">    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1742"><td class="num" id="LN1742">1742</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1743"><td class="num" id="LN1743">1743</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1744"><td class="num" id="LN1744">1744</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1745"><td class="num" id="LN1745">1745</td><td class="line"> <span class='comment'>* Find the names of swap files in current directory and the directory given</span></td></tr>
<tr class="codeline" data-linenumber="1746"><td class="num" id="LN1746">1746</td><td class="line"> <span class='comment'>* with the 'directory' option.</span></td></tr>
<tr class="codeline" data-linenumber="1747"><td class="num" id="LN1747">1747</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1748"><td class="num" id="LN1748">1748</td><td class="line"> <span class='comment'>* Used to:</span></td></tr>
<tr class="codeline" data-linenumber="1749"><td class="num" id="LN1749">1749</td><td class="line"> <span class='comment'>* - list the swap files for "vim -r"</span></td></tr>
<tr class="codeline" data-linenumber="1750"><td class="num" id="LN1750">1750</td><td class="line"> <span class='comment'>* - count the number of swap files when recovering</span></td></tr>
<tr class="codeline" data-linenumber="1751"><td class="num" id="LN1751">1751</td><td class="line"> <span class='comment'>* - list the swap files when recovering</span></td></tr>
<tr class="codeline" data-linenumber="1752"><td class="num" id="LN1752">1752</td><td class="line"> <span class='comment'>* - find the name of the n'th swap file when recovering</span></td></tr>
<tr class="codeline" data-linenumber="1753"><td class="num" id="LN1753">1753</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1754"><td class="num" id="LN1754">1754</td><td class="line">    <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="1755"><td class="num" id="LN1755">1755</td><td class="line">recover_names(</td></tr>
<tr class="codeline" data-linenumber="1756"><td class="num" id="LN1756">1756</td><td class="line">    char_u	*fname,		<span class='comment'>// base for swap file name</span></td></tr>
<tr class="codeline" data-linenumber="1757"><td class="num" id="LN1757">1757</td><td class="line">    <span class='keyword'>int</span>		list,		<span class='comment'>// when TRUE, list the swap file names</span></td></tr>
<tr class="codeline" data-linenumber="1758"><td class="num" id="LN1758">1758</td><td class="line">    <span class='keyword'>int</span>		nr,		<span class='comment'>// when non-zero, return nr'th swap file name</span></td></tr>
<tr class="codeline" data-linenumber="1759"><td class="num" id="LN1759">1759</td><td class="line">    char_u	**fname_out)	<span class='comment'>// result when "nr" &gt; 0</span></td></tr>
<tr class="codeline" data-linenumber="1760"><td class="num" id="LN1760">1760</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1761"><td class="num" id="LN1761">1761</td><td class="line">    <span class='keyword'>int</span>		num_names;</td></tr>
<tr class="codeline" data-linenumber="1762"><td class="num" id="LN1762">1762</td><td class="line">    char_u	*(names[6]);</td></tr>
<tr class="codeline" data-linenumber="1763"><td class="num" id="LN1763">1763</td><td class="line">    char_u	*tail;</td></tr>
<tr class="codeline" data-linenumber="1764"><td class="num" id="LN1764">1764</td><td class="line">    char_u	*p;</td></tr>
<tr class="codeline" data-linenumber="1765"><td class="num" id="LN1765">1765</td><td class="line">    <span class='keyword'>int</span>		num_files;</td></tr>
<tr class="codeline" data-linenumber="1766"><td class="num" id="LN1766">1766</td><td class="line">    <span class='keyword'>int</span>		file_count = 0;</td></tr>
<tr class="codeline" data-linenumber="1767"><td class="num" id="LN1767">1767</td><td class="line">    char_u	**files;</td></tr>
<tr class="codeline" data-linenumber="1768"><td class="num" id="LN1768">1768</td><td class="line">    <span class='keyword'>int</span>		i;</td></tr>
<tr class="codeline" data-linenumber="1769"><td class="num" id="LN1769">1769</td><td class="line">    char_u	*dirp;</td></tr>
<tr class="codeline" data-linenumber="1770"><td class="num" id="LN1770">1770</td><td class="line">    char_u	*dir_name;</td></tr>
<tr class="codeline" data-linenumber="1771"><td class="num" id="LN1771">1771</td><td class="line">    char_u	*fname_res = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1772"><td class="num" id="LN1772">1772</td><td class="line"><span class='directive'>#ifdef <span class='macro'>HAVE_READLINK<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="1773"><td class="num" id="LN1773">1773</td><td class="line">    char_u	fname_buf[<span class='macro'>MAXPATHL<span class='macro_popup'>4096</span></span>];</td></tr>
<tr class="codeline" data-linenumber="1774"><td class="num" id="LN1774">1774</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1775"><td class="num" id="LN1775">1775</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1776"><td class="num" id="LN1776">1776</td><td class="line">    <span class='keyword'>if</span> (fname != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1777"><td class="num" id="LN1777">1777</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1778"><td class="num" id="LN1778">1778</td><td class="line"><span class='directive'>#ifdef <span class='macro'>HAVE_READLINK<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="1779"><td class="num" id="LN1779">1779</td><td class="line">	<span class='comment'>// Expand symlink in the file name, because the swap file is created</span></td></tr>
<tr class="codeline" data-linenumber="1780"><td class="num" id="LN1780">1780</td><td class="line">	<span class='comment'>// with the actual file instead of with the symlink.</span></td></tr>
<tr class="codeline" data-linenumber="1781"><td class="num" id="LN1781">1781</td><td class="line">	<span class='keyword'>if</span> (resolve_symlink(fname, fname_buf) == <span class='macro'>OK<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1782"><td class="num" id="LN1782">1782</td><td class="line">	    fname_res = fname_buf;</td></tr>
<tr class="codeline" data-linenumber="1783"><td class="num" id="LN1783">1783</td><td class="line">	<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1784"><td class="num" id="LN1784">1784</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1785"><td class="num" id="LN1785">1785</td><td class="line">	    fname_res = fname;</td></tr>
<tr class="codeline" data-linenumber="1786"><td class="num" id="LN1786">1786</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1787"><td class="num" id="LN1787">1787</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1788"><td class="num" id="LN1788">1788</td><td class="line">    <span class='keyword'>if</span> (list)</td></tr>
<tr class="codeline" data-linenumber="1789"><td class="num" id="LN1789">1789</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1790"><td class="num" id="LN1790">1790</td><td class="line">	<span class='comment'>// use msg() to start the scrolling properly</span></td></tr>
<tr class="codeline" data-linenumber="1791"><td class="num" id="LN1791">1791</td><td class="line">	msg(<span class='macro'>_(<span class='string_literal'>"Swap files found:"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("Swap files found:"), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1792"><td class="num" id="LN1792">1792</td><td class="line">	msg_putchar('\n');</td></tr>
<tr class="codeline" data-linenumber="1793"><td class="num" id="LN1793">1793</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1794"><td class="num" id="LN1794">1794</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1795"><td class="num" id="LN1795">1795</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1796"><td class="num" id="LN1796">1796</td><td class="line">     <span class='comment'>* Do the loop for every directory in 'directory'.</span></td></tr>
<tr class="codeline" data-linenumber="1797"><td class="num" id="LN1797">1797</td><td class="line">     <span class='comment'>* First allocate some memory to put the directory name in.</span></td></tr>
<tr class="codeline" data-linenumber="1798"><td class="num" id="LN1798">1798</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1799"><td class="num" id="LN1799">1799</td><td class="line">    dir_name = alloc(<span class='macro'>STRLEN(p_dir)<span class='macro_popup'>strlen((char *)(p_dir))</span></span> + 1);</td></tr>
<tr class="codeline" data-linenumber="1800"><td class="num" id="LN1800">1800</td><td class="line">    dirp = p_dir;</td></tr>
<tr class="codeline" data-linenumber="1801"><td class="num" id="LN1801">1801</td><td class="line">    <span class='keyword'>while</span> (dir_name != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; *dirp)</td></tr>
<tr class="codeline" data-linenumber="1802"><td class="num" id="LN1802">1802</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1803"><td class="num" id="LN1803">1803</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1804"><td class="num" id="LN1804">1804</td><td class="line">	 <span class='comment'>* Isolate a directory name from *dirp and put it in dir_name (we know</span></td></tr>
<tr class="codeline" data-linenumber="1805"><td class="num" id="LN1805">1805</td><td class="line">	 <span class='comment'>* it is large enough, so use 31000 for length).</span></td></tr>
<tr class="codeline" data-linenumber="1806"><td class="num" id="LN1806">1806</td><td class="line">	 <span class='comment'>* Advance dirp to next directory name.</span></td></tr>
<tr class="codeline" data-linenumber="1807"><td class="num" id="LN1807">1807</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1808"><td class="num" id="LN1808">1808</td><td class="line">	(<span class='keyword'>void</span>)copy_option_part(&amp;dirp, dir_name, 31000, <span class='string_literal'>","</span>);</td></tr>
<tr class="codeline" data-linenumber="1809"><td class="num" id="LN1809">1809</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1810"><td class="num" id="LN1810">1810</td><td class="line">	<span class='keyword'>if</span> (dir_name[0] == '.' &amp;&amp; dir_name[1] == <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>)	<span class='comment'>// check current dir</span></td></tr>
<tr class="codeline" data-linenumber="1811"><td class="num" id="LN1811">1811</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="1812"><td class="num" id="LN1812">1812</td><td class="line">	    <span class='keyword'>if</span> (fname == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1813"><td class="num" id="LN1813">1813</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="1814"><td class="num" id="LN1814">1814</td><td class="line"><span class='directive'>#ifdef VMS</span></td></tr>
<tr class="codeline" data-linenumber="1815"><td class="num" id="LN1815">1815</td><td class="line">		names[0] = vim_strsave((char_u *)<span class='string_literal'>"*_sw%"</span>);</td></tr>
<tr class="codeline" data-linenumber="1816"><td class="num" id="LN1816">1816</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="1817"><td class="num" id="LN1817">1817</td><td class="line">		names[0] = vim_strsave((char_u *)<span class='string_literal'>"*.sw?"</span>);</td></tr>
<tr class="codeline" data-linenumber="1818"><td class="num" id="LN1818">1818</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1819"><td class="num" id="LN1819">1819</td><td class="line"><span class='directive'>#if defined(<span class='macro'>UNIX<span class='macro_popup'>1</span></span>) || defined(MSWIN)</span></td></tr>
<tr class="codeline" data-linenumber="1820"><td class="num" id="LN1820">1820</td><td class="line">		<span class='comment'>// For Unix names starting with a dot are special.  MS-Windows</span></td></tr>
<tr class="codeline" data-linenumber="1821"><td class="num" id="LN1821">1821</td><td class="line">		<span class='comment'>// supports this too, on some file systems.</span></td></tr>
<tr class="codeline" data-linenumber="1822"><td class="num" id="LN1822">1822</td><td class="line">		names[1] = vim_strsave((char_u *)<span class='string_literal'>".*.sw?"</span>);</td></tr>
<tr class="codeline" data-linenumber="1823"><td class="num" id="LN1823">1823</td><td class="line">		names[2] = vim_strsave((char_u *)<span class='string_literal'>".sw?"</span>);</td></tr>
<tr class="codeline" data-linenumber="1824"><td class="num" id="LN1824">1824</td><td class="line">		num_names = 3;</td></tr>
<tr class="codeline" data-linenumber="1825"><td class="num" id="LN1825">1825</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="1826"><td class="num" id="LN1826">1826</td><td class="line"><span class='directive'># ifdef VMS</span></td></tr>
<tr class="codeline" data-linenumber="1827"><td class="num" id="LN1827">1827</td><td class="line">		names[1] = vim_strsave((char_u *)<span class='string_literal'>".*_sw%"</span>);</td></tr>
<tr class="codeline" data-linenumber="1828"><td class="num" id="LN1828">1828</td><td class="line">		num_names = 2;</td></tr>
<tr class="codeline" data-linenumber="1829"><td class="num" id="LN1829">1829</td><td class="line"><span class='directive'># else</span></td></tr>
<tr class="codeline" data-linenumber="1830"><td class="num" id="LN1830">1830</td><td class="line">		num_names = 1;</td></tr>
<tr class="codeline" data-linenumber="1831"><td class="num" id="LN1831">1831</td><td class="line"><span class='directive'># endif</span></td></tr>
<tr class="codeline" data-linenumber="1832"><td class="num" id="LN1832">1832</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1833"><td class="num" id="LN1833">1833</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="1834"><td class="num" id="LN1834">1834</td><td class="line">	    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1835"><td class="num" id="LN1835">1835</td><td class="line">		num_names = recov_file_names(names, fname_res, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1836"><td class="num" id="LN1836">1836</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1837"><td class="num" id="LN1837">1837</td><td class="line">	<span class='keyword'>else</span>			    <span class='comment'>// check directory dir_name</span></td></tr>
<tr class="codeline" data-linenumber="1838"><td class="num" id="LN1838">1838</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="1839"><td class="num" id="LN1839">1839</td><td class="line">	    <span class='keyword'>if</span> (fname == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1840"><td class="num" id="LN1840">1840</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="1841"><td class="num" id="LN1841">1841</td><td class="line"><span class='directive'>#ifdef VMS</span></td></tr>
<tr class="codeline" data-linenumber="1842"><td class="num" id="LN1842">1842</td><td class="line">		names[0] = concat_fnames(dir_name, (char_u *)<span class='string_literal'>"*_sw%"</span>, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1843"><td class="num" id="LN1843">1843</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="1844"><td class="num" id="LN1844">1844</td><td class="line">		names[0] = concat_fnames(dir_name, (char_u *)<span class='string_literal'>"*.sw?"</span>, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1845"><td class="num" id="LN1845">1845</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1846"><td class="num" id="LN1846">1846</td><td class="line"><span class='directive'>#if defined(<span class='macro'>UNIX<span class='macro_popup'>1</span></span>) || defined(MSWIN)</span></td></tr>
<tr class="codeline" data-linenumber="1847"><td class="num" id="LN1847">1847</td><td class="line">		<span class='comment'>// For Unix names starting with a dot are special.  MS-Windows</span></td></tr>
<tr class="codeline" data-linenumber="1848"><td class="num" id="LN1848">1848</td><td class="line">		<span class='comment'>// supports this too, on some file systems.</span></td></tr>
<tr class="codeline" data-linenumber="1849"><td class="num" id="LN1849">1849</td><td class="line">		names[1] = concat_fnames(dir_name, (char_u *)<span class='string_literal'>".*.sw?"</span>, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1850"><td class="num" id="LN1850">1850</td><td class="line">		names[2] = concat_fnames(dir_name, (char_u *)<span class='string_literal'>".sw?"</span>, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1851"><td class="num" id="LN1851">1851</td><td class="line">		num_names = 3;</td></tr>
<tr class="codeline" data-linenumber="1852"><td class="num" id="LN1852">1852</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="1853"><td class="num" id="LN1853">1853</td><td class="line"><span class='directive'># ifdef VMS</span></td></tr>
<tr class="codeline" data-linenumber="1854"><td class="num" id="LN1854">1854</td><td class="line">		names[1] = concat_fnames(dir_name, (char_u *)<span class='string_literal'>".*_sw%"</span>, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1855"><td class="num" id="LN1855">1855</td><td class="line">		num_names = 2;</td></tr>
<tr class="codeline" data-linenumber="1856"><td class="num" id="LN1856">1856</td><td class="line"><span class='directive'># else</span></td></tr>
<tr class="codeline" data-linenumber="1857"><td class="num" id="LN1857">1857</td><td class="line">		num_names = 1;</td></tr>
<tr class="codeline" data-linenumber="1858"><td class="num" id="LN1858">1858</td><td class="line"><span class='directive'># endif</span></td></tr>
<tr class="codeline" data-linenumber="1859"><td class="num" id="LN1859">1859</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1860"><td class="num" id="LN1860">1860</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="1861"><td class="num" id="LN1861">1861</td><td class="line">	    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1862"><td class="num" id="LN1862">1862</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="1863"><td class="num" id="LN1863">1863</td><td class="line"><span class='directive'>#if defined(<span class='macro'>UNIX<span class='macro_popup'>1</span></span>) || defined(MSWIN)</span></td></tr>
<tr class="codeline" data-linenumber="1864"><td class="num" id="LN1864">1864</td><td class="line">		<span class='keyword'>int</span>	len = (<span class='keyword'>int</span>)<span class='macro'>STRLEN(dir_name)<span class='macro_popup'>strlen((char *)(dir_name))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1865"><td class="num" id="LN1865">1865</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1866"><td class="num" id="LN1866">1866</td><td class="line">		p = dir_name + len;</td></tr>
<tr class="codeline" data-linenumber="1867"><td class="num" id="LN1867">1867</td><td class="line">		<span class='keyword'>if</span> (after_pathsep(dir_name, p) &amp;&amp; len &gt; 1 &amp;&amp; p[-1] == p[-2])</td></tr>
<tr class="codeline" data-linenumber="1868"><td class="num" id="LN1868">1868</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="1869"><td class="num" id="LN1869">1869</td><td class="line">		    <span class='comment'>// Ends with '//', Use Full path for swap name</span></td></tr>
<tr class="codeline" data-linenumber="1870"><td class="num" id="LN1870">1870</td><td class="line">		    tail = make_percent_swname(dir_name, fname_res);</td></tr>
<tr class="codeline" data-linenumber="1871"><td class="num" id="LN1871">1871</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="1872"><td class="num" id="LN1872">1872</td><td class="line">		<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1873"><td class="num" id="LN1873">1873</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1874"><td class="num" id="LN1874">1874</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="1875"><td class="num" id="LN1875">1875</td><td class="line">		    tail = gettail(fname_res);</td></tr>
<tr class="codeline" data-linenumber="1876"><td class="num" id="LN1876">1876</td><td class="line">		    tail = concat_fnames(dir_name, tail, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1877"><td class="num" id="LN1877">1877</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="1878"><td class="num" id="LN1878">1878</td><td class="line">		<span class='keyword'>if</span> (tail == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1879"><td class="num" id="LN1879">1879</td><td class="line">		    num_names = 0;</td></tr>
<tr class="codeline" data-linenumber="1880"><td class="num" id="LN1880">1880</td><td class="line">		<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1881"><td class="num" id="LN1881">1881</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="1882"><td class="num" id="LN1882">1882</td><td class="line">		    num_names = recov_file_names(names, tail, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1883"><td class="num" id="LN1883">1883</td><td class="line">		    vim_free(tail);</td></tr>
<tr class="codeline" data-linenumber="1884"><td class="num" id="LN1884">1884</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="1885"><td class="num" id="LN1885">1885</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="1886"><td class="num" id="LN1886">1886</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1887"><td class="num" id="LN1887">1887</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1888"><td class="num" id="LN1888">1888</td><td class="line">	<span class='comment'>// check for out-of-memory</span></td></tr>
<tr class="codeline" data-linenumber="1889"><td class="num" id="LN1889">1889</td><td class="line">	<span class='keyword'>for</span> (i = 0; i &lt; num_names; ++i)</td></tr>
<tr class="codeline" data-linenumber="1890"><td class="num" id="LN1890">1890</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="1891"><td class="num" id="LN1891">1891</td><td class="line">	    <span class='keyword'>if</span> (names[i] == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1892"><td class="num" id="LN1892">1892</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="1893"><td class="num" id="LN1893">1893</td><td class="line">		<span class='keyword'>for</span> (i = 0; i &lt; num_names; ++i)</td></tr>
<tr class="codeline" data-linenumber="1894"><td class="num" id="LN1894">1894</td><td class="line">		    vim_free(names[i]);</td></tr>
<tr class="codeline" data-linenumber="1895"><td class="num" id="LN1895">1895</td><td class="line">		num_names = 0;</td></tr>
<tr class="codeline" data-linenumber="1896"><td class="num" id="LN1896">1896</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="1897"><td class="num" id="LN1897">1897</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1898"><td class="num" id="LN1898">1898</td><td class="line">	<span class='keyword'>if</span> (num_names == 0)</td></tr>
<tr class="codeline" data-linenumber="1899"><td class="num" id="LN1899">1899</td><td class="line">	    num_files = 0;</td></tr>
<tr class="codeline" data-linenumber="1900"><td class="num" id="LN1900">1900</td><td class="line">	<span class='keyword'>else</span> <span class='keyword'>if</span> (expand_wildcards(num_names, names, &amp;num_files, &amp;files,</td></tr>
<tr class="codeline" data-linenumber="1901"><td class="num" id="LN1901">1901</td><td class="line">			    <span class='macro'>EW_NOTENV<span class='macro_popup'>0x10000</span></span>|<span class='macro'>EW_KEEPALL<span class='macro_popup'>0x10</span></span>|<span class='macro'>EW_FILE<span class='macro_popup'>0x02</span></span>|<span class='macro'>EW_SILENT<span class='macro_popup'>0x20</span></span>) == <span class='macro'>FAIL<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1902"><td class="num" id="LN1902">1902</td><td class="line">	    num_files = 0;</td></tr>
<tr class="codeline" data-linenumber="1903"><td class="num" id="LN1903">1903</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1904"><td class="num" id="LN1904">1904</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1905"><td class="num" id="LN1905">1905</td><td class="line">	 <span class='comment'>* When no swap file found, wildcard expansion might have failed (e.g.</span></td></tr>
<tr class="codeline" data-linenumber="1906"><td class="num" id="LN1906">1906</td><td class="line">	 <span class='comment'>* not able to execute the shell).</span></td></tr>
<tr class="codeline" data-linenumber="1907"><td class="num" id="LN1907">1907</td><td class="line">	 <span class='comment'>* Try finding a swap file by simply adding ".swp" to the file name.</span></td></tr>
<tr class="codeline" data-linenumber="1908"><td class="num" id="LN1908">1908</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1909"><td class="num" id="LN1909">1909</td><td class="line">	<span class='keyword'>if</span> (*dirp == <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span> &amp;&amp; file_count + num_files == 0 &amp;&amp; fname != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1910"><td class="num" id="LN1910">1910</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="1911"><td class="num" id="LN1911">1911</td><td class="line">	    stat_T	    st;</td></tr>
<tr class="codeline" data-linenumber="1912"><td class="num" id="LN1912">1912</td><td class="line">	    char_u	    *swapname;</td></tr>
<tr class="codeline" data-linenumber="1913"><td class="num" id="LN1913">1913</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1914"><td class="num" id="LN1914">1914</td><td class="line">	    swapname = modname(fname_res,</td></tr>
<tr class="codeline" data-linenumber="1915"><td class="num" id="LN1915">1915</td><td class="line"><span class='directive'>#if defined(VMS)</span></td></tr>
<tr class="codeline" data-linenumber="1916"><td class="num" id="LN1916">1916</td><td class="line">			       (char_u *)<span class='string_literal'>"_swp"</span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span></td></tr>
<tr class="codeline" data-linenumber="1917"><td class="num" id="LN1917">1917</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="1918"><td class="num" id="LN1918">1918</td><td class="line">			       (char_u *)<span class='string_literal'>".swp"</span>, <span class='macro'>TRUE<span class='macro_popup'>1</span></span></td></tr>
<tr class="codeline" data-linenumber="1919"><td class="num" id="LN1919">1919</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1920"><td class="num" id="LN1920">1920</td><td class="line">			      );</td></tr>
<tr class="codeline" data-linenumber="1921"><td class="num" id="LN1921">1921</td><td class="line">	    <span class='keyword'>if</span> (swapname != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1922"><td class="num" id="LN1922">1922</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="1923"><td class="num" id="LN1923">1923</td><td class="line">		<span class='keyword'>if</span> (<span class='macro'>mch_stat((<span class='keyword'>char</span> *)swapname, &amp;st)<span class='macro_popup'>stat(((char *)swapname), (&amp;st))</span></span> != -1)    <span class='comment'>// It exists!</span></td></tr>
<tr class="codeline" data-linenumber="1924"><td class="num" id="LN1924">1924</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="1925"><td class="num" id="LN1925">1925</td><td class="line">		    files = <span class='macro'>ALLOC_ONE(char_u *)<span class='macro_popup'>(char_u * *)alloc(sizeof(char_u *))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1926"><td class="num" id="LN1926">1926</td><td class="line">		    <span class='keyword'>if</span> (files != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1927"><td class="num" id="LN1927">1927</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="1928"><td class="num" id="LN1928">1928</td><td class="line">			files[0] = swapname;</td></tr>
<tr class="codeline" data-linenumber="1929"><td class="num" id="LN1929">1929</td><td class="line">			swapname = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1930"><td class="num" id="LN1930">1930</td><td class="line">			num_files = 1;</td></tr>
<tr class="codeline" data-linenumber="1931"><td class="num" id="LN1931">1931</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="1932"><td class="num" id="LN1932">1932</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="1933"><td class="num" id="LN1933">1933</td><td class="line">		vim_free(swapname);</td></tr>
<tr class="codeline" data-linenumber="1934"><td class="num" id="LN1934">1934</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="1935"><td class="num" id="LN1935">1935</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1936"><td class="num" id="LN1936">1936</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1937"><td class="num" id="LN1937">1937</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="1938"><td class="num" id="LN1938">1938</td><td class="line">	 <span class='comment'>* remove swapfile name of the current buffer, it must be ignored</span></td></tr>
<tr class="codeline" data-linenumber="1939"><td class="num" id="LN1939">1939</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1940"><td class="num" id="LN1940">1940</td><td class="line">	<span class='keyword'>if</span> (curbuf-&gt;b_ml.ml_mfp != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="1941"><td class="num" id="LN1941">1941</td><td class="line">			       &amp;&amp; (p = curbuf-&gt;b_ml.ml_mfp-&gt;mf_fname) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1942"><td class="num" id="LN1942">1942</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="1943"><td class="num" id="LN1943">1943</td><td class="line">	    <span class='keyword'>for</span> (i = 0; i &lt; num_files; ++i)</td></tr>
<tr class="codeline" data-linenumber="1944"><td class="num" id="LN1944">1944</td><td class="line">		<span class='comment'>// Do not expand wildcards, on windows would try to expand</span></td></tr>
<tr class="codeline" data-linenumber="1945"><td class="num" id="LN1945">1945</td><td class="line">		<span class='comment'>// "%tmp%" in "%tmp%file".</span></td></tr>
<tr class="codeline" data-linenumber="1946"><td class="num" id="LN1946">1946</td><td class="line">		<span class='keyword'>if</span> (fullpathcmp(p, files[i], <span class='macro'>TRUE<span class='macro_popup'>1</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>) &amp; <span class='macro'>FPC_SAME<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1947"><td class="num" id="LN1947">1947</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="1948"><td class="num" id="LN1948">1948</td><td class="line">		    <span class='comment'>// Remove the name from files[i].  Move further entries</span></td></tr>
<tr class="codeline" data-linenumber="1949"><td class="num" id="LN1949">1949</td><td class="line">		    <span class='comment'>// down.  When the array becomes empty free it here, since</span></td></tr>
<tr class="codeline" data-linenumber="1950"><td class="num" id="LN1950">1950</td><td class="line">		    <span class='comment'>// FreeWild() won't be called below.</span></td></tr>
<tr class="codeline" data-linenumber="1951"><td class="num" id="LN1951">1951</td><td class="line">		    vim_free(files[i]);</td></tr>
<tr class="codeline" data-linenumber="1952"><td class="num" id="LN1952">1952</td><td class="line">		    <span class='keyword'>if</span> (--num_files == 0)</td></tr>
<tr class="codeline" data-linenumber="1953"><td class="num" id="LN1953">1953</td><td class="line">			vim_free(files);</td></tr>
<tr class="codeline" data-linenumber="1954"><td class="num" id="LN1954">1954</td><td class="line">		    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1955"><td class="num" id="LN1955">1955</td><td class="line">			<span class='keyword'>for</span> ( ; i &lt; num_files; ++i)</td></tr>
<tr class="codeline" data-linenumber="1956"><td class="num" id="LN1956">1956</td><td class="line">			    files[i] = files[i + 1];</td></tr>
<tr class="codeline" data-linenumber="1957"><td class="num" id="LN1957">1957</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="1958"><td class="num" id="LN1958">1958</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1959"><td class="num" id="LN1959">1959</td><td class="line">	<span class='keyword'>if</span> (nr &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="1960"><td class="num" id="LN1960">1960</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="1961"><td class="num" id="LN1961">1961</td><td class="line">	    file_count += num_files;</td></tr>
<tr class="codeline" data-linenumber="1962"><td class="num" id="LN1962">1962</td><td class="line">	    <span class='keyword'>if</span> (nr &lt;= file_count)</td></tr>
<tr class="codeline" data-linenumber="1963"><td class="num" id="LN1963">1963</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="1964"><td class="num" id="LN1964">1964</td><td class="line">		*fname_out = vim_strsave(</td></tr>
<tr class="codeline" data-linenumber="1965"><td class="num" id="LN1965">1965</td><td class="line">				      files[nr - 1 + num_files - file_count]);</td></tr>
<tr class="codeline" data-linenumber="1966"><td class="num" id="LN1966">1966</td><td class="line">		dirp = (char_u *)<span class='string_literal'>""</span>;		    <span class='comment'>// stop searching</span></td></tr>
<tr class="codeline" data-linenumber="1967"><td class="num" id="LN1967">1967</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="1968"><td class="num" id="LN1968">1968</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="1969"><td class="num" id="LN1969">1969</td><td class="line">	<span class='keyword'>else</span> <span class='keyword'>if</span> (list)</td></tr>
<tr class="codeline" data-linenumber="1970"><td class="num" id="LN1970">1970</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="1971"><td class="num" id="LN1971">1971</td><td class="line">	    <span class='keyword'>if</span> (dir_name[0] == '.' &amp;&amp; dir_name[1] == <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1972"><td class="num" id="LN1972">1972</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="1973"><td class="num" id="LN1973">1973</td><td class="line">		<span class='keyword'>if</span> (fname == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1974"><td class="num" id="LN1974">1974</td><td class="line">		    msg_puts(<span class='macro'>_(<span class='string_literal'>"   In current directory:\n"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("   In current directory:\n")<br>, 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1975"><td class="num" id="LN1975">1975</td><td class="line">		<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1976"><td class="num" id="LN1976">1976</td><td class="line">		    msg_puts(<span class='macro'>_(<span class='string_literal'>"   Using specified name:\n"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("   Using specified name:\n")<br>, 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1977"><td class="num" id="LN1977">1977</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="1978"><td class="num" id="LN1978">1978</td><td class="line">	    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1979"><td class="num" id="LN1979">1979</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="1980"><td class="num" id="LN1980">1980</td><td class="line">		msg_puts(<span class='macro'>_(<span class='string_literal'>"   In directory "</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("   In directory "), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1981"><td class="num" id="LN1981">1981</td><td class="line">		msg_home_replace(dir_name);</td></tr>
<tr class="codeline" data-linenumber="1982"><td class="num" id="LN1982">1982</td><td class="line">		msg_puts(<span class='string_literal'>":\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1983"><td class="num" id="LN1983">1983</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="1984"><td class="num" id="LN1984">1984</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1985"><td class="num" id="LN1985">1985</td><td class="line">	    <span class='keyword'>if</span> (num_files)</td></tr>
<tr class="codeline" data-linenumber="1986"><td class="num" id="LN1986">1986</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="1987"><td class="num" id="LN1987">1987</td><td class="line">		<span class='keyword'>for</span> (i = 0; i &lt; num_files; ++i)</td></tr>
<tr class="codeline" data-linenumber="1988"><td class="num" id="LN1988">1988</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="1989"><td class="num" id="LN1989">1989</td><td class="line">		    <span class='comment'>// print the swap file name</span></td></tr>
<tr class="codeline" data-linenumber="1990"><td class="num" id="LN1990">1990</td><td class="line">		    msg_outnum((<span class='keyword'>long</span>)++file_count);</td></tr>
<tr class="codeline" data-linenumber="1991"><td class="num" id="LN1991">1991</td><td class="line">		    msg_puts(<span class='string_literal'>".    "</span>);</td></tr>
<tr class="codeline" data-linenumber="1992"><td class="num" id="LN1992">1992</td><td class="line">		    msg_puts((<span class='keyword'>char</span> *)gettail(files[i]));</td></tr>
<tr class="codeline" data-linenumber="1993"><td class="num" id="LN1993">1993</td><td class="line">		    msg_putchar('\n');</td></tr>
<tr class="codeline" data-linenumber="1994"><td class="num" id="LN1994">1994</td><td class="line">		    (<span class='keyword'>void</span>)swapfile_info(files[i]);</td></tr>
<tr class="codeline" data-linenumber="1995"><td class="num" id="LN1995">1995</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="1996"><td class="num" id="LN1996">1996</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="1997"><td class="num" id="LN1997">1997</td><td class="line">	    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1998"><td class="num" id="LN1998">1998</td><td class="line">		msg_puts(<span class='macro'>_(<span class='string_literal'>"      -- none --\n"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("      -- none --\n"), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1999"><td class="num" id="LN1999">1999</td><td class="line">	    out_flush();</td></tr>
<tr class="codeline" data-linenumber="2000"><td class="num" id="LN2000">2000</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="2001"><td class="num" id="LN2001">2001</td><td class="line">	<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2002"><td class="num" id="LN2002">2002</td><td class="line">	    file_count += num_files;</td></tr>
<tr class="codeline" data-linenumber="2003"><td class="num" id="LN2003">2003</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2004"><td class="num" id="LN2004">2004</td><td class="line">	<span class='keyword'>for</span> (i = 0; i &lt; num_names; ++i)</td></tr>
<tr class="codeline" data-linenumber="2005"><td class="num" id="LN2005">2005</td><td class="line">	    vim_free(names[i]);</td></tr>
<tr class="codeline" data-linenumber="2006"><td class="num" id="LN2006">2006</td><td class="line">	<span class='keyword'>if</span> (num_files &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="2007"><td class="num" id="LN2007">2007</td><td class="line">	    FreeWild(num_files, files);</td></tr>
<tr class="codeline" data-linenumber="2008"><td class="num" id="LN2008">2008</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2009"><td class="num" id="LN2009">2009</td><td class="line">    vim_free(dir_name);</td></tr>
<tr class="codeline" data-linenumber="2010"><td class="num" id="LN2010">2010</td><td class="line">    <span class='keyword'>return</span> file_count;</td></tr>
<tr class="codeline" data-linenumber="2011"><td class="num" id="LN2011">2011</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2012"><td class="num" id="LN2012">2012</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2013"><td class="num" id="LN2013">2013</td><td class="line"><span class='directive'>#if defined(<span class='macro'>UNIX<span class='macro_popup'>1</span></span>) || defined(MSWIN) || defined(PROTO)</span></td></tr>
<tr class="codeline" data-linenumber="2014"><td class="num" id="LN2014">2014</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2015"><td class="num" id="LN2015">2015</td><td class="line"> <span class='comment'>* Need _very_ long file names.</span></td></tr>
<tr class="codeline" data-linenumber="2016"><td class="num" id="LN2016">2016</td><td class="line"> <span class='comment'>* Append the full path to name with path separators made into percent</span></td></tr>
<tr class="codeline" data-linenumber="2017"><td class="num" id="LN2017">2017</td><td class="line"> <span class='comment'>* signs, to dir. An unnamed buffer is handled as "" (&lt;currentdir&gt;/"")</span></td></tr>
<tr class="codeline" data-linenumber="2018"><td class="num" id="LN2018">2018</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2019"><td class="num" id="LN2019">2019</td><td class="line">    char_u *</td></tr>
<tr class="codeline" data-linenumber="2020"><td class="num" id="LN2020">2020</td><td class="line">make_percent_swname(char_u *dir, char_u *name)</td></tr>
<tr class="codeline" data-linenumber="2021"><td class="num" id="LN2021">2021</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2022"><td class="num" id="LN2022">2022</td><td class="line">    char_u *d = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, *s, *f;</td></tr>
<tr class="codeline" data-linenumber="2023"><td class="num" id="LN2023">2023</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2024"><td class="num" id="LN2024">2024</td><td class="line">    f = fix_fname(name != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> ? name : (char_u *)<span class='string_literal'>""</span>);</td></tr>
<tr class="codeline" data-linenumber="2025"><td class="num" id="LN2025">2025</td><td class="line">    <span class='keyword'>if</span> (f != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2026"><td class="num" id="LN2026">2026</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2027"><td class="num" id="LN2027">2027</td><td class="line">	s = alloc(<span class='macro'>STRLEN(f)<span class='macro_popup'>strlen((char *)(f))</span></span> + 1);</td></tr>
<tr class="codeline" data-linenumber="2028"><td class="num" id="LN2028">2028</td><td class="line">	<span class='keyword'>if</span> (s != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2029"><td class="num" id="LN2029">2029</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="2030"><td class="num" id="LN2030">2030</td><td class="line">	    <span class="mrange"><span class='macro'>STRCPY</span>(s, f)<span class='macro_popup'>strcpy((char *)(s), (char *)(f))</span></span>;</td></tr>
<tr><td class="num"></td><td class="line"><div id="EndPath" class="msg msgEvent" style="margin-left:13ex; max-width:52em">Call to function 'strcpy' is insecure as it does not provide bounding of the memory buffer. Replace unbounded copy functions with analogous functions that support length arguments such as 'strlcpy'. CWE-119</div></td></tr>
<tr class="codeline" data-linenumber="2031"><td class="num" id="LN2031">2031</td><td class="line">	    <span class='keyword'>for</span> (d = s; *d != <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>; <span class='macro'>MB_PTR_ADV(d)<span class='macro_popup'>d += (*mb_ptr2len)(d)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2032"><td class="num" id="LN2032">2032</td><td class="line">		<span class='keyword'>if</span> (vim_ispathsep(*d))</td></tr>
<tr class="codeline" data-linenumber="2033"><td class="num" id="LN2033">2033</td><td class="line">		    *d = '%';</td></tr>
<tr class="codeline" data-linenumber="2034"><td class="num" id="LN2034">2034</td><td class="line">	    d = concat_fnames(dir, s, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2035"><td class="num" id="LN2035">2035</td><td class="line">	    vim_free(s);</td></tr>
<tr class="codeline" data-linenumber="2036"><td class="num" id="LN2036">2036</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="2037"><td class="num" id="LN2037">2037</td><td class="line">	vim_free(f);</td></tr>
<tr class="codeline" data-linenumber="2038"><td class="num" id="LN2038">2038</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2039"><td class="num" id="LN2039">2039</td><td class="line">    <span class='keyword'>return</span> d;</td></tr>
<tr class="codeline" data-linenumber="2040"><td class="num" id="LN2040">2040</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2041"><td class="num" id="LN2041">2041</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2042"><td class="num" id="LN2042">2042</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2043"><td class="num" id="LN2043">2043</td><td class="line"><span class='directive'>#if (defined(<span class='macro'>UNIX<span class='macro_popup'>1</span></span>) || defined(VMS) || defined(MSWIN)) \</span></td></tr>
<tr class="codeline" data-linenumber="2044"><td class="num" id="LN2044">2044</td><td class="line">	<span class='directive'>&amp;&amp; (defined(FEAT_GUI_DIALOG) || defined(FEAT_CON_DIALOG))</span></td></tr>
<tr class="codeline" data-linenumber="2045"><td class="num" id="LN2045">2045</td><td class="line"><span class='directive'># define HAVE_PROCESS_STILL_RUNNING</span></td></tr>
<tr class="codeline" data-linenumber="2046"><td class="num" id="LN2046">2046</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> process_still_running;</td></tr>
<tr class="codeline" data-linenumber="2047"><td class="num" id="LN2047">2047</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2048"><td class="num" id="LN2048">2048</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2049"><td class="num" id="LN2049">2049</td><td class="line"><span class='directive'>#if defined(FEAT_EVAL) || defined(PROTO)</span></td></tr>
<tr class="codeline" data-linenumber="2050"><td class="num" id="LN2050">2050</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2051"><td class="num" id="LN2051">2051</td><td class="line"> <span class='comment'>* Return information found in swapfile "fname" in dictionary "d".</span></td></tr>
<tr class="codeline" data-linenumber="2052"><td class="num" id="LN2052">2052</td><td class="line"> <span class='comment'>* This is used by the swapinfo() function.</span></td></tr>
<tr class="codeline" data-linenumber="2053"><td class="num" id="LN2053">2053</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2054"><td class="num" id="LN2054">2054</td><td class="line">    <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="2055"><td class="num" id="LN2055">2055</td><td class="line">get_b0_dict(char_u *fname, dict_T *d)</td></tr>
<tr class="codeline" data-linenumber="2056"><td class="num" id="LN2056">2056</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2057"><td class="num" id="LN2057">2057</td><td class="line">    <span class='keyword'>int</span> fd;</td></tr>
<tr class="codeline" data-linenumber="2058"><td class="num" id="LN2058">2058</td><td class="line">    <span class='keyword'>struct</span> block0 b0;</td></tr>
<tr class="codeline" data-linenumber="2059"><td class="num" id="LN2059">2059</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2060"><td class="num" id="LN2060">2060</td><td class="line">    <span class='keyword'>if</span> ((fd = <span class='macro'>mch_open((<span class='keyword'>char</span> *)fname, O_RDONLY | O_EXTRA, 0)<span class='macro_popup'>open(((char *)fname), (00 | 0), (0))</span></span>) &gt;= 0)</td></tr>
<tr class="codeline" data-linenumber="2061"><td class="num" id="LN2061">2061</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2062"><td class="num" id="LN2062">2062</td><td class="line">	<span class='keyword'>if</span> (read_eintr(fd, &amp;b0, <span class='keyword'>sizeof</span>(b0)) == <span class='keyword'>sizeof</span>(b0))</td></tr>
<tr class="codeline" data-linenumber="2063"><td class="num" id="LN2063">2063</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="2064"><td class="num" id="LN2064">2064</td><td class="line">	    <span class='keyword'>if</span> (ml_check_b0_id(&amp;b0) == <span class='macro'>FAIL<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2065"><td class="num" id="LN2065">2065</td><td class="line">		dict_add_string(d, <span class='string_literal'>"error"</span>, (char_u *)<span class='string_literal'>"Not a swap file"</span>);</td></tr>
<tr class="codeline" data-linenumber="2066"><td class="num" id="LN2066">2066</td><td class="line">	    <span class='keyword'>else</span> <span class='keyword'>if</span> (b0_magic_wrong(&amp;b0))</td></tr>
<tr class="codeline" data-linenumber="2067"><td class="num" id="LN2067">2067</td><td class="line">		dict_add_string(d, <span class='string_literal'>"error"</span>, (char_u *)<span class='string_literal'>"Magic number mismatch"</span>);</td></tr>
<tr class="codeline" data-linenumber="2068"><td class="num" id="LN2068">2068</td><td class="line">	    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2069"><td class="num" id="LN2069">2069</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="2070"><td class="num" id="LN2070">2070</td><td class="line">		<span class='comment'>// we have swap information</span></td></tr>
<tr class="codeline" data-linenumber="2071"><td class="num" id="LN2071">2071</td><td class="line">		dict_add_string_len(d, <span class='string_literal'>"version"</span>, b0.b0_version, 10);</td></tr>
<tr class="codeline" data-linenumber="2072"><td class="num" id="LN2072">2072</td><td class="line">		dict_add_string_len(d, <span class='string_literal'>"user"</span>, b0.b0_uname, <span class='macro'>B0_UNAME_SIZE<span class='macro_popup'>40</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2073"><td class="num" id="LN2073">2073</td><td class="line">		dict_add_string_len(d, <span class='string_literal'>"host"</span>, b0.b0_hname, <span class='macro'>B0_HNAME_SIZE<span class='macro_popup'>40</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2074"><td class="num" id="LN2074">2074</td><td class="line">		dict_add_string_len(d, <span class='string_literal'>"fname"</span>, b0.b0_fname, <span class='macro'>B0_FNAME_SIZE_ORG<span class='macro_popup'>900</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2075"><td class="num" id="LN2075">2075</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2076"><td class="num" id="LN2076">2076</td><td class="line">		dict_add_number(d, <span class='string_literal'>"pid"</span>, char_to_long(b0.b0_pid));</td></tr>
<tr class="codeline" data-linenumber="2077"><td class="num" id="LN2077">2077</td><td class="line">		dict_add_number(d, <span class='string_literal'>"mtime"</span>, char_to_long(b0.b0_mtime));</td></tr>
<tr class="codeline" data-linenumber="2078"><td class="num" id="LN2078">2078</td><td class="line">		dict_add_number(d, <span class='string_literal'>"dirty"</span>, b0.<span class='macro'>b0_dirty<span class='macro_popup'>b0_fname[900 - 1]</span></span> ? 1 : 0);</td></tr>
<tr class="codeline" data-linenumber="2079"><td class="num" id="LN2079">2079</td><td class="line"><span class='directive'># ifdef CHECK_INODE</span></td></tr>
<tr class="codeline" data-linenumber="2080"><td class="num" id="LN2080">2080</td><td class="line">		dict_add_number(d, <span class='string_literal'>"inode"</span>, char_to_long(b0.b0_ino));</td></tr>
<tr class="codeline" data-linenumber="2081"><td class="num" id="LN2081">2081</td><td class="line"><span class='directive'># endif</span></td></tr>
<tr class="codeline" data-linenumber="2082"><td class="num" id="LN2082">2082</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="2083"><td class="num" id="LN2083">2083</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="2084"><td class="num" id="LN2084">2084</td><td class="line">	<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2085"><td class="num" id="LN2085">2085</td><td class="line">	    dict_add_string(d, <span class='string_literal'>"error"</span>, (char_u *)<span class='string_literal'>"Cannot read file"</span>);</td></tr>
<tr class="codeline" data-linenumber="2086"><td class="num" id="LN2086">2086</td><td class="line">	close(fd);</td></tr>
<tr class="codeline" data-linenumber="2087"><td class="num" id="LN2087">2087</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2088"><td class="num" id="LN2088">2088</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2089"><td class="num" id="LN2089">2089</td><td class="line">	dict_add_string(d, <span class='string_literal'>"error"</span>, (char_u *)<span class='string_literal'>"Cannot open file"</span>);</td></tr>
<tr class="codeline" data-linenumber="2090"><td class="num" id="LN2090">2090</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2091"><td class="num" id="LN2091">2091</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2092"><td class="num" id="LN2092">2092</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2093"><td class="num" id="LN2093">2093</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2094"><td class="num" id="LN2094">2094</td><td class="line"> <span class='comment'>* Give information about an existing swap file.</span></td></tr>
<tr class="codeline" data-linenumber="2095"><td class="num" id="LN2095">2095</td><td class="line"> <span class='comment'>* Returns timestamp (0 when unknown).</span></td></tr>
<tr class="codeline" data-linenumber="2096"><td class="num" id="LN2096">2096</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2097"><td class="num" id="LN2097">2097</td><td class="line">    <span class='keyword'>static</span> time_t</td></tr>
<tr class="codeline" data-linenumber="2098"><td class="num" id="LN2098">2098</td><td class="line">swapfile_info(char_u *fname)</td></tr>
<tr class="codeline" data-linenumber="2099"><td class="num" id="LN2099">2099</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2100"><td class="num" id="LN2100">2100</td><td class="line">    stat_T	    st;</td></tr>
<tr class="codeline" data-linenumber="2101"><td class="num" id="LN2101">2101</td><td class="line">    <span class='keyword'>int</span>		    fd;</td></tr>
<tr class="codeline" data-linenumber="2102"><td class="num" id="LN2102">2102</td><td class="line">    <span class='keyword'>struct</span> block0   b0;</td></tr>
<tr class="codeline" data-linenumber="2103"><td class="num" id="LN2103">2103</td><td class="line"><span class='directive'>#ifdef <span class='macro'>UNIX<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="2104"><td class="num" id="LN2104">2104</td><td class="line">    char_u	    uname[<span class='macro'>B0_UNAME_SIZE<span class='macro_popup'>40</span></span>];</td></tr>
<tr class="codeline" data-linenumber="2105"><td class="num" id="LN2105">2105</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2106"><td class="num" id="LN2106">2106</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2107"><td class="num" id="LN2107">2107</td><td class="line">    <span class='comment'>// print the swap file date</span></td></tr>
<tr class="codeline" data-linenumber="2108"><td class="num" id="LN2108">2108</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>mch_stat((<span class='keyword'>char</span> *)fname, &amp;st)<span class='macro_popup'>stat(((char *)fname), (&amp;st))</span></span> != -1)</td></tr>
<tr class="codeline" data-linenumber="2109"><td class="num" id="LN2109">2109</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2110"><td class="num" id="LN2110">2110</td><td class="line"><span class='directive'>#ifdef <span class='macro'>UNIX<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="2111"><td class="num" id="LN2111">2111</td><td class="line">	<span class='comment'>// print name of owner of the file</span></td></tr>
<tr class="codeline" data-linenumber="2112"><td class="num" id="LN2112">2112</td><td class="line">	<span class='keyword'>if</span> (mch_get_uname(st.st_uid, uname, <span class='macro'>B0_UNAME_SIZE<span class='macro_popup'>40</span></span>) == <span class='macro'>OK<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2113"><td class="num" id="LN2113">2113</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="2114"><td class="num" id="LN2114">2114</td><td class="line">	    msg_puts(<span class='macro'>_(<span class='string_literal'>"          owned by: "</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("          owned by: "), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2115"><td class="num" id="LN2115">2115</td><td class="line">	    msg_outtrans(uname);</td></tr>
<tr class="codeline" data-linenumber="2116"><td class="num" id="LN2116">2116</td><td class="line">	    msg_puts(<span class='macro'>_(<span class='string_literal'>"   dated: "</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("   dated: "), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2117"><td class="num" id="LN2117">2117</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="2118"><td class="num" id="LN2118">2118</td><td class="line">	<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2119"><td class="num" id="LN2119">2119</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2120"><td class="num" id="LN2120">2120</td><td class="line">	    msg_puts(<span class='macro'>_(<span class='string_literal'>"             dated: "</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("             dated: "), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2121"><td class="num" id="LN2121">2121</td><td class="line">	msg_puts(get_ctime(st.<span class='macro'>st_mtime<span class='macro_popup'>st_mtim.tv_sec</span></span>, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>));</td></tr>
<tr class="codeline" data-linenumber="2122"><td class="num" id="LN2122">2122</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2123"><td class="num" id="LN2123">2123</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2124"><td class="num" id="LN2124">2124</td><td class="line">	st.<span class='macro'>st_mtime<span class='macro_popup'>st_mtim.tv_sec</span></span> = 0;</td></tr>
<tr class="codeline" data-linenumber="2125"><td class="num" id="LN2125">2125</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2126"><td class="num" id="LN2126">2126</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2127"><td class="num" id="LN2127">2127</td><td class="line">     <span class='comment'>* print the original file name</span></td></tr>
<tr class="codeline" data-linenumber="2128"><td class="num" id="LN2128">2128</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2129"><td class="num" id="LN2129">2129</td><td class="line">    fd = <span class='macro'>mch_open((<span class='keyword'>char</span> *)fname, O_RDONLY | O_EXTRA, 0)<span class='macro_popup'>open(((char *)fname), (00 | 0), (0))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2130"><td class="num" id="LN2130">2130</td><td class="line">    <span class='keyword'>if</span> (fd &gt;= 0)</td></tr>
<tr class="codeline" data-linenumber="2131"><td class="num" id="LN2131">2131</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2132"><td class="num" id="LN2132">2132</td><td class="line">	<span class='keyword'>if</span> (read_eintr(fd, &amp;b0, <span class='keyword'>sizeof</span>(b0)) == <span class='keyword'>sizeof</span>(b0))</td></tr>
<tr class="codeline" data-linenumber="2133"><td class="num" id="LN2133">2133</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="2134"><td class="num" id="LN2134">2134</td><td class="line">	    <span class='keyword'>if</span> (<span class='macro'>STRNCMP(b0.b0_version, <span class='string_literal'>"VIM 3.0"</span>, 7)<span class='macro_popup'>strncmp((char *)(b0.b0_version), (char *)("VIM 3.0"), (size_t<br>)(7))</span></span> == 0)</td></tr>
<tr class="codeline" data-linenumber="2135"><td class="num" id="LN2135">2135</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="2136"><td class="num" id="LN2136">2136</td><td class="line">		msg_puts(<span class='macro'>_(<span class='string_literal'>"         [from Vim version 3.0]"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("         [from Vim version 3.0]"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2137"><td class="num" id="LN2137">2137</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="2138"><td class="num" id="LN2138">2138</td><td class="line">	    <span class='keyword'>else</span> <span class='keyword'>if</span> (ml_check_b0_id(&amp;b0) == <span class='macro'>FAIL<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2139"><td class="num" id="LN2139">2139</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="2140"><td class="num" id="LN2140">2140</td><td class="line">		msg_puts(<span class='macro'>_(<span class='string_literal'>"         [does not look like a Vim swap file]"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("         [does not look like a Vim swap file]"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2141"><td class="num" id="LN2141">2141</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="2142"><td class="num" id="LN2142">2142</td><td class="line">	    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2143"><td class="num" id="LN2143">2143</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="2144"><td class="num" id="LN2144">2144</td><td class="line">		msg_puts(<span class='macro'>_(<span class='string_literal'>"         file name: "</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("         file name: "), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2145"><td class="num" id="LN2145">2145</td><td class="line">		<span class='keyword'>if</span> (b0.b0_fname[0] == <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2146"><td class="num" id="LN2146">2146</td><td class="line">		    msg_puts(<span class='macro'>_(<span class='string_literal'>"[No Name]"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("[No Name]"), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2147"><td class="num" id="LN2147">2147</td><td class="line">		<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2148"><td class="num" id="LN2148">2148</td><td class="line">		    msg_outtrans(b0.b0_fname);</td></tr>
<tr class="codeline" data-linenumber="2149"><td class="num" id="LN2149">2149</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2150"><td class="num" id="LN2150">2150</td><td class="line">		msg_puts(<span class='macro'>_(<span class='string_literal'>"\n          modified: "</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("\n          modified: "), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2151"><td class="num" id="LN2151">2151</td><td class="line">		msg_puts(b0.<span class='macro'>b0_dirty<span class='macro_popup'>b0_fname[900 - 1]</span></span> ? <span class='macro'>_(<span class='string_literal'>"YES"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("YES"), 5)</span></span> : <span class='macro'>_(<span class='string_literal'>"no"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("no"), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2152"><td class="num" id="LN2152">2152</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2153"><td class="num" id="LN2153">2153</td><td class="line">		<span class='keyword'>if</span> (*(b0.b0_uname) != <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2154"><td class="num" id="LN2154">2154</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="2155"><td class="num" id="LN2155">2155</td><td class="line">		    msg_puts(<span class='macro'>_(<span class='string_literal'>"\n         user name: "</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("\n         user name: "), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2156"><td class="num" id="LN2156">2156</td><td class="line">		    msg_outtrans(b0.b0_uname);</td></tr>
<tr class="codeline" data-linenumber="2157"><td class="num" id="LN2157">2157</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="2158"><td class="num" id="LN2158">2158</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2159"><td class="num" id="LN2159">2159</td><td class="line">		<span class='keyword'>if</span> (*(b0.b0_hname) != <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2160"><td class="num" id="LN2160">2160</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="2161"><td class="num" id="LN2161">2161</td><td class="line">		    <span class='keyword'>if</span> (*(b0.b0_uname) != <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2162"><td class="num" id="LN2162">2162</td><td class="line">			msg_puts(<span class='macro'>_(<span class='string_literal'>"   host name: "</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("   host name: "), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2163"><td class="num" id="LN2163">2163</td><td class="line">		    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2164"><td class="num" id="LN2164">2164</td><td class="line">			msg_puts(<span class='macro'>_(<span class='string_literal'>"\n         host name: "</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("\n         host name: "), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2165"><td class="num" id="LN2165">2165</td><td class="line">		    msg_outtrans(b0.b0_hname);</td></tr>
<tr class="codeline" data-linenumber="2166"><td class="num" id="LN2166">2166</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="2167"><td class="num" id="LN2167">2167</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2168"><td class="num" id="LN2168">2168</td><td class="line">		<span class='keyword'>if</span> (char_to_long(b0.b0_pid) != 0L)</td></tr>
<tr class="codeline" data-linenumber="2169"><td class="num" id="LN2169">2169</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="2170"><td class="num" id="LN2170">2170</td><td class="line">		    msg_puts(<span class='macro'>_(<span class='string_literal'>"\n        process ID: "</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("\n        process ID: "), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2171"><td class="num" id="LN2171">2171</td><td class="line">		    msg_outnum(char_to_long(b0.b0_pid));</td></tr>
<tr class="codeline" data-linenumber="2172"><td class="num" id="LN2172">2172</td><td class="line"><span class='directive'>#if defined(<span class='macro'>UNIX<span class='macro_popup'>1</span></span>) || defined(MSWIN)</span></td></tr>
<tr class="codeline" data-linenumber="2173"><td class="num" id="LN2173">2173</td><td class="line">		    <span class='keyword'>if</span> (mch_process_running(char_to_long(b0.b0_pid)))</td></tr>
<tr class="codeline" data-linenumber="2174"><td class="num" id="LN2174">2174</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="2175"><td class="num" id="LN2175">2175</td><td class="line">			msg_puts(<span class='macro'>_(<span class='string_literal'>" (STILL RUNNING)"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)(" (STILL RUNNING)"), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2176"><td class="num" id="LN2176">2176</td><td class="line"><span class='directive'># ifdef HAVE_PROCESS_STILL_RUNNING</span></td></tr>
<tr class="codeline" data-linenumber="2177"><td class="num" id="LN2177">2177</td><td class="line">			process_still_running = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2178"><td class="num" id="LN2178">2178</td><td class="line"><span class='directive'># endif</span></td></tr>
<tr class="codeline" data-linenumber="2179"><td class="num" id="LN2179">2179</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="2180"><td class="num" id="LN2180">2180</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2181"><td class="num" id="LN2181">2181</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="2182"><td class="num" id="LN2182">2182</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2183"><td class="num" id="LN2183">2183</td><td class="line">		<span class='keyword'>if</span> (b0_magic_wrong(&amp;b0))</td></tr>
<tr class="codeline" data-linenumber="2184"><td class="num" id="LN2184">2184</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="2185"><td class="num" id="LN2185">2185</td><td class="line"><span class='directive'>#if defined(MSWIN)</span></td></tr>
<tr class="codeline" data-linenumber="2186"><td class="num" id="LN2186">2186</td><td class="line">		    <span class='keyword'>if</span> (<span class='macro'>STRNCMP(b0.b0_hname, <span class='string_literal'>"PC "</span>, 3)<span class='macro_popup'>strncmp((char *)(b0.b0_hname), (char *)("PC "), (size_t)(3))</span></span> == 0)</td></tr>
<tr class="codeline" data-linenumber="2187"><td class="num" id="LN2187">2187</td><td class="line">			msg_puts(<span class='macro'>_(<span class='string_literal'>"\n         [not usable with this version of Vim]"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("\n         [not usable with this version of Vim]"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2188"><td class="num" id="LN2188">2188</td><td class="line">		    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2189"><td class="num" id="LN2189">2189</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2190"><td class="num" id="LN2190">2190</td><td class="line">			msg_puts(<span class='macro'>_(<span class='string_literal'>"\n         [not usable on this computer]"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("\n         [not usable on this computer]"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2191"><td class="num" id="LN2191">2191</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="2192"><td class="num" id="LN2192">2192</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="2193"><td class="num" id="LN2193">2193</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="2194"><td class="num" id="LN2194">2194</td><td class="line">	<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2195"><td class="num" id="LN2195">2195</td><td class="line">	    msg_puts(<span class='macro'>_(<span class='string_literal'>"         [cannot be read]"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("         [cannot be read]"),<br> 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2196"><td class="num" id="LN2196">2196</td><td class="line">	close(fd);</td></tr>
<tr class="codeline" data-linenumber="2197"><td class="num" id="LN2197">2197</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2198"><td class="num" id="LN2198">2198</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2199"><td class="num" id="LN2199">2199</td><td class="line">	msg_puts(<span class='macro'>_(<span class='string_literal'>"         [cannot be opened]"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("         [cannot be opened]"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2200"><td class="num" id="LN2200">2200</td><td class="line">    msg_putchar('\n');</td></tr>
<tr class="codeline" data-linenumber="2201"><td class="num" id="LN2201">2201</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2202"><td class="num" id="LN2202">2202</td><td class="line">    <span class='keyword'>return</span> st.<span class='macro'>st_mtime<span class='macro_popup'>st_mtim.tv_sec</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2203"><td class="num" id="LN2203">2203</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2204"><td class="num" id="LN2204">2204</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2205"><td class="num" id="LN2205">2205</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2206"><td class="num" id="LN2206">2206</td><td class="line"> <span class='comment'>* Return TRUE if the swap file looks OK and there are no changes, thus it can</span></td></tr>
<tr class="codeline" data-linenumber="2207"><td class="num" id="LN2207">2207</td><td class="line"> <span class='comment'>* be safely deleted.</span></td></tr>
<tr class="codeline" data-linenumber="2208"><td class="num" id="LN2208">2208</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2209"><td class="num" id="LN2209">2209</td><td class="line">    <span class='keyword'>static</span> time_t</td></tr>
<tr class="codeline" data-linenumber="2210"><td class="num" id="LN2210">2210</td><td class="line">swapfile_unchanged(char_u *fname)</td></tr>
<tr class="codeline" data-linenumber="2211"><td class="num" id="LN2211">2211</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2212"><td class="num" id="LN2212">2212</td><td class="line">    stat_T	    st;</td></tr>
<tr class="codeline" data-linenumber="2213"><td class="num" id="LN2213">2213</td><td class="line">    <span class='keyword'>int</span>		    fd;</td></tr>
<tr class="codeline" data-linenumber="2214"><td class="num" id="LN2214">2214</td><td class="line">    <span class='keyword'>struct</span> block0   b0;</td></tr>
<tr class="codeline" data-linenumber="2215"><td class="num" id="LN2215">2215</td><td class="line">    <span class='keyword'>int</span>		    ret = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2216"><td class="num" id="LN2216">2216</td><td class="line"><span class='directive'>#if defined(<span class='macro'>UNIX<span class='macro_popup'>1</span></span>) || defined(MSWIN)</span></td></tr>
<tr class="codeline" data-linenumber="2217"><td class="num" id="LN2217">2217</td><td class="line">    <span class='keyword'>long</span>	    pid;</td></tr>
<tr class="codeline" data-linenumber="2218"><td class="num" id="LN2218">2218</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2219"><td class="num" id="LN2219">2219</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2220"><td class="num" id="LN2220">2220</td><td class="line">    <span class='comment'>// must be able to stat the swap file</span></td></tr>
<tr class="codeline" data-linenumber="2221"><td class="num" id="LN2221">2221</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>mch_stat((<span class='keyword'>char</span> *)fname, &amp;st)<span class='macro_popup'>stat(((char *)fname), (&amp;st))</span></span> == -1)</td></tr>
<tr class="codeline" data-linenumber="2222"><td class="num" id="LN2222">2222</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2223"><td class="num" id="LN2223">2223</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2224"><td class="num" id="LN2224">2224</td><td class="line">    <span class='comment'>// must be able to read the first block</span></td></tr>
<tr class="codeline" data-linenumber="2225"><td class="num" id="LN2225">2225</td><td class="line">    fd = <span class='macro'>mch_open((<span class='keyword'>char</span> *)fname, O_RDONLY | O_EXTRA, 0)<span class='macro_popup'>open(((char *)fname), (00 | 0), (0))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2226"><td class="num" id="LN2226">2226</td><td class="line">    <span class='keyword'>if</span> (fd &lt; 0)</td></tr>
<tr class="codeline" data-linenumber="2227"><td class="num" id="LN2227">2227</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2228"><td class="num" id="LN2228">2228</td><td class="line">    <span class='keyword'>if</span> (read_eintr(fd, &amp;b0, <span class='keyword'>sizeof</span>(b0)) != <span class='keyword'>sizeof</span>(b0))</td></tr>
<tr class="codeline" data-linenumber="2229"><td class="num" id="LN2229">2229</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2230"><td class="num" id="LN2230">2230</td><td class="line">	close(fd);</td></tr>
<tr class="codeline" data-linenumber="2231"><td class="num" id="LN2231">2231</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2232"><td class="num" id="LN2232">2232</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2233"><td class="num" id="LN2233">2233</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2234"><td class="num" id="LN2234">2234</td><td class="line">    <span class='comment'>// the ID and magic number must be correct</span></td></tr>
<tr class="codeline" data-linenumber="2235"><td class="num" id="LN2235">2235</td><td class="line">    <span class='keyword'>if</span> (ml_check_b0_id(&amp;b0) == <span class='macro'>FAIL<span class='macro_popup'>0</span></span>|| b0_magic_wrong(&amp;b0))</td></tr>
<tr class="codeline" data-linenumber="2236"><td class="num" id="LN2236">2236</td><td class="line">	ret = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2237"><td class="num" id="LN2237">2237</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2238"><td class="num" id="LN2238">2238</td><td class="line">    <span class='comment'>// must be unchanged</span></td></tr>
<tr class="codeline" data-linenumber="2239"><td class="num" id="LN2239">2239</td><td class="line">    <span class='keyword'>if</span> (b0.<span class='macro'>b0_dirty<span class='macro_popup'>b0_fname[900 - 1]</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2240"><td class="num" id="LN2240">2240</td><td class="line">	ret = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2241"><td class="num" id="LN2241">2241</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2242"><td class="num" id="LN2242">2242</td><td class="line"><span class='directive'>#if defined(<span class='macro'>UNIX<span class='macro_popup'>1</span></span>) || defined(MSWIN)</span></td></tr>
<tr class="codeline" data-linenumber="2243"><td class="num" id="LN2243">2243</td><td class="line">    <span class='comment'>// Host name must be known and must equal the current host name, otherwise</span></td></tr>
<tr class="codeline" data-linenumber="2244"><td class="num" id="LN2244">2244</td><td class="line">    <span class='comment'>// comparing pid is meaningless.</span></td></tr>
<tr class="codeline" data-linenumber="2245"><td class="num" id="LN2245">2245</td><td class="line">    <span class='keyword'>if</span> (*(b0.b0_hname) == <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2246"><td class="num" id="LN2246">2246</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2247"><td class="num" id="LN2247">2247</td><td class="line">	ret = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2248"><td class="num" id="LN2248">2248</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2249"><td class="num" id="LN2249">2249</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2250"><td class="num" id="LN2250">2250</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2251"><td class="num" id="LN2251">2251</td><td class="line">	char_u	    hostname[<span class='macro'>B0_HNAME_SIZE<span class='macro_popup'>40</span></span>];</td></tr>
<tr class="codeline" data-linenumber="2252"><td class="num" id="LN2252">2252</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2253"><td class="num" id="LN2253">2253</td><td class="line">	mch_get_host_name(hostname, <span class='macro'>B0_HNAME_SIZE<span class='macro_popup'>40</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2254"><td class="num" id="LN2254">2254</td><td class="line">	hostname[<span class='macro'>B0_HNAME_SIZE<span class='macro_popup'>40</span></span> - 1] = <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2255"><td class="num" id="LN2255">2255</td><td class="line">	b0.b0_hname[<span class='macro'>B0_HNAME_SIZE<span class='macro_popup'>40</span></span> - 1] = <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>; <span class='comment'>// in case of corruption</span></td></tr>
<tr class="codeline" data-linenumber="2256"><td class="num" id="LN2256">2256</td><td class="line">	<span class='keyword'>if</span> (<span class='macro'>STRICMP(b0.b0_hname, hostname)<span class='macro_popup'>strcasecmp((char *)(b0.b0_hname), (char *)(hostname))</span></span> != 0)</td></tr>
<tr class="codeline" data-linenumber="2257"><td class="num" id="LN2257">2257</td><td class="line">	    ret = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2258"><td class="num" id="LN2258">2258</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2259"><td class="num" id="LN2259">2259</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2260"><td class="num" id="LN2260">2260</td><td class="line">    <span class='comment'>// process must be known and not be running</span></td></tr>
<tr class="codeline" data-linenumber="2261"><td class="num" id="LN2261">2261</td><td class="line">    pid = char_to_long(b0.b0_pid);</td></tr>
<tr class="codeline" data-linenumber="2262"><td class="num" id="LN2262">2262</td><td class="line">    <span class='keyword'>if</span> (pid == 0L || mch_process_running(pid))</td></tr>
<tr class="codeline" data-linenumber="2263"><td class="num" id="LN2263">2263</td><td class="line">	ret = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2264"><td class="num" id="LN2264">2264</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2265"><td class="num" id="LN2265">2265</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2266"><td class="num" id="LN2266">2266</td><td class="line">    <span class='comment'>// We do not check the user, it should be irrelevant for whether the swap</span></td></tr>
<tr class="codeline" data-linenumber="2267"><td class="num" id="LN2267">2267</td><td class="line">    <span class='comment'>// file is still useful.</span></td></tr>
<tr class="codeline" data-linenumber="2268"><td class="num" id="LN2268">2268</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2269"><td class="num" id="LN2269">2269</td><td class="line">    close(fd);</td></tr>
<tr class="codeline" data-linenumber="2270"><td class="num" id="LN2270">2270</td><td class="line">    <span class='keyword'>return</span> ret;</td></tr>
<tr class="codeline" data-linenumber="2271"><td class="num" id="LN2271">2271</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2272"><td class="num" id="LN2272">2272</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2273"><td class="num" id="LN2273">2273</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="2274"><td class="num" id="LN2274">2274</td><td class="line">recov_file_names(char_u **names, char_u *path, <span class='keyword'>int</span> prepend_dot)</td></tr>
<tr class="codeline" data-linenumber="2275"><td class="num" id="LN2275">2275</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2276"><td class="num" id="LN2276">2276</td><td class="line">    <span class='keyword'>int</span>		num_names;</td></tr>
<tr class="codeline" data-linenumber="2277"><td class="num" id="LN2277">2277</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2278"><td class="num" id="LN2278">2278</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2279"><td class="num" id="LN2279">2279</td><td class="line">     <span class='comment'>* (Win32 and Win64) never short names, but do prepend a dot.</span></td></tr>
<tr class="codeline" data-linenumber="2280"><td class="num" id="LN2280">2280</td><td class="line">     <span class='comment'>* (Not MS-DOS or Win32 or Win64) maybe short name, maybe not: Try both.</span></td></tr>
<tr class="codeline" data-linenumber="2281"><td class="num" id="LN2281">2281</td><td class="line">     <span class='comment'>* Only use the short name if it is different.</span></td></tr>
<tr class="codeline" data-linenumber="2282"><td class="num" id="LN2282">2282</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2283"><td class="num" id="LN2283">2283</td><td class="line">    char_u	*p;</td></tr>
<tr class="codeline" data-linenumber="2284"><td class="num" id="LN2284">2284</td><td class="line">    <span class='keyword'>int</span>		i;</td></tr>
<tr class="codeline" data-linenumber="2285"><td class="num" id="LN2285">2285</td><td class="line"><span class='directive'># ifndef MSWIN</span></td></tr>
<tr class="codeline" data-linenumber="2286"><td class="num" id="LN2286">2286</td><td class="line">    <span class='keyword'>int</span>	    shortname = curbuf-&gt;b_shortname;</td></tr>
<tr class="codeline" data-linenumber="2287"><td class="num" id="LN2287">2287</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2288"><td class="num" id="LN2288">2288</td><td class="line">    curbuf-&gt;b_shortname = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2289"><td class="num" id="LN2289">2289</td><td class="line"><span class='directive'># endif</span></td></tr>
<tr class="codeline" data-linenumber="2290"><td class="num" id="LN2290">2290</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2291"><td class="num" id="LN2291">2291</td><td class="line">    num_names = 0;</td></tr>
<tr class="codeline" data-linenumber="2292"><td class="num" id="LN2292">2292</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2293"><td class="num" id="LN2293">2293</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2294"><td class="num" id="LN2294">2294</td><td class="line">     <span class='comment'>* May also add the file name with a dot prepended, for swap file in same</span></td></tr>
<tr class="codeline" data-linenumber="2295"><td class="num" id="LN2295">2295</td><td class="line">     <span class='comment'>* dir as original file.</span></td></tr>
<tr class="codeline" data-linenumber="2296"><td class="num" id="LN2296">2296</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2297"><td class="num" id="LN2297">2297</td><td class="line">    <span class='keyword'>if</span> (prepend_dot)</td></tr>
<tr class="codeline" data-linenumber="2298"><td class="num" id="LN2298">2298</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2299"><td class="num" id="LN2299">2299</td><td class="line">	names[num_names] = modname(path, (char_u *)<span class='string_literal'>".sw?"</span>, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2300"><td class="num" id="LN2300">2300</td><td class="line">	<span class='keyword'>if</span> (names[num_names] == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2301"><td class="num" id="LN2301">2301</td><td class="line">	    <span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="2302"><td class="num" id="LN2302">2302</td><td class="line">	++num_names;</td></tr>
<tr class="codeline" data-linenumber="2303"><td class="num" id="LN2303">2303</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2304"><td class="num" id="LN2304">2304</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2305"><td class="num" id="LN2305">2305</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2306"><td class="num" id="LN2306">2306</td><td class="line">     <span class='comment'>* Form the normal swap file name pattern by appending ".sw?".</span></td></tr>
<tr class="codeline" data-linenumber="2307"><td class="num" id="LN2307">2307</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2308"><td class="num" id="LN2308">2308</td><td class="line"><span class='directive'>#ifdef VMS</span></td></tr>
<tr class="codeline" data-linenumber="2309"><td class="num" id="LN2309">2309</td><td class="line">    names[num_names] = concat_fnames(path, (char_u *)<span class='string_literal'>"_sw%"</span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2310"><td class="num" id="LN2310">2310</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="2311"><td class="num" id="LN2311">2311</td><td class="line">    names[num_names] = concat_fnames(path, (char_u *)<span class='string_literal'>".sw?"</span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2312"><td class="num" id="LN2312">2312</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2313"><td class="num" id="LN2313">2313</td><td class="line">    <span class='keyword'>if</span> (names[num_names] == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2314"><td class="num" id="LN2314">2314</td><td class="line">	<span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="2315"><td class="num" id="LN2315">2315</td><td class="line">    <span class='keyword'>if</span> (num_names &gt;= 1)	    <span class='comment'>// check if we have the same name twice</span></td></tr>
<tr class="codeline" data-linenumber="2316"><td class="num" id="LN2316">2316</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2317"><td class="num" id="LN2317">2317</td><td class="line">	p = names[num_names - 1];</td></tr>
<tr class="codeline" data-linenumber="2318"><td class="num" id="LN2318">2318</td><td class="line">	i = (<span class='keyword'>int</span>)<span class='macro'>STRLEN(names[num_names - 1])<span class='macro_popup'>strlen((char *)(names[num_names - 1]))</span></span> - (<span class='keyword'>int</span>)<span class='macro'>STRLEN(names[num_names])<span class='macro_popup'>strlen((char *)(names[num_names]))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2319"><td class="num" id="LN2319">2319</td><td class="line">	<span class='keyword'>if</span> (i &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="2320"><td class="num" id="LN2320">2320</td><td class="line">	    p += i;	    <span class='comment'>// file name has been expanded to full path</span></td></tr>
<tr class="codeline" data-linenumber="2321"><td class="num" id="LN2321">2321</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2322"><td class="num" id="LN2322">2322</td><td class="line">	<span class='keyword'>if</span> (<span class='macro'>STRCMP(p, names[num_names])<span class='macro_popup'>strcmp((char *)(p), (char *)(names[num_names]))</span></span> != 0)</td></tr>
<tr class="codeline" data-linenumber="2323"><td class="num" id="LN2323">2323</td><td class="line">	    ++num_names;</td></tr>
<tr class="codeline" data-linenumber="2324"><td class="num" id="LN2324">2324</td><td class="line">	<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2325"><td class="num" id="LN2325">2325</td><td class="line">	    vim_free(names[num_names]);</td></tr>
<tr class="codeline" data-linenumber="2326"><td class="num" id="LN2326">2326</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2327"><td class="num" id="LN2327">2327</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2328"><td class="num" id="LN2328">2328</td><td class="line">	++num_names;</td></tr>
<tr class="codeline" data-linenumber="2329"><td class="num" id="LN2329">2329</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2330"><td class="num" id="LN2330">2330</td><td class="line"><span class='directive'># ifndef MSWIN</span></td></tr>
<tr class="codeline" data-linenumber="2331"><td class="num" id="LN2331">2331</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2332"><td class="num" id="LN2332">2332</td><td class="line">     <span class='comment'>* Also try with 'shortname' set, in case the file is on a DOS filesystem.</span></td></tr>
<tr class="codeline" data-linenumber="2333"><td class="num" id="LN2333">2333</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2334"><td class="num" id="LN2334">2334</td><td class="line">    curbuf-&gt;b_shortname = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2335"><td class="num" id="LN2335">2335</td><td class="line"><span class='directive'>#ifdef VMS</span></td></tr>
<tr class="codeline" data-linenumber="2336"><td class="num" id="LN2336">2336</td><td class="line">    names[num_names] = modname(path, (char_u *)<span class='string_literal'>"_sw%"</span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2337"><td class="num" id="LN2337">2337</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="2338"><td class="num" id="LN2338">2338</td><td class="line">    names[num_names] = modname(path, (char_u *)<span class='string_literal'>".sw?"</span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2339"><td class="num" id="LN2339">2339</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2340"><td class="num" id="LN2340">2340</td><td class="line">    <span class='keyword'>if</span> (names[num_names] == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2341"><td class="num" id="LN2341">2341</td><td class="line">	<span class='keyword'>goto</span> end;</td></tr>
<tr class="codeline" data-linenumber="2342"><td class="num" id="LN2342">2342</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2343"><td class="num" id="LN2343">2343</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2344"><td class="num" id="LN2344">2344</td><td class="line">     <span class='comment'>* Remove the one from 'shortname', if it's the same as with 'noshortname'.</span></td></tr>
<tr class="codeline" data-linenumber="2345"><td class="num" id="LN2345">2345</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2346"><td class="num" id="LN2346">2346</td><td class="line">    p = names[num_names];</td></tr>
<tr class="codeline" data-linenumber="2347"><td class="num" id="LN2347">2347</td><td class="line">    i = <span class='macro'>STRLEN(names[num_names])<span class='macro_popup'>strlen((char *)(names[num_names]))</span></span> - <span class='macro'>STRLEN(names[num_names - 1])<span class='macro_popup'>strlen((char *)(names[num_names - 1]))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2348"><td class="num" id="LN2348">2348</td><td class="line">    <span class='keyword'>if</span> (i &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="2349"><td class="num" id="LN2349">2349</td><td class="line">	p += i;		<span class='comment'>// file name has been expanded to full path</span></td></tr>
<tr class="codeline" data-linenumber="2350"><td class="num" id="LN2350">2350</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>STRCMP(names[num_names - 1], p)<span class='macro_popup'>strcmp((char *)(names[num_names - 1]), (char *)(p))</span></span> == 0)</td></tr>
<tr class="codeline" data-linenumber="2351"><td class="num" id="LN2351">2351</td><td class="line">	vim_free(names[num_names]);</td></tr>
<tr class="codeline" data-linenumber="2352"><td class="num" id="LN2352">2352</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2353"><td class="num" id="LN2353">2353</td><td class="line">	++num_names;</td></tr>
<tr class="codeline" data-linenumber="2354"><td class="num" id="LN2354">2354</td><td class="line"><span class='directive'># endif</span></td></tr>
<tr class="codeline" data-linenumber="2355"><td class="num" id="LN2355">2355</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2356"><td class="num" id="LN2356">2356</td><td class="line">end:</td></tr>
<tr class="codeline" data-linenumber="2357"><td class="num" id="LN2357">2357</td><td class="line"><span class='directive'># ifndef MSWIN</span></td></tr>
<tr class="codeline" data-linenumber="2358"><td class="num" id="LN2358">2358</td><td class="line">    curbuf-&gt;b_shortname = shortname;</td></tr>
<tr class="codeline" data-linenumber="2359"><td class="num" id="LN2359">2359</td><td class="line"><span class='directive'># endif</span></td></tr>
<tr class="codeline" data-linenumber="2360"><td class="num" id="LN2360">2360</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2361"><td class="num" id="LN2361">2361</td><td class="line">    <span class='keyword'>return</span> num_names;</td></tr>
<tr class="codeline" data-linenumber="2362"><td class="num" id="LN2362">2362</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2363"><td class="num" id="LN2363">2363</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2364"><td class="num" id="LN2364">2364</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2365"><td class="num" id="LN2365">2365</td><td class="line"> <span class='comment'>* sync all memlines</span></td></tr>
<tr class="codeline" data-linenumber="2366"><td class="num" id="LN2366">2366</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2367"><td class="num" id="LN2367">2367</td><td class="line"> <span class='comment'>* If 'check_file' is TRUE, check if original file exists and was not changed.</span></td></tr>
<tr class="codeline" data-linenumber="2368"><td class="num" id="LN2368">2368</td><td class="line"> <span class='comment'>* If 'check_char' is TRUE, stop syncing when character becomes available, but</span></td></tr>
<tr class="codeline" data-linenumber="2369"><td class="num" id="LN2369">2369</td><td class="line"> <span class='comment'>* always sync at least one block.</span></td></tr>
<tr class="codeline" data-linenumber="2370"><td class="num" id="LN2370">2370</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2371"><td class="num" id="LN2371">2371</td><td class="line">    <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="2372"><td class="num" id="LN2372">2372</td><td class="line">ml_sync_all(<span class='keyword'>int</span> check_file, <span class='keyword'>int</span> check_char)</td></tr>
<tr class="codeline" data-linenumber="2373"><td class="num" id="LN2373">2373</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2374"><td class="num" id="LN2374">2374</td><td class="line">    buf_T		*buf;</td></tr>
<tr class="codeline" data-linenumber="2375"><td class="num" id="LN2375">2375</td><td class="line">    stat_T		st;</td></tr>
<tr class="codeline" data-linenumber="2376"><td class="num" id="LN2376">2376</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2377"><td class="num" id="LN2377">2377</td><td class="line">    <span class='macro'>FOR_ALL_BUFFERS(buf)<span class='macro_popup'>for ((buf) = firstbuf; (buf) != ((void*)0); (buf) = (buf)-&gt;<br>b_next)</span></span></td></tr>
<tr class="codeline" data-linenumber="2378"><td class="num" id="LN2378">2378</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2379"><td class="num" id="LN2379">2379</td><td class="line">	<span class='keyword'>if</span> (buf-&gt;b_ml.ml_mfp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || buf-&gt;b_ml.ml_mfp-&gt;mf_fname == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2380"><td class="num" id="LN2380">2380</td><td class="line">	    <span class='keyword'>continue</span>;			    <span class='comment'>// no file</span></td></tr>
<tr class="codeline" data-linenumber="2381"><td class="num" id="LN2381">2381</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2382"><td class="num" id="LN2382">2382</td><td class="line">	ml_flush_line(buf);		    <span class='comment'>// flush buffered line</span></td></tr>
<tr class="codeline" data-linenumber="2383"><td class="num" id="LN2383">2383</td><td class="line">					    <span class='comment'>// flush locked block</span></td></tr>
<tr class="codeline" data-linenumber="2384"><td class="num" id="LN2384">2384</td><td class="line">	(<span class='keyword'>void</span>)ml_find_line(buf, (linenr_T)0, <span class='macro'>ML_FLUSH<span class='macro_popup'>0x02</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2385"><td class="num" id="LN2385">2385</td><td class="line">	<span class='keyword'>if</span> (bufIsChanged(buf) &amp;&amp; check_file &amp;&amp; mf_need_trans(buf-&gt;b_ml.ml_mfp)</td></tr>
<tr class="codeline" data-linenumber="2386"><td class="num" id="LN2386">2386</td><td class="line">						     &amp;&amp; buf-&gt;b_ffname != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2387"><td class="num" id="LN2387">2387</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="2388"><td class="num" id="LN2388">2388</td><td class="line">	    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2389"><td class="num" id="LN2389">2389</td><td class="line">	     <span class='comment'>* If the original file does not exist anymore or has been changed</span></td></tr>
<tr class="codeline" data-linenumber="2390"><td class="num" id="LN2390">2390</td><td class="line">	     <span class='comment'>* call ml_preserve() to get rid of all negative numbered blocks.</span></td></tr>
<tr class="codeline" data-linenumber="2391"><td class="num" id="LN2391">2391</td><td class="line">	     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2392"><td class="num" id="LN2392">2392</td><td class="line">	    <span class='keyword'>if</span> (<span class='macro'>mch_stat((<span class='keyword'>char</span> *)buf-&gt;b_ffname, &amp;st)<span class='macro_popup'>stat(((char *)buf-&gt;b_ffname), (&amp;st))</span></span> == -1</td></tr>
<tr class="codeline" data-linenumber="2393"><td class="num" id="LN2393">2393</td><td class="line">		    || st.<span class='macro'>st_mtime<span class='macro_popup'>st_mtim.tv_sec</span></span> != buf-&gt;b_mtime_read</td></tr>
<tr class="codeline" data-linenumber="2394"><td class="num" id="LN2394">2394</td><td class="line">		    || st.st_size != buf-&gt;b_orig_size)</td></tr>
<tr class="codeline" data-linenumber="2395"><td class="num" id="LN2395">2395</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="2396"><td class="num" id="LN2396">2396</td><td class="line">		ml_preserve(buf, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2397"><td class="num" id="LN2397">2397</td><td class="line">		did_check_timestamps = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2398"><td class="num" id="LN2398">2398</td><td class="line">		need_check_timestamps = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;	<span class='comment'>// give message later</span></td></tr>
<tr class="codeline" data-linenumber="2399"><td class="num" id="LN2399">2399</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="2400"><td class="num" id="LN2400">2400</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="2401"><td class="num" id="LN2401">2401</td><td class="line">	<span class='keyword'>if</span> (buf-&gt;b_ml.ml_mfp-&gt;mf_dirty)</td></tr>
<tr class="codeline" data-linenumber="2402"><td class="num" id="LN2402">2402</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="2403"><td class="num" id="LN2403">2403</td><td class="line">	    (<span class='keyword'>void</span>)mf_sync(buf-&gt;b_ml.ml_mfp, (check_char ? <span class='macro'>MFS_STOP<span class='macro_popup'>2</span></span> : 0)</td></tr>
<tr class="codeline" data-linenumber="2404"><td class="num" id="LN2404">2404</td><td class="line">					| (bufIsChanged(buf) ? <span class='macro'>MFS_FLUSH<span class='macro_popup'>4</span></span> : 0));</td></tr>
<tr class="codeline" data-linenumber="2405"><td class="num" id="LN2405">2405</td><td class="line">	    <span class='keyword'>if</span> (check_char &amp;&amp; ui_char_avail())	<span class='comment'>// character available now</span></td></tr>
<tr class="codeline" data-linenumber="2406"><td class="num" id="LN2406">2406</td><td class="line">		<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2407"><td class="num" id="LN2407">2407</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="2408"><td class="num" id="LN2408">2408</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2409"><td class="num" id="LN2409">2409</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2410"><td class="num" id="LN2410">2410</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2411"><td class="num" id="LN2411">2411</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2412"><td class="num" id="LN2412">2412</td><td class="line"> <span class='comment'>* sync one buffer, including negative blocks</span></td></tr>
<tr class="codeline" data-linenumber="2413"><td class="num" id="LN2413">2413</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2414"><td class="num" id="LN2414">2414</td><td class="line"> <span class='comment'>* after this all the blocks are in the swap file</span></td></tr>
<tr class="codeline" data-linenumber="2415"><td class="num" id="LN2415">2415</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2416"><td class="num" id="LN2416">2416</td><td class="line"> <span class='comment'>* Used for the :preserve command and when the original file has been</span></td></tr>
<tr class="codeline" data-linenumber="2417"><td class="num" id="LN2417">2417</td><td class="line"> <span class='comment'>* changed or deleted.</span></td></tr>
<tr class="codeline" data-linenumber="2418"><td class="num" id="LN2418">2418</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2419"><td class="num" id="LN2419">2419</td><td class="line"> <span class='comment'>* when message is TRUE the success of preserving is reported</span></td></tr>
<tr class="codeline" data-linenumber="2420"><td class="num" id="LN2420">2420</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2421"><td class="num" id="LN2421">2421</td><td class="line">    <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="2422"><td class="num" id="LN2422">2422</td><td class="line">ml_preserve(buf_T *buf, <span class='keyword'>int</span> message)</td></tr>
<tr class="codeline" data-linenumber="2423"><td class="num" id="LN2423">2423</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2424"><td class="num" id="LN2424">2424</td><td class="line">    bhdr_T	*hp;</td></tr>
<tr class="codeline" data-linenumber="2425"><td class="num" id="LN2425">2425</td><td class="line">    linenr_T	lnum;</td></tr>
<tr class="codeline" data-linenumber="2426"><td class="num" id="LN2426">2426</td><td class="line">    memfile_T	*mfp = buf-&gt;b_ml.ml_mfp;</td></tr>
<tr class="codeline" data-linenumber="2427"><td class="num" id="LN2427">2427</td><td class="line">    <span class='keyword'>int</span>		status;</td></tr>
<tr class="codeline" data-linenumber="2428"><td class="num" id="LN2428">2428</td><td class="line">    <span class='keyword'>int</span>		got_int_save = got_int;</td></tr>
<tr class="codeline" data-linenumber="2429"><td class="num" id="LN2429">2429</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2430"><td class="num" id="LN2430">2430</td><td class="line">    <span class='keyword'>if</span> (mfp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || mfp-&gt;mf_fname == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2431"><td class="num" id="LN2431">2431</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2432"><td class="num" id="LN2432">2432</td><td class="line">	<span class='keyword'>if</span> (message)</td></tr>
<tr class="codeline" data-linenumber="2433"><td class="num" id="LN2433">2433</td><td class="line">	    emsg(<span class='macro'>_(<span class='string_literal'>"E313: Cannot preserve, there is no swap file"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E313: Cannot preserve, there is no swap file"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2434"><td class="num" id="LN2434">2434</td><td class="line">	<span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2435"><td class="num" id="LN2435">2435</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2436"><td class="num" id="LN2436">2436</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2437"><td class="num" id="LN2437">2437</td><td class="line">    <span class='comment'>// We only want to stop when interrupted here, not when interrupted</span></td></tr>
<tr class="codeline" data-linenumber="2438"><td class="num" id="LN2438">2438</td><td class="line">    <span class='comment'>// before.</span></td></tr>
<tr class="codeline" data-linenumber="2439"><td class="num" id="LN2439">2439</td><td class="line">    got_int = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2440"><td class="num" id="LN2440">2440</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2441"><td class="num" id="LN2441">2441</td><td class="line">    ml_flush_line(buf);				    <span class='comment'>// flush buffered line</span></td></tr>
<tr class="codeline" data-linenumber="2442"><td class="num" id="LN2442">2442</td><td class="line">    (<span class='keyword'>void</span>)ml_find_line(buf, (linenr_T)0, <span class='macro'>ML_FLUSH<span class='macro_popup'>0x02</span></span>); <span class='comment'>// flush locked block</span></td></tr>
<tr class="codeline" data-linenumber="2443"><td class="num" id="LN2443">2443</td><td class="line">    status = mf_sync(mfp, <span class='macro'>MFS_ALL<span class='macro_popup'>1</span></span> | <span class='macro'>MFS_FLUSH<span class='macro_popup'>4</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2444"><td class="num" id="LN2444">2444</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2445"><td class="num" id="LN2445">2445</td><td class="line">    <span class='comment'>// stack is invalid after mf_sync(.., MFS_ALL)</span></td></tr>
<tr class="codeline" data-linenumber="2446"><td class="num" id="LN2446">2446</td><td class="line">    buf-&gt;b_ml.ml_stack_top = 0;</td></tr>
<tr class="codeline" data-linenumber="2447"><td class="num" id="LN2447">2447</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2448"><td class="num" id="LN2448">2448</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2449"><td class="num" id="LN2449">2449</td><td class="line">     <span class='comment'>* Some of the data blocks may have been changed from negative to</span></td></tr>
<tr class="codeline" data-linenumber="2450"><td class="num" id="LN2450">2450</td><td class="line">     <span class='comment'>* positive block number. In that case the pointer blocks need to be</span></td></tr>
<tr class="codeline" data-linenumber="2451"><td class="num" id="LN2451">2451</td><td class="line">     <span class='comment'>* updated.</span></td></tr>
<tr class="codeline" data-linenumber="2452"><td class="num" id="LN2452">2452</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2453"><td class="num" id="LN2453">2453</td><td class="line">     <span class='comment'>* We don't know in which pointer block the references are, so we visit</span></td></tr>
<tr class="codeline" data-linenumber="2454"><td class="num" id="LN2454">2454</td><td class="line">     <span class='comment'>* all data blocks until there are no more translations to be done (or</span></td></tr>
<tr class="codeline" data-linenumber="2455"><td class="num" id="LN2455">2455</td><td class="line">     <span class='comment'>* we hit the end of the file, which can only happen in case a write fails,</span></td></tr>
<tr class="codeline" data-linenumber="2456"><td class="num" id="LN2456">2456</td><td class="line">     <span class='comment'>* e.g. when file system if full).</span></td></tr>
<tr class="codeline" data-linenumber="2457"><td class="num" id="LN2457">2457</td><td class="line">     <span class='comment'>* ml_find_line() does the work by translating the negative block numbers</span></td></tr>
<tr class="codeline" data-linenumber="2458"><td class="num" id="LN2458">2458</td><td class="line">     <span class='comment'>* when getting the first line of each data block.</span></td></tr>
<tr class="codeline" data-linenumber="2459"><td class="num" id="LN2459">2459</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2460"><td class="num" id="LN2460">2460</td><td class="line">    <span class='keyword'>if</span> (mf_need_trans(mfp) &amp;&amp; !got_int)</td></tr>
<tr class="codeline" data-linenumber="2461"><td class="num" id="LN2461">2461</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2462"><td class="num" id="LN2462">2462</td><td class="line">	lnum = 1;</td></tr>
<tr class="codeline" data-linenumber="2463"><td class="num" id="LN2463">2463</td><td class="line">	<span class='keyword'>while</span> (mf_need_trans(mfp) &amp;&amp; lnum &lt;= buf-&gt;b_ml.ml_line_count)</td></tr>
<tr class="codeline" data-linenumber="2464"><td class="num" id="LN2464">2464</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="2465"><td class="num" id="LN2465">2465</td><td class="line">	    hp = ml_find_line(buf, lnum, <span class='macro'>ML_FIND<span class='macro_popup'>0x13</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2466"><td class="num" id="LN2466">2466</td><td class="line">	    <span class='keyword'>if</span> (hp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2467"><td class="num" id="LN2467">2467</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="2468"><td class="num" id="LN2468">2468</td><td class="line">		status = <span class='macro'>FAIL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2469"><td class="num" id="LN2469">2469</td><td class="line">		<span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="2470"><td class="num" id="LN2470">2470</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="2471"><td class="num" id="LN2471">2471</td><td class="line">	    <span class='macro'>CHECK(buf-&gt;b_ml.ml_locked_low != lnum, <span class='string_literal'>"low != lnum"</span>)<span class='macro_popup'>do { } while (0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2472"><td class="num" id="LN2472">2472</td><td class="line">	    lnum = buf-&gt;b_ml.ml_locked_high + 1;</td></tr>
<tr class="codeline" data-linenumber="2473"><td class="num" id="LN2473">2473</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="2474"><td class="num" id="LN2474">2474</td><td class="line">	(<span class='keyword'>void</span>)ml_find_line(buf, (linenr_T)0, <span class='macro'>ML_FLUSH<span class='macro_popup'>0x02</span></span>);	<span class='comment'>// flush locked block</span></td></tr>
<tr class="codeline" data-linenumber="2475"><td class="num" id="LN2475">2475</td><td class="line">	<span class='comment'>// sync the updated pointer blocks</span></td></tr>
<tr class="codeline" data-linenumber="2476"><td class="num" id="LN2476">2476</td><td class="line">	<span class='keyword'>if</span> (mf_sync(mfp, <span class='macro'>MFS_ALL<span class='macro_popup'>1</span></span> | <span class='macro'>MFS_FLUSH<span class='macro_popup'>4</span></span>) == <span class='macro'>FAIL<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2477"><td class="num" id="LN2477">2477</td><td class="line">	    status = <span class='macro'>FAIL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2478"><td class="num" id="LN2478">2478</td><td class="line">	buf-&gt;b_ml.ml_stack_top = 0;	    <span class='comment'>// stack is invalid now</span></td></tr>
<tr class="codeline" data-linenumber="2479"><td class="num" id="LN2479">2479</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2480"><td class="num" id="LN2480">2480</td><td class="line">theend:</td></tr>
<tr class="codeline" data-linenumber="2481"><td class="num" id="LN2481">2481</td><td class="line">    got_int |= got_int_save;</td></tr>
<tr class="codeline" data-linenumber="2482"><td class="num" id="LN2482">2482</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2483"><td class="num" id="LN2483">2483</td><td class="line">    <span class='keyword'>if</span> (message)</td></tr>
<tr class="codeline" data-linenumber="2484"><td class="num" id="LN2484">2484</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2485"><td class="num" id="LN2485">2485</td><td class="line">	<span class='keyword'>if</span> (status == <span class='macro'>OK<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2486"><td class="num" id="LN2486">2486</td><td class="line">	    msg(<span class='macro'>_(<span class='string_literal'>"File preserved"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("File preserved"), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2487"><td class="num" id="LN2487">2487</td><td class="line">	<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2488"><td class="num" id="LN2488">2488</td><td class="line">	    emsg(<span class='macro'>_(<span class='string_literal'>"E314: Preserve failed"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E314: Preserve failed"), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2489"><td class="num" id="LN2489">2489</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2490"><td class="num" id="LN2490">2490</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2491"><td class="num" id="LN2491">2491</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2492"><td class="num" id="LN2492">2492</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2493"><td class="num" id="LN2493">2493</td><td class="line"> <span class='comment'>* NOTE: The pointer returned by the ml_get_*() functions only remains valid</span></td></tr>
<tr class="codeline" data-linenumber="2494"><td class="num" id="LN2494">2494</td><td class="line"> <span class='comment'>* until the next call!</span></td></tr>
<tr class="codeline" data-linenumber="2495"><td class="num" id="LN2495">2495</td><td class="line"> <span class='comment'>*  line1 = ml_get(1);</span></td></tr>
<tr class="codeline" data-linenumber="2496"><td class="num" id="LN2496">2496</td><td class="line"> <span class='comment'>*  line2 = ml_get(2);	// line1 is now invalid!</span></td></tr>
<tr class="codeline" data-linenumber="2497"><td class="num" id="LN2497">2497</td><td class="line"> <span class='comment'>* Make a copy of the line if necessary.</span></td></tr>
<tr class="codeline" data-linenumber="2498"><td class="num" id="LN2498">2498</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2499"><td class="num" id="LN2499">2499</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2500"><td class="num" id="LN2500">2500</td><td class="line"> <span class='comment'>* Return a pointer to a (read-only copy of a) line.</span></td></tr>
<tr class="codeline" data-linenumber="2501"><td class="num" id="LN2501">2501</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2502"><td class="num" id="LN2502">2502</td><td class="line"> <span class='comment'>* On failure an error message is given and IObuff is returned (to avoid</span></td></tr>
<tr class="codeline" data-linenumber="2503"><td class="num" id="LN2503">2503</td><td class="line"> <span class='comment'>* having to check for error everywhere).</span></td></tr>
<tr class="codeline" data-linenumber="2504"><td class="num" id="LN2504">2504</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2505"><td class="num" id="LN2505">2505</td><td class="line">    char_u  *</td></tr>
<tr class="codeline" data-linenumber="2506"><td class="num" id="LN2506">2506</td><td class="line">ml_get(linenr_T lnum)</td></tr>
<tr class="codeline" data-linenumber="2507"><td class="num" id="LN2507">2507</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2508"><td class="num" id="LN2508">2508</td><td class="line">    <span class='keyword'>return</span> ml_get_buf(curbuf, lnum, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2509"><td class="num" id="LN2509">2509</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2510"><td class="num" id="LN2510">2510</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2511"><td class="num" id="LN2511">2511</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2512"><td class="num" id="LN2512">2512</td><td class="line"> <span class='comment'>* Return pointer to position "pos".</span></td></tr>
<tr class="codeline" data-linenumber="2513"><td class="num" id="LN2513">2513</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2514"><td class="num" id="LN2514">2514</td><td class="line">    char_u *</td></tr>
<tr class="codeline" data-linenumber="2515"><td class="num" id="LN2515">2515</td><td class="line">ml_get_pos(pos_T *pos)</td></tr>
<tr class="codeline" data-linenumber="2516"><td class="num" id="LN2516">2516</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2517"><td class="num" id="LN2517">2517</td><td class="line">    <span class='keyword'>return</span> (ml_get_buf(curbuf, pos-&gt;lnum, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>) + pos-&gt;col);</td></tr>
<tr class="codeline" data-linenumber="2518"><td class="num" id="LN2518">2518</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2519"><td class="num" id="LN2519">2519</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2520"><td class="num" id="LN2520">2520</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2521"><td class="num" id="LN2521">2521</td><td class="line"> <span class='comment'>* Return pointer to cursor line.</span></td></tr>
<tr class="codeline" data-linenumber="2522"><td class="num" id="LN2522">2522</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2523"><td class="num" id="LN2523">2523</td><td class="line">    char_u *</td></tr>
<tr class="codeline" data-linenumber="2524"><td class="num" id="LN2524">2524</td><td class="line">ml_get_curline(<span class='keyword'>void</span>)</td></tr>
<tr class="codeline" data-linenumber="2525"><td class="num" id="LN2525">2525</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2526"><td class="num" id="LN2526">2526</td><td class="line">    <span class='keyword'>return</span> ml_get_buf(curbuf, curwin-&gt;w_cursor.lnum, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2527"><td class="num" id="LN2527">2527</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2528"><td class="num" id="LN2528">2528</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2529"><td class="num" id="LN2529">2529</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2530"><td class="num" id="LN2530">2530</td><td class="line"> <span class='comment'>* Return pointer to cursor position.</span></td></tr>
<tr class="codeline" data-linenumber="2531"><td class="num" id="LN2531">2531</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2532"><td class="num" id="LN2532">2532</td><td class="line">    char_u *</td></tr>
<tr class="codeline" data-linenumber="2533"><td class="num" id="LN2533">2533</td><td class="line">ml_get_cursor(<span class='keyword'>void</span>)</td></tr>
<tr class="codeline" data-linenumber="2534"><td class="num" id="LN2534">2534</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2535"><td class="num" id="LN2535">2535</td><td class="line">    <span class='keyword'>return</span> (ml_get_buf(curbuf, curwin-&gt;w_cursor.lnum, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>) +</td></tr>
<tr class="codeline" data-linenumber="2536"><td class="num" id="LN2536">2536</td><td class="line">							curwin-&gt;w_cursor.col);</td></tr>
<tr class="codeline" data-linenumber="2537"><td class="num" id="LN2537">2537</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2538"><td class="num" id="LN2538">2538</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2539"><td class="num" id="LN2539">2539</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2540"><td class="num" id="LN2540">2540</td><td class="line"> <span class='comment'>* Return a pointer to a line in a specific buffer</span></td></tr>
<tr class="codeline" data-linenumber="2541"><td class="num" id="LN2541">2541</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2542"><td class="num" id="LN2542">2542</td><td class="line"> <span class='comment'>* "will_change": if TRUE mark the buffer dirty (chars in the line will be</span></td></tr>
<tr class="codeline" data-linenumber="2543"><td class="num" id="LN2543">2543</td><td class="line"> <span class='comment'>* changed)</span></td></tr>
<tr class="codeline" data-linenumber="2544"><td class="num" id="LN2544">2544</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2545"><td class="num" id="LN2545">2545</td><td class="line">    char_u  *</td></tr>
<tr class="codeline" data-linenumber="2546"><td class="num" id="LN2546">2546</td><td class="line">ml_get_buf(</td></tr>
<tr class="codeline" data-linenumber="2547"><td class="num" id="LN2547">2547</td><td class="line">    buf_T	*buf,</td></tr>
<tr class="codeline" data-linenumber="2548"><td class="num" id="LN2548">2548</td><td class="line">    linenr_T	lnum,</td></tr>
<tr class="codeline" data-linenumber="2549"><td class="num" id="LN2549">2549</td><td class="line">    <span class='keyword'>int</span>		will_change)		<span class='comment'>// line will be changed</span></td></tr>
<tr class="codeline" data-linenumber="2550"><td class="num" id="LN2550">2550</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2551"><td class="num" id="LN2551">2551</td><td class="line">    bhdr_T	*hp;</td></tr>
<tr class="codeline" data-linenumber="2552"><td class="num" id="LN2552">2552</td><td class="line">    DATA_BL	*dp;</td></tr>
<tr class="codeline" data-linenumber="2553"><td class="num" id="LN2553">2553</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>int</span>	recursive = 0;</td></tr>
<tr class="codeline" data-linenumber="2554"><td class="num" id="LN2554">2554</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2555"><td class="num" id="LN2555">2555</td><td class="line">    <span class='keyword'>if</span> (lnum &gt; buf-&gt;b_ml.ml_line_count)	<span class='comment'>// invalid line number</span></td></tr>
<tr class="codeline" data-linenumber="2556"><td class="num" id="LN2556">2556</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2557"><td class="num" id="LN2557">2557</td><td class="line">	<span class='keyword'>if</span> (recursive == 0)</td></tr>
<tr class="codeline" data-linenumber="2558"><td class="num" id="LN2558">2558</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="2559"><td class="num" id="LN2559">2559</td><td class="line">	    <span class='comment'>// Avoid giving this message for a recursive call, may happen when</span></td></tr>
<tr class="codeline" data-linenumber="2560"><td class="num" id="LN2560">2560</td><td class="line">	    <span class='comment'>// the GUI redraws part of the text.</span></td></tr>
<tr class="codeline" data-linenumber="2561"><td class="num" id="LN2561">2561</td><td class="line">	    ++recursive;</td></tr>
<tr class="codeline" data-linenumber="2562"><td class="num" id="LN2562">2562</td><td class="line">	    siemsg(<span class='macro'>_(<span class='string_literal'>"E315: ml_get: invalid lnum: %ld"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E315: ml_get: invalid lnum: %ld"<br>), 5)</span></span>, lnum);</td></tr>
<tr class="codeline" data-linenumber="2563"><td class="num" id="LN2563">2563</td><td class="line">	    --recursive;</td></tr>
<tr class="codeline" data-linenumber="2564"><td class="num" id="LN2564">2564</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="2565"><td class="num" id="LN2565">2565</td><td class="line">errorret:</td></tr>
<tr class="codeline" data-linenumber="2566"><td class="num" id="LN2566">2566</td><td class="line">	<span class='macro'>STRCPY(IObuff, <span class='string_literal'>"???"</span>)<span class='macro_popup'>strcpy((char *)(IObuff), (char *)("???"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2567"><td class="num" id="LN2567">2567</td><td class="line">	buf-&gt;b_ml.ml_line_len = 4;</td></tr>
<tr class="codeline" data-linenumber="2568"><td class="num" id="LN2568">2568</td><td class="line">	<span class='keyword'>return</span> IObuff;</td></tr>
<tr class="codeline" data-linenumber="2569"><td class="num" id="LN2569">2569</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2570"><td class="num" id="LN2570">2570</td><td class="line">    <span class='keyword'>if</span> (lnum &lt;= 0)			<span class='comment'>// pretend line 0 is line 1</span></td></tr>
<tr class="codeline" data-linenumber="2571"><td class="num" id="LN2571">2571</td><td class="line">	lnum = 1;</td></tr>
<tr class="codeline" data-linenumber="2572"><td class="num" id="LN2572">2572</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2573"><td class="num" id="LN2573">2573</td><td class="line">    <span class='keyword'>if</span> (buf-&gt;b_ml.ml_mfp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)	<span class='comment'>// there are no lines</span></td></tr>
<tr class="codeline" data-linenumber="2574"><td class="num" id="LN2574">2574</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2575"><td class="num" id="LN2575">2575</td><td class="line">	buf-&gt;b_ml.ml_line_len = 1;</td></tr>
<tr class="codeline" data-linenumber="2576"><td class="num" id="LN2576">2576</td><td class="line">	<span class='keyword'>return</span> (char_u *)<span class='string_literal'>""</span>;</td></tr>
<tr class="codeline" data-linenumber="2577"><td class="num" id="LN2577">2577</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2578"><td class="num" id="LN2578">2578</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2579"><td class="num" id="LN2579">2579</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2580"><td class="num" id="LN2580">2580</td><td class="line">     <span class='comment'>* See if it is the same line as requested last time.</span></td></tr>
<tr class="codeline" data-linenumber="2581"><td class="num" id="LN2581">2581</td><td class="line">     <span class='comment'>* Otherwise may need to flush last used line.</span></td></tr>
<tr class="codeline" data-linenumber="2582"><td class="num" id="LN2582">2582</td><td class="line">     <span class='comment'>* Don't use the last used line when 'swapfile' is reset, need to load all</span></td></tr>
<tr class="codeline" data-linenumber="2583"><td class="num" id="LN2583">2583</td><td class="line">     <span class='comment'>* blocks.</span></td></tr>
<tr class="codeline" data-linenumber="2584"><td class="num" id="LN2584">2584</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2585"><td class="num" id="LN2585">2585</td><td class="line">    <span class='keyword'>if</span> (buf-&gt;b_ml.ml_line_lnum != lnum || mf_dont_release)</td></tr>
<tr class="codeline" data-linenumber="2586"><td class="num" id="LN2586">2586</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2587"><td class="num" id="LN2587">2587</td><td class="line">	<span class='keyword'>unsigned</span>    start, end;</td></tr>
<tr class="codeline" data-linenumber="2588"><td class="num" id="LN2588">2588</td><td class="line">	colnr_T	    len;</td></tr>
<tr class="codeline" data-linenumber="2589"><td class="num" id="LN2589">2589</td><td class="line">	<span class='keyword'>int</span>	    idx;</td></tr>
<tr class="codeline" data-linenumber="2590"><td class="num" id="LN2590">2590</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2591"><td class="num" id="LN2591">2591</td><td class="line">	ml_flush_line(buf);</td></tr>
<tr class="codeline" data-linenumber="2592"><td class="num" id="LN2592">2592</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2593"><td class="num" id="LN2593">2593</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2594"><td class="num" id="LN2594">2594</td><td class="line">	 <span class='comment'>* Find the data block containing the line.</span></td></tr>
<tr class="codeline" data-linenumber="2595"><td class="num" id="LN2595">2595</td><td class="line">	 <span class='comment'>* This also fills the stack with the blocks from the root to the data</span></td></tr>
<tr class="codeline" data-linenumber="2596"><td class="num" id="LN2596">2596</td><td class="line">	 <span class='comment'>* block and releases any locked block.</span></td></tr>
<tr class="codeline" data-linenumber="2597"><td class="num" id="LN2597">2597</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2598"><td class="num" id="LN2598">2598</td><td class="line">	<span class='keyword'>if</span> ((hp = ml_find_line(buf, lnum, <span class='macro'>ML_FIND<span class='macro_popup'>0x13</span></span>)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2599"><td class="num" id="LN2599">2599</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="2600"><td class="num" id="LN2600">2600</td><td class="line">	    <span class='keyword'>if</span> (recursive == 0)</td></tr>
<tr class="codeline" data-linenumber="2601"><td class="num" id="LN2601">2601</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="2602"><td class="num" id="LN2602">2602</td><td class="line">		<span class='comment'>// Avoid giving this message for a recursive call, may happen</span></td></tr>
<tr class="codeline" data-linenumber="2603"><td class="num" id="LN2603">2603</td><td class="line">		<span class='comment'>// when the GUI redraws part of the text.</span></td></tr>
<tr class="codeline" data-linenumber="2604"><td class="num" id="LN2604">2604</td><td class="line">		++recursive;</td></tr>
<tr class="codeline" data-linenumber="2605"><td class="num" id="LN2605">2605</td><td class="line">		get_trans_bufname(buf);</td></tr>
<tr class="codeline" data-linenumber="2606"><td class="num" id="LN2606">2606</td><td class="line">		shorten_dir(NameBuff);</td></tr>
<tr class="codeline" data-linenumber="2607"><td class="num" id="LN2607">2607</td><td class="line">		siemsg(<span class='macro'>_(<span class='string_literal'>"E316: ml_get: cannot find line %ld in buffer %d %s"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E316: ml_get: cannot find line %ld in buffer %d %s"<br>), 5)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2608"><td class="num" id="LN2608">2608</td><td class="line">						  lnum, buf-&gt;b_fnum, NameBuff);</td></tr>
<tr class="codeline" data-linenumber="2609"><td class="num" id="LN2609">2609</td><td class="line">		--recursive;</td></tr>
<tr class="codeline" data-linenumber="2610"><td class="num" id="LN2610">2610</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="2611"><td class="num" id="LN2611">2611</td><td class="line">	    <span class='keyword'>goto</span> errorret;</td></tr>
<tr class="codeline" data-linenumber="2612"><td class="num" id="LN2612">2612</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="2613"><td class="num" id="LN2613">2613</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2614"><td class="num" id="LN2614">2614</td><td class="line">	dp = (DATA_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="2615"><td class="num" id="LN2615">2615</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2616"><td class="num" id="LN2616">2616</td><td class="line">	idx = lnum - buf-&gt;b_ml.ml_locked_low;</td></tr>
<tr class="codeline" data-linenumber="2617"><td class="num" id="LN2617">2617</td><td class="line">	start = ((dp-&gt;db_index[idx]) &amp; <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2618"><td class="num" id="LN2618">2618</td><td class="line">	<span class='comment'>// The text ends where the previous line starts.  The first line ends</span></td></tr>
<tr class="codeline" data-linenumber="2619"><td class="num" id="LN2619">2619</td><td class="line">	<span class='comment'>// at the end of the block.</span></td></tr>
<tr class="codeline" data-linenumber="2620"><td class="num" id="LN2620">2620</td><td class="line">	<span class='keyword'>if</span> (idx == 0)</td></tr>
<tr class="codeline" data-linenumber="2621"><td class="num" id="LN2621">2621</td><td class="line">	    end = dp-&gt;db_txt_end;</td></tr>
<tr class="codeline" data-linenumber="2622"><td class="num" id="LN2622">2622</td><td class="line">	<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2623"><td class="num" id="LN2623">2623</td><td class="line">	    end = ((dp-&gt;db_index[idx - 1]) &amp; <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2624"><td class="num" id="LN2624">2624</td><td class="line">	len = end - start;</td></tr>
<tr class="codeline" data-linenumber="2625"><td class="num" id="LN2625">2625</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2626"><td class="num" id="LN2626">2626</td><td class="line">	buf-&gt;b_ml.ml_line_ptr = (char_u *)dp + start;</td></tr>
<tr class="codeline" data-linenumber="2627"><td class="num" id="LN2627">2627</td><td class="line">	buf-&gt;b_ml.ml_line_len = len;</td></tr>
<tr class="codeline" data-linenumber="2628"><td class="num" id="LN2628">2628</td><td class="line">	buf-&gt;b_ml.ml_line_lnum = lnum;</td></tr>
<tr class="codeline" data-linenumber="2629"><td class="num" id="LN2629">2629</td><td class="line">	buf-&gt;b_ml.ml_flags &amp;= ~<span class='macro'>ML_LINE_DIRTY<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2630"><td class="num" id="LN2630">2630</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2631"><td class="num" id="LN2631">2631</td><td class="line">    <span class='keyword'>if</span> (will_change)</td></tr>
<tr class="codeline" data-linenumber="2632"><td class="num" id="LN2632">2632</td><td class="line">	buf-&gt;b_ml.ml_flags |= (<span class='macro'>ML_LOCKED_DIRTY<span class='macro_popup'>4</span></span> | <span class='macro'>ML_LOCKED_POS<span class='macro_popup'>8</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2633"><td class="num" id="LN2633">2633</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2634"><td class="num" id="LN2634">2634</td><td class="line">    <span class='keyword'>return</span> buf-&gt;b_ml.ml_line_ptr;</td></tr>
<tr class="codeline" data-linenumber="2635"><td class="num" id="LN2635">2635</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2636"><td class="num" id="LN2636">2636</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2637"><td class="num" id="LN2637">2637</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2638"><td class="num" id="LN2638">2638</td><td class="line"> <span class='comment'>* Check if a line that was just obtained by a call to ml_get</span></td></tr>
<tr class="codeline" data-linenumber="2639"><td class="num" id="LN2639">2639</td><td class="line"> <span class='comment'>* is in allocated memory.</span></td></tr>
<tr class="codeline" data-linenumber="2640"><td class="num" id="LN2640">2640</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2641"><td class="num" id="LN2641">2641</td><td class="line">    <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="2642"><td class="num" id="LN2642">2642</td><td class="line">ml_line_alloced(<span class='keyword'>void</span>)</td></tr>
<tr class="codeline" data-linenumber="2643"><td class="num" id="LN2643">2643</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2644"><td class="num" id="LN2644">2644</td><td class="line">    <span class='keyword'>return</span> (curbuf-&gt;b_ml.ml_flags &amp; <span class='macro'>ML_LINE_DIRTY<span class='macro_popup'>2</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2645"><td class="num" id="LN2645">2645</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2646"><td class="num" id="LN2646">2646</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2647"><td class="num" id="LN2647">2647</td><td class="line"><span class='directive'>#ifdef FEAT_PROP_POPUP</span></td></tr>
<tr class="codeline" data-linenumber="2648"><td class="num" id="LN2648">2648</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2649"><td class="num" id="LN2649">2649</td><td class="line"> <span class='comment'>* Add text properties that continue from the previous line.</span></td></tr>
<tr class="codeline" data-linenumber="2650"><td class="num" id="LN2650">2650</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2651"><td class="num" id="LN2651">2651</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="2652"><td class="num" id="LN2652">2652</td><td class="line">add_text_props_for_append(</td></tr>
<tr class="codeline" data-linenumber="2653"><td class="num" id="LN2653">2653</td><td class="line">	    buf_T	*buf,</td></tr>
<tr class="codeline" data-linenumber="2654"><td class="num" id="LN2654">2654</td><td class="line">	    linenr_T	lnum,</td></tr>
<tr class="codeline" data-linenumber="2655"><td class="num" id="LN2655">2655</td><td class="line">	    char_u	**line,</td></tr>
<tr class="codeline" data-linenumber="2656"><td class="num" id="LN2656">2656</td><td class="line">	    <span class='keyword'>int</span>		*len,</td></tr>
<tr class="codeline" data-linenumber="2657"><td class="num" id="LN2657">2657</td><td class="line">	    char_u	**tofree)</td></tr>
<tr class="codeline" data-linenumber="2658"><td class="num" id="LN2658">2658</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2659"><td class="num" id="LN2659">2659</td><td class="line">    <span class='keyword'>int</span>		round;</td></tr>
<tr class="codeline" data-linenumber="2660"><td class="num" id="LN2660">2660</td><td class="line">    <span class='keyword'>int</span>		new_prop_count = 0;</td></tr>
<tr class="codeline" data-linenumber="2661"><td class="num" id="LN2661">2661</td><td class="line">    <span class='keyword'>int</span>		count;</td></tr>
<tr class="codeline" data-linenumber="2662"><td class="num" id="LN2662">2662</td><td class="line">    <span class='keyword'>int</span>		n;</td></tr>
<tr class="codeline" data-linenumber="2663"><td class="num" id="LN2663">2663</td><td class="line">    char_u	*props;</td></tr>
<tr class="codeline" data-linenumber="2664"><td class="num" id="LN2664">2664</td><td class="line">    <span class='keyword'>int</span>		new_len = 0;  <span class='comment'>// init for gcc</span></td></tr>
<tr class="codeline" data-linenumber="2665"><td class="num" id="LN2665">2665</td><td class="line">    char_u	*new_line = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2666"><td class="num" id="LN2666">2666</td><td class="line">    textprop_T	prop;</td></tr>
<tr class="codeline" data-linenumber="2667"><td class="num" id="LN2667">2667</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2668"><td class="num" id="LN2668">2668</td><td class="line">    <span class='comment'>// Make two rounds:</span></td></tr>
<tr class="codeline" data-linenumber="2669"><td class="num" id="LN2669">2669</td><td class="line">    <span class='comment'>// 1. calculate the extra space needed</span></td></tr>
<tr class="codeline" data-linenumber="2670"><td class="num" id="LN2670">2670</td><td class="line">    <span class='comment'>// 2. allocate the space and fill it</span></td></tr>
<tr class="codeline" data-linenumber="2671"><td class="num" id="LN2671">2671</td><td class="line">    <span class='keyword'>for</span> (round = 1; round &lt;= 2; ++round)</td></tr>
<tr class="codeline" data-linenumber="2672"><td class="num" id="LN2672">2672</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2673"><td class="num" id="LN2673">2673</td><td class="line">	<span class='keyword'>if</span> (round == 2)</td></tr>
<tr class="codeline" data-linenumber="2674"><td class="num" id="LN2674">2674</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="2675"><td class="num" id="LN2675">2675</td><td class="line">	    <span class='keyword'>if</span> (new_prop_count == 0)</td></tr>
<tr class="codeline" data-linenumber="2676"><td class="num" id="LN2676">2676</td><td class="line">		<span class='keyword'>return</span>;  <span class='comment'>// nothing to do</span></td></tr>
<tr class="codeline" data-linenumber="2677"><td class="num" id="LN2677">2677</td><td class="line">	    new_len = *len + new_prop_count * <span class='keyword'>sizeof</span>(textprop_T);</td></tr>
<tr class="codeline" data-linenumber="2678"><td class="num" id="LN2678">2678</td><td class="line">	    new_line = alloc(new_len);</td></tr>
<tr class="codeline" data-linenumber="2679"><td class="num" id="LN2679">2679</td><td class="line">	    <span class='keyword'>if</span> (new_line == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2680"><td class="num" id="LN2680">2680</td><td class="line">		<span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2681"><td class="num" id="LN2681">2681</td><td class="line">	    <span class='macro'>mch_memmove(new_line, *line, *len)<span class='macro_popup'>memmove((char *)(new_line), (char *)(*line), *len)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2682"><td class="num" id="LN2682">2682</td><td class="line">	    new_prop_count = 0;</td></tr>
<tr class="codeline" data-linenumber="2683"><td class="num" id="LN2683">2683</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="2684"><td class="num" id="LN2684">2684</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2685"><td class="num" id="LN2685">2685</td><td class="line">	<span class='comment'>// Get the line above to find any props that continue in the next</span></td></tr>
<tr class="codeline" data-linenumber="2686"><td class="num" id="LN2686">2686</td><td class="line">	<span class='comment'>// line.</span></td></tr>
<tr class="codeline" data-linenumber="2687"><td class="num" id="LN2687">2687</td><td class="line">	count = get_text_props(buf, lnum, &amp;props, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2688"><td class="num" id="LN2688">2688</td><td class="line">	<span class='keyword'>for</span> (n = 0; n &lt; count; ++n)</td></tr>
<tr class="codeline" data-linenumber="2689"><td class="num" id="LN2689">2689</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="2690"><td class="num" id="LN2690">2690</td><td class="line">	    <span class='macro'>mch_memmove(&amp;prop, props + n * <span class='keyword'>sizeof</span>(textprop_T),<span class='macro_popup'>memmove((char *)(&amp;prop), (char *)(props + n * sizeof(textprop_T<br>)), sizeof(textprop_T))</span></span></td></tr>
<tr class="codeline" data-linenumber="2691"><td class="num" id="LN2691">2691</td><td class="line">							   <span class='keyword'><span class='macro'>sizeof</span>(textprop_T))<span class='macro_popup'>memmove((char *)(&amp;prop), (char *)(props + n * sizeof(textprop_T<br>)), sizeof(textprop_T))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2692"><td class="num" id="LN2692">2692</td><td class="line">	    <span class='keyword'>if</span> (prop.tp_flags &amp; <span class='macro'>TP_FLAG_CONT_NEXT<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2693"><td class="num" id="LN2693">2693</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="2694"><td class="num" id="LN2694">2694</td><td class="line">		<span class='keyword'>if</span> (round == 2)</td></tr>
<tr class="codeline" data-linenumber="2695"><td class="num" id="LN2695">2695</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="2696"><td class="num" id="LN2696">2696</td><td class="line">		    prop.tp_flags |= <span class='macro'>TP_FLAG_CONT_PREV<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2697"><td class="num" id="LN2697">2697</td><td class="line">		    prop.tp_col = 1;</td></tr>
<tr class="codeline" data-linenumber="2698"><td class="num" id="LN2698">2698</td><td class="line">		    prop.tp_len = *len;  <span class='comment'>// not exactly the right length</span></td></tr>
<tr class="codeline" data-linenumber="2699"><td class="num" id="LN2699">2699</td><td class="line">		    <span class='macro'>mch_memmove(new_line + *len + new_prop_count<span class='macro_popup'>memmove((char *)(new_line + *len + new_prop_count * sizeof(textprop_T<br>)), (char *)(&amp;prop), sizeof(textprop_T))</span></span></td></tr>
<tr class="codeline" data-linenumber="2700"><td class="num" id="LN2700">2700</td><td class="line">			      <span class='macro'>* <span class='keyword'>sizeof</span>(textprop_T), &amp;prop, <span class='keyword'>sizeof</span>(textprop_T))<span class='macro_popup'>memmove((char *)(new_line + *len + new_prop_count * sizeof(textprop_T<br>)), (char *)(&amp;prop), sizeof(textprop_T))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2701"><td class="num" id="LN2701">2701</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="2702"><td class="num" id="LN2702">2702</td><td class="line">		++new_prop_count;</td></tr>
<tr class="codeline" data-linenumber="2703"><td class="num" id="LN2703">2703</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="2704"><td class="num" id="LN2704">2704</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="2705"><td class="num" id="LN2705">2705</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2706"><td class="num" id="LN2706">2706</td><td class="line">    *line = new_line;</td></tr>
<tr class="codeline" data-linenumber="2707"><td class="num" id="LN2707">2707</td><td class="line">    *tofree = new_line;</td></tr>
<tr class="codeline" data-linenumber="2708"><td class="num" id="LN2708">2708</td><td class="line">    *len = new_len;</td></tr>
<tr class="codeline" data-linenumber="2709"><td class="num" id="LN2709">2709</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2710"><td class="num" id="LN2710">2710</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2711"><td class="num" id="LN2711">2711</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2712"><td class="num" id="LN2712">2712</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="2713"><td class="num" id="LN2713">2713</td><td class="line">ml_append_int(</td></tr>
<tr class="codeline" data-linenumber="2714"><td class="num" id="LN2714">2714</td><td class="line">    buf_T	*buf,</td></tr>
<tr class="codeline" data-linenumber="2715"><td class="num" id="LN2715">2715</td><td class="line">    linenr_T	lnum,		<span class='comment'>// append after this line (can be 0)</span></td></tr>
<tr class="codeline" data-linenumber="2716"><td class="num" id="LN2716">2716</td><td class="line">    char_u	*line_arg,	<span class='comment'>// text of the new line</span></td></tr>
<tr class="codeline" data-linenumber="2717"><td class="num" id="LN2717">2717</td><td class="line">    colnr_T	len_arg,	<span class='comment'>// length of line, including NUL, or 0</span></td></tr>
<tr class="codeline" data-linenumber="2718"><td class="num" id="LN2718">2718</td><td class="line">    <span class='keyword'>int</span>		flags)		<span class='comment'>// ML_APPEND_ flags</span></td></tr>
<tr class="codeline" data-linenumber="2719"><td class="num" id="LN2719">2719</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="2720"><td class="num" id="LN2720">2720</td><td class="line">    char_u	*line = line_arg;</td></tr>
<tr class="codeline" data-linenumber="2721"><td class="num" id="LN2721">2721</td><td class="line">    colnr_T	len = len_arg;</td></tr>
<tr class="codeline" data-linenumber="2722"><td class="num" id="LN2722">2722</td><td class="line">    <span class='keyword'>int</span>		i;</td></tr>
<tr class="codeline" data-linenumber="2723"><td class="num" id="LN2723">2723</td><td class="line">    <span class='keyword'>int</span>		line_count;	<span class='comment'>// number of indexes in current block</span></td></tr>
<tr class="codeline" data-linenumber="2724"><td class="num" id="LN2724">2724</td><td class="line">    <span class='keyword'>int</span>		offset;</td></tr>
<tr class="codeline" data-linenumber="2725"><td class="num" id="LN2725">2725</td><td class="line">    <span class='keyword'>int</span>		from, to;</td></tr>
<tr class="codeline" data-linenumber="2726"><td class="num" id="LN2726">2726</td><td class="line">    <span class='keyword'>int</span>		space_needed;	<span class='comment'>// space needed for new line</span></td></tr>
<tr class="codeline" data-linenumber="2727"><td class="num" id="LN2727">2727</td><td class="line">    <span class='keyword'>int</span>		page_size;</td></tr>
<tr class="codeline" data-linenumber="2728"><td class="num" id="LN2728">2728</td><td class="line">    <span class='keyword'>int</span>		page_count;</td></tr>
<tr class="codeline" data-linenumber="2729"><td class="num" id="LN2729">2729</td><td class="line">    <span class='keyword'>int</span>		db_idx;		<span class='comment'>// index for lnum in data block</span></td></tr>
<tr class="codeline" data-linenumber="2730"><td class="num" id="LN2730">2730</td><td class="line">    bhdr_T	*hp;</td></tr>
<tr class="codeline" data-linenumber="2731"><td class="num" id="LN2731">2731</td><td class="line">    memfile_T	*mfp;</td></tr>
<tr class="codeline" data-linenumber="2732"><td class="num" id="LN2732">2732</td><td class="line">    DATA_BL	*dp;</td></tr>
<tr class="codeline" data-linenumber="2733"><td class="num" id="LN2733">2733</td><td class="line">    PTR_BL	*pp;</td></tr>
<tr class="codeline" data-linenumber="2734"><td class="num" id="LN2734">2734</td><td class="line">    infoptr_T	*ip;</td></tr>
<tr class="codeline" data-linenumber="2735"><td class="num" id="LN2735">2735</td><td class="line"><span class='directive'>#ifdef FEAT_PROP_POPUP</span></td></tr>
<tr class="codeline" data-linenumber="2736"><td class="num" id="LN2736">2736</td><td class="line">    char_u	*tofree = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2737"><td class="num" id="LN2737">2737</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2738"><td class="num" id="LN2738">2738</td><td class="line">    <span class='keyword'>int</span>		ret = <span class='macro'>FAIL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2739"><td class="num" id="LN2739">2739</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2740"><td class="num" id="LN2740">2740</td><td class="line">    <span class='keyword'>if</span> (lnum &gt; buf-&gt;b_ml.ml_line_count || buf-&gt;b_ml.ml_mfp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2741"><td class="num" id="LN2741">2741</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>FAIL<span class='macro_popup'>0</span></span>;  <span class='comment'>// lnum out of range</span></td></tr>
<tr class="codeline" data-linenumber="2742"><td class="num" id="LN2742">2742</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2743"><td class="num" id="LN2743">2743</td><td class="line">    <span class='keyword'>if</span> (lowest_marked &amp;&amp; lowest_marked &gt; lnum)</td></tr>
<tr class="codeline" data-linenumber="2744"><td class="num" id="LN2744">2744</td><td class="line">	lowest_marked = lnum + 1;</td></tr>
<tr class="codeline" data-linenumber="2745"><td class="num" id="LN2745">2745</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2746"><td class="num" id="LN2746">2746</td><td class="line">    <span class='keyword'>if</span> (len == 0)</td></tr>
<tr class="codeline" data-linenumber="2747"><td class="num" id="LN2747">2747</td><td class="line">	len = (colnr_T)<span class='macro'>STRLEN(line)<span class='macro_popup'>strlen((char *)(line))</span></span> + 1;	<span class='comment'>// space needed for the text</span></td></tr>
<tr class="codeline" data-linenumber="2748"><td class="num" id="LN2748">2748</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2749"><td class="num" id="LN2749">2749</td><td class="line"><span class='directive'>#ifdef FEAT_PROP_POPUP</span></td></tr>
<tr class="codeline" data-linenumber="2750"><td class="num" id="LN2750">2750</td><td class="line">    <span class='keyword'>if</span> (curbuf-&gt;b_has_textprop &amp;&amp; lnum &gt; 0 &amp;&amp; !(flags &amp; <span class='macro'>ML_APPEND_UNDO<span class='macro_popup'>4</span></span>))</td></tr>
<tr class="codeline" data-linenumber="2751"><td class="num" id="LN2751">2751</td><td class="line">	<span class='comment'>// Add text properties that continue from the previous line.</span></td></tr>
<tr class="codeline" data-linenumber="2752"><td class="num" id="LN2752">2752</td><td class="line">	add_text_props_for_append(buf, lnum, &amp;line, &amp;len, &amp;tofree);</td></tr>
<tr class="codeline" data-linenumber="2753"><td class="num" id="LN2753">2753</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2754"><td class="num" id="LN2754">2754</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2755"><td class="num" id="LN2755">2755</td><td class="line">    space_needed = len + <span class='macro'>INDEX_SIZE<span class='macro_popup'>(sizeof(unsigned))</span></span>;	<span class='comment'>// space needed for text + index</span></td></tr>
<tr class="codeline" data-linenumber="2756"><td class="num" id="LN2756">2756</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2757"><td class="num" id="LN2757">2757</td><td class="line">    mfp = buf-&gt;b_ml.ml_mfp;</td></tr>
<tr class="codeline" data-linenumber="2758"><td class="num" id="LN2758">2758</td><td class="line">    page_size = mfp-&gt;mf_page_size;</td></tr>
<tr class="codeline" data-linenumber="2759"><td class="num" id="LN2759">2759</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2760"><td class="num" id="LN2760">2760</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2761"><td class="num" id="LN2761">2761</td><td class="line"> <span class='comment'>* find the data block containing the previous line</span></td></tr>
<tr class="codeline" data-linenumber="2762"><td class="num" id="LN2762">2762</td><td class="line"> <span class='comment'>* This also fills the stack with the blocks from the root to the data block</span></td></tr>
<tr class="codeline" data-linenumber="2763"><td class="num" id="LN2763">2763</td><td class="line"> <span class='comment'>* This also releases any locked block.</span></td></tr>
<tr class="codeline" data-linenumber="2764"><td class="num" id="LN2764">2764</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2765"><td class="num" id="LN2765">2765</td><td class="line">    <span class='keyword'>if</span> ((hp = ml_find_line(buf, lnum == 0 ? (linenr_T)1 : lnum,</td></tr>
<tr class="codeline" data-linenumber="2766"><td class="num" id="LN2766">2766</td><td class="line">							  <span class='macro'>ML_INSERT<span class='macro_popup'>0x12</span></span>)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2767"><td class="num" id="LN2767">2767</td><td class="line">	<span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="2768"><td class="num" id="LN2768">2768</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2769"><td class="num" id="LN2769">2769</td><td class="line">    buf-&gt;b_ml.ml_flags &amp;= ~<span class='macro'>ML_EMPTY<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2770"><td class="num" id="LN2770">2770</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2771"><td class="num" id="LN2771">2771</td><td class="line">    <span class='keyword'>if</span> (lnum == 0)		<span class='comment'>// got line one instead, correct db_idx</span></td></tr>
<tr class="codeline" data-linenumber="2772"><td class="num" id="LN2772">2772</td><td class="line">	db_idx = -1;		<span class='comment'>// careful, it is negative!</span></td></tr>
<tr class="codeline" data-linenumber="2773"><td class="num" id="LN2773">2773</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2774"><td class="num" id="LN2774">2774</td><td class="line">	db_idx = lnum - buf-&gt;b_ml.ml_locked_low;</td></tr>
<tr class="codeline" data-linenumber="2775"><td class="num" id="LN2775">2775</td><td class="line">		<span class='comment'>// get line count before the insertion</span></td></tr>
<tr class="codeline" data-linenumber="2776"><td class="num" id="LN2776">2776</td><td class="line">    line_count = buf-&gt;b_ml.ml_locked_high - buf-&gt;b_ml.ml_locked_low;</td></tr>
<tr class="codeline" data-linenumber="2777"><td class="num" id="LN2777">2777</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2778"><td class="num" id="LN2778">2778</td><td class="line">    dp = (DATA_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="2779"><td class="num" id="LN2779">2779</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2780"><td class="num" id="LN2780">2780</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2781"><td class="num" id="LN2781">2781</td><td class="line"> <span class='comment'>* If</span></td></tr>
<tr class="codeline" data-linenumber="2782"><td class="num" id="LN2782">2782</td><td class="line"> <span class='comment'>* - there is not enough room in the current block</span></td></tr>
<tr class="codeline" data-linenumber="2783"><td class="num" id="LN2783">2783</td><td class="line"> <span class='comment'>* - appending to the last line in the block</span></td></tr>
<tr class="codeline" data-linenumber="2784"><td class="num" id="LN2784">2784</td><td class="line"> <span class='comment'>* - not appending to the last line in the file</span></td></tr>
<tr class="codeline" data-linenumber="2785"><td class="num" id="LN2785">2785</td><td class="line"> <span class='comment'>* insert in front of the next block.</span></td></tr>
<tr class="codeline" data-linenumber="2786"><td class="num" id="LN2786">2786</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2787"><td class="num" id="LN2787">2787</td><td class="line">    <span class='keyword'>if</span> ((<span class='keyword'>int</span>)dp-&gt;db_free &lt; space_needed &amp;&amp; db_idx == line_count - 1</td></tr>
<tr class="codeline" data-linenumber="2788"><td class="num" id="LN2788">2788</td><td class="line">					    &amp;&amp; lnum &lt; buf-&gt;b_ml.ml_line_count)</td></tr>
<tr class="codeline" data-linenumber="2789"><td class="num" id="LN2789">2789</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2790"><td class="num" id="LN2790">2790</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2791"><td class="num" id="LN2791">2791</td><td class="line">	 <span class='comment'>* Now that the line is not going to be inserted in the block that we</span></td></tr>
<tr class="codeline" data-linenumber="2792"><td class="num" id="LN2792">2792</td><td class="line">	 <span class='comment'>* expected, the line count has to be adjusted in the pointer blocks</span></td></tr>
<tr class="codeline" data-linenumber="2793"><td class="num" id="LN2793">2793</td><td class="line">	 <span class='comment'>* by using ml_locked_lineadd.</span></td></tr>
<tr class="codeline" data-linenumber="2794"><td class="num" id="LN2794">2794</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2795"><td class="num" id="LN2795">2795</td><td class="line">	--(buf-&gt;b_ml.ml_locked_lineadd);</td></tr>
<tr class="codeline" data-linenumber="2796"><td class="num" id="LN2796">2796</td><td class="line">	--(buf-&gt;b_ml.ml_locked_high);</td></tr>
<tr class="codeline" data-linenumber="2797"><td class="num" id="LN2797">2797</td><td class="line">	<span class='keyword'>if</span> ((hp = ml_find_line(buf, lnum + 1, <span class='macro'>ML_INSERT<span class='macro_popup'>0x12</span></span>)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2798"><td class="num" id="LN2798">2798</td><td class="line">	    <span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="2799"><td class="num" id="LN2799">2799</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2800"><td class="num" id="LN2800">2800</td><td class="line">	db_idx = -1;		    <span class='comment'>// careful, it is negative!</span></td></tr>
<tr class="codeline" data-linenumber="2801"><td class="num" id="LN2801">2801</td><td class="line">		    <span class='comment'>// get line count before the insertion</span></td></tr>
<tr class="codeline" data-linenumber="2802"><td class="num" id="LN2802">2802</td><td class="line">	line_count = buf-&gt;b_ml.ml_locked_high - buf-&gt;b_ml.ml_locked_low;</td></tr>
<tr class="codeline" data-linenumber="2803"><td class="num" id="LN2803">2803</td><td class="line">	<span class='macro'>CHECK(buf-&gt;b_ml.ml_locked_low != lnum + 1, <span class='string_literal'>"locked_low != lnum + 1"</span>)<span class='macro_popup'>do { } while (0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2804"><td class="num" id="LN2804">2804</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2805"><td class="num" id="LN2805">2805</td><td class="line">	dp = (DATA_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="2806"><td class="num" id="LN2806">2806</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2807"><td class="num" id="LN2807">2807</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2808"><td class="num" id="LN2808">2808</td><td class="line">    ++buf-&gt;b_ml.ml_line_count;</td></tr>
<tr class="codeline" data-linenumber="2809"><td class="num" id="LN2809">2809</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2810"><td class="num" id="LN2810">2810</td><td class="line">    <span class='keyword'>if</span> ((<span class='keyword'>int</span>)dp-&gt;db_free &gt;= space_needed)	<span class='comment'>// enough room in data block</span></td></tr>
<tr class="codeline" data-linenumber="2811"><td class="num" id="LN2811">2811</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2812"><td class="num" id="LN2812">2812</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2813"><td class="num" id="LN2813">2813</td><td class="line">	 <span class='comment'>* Insert the new line in an existing data block, or in the data block</span></td></tr>
<tr class="codeline" data-linenumber="2814"><td class="num" id="LN2814">2814</td><td class="line">	 <span class='comment'>* allocated above.</span></td></tr>
<tr class="codeline" data-linenumber="2815"><td class="num" id="LN2815">2815</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2816"><td class="num" id="LN2816">2816</td><td class="line">	dp-&gt;db_txt_start -= len;</td></tr>
<tr class="codeline" data-linenumber="2817"><td class="num" id="LN2817">2817</td><td class="line">	dp-&gt;db_free -= space_needed;</td></tr>
<tr class="codeline" data-linenumber="2818"><td class="num" id="LN2818">2818</td><td class="line">	++(dp-&gt;db_line_count);</td></tr>
<tr class="codeline" data-linenumber="2819"><td class="num" id="LN2819">2819</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2820"><td class="num" id="LN2820">2820</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2821"><td class="num" id="LN2821">2821</td><td class="line">	 <span class='comment'>* move the text of the lines that follow to the front</span></td></tr>
<tr class="codeline" data-linenumber="2822"><td class="num" id="LN2822">2822</td><td class="line">	 <span class='comment'>* adjust the indexes of the lines that follow</span></td></tr>
<tr class="codeline" data-linenumber="2823"><td class="num" id="LN2823">2823</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2824"><td class="num" id="LN2824">2824</td><td class="line">	<span class='keyword'>if</span> (line_count &gt; db_idx + 1)	    <span class='comment'>// if there are following lines</span></td></tr>
<tr class="codeline" data-linenumber="2825"><td class="num" id="LN2825">2825</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="2826"><td class="num" id="LN2826">2826</td><td class="line">	    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2827"><td class="num" id="LN2827">2827</td><td class="line">	     <span class='comment'>* Offset is the start of the previous line.</span></td></tr>
<tr class="codeline" data-linenumber="2828"><td class="num" id="LN2828">2828</td><td class="line">	     <span class='comment'>* This will become the character just after the new line.</span></td></tr>
<tr class="codeline" data-linenumber="2829"><td class="num" id="LN2829">2829</td><td class="line">	     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2830"><td class="num" id="LN2830">2830</td><td class="line">	    <span class='keyword'>if</span> (db_idx &lt; 0)</td></tr>
<tr class="codeline" data-linenumber="2831"><td class="num" id="LN2831">2831</td><td class="line">		offset = dp-&gt;db_txt_end;</td></tr>
<tr class="codeline" data-linenumber="2832"><td class="num" id="LN2832">2832</td><td class="line">	    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2833"><td class="num" id="LN2833">2833</td><td class="line">		offset = ((dp-&gt;db_index[db_idx]) &amp; <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2834"><td class="num" id="LN2834">2834</td><td class="line">	    <span class='macro'>mch_memmove((<span class='keyword'>char</span> *)dp + dp-&gt;db_txt_start,<span class='macro_popup'>memmove((char *)((char *)dp + dp-&gt;db_txt_start), (char *)(<br>(char *)dp + dp-&gt;db_txt_start + len), (size_t)(offset - (dp<br>-&gt;db_txt_start + len)))</span></span></td></tr>
<tr class="codeline" data-linenumber="2835"><td class="num" id="LN2835">2835</td><td class="line">					  <span class='macro'>(<span class='keyword'>char</span> *)dp + dp-&gt;db_txt_start + len,<span class='macro_popup'>memmove((char *)((char *)dp + dp-&gt;db_txt_start), (char *)(<br>(char *)dp + dp-&gt;db_txt_start + len), (size_t)(offset - (dp<br>-&gt;db_txt_start + len)))</span></span></td></tr>
<tr class="codeline" data-linenumber="2836"><td class="num" id="LN2836">2836</td><td class="line">				 <span class='macro'>(size_t)(offset - (dp-&gt;db_txt_start + len)))<span class='macro_popup'>memmove((char *)((char *)dp + dp-&gt;db_txt_start), (char *)(<br>(char *)dp + dp-&gt;db_txt_start + len), (size_t)(offset - (dp<br>-&gt;db_txt_start + len)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2837"><td class="num" id="LN2837">2837</td><td class="line">	    <span class='keyword'>for</span> (i = line_count - 1; i &gt; db_idx; --i)</td></tr>
<tr class="codeline" data-linenumber="2838"><td class="num" id="LN2838">2838</td><td class="line">		dp-&gt;db_index[i + 1] = dp-&gt;db_index[i] - len;</td></tr>
<tr class="codeline" data-linenumber="2839"><td class="num" id="LN2839">2839</td><td class="line">	    dp-&gt;db_index[db_idx + 1] = offset - len;</td></tr>
<tr class="codeline" data-linenumber="2840"><td class="num" id="LN2840">2840</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="2841"><td class="num" id="LN2841">2841</td><td class="line">	<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2842"><td class="num" id="LN2842">2842</td><td class="line">	    <span class='comment'>// add line at the end (which is the start of the text)</span></td></tr>
<tr class="codeline" data-linenumber="2843"><td class="num" id="LN2843">2843</td><td class="line">	    dp-&gt;db_index[db_idx + 1] = dp-&gt;db_txt_start;</td></tr>
<tr class="codeline" data-linenumber="2844"><td class="num" id="LN2844">2844</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2845"><td class="num" id="LN2845">2845</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2846"><td class="num" id="LN2846">2846</td><td class="line">	 <span class='comment'>* copy the text into the block</span></td></tr>
<tr class="codeline" data-linenumber="2847"><td class="num" id="LN2847">2847</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2848"><td class="num" id="LN2848">2848</td><td class="line">	<span class='macro'>mch_memmove((<span class='keyword'>char</span> *)dp + dp-&gt;db_index[db_idx + 1], line, (size_t)len)<span class='macro_popup'>memmove((char *)((char *)dp + dp-&gt;db_index[db_idx + 1]), (<br>char *)(line), (size_t)len)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2849"><td class="num" id="LN2849">2849</td><td class="line">	<span class='keyword'>if</span> (flags &amp; <span class='macro'>ML_APPEND_MARK<span class='macro_popup'>2</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2850"><td class="num" id="LN2850">2850</td><td class="line">	    dp-&gt;db_index[db_idx + 1] |= <span class='macro'>DB_MARKED<span class='macro_popup'>((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2851"><td class="num" id="LN2851">2851</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2852"><td class="num" id="LN2852">2852</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2853"><td class="num" id="LN2853">2853</td><td class="line">	 <span class='comment'>* Mark the block dirty.</span></td></tr>
<tr class="codeline" data-linenumber="2854"><td class="num" id="LN2854">2854</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2855"><td class="num" id="LN2855">2855</td><td class="line">	buf-&gt;b_ml.ml_flags |= <span class='macro'>ML_LOCKED_DIRTY<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2856"><td class="num" id="LN2856">2856</td><td class="line">	<span class='keyword'>if</span> (!(flags &amp; <span class='macro'>ML_APPEND_NEW<span class='macro_popup'>1</span></span>))</td></tr>
<tr class="codeline" data-linenumber="2857"><td class="num" id="LN2857">2857</td><td class="line">	    buf-&gt;b_ml.ml_flags |= <span class='macro'>ML_LOCKED_POS<span class='macro_popup'>8</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2858"><td class="num" id="LN2858">2858</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2859"><td class="num" id="LN2859">2859</td><td class="line">    <span class='keyword'>else</span>	    <span class='comment'>// not enough space in data block</span></td></tr>
<tr class="codeline" data-linenumber="2860"><td class="num" id="LN2860">2860</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2861"><td class="num" id="LN2861">2861</td><td class="line">	<span class='keyword'>long</span>	    line_count_left, line_count_right;</td></tr>
<tr class="codeline" data-linenumber="2862"><td class="num" id="LN2862">2862</td><td class="line">	<span class='keyword'>int</span>	    page_count_left, page_count_right;</td></tr>
<tr class="codeline" data-linenumber="2863"><td class="num" id="LN2863">2863</td><td class="line">	bhdr_T	    *hp_left;</td></tr>
<tr class="codeline" data-linenumber="2864"><td class="num" id="LN2864">2864</td><td class="line">	bhdr_T	    *hp_right;</td></tr>
<tr class="codeline" data-linenumber="2865"><td class="num" id="LN2865">2865</td><td class="line">	bhdr_T	    *hp_new;</td></tr>
<tr class="codeline" data-linenumber="2866"><td class="num" id="LN2866">2866</td><td class="line">	<span class='keyword'>int</span>	    lines_moved;</td></tr>
<tr class="codeline" data-linenumber="2867"><td class="num" id="LN2867">2867</td><td class="line">	<span class='keyword'>int</span>	    data_moved = 0;	    <span class='comment'>// init to shut up gcc</span></td></tr>
<tr class="codeline" data-linenumber="2868"><td class="num" id="LN2868">2868</td><td class="line">	<span class='keyword'>int</span>	    total_moved = 0;	    <span class='comment'>// init to shut up gcc</span></td></tr>
<tr class="codeline" data-linenumber="2869"><td class="num" id="LN2869">2869</td><td class="line">	DATA_BL	    *dp_right, *dp_left;</td></tr>
<tr class="codeline" data-linenumber="2870"><td class="num" id="LN2870">2870</td><td class="line">	<span class='keyword'>int</span>	    stack_idx;</td></tr>
<tr class="codeline" data-linenumber="2871"><td class="num" id="LN2871">2871</td><td class="line">	<span class='keyword'>int</span>	    in_left;</td></tr>
<tr class="codeline" data-linenumber="2872"><td class="num" id="LN2872">2872</td><td class="line">	<span class='keyword'>int</span>	    lineadd;</td></tr>
<tr class="codeline" data-linenumber="2873"><td class="num" id="LN2873">2873</td><td class="line">	blocknr_T   bnum_left, bnum_right;</td></tr>
<tr class="codeline" data-linenumber="2874"><td class="num" id="LN2874">2874</td><td class="line">	linenr_T    lnum_left, lnum_right;</td></tr>
<tr class="codeline" data-linenumber="2875"><td class="num" id="LN2875">2875</td><td class="line">	<span class='keyword'>int</span>	    pb_idx;</td></tr>
<tr class="codeline" data-linenumber="2876"><td class="num" id="LN2876">2876</td><td class="line">	PTR_BL	    *pp_new;</td></tr>
<tr class="codeline" data-linenumber="2877"><td class="num" id="LN2877">2877</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2878"><td class="num" id="LN2878">2878</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2879"><td class="num" id="LN2879">2879</td><td class="line">	 <span class='comment'>* There is not enough room, we have to create a new data block and</span></td></tr>
<tr class="codeline" data-linenumber="2880"><td class="num" id="LN2880">2880</td><td class="line">	 <span class='comment'>* copy some lines into it.</span></td></tr>
<tr class="codeline" data-linenumber="2881"><td class="num" id="LN2881">2881</td><td class="line">	 <span class='comment'>* Then we have to insert an entry in the pointer block.</span></td></tr>
<tr class="codeline" data-linenumber="2882"><td class="num" id="LN2882">2882</td><td class="line">	 <span class='comment'>* If this pointer block also is full, we go up another block, and so</span></td></tr>
<tr class="codeline" data-linenumber="2883"><td class="num" id="LN2883">2883</td><td class="line">	 <span class='comment'>* on, up to the root if necessary.</span></td></tr>
<tr class="codeline" data-linenumber="2884"><td class="num" id="LN2884">2884</td><td class="line">	 <span class='comment'>* The line counts in the pointer blocks have already been adjusted by</span></td></tr>
<tr class="codeline" data-linenumber="2885"><td class="num" id="LN2885">2885</td><td class="line">	 <span class='comment'>* ml_find_line().</span></td></tr>
<tr class="codeline" data-linenumber="2886"><td class="num" id="LN2886">2886</td><td class="line">	 <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2887"><td class="num" id="LN2887">2887</td><td class="line">	 <span class='comment'>* We are going to allocate a new data block. Depending on the</span></td></tr>
<tr class="codeline" data-linenumber="2888"><td class="num" id="LN2888">2888</td><td class="line">	 <span class='comment'>* situation it will be put to the left or right of the existing</span></td></tr>
<tr class="codeline" data-linenumber="2889"><td class="num" id="LN2889">2889</td><td class="line">	 <span class='comment'>* block.  If possible we put the new line in the left block and move</span></td></tr>
<tr class="codeline" data-linenumber="2890"><td class="num" id="LN2890">2890</td><td class="line">	 <span class='comment'>* the lines after it to the right block. Otherwise the new line is</span></td></tr>
<tr class="codeline" data-linenumber="2891"><td class="num" id="LN2891">2891</td><td class="line">	 <span class='comment'>* also put in the right block. This method is more efficient when</span></td></tr>
<tr class="codeline" data-linenumber="2892"><td class="num" id="LN2892">2892</td><td class="line">	 <span class='comment'>* inserting a lot of lines at one place.</span></td></tr>
<tr class="codeline" data-linenumber="2893"><td class="num" id="LN2893">2893</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2894"><td class="num" id="LN2894">2894</td><td class="line">	<span class='keyword'>if</span> (db_idx &lt; 0)		<span class='comment'>// left block is new, right block is existing</span></td></tr>
<tr class="codeline" data-linenumber="2895"><td class="num" id="LN2895">2895</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="2896"><td class="num" id="LN2896">2896</td><td class="line">	    lines_moved = 0;</td></tr>
<tr class="codeline" data-linenumber="2897"><td class="num" id="LN2897">2897</td><td class="line">	    in_left = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2898"><td class="num" id="LN2898">2898</td><td class="line">	    <span class='comment'>// space_needed does not change</span></td></tr>
<tr class="codeline" data-linenumber="2899"><td class="num" id="LN2899">2899</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="2900"><td class="num" id="LN2900">2900</td><td class="line">	<span class='keyword'>else</span>			<span class='comment'>// left block is existing, right block is new</span></td></tr>
<tr class="codeline" data-linenumber="2901"><td class="num" id="LN2901">2901</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="2902"><td class="num" id="LN2902">2902</td><td class="line">	    lines_moved = line_count - db_idx - 1;</td></tr>
<tr class="codeline" data-linenumber="2903"><td class="num" id="LN2903">2903</td><td class="line">	    <span class='keyword'>if</span> (lines_moved == 0)</td></tr>
<tr class="codeline" data-linenumber="2904"><td class="num" id="LN2904">2904</td><td class="line">		in_left = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;	<span class='comment'>// put new line in right block</span></td></tr>
<tr class="codeline" data-linenumber="2905"><td class="num" id="LN2905">2905</td><td class="line">					<span class='comment'>// space_needed does not change</span></td></tr>
<tr class="codeline" data-linenumber="2906"><td class="num" id="LN2906">2906</td><td class="line">	    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2907"><td class="num" id="LN2907">2907</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="2908"><td class="num" id="LN2908">2908</td><td class="line">		data_moved = ((dp-&gt;db_index[db_idx]) &amp; <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>) -</td></tr>
<tr class="codeline" data-linenumber="2909"><td class="num" id="LN2909">2909</td><td class="line">							    dp-&gt;db_txt_start;</td></tr>
<tr class="codeline" data-linenumber="2910"><td class="num" id="LN2910">2910</td><td class="line">		total_moved = data_moved + lines_moved * <span class='macro'>INDEX_SIZE<span class='macro_popup'>(sizeof(unsigned))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2911"><td class="num" id="LN2911">2911</td><td class="line">		<span class='keyword'>if</span> ((<span class='keyword'>int</span>)dp-&gt;db_free + total_moved &gt;= space_needed)</td></tr>
<tr class="codeline" data-linenumber="2912"><td class="num" id="LN2912">2912</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="2913"><td class="num" id="LN2913">2913</td><td class="line">		    in_left = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;	<span class='comment'>// put new line in left block</span></td></tr>
<tr class="codeline" data-linenumber="2914"><td class="num" id="LN2914">2914</td><td class="line">		    space_needed = total_moved;</td></tr>
<tr class="codeline" data-linenumber="2915"><td class="num" id="LN2915">2915</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="2916"><td class="num" id="LN2916">2916</td><td class="line">		<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2917"><td class="num" id="LN2917">2917</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="2918"><td class="num" id="LN2918">2918</td><td class="line">		    in_left = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;	    <span class='comment'>// put new line in right block</span></td></tr>
<tr class="codeline" data-linenumber="2919"><td class="num" id="LN2919">2919</td><td class="line">		    space_needed += total_moved;</td></tr>
<tr class="codeline" data-linenumber="2920"><td class="num" id="LN2920">2920</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="2921"><td class="num" id="LN2921">2921</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="2922"><td class="num" id="LN2922">2922</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="2923"><td class="num" id="LN2923">2923</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2924"><td class="num" id="LN2924">2924</td><td class="line">	page_count = ((space_needed + <span class='macro'>HEADER_SIZE<span class='macro_popup'>(sizeof(DATA_BL) - (sizeof(unsigned)))</span></span>) + page_size - 1) / page_size;</td></tr>
<tr class="codeline" data-linenumber="2925"><td class="num" id="LN2925">2925</td><td class="line">	<span class='keyword'>if</span> ((hp_new = ml_new_data(mfp, flags &amp; <span class='macro'>ML_APPEND_NEW<span class='macro_popup'>1</span></span>, page_count))</td></tr>
<tr class="codeline" data-linenumber="2926"><td class="num" id="LN2926">2926</td><td class="line">								       == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2927"><td class="num" id="LN2927">2927</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="2928"><td class="num" id="LN2928">2928</td><td class="line">			<span class='comment'>// correct line counts in pointer blocks</span></td></tr>
<tr class="codeline" data-linenumber="2929"><td class="num" id="LN2929">2929</td><td class="line">	    --(buf-&gt;b_ml.ml_locked_lineadd);</td></tr>
<tr class="codeline" data-linenumber="2930"><td class="num" id="LN2930">2930</td><td class="line">	    --(buf-&gt;b_ml.ml_locked_high);</td></tr>
<tr class="codeline" data-linenumber="2931"><td class="num" id="LN2931">2931</td><td class="line">	    <span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="2932"><td class="num" id="LN2932">2932</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="2933"><td class="num" id="LN2933">2933</td><td class="line">	<span class='keyword'>if</span> (db_idx &lt; 0)		<span class='comment'>// left block is new</span></td></tr>
<tr class="codeline" data-linenumber="2934"><td class="num" id="LN2934">2934</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="2935"><td class="num" id="LN2935">2935</td><td class="line">	    hp_left = hp_new;</td></tr>
<tr class="codeline" data-linenumber="2936"><td class="num" id="LN2936">2936</td><td class="line">	    hp_right = hp;</td></tr>
<tr class="codeline" data-linenumber="2937"><td class="num" id="LN2937">2937</td><td class="line">	    line_count_left = 0;</td></tr>
<tr class="codeline" data-linenumber="2938"><td class="num" id="LN2938">2938</td><td class="line">	    line_count_right = line_count;</td></tr>
<tr class="codeline" data-linenumber="2939"><td class="num" id="LN2939">2939</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="2940"><td class="num" id="LN2940">2940</td><td class="line">	<span class='keyword'>else</span>			<span class='comment'>// right block is new</span></td></tr>
<tr class="codeline" data-linenumber="2941"><td class="num" id="LN2941">2941</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="2942"><td class="num" id="LN2942">2942</td><td class="line">	    hp_left = hp;</td></tr>
<tr class="codeline" data-linenumber="2943"><td class="num" id="LN2943">2943</td><td class="line">	    hp_right = hp_new;</td></tr>
<tr class="codeline" data-linenumber="2944"><td class="num" id="LN2944">2944</td><td class="line">	    line_count_left = line_count;</td></tr>
<tr class="codeline" data-linenumber="2945"><td class="num" id="LN2945">2945</td><td class="line">	    line_count_right = 0;</td></tr>
<tr class="codeline" data-linenumber="2946"><td class="num" id="LN2946">2946</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="2947"><td class="num" id="LN2947">2947</td><td class="line">	dp_right = (DATA_BL *)(hp_right-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="2948"><td class="num" id="LN2948">2948</td><td class="line">	dp_left = (DATA_BL *)(hp_left-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="2949"><td class="num" id="LN2949">2949</td><td class="line">	bnum_left = hp_left-&gt;<span class='macro'>bh_bnum<span class='macro_popup'>bh_hashitem.mhi_key</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2950"><td class="num" id="LN2950">2950</td><td class="line">	bnum_right = hp_right-&gt;<span class='macro'>bh_bnum<span class='macro_popup'>bh_hashitem.mhi_key</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2951"><td class="num" id="LN2951">2951</td><td class="line">	page_count_left = hp_left-&gt;bh_page_count;</td></tr>
<tr class="codeline" data-linenumber="2952"><td class="num" id="LN2952">2952</td><td class="line">	page_count_right = hp_right-&gt;bh_page_count;</td></tr>
<tr class="codeline" data-linenumber="2953"><td class="num" id="LN2953">2953</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2954"><td class="num" id="LN2954">2954</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2955"><td class="num" id="LN2955">2955</td><td class="line">	 <span class='comment'>* May move the new line into the right/new block.</span></td></tr>
<tr class="codeline" data-linenumber="2956"><td class="num" id="LN2956">2956</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2957"><td class="num" id="LN2957">2957</td><td class="line">	<span class='keyword'>if</span> (!in_left)</td></tr>
<tr class="codeline" data-linenumber="2958"><td class="num" id="LN2958">2958</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="2959"><td class="num" id="LN2959">2959</td><td class="line">	    dp_right-&gt;db_txt_start -= len;</td></tr>
<tr class="codeline" data-linenumber="2960"><td class="num" id="LN2960">2960</td><td class="line">	    dp_right-&gt;db_free -= len + <span class='macro'>INDEX_SIZE<span class='macro_popup'>(sizeof(unsigned))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2961"><td class="num" id="LN2961">2961</td><td class="line">	    dp_right-&gt;db_index[0] = dp_right-&gt;db_txt_start;</td></tr>
<tr class="codeline" data-linenumber="2962"><td class="num" id="LN2962">2962</td><td class="line">	    <span class='keyword'>if</span> (flags &amp; <span class='macro'>ML_APPEND_MARK<span class='macro_popup'>2</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2963"><td class="num" id="LN2963">2963</td><td class="line">		dp_right-&gt;db_index[0] |= <span class='macro'>DB_MARKED<span class='macro_popup'>((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2964"><td class="num" id="LN2964">2964</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2965"><td class="num" id="LN2965">2965</td><td class="line">	    <span class='macro'>mch_memmove((<span class='keyword'>char</span> *)dp_right + dp_right-&gt;db_txt_start,<span class='macro_popup'>memmove((char *)((char *)dp_right + dp_right-&gt;db_txt_start<br>), (char *)(line), (size_t)len)</span></span></td></tr>
<tr class="codeline" data-linenumber="2966"><td class="num" id="LN2966">2966</td><td class="line">							   <span class='macro'>line, (size_t)len)<span class='macro_popup'>memmove((char *)((char *)dp_right + dp_right-&gt;db_txt_start<br>), (char *)(line), (size_t)len)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2967"><td class="num" id="LN2967">2967</td><td class="line">	    ++line_count_right;</td></tr>
<tr class="codeline" data-linenumber="2968"><td class="num" id="LN2968">2968</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="2969"><td class="num" id="LN2969">2969</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2970"><td class="num" id="LN2970">2970</td><td class="line">	 <span class='comment'>* may move lines from the left/old block to the right/new one.</span></td></tr>
<tr class="codeline" data-linenumber="2971"><td class="num" id="LN2971">2971</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2972"><td class="num" id="LN2972">2972</td><td class="line">	<span class='keyword'>if</span> (lines_moved)</td></tr>
<tr class="codeline" data-linenumber="2973"><td class="num" id="LN2973">2973</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="2974"><td class="num" id="LN2974">2974</td><td class="line">	    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2975"><td class="num" id="LN2975">2975</td><td class="line">	     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2976"><td class="num" id="LN2976">2976</td><td class="line">	    dp_right-&gt;db_txt_start -= data_moved;</td></tr>
<tr class="codeline" data-linenumber="2977"><td class="num" id="LN2977">2977</td><td class="line">	    dp_right-&gt;db_free -= total_moved;</td></tr>
<tr class="codeline" data-linenumber="2978"><td class="num" id="LN2978">2978</td><td class="line">	    <span class='macro'>mch_memmove((<span class='keyword'>char</span> *)dp_right + dp_right-&gt;db_txt_start,<span class='macro_popup'>memmove((char *)((char *)dp_right + dp_right-&gt;db_txt_start<br>), (char *)((char *)dp_left + dp_left-&gt;db_txt_start), (size_t<br>)data_moved)</span></span></td></tr>
<tr class="codeline" data-linenumber="2979"><td class="num" id="LN2979">2979</td><td class="line">			<span class='macro'>(<span class='keyword'>char</span> *)dp_left + dp_left-&gt;db_txt_start,<span class='macro_popup'>memmove((char *)((char *)dp_right + dp_right-&gt;db_txt_start<br>), (char *)((char *)dp_left + dp_left-&gt;db_txt_start), (size_t<br>)data_moved)</span></span></td></tr>
<tr class="codeline" data-linenumber="2980"><td class="num" id="LN2980">2980</td><td class="line">			<span class='macro'>(size_t)data_moved)<span class='macro_popup'>memmove((char *)((char *)dp_right + dp_right-&gt;db_txt_start<br>), (char *)((char *)dp_left + dp_left-&gt;db_txt_start), (size_t<br>)data_moved)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2981"><td class="num" id="LN2981">2981</td><td class="line">	    offset = dp_right-&gt;db_txt_start - dp_left-&gt;db_txt_start;</td></tr>
<tr class="codeline" data-linenumber="2982"><td class="num" id="LN2982">2982</td><td class="line">	    dp_left-&gt;db_txt_start += data_moved;</td></tr>
<tr class="codeline" data-linenumber="2983"><td class="num" id="LN2983">2983</td><td class="line">	    dp_left-&gt;db_free += total_moved;</td></tr>
<tr class="codeline" data-linenumber="2984"><td class="num" id="LN2984">2984</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2985"><td class="num" id="LN2985">2985</td><td class="line">	    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2986"><td class="num" id="LN2986">2986</td><td class="line">	     <span class='comment'>* update indexes in the new block</span></td></tr>
<tr class="codeline" data-linenumber="2987"><td class="num" id="LN2987">2987</td><td class="line">	     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2988"><td class="num" id="LN2988">2988</td><td class="line">	    <span class='keyword'>for</span> (to = line_count_right, from = db_idx + 1;</td></tr>
<tr class="codeline" data-linenumber="2989"><td class="num" id="LN2989">2989</td><td class="line">					 from &lt; line_count_left; ++from, ++to)</td></tr>
<tr class="codeline" data-linenumber="2990"><td class="num" id="LN2990">2990</td><td class="line">		dp_right-&gt;db_index[to] = dp-&gt;db_index[from] + offset;</td></tr>
<tr class="codeline" data-linenumber="2991"><td class="num" id="LN2991">2991</td><td class="line">	    line_count_right += lines_moved;</td></tr>
<tr class="codeline" data-linenumber="2992"><td class="num" id="LN2992">2992</td><td class="line">	    line_count_left -= lines_moved;</td></tr>
<tr class="codeline" data-linenumber="2993"><td class="num" id="LN2993">2993</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="2994"><td class="num" id="LN2994">2994</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2995"><td class="num" id="LN2995">2995</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2996"><td class="num" id="LN2996">2996</td><td class="line">	 <span class='comment'>* May move the new line into the left (old or new) block.</span></td></tr>
<tr class="codeline" data-linenumber="2997"><td class="num" id="LN2997">2997</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2998"><td class="num" id="LN2998">2998</td><td class="line">	<span class='keyword'>if</span> (in_left)</td></tr>
<tr class="codeline" data-linenumber="2999"><td class="num" id="LN2999">2999</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="3000"><td class="num" id="LN3000">3000</td><td class="line">	    dp_left-&gt;db_txt_start -= len;</td></tr>
<tr class="codeline" data-linenumber="3001"><td class="num" id="LN3001">3001</td><td class="line">	    dp_left-&gt;db_free -= len + <span class='macro'>INDEX_SIZE<span class='macro_popup'>(sizeof(unsigned))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3002"><td class="num" id="LN3002">3002</td><td class="line">	    dp_left-&gt;db_index[line_count_left] = dp_left-&gt;db_txt_start;</td></tr>
<tr class="codeline" data-linenumber="3003"><td class="num" id="LN3003">3003</td><td class="line">	    <span class='keyword'>if</span> (flags &amp; <span class='macro'>ML_APPEND_MARK<span class='macro_popup'>2</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3004"><td class="num" id="LN3004">3004</td><td class="line">		dp_left-&gt;db_index[line_count_left] |= <span class='macro'>DB_MARKED<span class='macro_popup'>((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3005"><td class="num" id="LN3005">3005</td><td class="line">	    <span class='macro'>mch_memmove((<span class='keyword'>char</span> *)dp_left + dp_left-&gt;db_txt_start,<span class='macro_popup'>memmove((char *)((char *)dp_left + dp_left-&gt;db_txt_start),<br> (char *)(line), (size_t)len)</span></span></td></tr>
<tr class="codeline" data-linenumber="3006"><td class="num" id="LN3006">3006</td><td class="line">							   <span class='macro'>line, (size_t)len)<span class='macro_popup'>memmove((char *)((char *)dp_left + dp_left-&gt;db_txt_start),<br> (char *)(line), (size_t)len)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3007"><td class="num" id="LN3007">3007</td><td class="line">	    ++line_count_left;</td></tr>
<tr class="codeline" data-linenumber="3008"><td class="num" id="LN3008">3008</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="3009"><td class="num" id="LN3009">3009</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3010"><td class="num" id="LN3010">3010</td><td class="line">	<span class='keyword'>if</span> (db_idx &lt; 0)		<span class='comment'>// left block is new</span></td></tr>
<tr class="codeline" data-linenumber="3011"><td class="num" id="LN3011">3011</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="3012"><td class="num" id="LN3012">3012</td><td class="line">	    lnum_left = lnum + 1;</td></tr>
<tr class="codeline" data-linenumber="3013"><td class="num" id="LN3013">3013</td><td class="line">	    lnum_right = 0;</td></tr>
<tr class="codeline" data-linenumber="3014"><td class="num" id="LN3014">3014</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="3015"><td class="num" id="LN3015">3015</td><td class="line">	<span class='keyword'>else</span>			<span class='comment'>// right block is new</span></td></tr>
<tr class="codeline" data-linenumber="3016"><td class="num" id="LN3016">3016</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="3017"><td class="num" id="LN3017">3017</td><td class="line">	    lnum_left = 0;</td></tr>
<tr class="codeline" data-linenumber="3018"><td class="num" id="LN3018">3018</td><td class="line">	    <span class='keyword'>if</span> (in_left)</td></tr>
<tr class="codeline" data-linenumber="3019"><td class="num" id="LN3019">3019</td><td class="line">		lnum_right = lnum + 2;</td></tr>
<tr class="codeline" data-linenumber="3020"><td class="num" id="LN3020">3020</td><td class="line">	    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3021"><td class="num" id="LN3021">3021</td><td class="line">		lnum_right = lnum + 1;</td></tr>
<tr class="codeline" data-linenumber="3022"><td class="num" id="LN3022">3022</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="3023"><td class="num" id="LN3023">3023</td><td class="line">	dp_left-&gt;db_line_count = line_count_left;</td></tr>
<tr class="codeline" data-linenumber="3024"><td class="num" id="LN3024">3024</td><td class="line">	dp_right-&gt;db_line_count = line_count_right;</td></tr>
<tr class="codeline" data-linenumber="3025"><td class="num" id="LN3025">3025</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3026"><td class="num" id="LN3026">3026</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3027"><td class="num" id="LN3027">3027</td><td class="line">	 <span class='comment'>* release the two data blocks</span></td></tr>
<tr class="codeline" data-linenumber="3028"><td class="num" id="LN3028">3028</td><td class="line">	 <span class='comment'>* The new one (hp_new) already has a correct blocknumber.</span></td></tr>
<tr class="codeline" data-linenumber="3029"><td class="num" id="LN3029">3029</td><td class="line">	 <span class='comment'>* The old one (hp, in ml_locked) gets a positive blocknumber if</span></td></tr>
<tr class="codeline" data-linenumber="3030"><td class="num" id="LN3030">3030</td><td class="line">	 <span class='comment'>* we changed it and we are not editing a new file.</span></td></tr>
<tr class="codeline" data-linenumber="3031"><td class="num" id="LN3031">3031</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3032"><td class="num" id="LN3032">3032</td><td class="line">	<span class='keyword'>if</span> (lines_moved || in_left)</td></tr>
<tr class="codeline" data-linenumber="3033"><td class="num" id="LN3033">3033</td><td class="line">	    buf-&gt;b_ml.ml_flags |= <span class='macro'>ML_LOCKED_DIRTY<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3034"><td class="num" id="LN3034">3034</td><td class="line">	<span class='keyword'>if</span> (!(flags &amp; <span class='macro'>ML_APPEND_NEW<span class='macro_popup'>1</span></span>) &amp;&amp; db_idx &gt;= 0 &amp;&amp; in_left)</td></tr>
<tr class="codeline" data-linenumber="3035"><td class="num" id="LN3035">3035</td><td class="line">	    buf-&gt;b_ml.ml_flags |= <span class='macro'>ML_LOCKED_POS<span class='macro_popup'>8</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3036"><td class="num" id="LN3036">3036</td><td class="line">	mf_put(mfp, hp_new, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3037"><td class="num" id="LN3037">3037</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3038"><td class="num" id="LN3038">3038</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3039"><td class="num" id="LN3039">3039</td><td class="line">	 <span class='comment'>* flush the old data block</span></td></tr>
<tr class="codeline" data-linenumber="3040"><td class="num" id="LN3040">3040</td><td class="line">	 <span class='comment'>* set ml_locked_lineadd to 0, because the updating of the</span></td></tr>
<tr class="codeline" data-linenumber="3041"><td class="num" id="LN3041">3041</td><td class="line">	 <span class='comment'>* pointer blocks is done below</span></td></tr>
<tr class="codeline" data-linenumber="3042"><td class="num" id="LN3042">3042</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3043"><td class="num" id="LN3043">3043</td><td class="line">	lineadd = buf-&gt;b_ml.ml_locked_lineadd;</td></tr>
<tr class="codeline" data-linenumber="3044"><td class="num" id="LN3044">3044</td><td class="line">	buf-&gt;b_ml.ml_locked_lineadd = 0;</td></tr>
<tr class="codeline" data-linenumber="3045"><td class="num" id="LN3045">3045</td><td class="line">	ml_find_line(buf, (linenr_T)0, <span class='macro'>ML_FLUSH<span class='macro_popup'>0x02</span></span>);   <span class='comment'>// flush data block</span></td></tr>
<tr class="codeline" data-linenumber="3046"><td class="num" id="LN3046">3046</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3047"><td class="num" id="LN3047">3047</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3048"><td class="num" id="LN3048">3048</td><td class="line">	 <span class='comment'>* update pointer blocks for the new data block</span></td></tr>
<tr class="codeline" data-linenumber="3049"><td class="num" id="LN3049">3049</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3050"><td class="num" id="LN3050">3050</td><td class="line">	<span class='keyword'>for</span> (stack_idx = buf-&gt;b_ml.ml_stack_top - 1; stack_idx &gt;= 0;</td></tr>
<tr class="codeline" data-linenumber="3051"><td class="num" id="LN3051">3051</td><td class="line">								  --stack_idx)</td></tr>
<tr class="codeline" data-linenumber="3052"><td class="num" id="LN3052">3052</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="3053"><td class="num" id="LN3053">3053</td><td class="line">	    ip = &amp;(buf-&gt;b_ml.ml_stack[stack_idx]);</td></tr>
<tr class="codeline" data-linenumber="3054"><td class="num" id="LN3054">3054</td><td class="line">	    pb_idx = ip-&gt;ip_index;</td></tr>
<tr class="codeline" data-linenumber="3055"><td class="num" id="LN3055">3055</td><td class="line">	    <span class='keyword'>if</span> ((hp = mf_get(mfp, ip-&gt;ip_bnum, 1)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3056"><td class="num" id="LN3056">3056</td><td class="line">		<span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="3057"><td class="num" id="LN3057">3057</td><td class="line">	    pp = (PTR_BL *)(hp-&gt;bh_data);   <span class='comment'>// must be pointer block</span></td></tr>
<tr class="codeline" data-linenumber="3058"><td class="num" id="LN3058">3058</td><td class="line">	    <span class='keyword'>if</span> (pp-&gt;pb_id != <span class='macro'>PTR_ID<span class='macro_popup'>(('p' &lt;&lt; 8) + 't')</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3059"><td class="num" id="LN3059">3059</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="3060"><td class="num" id="LN3060">3060</td><td class="line">		iemsg(<span class='macro'>_(<span class='string_literal'>"E317: pointer block id wrong 3"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E317: pointer block id wrong 3"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3061"><td class="num" id="LN3061">3061</td><td class="line">		mf_put(mfp, hp, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3062"><td class="num" id="LN3062">3062</td><td class="line">		<span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="3063"><td class="num" id="LN3063">3063</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="3064"><td class="num" id="LN3064">3064</td><td class="line">	    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3065"><td class="num" id="LN3065">3065</td><td class="line">	     <span class='comment'>* TODO: If the pointer block is full and we are adding at the end</span></td></tr>
<tr class="codeline" data-linenumber="3066"><td class="num" id="LN3066">3066</td><td class="line">	     <span class='comment'>* try to insert in front of the next block</span></td></tr>
<tr class="codeline" data-linenumber="3067"><td class="num" id="LN3067">3067</td><td class="line">	     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3068"><td class="num" id="LN3068">3068</td><td class="line">	    <span class='comment'>// block not full, add one entry</span></td></tr>
<tr class="codeline" data-linenumber="3069"><td class="num" id="LN3069">3069</td><td class="line">	    <span class='keyword'>if</span> (pp-&gt;pb_count &lt; pp-&gt;pb_count_max)</td></tr>
<tr class="codeline" data-linenumber="3070"><td class="num" id="LN3070">3070</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="3071"><td class="num" id="LN3071">3071</td><td class="line">		<span class='keyword'>if</span> (pb_idx + 1 &lt; (<span class='keyword'>int</span>)pp-&gt;pb_count)</td></tr>
<tr class="codeline" data-linenumber="3072"><td class="num" id="LN3072">3072</td><td class="line">		    <span class='macro'>mch_memmove(&amp;pp-&gt;pb_pointer[pb_idx + 2],<span class='macro_popup'>memmove((char *)(&amp;pp-&gt;pb_pointer[pb_idx + 2]), (char *<br>)(&amp;pp-&gt;pb_pointer[pb_idx + 1]), (size_t)(pp-&gt;pb_count<br> - pb_idx - 1) * sizeof(PTR_EN))</span></span></td></tr>
<tr class="codeline" data-linenumber="3073"><td class="num" id="LN3073">3073</td><td class="line">				<span class='macro'>&amp;pp-&gt;pb_pointer[pb_idx + 1],<span class='macro_popup'>memmove((char *)(&amp;pp-&gt;pb_pointer[pb_idx + 2]), (char *<br>)(&amp;pp-&gt;pb_pointer[pb_idx + 1]), (size_t)(pp-&gt;pb_count<br> - pb_idx - 1) * sizeof(PTR_EN))</span></span></td></tr>
<tr class="codeline" data-linenumber="3074"><td class="num" id="LN3074">3074</td><td class="line">			<span class='macro'>(size_t)(pp-&gt;pb_count - pb_idx - 1) * <span class='keyword'>sizeof</span>(PTR_EN))<span class='macro_popup'>memmove((char *)(&amp;pp-&gt;pb_pointer[pb_idx + 2]), (char *<br>)(&amp;pp-&gt;pb_pointer[pb_idx + 1]), (size_t)(pp-&gt;pb_count<br> - pb_idx - 1) * sizeof(PTR_EN))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3075"><td class="num" id="LN3075">3075</td><td class="line">		++pp-&gt;pb_count;</td></tr>
<tr class="codeline" data-linenumber="3076"><td class="num" id="LN3076">3076</td><td class="line">		pp-&gt;pb_pointer[pb_idx].pe_line_count = line_count_left;</td></tr>
<tr class="codeline" data-linenumber="3077"><td class="num" id="LN3077">3077</td><td class="line">		pp-&gt;pb_pointer[pb_idx].pe_bnum = bnum_left;</td></tr>
<tr class="codeline" data-linenumber="3078"><td class="num" id="LN3078">3078</td><td class="line">		pp-&gt;pb_pointer[pb_idx].pe_page_count = page_count_left;</td></tr>
<tr class="codeline" data-linenumber="3079"><td class="num" id="LN3079">3079</td><td class="line">		pp-&gt;pb_pointer[pb_idx + 1].pe_line_count = line_count_right;</td></tr>
<tr class="codeline" data-linenumber="3080"><td class="num" id="LN3080">3080</td><td class="line">		pp-&gt;pb_pointer[pb_idx + 1].pe_bnum = bnum_right;</td></tr>
<tr class="codeline" data-linenumber="3081"><td class="num" id="LN3081">3081</td><td class="line">		pp-&gt;pb_pointer[pb_idx + 1].pe_page_count = page_count_right;</td></tr>
<tr class="codeline" data-linenumber="3082"><td class="num" id="LN3082">3082</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3083"><td class="num" id="LN3083">3083</td><td class="line">		<span class='keyword'>if</span> (lnum_left != 0)</td></tr>
<tr class="codeline" data-linenumber="3084"><td class="num" id="LN3084">3084</td><td class="line">		    pp-&gt;pb_pointer[pb_idx].pe_old_lnum = lnum_left;</td></tr>
<tr class="codeline" data-linenumber="3085"><td class="num" id="LN3085">3085</td><td class="line">		<span class='keyword'>if</span> (lnum_right != 0)</td></tr>
<tr class="codeline" data-linenumber="3086"><td class="num" id="LN3086">3086</td><td class="line">		    pp-&gt;pb_pointer[pb_idx + 1].pe_old_lnum = lnum_right;</td></tr>
<tr class="codeline" data-linenumber="3087"><td class="num" id="LN3087">3087</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3088"><td class="num" id="LN3088">3088</td><td class="line">		mf_put(mfp, hp, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3089"><td class="num" id="LN3089">3089</td><td class="line">		buf-&gt;b_ml.ml_stack_top = stack_idx + 1;	    <span class='comment'>// truncate stack</span></td></tr>
<tr class="codeline" data-linenumber="3090"><td class="num" id="LN3090">3090</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3091"><td class="num" id="LN3091">3091</td><td class="line">		<span class='keyword'>if</span> (lineadd)</td></tr>
<tr class="codeline" data-linenumber="3092"><td class="num" id="LN3092">3092</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="3093"><td class="num" id="LN3093">3093</td><td class="line">		    --(buf-&gt;b_ml.ml_stack_top);</td></tr>
<tr class="codeline" data-linenumber="3094"><td class="num" id="LN3094">3094</td><td class="line">		    <span class='comment'>// fix line count for rest of blocks in the stack</span></td></tr>
<tr class="codeline" data-linenumber="3095"><td class="num" id="LN3095">3095</td><td class="line">		    ml_lineadd(buf, lineadd);</td></tr>
<tr class="codeline" data-linenumber="3096"><td class="num" id="LN3096">3096</td><td class="line">							<span class='comment'>// fix stack itself</span></td></tr>
<tr class="codeline" data-linenumber="3097"><td class="num" id="LN3097">3097</td><td class="line">		    buf-&gt;b_ml.ml_stack[buf-&gt;b_ml.ml_stack_top].ip_high +=</td></tr>
<tr class="codeline" data-linenumber="3098"><td class="num" id="LN3098">3098</td><td class="line">								      lineadd;</td></tr>
<tr class="codeline" data-linenumber="3099"><td class="num" id="LN3099">3099</td><td class="line">		    ++(buf-&gt;b_ml.ml_stack_top);</td></tr>
<tr class="codeline" data-linenumber="3100"><td class="num" id="LN3100">3100</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="3101"><td class="num" id="LN3101">3101</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3102"><td class="num" id="LN3102">3102</td><td class="line">		<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3103"><td class="num" id="LN3103">3103</td><td class="line">		 <span class='comment'>* We are finished, break the loop here.</span></td></tr>
<tr class="codeline" data-linenumber="3104"><td class="num" id="LN3104">3104</td><td class="line">		 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3105"><td class="num" id="LN3105">3105</td><td class="line">		<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3106"><td class="num" id="LN3106">3106</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="3107"><td class="num" id="LN3107">3107</td><td class="line">	    <span class='keyword'>else</span>			<span class='comment'>// pointer block full</span></td></tr>
<tr class="codeline" data-linenumber="3108"><td class="num" id="LN3108">3108</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="3109"><td class="num" id="LN3109">3109</td><td class="line">		<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3110"><td class="num" id="LN3110">3110</td><td class="line">		 <span class='comment'>* split the pointer block</span></td></tr>
<tr class="codeline" data-linenumber="3111"><td class="num" id="LN3111">3111</td><td class="line">		 <span class='comment'>* allocate a new pointer block</span></td></tr>
<tr class="codeline" data-linenumber="3112"><td class="num" id="LN3112">3112</td><td class="line">		 <span class='comment'>* move some of the pointer into the new block</span></td></tr>
<tr class="codeline" data-linenumber="3113"><td class="num" id="LN3113">3113</td><td class="line">		 <span class='comment'>* prepare for updating the parent block</span></td></tr>
<tr class="codeline" data-linenumber="3114"><td class="num" id="LN3114">3114</td><td class="line">		 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3115"><td class="num" id="LN3115">3115</td><td class="line">		<span class='keyword'>for</span> (;;)	<span class='comment'>// do this twice when splitting block 1</span></td></tr>
<tr class="codeline" data-linenumber="3116"><td class="num" id="LN3116">3116</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="3117"><td class="num" id="LN3117">3117</td><td class="line">		    hp_new = ml_new_ptr(mfp);</td></tr>
<tr class="codeline" data-linenumber="3118"><td class="num" id="LN3118">3118</td><td class="line">		    <span class='keyword'>if</span> (hp_new == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)	    <span class='comment'>// TODO: try to fix tree</span></td></tr>
<tr class="codeline" data-linenumber="3119"><td class="num" id="LN3119">3119</td><td class="line">			<span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="3120"><td class="num" id="LN3120">3120</td><td class="line">		    pp_new = (PTR_BL *)(hp_new-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="3121"><td class="num" id="LN3121">3121</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3122"><td class="num" id="LN3122">3122</td><td class="line">		    <span class='keyword'>if</span> (hp-&gt;<span class='macro'>bh_bnum<span class='macro_popup'>bh_hashitem.mhi_key</span></span> != 1)</td></tr>
<tr class="codeline" data-linenumber="3123"><td class="num" id="LN3123">3123</td><td class="line">			<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3124"><td class="num" id="LN3124">3124</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3125"><td class="num" id="LN3125">3125</td><td class="line">		    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3126"><td class="num" id="LN3126">3126</td><td class="line">		     <span class='comment'>* if block 1 becomes full the tree is given an extra level</span></td></tr>
<tr class="codeline" data-linenumber="3127"><td class="num" id="LN3127">3127</td><td class="line">		     <span class='comment'>* The pointers from block 1 are moved into the new block.</span></td></tr>
<tr class="codeline" data-linenumber="3128"><td class="num" id="LN3128">3128</td><td class="line">		     <span class='comment'>* block 1 is updated to point to the new block</span></td></tr>
<tr class="codeline" data-linenumber="3129"><td class="num" id="LN3129">3129</td><td class="line">		     <span class='comment'>* then continue to split the new block</span></td></tr>
<tr class="codeline" data-linenumber="3130"><td class="num" id="LN3130">3130</td><td class="line">		     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3131"><td class="num" id="LN3131">3131</td><td class="line">		    <span class='macro'>mch_memmove(pp_new, pp, (size_t)page_size)<span class='macro_popup'>memmove((char *)(pp_new), (char *)(pp), (size_t)page_size)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3132"><td class="num" id="LN3132">3132</td><td class="line">		    pp-&gt;pb_count = 1;</td></tr>
<tr class="codeline" data-linenumber="3133"><td class="num" id="LN3133">3133</td><td class="line">		    pp-&gt;pb_pointer[0].pe_bnum = hp_new-&gt;<span class='macro'>bh_bnum<span class='macro_popup'>bh_hashitem.mhi_key</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3134"><td class="num" id="LN3134">3134</td><td class="line">		    pp-&gt;pb_pointer[0].pe_line_count = buf-&gt;b_ml.ml_line_count;</td></tr>
<tr class="codeline" data-linenumber="3135"><td class="num" id="LN3135">3135</td><td class="line">		    pp-&gt;pb_pointer[0].pe_old_lnum = 1;</td></tr>
<tr class="codeline" data-linenumber="3136"><td class="num" id="LN3136">3136</td><td class="line">		    pp-&gt;pb_pointer[0].pe_page_count = 1;</td></tr>
<tr class="codeline" data-linenumber="3137"><td class="num" id="LN3137">3137</td><td class="line">		    mf_put(mfp, hp, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);   <span class='comment'>// release block 1</span></td></tr>
<tr class="codeline" data-linenumber="3138"><td class="num" id="LN3138">3138</td><td class="line">		    hp = hp_new;		<span class='comment'>// new block is to be split</span></td></tr>
<tr class="codeline" data-linenumber="3139"><td class="num" id="LN3139">3139</td><td class="line">		    pp = pp_new;</td></tr>
<tr class="codeline" data-linenumber="3140"><td class="num" id="LN3140">3140</td><td class="line">		    <span class='macro'>CHECK(stack_idx != 0, _(<span class='string_literal'>"stack_idx should be 0"</span>))<span class='macro_popup'>do { } while (0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3141"><td class="num" id="LN3141">3141</td><td class="line">		    ip-&gt;ip_index = 0;</td></tr>
<tr class="codeline" data-linenumber="3142"><td class="num" id="LN3142">3142</td><td class="line">		    ++stack_idx;	<span class='comment'>// do block 1 again later</span></td></tr>
<tr class="codeline" data-linenumber="3143"><td class="num" id="LN3143">3143</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="3144"><td class="num" id="LN3144">3144</td><td class="line">		<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3145"><td class="num" id="LN3145">3145</td><td class="line">		 <span class='comment'>* move the pointers after the current one to the new block</span></td></tr>
<tr class="codeline" data-linenumber="3146"><td class="num" id="LN3146">3146</td><td class="line">		 <span class='comment'>* If there are none, the new entry will be in the new block.</span></td></tr>
<tr class="codeline" data-linenumber="3147"><td class="num" id="LN3147">3147</td><td class="line">		 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3148"><td class="num" id="LN3148">3148</td><td class="line">		total_moved = pp-&gt;pb_count - pb_idx - 1;</td></tr>
<tr class="codeline" data-linenumber="3149"><td class="num" id="LN3149">3149</td><td class="line">		<span class='keyword'>if</span> (total_moved)</td></tr>
<tr class="codeline" data-linenumber="3150"><td class="num" id="LN3150">3150</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="3151"><td class="num" id="LN3151">3151</td><td class="line">		    <span class='macro'>mch_memmove(&amp;pp_new-&gt;pb_pointer[0],<span class='macro_popup'>memmove((char *)(&amp;pp_new-&gt;pb_pointer[0]), (char *)(&amp;<br>pp-&gt;pb_pointer[pb_idx + 1]), (size_t)(total_moved) * sizeof<br>(PTR_EN))</span></span></td></tr>
<tr class="codeline" data-linenumber="3152"><td class="num" id="LN3152">3152</td><td class="line">				<span class='macro'>&amp;pp-&gt;pb_pointer[pb_idx + 1],<span class='macro_popup'>memmove((char *)(&amp;pp_new-&gt;pb_pointer[0]), (char *)(&amp;<br>pp-&gt;pb_pointer[pb_idx + 1]), (size_t)(total_moved) * sizeof<br>(PTR_EN))</span></span></td></tr>
<tr class="codeline" data-linenumber="3153"><td class="num" id="LN3153">3153</td><td class="line">				<span class='macro'>(size_t)(total_moved) * <span class='keyword'>sizeof</span>(PTR_EN))<span class='macro_popup'>memmove((char *)(&amp;pp_new-&gt;pb_pointer[0]), (char *)(&amp;<br>pp-&gt;pb_pointer[pb_idx + 1]), (size_t)(total_moved) * sizeof<br>(PTR_EN))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3154"><td class="num" id="LN3154">3154</td><td class="line">		    pp_new-&gt;pb_count = total_moved;</td></tr>
<tr class="codeline" data-linenumber="3155"><td class="num" id="LN3155">3155</td><td class="line">		    pp-&gt;pb_count -= total_moved - 1;</td></tr>
<tr class="codeline" data-linenumber="3156"><td class="num" id="LN3156">3156</td><td class="line">		    pp-&gt;pb_pointer[pb_idx + 1].pe_bnum = bnum_right;</td></tr>
<tr class="codeline" data-linenumber="3157"><td class="num" id="LN3157">3157</td><td class="line">		    pp-&gt;pb_pointer[pb_idx + 1].pe_line_count = line_count_right;</td></tr>
<tr class="codeline" data-linenumber="3158"><td class="num" id="LN3158">3158</td><td class="line">		    pp-&gt;pb_pointer[pb_idx + 1].pe_page_count = page_count_right;</td></tr>
<tr class="codeline" data-linenumber="3159"><td class="num" id="LN3159">3159</td><td class="line">		    <span class='keyword'>if</span> (lnum_right)</td></tr>
<tr class="codeline" data-linenumber="3160"><td class="num" id="LN3160">3160</td><td class="line">			pp-&gt;pb_pointer[pb_idx + 1].pe_old_lnum = lnum_right;</td></tr>
<tr class="codeline" data-linenumber="3161"><td class="num" id="LN3161">3161</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="3162"><td class="num" id="LN3162">3162</td><td class="line">		<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3163"><td class="num" id="LN3163">3163</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="3164"><td class="num" id="LN3164">3164</td><td class="line">		    pp_new-&gt;pb_count = 1;</td></tr>
<tr class="codeline" data-linenumber="3165"><td class="num" id="LN3165">3165</td><td class="line">		    pp_new-&gt;pb_pointer[0].pe_bnum = bnum_right;</td></tr>
<tr class="codeline" data-linenumber="3166"><td class="num" id="LN3166">3166</td><td class="line">		    pp_new-&gt;pb_pointer[0].pe_line_count = line_count_right;</td></tr>
<tr class="codeline" data-linenumber="3167"><td class="num" id="LN3167">3167</td><td class="line">		    pp_new-&gt;pb_pointer[0].pe_page_count = page_count_right;</td></tr>
<tr class="codeline" data-linenumber="3168"><td class="num" id="LN3168">3168</td><td class="line">		    pp_new-&gt;pb_pointer[0].pe_old_lnum = lnum_right;</td></tr>
<tr class="codeline" data-linenumber="3169"><td class="num" id="LN3169">3169</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="3170"><td class="num" id="LN3170">3170</td><td class="line">		pp-&gt;pb_pointer[pb_idx].pe_bnum = bnum_left;</td></tr>
<tr class="codeline" data-linenumber="3171"><td class="num" id="LN3171">3171</td><td class="line">		pp-&gt;pb_pointer[pb_idx].pe_line_count = line_count_left;</td></tr>
<tr class="codeline" data-linenumber="3172"><td class="num" id="LN3172">3172</td><td class="line">		pp-&gt;pb_pointer[pb_idx].pe_page_count = page_count_left;</td></tr>
<tr class="codeline" data-linenumber="3173"><td class="num" id="LN3173">3173</td><td class="line">		<span class='keyword'>if</span> (lnum_left)</td></tr>
<tr class="codeline" data-linenumber="3174"><td class="num" id="LN3174">3174</td><td class="line">		    pp-&gt;pb_pointer[pb_idx].pe_old_lnum = lnum_left;</td></tr>
<tr class="codeline" data-linenumber="3175"><td class="num" id="LN3175">3175</td><td class="line">		lnum_left = 0;</td></tr>
<tr class="codeline" data-linenumber="3176"><td class="num" id="LN3176">3176</td><td class="line">		lnum_right = 0;</td></tr>
<tr class="codeline" data-linenumber="3177"><td class="num" id="LN3177">3177</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3178"><td class="num" id="LN3178">3178</td><td class="line">		<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3179"><td class="num" id="LN3179">3179</td><td class="line">		 <span class='comment'>* recompute line counts</span></td></tr>
<tr class="codeline" data-linenumber="3180"><td class="num" id="LN3180">3180</td><td class="line">		 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3181"><td class="num" id="LN3181">3181</td><td class="line">		line_count_right = 0;</td></tr>
<tr class="codeline" data-linenumber="3182"><td class="num" id="LN3182">3182</td><td class="line">		<span class='keyword'>for</span> (i = 0; i &lt; (<span class='keyword'>int</span>)pp_new-&gt;pb_count; ++i)</td></tr>
<tr class="codeline" data-linenumber="3183"><td class="num" id="LN3183">3183</td><td class="line">		    line_count_right += pp_new-&gt;pb_pointer[i].pe_line_count;</td></tr>
<tr class="codeline" data-linenumber="3184"><td class="num" id="LN3184">3184</td><td class="line">		line_count_left = 0;</td></tr>
<tr class="codeline" data-linenumber="3185"><td class="num" id="LN3185">3185</td><td class="line">		<span class='keyword'>for</span> (i = 0; i &lt; (<span class='keyword'>int</span>)pp-&gt;pb_count; ++i)</td></tr>
<tr class="codeline" data-linenumber="3186"><td class="num" id="LN3186">3186</td><td class="line">		    line_count_left += pp-&gt;pb_pointer[i].pe_line_count;</td></tr>
<tr class="codeline" data-linenumber="3187"><td class="num" id="LN3187">3187</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3188"><td class="num" id="LN3188">3188</td><td class="line">		bnum_left = hp-&gt;<span class='macro'>bh_bnum<span class='macro_popup'>bh_hashitem.mhi_key</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3189"><td class="num" id="LN3189">3189</td><td class="line">		bnum_right = hp_new-&gt;<span class='macro'>bh_bnum<span class='macro_popup'>bh_hashitem.mhi_key</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3190"><td class="num" id="LN3190">3190</td><td class="line">		page_count_left = 1;</td></tr>
<tr class="codeline" data-linenumber="3191"><td class="num" id="LN3191">3191</td><td class="line">		page_count_right = 1;</td></tr>
<tr class="codeline" data-linenumber="3192"><td class="num" id="LN3192">3192</td><td class="line">		mf_put(mfp, hp, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3193"><td class="num" id="LN3193">3193</td><td class="line">		mf_put(mfp, hp_new, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3194"><td class="num" id="LN3194">3194</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="3195"><td class="num" id="LN3195">3195</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="3196"><td class="num" id="LN3196">3196</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3197"><td class="num" id="LN3197">3197</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3198"><td class="num" id="LN3198">3198</td><td class="line">	 <span class='comment'>* Safety check: fallen out of for loop?</span></td></tr>
<tr class="codeline" data-linenumber="3199"><td class="num" id="LN3199">3199</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3200"><td class="num" id="LN3200">3200</td><td class="line">	<span class='keyword'>if</span> (stack_idx &lt; 0)</td></tr>
<tr class="codeline" data-linenumber="3201"><td class="num" id="LN3201">3201</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="3202"><td class="num" id="LN3202">3202</td><td class="line">	    iemsg(<span class='macro'>_(<span class='string_literal'>"E318: Updated too many blocks?"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E318: Updated too many blocks?"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3203"><td class="num" id="LN3203">3203</td><td class="line">	    buf-&gt;b_ml.ml_stack_top = 0;	<span class='comment'>// invalidate stack</span></td></tr>
<tr class="codeline" data-linenumber="3204"><td class="num" id="LN3204">3204</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="3205"><td class="num" id="LN3205">3205</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3206"><td class="num" id="LN3206">3206</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3207"><td class="num" id="LN3207">3207</td><td class="line"><span class='directive'>#ifdef FEAT_BYTEOFF</span></td></tr>
<tr class="codeline" data-linenumber="3208"><td class="num" id="LN3208">3208</td><td class="line">    <span class='comment'>// The line was inserted below 'lnum'</span></td></tr>
<tr class="codeline" data-linenumber="3209"><td class="num" id="LN3209">3209</td><td class="line">    ml_updatechunk(buf, lnum + 1, (<span class='keyword'>long</span>)len, <span class='macro'>ML_CHNK_ADDLINE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3210"><td class="num" id="LN3210">3210</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3211"><td class="num" id="LN3211">3211</td><td class="line"><span class='directive'>#ifdef <span class='macro'>FEAT_NETBEANS_INTG<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="3212"><td class="num" id="LN3212">3212</td><td class="line">    <span class='keyword'>if</span> (netbeans_active())</td></tr>
<tr class="codeline" data-linenumber="3213"><td class="num" id="LN3213">3213</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3214"><td class="num" id="LN3214">3214</td><td class="line">	<span class='keyword'>if</span> (<span class='macro'>STRLEN(line)<span class='macro_popup'>strlen((char *)(line))</span></span> &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="3215"><td class="num" id="LN3215">3215</td><td class="line">	    netbeans_inserted(buf, lnum+1, (colnr_T)0, line, (<span class='keyword'>int</span>)<span class='macro'>STRLEN(line)<span class='macro_popup'>strlen((char *)(line))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3216"><td class="num" id="LN3216">3216</td><td class="line">	netbeans_inserted(buf, lnum+1, (colnr_T)<span class='macro'>STRLEN(line)<span class='macro_popup'>strlen((char *)(line))</span></span>,</td></tr>
<tr class="codeline" data-linenumber="3217"><td class="num" id="LN3217">3217</td><td class="line">							   (char_u *)<span class='string_literal'>"\n"</span>, 1);</td></tr>
<tr class="codeline" data-linenumber="3218"><td class="num" id="LN3218">3218</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3219"><td class="num" id="LN3219">3219</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3220"><td class="num" id="LN3220">3220</td><td class="line"><span class='directive'>#ifdef <span class='macro'>FEAT_JOB_CHANNEL<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="3221"><td class="num" id="LN3221">3221</td><td class="line">    <span class='keyword'>if</span> (buf-&gt;b_write_to_channel)</td></tr>
<tr class="codeline" data-linenumber="3222"><td class="num" id="LN3222">3222</td><td class="line">	channel_write_new_lines(buf);</td></tr>
<tr class="codeline" data-linenumber="3223"><td class="num" id="LN3223">3223</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3224"><td class="num" id="LN3224">3224</td><td class="line">    ret = <span class='macro'>OK<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3225"><td class="num" id="LN3225">3225</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3226"><td class="num" id="LN3226">3226</td><td class="line">theend:</td></tr>
<tr class="codeline" data-linenumber="3227"><td class="num" id="LN3227">3227</td><td class="line"><span class='directive'>#ifdef FEAT_PROP_POPUP</span></td></tr>
<tr class="codeline" data-linenumber="3228"><td class="num" id="LN3228">3228</td><td class="line">    vim_free(tofree);</td></tr>
<tr class="codeline" data-linenumber="3229"><td class="num" id="LN3229">3229</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3230"><td class="num" id="LN3230">3230</td><td class="line">    <span class='keyword'>return</span> ret;</td></tr>
<tr class="codeline" data-linenumber="3231"><td class="num" id="LN3231">3231</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3232"><td class="num" id="LN3232">3232</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3233"><td class="num" id="LN3233">3233</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3234"><td class="num" id="LN3234">3234</td><td class="line"> <span class='comment'>* Flush any pending change and call ml_append_int()</span></td></tr>
<tr class="codeline" data-linenumber="3235"><td class="num" id="LN3235">3235</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3236"><td class="num" id="LN3236">3236</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="3237"><td class="num" id="LN3237">3237</td><td class="line">ml_append_flush(</td></tr>
<tr class="codeline" data-linenumber="3238"><td class="num" id="LN3238">3238</td><td class="line">    buf_T	*buf,</td></tr>
<tr class="codeline" data-linenumber="3239"><td class="num" id="LN3239">3239</td><td class="line">    linenr_T	lnum,		<span class='comment'>// append after this line (can be 0)</span></td></tr>
<tr class="codeline" data-linenumber="3240"><td class="num" id="LN3240">3240</td><td class="line">    char_u	*line,		<span class='comment'>// text of the new line</span></td></tr>
<tr class="codeline" data-linenumber="3241"><td class="num" id="LN3241">3241</td><td class="line">    colnr_T	len,		<span class='comment'>// length of line, including NUL, or 0</span></td></tr>
<tr class="codeline" data-linenumber="3242"><td class="num" id="LN3242">3242</td><td class="line">    <span class='keyword'>int</span>		flags)		<span class='comment'>// ML_APPEND_ flags</span></td></tr>
<tr class="codeline" data-linenumber="3243"><td class="num" id="LN3243">3243</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3244"><td class="num" id="LN3244">3244</td><td class="line">    <span class='keyword'>if</span> (lnum &gt; buf-&gt;b_ml.ml_line_count)</td></tr>
<tr class="codeline" data-linenumber="3245"><td class="num" id="LN3245">3245</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>FAIL<span class='macro_popup'>0</span></span>;  <span class='comment'>// lnum out of range</span></td></tr>
<tr class="codeline" data-linenumber="3246"><td class="num" id="LN3246">3246</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3247"><td class="num" id="LN3247">3247</td><td class="line">    <span class='keyword'>if</span> (buf-&gt;b_ml.ml_line_lnum != 0)</td></tr>
<tr class="codeline" data-linenumber="3248"><td class="num" id="LN3248">3248</td><td class="line">	<span class='comment'>// This may also invoke ml_append_int().</span></td></tr>
<tr class="codeline" data-linenumber="3249"><td class="num" id="LN3249">3249</td><td class="line">	ml_flush_line(buf);</td></tr>
<tr class="codeline" data-linenumber="3250"><td class="num" id="LN3250">3250</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3251"><td class="num" id="LN3251">3251</td><td class="line"><span class='directive'>#ifdef FEAT_EVAL</span></td></tr>
<tr class="codeline" data-linenumber="3252"><td class="num" id="LN3252">3252</td><td class="line">    <span class='comment'>// When inserting above recorded changes: flush the changes before changing</span></td></tr>
<tr class="codeline" data-linenumber="3253"><td class="num" id="LN3253">3253</td><td class="line">    <span class='comment'>// the text.  Then flush the cached line, it may become invalid.</span></td></tr>
<tr class="codeline" data-linenumber="3254"><td class="num" id="LN3254">3254</td><td class="line">    may_invoke_listeners(buf, lnum + 1, lnum + 1, 1);</td></tr>
<tr class="codeline" data-linenumber="3255"><td class="num" id="LN3255">3255</td><td class="line">    <span class='keyword'>if</span> (buf-&gt;b_ml.ml_line_lnum != 0)</td></tr>
<tr class="codeline" data-linenumber="3256"><td class="num" id="LN3256">3256</td><td class="line">	ml_flush_line(buf);</td></tr>
<tr class="codeline" data-linenumber="3257"><td class="num" id="LN3257">3257</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3258"><td class="num" id="LN3258">3258</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3259"><td class="num" id="LN3259">3259</td><td class="line">    <span class='keyword'>return</span> ml_append_int(buf, lnum, line, len, flags);</td></tr>
<tr class="codeline" data-linenumber="3260"><td class="num" id="LN3260">3260</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3261"><td class="num" id="LN3261">3261</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3262"><td class="num" id="LN3262">3262</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3263"><td class="num" id="LN3263">3263</td><td class="line"> <span class='comment'>* Append a line after lnum (may be 0 to insert a line in front of the file).</span></td></tr>
<tr class="codeline" data-linenumber="3264"><td class="num" id="LN3264">3264</td><td class="line"> <span class='comment'>* "line" does not need to be allocated, but can't be another line in a</span></td></tr>
<tr class="codeline" data-linenumber="3265"><td class="num" id="LN3265">3265</td><td class="line"> <span class='comment'>* buffer, unlocking may make it invalid.</span></td></tr>
<tr class="codeline" data-linenumber="3266"><td class="num" id="LN3266">3266</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3267"><td class="num" id="LN3267">3267</td><td class="line"> <span class='comment'>* "newfile": TRUE when starting to edit a new file, meaning that pe_old_lnum</span></td></tr>
<tr class="codeline" data-linenumber="3268"><td class="num" id="LN3268">3268</td><td class="line"> <span class='comment'>*		will be set for recovery</span></td></tr>
<tr class="codeline" data-linenumber="3269"><td class="num" id="LN3269">3269</td><td class="line"> <span class='comment'>* Check: The caller of this function should probably also call</span></td></tr>
<tr class="codeline" data-linenumber="3270"><td class="num" id="LN3270">3270</td><td class="line"> <span class='comment'>* appended_lines().</span></td></tr>
<tr class="codeline" data-linenumber="3271"><td class="num" id="LN3271">3271</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3272"><td class="num" id="LN3272">3272</td><td class="line"> <span class='comment'>* return FAIL for failure, OK otherwise</span></td></tr>
<tr class="codeline" data-linenumber="3273"><td class="num" id="LN3273">3273</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3274"><td class="num" id="LN3274">3274</td><td class="line">    <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="3275"><td class="num" id="LN3275">3275</td><td class="line">ml_append(</td></tr>
<tr class="codeline" data-linenumber="3276"><td class="num" id="LN3276">3276</td><td class="line">    linenr_T	lnum,		<span class='comment'>// append after this line (can be 0)</span></td></tr>
<tr class="codeline" data-linenumber="3277"><td class="num" id="LN3277">3277</td><td class="line">    char_u	*line,		<span class='comment'>// text of the new line</span></td></tr>
<tr class="codeline" data-linenumber="3278"><td class="num" id="LN3278">3278</td><td class="line">    colnr_T	len,		<span class='comment'>// length of new line, including NUL, or 0</span></td></tr>
<tr class="codeline" data-linenumber="3279"><td class="num" id="LN3279">3279</td><td class="line">    <span class='keyword'>int</span>		newfile)	<span class='comment'>// flag, see above</span></td></tr>
<tr class="codeline" data-linenumber="3280"><td class="num" id="LN3280">3280</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3281"><td class="num" id="LN3281">3281</td><td class="line">    <span class='keyword'>return</span> ml_append_flags(lnum, line, len, newfile ? <span class='macro'>ML_APPEND_NEW<span class='macro_popup'>1</span></span> : 0);</td></tr>
<tr class="codeline" data-linenumber="3282"><td class="num" id="LN3282">3282</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3283"><td class="num" id="LN3283">3283</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3284"><td class="num" id="LN3284">3284</td><td class="line">    <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="3285"><td class="num" id="LN3285">3285</td><td class="line">ml_append_flags(</td></tr>
<tr class="codeline" data-linenumber="3286"><td class="num" id="LN3286">3286</td><td class="line">    linenr_T	lnum,		<span class='comment'>// append after this line (can be 0)</span></td></tr>
<tr class="codeline" data-linenumber="3287"><td class="num" id="LN3287">3287</td><td class="line">    char_u	*line,		<span class='comment'>// text of the new line</span></td></tr>
<tr class="codeline" data-linenumber="3288"><td class="num" id="LN3288">3288</td><td class="line">    colnr_T	len,		<span class='comment'>// length of new line, including NUL, or 0</span></td></tr>
<tr class="codeline" data-linenumber="3289"><td class="num" id="LN3289">3289</td><td class="line">    <span class='keyword'>int</span>		flags)		<span class='comment'>// ML_APPEND_ values</span></td></tr>
<tr class="codeline" data-linenumber="3290"><td class="num" id="LN3290">3290</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3291"><td class="num" id="LN3291">3291</td><td class="line">    <span class='comment'>// When starting up, we might still need to create the memfile</span></td></tr>
<tr class="codeline" data-linenumber="3292"><td class="num" id="LN3292">3292</td><td class="line">    <span class='keyword'>if</span> (curbuf-&gt;b_ml.ml_mfp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; open_buffer(<span class='macro'>FALSE<span class='macro_popup'>0</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, 0) == <span class='macro'>FAIL<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3293"><td class="num" id="LN3293">3293</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>FAIL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3294"><td class="num" id="LN3294">3294</td><td class="line">    <span class='keyword'>return</span> ml_append_flush(curbuf, lnum, line, len, flags);</td></tr>
<tr class="codeline" data-linenumber="3295"><td class="num" id="LN3295">3295</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3296"><td class="num" id="LN3296">3296</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3297"><td class="num" id="LN3297">3297</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3298"><td class="num" id="LN3298">3298</td><td class="line"><span class='directive'>#if defined(FEAT_SPELL) || defined(FEAT_QUICKFIX) || defined(PROTO)</span></td></tr>
<tr class="codeline" data-linenumber="3299"><td class="num" id="LN3299">3299</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3300"><td class="num" id="LN3300">3300</td><td class="line"> <span class='comment'>* Like ml_append() but for an arbitrary buffer.  The buffer must already have</span></td></tr>
<tr class="codeline" data-linenumber="3301"><td class="num" id="LN3301">3301</td><td class="line"> <span class='comment'>* a memline.</span></td></tr>
<tr class="codeline" data-linenumber="3302"><td class="num" id="LN3302">3302</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3303"><td class="num" id="LN3303">3303</td><td class="line">    <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="3304"><td class="num" id="LN3304">3304</td><td class="line">ml_append_buf(</td></tr>
<tr class="codeline" data-linenumber="3305"><td class="num" id="LN3305">3305</td><td class="line">    buf_T	*buf,</td></tr>
<tr class="codeline" data-linenumber="3306"><td class="num" id="LN3306">3306</td><td class="line">    linenr_T	lnum,		<span class='comment'>// append after this line (can be 0)</span></td></tr>
<tr class="codeline" data-linenumber="3307"><td class="num" id="LN3307">3307</td><td class="line">    char_u	*line,		<span class='comment'>// text of the new line</span></td></tr>
<tr class="codeline" data-linenumber="3308"><td class="num" id="LN3308">3308</td><td class="line">    colnr_T	len,		<span class='comment'>// length of new line, including NUL, or 0</span></td></tr>
<tr class="codeline" data-linenumber="3309"><td class="num" id="LN3309">3309</td><td class="line">    <span class='keyword'>int</span>		newfile)	<span class='comment'>// flag, see above</span></td></tr>
<tr class="codeline" data-linenumber="3310"><td class="num" id="LN3310">3310</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3311"><td class="num" id="LN3311">3311</td><td class="line">    <span class='keyword'>if</span> (buf-&gt;b_ml.ml_mfp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3312"><td class="num" id="LN3312">3312</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>FAIL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3313"><td class="num" id="LN3313">3313</td><td class="line">    <span class='keyword'>return</span> ml_append_flush(buf, lnum, line, len, newfile ? <span class='macro'>ML_APPEND_NEW<span class='macro_popup'>1</span></span> : 0);</td></tr>
<tr class="codeline" data-linenumber="3314"><td class="num" id="LN3314">3314</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3315"><td class="num" id="LN3315">3315</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3316"><td class="num" id="LN3316">3316</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3317"><td class="num" id="LN3317">3317</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3318"><td class="num" id="LN3318">3318</td><td class="line"> <span class='comment'>* Replace line "lnum", with buffering, in current buffer.</span></td></tr>
<tr class="codeline" data-linenumber="3319"><td class="num" id="LN3319">3319</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3320"><td class="num" id="LN3320">3320</td><td class="line"> <span class='comment'>* If "copy" is TRUE, make a copy of the line, otherwise the line has been</span></td></tr>
<tr class="codeline" data-linenumber="3321"><td class="num" id="LN3321">3321</td><td class="line"> <span class='comment'>* copied to allocated memory already.</span></td></tr>
<tr class="codeline" data-linenumber="3322"><td class="num" id="LN3322">3322</td><td class="line"> <span class='comment'>* If "copy" is FALSE the "line" may be freed to add text properties!</span></td></tr>
<tr class="codeline" data-linenumber="3323"><td class="num" id="LN3323">3323</td><td class="line"> <span class='comment'>* Do not use it after calling ml_replace().</span></td></tr>
<tr class="codeline" data-linenumber="3324"><td class="num" id="LN3324">3324</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3325"><td class="num" id="LN3325">3325</td><td class="line"> <span class='comment'>* Check: The caller of this function should probably also call</span></td></tr>
<tr class="codeline" data-linenumber="3326"><td class="num" id="LN3326">3326</td><td class="line"> <span class='comment'>* changed_lines(), unless update_screen(NOT_VALID) is used.</span></td></tr>
<tr class="codeline" data-linenumber="3327"><td class="num" id="LN3327">3327</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3328"><td class="num" id="LN3328">3328</td><td class="line"> <span class='comment'>* return FAIL for failure, OK otherwise</span></td></tr>
<tr class="codeline" data-linenumber="3329"><td class="num" id="LN3329">3329</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3330"><td class="num" id="LN3330">3330</td><td class="line">    <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="3331"><td class="num" id="LN3331">3331</td><td class="line">ml_replace(linenr_T lnum, char_u *line, <span class='keyword'>int</span> copy)</td></tr>
<tr class="codeline" data-linenumber="3332"><td class="num" id="LN3332">3332</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3333"><td class="num" id="LN3333">3333</td><td class="line">    colnr_T len = -1;</td></tr>
<tr class="codeline" data-linenumber="3334"><td class="num" id="LN3334">3334</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3335"><td class="num" id="LN3335">3335</td><td class="line">    <span class='keyword'>if</span> (line != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3336"><td class="num" id="LN3336">3336</td><td class="line">	len = (colnr_T)<span class='macro'>STRLEN(line)<span class='macro_popup'>strlen((char *)(line))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3337"><td class="num" id="LN3337">3337</td><td class="line">    <span class='keyword'>return</span> ml_replace_len(lnum, line, len, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>, copy);</td></tr>
<tr class="codeline" data-linenumber="3338"><td class="num" id="LN3338">3338</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3339"><td class="num" id="LN3339">3339</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3340"><td class="num" id="LN3340">3340</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3341"><td class="num" id="LN3341">3341</td><td class="line"> <span class='comment'>* Replace a line for the current buffer.  Like ml_replace() with:</span></td></tr>
<tr class="codeline" data-linenumber="3342"><td class="num" id="LN3342">3342</td><td class="line"> <span class='comment'>* "len_arg" is the length of the text, excluding NUL.</span></td></tr>
<tr class="codeline" data-linenumber="3343"><td class="num" id="LN3343">3343</td><td class="line"> <span class='comment'>* If "has_props" is TRUE then "line_arg" includes the text properties and</span></td></tr>
<tr class="codeline" data-linenumber="3344"><td class="num" id="LN3344">3344</td><td class="line"> <span class='comment'>* "len_arg" includes the NUL of the text.</span></td></tr>
<tr class="codeline" data-linenumber="3345"><td class="num" id="LN3345">3345</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3346"><td class="num" id="LN3346">3346</td><td class="line">    <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="3347"><td class="num" id="LN3347">3347</td><td class="line">ml_replace_len(</td></tr>
<tr class="codeline" data-linenumber="3348"><td class="num" id="LN3348">3348</td><td class="line">	linenr_T    lnum,</td></tr>
<tr class="codeline" data-linenumber="3349"><td class="num" id="LN3349">3349</td><td class="line">	char_u	    *line_arg,</td></tr>
<tr class="codeline" data-linenumber="3350"><td class="num" id="LN3350">3350</td><td class="line">	colnr_T	    len_arg,</td></tr>
<tr class="codeline" data-linenumber="3351"><td class="num" id="LN3351">3351</td><td class="line">	<span class='keyword'>int</span>	    has_props,</td></tr>
<tr class="codeline" data-linenumber="3352"><td class="num" id="LN3352">3352</td><td class="line">	<span class='keyword'>int</span>	    copy)</td></tr>
<tr class="codeline" data-linenumber="3353"><td class="num" id="LN3353">3353</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3354"><td class="num" id="LN3354">3354</td><td class="line">    char_u *line = line_arg;</td></tr>
<tr class="codeline" data-linenumber="3355"><td class="num" id="LN3355">3355</td><td class="line">    colnr_T len = len_arg;</td></tr>
<tr class="codeline" data-linenumber="3356"><td class="num" id="LN3356">3356</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3357"><td class="num" id="LN3357">3357</td><td class="line">    <span class='keyword'>if</span> (line == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)		<span class='comment'>// just checking...</span></td></tr>
<tr class="codeline" data-linenumber="3358"><td class="num" id="LN3358">3358</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>FAIL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3359"><td class="num" id="LN3359">3359</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3360"><td class="num" id="LN3360">3360</td><td class="line">    <span class='comment'>// When starting up, we might still need to create the memfile</span></td></tr>
<tr class="codeline" data-linenumber="3361"><td class="num" id="LN3361">3361</td><td class="line">    <span class='keyword'>if</span> (curbuf-&gt;b_ml.ml_mfp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; open_buffer(<span class='macro'>FALSE<span class='macro_popup'>0</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, 0) == <span class='macro'>FAIL<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3362"><td class="num" id="LN3362">3362</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>FAIL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3363"><td class="num" id="LN3363">3363</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3364"><td class="num" id="LN3364">3364</td><td class="line">    <span class='keyword'>if</span> (!has_props)</td></tr>
<tr class="codeline" data-linenumber="3365"><td class="num" id="LN3365">3365</td><td class="line">	++len;  <span class='comment'>// include the NUL after the text</span></td></tr>
<tr class="codeline" data-linenumber="3366"><td class="num" id="LN3366">3366</td><td class="line">    <span class='keyword'>if</span> (copy)</td></tr>
<tr class="codeline" data-linenumber="3367"><td class="num" id="LN3367">3367</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3368"><td class="num" id="LN3368">3368</td><td class="line">	<span class='comment'>// copy the line to allocated memory</span></td></tr>
<tr class="codeline" data-linenumber="3369"><td class="num" id="LN3369">3369</td><td class="line"><span class='directive'>#ifdef FEAT_PROP_POPUP</span></td></tr>
<tr class="codeline" data-linenumber="3370"><td class="num" id="LN3370">3370</td><td class="line">	<span class='keyword'>if</span> (has_props)</td></tr>
<tr class="codeline" data-linenumber="3371"><td class="num" id="LN3371">3371</td><td class="line">	    line = vim_memsave(line, len);</td></tr>
<tr class="codeline" data-linenumber="3372"><td class="num" id="LN3372">3372</td><td class="line">	<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3373"><td class="num" id="LN3373">3373</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3374"><td class="num" id="LN3374">3374</td><td class="line">	    line = vim_strnsave(line, len - 1);</td></tr>
<tr class="codeline" data-linenumber="3375"><td class="num" id="LN3375">3375</td><td class="line">	<span class='keyword'>if</span> (line == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3376"><td class="num" id="LN3376">3376</td><td class="line">	    <span class='keyword'>return</span> <span class='macro'>FAIL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3377"><td class="num" id="LN3377">3377</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3378"><td class="num" id="LN3378">3378</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3379"><td class="num" id="LN3379">3379</td><td class="line"><span class='directive'>#ifdef <span class='macro'>FEAT_NETBEANS_INTG<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="3380"><td class="num" id="LN3380">3380</td><td class="line">    <span class='keyword'>if</span> (netbeans_active())</td></tr>
<tr class="codeline" data-linenumber="3381"><td class="num" id="LN3381">3381</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3382"><td class="num" id="LN3382">3382</td><td class="line">	netbeans_removed(curbuf, lnum, 0, (<span class='keyword'>long</span>)<span class='macro'>STRLEN(ml_get(lnum))<span class='macro_popup'>strlen((char *)(ml_get(lnum)))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3383"><td class="num" id="LN3383">3383</td><td class="line">	netbeans_inserted(curbuf, lnum, 0, line, (<span class='keyword'>int</span>)<span class='macro'>STRLEN(line)<span class='macro_popup'>strlen((char *)(line))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3384"><td class="num" id="LN3384">3384</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3385"><td class="num" id="LN3385">3385</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3386"><td class="num" id="LN3386">3386</td><td class="line">    <span class='keyword'>if</span> (curbuf-&gt;b_ml.ml_line_lnum != lnum)</td></tr>
<tr class="codeline" data-linenumber="3387"><td class="num" id="LN3387">3387</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3388"><td class="num" id="LN3388">3388</td><td class="line">	<span class='comment'>// another line is buffered, flush it</span></td></tr>
<tr class="codeline" data-linenumber="3389"><td class="num" id="LN3389">3389</td><td class="line">	ml_flush_line(curbuf);</td></tr>
<tr class="codeline" data-linenumber="3390"><td class="num" id="LN3390">3390</td><td class="line">	curbuf-&gt;b_ml.ml_flags &amp;= ~<span class='macro'>ML_LINE_DIRTY<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3391"><td class="num" id="LN3391">3391</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3392"><td class="num" id="LN3392">3392</td><td class="line"><span class='directive'>#ifdef FEAT_PROP_POPUP</span></td></tr>
<tr class="codeline" data-linenumber="3393"><td class="num" id="LN3393">3393</td><td class="line">	<span class='keyword'>if</span> (curbuf-&gt;b_has_textprop &amp;&amp; !has_props)</td></tr>
<tr class="codeline" data-linenumber="3394"><td class="num" id="LN3394">3394</td><td class="line">	    <span class='comment'>// Need to fetch the old line to copy over any text properties.</span></td></tr>
<tr class="codeline" data-linenumber="3395"><td class="num" id="LN3395">3395</td><td class="line">	    ml_get_buf(curbuf, lnum, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3396"><td class="num" id="LN3396">3396</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3397"><td class="num" id="LN3397">3397</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3398"><td class="num" id="LN3398">3398</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3399"><td class="num" id="LN3399">3399</td><td class="line"><span class='directive'>#ifdef FEAT_PROP_POPUP</span></td></tr>
<tr class="codeline" data-linenumber="3400"><td class="num" id="LN3400">3400</td><td class="line">    <span class='keyword'>if</span> (curbuf-&gt;b_has_textprop &amp;&amp; !has_props)</td></tr>
<tr class="codeline" data-linenumber="3401"><td class="num" id="LN3401">3401</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3402"><td class="num" id="LN3402">3402</td><td class="line">	size_t	oldtextlen = <span class='macro'>STRLEN(curbuf-&gt;b_ml.ml_line_ptr)<span class='macro_popup'>strlen((char *)(curbuf-&gt;b_ml.ml_line_ptr))</span></span> + 1;</td></tr>
<tr class="codeline" data-linenumber="3403"><td class="num" id="LN3403">3403</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3404"><td class="num" id="LN3404">3404</td><td class="line">	<span class='keyword'>if</span> (oldtextlen &lt; (size_t)curbuf-&gt;b_ml.ml_line_len)</td></tr>
<tr class="codeline" data-linenumber="3405"><td class="num" id="LN3405">3405</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="3406"><td class="num" id="LN3406">3406</td><td class="line">	    char_u *newline;</td></tr>
<tr class="codeline" data-linenumber="3407"><td class="num" id="LN3407">3407</td><td class="line">	    size_t textproplen = curbuf-&gt;b_ml.ml_line_len - oldtextlen;</td></tr>
<tr class="codeline" data-linenumber="3408"><td class="num" id="LN3408">3408</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3409"><td class="num" id="LN3409">3409</td><td class="line">	    <span class='comment'>// Need to copy over text properties, stored after the text.</span></td></tr>
<tr class="codeline" data-linenumber="3410"><td class="num" id="LN3410">3410</td><td class="line">	    newline = alloc(len + (<span class='keyword'>int</span>)textproplen);</td></tr>
<tr class="codeline" data-linenumber="3411"><td class="num" id="LN3411">3411</td><td class="line">	    <span class='keyword'>if</span> (newline != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3412"><td class="num" id="LN3412">3412</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="3413"><td class="num" id="LN3413">3413</td><td class="line">		<span class='macro'>mch_memmove(newline, line, len)<span class='macro_popup'>memmove((char *)(newline), (char *)(line), len)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3414"><td class="num" id="LN3414">3414</td><td class="line">		<span class='macro'>mch_memmove(newline + len, curbuf-&gt;b_ml.ml_line_ptr<span class='macro_popup'>memmove((char *)(newline + len), (char *)(curbuf-&gt;b_ml.ml_line_ptr<br> + oldtextlen), textproplen)</span></span></td></tr>
<tr class="codeline" data-linenumber="3415"><td class="num" id="LN3415">3415</td><td class="line">						    <span class='macro'>+ oldtextlen, textproplen)<span class='macro_popup'>memmove((char *)(newline + len), (char *)(curbuf-&gt;b_ml.ml_line_ptr<br> + oldtextlen), textproplen)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3416"><td class="num" id="LN3416">3416</td><td class="line">		vim_free(line);</td></tr>
<tr class="codeline" data-linenumber="3417"><td class="num" id="LN3417">3417</td><td class="line">		line = newline;</td></tr>
<tr class="codeline" data-linenumber="3418"><td class="num" id="LN3418">3418</td><td class="line">		len += (colnr_T)textproplen;</td></tr>
<tr class="codeline" data-linenumber="3419"><td class="num" id="LN3419">3419</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="3420"><td class="num" id="LN3420">3420</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="3421"><td class="num" id="LN3421">3421</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3422"><td class="num" id="LN3422">3422</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3423"><td class="num" id="LN3423">3423</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3424"><td class="num" id="LN3424">3424</td><td class="line">    <span class='keyword'>if</span> (curbuf-&gt;b_ml.ml_flags &amp; <span class='macro'>ML_LINE_DIRTY<span class='macro_popup'>2</span></span>)	<span class='comment'>// same line allocated</span></td></tr>
<tr class="codeline" data-linenumber="3425"><td class="num" id="LN3425">3425</td><td class="line">	vim_free(curbuf-&gt;b_ml.ml_line_ptr);	<span class='comment'>// free it</span></td></tr>
<tr class="codeline" data-linenumber="3426"><td class="num" id="LN3426">3426</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3427"><td class="num" id="LN3427">3427</td><td class="line">    curbuf-&gt;b_ml.ml_line_ptr = line;</td></tr>
<tr class="codeline" data-linenumber="3428"><td class="num" id="LN3428">3428</td><td class="line">    curbuf-&gt;b_ml.ml_line_len = len;</td></tr>
<tr class="codeline" data-linenumber="3429"><td class="num" id="LN3429">3429</td><td class="line">    curbuf-&gt;b_ml.ml_line_lnum = lnum;</td></tr>
<tr class="codeline" data-linenumber="3430"><td class="num" id="LN3430">3430</td><td class="line">    curbuf-&gt;b_ml.ml_flags = (curbuf-&gt;b_ml.ml_flags | <span class='macro'>ML_LINE_DIRTY<span class='macro_popup'>2</span></span>) &amp; ~<span class='macro'>ML_EMPTY<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3431"><td class="num" id="LN3431">3431</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3432"><td class="num" id="LN3432">3432</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>OK<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3433"><td class="num" id="LN3433">3433</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3434"><td class="num" id="LN3434">3434</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3435"><td class="num" id="LN3435">3435</td><td class="line"><span class='directive'>#ifdef FEAT_PROP_POPUP</span></td></tr>
<tr class="codeline" data-linenumber="3436"><td class="num" id="LN3436">3436</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3437"><td class="num" id="LN3437">3437</td><td class="line"> <span class='comment'>* Adjust text properties in line "lnum" for a deleted line.</span></td></tr>
<tr class="codeline" data-linenumber="3438"><td class="num" id="LN3438">3438</td><td class="line"> <span class='comment'>* When "above" is true this is the line above the deleted line.</span></td></tr>
<tr class="codeline" data-linenumber="3439"><td class="num" id="LN3439">3439</td><td class="line"> <span class='comment'>* "del_props" are the properties of the deleted line.</span></td></tr>
<tr class="codeline" data-linenumber="3440"><td class="num" id="LN3440">3440</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3441"><td class="num" id="LN3441">3441</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="3442"><td class="num" id="LN3442">3442</td><td class="line">adjust_text_props_for_delete(</td></tr>
<tr class="codeline" data-linenumber="3443"><td class="num" id="LN3443">3443</td><td class="line">	buf_T	    *buf,</td></tr>
<tr class="codeline" data-linenumber="3444"><td class="num" id="LN3444">3444</td><td class="line">	linenr_T    lnum,</td></tr>
<tr class="codeline" data-linenumber="3445"><td class="num" id="LN3445">3445</td><td class="line">	char_u	    *del_props,</td></tr>
<tr class="codeline" data-linenumber="3446"><td class="num" id="LN3446">3446</td><td class="line">	<span class='keyword'>int</span>	    del_props_len,</td></tr>
<tr class="codeline" data-linenumber="3447"><td class="num" id="LN3447">3447</td><td class="line">	<span class='keyword'>int</span>	    above)</td></tr>
<tr class="codeline" data-linenumber="3448"><td class="num" id="LN3448">3448</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3449"><td class="num" id="LN3449">3449</td><td class="line">    <span class='keyword'>int</span>		did_get_line = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3450"><td class="num" id="LN3450">3450</td><td class="line">    <span class='keyword'>int</span>		done_del;</td></tr>
<tr class="codeline" data-linenumber="3451"><td class="num" id="LN3451">3451</td><td class="line">    <span class='keyword'>int</span>		done_this;</td></tr>
<tr class="codeline" data-linenumber="3452"><td class="num" id="LN3452">3452</td><td class="line">    textprop_T	prop_del;</td></tr>
<tr class="codeline" data-linenumber="3453"><td class="num" id="LN3453">3453</td><td class="line">    bhdr_T	*hp;</td></tr>
<tr class="codeline" data-linenumber="3454"><td class="num" id="LN3454">3454</td><td class="line">    DATA_BL	*dp;</td></tr>
<tr class="codeline" data-linenumber="3455"><td class="num" id="LN3455">3455</td><td class="line">    <span class='keyword'>int</span>		idx;</td></tr>
<tr class="codeline" data-linenumber="3456"><td class="num" id="LN3456">3456</td><td class="line">    <span class='keyword'>int</span>		line_start;</td></tr>
<tr class="codeline" data-linenumber="3457"><td class="num" id="LN3457">3457</td><td class="line">    <span class='keyword'>long</span>	line_size;</td></tr>
<tr class="codeline" data-linenumber="3458"><td class="num" id="LN3458">3458</td><td class="line">    <span class='keyword'>int</span>		this_props_len;</td></tr>
<tr class="codeline" data-linenumber="3459"><td class="num" id="LN3459">3459</td><td class="line">    char_u	*text;</td></tr>
<tr class="codeline" data-linenumber="3460"><td class="num" id="LN3460">3460</td><td class="line">    size_t	textlen;</td></tr>
<tr class="codeline" data-linenumber="3461"><td class="num" id="LN3461">3461</td><td class="line">    <span class='keyword'>int</span>		found;</td></tr>
<tr class="codeline" data-linenumber="3462"><td class="num" id="LN3462">3462</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3463"><td class="num" id="LN3463">3463</td><td class="line">    <span class='keyword'>for</span> (done_del = 0; done_del &lt; del_props_len; done_del += <span class='keyword'>sizeof</span>(textprop_T))</td></tr>
<tr class="codeline" data-linenumber="3464"><td class="num" id="LN3464">3464</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3465"><td class="num" id="LN3465">3465</td><td class="line">	<span class='macro'>mch_memmove(&amp;prop_del, del_props + done_del, <span class='keyword'>sizeof</span>(textprop_T))<span class='macro_popup'>memmove((char *)(&amp;prop_del), (char *)(del_props + done_del<br>), sizeof(textprop_T))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3466"><td class="num" id="LN3466">3466</td><td class="line">	<span class='keyword'>if</span> ((above &amp;&amp; (prop_del.tp_flags &amp; <span class='macro'>TP_FLAG_CONT_PREV<span class='macro_popup'>2</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3467"><td class="num" id="LN3467">3467</td><td class="line">		    &amp;&amp; !(prop_del.tp_flags &amp; <span class='macro'>TP_FLAG_CONT_NEXT<span class='macro_popup'>1</span></span>))</td></tr>
<tr class="codeline" data-linenumber="3468"><td class="num" id="LN3468">3468</td><td class="line">		|| (!above &amp;&amp; (prop_del.tp_flags &amp; <span class='macro'>TP_FLAG_CONT_NEXT<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3469"><td class="num" id="LN3469">3469</td><td class="line">		    &amp;&amp; !(prop_del.tp_flags &amp; <span class='macro'>TP_FLAG_CONT_PREV<span class='macro_popup'>2</span></span>)))</td></tr>
<tr class="codeline" data-linenumber="3470"><td class="num" id="LN3470">3470</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="3471"><td class="num" id="LN3471">3471</td><td class="line">	    <span class='keyword'>if</span> (!did_get_line)</td></tr>
<tr class="codeline" data-linenumber="3472"><td class="num" id="LN3472">3472</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="3473"><td class="num" id="LN3473">3473</td><td class="line">		did_get_line = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3474"><td class="num" id="LN3474">3474</td><td class="line">		<span class='keyword'>if</span> ((hp = ml_find_line(buf, lnum, <span class='macro'>ML_FIND<span class='macro_popup'>0x13</span></span>)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3475"><td class="num" id="LN3475">3475</td><td class="line">		    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="3476"><td class="num" id="LN3476">3476</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3477"><td class="num" id="LN3477">3477</td><td class="line">		dp = (DATA_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="3478"><td class="num" id="LN3478">3478</td><td class="line">		idx = lnum - buf-&gt;b_ml.ml_locked_low;</td></tr>
<tr class="codeline" data-linenumber="3479"><td class="num" id="LN3479">3479</td><td class="line">		line_start = ((dp-&gt;db_index[idx]) &amp; <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3480"><td class="num" id="LN3480">3480</td><td class="line">		<span class='keyword'>if</span> (idx == 0)		<span class='comment'>// first line in block, text at the end</span></td></tr>
<tr class="codeline" data-linenumber="3481"><td class="num" id="LN3481">3481</td><td class="line">		    line_size = dp-&gt;db_txt_end - line_start;</td></tr>
<tr class="codeline" data-linenumber="3482"><td class="num" id="LN3482">3482</td><td class="line">		<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3483"><td class="num" id="LN3483">3483</td><td class="line">		    line_size = ((dp-&gt;db_index[idx - 1]) &amp; <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3484"><td class="num" id="LN3484">3484</td><td class="line">								  - line_start;</td></tr>
<tr class="codeline" data-linenumber="3485"><td class="num" id="LN3485">3485</td><td class="line">		text = (char_u *)dp + line_start;</td></tr>
<tr class="codeline" data-linenumber="3486"><td class="num" id="LN3486">3486</td><td class="line">		textlen = <span class='macro'>STRLEN(text)<span class='macro_popup'>strlen((char *)(text))</span></span> + 1;</td></tr>
<tr class="codeline" data-linenumber="3487"><td class="num" id="LN3487">3487</td><td class="line">		<span class='keyword'>if</span> ((<span class='keyword'>long</span>)textlen &gt;= line_size)</td></tr>
<tr class="codeline" data-linenumber="3488"><td class="num" id="LN3488">3488</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="3489"><td class="num" id="LN3489">3489</td><td class="line">		    <span class='keyword'>if</span> (above)</td></tr>
<tr class="codeline" data-linenumber="3490"><td class="num" id="LN3490">3490</td><td class="line">			internal_error(<span class='string_literal'>"no text property above deleted line"</span>);</td></tr>
<tr class="codeline" data-linenumber="3491"><td class="num" id="LN3491">3491</td><td class="line">		    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3492"><td class="num" id="LN3492">3492</td><td class="line">			internal_error(<span class='string_literal'>"no text property below deleted line"</span>);</td></tr>
<tr class="codeline" data-linenumber="3493"><td class="num" id="LN3493">3493</td><td class="line">		    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="3494"><td class="num" id="LN3494">3494</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="3495"><td class="num" id="LN3495">3495</td><td class="line">		this_props_len = line_size - (<span class='keyword'>int</span>)textlen;</td></tr>
<tr class="codeline" data-linenumber="3496"><td class="num" id="LN3496">3496</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="3497"><td class="num" id="LN3497">3497</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3498"><td class="num" id="LN3498">3498</td><td class="line">	    found = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3499"><td class="num" id="LN3499">3499</td><td class="line">	    <span class='keyword'>for</span> (done_this = 0; done_this &lt; this_props_len;</td></tr>
<tr class="codeline" data-linenumber="3500"><td class="num" id="LN3500">3500</td><td class="line">					       done_this += <span class='keyword'>sizeof</span>(textprop_T))</td></tr>
<tr class="codeline" data-linenumber="3501"><td class="num" id="LN3501">3501</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="3502"><td class="num" id="LN3502">3502</td><td class="line">		<span class='keyword'>int</span>	    flag = above ? <span class='macro'>TP_FLAG_CONT_NEXT<span class='macro_popup'>1</span></span></td></tr>
<tr class="codeline" data-linenumber="3503"><td class="num" id="LN3503">3503</td><td class="line">							   : <span class='macro'>TP_FLAG_CONT_PREV<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3504"><td class="num" id="LN3504">3504</td><td class="line">		textprop_T  prop_this;</td></tr>
<tr class="codeline" data-linenumber="3505"><td class="num" id="LN3505">3505</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3506"><td class="num" id="LN3506">3506</td><td class="line">		<span class='macro'>mch_memmove(&amp;prop_this, text + textlen + done_del,<span class='macro_popup'>memmove((char *)(&amp;prop_this), (char *)(text + textlen + done_del<br>), sizeof(textprop_T))</span></span></td></tr>
<tr class="codeline" data-linenumber="3507"><td class="num" id="LN3507">3507</td><td class="line">							   <span class='keyword'><span class='macro'>sizeof</span>(textprop_T))<span class='macro_popup'>memmove((char *)(&amp;prop_this), (char *)(text + textlen + done_del<br>), sizeof(textprop_T))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3508"><td class="num" id="LN3508">3508</td><td class="line">		<span class='keyword'>if</span> ((prop_this.tp_flags &amp; flag)</td></tr>
<tr class="codeline" data-linenumber="3509"><td class="num" id="LN3509">3509</td><td class="line">			&amp;&amp; prop_del.tp_id == prop_this.tp_id</td></tr>
<tr class="codeline" data-linenumber="3510"><td class="num" id="LN3510">3510</td><td class="line">			&amp;&amp; prop_del.tp_type == prop_this.tp_type)</td></tr>
<tr class="codeline" data-linenumber="3511"><td class="num" id="LN3511">3511</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="3512"><td class="num" id="LN3512">3512</td><td class="line">		    found = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3513"><td class="num" id="LN3513">3513</td><td class="line">		    prop_this.tp_flags &amp;= ~flag;</td></tr>
<tr class="codeline" data-linenumber="3514"><td class="num" id="LN3514">3514</td><td class="line">		    <span class='macro'>mch_memmove(text + textlen + done_del, &amp;prop_this,<span class='macro_popup'>memmove((char *)(text + textlen + done_del), (char *)(&amp;prop_this<br>), sizeof(textprop_T))</span></span></td></tr>
<tr class="codeline" data-linenumber="3515"><td class="num" id="LN3515">3515</td><td class="line">							   <span class='keyword'><span class='macro'>sizeof</span>(textprop_T))<span class='macro_popup'>memmove((char *)(text + textlen + done_del), (char *)(&amp;prop_this<br>), sizeof(textprop_T))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3516"><td class="num" id="LN3516">3516</td><td class="line">		    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3517"><td class="num" id="LN3517">3517</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="3518"><td class="num" id="LN3518">3518</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="3519"><td class="num" id="LN3519">3519</td><td class="line">	    <span class='keyword'>if</span> (!found)</td></tr>
<tr class="codeline" data-linenumber="3520"><td class="num" id="LN3520">3520</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="3521"><td class="num" id="LN3521">3521</td><td class="line">		<span class='keyword'>if</span> (above)</td></tr>
<tr class="codeline" data-linenumber="3522"><td class="num" id="LN3522">3522</td><td class="line">		    internal_error(<span class='string_literal'>"text property above deleted line not found"</span>);</td></tr>
<tr class="codeline" data-linenumber="3523"><td class="num" id="LN3523">3523</td><td class="line">		<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3524"><td class="num" id="LN3524">3524</td><td class="line">		    internal_error(<span class='string_literal'>"text property below deleted line not found"</span>);</td></tr>
<tr class="codeline" data-linenumber="3525"><td class="num" id="LN3525">3525</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="3526"><td class="num" id="LN3526">3526</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3527"><td class="num" id="LN3527">3527</td><td class="line">	    buf-&gt;b_ml.ml_flags |= (<span class='macro'>ML_LOCKED_DIRTY<span class='macro_popup'>4</span></span> | <span class='macro'>ML_LOCKED_POS<span class='macro_popup'>8</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3528"><td class="num" id="LN3528">3528</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="3529"><td class="num" id="LN3529">3529</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3530"><td class="num" id="LN3530">3530</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3531"><td class="num" id="LN3531">3531</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3532"><td class="num" id="LN3532">3532</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3533"><td class="num" id="LN3533">3533</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3534"><td class="num" id="LN3534">3534</td><td class="line"> <span class='comment'>* Delete line "lnum" in the current buffer.</span></td></tr>
<tr class="codeline" data-linenumber="3535"><td class="num" id="LN3535">3535</td><td class="line"> <span class='comment'>* When "flags" has ML_DEL_MESSAGE may give a "No lines in buffer" message.</span></td></tr>
<tr class="codeline" data-linenumber="3536"><td class="num" id="LN3536">3536</td><td class="line"> <span class='comment'>* When "flags" has ML_DEL_UNDO this is called from undo.</span></td></tr>
<tr class="codeline" data-linenumber="3537"><td class="num" id="LN3537">3537</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3538"><td class="num" id="LN3538">3538</td><td class="line"> <span class='comment'>* return FAIL for failure, OK otherwise</span></td></tr>
<tr class="codeline" data-linenumber="3539"><td class="num" id="LN3539">3539</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3540"><td class="num" id="LN3540">3540</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="3541"><td class="num" id="LN3541">3541</td><td class="line">ml_delete_int(buf_T *buf, linenr_T lnum, <span class='keyword'>int</span> flags)</td></tr>
<tr class="codeline" data-linenumber="3542"><td class="num" id="LN3542">3542</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3543"><td class="num" id="LN3543">3543</td><td class="line">    bhdr_T	*hp;</td></tr>
<tr class="codeline" data-linenumber="3544"><td class="num" id="LN3544">3544</td><td class="line">    memfile_T	*mfp;</td></tr>
<tr class="codeline" data-linenumber="3545"><td class="num" id="LN3545">3545</td><td class="line">    DATA_BL	*dp;</td></tr>
<tr class="codeline" data-linenumber="3546"><td class="num" id="LN3546">3546</td><td class="line">    PTR_BL	*pp;</td></tr>
<tr class="codeline" data-linenumber="3547"><td class="num" id="LN3547">3547</td><td class="line">    infoptr_T	*ip;</td></tr>
<tr class="codeline" data-linenumber="3548"><td class="num" id="LN3548">3548</td><td class="line">    <span class='keyword'>int</span>		count;	    <span class='comment'>// number of entries in block</span></td></tr>
<tr class="codeline" data-linenumber="3549"><td class="num" id="LN3549">3549</td><td class="line">    <span class='keyword'>int</span>		idx;</td></tr>
<tr class="codeline" data-linenumber="3550"><td class="num" id="LN3550">3550</td><td class="line">    <span class='keyword'>int</span>		stack_idx;</td></tr>
<tr class="codeline" data-linenumber="3551"><td class="num" id="LN3551">3551</td><td class="line">    <span class='keyword'>int</span>		text_start;</td></tr>
<tr class="codeline" data-linenumber="3552"><td class="num" id="LN3552">3552</td><td class="line">    <span class='keyword'>int</span>		line_start;</td></tr>
<tr class="codeline" data-linenumber="3553"><td class="num" id="LN3553">3553</td><td class="line">    <span class='keyword'>long</span>	line_size;</td></tr>
<tr class="codeline" data-linenumber="3554"><td class="num" id="LN3554">3554</td><td class="line">    <span class='keyword'>int</span>		i;</td></tr>
<tr class="codeline" data-linenumber="3555"><td class="num" id="LN3555">3555</td><td class="line">    <span class='keyword'>int</span>		ret = <span class='macro'>FAIL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3556"><td class="num" id="LN3556">3556</td><td class="line"><span class='directive'>#ifdef FEAT_PROP_POPUP</span></td></tr>
<tr class="codeline" data-linenumber="3557"><td class="num" id="LN3557">3557</td><td class="line">    char_u	*textprop_save = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3558"><td class="num" id="LN3558">3558</td><td class="line">    <span class='keyword'>int</span>		textprop_save_len;</td></tr>
<tr class="codeline" data-linenumber="3559"><td class="num" id="LN3559">3559</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3560"><td class="num" id="LN3560">3560</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3561"><td class="num" id="LN3561">3561</td><td class="line">    <span class='keyword'>if</span> (lowest_marked &amp;&amp; lowest_marked &gt; lnum)</td></tr>
<tr class="codeline" data-linenumber="3562"><td class="num" id="LN3562">3562</td><td class="line">	lowest_marked--;</td></tr>
<tr class="codeline" data-linenumber="3563"><td class="num" id="LN3563">3563</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3564"><td class="num" id="LN3564">3564</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3565"><td class="num" id="LN3565">3565</td><td class="line"> <span class='comment'>* If the file becomes empty the last line is replaced by an empty line.</span></td></tr>
<tr class="codeline" data-linenumber="3566"><td class="num" id="LN3566">3566</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3567"><td class="num" id="LN3567">3567</td><td class="line">    <span class='keyword'>if</span> (buf-&gt;b_ml.ml_line_count == 1)	    <span class='comment'>// file becomes empty</span></td></tr>
<tr class="codeline" data-linenumber="3568"><td class="num" id="LN3568">3568</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3569"><td class="num" id="LN3569">3569</td><td class="line">	<span class='keyword'>if</span> ((flags &amp; <span class='macro'>ML_DEL_MESSAGE<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3570"><td class="num" id="LN3570">3570</td><td class="line"><span class='directive'>#ifdef <span class='macro'>FEAT_NETBEANS_INTG<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="3571"><td class="num" id="LN3571">3571</td><td class="line">		&amp;&amp; !netbeansSuppressNoLines</td></tr>
<tr class="codeline" data-linenumber="3572"><td class="num" id="LN3572">3572</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3573"><td class="num" id="LN3573">3573</td><td class="line">	   )</td></tr>
<tr class="codeline" data-linenumber="3574"><td class="num" id="LN3574">3574</td><td class="line">	    set_keep_msg((char_u *)<span class='macro'>_(no_lines_msg)<span class='macro_popup'>dcgettext (((void*)0), (char *)(no_lines_msg), 5)</span></span>, 0);</td></tr>
<tr class="codeline" data-linenumber="3575"><td class="num" id="LN3575">3575</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3576"><td class="num" id="LN3576">3576</td><td class="line">	<span class='comment'>// FEAT_BYTEOFF already handled in there, don't worry 'bout it below</span></td></tr>
<tr class="codeline" data-linenumber="3577"><td class="num" id="LN3577">3577</td><td class="line">	i = ml_replace((linenr_T)1, (char_u *)<span class='string_literal'>""</span>, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3578"><td class="num" id="LN3578">3578</td><td class="line">	buf-&gt;b_ml.ml_flags |= <span class='macro'>ML_EMPTY<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3579"><td class="num" id="LN3579">3579</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3580"><td class="num" id="LN3580">3580</td><td class="line">	<span class='keyword'>return</span> i;</td></tr>
<tr class="codeline" data-linenumber="3581"><td class="num" id="LN3581">3581</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3582"><td class="num" id="LN3582">3582</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3583"><td class="num" id="LN3583">3583</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3584"><td class="num" id="LN3584">3584</td><td class="line"> <span class='comment'>* Find the data block containing the line.</span></td></tr>
<tr class="codeline" data-linenumber="3585"><td class="num" id="LN3585">3585</td><td class="line"> <span class='comment'>* This also fills the stack with the blocks from the root to the data block.</span></td></tr>
<tr class="codeline" data-linenumber="3586"><td class="num" id="LN3586">3586</td><td class="line"> <span class='comment'>* This also releases any locked block..</span></td></tr>
<tr class="codeline" data-linenumber="3587"><td class="num" id="LN3587">3587</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3588"><td class="num" id="LN3588">3588</td><td class="line">    mfp = buf-&gt;b_ml.ml_mfp;</td></tr>
<tr class="codeline" data-linenumber="3589"><td class="num" id="LN3589">3589</td><td class="line">    <span class='keyword'>if</span> (mfp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3590"><td class="num" id="LN3590">3590</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>FAIL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3591"><td class="num" id="LN3591">3591</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3592"><td class="num" id="LN3592">3592</td><td class="line">    <span class='keyword'>if</span> ((hp = ml_find_line(buf, lnum, <span class='macro'>ML_DELETE<span class='macro_popup'>0x11</span></span>)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3593"><td class="num" id="LN3593">3593</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>FAIL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3594"><td class="num" id="LN3594">3594</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3595"><td class="num" id="LN3595">3595</td><td class="line">    dp = (DATA_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="3596"><td class="num" id="LN3596">3596</td><td class="line">    <span class='comment'>// compute line count before the delete</span></td></tr>
<tr class="codeline" data-linenumber="3597"><td class="num" id="LN3597">3597</td><td class="line">    count = (<span class='keyword'>long</span>)(buf-&gt;b_ml.ml_locked_high)</td></tr>
<tr class="codeline" data-linenumber="3598"><td class="num" id="LN3598">3598</td><td class="line">					- (<span class='keyword'>long</span>)(buf-&gt;b_ml.ml_locked_low) + 2;</td></tr>
<tr class="codeline" data-linenumber="3599"><td class="num" id="LN3599">3599</td><td class="line">    idx = lnum - buf-&gt;b_ml.ml_locked_low;</td></tr>
<tr class="codeline" data-linenumber="3600"><td class="num" id="LN3600">3600</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3601"><td class="num" id="LN3601">3601</td><td class="line">    --buf-&gt;b_ml.ml_line_count;</td></tr>
<tr class="codeline" data-linenumber="3602"><td class="num" id="LN3602">3602</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3603"><td class="num" id="LN3603">3603</td><td class="line">    line_start = ((dp-&gt;db_index[idx]) &amp; <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3604"><td class="num" id="LN3604">3604</td><td class="line">    <span class='keyword'>if</span> (idx == 0)		<span class='comment'>// first line in block, text at the end</span></td></tr>
<tr class="codeline" data-linenumber="3605"><td class="num" id="LN3605">3605</td><td class="line">	line_size = dp-&gt;db_txt_end - line_start;</td></tr>
<tr class="codeline" data-linenumber="3606"><td class="num" id="LN3606">3606</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3607"><td class="num" id="LN3607">3607</td><td class="line">	line_size = ((dp-&gt;db_index[idx - 1]) &amp; <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>) - line_start;</td></tr>
<tr class="codeline" data-linenumber="3608"><td class="num" id="LN3608">3608</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3609"><td class="num" id="LN3609">3609</td><td class="line"><span class='directive'>#ifdef <span class='macro'>FEAT_NETBEANS_INTG<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="3610"><td class="num" id="LN3610">3610</td><td class="line">    <span class='keyword'>if</span> (netbeans_active())</td></tr>
<tr class="codeline" data-linenumber="3611"><td class="num" id="LN3611">3611</td><td class="line">	netbeans_removed(buf, lnum, 0, (<span class='keyword'>long</span>)line_size);</td></tr>
<tr class="codeline" data-linenumber="3612"><td class="num" id="LN3612">3612</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3613"><td class="num" id="LN3613">3613</td><td class="line"><span class='directive'>#ifdef FEAT_PROP_POPUP</span></td></tr>
<tr class="codeline" data-linenumber="3614"><td class="num" id="LN3614">3614</td><td class="line">    <span class='comment'>// If there are text properties, make a copy, so that we can update</span></td></tr>
<tr class="codeline" data-linenumber="3615"><td class="num" id="LN3615">3615</td><td class="line">    <span class='comment'>// properties in preceding and following lines.</span></td></tr>
<tr class="codeline" data-linenumber="3616"><td class="num" id="LN3616">3616</td><td class="line">    <span class='keyword'>if</span> (buf-&gt;b_has_textprop &amp;&amp; !(flags &amp; <span class='macro'>ML_DEL_UNDO<span class='macro_popup'>2</span></span>))</td></tr>
<tr class="codeline" data-linenumber="3617"><td class="num" id="LN3617">3617</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3618"><td class="num" id="LN3618">3618</td><td class="line">	size_t	textlen = <span class='macro'>STRLEN((char_u *)dp + line_start)<span class='macro_popup'>strlen((char *)((char_u *)dp + line_start))</span></span> + 1;</td></tr>
<tr class="codeline" data-linenumber="3619"><td class="num" id="LN3619">3619</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3620"><td class="num" id="LN3620">3620</td><td class="line">	<span class='keyword'>if</span> ((<span class='keyword'>long</span>)textlen &lt; line_size)</td></tr>
<tr class="codeline" data-linenumber="3621"><td class="num" id="LN3621">3621</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="3622"><td class="num" id="LN3622">3622</td><td class="line">	    textprop_save_len = line_size - (<span class='keyword'>int</span>)textlen;</td></tr>
<tr class="codeline" data-linenumber="3623"><td class="num" id="LN3623">3623</td><td class="line">	    textprop_save = vim_memsave((char_u *)dp + line_start + textlen,</td></tr>
<tr class="codeline" data-linenumber="3624"><td class="num" id="LN3624">3624</td><td class="line">							  textprop_save_len);</td></tr>
<tr class="codeline" data-linenumber="3625"><td class="num" id="LN3625">3625</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="3626"><td class="num" id="LN3626">3626</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3627"><td class="num" id="LN3627">3627</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3628"><td class="num" id="LN3628">3628</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3629"><td class="num" id="LN3629">3629</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3630"><td class="num" id="LN3630">3630</td><td class="line"> <span class='comment'>* special case: If there is only one line in the data block it becomes empty.</span></td></tr>
<tr class="codeline" data-linenumber="3631"><td class="num" id="LN3631">3631</td><td class="line"> <span class='comment'>* Then we have to remove the entry, pointing to this data block, from the</span></td></tr>
<tr class="codeline" data-linenumber="3632"><td class="num" id="LN3632">3632</td><td class="line"> <span class='comment'>* pointer block. If this pointer block also becomes empty, we go up another</span></td></tr>
<tr class="codeline" data-linenumber="3633"><td class="num" id="LN3633">3633</td><td class="line"> <span class='comment'>* block, and so on, up to the root if necessary.</span></td></tr>
<tr class="codeline" data-linenumber="3634"><td class="num" id="LN3634">3634</td><td class="line"> <span class='comment'>* The line counts in the pointer blocks have already been adjusted by</span></td></tr>
<tr class="codeline" data-linenumber="3635"><td class="num" id="LN3635">3635</td><td class="line"> <span class='comment'>* ml_find_line().</span></td></tr>
<tr class="codeline" data-linenumber="3636"><td class="num" id="LN3636">3636</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3637"><td class="num" id="LN3637">3637</td><td class="line">    <span class='keyword'>if</span> (count == 1)</td></tr>
<tr class="codeline" data-linenumber="3638"><td class="num" id="LN3638">3638</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3639"><td class="num" id="LN3639">3639</td><td class="line">	mf_free(mfp, hp);	<span class='comment'>// free the data block</span></td></tr>
<tr class="codeline" data-linenumber="3640"><td class="num" id="LN3640">3640</td><td class="line">	buf-&gt;b_ml.ml_locked = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3641"><td class="num" id="LN3641">3641</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3642"><td class="num" id="LN3642">3642</td><td class="line">	<span class='keyword'>for</span> (stack_idx = buf-&gt;b_ml.ml_stack_top - 1; stack_idx &gt;= 0;</td></tr>
<tr class="codeline" data-linenumber="3643"><td class="num" id="LN3643">3643</td><td class="line">								  --stack_idx)</td></tr>
<tr class="codeline" data-linenumber="3644"><td class="num" id="LN3644">3644</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="3645"><td class="num" id="LN3645">3645</td><td class="line">	    buf-&gt;b_ml.ml_stack_top = 0;	    <span class='comment'>// stack is invalid when failing</span></td></tr>
<tr class="codeline" data-linenumber="3646"><td class="num" id="LN3646">3646</td><td class="line">	    ip = &amp;(buf-&gt;b_ml.ml_stack[stack_idx]);</td></tr>
<tr class="codeline" data-linenumber="3647"><td class="num" id="LN3647">3647</td><td class="line">	    idx = ip-&gt;ip_index;</td></tr>
<tr class="codeline" data-linenumber="3648"><td class="num" id="LN3648">3648</td><td class="line">	    <span class='keyword'>if</span> ((hp = mf_get(mfp, ip-&gt;ip_bnum, 1)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3649"><td class="num" id="LN3649">3649</td><td class="line">		<span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="3650"><td class="num" id="LN3650">3650</td><td class="line">	    pp = (PTR_BL *)(hp-&gt;bh_data);   <span class='comment'>// must be pointer block</span></td></tr>
<tr class="codeline" data-linenumber="3651"><td class="num" id="LN3651">3651</td><td class="line">	    <span class='keyword'>if</span> (pp-&gt;pb_id != <span class='macro'>PTR_ID<span class='macro_popup'>(('p' &lt;&lt; 8) + 't')</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3652"><td class="num" id="LN3652">3652</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="3653"><td class="num" id="LN3653">3653</td><td class="line">		iemsg(<span class='macro'>_(<span class='string_literal'>"E317: pointer block id wrong 4"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E317: pointer block id wrong 4"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3654"><td class="num" id="LN3654">3654</td><td class="line">		mf_put(mfp, hp, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3655"><td class="num" id="LN3655">3655</td><td class="line">		<span class='keyword'>goto</span> theend;</td></tr>
<tr class="codeline" data-linenumber="3656"><td class="num" id="LN3656">3656</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="3657"><td class="num" id="LN3657">3657</td><td class="line">	    count = --(pp-&gt;pb_count);</td></tr>
<tr class="codeline" data-linenumber="3658"><td class="num" id="LN3658">3658</td><td class="line">	    <span class='keyword'>if</span> (count == 0)	    <span class='comment'>// the pointer block becomes empty!</span></td></tr>
<tr class="codeline" data-linenumber="3659"><td class="num" id="LN3659">3659</td><td class="line">		mf_free(mfp, hp);</td></tr>
<tr class="codeline" data-linenumber="3660"><td class="num" id="LN3660">3660</td><td class="line">	    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3661"><td class="num" id="LN3661">3661</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="3662"><td class="num" id="LN3662">3662</td><td class="line">		<span class='keyword'>if</span> (count != idx)	<span class='comment'>// move entries after the deleted one</span></td></tr>
<tr class="codeline" data-linenumber="3663"><td class="num" id="LN3663">3663</td><td class="line">		    <span class='macro'>mch_memmove(&amp;pp-&gt;pb_pointer[idx], &amp;pp-&gt;pb_pointer[idx + 1],<span class='macro_popup'>memmove((char *)(&amp;pp-&gt;pb_pointer[idx]), (char *)(&amp;<br>pp-&gt;pb_pointer[idx + 1]), (size_t)(count - idx) * sizeof(PTR_EN<br>))</span></span></td></tr>
<tr class="codeline" data-linenumber="3664"><td class="num" id="LN3664">3664</td><td class="line">				      <span class='macro'>(size_t)(count - idx) * <span class='keyword'>sizeof</span>(PTR_EN))<span class='macro_popup'>memmove((char *)(&amp;pp-&gt;pb_pointer[idx]), (char *)(&amp;<br>pp-&gt;pb_pointer[idx + 1]), (size_t)(count - idx) * sizeof(PTR_EN<br>))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3665"><td class="num" id="LN3665">3665</td><td class="line">		mf_put(mfp, hp, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3666"><td class="num" id="LN3666">3666</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3667"><td class="num" id="LN3667">3667</td><td class="line">		buf-&gt;b_ml.ml_stack_top = stack_idx;	<span class='comment'>// truncate stack</span></td></tr>
<tr class="codeline" data-linenumber="3668"><td class="num" id="LN3668">3668</td><td class="line">		<span class='comment'>// fix line count for rest of blocks in the stack</span></td></tr>
<tr class="codeline" data-linenumber="3669"><td class="num" id="LN3669">3669</td><td class="line">		<span class='keyword'>if</span> (buf-&gt;b_ml.ml_locked_lineadd != 0)</td></tr>
<tr class="codeline" data-linenumber="3670"><td class="num" id="LN3670">3670</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="3671"><td class="num" id="LN3671">3671</td><td class="line">		    ml_lineadd(buf, buf-&gt;b_ml.ml_locked_lineadd);</td></tr>
<tr class="codeline" data-linenumber="3672"><td class="num" id="LN3672">3672</td><td class="line">		    buf-&gt;b_ml.ml_stack[buf-&gt;b_ml.ml_stack_top].ip_high +=</td></tr>
<tr class="codeline" data-linenumber="3673"><td class="num" id="LN3673">3673</td><td class="line">						  buf-&gt;b_ml.ml_locked_lineadd;</td></tr>
<tr class="codeline" data-linenumber="3674"><td class="num" id="LN3674">3674</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="3675"><td class="num" id="LN3675">3675</td><td class="line">		++(buf-&gt;b_ml.ml_stack_top);</td></tr>
<tr class="codeline" data-linenumber="3676"><td class="num" id="LN3676">3676</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3677"><td class="num" id="LN3677">3677</td><td class="line">		<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="3678"><td class="num" id="LN3678">3678</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="3679"><td class="num" id="LN3679">3679</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="3680"><td class="num" id="LN3680">3680</td><td class="line">	<span class='macro'>CHECK(stack_idx &lt; 0, _(<span class='string_literal'>"deleted block 1?"</span>))<span class='macro_popup'>do { } while (0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3681"><td class="num" id="LN3681">3681</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3682"><td class="num" id="LN3682">3682</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3683"><td class="num" id="LN3683">3683</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3684"><td class="num" id="LN3684">3684</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3685"><td class="num" id="LN3685">3685</td><td class="line">	 <span class='comment'>* delete the text by moving the next lines forwards</span></td></tr>
<tr class="codeline" data-linenumber="3686"><td class="num" id="LN3686">3686</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3687"><td class="num" id="LN3687">3687</td><td class="line">	text_start = dp-&gt;db_txt_start;</td></tr>
<tr class="codeline" data-linenumber="3688"><td class="num" id="LN3688">3688</td><td class="line">	<span class='macro'>mch_memmove((<span class='keyword'>char</span> *)dp + text_start + line_size,<span class='macro_popup'>memmove((char *)((char *)dp + text_start + line_size), (char *<br>)((char *)dp + text_start), (size_t)(line_start - text_start)<br>)</span></span></td></tr>
<tr class="codeline" data-linenumber="3689"><td class="num" id="LN3689">3689</td><td class="line">		  <span class='macro'>(<span class='keyword'>char</span> *)dp + text_start, (size_t)(line_start - text_start))<span class='macro_popup'>memmove((char *)((char *)dp + text_start + line_size), (char *<br>)((char *)dp + text_start), (size_t)(line_start - text_start)<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3690"><td class="num" id="LN3690">3690</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3691"><td class="num" id="LN3691">3691</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3692"><td class="num" id="LN3692">3692</td><td class="line">	 <span class='comment'>* delete the index by moving the next indexes backwards</span></td></tr>
<tr class="codeline" data-linenumber="3693"><td class="num" id="LN3693">3693</td><td class="line">	 <span class='comment'>* Adjust the indexes for the text movement.</span></td></tr>
<tr class="codeline" data-linenumber="3694"><td class="num" id="LN3694">3694</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3695"><td class="num" id="LN3695">3695</td><td class="line">	<span class='keyword'>for</span> (i = idx; i &lt; count - 1; ++i)</td></tr>
<tr class="codeline" data-linenumber="3696"><td class="num" id="LN3696">3696</td><td class="line">	    dp-&gt;db_index[i] = dp-&gt;db_index[i + 1] + line_size;</td></tr>
<tr class="codeline" data-linenumber="3697"><td class="num" id="LN3697">3697</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3698"><td class="num" id="LN3698">3698</td><td class="line">	dp-&gt;db_free += line_size + <span class='macro'>INDEX_SIZE<span class='macro_popup'>(sizeof(unsigned))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3699"><td class="num" id="LN3699">3699</td><td class="line">	dp-&gt;db_txt_start += line_size;</td></tr>
<tr class="codeline" data-linenumber="3700"><td class="num" id="LN3700">3700</td><td class="line">	--(dp-&gt;db_line_count);</td></tr>
<tr class="codeline" data-linenumber="3701"><td class="num" id="LN3701">3701</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3702"><td class="num" id="LN3702">3702</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3703"><td class="num" id="LN3703">3703</td><td class="line">	 <span class='comment'>* mark the block dirty and make sure it is in the file (for recovery)</span></td></tr>
<tr class="codeline" data-linenumber="3704"><td class="num" id="LN3704">3704</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3705"><td class="num" id="LN3705">3705</td><td class="line">	buf-&gt;b_ml.ml_flags |= (<span class='macro'>ML_LOCKED_DIRTY<span class='macro_popup'>4</span></span> | <span class='macro'>ML_LOCKED_POS<span class='macro_popup'>8</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3706"><td class="num" id="LN3706">3706</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3707"><td class="num" id="LN3707">3707</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3708"><td class="num" id="LN3708">3708</td><td class="line"><span class='directive'>#ifdef FEAT_BYTEOFF</span></td></tr>
<tr class="codeline" data-linenumber="3709"><td class="num" id="LN3709">3709</td><td class="line">    ml_updatechunk(buf, lnum, line_size, <span class='macro'>ML_CHNK_DELLINE<span class='macro_popup'>2</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3710"><td class="num" id="LN3710">3710</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3711"><td class="num" id="LN3711">3711</td><td class="line">    ret = <span class='macro'>OK<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3712"><td class="num" id="LN3712">3712</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3713"><td class="num" id="LN3713">3713</td><td class="line">theend:</td></tr>
<tr class="codeline" data-linenumber="3714"><td class="num" id="LN3714">3714</td><td class="line"><span class='directive'>#ifdef FEAT_PROP_POPUP</span></td></tr>
<tr class="codeline" data-linenumber="3715"><td class="num" id="LN3715">3715</td><td class="line">    <span class='keyword'>if</span> (textprop_save != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3716"><td class="num" id="LN3716">3716</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3717"><td class="num" id="LN3717">3717</td><td class="line">	<span class='comment'>// Adjust text properties in the line above and below.</span></td></tr>
<tr class="codeline" data-linenumber="3718"><td class="num" id="LN3718">3718</td><td class="line">	<span class='keyword'>if</span> (lnum &gt; 1)</td></tr>
<tr class="codeline" data-linenumber="3719"><td class="num" id="LN3719">3719</td><td class="line">	    adjust_text_props_for_delete(buf, lnum - 1, textprop_save, textprop_save_len, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3720"><td class="num" id="LN3720">3720</td><td class="line">	<span class='keyword'>if</span> (lnum &lt;= buf-&gt;b_ml.ml_line_count)</td></tr>
<tr class="codeline" data-linenumber="3721"><td class="num" id="LN3721">3721</td><td class="line">	    adjust_text_props_for_delete(buf, lnum, textprop_save, textprop_save_len, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3722"><td class="num" id="LN3722">3722</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3723"><td class="num" id="LN3723">3723</td><td class="line">    vim_free(textprop_save);</td></tr>
<tr class="codeline" data-linenumber="3724"><td class="num" id="LN3724">3724</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3725"><td class="num" id="LN3725">3725</td><td class="line">    <span class='keyword'>return</span> ret;</td></tr>
<tr class="codeline" data-linenumber="3726"><td class="num" id="LN3726">3726</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3727"><td class="num" id="LN3727">3727</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3728"><td class="num" id="LN3728">3728</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3729"><td class="num" id="LN3729">3729</td><td class="line"> <span class='comment'>* Delete line "lnum" in the current buffer.</span></td></tr>
<tr class="codeline" data-linenumber="3730"><td class="num" id="LN3730">3730</td><td class="line"> <span class='comment'>* When "message" is TRUE may give a "No lines in buffer" message.</span></td></tr>
<tr class="codeline" data-linenumber="3731"><td class="num" id="LN3731">3731</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3732"><td class="num" id="LN3732">3732</td><td class="line"> <span class='comment'>* Check: The caller of this function should probably also call</span></td></tr>
<tr class="codeline" data-linenumber="3733"><td class="num" id="LN3733">3733</td><td class="line"> <span class='comment'>* deleted_lines() after this.</span></td></tr>
<tr class="codeline" data-linenumber="3734"><td class="num" id="LN3734">3734</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3735"><td class="num" id="LN3735">3735</td><td class="line"> <span class='comment'>* return FAIL for failure, OK otherwise</span></td></tr>
<tr class="codeline" data-linenumber="3736"><td class="num" id="LN3736">3736</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3737"><td class="num" id="LN3737">3737</td><td class="line">    <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="3738"><td class="num" id="LN3738">3738</td><td class="line">ml_delete(linenr_T lnum)</td></tr>
<tr class="codeline" data-linenumber="3739"><td class="num" id="LN3739">3739</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3740"><td class="num" id="LN3740">3740</td><td class="line">    <span class='keyword'>return</span> ml_delete_flags(lnum, 0);</td></tr>
<tr class="codeline" data-linenumber="3741"><td class="num" id="LN3741">3741</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3742"><td class="num" id="LN3742">3742</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3743"><td class="num" id="LN3743">3743</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3744"><td class="num" id="LN3744">3744</td><td class="line"> <span class='comment'>* Like ml_delete() but using flags (see ml_delete_int()).</span></td></tr>
<tr class="codeline" data-linenumber="3745"><td class="num" id="LN3745">3745</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3746"><td class="num" id="LN3746">3746</td><td class="line">    <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="3747"><td class="num" id="LN3747">3747</td><td class="line">ml_delete_flags(linenr_T lnum, <span class='keyword'>int</span> flags)</td></tr>
<tr class="codeline" data-linenumber="3748"><td class="num" id="LN3748">3748</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3749"><td class="num" id="LN3749">3749</td><td class="line">    ml_flush_line(curbuf);</td></tr>
<tr class="codeline" data-linenumber="3750"><td class="num" id="LN3750">3750</td><td class="line">    <span class='keyword'>if</span> (lnum &lt; 1 || lnum &gt; curbuf-&gt;b_ml.ml_line_count)</td></tr>
<tr class="codeline" data-linenumber="3751"><td class="num" id="LN3751">3751</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>FAIL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3752"><td class="num" id="LN3752">3752</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3753"><td class="num" id="LN3753">3753</td><td class="line"><span class='directive'>#ifdef FEAT_EVAL</span></td></tr>
<tr class="codeline" data-linenumber="3754"><td class="num" id="LN3754">3754</td><td class="line">    <span class='comment'>// When inserting above recorded changes: flush the changes before changing</span></td></tr>
<tr class="codeline" data-linenumber="3755"><td class="num" id="LN3755">3755</td><td class="line">    <span class='comment'>// the text.</span></td></tr>
<tr class="codeline" data-linenumber="3756"><td class="num" id="LN3756">3756</td><td class="line">    may_invoke_listeners(curbuf, lnum, lnum + 1, -1);</td></tr>
<tr class="codeline" data-linenumber="3757"><td class="num" id="LN3757">3757</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3758"><td class="num" id="LN3758">3758</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3759"><td class="num" id="LN3759">3759</td><td class="line">    <span class='keyword'>return</span> ml_delete_int(curbuf, lnum, flags);</td></tr>
<tr class="codeline" data-linenumber="3760"><td class="num" id="LN3760">3760</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3761"><td class="num" id="LN3761">3761</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3762"><td class="num" id="LN3762">3762</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3763"><td class="num" id="LN3763">3763</td><td class="line"> <span class='comment'>* set the DB_MARKED flag for line 'lnum'</span></td></tr>
<tr class="codeline" data-linenumber="3764"><td class="num" id="LN3764">3764</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3765"><td class="num" id="LN3765">3765</td><td class="line">    <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="3766"><td class="num" id="LN3766">3766</td><td class="line">ml_setmarked(linenr_T lnum)</td></tr>
<tr class="codeline" data-linenumber="3767"><td class="num" id="LN3767">3767</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3768"><td class="num" id="LN3768">3768</td><td class="line">    bhdr_T    *hp;</td></tr>
<tr class="codeline" data-linenumber="3769"><td class="num" id="LN3769">3769</td><td class="line">    DATA_BL *dp;</td></tr>
<tr class="codeline" data-linenumber="3770"><td class="num" id="LN3770">3770</td><td class="line">				    <span class='comment'>// invalid line number</span></td></tr>
<tr class="codeline" data-linenumber="3771"><td class="num" id="LN3771">3771</td><td class="line">    <span class='keyword'>if</span> (lnum &lt; 1 || lnum &gt; curbuf-&gt;b_ml.ml_line_count</td></tr>
<tr class="codeline" data-linenumber="3772"><td class="num" id="LN3772">3772</td><td class="line">					       || curbuf-&gt;b_ml.ml_mfp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3773"><td class="num" id="LN3773">3773</td><td class="line">	<span class='keyword'>return</span>;			    <span class='comment'>// give error message?</span></td></tr>
<tr class="codeline" data-linenumber="3774"><td class="num" id="LN3774">3774</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3775"><td class="num" id="LN3775">3775</td><td class="line">    <span class='keyword'>if</span> (lowest_marked == 0 || lowest_marked &gt; lnum)</td></tr>
<tr class="codeline" data-linenumber="3776"><td class="num" id="LN3776">3776</td><td class="line">	lowest_marked = lnum;</td></tr>
<tr class="codeline" data-linenumber="3777"><td class="num" id="LN3777">3777</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3778"><td class="num" id="LN3778">3778</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3779"><td class="num" id="LN3779">3779</td><td class="line">     <span class='comment'>* find the data block containing the line</span></td></tr>
<tr class="codeline" data-linenumber="3780"><td class="num" id="LN3780">3780</td><td class="line">     <span class='comment'>* This also fills the stack with the blocks from the root to the data block</span></td></tr>
<tr class="codeline" data-linenumber="3781"><td class="num" id="LN3781">3781</td><td class="line">     <span class='comment'>* This also releases any locked block.</span></td></tr>
<tr class="codeline" data-linenumber="3782"><td class="num" id="LN3782">3782</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3783"><td class="num" id="LN3783">3783</td><td class="line">    <span class='keyword'>if</span> ((hp = ml_find_line(curbuf, lnum, <span class='macro'>ML_FIND<span class='macro_popup'>0x13</span></span>)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3784"><td class="num" id="LN3784">3784</td><td class="line">	<span class='keyword'>return</span>;		    <span class='comment'>// give error message?</span></td></tr>
<tr class="codeline" data-linenumber="3785"><td class="num" id="LN3785">3785</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3786"><td class="num" id="LN3786">3786</td><td class="line">    dp = (DATA_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="3787"><td class="num" id="LN3787">3787</td><td class="line">    dp-&gt;db_index[lnum - curbuf-&gt;b_ml.ml_locked_low] |= <span class='macro'>DB_MARKED<span class='macro_popup'>((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3788"><td class="num" id="LN3788">3788</td><td class="line">    curbuf-&gt;b_ml.ml_flags |= <span class='macro'>ML_LOCKED_DIRTY<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3789"><td class="num" id="LN3789">3789</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3790"><td class="num" id="LN3790">3790</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3791"><td class="num" id="LN3791">3791</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3792"><td class="num" id="LN3792">3792</td><td class="line"> <span class='comment'>* find the first line with its DB_MARKED flag set</span></td></tr>
<tr class="codeline" data-linenumber="3793"><td class="num" id="LN3793">3793</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3794"><td class="num" id="LN3794">3794</td><td class="line">    linenr_T</td></tr>
<tr class="codeline" data-linenumber="3795"><td class="num" id="LN3795">3795</td><td class="line">ml_firstmarked(<span class='keyword'>void</span>)</td></tr>
<tr class="codeline" data-linenumber="3796"><td class="num" id="LN3796">3796</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3797"><td class="num" id="LN3797">3797</td><td class="line">    bhdr_T	*hp;</td></tr>
<tr class="codeline" data-linenumber="3798"><td class="num" id="LN3798">3798</td><td class="line">    DATA_BL	*dp;</td></tr>
<tr class="codeline" data-linenumber="3799"><td class="num" id="LN3799">3799</td><td class="line">    linenr_T	lnum;</td></tr>
<tr class="codeline" data-linenumber="3800"><td class="num" id="LN3800">3800</td><td class="line">    <span class='keyword'>int</span>		i;</td></tr>
<tr class="codeline" data-linenumber="3801"><td class="num" id="LN3801">3801</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3802"><td class="num" id="LN3802">3802</td><td class="line">    <span class='keyword'>if</span> (curbuf-&gt;b_ml.ml_mfp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3803"><td class="num" id="LN3803">3803</td><td class="line">	<span class='keyword'>return</span> (linenr_T) 0;</td></tr>
<tr class="codeline" data-linenumber="3804"><td class="num" id="LN3804">3804</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3805"><td class="num" id="LN3805">3805</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3806"><td class="num" id="LN3806">3806</td><td class="line">     <span class='comment'>* The search starts with lowest_marked line. This is the last line where</span></td></tr>
<tr class="codeline" data-linenumber="3807"><td class="num" id="LN3807">3807</td><td class="line">     <span class='comment'>* a mark was found, adjusted by inserting/deleting lines.</span></td></tr>
<tr class="codeline" data-linenumber="3808"><td class="num" id="LN3808">3808</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3809"><td class="num" id="LN3809">3809</td><td class="line">    <span class='keyword'>for</span> (lnum = lowest_marked; lnum &lt;= curbuf-&gt;b_ml.ml_line_count; )</td></tr>
<tr class="codeline" data-linenumber="3810"><td class="num" id="LN3810">3810</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3811"><td class="num" id="LN3811">3811</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3812"><td class="num" id="LN3812">3812</td><td class="line">	 <span class='comment'>* Find the data block containing the line.</span></td></tr>
<tr class="codeline" data-linenumber="3813"><td class="num" id="LN3813">3813</td><td class="line">	 <span class='comment'>* This also fills the stack with the blocks from the root to the data</span></td></tr>
<tr class="codeline" data-linenumber="3814"><td class="num" id="LN3814">3814</td><td class="line">	 <span class='comment'>* block This also releases any locked block.</span></td></tr>
<tr class="codeline" data-linenumber="3815"><td class="num" id="LN3815">3815</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3816"><td class="num" id="LN3816">3816</td><td class="line">	<span class='keyword'>if</span> ((hp = ml_find_line(curbuf, lnum, <span class='macro'>ML_FIND<span class='macro_popup'>0x13</span></span>)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3817"><td class="num" id="LN3817">3817</td><td class="line">	    <span class='keyword'>return</span> (linenr_T)0;		    <span class='comment'>// give error message?</span></td></tr>
<tr class="codeline" data-linenumber="3818"><td class="num" id="LN3818">3818</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3819"><td class="num" id="LN3819">3819</td><td class="line">	dp = (DATA_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="3820"><td class="num" id="LN3820">3820</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3821"><td class="num" id="LN3821">3821</td><td class="line">	<span class='keyword'>for</span> (i = lnum - curbuf-&gt;b_ml.ml_locked_low;</td></tr>
<tr class="codeline" data-linenumber="3822"><td class="num" id="LN3822">3822</td><td class="line">			    lnum &lt;= curbuf-&gt;b_ml.ml_locked_high; ++i, ++lnum)</td></tr>
<tr class="codeline" data-linenumber="3823"><td class="num" id="LN3823">3823</td><td class="line">	    <span class='keyword'>if</span> ((dp-&gt;db_index[i]) &amp; <span class='macro'>DB_MARKED<span class='macro_popup'>((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3824"><td class="num" id="LN3824">3824</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="3825"><td class="num" id="LN3825">3825</td><td class="line">		(dp-&gt;db_index[i]) &amp;= <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3826"><td class="num" id="LN3826">3826</td><td class="line">		curbuf-&gt;b_ml.ml_flags |= <span class='macro'>ML_LOCKED_DIRTY<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3827"><td class="num" id="LN3827">3827</td><td class="line">		lowest_marked = lnum + 1;</td></tr>
<tr class="codeline" data-linenumber="3828"><td class="num" id="LN3828">3828</td><td class="line">		<span class='keyword'>return</span> lnum;</td></tr>
<tr class="codeline" data-linenumber="3829"><td class="num" id="LN3829">3829</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="3830"><td class="num" id="LN3830">3830</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3831"><td class="num" id="LN3831">3831</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3832"><td class="num" id="LN3832">3832</td><td class="line">    <span class='keyword'>return</span> (linenr_T) 0;</td></tr>
<tr class="codeline" data-linenumber="3833"><td class="num" id="LN3833">3833</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3834"><td class="num" id="LN3834">3834</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3835"><td class="num" id="LN3835">3835</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3836"><td class="num" id="LN3836">3836</td><td class="line"> <span class='comment'>* clear all DB_MARKED flags</span></td></tr>
<tr class="codeline" data-linenumber="3837"><td class="num" id="LN3837">3837</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3838"><td class="num" id="LN3838">3838</td><td class="line">    <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="3839"><td class="num" id="LN3839">3839</td><td class="line">ml_clearmarked(<span class='keyword'>void</span>)</td></tr>
<tr class="codeline" data-linenumber="3840"><td class="num" id="LN3840">3840</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3841"><td class="num" id="LN3841">3841</td><td class="line">    bhdr_T	*hp;</td></tr>
<tr class="codeline" data-linenumber="3842"><td class="num" id="LN3842">3842</td><td class="line">    DATA_BL	*dp;</td></tr>
<tr class="codeline" data-linenumber="3843"><td class="num" id="LN3843">3843</td><td class="line">    linenr_T	lnum;</td></tr>
<tr class="codeline" data-linenumber="3844"><td class="num" id="LN3844">3844</td><td class="line">    <span class='keyword'>int</span>		i;</td></tr>
<tr class="codeline" data-linenumber="3845"><td class="num" id="LN3845">3845</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3846"><td class="num" id="LN3846">3846</td><td class="line">    <span class='keyword'>if</span> (curbuf-&gt;b_ml.ml_mfp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)	    <span class='comment'>// nothing to do</span></td></tr>
<tr class="codeline" data-linenumber="3847"><td class="num" id="LN3847">3847</td><td class="line">	<span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="3848"><td class="num" id="LN3848">3848</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3849"><td class="num" id="LN3849">3849</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3850"><td class="num" id="LN3850">3850</td><td class="line">     <span class='comment'>* The search starts with line lowest_marked.</span></td></tr>
<tr class="codeline" data-linenumber="3851"><td class="num" id="LN3851">3851</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3852"><td class="num" id="LN3852">3852</td><td class="line">    <span class='keyword'>for</span> (lnum = lowest_marked; lnum &lt;= curbuf-&gt;b_ml.ml_line_count; )</td></tr>
<tr class="codeline" data-linenumber="3853"><td class="num" id="LN3853">3853</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3854"><td class="num" id="LN3854">3854</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3855"><td class="num" id="LN3855">3855</td><td class="line">	 <span class='comment'>* Find the data block containing the line.</span></td></tr>
<tr class="codeline" data-linenumber="3856"><td class="num" id="LN3856">3856</td><td class="line">	 <span class='comment'>* This also fills the stack with the blocks from the root to the data</span></td></tr>
<tr class="codeline" data-linenumber="3857"><td class="num" id="LN3857">3857</td><td class="line">	 <span class='comment'>* block and releases any locked block.</span></td></tr>
<tr class="codeline" data-linenumber="3858"><td class="num" id="LN3858">3858</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3859"><td class="num" id="LN3859">3859</td><td class="line">	<span class='keyword'>if</span> ((hp = ml_find_line(curbuf, lnum, <span class='macro'>ML_FIND<span class='macro_popup'>0x13</span></span>)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3860"><td class="num" id="LN3860">3860</td><td class="line">	    <span class='keyword'>return</span>;		<span class='comment'>// give error message?</span></td></tr>
<tr class="codeline" data-linenumber="3861"><td class="num" id="LN3861">3861</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3862"><td class="num" id="LN3862">3862</td><td class="line">	dp = (DATA_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="3863"><td class="num" id="LN3863">3863</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3864"><td class="num" id="LN3864">3864</td><td class="line">	<span class='keyword'>for</span> (i = lnum - curbuf-&gt;b_ml.ml_locked_low;</td></tr>
<tr class="codeline" data-linenumber="3865"><td class="num" id="LN3865">3865</td><td class="line">			    lnum &lt;= curbuf-&gt;b_ml.ml_locked_high; ++i, ++lnum)</td></tr>
<tr class="codeline" data-linenumber="3866"><td class="num" id="LN3866">3866</td><td class="line">	    <span class='keyword'>if</span> ((dp-&gt;db_index[i]) &amp; <span class='macro'>DB_MARKED<span class='macro_popup'>((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3867"><td class="num" id="LN3867">3867</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="3868"><td class="num" id="LN3868">3868</td><td class="line">		(dp-&gt;db_index[i]) &amp;= <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3869"><td class="num" id="LN3869">3869</td><td class="line">		curbuf-&gt;b_ml.ml_flags |= <span class='macro'>ML_LOCKED_DIRTY<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3870"><td class="num" id="LN3870">3870</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="3871"><td class="num" id="LN3871">3871</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3872"><td class="num" id="LN3872">3872</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3873"><td class="num" id="LN3873">3873</td><td class="line">    lowest_marked = 0;</td></tr>
<tr class="codeline" data-linenumber="3874"><td class="num" id="LN3874">3874</td><td class="line">    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="3875"><td class="num" id="LN3875">3875</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3876"><td class="num" id="LN3876">3876</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3877"><td class="num" id="LN3877">3877</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3878"><td class="num" id="LN3878">3878</td><td class="line"> <span class='comment'>* flush ml_line if necessary</span></td></tr>
<tr class="codeline" data-linenumber="3879"><td class="num" id="LN3879">3879</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3880"><td class="num" id="LN3880">3880</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="3881"><td class="num" id="LN3881">3881</td><td class="line">ml_flush_line(buf_T *buf)</td></tr>
<tr class="codeline" data-linenumber="3882"><td class="num" id="LN3882">3882</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3883"><td class="num" id="LN3883">3883</td><td class="line">    bhdr_T	*hp;</td></tr>
<tr class="codeline" data-linenumber="3884"><td class="num" id="LN3884">3884</td><td class="line">    DATA_BL	*dp;</td></tr>
<tr class="codeline" data-linenumber="3885"><td class="num" id="LN3885">3885</td><td class="line">    linenr_T	lnum;</td></tr>
<tr class="codeline" data-linenumber="3886"><td class="num" id="LN3886">3886</td><td class="line">    char_u	*new_line;</td></tr>
<tr class="codeline" data-linenumber="3887"><td class="num" id="LN3887">3887</td><td class="line">    char_u	*old_line;</td></tr>
<tr class="codeline" data-linenumber="3888"><td class="num" id="LN3888">3888</td><td class="line">    colnr_T	new_len;</td></tr>
<tr class="codeline" data-linenumber="3889"><td class="num" id="LN3889">3889</td><td class="line">    <span class='keyword'>int</span>		old_len;</td></tr>
<tr class="codeline" data-linenumber="3890"><td class="num" id="LN3890">3890</td><td class="line">    <span class='keyword'>int</span>		extra;</td></tr>
<tr class="codeline" data-linenumber="3891"><td class="num" id="LN3891">3891</td><td class="line">    <span class='keyword'>int</span>		idx;</td></tr>
<tr class="codeline" data-linenumber="3892"><td class="num" id="LN3892">3892</td><td class="line">    <span class='keyword'>int</span>		start;</td></tr>
<tr class="codeline" data-linenumber="3893"><td class="num" id="LN3893">3893</td><td class="line">    <span class='keyword'>int</span>		count;</td></tr>
<tr class="codeline" data-linenumber="3894"><td class="num" id="LN3894">3894</td><td class="line">    <span class='keyword'>int</span>		i;</td></tr>
<tr class="codeline" data-linenumber="3895"><td class="num" id="LN3895">3895</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>int</span>  entered = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3896"><td class="num" id="LN3896">3896</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3897"><td class="num" id="LN3897">3897</td><td class="line">    <span class='keyword'>if</span> (buf-&gt;b_ml.ml_line_lnum == 0 || buf-&gt;b_ml.ml_mfp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3898"><td class="num" id="LN3898">3898</td><td class="line">	<span class='keyword'>return</span>;		<span class='comment'>// nothing to do</span></td></tr>
<tr class="codeline" data-linenumber="3899"><td class="num" id="LN3899">3899</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3900"><td class="num" id="LN3900">3900</td><td class="line">    <span class='keyword'>if</span> (buf-&gt;b_ml.ml_flags &amp; <span class='macro'>ML_LINE_DIRTY<span class='macro_popup'>2</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3901"><td class="num" id="LN3901">3901</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3902"><td class="num" id="LN3902">3902</td><td class="line">	<span class='comment'>// This code doesn't work recursively, but Netbeans may call back here</span></td></tr>
<tr class="codeline" data-linenumber="3903"><td class="num" id="LN3903">3903</td><td class="line">	<span class='comment'>// when obtaining the cursor position.</span></td></tr>
<tr class="codeline" data-linenumber="3904"><td class="num" id="LN3904">3904</td><td class="line">	<span class='keyword'>if</span> (entered)</td></tr>
<tr class="codeline" data-linenumber="3905"><td class="num" id="LN3905">3905</td><td class="line">	    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="3906"><td class="num" id="LN3906">3906</td><td class="line">	entered = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3907"><td class="num" id="LN3907">3907</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3908"><td class="num" id="LN3908">3908</td><td class="line">	lnum = buf-&gt;b_ml.ml_line_lnum;</td></tr>
<tr class="codeline" data-linenumber="3909"><td class="num" id="LN3909">3909</td><td class="line">	new_line = buf-&gt;b_ml.ml_line_ptr;</td></tr>
<tr class="codeline" data-linenumber="3910"><td class="num" id="LN3910">3910</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3911"><td class="num" id="LN3911">3911</td><td class="line">	hp = ml_find_line(buf, lnum, <span class='macro'>ML_FIND<span class='macro_popup'>0x13</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3912"><td class="num" id="LN3912">3912</td><td class="line">	<span class='keyword'>if</span> (hp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3913"><td class="num" id="LN3913">3913</td><td class="line">	    siemsg(<span class='macro'>_(<span class='string_literal'>"E320: Cannot find line %ld"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E320: Cannot find line %ld")<br>, 5)</span></span>, lnum);</td></tr>
<tr class="codeline" data-linenumber="3914"><td class="num" id="LN3914">3914</td><td class="line">	<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3915"><td class="num" id="LN3915">3915</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="3916"><td class="num" id="LN3916">3916</td><td class="line">	    dp = (DATA_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="3917"><td class="num" id="LN3917">3917</td><td class="line">	    idx = lnum - buf-&gt;b_ml.ml_locked_low;</td></tr>
<tr class="codeline" data-linenumber="3918"><td class="num" id="LN3918">3918</td><td class="line">	    start = ((dp-&gt;db_index[idx]) &amp; <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3919"><td class="num" id="LN3919">3919</td><td class="line">	    old_line = (char_u *)dp + start;</td></tr>
<tr class="codeline" data-linenumber="3920"><td class="num" id="LN3920">3920</td><td class="line">	    <span class='keyword'>if</span> (idx == 0)	<span class='comment'>// line is last in block</span></td></tr>
<tr class="codeline" data-linenumber="3921"><td class="num" id="LN3921">3921</td><td class="line">		old_len = dp-&gt;db_txt_end - start;</td></tr>
<tr class="codeline" data-linenumber="3922"><td class="num" id="LN3922">3922</td><td class="line">	    <span class='keyword'>else</span>		<span class='comment'>// text of previous line follows</span></td></tr>
<tr class="codeline" data-linenumber="3923"><td class="num" id="LN3923">3923</td><td class="line">		old_len = (dp-&gt;db_index[idx - 1] &amp; <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>) - start;</td></tr>
<tr class="codeline" data-linenumber="3924"><td class="num" id="LN3924">3924</td><td class="line">	    new_len = buf-&gt;b_ml.ml_line_len;</td></tr>
<tr class="codeline" data-linenumber="3925"><td class="num" id="LN3925">3925</td><td class="line">	    extra = new_len - old_len;	    <span class='comment'>// negative if lines gets smaller</span></td></tr>
<tr class="codeline" data-linenumber="3926"><td class="num" id="LN3926">3926</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3927"><td class="num" id="LN3927">3927</td><td class="line">	    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3928"><td class="num" id="LN3928">3928</td><td class="line">	     <span class='comment'>* if new line fits in data block, replace directly</span></td></tr>
<tr class="codeline" data-linenumber="3929"><td class="num" id="LN3929">3929</td><td class="line">	     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3930"><td class="num" id="LN3930">3930</td><td class="line">	    <span class='keyword'>if</span> ((<span class='keyword'>int</span>)dp-&gt;db_free &gt;= extra)</td></tr>
<tr class="codeline" data-linenumber="3931"><td class="num" id="LN3931">3931</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="3932"><td class="num" id="LN3932">3932</td><td class="line">		<span class='comment'>// if the length changes and there are following lines</span></td></tr>
<tr class="codeline" data-linenumber="3933"><td class="num" id="LN3933">3933</td><td class="line">		count = buf-&gt;b_ml.ml_locked_high - buf-&gt;b_ml.ml_locked_low + 1;</td></tr>
<tr class="codeline" data-linenumber="3934"><td class="num" id="LN3934">3934</td><td class="line">		<span class='keyword'>if</span> (extra != 0 &amp;&amp; idx &lt; count - 1)</td></tr>
<tr class="codeline" data-linenumber="3935"><td class="num" id="LN3935">3935</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="3936"><td class="num" id="LN3936">3936</td><td class="line">		    <span class='comment'>// move text of following lines</span></td></tr>
<tr class="codeline" data-linenumber="3937"><td class="num" id="LN3937">3937</td><td class="line">		    <span class='macro'>mch_memmove((<span class='keyword'>char</span> *)dp + dp-&gt;db_txt_start - extra,<span class='macro_popup'>memmove((char *)((char *)dp + dp-&gt;db_txt_start - extra), (<br>char *)((char *)dp + dp-&gt;db_txt_start), (size_t)(start - dp<br>-&gt;db_txt_start))</span></span></td></tr>
<tr class="codeline" data-linenumber="3938"><td class="num" id="LN3938">3938</td><td class="line">				<span class='macro'>(<span class='keyword'>char</span> *)dp + dp-&gt;db_txt_start,<span class='macro_popup'>memmove((char *)((char *)dp + dp-&gt;db_txt_start - extra), (<br>char *)((char *)dp + dp-&gt;db_txt_start), (size_t)(start - dp<br>-&gt;db_txt_start))</span></span></td></tr>
<tr class="codeline" data-linenumber="3939"><td class="num" id="LN3939">3939</td><td class="line">				<span class='macro'>(size_t)(start - dp-&gt;db_txt_start))<span class='macro_popup'>memmove((char *)((char *)dp + dp-&gt;db_txt_start - extra), (<br>char *)((char *)dp + dp-&gt;db_txt_start), (size_t)(start - dp<br>-&gt;db_txt_start))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3940"><td class="num" id="LN3940">3940</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3941"><td class="num" id="LN3941">3941</td><td class="line">		    <span class='comment'>// adjust pointers of this and following lines</span></td></tr>
<tr class="codeline" data-linenumber="3942"><td class="num" id="LN3942">3942</td><td class="line">		    <span class='keyword'>for</span> (i = idx + 1; i &lt; count; ++i)</td></tr>
<tr class="codeline" data-linenumber="3943"><td class="num" id="LN3943">3943</td><td class="line">			dp-&gt;db_index[i] -= extra;</td></tr>
<tr class="codeline" data-linenumber="3944"><td class="num" id="LN3944">3944</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="3945"><td class="num" id="LN3945">3945</td><td class="line">		dp-&gt;db_index[idx] -= extra;</td></tr>
<tr class="codeline" data-linenumber="3946"><td class="num" id="LN3946">3946</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3947"><td class="num" id="LN3947">3947</td><td class="line">		<span class='comment'>// adjust free space</span></td></tr>
<tr class="codeline" data-linenumber="3948"><td class="num" id="LN3948">3948</td><td class="line">		dp-&gt;db_free -= extra;</td></tr>
<tr class="codeline" data-linenumber="3949"><td class="num" id="LN3949">3949</td><td class="line">		dp-&gt;db_txt_start -= extra;</td></tr>
<tr class="codeline" data-linenumber="3950"><td class="num" id="LN3950">3950</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3951"><td class="num" id="LN3951">3951</td><td class="line">		<span class='comment'>// copy new line into the data block</span></td></tr>
<tr class="codeline" data-linenumber="3952"><td class="num" id="LN3952">3952</td><td class="line">		<span class='macro'>mch_memmove(old_line - extra, new_line, (size_t)new_len)<span class='macro_popup'>memmove((char *)(old_line - extra), (char *)(new_line), (size_t<br>)new_len)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3953"><td class="num" id="LN3953">3953</td><td class="line">		buf-&gt;b_ml.ml_flags |= (<span class='macro'>ML_LOCKED_DIRTY<span class='macro_popup'>4</span></span> | <span class='macro'>ML_LOCKED_POS<span class='macro_popup'>8</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3954"><td class="num" id="LN3954">3954</td><td class="line"><span class='directive'>#ifdef FEAT_BYTEOFF</span></td></tr>
<tr class="codeline" data-linenumber="3955"><td class="num" id="LN3955">3955</td><td class="line">		<span class='comment'>// The else case is already covered by the insert and delete</span></td></tr>
<tr class="codeline" data-linenumber="3956"><td class="num" id="LN3956">3956</td><td class="line">		ml_updatechunk(buf, lnum, (<span class='keyword'>long</span>)extra, <span class='macro'>ML_CHNK_UPDLINE<span class='macro_popup'>3</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3957"><td class="num" id="LN3957">3957</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="3958"><td class="num" id="LN3958">3958</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="3959"><td class="num" id="LN3959">3959</td><td class="line">	    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3960"><td class="num" id="LN3960">3960</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="3961"><td class="num" id="LN3961">3961</td><td class="line">		<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3962"><td class="num" id="LN3962">3962</td><td class="line">		 <span class='comment'>* Cannot do it in one data block: Delete and append.</span></td></tr>
<tr class="codeline" data-linenumber="3963"><td class="num" id="LN3963">3963</td><td class="line">		 <span class='comment'>* Append first, because ml_delete_int() cannot delete the</span></td></tr>
<tr class="codeline" data-linenumber="3964"><td class="num" id="LN3964">3964</td><td class="line">		 <span class='comment'>* last line in a buffer, which causes trouble for a buffer</span></td></tr>
<tr class="codeline" data-linenumber="3965"><td class="num" id="LN3965">3965</td><td class="line">		 <span class='comment'>* that has only one line.</span></td></tr>
<tr class="codeline" data-linenumber="3966"><td class="num" id="LN3966">3966</td><td class="line">		 <span class='comment'>* Don't forget to copy the mark!</span></td></tr>
<tr class="codeline" data-linenumber="3967"><td class="num" id="LN3967">3967</td><td class="line">		 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3968"><td class="num" id="LN3968">3968</td><td class="line">		<span class='comment'>// How about handling errors???</span></td></tr>
<tr class="codeline" data-linenumber="3969"><td class="num" id="LN3969">3969</td><td class="line">		(<span class='keyword'>void</span>)ml_append_int(buf, lnum, new_line, new_len,</td></tr>
<tr class="codeline" data-linenumber="3970"><td class="num" id="LN3970">3970</td><td class="line">			 (dp-&gt;db_index[idx] &amp; <span class='macro'>DB_MARKED<span class='macro_popup'>((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1))</span></span>) ? <span class='macro'>ML_APPEND_MARK<span class='macro_popup'>2</span></span> : 0);</td></tr>
<tr class="codeline" data-linenumber="3971"><td class="num" id="LN3971">3971</td><td class="line">		(<span class='keyword'>void</span>)ml_delete_int(buf, lnum, 0);</td></tr>
<tr class="codeline" data-linenumber="3972"><td class="num" id="LN3972">3972</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="3973"><td class="num" id="LN3973">3973</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="3974"><td class="num" id="LN3974">3974</td><td class="line">	vim_free(new_line);</td></tr>
<tr class="codeline" data-linenumber="3975"><td class="num" id="LN3975">3975</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3976"><td class="num" id="LN3976">3976</td><td class="line">	entered = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3977"><td class="num" id="LN3977">3977</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3978"><td class="num" id="LN3978">3978</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3979"><td class="num" id="LN3979">3979</td><td class="line">    buf-&gt;b_ml.ml_line_lnum = 0;</td></tr>
<tr class="codeline" data-linenumber="3980"><td class="num" id="LN3980">3980</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3981"><td class="num" id="LN3981">3981</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3982"><td class="num" id="LN3982">3982</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="3983"><td class="num" id="LN3983">3983</td><td class="line"> <span class='comment'>* create a new, empty, data block</span></td></tr>
<tr class="codeline" data-linenumber="3984"><td class="num" id="LN3984">3984</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3985"><td class="num" id="LN3985">3985</td><td class="line">    <span class='keyword'>static</span> bhdr_T *</td></tr>
<tr class="codeline" data-linenumber="3986"><td class="num" id="LN3986">3986</td><td class="line">ml_new_data(memfile_T *mfp, <span class='keyword'>int</span> negative, <span class='keyword'>int</span> page_count)</td></tr>
<tr class="codeline" data-linenumber="3987"><td class="num" id="LN3987">3987</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3988"><td class="num" id="LN3988">3988</td><td class="line">    bhdr_T	*hp;</td></tr>
<tr class="codeline" data-linenumber="3989"><td class="num" id="LN3989">3989</td><td class="line">    DATA_BL	*dp;</td></tr>
<tr class="codeline" data-linenumber="3990"><td class="num" id="LN3990">3990</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3991"><td class="num" id="LN3991">3991</td><td class="line">    <span class='keyword'>if</span> ((hp = mf_new(mfp, negative, page_count)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3992"><td class="num" id="LN3992">3992</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3993"><td class="num" id="LN3993">3993</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3994"><td class="num" id="LN3994">3994</td><td class="line">    dp = (DATA_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="3995"><td class="num" id="LN3995">3995</td><td class="line">    dp-&gt;db_id = <span class='macro'>DATA_ID<span class='macro_popup'>(('d' &lt;&lt; 8) + 'a')</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3996"><td class="num" id="LN3996">3996</td><td class="line">    dp-&gt;db_txt_start = dp-&gt;db_txt_end = page_count * mfp-&gt;mf_page_size;</td></tr>
<tr class="codeline" data-linenumber="3997"><td class="num" id="LN3997">3997</td><td class="line">    dp-&gt;db_free = dp-&gt;db_txt_start - <span class='macro'>HEADER_SIZE<span class='macro_popup'>(sizeof(DATA_BL) - (sizeof(unsigned)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3998"><td class="num" id="LN3998">3998</td><td class="line">    dp-&gt;db_line_count = 0;</td></tr>
<tr class="codeline" data-linenumber="3999"><td class="num" id="LN3999">3999</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4000"><td class="num" id="LN4000">4000</td><td class="line">    <span class='keyword'>return</span> hp;</td></tr>
<tr class="codeline" data-linenumber="4001"><td class="num" id="LN4001">4001</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4002"><td class="num" id="LN4002">4002</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4003"><td class="num" id="LN4003">4003</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4004"><td class="num" id="LN4004">4004</td><td class="line"> <span class='comment'>* create a new, empty, pointer block</span></td></tr>
<tr class="codeline" data-linenumber="4005"><td class="num" id="LN4005">4005</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4006"><td class="num" id="LN4006">4006</td><td class="line">    <span class='keyword'>static</span> bhdr_T *</td></tr>
<tr class="codeline" data-linenumber="4007"><td class="num" id="LN4007">4007</td><td class="line">ml_new_ptr(memfile_T *mfp)</td></tr>
<tr class="codeline" data-linenumber="4008"><td class="num" id="LN4008">4008</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4009"><td class="num" id="LN4009">4009</td><td class="line">    bhdr_T	*hp;</td></tr>
<tr class="codeline" data-linenumber="4010"><td class="num" id="LN4010">4010</td><td class="line">    PTR_BL	*pp;</td></tr>
<tr class="codeline" data-linenumber="4011"><td class="num" id="LN4011">4011</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4012"><td class="num" id="LN4012">4012</td><td class="line">    <span class='keyword'>if</span> ((hp = mf_new(mfp, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>, 1)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4013"><td class="num" id="LN4013">4013</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4014"><td class="num" id="LN4014">4014</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4015"><td class="num" id="LN4015">4015</td><td class="line">    pp = (PTR_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="4016"><td class="num" id="LN4016">4016</td><td class="line">    pp-&gt;pb_id = <span class='macro'>PTR_ID<span class='macro_popup'>(('p' &lt;&lt; 8) + 't')</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4017"><td class="num" id="LN4017">4017</td><td class="line">    pp-&gt;pb_count = 0;</td></tr>
<tr class="codeline" data-linenumber="4018"><td class="num" id="LN4018">4018</td><td class="line">    pp-&gt;pb_count_max = (short_u)((mfp-&gt;mf_page_size - <span class='keyword'>sizeof</span>(PTR_BL))</td></tr>
<tr class="codeline" data-linenumber="4019"><td class="num" id="LN4019">4019</td><td class="line">							/ <span class='keyword'>sizeof</span>(PTR_EN) + 1);</td></tr>
<tr class="codeline" data-linenumber="4020"><td class="num" id="LN4020">4020</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4021"><td class="num" id="LN4021">4021</td><td class="line">    <span class='keyword'>return</span> hp;</td></tr>
<tr class="codeline" data-linenumber="4022"><td class="num" id="LN4022">4022</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4023"><td class="num" id="LN4023">4023</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4024"><td class="num" id="LN4024">4024</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4025"><td class="num" id="LN4025">4025</td><td class="line"> <span class='comment'>* Lookup line 'lnum' in a memline.</span></td></tr>
<tr class="codeline" data-linenumber="4026"><td class="num" id="LN4026">4026</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="4027"><td class="num" id="LN4027">4027</td><td class="line"> <span class='comment'>*   action: if ML_DELETE or ML_INSERT the line count is updated while searching</span></td></tr>
<tr class="codeline" data-linenumber="4028"><td class="num" id="LN4028">4028</td><td class="line"> <span class='comment'>*	     if ML_FLUSH only flush a locked block</span></td></tr>
<tr class="codeline" data-linenumber="4029"><td class="num" id="LN4029">4029</td><td class="line"> <span class='comment'>*	     if ML_FIND just find the line</span></td></tr>
<tr class="codeline" data-linenumber="4030"><td class="num" id="LN4030">4030</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="4031"><td class="num" id="LN4031">4031</td><td class="line"> <span class='comment'>* If the block was found it is locked and put in ml_locked.</span></td></tr>
<tr class="codeline" data-linenumber="4032"><td class="num" id="LN4032">4032</td><td class="line"> <span class='comment'>* The stack is updated to lead to the locked block. The ip_high field in</span></td></tr>
<tr class="codeline" data-linenumber="4033"><td class="num" id="LN4033">4033</td><td class="line"> <span class='comment'>* the stack is updated to reflect the last line in the block AFTER the</span></td></tr>
<tr class="codeline" data-linenumber="4034"><td class="num" id="LN4034">4034</td><td class="line"> <span class='comment'>* insert or delete, also if the pointer block has not been updated yet. But</span></td></tr>
<tr class="codeline" data-linenumber="4035"><td class="num" id="LN4035">4035</td><td class="line"> <span class='comment'>* if ml_locked != NULL ml_locked_lineadd must be added to ip_high.</span></td></tr>
<tr class="codeline" data-linenumber="4036"><td class="num" id="LN4036">4036</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="4037"><td class="num" id="LN4037">4037</td><td class="line"> <span class='comment'>* return: NULL for failure, pointer to block header otherwise</span></td></tr>
<tr class="codeline" data-linenumber="4038"><td class="num" id="LN4038">4038</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4039"><td class="num" id="LN4039">4039</td><td class="line">    <span class='keyword'>static</span> bhdr_T *</td></tr>
<tr class="codeline" data-linenumber="4040"><td class="num" id="LN4040">4040</td><td class="line">ml_find_line(buf_T *buf, linenr_T lnum, <span class='keyword'>int</span> action)</td></tr>
<tr class="codeline" data-linenumber="4041"><td class="num" id="LN4041">4041</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4042"><td class="num" id="LN4042">4042</td><td class="line">    DATA_BL	*dp;</td></tr>
<tr class="codeline" data-linenumber="4043"><td class="num" id="LN4043">4043</td><td class="line">    PTR_BL	*pp;</td></tr>
<tr class="codeline" data-linenumber="4044"><td class="num" id="LN4044">4044</td><td class="line">    infoptr_T	*ip;</td></tr>
<tr class="codeline" data-linenumber="4045"><td class="num" id="LN4045">4045</td><td class="line">    bhdr_T	*hp;</td></tr>
<tr class="codeline" data-linenumber="4046"><td class="num" id="LN4046">4046</td><td class="line">    memfile_T	*mfp;</td></tr>
<tr class="codeline" data-linenumber="4047"><td class="num" id="LN4047">4047</td><td class="line">    linenr_T	t;</td></tr>
<tr class="codeline" data-linenumber="4048"><td class="num" id="LN4048">4048</td><td class="line">    blocknr_T	bnum, bnum2;</td></tr>
<tr class="codeline" data-linenumber="4049"><td class="num" id="LN4049">4049</td><td class="line">    <span class='keyword'>int</span>		dirty;</td></tr>
<tr class="codeline" data-linenumber="4050"><td class="num" id="LN4050">4050</td><td class="line">    linenr_T	low, high;</td></tr>
<tr class="codeline" data-linenumber="4051"><td class="num" id="LN4051">4051</td><td class="line">    <span class='keyword'>int</span>		top;</td></tr>
<tr class="codeline" data-linenumber="4052"><td class="num" id="LN4052">4052</td><td class="line">    <span class='keyword'>int</span>		page_count;</td></tr>
<tr class="codeline" data-linenumber="4053"><td class="num" id="LN4053">4053</td><td class="line">    <span class='keyword'>int</span>		idx;</td></tr>
<tr class="codeline" data-linenumber="4054"><td class="num" id="LN4054">4054</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4055"><td class="num" id="LN4055">4055</td><td class="line">    mfp = buf-&gt;b_ml.ml_mfp;</td></tr>
<tr class="codeline" data-linenumber="4056"><td class="num" id="LN4056">4056</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4057"><td class="num" id="LN4057">4057</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4058"><td class="num" id="LN4058">4058</td><td class="line">     <span class='comment'>* If there is a locked block check if the wanted line is in it.</span></td></tr>
<tr class="codeline" data-linenumber="4059"><td class="num" id="LN4059">4059</td><td class="line">     <span class='comment'>* If not, flush and release the locked block.</span></td></tr>
<tr class="codeline" data-linenumber="4060"><td class="num" id="LN4060">4060</td><td class="line">     <span class='comment'>* Don't do this for ML_INSERT_SAME, because the stack need to be updated.</span></td></tr>
<tr class="codeline" data-linenumber="4061"><td class="num" id="LN4061">4061</td><td class="line">     <span class='comment'>* Don't do this for ML_FLUSH, because we want to flush the locked block.</span></td></tr>
<tr class="codeline" data-linenumber="4062"><td class="num" id="LN4062">4062</td><td class="line">     <span class='comment'>* Don't do this when 'swapfile' is reset, we want to load all the blocks.</span></td></tr>
<tr class="codeline" data-linenumber="4063"><td class="num" id="LN4063">4063</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4064"><td class="num" id="LN4064">4064</td><td class="line">    <span class='keyword'>if</span> (buf-&gt;b_ml.ml_locked)</td></tr>
<tr class="codeline" data-linenumber="4065"><td class="num" id="LN4065">4065</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="4066"><td class="num" id="LN4066">4066</td><td class="line">	<span class='keyword'>if</span> (<span class='macro'>ML_SIMPLE(action)<span class='macro_popup'>(action &amp; 0x10)</span></span></td></tr>
<tr class="codeline" data-linenumber="4067"><td class="num" id="LN4067">4067</td><td class="line">		&amp;&amp; buf-&gt;b_ml.ml_locked_low &lt;= lnum</td></tr>
<tr class="codeline" data-linenumber="4068"><td class="num" id="LN4068">4068</td><td class="line">		&amp;&amp; buf-&gt;b_ml.ml_locked_high &gt;= lnum</td></tr>
<tr class="codeline" data-linenumber="4069"><td class="num" id="LN4069">4069</td><td class="line">		&amp;&amp; !mf_dont_release)</td></tr>
<tr class="codeline" data-linenumber="4070"><td class="num" id="LN4070">4070</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="4071"><td class="num" id="LN4071">4071</td><td class="line">	    <span class='comment'>// remember to update pointer blocks and stack later</span></td></tr>
<tr class="codeline" data-linenumber="4072"><td class="num" id="LN4072">4072</td><td class="line">	    <span class='keyword'>if</span> (action == <span class='macro'>ML_INSERT<span class='macro_popup'>0x12</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4073"><td class="num" id="LN4073">4073</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="4074"><td class="num" id="LN4074">4074</td><td class="line">		++(buf-&gt;b_ml.ml_locked_lineadd);</td></tr>
<tr class="codeline" data-linenumber="4075"><td class="num" id="LN4075">4075</td><td class="line">		++(buf-&gt;b_ml.ml_locked_high);</td></tr>
<tr class="codeline" data-linenumber="4076"><td class="num" id="LN4076">4076</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="4077"><td class="num" id="LN4077">4077</td><td class="line">	    <span class='keyword'>else</span> <span class='keyword'>if</span> (action == <span class='macro'>ML_DELETE<span class='macro_popup'>0x11</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4078"><td class="num" id="LN4078">4078</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="4079"><td class="num" id="LN4079">4079</td><td class="line">		--(buf-&gt;b_ml.ml_locked_lineadd);</td></tr>
<tr class="codeline" data-linenumber="4080"><td class="num" id="LN4080">4080</td><td class="line">		--(buf-&gt;b_ml.ml_locked_high);</td></tr>
<tr class="codeline" data-linenumber="4081"><td class="num" id="LN4081">4081</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="4082"><td class="num" id="LN4082">4082</td><td class="line">	    <span class='keyword'>return</span> (buf-&gt;b_ml.ml_locked);</td></tr>
<tr class="codeline" data-linenumber="4083"><td class="num" id="LN4083">4083</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="4084"><td class="num" id="LN4084">4084</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4085"><td class="num" id="LN4085">4085</td><td class="line">	mf_put(mfp, buf-&gt;b_ml.ml_locked, buf-&gt;b_ml.ml_flags &amp; <span class='macro'>ML_LOCKED_DIRTY<span class='macro_popup'>4</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4086"><td class="num" id="LN4086">4086</td><td class="line">					    buf-&gt;b_ml.ml_flags &amp; <span class='macro'>ML_LOCKED_POS<span class='macro_popup'>8</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4087"><td class="num" id="LN4087">4087</td><td class="line">	buf-&gt;b_ml.ml_locked = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4088"><td class="num" id="LN4088">4088</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4089"><td class="num" id="LN4089">4089</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4090"><td class="num" id="LN4090">4090</td><td class="line">	 <span class='comment'>* If lines have been added or deleted in the locked block, need to</span></td></tr>
<tr class="codeline" data-linenumber="4091"><td class="num" id="LN4091">4091</td><td class="line">	 <span class='comment'>* update the line count in pointer blocks.</span></td></tr>
<tr class="codeline" data-linenumber="4092"><td class="num" id="LN4092">4092</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4093"><td class="num" id="LN4093">4093</td><td class="line">	<span class='keyword'>if</span> (buf-&gt;b_ml.ml_locked_lineadd != 0)</td></tr>
<tr class="codeline" data-linenumber="4094"><td class="num" id="LN4094">4094</td><td class="line">	    ml_lineadd(buf, buf-&gt;b_ml.ml_locked_lineadd);</td></tr>
<tr class="codeline" data-linenumber="4095"><td class="num" id="LN4095">4095</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4096"><td class="num" id="LN4096">4096</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4097"><td class="num" id="LN4097">4097</td><td class="line">    <span class='keyword'>if</span> (action == <span class='macro'>ML_FLUSH<span class='macro_popup'>0x02</span></span>)	    <span class='comment'>// nothing else to do</span></td></tr>
<tr class="codeline" data-linenumber="4098"><td class="num" id="LN4098">4098</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4099"><td class="num" id="LN4099">4099</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4100"><td class="num" id="LN4100">4100</td><td class="line">    bnum = 1;			    <span class='comment'>// start at the root of the tree</span></td></tr>
<tr class="codeline" data-linenumber="4101"><td class="num" id="LN4101">4101</td><td class="line">    page_count = 1;</td></tr>
<tr class="codeline" data-linenumber="4102"><td class="num" id="LN4102">4102</td><td class="line">    low = 1;</td></tr>
<tr class="codeline" data-linenumber="4103"><td class="num" id="LN4103">4103</td><td class="line">    high = buf-&gt;b_ml.ml_line_count;</td></tr>
<tr class="codeline" data-linenumber="4104"><td class="num" id="LN4104">4104</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4105"><td class="num" id="LN4105">4105</td><td class="line">    <span class='keyword'>if</span> (action == <span class='macro'>ML_FIND<span class='macro_popup'>0x13</span></span>)	<span class='comment'>// first try stack entries</span></td></tr>
<tr class="codeline" data-linenumber="4106"><td class="num" id="LN4106">4106</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="4107"><td class="num" id="LN4107">4107</td><td class="line">	<span class='keyword'>for</span> (top = buf-&gt;b_ml.ml_stack_top - 1; top &gt;= 0; --top)</td></tr>
<tr class="codeline" data-linenumber="4108"><td class="num" id="LN4108">4108</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="4109"><td class="num" id="LN4109">4109</td><td class="line">	    ip = &amp;(buf-&gt;b_ml.ml_stack[top]);</td></tr>
<tr class="codeline" data-linenumber="4110"><td class="num" id="LN4110">4110</td><td class="line">	    <span class='keyword'>if</span> (ip-&gt;ip_low &lt;= lnum &amp;&amp; ip-&gt;ip_high &gt;= lnum)</td></tr>
<tr class="codeline" data-linenumber="4111"><td class="num" id="LN4111">4111</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="4112"><td class="num" id="LN4112">4112</td><td class="line">		bnum = ip-&gt;ip_bnum;</td></tr>
<tr class="codeline" data-linenumber="4113"><td class="num" id="LN4113">4113</td><td class="line">		low = ip-&gt;ip_low;</td></tr>
<tr class="codeline" data-linenumber="4114"><td class="num" id="LN4114">4114</td><td class="line">		high = ip-&gt;ip_high;</td></tr>
<tr class="codeline" data-linenumber="4115"><td class="num" id="LN4115">4115</td><td class="line">		buf-&gt;b_ml.ml_stack_top = top;	<span class='comment'>// truncate stack at prev entry</span></td></tr>
<tr class="codeline" data-linenumber="4116"><td class="num" id="LN4116">4116</td><td class="line">		<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4117"><td class="num" id="LN4117">4117</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="4118"><td class="num" id="LN4118">4118</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="4119"><td class="num" id="LN4119">4119</td><td class="line">	<span class='keyword'>if</span> (top &lt; 0)</td></tr>
<tr class="codeline" data-linenumber="4120"><td class="num" id="LN4120">4120</td><td class="line">	    buf-&gt;b_ml.ml_stack_top = 0;		<span class='comment'>// not found, start at the root</span></td></tr>
<tr class="codeline" data-linenumber="4121"><td class="num" id="LN4121">4121</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4122"><td class="num" id="LN4122">4122</td><td class="line">    <span class='keyword'>else</span>	<span class='comment'>// ML_DELETE or ML_INSERT</span></td></tr>
<tr class="codeline" data-linenumber="4123"><td class="num" id="LN4123">4123</td><td class="line">	buf-&gt;b_ml.ml_stack_top = 0;	<span class='comment'>// start at the root</span></td></tr>
<tr class="codeline" data-linenumber="4124"><td class="num" id="LN4124">4124</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4125"><td class="num" id="LN4125">4125</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4126"><td class="num" id="LN4126">4126</td><td class="line"> <span class='comment'>* search downwards in the tree until a data block is found</span></td></tr>
<tr class="codeline" data-linenumber="4127"><td class="num" id="LN4127">4127</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4128"><td class="num" id="LN4128">4128</td><td class="line">    <span class='keyword'>for</span> (;;)</td></tr>
<tr class="codeline" data-linenumber="4129"><td class="num" id="LN4129">4129</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="4130"><td class="num" id="LN4130">4130</td><td class="line">	<span class='keyword'>if</span> ((hp = mf_get(mfp, bnum, page_count)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4131"><td class="num" id="LN4131">4131</td><td class="line">	    <span class='keyword'>goto</span> error_noblock;</td></tr>
<tr class="codeline" data-linenumber="4132"><td class="num" id="LN4132">4132</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4133"><td class="num" id="LN4133">4133</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4134"><td class="num" id="LN4134">4134</td><td class="line">	 <span class='comment'>* update high for insert/delete</span></td></tr>
<tr class="codeline" data-linenumber="4135"><td class="num" id="LN4135">4135</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4136"><td class="num" id="LN4136">4136</td><td class="line">	<span class='keyword'>if</span> (action == <span class='macro'>ML_INSERT<span class='macro_popup'>0x12</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4137"><td class="num" id="LN4137">4137</td><td class="line">	    ++high;</td></tr>
<tr class="codeline" data-linenumber="4138"><td class="num" id="LN4138">4138</td><td class="line">	<span class='keyword'>else</span> <span class='keyword'>if</span> (action == <span class='macro'>ML_DELETE<span class='macro_popup'>0x11</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4139"><td class="num" id="LN4139">4139</td><td class="line">	    --high;</td></tr>
<tr class="codeline" data-linenumber="4140"><td class="num" id="LN4140">4140</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4141"><td class="num" id="LN4141">4141</td><td class="line">	dp = (DATA_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="4142"><td class="num" id="LN4142">4142</td><td class="line">	<span class='keyword'>if</span> (dp-&gt;db_id == <span class='macro'>DATA_ID<span class='macro_popup'>(('d' &lt;&lt; 8) + 'a')</span></span>)	<span class='comment'>// data block</span></td></tr>
<tr class="codeline" data-linenumber="4143"><td class="num" id="LN4143">4143</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="4144"><td class="num" id="LN4144">4144</td><td class="line">	    buf-&gt;b_ml.ml_locked = hp;</td></tr>
<tr class="codeline" data-linenumber="4145"><td class="num" id="LN4145">4145</td><td class="line">	    buf-&gt;b_ml.ml_locked_low = low;</td></tr>
<tr class="codeline" data-linenumber="4146"><td class="num" id="LN4146">4146</td><td class="line">	    buf-&gt;b_ml.ml_locked_high = high;</td></tr>
<tr class="codeline" data-linenumber="4147"><td class="num" id="LN4147">4147</td><td class="line">	    buf-&gt;b_ml.ml_locked_lineadd = 0;</td></tr>
<tr class="codeline" data-linenumber="4148"><td class="num" id="LN4148">4148</td><td class="line">	    buf-&gt;b_ml.ml_flags &amp;= ~(<span class='macro'>ML_LOCKED_DIRTY<span class='macro_popup'>4</span></span> | <span class='macro'>ML_LOCKED_POS<span class='macro_popup'>8</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4149"><td class="num" id="LN4149">4149</td><td class="line">	    <span class='keyword'>return</span> hp;</td></tr>
<tr class="codeline" data-linenumber="4150"><td class="num" id="LN4150">4150</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="4151"><td class="num" id="LN4151">4151</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4152"><td class="num" id="LN4152">4152</td><td class="line">	pp = (PTR_BL *)(dp);		<span class='comment'>// must be pointer block</span></td></tr>
<tr class="codeline" data-linenumber="4153"><td class="num" id="LN4153">4153</td><td class="line">	<span class='keyword'>if</span> (pp-&gt;pb_id != <span class='macro'>PTR_ID<span class='macro_popup'>(('p' &lt;&lt; 8) + 't')</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4154"><td class="num" id="LN4154">4154</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="4155"><td class="num" id="LN4155">4155</td><td class="line">	    iemsg(<span class='macro'>_(<span class='string_literal'>"E317: pointer block id wrong"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E317: pointer block id wrong"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4156"><td class="num" id="LN4156">4156</td><td class="line">	    <span class='keyword'>goto</span> error_block;</td></tr>
<tr class="codeline" data-linenumber="4157"><td class="num" id="LN4157">4157</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="4158"><td class="num" id="LN4158">4158</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4159"><td class="num" id="LN4159">4159</td><td class="line">	<span class='keyword'>if</span> ((top = ml_add_stack(buf)) &lt; 0)	<span class='comment'>// add new entry to stack</span></td></tr>
<tr class="codeline" data-linenumber="4160"><td class="num" id="LN4160">4160</td><td class="line">	    <span class='keyword'>goto</span> error_block;</td></tr>
<tr class="codeline" data-linenumber="4161"><td class="num" id="LN4161">4161</td><td class="line">	ip = &amp;(buf-&gt;b_ml.ml_stack[top]);</td></tr>
<tr class="codeline" data-linenumber="4162"><td class="num" id="LN4162">4162</td><td class="line">	ip-&gt;ip_bnum = bnum;</td></tr>
<tr class="codeline" data-linenumber="4163"><td class="num" id="LN4163">4163</td><td class="line">	ip-&gt;ip_low = low;</td></tr>
<tr class="codeline" data-linenumber="4164"><td class="num" id="LN4164">4164</td><td class="line">	ip-&gt;ip_high = high;</td></tr>
<tr class="codeline" data-linenumber="4165"><td class="num" id="LN4165">4165</td><td class="line">	ip-&gt;ip_index = -1;		<span class='comment'>// index not known yet</span></td></tr>
<tr class="codeline" data-linenumber="4166"><td class="num" id="LN4166">4166</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4167"><td class="num" id="LN4167">4167</td><td class="line">	dirty = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4168"><td class="num" id="LN4168">4168</td><td class="line">	<span class='keyword'>for</span> (idx = 0; idx &lt; (<span class='keyword'>int</span>)pp-&gt;pb_count; ++idx)</td></tr>
<tr class="codeline" data-linenumber="4169"><td class="num" id="LN4169">4169</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="4170"><td class="num" id="LN4170">4170</td><td class="line">	    t = pp-&gt;pb_pointer[idx].pe_line_count;</td></tr>
<tr class="codeline" data-linenumber="4171"><td class="num" id="LN4171">4171</td><td class="line">	    <span class='macro'>CHECK(t == 0, _(<span class='string_literal'>"pe_line_count is zero"</span>))<span class='macro_popup'>do { } while (0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4172"><td class="num" id="LN4172">4172</td><td class="line">	    <span class='keyword'>if</span> ((low += t) &gt; lnum)</td></tr>
<tr class="codeline" data-linenumber="4173"><td class="num" id="LN4173">4173</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="4174"><td class="num" id="LN4174">4174</td><td class="line">		ip-&gt;ip_index = idx;</td></tr>
<tr class="codeline" data-linenumber="4175"><td class="num" id="LN4175">4175</td><td class="line">		bnum = pp-&gt;pb_pointer[idx].pe_bnum;</td></tr>
<tr class="codeline" data-linenumber="4176"><td class="num" id="LN4176">4176</td><td class="line">		page_count = pp-&gt;pb_pointer[idx].pe_page_count;</td></tr>
<tr class="codeline" data-linenumber="4177"><td class="num" id="LN4177">4177</td><td class="line">		high = low - 1;</td></tr>
<tr class="codeline" data-linenumber="4178"><td class="num" id="LN4178">4178</td><td class="line">		low -= t;</td></tr>
<tr class="codeline" data-linenumber="4179"><td class="num" id="LN4179">4179</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4180"><td class="num" id="LN4180">4180</td><td class="line">		<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4181"><td class="num" id="LN4181">4181</td><td class="line">		 <span class='comment'>* a negative block number may have been changed</span></td></tr>
<tr class="codeline" data-linenumber="4182"><td class="num" id="LN4182">4182</td><td class="line">		 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4183"><td class="num" id="LN4183">4183</td><td class="line">		<span class='keyword'>if</span> (bnum &lt; 0)</td></tr>
<tr class="codeline" data-linenumber="4184"><td class="num" id="LN4184">4184</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="4185"><td class="num" id="LN4185">4185</td><td class="line">		    bnum2 = mf_trans_del(mfp, bnum);</td></tr>
<tr class="codeline" data-linenumber="4186"><td class="num" id="LN4186">4186</td><td class="line">		    <span class='keyword'>if</span> (bnum != bnum2)</td></tr>
<tr class="codeline" data-linenumber="4187"><td class="num" id="LN4187">4187</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="4188"><td class="num" id="LN4188">4188</td><td class="line">			bnum = bnum2;</td></tr>
<tr class="codeline" data-linenumber="4189"><td class="num" id="LN4189">4189</td><td class="line">			pp-&gt;pb_pointer[idx].pe_bnum = bnum;</td></tr>
<tr class="codeline" data-linenumber="4190"><td class="num" id="LN4190">4190</td><td class="line">			dirty = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4191"><td class="num" id="LN4191">4191</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="4192"><td class="num" id="LN4192">4192</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="4193"><td class="num" id="LN4193">4193</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4194"><td class="num" id="LN4194">4194</td><td class="line">		<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4195"><td class="num" id="LN4195">4195</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="4196"><td class="num" id="LN4196">4196</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="4197"><td class="num" id="LN4197">4197</td><td class="line">	<span class='keyword'>if</span> (idx &gt;= (<span class='keyword'>int</span>)pp-&gt;pb_count)	    <span class='comment'>// past the end: something wrong!</span></td></tr>
<tr class="codeline" data-linenumber="4198"><td class="num" id="LN4198">4198</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="4199"><td class="num" id="LN4199">4199</td><td class="line">	    <span class='keyword'>if</span> (lnum &gt; buf-&gt;b_ml.ml_line_count)</td></tr>
<tr class="codeline" data-linenumber="4200"><td class="num" id="LN4200">4200</td><td class="line">		siemsg(<span class='macro'>_(<span class='string_literal'>"E322: line number out of range: %ld past the end"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E322: line number out of range: %ld past the end"<br>), 5)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4201"><td class="num" id="LN4201">4201</td><td class="line">					      lnum - buf-&gt;b_ml.ml_line_count);</td></tr>
<tr class="codeline" data-linenumber="4202"><td class="num" id="LN4202">4202</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4203"><td class="num" id="LN4203">4203</td><td class="line">	    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="4204"><td class="num" id="LN4204">4204</td><td class="line">		siemsg(<span class='macro'>_(<span class='string_literal'>"E323: line count wrong in block %ld"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E323: line count wrong in block %ld"<br>), 5)</span></span>, bnum);</td></tr>
<tr class="codeline" data-linenumber="4205"><td class="num" id="LN4205">4205</td><td class="line">	    <span class='keyword'>goto</span> error_block;</td></tr>
<tr class="codeline" data-linenumber="4206"><td class="num" id="LN4206">4206</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="4207"><td class="num" id="LN4207">4207</td><td class="line">	<span class='keyword'>if</span> (action == <span class='macro'>ML_DELETE<span class='macro_popup'>0x11</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4208"><td class="num" id="LN4208">4208</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="4209"><td class="num" id="LN4209">4209</td><td class="line">	    pp-&gt;pb_pointer[idx].pe_line_count--;</td></tr>
<tr class="codeline" data-linenumber="4210"><td class="num" id="LN4210">4210</td><td class="line">	    dirty = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4211"><td class="num" id="LN4211">4211</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="4212"><td class="num" id="LN4212">4212</td><td class="line">	<span class='keyword'>else</span> <span class='keyword'>if</span> (action == <span class='macro'>ML_INSERT<span class='macro_popup'>0x12</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4213"><td class="num" id="LN4213">4213</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="4214"><td class="num" id="LN4214">4214</td><td class="line">	    pp-&gt;pb_pointer[idx].pe_line_count++;</td></tr>
<tr class="codeline" data-linenumber="4215"><td class="num" id="LN4215">4215</td><td class="line">	    dirty = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4216"><td class="num" id="LN4216">4216</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="4217"><td class="num" id="LN4217">4217</td><td class="line">	mf_put(mfp, hp, dirty, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4218"><td class="num" id="LN4218">4218</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4219"><td class="num" id="LN4219">4219</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4220"><td class="num" id="LN4220">4220</td><td class="line">error_block:</td></tr>
<tr class="codeline" data-linenumber="4221"><td class="num" id="LN4221">4221</td><td class="line">    mf_put(mfp, hp, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4222"><td class="num" id="LN4222">4222</td><td class="line">error_noblock:</td></tr>
<tr class="codeline" data-linenumber="4223"><td class="num" id="LN4223">4223</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4224"><td class="num" id="LN4224">4224</td><td class="line">     <span class='comment'>* If action is ML_DELETE or ML_INSERT we have to correct the tree for</span></td></tr>
<tr class="codeline" data-linenumber="4225"><td class="num" id="LN4225">4225</td><td class="line">     <span class='comment'>* the incremented/decremented line counts, because there won't be a line</span></td></tr>
<tr class="codeline" data-linenumber="4226"><td class="num" id="LN4226">4226</td><td class="line">     <span class='comment'>* inserted/deleted after all.</span></td></tr>
<tr class="codeline" data-linenumber="4227"><td class="num" id="LN4227">4227</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4228"><td class="num" id="LN4228">4228</td><td class="line">    <span class='keyword'>if</span> (action == <span class='macro'>ML_DELETE<span class='macro_popup'>0x11</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4229"><td class="num" id="LN4229">4229</td><td class="line">	ml_lineadd(buf, 1);</td></tr>
<tr class="codeline" data-linenumber="4230"><td class="num" id="LN4230">4230</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (action == <span class='macro'>ML_INSERT<span class='macro_popup'>0x12</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4231"><td class="num" id="LN4231">4231</td><td class="line">	ml_lineadd(buf, -1);</td></tr>
<tr class="codeline" data-linenumber="4232"><td class="num" id="LN4232">4232</td><td class="line">    buf-&gt;b_ml.ml_stack_top = 0;</td></tr>
<tr class="codeline" data-linenumber="4233"><td class="num" id="LN4233">4233</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4234"><td class="num" id="LN4234">4234</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4235"><td class="num" id="LN4235">4235</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4236"><td class="num" id="LN4236">4236</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4237"><td class="num" id="LN4237">4237</td><td class="line"> <span class='comment'>* add an entry to the info pointer stack</span></td></tr>
<tr class="codeline" data-linenumber="4238"><td class="num" id="LN4238">4238</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="4239"><td class="num" id="LN4239">4239</td><td class="line"> <span class='comment'>* return -1 for failure, number of the new entry otherwise</span></td></tr>
<tr class="codeline" data-linenumber="4240"><td class="num" id="LN4240">4240</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4241"><td class="num" id="LN4241">4241</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="4242"><td class="num" id="LN4242">4242</td><td class="line">ml_add_stack(buf_T *buf)</td></tr>
<tr class="codeline" data-linenumber="4243"><td class="num" id="LN4243">4243</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4244"><td class="num" id="LN4244">4244</td><td class="line">    <span class='keyword'>int</span>		top;</td></tr>
<tr class="codeline" data-linenumber="4245"><td class="num" id="LN4245">4245</td><td class="line">    infoptr_T	*newstack;</td></tr>
<tr class="codeline" data-linenumber="4246"><td class="num" id="LN4246">4246</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4247"><td class="num" id="LN4247">4247</td><td class="line">    top = buf-&gt;b_ml.ml_stack_top;</td></tr>
<tr class="codeline" data-linenumber="4248"><td class="num" id="LN4248">4248</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4249"><td class="num" id="LN4249">4249</td><td class="line">    <span class='comment'>// may have to increase the stack size</span></td></tr>
<tr class="codeline" data-linenumber="4250"><td class="num" id="LN4250">4250</td><td class="line">    <span class='keyword'>if</span> (top == buf-&gt;b_ml.ml_stack_size)</td></tr>
<tr class="codeline" data-linenumber="4251"><td class="num" id="LN4251">4251</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="4252"><td class="num" id="LN4252">4252</td><td class="line">	<span class='macro'>CHECK(top &gt; 0, _(<span class='string_literal'>"Stack size increases"</span>))<span class='macro_popup'>do { } while (0)</span></span>; <span class='comment'>// more than 5 levels???</span></td></tr>
<tr class="codeline" data-linenumber="4253"><td class="num" id="LN4253">4253</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4254"><td class="num" id="LN4254">4254</td><td class="line">	newstack = <span class='macro'>ALLOC_MULT(infoptr_T, buf-&gt;b_ml.ml_stack_size + STACK_INCR)<span class='macro_popup'>(infoptr_T *)alloc(sizeof(infoptr_T) * (buf-&gt;b_ml.ml_stack_size<br> + 5))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4255"><td class="num" id="LN4255">4255</td><td class="line">	<span class='keyword'>if</span> (newstack == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4256"><td class="num" id="LN4256">4256</td><td class="line">	    <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="4257"><td class="num" id="LN4257">4257</td><td class="line">	<span class='keyword'>if</span> (top &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="4258"><td class="num" id="LN4258">4258</td><td class="line">	    <span class='macro'>mch_memmove(newstack, buf-&gt;b_ml.ml_stack,<span class='macro_popup'>memmove((char *)(newstack), (char *)(buf-&gt;b_ml.ml_stack), (<br>size_t)top * sizeof(infoptr_T))</span></span></td></tr>
<tr class="codeline" data-linenumber="4259"><td class="num" id="LN4259">4259</td><td class="line">					     <span class='macro'>(size_t)top * <span class='keyword'>sizeof</span>(infoptr_T))<span class='macro_popup'>memmove((char *)(newstack), (char *)(buf-&gt;b_ml.ml_stack), (<br>size_t)top * sizeof(infoptr_T))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4260"><td class="num" id="LN4260">4260</td><td class="line">	vim_free(buf-&gt;b_ml.ml_stack);</td></tr>
<tr class="codeline" data-linenumber="4261"><td class="num" id="LN4261">4261</td><td class="line">	buf-&gt;b_ml.ml_stack = newstack;</td></tr>
<tr class="codeline" data-linenumber="4262"><td class="num" id="LN4262">4262</td><td class="line">	buf-&gt;b_ml.ml_stack_size += <span class='macro'>STACK_INCR<span class='macro_popup'>5</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4263"><td class="num" id="LN4263">4263</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4264"><td class="num" id="LN4264">4264</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4265"><td class="num" id="LN4265">4265</td><td class="line">    buf-&gt;b_ml.ml_stack_top++;</td></tr>
<tr class="codeline" data-linenumber="4266"><td class="num" id="LN4266">4266</td><td class="line">    <span class='keyword'>return</span> top;</td></tr>
<tr class="codeline" data-linenumber="4267"><td class="num" id="LN4267">4267</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4268"><td class="num" id="LN4268">4268</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4269"><td class="num" id="LN4269">4269</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4270"><td class="num" id="LN4270">4270</td><td class="line"> <span class='comment'>* Update the pointer blocks on the stack for inserted/deleted lines.</span></td></tr>
<tr class="codeline" data-linenumber="4271"><td class="num" id="LN4271">4271</td><td class="line"> <span class='comment'>* The stack itself is also updated.</span></td></tr>
<tr class="codeline" data-linenumber="4272"><td class="num" id="LN4272">4272</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="4273"><td class="num" id="LN4273">4273</td><td class="line"> <span class='comment'>* When a insert/delete line action fails, the line is not inserted/deleted,</span></td></tr>
<tr class="codeline" data-linenumber="4274"><td class="num" id="LN4274">4274</td><td class="line"> <span class='comment'>* but the pointer blocks have already been updated. That is fixed here by</span></td></tr>
<tr class="codeline" data-linenumber="4275"><td class="num" id="LN4275">4275</td><td class="line"> <span class='comment'>* walking through the stack.</span></td></tr>
<tr class="codeline" data-linenumber="4276"><td class="num" id="LN4276">4276</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="4277"><td class="num" id="LN4277">4277</td><td class="line"> <span class='comment'>* Count is the number of lines added, negative if lines have been deleted.</span></td></tr>
<tr class="codeline" data-linenumber="4278"><td class="num" id="LN4278">4278</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4279"><td class="num" id="LN4279">4279</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="4280"><td class="num" id="LN4280">4280</td><td class="line">ml_lineadd(buf_T *buf, <span class='keyword'>int</span> count)</td></tr>
<tr class="codeline" data-linenumber="4281"><td class="num" id="LN4281">4281</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4282"><td class="num" id="LN4282">4282</td><td class="line">    <span class='keyword'>int</span>		idx;</td></tr>
<tr class="codeline" data-linenumber="4283"><td class="num" id="LN4283">4283</td><td class="line">    infoptr_T	*ip;</td></tr>
<tr class="codeline" data-linenumber="4284"><td class="num" id="LN4284">4284</td><td class="line">    PTR_BL	*pp;</td></tr>
<tr class="codeline" data-linenumber="4285"><td class="num" id="LN4285">4285</td><td class="line">    memfile_T	*mfp = buf-&gt;b_ml.ml_mfp;</td></tr>
<tr class="codeline" data-linenumber="4286"><td class="num" id="LN4286">4286</td><td class="line">    bhdr_T	*hp;</td></tr>
<tr class="codeline" data-linenumber="4287"><td class="num" id="LN4287">4287</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4288"><td class="num" id="LN4288">4288</td><td class="line">    <span class='keyword'>for</span> (idx = buf-&gt;b_ml.ml_stack_top - 1; idx &gt;= 0; --idx)</td></tr>
<tr class="codeline" data-linenumber="4289"><td class="num" id="LN4289">4289</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="4290"><td class="num" id="LN4290">4290</td><td class="line">	ip = &amp;(buf-&gt;b_ml.ml_stack[idx]);</td></tr>
<tr class="codeline" data-linenumber="4291"><td class="num" id="LN4291">4291</td><td class="line">	<span class='keyword'>if</span> ((hp = mf_get(mfp, ip-&gt;ip_bnum, 1)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4292"><td class="num" id="LN4292">4292</td><td class="line">	    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4293"><td class="num" id="LN4293">4293</td><td class="line">	pp = (PTR_BL *)(hp-&gt;bh_data);	<span class='comment'>// must be pointer block</span></td></tr>
<tr class="codeline" data-linenumber="4294"><td class="num" id="LN4294">4294</td><td class="line">	<span class='keyword'>if</span> (pp-&gt;pb_id != <span class='macro'>PTR_ID<span class='macro_popup'>(('p' &lt;&lt; 8) + 't')</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4295"><td class="num" id="LN4295">4295</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="4296"><td class="num" id="LN4296">4296</td><td class="line">	    mf_put(mfp, hp, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4297"><td class="num" id="LN4297">4297</td><td class="line">	    iemsg(<span class='macro'>_(<span class='string_literal'>"E317: pointer block id wrong 2"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E317: pointer block id wrong 2"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4298"><td class="num" id="LN4298">4298</td><td class="line">	    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4299"><td class="num" id="LN4299">4299</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="4300"><td class="num" id="LN4300">4300</td><td class="line">	pp-&gt;pb_pointer[ip-&gt;ip_index].pe_line_count += count;</td></tr>
<tr class="codeline" data-linenumber="4301"><td class="num" id="LN4301">4301</td><td class="line">	ip-&gt;ip_high += count;</td></tr>
<tr class="codeline" data-linenumber="4302"><td class="num" id="LN4302">4302</td><td class="line">	mf_put(mfp, hp, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4303"><td class="num" id="LN4303">4303</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4304"><td class="num" id="LN4304">4304</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4305"><td class="num" id="LN4305">4305</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4306"><td class="num" id="LN4306">4306</td><td class="line"><span class='directive'>#if defined(<span class='macro'>HAVE_READLINK<span class='macro_popup'>1</span></span>) || defined(PROTO)</span></td></tr>
<tr class="codeline" data-linenumber="4307"><td class="num" id="LN4307">4307</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4308"><td class="num" id="LN4308">4308</td><td class="line"> <span class='comment'>* Resolve a symlink in the last component of a file name.</span></td></tr>
<tr class="codeline" data-linenumber="4309"><td class="num" id="LN4309">4309</td><td class="line"> <span class='comment'>* Note that f_resolve() does it for every part of the path, we don't do that</span></td></tr>
<tr class="codeline" data-linenumber="4310"><td class="num" id="LN4310">4310</td><td class="line"> <span class='comment'>* here.</span></td></tr>
<tr class="codeline" data-linenumber="4311"><td class="num" id="LN4311">4311</td><td class="line"> <span class='comment'>* If it worked returns OK and the resolved link in "buf[MAXPATHL]".</span></td></tr>
<tr class="codeline" data-linenumber="4312"><td class="num" id="LN4312">4312</td><td class="line"> <span class='comment'>* Otherwise returns FAIL.</span></td></tr>
<tr class="codeline" data-linenumber="4313"><td class="num" id="LN4313">4313</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4314"><td class="num" id="LN4314">4314</td><td class="line">    <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="4315"><td class="num" id="LN4315">4315</td><td class="line">resolve_symlink(char_u *fname, char_u *buf)</td></tr>
<tr class="codeline" data-linenumber="4316"><td class="num" id="LN4316">4316</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4317"><td class="num" id="LN4317">4317</td><td class="line">    char_u	tmp[<span class='macro'>MAXPATHL<span class='macro_popup'>4096</span></span>];</td></tr>
<tr class="codeline" data-linenumber="4318"><td class="num" id="LN4318">4318</td><td class="line">    <span class='keyword'>int</span>		ret;</td></tr>
<tr class="codeline" data-linenumber="4319"><td class="num" id="LN4319">4319</td><td class="line">    <span class='keyword'>int</span>		depth = 0;</td></tr>
<tr class="codeline" data-linenumber="4320"><td class="num" id="LN4320">4320</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4321"><td class="num" id="LN4321">4321</td><td class="line">    <span class='keyword'>if</span> (fname == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4322"><td class="num" id="LN4322">4322</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>FAIL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4323"><td class="num" id="LN4323">4323</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4324"><td class="num" id="LN4324">4324</td><td class="line">    <span class='comment'>// Put the result so far in tmp[], starting with the original name.</span></td></tr>
<tr class="codeline" data-linenumber="4325"><td class="num" id="LN4325">4325</td><td class="line">    vim_strncpy(tmp, fname, <span class='macro'>MAXPATHL<span class='macro_popup'>4096</span></span> - 1);</td></tr>
<tr class="codeline" data-linenumber="4326"><td class="num" id="LN4326">4326</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4327"><td class="num" id="LN4327">4327</td><td class="line">    <span class='keyword'>for</span> (;;)</td></tr>
<tr class="codeline" data-linenumber="4328"><td class="num" id="LN4328">4328</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="4329"><td class="num" id="LN4329">4329</td><td class="line">	<span class='comment'>// Limit symlink depth to 100, catch recursive loops.</span></td></tr>
<tr class="codeline" data-linenumber="4330"><td class="num" id="LN4330">4330</td><td class="line">	<span class='keyword'>if</span> (++depth == 100)</td></tr>
<tr class="codeline" data-linenumber="4331"><td class="num" id="LN4331">4331</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="4332"><td class="num" id="LN4332">4332</td><td class="line">	    semsg(<span class='macro'>_(<span class='string_literal'>"E773: Symlink loop for \"%s\""</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E773: Symlink loop for \"%s\""<br>), 5)</span></span>, fname);</td></tr>
<tr class="codeline" data-linenumber="4333"><td class="num" id="LN4333">4333</td><td class="line">	    <span class='keyword'>return</span> <span class='macro'>FAIL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4334"><td class="num" id="LN4334">4334</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="4335"><td class="num" id="LN4335">4335</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4336"><td class="num" id="LN4336">4336</td><td class="line">	ret = readlink((<span class='keyword'>char</span> *)tmp, (<span class='keyword'>char</span> *)buf, <span class='macro'>MAXPATHL<span class='macro_popup'>4096</span></span> - 1);</td></tr>
<tr class="codeline" data-linenumber="4337"><td class="num" id="LN4337">4337</td><td class="line">	<span class='keyword'>if</span> (ret &lt;= 0)</td></tr>
<tr class="codeline" data-linenumber="4338"><td class="num" id="LN4338">4338</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="4339"><td class="num" id="LN4339">4339</td><td class="line">	    <span class='keyword'>if</span> (<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> == <span class='macro'>EINVAL<span class='macro_popup'>22</span></span> || <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> == <span class='macro'>ENOENT<span class='macro_popup'>2</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4340"><td class="num" id="LN4340">4340</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="4341"><td class="num" id="LN4341">4341</td><td class="line">		<span class='comment'>// Found non-symlink or not existing file, stop here.</span></td></tr>
<tr class="codeline" data-linenumber="4342"><td class="num" id="LN4342">4342</td><td class="line">		<span class='comment'>// When at the first level use the unmodified name, skip the</span></td></tr>
<tr class="codeline" data-linenumber="4343"><td class="num" id="LN4343">4343</td><td class="line">		<span class='comment'>// call to vim_FullName().</span></td></tr>
<tr class="codeline" data-linenumber="4344"><td class="num" id="LN4344">4344</td><td class="line">		<span class='keyword'>if</span> (depth == 1)</td></tr>
<tr class="codeline" data-linenumber="4345"><td class="num" id="LN4345">4345</td><td class="line">		    <span class='keyword'>return</span> <span class='macro'>FAIL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4346"><td class="num" id="LN4346">4346</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4347"><td class="num" id="LN4347">4347</td><td class="line">		<span class='comment'>// Use the resolved name in tmp[].</span></td></tr>
<tr class="codeline" data-linenumber="4348"><td class="num" id="LN4348">4348</td><td class="line">		<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4349"><td class="num" id="LN4349">4349</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="4350"><td class="num" id="LN4350">4350</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4351"><td class="num" id="LN4351">4351</td><td class="line">	    <span class='comment'>// There must be some error reading links, use original name.</span></td></tr>
<tr class="codeline" data-linenumber="4352"><td class="num" id="LN4352">4352</td><td class="line">	    <span class='keyword'>return</span> <span class='macro'>FAIL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4353"><td class="num" id="LN4353">4353</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="4354"><td class="num" id="LN4354">4354</td><td class="line">	buf[ret] = <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4355"><td class="num" id="LN4355">4355</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4356"><td class="num" id="LN4356">4356</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4357"><td class="num" id="LN4357">4357</td><td class="line">	 <span class='comment'>* Check whether the symlink is relative or absolute.</span></td></tr>
<tr class="codeline" data-linenumber="4358"><td class="num" id="LN4358">4358</td><td class="line">	 <span class='comment'>* If it's relative, build a new path based on the directory</span></td></tr>
<tr class="codeline" data-linenumber="4359"><td class="num" id="LN4359">4359</td><td class="line">	 <span class='comment'>* portion of the filename (if any) and the path the symlink</span></td></tr>
<tr class="codeline" data-linenumber="4360"><td class="num" id="LN4360">4360</td><td class="line">	 <span class='comment'>* points to.</span></td></tr>
<tr class="codeline" data-linenumber="4361"><td class="num" id="LN4361">4361</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4362"><td class="num" id="LN4362">4362</td><td class="line">	<span class='keyword'>if</span> (mch_isFullName(buf))</td></tr>
<tr class="codeline" data-linenumber="4363"><td class="num" id="LN4363">4363</td><td class="line">	    <span class='macro'>STRCPY(tmp, buf)<span class='macro_popup'>strcpy((char *)(tmp), (char *)(buf))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4364"><td class="num" id="LN4364">4364</td><td class="line">	<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="4365"><td class="num" id="LN4365">4365</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="4366"><td class="num" id="LN4366">4366</td><td class="line">	    char_u *tail;</td></tr>
<tr class="codeline" data-linenumber="4367"><td class="num" id="LN4367">4367</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4368"><td class="num" id="LN4368">4368</td><td class="line">	    tail = gettail(tmp);</td></tr>
<tr class="codeline" data-linenumber="4369"><td class="num" id="LN4369">4369</td><td class="line">	    <span class='keyword'>if</span> (<span class='macro'>STRLEN(tail)<span class='macro_popup'>strlen((char *)(tail))</span></span> + <span class='macro'>STRLEN(buf)<span class='macro_popup'>strlen((char *)(buf))</span></span> &gt;= <span class='macro'>MAXPATHL<span class='macro_popup'>4096</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4370"><td class="num" id="LN4370">4370</td><td class="line">		<span class='keyword'>return</span> <span class='macro'>FAIL<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4371"><td class="num" id="LN4371">4371</td><td class="line">	    <span class='macro'>STRCPY(tail, buf)<span class='macro_popup'>strcpy((char *)(tail), (char *)(buf))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4372"><td class="num" id="LN4372">4372</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="4373"><td class="num" id="LN4373">4373</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4374"><td class="num" id="LN4374">4374</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4375"><td class="num" id="LN4375">4375</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4376"><td class="num" id="LN4376">4376</td><td class="line">     <span class='comment'>* Try to resolve the full name of the file so that the swapfile name will</span></td></tr>
<tr class="codeline" data-linenumber="4377"><td class="num" id="LN4377">4377</td><td class="line">     <span class='comment'>* be consistent even when opening a relative symlink from different</span></td></tr>
<tr class="codeline" data-linenumber="4378"><td class="num" id="LN4378">4378</td><td class="line">     <span class='comment'>* working directories.</span></td></tr>
<tr class="codeline" data-linenumber="4379"><td class="num" id="LN4379">4379</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4380"><td class="num" id="LN4380">4380</td><td class="line">    <span class='keyword'>return</span> vim_FullName(tmp, buf, <span class='macro'>MAXPATHL<span class='macro_popup'>4096</span></span>, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4381"><td class="num" id="LN4381">4381</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4382"><td class="num" id="LN4382">4382</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="4383"><td class="num" id="LN4383">4383</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4384"><td class="num" id="LN4384">4384</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4385"><td class="num" id="LN4385">4385</td><td class="line"> <span class='comment'>* Make swap file name out of the file name and a directory name.</span></td></tr>
<tr class="codeline" data-linenumber="4386"><td class="num" id="LN4386">4386</td><td class="line"> <span class='comment'>* Returns pointer to allocated memory or NULL.</span></td></tr>
<tr class="codeline" data-linenumber="4387"><td class="num" id="LN4387">4387</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4388"><td class="num" id="LN4388">4388</td><td class="line">    char_u *</td></tr>
<tr class="codeline" data-linenumber="4389"><td class="num" id="LN4389">4389</td><td class="line">makeswapname(</td></tr>
<tr class="codeline" data-linenumber="4390"><td class="num" id="LN4390">4390</td><td class="line">    char_u	*fname,</td></tr>
<tr class="codeline" data-linenumber="4391"><td class="num" id="LN4391">4391</td><td class="line">    char_u	*ffname <span class='macro'>UNUSED<span class='macro_popup'>__attribute__((unused))</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4392"><td class="num" id="LN4392">4392</td><td class="line">    buf_T	*buf,</td></tr>
<tr class="codeline" data-linenumber="4393"><td class="num" id="LN4393">4393</td><td class="line">    char_u	*dir_name)</td></tr>
<tr class="codeline" data-linenumber="4394"><td class="num" id="LN4394">4394</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4395"><td class="num" id="LN4395">4395</td><td class="line">    char_u	*r, *s;</td></tr>
<tr class="codeline" data-linenumber="4396"><td class="num" id="LN4396">4396</td><td class="line">    char_u	*fname_res = fname;</td></tr>
<tr class="codeline" data-linenumber="4397"><td class="num" id="LN4397">4397</td><td class="line"><span class='directive'>#ifdef <span class='macro'>HAVE_READLINK<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4398"><td class="num" id="LN4398">4398</td><td class="line">    char_u	fname_buf[<span class='macro'>MAXPATHL<span class='macro_popup'>4096</span></span>];</td></tr>
<tr class="codeline" data-linenumber="4399"><td class="num" id="LN4399">4399</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4400"><td class="num" id="LN4400">4400</td><td class="line">    <span class='comment'>// Expand symlink in the file name, so that we put the swap file with the</span></td></tr>
<tr class="codeline" data-linenumber="4401"><td class="num" id="LN4401">4401</td><td class="line">    <span class='comment'>// actual file instead of with the symlink.</span></td></tr>
<tr class="codeline" data-linenumber="4402"><td class="num" id="LN4402">4402</td><td class="line">    <span class='keyword'>if</span> (resolve_symlink(fname, fname_buf) == <span class='macro'>OK<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4403"><td class="num" id="LN4403">4403</td><td class="line">	fname_res = fname_buf;</td></tr>
<tr class="codeline" data-linenumber="4404"><td class="num" id="LN4404">4404</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="4405"><td class="num" id="LN4405">4405</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4406"><td class="num" id="LN4406">4406</td><td class="line"><span class='directive'>#if defined(<span class='macro'>UNIX<span class='macro_popup'>1</span></span>) || defined(MSWIN)  // Need _very_ long file names</span></td></tr>
<tr class="codeline" data-linenumber="4407"><td class="num" id="LN4407">4407</td><td class="line">    <span class='keyword'>int</span>		len = (<span class='keyword'>int</span>)<span class='macro'>STRLEN(dir_name)<span class='macro_popup'>strlen((char *)(dir_name))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4408"><td class="num" id="LN4408">4408</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4409"><td class="num" id="LN4409">4409</td><td class="line">    s = dir_name + len;</td></tr>
<tr class="codeline" data-linenumber="4410"><td class="num" id="LN4410">4410</td><td class="line">    <span class='keyword'>if</span> (after_pathsep(dir_name, s) &amp;&amp; len &gt; 1 &amp;&amp; s[-1] == s[-2])</td></tr>
<tr class="codeline" data-linenumber="4411"><td class="num" id="LN4411">4411</td><td class="line">    {			       <span class='comment'>// Ends with '//', Use Full path</span></td></tr>
<tr class="codeline" data-linenumber="4412"><td class="num" id="LN4412">4412</td><td class="line">	r = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4413"><td class="num" id="LN4413">4413</td><td class="line">	<span class='keyword'>if</span> ((s = make_percent_swname(dir_name, fname_res)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4414"><td class="num" id="LN4414">4414</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="4415"><td class="num" id="LN4415">4415</td><td class="line">	    r = modname(s, (char_u *)<span class='string_literal'>".swp"</span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4416"><td class="num" id="LN4416">4416</td><td class="line">	    vim_free(s);</td></tr>
<tr class="codeline" data-linenumber="4417"><td class="num" id="LN4417">4417</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="4418"><td class="num" id="LN4418">4418</td><td class="line">	<span class='keyword'>return</span> r;</td></tr>
<tr class="codeline" data-linenumber="4419"><td class="num" id="LN4419">4419</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4420"><td class="num" id="LN4420">4420</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="4421"><td class="num" id="LN4421">4421</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4422"><td class="num" id="LN4422">4422</td><td class="line">    r = buf_modname(</td></tr>
<tr class="codeline" data-linenumber="4423"><td class="num" id="LN4423">4423</td><td class="line">	    (buf-&gt;b_p_sn || buf-&gt;b_shortname),</td></tr>
<tr class="codeline" data-linenumber="4424"><td class="num" id="LN4424">4424</td><td class="line">	    fname_res,</td></tr>
<tr class="codeline" data-linenumber="4425"><td class="num" id="LN4425">4425</td><td class="line">	    (char_u *)</td></tr>
<tr class="codeline" data-linenumber="4426"><td class="num" id="LN4426">4426</td><td class="line"><span class='directive'>#if defined(VMS)</span></td></tr>
<tr class="codeline" data-linenumber="4427"><td class="num" id="LN4427">4427</td><td class="line">	    <span class='string_literal'>"_swp"</span>,</td></tr>
<tr class="codeline" data-linenumber="4428"><td class="num" id="LN4428">4428</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="4429"><td class="num" id="LN4429">4429</td><td class="line">	    <span class='string_literal'>".swp"</span>,</td></tr>
<tr class="codeline" data-linenumber="4430"><td class="num" id="LN4430">4430</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="4431"><td class="num" id="LN4431">4431</td><td class="line">	    <span class='comment'>// Prepend a '.' to the swap file name for the current directory.</span></td></tr>
<tr class="codeline" data-linenumber="4432"><td class="num" id="LN4432">4432</td><td class="line">	    dir_name[0] == '.' &amp;&amp; dir_name[1] == <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4433"><td class="num" id="LN4433">4433</td><td class="line">    <span class='keyword'>if</span> (r == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)	    <span class='comment'>// out of memory</span></td></tr>
<tr class="codeline" data-linenumber="4434"><td class="num" id="LN4434">4434</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4435"><td class="num" id="LN4435">4435</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4436"><td class="num" id="LN4436">4436</td><td class="line">    s = get_file_in_dir(r, dir_name);</td></tr>
<tr class="codeline" data-linenumber="4437"><td class="num" id="LN4437">4437</td><td class="line">    vim_free(r);</td></tr>
<tr class="codeline" data-linenumber="4438"><td class="num" id="LN4438">4438</td><td class="line">    <span class='keyword'>return</span> s;</td></tr>
<tr class="codeline" data-linenumber="4439"><td class="num" id="LN4439">4439</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4440"><td class="num" id="LN4440">4440</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4441"><td class="num" id="LN4441">4441</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4442"><td class="num" id="LN4442">4442</td><td class="line"> <span class='comment'>* Get file name to use for swap file or backup file.</span></td></tr>
<tr class="codeline" data-linenumber="4443"><td class="num" id="LN4443">4443</td><td class="line"> <span class='comment'>* Use the name of the edited file "fname" and an entry in the 'dir' or 'bdir'</span></td></tr>
<tr class="codeline" data-linenumber="4444"><td class="num" id="LN4444">4444</td><td class="line"> <span class='comment'>* option "dname".</span></td></tr>
<tr class="codeline" data-linenumber="4445"><td class="num" id="LN4445">4445</td><td class="line"> <span class='comment'>* - If "dname" is ".", return "fname" (swap file in dir of file).</span></td></tr>
<tr class="codeline" data-linenumber="4446"><td class="num" id="LN4446">4446</td><td class="line"> <span class='comment'>* - If "dname" starts with "./", insert "dname" in "fname" (swap file</span></td></tr>
<tr class="codeline" data-linenumber="4447"><td class="num" id="LN4447">4447</td><td class="line"> <span class='comment'>*   relative to dir of file).</span></td></tr>
<tr class="codeline" data-linenumber="4448"><td class="num" id="LN4448">4448</td><td class="line"> <span class='comment'>* - Otherwise, prepend "dname" to the tail of "fname" (swap file in specific</span></td></tr>
<tr class="codeline" data-linenumber="4449"><td class="num" id="LN4449">4449</td><td class="line"> <span class='comment'>*   dir).</span></td></tr>
<tr class="codeline" data-linenumber="4450"><td class="num" id="LN4450">4450</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="4451"><td class="num" id="LN4451">4451</td><td class="line"> <span class='comment'>* The return value is an allocated string and can be NULL.</span></td></tr>
<tr class="codeline" data-linenumber="4452"><td class="num" id="LN4452">4452</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4453"><td class="num" id="LN4453">4453</td><td class="line">    char_u *</td></tr>
<tr class="codeline" data-linenumber="4454"><td class="num" id="LN4454">4454</td><td class="line">get_file_in_dir(</td></tr>
<tr class="codeline" data-linenumber="4455"><td class="num" id="LN4455">4455</td><td class="line">    char_u  *fname,</td></tr>
<tr class="codeline" data-linenumber="4456"><td class="num" id="LN4456">4456</td><td class="line">    char_u  *dname)	<span class='comment'>// don't use "dirname", it is a global for Alpha</span></td></tr>
<tr class="codeline" data-linenumber="4457"><td class="num" id="LN4457">4457</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4458"><td class="num" id="LN4458">4458</td><td class="line">    char_u	*t;</td></tr>
<tr class="codeline" data-linenumber="4459"><td class="num" id="LN4459">4459</td><td class="line">    char_u	*tail;</td></tr>
<tr class="codeline" data-linenumber="4460"><td class="num" id="LN4460">4460</td><td class="line">    char_u	*retval;</td></tr>
<tr class="codeline" data-linenumber="4461"><td class="num" id="LN4461">4461</td><td class="line">    <span class='keyword'>int</span>		save_char;</td></tr>
<tr class="codeline" data-linenumber="4462"><td class="num" id="LN4462">4462</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4463"><td class="num" id="LN4463">4463</td><td class="line">    tail = gettail(fname);</td></tr>
<tr class="codeline" data-linenumber="4464"><td class="num" id="LN4464">4464</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4465"><td class="num" id="LN4465">4465</td><td class="line">    <span class='keyword'>if</span> (dname[0] == '.' &amp;&amp; dname[1] == <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4466"><td class="num" id="LN4466">4466</td><td class="line">	retval = vim_strsave(fname);</td></tr>
<tr class="codeline" data-linenumber="4467"><td class="num" id="LN4467">4467</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (dname[0] == '.' &amp;&amp; vim_ispathsep(dname[1]))</td></tr>
<tr class="codeline" data-linenumber="4468"><td class="num" id="LN4468">4468</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="4469"><td class="num" id="LN4469">4469</td><td class="line">	<span class='keyword'>if</span> (tail == fname)	    <span class='comment'>// no path before file name</span></td></tr>
<tr class="codeline" data-linenumber="4470"><td class="num" id="LN4470">4470</td><td class="line">	    retval = concat_fnames(dname + 2, tail, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4471"><td class="num" id="LN4471">4471</td><td class="line">	<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="4472"><td class="num" id="LN4472">4472</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="4473"><td class="num" id="LN4473">4473</td><td class="line">	    save_char = *tail;</td></tr>
<tr class="codeline" data-linenumber="4474"><td class="num" id="LN4474">4474</td><td class="line">	    *tail = <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4475"><td class="num" id="LN4475">4475</td><td class="line">	    t = concat_fnames(fname, dname + 2, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4476"><td class="num" id="LN4476">4476</td><td class="line">	    *tail = save_char;</td></tr>
<tr class="codeline" data-linenumber="4477"><td class="num" id="LN4477">4477</td><td class="line">	    <span class='keyword'>if</span> (t == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)	    <span class='comment'>// out of memory</span></td></tr>
<tr class="codeline" data-linenumber="4478"><td class="num" id="LN4478">4478</td><td class="line">		retval = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4479"><td class="num" id="LN4479">4479</td><td class="line">	    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="4480"><td class="num" id="LN4480">4480</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="4481"><td class="num" id="LN4481">4481</td><td class="line">		retval = concat_fnames(t, tail, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4482"><td class="num" id="LN4482">4482</td><td class="line">		vim_free(t);</td></tr>
<tr class="codeline" data-linenumber="4483"><td class="num" id="LN4483">4483</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="4484"><td class="num" id="LN4484">4484</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="4485"><td class="num" id="LN4485">4485</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4486"><td class="num" id="LN4486">4486</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="4487"><td class="num" id="LN4487">4487</td><td class="line">	retval = concat_fnames(dname, tail, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4488"><td class="num" id="LN4488">4488</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4489"><td class="num" id="LN4489">4489</td><td class="line"><span class='directive'>#ifdef MSWIN</span></td></tr>
<tr class="codeline" data-linenumber="4490"><td class="num" id="LN4490">4490</td><td class="line">    <span class='keyword'>if</span> (retval != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4491"><td class="num" id="LN4491">4491</td><td class="line">	<span class='keyword'>for</span> (t = gettail(retval); *t != <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>; <span class='macro'>MB_PTR_ADV(t)<span class='macro_popup'>t += (*mb_ptr2len)(t)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4492"><td class="num" id="LN4492">4492</td><td class="line">	    <span class='keyword'>if</span> (*t == ':')</td></tr>
<tr class="codeline" data-linenumber="4493"><td class="num" id="LN4493">4493</td><td class="line">		*t = '%';</td></tr>
<tr class="codeline" data-linenumber="4494"><td class="num" id="LN4494">4494</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="4495"><td class="num" id="LN4495">4495</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4496"><td class="num" id="LN4496">4496</td><td class="line">    <span class='keyword'>return</span> retval;</td></tr>
<tr class="codeline" data-linenumber="4497"><td class="num" id="LN4497">4497</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4498"><td class="num" id="LN4498">4498</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4499"><td class="num" id="LN4499">4499</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4500"><td class="num" id="LN4500">4500</td><td class="line"> <span class='comment'>* Print the ATTENTION message: info about an existing swap file.</span></td></tr>
<tr class="codeline" data-linenumber="4501"><td class="num" id="LN4501">4501</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4502"><td class="num" id="LN4502">4502</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="4503"><td class="num" id="LN4503">4503</td><td class="line">attention_message(</td></tr>
<tr class="codeline" data-linenumber="4504"><td class="num" id="LN4504">4504</td><td class="line">    buf_T   *buf,	<span class='comment'>// buffer being edited</span></td></tr>
<tr class="codeline" data-linenumber="4505"><td class="num" id="LN4505">4505</td><td class="line">    char_u  *fname)	<span class='comment'>// swap file name</span></td></tr>
<tr class="codeline" data-linenumber="4506"><td class="num" id="LN4506">4506</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4507"><td class="num" id="LN4507">4507</td><td class="line">    stat_T	st;</td></tr>
<tr class="codeline" data-linenumber="4508"><td class="num" id="LN4508">4508</td><td class="line">    time_t	swap_mtime;</td></tr>
<tr class="codeline" data-linenumber="4509"><td class="num" id="LN4509">4509</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4510"><td class="num" id="LN4510">4510</td><td class="line">    ++no_wait_return;</td></tr>
<tr class="codeline" data-linenumber="4511"><td class="num" id="LN4511">4511</td><td class="line">    (<span class='keyword'>void</span>)emsg(<span class='macro'>_(<span class='string_literal'>"E325: ATTENTION"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E325: ATTENTION"), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4512"><td class="num" id="LN4512">4512</td><td class="line">    msg_puts(<span class='macro'>_(<span class='string_literal'>"\nFound a swap file by the name \""</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("\nFound a swap file by the name \""<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4513"><td class="num" id="LN4513">4513</td><td class="line">    msg_home_replace(fname);</td></tr>
<tr class="codeline" data-linenumber="4514"><td class="num" id="LN4514">4514</td><td class="line">    msg_puts(<span class='string_literal'>"\"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4515"><td class="num" id="LN4515">4515</td><td class="line">    swap_mtime = swapfile_info(fname);</td></tr>
<tr class="codeline" data-linenumber="4516"><td class="num" id="LN4516">4516</td><td class="line">    msg_puts(<span class='macro'>_(<span class='string_literal'>"While opening file \""</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("While opening file \""), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4517"><td class="num" id="LN4517">4517</td><td class="line">    msg_outtrans(buf-&gt;b_fname);</td></tr>
<tr class="codeline" data-linenumber="4518"><td class="num" id="LN4518">4518</td><td class="line">    msg_puts(<span class='string_literal'>"\"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4519"><td class="num" id="LN4519">4519</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>mch_stat((<span class='keyword'>char</span> *)buf-&gt;b_fname, &amp;st)<span class='macro_popup'>stat(((char *)buf-&gt;b_fname), (&amp;st))</span></span> == -1)</td></tr>
<tr class="codeline" data-linenumber="4520"><td class="num" id="LN4520">4520</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="4521"><td class="num" id="LN4521">4521</td><td class="line">	msg_puts(<span class='macro'>_(<span class='string_literal'>"      CANNOT BE FOUND"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("      CANNOT BE FOUND"), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4522"><td class="num" id="LN4522">4522</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4523"><td class="num" id="LN4523">4523</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="4524"><td class="num" id="LN4524">4524</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="4525"><td class="num" id="LN4525">4525</td><td class="line">	msg_puts(<span class='macro'>_(<span class='string_literal'>"             dated: "</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("             dated: "), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4526"><td class="num" id="LN4526">4526</td><td class="line">	msg_puts(get_ctime(st.<span class='macro'>st_mtime<span class='macro_popup'>st_mtim.tv_sec</span></span>, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>));</td></tr>
<tr class="codeline" data-linenumber="4527"><td class="num" id="LN4527">4527</td><td class="line">	<span class='keyword'>if</span> (swap_mtime != 0 &amp;&amp; st.<span class='macro'>st_mtime<span class='macro_popup'>st_mtim.tv_sec</span></span> &gt; swap_mtime)</td></tr>
<tr class="codeline" data-linenumber="4528"><td class="num" id="LN4528">4528</td><td class="line">	    msg_puts(<span class='macro'>_(<span class='string_literal'>"      NEWER than swap file!\n"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("      NEWER than swap file!\n"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4529"><td class="num" id="LN4529">4529</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4530"><td class="num" id="LN4530">4530</td><td class="line">    <span class='comment'>// Some of these messages are long to allow translation to</span></td></tr>
<tr class="codeline" data-linenumber="4531"><td class="num" id="LN4531">4531</td><td class="line">    <span class='comment'>// other languages.</span></td></tr>
<tr class="codeline" data-linenumber="4532"><td class="num" id="LN4532">4532</td><td class="line">    msg_puts(<span class='macro'>_(<span class='string_literal'>"\n(1) Another program may be editing the same file.  If this is the case,\n    be careful not to end up with two different instances of the same\n    file when making changes.  Quit, or continue with caution.\n"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("\n(1) Another program may be editing the same file.  If this is the case,\n    be careful not to end up with two different instances of the same\n    file when making changes.  Quit, or continue with caution.\n"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4533"><td class="num" id="LN4533">4533</td><td class="line">    msg_puts(<span class='macro'>_(<span class='string_literal'>"(2) An edit session for this file crashed.\n"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("(2) An edit session for this file crashed.\n"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4534"><td class="num" id="LN4534">4534</td><td class="line">    msg_puts(<span class='macro'>_(<span class='string_literal'>"    If this is the case, use \":recover\" or \"vim -r "</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("    If this is the case, use \":recover\" or \"vim -r "<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4535"><td class="num" id="LN4535">4535</td><td class="line">    msg_outtrans(buf-&gt;b_fname);</td></tr>
<tr class="codeline" data-linenumber="4536"><td class="num" id="LN4536">4536</td><td class="line">    msg_puts(<span class='macro'>_(<span class='string_literal'>"\"\n    to recover the changes (see \":help recovery\").\n"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("\"\n    to recover the changes (see \":help recovery\").\n"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4537"><td class="num" id="LN4537">4537</td><td class="line">    msg_puts(<span class='macro'>_(<span class='string_literal'>"    If you did this already, delete the swap file \""</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("    If you did this already, delete the swap file \""<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4538"><td class="num" id="LN4538">4538</td><td class="line">    msg_outtrans(fname);</td></tr>
<tr class="codeline" data-linenumber="4539"><td class="num" id="LN4539">4539</td><td class="line">    msg_puts(<span class='macro'>_(<span class='string_literal'>"\"\n    to avoid this message.\n"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("\"\n    to avoid this message.\n"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4540"><td class="num" id="LN4540">4540</td><td class="line">    cmdline_row = msg_row;</td></tr>
<tr class="codeline" data-linenumber="4541"><td class="num" id="LN4541">4541</td><td class="line">    --no_wait_return;</td></tr>
<tr class="codeline" data-linenumber="4542"><td class="num" id="LN4542">4542</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4543"><td class="num" id="LN4543">4543</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4544"><td class="num" id="LN4544">4544</td><td class="line"><span class='directive'>#if defined(FEAT_EVAL)</span></td></tr>
<tr class="codeline" data-linenumber="4545"><td class="num" id="LN4545">4545</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4546"><td class="num" id="LN4546">4546</td><td class="line"> <span class='comment'>* Trigger the SwapExists autocommands.</span></td></tr>
<tr class="codeline" data-linenumber="4547"><td class="num" id="LN4547">4547</td><td class="line"> <span class='comment'>* Returns a value for equivalent to do_dialog() (see below):</span></td></tr>
<tr class="codeline" data-linenumber="4548"><td class="num" id="LN4548">4548</td><td class="line"> <span class='comment'>* 0: still need to ask for a choice</span></td></tr>
<tr class="codeline" data-linenumber="4549"><td class="num" id="LN4549">4549</td><td class="line"> <span class='comment'>* 1: open read-only</span></td></tr>
<tr class="codeline" data-linenumber="4550"><td class="num" id="LN4550">4550</td><td class="line"> <span class='comment'>* 2: edit anyway</span></td></tr>
<tr class="codeline" data-linenumber="4551"><td class="num" id="LN4551">4551</td><td class="line"> <span class='comment'>* 3: recover</span></td></tr>
<tr class="codeline" data-linenumber="4552"><td class="num" id="LN4552">4552</td><td class="line"> <span class='comment'>* 4: delete it</span></td></tr>
<tr class="codeline" data-linenumber="4553"><td class="num" id="LN4553">4553</td><td class="line"> <span class='comment'>* 5: quit</span></td></tr>
<tr class="codeline" data-linenumber="4554"><td class="num" id="LN4554">4554</td><td class="line"> <span class='comment'>* 6: abort</span></td></tr>
<tr class="codeline" data-linenumber="4555"><td class="num" id="LN4555">4555</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4556"><td class="num" id="LN4556">4556</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="4557"><td class="num" id="LN4557">4557</td><td class="line">do_swapexists(buf_T *buf, char_u *fname)</td></tr>
<tr class="codeline" data-linenumber="4558"><td class="num" id="LN4558">4558</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4559"><td class="num" id="LN4559">4559</td><td class="line">    set_vim_var_string(<span class='macro'>VV_SWAPNAME<span class='macro_popup'>46</span></span>, fname, -1);</td></tr>
<tr class="codeline" data-linenumber="4560"><td class="num" id="LN4560">4560</td><td class="line">    set_vim_var_string(<span class='macro'>VV_SWAPCHOICE<span class='macro_popup'>47</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, -1);</td></tr>
<tr class="codeline" data-linenumber="4561"><td class="num" id="LN4561">4561</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4562"><td class="num" id="LN4562">4562</td><td class="line">    <span class='comment'>// Trigger SwapExists autocommands with &lt;afile&gt; set to the file being</span></td></tr>
<tr class="codeline" data-linenumber="4563"><td class="num" id="LN4563">4563</td><td class="line">    <span class='comment'>// edited.  Disallow changing directory here.</span></td></tr>
<tr class="codeline" data-linenumber="4564"><td class="num" id="LN4564">4564</td><td class="line">    ++allbuf_lock;</td></tr>
<tr class="codeline" data-linenumber="4565"><td class="num" id="LN4565">4565</td><td class="line">    apply_autocmds(EVENT_SWAPEXISTS, buf-&gt;b_fname, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4566"><td class="num" id="LN4566">4566</td><td class="line">    --allbuf_lock;</td></tr>
<tr class="codeline" data-linenumber="4567"><td class="num" id="LN4567">4567</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4568"><td class="num" id="LN4568">4568</td><td class="line">    set_vim_var_string(<span class='macro'>VV_SWAPNAME<span class='macro_popup'>46</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, -1);</td></tr>
<tr class="codeline" data-linenumber="4569"><td class="num" id="LN4569">4569</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4570"><td class="num" id="LN4570">4570</td><td class="line">    <span class='keyword'>switch</span> (*get_vim_var_str(<span class='macro'>VV_SWAPCHOICE<span class='macro_popup'>47</span></span>))</td></tr>
<tr class="codeline" data-linenumber="4571"><td class="num" id="LN4571">4571</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="4572"><td class="num" id="LN4572">4572</td><td class="line">	<span class='keyword'>case</span> 'o': <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="4573"><td class="num" id="LN4573">4573</td><td class="line">	<span class='keyword'>case</span> 'e': <span class='keyword'>return</span> 2;</td></tr>
<tr class="codeline" data-linenumber="4574"><td class="num" id="LN4574">4574</td><td class="line">	<span class='keyword'>case</span> 'r': <span class='keyword'>return</span> 3;</td></tr>
<tr class="codeline" data-linenumber="4575"><td class="num" id="LN4575">4575</td><td class="line">	<span class='keyword'>case</span> 'd': <span class='keyword'>return</span> 4;</td></tr>
<tr class="codeline" data-linenumber="4576"><td class="num" id="LN4576">4576</td><td class="line">	<span class='keyword'>case</span> 'q': <span class='keyword'>return</span> 5;</td></tr>
<tr class="codeline" data-linenumber="4577"><td class="num" id="LN4577">4577</td><td class="line">	<span class='keyword'>case</span> 'a': <span class='keyword'>return</span> 6;</td></tr>
<tr class="codeline" data-linenumber="4578"><td class="num" id="LN4578">4578</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4579"><td class="num" id="LN4579">4579</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4580"><td class="num" id="LN4580">4580</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="4581"><td class="num" id="LN4581">4581</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4582"><td class="num" id="LN4582">4582</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="4583"><td class="num" id="LN4583">4583</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4584"><td class="num" id="LN4584">4584</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4585"><td class="num" id="LN4585">4585</td><td class="line"> <span class='comment'>* Find out what name to use for the swap file for buffer 'buf'.</span></td></tr>
<tr class="codeline" data-linenumber="4586"><td class="num" id="LN4586">4586</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="4587"><td class="num" id="LN4587">4587</td><td class="line"> <span class='comment'>* Several names are tried to find one that does not exist</span></td></tr>
<tr class="codeline" data-linenumber="4588"><td class="num" id="LN4588">4588</td><td class="line"> <span class='comment'>* Returns the name in allocated memory or NULL.</span></td></tr>
<tr class="codeline" data-linenumber="4589"><td class="num" id="LN4589">4589</td><td class="line"> <span class='comment'>* When out of memory "dirp" is set to NULL.</span></td></tr>
<tr class="codeline" data-linenumber="4590"><td class="num" id="LN4590">4590</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="4591"><td class="num" id="LN4591">4591</td><td class="line"> <span class='comment'>* Note: If BASENAMELEN is not correct, you will get error messages for</span></td></tr>
<tr class="codeline" data-linenumber="4592"><td class="num" id="LN4592">4592</td><td class="line"> <span class='comment'>*	 not being able to open the swap or undo file</span></td></tr>
<tr class="codeline" data-linenumber="4593"><td class="num" id="LN4593">4593</td><td class="line"> <span class='comment'>* Note: May trigger SwapExists autocmd, pointers may change!</span></td></tr>
<tr class="codeline" data-linenumber="4594"><td class="num" id="LN4594">4594</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4595"><td class="num" id="LN4595">4595</td><td class="line">    <span class='keyword'>static</span> char_u *</td></tr>
<tr class="codeline" data-linenumber="4596"><td class="num" id="LN4596">4596</td><td class="line">findswapname(</td></tr>
<tr class="codeline" data-linenumber="4597"><td class="num" id="LN4597">4597</td><td class="line">    buf_T	*buf,</td></tr>
<tr class="codeline" data-linenumber="4598"><td class="num" id="LN4598">4598</td><td class="line">    char_u	**dirp,		<span class='comment'>// pointer to list of directories</span></td></tr>
<tr class="codeline" data-linenumber="4599"><td class="num" id="LN4599">4599</td><td class="line">    char_u	*old_fname)	<span class='comment'>// don't give warning for this file name</span></td></tr>
<tr class="codeline" data-linenumber="4600"><td class="num" id="LN4600">4600</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="4601"><td class="num" id="LN4601">4601</td><td class="line">    char_u	*fname;</td></tr>
<tr class="codeline" data-linenumber="4602"><td class="num" id="LN4602">4602</td><td class="line">    <span class='keyword'>int</span>		n;</td></tr>
<tr class="codeline" data-linenumber="4603"><td class="num" id="LN4603">4603</td><td class="line">    char_u	*dir_name;</td></tr>
<tr class="codeline" data-linenumber="4604"><td class="num" id="LN4604">4604</td><td class="line"><span class='directive'>#ifdef AMIGA</span></td></tr>
<tr class="codeline" data-linenumber="4605"><td class="num" id="LN4605">4605</td><td class="line">    BPTR	fh;</td></tr>
<tr class="codeline" data-linenumber="4606"><td class="num" id="LN4606">4606</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="4607"><td class="num" id="LN4607">4607</td><td class="line">    <span class='keyword'>int</span>		r;</td></tr>
<tr class="codeline" data-linenumber="4608"><td class="num" id="LN4608">4608</td><td class="line">    char_u	*buf_fname = buf-&gt;b_fname;</td></tr>
<tr class="codeline" data-linenumber="4609"><td class="num" id="LN4609">4609</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4610"><td class="num" id="LN4610">4610</td><td class="line"><span class='directive'>#if !defined(<span class='macro'>UNIX<span class='macro_popup'>1</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="4611"><td class="num" id="LN4611">4611</td><td class="line"><span class='directive'># define CREATE_DUMMY_FILE</span></td></tr>
<tr class="codeline" data-linenumber="4612"><td class="num" id="LN4612">4612</td><td class="line">    FILE	*dummyfd = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4613"><td class="num" id="LN4613">4613</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4614"><td class="num" id="LN4614">4614</td><td class="line"><span class='directive'># ifdef MSWIN</span></td></tr>
<tr class="codeline" data-linenumber="4615"><td class="num" id="LN4615">4615</td><td class="line">    <span class='keyword'>if</span> (buf_fname != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; !mch_isFullName(buf_fname)</td></tr>
<tr class="codeline" data-linenumber="4616"><td class="num" id="LN4616">4616</td><td class="line">				       &amp;&amp; vim_strchr(gettail(buf_fname), ':'))</td></tr>
<tr class="codeline" data-linenumber="4617"><td class="num" id="LN4617">4617</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="4618"><td class="num" id="LN4618">4618</td><td class="line">	char_u *t;</td></tr>
<tr class="codeline" data-linenumber="4619"><td class="num" id="LN4619">4619</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4620"><td class="num" id="LN4620">4620</td><td class="line">	buf_fname = vim_strsave(buf_fname);</td></tr>
<tr class="codeline" data-linenumber="4621"><td class="num" id="LN4621">4621</td><td class="line">	<span class='keyword'>if</span> (buf_fname == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4622"><td class="num" id="LN4622">4622</td><td class="line">	    buf_fname = buf-&gt;b_fname;</td></tr>
<tr class="codeline" data-linenumber="4623"><td class="num" id="LN4623">4623</td><td class="line">	<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="4624"><td class="num" id="LN4624">4624</td><td class="line">	    <span class='keyword'>for</span> (t = gettail(buf_fname); *t != <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>; <span class='macro'>MB_PTR_ADV(t)<span class='macro_popup'>t += (*mb_ptr2len)(t)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4625"><td class="num" id="LN4625">4625</td><td class="line">		<span class='keyword'>if</span> (*t == ':')</td></tr>
<tr class="codeline" data-linenumber="4626"><td class="num" id="LN4626">4626</td><td class="line">		    *t = '%';</td></tr>
<tr class="codeline" data-linenumber="4627"><td class="num" id="LN4627">4627</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4628"><td class="num" id="LN4628">4628</td><td class="line"><span class='directive'># endif</span></td></tr>
<tr class="codeline" data-linenumber="4629"><td class="num" id="LN4629">4629</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4630"><td class="num" id="LN4630">4630</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4631"><td class="num" id="LN4631">4631</td><td class="line">     <span class='comment'>* If we start editing a new file, e.g. "test.doc", which resides on an</span></td></tr>
<tr class="codeline" data-linenumber="4632"><td class="num" id="LN4632">4632</td><td class="line">     <span class='comment'>* MSDOS compatible filesystem, it is possible that the file</span></td></tr>
<tr class="codeline" data-linenumber="4633"><td class="num" id="LN4633">4633</td><td class="line">     <span class='comment'>* "test.doc.swp" which we create will be exactly the same file. To avoid</span></td></tr>
<tr class="codeline" data-linenumber="4634"><td class="num" id="LN4634">4634</td><td class="line">     <span class='comment'>* this problem we temporarily create "test.doc".  Don't do this when the</span></td></tr>
<tr class="codeline" data-linenumber="4635"><td class="num" id="LN4635">4635</td><td class="line">     <span class='comment'>* check below for a 8.3 file name is used.</span></td></tr>
<tr class="codeline" data-linenumber="4636"><td class="num" id="LN4636">4636</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4637"><td class="num" id="LN4637">4637</td><td class="line">    <span class='keyword'>if</span> (!(buf-&gt;b_p_sn || buf-&gt;b_shortname) &amp;&amp; buf_fname != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="4638"><td class="num" id="LN4638">4638</td><td class="line">					     &amp;&amp; mch_getperm(buf_fname) &lt; 0)</td></tr>
<tr class="codeline" data-linenumber="4639"><td class="num" id="LN4639">4639</td><td class="line">	dummyfd = <span class='macro'>mch_fopen((<span class='keyword'>char</span> *)buf_fname, <span class='string_literal'>"w"</span>)<span class='macro_popup'>fopen(((char *)buf_fname), ("w"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4640"><td class="num" id="LN4640">4640</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="4641"><td class="num" id="LN4641">4641</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4642"><td class="num" id="LN4642">4642</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4643"><td class="num" id="LN4643">4643</td><td class="line">     <span class='comment'>* Isolate a directory name from *dirp and put it in dir_name.</span></td></tr>
<tr class="codeline" data-linenumber="4644"><td class="num" id="LN4644">4644</td><td class="line">     <span class='comment'>* First allocate some memory to put the directory name in.</span></td></tr>
<tr class="codeline" data-linenumber="4645"><td class="num" id="LN4645">4645</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4646"><td class="num" id="LN4646">4646</td><td class="line">    dir_name = alloc(<span class='macro'>STRLEN(*dirp)<span class='macro_popup'>strlen((char *)(*dirp))</span></span> + 1);</td></tr>
<tr class="codeline" data-linenumber="4647"><td class="num" id="LN4647">4647</td><td class="line">    <span class='keyword'>if</span> (dir_name == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4648"><td class="num" id="LN4648">4648</td><td class="line">	*dirp = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4649"><td class="num" id="LN4649">4649</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="4650"><td class="num" id="LN4650">4650</td><td class="line">	(<span class='keyword'>void</span>)copy_option_part(dirp, dir_name, 31000, <span class='string_literal'>","</span>);</td></tr>
<tr class="codeline" data-linenumber="4651"><td class="num" id="LN4651">4651</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4652"><td class="num" id="LN4652">4652</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4653"><td class="num" id="LN4653">4653</td><td class="line">     <span class='comment'>* we try different names until we find one that does not exist yet</span></td></tr>
<tr class="codeline" data-linenumber="4654"><td class="num" id="LN4654">4654</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4655"><td class="num" id="LN4655">4655</td><td class="line">    <span class='keyword'>if</span> (dir_name == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)	    <span class='comment'>// out of memory</span></td></tr>
<tr class="codeline" data-linenumber="4656"><td class="num" id="LN4656">4656</td><td class="line">	fname = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4657"><td class="num" id="LN4657">4657</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="4658"><td class="num" id="LN4658">4658</td><td class="line">	fname = makeswapname(buf_fname, buf-&gt;b_ffname, buf, dir_name);</td></tr>
<tr class="codeline" data-linenumber="4659"><td class="num" id="LN4659">4659</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4660"><td class="num" id="LN4660">4660</td><td class="line">    <span class='keyword'>for</span> (;;)</td></tr>
<tr class="codeline" data-linenumber="4661"><td class="num" id="LN4661">4661</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="4662"><td class="num" id="LN4662">4662</td><td class="line">	<span class='keyword'>if</span> (fname == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)	<span class='comment'>// must be out of memory</span></td></tr>
<tr class="codeline" data-linenumber="4663"><td class="num" id="LN4663">4663</td><td class="line">	    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4664"><td class="num" id="LN4664">4664</td><td class="line">	<span class='keyword'>if</span> ((n = (<span class='keyword'>int</span>)<span class='macro'>STRLEN(fname)<span class='macro_popup'>strlen((char *)(fname))</span></span>) == 0)	<span class='comment'>// safety check</span></td></tr>
<tr class="codeline" data-linenumber="4665"><td class="num" id="LN4665">4665</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="4666"><td class="num" id="LN4666">4666</td><td class="line">	    <span class='macro'>VIM_CLEAR(fname)<span class='macro_popup'>do { if ((fname) != ((void*)0)) { vim_free(fname); (fname) = (<br>(void*)0); } } while (0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4667"><td class="num" id="LN4667">4667</td><td class="line">	    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4668"><td class="num" id="LN4668">4668</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="4669"><td class="num" id="LN4669">4669</td><td class="line"><span class='directive'>#if defined(<span class='macro'>UNIX<span class='macro_popup'>1</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="4670"><td class="num" id="LN4670">4670</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4671"><td class="num" id="LN4671">4671</td><td class="line"> <span class='comment'>* Some systems have a MS-DOS compatible filesystem that use 8.3 character</span></td></tr>
<tr class="codeline" data-linenumber="4672"><td class="num" id="LN4672">4672</td><td class="line"> <span class='comment'>* file names. If this is the first try and the swap file name does not fit in</span></td></tr>
<tr class="codeline" data-linenumber="4673"><td class="num" id="LN4673">4673</td><td class="line"> <span class='comment'>* 8.3, detect if this is the case, set shortname and try again.</span></td></tr>
<tr class="codeline" data-linenumber="4674"><td class="num" id="LN4674">4674</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4675"><td class="num" id="LN4675">4675</td><td class="line">	<span class='keyword'>if</span> (fname[n - 2] == 'w' &amp;&amp; fname[n - 1] == 'p'</td></tr>
<tr class="codeline" data-linenumber="4676"><td class="num" id="LN4676">4676</td><td class="line">					&amp;&amp; !(buf-&gt;b_p_sn || buf-&gt;b_shortname))</td></tr>
<tr class="codeline" data-linenumber="4677"><td class="num" id="LN4677">4677</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="4678"><td class="num" id="LN4678">4678</td><td class="line">	    char_u	    *tail;</td></tr>
<tr class="codeline" data-linenumber="4679"><td class="num" id="LN4679">4679</td><td class="line">	    char_u	    *fname2;</td></tr>
<tr class="codeline" data-linenumber="4680"><td class="num" id="LN4680">4680</td><td class="line">	    stat_T	    s1, s2;</td></tr>
<tr class="codeline" data-linenumber="4681"><td class="num" id="LN4681">4681</td><td class="line">	    <span class='keyword'>int</span>		    f1, f2;</td></tr>
<tr class="codeline" data-linenumber="4682"><td class="num" id="LN4682">4682</td><td class="line">	    <span class='keyword'>int</span>		    created1 = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>, created2 = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4683"><td class="num" id="LN4683">4683</td><td class="line">	    <span class='keyword'>int</span>		    same = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4684"><td class="num" id="LN4684">4684</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4685"><td class="num" id="LN4685">4685</td><td class="line">	    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4686"><td class="num" id="LN4686">4686</td><td class="line">	     <span class='comment'>* Check if swapfile name does not fit in 8.3:</span></td></tr>
<tr class="codeline" data-linenumber="4687"><td class="num" id="LN4687">4687</td><td class="line">	     <span class='comment'>* It either contains two dots, is longer than 8 chars, or starts</span></td></tr>
<tr class="codeline" data-linenumber="4688"><td class="num" id="LN4688">4688</td><td class="line">	     <span class='comment'>* with a dot.</span></td></tr>
<tr class="codeline" data-linenumber="4689"><td class="num" id="LN4689">4689</td><td class="line">	     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4690"><td class="num" id="LN4690">4690</td><td class="line">	    tail = gettail(buf_fname);</td></tr>
<tr class="codeline" data-linenumber="4691"><td class="num" id="LN4691">4691</td><td class="line">	    <span class='keyword'>if</span> (       vim_strchr(tail, '.') != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="4692"><td class="num" id="LN4692">4692</td><td class="line">		    || <span class='macro'>STRLEN(tail)<span class='macro_popup'>strlen((char *)(tail))</span></span> &gt; (size_t)8</td></tr>
<tr class="codeline" data-linenumber="4693"><td class="num" id="LN4693">4693</td><td class="line">		    || *gettail(fname) == '.')</td></tr>
<tr class="codeline" data-linenumber="4694"><td class="num" id="LN4694">4694</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="4695"><td class="num" id="LN4695">4695</td><td class="line">		fname2 = alloc(n + 2);</td></tr>
<tr class="codeline" data-linenumber="4696"><td class="num" id="LN4696">4696</td><td class="line">		<span class='keyword'>if</span> (fname2 != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4697"><td class="num" id="LN4697">4697</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="4698"><td class="num" id="LN4698">4698</td><td class="line">		    <span class='macro'>STRCPY(fname2, fname)<span class='macro_popup'>strcpy((char *)(fname2), (char *)(fname))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4699"><td class="num" id="LN4699">4699</td><td class="line">		    <span class='comment'>// if fname == "xx.xx.swp",	    fname2 = "xx.xx.swx"</span></td></tr>
<tr class="codeline" data-linenumber="4700"><td class="num" id="LN4700">4700</td><td class="line">		    <span class='comment'>// if fname == ".xx.swp",	    fname2 = ".xx.swpx"</span></td></tr>
<tr class="codeline" data-linenumber="4701"><td class="num" id="LN4701">4701</td><td class="line">		    <span class='comment'>// if fname == "123456789.swp", fname2 = "12345678x.swp"</span></td></tr>
<tr class="codeline" data-linenumber="4702"><td class="num" id="LN4702">4702</td><td class="line">		    <span class='keyword'>if</span> (vim_strchr(tail, '.') != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4703"><td class="num" id="LN4703">4703</td><td class="line">			fname2[n - 1] = 'x';</td></tr>
<tr class="codeline" data-linenumber="4704"><td class="num" id="LN4704">4704</td><td class="line">		    <span class='keyword'>else</span> <span class='keyword'>if</span> (*gettail(fname) == '.')</td></tr>
<tr class="codeline" data-linenumber="4705"><td class="num" id="LN4705">4705</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="4706"><td class="num" id="LN4706">4706</td><td class="line">			fname2[n] = 'x';</td></tr>
<tr class="codeline" data-linenumber="4707"><td class="num" id="LN4707">4707</td><td class="line">			fname2[n + 1] = <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4708"><td class="num" id="LN4708">4708</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="4709"><td class="num" id="LN4709">4709</td><td class="line">		    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="4710"><td class="num" id="LN4710">4710</td><td class="line">			fname2[n - 5] += 1;</td></tr>
<tr class="codeline" data-linenumber="4711"><td class="num" id="LN4711">4711</td><td class="line">		    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4712"><td class="num" id="LN4712">4712</td><td class="line">		     <span class='comment'>* may need to create the files to be able to use mch_stat()</span></td></tr>
<tr class="codeline" data-linenumber="4713"><td class="num" id="LN4713">4713</td><td class="line">		     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4714"><td class="num" id="LN4714">4714</td><td class="line">		    f1 = <span class='macro'>mch_open((<span class='keyword'>char</span> *)fname, O_RDONLY | O_EXTRA, 0)<span class='macro_popup'>open(((char *)fname), (00 | 0), (0))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4715"><td class="num" id="LN4715">4715</td><td class="line">		    <span class='keyword'>if</span> (f1 &lt; 0)</td></tr>
<tr class="codeline" data-linenumber="4716"><td class="num" id="LN4716">4716</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="4717"><td class="num" id="LN4717">4717</td><td class="line">			f1 = <span class='macro'>mch_open_rw((<span class='keyword'>char</span> *)fname,<span class='macro_popup'>open((((char *)fname)), ((02|0100|0200|0)), ((mode_t)0600))</span></span></td></tr>
<tr class="codeline" data-linenumber="4718"><td class="num" id="LN4718">4718</td><td class="line">					       <span class='macro'>O_RDWR|O_CREAT|O_EXCL|O_EXTRA)<span class='macro_popup'>open((((char *)fname)), ((02|0100|0200|0)), ((mode_t)0600))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4719"><td class="num" id="LN4719">4719</td><td class="line">			created1 = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4720"><td class="num" id="LN4720">4720</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="4721"><td class="num" id="LN4721">4721</td><td class="line">		    <span class='keyword'>if</span> (f1 &gt;= 0)</td></tr>
<tr class="codeline" data-linenumber="4722"><td class="num" id="LN4722">4722</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="4723"><td class="num" id="LN4723">4723</td><td class="line">			f2 = <span class='macro'>mch_open((<span class='keyword'>char</span> *)fname2, O_RDONLY | O_EXTRA, 0)<span class='macro_popup'>open(((char *)fname2), (00 | 0), (0))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4724"><td class="num" id="LN4724">4724</td><td class="line">			<span class='keyword'>if</span> (f2 &lt; 0)</td></tr>
<tr class="codeline" data-linenumber="4725"><td class="num" id="LN4725">4725</td><td class="line">			{</td></tr>
<tr class="codeline" data-linenumber="4726"><td class="num" id="LN4726">4726</td><td class="line">			    f2 = <span class='macro'>mch_open_rw((<span class='keyword'>char</span> *)fname2,<span class='macro_popup'>open((((char *)fname2)), ((02|0100|0200|0)), ((mode_t)0600))</span></span></td></tr>
<tr class="codeline" data-linenumber="4727"><td class="num" id="LN4727">4727</td><td class="line">					       <span class='macro'>O_RDWR|O_CREAT|O_EXCL|O_EXTRA)<span class='macro_popup'>open((((char *)fname2)), ((02|0100|0200|0)), ((mode_t)0600))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4728"><td class="num" id="LN4728">4728</td><td class="line">			    created2 = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4729"><td class="num" id="LN4729">4729</td><td class="line">			}</td></tr>
<tr class="codeline" data-linenumber="4730"><td class="num" id="LN4730">4730</td><td class="line">			<span class='keyword'>if</span> (f2 &gt;= 0)</td></tr>
<tr class="codeline" data-linenumber="4731"><td class="num" id="LN4731">4731</td><td class="line">			{</td></tr>
<tr class="codeline" data-linenumber="4732"><td class="num" id="LN4732">4732</td><td class="line">			    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4733"><td class="num" id="LN4733">4733</td><td class="line">			     <span class='comment'>* Both files exist now. If mch_stat() returns the</span></td></tr>
<tr class="codeline" data-linenumber="4734"><td class="num" id="LN4734">4734</td><td class="line">			     <span class='comment'>* same device and inode they are the same file.</span></td></tr>
<tr class="codeline" data-linenumber="4735"><td class="num" id="LN4735">4735</td><td class="line">			     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4736"><td class="num" id="LN4736">4736</td><td class="line">			    <span class='keyword'>if</span> (<span class='macro'>mch_fstat(f1, &amp;s1)<span class='macro_popup'>fstat((f1), (&amp;s1))</span></span> != -1</td></tr>
<tr class="codeline" data-linenumber="4737"><td class="num" id="LN4737">4737</td><td class="line">				    &amp;&amp; <span class='macro'>mch_fstat(f2, &amp;s2)<span class='macro_popup'>fstat((f2), (&amp;s2))</span></span> != -1</td></tr>
<tr class="codeline" data-linenumber="4738"><td class="num" id="LN4738">4738</td><td class="line">				    &amp;&amp; s1.st_dev == s2.st_dev</td></tr>
<tr class="codeline" data-linenumber="4739"><td class="num" id="LN4739">4739</td><td class="line">				    &amp;&amp; s1.st_ino == s2.st_ino)</td></tr>
<tr class="codeline" data-linenumber="4740"><td class="num" id="LN4740">4740</td><td class="line">				same = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4741"><td class="num" id="LN4741">4741</td><td class="line">			    close(f2);</td></tr>
<tr class="codeline" data-linenumber="4742"><td class="num" id="LN4742">4742</td><td class="line">			    <span class='keyword'>if</span> (created2)</td></tr>
<tr class="codeline" data-linenumber="4743"><td class="num" id="LN4743">4743</td><td class="line">				<span class='macro'>mch_remove(fname2)<span class='macro_popup'>unlink((char *)(fname2))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4744"><td class="num" id="LN4744">4744</td><td class="line">			}</td></tr>
<tr class="codeline" data-linenumber="4745"><td class="num" id="LN4745">4745</td><td class="line">			close(f1);</td></tr>
<tr class="codeline" data-linenumber="4746"><td class="num" id="LN4746">4746</td><td class="line">			<span class='keyword'>if</span> (created1)</td></tr>
<tr class="codeline" data-linenumber="4747"><td class="num" id="LN4747">4747</td><td class="line">			    <span class='macro'>mch_remove(fname)<span class='macro_popup'>unlink((char *)(fname))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4748"><td class="num" id="LN4748">4748</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="4749"><td class="num" id="LN4749">4749</td><td class="line">		    vim_free(fname2);</td></tr>
<tr class="codeline" data-linenumber="4750"><td class="num" id="LN4750">4750</td><td class="line">		    <span class='keyword'>if</span> (same)</td></tr>
<tr class="codeline" data-linenumber="4751"><td class="num" id="LN4751">4751</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="4752"><td class="num" id="LN4752">4752</td><td class="line">			buf-&gt;b_shortname = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4753"><td class="num" id="LN4753">4753</td><td class="line">			vim_free(fname);</td></tr>
<tr class="codeline" data-linenumber="4754"><td class="num" id="LN4754">4754</td><td class="line">			fname = makeswapname(buf_fname, buf-&gt;b_ffname,</td></tr>
<tr class="codeline" data-linenumber="4755"><td class="num" id="LN4755">4755</td><td class="line">							       buf, dir_name);</td></tr>
<tr class="codeline" data-linenumber="4756"><td class="num" id="LN4756">4756</td><td class="line">			<span class='keyword'>continue</span>;	<span class='comment'>// try again with b_shortname set</span></td></tr>
<tr class="codeline" data-linenumber="4757"><td class="num" id="LN4757">4757</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="4758"><td class="num" id="LN4758">4758</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="4759"><td class="num" id="LN4759">4759</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="4760"><td class="num" id="LN4760">4760</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="4761"><td class="num" id="LN4761">4761</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="4762"><td class="num" id="LN4762">4762</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4763"><td class="num" id="LN4763">4763</td><td class="line">	 <span class='comment'>* check if the swapfile already exists</span></td></tr>
<tr class="codeline" data-linenumber="4764"><td class="num" id="LN4764">4764</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4765"><td class="num" id="LN4765">4765</td><td class="line">	<span class='keyword'>if</span> (mch_getperm(fname) &lt; 0)	<span class='comment'>// it does not exist</span></td></tr>
<tr class="codeline" data-linenumber="4766"><td class="num" id="LN4766">4766</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="4767"><td class="num" id="LN4767">4767</td><td class="line"><span class='directive'>#ifdef <span class='macro'>HAVE_LSTAT<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4768"><td class="num" id="LN4768">4768</td><td class="line">	    stat_T	sb;</td></tr>
<tr class="codeline" data-linenumber="4769"><td class="num" id="LN4769">4769</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4770"><td class="num" id="LN4770">4770</td><td class="line">	    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4771"><td class="num" id="LN4771">4771</td><td class="line">	     <span class='comment'>* Extra security check: When a swap file is a symbolic link, this</span></td></tr>
<tr class="codeline" data-linenumber="4772"><td class="num" id="LN4772">4772</td><td class="line">	     <span class='comment'>* is most likely a symlink attack.</span></td></tr>
<tr class="codeline" data-linenumber="4773"><td class="num" id="LN4773">4773</td><td class="line">	     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4774"><td class="num" id="LN4774">4774</td><td class="line">	    <span class='keyword'>if</span> (<span class='macro'>mch_lstat((<span class='keyword'>char</span> *)fname, &amp;sb)<span class='macro_popup'>lstat(((char *)fname), (&amp;sb))</span></span> &lt; 0)</td></tr>
<tr class="codeline" data-linenumber="4775"><td class="num" id="LN4775">4775</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="4776"><td class="num" id="LN4776">4776</td><td class="line"><span class='directive'># ifdef AMIGA</span></td></tr>
<tr class="codeline" data-linenumber="4777"><td class="num" id="LN4777">4777</td><td class="line">	    fh = Open((UBYTE *)fname, (<span class='keyword'>long</span>)MODE_NEWFILE);</td></tr>
<tr class="codeline" data-linenumber="4778"><td class="num" id="LN4778">4778</td><td class="line">	    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4779"><td class="num" id="LN4779">4779</td><td class="line">	     <span class='comment'>* on the Amiga mch_getperm() will return -1 when the file exists</span></td></tr>
<tr class="codeline" data-linenumber="4780"><td class="num" id="LN4780">4780</td><td class="line">	     <span class='comment'>* but is being used by another program. This happens if you edit</span></td></tr>
<tr class="codeline" data-linenumber="4781"><td class="num" id="LN4781">4781</td><td class="line">	     <span class='comment'>* a file twice.</span></td></tr>
<tr class="codeline" data-linenumber="4782"><td class="num" id="LN4782">4782</td><td class="line">	     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4783"><td class="num" id="LN4783">4783</td><td class="line">	    <span class='keyword'>if</span> (fh != (BPTR)<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)	<span class='comment'>// can open file, OK</span></td></tr>
<tr class="codeline" data-linenumber="4784"><td class="num" id="LN4784">4784</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="4785"><td class="num" id="LN4785">4785</td><td class="line">		Close(fh);</td></tr>
<tr class="codeline" data-linenumber="4786"><td class="num" id="LN4786">4786</td><td class="line">		<span class='macro'>mch_remove(fname)<span class='macro_popup'>unlink((char *)(fname))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4787"><td class="num" id="LN4787">4787</td><td class="line">		<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4788"><td class="num" id="LN4788">4788</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="4789"><td class="num" id="LN4789">4789</td><td class="line">	    <span class='keyword'>if</span> (IoErr() != ERROR_OBJECT_IN_USE</td></tr>
<tr class="codeline" data-linenumber="4790"><td class="num" id="LN4790">4790</td><td class="line">					    &amp;&amp; IoErr() != ERROR_OBJECT_EXISTS)</td></tr>
<tr class="codeline" data-linenumber="4791"><td class="num" id="LN4791">4791</td><td class="line"><span class='directive'># endif</span></td></tr>
<tr class="codeline" data-linenumber="4792"><td class="num" id="LN4792">4792</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="4793"><td class="num" id="LN4793">4793</td><td class="line">		<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4794"><td class="num" id="LN4794">4794</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="4795"><td class="num" id="LN4795">4795</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4796"><td class="num" id="LN4796">4796</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4797"><td class="num" id="LN4797">4797</td><td class="line">	 <span class='comment'>* A file name equal to old_fname is OK to use.</span></td></tr>
<tr class="codeline" data-linenumber="4798"><td class="num" id="LN4798">4798</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4799"><td class="num" id="LN4799">4799</td><td class="line">	<span class='keyword'>if</span> (old_fname != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; <span class='macro'>fnamecmp(fname, old_fname)<span class='macro_popup'>vim_fnamecmp((char_u *)(fname), (char_u *)(old_fname))</span></span> == 0)</td></tr>
<tr class="codeline" data-linenumber="4800"><td class="num" id="LN4800">4800</td><td class="line">	    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4801"><td class="num" id="LN4801">4801</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4802"><td class="num" id="LN4802">4802</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4803"><td class="num" id="LN4803">4803</td><td class="line">	 <span class='comment'>* get here when file already exists</span></td></tr>
<tr class="codeline" data-linenumber="4804"><td class="num" id="LN4804">4804</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4805"><td class="num" id="LN4805">4805</td><td class="line">	<span class='keyword'>if</span> (fname[n - 2] == 'w' &amp;&amp; fname[n - 1] == 'p')	<span class='comment'>// first try</span></td></tr>
<tr class="codeline" data-linenumber="4806"><td class="num" id="LN4806">4806</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="4807"><td class="num" id="LN4807">4807</td><td class="line">	    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4808"><td class="num" id="LN4808">4808</td><td class="line">	     <span class='comment'>* on MS-DOS compatible filesystems (e.g. messydos) file.doc.swp</span></td></tr>
<tr class="codeline" data-linenumber="4809"><td class="num" id="LN4809">4809</td><td class="line">	     <span class='comment'>* and file.doc are the same file. To guess if this problem is</span></td></tr>
<tr class="codeline" data-linenumber="4810"><td class="num" id="LN4810">4810</td><td class="line">	     <span class='comment'>* present try if file.doc.swx exists. If it does, we set</span></td></tr>
<tr class="codeline" data-linenumber="4811"><td class="num" id="LN4811">4811</td><td class="line">	     <span class='comment'>* buf-&gt;b_shortname and try file_doc.swp (dots replaced by</span></td></tr>
<tr class="codeline" data-linenumber="4812"><td class="num" id="LN4812">4812</td><td class="line">	     <span class='comment'>* underscores for this file), and try again. If it doesn't we</span></td></tr>
<tr class="codeline" data-linenumber="4813"><td class="num" id="LN4813">4813</td><td class="line">	     <span class='comment'>* assume that "file.doc.swp" already exists.</span></td></tr>
<tr class="codeline" data-linenumber="4814"><td class="num" id="LN4814">4814</td><td class="line">	     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4815"><td class="num" id="LN4815">4815</td><td class="line">	    <span class='keyword'>if</span> (!(buf-&gt;b_p_sn || buf-&gt;b_shortname))	<span class='comment'>// not tried yet</span></td></tr>
<tr class="codeline" data-linenumber="4816"><td class="num" id="LN4816">4816</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="4817"><td class="num" id="LN4817">4817</td><td class="line">		fname[n - 1] = 'x';</td></tr>
<tr class="codeline" data-linenumber="4818"><td class="num" id="LN4818">4818</td><td class="line">		r = mch_getperm(fname);		<span class='comment'>// try "file.swx"</span></td></tr>
<tr class="codeline" data-linenumber="4819"><td class="num" id="LN4819">4819</td><td class="line">		fname[n - 1] = 'p';</td></tr>
<tr class="codeline" data-linenumber="4820"><td class="num" id="LN4820">4820</td><td class="line">		<span class='keyword'>if</span> (r &gt;= 0)		    <span class='comment'>// "file.swx" seems to exist</span></td></tr>
<tr class="codeline" data-linenumber="4821"><td class="num" id="LN4821">4821</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="4822"><td class="num" id="LN4822">4822</td><td class="line">		    buf-&gt;b_shortname = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4823"><td class="num" id="LN4823">4823</td><td class="line">		    vim_free(fname);</td></tr>
<tr class="codeline" data-linenumber="4824"><td class="num" id="LN4824">4824</td><td class="line">		    fname = makeswapname(buf_fname, buf-&gt;b_ffname,</td></tr>
<tr class="codeline" data-linenumber="4825"><td class="num" id="LN4825">4825</td><td class="line">							       buf, dir_name);</td></tr>
<tr class="codeline" data-linenumber="4826"><td class="num" id="LN4826">4826</td><td class="line">		    <span class='keyword'>continue</span>;	    <span class='comment'>// try again with '.' replaced with '_'</span></td></tr>
<tr class="codeline" data-linenumber="4827"><td class="num" id="LN4827">4827</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="4828"><td class="num" id="LN4828">4828</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="4829"><td class="num" id="LN4829">4829</td><td class="line">	    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4830"><td class="num" id="LN4830">4830</td><td class="line">	     <span class='comment'>* If we get here the ".swp" file really exists.</span></td></tr>
<tr class="codeline" data-linenumber="4831"><td class="num" id="LN4831">4831</td><td class="line">	     <span class='comment'>* Give an error message, unless recovering, no file name, we are</span></td></tr>
<tr class="codeline" data-linenumber="4832"><td class="num" id="LN4832">4832</td><td class="line">	     <span class='comment'>* viewing a help file or when the path of the file is different</span></td></tr>
<tr class="codeline" data-linenumber="4833"><td class="num" id="LN4833">4833</td><td class="line">	     <span class='comment'>* (happens when all .swp files are in one directory).</span></td></tr>
<tr class="codeline" data-linenumber="4834"><td class="num" id="LN4834">4834</td><td class="line">	     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4835"><td class="num" id="LN4835">4835</td><td class="line">	    <span class='keyword'>if</span> (!recoverymode &amp;&amp; buf_fname != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="4836"><td class="num" id="LN4836">4836</td><td class="line">				&amp;&amp; !buf-&gt;b_help</td></tr>
<tr class="codeline" data-linenumber="4837"><td class="num" id="LN4837">4837</td><td class="line">				&amp;&amp; !(buf-&gt;b_flags &amp; (<span class='macro'>BF_DUMMY<span class='macro_popup'>0x80</span></span> | <span class='macro'>BF_NO_SEA<span class='macro_popup'>0x400</span></span>)))</td></tr>
<tr class="codeline" data-linenumber="4838"><td class="num" id="LN4838">4838</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="4839"><td class="num" id="LN4839">4839</td><td class="line">		<span class='keyword'>int</span>		fd;</td></tr>
<tr class="codeline" data-linenumber="4840"><td class="num" id="LN4840">4840</td><td class="line">		<span class='keyword'>struct</span> block0	b0;</td></tr>
<tr class="codeline" data-linenumber="4841"><td class="num" id="LN4841">4841</td><td class="line">		<span class='keyword'>int</span>		differ = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4842"><td class="num" id="LN4842">4842</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4843"><td class="num" id="LN4843">4843</td><td class="line">		<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4844"><td class="num" id="LN4844">4844</td><td class="line">		 <span class='comment'>* Try to read block 0 from the swap file to get the original</span></td></tr>
<tr class="codeline" data-linenumber="4845"><td class="num" id="LN4845">4845</td><td class="line">		 <span class='comment'>* file name (and inode number).</span></td></tr>
<tr class="codeline" data-linenumber="4846"><td class="num" id="LN4846">4846</td><td class="line">		 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4847"><td class="num" id="LN4847">4847</td><td class="line">		fd = <span class='macro'>mch_open((<span class='keyword'>char</span> *)fname, O_RDONLY | O_EXTRA, 0)<span class='macro_popup'>open(((char *)fname), (00 | 0), (0))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4848"><td class="num" id="LN4848">4848</td><td class="line">		<span class='keyword'>if</span> (fd &gt;= 0)</td></tr>
<tr class="codeline" data-linenumber="4849"><td class="num" id="LN4849">4849</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="4850"><td class="num" id="LN4850">4850</td><td class="line">		    <span class='keyword'>if</span> (read_eintr(fd, &amp;b0, <span class='keyword'>sizeof</span>(b0)) == <span class='keyword'>sizeof</span>(b0))</td></tr>
<tr class="codeline" data-linenumber="4851"><td class="num" id="LN4851">4851</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="4852"><td class="num" id="LN4852">4852</td><td class="line">			<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4853"><td class="num" id="LN4853">4853</td><td class="line">			 <span class='comment'>* If the swapfile has the same directory as the</span></td></tr>
<tr class="codeline" data-linenumber="4854"><td class="num" id="LN4854">4854</td><td class="line">			 <span class='comment'>* buffer don't compare the directory names, they can</span></td></tr>
<tr class="codeline" data-linenumber="4855"><td class="num" id="LN4855">4855</td><td class="line">			 <span class='comment'>* have a different mountpoint.</span></td></tr>
<tr class="codeline" data-linenumber="4856"><td class="num" id="LN4856">4856</td><td class="line">			 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4857"><td class="num" id="LN4857">4857</td><td class="line">			<span class='keyword'>if</span> (b0.<span class='macro'>b0_flags<span class='macro_popup'>b0_fname[900 - 2]</span></span> &amp; <span class='macro'>B0_SAME_DIR<span class='macro_popup'>4</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4858"><td class="num" id="LN4858">4858</td><td class="line">			{</td></tr>
<tr class="codeline" data-linenumber="4859"><td class="num" id="LN4859">4859</td><td class="line">			    <span class='keyword'>if</span> (<span class='macro'>fnamecmp(gettail(buf-&gt;b_ffname),<span class='macro_popup'>vim_fnamecmp((char_u *)(gettail(buf-&gt;b_ffname)), (char_u *<br>)(gettail(b0.b0_fname)))</span></span></td></tr>
<tr class="codeline" data-linenumber="4860"><td class="num" id="LN4860">4860</td><td class="line">						   <span class='macro'>gettail(b0.b0_fname))<span class='macro_popup'>vim_fnamecmp((char_u *)(gettail(buf-&gt;b_ffname)), (char_u *<br>)(gettail(b0.b0_fname)))</span></span> != 0</td></tr>
<tr class="codeline" data-linenumber="4861"><td class="num" id="LN4861">4861</td><td class="line">				    || !same_directory(fname, buf-&gt;b_ffname))</td></tr>
<tr class="codeline" data-linenumber="4862"><td class="num" id="LN4862">4862</td><td class="line">			    {</td></tr>
<tr class="codeline" data-linenumber="4863"><td class="num" id="LN4863">4863</td><td class="line"><span class='directive'>#ifdef CHECK_INODE</span></td></tr>
<tr class="codeline" data-linenumber="4864"><td class="num" id="LN4864">4864</td><td class="line">				<span class='comment'>// Symlinks may point to the same file even</span></td></tr>
<tr class="codeline" data-linenumber="4865"><td class="num" id="LN4865">4865</td><td class="line">				<span class='comment'>// when the name differs, need to check the</span></td></tr>
<tr class="codeline" data-linenumber="4866"><td class="num" id="LN4866">4866</td><td class="line">				<span class='comment'>// inode too.</span></td></tr>
<tr class="codeline" data-linenumber="4867"><td class="num" id="LN4867">4867</td><td class="line">				expand_env(b0.b0_fname, NameBuff, <span class='macro'>MAXPATHL<span class='macro_popup'>4096</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4868"><td class="num" id="LN4868">4868</td><td class="line">				<span class='keyword'>if</span> (fnamecmp_ino(buf-&gt;b_ffname, NameBuff,</td></tr>
<tr class="codeline" data-linenumber="4869"><td class="num" id="LN4869">4869</td><td class="line">						     char_to_long(b0.b0_ino)))</td></tr>
<tr class="codeline" data-linenumber="4870"><td class="num" id="LN4870">4870</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="4871"><td class="num" id="LN4871">4871</td><td class="line">				    differ = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4872"><td class="num" id="LN4872">4872</td><td class="line">			    }</td></tr>
<tr class="codeline" data-linenumber="4873"><td class="num" id="LN4873">4873</td><td class="line">			}</td></tr>
<tr class="codeline" data-linenumber="4874"><td class="num" id="LN4874">4874</td><td class="line">			<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="4875"><td class="num" id="LN4875">4875</td><td class="line">			{</td></tr>
<tr class="codeline" data-linenumber="4876"><td class="num" id="LN4876">4876</td><td class="line">			    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4877"><td class="num" id="LN4877">4877</td><td class="line">			     <span class='comment'>* The name in the swap file may be</span></td></tr>
<tr class="codeline" data-linenumber="4878"><td class="num" id="LN4878">4878</td><td class="line">			     <span class='comment'>* "~user/path/file".  Expand it first.</span></td></tr>
<tr class="codeline" data-linenumber="4879"><td class="num" id="LN4879">4879</td><td class="line">			     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4880"><td class="num" id="LN4880">4880</td><td class="line">			    expand_env(b0.b0_fname, NameBuff, <span class='macro'>MAXPATHL<span class='macro_popup'>4096</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4881"><td class="num" id="LN4881">4881</td><td class="line"><span class='directive'>#ifdef CHECK_INODE</span></td></tr>
<tr class="codeline" data-linenumber="4882"><td class="num" id="LN4882">4882</td><td class="line">			    <span class='keyword'>if</span> (fnamecmp_ino(buf-&gt;b_ffname, NameBuff,</td></tr>
<tr class="codeline" data-linenumber="4883"><td class="num" id="LN4883">4883</td><td class="line">						     char_to_long(b0.b0_ino)))</td></tr>
<tr class="codeline" data-linenumber="4884"><td class="num" id="LN4884">4884</td><td class="line">				differ = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4885"><td class="num" id="LN4885">4885</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="4886"><td class="num" id="LN4886">4886</td><td class="line">			    <span class='keyword'>if</span> (<span class='macro'>fnamecmp(NameBuff, buf-&gt;b_ffname)<span class='macro_popup'>vim_fnamecmp((char_u *)(NameBuff), (char_u *)(buf-&gt;b_ffname<br>))</span></span> != 0)</td></tr>
<tr class="codeline" data-linenumber="4887"><td class="num" id="LN4887">4887</td><td class="line">				differ = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4888"><td class="num" id="LN4888">4888</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="4889"><td class="num" id="LN4889">4889</td><td class="line">			}</td></tr>
<tr class="codeline" data-linenumber="4890"><td class="num" id="LN4890">4890</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="4891"><td class="num" id="LN4891">4891</td><td class="line">		    close(fd);</td></tr>
<tr class="codeline" data-linenumber="4892"><td class="num" id="LN4892">4892</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="4893"><td class="num" id="LN4893">4893</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4894"><td class="num" id="LN4894">4894</td><td class="line">		<span class='comment'>// give the ATTENTION message when there is an old swap file</span></td></tr>
<tr class="codeline" data-linenumber="4895"><td class="num" id="LN4895">4895</td><td class="line">		<span class='comment'>// for the current file, and the buffer was not recovered.</span></td></tr>
<tr class="codeline" data-linenumber="4896"><td class="num" id="LN4896">4896</td><td class="line">		<span class='keyword'>if</span> (differ == <span class='macro'>FALSE<span class='macro_popup'>0</span></span> &amp;&amp; !(curbuf-&gt;b_flags &amp; <span class='macro'>BF_RECOVERED<span class='macro_popup'>0x01</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4897"><td class="num" id="LN4897">4897</td><td class="line">			&amp;&amp; vim_strchr(p_shm, <span class='macro'>SHM_ATTENTION<span class='macro_popup'>'A'</span></span>) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4898"><td class="num" id="LN4898">4898</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="4899"><td class="num" id="LN4899">4899</td><td class="line">		    <span class='keyword'>int</span>		choice = 0;</td></tr>
<tr class="codeline" data-linenumber="4900"><td class="num" id="LN4900">4900</td><td class="line">		    stat_T	st;</td></tr>
<tr class="codeline" data-linenumber="4901"><td class="num" id="LN4901">4901</td><td class="line"><span class='directive'>#ifdef CREATE_DUMMY_FILE</span></td></tr>
<tr class="codeline" data-linenumber="4902"><td class="num" id="LN4902">4902</td><td class="line">		    <span class='keyword'>int</span>		did_use_dummy = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4903"><td class="num" id="LN4903">4903</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4904"><td class="num" id="LN4904">4904</td><td class="line">		    <span class='comment'>// Avoid getting a warning for the file being created</span></td></tr>
<tr class="codeline" data-linenumber="4905"><td class="num" id="LN4905">4905</td><td class="line">		    <span class='comment'>// outside of Vim, it was created at the start of this</span></td></tr>
<tr class="codeline" data-linenumber="4906"><td class="num" id="LN4906">4906</td><td class="line">		    <span class='comment'>// function.  Delete the file now, because Vim might exit</span></td></tr>
<tr class="codeline" data-linenumber="4907"><td class="num" id="LN4907">4907</td><td class="line">		    <span class='comment'>// here if the window is closed.</span></td></tr>
<tr class="codeline" data-linenumber="4908"><td class="num" id="LN4908">4908</td><td class="line">		    <span class='keyword'>if</span> (dummyfd != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4909"><td class="num" id="LN4909">4909</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="4910"><td class="num" id="LN4910">4910</td><td class="line">			fclose(dummyfd);</td></tr>
<tr class="codeline" data-linenumber="4911"><td class="num" id="LN4911">4911</td><td class="line">			dummyfd = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4912"><td class="num" id="LN4912">4912</td><td class="line">			<span class='macro'>mch_remove(buf_fname)<span class='macro_popup'>unlink((char *)(buf_fname))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4913"><td class="num" id="LN4913">4913</td><td class="line">			did_use_dummy = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4914"><td class="num" id="LN4914">4914</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="4915"><td class="num" id="LN4915">4915</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="4916"><td class="num" id="LN4916">4916</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4917"><td class="num" id="LN4917">4917</td><td class="line"><span class='directive'>#ifdef HAVE_PROCESS_STILL_RUNNING</span></td></tr>
<tr class="codeline" data-linenumber="4918"><td class="num" id="LN4918">4918</td><td class="line">		    process_still_running = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4919"><td class="num" id="LN4919">4919</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="4920"><td class="num" id="LN4920">4920</td><td class="line">		    <span class='comment'>// It's safe to delete the swap file if all these are true:</span></td></tr>
<tr class="codeline" data-linenumber="4921"><td class="num" id="LN4921">4921</td><td class="line">		    <span class='comment'>// - the edited file exists</span></td></tr>
<tr class="codeline" data-linenumber="4922"><td class="num" id="LN4922">4922</td><td class="line">		    <span class='comment'>// - the swap file has no changes and looks OK</span></td></tr>
<tr class="codeline" data-linenumber="4923"><td class="num" id="LN4923">4923</td><td class="line">		    <span class='keyword'>if</span> (<span class='macro'>mch_stat((<span class='keyword'>char</span> *)buf-&gt;b_fname, &amp;st)<span class='macro_popup'>stat(((char *)buf-&gt;b_fname), (&amp;st))</span></span> == 0</td></tr>
<tr class="codeline" data-linenumber="4924"><td class="num" id="LN4924">4924</td><td class="line">						  &amp;&amp; swapfile_unchanged(fname))</td></tr>
<tr class="codeline" data-linenumber="4925"><td class="num" id="LN4925">4925</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="4926"><td class="num" id="LN4926">4926</td><td class="line">			choice = 4;</td></tr>
<tr class="codeline" data-linenumber="4927"><td class="num" id="LN4927">4927</td><td class="line">			<span class='keyword'>if</span> (p_verbose &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="4928"><td class="num" id="LN4928">4928</td><td class="line">			    verb_msg(<span class='macro'>_(<span class='string_literal'>"Found a swap file that is not useful, deleting it"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("Found a swap file that is not useful, deleting it"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4929"><td class="num" id="LN4929">4929</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="4930"><td class="num" id="LN4930">4930</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4931"><td class="num" id="LN4931">4931</td><td class="line"><span class='directive'>#if defined(FEAT_EVAL)</span></td></tr>
<tr class="codeline" data-linenumber="4932"><td class="num" id="LN4932">4932</td><td class="line">		    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="4933"><td class="num" id="LN4933">4933</td><td class="line">		     <span class='comment'>* If there is an SwapExists autocommand and we can handle</span></td></tr>
<tr class="codeline" data-linenumber="4934"><td class="num" id="LN4934">4934</td><td class="line">		     <span class='comment'>* the response, trigger it.  It may return 0 to ask the</span></td></tr>
<tr class="codeline" data-linenumber="4935"><td class="num" id="LN4935">4935</td><td class="line">		     <span class='comment'>* user anyway.</span></td></tr>
<tr class="codeline" data-linenumber="4936"><td class="num" id="LN4936">4936</td><td class="line">		     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="4937"><td class="num" id="LN4937">4937</td><td class="line">		    <span class='keyword'>if</span> (choice == 0</td></tr>
<tr class="codeline" data-linenumber="4938"><td class="num" id="LN4938">4938</td><td class="line">			    &amp;&amp; swap_exists_action != <span class='macro'>SEA_NONE<span class='macro_popup'>0</span></span></td></tr>
<tr class="codeline" data-linenumber="4939"><td class="num" id="LN4939">4939</td><td class="line">			    &amp;&amp; has_autocmd(EVENT_SWAPEXISTS, buf_fname, buf))</td></tr>
<tr class="codeline" data-linenumber="4940"><td class="num" id="LN4940">4940</td><td class="line">			choice = do_swapexists(buf, fname);</td></tr>
<tr class="codeline" data-linenumber="4941"><td class="num" id="LN4941">4941</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4942"><td class="num" id="LN4942">4942</td><td class="line">		    <span class='keyword'>if</span> (choice == 0)</td></tr>
<tr class="codeline" data-linenumber="4943"><td class="num" id="LN4943">4943</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="4944"><td class="num" id="LN4944">4944</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="4945"><td class="num" id="LN4945">4945</td><td class="line"><span class='directive'>#ifdef FEAT_GUI</span></td></tr>
<tr class="codeline" data-linenumber="4946"><td class="num" id="LN4946">4946</td><td class="line">			<span class='comment'>// If we are supposed to start the GUI but it wasn't</span></td></tr>
<tr class="codeline" data-linenumber="4947"><td class="num" id="LN4947">4947</td><td class="line">			<span class='comment'>// completely started yet, start it now.  This makes</span></td></tr>
<tr class="codeline" data-linenumber="4948"><td class="num" id="LN4948">4948</td><td class="line">			<span class='comment'>// the messages displayed in the Vim window when</span></td></tr>
<tr class="codeline" data-linenumber="4949"><td class="num" id="LN4949">4949</td><td class="line">			<span class='comment'>// loading a session from the .gvimrc file.</span></td></tr>
<tr class="codeline" data-linenumber="4950"><td class="num" id="LN4950">4950</td><td class="line">			<span class='keyword'>if</span> (gui.starting &amp;&amp; !gui.in_use)</td></tr>
<tr class="codeline" data-linenumber="4951"><td class="num" id="LN4951">4951</td><td class="line">			    gui_start(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4952"><td class="num" id="LN4952">4952</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="4953"><td class="num" id="LN4953">4953</td><td class="line">			<span class='comment'>// Show info about the existing swap file.</span></td></tr>
<tr class="codeline" data-linenumber="4954"><td class="num" id="LN4954">4954</td><td class="line">			attention_message(buf, fname);</td></tr>
<tr class="codeline" data-linenumber="4955"><td class="num" id="LN4955">4955</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4956"><td class="num" id="LN4956">4956</td><td class="line">			<span class='comment'>// We don't want a 'q' typed at the more-prompt</span></td></tr>
<tr class="codeline" data-linenumber="4957"><td class="num" id="LN4957">4957</td><td class="line">			<span class='comment'>// interrupt loading a file.</span></td></tr>
<tr class="codeline" data-linenumber="4958"><td class="num" id="LN4958">4958</td><td class="line">			got_int = <span class='macro'>FALSE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4959"><td class="num" id="LN4959">4959</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4960"><td class="num" id="LN4960">4960</td><td class="line">			<span class='comment'>// If vimrc has "simalt ~x" we don't want it to</span></td></tr>
<tr class="codeline" data-linenumber="4961"><td class="num" id="LN4961">4961</td><td class="line">			<span class='comment'>// interfere with the prompt here.</span></td></tr>
<tr class="codeline" data-linenumber="4962"><td class="num" id="LN4962">4962</td><td class="line">			flush_buffers(FLUSH_TYPEAHEAD);</td></tr>
<tr class="codeline" data-linenumber="4963"><td class="num" id="LN4963">4963</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="4964"><td class="num" id="LN4964">4964</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4965"><td class="num" id="LN4965">4965</td><td class="line"><span class='directive'>#if defined(FEAT_GUI_DIALOG) || defined(FEAT_CON_DIALOG)</span></td></tr>
<tr class="codeline" data-linenumber="4966"><td class="num" id="LN4966">4966</td><td class="line">		    <span class='keyword'>if</span> (swap_exists_action != <span class='macro'>SEA_NONE<span class='macro_popup'>0</span></span> &amp;&amp; choice == 0)</td></tr>
<tr class="codeline" data-linenumber="4967"><td class="num" id="LN4967">4967</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="4968"><td class="num" id="LN4968">4968</td><td class="line">			char_u	*name;</td></tr>
<tr class="codeline" data-linenumber="4969"><td class="num" id="LN4969">4969</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4970"><td class="num" id="LN4970">4970</td><td class="line">			name = alloc(<span class='macro'>STRLEN(fname)<span class='macro_popup'>strlen((char *)(fname))</span></span></td></tr>
<tr class="codeline" data-linenumber="4971"><td class="num" id="LN4971">4971</td><td class="line">				+ <span class='macro'>STRLEN(_(<span class='string_literal'>"Swap file \""</span>))<span class='macro_popup'>strlen((char *)(dcgettext (((void*)0), (char *)("Swap file \""<br>), 5)))</span></span></td></tr>
<tr class="codeline" data-linenumber="4972"><td class="num" id="LN4972">4972</td><td class="line">				+ <span class='macro'>STRLEN(_(<span class='string_literal'>"\" already exists!"</span>))<span class='macro_popup'>strlen((char *)(dcgettext (((void*)0), (char *)("\" already exists!"<br>), 5)))</span></span> + 5);</td></tr>
<tr class="codeline" data-linenumber="4973"><td class="num" id="LN4973">4973</td><td class="line">			<span class='keyword'>if</span> (name != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4974"><td class="num" id="LN4974">4974</td><td class="line">			{</td></tr>
<tr class="codeline" data-linenumber="4975"><td class="num" id="LN4975">4975</td><td class="line">			    <span class='macro'>STRCPY(name, _(<span class='string_literal'>"Swap file \""</span>))<span class='macro_popup'>strcpy((char *)(name), (char *)(dcgettext (((void*)0), (char *<br>)("Swap file \""), 5)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4976"><td class="num" id="LN4976">4976</td><td class="line">			    home_replace(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, fname, name + <span class='macro'>STRLEN(name)<span class='macro_popup'>strlen((char *)(name))</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4977"><td class="num" id="LN4977">4977</td><td class="line">								  1000, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4978"><td class="num" id="LN4978">4978</td><td class="line">			    <span class='macro'>STRCAT(name, _(<span class='string_literal'>"\" already exists!"</span>))<span class='macro_popup'>strcat((char *)(name), (char *)(dcgettext (((void*)0), (char *<br>)("\" already exists!"), 5)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4979"><td class="num" id="LN4979">4979</td><td class="line">			}</td></tr>
<tr class="codeline" data-linenumber="4980"><td class="num" id="LN4980">4980</td><td class="line">			choice = do_dialog(<span class='macro'>VIM_WARNING<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4981"><td class="num" id="LN4981">4981</td><td class="line">				    (char_u *)<span class='macro'>_(<span class='string_literal'>"VIM - ATTENTION"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("VIM - ATTENTION"), 5)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4982"><td class="num" id="LN4982">4982</td><td class="line">				    name == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="4983"><td class="num" id="LN4983">4983</td><td class="line">					?  (char_u *)<span class='macro'>_(<span class='string_literal'>"Swap file already exists!"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("Swap file already exists!"),<br> 5)</span></span></td></tr>
<tr class="codeline" data-linenumber="4984"><td class="num" id="LN4984">4984</td><td class="line">					: name,</td></tr>
<tr class="codeline" data-linenumber="4985"><td class="num" id="LN4985">4985</td><td class="line"><span class='directive'># ifdef HAVE_PROCESS_STILL_RUNNING</span></td></tr>
<tr class="codeline" data-linenumber="4986"><td class="num" id="LN4986">4986</td><td class="line">				    process_still_running</td></tr>
<tr class="codeline" data-linenumber="4987"><td class="num" id="LN4987">4987</td><td class="line">					? (char_u *)<span class='macro'>_(<span class='string_literal'>"&amp;Open Read-Only\n&amp;Edit anyway\n&amp;Recover\n&amp;Quit\n&amp;Abort"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("&amp;Open Read-Only\n&amp;Edit anyway\n&amp;Recover\n&amp;Quit\n&amp;Abort"<br>), 5)</span></span> :</td></tr>
<tr class="codeline" data-linenumber="4988"><td class="num" id="LN4988">4988</td><td class="line"><span class='directive'># endif</span></td></tr>
<tr class="codeline" data-linenumber="4989"><td class="num" id="LN4989">4989</td><td class="line">					(char_u *)<span class='macro'>_(<span class='string_literal'>"&amp;Open Read-Only\n&amp;Edit anyway\n&amp;Recover\n&amp;Delete it\n&amp;Quit\n&amp;Abort"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("&amp;Open Read-Only\n&amp;Edit anyway\n&amp;Recover\n&amp;Delete it\n&amp;Quit\n&amp;Abort"<br>), 5)</span></span>, 1, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4990"><td class="num" id="LN4990">4990</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4991"><td class="num" id="LN4991">4991</td><td class="line"><span class='directive'># ifdef HAVE_PROCESS_STILL_RUNNING</span></td></tr>
<tr class="codeline" data-linenumber="4992"><td class="num" id="LN4992">4992</td><td class="line">			<span class='keyword'>if</span> (process_still_running &amp;&amp; choice &gt;= 4)</td></tr>
<tr class="codeline" data-linenumber="4993"><td class="num" id="LN4993">4993</td><td class="line">			    choice++;	<span class='comment'>// Skip missing "Delete it" button</span></td></tr>
<tr class="codeline" data-linenumber="4994"><td class="num" id="LN4994">4994</td><td class="line"><span class='directive'># endif</span></td></tr>
<tr class="codeline" data-linenumber="4995"><td class="num" id="LN4995">4995</td><td class="line">			vim_free(name);</td></tr>
<tr class="codeline" data-linenumber="4996"><td class="num" id="LN4996">4996</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4997"><td class="num" id="LN4997">4997</td><td class="line">			<span class='comment'>// pretend screen didn't scroll, need redraw anyway</span></td></tr>
<tr class="codeline" data-linenumber="4998"><td class="num" id="LN4998">4998</td><td class="line">			msg_scrolled = 0;</td></tr>
<tr class="codeline" data-linenumber="4999"><td class="num" id="LN4999">4999</td><td class="line">			redraw_all_later(<span class='macro'>NOT_VALID<span class='macro_popup'>40</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5000"><td class="num" id="LN5000">5000</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="5001"><td class="num" id="LN5001">5001</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="5002"><td class="num" id="LN5002">5002</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5003"><td class="num" id="LN5003">5003</td><td class="line">		    <span class='keyword'>if</span> (choice &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="5004"><td class="num" id="LN5004">5004</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="5005"><td class="num" id="LN5005">5005</td><td class="line">			<span class='keyword'>switch</span> (choice)</td></tr>
<tr class="codeline" data-linenumber="5006"><td class="num" id="LN5006">5006</td><td class="line">			{</td></tr>
<tr class="codeline" data-linenumber="5007"><td class="num" id="LN5007">5007</td><td class="line">			    <span class='keyword'>case</span> 1:</td></tr>
<tr class="codeline" data-linenumber="5008"><td class="num" id="LN5008">5008</td><td class="line">				buf-&gt;b_p_ro = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5009"><td class="num" id="LN5009">5009</td><td class="line">				<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5010"><td class="num" id="LN5010">5010</td><td class="line">			    <span class='keyword'>case</span> 2:</td></tr>
<tr class="codeline" data-linenumber="5011"><td class="num" id="LN5011">5011</td><td class="line">				<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5012"><td class="num" id="LN5012">5012</td><td class="line">			    <span class='keyword'>case</span> 3:</td></tr>
<tr class="codeline" data-linenumber="5013"><td class="num" id="LN5013">5013</td><td class="line">				swap_exists_action = <span class='macro'>SEA_RECOVER<span class='macro_popup'>3</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5014"><td class="num" id="LN5014">5014</td><td class="line">				<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5015"><td class="num" id="LN5015">5015</td><td class="line">			    <span class='keyword'>case</span> 4:</td></tr>
<tr class="codeline" data-linenumber="5016"><td class="num" id="LN5016">5016</td><td class="line">				<span class='macro'>mch_remove(fname)<span class='macro_popup'>unlink((char *)(fname))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5017"><td class="num" id="LN5017">5017</td><td class="line">				<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5018"><td class="num" id="LN5018">5018</td><td class="line">			    <span class='keyword'>case</span> 5:</td></tr>
<tr class="codeline" data-linenumber="5019"><td class="num" id="LN5019">5019</td><td class="line">				swap_exists_action = <span class='macro'>SEA_QUIT<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5020"><td class="num" id="LN5020">5020</td><td class="line">				<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5021"><td class="num" id="LN5021">5021</td><td class="line">			    <span class='keyword'>case</span> 6:</td></tr>
<tr class="codeline" data-linenumber="5022"><td class="num" id="LN5022">5022</td><td class="line">				swap_exists_action = <span class='macro'>SEA_QUIT<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5023"><td class="num" id="LN5023">5023</td><td class="line">				got_int = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5024"><td class="num" id="LN5024">5024</td><td class="line">				<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5025"><td class="num" id="LN5025">5025</td><td class="line">			}</td></tr>
<tr class="codeline" data-linenumber="5026"><td class="num" id="LN5026">5026</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5027"><td class="num" id="LN5027">5027</td><td class="line">			<span class='comment'>// If the file was deleted this fname can be used.</span></td></tr>
<tr class="codeline" data-linenumber="5028"><td class="num" id="LN5028">5028</td><td class="line">			<span class='keyword'>if</span> (mch_getperm(fname) &lt; 0)</td></tr>
<tr class="codeline" data-linenumber="5029"><td class="num" id="LN5029">5029</td><td class="line">			    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5030"><td class="num" id="LN5030">5030</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="5031"><td class="num" id="LN5031">5031</td><td class="line">		    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="5032"><td class="num" id="LN5032">5032</td><td class="line">		    {</td></tr>
<tr class="codeline" data-linenumber="5033"><td class="num" id="LN5033">5033</td><td class="line">			msg_puts(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="5034"><td class="num" id="LN5034">5034</td><td class="line">			<span class='keyword'>if</span> (msg_silent == 0)</td></tr>
<tr class="codeline" data-linenumber="5035"><td class="num" id="LN5035">5035</td><td class="line">			    <span class='comment'>// call wait_return() later</span></td></tr>
<tr class="codeline" data-linenumber="5036"><td class="num" id="LN5036">5036</td><td class="line">			    need_wait_return = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5037"><td class="num" id="LN5037">5037</td><td class="line">		    }</td></tr>
<tr class="codeline" data-linenumber="5038"><td class="num" id="LN5038">5038</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5039"><td class="num" id="LN5039">5039</td><td class="line"><span class='directive'>#ifdef CREATE_DUMMY_FILE</span></td></tr>
<tr class="codeline" data-linenumber="5040"><td class="num" id="LN5040">5040</td><td class="line">		    <span class='comment'>// Going to try another name, need the dummy file again.</span></td></tr>
<tr class="codeline" data-linenumber="5041"><td class="num" id="LN5041">5041</td><td class="line">		    <span class='keyword'>if</span> (did_use_dummy)</td></tr>
<tr class="codeline" data-linenumber="5042"><td class="num" id="LN5042">5042</td><td class="line">			dummyfd = <span class='macro'>mch_fopen((<span class='keyword'>char</span> *)buf_fname, <span class='string_literal'>"w"</span>)<span class='macro_popup'>fopen(((char *)buf_fname), ("w"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5043"><td class="num" id="LN5043">5043</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="5044"><td class="num" id="LN5044">5044</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="5045"><td class="num" id="LN5045">5045</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="5046"><td class="num" id="LN5046">5046</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="5047"><td class="num" id="LN5047">5047</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5048"><td class="num" id="LN5048">5048</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="5049"><td class="num" id="LN5049">5049</td><td class="line">	 <span class='comment'>* Change the ".swp" extension to find another file that can be used.</span></td></tr>
<tr class="codeline" data-linenumber="5050"><td class="num" id="LN5050">5050</td><td class="line">	 <span class='comment'>* First decrement the last char: ".swo", ".swn", etc.</span></td></tr>
<tr class="codeline" data-linenumber="5051"><td class="num" id="LN5051">5051</td><td class="line">	 <span class='comment'>* If that still isn't enough decrement the last but one char: ".svz"</span></td></tr>
<tr class="codeline" data-linenumber="5052"><td class="num" id="LN5052">5052</td><td class="line">	 <span class='comment'>* Can happen when editing many "No Name" buffers.</span></td></tr>
<tr class="codeline" data-linenumber="5053"><td class="num" id="LN5053">5053</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="5054"><td class="num" id="LN5054">5054</td><td class="line">	<span class='keyword'>if</span> (fname[n - 1] == 'a')	<span class='comment'>// ".s?a"</span></td></tr>
<tr class="codeline" data-linenumber="5055"><td class="num" id="LN5055">5055</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="5056"><td class="num" id="LN5056">5056</td><td class="line">	    <span class='keyword'>if</span> (fname[n - 2] == 'a')    <span class='comment'>// ".saa": tried enough, give up</span></td></tr>
<tr class="codeline" data-linenumber="5057"><td class="num" id="LN5057">5057</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="5058"><td class="num" id="LN5058">5058</td><td class="line">		emsg(<span class='macro'>_(<span class='string_literal'>"E326: Too many swap files found"</span>)<span class='macro_popup'>dcgettext (((void*)0), (char *)("E326: Too many swap files found"<br>), 5)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5059"><td class="num" id="LN5059">5059</td><td class="line">		<span class='macro'>VIM_CLEAR(fname)<span class='macro_popup'>do { if ((fname) != ((void*)0)) { vim_free(fname); (fname) = (<br>(void*)0); } } while (0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5060"><td class="num" id="LN5060">5060</td><td class="line">		<span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5061"><td class="num" id="LN5061">5061</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="5062"><td class="num" id="LN5062">5062</td><td class="line">	    --fname[n - 2];		<span class='comment'>// ".svz", ".suz", etc.</span></td></tr>
<tr class="codeline" data-linenumber="5063"><td class="num" id="LN5063">5063</td><td class="line">	    fname[n - 1] = 'z' + 1;</td></tr>
<tr class="codeline" data-linenumber="5064"><td class="num" id="LN5064">5064</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="5065"><td class="num" id="LN5065">5065</td><td class="line">	--fname[n - 1];			<span class='comment'>// ".swo", ".swn", etc.</span></td></tr>
<tr class="codeline" data-linenumber="5066"><td class="num" id="LN5066">5066</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5067"><td class="num" id="LN5067">5067</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5068"><td class="num" id="LN5068">5068</td><td class="line">    vim_free(dir_name);</td></tr>
<tr class="codeline" data-linenumber="5069"><td class="num" id="LN5069">5069</td><td class="line"><span class='directive'>#ifdef CREATE_DUMMY_FILE</span></td></tr>
<tr class="codeline" data-linenumber="5070"><td class="num" id="LN5070">5070</td><td class="line">    <span class='keyword'>if</span> (dummyfd != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)	<span class='comment'>// file has been created temporarily</span></td></tr>
<tr class="codeline" data-linenumber="5071"><td class="num" id="LN5071">5071</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="5072"><td class="num" id="LN5072">5072</td><td class="line">	fclose(dummyfd);</td></tr>
<tr class="codeline" data-linenumber="5073"><td class="num" id="LN5073">5073</td><td class="line">	<span class='macro'>mch_remove(buf_fname)<span class='macro_popup'>unlink((char *)(buf_fname))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5074"><td class="num" id="LN5074">5074</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5075"><td class="num" id="LN5075">5075</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="5076"><td class="num" id="LN5076">5076</td><td class="line"><span class='directive'>#ifdef MSWIN</span></td></tr>
<tr class="codeline" data-linenumber="5077"><td class="num" id="LN5077">5077</td><td class="line">    <span class='keyword'>if</span> (buf_fname != buf-&gt;b_fname)</td></tr>
<tr class="codeline" data-linenumber="5078"><td class="num" id="LN5078">5078</td><td class="line">	vim_free(buf_fname);</td></tr>
<tr class="codeline" data-linenumber="5079"><td class="num" id="LN5079">5079</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="5080"><td class="num" id="LN5080">5080</td><td class="line">    <span class='keyword'>return</span> fname;</td></tr>
<tr class="codeline" data-linenumber="5081"><td class="num" id="LN5081">5081</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5082"><td class="num" id="LN5082">5082</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5083"><td class="num" id="LN5083">5083</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="5084"><td class="num" id="LN5084">5084</td><td class="line">b0_magic_wrong(ZERO_BL *b0p)</td></tr>
<tr class="codeline" data-linenumber="5085"><td class="num" id="LN5085">5085</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="5086"><td class="num" id="LN5086">5086</td><td class="line">    <span class='keyword'>return</span> (b0p-&gt;b0_magic_long != (<span class='keyword'>long</span>)<span class='macro'>B0_MAGIC_LONG<span class='macro_popup'>0x30313233L</span></span></td></tr>
<tr class="codeline" data-linenumber="5087"><td class="num" id="LN5087">5087</td><td class="line">	    || b0p-&gt;b0_magic_int != (<span class='keyword'>int</span>)<span class='macro'>B0_MAGIC_INT<span class='macro_popup'>0x20212223L</span></span></td></tr>
<tr class="codeline" data-linenumber="5088"><td class="num" id="LN5088">5088</td><td class="line">	    || b0p-&gt;b0_magic_short != (<span class='keyword'>short</span>)<span class='macro'>B0_MAGIC_SHORT<span class='macro_popup'>0x10111213L</span></span></td></tr>
<tr class="codeline" data-linenumber="5089"><td class="num" id="LN5089">5089</td><td class="line">	    || b0p-&gt;b0_magic_char != <span class='macro'>B0_MAGIC_CHAR<span class='macro_popup'>0x55</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5090"><td class="num" id="LN5090">5090</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5091"><td class="num" id="LN5091">5091</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5092"><td class="num" id="LN5092">5092</td><td class="line"><span class='directive'>#ifdef CHECK_INODE</span></td></tr>
<tr class="codeline" data-linenumber="5093"><td class="num" id="LN5093">5093</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="5094"><td class="num" id="LN5094">5094</td><td class="line"> <span class='comment'>* Compare current file name with file name from swap file.</span></td></tr>
<tr class="codeline" data-linenumber="5095"><td class="num" id="LN5095">5095</td><td class="line"> <span class='comment'>* Try to use inode numbers when possible.</span></td></tr>
<tr class="codeline" data-linenumber="5096"><td class="num" id="LN5096">5096</td><td class="line"> <span class='comment'>* Return non-zero when files are different.</span></td></tr>
<tr class="codeline" data-linenumber="5097"><td class="num" id="LN5097">5097</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="5098"><td class="num" id="LN5098">5098</td><td class="line"> <span class='comment'>* When comparing file names a few things have to be taken into consideration:</span></td></tr>
<tr class="codeline" data-linenumber="5099"><td class="num" id="LN5099">5099</td><td class="line"> <span class='comment'>* - When working over a network the full path of a file depends on the host.</span></td></tr>
<tr class="codeline" data-linenumber="5100"><td class="num" id="LN5100">5100</td><td class="line"> <span class='comment'>*   We check the inode number if possible.  It is not 100% reliable though,</span></td></tr>
<tr class="codeline" data-linenumber="5101"><td class="num" id="LN5101">5101</td><td class="line"> <span class='comment'>*   because the device number cannot be used over a network.</span></td></tr>
<tr class="codeline" data-linenumber="5102"><td class="num" id="LN5102">5102</td><td class="line"> <span class='comment'>* - When a file does not exist yet (editing a new file) there is no inode</span></td></tr>
<tr class="codeline" data-linenumber="5103"><td class="num" id="LN5103">5103</td><td class="line"> <span class='comment'>*   number.</span></td></tr>
<tr class="codeline" data-linenumber="5104"><td class="num" id="LN5104">5104</td><td class="line"> <span class='comment'>* - The file name in a swap file may not be valid on the current host.  The</span></td></tr>
<tr class="codeline" data-linenumber="5105"><td class="num" id="LN5105">5105</td><td class="line"> <span class='comment'>*   "~user" form is used whenever possible to avoid this.</span></td></tr>
<tr class="codeline" data-linenumber="5106"><td class="num" id="LN5106">5106</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="5107"><td class="num" id="LN5107">5107</td><td class="line"> <span class='comment'>* This is getting complicated, let's make a table:</span></td></tr>
<tr class="codeline" data-linenumber="5108"><td class="num" id="LN5108">5108</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="5109"><td class="num" id="LN5109">5109</td><td class="line"> <span class='comment'>*		ino_c  ino_s  fname_c  fname_s	differ =</span></td></tr>
<tr class="codeline" data-linenumber="5110"><td class="num" id="LN5110">5110</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="5111"><td class="num" id="LN5111">5111</td><td class="line"> <span class='comment'>* both files exist -&gt; compare inode numbers:</span></td></tr>
<tr class="codeline" data-linenumber="5112"><td class="num" id="LN5112">5112</td><td class="line"> <span class='comment'>*		!= 0   != 0	X	 X	ino_c != ino_s</span></td></tr>
<tr class="codeline" data-linenumber="5113"><td class="num" id="LN5113">5113</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="5114"><td class="num" id="LN5114">5114</td><td class="line"> <span class='comment'>* inode number(s) unknown, file names available -&gt; compare file names</span></td></tr>
<tr class="codeline" data-linenumber="5115"><td class="num" id="LN5115">5115</td><td class="line"> <span class='comment'>*		== 0	X	OK	 OK	fname_c != fname_s</span></td></tr>
<tr class="codeline" data-linenumber="5116"><td class="num" id="LN5116">5116</td><td class="line"> <span class='comment'>*		 X     == 0	OK	 OK	fname_c != fname_s</span></td></tr>
<tr class="codeline" data-linenumber="5117"><td class="num" id="LN5117">5117</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="5118"><td class="num" id="LN5118">5118</td><td class="line"> <span class='comment'>* current file doesn't exist, file for swap file exist, file name(s) not</span></td></tr>
<tr class="codeline" data-linenumber="5119"><td class="num" id="LN5119">5119</td><td class="line"> <span class='comment'>* available -&gt; probably different</span></td></tr>
<tr class="codeline" data-linenumber="5120"><td class="num" id="LN5120">5120</td><td class="line"> <span class='comment'>*		== 0   != 0    FAIL	 X	TRUE</span></td></tr>
<tr class="codeline" data-linenumber="5121"><td class="num" id="LN5121">5121</td><td class="line"> <span class='comment'>*		== 0   != 0	X	FAIL	TRUE</span></td></tr>
<tr class="codeline" data-linenumber="5122"><td class="num" id="LN5122">5122</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="5123"><td class="num" id="LN5123">5123</td><td class="line"> <span class='comment'>* current file exists, inode for swap unknown, file name(s) not</span></td></tr>
<tr class="codeline" data-linenumber="5124"><td class="num" id="LN5124">5124</td><td class="line"> <span class='comment'>* available -&gt; probably different</span></td></tr>
<tr class="codeline" data-linenumber="5125"><td class="num" id="LN5125">5125</td><td class="line"> <span class='comment'>*		!= 0   == 0    FAIL	 X	TRUE</span></td></tr>
<tr class="codeline" data-linenumber="5126"><td class="num" id="LN5126">5126</td><td class="line"> <span class='comment'>*		!= 0   == 0	X	FAIL	TRUE</span></td></tr>
<tr class="codeline" data-linenumber="5127"><td class="num" id="LN5127">5127</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="5128"><td class="num" id="LN5128">5128</td><td class="line"> <span class='comment'>* current file doesn't exist, inode for swap unknown, one file name not</span></td></tr>
<tr class="codeline" data-linenumber="5129"><td class="num" id="LN5129">5129</td><td class="line"> <span class='comment'>* available -&gt; probably different</span></td></tr>
<tr class="codeline" data-linenumber="5130"><td class="num" id="LN5130">5130</td><td class="line"> <span class='comment'>*		== 0   == 0    FAIL	 OK	TRUE</span></td></tr>
<tr class="codeline" data-linenumber="5131"><td class="num" id="LN5131">5131</td><td class="line"> <span class='comment'>*		== 0   == 0	OK	FAIL	TRUE</span></td></tr>
<tr class="codeline" data-linenumber="5132"><td class="num" id="LN5132">5132</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="5133"><td class="num" id="LN5133">5133</td><td class="line"> <span class='comment'>* current file doesn't exist, inode for swap unknown, both file names not</span></td></tr>
<tr class="codeline" data-linenumber="5134"><td class="num" id="LN5134">5134</td><td class="line"> <span class='comment'>* available -&gt; compare file names</span></td></tr>
<tr class="codeline" data-linenumber="5135"><td class="num" id="LN5135">5135</td><td class="line"> <span class='comment'>*		== 0   == 0    FAIL	FAIL	fname_c != fname_s</span></td></tr>
<tr class="codeline" data-linenumber="5136"><td class="num" id="LN5136">5136</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="5137"><td class="num" id="LN5137">5137</td><td class="line"> <span class='comment'>* Note that when the ino_t is 64 bits, only the last 32 will be used.  This</span></td></tr>
<tr class="codeline" data-linenumber="5138"><td class="num" id="LN5138">5138</td><td class="line"> <span class='comment'>* can't be changed without making the block 0 incompatible with 32 bit</span></td></tr>
<tr class="codeline" data-linenumber="5139"><td class="num" id="LN5139">5139</td><td class="line"> <span class='comment'>* versions.</span></td></tr>
<tr class="codeline" data-linenumber="5140"><td class="num" id="LN5140">5140</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="5141"><td class="num" id="LN5141">5141</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5142"><td class="num" id="LN5142">5142</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>int</span></td></tr>
<tr class="codeline" data-linenumber="5143"><td class="num" id="LN5143">5143</td><td class="line">fnamecmp_ino(</td></tr>
<tr class="codeline" data-linenumber="5144"><td class="num" id="LN5144">5144</td><td class="line">    char_u	*fname_c,	    <span class='comment'>// current file name</span></td></tr>
<tr class="codeline" data-linenumber="5145"><td class="num" id="LN5145">5145</td><td class="line">    char_u	*fname_s,	    <span class='comment'>// file name from swap file</span></td></tr>
<tr class="codeline" data-linenumber="5146"><td class="num" id="LN5146">5146</td><td class="line">    <span class='keyword'>long</span>	ino_block0)</td></tr>
<tr class="codeline" data-linenumber="5147"><td class="num" id="LN5147">5147</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="5148"><td class="num" id="LN5148">5148</td><td class="line">    stat_T	st;</td></tr>
<tr class="codeline" data-linenumber="5149"><td class="num" id="LN5149">5149</td><td class="line">    ino_t	ino_c = 0;	    <span class='comment'>// ino of current file</span></td></tr>
<tr class="codeline" data-linenumber="5150"><td class="num" id="LN5150">5150</td><td class="line">    ino_t	ino_s;		    <span class='comment'>// ino of file from swap file</span></td></tr>
<tr class="codeline" data-linenumber="5151"><td class="num" id="LN5151">5151</td><td class="line">    char_u	buf_c[<span class='macro'>MAXPATHL<span class='macro_popup'>4096</span></span>];    <span class='comment'>// full path of fname_c</span></td></tr>
<tr class="codeline" data-linenumber="5152"><td class="num" id="LN5152">5152</td><td class="line">    char_u	buf_s[<span class='macro'>MAXPATHL<span class='macro_popup'>4096</span></span>];    <span class='comment'>// full path of fname_s</span></td></tr>
<tr class="codeline" data-linenumber="5153"><td class="num" id="LN5153">5153</td><td class="line">    <span class='keyword'>int</span>		retval_c;	    <span class='comment'>// flag: buf_c valid</span></td></tr>
<tr class="codeline" data-linenumber="5154"><td class="num" id="LN5154">5154</td><td class="line">    <span class='keyword'>int</span>		retval_s;	    <span class='comment'>// flag: buf_s valid</span></td></tr>
<tr class="codeline" data-linenumber="5155"><td class="num" id="LN5155">5155</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5156"><td class="num" id="LN5156">5156</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>mch_stat((<span class='keyword'>char</span> *)fname_c, &amp;st)<span class='macro_popup'>stat(((char *)fname_c), (&amp;st))</span></span> == 0)</td></tr>
<tr class="codeline" data-linenumber="5157"><td class="num" id="LN5157">5157</td><td class="line">	ino_c = (ino_t)st.st_ino;</td></tr>
<tr class="codeline" data-linenumber="5158"><td class="num" id="LN5158">5158</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5159"><td class="num" id="LN5159">5159</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="5160"><td class="num" id="LN5160">5160</td><td class="line">     <span class='comment'>* First we try to get the inode from the file name, because the inode in</span></td></tr>
<tr class="codeline" data-linenumber="5161"><td class="num" id="LN5161">5161</td><td class="line">     <span class='comment'>* the swap file may be outdated.  If that fails (e.g. this path is not</span></td></tr>
<tr class="codeline" data-linenumber="5162"><td class="num" id="LN5162">5162</td><td class="line">     <span class='comment'>* valid on this machine), use the inode from block 0.</span></td></tr>
<tr class="codeline" data-linenumber="5163"><td class="num" id="LN5163">5163</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="5164"><td class="num" id="LN5164">5164</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>mch_stat((<span class='keyword'>char</span> *)fname_s, &amp;st)<span class='macro_popup'>stat(((char *)fname_s), (&amp;st))</span></span> == 0)</td></tr>
<tr class="codeline" data-linenumber="5165"><td class="num" id="LN5165">5165</td><td class="line">	ino_s = (ino_t)st.st_ino;</td></tr>
<tr class="codeline" data-linenumber="5166"><td class="num" id="LN5166">5166</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="5167"><td class="num" id="LN5167">5167</td><td class="line">	ino_s = (ino_t)ino_block0;</td></tr>
<tr class="codeline" data-linenumber="5168"><td class="num" id="LN5168">5168</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5169"><td class="num" id="LN5169">5169</td><td class="line">    <span class='keyword'>if</span> (ino_c &amp;&amp; ino_s)</td></tr>
<tr class="codeline" data-linenumber="5170"><td class="num" id="LN5170">5170</td><td class="line">	<span class='keyword'>return</span> (ino_c != ino_s);</td></tr>
<tr class="codeline" data-linenumber="5171"><td class="num" id="LN5171">5171</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5172"><td class="num" id="LN5172">5172</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="5173"><td class="num" id="LN5173">5173</td><td class="line">     <span class='comment'>* One of the inode numbers is unknown, try a forced vim_FullName() and</span></td></tr>
<tr class="codeline" data-linenumber="5174"><td class="num" id="LN5174">5174</td><td class="line">     <span class='comment'>* compare the file names.</span></td></tr>
<tr class="codeline" data-linenumber="5175"><td class="num" id="LN5175">5175</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="5176"><td class="num" id="LN5176">5176</td><td class="line">    retval_c = vim_FullName(fname_c, buf_c, <span class='macro'>MAXPATHL<span class='macro_popup'>4096</span></span>, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5177"><td class="num" id="LN5177">5177</td><td class="line">    retval_s = vim_FullName(fname_s, buf_s, <span class='macro'>MAXPATHL<span class='macro_popup'>4096</span></span>, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5178"><td class="num" id="LN5178">5178</td><td class="line">    <span class='keyword'>if</span> (retval_c == <span class='macro'>OK<span class='macro_popup'>1</span></span> &amp;&amp; retval_s == <span class='macro'>OK<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5179"><td class="num" id="LN5179">5179</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>STRCMP(buf_c, buf_s)<span class='macro_popup'>strcmp((char *)(buf_c), (char *)(buf_s))</span></span> != 0;</td></tr>
<tr class="codeline" data-linenumber="5180"><td class="num" id="LN5180">5180</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5181"><td class="num" id="LN5181">5181</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="5182"><td class="num" id="LN5182">5182</td><td class="line">     <span class='comment'>* Can't compare inodes or file names, guess that the files are different,</span></td></tr>
<tr class="codeline" data-linenumber="5183"><td class="num" id="LN5183">5183</td><td class="line">     <span class='comment'>* unless both appear not to exist at all, then compare with the file name</span></td></tr>
<tr class="codeline" data-linenumber="5184"><td class="num" id="LN5184">5184</td><td class="line">     <span class='comment'>* in the swap file.</span></td></tr>
<tr class="codeline" data-linenumber="5185"><td class="num" id="LN5185">5185</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="5186"><td class="num" id="LN5186">5186</td><td class="line">    <span class='keyword'>if</span> (ino_s == 0 &amp;&amp; ino_c == 0 &amp;&amp; retval_c == <span class='macro'>FAIL<span class='macro_popup'>0</span></span> &amp;&amp; retval_s == <span class='macro'>FAIL<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5187"><td class="num" id="LN5187">5187</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>STRCMP(fname_c, fname_s)<span class='macro_popup'>strcmp((char *)(fname_c), (char *)(fname_s))</span></span> != 0;</td></tr>
<tr class="codeline" data-linenumber="5188"><td class="num" id="LN5188">5188</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5189"><td class="num" id="LN5189">5189</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5190"><td class="num" id="LN5190">5190</td><td class="line"><span class='directive'>#endif // CHECK_INODE</span></td></tr>
<tr class="codeline" data-linenumber="5191"><td class="num" id="LN5191">5191</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5192"><td class="num" id="LN5192">5192</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="5193"><td class="num" id="LN5193">5193</td><td class="line"> <span class='comment'>* Move a long integer into a four byte character array.</span></td></tr>
<tr class="codeline" data-linenumber="5194"><td class="num" id="LN5194">5194</td><td class="line"> <span class='comment'>* Used for machine independency in block zero.</span></td></tr>
<tr class="codeline" data-linenumber="5195"><td class="num" id="LN5195">5195</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="5196"><td class="num" id="LN5196">5196</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="5197"><td class="num" id="LN5197">5197</td><td class="line">long_to_char(<span class='keyword'>long</span> n, char_u *s)</td></tr>
<tr class="codeline" data-linenumber="5198"><td class="num" id="LN5198">5198</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="5199"><td class="num" id="LN5199">5199</td><td class="line">    s[0] = (char_u)(n &amp; 0xff);</td></tr>
<tr class="codeline" data-linenumber="5200"><td class="num" id="LN5200">5200</td><td class="line">    n = (<span class='keyword'>unsigned</span>)n &gt;&gt; 8;</td></tr>
<tr class="codeline" data-linenumber="5201"><td class="num" id="LN5201">5201</td><td class="line">    s[1] = (char_u)(n &amp; 0xff);</td></tr>
<tr class="codeline" data-linenumber="5202"><td class="num" id="LN5202">5202</td><td class="line">    n = (<span class='keyword'>unsigned</span>)n &gt;&gt; 8;</td></tr>
<tr class="codeline" data-linenumber="5203"><td class="num" id="LN5203">5203</td><td class="line">    s[2] = (char_u)(n &amp; 0xff);</td></tr>
<tr class="codeline" data-linenumber="5204"><td class="num" id="LN5204">5204</td><td class="line">    n = (<span class='keyword'>unsigned</span>)n &gt;&gt; 8;</td></tr>
<tr class="codeline" data-linenumber="5205"><td class="num" id="LN5205">5205</td><td class="line">    s[3] = (char_u)(n &amp; 0xff);</td></tr>
<tr class="codeline" data-linenumber="5206"><td class="num" id="LN5206">5206</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5207"><td class="num" id="LN5207">5207</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5208"><td class="num" id="LN5208">5208</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>long</span></td></tr>
<tr class="codeline" data-linenumber="5209"><td class="num" id="LN5209">5209</td><td class="line">char_to_long(char_u *s)</td></tr>
<tr class="codeline" data-linenumber="5210"><td class="num" id="LN5210">5210</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="5211"><td class="num" id="LN5211">5211</td><td class="line">    <span class='keyword'>long</span>    retval;</td></tr>
<tr class="codeline" data-linenumber="5212"><td class="num" id="LN5212">5212</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5213"><td class="num" id="LN5213">5213</td><td class="line">    retval = s[3];</td></tr>
<tr class="codeline" data-linenumber="5214"><td class="num" id="LN5214">5214</td><td class="line">    retval &lt;&lt;= 8;</td></tr>
<tr class="codeline" data-linenumber="5215"><td class="num" id="LN5215">5215</td><td class="line">    retval |= s[2];</td></tr>
<tr class="codeline" data-linenumber="5216"><td class="num" id="LN5216">5216</td><td class="line">    retval &lt;&lt;= 8;</td></tr>
<tr class="codeline" data-linenumber="5217"><td class="num" id="LN5217">5217</td><td class="line">    retval |= s[1];</td></tr>
<tr class="codeline" data-linenumber="5218"><td class="num" id="LN5218">5218</td><td class="line">    retval &lt;&lt;= 8;</td></tr>
<tr class="codeline" data-linenumber="5219"><td class="num" id="LN5219">5219</td><td class="line">    retval |= s[0];</td></tr>
<tr class="codeline" data-linenumber="5220"><td class="num" id="LN5220">5220</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5221"><td class="num" id="LN5221">5221</td><td class="line">    <span class='keyword'>return</span> retval;</td></tr>
<tr class="codeline" data-linenumber="5222"><td class="num" id="LN5222">5222</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5223"><td class="num" id="LN5223">5223</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5224"><td class="num" id="LN5224">5224</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="5225"><td class="num" id="LN5225">5225</td><td class="line"> <span class='comment'>* Set the flags in the first block of the swap file:</span></td></tr>
<tr class="codeline" data-linenumber="5226"><td class="num" id="LN5226">5226</td><td class="line"> <span class='comment'>* - file is modified or not: buf-&gt;b_changed</span></td></tr>
<tr class="codeline" data-linenumber="5227"><td class="num" id="LN5227">5227</td><td class="line"> <span class='comment'>* - 'fileformat'</span></td></tr>
<tr class="codeline" data-linenumber="5228"><td class="num" id="LN5228">5228</td><td class="line"> <span class='comment'>* - 'fileencoding'</span></td></tr>
<tr class="codeline" data-linenumber="5229"><td class="num" id="LN5229">5229</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="5230"><td class="num" id="LN5230">5230</td><td class="line">    <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="5231"><td class="num" id="LN5231">5231</td><td class="line">ml_setflags(buf_T *buf)</td></tr>
<tr class="codeline" data-linenumber="5232"><td class="num" id="LN5232">5232</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="5233"><td class="num" id="LN5233">5233</td><td class="line">    bhdr_T	*hp;</td></tr>
<tr class="codeline" data-linenumber="5234"><td class="num" id="LN5234">5234</td><td class="line">    ZERO_BL	*b0p;</td></tr>
<tr class="codeline" data-linenumber="5235"><td class="num" id="LN5235">5235</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5236"><td class="num" id="LN5236">5236</td><td class="line">    <span class='keyword'>if</span> (!buf-&gt;b_ml.ml_mfp)</td></tr>
<tr class="codeline" data-linenumber="5237"><td class="num" id="LN5237">5237</td><td class="line">	<span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="5238"><td class="num" id="LN5238">5238</td><td class="line">    <span class='keyword'>for</span> (hp = buf-&gt;b_ml.ml_mfp-&gt;mf_used_last; hp != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>; hp = hp-&gt;bh_prev)</td></tr>
<tr class="codeline" data-linenumber="5239"><td class="num" id="LN5239">5239</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="5240"><td class="num" id="LN5240">5240</td><td class="line">	<span class='keyword'>if</span> (hp-&gt;<span class='macro'>bh_bnum<span class='macro_popup'>bh_hashitem.mhi_key</span></span> == 0)</td></tr>
<tr class="codeline" data-linenumber="5241"><td class="num" id="LN5241">5241</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="5242"><td class="num" id="LN5242">5242</td><td class="line">	    b0p = (ZERO_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="5243"><td class="num" id="LN5243">5243</td><td class="line">	    b0p-&gt;<span class='macro'>b0_dirty<span class='macro_popup'>b0_fname[900 - 1]</span></span> = buf-&gt;b_changed ? <span class='macro'>B0_DIRTY<span class='macro_popup'>0x55</span></span> : 0;</td></tr>
<tr class="codeline" data-linenumber="5244"><td class="num" id="LN5244">5244</td><td class="line">	    b0p-&gt;<span class='macro'>b0_flags<span class='macro_popup'>b0_fname[900 - 2]</span></span> = (b0p-&gt;<span class='macro'>b0_flags<span class='macro_popup'>b0_fname[900 - 2]</span></span> &amp; ~<span class='macro'>B0_FF_MASK<span class='macro_popup'>3</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5245"><td class="num" id="LN5245">5245</td><td class="line">						  | (get_fileformat(buf) + 1);</td></tr>
<tr class="codeline" data-linenumber="5246"><td class="num" id="LN5246">5246</td><td class="line">	    add_b0_fenc(b0p, buf);</td></tr>
<tr class="codeline" data-linenumber="5247"><td class="num" id="LN5247">5247</td><td class="line">	    hp-&gt;bh_flags |= <span class='macro'>BH_DIRTY<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5248"><td class="num" id="LN5248">5248</td><td class="line">	    mf_sync(buf-&gt;b_ml.ml_mfp, <span class='macro'>MFS_ZERO<span class='macro_popup'>8</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5249"><td class="num" id="LN5249">5249</td><td class="line">	    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5250"><td class="num" id="LN5250">5250</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="5251"><td class="num" id="LN5251">5251</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5252"><td class="num" id="LN5252">5252</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5253"><td class="num" id="LN5253">5253</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5254"><td class="num" id="LN5254">5254</td><td class="line"><span class='directive'>#if defined(FEAT_CRYPT) || defined(PROTO)</span></td></tr>
<tr class="codeline" data-linenumber="5255"><td class="num" id="LN5255">5255</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="5256"><td class="num" id="LN5256">5256</td><td class="line"> <span class='comment'>* If "data" points to a data block encrypt the text in it and return a copy</span></td></tr>
<tr class="codeline" data-linenumber="5257"><td class="num" id="LN5257">5257</td><td class="line"> <span class='comment'>* in allocated memory.  Return NULL when out of memory.</span></td></tr>
<tr class="codeline" data-linenumber="5258"><td class="num" id="LN5258">5258</td><td class="line"> <span class='comment'>* Otherwise return "data".</span></td></tr>
<tr class="codeline" data-linenumber="5259"><td class="num" id="LN5259">5259</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="5260"><td class="num" id="LN5260">5260</td><td class="line">    char_u *</td></tr>
<tr class="codeline" data-linenumber="5261"><td class="num" id="LN5261">5261</td><td class="line">ml_encrypt_data(</td></tr>
<tr class="codeline" data-linenumber="5262"><td class="num" id="LN5262">5262</td><td class="line">    memfile_T	*mfp,</td></tr>
<tr class="codeline" data-linenumber="5263"><td class="num" id="LN5263">5263</td><td class="line">    char_u	*data,</td></tr>
<tr class="codeline" data-linenumber="5264"><td class="num" id="LN5264">5264</td><td class="line">    off_T	offset,</td></tr>
<tr class="codeline" data-linenumber="5265"><td class="num" id="LN5265">5265</td><td class="line">    <span class='keyword'>unsigned</span>	size)</td></tr>
<tr class="codeline" data-linenumber="5266"><td class="num" id="LN5266">5266</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="5267"><td class="num" id="LN5267">5267</td><td class="line">    DATA_BL	*dp = (DATA_BL *)data;</td></tr>
<tr class="codeline" data-linenumber="5268"><td class="num" id="LN5268">5268</td><td class="line">    char_u	*head_end;</td></tr>
<tr class="codeline" data-linenumber="5269"><td class="num" id="LN5269">5269</td><td class="line">    char_u	*text_start;</td></tr>
<tr class="codeline" data-linenumber="5270"><td class="num" id="LN5270">5270</td><td class="line">    char_u	*new_data;</td></tr>
<tr class="codeline" data-linenumber="5271"><td class="num" id="LN5271">5271</td><td class="line">    <span class='keyword'>int</span>		text_len;</td></tr>
<tr class="codeline" data-linenumber="5272"><td class="num" id="LN5272">5272</td><td class="line">    cryptstate_T *state;</td></tr>
<tr class="codeline" data-linenumber="5273"><td class="num" id="LN5273">5273</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5274"><td class="num" id="LN5274">5274</td><td class="line">    <span class='keyword'>if</span> (dp-&gt;db_id != <span class='macro'>DATA_ID<span class='macro_popup'>(('d' &lt;&lt; 8) + 'a')</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5275"><td class="num" id="LN5275">5275</td><td class="line">	<span class='keyword'>return</span> data;</td></tr>
<tr class="codeline" data-linenumber="5276"><td class="num" id="LN5276">5276</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5277"><td class="num" id="LN5277">5277</td><td class="line">    state = ml_crypt_prepare(mfp, offset, <span class='macro'>FALSE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5278"><td class="num" id="LN5278">5278</td><td class="line">    <span class='keyword'>if</span> (state == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5279"><td class="num" id="LN5279">5279</td><td class="line">	<span class='keyword'>return</span> data;</td></tr>
<tr class="codeline" data-linenumber="5280"><td class="num" id="LN5280">5280</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5281"><td class="num" id="LN5281">5281</td><td class="line">    new_data = alloc(size);</td></tr>
<tr class="codeline" data-linenumber="5282"><td class="num" id="LN5282">5282</td><td class="line">    <span class='keyword'>if</span> (new_data == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5283"><td class="num" id="LN5283">5283</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5284"><td class="num" id="LN5284">5284</td><td class="line">    head_end = (char_u *)(&amp;dp-&gt;db_index[dp-&gt;db_line_count]);</td></tr>
<tr class="codeline" data-linenumber="5285"><td class="num" id="LN5285">5285</td><td class="line">    text_start = (char_u *)dp + dp-&gt;db_txt_start;</td></tr>
<tr class="codeline" data-linenumber="5286"><td class="num" id="LN5286">5286</td><td class="line">    text_len = size - dp-&gt;db_txt_start;</td></tr>
<tr class="codeline" data-linenumber="5287"><td class="num" id="LN5287">5287</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5288"><td class="num" id="LN5288">5288</td><td class="line">    <span class='comment'>// Copy the header and the text.</span></td></tr>
<tr class="codeline" data-linenumber="5289"><td class="num" id="LN5289">5289</td><td class="line">    <span class='macro'>mch_memmove(new_data, dp, head_end - (char_u *)dp)<span class='macro_popup'>memmove((char *)(new_data), (char *)(dp), head_end - (char_u *<br>)dp)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5290"><td class="num" id="LN5290">5290</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5291"><td class="num" id="LN5291">5291</td><td class="line">    <span class='comment'>// Encrypt the text.</span></td></tr>
<tr class="codeline" data-linenumber="5292"><td class="num" id="LN5292">5292</td><td class="line">    crypt_encode(state, text_start, text_len, new_data + dp-&gt;db_txt_start);</td></tr>
<tr class="codeline" data-linenumber="5293"><td class="num" id="LN5293">5293</td><td class="line">    crypt_free_state(state);</td></tr>
<tr class="codeline" data-linenumber="5294"><td class="num" id="LN5294">5294</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5295"><td class="num" id="LN5295">5295</td><td class="line">    <span class='comment'>// Clear the gap.</span></td></tr>
<tr class="codeline" data-linenumber="5296"><td class="num" id="LN5296">5296</td><td class="line">    <span class='keyword'>if</span> (head_end &lt; text_start)</td></tr>
<tr class="codeline" data-linenumber="5297"><td class="num" id="LN5297">5297</td><td class="line">	<span class='macro'>vim_memset(new_data + (head_end - data), 0, text_start - head_end)<span class='macro_popup'>memset((new_data + (head_end - data)), (0), (text_start - head_end<br>))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5298"><td class="num" id="LN5298">5298</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5299"><td class="num" id="LN5299">5299</td><td class="line">    <span class='keyword'>return</span> new_data;</td></tr>
<tr class="codeline" data-linenumber="5300"><td class="num" id="LN5300">5300</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5301"><td class="num" id="LN5301">5301</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5302"><td class="num" id="LN5302">5302</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="5303"><td class="num" id="LN5303">5303</td><td class="line"> <span class='comment'>* Decrypt the text in "data" if it points to an encrypted data block.</span></td></tr>
<tr class="codeline" data-linenumber="5304"><td class="num" id="LN5304">5304</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="5305"><td class="num" id="LN5305">5305</td><td class="line">    <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="5306"><td class="num" id="LN5306">5306</td><td class="line">ml_decrypt_data(</td></tr>
<tr class="codeline" data-linenumber="5307"><td class="num" id="LN5307">5307</td><td class="line">    memfile_T	*mfp,</td></tr>
<tr class="codeline" data-linenumber="5308"><td class="num" id="LN5308">5308</td><td class="line">    char_u	*data,</td></tr>
<tr class="codeline" data-linenumber="5309"><td class="num" id="LN5309">5309</td><td class="line">    off_T	offset,</td></tr>
<tr class="codeline" data-linenumber="5310"><td class="num" id="LN5310">5310</td><td class="line">    <span class='keyword'>unsigned</span>	size)</td></tr>
<tr class="codeline" data-linenumber="5311"><td class="num" id="LN5311">5311</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="5312"><td class="num" id="LN5312">5312</td><td class="line">    DATA_BL	*dp = (DATA_BL *)data;</td></tr>
<tr class="codeline" data-linenumber="5313"><td class="num" id="LN5313">5313</td><td class="line">    char_u	*head_end;</td></tr>
<tr class="codeline" data-linenumber="5314"><td class="num" id="LN5314">5314</td><td class="line">    char_u	*text_start;</td></tr>
<tr class="codeline" data-linenumber="5315"><td class="num" id="LN5315">5315</td><td class="line">    <span class='keyword'>int</span>		text_len;</td></tr>
<tr class="codeline" data-linenumber="5316"><td class="num" id="LN5316">5316</td><td class="line">    cryptstate_T *state;</td></tr>
<tr class="codeline" data-linenumber="5317"><td class="num" id="LN5317">5317</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5318"><td class="num" id="LN5318">5318</td><td class="line">    <span class='keyword'>if</span> (dp-&gt;db_id == <span class='macro'>DATA_ID<span class='macro_popup'>(('d' &lt;&lt; 8) + 'a')</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5319"><td class="num" id="LN5319">5319</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="5320"><td class="num" id="LN5320">5320</td><td class="line">	head_end = (char_u *)(&amp;dp-&gt;db_index[dp-&gt;db_line_count]);</td></tr>
<tr class="codeline" data-linenumber="5321"><td class="num" id="LN5321">5321</td><td class="line">	text_start = (char_u *)dp + dp-&gt;db_txt_start;</td></tr>
<tr class="codeline" data-linenumber="5322"><td class="num" id="LN5322">5322</td><td class="line">	text_len = dp-&gt;db_txt_end - dp-&gt;db_txt_start;</td></tr>
<tr class="codeline" data-linenumber="5323"><td class="num" id="LN5323">5323</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5324"><td class="num" id="LN5324">5324</td><td class="line">	<span class='keyword'>if</span> (head_end &gt; text_start || dp-&gt;db_txt_start &gt; size</td></tr>
<tr class="codeline" data-linenumber="5325"><td class="num" id="LN5325">5325</td><td class="line">						     || dp-&gt;db_txt_end &gt; size)</td></tr>
<tr class="codeline" data-linenumber="5326"><td class="num" id="LN5326">5326</td><td class="line">	    <span class='keyword'>return</span>;  <span class='comment'>// data was messed up</span></td></tr>
<tr class="codeline" data-linenumber="5327"><td class="num" id="LN5327">5327</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5328"><td class="num" id="LN5328">5328</td><td class="line">	state = ml_crypt_prepare(mfp, offset, <span class='macro'>TRUE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5329"><td class="num" id="LN5329">5329</td><td class="line">	<span class='keyword'>if</span> (state != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5330"><td class="num" id="LN5330">5330</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="5331"><td class="num" id="LN5331">5331</td><td class="line">	    <span class='comment'>// Decrypt the text in place.</span></td></tr>
<tr class="codeline" data-linenumber="5332"><td class="num" id="LN5332">5332</td><td class="line">	    crypt_decode_inplace(state, text_start, text_len);</td></tr>
<tr class="codeline" data-linenumber="5333"><td class="num" id="LN5333">5333</td><td class="line">	    crypt_free_state(state);</td></tr>
<tr class="codeline" data-linenumber="5334"><td class="num" id="LN5334">5334</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="5335"><td class="num" id="LN5335">5335</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5336"><td class="num" id="LN5336">5336</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5337"><td class="num" id="LN5337">5337</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5338"><td class="num" id="LN5338">5338</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="5339"><td class="num" id="LN5339">5339</td><td class="line"> <span class='comment'>* Prepare for encryption/decryption, using the key, seed and offset.</span></td></tr>
<tr class="codeline" data-linenumber="5340"><td class="num" id="LN5340">5340</td><td class="line"> <span class='comment'>* Return an allocated cryptstate_T *.</span></td></tr>
<tr class="codeline" data-linenumber="5341"><td class="num" id="LN5341">5341</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="5342"><td class="num" id="LN5342">5342</td><td class="line">    <span class='keyword'>static</span> cryptstate_T *</td></tr>
<tr class="codeline" data-linenumber="5343"><td class="num" id="LN5343">5343</td><td class="line">ml_crypt_prepare(memfile_T *mfp, off_T offset, <span class='keyword'>int</span> reading)</td></tr>
<tr class="codeline" data-linenumber="5344"><td class="num" id="LN5344">5344</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="5345"><td class="num" id="LN5345">5345</td><td class="line">    buf_T	*buf = mfp-&gt;mf_buffer;</td></tr>
<tr class="codeline" data-linenumber="5346"><td class="num" id="LN5346">5346</td><td class="line">    char_u	salt[50];</td></tr>
<tr class="codeline" data-linenumber="5347"><td class="num" id="LN5347">5347</td><td class="line">    <span class='keyword'>int</span>		method_nr;</td></tr>
<tr class="codeline" data-linenumber="5348"><td class="num" id="LN5348">5348</td><td class="line">    char_u	*key;</td></tr>
<tr class="codeline" data-linenumber="5349"><td class="num" id="LN5349">5349</td><td class="line">    char_u	*seed;</td></tr>
<tr class="codeline" data-linenumber="5350"><td class="num" id="LN5350">5350</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5351"><td class="num" id="LN5351">5351</td><td class="line">    <span class='keyword'>if</span> (reading &amp;&amp; mfp-&gt;mf_old_key != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5352"><td class="num" id="LN5352">5352</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="5353"><td class="num" id="LN5353">5353</td><td class="line">	<span class='comment'>// Reading back blocks with the previous key/method/seed.</span></td></tr>
<tr class="codeline" data-linenumber="5354"><td class="num" id="LN5354">5354</td><td class="line">	method_nr = mfp-&gt;mf_old_cm;</td></tr>
<tr class="codeline" data-linenumber="5355"><td class="num" id="LN5355">5355</td><td class="line">	key = mfp-&gt;mf_old_key;</td></tr>
<tr class="codeline" data-linenumber="5356"><td class="num" id="LN5356">5356</td><td class="line">	seed = mfp-&gt;mf_old_seed;</td></tr>
<tr class="codeline" data-linenumber="5357"><td class="num" id="LN5357">5357</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5358"><td class="num" id="LN5358">5358</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="5359"><td class="num" id="LN5359">5359</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="5360"><td class="num" id="LN5360">5360</td><td class="line">	method_nr = crypt_get_method_nr(buf);</td></tr>
<tr class="codeline" data-linenumber="5361"><td class="num" id="LN5361">5361</td><td class="line">	key = buf-&gt;b_p_key;</td></tr>
<tr class="codeline" data-linenumber="5362"><td class="num" id="LN5362">5362</td><td class="line">	seed = mfp-&gt;mf_seed;</td></tr>
<tr class="codeline" data-linenumber="5363"><td class="num" id="LN5363">5363</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5364"><td class="num" id="LN5364">5364</td><td class="line">    <span class='keyword'>if</span> (*key == <span class='macro'>NUL<span class='macro_popup'>'\000'</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5365"><td class="num" id="LN5365">5365</td><td class="line">	<span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5366"><td class="num" id="LN5366">5366</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5367"><td class="num" id="LN5367">5367</td><td class="line">    <span class='keyword'>if</span> (method_nr == <span class='macro'>CRYPT_M_ZIP<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5368"><td class="num" id="LN5368">5368</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="5369"><td class="num" id="LN5369">5369</td><td class="line">	<span class='comment'>// For PKzip: Append the offset to the key, so that we use a different</span></td></tr>
<tr class="codeline" data-linenumber="5370"><td class="num" id="LN5370">5370</td><td class="line">	<span class='comment'>// key for every block.</span></td></tr>
<tr class="codeline" data-linenumber="5371"><td class="num" id="LN5371">5371</td><td class="line">	vim_snprintf((<span class='keyword'>char</span> *)salt, <span class='keyword'>sizeof</span>(salt), <span class='string_literal'>"%s%ld"</span>, key, (<span class='keyword'>long</span>)offset);</td></tr>
<tr class="codeline" data-linenumber="5372"><td class="num" id="LN5372">5372</td><td class="line">	<span class='keyword'>return</span> crypt_create(method_nr, salt, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, 0, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, 0);</td></tr>
<tr class="codeline" data-linenumber="5373"><td class="num" id="LN5373">5373</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5374"><td class="num" id="LN5374">5374</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5375"><td class="num" id="LN5375">5375</td><td class="line">    <span class='comment'>// Using blowfish or better: add salt and seed. We use the byte offset</span></td></tr>
<tr class="codeline" data-linenumber="5376"><td class="num" id="LN5376">5376</td><td class="line">    <span class='comment'>// of the block for the salt.</span></td></tr>
<tr class="codeline" data-linenumber="5377"><td class="num" id="LN5377">5377</td><td class="line">    vim_snprintf((<span class='keyword'>char</span> *)salt, <span class='keyword'>sizeof</span>(salt), <span class='string_literal'>"%ld"</span>, (<span class='keyword'>long</span>)offset);</td></tr>
<tr class="codeline" data-linenumber="5378"><td class="num" id="LN5378">5378</td><td class="line">    <span class='keyword'>return</span> crypt_create(method_nr, key, salt, (<span class='keyword'>int</span>)<span class='macro'>STRLEN(salt)<span class='macro_popup'>strlen((char *)(salt))</span></span>,</td></tr>
<tr class="codeline" data-linenumber="5379"><td class="num" id="LN5379">5379</td><td class="line">							   seed, <span class='macro'>MF_SEED_LEN<span class='macro_popup'>8</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5380"><td class="num" id="LN5380">5380</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5381"><td class="num" id="LN5381">5381</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5382"><td class="num" id="LN5382">5382</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="5383"><td class="num" id="LN5383">5383</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5384"><td class="num" id="LN5384">5384</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5385"><td class="num" id="LN5385">5385</td><td class="line"><span class='directive'>#if defined(FEAT_BYTEOFF) || defined(PROTO)</span></td></tr>
<tr class="codeline" data-linenumber="5386"><td class="num" id="LN5386">5386</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5387"><td class="num" id="LN5387">5387</td><td class="line"><span class='directive'>#define <span class='macro'>MLCS_MAXL<span class='macro_popup'>800</span></span> 800	// max no of lines in chunk</span></td></tr>
<tr class="codeline" data-linenumber="5388"><td class="num" id="LN5388">5388</td><td class="line"><span class='directive'>#define <span class='macro'>MLCS_MINL<span class='macro_popup'>400</span></span> 400   // should be half of MLCS_MAXL</span></td></tr>
<tr class="codeline" data-linenumber="5389"><td class="num" id="LN5389">5389</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5390"><td class="num" id="LN5390">5390</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="5391"><td class="num" id="LN5391">5391</td><td class="line"> <span class='comment'>* Keep information for finding byte offset of a line, updtype may be one of:</span></td></tr>
<tr class="codeline" data-linenumber="5392"><td class="num" id="LN5392">5392</td><td class="line"> <span class='comment'>* ML_CHNK_ADDLINE: Add len to parent chunk, possibly splitting it</span></td></tr>
<tr class="codeline" data-linenumber="5393"><td class="num" id="LN5393">5393</td><td class="line"> <span class='comment'>*	   Careful: ML_CHNK_ADDLINE may cause ml_find_line() to be called.</span></td></tr>
<tr class="codeline" data-linenumber="5394"><td class="num" id="LN5394">5394</td><td class="line"> <span class='comment'>* ML_CHNK_DELLINE: Subtract len from parent chunk, possibly deleting it</span></td></tr>
<tr class="codeline" data-linenumber="5395"><td class="num" id="LN5395">5395</td><td class="line"> <span class='comment'>* ML_CHNK_UPDLINE: Add len to parent chunk, as a signed entity.</span></td></tr>
<tr class="codeline" data-linenumber="5396"><td class="num" id="LN5396">5396</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="5397"><td class="num" id="LN5397">5397</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="5398"><td class="num" id="LN5398">5398</td><td class="line">ml_updatechunk(</td></tr>
<tr class="codeline" data-linenumber="5399"><td class="num" id="LN5399">5399</td><td class="line">    buf_T	*buf,</td></tr>
<tr class="codeline" data-linenumber="5400"><td class="num" id="LN5400">5400</td><td class="line">    linenr_T	line,</td></tr>
<tr class="codeline" data-linenumber="5401"><td class="num" id="LN5401">5401</td><td class="line">    <span class='keyword'>long</span>	len,</td></tr>
<tr class="codeline" data-linenumber="5402"><td class="num" id="LN5402">5402</td><td class="line">    <span class='keyword'>int</span>		updtype)</td></tr>
<tr class="codeline" data-linenumber="5403"><td class="num" id="LN5403">5403</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="5404"><td class="num" id="LN5404">5404</td><td class="line">    <span class='keyword'>static</span> buf_T	*ml_upd_lastbuf = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5405"><td class="num" id="LN5405">5405</td><td class="line">    <span class='keyword'>static</span> linenr_T	ml_upd_lastline;</td></tr>
<tr class="codeline" data-linenumber="5406"><td class="num" id="LN5406">5406</td><td class="line">    <span class='keyword'>static</span> linenr_T	ml_upd_lastcurline;</td></tr>
<tr class="codeline" data-linenumber="5407"><td class="num" id="LN5407">5407</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>int</span>		ml_upd_lastcurix;</td></tr>
<tr class="codeline" data-linenumber="5408"><td class="num" id="LN5408">5408</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5409"><td class="num" id="LN5409">5409</td><td class="line">    linenr_T		curline = ml_upd_lastcurline;</td></tr>
<tr class="codeline" data-linenumber="5410"><td class="num" id="LN5410">5410</td><td class="line">    <span class='keyword'>int</span>			curix = ml_upd_lastcurix;</td></tr>
<tr class="codeline" data-linenumber="5411"><td class="num" id="LN5411">5411</td><td class="line">    <span class='keyword'>long</span>		size;</td></tr>
<tr class="codeline" data-linenumber="5412"><td class="num" id="LN5412">5412</td><td class="line">    chunksize_T		*curchnk;</td></tr>
<tr class="codeline" data-linenumber="5413"><td class="num" id="LN5413">5413</td><td class="line">    <span class='keyword'>int</span>			rest;</td></tr>
<tr class="codeline" data-linenumber="5414"><td class="num" id="LN5414">5414</td><td class="line">    bhdr_T		*hp;</td></tr>
<tr class="codeline" data-linenumber="5415"><td class="num" id="LN5415">5415</td><td class="line">    DATA_BL		*dp;</td></tr>
<tr class="codeline" data-linenumber="5416"><td class="num" id="LN5416">5416</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5417"><td class="num" id="LN5417">5417</td><td class="line">    <span class='keyword'>if</span> (buf-&gt;b_ml.ml_usedchunks == -1 || len == 0)</td></tr>
<tr class="codeline" data-linenumber="5418"><td class="num" id="LN5418">5418</td><td class="line">	<span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="5419"><td class="num" id="LN5419">5419</td><td class="line">    <span class='keyword'>if</span> (buf-&gt;b_ml.ml_chunksize == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5420"><td class="num" id="LN5420">5420</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="5421"><td class="num" id="LN5421">5421</td><td class="line">	buf-&gt;b_ml.ml_chunksize = <span class='macro'>ALLOC_MULT(chunksize_T, 100)<span class='macro_popup'>(chunksize_T *)alloc(sizeof(chunksize_T) * (100))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5422"><td class="num" id="LN5422">5422</td><td class="line">	<span class='keyword'>if</span> (buf-&gt;b_ml.ml_chunksize == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5423"><td class="num" id="LN5423">5423</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="5424"><td class="num" id="LN5424">5424</td><td class="line">	    buf-&gt;b_ml.ml_usedchunks = -1;</td></tr>
<tr class="codeline" data-linenumber="5425"><td class="num" id="LN5425">5425</td><td class="line">	    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="5426"><td class="num" id="LN5426">5426</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="5427"><td class="num" id="LN5427">5427</td><td class="line">	buf-&gt;b_ml.ml_numchunks = 100;</td></tr>
<tr class="codeline" data-linenumber="5428"><td class="num" id="LN5428">5428</td><td class="line">	buf-&gt;b_ml.ml_usedchunks = 1;</td></tr>
<tr class="codeline" data-linenumber="5429"><td class="num" id="LN5429">5429</td><td class="line">	buf-&gt;b_ml.ml_chunksize[0].mlcs_numlines = 1;</td></tr>
<tr class="codeline" data-linenumber="5430"><td class="num" id="LN5430">5430</td><td class="line">	buf-&gt;b_ml.ml_chunksize[0].mlcs_totalsize = 1;</td></tr>
<tr class="codeline" data-linenumber="5431"><td class="num" id="LN5431">5431</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5432"><td class="num" id="LN5432">5432</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5433"><td class="num" id="LN5433">5433</td><td class="line">    <span class='keyword'>if</span> (updtype == <span class='macro'>ML_CHNK_UPDLINE<span class='macro_popup'>3</span></span> &amp;&amp; buf-&gt;b_ml.ml_line_count == 1)</td></tr>
<tr class="codeline" data-linenumber="5434"><td class="num" id="LN5434">5434</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="5435"><td class="num" id="LN5435">5435</td><td class="line">	<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="5436"><td class="num" id="LN5436">5436</td><td class="line">	 <span class='comment'>* First line in empty buffer from ml_flush_line() -- reset</span></td></tr>
<tr class="codeline" data-linenumber="5437"><td class="num" id="LN5437">5437</td><td class="line">	 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="5438"><td class="num" id="LN5438">5438</td><td class="line">	buf-&gt;b_ml.ml_usedchunks = 1;</td></tr>
<tr class="codeline" data-linenumber="5439"><td class="num" id="LN5439">5439</td><td class="line">	buf-&gt;b_ml.ml_chunksize[0].mlcs_numlines = 1;</td></tr>
<tr class="codeline" data-linenumber="5440"><td class="num" id="LN5440">5440</td><td class="line">	buf-&gt;b_ml.ml_chunksize[0].mlcs_totalsize = (<span class='keyword'>long</span>)buf-&gt;b_ml.ml_line_len;</td></tr>
<tr class="codeline" data-linenumber="5441"><td class="num" id="LN5441">5441</td><td class="line">	<span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="5442"><td class="num" id="LN5442">5442</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5443"><td class="num" id="LN5443">5443</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5444"><td class="num" id="LN5444">5444</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="5445"><td class="num" id="LN5445">5445</td><td class="line">     <span class='comment'>* Find chunk that our line belongs to, curline will be at start of the</span></td></tr>
<tr class="codeline" data-linenumber="5446"><td class="num" id="LN5446">5446</td><td class="line">     <span class='comment'>* chunk.</span></td></tr>
<tr class="codeline" data-linenumber="5447"><td class="num" id="LN5447">5447</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="5448"><td class="num" id="LN5448">5448</td><td class="line">    <span class='keyword'>if</span> (buf != ml_upd_lastbuf || line != ml_upd_lastline + 1</td></tr>
<tr class="codeline" data-linenumber="5449"><td class="num" id="LN5449">5449</td><td class="line">	    || updtype != <span class='macro'>ML_CHNK_ADDLINE<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5450"><td class="num" id="LN5450">5450</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="5451"><td class="num" id="LN5451">5451</td><td class="line">	<span class='keyword'>for</span> (curline = 1, curix = 0;</td></tr>
<tr class="codeline" data-linenumber="5452"><td class="num" id="LN5452">5452</td><td class="line">	     curix &lt; buf-&gt;b_ml.ml_usedchunks - 1</td></tr>
<tr class="codeline" data-linenumber="5453"><td class="num" id="LN5453">5453</td><td class="line">	     &amp;&amp; line &gt;= curline + buf-&gt;b_ml.ml_chunksize[curix].mlcs_numlines;</td></tr>
<tr class="codeline" data-linenumber="5454"><td class="num" id="LN5454">5454</td><td class="line">	     curix++)</td></tr>
<tr class="codeline" data-linenumber="5455"><td class="num" id="LN5455">5455</td><td class="line">	    curline += buf-&gt;b_ml.ml_chunksize[curix].mlcs_numlines;</td></tr>
<tr class="codeline" data-linenumber="5456"><td class="num" id="LN5456">5456</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5457"><td class="num" id="LN5457">5457</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (curix &lt; buf-&gt;b_ml.ml_usedchunks - 1</td></tr>
<tr class="codeline" data-linenumber="5458"><td class="num" id="LN5458">5458</td><td class="line">	      &amp;&amp; line &gt;= curline + buf-&gt;b_ml.ml_chunksize[curix].mlcs_numlines)</td></tr>
<tr class="codeline" data-linenumber="5459"><td class="num" id="LN5459">5459</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="5460"><td class="num" id="LN5460">5460</td><td class="line">	<span class='comment'>// Adjust cached curix &amp; curline</span></td></tr>
<tr class="codeline" data-linenumber="5461"><td class="num" id="LN5461">5461</td><td class="line">	curline += buf-&gt;b_ml.ml_chunksize[curix].mlcs_numlines;</td></tr>
<tr class="codeline" data-linenumber="5462"><td class="num" id="LN5462">5462</td><td class="line">	curix++;</td></tr>
<tr class="codeline" data-linenumber="5463"><td class="num" id="LN5463">5463</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5464"><td class="num" id="LN5464">5464</td><td class="line">    curchnk = buf-&gt;b_ml.ml_chunksize + curix;</td></tr>
<tr class="codeline" data-linenumber="5465"><td class="num" id="LN5465">5465</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5466"><td class="num" id="LN5466">5466</td><td class="line">    <span class='keyword'>if</span> (updtype == <span class='macro'>ML_CHNK_DELLINE<span class='macro_popup'>2</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5467"><td class="num" id="LN5467">5467</td><td class="line">	len = -len;</td></tr>
<tr class="codeline" data-linenumber="5468"><td class="num" id="LN5468">5468</td><td class="line">    curchnk-&gt;mlcs_totalsize += len;</td></tr>
<tr class="codeline" data-linenumber="5469"><td class="num" id="LN5469">5469</td><td class="line">    <span class='keyword'>if</span> (updtype == <span class='macro'>ML_CHNK_ADDLINE<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5470"><td class="num" id="LN5470">5470</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="5471"><td class="num" id="LN5471">5471</td><td class="line">	curchnk-&gt;mlcs_numlines++;</td></tr>
<tr class="codeline" data-linenumber="5472"><td class="num" id="LN5472">5472</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5473"><td class="num" id="LN5473">5473</td><td class="line">	<span class='comment'>// May resize here so we don't have to do it in both cases below</span></td></tr>
<tr class="codeline" data-linenumber="5474"><td class="num" id="LN5474">5474</td><td class="line">	<span class='keyword'>if</span> (buf-&gt;b_ml.ml_usedchunks + 1 &gt;= buf-&gt;b_ml.ml_numchunks)</td></tr>
<tr class="codeline" data-linenumber="5475"><td class="num" id="LN5475">5475</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="5476"><td class="num" id="LN5476">5476</td><td class="line">	    chunksize_T *t_chunksize = buf-&gt;b_ml.ml_chunksize;</td></tr>
<tr class="codeline" data-linenumber="5477"><td class="num" id="LN5477">5477</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5478"><td class="num" id="LN5478">5478</td><td class="line">	    buf-&gt;b_ml.ml_numchunks = buf-&gt;b_ml.ml_numchunks * 3 / 2;</td></tr>
<tr class="codeline" data-linenumber="5479"><td class="num" id="LN5479">5479</td><td class="line">	    buf-&gt;b_ml.ml_chunksize = <span class='macro'>vim_realloc(buf-&gt;b_ml.ml_chunksize,<span class='macro_popup'>realloc((buf-&gt;b_ml.ml_chunksize), (sizeof(chunksize_T) * buf<br>-&gt;b_ml.ml_numchunks))</span></span></td></tr>
<tr class="codeline" data-linenumber="5480"><td class="num" id="LN5480">5480</td><td class="line">			    <span class='keyword'><span class='macro'>sizeof</span>(chunksize_T) * buf-&gt;b_ml.ml_numchunks)<span class='macro_popup'>realloc((buf-&gt;b_ml.ml_chunksize), (sizeof(chunksize_T) * buf<br>-&gt;b_ml.ml_numchunks))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5481"><td class="num" id="LN5481">5481</td><td class="line">	    <span class='keyword'>if</span> (buf-&gt;b_ml.ml_chunksize == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5482"><td class="num" id="LN5482">5482</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="5483"><td class="num" id="LN5483">5483</td><td class="line">		<span class='comment'>// Hmmmm, Give up on offset for this buffer</span></td></tr>
<tr class="codeline" data-linenumber="5484"><td class="num" id="LN5484">5484</td><td class="line">		vim_free(t_chunksize);</td></tr>
<tr class="codeline" data-linenumber="5485"><td class="num" id="LN5485">5485</td><td class="line">		buf-&gt;b_ml.ml_usedchunks = -1;</td></tr>
<tr class="codeline" data-linenumber="5486"><td class="num" id="LN5486">5486</td><td class="line">		<span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="5487"><td class="num" id="LN5487">5487</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="5488"><td class="num" id="LN5488">5488</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="5489"><td class="num" id="LN5489">5489</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5490"><td class="num" id="LN5490">5490</td><td class="line">	<span class='keyword'>if</span> (buf-&gt;b_ml.ml_chunksize[curix].mlcs_numlines &gt;= <span class='macro'>MLCS_MAXL<span class='macro_popup'>800</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5491"><td class="num" id="LN5491">5491</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="5492"><td class="num" id="LN5492">5492</td><td class="line">	    <span class='keyword'>int</span>	    count;	    <span class='comment'>// number of entries in block</span></td></tr>
<tr class="codeline" data-linenumber="5493"><td class="num" id="LN5493">5493</td><td class="line">	    <span class='keyword'>int</span>	    idx;</td></tr>
<tr class="codeline" data-linenumber="5494"><td class="num" id="LN5494">5494</td><td class="line">	    <span class='keyword'>int</span>	    end_idx;</td></tr>
<tr class="codeline" data-linenumber="5495"><td class="num" id="LN5495">5495</td><td class="line">	    <span class='keyword'>int</span>	    text_end;</td></tr>
<tr class="codeline" data-linenumber="5496"><td class="num" id="LN5496">5496</td><td class="line">	    <span class='keyword'>int</span>	    linecnt;</td></tr>
<tr class="codeline" data-linenumber="5497"><td class="num" id="LN5497">5497</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5498"><td class="num" id="LN5498">5498</td><td class="line">	    <span class='macro'>mch_memmove(buf-&gt;b_ml.ml_chunksize + curix + 1,<span class='macro_popup'>memmove((char *)(buf-&gt;b_ml.ml_chunksize + curix + 1), (char<br> *)(buf-&gt;b_ml.ml_chunksize + curix), (buf-&gt;b_ml.ml_usedchunks<br> - curix) * sizeof(chunksize_T))</span></span></td></tr>
<tr class="codeline" data-linenumber="5499"><td class="num" id="LN5499">5499</td><td class="line">			<span class='macro'>buf-&gt;b_ml.ml_chunksize + curix,<span class='macro_popup'>memmove((char *)(buf-&gt;b_ml.ml_chunksize + curix + 1), (char<br> *)(buf-&gt;b_ml.ml_chunksize + curix), (buf-&gt;b_ml.ml_usedchunks<br> - curix) * sizeof(chunksize_T))</span></span></td></tr>
<tr class="codeline" data-linenumber="5500"><td class="num" id="LN5500">5500</td><td class="line">			<span class='macro'>(buf-&gt;b_ml.ml_usedchunks - curix) *<span class='macro_popup'>memmove((char *)(buf-&gt;b_ml.ml_chunksize + curix + 1), (char<br> *)(buf-&gt;b_ml.ml_chunksize + curix), (buf-&gt;b_ml.ml_usedchunks<br> - curix) * sizeof(chunksize_T))</span></span></td></tr>
<tr class="codeline" data-linenumber="5501"><td class="num" id="LN5501">5501</td><td class="line">			<span class='keyword'><span class='macro'>sizeof</span>(chunksize_T))<span class='macro_popup'>memmove((char *)(buf-&gt;b_ml.ml_chunksize + curix + 1), (char<br> *)(buf-&gt;b_ml.ml_chunksize + curix), (buf-&gt;b_ml.ml_usedchunks<br> - curix) * sizeof(chunksize_T))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5502"><td class="num" id="LN5502">5502</td><td class="line">	    <span class='comment'>// Compute length of first half of lines in the split chunk</span></td></tr>
<tr class="codeline" data-linenumber="5503"><td class="num" id="LN5503">5503</td><td class="line">	    size = 0;</td></tr>
<tr class="codeline" data-linenumber="5504"><td class="num" id="LN5504">5504</td><td class="line">	    linecnt = 0;</td></tr>
<tr class="codeline" data-linenumber="5505"><td class="num" id="LN5505">5505</td><td class="line">	    <span class='keyword'>while</span> (curline &lt; buf-&gt;b_ml.ml_line_count</td></tr>
<tr class="codeline" data-linenumber="5506"><td class="num" id="LN5506">5506</td><td class="line">			&amp;&amp; linecnt &lt; <span class='macro'>MLCS_MINL<span class='macro_popup'>400</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5507"><td class="num" id="LN5507">5507</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="5508"><td class="num" id="LN5508">5508</td><td class="line">		<span class='keyword'>if</span> ((hp = ml_find_line(buf, curline, <span class='macro'>ML_FIND<span class='macro_popup'>0x13</span></span>)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5509"><td class="num" id="LN5509">5509</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="5510"><td class="num" id="LN5510">5510</td><td class="line">		    buf-&gt;b_ml.ml_usedchunks = -1;</td></tr>
<tr class="codeline" data-linenumber="5511"><td class="num" id="LN5511">5511</td><td class="line">		    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="5512"><td class="num" id="LN5512">5512</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="5513"><td class="num" id="LN5513">5513</td><td class="line">		dp = (DATA_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="5514"><td class="num" id="LN5514">5514</td><td class="line">		count = (<span class='keyword'>long</span>)(buf-&gt;b_ml.ml_locked_high) -</td></tr>
<tr class="codeline" data-linenumber="5515"><td class="num" id="LN5515">5515</td><td class="line">			(<span class='keyword'>long</span>)(buf-&gt;b_ml.ml_locked_low) + 1;</td></tr>
<tr class="codeline" data-linenumber="5516"><td class="num" id="LN5516">5516</td><td class="line">		idx = curline - buf-&gt;b_ml.ml_locked_low;</td></tr>
<tr class="codeline" data-linenumber="5517"><td class="num" id="LN5517">5517</td><td class="line">		curline = buf-&gt;b_ml.ml_locked_high + 1;</td></tr>
<tr class="codeline" data-linenumber="5518"><td class="num" id="LN5518">5518</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5519"><td class="num" id="LN5519">5519</td><td class="line">		<span class='comment'>// compute index of last line to use in this MEMLINE</span></td></tr>
<tr class="codeline" data-linenumber="5520"><td class="num" id="LN5520">5520</td><td class="line">		rest = count - idx;</td></tr>
<tr class="codeline" data-linenumber="5521"><td class="num" id="LN5521">5521</td><td class="line">		<span class='keyword'>if</span> (linecnt + rest &gt; <span class='macro'>MLCS_MINL<span class='macro_popup'>400</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5522"><td class="num" id="LN5522">5522</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="5523"><td class="num" id="LN5523">5523</td><td class="line">		    end_idx = idx + <span class='macro'>MLCS_MINL<span class='macro_popup'>400</span></span> - linecnt - 1;</td></tr>
<tr class="codeline" data-linenumber="5524"><td class="num" id="LN5524">5524</td><td class="line">		    linecnt = <span class='macro'>MLCS_MINL<span class='macro_popup'>400</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5525"><td class="num" id="LN5525">5525</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="5526"><td class="num" id="LN5526">5526</td><td class="line">		<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="5527"><td class="num" id="LN5527">5527</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="5528"><td class="num" id="LN5528">5528</td><td class="line">		    end_idx = count - 1;</td></tr>
<tr class="codeline" data-linenumber="5529"><td class="num" id="LN5529">5529</td><td class="line">		    linecnt += rest;</td></tr>
<tr class="codeline" data-linenumber="5530"><td class="num" id="LN5530">5530</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="5531"><td class="num" id="LN5531">5531</td><td class="line"><span class='directive'>#ifdef FEAT_PROP_POPUP</span></td></tr>
<tr class="codeline" data-linenumber="5532"><td class="num" id="LN5532">5532</td><td class="line">		<span class='keyword'>if</span> (buf-&gt;b_has_textprop)</td></tr>
<tr class="codeline" data-linenumber="5533"><td class="num" id="LN5533">5533</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="5534"><td class="num" id="LN5534">5534</td><td class="line">		    <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="5535"><td class="num" id="LN5535">5535</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5536"><td class="num" id="LN5536">5536</td><td class="line">		    <span class='comment'>// We cannot use the text pointers to get the text length,</span></td></tr>
<tr class="codeline" data-linenumber="5537"><td class="num" id="LN5537">5537</td><td class="line">		    <span class='comment'>// the text prop info would also be counted.  Go over the</span></td></tr>
<tr class="codeline" data-linenumber="5538"><td class="num" id="LN5538">5538</td><td class="line">		    <span class='comment'>// lines.</span></td></tr>
<tr class="codeline" data-linenumber="5539"><td class="num" id="LN5539">5539</td><td class="line">		    <span class='keyword'>for</span> (i = end_idx; i &lt; idx; ++i)</td></tr>
<tr class="codeline" data-linenumber="5540"><td class="num" id="LN5540">5540</td><td class="line">			size += (<span class='keyword'>int</span>)<span class='macro'>STRLEN((char_u *)dp + (dp-&gt;db_index[i] &amp; DB_INDEX_MASK))<span class='macro_popup'>strlen((char *)((char_u *)dp + (dp-&gt;db_index[i] &amp; (~((<br>unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1))))))</span></span> + 1;</td></tr>
<tr class="codeline" data-linenumber="5541"><td class="num" id="LN5541">5541</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="5542"><td class="num" id="LN5542">5542</td><td class="line">		<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="5543"><td class="num" id="LN5543">5543</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="5544"><td class="num" id="LN5544">5544</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="5545"><td class="num" id="LN5545">5545</td><td class="line">		    <span class='keyword'>if</span> (idx == 0)<span class='comment'>// first line in block, text at the end</span></td></tr>
<tr class="codeline" data-linenumber="5546"><td class="num" id="LN5546">5546</td><td class="line">			text_end = dp-&gt;db_txt_end;</td></tr>
<tr class="codeline" data-linenumber="5547"><td class="num" id="LN5547">5547</td><td class="line">		    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="5548"><td class="num" id="LN5548">5548</td><td class="line">			text_end = ((dp-&gt;db_index[idx - 1]) &amp; <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5549"><td class="num" id="LN5549">5549</td><td class="line">		    size += text_end - ((dp-&gt;db_index[end_idx]) &amp; <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5550"><td class="num" id="LN5550">5550</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="5551"><td class="num" id="LN5551">5551</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="5552"><td class="num" id="LN5552">5552</td><td class="line">	    buf-&gt;b_ml.ml_chunksize[curix].mlcs_numlines = linecnt;</td></tr>
<tr class="codeline" data-linenumber="5553"><td class="num" id="LN5553">5553</td><td class="line">	    buf-&gt;b_ml.ml_chunksize[curix + 1].mlcs_numlines -= linecnt;</td></tr>
<tr class="codeline" data-linenumber="5554"><td class="num" id="LN5554">5554</td><td class="line">	    buf-&gt;b_ml.ml_chunksize[curix].mlcs_totalsize = size;</td></tr>
<tr class="codeline" data-linenumber="5555"><td class="num" id="LN5555">5555</td><td class="line">	    buf-&gt;b_ml.ml_chunksize[curix + 1].mlcs_totalsize -= size;</td></tr>
<tr class="codeline" data-linenumber="5556"><td class="num" id="LN5556">5556</td><td class="line">	    buf-&gt;b_ml.ml_usedchunks++;</td></tr>
<tr class="codeline" data-linenumber="5557"><td class="num" id="LN5557">5557</td><td class="line">	    ml_upd_lastbuf = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;   <span class='comment'>// Force recalc of curix &amp; curline</span></td></tr>
<tr class="codeline" data-linenumber="5558"><td class="num" id="LN5558">5558</td><td class="line">	    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="5559"><td class="num" id="LN5559">5559</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="5560"><td class="num" id="LN5560">5560</td><td class="line">	<span class='keyword'>else</span> <span class='keyword'>if</span> (buf-&gt;b_ml.ml_chunksize[curix].mlcs_numlines &gt;= <span class='macro'>MLCS_MINL<span class='macro_popup'>400</span></span></td></tr>
<tr class="codeline" data-linenumber="5561"><td class="num" id="LN5561">5561</td><td class="line">		     &amp;&amp; curix == buf-&gt;b_ml.ml_usedchunks - 1</td></tr>
<tr class="codeline" data-linenumber="5562"><td class="num" id="LN5562">5562</td><td class="line">		     &amp;&amp; buf-&gt;b_ml.ml_line_count - line &lt;= 1)</td></tr>
<tr class="codeline" data-linenumber="5563"><td class="num" id="LN5563">5563</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="5564"><td class="num" id="LN5564">5564</td><td class="line">	    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="5565"><td class="num" id="LN5565">5565</td><td class="line">	     <span class='comment'>* We are in the last chunk and it is cheap to crate a new one</span></td></tr>
<tr class="codeline" data-linenumber="5566"><td class="num" id="LN5566">5566</td><td class="line">	     <span class='comment'>* after this. Do it now to avoid the loop above later on</span></td></tr>
<tr class="codeline" data-linenumber="5567"><td class="num" id="LN5567">5567</td><td class="line">	     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="5568"><td class="num" id="LN5568">5568</td><td class="line">	    curchnk = buf-&gt;b_ml.ml_chunksize + curix + 1;</td></tr>
<tr class="codeline" data-linenumber="5569"><td class="num" id="LN5569">5569</td><td class="line">	    buf-&gt;b_ml.ml_usedchunks++;</td></tr>
<tr class="codeline" data-linenumber="5570"><td class="num" id="LN5570">5570</td><td class="line">	    <span class='keyword'>if</span> (line == buf-&gt;b_ml.ml_line_count)</td></tr>
<tr class="codeline" data-linenumber="5571"><td class="num" id="LN5571">5571</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="5572"><td class="num" id="LN5572">5572</td><td class="line">		curchnk-&gt;mlcs_numlines = 0;</td></tr>
<tr class="codeline" data-linenumber="5573"><td class="num" id="LN5573">5573</td><td class="line">		curchnk-&gt;mlcs_totalsize = 0;</td></tr>
<tr class="codeline" data-linenumber="5574"><td class="num" id="LN5574">5574</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="5575"><td class="num" id="LN5575">5575</td><td class="line">	    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="5576"><td class="num" id="LN5576">5576</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="5577"><td class="num" id="LN5577">5577</td><td class="line">		<span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="5578"><td class="num" id="LN5578">5578</td><td class="line">		 <span class='comment'>* Line is just prior to last, move count for last</span></td></tr>
<tr class="codeline" data-linenumber="5579"><td class="num" id="LN5579">5579</td><td class="line">		 <span class='comment'>* This is the common case  when loading a new file</span></td></tr>
<tr class="codeline" data-linenumber="5580"><td class="num" id="LN5580">5580</td><td class="line">		 <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="5581"><td class="num" id="LN5581">5581</td><td class="line">		hp = ml_find_line(buf, buf-&gt;b_ml.ml_line_count, <span class='macro'>ML_FIND<span class='macro_popup'>0x13</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5582"><td class="num" id="LN5582">5582</td><td class="line">		<span class='keyword'>if</span> (hp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5583"><td class="num" id="LN5583">5583</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="5584"><td class="num" id="LN5584">5584</td><td class="line">		    buf-&gt;b_ml.ml_usedchunks = -1;</td></tr>
<tr class="codeline" data-linenumber="5585"><td class="num" id="LN5585">5585</td><td class="line">		    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="5586"><td class="num" id="LN5586">5586</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="5587"><td class="num" id="LN5587">5587</td><td class="line">		dp = (DATA_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="5588"><td class="num" id="LN5588">5588</td><td class="line">		<span class='keyword'>if</span> (dp-&gt;db_line_count == 1)</td></tr>
<tr class="codeline" data-linenumber="5589"><td class="num" id="LN5589">5589</td><td class="line">		    rest = dp-&gt;db_txt_end - dp-&gt;db_txt_start;</td></tr>
<tr class="codeline" data-linenumber="5590"><td class="num" id="LN5590">5590</td><td class="line">		<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="5591"><td class="num" id="LN5591">5591</td><td class="line">		    rest =</td></tr>
<tr class="codeline" data-linenumber="5592"><td class="num" id="LN5592">5592</td><td class="line">			((dp-&gt;db_index[dp-&gt;db_line_count - 2]) &amp; <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5593"><td class="num" id="LN5593">5593</td><td class="line">			- dp-&gt;db_txt_start;</td></tr>
<tr class="codeline" data-linenumber="5594"><td class="num" id="LN5594">5594</td><td class="line">		curchnk-&gt;mlcs_totalsize = rest;</td></tr>
<tr class="codeline" data-linenumber="5595"><td class="num" id="LN5595">5595</td><td class="line">		curchnk-&gt;mlcs_numlines = 1;</td></tr>
<tr class="codeline" data-linenumber="5596"><td class="num" id="LN5596">5596</td><td class="line">		curchnk[-1].mlcs_totalsize -= rest;</td></tr>
<tr class="codeline" data-linenumber="5597"><td class="num" id="LN5597">5597</td><td class="line">		curchnk[-1].mlcs_numlines -= 1;</td></tr>
<tr class="codeline" data-linenumber="5598"><td class="num" id="LN5598">5598</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="5599"><td class="num" id="LN5599">5599</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="5600"><td class="num" id="LN5600">5600</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5601"><td class="num" id="LN5601">5601</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (updtype == <span class='macro'>ML_CHNK_DELLINE<span class='macro_popup'>2</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5602"><td class="num" id="LN5602">5602</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="5603"><td class="num" id="LN5603">5603</td><td class="line">	curchnk-&gt;mlcs_numlines--;</td></tr>
<tr class="codeline" data-linenumber="5604"><td class="num" id="LN5604">5604</td><td class="line">	ml_upd_lastbuf = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;   <span class='comment'>// Force recalc of curix &amp; curline</span></td></tr>
<tr class="codeline" data-linenumber="5605"><td class="num" id="LN5605">5605</td><td class="line">	<span class='keyword'>if</span> (curix &lt; (buf-&gt;b_ml.ml_usedchunks - 1)</td></tr>
<tr class="codeline" data-linenumber="5606"><td class="num" id="LN5606">5606</td><td class="line">		&amp;&amp; (curchnk-&gt;mlcs_numlines + curchnk[1].mlcs_numlines)</td></tr>
<tr class="codeline" data-linenumber="5607"><td class="num" id="LN5607">5607</td><td class="line">		   &lt;= <span class='macro'>MLCS_MINL<span class='macro_popup'>400</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5608"><td class="num" id="LN5608">5608</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="5609"><td class="num" id="LN5609">5609</td><td class="line">	    curix++;</td></tr>
<tr class="codeline" data-linenumber="5610"><td class="num" id="LN5610">5610</td><td class="line">	    curchnk = buf-&gt;b_ml.ml_chunksize + curix;</td></tr>
<tr class="codeline" data-linenumber="5611"><td class="num" id="LN5611">5611</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="5612"><td class="num" id="LN5612">5612</td><td class="line">	<span class='keyword'>else</span> <span class='keyword'>if</span> (curix == 0 &amp;&amp; curchnk-&gt;mlcs_numlines &lt;= 0)</td></tr>
<tr class="codeline" data-linenumber="5613"><td class="num" id="LN5613">5613</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="5614"><td class="num" id="LN5614">5614</td><td class="line">	    buf-&gt;b_ml.ml_usedchunks--;</td></tr>
<tr class="codeline" data-linenumber="5615"><td class="num" id="LN5615">5615</td><td class="line">	    <span class='macro'>mch_memmove(buf-&gt;b_ml.ml_chunksize, buf-&gt;b_ml.ml_chunksize + 1,<span class='macro_popup'>memmove((char *)(buf-&gt;b_ml.ml_chunksize), (char *)(buf-&gt;<br>b_ml.ml_chunksize + 1), buf-&gt;b_ml.ml_usedchunks * sizeof(chunksize_T<br>))</span></span></td></tr>
<tr class="codeline" data-linenumber="5616"><td class="num" id="LN5616">5616</td><td class="line">			<span class='macro'>buf-&gt;b_ml.ml_usedchunks * <span class='keyword'>sizeof</span>(chunksize_T))<span class='macro_popup'>memmove((char *)(buf-&gt;b_ml.ml_chunksize), (char *)(buf-&gt;<br>b_ml.ml_chunksize + 1), buf-&gt;b_ml.ml_usedchunks * sizeof(chunksize_T<br>))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5617"><td class="num" id="LN5617">5617</td><td class="line">	    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="5618"><td class="num" id="LN5618">5618</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="5619"><td class="num" id="LN5619">5619</td><td class="line">	<span class='keyword'>else</span> <span class='keyword'>if</span> (curix == 0 || (curchnk-&gt;mlcs_numlines &gt; 10</td></tr>
<tr class="codeline" data-linenumber="5620"><td class="num" id="LN5620">5620</td><td class="line">		    &amp;&amp; (curchnk-&gt;mlcs_numlines + curchnk[-1].mlcs_numlines)</td></tr>
<tr class="codeline" data-linenumber="5621"><td class="num" id="LN5621">5621</td><td class="line">		       &gt; <span class='macro'>MLCS_MINL<span class='macro_popup'>400</span></span>))</td></tr>
<tr class="codeline" data-linenumber="5622"><td class="num" id="LN5622">5622</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="5623"><td class="num" id="LN5623">5623</td><td class="line">	    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="5624"><td class="num" id="LN5624">5624</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="5625"><td class="num" id="LN5625">5625</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5626"><td class="num" id="LN5626">5626</td><td class="line">	<span class='comment'>// Collapse chunks</span></td></tr>
<tr class="codeline" data-linenumber="5627"><td class="num" id="LN5627">5627</td><td class="line">	curchnk[-1].mlcs_numlines += curchnk-&gt;mlcs_numlines;</td></tr>
<tr class="codeline" data-linenumber="5628"><td class="num" id="LN5628">5628</td><td class="line">	curchnk[-1].mlcs_totalsize += curchnk-&gt;mlcs_totalsize;</td></tr>
<tr class="codeline" data-linenumber="5629"><td class="num" id="LN5629">5629</td><td class="line">	buf-&gt;b_ml.ml_usedchunks--;</td></tr>
<tr class="codeline" data-linenumber="5630"><td class="num" id="LN5630">5630</td><td class="line">	<span class='keyword'>if</span> (curix &lt; buf-&gt;b_ml.ml_usedchunks)</td></tr>
<tr class="codeline" data-linenumber="5631"><td class="num" id="LN5631">5631</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="5632"><td class="num" id="LN5632">5632</td><td class="line">	    <span class='macro'>mch_memmove(buf-&gt;b_ml.ml_chunksize + curix,<span class='macro_popup'>memmove((char *)(buf-&gt;b_ml.ml_chunksize + curix), (char *)<br>(buf-&gt;b_ml.ml_chunksize + curix + 1), (buf-&gt;b_ml.ml_usedchunks<br> - curix) * sizeof(chunksize_T))</span></span></td></tr>
<tr class="codeline" data-linenumber="5633"><td class="num" id="LN5633">5633</td><td class="line">			<span class='macro'>buf-&gt;b_ml.ml_chunksize + curix + 1,<span class='macro_popup'>memmove((char *)(buf-&gt;b_ml.ml_chunksize + curix), (char *)<br>(buf-&gt;b_ml.ml_chunksize + curix + 1), (buf-&gt;b_ml.ml_usedchunks<br> - curix) * sizeof(chunksize_T))</span></span></td></tr>
<tr class="codeline" data-linenumber="5634"><td class="num" id="LN5634">5634</td><td class="line">			<span class='macro'>(buf-&gt;b_ml.ml_usedchunks - curix) *<span class='macro_popup'>memmove((char *)(buf-&gt;b_ml.ml_chunksize + curix), (char *)<br>(buf-&gt;b_ml.ml_chunksize + curix + 1), (buf-&gt;b_ml.ml_usedchunks<br> - curix) * sizeof(chunksize_T))</span></span></td></tr>
<tr class="codeline" data-linenumber="5635"><td class="num" id="LN5635">5635</td><td class="line">			<span class='keyword'><span class='macro'>sizeof</span>(chunksize_T))<span class='macro_popup'>memmove((char *)(buf-&gt;b_ml.ml_chunksize + curix), (char *)<br>(buf-&gt;b_ml.ml_chunksize + curix + 1), (buf-&gt;b_ml.ml_usedchunks<br> - curix) * sizeof(chunksize_T))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5636"><td class="num" id="LN5636">5636</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="5637"><td class="num" id="LN5637">5637</td><td class="line">	<span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="5638"><td class="num" id="LN5638">5638</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5639"><td class="num" id="LN5639">5639</td><td class="line">    ml_upd_lastbuf = buf;</td></tr>
<tr class="codeline" data-linenumber="5640"><td class="num" id="LN5640">5640</td><td class="line">    ml_upd_lastline = line;</td></tr>
<tr class="codeline" data-linenumber="5641"><td class="num" id="LN5641">5641</td><td class="line">    ml_upd_lastcurline = curline;</td></tr>
<tr class="codeline" data-linenumber="5642"><td class="num" id="LN5642">5642</td><td class="line">    ml_upd_lastcurix = curix;</td></tr>
<tr class="codeline" data-linenumber="5643"><td class="num" id="LN5643">5643</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5644"><td class="num" id="LN5644">5644</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5645"><td class="num" id="LN5645">5645</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="5646"><td class="num" id="LN5646">5646</td><td class="line"> <span class='comment'>* Find offset for line or line with offset.</span></td></tr>
<tr class="codeline" data-linenumber="5647"><td class="num" id="LN5647">5647</td><td class="line"> <span class='comment'>* Find line with offset if "lnum" is 0; return remaining offset in offp</span></td></tr>
<tr class="codeline" data-linenumber="5648"><td class="num" id="LN5648">5648</td><td class="line"> <span class='comment'>* Find offset of line if "lnum" &gt; 0</span></td></tr>
<tr class="codeline" data-linenumber="5649"><td class="num" id="LN5649">5649</td><td class="line"> <span class='comment'>* return -1 if information is not available</span></td></tr>
<tr class="codeline" data-linenumber="5650"><td class="num" id="LN5650">5650</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="5651"><td class="num" id="LN5651">5651</td><td class="line">    <span class='keyword'>long</span></td></tr>
<tr class="codeline" data-linenumber="5652"><td class="num" id="LN5652">5652</td><td class="line">ml_find_line_or_offset(buf_T *buf, linenr_T lnum, <span class='keyword'>long</span> *offp)</td></tr>
<tr class="codeline" data-linenumber="5653"><td class="num" id="LN5653">5653</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="5654"><td class="num" id="LN5654">5654</td><td class="line">    linenr_T	curline;</td></tr>
<tr class="codeline" data-linenumber="5655"><td class="num" id="LN5655">5655</td><td class="line">    <span class='keyword'>int</span>		curix;</td></tr>
<tr class="codeline" data-linenumber="5656"><td class="num" id="LN5656">5656</td><td class="line">    <span class='keyword'>long</span>	size;</td></tr>
<tr class="codeline" data-linenumber="5657"><td class="num" id="LN5657">5657</td><td class="line">    bhdr_T	*hp;</td></tr>
<tr class="codeline" data-linenumber="5658"><td class="num" id="LN5658">5658</td><td class="line">    DATA_BL	*dp;</td></tr>
<tr class="codeline" data-linenumber="5659"><td class="num" id="LN5659">5659</td><td class="line">    <span class='keyword'>int</span>		count;		<span class='comment'>// number of entries in block</span></td></tr>
<tr class="codeline" data-linenumber="5660"><td class="num" id="LN5660">5660</td><td class="line">    <span class='keyword'>int</span>		idx;</td></tr>
<tr class="codeline" data-linenumber="5661"><td class="num" id="LN5661">5661</td><td class="line">    <span class='keyword'>int</span>		start_idx;</td></tr>
<tr class="codeline" data-linenumber="5662"><td class="num" id="LN5662">5662</td><td class="line">    <span class='keyword'>int</span>		text_end;</td></tr>
<tr class="codeline" data-linenumber="5663"><td class="num" id="LN5663">5663</td><td class="line">    <span class='keyword'>long</span>	offset;</td></tr>
<tr class="codeline" data-linenumber="5664"><td class="num" id="LN5664">5664</td><td class="line">    <span class='keyword'>int</span>		len;</td></tr>
<tr class="codeline" data-linenumber="5665"><td class="num" id="LN5665">5665</td><td class="line">    <span class='keyword'>int</span>		ffdos = (get_fileformat(buf) == <span class='macro'>EOL_DOS<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5666"><td class="num" id="LN5666">5666</td><td class="line">    <span class='keyword'>int</span>		extra = 0;</td></tr>
<tr class="codeline" data-linenumber="5667"><td class="num" id="LN5667">5667</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5668"><td class="num" id="LN5668">5668</td><td class="line">    <span class='comment'>// take care of cached line first</span></td></tr>
<tr class="codeline" data-linenumber="5669"><td class="num" id="LN5669">5669</td><td class="line">    ml_flush_line(curbuf);</td></tr>
<tr class="codeline" data-linenumber="5670"><td class="num" id="LN5670">5670</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5671"><td class="num" id="LN5671">5671</td><td class="line">    <span class='keyword'>if</span> (buf-&gt;b_ml.ml_usedchunks == -1</td></tr>
<tr class="codeline" data-linenumber="5672"><td class="num" id="LN5672">5672</td><td class="line">	    || buf-&gt;b_ml.ml_chunksize == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="5673"><td class="num" id="LN5673">5673</td><td class="line">	    || lnum &lt; 0)</td></tr>
<tr class="codeline" data-linenumber="5674"><td class="num" id="LN5674">5674</td><td class="line">	<span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="5675"><td class="num" id="LN5675">5675</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5676"><td class="num" id="LN5676">5676</td><td class="line">    <span class='keyword'>if</span> (offp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5677"><td class="num" id="LN5677">5677</td><td class="line">	offset = 0;</td></tr>
<tr class="codeline" data-linenumber="5678"><td class="num" id="LN5678">5678</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="5679"><td class="num" id="LN5679">5679</td><td class="line">	offset = *offp;</td></tr>
<tr class="codeline" data-linenumber="5680"><td class="num" id="LN5680">5680</td><td class="line">    <span class='keyword'>if</span> (lnum == 0 &amp;&amp; offset &lt;= 0)</td></tr>
<tr class="codeline" data-linenumber="5681"><td class="num" id="LN5681">5681</td><td class="line">	<span class='keyword'>return</span> 1;   <span class='comment'>// Not a "find offset" and offset 0 _must_ be in line 1</span></td></tr>
<tr class="codeline" data-linenumber="5682"><td class="num" id="LN5682">5682</td><td class="line">    <span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="5683"><td class="num" id="LN5683">5683</td><td class="line">     <span class='comment'>* Find the last chunk before the one containing our line. Last chunk is</span></td></tr>
<tr class="codeline" data-linenumber="5684"><td class="num" id="LN5684">5684</td><td class="line">     <span class='comment'>* special because it will never qualify</span></td></tr>
<tr class="codeline" data-linenumber="5685"><td class="num" id="LN5685">5685</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="5686"><td class="num" id="LN5686">5686</td><td class="line">    curline = 1;</td></tr>
<tr class="codeline" data-linenumber="5687"><td class="num" id="LN5687">5687</td><td class="line">    curix = size = 0;</td></tr>
<tr class="codeline" data-linenumber="5688"><td class="num" id="LN5688">5688</td><td class="line">    <span class='keyword'>while</span> (curix &lt; buf-&gt;b_ml.ml_usedchunks - 1</td></tr>
<tr class="codeline" data-linenumber="5689"><td class="num" id="LN5689">5689</td><td class="line">	    &amp;&amp; ((lnum != 0</td></tr>
<tr class="codeline" data-linenumber="5690"><td class="num" id="LN5690">5690</td><td class="line">	     &amp;&amp; lnum &gt;= curline + buf-&gt;b_ml.ml_chunksize[curix].mlcs_numlines)</td></tr>
<tr class="codeline" data-linenumber="5691"><td class="num" id="LN5691">5691</td><td class="line">		|| (offset != 0</td></tr>
<tr class="codeline" data-linenumber="5692"><td class="num" id="LN5692">5692</td><td class="line">	       &amp;&amp; offset &gt; size + buf-&gt;b_ml.ml_chunksize[curix].mlcs_totalsize</td></tr>
<tr class="codeline" data-linenumber="5693"><td class="num" id="LN5693">5693</td><td class="line">		      + ffdos * buf-&gt;b_ml.ml_chunksize[curix].mlcs_numlines)))</td></tr>
<tr class="codeline" data-linenumber="5694"><td class="num" id="LN5694">5694</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="5695"><td class="num" id="LN5695">5695</td><td class="line">	curline += buf-&gt;b_ml.ml_chunksize[curix].mlcs_numlines;</td></tr>
<tr class="codeline" data-linenumber="5696"><td class="num" id="LN5696">5696</td><td class="line">	size += buf-&gt;b_ml.ml_chunksize[curix].mlcs_totalsize;</td></tr>
<tr class="codeline" data-linenumber="5697"><td class="num" id="LN5697">5697</td><td class="line">	<span class='keyword'>if</span> (offset &amp;&amp; ffdos)</td></tr>
<tr class="codeline" data-linenumber="5698"><td class="num" id="LN5698">5698</td><td class="line">	    size += buf-&gt;b_ml.ml_chunksize[curix].mlcs_numlines;</td></tr>
<tr class="codeline" data-linenumber="5699"><td class="num" id="LN5699">5699</td><td class="line">	curix++;</td></tr>
<tr class="codeline" data-linenumber="5700"><td class="num" id="LN5700">5700</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5701"><td class="num" id="LN5701">5701</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5702"><td class="num" id="LN5702">5702</td><td class="line">    <span class='keyword'>while</span> ((lnum != 0 &amp;&amp; curline &lt; lnum) || (offset != 0 &amp;&amp; size &lt; offset))</td></tr>
<tr class="codeline" data-linenumber="5703"><td class="num" id="LN5703">5703</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="5704"><td class="num" id="LN5704">5704</td><td class="line">	<span class='keyword'>if</span> (curline &gt; buf-&gt;b_ml.ml_line_count</td></tr>
<tr class="codeline" data-linenumber="5705"><td class="num" id="LN5705">5705</td><td class="line">		|| (hp = ml_find_line(buf, curline, <span class='macro'>ML_FIND<span class='macro_popup'>0x13</span></span>)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5706"><td class="num" id="LN5706">5706</td><td class="line">	    <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="5707"><td class="num" id="LN5707">5707</td><td class="line">	dp = (DATA_BL *)(hp-&gt;bh_data);</td></tr>
<tr class="codeline" data-linenumber="5708"><td class="num" id="LN5708">5708</td><td class="line">	count = (<span class='keyword'>long</span>)(buf-&gt;b_ml.ml_locked_high) -</td></tr>
<tr class="codeline" data-linenumber="5709"><td class="num" id="LN5709">5709</td><td class="line">		(<span class='keyword'>long</span>)(buf-&gt;b_ml.ml_locked_low) + 1;</td></tr>
<tr class="codeline" data-linenumber="5710"><td class="num" id="LN5710">5710</td><td class="line">	start_idx = idx = curline - buf-&gt;b_ml.ml_locked_low;</td></tr>
<tr class="codeline" data-linenumber="5711"><td class="num" id="LN5711">5711</td><td class="line">	<span class='keyword'>if</span> (idx == 0)  <span class='comment'>// first line in block, text at the end</span></td></tr>
<tr class="codeline" data-linenumber="5712"><td class="num" id="LN5712">5712</td><td class="line">	    text_end = dp-&gt;db_txt_end;</td></tr>
<tr class="codeline" data-linenumber="5713"><td class="num" id="LN5713">5713</td><td class="line">	<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="5714"><td class="num" id="LN5714">5714</td><td class="line">	    text_end = ((dp-&gt;db_index[idx - 1]) &amp; <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5715"><td class="num" id="LN5715">5715</td><td class="line">	<span class='comment'>// Compute index of last line to use in this MEMLINE</span></td></tr>
<tr class="codeline" data-linenumber="5716"><td class="num" id="LN5716">5716</td><td class="line">	<span class='keyword'>if</span> (lnum != 0)</td></tr>
<tr class="codeline" data-linenumber="5717"><td class="num" id="LN5717">5717</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="5718"><td class="num" id="LN5718">5718</td><td class="line">	    <span class='keyword'>if</span> (curline + (count - idx) &gt;= lnum)</td></tr>
<tr class="codeline" data-linenumber="5719"><td class="num" id="LN5719">5719</td><td class="line">		idx += lnum - curline - 1;</td></tr>
<tr class="codeline" data-linenumber="5720"><td class="num" id="LN5720">5720</td><td class="line">	    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="5721"><td class="num" id="LN5721">5721</td><td class="line">		idx = count - 1;</td></tr>
<tr class="codeline" data-linenumber="5722"><td class="num" id="LN5722">5722</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="5723"><td class="num" id="LN5723">5723</td><td class="line">	<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="5724"><td class="num" id="LN5724">5724</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="5725"><td class="num" id="LN5725">5725</td><td class="line"><span class='directive'>#ifdef FEAT_PROP_POPUP</span></td></tr>
<tr class="codeline" data-linenumber="5726"><td class="num" id="LN5726">5726</td><td class="line">	    size_t textprop_total = 0;</td></tr>
<tr class="codeline" data-linenumber="5727"><td class="num" id="LN5727">5727</td><td class="line">	    size_t textprop_size = 0;</td></tr>
<tr class="codeline" data-linenumber="5728"><td class="num" id="LN5728">5728</td><td class="line">	    char_u *l1, *l2;</td></tr>
<tr class="codeline" data-linenumber="5729"><td class="num" id="LN5729">5729</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="5730"><td class="num" id="LN5730">5730</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5731"><td class="num" id="LN5731">5731</td><td class="line">	    extra = 0;</td></tr>
<tr class="codeline" data-linenumber="5732"><td class="num" id="LN5732">5732</td><td class="line">	    <span class='keyword'>for</span> (;;)</td></tr>
<tr class="codeline" data-linenumber="5733"><td class="num" id="LN5733">5733</td><td class="line">	    {</td></tr>
<tr class="codeline" data-linenumber="5734"><td class="num" id="LN5734">5734</td><td class="line"><span class='directive'>#ifdef FEAT_PROP_POPUP</span></td></tr>
<tr class="codeline" data-linenumber="5735"><td class="num" id="LN5735">5735</td><td class="line">		<span class='keyword'>if</span> (buf-&gt;b_has_textprop)</td></tr>
<tr class="codeline" data-linenumber="5736"><td class="num" id="LN5736">5736</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="5737"><td class="num" id="LN5737">5737</td><td class="line">		    <span class='comment'>// compensate for the extra bytes taken by textprops</span></td></tr>
<tr class="codeline" data-linenumber="5738"><td class="num" id="LN5738">5738</td><td class="line">		    l1 = (char_u *)dp + ((dp-&gt;db_index[idx]) &amp; <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5739"><td class="num" id="LN5739">5739</td><td class="line">		    l2 = (char_u *)dp + (idx == 0 ? dp-&gt;db_txt_end</td></tr>
<tr class="codeline" data-linenumber="5740"><td class="num" id="LN5740">5740</td><td class="line">				  : ((dp-&gt;db_index[idx - 1]) &amp; <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>));</td></tr>
<tr class="codeline" data-linenumber="5741"><td class="num" id="LN5741">5741</td><td class="line">		    textprop_size = (l2 - l1) - (<span class='macro'>STRLEN(l1)<span class='macro_popup'>strlen((char *)(l1))</span></span> + 1);</td></tr>
<tr class="codeline" data-linenumber="5742"><td class="num" id="LN5742">5742</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="5743"><td class="num" id="LN5743">5743</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="5744"><td class="num" id="LN5744">5744</td><td class="line">		<span class='keyword'>if</span> (!(offset &gt;= size</td></tr>
<tr class="codeline" data-linenumber="5745"><td class="num" id="LN5745">5745</td><td class="line">			+ text_end - (<span class='keyword'>int</span>)((dp-&gt;db_index[idx]) &amp; <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5746"><td class="num" id="LN5746">5746</td><td class="line"><span class='directive'>#ifdef FEAT_PROP_POPUP</span></td></tr>
<tr class="codeline" data-linenumber="5747"><td class="num" id="LN5747">5747</td><td class="line">			- (<span class='keyword'>long</span>)(textprop_total + textprop_size)</td></tr>
<tr class="codeline" data-linenumber="5748"><td class="num" id="LN5748">5748</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="5749"><td class="num" id="LN5749">5749</td><td class="line">			+ ffdos))</td></tr>
<tr class="codeline" data-linenumber="5750"><td class="num" id="LN5750">5750</td><td class="line">		    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5751"><td class="num" id="LN5751">5751</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5752"><td class="num" id="LN5752">5752</td><td class="line">		<span class='keyword'>if</span> (ffdos)</td></tr>
<tr class="codeline" data-linenumber="5753"><td class="num" id="LN5753">5753</td><td class="line">		    size++;</td></tr>
<tr class="codeline" data-linenumber="5754"><td class="num" id="LN5754">5754</td><td class="line"><span class='directive'>#ifdef FEAT_PROP_POPUP</span></td></tr>
<tr class="codeline" data-linenumber="5755"><td class="num" id="LN5755">5755</td><td class="line">		textprop_total += textprop_size;</td></tr>
<tr class="codeline" data-linenumber="5756"><td class="num" id="LN5756">5756</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="5757"><td class="num" id="LN5757">5757</td><td class="line">		<span class='keyword'>if</span> (idx == count - 1)</td></tr>
<tr class="codeline" data-linenumber="5758"><td class="num" id="LN5758">5758</td><td class="line">		{</td></tr>
<tr class="codeline" data-linenumber="5759"><td class="num" id="LN5759">5759</td><td class="line">		    extra = 1;</td></tr>
<tr class="codeline" data-linenumber="5760"><td class="num" id="LN5760">5760</td><td class="line">		    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="5761"><td class="num" id="LN5761">5761</td><td class="line">		}</td></tr>
<tr class="codeline" data-linenumber="5762"><td class="num" id="LN5762">5762</td><td class="line">		idx++;</td></tr>
<tr class="codeline" data-linenumber="5763"><td class="num" id="LN5763">5763</td><td class="line">	    }</td></tr>
<tr class="codeline" data-linenumber="5764"><td class="num" id="LN5764">5764</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="5765"><td class="num" id="LN5765">5765</td><td class="line"><span class='directive'>#ifdef FEAT_PROP_POPUP</span></td></tr>
<tr class="codeline" data-linenumber="5766"><td class="num" id="LN5766">5766</td><td class="line">	<span class='keyword'>if</span> (buf-&gt;b_has_textprop)</td></tr>
<tr class="codeline" data-linenumber="5767"><td class="num" id="LN5767">5767</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="5768"><td class="num" id="LN5768">5768</td><td class="line">	    <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="5769"><td class="num" id="LN5769">5769</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5770"><td class="num" id="LN5770">5770</td><td class="line">	    <span class='comment'>// cannot use the db_index pointer, need to get the actual text</span></td></tr>
<tr class="codeline" data-linenumber="5771"><td class="num" id="LN5771">5771</td><td class="line">	    <span class='comment'>// lengths.</span></td></tr>
<tr class="codeline" data-linenumber="5772"><td class="num" id="LN5772">5772</td><td class="line">	    len = 0;</td></tr>
<tr class="codeline" data-linenumber="5773"><td class="num" id="LN5773">5773</td><td class="line">	    <span class='keyword'>for</span> (i = start_idx; i &lt;= idx; ++i)</td></tr>
<tr class="codeline" data-linenumber="5774"><td class="num" id="LN5774">5774</td><td class="line">		len += (<span class='keyword'>int</span>)<span class='macro'>STRLEN((char_u *)dp<span class='macro_popup'>strlen((char *)((char_u *)dp + ((dp-&gt;db_index[i]) &amp; (~<br>((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1))))))</span></span></td></tr>
<tr class="codeline" data-linenumber="5775"><td class="num" id="LN5775">5775</td><td class="line">				    <span class='macro'>+ ((dp-&gt;db_index[i]) &amp; DB_INDEX_MASK))<span class='macro_popup'>strlen((char *)((char_u *)dp + ((dp-&gt;db_index[i]) &amp; (~<br>((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1))))))</span></span> + 1;</td></tr>
<tr class="codeline" data-linenumber="5776"><td class="num" id="LN5776">5776</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="5777"><td class="num" id="LN5777">5777</td><td class="line">	<span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="5778"><td class="num" id="LN5778">5778</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="5779"><td class="num" id="LN5779">5779</td><td class="line">	    len = text_end - ((dp-&gt;db_index[idx]) &amp; <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5780"><td class="num" id="LN5780">5780</td><td class="line">	size += len;</td></tr>
<tr class="codeline" data-linenumber="5781"><td class="num" id="LN5781">5781</td><td class="line">	<span class='keyword'>if</span> (offset != 0 &amp;&amp; size &gt;= offset)</td></tr>
<tr class="codeline" data-linenumber="5782"><td class="num" id="LN5782">5782</td><td class="line">	{</td></tr>
<tr class="codeline" data-linenumber="5783"><td class="num" id="LN5783">5783</td><td class="line">	    <span class='keyword'>if</span> (size + ffdos == offset)</td></tr>
<tr class="codeline" data-linenumber="5784"><td class="num" id="LN5784">5784</td><td class="line">		*offp = 0;</td></tr>
<tr class="codeline" data-linenumber="5785"><td class="num" id="LN5785">5785</td><td class="line">	    <span class='keyword'>else</span> <span class='keyword'>if</span> (idx == start_idx)</td></tr>
<tr class="codeline" data-linenumber="5786"><td class="num" id="LN5786">5786</td><td class="line">		*offp = offset - size + len;</td></tr>
<tr class="codeline" data-linenumber="5787"><td class="num" id="LN5787">5787</td><td class="line">	    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="5788"><td class="num" id="LN5788">5788</td><td class="line">		*offp = offset - size + len</td></tr>
<tr class="codeline" data-linenumber="5789"><td class="num" id="LN5789">5789</td><td class="line">		     - (text_end - ((dp-&gt;db_index[idx - 1]) &amp; <span class='macro'>DB_INDEX_MASK<span class='macro_popup'>(~((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1)))</span></span>));</td></tr>
<tr class="codeline" data-linenumber="5790"><td class="num" id="LN5790">5790</td><td class="line">	    curline += idx - start_idx + extra;</td></tr>
<tr class="codeline" data-linenumber="5791"><td class="num" id="LN5791">5791</td><td class="line">	    <span class='keyword'>if</span> (curline &gt; buf-&gt;b_ml.ml_line_count)</td></tr>
<tr class="codeline" data-linenumber="5792"><td class="num" id="LN5792">5792</td><td class="line">		<span class='keyword'>return</span> -1;	<span class='comment'>// exactly one byte beyond the end</span></td></tr>
<tr class="codeline" data-linenumber="5793"><td class="num" id="LN5793">5793</td><td class="line">	    <span class='keyword'>return</span> curline;</td></tr>
<tr class="codeline" data-linenumber="5794"><td class="num" id="LN5794">5794</td><td class="line">	}</td></tr>
<tr class="codeline" data-linenumber="5795"><td class="num" id="LN5795">5795</td><td class="line">	curline = buf-&gt;b_ml.ml_locked_high + 1;</td></tr>
<tr class="codeline" data-linenumber="5796"><td class="num" id="LN5796">5796</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5797"><td class="num" id="LN5797">5797</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5798"><td class="num" id="LN5798">5798</td><td class="line">    <span class='keyword'>if</span> (lnum != 0)</td></tr>
<tr class="codeline" data-linenumber="5799"><td class="num" id="LN5799">5799</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="5800"><td class="num" id="LN5800">5800</td><td class="line">	<span class='comment'>// Count extra CR characters.</span></td></tr>
<tr class="codeline" data-linenumber="5801"><td class="num" id="LN5801">5801</td><td class="line">	<span class='keyword'>if</span> (ffdos)</td></tr>
<tr class="codeline" data-linenumber="5802"><td class="num" id="LN5802">5802</td><td class="line">	    size += lnum - 1;</td></tr>
<tr class="codeline" data-linenumber="5803"><td class="num" id="LN5803">5803</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5804"><td class="num" id="LN5804">5804</td><td class="line">	<span class='comment'>// Don't count the last line break if 'noeol' and ('bin' or</span></td></tr>
<tr class="codeline" data-linenumber="5805"><td class="num" id="LN5805">5805</td><td class="line">	<span class='comment'>// 'nofixeol').</span></td></tr>
<tr class="codeline" data-linenumber="5806"><td class="num" id="LN5806">5806</td><td class="line">	<span class='keyword'>if</span> ((!buf-&gt;b_p_fixeol || buf-&gt;b_p_bin) &amp;&amp; !buf-&gt;b_p_eol</td></tr>
<tr class="codeline" data-linenumber="5807"><td class="num" id="LN5807">5807</td><td class="line">					   &amp;&amp; lnum &gt; buf-&gt;b_ml.ml_line_count)</td></tr>
<tr class="codeline" data-linenumber="5808"><td class="num" id="LN5808">5808</td><td class="line">	    size -= ffdos + 1;</td></tr>
<tr class="codeline" data-linenumber="5809"><td class="num" id="LN5809">5809</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5810"><td class="num" id="LN5810">5810</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5811"><td class="num" id="LN5811">5811</td><td class="line">    <span class='keyword'>return</span> size;</td></tr>
<tr class="codeline" data-linenumber="5812"><td class="num" id="LN5812">5812</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5813"><td class="num" id="LN5813">5813</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5814"><td class="num" id="LN5814">5814</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="5815"><td class="num" id="LN5815">5815</td><td class="line"> <span class='comment'>* Goto byte in buffer with offset 'cnt'.</span></td></tr>
<tr class="codeline" data-linenumber="5816"><td class="num" id="LN5816">5816</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="5817"><td class="num" id="LN5817">5817</td><td class="line">    <span class='keyword'>void</span></td></tr>
<tr class="codeline" data-linenumber="5818"><td class="num" id="LN5818">5818</td><td class="line">goto_byte(<span class='keyword'>long</span> cnt)</td></tr>
<tr class="codeline" data-linenumber="5819"><td class="num" id="LN5819">5819</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="5820"><td class="num" id="LN5820">5820</td><td class="line">    <span class='keyword'>long</span>	boff = cnt;</td></tr>
<tr class="codeline" data-linenumber="5821"><td class="num" id="LN5821">5821</td><td class="line">    linenr_T	lnum;</td></tr>
<tr class="codeline" data-linenumber="5822"><td class="num" id="LN5822">5822</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5823"><td class="num" id="LN5823">5823</td><td class="line">    ml_flush_line(curbuf);	<span class='comment'>// cached line may be dirty</span></td></tr>
<tr class="codeline" data-linenumber="5824"><td class="num" id="LN5824">5824</td><td class="line">    setpcmark();</td></tr>
<tr class="codeline" data-linenumber="5825"><td class="num" id="LN5825">5825</td><td class="line">    <span class='keyword'>if</span> (boff)</td></tr>
<tr class="codeline" data-linenumber="5826"><td class="num" id="LN5826">5826</td><td class="line">	--boff;</td></tr>
<tr class="codeline" data-linenumber="5827"><td class="num" id="LN5827">5827</td><td class="line">    lnum = ml_find_line_or_offset(curbuf, (linenr_T)0, &amp;boff);</td></tr>
<tr class="codeline" data-linenumber="5828"><td class="num" id="LN5828">5828</td><td class="line">    <span class='keyword'>if</span> (lnum &lt; 1)	<span class='comment'>// past the end</span></td></tr>
<tr class="codeline" data-linenumber="5829"><td class="num" id="LN5829">5829</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="5830"><td class="num" id="LN5830">5830</td><td class="line">	curwin-&gt;w_cursor.lnum = curbuf-&gt;b_ml.ml_line_count;</td></tr>
<tr class="codeline" data-linenumber="5831"><td class="num" id="LN5831">5831</td><td class="line">	curwin-&gt;w_curswant = <span class='macro'>MAXCOL<span class='macro_popup'>2147483647</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5832"><td class="num" id="LN5832">5832</td><td class="line">	coladvance((colnr_T)<span class='macro'>MAXCOL<span class='macro_popup'>2147483647</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5833"><td class="num" id="LN5833">5833</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5834"><td class="num" id="LN5834">5834</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="5835"><td class="num" id="LN5835">5835</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="5836"><td class="num" id="LN5836">5836</td><td class="line">	curwin-&gt;w_cursor.lnum = lnum;</td></tr>
<tr class="codeline" data-linenumber="5837"><td class="num" id="LN5837">5837</td><td class="line">	curwin-&gt;w_cursor.col = (colnr_T)boff;</td></tr>
<tr class="codeline" data-linenumber="5838"><td class="num" id="LN5838">5838</td><td class="line">	curwin-&gt;w_cursor.coladd = 0;</td></tr>
<tr class="codeline" data-linenumber="5839"><td class="num" id="LN5839">5839</td><td class="line">	curwin-&gt;w_set_curswant = <span class='macro'>TRUE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5840"><td class="num" id="LN5840">5840</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5841"><td class="num" id="LN5841">5841</td><td class="line">    check_cursor();</td></tr>
<tr class="codeline" data-linenumber="5842"><td class="num" id="LN5842">5842</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5843"><td class="num" id="LN5843">5843</td><td class="line">    <span class='comment'>// Make sure the cursor is on the first byte of a multi-byte char.</span></td></tr>
<tr class="codeline" data-linenumber="5844"><td class="num" id="LN5844">5844</td><td class="line">    <span class='keyword'>if</span> (has_mbyte)</td></tr>
<tr class="codeline" data-linenumber="5845"><td class="num" id="LN5845">5845</td><td class="line">	mb_adjust_cursor();</td></tr>
<tr class="codeline" data-linenumber="5846"><td class="num" id="LN5846">5846</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5847"><td class="num" id="LN5847">5847</td><td class="line"><span class='directive'>#endif</span></td></tr>
</table></body></html>
