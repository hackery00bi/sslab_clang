
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cppcheck - HTML report - [project name]</title>
    <link rel="stylesheet" href="style.css">
    <style>
.highlight .hll { background-color: #ffffcc }
.highlight  { background: #ffffff; }
.highlight .c { color: #888888 } /* Comment */
.highlight .err { color: #FF0000; background-color: #FFAAAA } /* Error */
.highlight .k { color: #008800; font-weight: bold } /* Keyword */
.highlight .o { color: #333333 } /* Operator */
.highlight .ch { color: #888888 } /* Comment.Hashbang */
.highlight .cm { color: #888888 } /* Comment.Multiline */
.highlight .cp { color: #557799 } /* Comment.Preproc */
.highlight .cpf { color: #888888 } /* Comment.PreprocFile */
.highlight .c1 { color: #888888 } /* Comment.Single */
.highlight .cs { color: #cc0000; font-weight: bold } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008800; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008800; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008800; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #003388; font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: #008800; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #333399; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #6600EE; font-weight: bold } /* Literal.Number */
.highlight .s { background-color: #fff0f0 } /* Literal.String */
.highlight .na { color: #0000CC } /* Name.Attribute */
.highlight .nb { color: #007020 } /* Name.Builtin */
.highlight .nc { color: #BB0066; font-weight: bold } /* Name.Class */
.highlight .no { color: #003366; font-weight: bold } /* Name.Constant */
.highlight .nd { color: #555555; font-weight: bold } /* Name.Decorator */
.highlight .ni { color: #880000; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #FF0000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0066BB; font-weight: bold } /* Name.Function */
.highlight .nl { color: #997700; font-weight: bold } /* Name.Label */
.highlight .nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #007700 } /* Name.Tag */
.highlight .nv { color: #996633 } /* Name.Variable */
.highlight .ow { color: #000000; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #6600EE; font-weight: bold } /* Literal.Number.Bin */
.highlight .mf { color: #6600EE; font-weight: bold } /* Literal.Number.Float */
.highlight .mh { color: #005588; font-weight: bold } /* Literal.Number.Hex */
.highlight .mi { color: #0000DD; font-weight: bold } /* Literal.Number.Integer */
.highlight .mo { color: #4400EE; font-weight: bold } /* Literal.Number.Oct */
.highlight .sa { background-color: #fff0f0 } /* Literal.String.Affix */
.highlight .sb { background-color: #fff0f0 } /* Literal.String.Backtick */
.highlight .sc { color: #0044DD } /* Literal.String.Char */
.highlight .dl { background-color: #fff0f0 } /* Literal.String.Delimiter */
.highlight .sd { color: #DD4422 } /* Literal.String.Doc */
.highlight .s2 { background-color: #fff0f0 } /* Literal.String.Double */
.highlight .se { color: #666666; font-weight: bold; background-color: #fff0f0 } /* Literal.String.Escape */
.highlight .sh { background-color: #fff0f0 } /* Literal.String.Heredoc */
.highlight .si { background-color: #eeeeee } /* Literal.String.Interpol */
.highlight .sx { color: #DD2200; background-color: #fff0f0 } /* Literal.String.Other */
.highlight .sr { color: #000000; background-color: #fff0ff } /* Literal.String.Regex */
.highlight .s1 { background-color: #fff0f0 } /* Literal.String.Single */
.highlight .ss { color: #AA6600 } /* Literal.String.Symbol */
.highlight .bp { color: #007020 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0066BB; font-weight: bold } /* Name.Function.Magic */
.highlight .vc { color: #336699 } /* Name.Variable.Class */
.highlight .vg { color: #dd7700; font-weight: bold } /* Name.Variable.Global */
.highlight .vi { color: #3333BB } /* Name.Variable.Instance */
.highlight .vm { color: #996633 } /* Name.Variable.Magic */
.highlight .il { color: #0000DD; font-weight: bold } /* Literal.Number.Integer.Long */
    </style>
    <script>
      function getStyle(el, styleProp) {
        var y;

        if (el.currentStyle) {
          y = el.currentStyle[styleProp];
        } else if (window.getComputedStyle) {
          y = document.defaultView.getComputedStyle(el, null).getPropertyValue(styleProp);
        }

        return y;
      }

      function toggle() {
        var el = this.expandable_content;
        var mark = this.expandable_marker;

        if (el.style.display === "block") {
          el.style.display = "none";
          mark.textContent = "[+]";
        } else {
          el.style.display = "block";
          mark.textContent = "[-]";
        }
      }

      function initExpandables() {
        var elements = document.querySelectorAll(".expandable");

        for (var i = 0, len = elements.length; i < len; i++) {
          var el = elements[i];
          var clickable = el.querySelector("span");
          var marker = clickable.querySelector(".marker");
          var content = el.querySelector(".content");
          var width = clickable.clientWidth - parseInt(getStyle(content, "padding-left")) - parseInt(getStyle(content, "padding-right"));
          content.style.width = width + "px";
          clickable.expandable_content = content;
          clickable.expandable_marker = marker;
          clickable.addEventListener("click", toggle);
        }
      }

      function toggleDisplay(id) {
        var elements = document.querySelectorAll("." + id);

        for (var i = 0, len = elements.length; i < len; i++) {
          elements[i].classList.toggle("d-none");
        }
      }

      function toggleAll() {
        var elements = document.querySelectorAll("input");

        // starting from 1 since 0 is the "toggle all" input
        for (var i = 1, len = elements.length; i < len; i++) {
          var el = elements[i];

          if (el.checked) {
            el.checked = false;
          } else {
            el.checked = true;
          }

          toggleDisplay(el.id);
        }
      }
      window.addEventListener("load", initExpandables);
    </script>
  </head>
  <body>
    <div id="header" class="header">
      <h1>Cppcheck report - [project name]: /tmp/sslab_clang/c_git/git/symlinks.c</h1>
    </div>
    <div class="wrapper">
      <div id="menu">
       <p id="filename"><a href="index.html">Defects:</a> symlinks.c</p>
<a href="296.html#line-0"> toomanyconfigs 0</a>
    </div>
    <div id="content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323</pre></div></td><td class="code"><div class="highlight"><pre><span></span><a name="line-1"></a><span class="cp">#include</span> <span class="cpf">&quot;cache.h&quot;</span><span class="cp"></span>
<a name="line-2"></a>
<a name="line-3"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">threaded_check_leading_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_def</span> <span class="o">*</span><span class="n">cache</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<a name="line-4"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">threaded_has_dirs_only_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_def</span> <span class="o">*</span><span class="n">cache</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prefix_len</span><span class="p">);</span>
<a name="line-5"></a>
<a name="line-6"></a><span class="cm">/*</span>
<a name="line-7"></a><span class="cm"> * Returns the length (on a path component basis) of the longest</span>
<a name="line-8"></a><span class="cm"> * common prefix match of &#39;name_a&#39; and &#39;name_b&#39;.</span>
<a name="line-9"></a><span class="cm"> */</span>
<a name="line-10"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">longest_path_match</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name_a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len_a</span><span class="p">,</span>
<a name="line-11"></a>			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name_b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len_b</span><span class="p">,</span>
<a name="line-12"></a>			      <span class="kt">int</span> <span class="o">*</span><span class="n">previous_slash</span><span class="p">)</span>
<a name="line-13"></a><span class="p">{</span>
<a name="line-14"></a>	<span class="kt">int</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">match_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">match_len_prev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-15"></a>
<a name="line-16"></a>	<span class="n">max_len</span> <span class="o">=</span> <span class="n">len_a</span> <span class="o">&lt;</span> <span class="n">len_b</span> <span class="o">?</span> <span class="nl">len_a</span> <span class="p">:</span> <span class="n">len_b</span><span class="p">;</span>
<a name="line-17"></a>	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_len</span> <span class="o">&amp;&amp;</span> <span class="n">name_a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">name_b</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
<a name="line-18"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">name_a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
<a name="line-19"></a>			<span class="n">match_len_prev</span> <span class="o">=</span> <span class="n">match_len</span><span class="p">;</span>
<a name="line-20"></a>			<span class="n">match_len</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<a name="line-21"></a>		<span class="p">}</span>
<a name="line-22"></a>		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
<a name="line-23"></a>	<span class="p">}</span>
<a name="line-24"></a>	<span class="cm">/*</span>
<a name="line-25"></a><span class="cm">	 * Is &#39;name_b&#39; a substring of &#39;name_a&#39;, the other way around,</span>
<a name="line-26"></a><span class="cm">	 * or is &#39;name_a&#39; and &#39;name_b&#39; the exact same string?</span>
<a name="line-27"></a><span class="cm">	 */</span>
<a name="line-28"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">max_len</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">len_a</span> <span class="o">&gt;</span> <span class="n">len_b</span> <span class="o">&amp;&amp;</span> <span class="n">name_a</span><span class="p">[</span><span class="n">len_b</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="o">||</span>
<a name="line-29"></a>			     <span class="p">(</span><span class="n">len_a</span> <span class="o">&lt;</span> <span class="n">len_b</span> <span class="o">&amp;&amp;</span> <span class="n">name_b</span><span class="p">[</span><span class="n">len_a</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="o">||</span>
<a name="line-30"></a>			     <span class="p">(</span><span class="n">len_a</span> <span class="o">==</span> <span class="n">len_b</span><span class="p">)))</span> <span class="p">{</span>
<a name="line-31"></a>		<span class="n">match_len_prev</span> <span class="o">=</span> <span class="n">match_len</span><span class="p">;</span>
<a name="line-32"></a>		<span class="n">match_len</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<a name="line-33"></a>	<span class="p">}</span>
<a name="line-34"></a>	<span class="o">*</span><span class="n">previous_slash</span> <span class="o">=</span> <span class="n">match_len_prev</span><span class="p">;</span>
<a name="line-35"></a>	<span class="k">return</span> <span class="n">match_len</span><span class="p">;</span>
<a name="line-36"></a><span class="p">}</span>
<a name="line-37"></a>
<a name="line-38"></a><span class="k">static</span> <span class="k">struct</span> <span class="n">cache_def</span> <span class="n">default_cache</span> <span class="o">=</span> <span class="n">CACHE_DEF_INIT</span><span class="p">;</span>
<a name="line-39"></a>
<a name="line-40"></a><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">reset_lstat_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_def</span> <span class="o">*</span><span class="n">cache</span><span class="p">)</span>
<a name="line-41"></a><span class="p">{</span>
<a name="line-42"></a>	<span class="n">strbuf_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
<a name="line-43"></a>	<span class="n">cache</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-44"></a>	<span class="cm">/*</span>
<a name="line-45"></a><span class="cm">	 * The track_flags and prefix_len_stat_func members is only</span>
<a name="line-46"></a><span class="cm">	 * set by the safeguard rule inside lstat_cache()</span>
<a name="line-47"></a><span class="cm">	 */</span>
<a name="line-48"></a><span class="p">}</span>
<a name="line-49"></a>
<a name="line-50"></a><span class="cp">#define FL_DIR      (1 &lt;&lt; 0)</span>
<a name="line-51"></a><span class="cp">#define FL_NOENT    (1 &lt;&lt; 1)</span>
<a name="line-52"></a><span class="cp">#define FL_SYMLINK  (1 &lt;&lt; 2)</span>
<a name="line-53"></a><span class="cp">#define FL_LSTATERR (1 &lt;&lt; 3)</span>
<a name="line-54"></a><span class="cp">#define FL_ERR      (1 &lt;&lt; 4)</span>
<a name="line-55"></a><span class="cp">#define FL_FULLPATH (1 &lt;&lt; 5)</span>
<a name="line-56"></a>
<a name="line-57"></a><span class="cm">/*</span>
<a name="line-58"></a><span class="cm"> * Check if name &#39;name&#39; of length &#39;len&#39; has a symlink leading</span>
<a name="line-59"></a><span class="cm"> * component, or if the directory exists and is real, or not.</span>
<a name="line-60"></a><span class="cm"> *</span>
<a name="line-61"></a><span class="cm"> * To speed up the check, some information is allowed to be cached.</span>
<a name="line-62"></a><span class="cm"> * This can be indicated by the &#39;track_flags&#39; argument, which also can</span>
<a name="line-63"></a><span class="cm"> * be used to indicate that we should check the full path.</span>
<a name="line-64"></a><span class="cm"> *</span>
<a name="line-65"></a><span class="cm"> * The &#39;prefix_len_stat_func&#39; parameter can be used to set the length</span>
<a name="line-66"></a><span class="cm"> * of the prefix, where the cache should use the stat() function</span>
<a name="line-67"></a><span class="cm"> * instead of the lstat() function to test each path component.</span>
<a name="line-68"></a><span class="cm"> */</span>
<a name="line-69"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">lstat_cache_matchlen</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_def</span> <span class="o">*</span><span class="n">cache</span><span class="p">,</span>
<a name="line-70"></a>				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
<a name="line-71"></a>				<span class="kt">int</span> <span class="o">*</span><span class="n">ret_flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">track_flags</span><span class="p">,</span>
<a name="line-72"></a>				<span class="kt">int</span> <span class="n">prefix_len_stat_func</span><span class="p">)</span>
<a name="line-73"></a><span class="p">{</span>
<a name="line-74"></a>	<span class="kt">int</span> <span class="n">match_len</span><span class="p">,</span> <span class="n">last_slash</span><span class="p">,</span> <span class="n">last_slash_dir</span><span class="p">,</span> <span class="n">previous_slash</span><span class="p">;</span>
<a name="line-75"></a>	<span class="kt">int</span> <span class="n">save_flags</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
<a name="line-76"></a>	<span class="k">struct</span> <span class="n">stat</span> <span class="n">st</span><span class="p">;</span>
<a name="line-77"></a>
<a name="line-78"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">track_flags</span> <span class="o">!=</span> <span class="n">track_flags</span> <span class="o">||</span>
<a name="line-79"></a>	    <span class="n">cache</span><span class="o">-&gt;</span><span class="n">prefix_len_stat_func</span> <span class="o">!=</span> <span class="n">prefix_len_stat_func</span><span class="p">)</span> <span class="p">{</span>
<a name="line-80"></a>		<span class="cm">/*</span>
<a name="line-81"></a><span class="cm">		 * As a safeguard rule we clear the cache if the</span>
<a name="line-82"></a><span class="cm">		 * values of track_flags and/or prefix_len_stat_func</span>
<a name="line-83"></a><span class="cm">		 * does not match with the last supplied values.</span>
<a name="line-84"></a><span class="cm">		 */</span>
<a name="line-85"></a>		<span class="n">reset_lstat_cache</span><span class="p">(</span><span class="n">cache</span><span class="p">);</span>
<a name="line-86"></a>		<span class="n">cache</span><span class="o">-&gt;</span><span class="n">track_flags</span> <span class="o">=</span> <span class="n">track_flags</span><span class="p">;</span>
<a name="line-87"></a>		<span class="n">cache</span><span class="o">-&gt;</span><span class="n">prefix_len_stat_func</span> <span class="o">=</span> <span class="n">prefix_len_stat_func</span><span class="p">;</span>
<a name="line-88"></a>		<span class="n">match_len</span> <span class="o">=</span> <span class="n">last_slash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-89"></a>	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="line-90"></a>		<span class="cm">/*</span>
<a name="line-91"></a><span class="cm">		 * Check to see if we have a match from the cache for</span>
<a name="line-92"></a><span class="cm">		 * the 2 &quot;excluding&quot; path types.</span>
<a name="line-93"></a><span class="cm">		 */</span>
<a name="line-94"></a>		<span class="n">match_len</span> <span class="o">=</span> <span class="n">last_slash</span> <span class="o">=</span>
<a name="line-95"></a>			<span class="n">longest_path_match</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">cache</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span>
<a name="line-96"></a>					   <span class="n">cache</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">previous_slash</span><span class="p">);</span>
<a name="line-97"></a>		<span class="o">*</span><span class="n">ret_flags</span> <span class="o">=</span> <span class="n">cache</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">track_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FL_NOENT</span><span class="o">|</span><span class="n">FL_SYMLINK</span><span class="p">);</span>
<a name="line-98"></a>
<a name="line-99"></a>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">track_flags</span> <span class="o">&amp;</span> <span class="n">FL_FULLPATH</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">match_len</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span>
<a name="line-100"></a>			<span class="n">match_len</span> <span class="o">=</span> <span class="n">last_slash</span> <span class="o">=</span> <span class="n">previous_slash</span><span class="p">;</span>
<a name="line-101"></a>
<a name="line-102"></a>		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ret_flags</span> <span class="o">&amp;&amp;</span> <span class="n">match_len</span> <span class="o">==</span> <span class="n">cache</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
<a name="line-103"></a>			<span class="k">return</span> <span class="n">match_len</span><span class="p">;</span>
<a name="line-104"></a>		<span class="cm">/*</span>
<a name="line-105"></a><span class="cm">		 * If we now have match_len &gt; 0, we would know that</span>
<a name="line-106"></a><span class="cm">		 * the matched part will always be a directory.</span>
<a name="line-107"></a><span class="cm">		 *</span>
<a name="line-108"></a><span class="cm">		 * Also, if we are tracking directories and &#39;name&#39; is</span>
<a name="line-109"></a><span class="cm">		 * a substring of the cache on a path component basis,</span>
<a name="line-110"></a><span class="cm">		 * we can return immediately.</span>
<a name="line-111"></a><span class="cm">		 */</span>
<a name="line-112"></a>		<span class="o">*</span><span class="n">ret_flags</span> <span class="o">=</span> <span class="n">track_flags</span> <span class="o">&amp;</span> <span class="n">FL_DIR</span><span class="p">;</span>
<a name="line-113"></a>		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ret_flags</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">==</span> <span class="n">match_len</span><span class="p">)</span>
<a name="line-114"></a>			<span class="k">return</span> <span class="n">match_len</span><span class="p">;</span>
<a name="line-115"></a>	<span class="p">}</span>
<a name="line-116"></a>
<a name="line-117"></a>	<span class="cm">/*</span>
<a name="line-118"></a><span class="cm">	 * Okay, no match from the cache so far, so now we have to</span>
<a name="line-119"></a><span class="cm">	 * check the rest of the path components.</span>
<a name="line-120"></a><span class="cm">	 */</span>
<a name="line-121"></a>	<span class="o">*</span><span class="n">ret_flags</span> <span class="o">=</span> <span class="n">FL_DIR</span><span class="p">;</span>
<a name="line-122"></a>	<span class="n">last_slash_dir</span> <span class="o">=</span> <span class="n">last_slash</span><span class="p">;</span>
<a name="line-123"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">cache</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
<a name="line-124"></a>		<span class="n">strbuf_grow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">cache</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
<a name="line-125"></a>	<span class="k">while</span> <span class="p">(</span><span class="n">match_len</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
<a name="line-126"></a>		<span class="k">do</span> <span class="p">{</span>
<a name="line-127"></a>			<span class="n">cache</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">match_len</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="n">match_len</span><span class="p">];</span>
<a name="line-128"></a>			<span class="n">match_len</span><span class="o">++</span><span class="p">;</span>
<a name="line-129"></a>		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">match_len</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">name</span><span class="p">[</span><span class="n">match_len</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span><span class="p">);</span>
<a name="line-130"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">match_len</span> <span class="o">&gt;=</span> <span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">track_flags</span> <span class="o">&amp;</span> <span class="n">FL_FULLPATH</span><span class="p">))</span>
<a name="line-131"></a>			<span class="k">break</span><span class="p">;</span>
<a name="line-132"></a>		<span class="n">last_slash</span> <span class="o">=</span> <span class="n">match_len</span><span class="p">;</span>
<a name="line-133"></a>		<span class="n">cache</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">last_slash</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<a name="line-134"></a>
<a name="line-135"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">last_slash</span> <span class="o">&lt;=</span> <span class="n">prefix_len_stat_func</span><span class="p">)</span>
<a name="line-136"></a>			<span class="n">ret</span> <span class="o">=</span> <span class="n">stat</span><span class="p">(</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">);</span>
<a name="line-137"></a>		<span class="k">else</span>
<a name="line-138"></a>			<span class="n">ret</span> <span class="o">=</span> <span class="n">lstat</span><span class="p">(</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">);</span>
<a name="line-139"></a>
<a name="line-140"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
<a name="line-141"></a>			<span class="o">*</span><span class="n">ret_flags</span> <span class="o">=</span> <span class="n">FL_LSTATERR</span><span class="p">;</span>
<a name="line-142"></a>			<span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">ENOENT</span><span class="p">)</span>
<a name="line-143"></a>				<span class="o">*</span><span class="n">ret_flags</span> <span class="o">|=</span> <span class="n">FL_NOENT</span><span class="p">;</span>
<a name="line-144"></a>		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="p">{</span>
<a name="line-145"></a>			<span class="n">last_slash_dir</span> <span class="o">=</span> <span class="n">last_slash</span><span class="p">;</span>
<a name="line-146"></a>			<span class="k">continue</span><span class="p">;</span>
<a name="line-147"></a>		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">S_ISLNK</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="p">{</span>
<a name="line-148"></a>			<span class="o">*</span><span class="n">ret_flags</span> <span class="o">=</span> <span class="n">FL_SYMLINK</span><span class="p">;</span>
<a name="line-149"></a>		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="line-150"></a>			<span class="o">*</span><span class="n">ret_flags</span> <span class="o">=</span> <span class="n">FL_ERR</span><span class="p">;</span>
<a name="line-151"></a>		<span class="p">}</span>
<a name="line-152"></a>		<span class="k">break</span><span class="p">;</span>
<a name="line-153"></a>	<span class="p">}</span>
<a name="line-154"></a>
<a name="line-155"></a>	<span class="cm">/*</span>
<a name="line-156"></a><span class="cm">	 * At the end update the cache.  Note that max 3 different</span>
<a name="line-157"></a><span class="cm">	 * path types, FL_NOENT, FL_SYMLINK and FL_DIR, can be cached</span>
<a name="line-158"></a><span class="cm">	 * for the moment!</span>
<a name="line-159"></a><span class="cm">	 */</span>
<a name="line-160"></a>	<span class="n">save_flags</span> <span class="o">=</span> <span class="o">*</span><span class="n">ret_flags</span> <span class="o">&amp;</span> <span class="n">track_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FL_NOENT</span><span class="o">|</span><span class="n">FL_SYMLINK</span><span class="p">);</span>
<a name="line-161"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">save_flags</span> <span class="o">&amp;&amp;</span> <span class="n">last_slash</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="line-162"></a>		<span class="n">cache</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">last_slash</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<a name="line-163"></a>		<span class="n">cache</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">last_slash</span><span class="p">;</span>
<a name="line-164"></a>		<span class="n">cache</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">save_flags</span><span class="p">;</span>
<a name="line-165"></a>	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">track_flags</span> <span class="o">&amp;</span> <span class="n">FL_DIR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">last_slash_dir</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="line-166"></a>		<span class="cm">/*</span>
<a name="line-167"></a><span class="cm">		 * We have a separate test for the directory case,</span>
<a name="line-168"></a><span class="cm">		 * since it could be that we have found a symlink or a</span>
<a name="line-169"></a><span class="cm">		 * non-existing directory and the track_flags says</span>
<a name="line-170"></a><span class="cm">		 * that we cannot cache this fact, so the cache would</span>
<a name="line-171"></a><span class="cm">		 * then have been left empty in this case.</span>
<a name="line-172"></a><span class="cm">		 *</span>
<a name="line-173"></a><span class="cm">		 * But if we are allowed to track real directories, we</span>
<a name="line-174"></a><span class="cm">		 * can still cache the path components before the last</span>
<a name="line-175"></a><span class="cm">		 * one (the found symlink or non-existing component).</span>
<a name="line-176"></a><span class="cm">		 */</span>
<a name="line-177"></a>		<span class="n">cache</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">last_slash_dir</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<a name="line-178"></a>		<span class="n">cache</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">last_slash_dir</span><span class="p">;</span>
<a name="line-179"></a>		<span class="n">cache</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FL_DIR</span><span class="p">;</span>
<a name="line-180"></a>	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="line-181"></a>		<span class="n">reset_lstat_cache</span><span class="p">(</span><span class="n">cache</span><span class="p">);</span>
<a name="line-182"></a>	<span class="p">}</span>
<a name="line-183"></a>	<span class="k">return</span> <span class="n">match_len</span><span class="p">;</span>
<a name="line-184"></a><span class="p">}</span>
<a name="line-185"></a>
<a name="line-186"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">lstat_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_def</span> <span class="o">*</span><span class="n">cache</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
<a name="line-187"></a>		       <span class="kt">int</span> <span class="n">track_flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prefix_len_stat_func</span><span class="p">)</span>
<a name="line-188"></a><span class="p">{</span>
<a name="line-189"></a>	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
<a name="line-190"></a>	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">lstat_cache_matchlen</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="n">track_flags</span><span class="p">,</span>
<a name="line-191"></a>			<span class="n">prefix_len_stat_func</span><span class="p">);</span>
<a name="line-192"></a>	<span class="k">return</span> <span class="n">flags</span><span class="p">;</span>
<a name="line-193"></a><span class="p">}</span>
<a name="line-194"></a>
<a name="line-195"></a><span class="cp">#define USE_ONLY_LSTAT  0</span>
<a name="line-196"></a>
<a name="line-197"></a><span class="cm">/*</span>
<a name="line-198"></a><span class="cm"> * Return non-zero if path &#39;name&#39; has a leading symlink component</span>
<a name="line-199"></a><span class="cm"> */</span>
<a name="line-200"></a><span class="kt">int</span> <span class="nf">threaded_has_symlink_leading_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_def</span> <span class="o">*</span><span class="n">cache</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<a name="line-201"></a><span class="p">{</span>
<a name="line-202"></a>	<span class="k">return</span> <span class="n">lstat_cache</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">FL_SYMLINK</span><span class="o">|</span><span class="n">FL_DIR</span><span class="p">,</span> <span class="n">USE_ONLY_LSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FL_SYMLINK</span><span class="p">;</span>
<a name="line-203"></a><span class="p">}</span>
<a name="line-204"></a>
<a name="line-205"></a><span class="cm">/*</span>
<a name="line-206"></a><span class="cm"> * Return non-zero if path &#39;name&#39; has a leading symlink component</span>
<a name="line-207"></a><span class="cm"> */</span>
<a name="line-208"></a><span class="kt">int</span> <span class="nf">has_symlink_leading_path</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<a name="line-209"></a><span class="p">{</span>
<a name="line-210"></a>	<span class="k">return</span> <span class="n">threaded_has_symlink_leading_path</span><span class="p">(</span><span class="o">&amp;</span><span class="n">default_cache</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="line-211"></a><span class="p">}</span>
<a name="line-212"></a>
<a name="line-213"></a><span class="cm">/*</span>
<a name="line-214"></a><span class="cm"> * Return zero if path &#39;name&#39; has a leading symlink component or</span>
<a name="line-215"></a><span class="cm"> * if some leading path component does not exists.</span>
<a name="line-216"></a><span class="cm"> *</span>
<a name="line-217"></a><span class="cm"> * Return -1 if leading path exists and is a directory.</span>
<a name="line-218"></a><span class="cm"> *</span>
<a name="line-219"></a><span class="cm"> * Return path length if leading path exists and is neither a</span>
<a name="line-220"></a><span class="cm"> * directory nor a symlink.</span>
<a name="line-221"></a><span class="cm"> */</span>
<a name="line-222"></a><span class="kt">int</span> <span class="nf">check_leading_path</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<a name="line-223"></a><span class="p">{</span>
<a name="line-224"></a>	<span class="k">return</span> <span class="n">threaded_check_leading_path</span><span class="p">(</span><span class="o">&amp;</span><span class="n">default_cache</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<a name="line-225"></a><span class="p">}</span>
<a name="line-226"></a>
<a name="line-227"></a><span class="cm">/*</span>
<a name="line-228"></a><span class="cm"> * Return zero if path &#39;name&#39; has a leading symlink component or</span>
<a name="line-229"></a><span class="cm"> * if some leading path component does not exists.</span>
<a name="line-230"></a><span class="cm"> *</span>
<a name="line-231"></a><span class="cm"> * Return -1 if leading path exists and is a directory.</span>
<a name="line-232"></a><span class="cm"> *</span>
<a name="line-233"></a><span class="cm"> * Return path length if leading path exists and is neither a</span>
<a name="line-234"></a><span class="cm"> * directory nor a symlink.</span>
<a name="line-235"></a><span class="cm"> */</span>
<a name="line-236"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">threaded_check_leading_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_def</span> <span class="o">*</span><span class="n">cache</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<a name="line-237"></a><span class="p">{</span>
<a name="line-238"></a>	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
<a name="line-239"></a>	<span class="kt">int</span> <span class="n">match_len</span> <span class="o">=</span> <span class="n">lstat_cache_matchlen</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span>
<a name="line-240"></a>			   <span class="n">FL_SYMLINK</span><span class="o">|</span><span class="n">FL_NOENT</span><span class="o">|</span><span class="n">FL_DIR</span><span class="p">,</span> <span class="n">USE_ONLY_LSTAT</span><span class="p">);</span>
<a name="line-241"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FL_NOENT</span><span class="p">)</span>
<a name="line-242"></a>		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-243"></a>	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FL_DIR</span><span class="p">)</span>
<a name="line-244"></a>		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="line-245"></a>	<span class="k">else</span>
<a name="line-246"></a>		<span class="k">return</span> <span class="n">match_len</span><span class="p">;</span>
<a name="line-247"></a><span class="p">}</span>
<a name="line-248"></a>
<a name="line-249"></a><span class="cm">/*</span>
<a name="line-250"></a><span class="cm"> * Return non-zero if all path components of &#39;name&#39; exists as a</span>
<a name="line-251"></a><span class="cm"> * directory.  If prefix_len &gt; 0, we will test with the stat()</span>
<a name="line-252"></a><span class="cm"> * function instead of the lstat() function for a prefix length of</span>
<a name="line-253"></a><span class="cm"> * &#39;prefix_len&#39;, thus we then allow for symlinks in the prefix part as</span>
<a name="line-254"></a><span class="cm"> * long as those points to real existing directories.</span>
<a name="line-255"></a><span class="cm"> */</span>
<a name="line-256"></a><span class="kt">int</span> <span class="nf">has_dirs_only_path</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prefix_len</span><span class="p">)</span>
<a name="line-257"></a><span class="p">{</span>
<a name="line-258"></a>	<span class="k">return</span> <span class="n">threaded_has_dirs_only_path</span><span class="p">(</span><span class="o">&amp;</span><span class="n">default_cache</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">prefix_len</span><span class="p">);</span>
<a name="line-259"></a><span class="p">}</span>
<a name="line-260"></a>
<a name="line-261"></a><span class="cm">/*</span>
<a name="line-262"></a><span class="cm"> * Return non-zero if all path components of &#39;name&#39; exists as a</span>
<a name="line-263"></a><span class="cm"> * directory.  If prefix_len &gt; 0, we will test with the stat()</span>
<a name="line-264"></a><span class="cm"> * function instead of the lstat() function for a prefix length of</span>
<a name="line-265"></a><span class="cm"> * &#39;prefix_len&#39;, thus we then allow for symlinks in the prefix part as</span>
<a name="line-266"></a><span class="cm"> * long as those points to real existing directories.</span>
<a name="line-267"></a><span class="cm"> */</span>
<a name="line-268"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">threaded_has_dirs_only_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">cache_def</span> <span class="o">*</span><span class="n">cache</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prefix_len</span><span class="p">)</span>
<a name="line-269"></a><span class="p">{</span>
<a name="line-270"></a>	<span class="k">return</span> <span class="n">lstat_cache</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
<a name="line-271"></a>			   <span class="n">FL_DIR</span><span class="o">|</span><span class="n">FL_FULLPATH</span><span class="p">,</span> <span class="n">prefix_len</span><span class="p">)</span> <span class="o">&amp;</span>
<a name="line-272"></a>		<span class="n">FL_DIR</span><span class="p">;</span>
<a name="line-273"></a><span class="p">}</span>
<a name="line-274"></a>
<a name="line-275"></a><span class="k">static</span> <span class="k">struct</span> <span class="n">strbuf</span> <span class="n">removal</span> <span class="o">=</span> <span class="n">STRBUF_INIT</span><span class="p">;</span>
<a name="line-276"></a>
<a name="line-277"></a><span class="k">static</span> <span class="kt">void</span> <span class="nf">do_remove_scheduled_dirs</span><span class="p">(</span><span class="kt">int</span> <span class="n">new_len</span><span class="p">)</span>
<a name="line-278"></a><span class="p">{</span>
<a name="line-279"></a>	<span class="k">while</span> <span class="p">(</span><span class="n">removal</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">new_len</span><span class="p">)</span> <span class="p">{</span>
<a name="line-280"></a>		<span class="n">removal</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">removal</span><span class="p">.</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<a name="line-281"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">rmdir</span><span class="p">(</span><span class="n">removal</span><span class="p">.</span><span class="n">buf</span><span class="p">))</span>
<a name="line-282"></a>			<span class="k">break</span><span class="p">;</span>
<a name="line-283"></a>		<span class="k">do</span> <span class="p">{</span>
<a name="line-284"></a>			<span class="n">removal</span><span class="p">.</span><span class="n">len</span><span class="o">--</span><span class="p">;</span>
<a name="line-285"></a>		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">removal</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">new_len</span> <span class="o">&amp;&amp;</span>
<a name="line-286"></a>			 <span class="n">removal</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">removal</span><span class="p">.</span><span class="n">len</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span><span class="p">);</span>
<a name="line-287"></a>	<span class="p">}</span>
<a name="line-288"></a>	<span class="n">removal</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">new_len</span><span class="p">;</span>
<a name="line-289"></a><span class="p">}</span>
<a name="line-290"></a>
<a name="line-291"></a><span class="kt">void</span> <span class="nf">schedule_dir_for_removal</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<a name="line-292"></a><span class="p">{</span>
<a name="line-293"></a>	<span class="kt">int</span> <span class="n">match_len</span><span class="p">,</span> <span class="n">last_slash</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">previous_slash</span><span class="p">;</span>
<a name="line-294"></a>
<a name="line-295"></a>	<span class="n">match_len</span> <span class="o">=</span> <span class="n">last_slash</span> <span class="o">=</span> <span class="n">i</span> <span class="o">=</span>
<a name="line-296"></a>		<span class="n">longest_path_match</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">removal</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">removal</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
<a name="line-297"></a>				   <span class="o">&amp;</span><span class="n">previous_slash</span><span class="p">);</span>
<a name="line-298"></a>	<span class="cm">/* Find last slash inside &#39;name&#39; */</span>
<a name="line-299"></a>	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
<a name="line-300"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span>
<a name="line-301"></a>			<span class="n">last_slash</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<a name="line-302"></a>		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
<a name="line-303"></a>	<span class="p">}</span>
<a name="line-304"></a>
<a name="line-305"></a>	<span class="cm">/*</span>
<a name="line-306"></a><span class="cm">	 * If we are about to go down the directory tree, we check if</span>
<a name="line-307"></a><span class="cm">	 * we must first go upwards the tree, such that we then can</span>
<a name="line-308"></a><span class="cm">	 * remove possible empty directories as we go upwards.</span>
<a name="line-309"></a><span class="cm">	 */</span>
<a name="line-310"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">match_len</span> <span class="o">&lt;</span> <span class="n">last_slash</span> <span class="o">&amp;&amp;</span> <span class="n">match_len</span> <span class="o">&lt;</span> <span class="n">removal</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
<a name="line-311"></a>		<span class="n">do_remove_scheduled_dirs</span><span class="p">(</span><span class="n">match_len</span><span class="p">);</span>
<a name="line-312"></a>	<span class="cm">/*</span>
<a name="line-313"></a><span class="cm">	 * If we go deeper down the directory tree, we only need to</span>
<a name="line-314"></a><span class="cm">	 * save the new path components as we go down.</span>
<a name="line-315"></a><span class="cm">	 */</span>
<a name="line-316"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">match_len</span> <span class="o">&lt;</span> <span class="n">last_slash</span><span class="p">)</span>
<a name="line-317"></a>		<span class="n">strbuf_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">removal</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">[</span><span class="n">match_len</span><span class="p">],</span> <span class="n">last_slash</span> <span class="o">-</span> <span class="n">match_len</span><span class="p">);</span>
<a name="line-318"></a><span class="p">}</span>
<a name="line-319"></a>
<a name="line-320"></a><span class="kt">void</span> <span class="nf">remove_scheduled_dirs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a name="line-321"></a><span class="p">{</span>
<a name="line-322"></a>	<span class="n">do_remove_scheduled_dirs</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a name="line-323"></a><span class="p">}</span>
</pre></div>
</td></tr></table>
      </div> <!-- /.wrapper -->
    </div>
    <div id="footer" class="footer">
      <p>
        Cppcheck 2.2 - a tool for static C/C++ code analysis<br>
        <br>
        Internet: <a href="http://cppcheck.net">http://cppcheck.net</a><br>
        IRC: <a href="irc://irc.freenode.net/cppcheck">irc://irc.freenode.net/cppcheck</a><br>
      </p>
    </div>
  </body>
</html>
