
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cppcheck - HTML report - [project name]</title>
    <link rel="stylesheet" href="style.css">
    <style>
.highlight .hll { background-color: #ffffcc }
.highlight  { background: #ffffff; }
.highlight .c { color: #888888 } /* Comment */
.highlight .err { color: #FF0000; background-color: #FFAAAA } /* Error */
.highlight .k { color: #008800; font-weight: bold } /* Keyword */
.highlight .o { color: #333333 } /* Operator */
.highlight .ch { color: #888888 } /* Comment.Hashbang */
.highlight .cm { color: #888888 } /* Comment.Multiline */
.highlight .cp { color: #557799 } /* Comment.Preproc */
.highlight .cpf { color: #888888 } /* Comment.PreprocFile */
.highlight .c1 { color: #888888 } /* Comment.Single */
.highlight .cs { color: #cc0000; font-weight: bold } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008800; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008800; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008800; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #003388; font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: #008800; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #333399; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #6600EE; font-weight: bold } /* Literal.Number */
.highlight .s { background-color: #fff0f0 } /* Literal.String */
.highlight .na { color: #0000CC } /* Name.Attribute */
.highlight .nb { color: #007020 } /* Name.Builtin */
.highlight .nc { color: #BB0066; font-weight: bold } /* Name.Class */
.highlight .no { color: #003366; font-weight: bold } /* Name.Constant */
.highlight .nd { color: #555555; font-weight: bold } /* Name.Decorator */
.highlight .ni { color: #880000; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #FF0000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0066BB; font-weight: bold } /* Name.Function */
.highlight .nl { color: #997700; font-weight: bold } /* Name.Label */
.highlight .nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #007700 } /* Name.Tag */
.highlight .nv { color: #996633 } /* Name.Variable */
.highlight .ow { color: #000000; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #6600EE; font-weight: bold } /* Literal.Number.Bin */
.highlight .mf { color: #6600EE; font-weight: bold } /* Literal.Number.Float */
.highlight .mh { color: #005588; font-weight: bold } /* Literal.Number.Hex */
.highlight .mi { color: #0000DD; font-weight: bold } /* Literal.Number.Integer */
.highlight .mo { color: #4400EE; font-weight: bold } /* Literal.Number.Oct */
.highlight .sa { background-color: #fff0f0 } /* Literal.String.Affix */
.highlight .sb { background-color: #fff0f0 } /* Literal.String.Backtick */
.highlight .sc { color: #0044DD } /* Literal.String.Char */
.highlight .dl { background-color: #fff0f0 } /* Literal.String.Delimiter */
.highlight .sd { color: #DD4422 } /* Literal.String.Doc */
.highlight .s2 { background-color: #fff0f0 } /* Literal.String.Double */
.highlight .se { color: #666666; font-weight: bold; background-color: #fff0f0 } /* Literal.String.Escape */
.highlight .sh { background-color: #fff0f0 } /* Literal.String.Heredoc */
.highlight .si { background-color: #eeeeee } /* Literal.String.Interpol */
.highlight .sx { color: #DD2200; background-color: #fff0f0 } /* Literal.String.Other */
.highlight .sr { color: #000000; background-color: #fff0ff } /* Literal.String.Regex */
.highlight .s1 { background-color: #fff0f0 } /* Literal.String.Single */
.highlight .ss { color: #AA6600 } /* Literal.String.Symbol */
.highlight .bp { color: #007020 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0066BB; font-weight: bold } /* Name.Function.Magic */
.highlight .vc { color: #336699 } /* Name.Variable.Class */
.highlight .vg { color: #dd7700; font-weight: bold } /* Name.Variable.Global */
.highlight .vi { color: #3333BB } /* Name.Variable.Instance */
.highlight .vm { color: #996633 } /* Name.Variable.Magic */
.highlight .il { color: #0000DD; font-weight: bold } /* Literal.Number.Integer.Long */
    </style>
    <script>
      function getStyle(el, styleProp) {
        var y;

        if (el.currentStyle) {
          y = el.currentStyle[styleProp];
        } else if (window.getComputedStyle) {
          y = document.defaultView.getComputedStyle(el, null).getPropertyValue(styleProp);
        }

        return y;
      }

      function toggle() {
        var el = this.expandable_content;
        var mark = this.expandable_marker;

        if (el.style.display === "block") {
          el.style.display = "none";
          mark.textContent = "[+]";
        } else {
          el.style.display = "block";
          mark.textContent = "[-]";
        }
      }

      function initExpandables() {
        var elements = document.querySelectorAll(".expandable");

        for (var i = 0, len = elements.length; i < len; i++) {
          var el = elements[i];
          var clickable = el.querySelector("span");
          var marker = clickable.querySelector(".marker");
          var content = el.querySelector(".content");
          var width = clickable.clientWidth - parseInt(getStyle(content, "padding-left")) - parseInt(getStyle(content, "padding-right"));
          content.style.width = width + "px";
          clickable.expandable_content = content;
          clickable.expandable_marker = marker;
          clickable.addEventListener("click", toggle);
        }
      }

      function toggleDisplay(id) {
        var elements = document.querySelectorAll("." + id);

        for (var i = 0, len = elements.length; i < len; i++) {
          elements[i].classList.toggle("d-none");
        }
      }

      function toggleAll() {
        var elements = document.querySelectorAll("input");

        // starting from 1 since 0 is the "toggle all" input
        for (var i = 1, len = elements.length; i < len; i++) {
          var el = elements[i];

          if (el.checked) {
            el.checked = false;
          } else {
            el.checked = true;
          }

          toggleDisplay(el.id);
        }
      }
      window.addEventListener("load", initExpandables);
    </script>
  </head>
  <body>
    <div id="header" class="header">
      <h1>Cppcheck report - [project name]: /tmp/sslab_clang/c_git/git/urlmatch.c</h1>
    </div>
    <div class="wrapper">
      <div id="menu">
       <p id="filename"><a href="index.html">Defects:</a> urlmatch.c</p>
<a href="331.html#line-0"> toomanyconfigs 0</a>
    </div>
    <div id="content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613</pre></div></td><td class="code"><div class="highlight"><pre><span></span><a name="line-1"></a><span class="cp">#include</span> <span class="cpf">&quot;cache.h&quot;</span><span class="cp"></span>
<a name="line-2"></a><span class="cp">#include</span> <span class="cpf">&quot;urlmatch.h&quot;</span><span class="cp"></span>
<a name="line-3"></a>
<a name="line-4"></a><span class="cp">#define URL_ALPHA &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;</span>
<a name="line-5"></a><span class="cp">#define URL_DIGIT &quot;0123456789&quot;</span>
<a name="line-6"></a><span class="cp">#define URL_ALPHADIGIT URL_ALPHA URL_DIGIT</span>
<a name="line-7"></a><span class="cp">#define URL_SCHEME_CHARS URL_ALPHADIGIT &quot;+.-&quot;</span>
<a name="line-8"></a><span class="cp">#define URL_HOST_CHARS URL_ALPHADIGIT &quot;.-[:]&quot; </span><span class="cm">/* IPv6 literals need [:] */</span><span class="cp"></span>
<a name="line-9"></a><span class="cp">#define URL_UNSAFE_CHARS &quot; &lt;&gt;\&quot;%{}|\\^`&quot; </span><span class="cm">/* plus 0x00-0x1F,0x7F-0xFF */</span><span class="cp"></span>
<a name="line-10"></a><span class="cp">#define URL_GEN_RESERVED &quot;:/?#[]@&quot;</span>
<a name="line-11"></a><span class="cp">#define URL_SUB_RESERVED &quot;!$&amp;&#39;()*+,;=&quot;</span>
<a name="line-12"></a><span class="cp">#define URL_RESERVED URL_GEN_RESERVED URL_SUB_RESERVED </span><span class="cm">/* only allowed delims */</span><span class="cp"></span>
<a name="line-13"></a>
<a name="line-14"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">append_normalized_escapes</span><span class="p">(</span><span class="k">struct</span> <span class="n">strbuf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
<a name="line-15"></a>				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span>
<a name="line-16"></a>				     <span class="kt">size_t</span> <span class="n">from_len</span><span class="p">,</span>
<a name="line-17"></a>				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">esc_extra</span><span class="p">,</span>
<a name="line-18"></a>				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">esc_ok</span><span class="p">)</span>
<a name="line-19"></a><span class="p">{</span>
<a name="line-20"></a>	<span class="cm">/*</span>
<a name="line-21"></a><span class="cm">	 * Append to strbuf &#39;buf&#39; characters from string &#39;from&#39; with length</span>
<a name="line-22"></a><span class="cm">	 * &#39;from_len&#39; while unescaping characters that do not need to be escaped</span>
<a name="line-23"></a><span class="cm">	 * and escaping characters that do.  The set of characters to escape</span>
<a name="line-24"></a><span class="cm">	 * (the complement of which is unescaped) starts out as the RFC 3986</span>
<a name="line-25"></a><span class="cm">	 * unsafe characters (0x00-0x1F,0x7F-0xFF,&quot; &lt;&gt;\&quot;#%{}|\\^`&quot;).  If</span>
<a name="line-26"></a><span class="cm">	 * &#39;esc_extra&#39; is not NULL, those additional characters will also always</span>
<a name="line-27"></a><span class="cm">	 * be escaped.  If &#39;esc_ok&#39; is not NULL, those characters will be left</span>
<a name="line-28"></a><span class="cm">	 * escaped if found that way, but will not be unescaped otherwise (used</span>
<a name="line-29"></a><span class="cm">	 * for delimiters).  If a %-escape sequence is encountered that is not</span>
<a name="line-30"></a><span class="cm">	 * followed by 2 hexadecimal digits, the sequence is invalid and</span>
<a name="line-31"></a><span class="cm">	 * false (0) will be returned.  Otherwise true (1) will be returned for</span>
<a name="line-32"></a><span class="cm">	 * success.</span>
<a name="line-33"></a><span class="cm">	 *</span>
<a name="line-34"></a><span class="cm">	 * Note that all %-escape sequences will be normalized to UPPERCASE</span>
<a name="line-35"></a><span class="cm">	 * as indicated in RFC 3986.  Unless included in esc_extra or esc_ok</span>
<a name="line-36"></a><span class="cm">	 * alphanumerics and &quot;-._~&quot; will always be unescaped as per RFC 3986.</span>
<a name="line-37"></a><span class="cm">	 */</span>
<a name="line-38"></a>
<a name="line-39"></a>	<span class="k">while</span> <span class="p">(</span><span class="n">from_len</span><span class="p">)</span> <span class="p">{</span>
<a name="line-40"></a>		<span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
<a name="line-41"></a>		<span class="kt">int</span> <span class="n">was_esc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-42"></a>
<a name="line-43"></a>		<span class="n">from_len</span><span class="o">--</span><span class="p">;</span>
<a name="line-44"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;%&#39;</span><span class="p">)</span> <span class="p">{</span>
<a name="line-45"></a>			<span class="k">if</span> <span class="p">(</span><span class="n">from_len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
<a name="line-46"></a>				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-47"></a>			<span class="n">ch</span> <span class="o">=</span> <span class="n">hex2chr</span><span class="p">(</span><span class="n">from</span><span class="p">);</span>
<a name="line-48"></a>			<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-49"></a>				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-50"></a>			<span class="n">from</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
<a name="line-51"></a>			<span class="n">from_len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
<a name="line-52"></a>			<span class="n">was_esc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="line-53"></a>		<span class="p">}</span>
<a name="line-54"></a>		<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">ch</span> <span class="o">&lt;=</span> <span class="mh">0x1F</span> <span class="o">||</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="mh">0x7F</span> <span class="o">||</span>
<a name="line-55"></a>		    <span class="n">strchr</span><span class="p">(</span><span class="n">URL_UNSAFE_CHARS</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span> <span class="o">||</span>
<a name="line-56"></a>		    <span class="p">(</span><span class="n">esc_extra</span> <span class="o">&amp;&amp;</span> <span class="n">strchr</span><span class="p">(</span><span class="n">esc_extra</span><span class="p">,</span> <span class="n">ch</span><span class="p">))</span> <span class="o">||</span>
<a name="line-57"></a>		    <span class="p">(</span><span class="n">was_esc</span> <span class="o">&amp;&amp;</span> <span class="n">strchr</span><span class="p">(</span><span class="n">esc_ok</span><span class="p">,</span> <span class="n">ch</span><span class="p">)))</span>
<a name="line-58"></a>			<span class="n">strbuf_addf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%%%02X&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">ch</span><span class="p">);</span>
<a name="line-59"></a>		<span class="k">else</span>
<a name="line-60"></a>			<span class="n">strbuf_addch</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
<a name="line-61"></a>	<span class="p">}</span>
<a name="line-62"></a>
<a name="line-63"></a>	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="line-64"></a><span class="p">}</span>
<a name="line-65"></a>
<a name="line-66"></a><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">end_of_token</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span>
<a name="line-67"></a><span class="p">{</span>
<a name="line-68"></a>	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">memchr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<a name="line-69"></a>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">next</span><span class="p">)</span>
<a name="line-70"></a>		<span class="n">next</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">n</span><span class="p">;</span>
<a name="line-71"></a>	<span class="k">return</span> <span class="n">next</span><span class="p">;</span>
<a name="line-72"></a><span class="p">}</span>
<a name="line-73"></a>
<a name="line-74"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">match_host</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">url_info</span> <span class="o">*</span><span class="n">url_info</span><span class="p">,</span>
<a name="line-75"></a>		      <span class="k">const</span> <span class="k">struct</span> <span class="n">url_info</span> <span class="o">*</span><span class="n">pattern_info</span><span class="p">)</span>
<a name="line-76"></a><span class="p">{</span>
<a name="line-77"></a>	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="n">url_info</span><span class="o">-&gt;</span><span class="n">url</span> <span class="o">+</span> <span class="n">url_info</span><span class="o">-&gt;</span><span class="n">host_off</span><span class="p">;</span>
<a name="line-78"></a>	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pat</span> <span class="o">=</span> <span class="n">pattern_info</span><span class="o">-&gt;</span><span class="n">url</span> <span class="o">+</span> <span class="n">pattern_info</span><span class="o">-&gt;</span><span class="n">host_off</span><span class="p">;</span>
<a name="line-79"></a>	<span class="kt">int</span> <span class="n">url_len</span> <span class="o">=</span> <span class="n">url_info</span><span class="o">-&gt;</span><span class="n">host_len</span><span class="p">;</span>
<a name="line-80"></a>	<span class="kt">int</span> <span class="n">pat_len</span> <span class="o">=</span> <span class="n">pattern_info</span><span class="o">-&gt;</span><span class="n">host_len</span><span class="p">;</span>
<a name="line-81"></a>
<a name="line-82"></a>	<span class="k">while</span> <span class="p">(</span><span class="n">url_len</span> <span class="o">&amp;&amp;</span> <span class="n">pat_len</span><span class="p">)</span> <span class="p">{</span>
<a name="line-83"></a>		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">url_next</span> <span class="o">=</span> <span class="n">end_of_token</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="sc">&#39;.&#39;</span><span class="p">,</span> <span class="n">url_len</span><span class="p">);</span>
<a name="line-84"></a>		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pat_next</span> <span class="o">=</span> <span class="n">end_of_token</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="sc">&#39;.&#39;</span><span class="p">,</span> <span class="n">pat_len</span><span class="p">);</span>
<a name="line-85"></a>
<a name="line-86"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">pat_next</span> <span class="o">==</span> <span class="n">pat</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">pat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span><span class="p">)</span>
<a name="line-87"></a>			<span class="cm">/* wildcard matches anything */</span>
<a name="line-88"></a>			<span class="p">;</span>
<a name="line-89"></a>		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">pat_next</span> <span class="o">-</span> <span class="n">pat</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">url_next</span> <span class="o">-</span> <span class="n">url</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="line-90"></a>			 <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">pat</span><span class="p">,</span> <span class="n">url_next</span> <span class="o">-</span> <span class="n">url</span><span class="p">))</span>
<a name="line-91"></a>			<span class="cm">/* the components are the same */</span>
<a name="line-92"></a>			<span class="p">;</span>
<a name="line-93"></a>		<span class="k">else</span>
<a name="line-94"></a>			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* found an unmatch */</span>
<a name="line-95"></a>
<a name="line-96"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">url_next</span> <span class="o">&lt;</span> <span class="n">url</span> <span class="o">+</span> <span class="n">url_len</span><span class="p">)</span>
<a name="line-97"></a>			<span class="n">url_next</span><span class="o">++</span><span class="p">;</span>
<a name="line-98"></a>		<span class="n">url_len</span> <span class="o">-=</span> <span class="n">url_next</span> <span class="o">-</span> <span class="n">url</span><span class="p">;</span>
<a name="line-99"></a>		<span class="n">url</span> <span class="o">=</span> <span class="n">url_next</span><span class="p">;</span>
<a name="line-100"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">pat_next</span> <span class="o">&lt;</span> <span class="n">pat</span> <span class="o">+</span> <span class="n">pat_len</span><span class="p">)</span>
<a name="line-101"></a>			<span class="n">pat_next</span><span class="o">++</span><span class="p">;</span>
<a name="line-102"></a>		<span class="n">pat_len</span> <span class="o">-=</span> <span class="n">pat_next</span> <span class="o">-</span> <span class="n">pat</span><span class="p">;</span>
<a name="line-103"></a>		<span class="n">pat</span> <span class="o">=</span> <span class="n">pat_next</span><span class="p">;</span>
<a name="line-104"></a>	<span class="p">}</span>
<a name="line-105"></a>
<a name="line-106"></a>	<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">url_len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pat_len</span><span class="p">);</span>
<a name="line-107"></a><span class="p">}</span>
<a name="line-108"></a>
<a name="line-109"></a><span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">url_normalize_1</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">url</span><span class="p">,</span> <span class="k">struct</span> <span class="n">url_info</span> <span class="o">*</span><span class="n">out_info</span><span class="p">,</span> <span class="kt">char</span> <span class="n">allow_globs</span><span class="p">)</span>
<a name="line-110"></a><span class="p">{</span>
<a name="line-111"></a>	<span class="cm">/*</span>
<a name="line-112"></a><span class="cm">	 * Normalize NUL-terminated url using the following rules:</span>
<a name="line-113"></a><span class="cm">	 *</span>
<a name="line-114"></a><span class="cm">	 * 1. Case-insensitive parts of url will be converted to lower case</span>
<a name="line-115"></a><span class="cm">	 * 2. %-encoded characters that do not need to be will be unencoded</span>
<a name="line-116"></a><span class="cm">	 * 3. Characters that are not %-encoded and must be will be encoded</span>
<a name="line-117"></a><span class="cm">	 * 4. All %-encodings will be converted to upper case hexadecimal</span>
<a name="line-118"></a><span class="cm">	 * 5. Leading 0s are removed from port numbers</span>
<a name="line-119"></a><span class="cm">	 * 6. If the default port for the scheme is given it will be removed</span>
<a name="line-120"></a><span class="cm">	 * 7. A path part (including empty) not starting with &#39;/&#39; has one added</span>
<a name="line-121"></a><span class="cm">	 * 8. Any dot segments (. or ..) in the path are resolved and removed</span>
<a name="line-122"></a><span class="cm">	 * 9. IPv6 host literals are allowed (but not normalized or validated)</span>
<a name="line-123"></a><span class="cm">	 *</span>
<a name="line-124"></a><span class="cm">	 * The rules are based on information in RFC 3986.</span>
<a name="line-125"></a><span class="cm">	 *</span>
<a name="line-126"></a><span class="cm">	 * Please note this function requires a full URL including a scheme</span>
<a name="line-127"></a><span class="cm">	 * and host part (except for file: URLs which may have an empty host).</span>
<a name="line-128"></a><span class="cm">	 *</span>
<a name="line-129"></a><span class="cm">	 * The return value is a newly allocated string that must be freed</span>
<a name="line-130"></a><span class="cm">	 * or NULL if the url is not valid.</span>
<a name="line-131"></a><span class="cm">	 *</span>
<a name="line-132"></a><span class="cm">	 * If out_info is non-NULL, the url and err fields therein will always</span>
<a name="line-133"></a><span class="cm">	 * be set.  If a non-NULL value is returned, it will be stored in</span>
<a name="line-134"></a><span class="cm">	 * out_info-&gt;url as well, out_info-&gt;err will be set to NULL and the</span>
<a name="line-135"></a><span class="cm">	 * other fields of *out_info will also be filled in.  If a NULL value</span>
<a name="line-136"></a><span class="cm">	 * is returned, NULL will be stored in out_info-&gt;url and out_info-&gt;err</span>
<a name="line-137"></a><span class="cm">	 * will be set to a brief, translated, error message, but no other</span>
<a name="line-138"></a><span class="cm">	 * fields will be filled in.</span>
<a name="line-139"></a><span class="cm">	 *</span>
<a name="line-140"></a><span class="cm">	 * This is NOT a URL validation function.  Full URL validation is NOT</span>
<a name="line-141"></a><span class="cm">	 * performed.  Some invalid host names are passed through this function</span>
<a name="line-142"></a><span class="cm">	 * undetected.  However, most all other problems that make a URL invalid</span>
<a name="line-143"></a><span class="cm">	 * will be detected (including a missing host for non file: URLs).</span>
<a name="line-144"></a><span class="cm">	 */</span>
<a name="line-145"></a>
<a name="line-146"></a>	<span class="kt">size_t</span> <span class="n">url_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
<a name="line-147"></a>	<span class="k">struct</span> <span class="n">strbuf</span> <span class="n">norm</span><span class="p">;</span>
<a name="line-148"></a>	<span class="kt">size_t</span> <span class="n">spanned</span><span class="p">;</span>
<a name="line-149"></a>	<span class="kt">size_t</span> <span class="n">scheme_len</span><span class="p">,</span> <span class="n">user_off</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">user_len</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">passwd_off</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">passwd_len</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<a name="line-150"></a>	<span class="kt">size_t</span> <span class="n">host_off</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">host_len</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">port_off</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">port_len</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">path_off</span><span class="p">,</span> <span class="n">path_len</span><span class="p">,</span> <span class="n">result_len</span><span class="p">;</span>
<a name="line-151"></a>	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">slash_ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">at_ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">colon_ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">path_start</span><span class="p">;</span>
<a name="line-152"></a>	<span class="kt">char</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
<a name="line-153"></a>
<a name="line-154"></a>	<span class="cm">/*</span>
<a name="line-155"></a><span class="cm">	 * Copy lowercased scheme and :// suffix, %-escapes are not allowed</span>
<a name="line-156"></a><span class="cm">	 * First character of scheme must be URL_ALPHA</span>
<a name="line-157"></a><span class="cm">	 */</span>
<a name="line-158"></a>	<span class="n">spanned</span> <span class="o">=</span> <span class="n">strspn</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">URL_SCHEME_CHARS</span><span class="p">);</span>
<a name="line-159"></a>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spanned</span> <span class="o">||</span> <span class="o">!</span><span class="n">isalpha</span><span class="p">(</span><span class="n">url</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">||</span> <span class="n">spanned</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">&gt;</span> <span class="n">url_len</span> <span class="o">||</span>
<a name="line-160"></a>	    <span class="n">url</span><span class="p">[</span><span class="n">spanned</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span> <span class="o">||</span> <span class="n">url</span><span class="p">[</span><span class="n">spanned</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span> <span class="o">||</span> <span class="n">url</span><span class="p">[</span><span class="n">spanned</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
<a name="line-161"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">out_info</span><span class="p">)</span> <span class="p">{</span>
<a name="line-162"></a>			<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">url</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-163"></a>			<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;invalid URL scheme name or missing &#39;://&#39; suffix&quot;</span><span class="p">);</span>
<a name="line-164"></a>		<span class="p">}</span>
<a name="line-165"></a>		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* Bad scheme and/or missing &quot;://&quot; part */</span>
<a name="line-166"></a>	<span class="p">}</span>
<a name="line-167"></a>	<span class="n">strbuf_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">,</span> <span class="n">url_len</span><span class="p">);</span>
<a name="line-168"></a>	<span class="n">scheme_len</span> <span class="o">=</span> <span class="n">spanned</span><span class="p">;</span>
<a name="line-169"></a>	<span class="n">spanned</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
<a name="line-170"></a>	<span class="n">url_len</span> <span class="o">-=</span> <span class="n">spanned</span><span class="p">;</span>
<a name="line-171"></a>	<span class="k">while</span> <span class="p">(</span><span class="n">spanned</span><span class="o">--</span><span class="p">)</span>
<a name="line-172"></a>		<span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">,</span> <span class="n">tolower</span><span class="p">(</span><span class="o">*</span><span class="n">url</span><span class="o">++</span><span class="p">));</span>
<a name="line-173"></a>
<a name="line-174"></a>
<a name="line-175"></a>	<span class="cm">/*</span>
<a name="line-176"></a><span class="cm">	 * Copy any username:password if present normalizing %-escapes</span>
<a name="line-177"></a><span class="cm">	 */</span>
<a name="line-178"></a>	<span class="n">at_ptr</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="sc">&#39;@&#39;</span><span class="p">);</span>
<a name="line-179"></a>	<span class="n">slash_ptr</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="n">strcspn</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s">&quot;/?#&quot;</span><span class="p">);</span>
<a name="line-180"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">at_ptr</span> <span class="o">&amp;&amp;</span> <span class="n">at_ptr</span> <span class="o">&lt;</span> <span class="n">slash_ptr</span><span class="p">)</span> <span class="p">{</span>
<a name="line-181"></a>		<span class="n">user_off</span> <span class="o">=</span> <span class="n">norm</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
<a name="line-182"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">at_ptr</span> <span class="o">&gt;</span> <span class="n">url</span><span class="p">)</span> <span class="p">{</span>
<a name="line-183"></a>			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">append_normalized_escapes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">at_ptr</span> <span class="o">-</span> <span class="n">url</span><span class="p">,</span>
<a name="line-184"></a>						       <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">URL_RESERVED</span><span class="p">))</span> <span class="p">{</span>
<a name="line-185"></a>				<span class="k">if</span> <span class="p">(</span><span class="n">out_info</span><span class="p">)</span> <span class="p">{</span>
<a name="line-186"></a>					<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">url</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-187"></a>					<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;invalid %XX escape sequence&quot;</span><span class="p">);</span>
<a name="line-188"></a>				<span class="p">}</span>
<a name="line-189"></a>				<span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">);</span>
<a name="line-190"></a>				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-191"></a>			<span class="p">}</span>
<a name="line-192"></a>			<span class="n">colon_ptr</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">norm</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">scheme_len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
<a name="line-193"></a>			<span class="k">if</span> <span class="p">(</span><span class="n">colon_ptr</span><span class="p">)</span> <span class="p">{</span>
<a name="line-194"></a>				<span class="n">passwd_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">colon_ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">norm</span><span class="p">.</span><span class="n">buf</span><span class="p">;</span>
<a name="line-195"></a>				<span class="n">passwd_len</span> <span class="o">=</span> <span class="n">norm</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">passwd_off</span><span class="p">;</span>
<a name="line-196"></a>				<span class="n">user_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">passwd_off</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">scheme_len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
<a name="line-197"></a>			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="line-198"></a>				<span class="n">user_len</span> <span class="o">=</span> <span class="n">norm</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="p">(</span><span class="n">scheme_len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
<a name="line-199"></a>			<span class="p">}</span>
<a name="line-200"></a>		<span class="p">}</span>
<a name="line-201"></a>		<span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">,</span> <span class="sc">&#39;@&#39;</span><span class="p">);</span>
<a name="line-202"></a>		<span class="n">url_len</span> <span class="o">-=</span> <span class="p">(</span><span class="o">++</span><span class="n">at_ptr</span> <span class="o">-</span> <span class="n">url</span><span class="p">);</span>
<a name="line-203"></a>		<span class="n">url</span> <span class="o">=</span> <span class="n">at_ptr</span><span class="p">;</span>
<a name="line-204"></a>	<span class="p">}</span>
<a name="line-205"></a>
<a name="line-206"></a>
<a name="line-207"></a>	<span class="cm">/*</span>
<a name="line-208"></a><span class="cm">	 * Copy the host part excluding any port part, no %-escapes allowed</span>
<a name="line-209"></a><span class="cm">	 */</span>
<a name="line-210"></a>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">url_len</span> <span class="o">||</span> <span class="n">strchr</span><span class="p">(</span><span class="s">&quot;:/?#&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">url</span><span class="p">))</span> <span class="p">{</span>
<a name="line-211"></a>		<span class="cm">/* Missing host invalid for all URL schemes except file */</span>
<a name="line-212"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">norm</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;file:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
<a name="line-213"></a>			<span class="k">if</span> <span class="p">(</span><span class="n">out_info</span><span class="p">)</span> <span class="p">{</span>
<a name="line-214"></a>				<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">url</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-215"></a>				<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;missing host and scheme is not &#39;file:&#39;&quot;</span><span class="p">);</span>
<a name="line-216"></a>			<span class="p">}</span>
<a name="line-217"></a>			<span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">);</span>
<a name="line-218"></a>			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-219"></a>		<span class="p">}</span>
<a name="line-220"></a>	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="line-221"></a>		<span class="n">host_off</span> <span class="o">=</span> <span class="n">norm</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
<a name="line-222"></a>	<span class="p">}</span>
<a name="line-223"></a>	<span class="n">colon_ptr</span> <span class="o">=</span> <span class="n">slash_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="line-224"></a>	<span class="k">while</span> <span class="p">(</span><span class="n">colon_ptr</span> <span class="o">&gt;</span> <span class="n">url</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">colon_ptr</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">colon_ptr</span> <span class="o">!=</span> <span class="sc">&#39;]&#39;</span><span class="p">)</span>
<a name="line-225"></a>		<span class="n">colon_ptr</span><span class="o">--</span><span class="p">;</span>
<a name="line-226"></a>	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">colon_ptr</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="p">{</span>
<a name="line-227"></a>		<span class="n">colon_ptr</span> <span class="o">=</span> <span class="n">slash_ptr</span><span class="p">;</span>
<a name="line-228"></a>	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host_off</span> <span class="o">&amp;&amp;</span> <span class="n">colon_ptr</span> <span class="o">&lt;</span> <span class="n">slash_ptr</span> <span class="o">&amp;&amp;</span> <span class="n">colon_ptr</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">!=</span> <span class="n">slash_ptr</span><span class="p">)</span> <span class="p">{</span>
<a name="line-229"></a>		<span class="cm">/* file: URLs may not have a port number */</span>
<a name="line-230"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">out_info</span><span class="p">)</span> <span class="p">{</span>
<a name="line-231"></a>			<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">url</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-232"></a>			<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;a &#39;file:&#39; URL may not have a port number&quot;</span><span class="p">);</span>
<a name="line-233"></a>		<span class="p">}</span>
<a name="line-234"></a>		<span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">);</span>
<a name="line-235"></a>		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-236"></a>	<span class="p">}</span>
<a name="line-237"></a>
<a name="line-238"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">allow_globs</span><span class="p">)</span>
<a name="line-239"></a>		<span class="n">spanned</span> <span class="o">=</span> <span class="n">strspn</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">URL_HOST_CHARS</span> <span class="s">&quot;*&quot;</span><span class="p">);</span>
<a name="line-240"></a>	<span class="k">else</span>
<a name="line-241"></a>		<span class="n">spanned</span> <span class="o">=</span> <span class="n">strspn</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">URL_HOST_CHARS</span><span class="p">);</span>
<a name="line-242"></a>
<a name="line-243"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">spanned</span> <span class="o">&lt;</span> <span class="n">colon_ptr</span> <span class="o">-</span> <span class="n">url</span><span class="p">)</span> <span class="p">{</span>
<a name="line-244"></a>		<span class="cm">/* Host name has invalid characters */</span>
<a name="line-245"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">out_info</span><span class="p">)</span> <span class="p">{</span>
<a name="line-246"></a>			<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">url</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-247"></a>			<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;invalid characters in host name&quot;</span><span class="p">);</span>
<a name="line-248"></a>		<span class="p">}</span>
<a name="line-249"></a>		<span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">);</span>
<a name="line-250"></a>		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-251"></a>	<span class="p">}</span>
<a name="line-252"></a>	<span class="k">while</span> <span class="p">(</span><span class="n">url</span> <span class="o">&lt;</span> <span class="n">colon_ptr</span><span class="p">)</span> <span class="p">{</span>
<a name="line-253"></a>		<span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">,</span> <span class="n">tolower</span><span class="p">(</span><span class="o">*</span><span class="n">url</span><span class="o">++</span><span class="p">));</span>
<a name="line-254"></a>		<span class="n">url_len</span><span class="o">--</span><span class="p">;</span>
<a name="line-255"></a>	<span class="p">}</span>
<a name="line-256"></a>
<a name="line-257"></a>
<a name="line-258"></a>	<span class="cm">/*</span>
<a name="line-259"></a><span class="cm">	 * Check the port part and copy if not the default (after removing any</span>
<a name="line-260"></a><span class="cm">	 * leading 0s); no %-escapes allowed</span>
<a name="line-261"></a><span class="cm">	 */</span>
<a name="line-262"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">colon_ptr</span> <span class="o">&lt;</span> <span class="n">slash_ptr</span><span class="p">)</span> <span class="p">{</span>
<a name="line-263"></a>		<span class="cm">/* skip the &#39;:&#39; and leading 0s but not the last one if all 0s */</span>
<a name="line-264"></a>		<span class="n">url</span><span class="o">++</span><span class="p">;</span>
<a name="line-265"></a>		<span class="n">url</span> <span class="o">+=</span> <span class="n">strspn</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">);</span>
<a name="line-266"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">url</span> <span class="o">==</span> <span class="n">slash_ptr</span> <span class="o">&amp;&amp;</span> <span class="n">url</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span>
<a name="line-267"></a>			<span class="n">url</span><span class="o">--</span><span class="p">;</span>
<a name="line-268"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">url</span> <span class="o">==</span> <span class="n">slash_ptr</span><span class="p">)</span> <span class="p">{</span>
<a name="line-269"></a>			<span class="cm">/* Skip &quot;:&quot; port with no number, it&#39;s same as default */</span>
<a name="line-270"></a>		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">slash_ptr</span> <span class="o">-</span> <span class="n">url</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span>
<a name="line-271"></a>			   <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">norm</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;http:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="line-272"></a>			   <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s">&quot;80&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
<a name="line-273"></a>			<span class="cm">/* Skip http :80 as it&#39;s the default */</span>
<a name="line-274"></a>		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">slash_ptr</span> <span class="o">-</span> <span class="n">url</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
<a name="line-275"></a>			   <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">norm</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;https:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<a name="line-276"></a>			   <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s">&quot;443&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
<a name="line-277"></a>			<span class="cm">/* Skip https :443 as it&#39;s the default */</span>
<a name="line-278"></a>		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="line-279"></a>			<span class="cm">/*</span>
<a name="line-280"></a><span class="cm">			 * Port number must be all digits with leading 0s removed</span>
<a name="line-281"></a><span class="cm">			 * and since all the protocols we deal with have a 16-bit</span>
<a name="line-282"></a><span class="cm">			 * port number it must also be in the range 1..65535</span>
<a name="line-283"></a><span class="cm">			 * 0 is not allowed because that means &quot;next available&quot;</span>
<a name="line-284"></a><span class="cm">			 * on just about every system and therefore cannot be used</span>
<a name="line-285"></a><span class="cm">			 */</span>
<a name="line-286"></a>			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-287"></a>			<span class="n">spanned</span> <span class="o">=</span> <span class="n">strspn</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">URL_DIGIT</span><span class="p">);</span>
<a name="line-288"></a>			<span class="k">if</span> <span class="p">(</span><span class="n">spanned</span> <span class="o">&lt;</span> <span class="n">slash_ptr</span> <span class="o">-</span> <span class="n">url</span><span class="p">)</span> <span class="p">{</span>
<a name="line-289"></a>				<span class="cm">/* port number has invalid characters */</span>
<a name="line-290"></a>				<span class="k">if</span> <span class="p">(</span><span class="n">out_info</span><span class="p">)</span> <span class="p">{</span>
<a name="line-291"></a>					<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">url</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-292"></a>					<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;invalid port number&quot;</span><span class="p">);</span>
<a name="line-293"></a>				<span class="p">}</span>
<a name="line-294"></a>				<span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">);</span>
<a name="line-295"></a>				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-296"></a>			<span class="p">}</span>
<a name="line-297"></a>			<span class="k">if</span> <span class="p">(</span><span class="n">slash_ptr</span> <span class="o">-</span> <span class="n">url</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span>
<a name="line-298"></a>				<span class="n">pnum</span> <span class="o">=</span> <span class="n">strtoul</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<a name="line-299"></a>			<span class="k">if</span> <span class="p">(</span><span class="n">pnum</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pnum</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">)</span> <span class="p">{</span>
<a name="line-300"></a>				<span class="cm">/* port number not in range 1..65535 */</span>
<a name="line-301"></a>				<span class="k">if</span> <span class="p">(</span><span class="n">out_info</span><span class="p">)</span> <span class="p">{</span>
<a name="line-302"></a>					<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">url</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-303"></a>					<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;invalid port number&quot;</span><span class="p">);</span>
<a name="line-304"></a>				<span class="p">}</span>
<a name="line-305"></a>				<span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">);</span>
<a name="line-306"></a>				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-307"></a>			<span class="p">}</span>
<a name="line-308"></a>			<span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
<a name="line-309"></a>			<span class="n">port_off</span> <span class="o">=</span> <span class="n">norm</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
<a name="line-310"></a>			<span class="n">strbuf_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">slash_ptr</span> <span class="o">-</span> <span class="n">url</span><span class="p">);</span>
<a name="line-311"></a>			<span class="n">port_len</span> <span class="o">=</span> <span class="n">slash_ptr</span> <span class="o">-</span> <span class="n">url</span><span class="p">;</span>
<a name="line-312"></a>		<span class="p">}</span>
<a name="line-313"></a>		<span class="n">url_len</span> <span class="o">-=</span> <span class="n">slash_ptr</span> <span class="o">-</span> <span class="n">colon_ptr</span><span class="p">;</span>
<a name="line-314"></a>		<span class="n">url</span> <span class="o">=</span> <span class="n">slash_ptr</span><span class="p">;</span>
<a name="line-315"></a>	<span class="p">}</span>
<a name="line-316"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">host_off</span><span class="p">)</span>
<a name="line-317"></a>		<span class="n">host_len</span> <span class="o">=</span> <span class="n">norm</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">host_off</span> <span class="o">-</span> <span class="p">(</span><span class="n">port_len</span> <span class="o">?</span> <span class="n">port_len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<a name="line-318"></a>
<a name="line-319"></a>
<a name="line-320"></a>	<span class="cm">/*</span>
<a name="line-321"></a><span class="cm">	 * Now copy the path resolving any . and .. segments being careful not</span>
<a name="line-322"></a><span class="cm">	 * to corrupt the URL by unescaping any delimiters, but do add an</span>
<a name="line-323"></a><span class="cm">	 * initial &#39;/&#39; if it&#39;s missing and do normalize any %-escape sequences.</span>
<a name="line-324"></a><span class="cm">	 */</span>
<a name="line-325"></a>	<span class="n">path_off</span> <span class="o">=</span> <span class="n">norm</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
<a name="line-326"></a>	<span class="n">path_start</span> <span class="o">=</span> <span class="n">norm</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">path_off</span><span class="p">;</span>
<a name="line-327"></a>	<span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">);</span>
<a name="line-328"></a>	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">url</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
<a name="line-329"></a>		<span class="n">url</span><span class="o">++</span><span class="p">;</span>
<a name="line-330"></a>		<span class="n">url_len</span><span class="o">--</span><span class="p">;</span>
<a name="line-331"></a>	<span class="p">}</span>
<a name="line-332"></a>	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
<a name="line-333"></a>		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">seg_start</span><span class="p">;</span>
<a name="line-334"></a>		<span class="kt">size_t</span> <span class="n">seg_start_off</span> <span class="o">=</span> <span class="n">norm</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
<a name="line-335"></a>		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">next_slash</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="n">strcspn</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s">&quot;/?#&quot;</span><span class="p">);</span>
<a name="line-336"></a>		<span class="kt">int</span> <span class="n">skip_add_slash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-337"></a>
<a name="line-338"></a>		<span class="cm">/*</span>
<a name="line-339"></a><span class="cm">		 * RFC 3689 indicates that any . or .. segments should be</span>
<a name="line-340"></a><span class="cm">		 * unescaped before being checked for.</span>
<a name="line-341"></a><span class="cm">		 */</span>
<a name="line-342"></a>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">append_normalized_escapes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">next_slash</span> <span class="o">-</span> <span class="n">url</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
<a name="line-343"></a>					       <span class="n">URL_RESERVED</span><span class="p">))</span> <span class="p">{</span>
<a name="line-344"></a>			<span class="k">if</span> <span class="p">(</span><span class="n">out_info</span><span class="p">)</span> <span class="p">{</span>
<a name="line-345"></a>				<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">url</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-346"></a>				<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;invalid %XX escape sequence&quot;</span><span class="p">);</span>
<a name="line-347"></a>			<span class="p">}</span>
<a name="line-348"></a>			<span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">);</span>
<a name="line-349"></a>			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-350"></a>		<span class="p">}</span>
<a name="line-351"></a>
<a name="line-352"></a>		<span class="n">seg_start</span> <span class="o">=</span> <span class="n">norm</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">seg_start_off</span><span class="p">;</span>
<a name="line-353"></a>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">seg_start</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">))</span> <span class="p">{</span>
<a name="line-354"></a>			<span class="cm">/* ignore a . segment; be careful not to remove initial &#39;/&#39; */</span>
<a name="line-355"></a>			<span class="k">if</span> <span class="p">(</span><span class="n">seg_start</span> <span class="o">==</span> <span class="n">path_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="line-356"></a>				<span class="n">strbuf_setlen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">,</span> <span class="n">norm</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<a name="line-357"></a>				<span class="n">skip_add_slash</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="line-358"></a>			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="line-359"></a>				<span class="n">strbuf_setlen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">,</span> <span class="n">norm</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
<a name="line-360"></a>			<span class="p">}</span>
<a name="line-361"></a>		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">seg_start</span><span class="p">,</span> <span class="s">&quot;..&quot;</span><span class="p">))</span> <span class="p">{</span>
<a name="line-362"></a>			<span class="cm">/*</span>
<a name="line-363"></a><span class="cm">			 * ignore a .. segment and remove the previous segment;</span>
<a name="line-364"></a><span class="cm">			 * be careful not to remove initial &#39;/&#39; from path</span>
<a name="line-365"></a><span class="cm">			 */</span>
<a name="line-366"></a>			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prev_slash</span> <span class="o">=</span> <span class="n">norm</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">norm</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
<a name="line-367"></a>			<span class="k">if</span> <span class="p">(</span><span class="n">prev_slash</span> <span class="o">==</span> <span class="n">path_start</span><span class="p">)</span> <span class="p">{</span>
<a name="line-368"></a>				<span class="cm">/* invalid .. because no previous segment to remove */</span>
<a name="line-369"></a>				<span class="k">if</span> <span class="p">(</span><span class="n">out_info</span><span class="p">)</span> <span class="p">{</span>
<a name="line-370"></a>					<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">url</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-371"></a>					<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;invalid &#39;..&#39; path segment&quot;</span><span class="p">);</span>
<a name="line-372"></a>				<span class="p">}</span>
<a name="line-373"></a>				<span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">);</span>
<a name="line-374"></a>				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-375"></a>			<span class="p">}</span>
<a name="line-376"></a>			<span class="k">while</span> <span class="p">(</span><span class="o">*--</span><span class="n">prev_slash</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="p">{}</span>
<a name="line-377"></a>			<span class="k">if</span> <span class="p">(</span><span class="n">prev_slash</span> <span class="o">==</span> <span class="n">path_start</span><span class="p">)</span> <span class="p">{</span>
<a name="line-378"></a>				<span class="n">strbuf_setlen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">,</span> <span class="n">prev_slash</span> <span class="o">-</span> <span class="n">norm</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="line-379"></a>				<span class="n">skip_add_slash</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="line-380"></a>			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="line-381"></a>				<span class="n">strbuf_setlen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">,</span> <span class="n">prev_slash</span> <span class="o">-</span> <span class="n">norm</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
<a name="line-382"></a>			<span class="p">}</span>
<a name="line-383"></a>		<span class="p">}</span>
<a name="line-384"></a>		<span class="n">url_len</span> <span class="o">-=</span> <span class="n">next_slash</span> <span class="o">-</span> <span class="n">url</span><span class="p">;</span>
<a name="line-385"></a>		<span class="n">url</span> <span class="o">=</span> <span class="n">next_slash</span><span class="p">;</span>
<a name="line-386"></a>		<span class="cm">/* if the next char is not &#39;/&#39; done with the path */</span>
<a name="line-387"></a>		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">url</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span>
<a name="line-388"></a>			<span class="k">break</span><span class="p">;</span>
<a name="line-389"></a>		<span class="n">url</span><span class="o">++</span><span class="p">;</span>
<a name="line-390"></a>		<span class="n">url_len</span><span class="o">--</span><span class="p">;</span>
<a name="line-391"></a>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skip_add_slash</span><span class="p">)</span>
<a name="line-392"></a>			<span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">);</span>
<a name="line-393"></a>	<span class="p">}</span>
<a name="line-394"></a>	<span class="n">path_len</span> <span class="o">=</span> <span class="n">norm</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">path_off</span><span class="p">;</span>
<a name="line-395"></a>
<a name="line-396"></a>
<a name="line-397"></a>	<span class="cm">/*</span>
<a name="line-398"></a><span class="cm">	 * Now simply copy the rest, if any, only normalizing %-escapes and</span>
<a name="line-399"></a><span class="cm">	 * being careful not to corrupt the URL by unescaping any delimiters.</span>
<a name="line-400"></a><span class="cm">	 */</span>
<a name="line-401"></a>	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">url</span><span class="p">)</span> <span class="p">{</span>
<a name="line-402"></a>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">append_normalized_escapes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">url_len</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">URL_RESERVED</span><span class="p">))</span> <span class="p">{</span>
<a name="line-403"></a>			<span class="k">if</span> <span class="p">(</span><span class="n">out_info</span><span class="p">)</span> <span class="p">{</span>
<a name="line-404"></a>				<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">url</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-405"></a>				<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;invalid %XX escape sequence&quot;</span><span class="p">);</span>
<a name="line-406"></a>			<span class="p">}</span>
<a name="line-407"></a>			<span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">);</span>
<a name="line-408"></a>			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-409"></a>		<span class="p">}</span>
<a name="line-410"></a>	<span class="p">}</span>
<a name="line-411"></a>
<a name="line-412"></a>
<a name="line-413"></a>	<span class="n">result</span> <span class="o">=</span> <span class="n">strbuf_detach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">norm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result_len</span><span class="p">);</span>
<a name="line-414"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">out_info</span><span class="p">)</span> <span class="p">{</span>
<a name="line-415"></a>		<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">url</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
<a name="line-416"></a>		<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-417"></a>		<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">url_len</span> <span class="o">=</span> <span class="n">result_len</span><span class="p">;</span>
<a name="line-418"></a>		<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">scheme_len</span> <span class="o">=</span> <span class="n">scheme_len</span><span class="p">;</span>
<a name="line-419"></a>		<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">user_off</span> <span class="o">=</span> <span class="n">user_off</span><span class="p">;</span>
<a name="line-420"></a>		<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">user_len</span> <span class="o">=</span> <span class="n">user_len</span><span class="p">;</span>
<a name="line-421"></a>		<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">passwd_off</span> <span class="o">=</span> <span class="n">passwd_off</span><span class="p">;</span>
<a name="line-422"></a>		<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">passwd_len</span> <span class="o">=</span> <span class="n">passwd_len</span><span class="p">;</span>
<a name="line-423"></a>		<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">host_off</span> <span class="o">=</span> <span class="n">host_off</span><span class="p">;</span>
<a name="line-424"></a>		<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">host_len</span> <span class="o">=</span> <span class="n">host_len</span><span class="p">;</span>
<a name="line-425"></a>		<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">port_off</span> <span class="o">=</span> <span class="n">port_off</span><span class="p">;</span>
<a name="line-426"></a>		<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">port_len</span> <span class="o">=</span> <span class="n">port_len</span><span class="p">;</span>
<a name="line-427"></a>		<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">path_off</span> <span class="o">=</span> <span class="n">path_off</span><span class="p">;</span>
<a name="line-428"></a>		<span class="n">out_info</span><span class="o">-&gt;</span><span class="n">path_len</span> <span class="o">=</span> <span class="n">path_len</span><span class="p">;</span>
<a name="line-429"></a>	<span class="p">}</span>
<a name="line-430"></a>	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<a name="line-431"></a><span class="p">}</span>
<a name="line-432"></a>
<a name="line-433"></a><span class="kt">char</span> <span class="o">*</span><span class="nf">url_normalize</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">url</span><span class="p">,</span> <span class="k">struct</span> <span class="n">url_info</span> <span class="o">*</span><span class="n">out_info</span><span class="p">)</span>
<a name="line-434"></a><span class="p">{</span>
<a name="line-435"></a>	<span class="k">return</span> <span class="n">url_normalize_1</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">out_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="line-436"></a><span class="p">}</span>
<a name="line-437"></a>
<a name="line-438"></a><span class="k">static</span> <span class="kt">size_t</span> <span class="nf">url_match_prefix</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">url</span><span class="p">,</span>
<a name="line-439"></a>			       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">url_prefix</span><span class="p">,</span>
<a name="line-440"></a>			       <span class="kt">size_t</span> <span class="n">url_prefix_len</span><span class="p">)</span>
<a name="line-441"></a><span class="p">{</span>
<a name="line-442"></a>	<span class="cm">/*</span>
<a name="line-443"></a><span class="cm">	 * url_prefix matches url if url_prefix is an exact match for url or it</span>
<a name="line-444"></a><span class="cm">	 * is a prefix of url and the match ends on a path component boundary.</span>
<a name="line-445"></a><span class="cm">	 * Both url and url_prefix are considered to have an implicit &#39;/&#39; on the</span>
<a name="line-446"></a><span class="cm">	 * end for matching purposes if they do not already.</span>
<a name="line-447"></a><span class="cm">	 *</span>
<a name="line-448"></a><span class="cm">	 * url must be NUL terminated.  url_prefix_len is the length of</span>
<a name="line-449"></a><span class="cm">	 * url_prefix which need not be NUL terminated.</span>
<a name="line-450"></a><span class="cm">	 *</span>
<a name="line-451"></a><span class="cm">	 * The return value is the length of the match in characters (including</span>
<a name="line-452"></a><span class="cm">	 * the final &#39;/&#39; even if it&#39;s implicit) or 0 for no match.</span>
<a name="line-453"></a><span class="cm">	 *</span>
<a name="line-454"></a><span class="cm">	 * Passing NULL as url and/or url_prefix will always cause 0 to be</span>
<a name="line-455"></a><span class="cm">	 * returned without causing any faults.</span>
<a name="line-456"></a><span class="cm">	 */</span>
<a name="line-457"></a>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">url</span> <span class="o">||</span> <span class="o">!</span><span class="n">url_prefix</span><span class="p">)</span>
<a name="line-458"></a>		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-459"></a>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">url_prefix_len</span> <span class="o">||</span> <span class="p">(</span><span class="n">url_prefix_len</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">url_prefix</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">))</span>
<a name="line-460"></a>		<span class="k">return</span> <span class="p">(</span><span class="o">!*</span><span class="n">url</span> <span class="o">||</span> <span class="o">*</span><span class="n">url</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-461"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">url_prefix</span><span class="p">[</span><span class="n">url_prefix_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span>
<a name="line-462"></a>		<span class="n">url_prefix_len</span><span class="o">--</span><span class="p">;</span>
<a name="line-463"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">url_prefix</span><span class="p">,</span> <span class="n">url_prefix_len</span><span class="p">))</span>
<a name="line-464"></a>		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-465"></a>	<span class="k">if</span> <span class="p">((</span><span class="n">strlen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="o">==</span> <span class="n">url_prefix_len</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">url</span><span class="p">[</span><span class="n">url_prefix_len</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">))</span>
<a name="line-466"></a>		<span class="k">return</span> <span class="n">url_prefix_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="line-467"></a>	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-468"></a><span class="p">}</span>
<a name="line-469"></a>
<a name="line-470"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">match_urls</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">url_info</span> <span class="o">*</span><span class="n">url</span><span class="p">,</span>
<a name="line-471"></a>		      <span class="k">const</span> <span class="k">struct</span> <span class="n">url_info</span> <span class="o">*</span><span class="n">url_prefix</span><span class="p">,</span>
<a name="line-472"></a>		      <span class="k">struct</span> <span class="n">urlmatch_item</span> <span class="o">*</span><span class="n">match</span><span class="p">)</span>
<a name="line-473"></a><span class="p">{</span>
<a name="line-474"></a>	<span class="cm">/*</span>
<a name="line-475"></a><span class="cm">	 * url_prefix matches url if the scheme, host and port of url_prefix</span>
<a name="line-476"></a><span class="cm">	 * are the same as those of url and the path portion of url_prefix</span>
<a name="line-477"></a><span class="cm">	 * is the same as the path portion of url or it is a prefix that</span>
<a name="line-478"></a><span class="cm">	 * matches at a &#39;/&#39; boundary.  If url_prefix contains a user name,</span>
<a name="line-479"></a><span class="cm">	 * that must also exactly match the user name in url.</span>
<a name="line-480"></a><span class="cm">	 *</span>
<a name="line-481"></a><span class="cm">	 * If the user, host, port and path match in this fashion, the returned</span>
<a name="line-482"></a><span class="cm">	 * value is the length of the path match including any implicit</span>
<a name="line-483"></a><span class="cm">	 * final &#39;/&#39;.  For example, &quot;http://me@example.com/path&quot; is matched by</span>
<a name="line-484"></a><span class="cm">	 * &quot;http://example.com&quot; with a path length of 1.</span>
<a name="line-485"></a><span class="cm">	 *</span>
<a name="line-486"></a><span class="cm">	 * If there is a match and exactusermatch is not NULL, then</span>
<a name="line-487"></a><span class="cm">	 * *exactusermatch will be set to true if both url and url_prefix</span>
<a name="line-488"></a><span class="cm">	 * contained a user name or false if url_prefix did not have a</span>
<a name="line-489"></a><span class="cm">	 * user name.  If there is no match *exactusermatch is left untouched.</span>
<a name="line-490"></a><span class="cm">	 */</span>
<a name="line-491"></a>	<span class="kt">char</span> <span class="n">usermatched</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-492"></a>	<span class="kt">size_t</span> <span class="n">pathmatchlen</span><span class="p">;</span>
<a name="line-493"></a>
<a name="line-494"></a>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">url</span> <span class="o">||</span> <span class="o">!</span><span class="n">url_prefix</span> <span class="o">||</span> <span class="o">!</span><span class="n">url</span><span class="o">-&gt;</span><span class="n">url</span> <span class="o">||</span> <span class="o">!</span><span class="n">url_prefix</span><span class="o">-&gt;</span><span class="n">url</span><span class="p">)</span>
<a name="line-495"></a>		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-496"></a>
<a name="line-497"></a>	<span class="cm">/* check the scheme */</span>
<a name="line-498"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">url_prefix</span><span class="o">-&gt;</span><span class="n">scheme_len</span> <span class="o">!=</span> <span class="n">url</span><span class="o">-&gt;</span><span class="n">scheme_len</span> <span class="o">||</span>
<a name="line-499"></a>	    <span class="n">strncmp</span><span class="p">(</span><span class="n">url</span><span class="o">-&gt;</span><span class="n">url</span><span class="p">,</span> <span class="n">url_prefix</span><span class="o">-&gt;</span><span class="n">url</span><span class="p">,</span> <span class="n">url</span><span class="o">-&gt;</span><span class="n">scheme_len</span><span class="p">))</span>
<a name="line-500"></a>		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* schemes do not match */</span>
<a name="line-501"></a>
<a name="line-502"></a>	<span class="cm">/* check the user name if url_prefix has one */</span>
<a name="line-503"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">url_prefix</span><span class="o">-&gt;</span><span class="n">user_off</span><span class="p">)</span> <span class="p">{</span>
<a name="line-504"></a>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">url</span><span class="o">-&gt;</span><span class="n">user_off</span> <span class="o">||</span> <span class="n">url</span><span class="o">-&gt;</span><span class="n">user_len</span> <span class="o">!=</span> <span class="n">url_prefix</span><span class="o">-&gt;</span><span class="n">user_len</span> <span class="o">||</span>
<a name="line-505"></a>		    <span class="n">strncmp</span><span class="p">(</span><span class="n">url</span><span class="o">-&gt;</span><span class="n">url</span> <span class="o">+</span> <span class="n">url</span><span class="o">-&gt;</span><span class="n">user_off</span><span class="p">,</span>
<a name="line-506"></a>			    <span class="n">url_prefix</span><span class="o">-&gt;</span><span class="n">url</span> <span class="o">+</span> <span class="n">url_prefix</span><span class="o">-&gt;</span><span class="n">user_off</span><span class="p">,</span>
<a name="line-507"></a>			    <span class="n">url</span><span class="o">-&gt;</span><span class="n">user_len</span><span class="p">))</span>
<a name="line-508"></a>			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* url_prefix has a user but it&#39;s not a match */</span>
<a name="line-509"></a>		<span class="n">usermatched</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="line-510"></a>	<span class="p">}</span>
<a name="line-511"></a>
<a name="line-512"></a>	<span class="cm">/* check the host */</span>
<a name="line-513"></a>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match_host</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">url_prefix</span><span class="p">))</span>
<a name="line-514"></a>		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* host names do not match */</span>
<a name="line-515"></a>
<a name="line-516"></a>	<span class="cm">/* check the port */</span>
<a name="line-517"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">url_prefix</span><span class="o">-&gt;</span><span class="n">port_len</span> <span class="o">!=</span> <span class="n">url</span><span class="o">-&gt;</span><span class="n">port_len</span> <span class="o">||</span>
<a name="line-518"></a>	    <span class="n">strncmp</span><span class="p">(</span><span class="n">url</span><span class="o">-&gt;</span><span class="n">url</span> <span class="o">+</span> <span class="n">url</span><span class="o">-&gt;</span><span class="n">port_off</span><span class="p">,</span>
<a name="line-519"></a>		    <span class="n">url_prefix</span><span class="o">-&gt;</span><span class="n">url</span> <span class="o">+</span> <span class="n">url_prefix</span><span class="o">-&gt;</span><span class="n">port_off</span><span class="p">,</span> <span class="n">url</span><span class="o">-&gt;</span><span class="n">port_len</span><span class="p">))</span>
<a name="line-520"></a>		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* ports do not match */</span>
<a name="line-521"></a>
<a name="line-522"></a>	<span class="cm">/* check the path */</span>
<a name="line-523"></a>	<span class="n">pathmatchlen</span> <span class="o">=</span> <span class="n">url_match_prefix</span><span class="p">(</span>
<a name="line-524"></a>		<span class="n">url</span><span class="o">-&gt;</span><span class="n">url</span> <span class="o">+</span> <span class="n">url</span><span class="o">-&gt;</span><span class="n">path_off</span><span class="p">,</span>
<a name="line-525"></a>		<span class="n">url_prefix</span><span class="o">-&gt;</span><span class="n">url</span> <span class="o">+</span> <span class="n">url_prefix</span><span class="o">-&gt;</span><span class="n">path_off</span><span class="p">,</span>
<a name="line-526"></a>		<span class="n">url_prefix</span><span class="o">-&gt;</span><span class="n">url_len</span> <span class="o">-</span> <span class="n">url_prefix</span><span class="o">-&gt;</span><span class="n">path_off</span><span class="p">);</span>
<a name="line-527"></a>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pathmatchlen</span><span class="p">)</span>
<a name="line-528"></a>		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* paths do not match */</span>
<a name="line-529"></a>
<a name="line-530"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span>
<a name="line-531"></a>		<span class="n">match</span><span class="o">-&gt;</span><span class="n">hostmatch_len</span> <span class="o">=</span> <span class="n">url_prefix</span><span class="o">-&gt;</span><span class="n">host_len</span><span class="p">;</span>
<a name="line-532"></a>		<span class="n">match</span><span class="o">-&gt;</span><span class="n">pathmatch_len</span> <span class="o">=</span> <span class="n">pathmatchlen</span><span class="p">;</span>
<a name="line-533"></a>		<span class="n">match</span><span class="o">-&gt;</span><span class="n">user_matched</span> <span class="o">=</span> <span class="n">usermatched</span><span class="p">;</span>
<a name="line-534"></a>	<span class="p">}</span>
<a name="line-535"></a>
<a name="line-536"></a>	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<a name="line-537"></a><span class="p">}</span>
<a name="line-538"></a>
<a name="line-539"></a><span class="k">static</span> <span class="kt">int</span> <span class="nf">cmp_matches</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">urlmatch_item</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
<a name="line-540"></a>		       <span class="k">const</span> <span class="k">struct</span> <span class="n">urlmatch_item</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<a name="line-541"></a><span class="p">{</span>
<a name="line-542"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">hostmatch_len</span> <span class="o">!=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">hostmatch_len</span><span class="p">)</span>
<a name="line-543"></a>		<span class="k">return</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">hostmatch_len</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">hostmatch_len</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<a name="line-544"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">pathmatch_len</span> <span class="o">!=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">pathmatch_len</span><span class="p">)</span>
<a name="line-545"></a>		<span class="k">return</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">pathmatch_len</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">pathmatch_len</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<a name="line-546"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">user_matched</span> <span class="o">!=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">user_matched</span><span class="p">)</span>
<a name="line-547"></a>		<span class="k">return</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">user_matched</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<a name="line-548"></a>	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-549"></a><span class="p">}</span>
<a name="line-550"></a>
<a name="line-551"></a><span class="kt">int</span> <span class="nf">urlmatch_config_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<a name="line-552"></a><span class="p">{</span>
<a name="line-553"></a>	<span class="k">struct</span> <span class="n">string_list_item</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>
<a name="line-554"></a>	<span class="k">struct</span> <span class="n">urlmatch_config</span> <span class="o">*</span><span class="n">collect</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span>
<a name="line-555"></a>	<span class="k">struct</span> <span class="n">urlmatch_item</span> <span class="n">matched</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<a name="line-556"></a>	<span class="k">struct</span> <span class="n">url_info</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">collect</span><span class="o">-&gt;</span><span class="n">url</span><span class="p">;</span>
<a name="line-557"></a>	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">dot</span><span class="p">;</span>
<a name="line-558"></a>	<span class="k">struct</span> <span class="n">strbuf</span> <span class="n">synthkey</span> <span class="o">=</span> <span class="n">STRBUF_INIT</span><span class="p">;</span>
<a name="line-559"></a>	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
<a name="line-560"></a>	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">select_fn</span><span class="p">)(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">urlmatch_item</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">urlmatch_item</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span>
<a name="line-561"></a>		<span class="n">collect</span><span class="o">-&gt;</span><span class="n">select_fn</span> <span class="o">?</span> <span class="n">collect</span><span class="o">-&gt;</span><span class="nl">select_fn</span> <span class="p">:</span> <span class="n">cmp_matches</span><span class="p">;</span>
<a name="line-562"></a>
<a name="line-563"></a>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skip_prefix</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">collect</span><span class="o">-&gt;</span><span class="n">section</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">)</span> <span class="o">||</span> <span class="o">*</span><span class="p">(</span><span class="n">key</span><span class="o">++</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
<a name="line-564"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">collect</span><span class="o">-&gt;</span><span class="n">cascade_fn</span><span class="p">)</span>
<a name="line-565"></a>			<span class="k">return</span> <span class="n">collect</span><span class="o">-&gt;</span><span class="n">cascade_fn</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>
<a name="line-566"></a>		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* not interested */</span>
<a name="line-567"></a>	<span class="p">}</span>
<a name="line-568"></a>	<span class="n">dot</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="sc">&#39;.&#39;</span><span class="p">);</span>
<a name="line-569"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">dot</span><span class="p">)</span> <span class="p">{</span>
<a name="line-570"></a>		<span class="kt">char</span> <span class="o">*</span><span class="n">config_url</span><span class="p">,</span> <span class="o">*</span><span class="n">norm_url</span><span class="p">;</span>
<a name="line-571"></a>		<span class="k">struct</span> <span class="n">url_info</span> <span class="n">norm_info</span><span class="p">;</span>
<a name="line-572"></a>
<a name="line-573"></a>		<span class="n">config_url</span> <span class="o">=</span> <span class="n">xmemdupz</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">dot</span> <span class="o">-</span> <span class="n">key</span><span class="p">);</span>
<a name="line-574"></a>		<span class="n">norm_url</span> <span class="o">=</span> <span class="n">url_normalize_1</span><span class="p">(</span><span class="n">config_url</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">norm_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<a name="line-575"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">norm_url</span><span class="p">)</span>
<a name="line-576"></a>			<span class="n">retval</span> <span class="o">=</span> <span class="n">match_urls</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">norm_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">matched</span><span class="p">);</span>
<a name="line-577"></a>		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">collect</span><span class="o">-&gt;</span><span class="n">fallback_match_fn</span><span class="p">)</span>
<a name="line-578"></a>			<span class="n">retval</span> <span class="o">=</span> <span class="n">collect</span><span class="o">-&gt;</span><span class="n">fallback_match_fn</span><span class="p">(</span><span class="n">config_url</span><span class="p">,</span>
<a name="line-579"></a>							    <span class="n">collect</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">);</span>
<a name="line-580"></a>		<span class="k">else</span>
<a name="line-581"></a>			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-582"></a>		<span class="n">free</span><span class="p">(</span><span class="n">config_url</span><span class="p">);</span>
<a name="line-583"></a>		<span class="n">free</span><span class="p">(</span><span class="n">norm_url</span><span class="p">);</span>
<a name="line-584"></a>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
<a name="line-585"></a>			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-586"></a>		<span class="n">key</span> <span class="o">=</span> <span class="n">dot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="line-587"></a>	<span class="p">}</span>
<a name="line-588"></a>
<a name="line-589"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">collect</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">collect</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">))</span>
<a name="line-590"></a>		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-591"></a>
<a name="line-592"></a>	<span class="n">item</span> <span class="o">=</span> <span class="n">string_list_insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">collect</span><span class="o">-&gt;</span><span class="n">vars</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
<a name="line-593"></a>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">util</span><span class="p">)</span> <span class="p">{</span>
<a name="line-594"></a>		<span class="n">item</span><span class="o">-&gt;</span><span class="n">util</span> <span class="o">=</span> <span class="n">xcalloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">matched</span><span class="p">));</span>
<a name="line-595"></a>	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="line-596"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">select_fn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">matched</span><span class="p">,</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">util</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-597"></a>			 <span class="cm">/*</span>
<a name="line-598"></a><span class="cm">			  * Our match is worse than the old one,</span>
<a name="line-599"></a><span class="cm">			  * we cannot use it.</span>
<a name="line-600"></a><span class="cm">			  */</span>
<a name="line-601"></a>			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-602"></a>		<span class="cm">/* Otherwise, replace it with this one. */</span>
<a name="line-603"></a>	<span class="p">}</span>
<a name="line-604"></a>
<a name="line-605"></a>	<span class="n">memcpy</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">util</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">matched</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">matched</span><span class="p">));</span>
<a name="line-606"></a>	<span class="n">strbuf_addstr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">synthkey</span><span class="p">,</span> <span class="n">collect</span><span class="o">-&gt;</span><span class="n">section</span><span class="p">);</span>
<a name="line-607"></a>	<span class="n">strbuf_addch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">synthkey</span><span class="p">,</span> <span class="sc">&#39;.&#39;</span><span class="p">);</span>
<a name="line-608"></a>	<span class="n">strbuf_addstr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">synthkey</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
<a name="line-609"></a>	<span class="n">retval</span> <span class="o">=</span> <span class="n">collect</span><span class="o">-&gt;</span><span class="n">collect_fn</span><span class="p">(</span><span class="n">synthkey</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">collect</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">);</span>
<a name="line-610"></a>
<a name="line-611"></a>	<span class="n">strbuf_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">synthkey</span><span class="p">);</span>
<a name="line-612"></a>	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<a name="line-613"></a><span class="p">}</span>
</pre></div>
</td></tr></table>
      </div> <!-- /.wrapper -->
    </div>
    <div id="footer" class="footer">
      <p>
        Cppcheck 2.2 - a tool for static C/C++ code analysis<br>
        <br>
        Internet: <a href="http://cppcheck.net">http://cppcheck.net</a><br>
        IRC: <a href="irc://irc.freenode.net/cppcheck">irc://irc.freenode.net/cppcheck</a><br>
      </p>
    </div>
  </body>
</html>
