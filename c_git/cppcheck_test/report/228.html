
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cppcheck - HTML report - [project name]</title>
    <link rel="stylesheet" href="style.css">
    <style>
.highlight .hll { background-color: #ffffcc }
.highlight  { background: #ffffff; }
.highlight .c { color: #888888 } /* Comment */
.highlight .err { color: #FF0000; background-color: #FFAAAA } /* Error */
.highlight .k { color: #008800; font-weight: bold } /* Keyword */
.highlight .o { color: #333333 } /* Operator */
.highlight .ch { color: #888888 } /* Comment.Hashbang */
.highlight .cm { color: #888888 } /* Comment.Multiline */
.highlight .cp { color: #557799 } /* Comment.Preproc */
.highlight .cpf { color: #888888 } /* Comment.PreprocFile */
.highlight .c1 { color: #888888 } /* Comment.Single */
.highlight .cs { color: #cc0000; font-weight: bold } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008800; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008800; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008800; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #003388; font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: #008800; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #333399; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #6600EE; font-weight: bold } /* Literal.Number */
.highlight .s { background-color: #fff0f0 } /* Literal.String */
.highlight .na { color: #0000CC } /* Name.Attribute */
.highlight .nb { color: #007020 } /* Name.Builtin */
.highlight .nc { color: #BB0066; font-weight: bold } /* Name.Class */
.highlight .no { color: #003366; font-weight: bold } /* Name.Constant */
.highlight .nd { color: #555555; font-weight: bold } /* Name.Decorator */
.highlight .ni { color: #880000; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #FF0000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0066BB; font-weight: bold } /* Name.Function */
.highlight .nl { color: #997700; font-weight: bold } /* Name.Label */
.highlight .nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #007700 } /* Name.Tag */
.highlight .nv { color: #996633 } /* Name.Variable */
.highlight .ow { color: #000000; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #6600EE; font-weight: bold } /* Literal.Number.Bin */
.highlight .mf { color: #6600EE; font-weight: bold } /* Literal.Number.Float */
.highlight .mh { color: #005588; font-weight: bold } /* Literal.Number.Hex */
.highlight .mi { color: #0000DD; font-weight: bold } /* Literal.Number.Integer */
.highlight .mo { color: #4400EE; font-weight: bold } /* Literal.Number.Oct */
.highlight .sa { background-color: #fff0f0 } /* Literal.String.Affix */
.highlight .sb { background-color: #fff0f0 } /* Literal.String.Backtick */
.highlight .sc { color: #0044DD } /* Literal.String.Char */
.highlight .dl { background-color: #fff0f0 } /* Literal.String.Delimiter */
.highlight .sd { color: #DD4422 } /* Literal.String.Doc */
.highlight .s2 { background-color: #fff0f0 } /* Literal.String.Double */
.highlight .se { color: #666666; font-weight: bold; background-color: #fff0f0 } /* Literal.String.Escape */
.highlight .sh { background-color: #fff0f0 } /* Literal.String.Heredoc */
.highlight .si { background-color: #eeeeee } /* Literal.String.Interpol */
.highlight .sx { color: #DD2200; background-color: #fff0f0 } /* Literal.String.Other */
.highlight .sr { color: #000000; background-color: #fff0ff } /* Literal.String.Regex */
.highlight .s1 { background-color: #fff0f0 } /* Literal.String.Single */
.highlight .ss { color: #AA6600 } /* Literal.String.Symbol */
.highlight .bp { color: #007020 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0066BB; font-weight: bold } /* Name.Function.Magic */
.highlight .vc { color: #336699 } /* Name.Variable.Class */
.highlight .vg { color: #dd7700; font-weight: bold } /* Name.Variable.Global */
.highlight .vi { color: #3333BB } /* Name.Variable.Instance */
.highlight .vm { color: #996633 } /* Name.Variable.Magic */
.highlight .il { color: #0000DD; font-weight: bold } /* Literal.Number.Integer.Long */
    </style>
    <script>
      function getStyle(el, styleProp) {
        var y;

        if (el.currentStyle) {
          y = el.currentStyle[styleProp];
        } else if (window.getComputedStyle) {
          y = document.defaultView.getComputedStyle(el, null).getPropertyValue(styleProp);
        }

        return y;
      }

      function toggle() {
        var el = this.expandable_content;
        var mark = this.expandable_marker;

        if (el.style.display === "block") {
          el.style.display = "none";
          mark.textContent = "[+]";
        } else {
          el.style.display = "block";
          mark.textContent = "[-]";
        }
      }

      function initExpandables() {
        var elements = document.querySelectorAll(".expandable");

        for (var i = 0, len = elements.length; i < len; i++) {
          var el = elements[i];
          var clickable = el.querySelector("span");
          var marker = clickable.querySelector(".marker");
          var content = el.querySelector(".content");
          var width = clickable.clientWidth - parseInt(getStyle(content, "padding-left")) - parseInt(getStyle(content, "padding-right"));
          content.style.width = width + "px";
          clickable.expandable_content = content;
          clickable.expandable_marker = marker;
          clickable.addEventListener("click", toggle);
        }
      }

      function toggleDisplay(id) {
        var elements = document.querySelectorAll("." + id);

        for (var i = 0, len = elements.length; i < len; i++) {
          elements[i].classList.toggle("d-none");
        }
      }

      function toggleAll() {
        var elements = document.querySelectorAll("input");

        // starting from 1 since 0 is the "toggle all" input
        for (var i = 1, len = elements.length; i < len; i++) {
          var el = elements[i];

          if (el.checked) {
            el.checked = false;
          } else {
            el.checked = true;
          }

          toggleDisplay(el.id);
        }
      }
      window.addEventListener("load", initExpandables);
    </script>
  </head>
  <body>
    <div id="header" class="header">
      <h1>Cppcheck report - [project name]: /tmp/sslab_clang/c_git/git/pack-revindex.c</h1>
    </div>
    <div class="wrapper">
      <div id="menu">
       <p id="filename"><a href="index.html">Defects:</a> pack-revindex.c</p>
<a href="228.html#line-0"> toomanyconfigs 0</a>
    </div>
    <div id="content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205</pre></div></td><td class="code"><div class="highlight"><pre><span></span><a name="line-1"></a><span class="cp">#include</span> <span class="cpf">&quot;cache.h&quot;</span><span class="cp"></span>
<a name="line-2"></a><span class="cp">#include</span> <span class="cpf">&quot;pack-revindex.h&quot;</span><span class="cp"></span>
<a name="line-3"></a><span class="cp">#include</span> <span class="cpf">&quot;object-store.h&quot;</span><span class="cp"></span>
<a name="line-4"></a><span class="cp">#include</span> <span class="cpf">&quot;packfile.h&quot;</span><span class="cp"></span>
<a name="line-5"></a>
<a name="line-6"></a><span class="cm">/*</span>
<a name="line-7"></a><span class="cm"> * Pack index for existing packs give us easy access to the offsets into</span>
<a name="line-8"></a><span class="cm"> * corresponding pack file where each object&#39;s data starts, but the entries</span>
<a name="line-9"></a><span class="cm"> * do not store the size of the compressed representation (uncompressed</span>
<a name="line-10"></a><span class="cm"> * size is easily available by examining the pack entry header).  It is</span>
<a name="line-11"></a><span class="cm"> * also rather expensive to find the sha1 for an object given its offset.</span>
<a name="line-12"></a><span class="cm"> *</span>
<a name="line-13"></a><span class="cm"> * The pack index file is sorted by object name mapping to offset;</span>
<a name="line-14"></a><span class="cm"> * this revindex array is a list of offset/index_nr pairs</span>
<a name="line-15"></a><span class="cm"> * ordered by offset, so if you know the offset of an object, next offset</span>
<a name="line-16"></a><span class="cm"> * is where its packed representation ends and the index_nr can be used to</span>
<a name="line-17"></a><span class="cm"> * get the object sha1 from the main index.</span>
<a name="line-18"></a><span class="cm"> */</span>
<a name="line-19"></a>
<a name="line-20"></a><span class="cm">/*</span>
<a name="line-21"></a><span class="cm"> * This is a least-significant-digit radix sort.</span>
<a name="line-22"></a><span class="cm"> *</span>
<a name="line-23"></a><span class="cm"> * It sorts each of the &quot;n&quot; items in &quot;entries&quot; by its offset field. The &quot;max&quot;</span>
<a name="line-24"></a><span class="cm"> * parameter must be at least as large as the largest offset in the array,</span>
<a name="line-25"></a><span class="cm"> * and lets us quit the sort early.</span>
<a name="line-26"></a><span class="cm"> */</span>
<a name="line-27"></a><span class="k">static</span> <span class="kt">void</span> <span class="nf">sort_revindex</span><span class="p">(</span><span class="k">struct</span> <span class="n">revindex_entry</span> <span class="o">*</span><span class="n">entries</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">n</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">max</span><span class="p">)</span>
<a name="line-28"></a><span class="p">{</span>
<a name="line-29"></a>	<span class="cm">/*</span>
<a name="line-30"></a><span class="cm">	 * We use a &quot;digit&quot; size of 16 bits. That keeps our memory</span>
<a name="line-31"></a><span class="cm">	 * usage reasonable, and we can generally (for a 4G or smaller</span>
<a name="line-32"></a><span class="cm">	 * packfile) quit after two rounds of radix-sorting.</span>
<a name="line-33"></a><span class="cm">	 */</span>
<a name="line-34"></a><span class="cp">#define DIGIT_SIZE (16)</span>
<a name="line-35"></a><span class="cp">#define BUCKETS (1 &lt;&lt; DIGIT_SIZE)</span>
<a name="line-36"></a>	<span class="cm">/*</span>
<a name="line-37"></a><span class="cm">	 * We want to know the bucket that a[i] will go into when we are using</span>
<a name="line-38"></a><span class="cm">	 * the digit that is N bits from the (least significant) end.</span>
<a name="line-39"></a><span class="cm">	 */</span>
<a name="line-40"></a><span class="cp">#define BUCKET_FOR(a, i, bits) (((a)[(i)].offset &gt;&gt; (bits)) &amp; (BUCKETS-1))</span>
<a name="line-41"></a>
<a name="line-42"></a>	<span class="cm">/*</span>
<a name="line-43"></a><span class="cm">	 * We need O(n) temporary storage. Rather than do an extra copy of the</span>
<a name="line-44"></a><span class="cm">	 * partial results into &quot;entries&quot;, we sort back and forth between the</span>
<a name="line-45"></a><span class="cm">	 * real array and temporary storage. In each iteration of the loop, we</span>
<a name="line-46"></a><span class="cm">	 * keep track of them with alias pointers, always sorting from &quot;from&quot;</span>
<a name="line-47"></a><span class="cm">	 * to &quot;to&quot;.</span>
<a name="line-48"></a><span class="cm">	 */</span>
<a name="line-49"></a>	<span class="k">struct</span> <span class="n">revindex_entry</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="o">*</span><span class="n">to</span><span class="p">;</span>
<a name="line-50"></a>	<span class="kt">int</span> <span class="n">bits</span><span class="p">;</span>
<a name="line-51"></a>	<span class="kt">unsigned</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
<a name="line-52"></a>
<a name="line-53"></a>	<span class="n">ALLOC_ARRAY</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">BUCKETS</span><span class="p">);</span>
<a name="line-54"></a>	<span class="n">ALLOC_ARRAY</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<a name="line-55"></a>	<span class="n">from</span> <span class="o">=</span> <span class="n">entries</span><span class="p">;</span>
<a name="line-56"></a>	<span class="n">to</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
<a name="line-57"></a>
<a name="line-58"></a>	<span class="cm">/*</span>
<a name="line-59"></a><span class="cm">	 * If (max &gt;&gt; bits) is zero, then we know that the radix digit we are</span>
<a name="line-60"></a><span class="cm">	 * on (and any higher) will be zero for all entries, and our loop will</span>
<a name="line-61"></a><span class="cm">	 * be a no-op, as everybody lands in the same zero-th bucket.</span>
<a name="line-62"></a><span class="cm">	 */</span>
<a name="line-63"></a>	<span class="k">for</span> <span class="p">(</span><span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">max</span> <span class="o">&gt;&gt;</span> <span class="n">bits</span><span class="p">;</span> <span class="n">bits</span> <span class="o">+=</span> <span class="n">DIGIT_SIZE</span><span class="p">)</span> <span class="p">{</span>
<a name="line-64"></a>		<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
<a name="line-65"></a>
<a name="line-66"></a>		<span class="n">memset</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BUCKETS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">));</span>
<a name="line-67"></a>
<a name="line-68"></a>		<span class="cm">/*</span>
<a name="line-69"></a><span class="cm">		 * We want pos[i] to store the index of the last element that</span>
<a name="line-70"></a><span class="cm">		 * will go in bucket &quot;i&quot; (actually one past the last element).</span>
<a name="line-71"></a><span class="cm">		 * To do this, we first count the items that will go in each</span>
<a name="line-72"></a><span class="cm">		 * bucket, which gives us a relative offset from the last</span>
<a name="line-73"></a><span class="cm">		 * bucket. We can then cumulatively add the index from the</span>
<a name="line-74"></a><span class="cm">		 * previous bucket to get the true index.</span>
<a name="line-75"></a><span class="cm">		 */</span>
<a name="line-76"></a>		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="line-77"></a>			<span class="n">pos</span><span class="p">[</span><span class="n">BUCKET_FOR</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">bits</span><span class="p">)]</span><span class="o">++</span><span class="p">;</span>
<a name="line-78"></a>		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BUCKETS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a name="line-79"></a>			<span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
<a name="line-80"></a>
<a name="line-81"></a>		<span class="cm">/*</span>
<a name="line-82"></a><span class="cm">		 * Now we can drop the elements into their correct buckets (in</span>
<a name="line-83"></a><span class="cm">		 * our temporary array).  We iterate the pos counter backwards</span>
<a name="line-84"></a><span class="cm">		 * to avoid using an extra index to count up. And since we are</span>
<a name="line-85"></a><span class="cm">		 * going backwards there, we must also go backwards through the</span>
<a name="line-86"></a><span class="cm">		 * array itself, to keep the sort stable.</span>
<a name="line-87"></a><span class="cm">		 *</span>
<a name="line-88"></a><span class="cm">		 * Note that we use an unsigned iterator to make sure we can</span>
<a name="line-89"></a><span class="cm">		 * handle 2^32-1 objects, even on a 32-bit system. But this</span>
<a name="line-90"></a><span class="cm">		 * means we cannot use the more obvious &quot;i &gt;= 0&quot; loop condition</span>
<a name="line-91"></a><span class="cm">		 * for counting backwards, and must instead check for</span>
<a name="line-92"></a><span class="cm">		 * wrap-around with UINT_MAX.</span>
<a name="line-93"></a><span class="cm">		 */</span>
<a name="line-94"></a>		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">UINT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
<a name="line-95"></a>			<span class="n">to</span><span class="p">[</span><span class="o">--</span><span class="n">pos</span><span class="p">[</span><span class="n">BUCKET_FOR</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">bits</span><span class="p">)]]</span> <span class="o">=</span> <span class="n">from</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<a name="line-96"></a>
<a name="line-97"></a>		<span class="cm">/*</span>
<a name="line-98"></a><span class="cm">		 * Now &quot;to&quot; contains the most sorted list, so we swap &quot;from&quot; and</span>
<a name="line-99"></a><span class="cm">		 * &quot;to&quot; for the next iteration.</span>
<a name="line-100"></a><span class="cm">		 */</span>
<a name="line-101"></a>		<span class="n">SWAP</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">);</span>
<a name="line-102"></a>	<span class="p">}</span>
<a name="line-103"></a>
<a name="line-104"></a>	<span class="cm">/*</span>
<a name="line-105"></a><span class="cm">	 * If we ended with our data in the original array, great. If not,</span>
<a name="line-106"></a><span class="cm">	 * we have to move it back from the temporary storage.</span>
<a name="line-107"></a><span class="cm">	 */</span>
<a name="line-108"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">from</span> <span class="o">!=</span> <span class="n">entries</span><span class="p">)</span>
<a name="line-109"></a>		<span class="n">COPY_ARRAY</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<a name="line-110"></a>	<span class="n">free</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
<a name="line-111"></a>	<span class="n">free</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
<a name="line-112"></a>
<a name="line-113"></a><span class="cp">#undef BUCKET_FOR</span>
<a name="line-114"></a><span class="cp">#undef BUCKETS</span>
<a name="line-115"></a><span class="cp">#undef DIGIT_SIZE</span>
<a name="line-116"></a><span class="p">}</span>
<a name="line-117"></a>
<a name="line-118"></a><span class="cm">/*</span>
<a name="line-119"></a><span class="cm"> * Ordered list of offsets of objects in the pack.</span>
<a name="line-120"></a><span class="cm"> */</span>
<a name="line-121"></a><span class="k">static</span> <span class="kt">void</span> <span class="nf">create_pack_revindex</span><span class="p">(</span><span class="k">struct</span> <span class="n">packed_git</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<a name="line-122"></a><span class="p">{</span>
<a name="line-123"></a>	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">num_ent</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">num_objects</span><span class="p">;</span>
<a name="line-124"></a>	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
<a name="line-125"></a>	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">index</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">index_data</span><span class="p">;</span>
<a name="line-126"></a>	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">hashsz</span> <span class="o">=</span> <span class="n">the_hash_algo</span><span class="o">-&gt;</span><span class="n">rawsz</span><span class="p">;</span>
<a name="line-127"></a>
<a name="line-128"></a>	<span class="n">ALLOC_ARRAY</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">revindex</span><span class="p">,</span> <span class="n">num_ent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<a name="line-129"></a>	<span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">256</span><span class="p">;</span>
<a name="line-130"></a>
<a name="line-131"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">index_version</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="line-132"></a>		<span class="k">const</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">off_32</span> <span class="o">=</span>
<a name="line-133"></a>			<span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">num_objects</span> <span class="o">*</span> <span class="p">(</span><span class="n">hashsz</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
<a name="line-134"></a>		<span class="k">const</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">off_64</span> <span class="o">=</span> <span class="n">off_32</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">num_objects</span><span class="p">;</span>
<a name="line-135"></a>		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_ent</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="line-136"></a>			<span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">off</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="n">off_32</span><span class="o">++</span><span class="p">);</span>
<a name="line-137"></a>			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">))</span> <span class="p">{</span>
<a name="line-138"></a>				<span class="n">p</span><span class="o">-&gt;</span><span class="n">revindex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
<a name="line-139"></a>			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="line-140"></a>				<span class="n">p</span><span class="o">-&gt;</span><span class="n">revindex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">get_be64</span><span class="p">(</span><span class="n">off_64</span><span class="p">);</span>
<a name="line-141"></a>				<span class="n">off_64</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
<a name="line-142"></a>			<span class="p">}</span>
<a name="line-143"></a>			<span class="n">p</span><span class="o">-&gt;</span><span class="n">revindex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nr</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<a name="line-144"></a>		<span class="p">}</span>
<a name="line-145"></a>	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="line-146"></a>		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_ent</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="line-147"></a>			<span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">hl</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">index</span> <span class="o">+</span> <span class="p">(</span><span class="n">hashsz</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="p">));</span>
<a name="line-148"></a>			<span class="n">p</span><span class="o">-&gt;</span><span class="n">revindex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">hl</span><span class="p">);</span>
<a name="line-149"></a>			<span class="n">p</span><span class="o">-&gt;</span><span class="n">revindex</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nr</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<a name="line-150"></a>		<span class="p">}</span>
<a name="line-151"></a>	<span class="p">}</span>
<a name="line-152"></a>
<a name="line-153"></a>	<span class="cm">/*</span>
<a name="line-154"></a><span class="cm">	 * This knows the pack format -- the hash trailer</span>
<a name="line-155"></a><span class="cm">	 * follows immediately after the last object data.</span>
<a name="line-156"></a><span class="cm">	 */</span>
<a name="line-157"></a>	<span class="n">p</span><span class="o">-&gt;</span><span class="n">revindex</span><span class="p">[</span><span class="n">num_ent</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pack_size</span> <span class="o">-</span> <span class="n">hashsz</span><span class="p">;</span>
<a name="line-158"></a>	<span class="n">p</span><span class="o">-&gt;</span><span class="n">revindex</span><span class="p">[</span><span class="n">num_ent</span><span class="p">].</span><span class="n">nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="line-159"></a>	<span class="n">sort_revindex</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">revindex</span><span class="p">,</span> <span class="n">num_ent</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pack_size</span><span class="p">);</span>
<a name="line-160"></a><span class="p">}</span>
<a name="line-161"></a>
<a name="line-162"></a><span class="kt">int</span> <span class="nf">load_pack_revindex</span><span class="p">(</span><span class="k">struct</span> <span class="n">packed_git</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<a name="line-163"></a><span class="p">{</span>
<a name="line-164"></a>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">revindex</span><span class="p">)</span> <span class="p">{</span>
<a name="line-165"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">open_pack_index</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<a name="line-166"></a>			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="line-167"></a>		<span class="n">create_pack_revindex</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<a name="line-168"></a>	<span class="p">}</span>
<a name="line-169"></a>	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-170"></a><span class="p">}</span>
<a name="line-171"></a>
<a name="line-172"></a><span class="kt">int</span> <span class="nf">find_revindex_position</span><span class="p">(</span><span class="k">struct</span> <span class="n">packed_git</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">ofs</span><span class="p">)</span>
<a name="line-173"></a><span class="p">{</span>
<a name="line-174"></a>	<span class="kt">int</span> <span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-175"></a>	<span class="kt">int</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">num_objects</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="line-176"></a>	<span class="k">const</span> <span class="k">struct</span> <span class="n">revindex_entry</span> <span class="o">*</span><span class="n">revindex</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">revindex</span><span class="p">;</span>
<a name="line-177"></a>
<a name="line-178"></a>	<span class="k">do</span> <span class="p">{</span>
<a name="line-179"></a>		<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">mi</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">+</span> <span class="p">(</span><span class="n">hi</span> <span class="o">-</span> <span class="n">lo</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<a name="line-180"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">revindex</span><span class="p">[</span><span class="n">mi</span><span class="p">].</span><span class="n">offset</span> <span class="o">==</span> <span class="n">ofs</span><span class="p">)</span> <span class="p">{</span>
<a name="line-181"></a>			<span class="k">return</span> <span class="n">mi</span><span class="p">;</span>
<a name="line-182"></a>		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">&lt;</span> <span class="n">revindex</span><span class="p">[</span><span class="n">mi</span><span class="p">].</span><span class="n">offset</span><span class="p">)</span>
<a name="line-183"></a>			<span class="n">hi</span> <span class="o">=</span> <span class="n">mi</span><span class="p">;</span>
<a name="line-184"></a>		<span class="k">else</span>
<a name="line-185"></a>			<span class="n">lo</span> <span class="o">=</span> <span class="n">mi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="line-186"></a>	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&lt;</span> <span class="n">hi</span><span class="p">);</span>
<a name="line-187"></a>
<a name="line-188"></a>	<span class="n">error</span><span class="p">(</span><span class="s">&quot;bad offset for revindex&quot;</span><span class="p">);</span>
<a name="line-189"></a>	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a name="line-190"></a><span class="p">}</span>
<a name="line-191"></a>
<a name="line-192"></a><span class="k">struct</span> <span class="n">revindex_entry</span> <span class="o">*</span><span class="nf">find_pack_revindex</span><span class="p">(</span><span class="k">struct</span> <span class="n">packed_git</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">ofs</span><span class="p">)</span>
<a name="line-193"></a><span class="p">{</span>
<a name="line-194"></a>	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
<a name="line-195"></a>
<a name="line-196"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">load_pack_revindex</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<a name="line-197"></a>		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-198"></a>
<a name="line-199"></a>	<span class="n">pos</span> <span class="o">=</span> <span class="n">find_revindex_position</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
<a name="line-200"></a>
<a name="line-201"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-202"></a>		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<a name="line-203"></a>
<a name="line-204"></a>	<span class="k">return</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">revindex</span> <span class="o">+</span> <span class="n">pos</span><span class="p">;</span>
<a name="line-205"></a><span class="p">}</span>
</pre></div>
</td></tr></table>
      </div> <!-- /.wrapper -->
    </div>
    <div id="footer" class="footer">
      <p>
        Cppcheck 2.2 - a tool for static C/C++ code analysis<br>
        <br>
        Internet: <a href="http://cppcheck.net">http://cppcheck.net</a><br>
        IRC: <a href="irc://irc.freenode.net/cppcheck">irc://irc.freenode.net/cppcheck</a><br>
      </p>
    </div>
  </body>
</html>
