<!doctype html>
<html>
<head>
<title>ltable.c</title>

<style type="text/css">
body { color:#000000; background-color:#ffffff }
body { font-family:Helvetica, sans-serif; font-size:10pt }
h1 { font-size:14pt }
.FileName { margin-top: 5px; margin-bottom: 5px; display: inline; }
.FileNav { margin-left: 5px; margin-right: 5px; display: inline; }
.FileNav a { text-decoration:none; font-size: larger; }
.divider { margin-top: 30px; margin-bottom: 30px; height: 15px; }
.divider { background-color: gray; }
.code { border-collapse:collapse; width:100%; }
.code { font-family: "Monospace", monospace; font-size:10pt }
.code { line-height: 1.2em }
.comment { color: green; font-style: oblique }
.keyword { color: blue }
.string_literal { color: red }
.directive { color: darkmagenta }

/* Macros and variables could have pop-up notes hidden by default.
  - Macro pop-up:    expansion of the macro
  - Variable pop-up: value (table) of the variable */
.macro_popup, .variable_popup { display: none; }

/* Pop-up appears on mouse-hover event. */
.macro:hover .macro_popup, .variable:hover .variable_popup {
  display: block;
  padding: 2px;
  -webkit-border-radius:5px;
  -webkit-box-shadow:1px 1px 7px #000;
  border-radius:5px;
  box-shadow:1px 1px 7px #000;
  position: absolute;
  top: -1em;
  left:10em;
  z-index: 1
}

.macro_popup {
  border: 2px solid red;
  background-color:#FFF0F0;
  font-weight: normal;
}

.variable_popup {
  border: 2px solid blue;
  background-color:#F0F0FF;
  font-weight: bold;
  font-family: Helvetica, sans-serif;
  font-size: 9pt;
}

/* Pop-up notes needs a relative position as a base where they pops up. */
.macro, .variable {
  background-color: PaleGoldenRod;
  position: relative;
}
.macro { color: DarkMagenta; }

#tooltiphint {
  position: fixed;
  width: 50em;
  margin-left: -25em;
  left: 50%;
  padding: 10px;
  border: 1px solid #b0b0b0;
  border-radius: 2px;
  box-shadow: 1px 1px 7px black;
  background-color: #c0c0c0;
  z-index: 2;
}

.num { width:2.5em; padding-right:2ex; background-color:#eeeeee }
.num { text-align:right; font-size:8pt }
.num { color:#444444 }
.line { padding-left: 1ex; border-left: 3px solid #ccc }
.line { white-space: pre }
.msg { -webkit-box-shadow:1px 1px 7px #000 }
.msg { box-shadow:1px 1px 7px #000 }
.msg { -webkit-border-radius:5px }
.msg { border-radius:5px }
.msg { font-family:Helvetica, sans-serif; font-size:8pt }
.msg { float:left }
.msg { padding:0.25em 1ex 0.25em 1ex }
.msg { margin-top:10px; margin-bottom:10px }
.msg { font-weight:bold }
.msg { max-width:60em; word-wrap: break-word; white-space: pre-wrap }
.msgT { padding:0x; spacing:0x }
.msgEvent { background-color:#fff8b4; color:#000000 }
.msgControl { background-color:#bbbbbb; color:#000000 }
.msgNote { background-color:#ddeeff; color:#000000 }
.mrange { background-color:#dfddf3 }
.mrange { border-bottom:1px solid #6F9DBE }
.PathIndex { font-weight: bold; padding:0px 5px; margin-right:5px; }
.PathIndex { -webkit-border-radius:8px }
.PathIndex { border-radius:8px }
.PathIndexEvent { background-color:#bfba87 }
.PathIndexControl { background-color:#8c8c8c }
.PathIndexPopUp { background-color: #879abc; }
.PathNav a { text-decoration:none; font-size: larger }
.CodeInsertionHint { font-weight: bold; background-color: #10dd10 }
.CodeRemovalHint { background-color:#de1010 }
.CodeRemovalHint { border-bottom:1px solid #6F9DBE }
.selected{ background-color:orange !important; }

table.simpletable {
  padding: 5px;
  font-size:12pt;
  margin:20px;
  border-collapse: collapse; border-spacing: 0px;
}
td.rowname {
  text-align: right;
  vertical-align: top;
  font-weight: bold;
  color:#444444;
  padding-right:2ex;
}

/* Hidden text. */
input.spoilerhider + label {
  cursor: pointer;
  text-decoration: underline;
  display: block;
}
input.spoilerhider {
 display: none;
}
input.spoilerhider ~ .spoiler {
  overflow: hidden;
  margin: 10px auto 0;
  height: 0;
  opacity: 0;
}
input.spoilerhider:checked + label + .spoiler{
  height: auto;
  opacity: 1;
}
</style>
</head>
<body>
<!-- BUGDESC Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11 -->

<!-- BUGTYPE Potential insecure memory buffer bounds restriction in call 'memcpy' -->

<!-- BUGCATEGORY Security -->

<!-- BUGFILE /tmp/sslab_clang/c_redis/redis/deps/lua/src/ltable.c -->

<!-- FILENAME ltable.c -->

<!-- FUNCTIONNAME hashnum -->

<!-- ISSUEHASHCONTENTOFLINEINCONTEXT e393bca08a3d14d7615b7462ce5fba48 -->

<!-- BUGLINE 89 -->

<!-- BUGCOLUMN 3 -->

<!-- BUGPATHLENGTH 1 -->

<!-- BUGMETAEND -->
<!-- REPORTHEADER -->
<h3>Bug Summary</h3>
<table class="simpletable">
<tr><td class="rowname">File:</td><td>deps/lua/src/ltable.c</td></tr>
<tr><td class="rowname">Warning:</td><td><a href="#EndPath">line 89, column 3</a><br />Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11</td></tr>

</table>
<!-- REPORTSUMMARYEXTRA -->
<h3>Annotated Source Code</h3>
<p>Press <a href="#" onclick="toggleHelp(); return false;">'?'</a>
   to see keyboard shortcuts</p>
<input type="checkbox" class="spoilerhider" id="showinvocation" />
<label for="showinvocation" >Show analyzer invocation</label>
<div class="spoiler">clang -cc1 -cc1 -triple x86_64-unknown-linux-gnu -analyze -disable-free -main-file-name ltable.c -analyzer-store=region -analyzer-opt-analyze-nested-blocks -analyzer-checker=core -analyzer-checker=apiModeling -analyzer-checker=unix -analyzer-checker=deadcode -analyzer-checker=security.insecureAPI.UncheckedReturn -analyzer-checker=security.insecureAPI.getpw -analyzer-checker=security.insecureAPI.gets -analyzer-checker=security.insecureAPI.mktemp -analyzer-checker=security.insecureAPI.mkstemp -analyzer-checker=security.insecureAPI.vfork -analyzer-checker=nullability.NullPassedToNonnull -analyzer-checker=nullability.NullReturnedFromNonnull -analyzer-output plist -w -setup-static-analyzer -mrelocation-model static -mframe-pointer=none -fmath-errno -fno-rounding-math -mconstructor-aliases -munwind-tables -target-cpu x86-64 -fno-split-dwarf-inlining -debugger-tuning=gdb -resource-dir /llvm-project/build/lib/clang/12.0.0 -D LUA_ANSI -D ENABLE_CJSON_GLOBAL -D REDIS_STATIC= -internal-isystem /usr/local/include -internal-isystem /llvm-project/build/lib/clang/12.0.0/include -internal-externc-isystem /usr/include/x86_64-linux-gnu -internal-externc-isystem /include -internal-externc-isystem /usr/include -O2 -fdebug-compilation-dir /tmp/sslab_clang/c_redis/redis/deps/lua/src -ferror-limit 19 -fgnuc-version=4.2.1 -vectorize-loops -vectorize-slp -analyzer-checker core -analyzer-checker cplusplus -analyzer-checker nullability -analyzer-checker optin -analyzer-checker security -analyzer-checker unix -analyzer-checker osx -analyzer-checker fuchsia -analyzer-checker webkit -analyzer-output=html -faddrsig -o /tmp/scan-build-2020-11-24-134337-37-1 -x c ltable.c
</div>
<div id='tooltiphint' hidden="true">
  <p>Keyboard shortcuts: </p>
  <ul>
    <li>Use 'j/k' keys for keyboard navigation</li>
    <li>Use 'Shift+S' to show/hide relevant lines</li>
    <li>Use '?' to toggle this window</li>
  </ul>
  <a href="#" onclick="toggleHelp(); return false;">Close</a>
</div>
<script type='text/javascript'>
var relevant_lines = {"1": {"89": 1}};

var filterCounterexample = function (hide) {
  var tables = document.getElementsByClassName("code");
  for (var t=0; t<tables.length; t++) {
    var table = tables[t];
    var file_id = table.getAttribute("data-fileid");
    var lines_in_fid = relevant_lines[file_id];
    if (!lines_in_fid) {
      lines_in_fid = {};
    }
    var lines = table.getElementsByClassName("codeline");
    for (var i=0; i<lines.length; i++) {
        var el = lines[i];
        var lineNo = el.getAttribute("data-linenumber");
        if (!lines_in_fid[lineNo]) {
          if (hide) {
            el.setAttribute("hidden", "");
          } else {
            el.removeAttribute("hidden");
          }
        }
    }
  }
}

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "S") {
    var checked = document.getElementsByName("showCounterexample")[0].checked;
    filterCounterexample(!checked);
    document.getElementsByName("showCounterexample")[0].checked = !checked;
  } else {
    return;
  }
  event.preventDefault();
}, true);

document.addEventListener("DOMContentLoaded", function() {
    document.querySelector('input[name="showCounterexample"]').onchange=
        function (event) {
      filterCounterexample(this.checked);
    };
});
</script>

<form>
    <input type="checkbox" name="showCounterexample" id="showCounterexample" />
    <label for="showCounterexample">
       Show only relevant lines
    </label>
</form>

<script type='text/javascript'>
var digitMatcher = new RegExp("[0-9]+");

var querySelectorAllArray = function(selector) {
  return Array.prototype.slice.call(
    document.querySelectorAll(selector));
}

document.addEventListener("DOMContentLoaded", function() {
    querySelectorAllArray(".PathNav > a").forEach(
        function(currentValue, currentIndex) {
            var hrefValue = currentValue.getAttribute("href");
            currentValue.onclick = function() {
                scrollTo(document.querySelector(hrefValue));
                return false;
            };
        });
});

var findNum = function() {
    var s = document.querySelector(".selected");
    if (!s || s.id == "EndPath") {
        return 0;
    }
    var out = parseInt(digitMatcher.exec(s.id)[0]);
    return out;
};

var scrollTo = function(el) {
    querySelectorAllArray(".selected").forEach(function(s) {
        s.classList.remove("selected");
    });
    el.classList.add("selected");
    window.scrollBy(0, el.getBoundingClientRect().top -
        (window.innerHeight / 2));
}

var move = function(num, up, numItems) {
  if (num == 1 && up || num == numItems - 1 && !up) {
    return 0;
  } else if (num == 0 && up) {
    return numItems - 1;
  } else if (num == 0 && !up) {
    return 1 % numItems;
  }
  return up ? num - 1 : num + 1;
}

var numToId = function(num) {
  if (num == 0) {
    return document.getElementById("EndPath")
  }
  return document.getElementById("Path" + num);
};

var navigateTo = function(up) {
  var numItems = document.querySelectorAll(
      ".line > .msgEvent, .line > .msgControl").length;
  var currentSelected = findNum();
  var newSelected = move(currentSelected, up, numItems);
  var newEl = numToId(newSelected, numItems);

  // Scroll element into center.
  scrollTo(newEl);
};

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "j") {
    navigateTo(/*up=*/false);
  } else if (event.key == "k") {
    navigateTo(/*up=*/true);
  } else {
    return;
  }
  event.preventDefault();
}, true);
</script>
  
<script type='text/javascript'>

var toggleHelp = function() {
    var hint = document.querySelector("#tooltiphint");
    var attributeName = "hidden";
    if (hint.hasAttribute(attributeName)) {
      hint.removeAttribute(attributeName);
    } else {
      hint.setAttribute("hidden", "true");
    }
};
window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "?") {
    toggleHelp();
  } else {
    return;
  }
  event.preventDefault();
});
</script>
<table class="code" data-fileid="1">
<tr class="codeline" data-linenumber="1"><td class="num" id="LN1">1</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2"><td class="num" id="LN2">2</td><td class="line"><span class='comment'>** $Id: ltable.c,v 2.32.1.2 2007/12/28 15:32:23 roberto Exp $</span></td></tr>
<tr class="codeline" data-linenumber="3"><td class="num" id="LN3">3</td><td class="line"><span class='comment'>** Lua tables (hash)</span></td></tr>
<tr class="codeline" data-linenumber="4"><td class="num" id="LN4">4</td><td class="line"><span class='comment'>** See Copyright Notice in lua.h</span></td></tr>
<tr class="codeline" data-linenumber="5"><td class="num" id="LN5">5</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="6"><td class="num" id="LN6">6</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="7"><td class="num" id="LN7">7</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="8"><td class="num" id="LN8">8</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="9"><td class="num" id="LN9">9</td><td class="line"><span class='comment'>** Implementation of tables (aka arrays, objects, or hash tables).</span></td></tr>
<tr class="codeline" data-linenumber="10"><td class="num" id="LN10">10</td><td class="line"><span class='comment'>** Tables keep its elements in two parts: an array part and a hash part.</span></td></tr>
<tr class="codeline" data-linenumber="11"><td class="num" id="LN11">11</td><td class="line"><span class='comment'>** Non-negative integer keys are all candidates to be kept in the array</span></td></tr>
<tr class="codeline" data-linenumber="12"><td class="num" id="LN12">12</td><td class="line"><span class='comment'>** part. The actual size of the array is the largest `n' such that at</span></td></tr>
<tr class="codeline" data-linenumber="13"><td class="num" id="LN13">13</td><td class="line"><span class='comment'>** least half the slots between 0 and n are in use.</span></td></tr>
<tr class="codeline" data-linenumber="14"><td class="num" id="LN14">14</td><td class="line"><span class='comment'>** Hash uses a mix of chained scatter table with Brent's variation.</span></td></tr>
<tr class="codeline" data-linenumber="15"><td class="num" id="LN15">15</td><td class="line"><span class='comment'>** A main invariant of these tables is that, if an element is not</span></td></tr>
<tr class="codeline" data-linenumber="16"><td class="num" id="LN16">16</td><td class="line"><span class='comment'>** in its main position (i.e. the `original' position that its hash gives</span></td></tr>
<tr class="codeline" data-linenumber="17"><td class="num" id="LN17">17</td><td class="line"><span class='comment'>** to it), then the colliding element is in its own main position.</span></td></tr>
<tr class="codeline" data-linenumber="18"><td class="num" id="LN18">18</td><td class="line"><span class='comment'>** Hence even when the load factor reaches 100%, performance remains good.</span></td></tr>
<tr class="codeline" data-linenumber="19"><td class="num" id="LN19">19</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="20"><td class="num" id="LN20">20</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="21"><td class="num" id="LN21">21</td><td class="line"><span class='directive'>#include &lt;math.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="22"><td class="num" id="LN22">22</td><td class="line"><span class='directive'>#include &lt;string.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="23"><td class="num" id="LN23">23</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="24"><td class="num" id="LN24">24</td><td class="line"><span class='directive'>#define ltable_c</span></td></tr>
<tr class="codeline" data-linenumber="25"><td class="num" id="LN25">25</td><td class="line"><span class='directive'>#define LUA_CORE</span></td></tr>
<tr class="codeline" data-linenumber="26"><td class="num" id="LN26">26</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="27"><td class="num" id="LN27">27</td><td class="line"><span class='directive'>#include "lua.h"</span></td></tr>
<tr class="codeline" data-linenumber="28"><td class="num" id="LN28">28</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="29"><td class="num" id="LN29">29</td><td class="line"><span class='directive'>#include "ldebug.h"</span></td></tr>
<tr class="codeline" data-linenumber="30"><td class="num" id="LN30">30</td><td class="line"><span class='directive'>#include "ldo.h"</span></td></tr>
<tr class="codeline" data-linenumber="31"><td class="num" id="LN31">31</td><td class="line"><span class='directive'>#include "lgc.h"</span></td></tr>
<tr class="codeline" data-linenumber="32"><td class="num" id="LN32">32</td><td class="line"><span class='directive'>#include "lmem.h"</span></td></tr>
<tr class="codeline" data-linenumber="33"><td class="num" id="LN33">33</td><td class="line"><span class='directive'>#include "lobject.h"</span></td></tr>
<tr class="codeline" data-linenumber="34"><td class="num" id="LN34">34</td><td class="line"><span class='directive'>#include "lstate.h"</span></td></tr>
<tr class="codeline" data-linenumber="35"><td class="num" id="LN35">35</td><td class="line"><span class='directive'>#include "ltable.h"</span></td></tr>
<tr class="codeline" data-linenumber="36"><td class="num" id="LN36">36</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="37"><td class="num" id="LN37">37</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="38"><td class="num" id="LN38">38</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="39"><td class="num" id="LN39">39</td><td class="line"><span class='comment'>** max size of array part is 2^MAXBITS</span></td></tr>
<tr class="codeline" data-linenumber="40"><td class="num" id="LN40">40</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="41"><td class="num" id="LN41">41</td><td class="line"><span class='directive'>#if <span class='macro'>LUAI_BITSINT<span class='macro_popup'>32</span></span> &gt; 26</span></td></tr>
<tr class="codeline" data-linenumber="42"><td class="num" id="LN42">42</td><td class="line"><span class='directive'>#define <span class='macro'>MAXBITS<span class='macro_popup'>26</span></span>		26</span></td></tr>
<tr class="codeline" data-linenumber="43"><td class="num" id="LN43">43</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="44"><td class="num" id="LN44">44</td><td class="line"><span class='directive'>#define <span class='macro'>MAXBITS<span class='macro_popup'>26</span></span>		(<span class='macro'>LUAI_BITSINT<span class='macro_popup'>32</span></span>-2)</span></td></tr>
<tr class="codeline" data-linenumber="45"><td class="num" id="LN45">45</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="46"><td class="num" id="LN46">46</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="47"><td class="num" id="LN47">47</td><td class="line"><span class='directive'>#define <span class='macro'>MAXASIZE<span class='macro_popup'>(1 &lt;&lt; 26)</span></span>	(1 &lt;&lt; <span class='macro'>MAXBITS<span class='macro_popup'>26</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="48"><td class="num" id="LN48">48</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="49"><td class="num" id="LN49">49</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="50"><td class="num" id="LN50">50</td><td class="line"><span class='directive'>#define <span class='macro'>hashpow2(t,n)<span class='macro_popup'>((&amp;(t)-&gt;node[(((((int)(((n)) &amp; ((((1&lt;&lt;((t)-&gt;<br>lsizenode))))-1))))))]))</span></span>      (<span class='macro'>gnode(t, lmod((n), sizenode(t)))<span class='macro_popup'>(&amp;(t)-&gt;node[(((((int)(((n)) &amp; ((((1&lt;&lt;((t)-&gt;<br>lsizenode))))-1))))))])</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="51"><td class="num" id="LN51">51</td><td class="line">  </td></tr>
<tr class="codeline" data-linenumber="52"><td class="num" id="LN52">52</td><td class="line"><span class='directive'>#define <span class='macro'>hashstr(t,str)<span class='macro_popup'>((&amp;(t)-&gt;node[(((((int)((((str)-&gt;tsv.hash)) &amp; ((<br>((1&lt;&lt;((t)-&gt;lsizenode))))-1))))))]))</span></span>  <span class='macro'>hashpow2(t, (str)-&gt;tsv.hash)<span class='macro_popup'>((&amp;(t)-&gt;node[(((((int)((((str)-&gt;tsv.hash)) &amp; ((<br>((1&lt;&lt;((t)-&gt;lsizenode))))-1))))))]))</span></span></span></td></tr>
<tr class="codeline" data-linenumber="53"><td class="num" id="LN53">53</td><td class="line"><span class='directive'>#define <span class='macro'>hashboolean(t,p)<span class='macro_popup'>((&amp;(t)-&gt;node[(((((int)(((p)) &amp; ((((1&lt;&lt;((t)-&gt;<br>lsizenode))))-1))))))]))</span></span>        <span class='macro'>hashpow2(t, p)<span class='macro_popup'>((&amp;(t)-&gt;node[(((((int)(((p)) &amp; ((((1&lt;&lt;((t)-&gt;<br>lsizenode))))-1))))))]))</span></span></span></td></tr>
<tr class="codeline" data-linenumber="54"><td class="num" id="LN54">54</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="55"><td class="num" id="LN55">55</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="56"><td class="num" id="LN56">56</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="57"><td class="num" id="LN57">57</td><td class="line"><span class='comment'>** for some types, it is better to avoid modulus by power of 2, as</span></td></tr>
<tr class="codeline" data-linenumber="58"><td class="num" id="LN58">58</td><td class="line"><span class='comment'>** they tend to have many 2 factors.</span></td></tr>
<tr class="codeline" data-linenumber="59"><td class="num" id="LN59">59</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="60"><td class="num" id="LN60">60</td><td class="line"><span class='directive'>#define <span class='macro'>hashmod(t,n)<span class='macro_popup'>((&amp;(t)-&gt;node[((n) % ((((1&lt;&lt;((t)-&gt;lsizenode)))<br>-1)|1))]))</span></span>	(<span class='macro'>gnode(t, ((n) % ((sizenode(t)-1)|1)))<span class='macro_popup'>(&amp;(t)-&gt;node[((n) % ((((1&lt;&lt;((t)-&gt;lsizenode)))-<br>1)|1))])</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="61"><td class="num" id="LN61">61</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="62"><td class="num" id="LN62">62</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="63"><td class="num" id="LN63">63</td><td class="line"><span class='directive'>#define <span class='macro'>hashpointer(t,p)<span class='macro_popup'>((&amp;(t)-&gt;node[((((unsigned int)(lu_mem)(p))) % ((((1&lt;&lt;<br>((t)-&gt;lsizenode)))-1)|1))]))</span></span>	<span class='macro'>hashmod(t, IntPoint(p))<span class='macro_popup'>((&amp;(t)-&gt;node[((((unsigned int)(lu_mem)(p))) % ((((1&lt;&lt;<br>((t)-&gt;lsizenode)))-1)|1))]))</span></span></span></td></tr>
<tr class="codeline" data-linenumber="64"><td class="num" id="LN64">64</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="65"><td class="num" id="LN65">65</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="66"><td class="num" id="LN66">66</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="67"><td class="num" id="LN67">67</td><td class="line"><span class='comment'>** number of ints inside a lua_Number</span></td></tr>
<tr class="codeline" data-linenumber="68"><td class="num" id="LN68">68</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="69"><td class="num" id="LN69">69</td><td class="line"><span class='directive'>#define <span class='macro'>numints<span class='macro_popup'>((int)((sizeof(lua_Number)/sizeof(int))))</span></span>		<span class='macro'>cast_int(sizeof(lua_Number)/sizeof(int))<span class='macro_popup'>((int)((sizeof(lua_Number)/sizeof(int))))</span></span></span></td></tr>
<tr class="codeline" data-linenumber="70"><td class="num" id="LN70">70</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="71"><td class="num" id="LN71">71</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="72"><td class="num" id="LN72">72</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="73"><td class="num" id="LN73">73</td><td class="line"><span class='directive'>#define <span class='macro'>dummynode<span class='macro_popup'>(&amp;dummynode_)</span></span>		(&amp;dummynode_)</span></td></tr>
<tr class="codeline" data-linenumber="74"><td class="num" id="LN74">74</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="75"><td class="num" id="LN75">75</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>const</span> Node dummynode_ = {</td></tr>
<tr class="codeline" data-linenumber="76"><td class="num" id="LN76">76</td><td class="line">  {{<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>}, <span class='macro'>LUA_TNIL<span class='macro_popup'>0</span></span>},  <span class='comment'>/* value */</span></td></tr>
<tr class="codeline" data-linenumber="77"><td class="num" id="LN77">77</td><td class="line">  {{{<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>}, <span class='macro'>LUA_TNIL<span class='macro_popup'>0</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>}}  <span class='comment'>/* key */</span></td></tr>
<tr class="codeline" data-linenumber="78"><td class="num" id="LN78">78</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="79"><td class="num" id="LN79">79</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="80"><td class="num" id="LN80">80</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="81"><td class="num" id="LN81">81</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="82"><td class="num" id="LN82">82</td><td class="line"><span class='comment'>** hash for lua_Numbers</span></td></tr>
<tr class="codeline" data-linenumber="83"><td class="num" id="LN83">83</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="84"><td class="num" id="LN84">84</td><td class="line"><span class='keyword'>static</span> Node *hashnum (<span class='keyword'>const</span> Table *t, lua_Number n) {</td></tr>
<tr class="codeline" data-linenumber="85"><td class="num" id="LN85">85</td><td class="line">  <span class='keyword'>unsigned</span> <span class='keyword'>int</span> a[<span class='macro'>numints<span class='macro_popup'>((int)((sizeof(lua_Number)/sizeof(int))))</span></span>];</td></tr>
<tr class="codeline" data-linenumber="86"><td class="num" id="LN86">86</td><td class="line">  <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="87"><td class="num" id="LN87">87</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>luai_numeq(n, 0)<span class='macro_popup'>((n)==(0))</span></span>)  <span class='comment'>/* avoid problems with -0 */</span></td></tr>
<tr class="codeline" data-linenumber="88"><td class="num" id="LN88">88</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>gnode(t, 0)<span class='macro_popup'>(&amp;(t)-&gt;node[0])</span></span>;</td></tr>
<tr class="codeline" data-linenumber="89"><td class="num" id="LN89">89</td><td class="line">  <span class="mrange">memcpy</span>(a, &amp;n, <span class='keyword'>sizeof</span>(a));</td></tr>
<tr><td class="num"></td><td class="line"><div id="EndPath" class="msg msgEvent" style="margin-left:3ex; max-width:58em">Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11</div></td></tr>
<tr class="codeline" data-linenumber="90"><td class="num" id="LN90">90</td><td class="line">  <span class='keyword'>for</span> (i = 1; i &lt; <span class='macro'>numints<span class='macro_popup'>((int)((sizeof(lua_Number)/sizeof(int))))</span></span>; i++) a[0] += a[i];</td></tr>
<tr class="codeline" data-linenumber="91"><td class="num" id="LN91">91</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>hashmod(t, a[0])<span class='macro_popup'>((&amp;(t)-&gt;node[((a[0]) % ((((1&lt;&lt;((t)-&gt;lsizenode<br>)))-1)|1))]))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="92"><td class="num" id="LN92">92</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="93"><td class="num" id="LN93">93</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="94"><td class="num" id="LN94">94</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="95"><td class="num" id="LN95">95</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="96"><td class="num" id="LN96">96</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="97"><td class="num" id="LN97">97</td><td class="line"><span class='comment'>** returns the `main' position of an element in a table (that is, the index</span></td></tr>
<tr class="codeline" data-linenumber="98"><td class="num" id="LN98">98</td><td class="line"><span class='comment'>** of its hash value)</span></td></tr>
<tr class="codeline" data-linenumber="99"><td class="num" id="LN99">99</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="100"><td class="num" id="LN100">100</td><td class="line"><span class='keyword'>static</span> Node *mainposition (<span class='keyword'>const</span> Table *t, <span class='keyword'>const</span> TValue *key) {</td></tr>
<tr class="codeline" data-linenumber="101"><td class="num" id="LN101">101</td><td class="line">  <span class='keyword'>switch</span> (<span class='macro'>ttype(key)<span class='macro_popup'>((key)-&gt;tt)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="102"><td class="num" id="LN102">102</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TNUMBER<span class='macro_popup'>3</span></span>:</td></tr>
<tr class="codeline" data-linenumber="103"><td class="num" id="LN103">103</td><td class="line">      <span class='keyword'>return</span> hashnum(t, <span class='macro'>nvalue(key)<span class='macro_popup'>((key)-&gt;value.n)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="104"><td class="num" id="LN104">104</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TSTRING<span class='macro_popup'>4</span></span>:</td></tr>
<tr class="codeline" data-linenumber="105"><td class="num" id="LN105">105</td><td class="line">      <span class='keyword'>return</span> <span class='macro'>hashstr(t, rawtsvalue(key))<span class='macro_popup'>((&amp;(t)-&gt;node[(((((int)(((((&amp;(key)-&gt;value.gc-&gt;<br>ts))-&gt;tsv.hash)) &amp; ((((1&lt;&lt;((t)-&gt;lsizenode))))<br>-1))))))]))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="106"><td class="num" id="LN106">106</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TBOOLEAN<span class='macro_popup'>1</span></span>:</td></tr>
<tr class="codeline" data-linenumber="107"><td class="num" id="LN107">107</td><td class="line">      <span class='keyword'>return</span> <span class='macro'>hashboolean(t, bvalue(key))<span class='macro_popup'>((&amp;(t)-&gt;node[(((((int)(((((key)-&gt;value.b))) &amp; (<br>(((1&lt;&lt;((t)-&gt;lsizenode))))-1))))))]))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="108"><td class="num" id="LN108">108</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TLIGHTUSERDATA<span class='macro_popup'>2</span></span>:</td></tr>
<tr class="codeline" data-linenumber="109"><td class="num" id="LN109">109</td><td class="line">      <span class='keyword'>return</span> <span class='macro'>hashpointer(t, pvalue(key))<span class='macro_popup'>((&amp;(t)-&gt;node[((((unsigned int)(lu_mem)(((key)-&gt;value<br>.p)))) % ((((1&lt;&lt;((t)-&gt;lsizenode)))-1)|1))]))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="110"><td class="num" id="LN110">110</td><td class="line">    <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="111"><td class="num" id="LN111">111</td><td class="line">      <span class='keyword'>return</span> <span class='macro'>hashpointer(t, gcvalue(key))<span class='macro_popup'>((&amp;(t)-&gt;node[((((unsigned int)(lu_mem)(((key)-&gt;value<br>.gc)))) % ((((1&lt;&lt;((t)-&gt;lsizenode)))-1)|1))]))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="112"><td class="num" id="LN112">112</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="113"><td class="num" id="LN113">113</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="114"><td class="num" id="LN114">114</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="115"><td class="num" id="LN115">115</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="116"><td class="num" id="LN116">116</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="117"><td class="num" id="LN117">117</td><td class="line"><span class='comment'>** returns the index for `key' if `key' is an appropriate key to live in</span></td></tr>
<tr class="codeline" data-linenumber="118"><td class="num" id="LN118">118</td><td class="line"><span class='comment'>** the array part of the table, -1 otherwise.</span></td></tr>
<tr class="codeline" data-linenumber="119"><td class="num" id="LN119">119</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="120"><td class="num" id="LN120">120</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> arrayindex (<span class='keyword'>const</span> TValue *key) {</td></tr>
<tr class="codeline" data-linenumber="121"><td class="num" id="LN121">121</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>ttisnumber(key)<span class='macro_popup'>(((key)-&gt;tt) == 3)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="122"><td class="num" id="LN122">122</td><td class="line">    lua_Number n = <span class='macro'>nvalue(key)<span class='macro_popup'>((key)-&gt;value.n)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="123"><td class="num" id="LN123">123</td><td class="line">    <span class='keyword'>int</span> k;</td></tr>
<tr class="codeline" data-linenumber="124"><td class="num" id="LN124">124</td><td class="line">    <span class='macro'>lua_number2int(k, n)<span class='macro_popup'>((k)=(int)(n))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="125"><td class="num" id="LN125">125</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>luai_numeq(cast_num(k), n)<span class='macro_popup'>((((lua_Number)((k))))==(n))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="126"><td class="num" id="LN126">126</td><td class="line">      <span class='keyword'>return</span> k;</td></tr>
<tr class="codeline" data-linenumber="127"><td class="num" id="LN127">127</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="128"><td class="num" id="LN128">128</td><td class="line">  <span class='keyword'>return</span> -1;  <span class='comment'>/* `key' did not match some condition */</span></td></tr>
<tr class="codeline" data-linenumber="129"><td class="num" id="LN129">129</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="130"><td class="num" id="LN130">130</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="131"><td class="num" id="LN131">131</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="132"><td class="num" id="LN132">132</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="133"><td class="num" id="LN133">133</td><td class="line"><span class='comment'>** returns the index of a `key' for table traversals. First goes all</span></td></tr>
<tr class="codeline" data-linenumber="134"><td class="num" id="LN134">134</td><td class="line"><span class='comment'>** elements in the array part, then elements in the hash part. The</span></td></tr>
<tr class="codeline" data-linenumber="135"><td class="num" id="LN135">135</td><td class="line"><span class='comment'>** beginning of a traversal is signalled by -1.</span></td></tr>
<tr class="codeline" data-linenumber="136"><td class="num" id="LN136">136</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="137"><td class="num" id="LN137">137</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> findindex (lua_State *L, Table *t, StkId key) {</td></tr>
<tr class="codeline" data-linenumber="138"><td class="num" id="LN138">138</td><td class="line">  <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="139"><td class="num" id="LN139">139</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>ttisnil(key)<span class='macro_popup'>(((key)-&gt;tt) == 0)</span></span>) <span class='keyword'>return</span> -1;  <span class='comment'>/* first iteration */</span></td></tr>
<tr class="codeline" data-linenumber="140"><td class="num" id="LN140">140</td><td class="line">  i = arrayindex(key);</td></tr>
<tr class="codeline" data-linenumber="141"><td class="num" id="LN141">141</td><td class="line">  <span class='keyword'>if</span> (0 &lt; i &amp;&amp; i &lt;= t-&gt;sizearray)  <span class='comment'>/* is `key' inside array part? */</span></td></tr>
<tr class="codeline" data-linenumber="142"><td class="num" id="LN142">142</td><td class="line">    <span class='keyword'>return</span> i-1;  <span class='comment'>/* yes; that's the index (corrected to C) */</span></td></tr>
<tr class="codeline" data-linenumber="143"><td class="num" id="LN143">143</td><td class="line">  <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="144"><td class="num" id="LN144">144</td><td class="line">    Node *n = mainposition(t, key);</td></tr>
<tr class="codeline" data-linenumber="145"><td class="num" id="LN145">145</td><td class="line">    <span class='keyword'>do</span> {  <span class='comment'>/* check whether `key' is somewhere in the chain */</span></td></tr>
<tr class="codeline" data-linenumber="146"><td class="num" id="LN146">146</td><td class="line">      <span class='comment'>/* key may be dead already, but it is ok to use it in `next' */</span></td></tr>
<tr class="codeline" data-linenumber="147"><td class="num" id="LN147">147</td><td class="line">      <span class='keyword'>if</span> (luaO_rawequalObj(<span class='macro'>key2tval(n)<span class='macro_popup'>(&amp;(n)-&gt;i_key.tvk)</span></span>, key) ||</td></tr>
<tr class="codeline" data-linenumber="148"><td class="num" id="LN148">148</td><td class="line">            (<span class='macro'>ttype(gkey(n))<span class='macro_popup'>(((&amp;(n)-&gt;i_key.nk))-&gt;tt)</span></span> == <span class='macro'>LUA_TDEADKEY<span class='macro_popup'>(8 +3)</span></span> &amp;&amp; <span class='macro'>iscollectable(key)<span class='macro_popup'>(((key)-&gt;tt) &gt;= 4)</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="149"><td class="num" id="LN149">149</td><td class="line">             <span class='macro'>gcvalue(gkey(n))<span class='macro_popup'>(((&amp;(n)-&gt;i_key.nk))-&gt;value.gc)</span></span> == <span class='macro'>gcvalue(key)<span class='macro_popup'>((key)-&gt;value.gc)</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="150"><td class="num" id="LN150">150</td><td class="line">        i = <span class='macro'>cast_int(n - gnode(t, 0))<span class='macro_popup'>((int)((n - (&amp;(t)-&gt;node[0]))))</span></span>;  <span class='comment'>/* key index in hash table */</span></td></tr>
<tr class="codeline" data-linenumber="151"><td class="num" id="LN151">151</td><td class="line">        <span class='comment'>/* hash elements are numbered after array ones */</span></td></tr>
<tr class="codeline" data-linenumber="152"><td class="num" id="LN152">152</td><td class="line">        <span class='keyword'>return</span> i + t-&gt;sizearray;</td></tr>
<tr class="codeline" data-linenumber="153"><td class="num" id="LN153">153</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="154"><td class="num" id="LN154">154</td><td class="line">      <span class='keyword'>else</span> n = <span class='macro'>gnext(n)<span class='macro_popup'>((n)-&gt;i_key.nk.next)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="155"><td class="num" id="LN155">155</td><td class="line">    } <span class='keyword'>while</span> (n);</td></tr>
<tr class="codeline" data-linenumber="156"><td class="num" id="LN156">156</td><td class="line">    luaG_runerror(L, <span class='string_literal'>"invalid key to "</span> <span class='macro'>LUA_QL(<span class='string_literal'>"next"</span>)<span class='macro_popup'>"'" "next" "'"</span></span>);  <span class='comment'>/* key not found */</span></td></tr>
<tr class="codeline" data-linenumber="157"><td class="num" id="LN157">157</td><td class="line">    <span class='keyword'>return</span> 0;  <span class='comment'>/* to avoid warnings */</span></td></tr>
<tr class="codeline" data-linenumber="158"><td class="num" id="LN158">158</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="159"><td class="num" id="LN159">159</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="160"><td class="num" id="LN160">160</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="161"><td class="num" id="LN161">161</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="162"><td class="num" id="LN162">162</td><td class="line"><span class='keyword'>int</span> luaH_next (lua_State *L, Table *t, StkId key) {</td></tr>
<tr class="codeline" data-linenumber="163"><td class="num" id="LN163">163</td><td class="line">  <span class='keyword'>int</span> i = findindex(L, t, key);  <span class='comment'>/* find original element */</span></td></tr>
<tr class="codeline" data-linenumber="164"><td class="num" id="LN164">164</td><td class="line">  <span class='keyword'>for</span> (i++; i &lt; t-&gt;sizearray; i++) {  <span class='comment'>/* try first array part */</span></td></tr>
<tr class="codeline" data-linenumber="165"><td class="num" id="LN165">165</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>ttisnil(&amp;t-&gt;array[i])<span class='macro_popup'>(((&amp;t-&gt;array[i])-&gt;tt) == 0)</span></span>) {  <span class='comment'>/* a non-nil value? */</span></td></tr>
<tr class="codeline" data-linenumber="166"><td class="num" id="LN166">166</td><td class="line">      <span class='macro'>setnvalue(key, cast_num(i+1))<span class='macro_popup'>{ TValue *i_o=(key); i_o-&gt;value.n=(((lua_Number)((i+1))));<br> i_o-&gt;tt=3; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="167"><td class="num" id="LN167">167</td><td class="line">      <span class='macro'>setobj2s(L, key+1, &amp;t-&gt;array[i])<span class='macro_popup'>{ const TValue *o2=(&amp;t-&gt;array[i]); TValue *o1=(key+1);<br> o1-&gt;value = o2-&gt;value; o1-&gt;tt=o2-&gt;tt; ((void)0);<br> }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="168"><td class="num" id="LN168">168</td><td class="line">      <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="169"><td class="num" id="LN169">169</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="170"><td class="num" id="LN170">170</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="171"><td class="num" id="LN171">171</td><td class="line">  <span class='keyword'>for</span> (i -= t-&gt;sizearray; i &lt; <span class='macro'>sizenode(t)<span class='macro_popup'>((1&lt;&lt;((t)-&gt;lsizenode)))</span></span>; i++) {  <span class='comment'>/* then hash part */</span></td></tr>
<tr class="codeline" data-linenumber="172"><td class="num" id="LN172">172</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>ttisnil(gval(gnode(t, i)))<span class='macro_popup'>((((&amp;((&amp;(t)-&gt;node[i]))-&gt;i_val))-&gt;tt) == 0)</span></span>) {  <span class='comment'>/* a non-nil value? */</span></td></tr>
<tr class="codeline" data-linenumber="173"><td class="num" id="LN173">173</td><td class="line">      <span class='macro'>setobj2s(L, key, key2tval(gnode(t, i)))<span class='macro_popup'>{ const TValue *o2=((&amp;((&amp;(t)-&gt;node[i]))-&gt;i_key.<br>tvk)); TValue *o1=(key); o1-&gt;value = o2-&gt;value; o1-&gt;<br>tt=o2-&gt;tt; ((void)0); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="174"><td class="num" id="LN174">174</td><td class="line">      <span class='macro'>setobj2s(L, key+1, gval(gnode(t, i)))<span class='macro_popup'>{ const TValue *o2=((&amp;((&amp;(t)-&gt;node[i]))-&gt;i_val)<br>); TValue *o1=(key+1); o1-&gt;value = o2-&gt;value; o1-&gt;tt<br>=o2-&gt;tt; ((void)0); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="175"><td class="num" id="LN175">175</td><td class="line">      <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="176"><td class="num" id="LN176">176</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="177"><td class="num" id="LN177">177</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="178"><td class="num" id="LN178">178</td><td class="line">  <span class='keyword'>return</span> 0;  <span class='comment'>/* no more elements */</span></td></tr>
<tr class="codeline" data-linenumber="179"><td class="num" id="LN179">179</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="180"><td class="num" id="LN180">180</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="181"><td class="num" id="LN181">181</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="182"><td class="num" id="LN182">182</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="183"><td class="num" id="LN183">183</td><td class="line"><span class='comment'>** {=============================================================</span></td></tr>
<tr class="codeline" data-linenumber="184"><td class="num" id="LN184">184</td><td class="line"><span class='comment'>** Rehash</span></td></tr>
<tr class="codeline" data-linenumber="185"><td class="num" id="LN185">185</td><td class="line"><span class='comment'>** ==============================================================</span></td></tr>
<tr class="codeline" data-linenumber="186"><td class="num" id="LN186">186</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="187"><td class="num" id="LN187">187</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="188"><td class="num" id="LN188">188</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="189"><td class="num" id="LN189">189</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> computesizes (<span class='keyword'>int</span> nums[], <span class='keyword'>int</span> *narray) {</td></tr>
<tr class="codeline" data-linenumber="190"><td class="num" id="LN190">190</td><td class="line">  <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="191"><td class="num" id="LN191">191</td><td class="line">  <span class='keyword'>int</span> twotoi;  <span class='comment'>/* 2^i */</span></td></tr>
<tr class="codeline" data-linenumber="192"><td class="num" id="LN192">192</td><td class="line">  <span class='keyword'>int</span> a = 0;  <span class='comment'>/* number of elements smaller than 2^i */</span></td></tr>
<tr class="codeline" data-linenumber="193"><td class="num" id="LN193">193</td><td class="line">  <span class='keyword'>int</span> na = 0;  <span class='comment'>/* number of elements to go to array part */</span></td></tr>
<tr class="codeline" data-linenumber="194"><td class="num" id="LN194">194</td><td class="line">  <span class='keyword'>int</span> n = 0;  <span class='comment'>/* optimal size for array part */</span></td></tr>
<tr class="codeline" data-linenumber="195"><td class="num" id="LN195">195</td><td class="line">  <span class='keyword'>for</span> (i = 0, twotoi = 1; twotoi/2 &lt; *narray; i++, twotoi *= 2) {</td></tr>
<tr class="codeline" data-linenumber="196"><td class="num" id="LN196">196</td><td class="line">    <span class='keyword'>if</span> (nums[i] &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="197"><td class="num" id="LN197">197</td><td class="line">      a += nums[i];</td></tr>
<tr class="codeline" data-linenumber="198"><td class="num" id="LN198">198</td><td class="line">      <span class='keyword'>if</span> (a &gt; twotoi/2) {  <span class='comment'>/* more than half elements present? */</span></td></tr>
<tr class="codeline" data-linenumber="199"><td class="num" id="LN199">199</td><td class="line">        n = twotoi;  <span class='comment'>/* optimal size (till now) */</span></td></tr>
<tr class="codeline" data-linenumber="200"><td class="num" id="LN200">200</td><td class="line">        na = a;  <span class='comment'>/* all elements smaller than n will go to array part */</span></td></tr>
<tr class="codeline" data-linenumber="201"><td class="num" id="LN201">201</td><td class="line">      }</td></tr>
<tr class="codeline" data-linenumber="202"><td class="num" id="LN202">202</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="203"><td class="num" id="LN203">203</td><td class="line">    <span class='keyword'>if</span> (a == *narray) <span class='keyword'>break</span>;  <span class='comment'>/* all elements already counted */</span></td></tr>
<tr class="codeline" data-linenumber="204"><td class="num" id="LN204">204</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="205"><td class="num" id="LN205">205</td><td class="line">  *narray = n;</td></tr>
<tr class="codeline" data-linenumber="206"><td class="num" id="LN206">206</td><td class="line">  <span class='macro'>lua_assert(*narray/2 &lt;= na &amp;&amp; na &lt;= *narray)<span class='macro_popup'>((void)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="207"><td class="num" id="LN207">207</td><td class="line">  <span class='keyword'>return</span> na;</td></tr>
<tr class="codeline" data-linenumber="208"><td class="num" id="LN208">208</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="209"><td class="num" id="LN209">209</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="210"><td class="num" id="LN210">210</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="211"><td class="num" id="LN211">211</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> countint (<span class='keyword'>const</span> TValue *key, <span class='keyword'>int</span> *nums) {</td></tr>
<tr class="codeline" data-linenumber="212"><td class="num" id="LN212">212</td><td class="line">  <span class='keyword'>int</span> k = arrayindex(key);</td></tr>
<tr class="codeline" data-linenumber="213"><td class="num" id="LN213">213</td><td class="line">  <span class='keyword'>if</span> (0 &lt; k &amp;&amp; k &lt;= <span class='macro'>MAXASIZE<span class='macro_popup'>(1 &lt;&lt; 26)</span></span>) {  <span class='comment'>/* is `key' an appropriate array index? */</span></td></tr>
<tr class="codeline" data-linenumber="214"><td class="num" id="LN214">214</td><td class="line">    nums[<span class='macro'>ceillog2(k)<span class='macro_popup'>(luaO_log2((k)-1) + 1)</span></span>]++;  <span class='comment'>/* count as such */</span></td></tr>
<tr class="codeline" data-linenumber="215"><td class="num" id="LN215">215</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="216"><td class="num" id="LN216">216</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="217"><td class="num" id="LN217">217</td><td class="line">  <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="218"><td class="num" id="LN218">218</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="219"><td class="num" id="LN219">219</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="220"><td class="num" id="LN220">220</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="221"><td class="num" id="LN221">221</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="222"><td class="num" id="LN222">222</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> numusearray (<span class='keyword'>const</span> Table *t, <span class='keyword'>int</span> *nums) {</td></tr>
<tr class="codeline" data-linenumber="223"><td class="num" id="LN223">223</td><td class="line">  <span class='keyword'>int</span> lg;</td></tr>
<tr class="codeline" data-linenumber="224"><td class="num" id="LN224">224</td><td class="line">  <span class='keyword'>int</span> ttlg;  <span class='comment'>/* 2^lg */</span></td></tr>
<tr class="codeline" data-linenumber="225"><td class="num" id="LN225">225</td><td class="line">  <span class='keyword'>int</span> ause = 0;  <span class='comment'>/* summation of `nums' */</span></td></tr>
<tr class="codeline" data-linenumber="226"><td class="num" id="LN226">226</td><td class="line">  <span class='keyword'>int</span> i = 1;  <span class='comment'>/* count to traverse all array keys */</span></td></tr>
<tr class="codeline" data-linenumber="227"><td class="num" id="LN227">227</td><td class="line">  <span class='keyword'>for</span> (lg=0, ttlg=1; lg&lt;=<span class='macro'>MAXBITS<span class='macro_popup'>26</span></span>; lg++, ttlg*=2) {  <span class='comment'>/* for each slice */</span></td></tr>
<tr class="codeline" data-linenumber="228"><td class="num" id="LN228">228</td><td class="line">    <span class='keyword'>int</span> lc = 0;  <span class='comment'>/* counter */</span></td></tr>
<tr class="codeline" data-linenumber="229"><td class="num" id="LN229">229</td><td class="line">    <span class='keyword'>int</span> lim = ttlg;</td></tr>
<tr class="codeline" data-linenumber="230"><td class="num" id="LN230">230</td><td class="line">    <span class='keyword'>if</span> (lim &gt; t-&gt;sizearray) {</td></tr>
<tr class="codeline" data-linenumber="231"><td class="num" id="LN231">231</td><td class="line">      lim = t-&gt;sizearray;  <span class='comment'>/* adjust upper limit */</span></td></tr>
<tr class="codeline" data-linenumber="232"><td class="num" id="LN232">232</td><td class="line">      <span class='keyword'>if</span> (i &gt; lim)</td></tr>
<tr class="codeline" data-linenumber="233"><td class="num" id="LN233">233</td><td class="line">        <span class='keyword'>break</span>;  <span class='comment'>/* no more elements to count */</span></td></tr>
<tr class="codeline" data-linenumber="234"><td class="num" id="LN234">234</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="235"><td class="num" id="LN235">235</td><td class="line">    <span class='comment'>/* count elements in range (2^(lg-1), 2^lg] */</span></td></tr>
<tr class="codeline" data-linenumber="236"><td class="num" id="LN236">236</td><td class="line">    <span class='keyword'>for</span> (; i &lt;= lim; i++) {</td></tr>
<tr class="codeline" data-linenumber="237"><td class="num" id="LN237">237</td><td class="line">      <span class='keyword'>if</span> (!<span class='macro'>ttisnil(&amp;t-&gt;array[i-1])<span class='macro_popup'>(((&amp;t-&gt;array[i-1])-&gt;tt) == 0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="238"><td class="num" id="LN238">238</td><td class="line">        lc++;</td></tr>
<tr class="codeline" data-linenumber="239"><td class="num" id="LN239">239</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="240"><td class="num" id="LN240">240</td><td class="line">    nums[lg] += lc;</td></tr>
<tr class="codeline" data-linenumber="241"><td class="num" id="LN241">241</td><td class="line">    ause += lc;</td></tr>
<tr class="codeline" data-linenumber="242"><td class="num" id="LN242">242</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="243"><td class="num" id="LN243">243</td><td class="line">  <span class='keyword'>return</span> ause;</td></tr>
<tr class="codeline" data-linenumber="244"><td class="num" id="LN244">244</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="245"><td class="num" id="LN245">245</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="246"><td class="num" id="LN246">246</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="247"><td class="num" id="LN247">247</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> numusehash (<span class='keyword'>const</span> Table *t, <span class='keyword'>int</span> *nums, <span class='keyword'>int</span> *pnasize) {</td></tr>
<tr class="codeline" data-linenumber="248"><td class="num" id="LN248">248</td><td class="line">  <span class='keyword'>int</span> totaluse = 0;  <span class='comment'>/* total number of elements */</span></td></tr>
<tr class="codeline" data-linenumber="249"><td class="num" id="LN249">249</td><td class="line">  <span class='keyword'>int</span> ause = 0;  <span class='comment'>/* summation of `nums' */</span></td></tr>
<tr class="codeline" data-linenumber="250"><td class="num" id="LN250">250</td><td class="line">  <span class='keyword'>int</span> i = <span class='macro'>sizenode(t)<span class='macro_popup'>((1&lt;&lt;((t)-&gt;lsizenode)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="251"><td class="num" id="LN251">251</td><td class="line">  <span class='keyword'>while</span> (i--) {</td></tr>
<tr class="codeline" data-linenumber="252"><td class="num" id="LN252">252</td><td class="line">    Node *n = &amp;t-&gt;node[i];</td></tr>
<tr class="codeline" data-linenumber="253"><td class="num" id="LN253">253</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>ttisnil(gval(n))<span class='macro_popup'>((((&amp;(n)-&gt;i_val))-&gt;tt) == 0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="254"><td class="num" id="LN254">254</td><td class="line">      ause += countint(<span class='macro'>key2tval(n)<span class='macro_popup'>(&amp;(n)-&gt;i_key.tvk)</span></span>, nums);</td></tr>
<tr class="codeline" data-linenumber="255"><td class="num" id="LN255">255</td><td class="line">      totaluse++;</td></tr>
<tr class="codeline" data-linenumber="256"><td class="num" id="LN256">256</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="257"><td class="num" id="LN257">257</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="258"><td class="num" id="LN258">258</td><td class="line">  *pnasize += ause;</td></tr>
<tr class="codeline" data-linenumber="259"><td class="num" id="LN259">259</td><td class="line">  <span class='keyword'>return</span> totaluse;</td></tr>
<tr class="codeline" data-linenumber="260"><td class="num" id="LN260">260</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="261"><td class="num" id="LN261">261</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="262"><td class="num" id="LN262">262</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="263"><td class="num" id="LN263">263</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> setarrayvector (lua_State *L, Table *t, <span class='keyword'>int</span> size) {</td></tr>
<tr class="codeline" data-linenumber="264"><td class="num" id="LN264">264</td><td class="line">  <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="265"><td class="num" id="LN265">265</td><td class="line">  <span class='macro'>luaM_reallocvector(L, t-&gt;array, t-&gt;sizearray, size, TValue)<span class='macro_popup'>((t-&gt;array)=((TValue *)(((((size_t)((size)+1)) &lt;= ((size_t<br>)(~(size_t)0)-2)/(sizeof(TValue))) ? luaM_realloc_(L, (t-&gt;<br>array), (t-&gt;sizearray)*(sizeof(TValue)), (size)*(sizeof(TValue<br>))) : luaM_toobig(L)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="266"><td class="num" id="LN266">266</td><td class="line">  <span class='keyword'>for</span> (i=t-&gt;sizearray; i&lt;size; i++)</td></tr>
<tr class="codeline" data-linenumber="267"><td class="num" id="LN267">267</td><td class="line">     <span class='macro'>setnilvalue(&amp;t-&gt;array[i])<span class='macro_popup'>((&amp;t-&gt;array[i])-&gt;tt=0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="268"><td class="num" id="LN268">268</td><td class="line">  t-&gt;sizearray = size;</td></tr>
<tr class="codeline" data-linenumber="269"><td class="num" id="LN269">269</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="270"><td class="num" id="LN270">270</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="271"><td class="num" id="LN271">271</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="272"><td class="num" id="LN272">272</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> setnodevector (lua_State *L, Table *t, <span class='keyword'>int</span> size) {</td></tr>
<tr class="codeline" data-linenumber="273"><td class="num" id="LN273">273</td><td class="line">  <span class='keyword'>int</span> lsize;</td></tr>
<tr class="codeline" data-linenumber="274"><td class="num" id="LN274">274</td><td class="line">  <span class='keyword'>if</span> (size == 0) {  <span class='comment'>/* no elements to hash part? */</span></td></tr>
<tr class="codeline" data-linenumber="275"><td class="num" id="LN275">275</td><td class="line">    t-&gt;node = <span class='macro'>cast(Node *, dummynode)<span class='macro_popup'>((Node *)((&amp;dummynode_)))</span></span>;  <span class='comment'>/* use common `dummynode' */</span></td></tr>
<tr class="codeline" data-linenumber="276"><td class="num" id="LN276">276</td><td class="line">    lsize = 0;</td></tr>
<tr class="codeline" data-linenumber="277"><td class="num" id="LN277">277</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="278"><td class="num" id="LN278">278</td><td class="line">  <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="279"><td class="num" id="LN279">279</td><td class="line">    <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="280"><td class="num" id="LN280">280</td><td class="line">    lsize = <span class='macro'>ceillog2(size)<span class='macro_popup'>(luaO_log2((size)-1) + 1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="281"><td class="num" id="LN281">281</td><td class="line">    <span class='keyword'>if</span> (lsize &gt; <span class='macro'>MAXBITS<span class='macro_popup'>26</span></span>)</td></tr>
<tr class="codeline" data-linenumber="282"><td class="num" id="LN282">282</td><td class="line">      luaG_runerror(L, <span class='string_literal'>"table overflow"</span>);</td></tr>
<tr class="codeline" data-linenumber="283"><td class="num" id="LN283">283</td><td class="line">    size = <span class='macro'>twoto(lsize)<span class='macro_popup'>(1&lt;&lt;(lsize))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="284"><td class="num" id="LN284">284</td><td class="line">    t-&gt;node = <span class='macro'>luaM_newvector(L, size, Node)<span class='macro_popup'>((Node *)(((((size_t)((size)+1)) &lt;= ((size_t)(~(size_t)0)-<br>2)/(sizeof(Node))) ? luaM_realloc_(L, (((void*)0)), (0)*(sizeof<br>(Node)), (size)*(sizeof(Node))) : luaM_toobig(L))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="285"><td class="num" id="LN285">285</td><td class="line">    <span class='keyword'>for</span> (i=0; i&lt;size; i++) {</td></tr>
<tr class="codeline" data-linenumber="286"><td class="num" id="LN286">286</td><td class="line">      Node *n = <span class='macro'>gnode(t, i)<span class='macro_popup'>(&amp;(t)-&gt;node[i])</span></span>;</td></tr>
<tr class="codeline" data-linenumber="287"><td class="num" id="LN287">287</td><td class="line">      <span class='macro'>gnext(n)<span class='macro_popup'>((n)-&gt;i_key.nk.next)</span></span> = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="288"><td class="num" id="LN288">288</td><td class="line">      <span class='macro'>setnilvalue(gkey(n))<span class='macro_popup'>(((&amp;(n)-&gt;i_key.nk))-&gt;tt=0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="289"><td class="num" id="LN289">289</td><td class="line">      <span class='macro'>setnilvalue(gval(n))<span class='macro_popup'>(((&amp;(n)-&gt;i_val))-&gt;tt=0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="290"><td class="num" id="LN290">290</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="291"><td class="num" id="LN291">291</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="292"><td class="num" id="LN292">292</td><td class="line">  t-&gt;lsizenode = <span class='macro'>cast_byte(lsize)<span class='macro_popup'>((lu_byte)((lsize)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="293"><td class="num" id="LN293">293</td><td class="line">  t-&gt;lastfree = <span class='macro'>gnode(t, size)<span class='macro_popup'>(&amp;(t)-&gt;node[size])</span></span>;  <span class='comment'>/* all positions are free */</span></td></tr>
<tr class="codeline" data-linenumber="294"><td class="num" id="LN294">294</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="295"><td class="num" id="LN295">295</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="296"><td class="num" id="LN296">296</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="297"><td class="num" id="LN297">297</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> resize (lua_State *L, Table *t, <span class='keyword'>int</span> nasize, <span class='keyword'>int</span> nhsize) {</td></tr>
<tr class="codeline" data-linenumber="298"><td class="num" id="LN298">298</td><td class="line">  <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="299"><td class="num" id="LN299">299</td><td class="line">  <span class='keyword'>int</span> oldasize = t-&gt;sizearray;</td></tr>
<tr class="codeline" data-linenumber="300"><td class="num" id="LN300">300</td><td class="line">  <span class='keyword'>int</span> oldhsize = t-&gt;lsizenode;</td></tr>
<tr class="codeline" data-linenumber="301"><td class="num" id="LN301">301</td><td class="line">  Node *nold = t-&gt;node;  <span class='comment'>/* save old hash ... */</span></td></tr>
<tr class="codeline" data-linenumber="302"><td class="num" id="LN302">302</td><td class="line">  <span class='keyword'>if</span> (nasize &gt; oldasize)  <span class='comment'>/* array part must grow? */</span></td></tr>
<tr class="codeline" data-linenumber="303"><td class="num" id="LN303">303</td><td class="line">    setarrayvector(L, t, nasize);</td></tr>
<tr class="codeline" data-linenumber="304"><td class="num" id="LN304">304</td><td class="line">  <span class='comment'>/* create new hash part with appropriate size */</span></td></tr>
<tr class="codeline" data-linenumber="305"><td class="num" id="LN305">305</td><td class="line">  setnodevector(L, t, nhsize);  </td></tr>
<tr class="codeline" data-linenumber="306"><td class="num" id="LN306">306</td><td class="line">  <span class='keyword'>if</span> (nasize &lt; oldasize) {  <span class='comment'>/* array part must shrink? */</span></td></tr>
<tr class="codeline" data-linenumber="307"><td class="num" id="LN307">307</td><td class="line">    t-&gt;sizearray = nasize;</td></tr>
<tr class="codeline" data-linenumber="308"><td class="num" id="LN308">308</td><td class="line">    <span class='comment'>/* re-insert elements from vanishing slice */</span></td></tr>
<tr class="codeline" data-linenumber="309"><td class="num" id="LN309">309</td><td class="line">    <span class='keyword'>for</span> (i=nasize; i&lt;oldasize; i++) {</td></tr>
<tr class="codeline" data-linenumber="310"><td class="num" id="LN310">310</td><td class="line">      <span class='keyword'>if</span> (!<span class='macro'>ttisnil(&amp;t-&gt;array[i])<span class='macro_popup'>(((&amp;t-&gt;array[i])-&gt;tt) == 0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="311"><td class="num" id="LN311">311</td><td class="line">        <span class='macro'>setobjt2t(L, luaH_setnum(L, t, i+1), &amp;t-&gt;array[i])<span class='macro_popup'>{ const TValue *o2=(&amp;t-&gt;array[i]); TValue *o1=(luaH_setnum<br>(L, t, i+1)); o1-&gt;value = o2-&gt;value; o1-&gt;tt=o2-&gt;tt<br>; ((void)0); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="312"><td class="num" id="LN312">312</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="313"><td class="num" id="LN313">313</td><td class="line">    <span class='comment'>/* shrink array */</span></td></tr>
<tr class="codeline" data-linenumber="314"><td class="num" id="LN314">314</td><td class="line">    <span class='macro'>luaM_reallocvector(L, t-&gt;array, oldasize, nasize, TValue)<span class='macro_popup'>((t-&gt;array)=((TValue *)(((((size_t)((nasize)+1)) &lt;= ((size_t<br>)(~(size_t)0)-2)/(sizeof(TValue))) ? luaM_realloc_(L, (t-&gt;<br>array), (oldasize)*(sizeof(TValue)), (nasize)*(sizeof(TValue)<br>)) : luaM_toobig(L)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="315"><td class="num" id="LN315">315</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="316"><td class="num" id="LN316">316</td><td class="line">  <span class='comment'>/* re-insert elements from hash part */</span></td></tr>
<tr class="codeline" data-linenumber="317"><td class="num" id="LN317">317</td><td class="line">  <span class='keyword'>for</span> (i = <span class='macro'>twoto(oldhsize)<span class='macro_popup'>(1&lt;&lt;(oldhsize))</span></span> - 1; i &gt;= 0; i--) {</td></tr>
<tr class="codeline" data-linenumber="318"><td class="num" id="LN318">318</td><td class="line">    Node *old = nold+i;</td></tr>
<tr class="codeline" data-linenumber="319"><td class="num" id="LN319">319</td><td class="line">    <span class='keyword'>if</span> (!<span class='macro'>ttisnil(gval(old))<span class='macro_popup'>((((&amp;(old)-&gt;i_val))-&gt;tt) == 0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="320"><td class="num" id="LN320">320</td><td class="line">      <span class='macro'>setobjt2t(L, luaH_set(L, t, key2tval(old)), gval(old))<span class='macro_popup'>{ const TValue *o2=((&amp;(old)-&gt;i_val)); TValue *o1=(luaH_set<br>(L, t, (&amp;(old)-&gt;i_key.tvk))); o1-&gt;value = o2-&gt;value<br>; o1-&gt;tt=o2-&gt;tt; ((void)0); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="321"><td class="num" id="LN321">321</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="322"><td class="num" id="LN322">322</td><td class="line">  <span class='keyword'>if</span> (nold != <span class='macro'>dummynode<span class='macro_popup'>(&amp;dummynode_)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="323"><td class="num" id="LN323">323</td><td class="line">    <span class='macro'>luaM_freearray(L, nold, twoto(oldhsize), Node)<span class='macro_popup'>((((size_t)((0)+1)) &lt;= ((size_t)(~(size_t)0)-2)/(sizeof(Node<br>))) ? luaM_realloc_(L, ((nold)), ((1&lt;&lt;(oldhsize)))*(sizeof<br>(Node)), (0)*(sizeof(Node))) : luaM_toobig(L))</span></span>;  <span class='comment'>/* free old array */</span></td></tr>
<tr class="codeline" data-linenumber="324"><td class="num" id="LN324">324</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="325"><td class="num" id="LN325">325</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="326"><td class="num" id="LN326">326</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="327"><td class="num" id="LN327">327</td><td class="line"><span class='keyword'>void</span> luaH_resizearray (lua_State *L, Table *t, <span class='keyword'>int</span> nasize) {</td></tr>
<tr class="codeline" data-linenumber="328"><td class="num" id="LN328">328</td><td class="line">  <span class='keyword'>int</span> nsize = (t-&gt;node == <span class='macro'>dummynode<span class='macro_popup'>(&amp;dummynode_)</span></span>) ? 0 : <span class='macro'>sizenode(t)<span class='macro_popup'>((1&lt;&lt;((t)-&gt;lsizenode)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="329"><td class="num" id="LN329">329</td><td class="line">  resize(L, t, nasize, nsize);</td></tr>
<tr class="codeline" data-linenumber="330"><td class="num" id="LN330">330</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="331"><td class="num" id="LN331">331</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="332"><td class="num" id="LN332">332</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="333"><td class="num" id="LN333">333</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> rehash (lua_State *L, Table *t, <span class='keyword'>const</span> TValue *ek) {</td></tr>
<tr class="codeline" data-linenumber="334"><td class="num" id="LN334">334</td><td class="line">  <span class='keyword'>int</span> nasize, na;</td></tr>
<tr class="codeline" data-linenumber="335"><td class="num" id="LN335">335</td><td class="line">  <span class='keyword'>int</span> nums[<span class='macro'>MAXBITS<span class='macro_popup'>26</span></span>+1];  <span class='comment'>/* nums[i] = number of keys between 2^(i-1) and 2^i */</span></td></tr>
<tr class="codeline" data-linenumber="336"><td class="num" id="LN336">336</td><td class="line">  <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="337"><td class="num" id="LN337">337</td><td class="line">  <span class='keyword'>int</span> totaluse;</td></tr>
<tr class="codeline" data-linenumber="338"><td class="num" id="LN338">338</td><td class="line">  <span class='keyword'>for</span> (i=0; i&lt;=<span class='macro'>MAXBITS<span class='macro_popup'>26</span></span>; i++) nums[i] = 0;  <span class='comment'>/* reset counts */</span></td></tr>
<tr class="codeline" data-linenumber="339"><td class="num" id="LN339">339</td><td class="line">  nasize = numusearray(t, nums);  <span class='comment'>/* count keys in array part */</span></td></tr>
<tr class="codeline" data-linenumber="340"><td class="num" id="LN340">340</td><td class="line">  totaluse = nasize;  <span class='comment'>/* all those keys are integer keys */</span></td></tr>
<tr class="codeline" data-linenumber="341"><td class="num" id="LN341">341</td><td class="line">  totaluse += numusehash(t, nums, &amp;nasize);  <span class='comment'>/* count keys in hash part */</span></td></tr>
<tr class="codeline" data-linenumber="342"><td class="num" id="LN342">342</td><td class="line">  <span class='comment'>/* count extra key */</span></td></tr>
<tr class="codeline" data-linenumber="343"><td class="num" id="LN343">343</td><td class="line">  nasize += countint(ek, nums);</td></tr>
<tr class="codeline" data-linenumber="344"><td class="num" id="LN344">344</td><td class="line">  totaluse++;</td></tr>
<tr class="codeline" data-linenumber="345"><td class="num" id="LN345">345</td><td class="line">  <span class='comment'>/* compute new size for array part */</span></td></tr>
<tr class="codeline" data-linenumber="346"><td class="num" id="LN346">346</td><td class="line">  na = computesizes(nums, &amp;nasize);</td></tr>
<tr class="codeline" data-linenumber="347"><td class="num" id="LN347">347</td><td class="line">  <span class='comment'>/* resize the table to new computed sizes */</span></td></tr>
<tr class="codeline" data-linenumber="348"><td class="num" id="LN348">348</td><td class="line">  resize(L, t, nasize, totaluse - na);</td></tr>
<tr class="codeline" data-linenumber="349"><td class="num" id="LN349">349</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="350"><td class="num" id="LN350">350</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="351"><td class="num" id="LN351">351</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="352"><td class="num" id="LN352">352</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="353"><td class="num" id="LN353">353</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="354"><td class="num" id="LN354">354</td><td class="line"><span class='comment'>** }=============================================================</span></td></tr>
<tr class="codeline" data-linenumber="355"><td class="num" id="LN355">355</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="356"><td class="num" id="LN356">356</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="357"><td class="num" id="LN357">357</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="358"><td class="num" id="LN358">358</td><td class="line">Table *luaH_new (lua_State *L, <span class='keyword'>int</span> narray, <span class='keyword'>int</span> nhash) {</td></tr>
<tr class="codeline" data-linenumber="359"><td class="num" id="LN359">359</td><td class="line">  Table *t = <span class='macro'>luaM_new(L, Table)<span class='macro_popup'>((Table *)(luaM_realloc_(L, ((void*)0), 0, (sizeof(Table)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="360"><td class="num" id="LN360">360</td><td class="line">  luaC_link(L, <span class='macro'>obj2gco(t)<span class='macro_popup'>(((GCObject *)((t))))</span></span>, <span class='macro'>LUA_TTABLE<span class='macro_popup'>5</span></span>);</td></tr>
<tr class="codeline" data-linenumber="361"><td class="num" id="LN361">361</td><td class="line">  t-&gt;metatable = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="362"><td class="num" id="LN362">362</td><td class="line">  t-&gt;flags = <span class='macro'>cast_byte(~0)<span class='macro_popup'>((lu_byte)((~0)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="363"><td class="num" id="LN363">363</td><td class="line">  <span class='comment'>/* temporary values (kept only if some malloc fails) */</span></td></tr>
<tr class="codeline" data-linenumber="364"><td class="num" id="LN364">364</td><td class="line">  t-&gt;array = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="365"><td class="num" id="LN365">365</td><td class="line">  t-&gt;sizearray = 0;</td></tr>
<tr class="codeline" data-linenumber="366"><td class="num" id="LN366">366</td><td class="line">  t-&gt;lsizenode = 0;</td></tr>
<tr class="codeline" data-linenumber="367"><td class="num" id="LN367">367</td><td class="line">  t-&gt;node = <span class='macro'>cast(Node *, dummynode)<span class='macro_popup'>((Node *)((&amp;dummynode_)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="368"><td class="num" id="LN368">368</td><td class="line">  setarrayvector(L, t, narray);</td></tr>
<tr class="codeline" data-linenumber="369"><td class="num" id="LN369">369</td><td class="line">  setnodevector(L, t, nhash);</td></tr>
<tr class="codeline" data-linenumber="370"><td class="num" id="LN370">370</td><td class="line">  <span class='keyword'>return</span> t;</td></tr>
<tr class="codeline" data-linenumber="371"><td class="num" id="LN371">371</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="372"><td class="num" id="LN372">372</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="373"><td class="num" id="LN373">373</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="374"><td class="num" id="LN374">374</td><td class="line"><span class='keyword'>void</span> luaH_free (lua_State *L, Table *t) {</td></tr>
<tr class="codeline" data-linenumber="375"><td class="num" id="LN375">375</td><td class="line">  <span class='keyword'>if</span> (t-&gt;node != <span class='macro'>dummynode<span class='macro_popup'>(&amp;dummynode_)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="376"><td class="num" id="LN376">376</td><td class="line">    <span class='macro'>luaM_freearray(L, t-&gt;node, sizenode(t), Node)<span class='macro_popup'>((((size_t)((0)+1)) &lt;= ((size_t)(~(size_t)0)-2)/(sizeof(Node<br>))) ? luaM_realloc_(L, ((t-&gt;node)), (((1&lt;&lt;((t)-&gt;lsizenode<br>))))*(sizeof(Node)), (0)*(sizeof(Node))) : luaM_toobig(L))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="377"><td class="num" id="LN377">377</td><td class="line">  <span class='macro'>luaM_freearray(L, t-&gt;array, t-&gt;sizearray, TValue)<span class='macro_popup'>((((size_t)((0)+1)) &lt;= ((size_t)(~(size_t)0)-2)/(sizeof(TValue<br>))) ? luaM_realloc_(L, ((t-&gt;array)), (t-&gt;sizearray)*(sizeof<br>(TValue)), (0)*(sizeof(TValue))) : luaM_toobig(L))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="378"><td class="num" id="LN378">378</td><td class="line">  <span class='macro'>luaM_free(L, t)<span class='macro_popup'>luaM_realloc_(L, (t), sizeof(*(t)), 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="379"><td class="num" id="LN379">379</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="380"><td class="num" id="LN380">380</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="381"><td class="num" id="LN381">381</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="382"><td class="num" id="LN382">382</td><td class="line"><span class='keyword'>static</span> Node *getfreepos (Table *t) {</td></tr>
<tr class="codeline" data-linenumber="383"><td class="num" id="LN383">383</td><td class="line">  <span class='keyword'>while</span> (t-&gt;lastfree-- &gt; t-&gt;node) {</td></tr>
<tr class="codeline" data-linenumber="384"><td class="num" id="LN384">384</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>ttisnil(gkey(t-&gt;lastfree))<span class='macro_popup'>((((&amp;(t-&gt;lastfree)-&gt;i_key.nk))-&gt;tt) == 0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="385"><td class="num" id="LN385">385</td><td class="line">      <span class='keyword'>return</span> t-&gt;lastfree;</td></tr>
<tr class="codeline" data-linenumber="386"><td class="num" id="LN386">386</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="387"><td class="num" id="LN387">387</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;  <span class='comment'>/* could not find a free place */</span></td></tr>
<tr class="codeline" data-linenumber="388"><td class="num" id="LN388">388</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="389"><td class="num" id="LN389">389</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="390"><td class="num" id="LN390">390</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="391"><td class="num" id="LN391">391</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="392"><td class="num" id="LN392">392</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="393"><td class="num" id="LN393">393</td><td class="line"><span class='comment'>** inserts a new key into a hash table; first, check whether key's main</span> </td></tr>
<tr class="codeline" data-linenumber="394"><td class="num" id="LN394">394</td><td class="line"><span class='comment'>** position is free. If not, check whether colliding node is in its main</span> </td></tr>
<tr class="codeline" data-linenumber="395"><td class="num" id="LN395">395</td><td class="line"><span class='comment'>** position or not: if it is not, move colliding node to an empty place and</span> </td></tr>
<tr class="codeline" data-linenumber="396"><td class="num" id="LN396">396</td><td class="line"><span class='comment'>** put new key in its main position; otherwise (colliding node is in its main</span> </td></tr>
<tr class="codeline" data-linenumber="397"><td class="num" id="LN397">397</td><td class="line"><span class='comment'>** position), new key goes to an empty position.</span> </td></tr>
<tr class="codeline" data-linenumber="398"><td class="num" id="LN398">398</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="399"><td class="num" id="LN399">399</td><td class="line"><span class='keyword'>static</span> TValue *newkey (lua_State *L, Table *t, <span class='keyword'>const</span> TValue *key) {</td></tr>
<tr class="codeline" data-linenumber="400"><td class="num" id="LN400">400</td><td class="line">  Node *mp = mainposition(t, key);</td></tr>
<tr class="codeline" data-linenumber="401"><td class="num" id="LN401">401</td><td class="line">  <span class='keyword'>if</span> (!<span class='macro'>ttisnil(gval(mp))<span class='macro_popup'>((((&amp;(mp)-&gt;i_val))-&gt;tt) == 0)</span></span> || mp == <span class='macro'>dummynode<span class='macro_popup'>(&amp;dummynode_)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="402"><td class="num" id="LN402">402</td><td class="line">    Node *othern;</td></tr>
<tr class="codeline" data-linenumber="403"><td class="num" id="LN403">403</td><td class="line">    Node *n = getfreepos(t);  <span class='comment'>/* get a free place */</span></td></tr>
<tr class="codeline" data-linenumber="404"><td class="num" id="LN404">404</td><td class="line">    <span class='keyword'>if</span> (n == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {  <span class='comment'>/* cannot find a free place? */</span></td></tr>
<tr class="codeline" data-linenumber="405"><td class="num" id="LN405">405</td><td class="line">      rehash(L, t, key);  <span class='comment'>/* grow table */</span></td></tr>
<tr class="codeline" data-linenumber="406"><td class="num" id="LN406">406</td><td class="line">      <span class='keyword'>return</span> luaH_set(L, t, key);  <span class='comment'>/* re-insert key into grown table */</span></td></tr>
<tr class="codeline" data-linenumber="407"><td class="num" id="LN407">407</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="408"><td class="num" id="LN408">408</td><td class="line">    <span class='macro'>lua_assert(n != dummynode)<span class='macro_popup'>((void)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="409"><td class="num" id="LN409">409</td><td class="line">    othern = mainposition(t, <span class='macro'>key2tval(mp)<span class='macro_popup'>(&amp;(mp)-&gt;i_key.tvk)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="410"><td class="num" id="LN410">410</td><td class="line">    <span class='keyword'>if</span> (othern != mp) {  <span class='comment'>/* is colliding node out of its main position? */</span></td></tr>
<tr class="codeline" data-linenumber="411"><td class="num" id="LN411">411</td><td class="line">      <span class='comment'>/* yes; move colliding node into free position */</span></td></tr>
<tr class="codeline" data-linenumber="412"><td class="num" id="LN412">412</td><td class="line">      <span class='keyword'>while</span> (<span class='macro'>gnext(othern)<span class='macro_popup'>((othern)-&gt;i_key.nk.next)</span></span> != mp) othern = <span class='macro'>gnext(othern)<span class='macro_popup'>((othern)-&gt;i_key.nk.next)</span></span>;  <span class='comment'>/* find previous */</span></td></tr>
<tr class="codeline" data-linenumber="413"><td class="num" id="LN413">413</td><td class="line">      <span class='macro'>gnext(othern)<span class='macro_popup'>((othern)-&gt;i_key.nk.next)</span></span> = n;  <span class='comment'>/* redo the chain with `n' in place of `mp' */</span></td></tr>
<tr class="codeline" data-linenumber="414"><td class="num" id="LN414">414</td><td class="line">      *n = *mp;  <span class='comment'>/* copy colliding node into free pos. (mp-&gt;next also goes) */</span></td></tr>
<tr class="codeline" data-linenumber="415"><td class="num" id="LN415">415</td><td class="line">      <span class='macro'>gnext(mp)<span class='macro_popup'>((mp)-&gt;i_key.nk.next)</span></span> = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;  <span class='comment'>/* now `mp' is free */</span></td></tr>
<tr class="codeline" data-linenumber="416"><td class="num" id="LN416">416</td><td class="line">      <span class='macro'>setnilvalue(gval(mp))<span class='macro_popup'>(((&amp;(mp)-&gt;i_val))-&gt;tt=0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="417"><td class="num" id="LN417">417</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="418"><td class="num" id="LN418">418</td><td class="line">    <span class='keyword'>else</span> {  <span class='comment'>/* colliding node is in its own main position */</span></td></tr>
<tr class="codeline" data-linenumber="419"><td class="num" id="LN419">419</td><td class="line">      <span class='comment'>/* new node will go into free position */</span></td></tr>
<tr class="codeline" data-linenumber="420"><td class="num" id="LN420">420</td><td class="line">      <span class='macro'>gnext(n)<span class='macro_popup'>((n)-&gt;i_key.nk.next)</span></span> = <span class='macro'>gnext(mp)<span class='macro_popup'>((mp)-&gt;i_key.nk.next)</span></span>;  <span class='comment'>/* chain new position */</span></td></tr>
<tr class="codeline" data-linenumber="421"><td class="num" id="LN421">421</td><td class="line">      <span class='macro'>gnext(mp)<span class='macro_popup'>((mp)-&gt;i_key.nk.next)</span></span> = n;</td></tr>
<tr class="codeline" data-linenumber="422"><td class="num" id="LN422">422</td><td class="line">      mp = n;</td></tr>
<tr class="codeline" data-linenumber="423"><td class="num" id="LN423">423</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="424"><td class="num" id="LN424">424</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="425"><td class="num" id="LN425">425</td><td class="line">  <span class='macro'>gkey(mp)<span class='macro_popup'>(&amp;(mp)-&gt;i_key.nk)</span></span>-&gt;value = key-&gt;value; <span class='macro'>gkey(mp)<span class='macro_popup'>(&amp;(mp)-&gt;i_key.nk)</span></span>-&gt;tt = key-&gt;tt;</td></tr>
<tr class="codeline" data-linenumber="426"><td class="num" id="LN426">426</td><td class="line">  <span class='macro'>luaC_barriert(L, t, key)<span class='macro_popup'>{ if (((((key)-&gt;tt) &gt;= 4) &amp;&amp; (((((key)-&gt;value<br>.gc))-&gt;gch.marked) &amp; ((((1&lt;&lt;(0)) | (1&lt;&lt;(1)<br>)))))) &amp;&amp; ((((((GCObject *)((t)))))-&gt;gch.marked) &amp;<br> ((1&lt;&lt;(2))))) luaC_barrierback(L,t); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="427"><td class="num" id="LN427">427</td><td class="line">  <span class='macro'>lua_assert(ttisnil(gval(mp)))<span class='macro_popup'>((void)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="428"><td class="num" id="LN428">428</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>gval(mp)<span class='macro_popup'>(&amp;(mp)-&gt;i_val)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="429"><td class="num" id="LN429">429</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="430"><td class="num" id="LN430">430</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="431"><td class="num" id="LN431">431</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="432"><td class="num" id="LN432">432</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="433"><td class="num" id="LN433">433</td><td class="line"><span class='comment'>** search function for integers</span></td></tr>
<tr class="codeline" data-linenumber="434"><td class="num" id="LN434">434</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="435"><td class="num" id="LN435">435</td><td class="line"><span class='keyword'>const</span> TValue *luaH_getnum (Table *t, <span class='keyword'>int</span> key) {</td></tr>
<tr class="codeline" data-linenumber="436"><td class="num" id="LN436">436</td><td class="line">  <span class='comment'>/* (1 &lt;= key &amp;&amp; key &lt;= t-&gt;sizearray) */</span></td></tr>
<tr class="codeline" data-linenumber="437"><td class="num" id="LN437">437</td><td class="line">  <span class='keyword'>if</span> (<span class='macro'>cast(<span class='keyword'>unsigned</span> <span class='keyword'>int</span>, key-1)<span class='macro_popup'>((unsigned int)(key-1))</span></span> &lt; <span class='macro'>cast(<span class='keyword'>unsigned</span> <span class='keyword'>int</span>, t-&gt;sizearray)<span class='macro_popup'>((unsigned int)(t-&gt;sizearray))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="438"><td class="num" id="LN438">438</td><td class="line">    <span class='keyword'>return</span> &amp;t-&gt;array[key-1];</td></tr>
<tr class="codeline" data-linenumber="439"><td class="num" id="LN439">439</td><td class="line">  <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="440"><td class="num" id="LN440">440</td><td class="line">    lua_Number nk = <span class='macro'>cast_num(key)<span class='macro_popup'>((lua_Number)((key)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="441"><td class="num" id="LN441">441</td><td class="line">    Node *n = hashnum(t, nk);</td></tr>
<tr class="codeline" data-linenumber="442"><td class="num" id="LN442">442</td><td class="line">    <span class='keyword'>do</span> {  <span class='comment'>/* check whether `key' is somewhere in the chain */</span></td></tr>
<tr class="codeline" data-linenumber="443"><td class="num" id="LN443">443</td><td class="line">      <span class='keyword'>if</span> (<span class='macro'>ttisnumber(gkey(n))<span class='macro_popup'>((((&amp;(n)-&gt;i_key.nk))-&gt;tt) == 3)</span></span> &amp;&amp; <span class='macro'>luai_numeq(nvalue(gkey(n)), nk)<span class='macro_popup'>(((((&amp;(n)-&gt;i_key.nk))-&gt;value.n))==(nk))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="444"><td class="num" id="LN444">444</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>gval(n)<span class='macro_popup'>(&amp;(n)-&gt;i_val)</span></span>;  <span class='comment'>/* that's it */</span></td></tr>
<tr class="codeline" data-linenumber="445"><td class="num" id="LN445">445</td><td class="line">      <span class='keyword'>else</span> n = <span class='macro'>gnext(n)<span class='macro_popup'>((n)-&gt;i_key.nk.next)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="446"><td class="num" id="LN446">446</td><td class="line">    } <span class='keyword'>while</span> (n);</td></tr>
<tr class="codeline" data-linenumber="447"><td class="num" id="LN447">447</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>luaO_nilobject<span class='macro_popup'>(&amp;luaO_nilobject_)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="448"><td class="num" id="LN448">448</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="449"><td class="num" id="LN449">449</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="450"><td class="num" id="LN450">450</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="451"><td class="num" id="LN451">451</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="452"><td class="num" id="LN452">452</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="453"><td class="num" id="LN453">453</td><td class="line"><span class='comment'>** search function for strings</span></td></tr>
<tr class="codeline" data-linenumber="454"><td class="num" id="LN454">454</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="455"><td class="num" id="LN455">455</td><td class="line"><span class='keyword'>const</span> TValue *luaH_getstr (Table *t, TString *key) {</td></tr>
<tr class="codeline" data-linenumber="456"><td class="num" id="LN456">456</td><td class="line">  Node *n = <span class='macro'>hashstr(t, key)<span class='macro_popup'>((&amp;(t)-&gt;node[(((((int)((((key)-&gt;tsv.hash)) &amp; ((<br>((1&lt;&lt;((t)-&gt;lsizenode))))-1))))))]))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="457"><td class="num" id="LN457">457</td><td class="line">  <span class='keyword'>do</span> {  <span class='comment'>/* check whether `key' is somewhere in the chain */</span></td></tr>
<tr class="codeline" data-linenumber="458"><td class="num" id="LN458">458</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>ttisstring(gkey(n))<span class='macro_popup'>((((&amp;(n)-&gt;i_key.nk))-&gt;tt) == 4)</span></span> &amp;&amp; <span class='macro'>rawtsvalue(gkey(n))<span class='macro_popup'>(&amp;((&amp;(n)-&gt;i_key.nk))-&gt;value.gc-&gt;ts)</span></span> == key)</td></tr>
<tr class="codeline" data-linenumber="459"><td class="num" id="LN459">459</td><td class="line">      <span class='keyword'>return</span> <span class='macro'>gval(n)<span class='macro_popup'>(&amp;(n)-&gt;i_val)</span></span>;  <span class='comment'>/* that's it */</span></td></tr>
<tr class="codeline" data-linenumber="460"><td class="num" id="LN460">460</td><td class="line">    <span class='keyword'>else</span> n = <span class='macro'>gnext(n)<span class='macro_popup'>((n)-&gt;i_key.nk.next)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="461"><td class="num" id="LN461">461</td><td class="line">  } <span class='keyword'>while</span> (n);</td></tr>
<tr class="codeline" data-linenumber="462"><td class="num" id="LN462">462</td><td class="line">  <span class='keyword'>return</span> <span class='macro'>luaO_nilobject<span class='macro_popup'>(&amp;luaO_nilobject_)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="463"><td class="num" id="LN463">463</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="464"><td class="num" id="LN464">464</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="465"><td class="num" id="LN465">465</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="466"><td class="num" id="LN466">466</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="467"><td class="num" id="LN467">467</td><td class="line"><span class='comment'>** main search function</span></td></tr>
<tr class="codeline" data-linenumber="468"><td class="num" id="LN468">468</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="469"><td class="num" id="LN469">469</td><td class="line"><span class='keyword'>const</span> TValue *luaH_get (Table *t, <span class='keyword'>const</span> TValue *key) {</td></tr>
<tr class="codeline" data-linenumber="470"><td class="num" id="LN470">470</td><td class="line">  <span class='keyword'>switch</span> (<span class='macro'>ttype(key)<span class='macro_popup'>((key)-&gt;tt)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="471"><td class="num" id="LN471">471</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TNIL<span class='macro_popup'>0</span></span>: <span class='keyword'>return</span> <span class='macro'>luaO_nilobject<span class='macro_popup'>(&amp;luaO_nilobject_)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="472"><td class="num" id="LN472">472</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TSTRING<span class='macro_popup'>4</span></span>: <span class='keyword'>return</span> luaH_getstr(t, <span class='macro'>rawtsvalue(key)<span class='macro_popup'>(&amp;(key)-&gt;value.gc-&gt;ts)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="473"><td class="num" id="LN473">473</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TNUMBER<span class='macro_popup'>3</span></span>: {</td></tr>
<tr class="codeline" data-linenumber="474"><td class="num" id="LN474">474</td><td class="line">      <span class='keyword'>int</span> k;</td></tr>
<tr class="codeline" data-linenumber="475"><td class="num" id="LN475">475</td><td class="line">      lua_Number n = <span class='macro'>nvalue(key)<span class='macro_popup'>((key)-&gt;value.n)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="476"><td class="num" id="LN476">476</td><td class="line">      <span class='macro'>lua_number2int(k, n)<span class='macro_popup'>((k)=(int)(n))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="477"><td class="num" id="LN477">477</td><td class="line">      <span class='keyword'>if</span> (<span class='macro'>luai_numeq(cast_num(k), nvalue(key))<span class='macro_popup'>((((lua_Number)((k))))==(((key)-&gt;value.n)))</span></span>) <span class='comment'>/* index is int? */</span></td></tr>
<tr class="codeline" data-linenumber="478"><td class="num" id="LN478">478</td><td class="line">        <span class='keyword'>return</span> luaH_getnum(t, k);  <span class='comment'>/* use specialized version */</span></td></tr>
<tr class="codeline" data-linenumber="479"><td class="num" id="LN479">479</td><td class="line">      <span class='comment'>/* else go through */</span></td></tr>
<tr class="codeline" data-linenumber="480"><td class="num" id="LN480">480</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="481"><td class="num" id="LN481">481</td><td class="line">    <span class='keyword'>default</span>: {</td></tr>
<tr class="codeline" data-linenumber="482"><td class="num" id="LN482">482</td><td class="line">      Node *n = mainposition(t, key);</td></tr>
<tr class="codeline" data-linenumber="483"><td class="num" id="LN483">483</td><td class="line">      <span class='keyword'>do</span> {  <span class='comment'>/* check whether `key' is somewhere in the chain */</span></td></tr>
<tr class="codeline" data-linenumber="484"><td class="num" id="LN484">484</td><td class="line">        <span class='keyword'>if</span> (luaO_rawequalObj(<span class='macro'>key2tval(n)<span class='macro_popup'>(&amp;(n)-&gt;i_key.tvk)</span></span>, key))</td></tr>
<tr class="codeline" data-linenumber="485"><td class="num" id="LN485">485</td><td class="line">          <span class='keyword'>return</span> <span class='macro'>gval(n)<span class='macro_popup'>(&amp;(n)-&gt;i_val)</span></span>;  <span class='comment'>/* that's it */</span></td></tr>
<tr class="codeline" data-linenumber="486"><td class="num" id="LN486">486</td><td class="line">        <span class='keyword'>else</span> n = <span class='macro'>gnext(n)<span class='macro_popup'>((n)-&gt;i_key.nk.next)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="487"><td class="num" id="LN487">487</td><td class="line">      } <span class='keyword'>while</span> (n);</td></tr>
<tr class="codeline" data-linenumber="488"><td class="num" id="LN488">488</td><td class="line">      <span class='keyword'>return</span> <span class='macro'>luaO_nilobject<span class='macro_popup'>(&amp;luaO_nilobject_)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="489"><td class="num" id="LN489">489</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="490"><td class="num" id="LN490">490</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="491"><td class="num" id="LN491">491</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="492"><td class="num" id="LN492">492</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="493"><td class="num" id="LN493">493</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="494"><td class="num" id="LN494">494</td><td class="line">TValue *luaH_set (lua_State *L, Table *t, <span class='keyword'>const</span> TValue *key) {</td></tr>
<tr class="codeline" data-linenumber="495"><td class="num" id="LN495">495</td><td class="line">  <span class='keyword'>const</span> TValue *p = luaH_get(t, key);</td></tr>
<tr class="codeline" data-linenumber="496"><td class="num" id="LN496">496</td><td class="line">  t-&gt;flags = 0;</td></tr>
<tr class="codeline" data-linenumber="497"><td class="num" id="LN497">497</td><td class="line">  <span class='keyword'>if</span> (p != <span class='macro'>luaO_nilobject<span class='macro_popup'>(&amp;luaO_nilobject_)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="498"><td class="num" id="LN498">498</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>cast(TValue *, p)<span class='macro_popup'>((TValue *)(p))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="499"><td class="num" id="LN499">499</td><td class="line">  <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="500"><td class="num" id="LN500">500</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>ttisnil(key)<span class='macro_popup'>(((key)-&gt;tt) == 0)</span></span>) luaG_runerror(L, <span class='string_literal'>"table index is nil"</span>);</td></tr>
<tr class="codeline" data-linenumber="501"><td class="num" id="LN501">501</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>ttisnumber(key)<span class='macro_popup'>(((key)-&gt;tt) == 3)</span></span> &amp;&amp; <span class='macro'>luai_numisnan(nvalue(key))<span class='macro_popup'>(!(((((key)-&gt;value.n)))==((((key)-&gt;value.n)))))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="502"><td class="num" id="LN502">502</td><td class="line">      luaG_runerror(L, <span class='string_literal'>"table index is NaN"</span>);</td></tr>
<tr class="codeline" data-linenumber="503"><td class="num" id="LN503">503</td><td class="line">    <span class='keyword'>return</span> newkey(L, t, key);</td></tr>
<tr class="codeline" data-linenumber="504"><td class="num" id="LN504">504</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="505"><td class="num" id="LN505">505</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="506"><td class="num" id="LN506">506</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="507"><td class="num" id="LN507">507</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="508"><td class="num" id="LN508">508</td><td class="line">TValue *luaH_setnum (lua_State *L, Table *t, <span class='keyword'>int</span> key) {</td></tr>
<tr class="codeline" data-linenumber="509"><td class="num" id="LN509">509</td><td class="line">  <span class='keyword'>const</span> TValue *p = luaH_getnum(t, key);</td></tr>
<tr class="codeline" data-linenumber="510"><td class="num" id="LN510">510</td><td class="line">  <span class='keyword'>if</span> (p != <span class='macro'>luaO_nilobject<span class='macro_popup'>(&amp;luaO_nilobject_)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="511"><td class="num" id="LN511">511</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>cast(TValue *, p)<span class='macro_popup'>((TValue *)(p))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="512"><td class="num" id="LN512">512</td><td class="line">  <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="513"><td class="num" id="LN513">513</td><td class="line">    TValue k;</td></tr>
<tr class="codeline" data-linenumber="514"><td class="num" id="LN514">514</td><td class="line">    <span class='macro'>setnvalue(&amp;k, cast_num(key))<span class='macro_popup'>{ TValue *i_o=(&amp;k); i_o-&gt;value.n=(((lua_Number)((key))<br>)); i_o-&gt;tt=3; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="515"><td class="num" id="LN515">515</td><td class="line">    <span class='keyword'>return</span> newkey(L, t, &amp;k);</td></tr>
<tr class="codeline" data-linenumber="516"><td class="num" id="LN516">516</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="517"><td class="num" id="LN517">517</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="518"><td class="num" id="LN518">518</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="519"><td class="num" id="LN519">519</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="520"><td class="num" id="LN520">520</td><td class="line">TValue *luaH_setstr (lua_State *L, Table *t, TString *key) {</td></tr>
<tr class="codeline" data-linenumber="521"><td class="num" id="LN521">521</td><td class="line">  <span class='keyword'>const</span> TValue *p = luaH_getstr(t, key);</td></tr>
<tr class="codeline" data-linenumber="522"><td class="num" id="LN522">522</td><td class="line">  <span class='keyword'>if</span> (p != <span class='macro'>luaO_nilobject<span class='macro_popup'>(&amp;luaO_nilobject_)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="523"><td class="num" id="LN523">523</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>cast(TValue *, p)<span class='macro_popup'>((TValue *)(p))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="524"><td class="num" id="LN524">524</td><td class="line">  <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="525"><td class="num" id="LN525">525</td><td class="line">    TValue k;</td></tr>
<tr class="codeline" data-linenumber="526"><td class="num" id="LN526">526</td><td class="line">    <span class='macro'>setsvalue(L, &amp;k, key)<span class='macro_popup'>{ TValue *i_o=(&amp;k); i_o-&gt;value.gc=((GCObject *)((key))<br>); i_o-&gt;tt=4; ((void)0); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="527"><td class="num" id="LN527">527</td><td class="line">    <span class='keyword'>return</span> newkey(L, t, &amp;k);</td></tr>
<tr class="codeline" data-linenumber="528"><td class="num" id="LN528">528</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="529"><td class="num" id="LN529">529</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="530"><td class="num" id="LN530">530</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="531"><td class="num" id="LN531">531</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="532"><td class="num" id="LN532">532</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> unbound_search (Table *t, <span class='keyword'>unsigned</span> <span class='keyword'>int</span> j) {</td></tr>
<tr class="codeline" data-linenumber="533"><td class="num" id="LN533">533</td><td class="line">  <span class='keyword'>unsigned</span> <span class='keyword'>int</span> i = j;  <span class='comment'>/* i is zero or a present index */</span></td></tr>
<tr class="codeline" data-linenumber="534"><td class="num" id="LN534">534</td><td class="line">  j++;</td></tr>
<tr class="codeline" data-linenumber="535"><td class="num" id="LN535">535</td><td class="line">  <span class='comment'>/* find `i' and `j' such that i is present and j is not */</span></td></tr>
<tr class="codeline" data-linenumber="536"><td class="num" id="LN536">536</td><td class="line">  <span class='keyword'>while</span> (!<span class='macro'>ttisnil(luaH_getnum(t, j))<span class='macro_popup'>(((luaH_getnum(t, j))-&gt;tt) == 0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="537"><td class="num" id="LN537">537</td><td class="line">    i = j;</td></tr>
<tr class="codeline" data-linenumber="538"><td class="num" id="LN538">538</td><td class="line">    j *= 2;</td></tr>
<tr class="codeline" data-linenumber="539"><td class="num" id="LN539">539</td><td class="line">    <span class='keyword'>if</span> (j &gt; <span class='macro'>cast(<span class='keyword'>unsigned</span> <span class='keyword'>int</span>, MAX_INT)<span class='macro_popup'>((unsigned int)((2147483647 -2)))</span></span>) {  <span class='comment'>/* overflow? */</span></td></tr>
<tr class="codeline" data-linenumber="540"><td class="num" id="LN540">540</td><td class="line">      <span class='comment'>/* table was built with bad purposes: resort to linear search */</span></td></tr>
<tr class="codeline" data-linenumber="541"><td class="num" id="LN541">541</td><td class="line">      i = 1;</td></tr>
<tr class="codeline" data-linenumber="542"><td class="num" id="LN542">542</td><td class="line">      <span class='keyword'>while</span> (!<span class='macro'>ttisnil(luaH_getnum(t, i))<span class='macro_popup'>(((luaH_getnum(t, i))-&gt;tt) == 0)</span></span>) i++;</td></tr>
<tr class="codeline" data-linenumber="543"><td class="num" id="LN543">543</td><td class="line">      <span class='keyword'>return</span> i - 1;</td></tr>
<tr class="codeline" data-linenumber="544"><td class="num" id="LN544">544</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="545"><td class="num" id="LN545">545</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="546"><td class="num" id="LN546">546</td><td class="line">  <span class='comment'>/* now do a binary search between them */</span></td></tr>
<tr class="codeline" data-linenumber="547"><td class="num" id="LN547">547</td><td class="line">  <span class='keyword'>while</span> (j - i &gt; 1) {</td></tr>
<tr class="codeline" data-linenumber="548"><td class="num" id="LN548">548</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> m = (i+j)/2;</td></tr>
<tr class="codeline" data-linenumber="549"><td class="num" id="LN549">549</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>ttisnil(luaH_getnum(t, m))<span class='macro_popup'>(((luaH_getnum(t, m))-&gt;tt) == 0)</span></span>) j = m;</td></tr>
<tr class="codeline" data-linenumber="550"><td class="num" id="LN550">550</td><td class="line">    <span class='keyword'>else</span> i = m;</td></tr>
<tr class="codeline" data-linenumber="551"><td class="num" id="LN551">551</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="552"><td class="num" id="LN552">552</td><td class="line">  <span class='keyword'>return</span> i;</td></tr>
<tr class="codeline" data-linenumber="553"><td class="num" id="LN553">553</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="554"><td class="num" id="LN554">554</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="555"><td class="num" id="LN555">555</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="556"><td class="num" id="LN556">556</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="557"><td class="num" id="LN557">557</td><td class="line"><span class='comment'>** Try to find a boundary in table `t'. A `boundary' is an integer index</span></td></tr>
<tr class="codeline" data-linenumber="558"><td class="num" id="LN558">558</td><td class="line"><span class='comment'>** such that t[i] is non-nil and t[i+1] is nil (and 0 if t[1] is nil).</span></td></tr>
<tr class="codeline" data-linenumber="559"><td class="num" id="LN559">559</td><td class="line"><span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="560"><td class="num" id="LN560">560</td><td class="line"><span class='keyword'>int</span> luaH_getn (Table *t) {</td></tr>
<tr class="codeline" data-linenumber="561"><td class="num" id="LN561">561</td><td class="line">  <span class='keyword'>unsigned</span> <span class='keyword'>int</span> j = t-&gt;sizearray;</td></tr>
<tr class="codeline" data-linenumber="562"><td class="num" id="LN562">562</td><td class="line">  <span class='keyword'>if</span> (j &gt; 0 &amp;&amp; <span class='macro'>ttisnil(&amp;t-&gt;array[j - 1])<span class='macro_popup'>(((&amp;t-&gt;array[j - 1])-&gt;tt) == 0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="563"><td class="num" id="LN563">563</td><td class="line">    <span class='comment'>/* there is a boundary in the array part: (binary) search for it */</span></td></tr>
<tr class="codeline" data-linenumber="564"><td class="num" id="LN564">564</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> i = 0;</td></tr>
<tr class="codeline" data-linenumber="565"><td class="num" id="LN565">565</td><td class="line">    <span class='keyword'>while</span> (j - i &gt; 1) {</td></tr>
<tr class="codeline" data-linenumber="566"><td class="num" id="LN566">566</td><td class="line">      <span class='keyword'>unsigned</span> <span class='keyword'>int</span> m = (i+j)/2;</td></tr>
<tr class="codeline" data-linenumber="567"><td class="num" id="LN567">567</td><td class="line">      <span class='keyword'>if</span> (<span class='macro'>ttisnil(&amp;t-&gt;array[m - 1])<span class='macro_popup'>(((&amp;t-&gt;array[m - 1])-&gt;tt) == 0)</span></span>) j = m;</td></tr>
<tr class="codeline" data-linenumber="568"><td class="num" id="LN568">568</td><td class="line">      <span class='keyword'>else</span> i = m;</td></tr>
<tr class="codeline" data-linenumber="569"><td class="num" id="LN569">569</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="570"><td class="num" id="LN570">570</td><td class="line">    <span class='keyword'>return</span> i;</td></tr>
<tr class="codeline" data-linenumber="571"><td class="num" id="LN571">571</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="572"><td class="num" id="LN572">572</td><td class="line">  <span class='comment'>/* else must find a boundary in hash part */</span></td></tr>
<tr class="codeline" data-linenumber="573"><td class="num" id="LN573">573</td><td class="line">  <span class='keyword'>else</span> <span class='keyword'>if</span> (t-&gt;node == <span class='macro'>dummynode<span class='macro_popup'>(&amp;dummynode_)</span></span>)  <span class='comment'>/* hash part is empty? */</span></td></tr>
<tr class="codeline" data-linenumber="574"><td class="num" id="LN574">574</td><td class="line">    <span class='keyword'>return</span> j;  <span class='comment'>/* that is easy... */</span></td></tr>
<tr class="codeline" data-linenumber="575"><td class="num" id="LN575">575</td><td class="line">  <span class='keyword'>else</span> <span class='keyword'>return</span> unbound_search(t, j);</td></tr>
<tr class="codeline" data-linenumber="576"><td class="num" id="LN576">576</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="577"><td class="num" id="LN577">577</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="578"><td class="num" id="LN578">578</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="579"><td class="num" id="LN579">579</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="580"><td class="num" id="LN580">580</td><td class="line"><span class='directive'>#if defined(LUA_DEBUG)</span></td></tr>
<tr class="codeline" data-linenumber="581"><td class="num" id="LN581">581</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="582"><td class="num" id="LN582">582</td><td class="line">Node *luaH_mainposition (<span class='keyword'>const</span> Table *t, <span class='keyword'>const</span> TValue *key) {</td></tr>
<tr class="codeline" data-linenumber="583"><td class="num" id="LN583">583</td><td class="line">  <span class='keyword'>return</span> mainposition(t, key);</td></tr>
<tr class="codeline" data-linenumber="584"><td class="num" id="LN584">584</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="585"><td class="num" id="LN585">585</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="586"><td class="num" id="LN586">586</td><td class="line"><span class='keyword'>int</span> luaH_isdummy (Node *n) { <span class='keyword'>return</span> n == <span class='macro'>dummynode<span class='macro_popup'>(&amp;dummynode_)</span></span>; }</td></tr>
<tr class="codeline" data-linenumber="587"><td class="num" id="LN587">587</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="588"><td class="num" id="LN588">588</td><td class="line"><span class='directive'>#endif</span></td></tr>
</table></body></html>
