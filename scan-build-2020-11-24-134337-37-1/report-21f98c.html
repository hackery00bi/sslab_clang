<!doctype html>
<html>
<head>
<title>server.c</title>

<style type="text/css">
body { color:#000000; background-color:#ffffff }
body { font-family:Helvetica, sans-serif; font-size:10pt }
h1 { font-size:14pt }
.FileName { margin-top: 5px; margin-bottom: 5px; display: inline; }
.FileNav { margin-left: 5px; margin-right: 5px; display: inline; }
.FileNav a { text-decoration:none; font-size: larger; }
.divider { margin-top: 30px; margin-bottom: 30px; height: 15px; }
.divider { background-color: gray; }
.code { border-collapse:collapse; width:100%; }
.code { font-family: "Monospace", monospace; font-size:10pt }
.code { line-height: 1.2em }
.comment { color: green; font-style: oblique }
.keyword { color: blue }
.string_literal { color: red }
.directive { color: darkmagenta }

/* Macros and variables could have pop-up notes hidden by default.
  - Macro pop-up:    expansion of the macro
  - Variable pop-up: value (table) of the variable */
.macro_popup, .variable_popup { display: none; }

/* Pop-up appears on mouse-hover event. */
.macro:hover .macro_popup, .variable:hover .variable_popup {
  display: block;
  padding: 2px;
  -webkit-border-radius:5px;
  -webkit-box-shadow:1px 1px 7px #000;
  border-radius:5px;
  box-shadow:1px 1px 7px #000;
  position: absolute;
  top: -1em;
  left:10em;
  z-index: 1
}

.macro_popup {
  border: 2px solid red;
  background-color:#FFF0F0;
  font-weight: normal;
}

.variable_popup {
  border: 2px solid blue;
  background-color:#F0F0FF;
  font-weight: bold;
  font-family: Helvetica, sans-serif;
  font-size: 9pt;
}

/* Pop-up notes needs a relative position as a base where they pops up. */
.macro, .variable {
  background-color: PaleGoldenRod;
  position: relative;
}
.macro { color: DarkMagenta; }

#tooltiphint {
  position: fixed;
  width: 50em;
  margin-left: -25em;
  left: 50%;
  padding: 10px;
  border: 1px solid #b0b0b0;
  border-radius: 2px;
  box-shadow: 1px 1px 7px black;
  background-color: #c0c0c0;
  z-index: 2;
}

.num { width:2.5em; padding-right:2ex; background-color:#eeeeee }
.num { text-align:right; font-size:8pt }
.num { color:#444444 }
.line { padding-left: 1ex; border-left: 3px solid #ccc }
.line { white-space: pre }
.msg { -webkit-box-shadow:1px 1px 7px #000 }
.msg { box-shadow:1px 1px 7px #000 }
.msg { -webkit-border-radius:5px }
.msg { border-radius:5px }
.msg { font-family:Helvetica, sans-serif; font-size:8pt }
.msg { float:left }
.msg { padding:0.25em 1ex 0.25em 1ex }
.msg { margin-top:10px; margin-bottom:10px }
.msg { font-weight:bold }
.msg { max-width:60em; word-wrap: break-word; white-space: pre-wrap }
.msgT { padding:0x; spacing:0x }
.msgEvent { background-color:#fff8b4; color:#000000 }
.msgControl { background-color:#bbbbbb; color:#000000 }
.msgNote { background-color:#ddeeff; color:#000000 }
.mrange { background-color:#dfddf3 }
.mrange { border-bottom:1px solid #6F9DBE }
.PathIndex { font-weight: bold; padding:0px 5px; margin-right:5px; }
.PathIndex { -webkit-border-radius:8px }
.PathIndex { border-radius:8px }
.PathIndexEvent { background-color:#bfba87 }
.PathIndexControl { background-color:#8c8c8c }
.PathIndexPopUp { background-color: #879abc; }
.PathNav a { text-decoration:none; font-size: larger }
.CodeInsertionHint { font-weight: bold; background-color: #10dd10 }
.CodeRemovalHint { background-color:#de1010 }
.CodeRemovalHint { border-bottom:1px solid #6F9DBE }
.selected{ background-color:orange !important; }

table.simpletable {
  padding: 5px;
  font-size:12pt;
  margin:20px;
  border-collapse: collapse; border-spacing: 0px;
}
td.rowname {
  text-align: right;
  vertical-align: top;
  font-weight: bold;
  color:#444444;
  padding-right:2ex;
}

/* Hidden text. */
input.spoilerhider + label {
  cursor: pointer;
  text-decoration: underline;
  display: block;
}
input.spoilerhider {
 display: none;
}
input.spoilerhider ~ .spoiler {
  overflow: hidden;
  margin: 10px auto 0;
  height: 0;
  opacity: 0;
}
input.spoilerhider:checked + label + .spoiler{
  height: auto;
  opacity: 1;
}
</style>
</head>
<body>
<!-- BUGDESC Call to function 'memset' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memset_s' in case of C11 -->

<!-- BUGTYPE Potential insecure memory buffer bounds restriction in call 'memset' -->

<!-- BUGCATEGORY Security -->

<!-- BUGFILE /tmp/sslab_clang/c_redis/redis/src/server.c -->

<!-- FILENAME server.c -->

<!-- FUNCTIONNAME initServerConfig -->

<!-- ISSUEHASHCONTENTOFLINEINCONTEXT a8f62878466839c3235074bb043cfdeb -->

<!-- BUGLINE 2380 -->

<!-- BUGCOLUMN 5 -->

<!-- BUGPATHLENGTH 1 -->

<!-- BUGMETAEND -->
<!-- REPORTHEADER -->
<h3>Bug Summary</h3>
<table class="simpletable">
<tr><td class="rowname">File:</td><td>src/server.c</td></tr>
<tr><td class="rowname">Warning:</td><td><a href="#EndPath">line 2380, column 5</a><br />Call to function 'memset' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memset_s' in case of C11</td></tr>

</table>
<!-- REPORTSUMMARYEXTRA -->
<h3>Annotated Source Code</h3>
<p>Press <a href="#" onclick="toggleHelp(); return false;">'?'</a>
   to see keyboard shortcuts</p>
<input type="checkbox" class="spoilerhider" id="showinvocation" />
<label for="showinvocation" >Show analyzer invocation</label>
<div class="spoiler">clang -cc1 -cc1 -triple x86_64-unknown-linux-gnu -analyze -disable-free -main-file-name server.c -analyzer-store=region -analyzer-opt-analyze-nested-blocks -analyzer-checker=core -analyzer-checker=apiModeling -analyzer-checker=unix -analyzer-checker=deadcode -analyzer-checker=security.insecureAPI.UncheckedReturn -analyzer-checker=security.insecureAPI.getpw -analyzer-checker=security.insecureAPI.gets -analyzer-checker=security.insecureAPI.mktemp -analyzer-checker=security.insecureAPI.mkstemp -analyzer-checker=security.insecureAPI.vfork -analyzer-checker=nullability.NullPassedToNonnull -analyzer-checker=nullability.NullReturnedFromNonnull -analyzer-output plist -w -setup-static-analyzer -mrelocation-model static -mframe-pointer=none -fmath-errno -fno-rounding-math -mconstructor-aliases -munwind-tables -target-cpu x86-64 -fno-split-dwarf-inlining -debugger-tuning=gdb -resource-dir /llvm-project/build/lib/clang/12.0.0 -D REDIS_STATIC= -I ../deps/hiredis -I ../deps/linenoise -I ../deps/lua/src -D USE_JEMALLOC -I ../deps/jemalloc/include -internal-isystem /usr/local/include -internal-isystem /llvm-project/build/lib/clang/12.0.0/include -internal-externc-isystem /usr/include/x86_64-linux-gnu -internal-externc-isystem /include -internal-externc-isystem /usr/include -O2 -Wno-missing-field-initializers -std=c11 -fdebug-compilation-dir /tmp/sslab_clang/c_redis/redis/src -ferror-limit 19 -fgnuc-version=4.2.1 -vectorize-loops -vectorize-slp -analyzer-checker core -analyzer-checker cplusplus -analyzer-checker nullability -analyzer-checker optin -analyzer-checker security -analyzer-checker unix -analyzer-checker osx -analyzer-checker fuchsia -analyzer-checker webkit -analyzer-output=html -faddrsig -o /tmp/scan-build-2020-11-24-134337-37-1 -x c server.c
</div>
<div id='tooltiphint' hidden="true">
  <p>Keyboard shortcuts: </p>
  <ul>
    <li>Use 'j/k' keys for keyboard navigation</li>
    <li>Use 'Shift+S' to show/hide relevant lines</li>
    <li>Use '?' to toggle this window</li>
  </ul>
  <a href="#" onclick="toggleHelp(); return false;">Close</a>
</div>
<script type='text/javascript'>
var relevant_lines = {"1": {"2380": 1}};

var filterCounterexample = function (hide) {
  var tables = document.getElementsByClassName("code");
  for (var t=0; t<tables.length; t++) {
    var table = tables[t];
    var file_id = table.getAttribute("data-fileid");
    var lines_in_fid = relevant_lines[file_id];
    if (!lines_in_fid) {
      lines_in_fid = {};
    }
    var lines = table.getElementsByClassName("codeline");
    for (var i=0; i<lines.length; i++) {
        var el = lines[i];
        var lineNo = el.getAttribute("data-linenumber");
        if (!lines_in_fid[lineNo]) {
          if (hide) {
            el.setAttribute("hidden", "");
          } else {
            el.removeAttribute("hidden");
          }
        }
    }
  }
}

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "S") {
    var checked = document.getElementsByName("showCounterexample")[0].checked;
    filterCounterexample(!checked);
    document.getElementsByName("showCounterexample")[0].checked = !checked;
  } else {
    return;
  }
  event.preventDefault();
}, true);

document.addEventListener("DOMContentLoaded", function() {
    document.querySelector('input[name="showCounterexample"]').onchange=
        function (event) {
      filterCounterexample(this.checked);
    };
});
</script>

<form>
    <input type="checkbox" name="showCounterexample" id="showCounterexample" />
    <label for="showCounterexample">
       Show only relevant lines
    </label>
</form>

<script type='text/javascript'>
var digitMatcher = new RegExp("[0-9]+");

var querySelectorAllArray = function(selector) {
  return Array.prototype.slice.call(
    document.querySelectorAll(selector));
}

document.addEventListener("DOMContentLoaded", function() {
    querySelectorAllArray(".PathNav > a").forEach(
        function(currentValue, currentIndex) {
            var hrefValue = currentValue.getAttribute("href");
            currentValue.onclick = function() {
                scrollTo(document.querySelector(hrefValue));
                return false;
            };
        });
});

var findNum = function() {
    var s = document.querySelector(".selected");
    if (!s || s.id == "EndPath") {
        return 0;
    }
    var out = parseInt(digitMatcher.exec(s.id)[0]);
    return out;
};

var scrollTo = function(el) {
    querySelectorAllArray(".selected").forEach(function(s) {
        s.classList.remove("selected");
    });
    el.classList.add("selected");
    window.scrollBy(0, el.getBoundingClientRect().top -
        (window.innerHeight / 2));
}

var move = function(num, up, numItems) {
  if (num == 1 && up || num == numItems - 1 && !up) {
    return 0;
  } else if (num == 0 && up) {
    return numItems - 1;
  } else if (num == 0 && !up) {
    return 1 % numItems;
  }
  return up ? num - 1 : num + 1;
}

var numToId = function(num) {
  if (num == 0) {
    return document.getElementById("EndPath")
  }
  return document.getElementById("Path" + num);
};

var navigateTo = function(up) {
  var numItems = document.querySelectorAll(
      ".line > .msgEvent, .line > .msgControl").length;
  var currentSelected = findNum();
  var newSelected = move(currentSelected, up, numItems);
  var newEl = numToId(newSelected, numItems);

  // Scroll element into center.
  scrollTo(newEl);
};

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "j") {
    navigateTo(/*up=*/false);
  } else if (event.key == "k") {
    navigateTo(/*up=*/true);
  } else {
    return;
  }
  event.preventDefault();
}, true);
</script>
  
<script type='text/javascript'>

var toggleHelp = function() {
    var hint = document.querySelector("#tooltiphint");
    var attributeName = "hidden";
    if (hint.hasAttribute(attributeName)) {
      hint.removeAttribute(attributeName);
    } else {
      hint.setAttribute("hidden", "true");
    }
};
window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "?") {
    toggleHelp();
  } else {
    return;
  }
  event.preventDefault();
});
</script>
<table class="code" data-fileid="1">
<tr class="codeline" data-linenumber="1"><td class="num" id="LN1">1</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2"><td class="num" id="LN2">2</td><td class="line"> <span class='comment'>* Copyright (c) 2009-2016, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;</span></td></tr>
<tr class="codeline" data-linenumber="3"><td class="num" id="LN3">3</td><td class="line"> <span class='comment'>* All rights reserved.</span></td></tr>
<tr class="codeline" data-linenumber="4"><td class="num" id="LN4">4</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="5"><td class="num" id="LN5">5</td><td class="line"> <span class='comment'>* Redistribution and use in source and binary forms, with or without</span></td></tr>
<tr class="codeline" data-linenumber="6"><td class="num" id="LN6">6</td><td class="line"> <span class='comment'>* modification, are permitted provided that the following conditions are met:</span></td></tr>
<tr class="codeline" data-linenumber="7"><td class="num" id="LN7">7</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="8"><td class="num" id="LN8">8</td><td class="line"> <span class='comment'>*   * Redistributions of source code must retain the above copyright notice,</span></td></tr>
<tr class="codeline" data-linenumber="9"><td class="num" id="LN9">9</td><td class="line"> <span class='comment'>*     this list of conditions and the following disclaimer.</span></td></tr>
<tr class="codeline" data-linenumber="10"><td class="num" id="LN10">10</td><td class="line"> <span class='comment'>*   * Redistributions in binary form must reproduce the above copyright</span></td></tr>
<tr class="codeline" data-linenumber="11"><td class="num" id="LN11">11</td><td class="line"> <span class='comment'>*     notice, this list of conditions and the following disclaimer in the</span></td></tr>
<tr class="codeline" data-linenumber="12"><td class="num" id="LN12">12</td><td class="line"> <span class='comment'>*     documentation and/or other materials provided with the distribution.</span></td></tr>
<tr class="codeline" data-linenumber="13"><td class="num" id="LN13">13</td><td class="line"> <span class='comment'>*   * Neither the name of Redis nor the names of its contributors may be used</span></td></tr>
<tr class="codeline" data-linenumber="14"><td class="num" id="LN14">14</td><td class="line"> <span class='comment'>*     to endorse or promote products derived from this software without</span></td></tr>
<tr class="codeline" data-linenumber="15"><td class="num" id="LN15">15</td><td class="line"> <span class='comment'>*     specific prior written permission.</span></td></tr>
<tr class="codeline" data-linenumber="16"><td class="num" id="LN16">16</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="17"><td class="num" id="LN17">17</td><td class="line"> <span class='comment'>* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"</span></td></tr>
<tr class="codeline" data-linenumber="18"><td class="num" id="LN18">18</td><td class="line"> <span class='comment'>* AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span></td></tr>
<tr class="codeline" data-linenumber="19"><td class="num" id="LN19">19</td><td class="line"> <span class='comment'>* IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span></td></tr>
<tr class="codeline" data-linenumber="20"><td class="num" id="LN20">20</td><td class="line"> <span class='comment'>* ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span></td></tr>
<tr class="codeline" data-linenumber="21"><td class="num" id="LN21">21</td><td class="line"> <span class='comment'>* LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span></td></tr>
<tr class="codeline" data-linenumber="22"><td class="num" id="LN22">22</td><td class="line"> <span class='comment'>* CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span></td></tr>
<tr class="codeline" data-linenumber="23"><td class="num" id="LN23">23</td><td class="line"> <span class='comment'>* SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span></td></tr>
<tr class="codeline" data-linenumber="24"><td class="num" id="LN24">24</td><td class="line"> <span class='comment'>* INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span></td></tr>
<tr class="codeline" data-linenumber="25"><td class="num" id="LN25">25</td><td class="line"> <span class='comment'>* CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span></td></tr>
<tr class="codeline" data-linenumber="26"><td class="num" id="LN26">26</td><td class="line"> <span class='comment'>* ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span></td></tr>
<tr class="codeline" data-linenumber="27"><td class="num" id="LN27">27</td><td class="line"> <span class='comment'>* POSSIBILITY OF SUCH DAMAGE.</span></td></tr>
<tr class="codeline" data-linenumber="28"><td class="num" id="LN28">28</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="29"><td class="num" id="LN29">29</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="30"><td class="num" id="LN30">30</td><td class="line"><span class='directive'>#include "server.h"</span></td></tr>
<tr class="codeline" data-linenumber="31"><td class="num" id="LN31">31</td><td class="line"><span class='directive'>#include "cluster.h"</span></td></tr>
<tr class="codeline" data-linenumber="32"><td class="num" id="LN32">32</td><td class="line"><span class='directive'>#include "slowlog.h"</span></td></tr>
<tr class="codeline" data-linenumber="33"><td class="num" id="LN33">33</td><td class="line"><span class='directive'>#include "bio.h"</span></td></tr>
<tr class="codeline" data-linenumber="34"><td class="num" id="LN34">34</td><td class="line"><span class='directive'>#include "latency.h"</span></td></tr>
<tr class="codeline" data-linenumber="35"><td class="num" id="LN35">35</td><td class="line"><span class='directive'>#include "atomicvar.h"</span></td></tr>
<tr class="codeline" data-linenumber="36"><td class="num" id="LN36">36</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="37"><td class="num" id="LN37">37</td><td class="line"><span class='directive'>#include &lt;time.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="38"><td class="num" id="LN38">38</td><td class="line"><span class='directive'>#include &lt;signal.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="39"><td class="num" id="LN39">39</td><td class="line"><span class='directive'>#include &lt;sys/wait.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="40"><td class="num" id="LN40">40</td><td class="line"><span class='directive'>#include &lt;<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="41"><td class="num" id="LN41">41</td><td class="line"><span class='directive'>#include &lt;assert.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="42"><td class="num" id="LN42">42</td><td class="line"><span class='directive'>#include &lt;ctype.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="43"><td class="num" id="LN43">43</td><td class="line"><span class='directive'>#include &lt;stdarg.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="44"><td class="num" id="LN44">44</td><td class="line"><span class='directive'>#include &lt;arpa/inet.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="45"><td class="num" id="LN45">45</td><td class="line"><span class='directive'>#include &lt;sys/stat.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="46"><td class="num" id="LN46">46</td><td class="line"><span class='directive'>#include &lt;fcntl.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="47"><td class="num" id="LN47">47</td><td class="line"><span class='directive'>#include &lt;sys/time.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="48"><td class="num" id="LN48">48</td><td class="line"><span class='directive'>#include &lt;sys/resource.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="49"><td class="num" id="LN49">49</td><td class="line"><span class='directive'>#include &lt;sys/uio.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="50"><td class="num" id="LN50">50</td><td class="line"><span class='directive'>#include &lt;sys/un.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="51"><td class="num" id="LN51">51</td><td class="line"><span class='directive'>#include &lt;limits.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="52"><td class="num" id="LN52">52</td><td class="line"><span class='directive'>#include &lt;float.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="53"><td class="num" id="LN53">53</td><td class="line"><span class='directive'>#include &lt;math.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="54"><td class="num" id="LN54">54</td><td class="line"><span class='directive'>#include &lt;sys/resource.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="55"><td class="num" id="LN55">55</td><td class="line"><span class='directive'>#include &lt;sys/utsname.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="56"><td class="num" id="LN56">56</td><td class="line"><span class='directive'>#include &lt;locale.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="57"><td class="num" id="LN57">57</td><td class="line"><span class='directive'>#include &lt;sys/socket.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="58"><td class="num" id="LN58">58</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="59"><td class="num" id="LN59">59</td><td class="line"><span class='comment'>/* Our shared "common" objects */</span></td></tr>
<tr class="codeline" data-linenumber="60"><td class="num" id="LN60">60</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="61"><td class="num" id="LN61">61</td><td class="line"><span class='keyword'>struct</span> sharedObjectsStruct shared;</td></tr>
<tr class="codeline" data-linenumber="62"><td class="num" id="LN62">62</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="63"><td class="num" id="LN63">63</td><td class="line"><span class='comment'>/* Global vars that are actually used as constants. The following double</span></td></tr>
<tr class="codeline" data-linenumber="64"><td class="num" id="LN64">64</td><td class="line"> <span class='comment'>* values are used for double on-disk serialization, and are initialized</span></td></tr>
<tr class="codeline" data-linenumber="65"><td class="num" id="LN65">65</td><td class="line"> <span class='comment'>* at runtime to avoid strange compiler optimizations. */</span></td></tr>
<tr class="codeline" data-linenumber="66"><td class="num" id="LN66">66</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="67"><td class="num" id="LN67">67</td><td class="line"><span class='keyword'>double</span> R_Zero, R_PosInf, R_NegInf, R_Nan;</td></tr>
<tr class="codeline" data-linenumber="68"><td class="num" id="LN68">68</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="69"><td class="num" id="LN69">69</td><td class="line"><span class='comment'>/*================================= Globals ================================= */</span></td></tr>
<tr class="codeline" data-linenumber="70"><td class="num" id="LN70">70</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="71"><td class="num" id="LN71">71</td><td class="line"><span class='comment'>/* Global vars */</span></td></tr>
<tr class="codeline" data-linenumber="72"><td class="num" id="LN72">72</td><td class="line"><span class='keyword'>struct</span> redisServer server; <span class='comment'>/* Server global state */</span></td></tr>
<tr class="codeline" data-linenumber="73"><td class="num" id="LN73">73</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="74"><td class="num" id="LN74">74</td><td class="line"><span class='comment'>/* Our command table.</span></td></tr>
<tr class="codeline" data-linenumber="75"><td class="num" id="LN75">75</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="76"><td class="num" id="LN76">76</td><td class="line"> <span class='comment'>* Every entry is composed of the following fields:</span></td></tr>
<tr class="codeline" data-linenumber="77"><td class="num" id="LN77">77</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="78"><td class="num" id="LN78">78</td><td class="line"> <span class='comment'>* name:        A string representing the command name.</span></td></tr>
<tr class="codeline" data-linenumber="79"><td class="num" id="LN79">79</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="80"><td class="num" id="LN80">80</td><td class="line"> <span class='comment'>* function:    Pointer to the C function implementing the command.</span></td></tr>
<tr class="codeline" data-linenumber="81"><td class="num" id="LN81">81</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="82"><td class="num" id="LN82">82</td><td class="line"> <span class='comment'>* arity:       Number of arguments, it is possible to use -N to say &gt;= N</span></td></tr>
<tr class="codeline" data-linenumber="83"><td class="num" id="LN83">83</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="84"><td class="num" id="LN84">84</td><td class="line"> <span class='comment'>* sflags:      Command flags as string. See below for a table of flags.</span></td></tr>
<tr class="codeline" data-linenumber="85"><td class="num" id="LN85">85</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="86"><td class="num" id="LN86">86</td><td class="line"> <span class='comment'>* flags:       Flags as bitmask. Computed by Redis using the 'sflags' field.</span></td></tr>
<tr class="codeline" data-linenumber="87"><td class="num" id="LN87">87</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="88"><td class="num" id="LN88">88</td><td class="line"> <span class='comment'>* get_keys_proc: An optional function to get key arguments from a command.</span></td></tr>
<tr class="codeline" data-linenumber="89"><td class="num" id="LN89">89</td><td class="line"> <span class='comment'>*                This is only used when the following three fields are not</span></td></tr>
<tr class="codeline" data-linenumber="90"><td class="num" id="LN90">90</td><td class="line"> <span class='comment'>*                enough to specify what arguments are keys.</span></td></tr>
<tr class="codeline" data-linenumber="91"><td class="num" id="LN91">91</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="92"><td class="num" id="LN92">92</td><td class="line"> <span class='comment'>* first_key_index: First argument that is a key</span></td></tr>
<tr class="codeline" data-linenumber="93"><td class="num" id="LN93">93</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="94"><td class="num" id="LN94">94</td><td class="line"> <span class='comment'>* last_key_index: Last argument that is a key</span></td></tr>
<tr class="codeline" data-linenumber="95"><td class="num" id="LN95">95</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="96"><td class="num" id="LN96">96</td><td class="line"> <span class='comment'>* key_step:    Step to get all the keys from first to last argument.</span></td></tr>
<tr class="codeline" data-linenumber="97"><td class="num" id="LN97">97</td><td class="line"> <span class='comment'>*              For instance in MSET the step is two since arguments</span></td></tr>
<tr class="codeline" data-linenumber="98"><td class="num" id="LN98">98</td><td class="line"> <span class='comment'>*              are key,val,key,val,...</span></td></tr>
<tr class="codeline" data-linenumber="99"><td class="num" id="LN99">99</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="100"><td class="num" id="LN100">100</td><td class="line"> <span class='comment'>* microseconds: Microseconds of total execution time for this command.</span></td></tr>
<tr class="codeline" data-linenumber="101"><td class="num" id="LN101">101</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="102"><td class="num" id="LN102">102</td><td class="line"> <span class='comment'>* calls:       Total number of calls of this command.</span></td></tr>
<tr class="codeline" data-linenumber="103"><td class="num" id="LN103">103</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="104"><td class="num" id="LN104">104</td><td class="line"> <span class='comment'>* id:          Command bit identifier for ACLs or other goals.</span></td></tr>
<tr class="codeline" data-linenumber="105"><td class="num" id="LN105">105</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="106"><td class="num" id="LN106">106</td><td class="line"> <span class='comment'>* The flags, microseconds and calls fields are computed by Redis and should</span></td></tr>
<tr class="codeline" data-linenumber="107"><td class="num" id="LN107">107</td><td class="line"> <span class='comment'>* always be set to zero.</span></td></tr>
<tr class="codeline" data-linenumber="108"><td class="num" id="LN108">108</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="109"><td class="num" id="LN109">109</td><td class="line"> <span class='comment'>* Command flags are expressed using space separated strings, that are turned</span></td></tr>
<tr class="codeline" data-linenumber="110"><td class="num" id="LN110">110</td><td class="line"> <span class='comment'>* into actual flags by the populateCommandTable() function.</span></td></tr>
<tr class="codeline" data-linenumber="111"><td class="num" id="LN111">111</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="112"><td class="num" id="LN112">112</td><td class="line"> <span class='comment'>* This is the meaning of the flags:</span></td></tr>
<tr class="codeline" data-linenumber="113"><td class="num" id="LN113">113</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="114"><td class="num" id="LN114">114</td><td class="line"> <span class='comment'>* write:       Write command (may modify the key space).</span></td></tr>
<tr class="codeline" data-linenumber="115"><td class="num" id="LN115">115</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="116"><td class="num" id="LN116">116</td><td class="line"> <span class='comment'>* read-only:   All the non special commands just reading from keys without</span></td></tr>
<tr class="codeline" data-linenumber="117"><td class="num" id="LN117">117</td><td class="line"> <span class='comment'>*              changing the content, or returning other information like</span></td></tr>
<tr class="codeline" data-linenumber="118"><td class="num" id="LN118">118</td><td class="line"> <span class='comment'>*              the TIME command. Special commands such administrative commands</span></td></tr>
<tr class="codeline" data-linenumber="119"><td class="num" id="LN119">119</td><td class="line"> <span class='comment'>*              or transaction related commands (multi, exec, discard, ...)</span></td></tr>
<tr class="codeline" data-linenumber="120"><td class="num" id="LN120">120</td><td class="line"> <span class='comment'>*              are not flagged as read-only commands, since they affect the</span></td></tr>
<tr class="codeline" data-linenumber="121"><td class="num" id="LN121">121</td><td class="line"> <span class='comment'>*              server or the connection in other ways.</span></td></tr>
<tr class="codeline" data-linenumber="122"><td class="num" id="LN122">122</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="123"><td class="num" id="LN123">123</td><td class="line"> <span class='comment'>* use-memory:  May increase memory usage once called. Don't allow if out</span></td></tr>
<tr class="codeline" data-linenumber="124"><td class="num" id="LN124">124</td><td class="line"> <span class='comment'>*              of memory.</span></td></tr>
<tr class="codeline" data-linenumber="125"><td class="num" id="LN125">125</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="126"><td class="num" id="LN126">126</td><td class="line"> <span class='comment'>* admin:       Administrative command, like SAVE or SHUTDOWN.</span></td></tr>
<tr class="codeline" data-linenumber="127"><td class="num" id="LN127">127</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="128"><td class="num" id="LN128">128</td><td class="line"> <span class='comment'>* pub-sub:     Pub/Sub related command.</span></td></tr>
<tr class="codeline" data-linenumber="129"><td class="num" id="LN129">129</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="130"><td class="num" id="LN130">130</td><td class="line"> <span class='comment'>* no-script:   Command not allowed in scripts.</span></td></tr>
<tr class="codeline" data-linenumber="131"><td class="num" id="LN131">131</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="132"><td class="num" id="LN132">132</td><td class="line"> <span class='comment'>* random:      Random command. Command is not deterministic, that is, the same</span></td></tr>
<tr class="codeline" data-linenumber="133"><td class="num" id="LN133">133</td><td class="line"> <span class='comment'>*              command with the same arguments, with the same key space, may</span></td></tr>
<tr class="codeline" data-linenumber="134"><td class="num" id="LN134">134</td><td class="line"> <span class='comment'>*              have different results. For instance SPOP and RANDOMKEY are</span></td></tr>
<tr class="codeline" data-linenumber="135"><td class="num" id="LN135">135</td><td class="line"> <span class='comment'>*              two random commands.</span></td></tr>
<tr class="codeline" data-linenumber="136"><td class="num" id="LN136">136</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="137"><td class="num" id="LN137">137</td><td class="line"> <span class='comment'>* to-sort:     Sort command output array if called from script, so that the</span></td></tr>
<tr class="codeline" data-linenumber="138"><td class="num" id="LN138">138</td><td class="line"> <span class='comment'>*              output is deterministic. When this flag is used (not always</span></td></tr>
<tr class="codeline" data-linenumber="139"><td class="num" id="LN139">139</td><td class="line"> <span class='comment'>*              possible), then the "random" flag is not needed.</span></td></tr>
<tr class="codeline" data-linenumber="140"><td class="num" id="LN140">140</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="141"><td class="num" id="LN141">141</td><td class="line"> <span class='comment'>* ok-loading:  Allow the command while loading the database.</span></td></tr>
<tr class="codeline" data-linenumber="142"><td class="num" id="LN142">142</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="143"><td class="num" id="LN143">143</td><td class="line"> <span class='comment'>* ok-stale:    Allow the command while a slave has stale data but is not</span></td></tr>
<tr class="codeline" data-linenumber="144"><td class="num" id="LN144">144</td><td class="line"> <span class='comment'>*              allowed to serve this data. Normally no command is accepted</span></td></tr>
<tr class="codeline" data-linenumber="145"><td class="num" id="LN145">145</td><td class="line"> <span class='comment'>*              in this condition but just a few.</span></td></tr>
<tr class="codeline" data-linenumber="146"><td class="num" id="LN146">146</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="147"><td class="num" id="LN147">147</td><td class="line"> <span class='comment'>* no-monitor:  Do not automatically propagate the command on MONITOR.</span></td></tr>
<tr class="codeline" data-linenumber="148"><td class="num" id="LN148">148</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="149"><td class="num" id="LN149">149</td><td class="line"> <span class='comment'>* no-slowlog:  Do not automatically propagate the command to the slowlog.</span></td></tr>
<tr class="codeline" data-linenumber="150"><td class="num" id="LN150">150</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="151"><td class="num" id="LN151">151</td><td class="line"> <span class='comment'>* cluster-asking: Perform an implicit ASKING for this command, so the</span></td></tr>
<tr class="codeline" data-linenumber="152"><td class="num" id="LN152">152</td><td class="line"> <span class='comment'>*              command will be accepted in cluster mode if the slot is marked</span></td></tr>
<tr class="codeline" data-linenumber="153"><td class="num" id="LN153">153</td><td class="line"> <span class='comment'>*              as 'importing'.</span></td></tr>
<tr class="codeline" data-linenumber="154"><td class="num" id="LN154">154</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="155"><td class="num" id="LN155">155</td><td class="line"> <span class='comment'>* fast:        Fast command: O(1) or O(log(N)) command that should never</span></td></tr>
<tr class="codeline" data-linenumber="156"><td class="num" id="LN156">156</td><td class="line"> <span class='comment'>*              delay its execution as long as the kernel scheduler is giving</span></td></tr>
<tr class="codeline" data-linenumber="157"><td class="num" id="LN157">157</td><td class="line"> <span class='comment'>*              us time. Note that commands that may trigger a DEL as a side</span></td></tr>
<tr class="codeline" data-linenumber="158"><td class="num" id="LN158">158</td><td class="line"> <span class='comment'>*              effect (like SET) are not fast commands.</span></td></tr>
<tr class="codeline" data-linenumber="159"><td class="num" id="LN159">159</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="160"><td class="num" id="LN160">160</td><td class="line"> <span class='comment'>* The following additional flags are only used in order to put commands</span></td></tr>
<tr class="codeline" data-linenumber="161"><td class="num" id="LN161">161</td><td class="line"> <span class='comment'>* in a specific ACL category. Commands can have multiple ACL categories.</span></td></tr>
<tr class="codeline" data-linenumber="162"><td class="num" id="LN162">162</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="163"><td class="num" id="LN163">163</td><td class="line"> <span class='comment'>* @keyspace, @read, @write, @set, @sortedset, @list, @hash, @string, @bitmap,</span></td></tr>
<tr class="codeline" data-linenumber="164"><td class="num" id="LN164">164</td><td class="line"> <span class='comment'>* @hyperloglog, @stream, @admin, @fast, @slow, @pubsub, @blocking, @dangerous,</span></td></tr>
<tr class="codeline" data-linenumber="165"><td class="num" id="LN165">165</td><td class="line"> <span class='comment'>* @connection, @transaction, @scripting, @geo.</span></td></tr>
<tr class="codeline" data-linenumber="166"><td class="num" id="LN166">166</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="167"><td class="num" id="LN167">167</td><td class="line"> <span class='comment'>* Note that:</span></td></tr>
<tr class="codeline" data-linenumber="168"><td class="num" id="LN168">168</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="169"><td class="num" id="LN169">169</td><td class="line"> <span class='comment'>* 1) The read-only flag implies the @read ACL category.</span></td></tr>
<tr class="codeline" data-linenumber="170"><td class="num" id="LN170">170</td><td class="line"> <span class='comment'>* 2) The write flag implies the @write ACL category.</span></td></tr>
<tr class="codeline" data-linenumber="171"><td class="num" id="LN171">171</td><td class="line"> <span class='comment'>* 3) The fast flag implies the @fast ACL category.</span></td></tr>
<tr class="codeline" data-linenumber="172"><td class="num" id="LN172">172</td><td class="line"> <span class='comment'>* 4) The admin flag implies the @admin and @dangerous ACL category.</span></td></tr>
<tr class="codeline" data-linenumber="173"><td class="num" id="LN173">173</td><td class="line"> <span class='comment'>* 5) The pub-sub flag implies the @pubsub ACL category.</span></td></tr>
<tr class="codeline" data-linenumber="174"><td class="num" id="LN174">174</td><td class="line"> <span class='comment'>* 6) The lack of fast flag implies the @slow ACL category.</span></td></tr>
<tr class="codeline" data-linenumber="175"><td class="num" id="LN175">175</td><td class="line"> <span class='comment'>* 7) The non obvious "keyspace" category includes the commands</span></td></tr>
<tr class="codeline" data-linenumber="176"><td class="num" id="LN176">176</td><td class="line"> <span class='comment'>*    that interact with keys without having anything to do with</span></td></tr>
<tr class="codeline" data-linenumber="177"><td class="num" id="LN177">177</td><td class="line"> <span class='comment'>*    specific data structures, such as: DEL, RENAME, MOVE, SELECT,</span></td></tr>
<tr class="codeline" data-linenumber="178"><td class="num" id="LN178">178</td><td class="line"> <span class='comment'>*    TYPE, EXPIRE*, PEXPIRE*, TTL, PTTL, ...</span></td></tr>
<tr class="codeline" data-linenumber="179"><td class="num" id="LN179">179</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="180"><td class="num" id="LN180">180</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="181"><td class="num" id="LN181">181</td><td class="line"><span class='keyword'>struct</span> redisCommand redisCommandTable[] = {</td></tr>
<tr class="codeline" data-linenumber="182"><td class="num" id="LN182">182</td><td class="line">    {<span class='string_literal'>"module"</span>,moduleCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="183"><td class="num" id="LN183">183</td><td class="line">     <span class='string_literal'>"admin no-script"</span>,</td></tr>
<tr class="codeline" data-linenumber="184"><td class="num" id="LN184">184</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="185"><td class="num" id="LN185">185</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="186"><td class="num" id="LN186">186</td><td class="line">    {<span class='string_literal'>"get"</span>,getCommand,2,</td></tr>
<tr class="codeline" data-linenumber="187"><td class="num" id="LN187">187</td><td class="line">     <span class='string_literal'>"read-only fast @string"</span>,</td></tr>
<tr class="codeline" data-linenumber="188"><td class="num" id="LN188">188</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="189"><td class="num" id="LN189">189</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="190"><td class="num" id="LN190">190</td><td class="line">    <span class='comment'>/* Note that we can't flag set as fast, since it may perform an</span></td></tr>
<tr class="codeline" data-linenumber="191"><td class="num" id="LN191">191</td><td class="line">     <span class='comment'>* implicit DEL of a large key. */</span></td></tr>
<tr class="codeline" data-linenumber="192"><td class="num" id="LN192">192</td><td class="line">    {<span class='string_literal'>"set"</span>,setCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="193"><td class="num" id="LN193">193</td><td class="line">     <span class='string_literal'>"write use-memory @string"</span>,</td></tr>
<tr class="codeline" data-linenumber="194"><td class="num" id="LN194">194</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="195"><td class="num" id="LN195">195</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="196"><td class="num" id="LN196">196</td><td class="line">    {<span class='string_literal'>"setnx"</span>,setnxCommand,3,</td></tr>
<tr class="codeline" data-linenumber="197"><td class="num" id="LN197">197</td><td class="line">     <span class='string_literal'>"write use-memory fast @string"</span>,</td></tr>
<tr class="codeline" data-linenumber="198"><td class="num" id="LN198">198</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="199"><td class="num" id="LN199">199</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="200"><td class="num" id="LN200">200</td><td class="line">    {<span class='string_literal'>"setex"</span>,setexCommand,4,</td></tr>
<tr class="codeline" data-linenumber="201"><td class="num" id="LN201">201</td><td class="line">     <span class='string_literal'>"write use-memory @string"</span>,</td></tr>
<tr class="codeline" data-linenumber="202"><td class="num" id="LN202">202</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="203"><td class="num" id="LN203">203</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="204"><td class="num" id="LN204">204</td><td class="line">    {<span class='string_literal'>"psetex"</span>,psetexCommand,4,</td></tr>
<tr class="codeline" data-linenumber="205"><td class="num" id="LN205">205</td><td class="line">     <span class='string_literal'>"write use-memory @string"</span>,</td></tr>
<tr class="codeline" data-linenumber="206"><td class="num" id="LN206">206</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="207"><td class="num" id="LN207">207</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="208"><td class="num" id="LN208">208</td><td class="line">    {<span class='string_literal'>"append"</span>,appendCommand,3,</td></tr>
<tr class="codeline" data-linenumber="209"><td class="num" id="LN209">209</td><td class="line">     <span class='string_literal'>"write use-memory fast @string"</span>,</td></tr>
<tr class="codeline" data-linenumber="210"><td class="num" id="LN210">210</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="211"><td class="num" id="LN211">211</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="212"><td class="num" id="LN212">212</td><td class="line">    {<span class='string_literal'>"strlen"</span>,strlenCommand,2,</td></tr>
<tr class="codeline" data-linenumber="213"><td class="num" id="LN213">213</td><td class="line">     <span class='string_literal'>"read-only fast @string"</span>,</td></tr>
<tr class="codeline" data-linenumber="214"><td class="num" id="LN214">214</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="215"><td class="num" id="LN215">215</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="216"><td class="num" id="LN216">216</td><td class="line">    {<span class='string_literal'>"del"</span>,delCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="217"><td class="num" id="LN217">217</td><td class="line">     <span class='string_literal'>"write @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="218"><td class="num" id="LN218">218</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,-1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="219"><td class="num" id="LN219">219</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="220"><td class="num" id="LN220">220</td><td class="line">    {<span class='string_literal'>"unlink"</span>,unlinkCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="221"><td class="num" id="LN221">221</td><td class="line">     <span class='string_literal'>"write fast @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="222"><td class="num" id="LN222">222</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,-1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="223"><td class="num" id="LN223">223</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="224"><td class="num" id="LN224">224</td><td class="line">    {<span class='string_literal'>"exists"</span>,existsCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="225"><td class="num" id="LN225">225</td><td class="line">     <span class='string_literal'>"read-only fast @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="226"><td class="num" id="LN226">226</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,-1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="227"><td class="num" id="LN227">227</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="228"><td class="num" id="LN228">228</td><td class="line">    {<span class='string_literal'>"setbit"</span>,setbitCommand,4,</td></tr>
<tr class="codeline" data-linenumber="229"><td class="num" id="LN229">229</td><td class="line">     <span class='string_literal'>"write use-memory @bitmap"</span>,</td></tr>
<tr class="codeline" data-linenumber="230"><td class="num" id="LN230">230</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="231"><td class="num" id="LN231">231</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="232"><td class="num" id="LN232">232</td><td class="line">    {<span class='string_literal'>"getbit"</span>,getbitCommand,3,</td></tr>
<tr class="codeline" data-linenumber="233"><td class="num" id="LN233">233</td><td class="line">     <span class='string_literal'>"read-only fast @bitmap"</span>,</td></tr>
<tr class="codeline" data-linenumber="234"><td class="num" id="LN234">234</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="235"><td class="num" id="LN235">235</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="236"><td class="num" id="LN236">236</td><td class="line">    {<span class='string_literal'>"bitfield"</span>,bitfieldCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="237"><td class="num" id="LN237">237</td><td class="line">     <span class='string_literal'>"write use-memory @bitmap"</span>,</td></tr>
<tr class="codeline" data-linenumber="238"><td class="num" id="LN238">238</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="239"><td class="num" id="LN239">239</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="240"><td class="num" id="LN240">240</td><td class="line">    {<span class='string_literal'>"bitfield_ro"</span>,bitfieldroCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="241"><td class="num" id="LN241">241</td><td class="line">     <span class='string_literal'>"read-only fast @bitmap"</span>,</td></tr>
<tr class="codeline" data-linenumber="242"><td class="num" id="LN242">242</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="243"><td class="num" id="LN243">243</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="244"><td class="num" id="LN244">244</td><td class="line">    {<span class='string_literal'>"setrange"</span>,setrangeCommand,4,</td></tr>
<tr class="codeline" data-linenumber="245"><td class="num" id="LN245">245</td><td class="line">     <span class='string_literal'>"write use-memory @string"</span>,</td></tr>
<tr class="codeline" data-linenumber="246"><td class="num" id="LN246">246</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="247"><td class="num" id="LN247">247</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="248"><td class="num" id="LN248">248</td><td class="line">    {<span class='string_literal'>"getrange"</span>,getrangeCommand,4,</td></tr>
<tr class="codeline" data-linenumber="249"><td class="num" id="LN249">249</td><td class="line">     <span class='string_literal'>"read-only @string"</span>,</td></tr>
<tr class="codeline" data-linenumber="250"><td class="num" id="LN250">250</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="251"><td class="num" id="LN251">251</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="252"><td class="num" id="LN252">252</td><td class="line">    {<span class='string_literal'>"substr"</span>,getrangeCommand,4,</td></tr>
<tr class="codeline" data-linenumber="253"><td class="num" id="LN253">253</td><td class="line">     <span class='string_literal'>"read-only @string"</span>,</td></tr>
<tr class="codeline" data-linenumber="254"><td class="num" id="LN254">254</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="255"><td class="num" id="LN255">255</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="256"><td class="num" id="LN256">256</td><td class="line">    {<span class='string_literal'>"incr"</span>,incrCommand,2,</td></tr>
<tr class="codeline" data-linenumber="257"><td class="num" id="LN257">257</td><td class="line">     <span class='string_literal'>"write use-memory fast @string"</span>,</td></tr>
<tr class="codeline" data-linenumber="258"><td class="num" id="LN258">258</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="259"><td class="num" id="LN259">259</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="260"><td class="num" id="LN260">260</td><td class="line">    {<span class='string_literal'>"decr"</span>,decrCommand,2,</td></tr>
<tr class="codeline" data-linenumber="261"><td class="num" id="LN261">261</td><td class="line">     <span class='string_literal'>"write use-memory fast @string"</span>,</td></tr>
<tr class="codeline" data-linenumber="262"><td class="num" id="LN262">262</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="263"><td class="num" id="LN263">263</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="264"><td class="num" id="LN264">264</td><td class="line">    {<span class='string_literal'>"mget"</span>,mgetCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="265"><td class="num" id="LN265">265</td><td class="line">     <span class='string_literal'>"read-only fast @string"</span>,</td></tr>
<tr class="codeline" data-linenumber="266"><td class="num" id="LN266">266</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,-1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="267"><td class="num" id="LN267">267</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="268"><td class="num" id="LN268">268</td><td class="line">    {<span class='string_literal'>"rpush"</span>,rpushCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="269"><td class="num" id="LN269">269</td><td class="line">     <span class='string_literal'>"write use-memory fast @list"</span>,</td></tr>
<tr class="codeline" data-linenumber="270"><td class="num" id="LN270">270</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="271"><td class="num" id="LN271">271</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="272"><td class="num" id="LN272">272</td><td class="line">    {<span class='string_literal'>"lpush"</span>,lpushCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="273"><td class="num" id="LN273">273</td><td class="line">     <span class='string_literal'>"write use-memory fast @list"</span>,</td></tr>
<tr class="codeline" data-linenumber="274"><td class="num" id="LN274">274</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="275"><td class="num" id="LN275">275</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="276"><td class="num" id="LN276">276</td><td class="line">    {<span class='string_literal'>"rpushx"</span>,rpushxCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="277"><td class="num" id="LN277">277</td><td class="line">     <span class='string_literal'>"write use-memory fast @list"</span>,</td></tr>
<tr class="codeline" data-linenumber="278"><td class="num" id="LN278">278</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="279"><td class="num" id="LN279">279</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="280"><td class="num" id="LN280">280</td><td class="line">    {<span class='string_literal'>"lpushx"</span>,lpushxCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="281"><td class="num" id="LN281">281</td><td class="line">     <span class='string_literal'>"write use-memory fast @list"</span>,</td></tr>
<tr class="codeline" data-linenumber="282"><td class="num" id="LN282">282</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="283"><td class="num" id="LN283">283</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="284"><td class="num" id="LN284">284</td><td class="line">    {<span class='string_literal'>"linsert"</span>,linsertCommand,5,</td></tr>
<tr class="codeline" data-linenumber="285"><td class="num" id="LN285">285</td><td class="line">     <span class='string_literal'>"write use-memory @list"</span>,</td></tr>
<tr class="codeline" data-linenumber="286"><td class="num" id="LN286">286</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="287"><td class="num" id="LN287">287</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="288"><td class="num" id="LN288">288</td><td class="line">    {<span class='string_literal'>"rpop"</span>,rpopCommand,2,</td></tr>
<tr class="codeline" data-linenumber="289"><td class="num" id="LN289">289</td><td class="line">     <span class='string_literal'>"write fast @list"</span>,</td></tr>
<tr class="codeline" data-linenumber="290"><td class="num" id="LN290">290</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="291"><td class="num" id="LN291">291</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="292"><td class="num" id="LN292">292</td><td class="line">    {<span class='string_literal'>"lpop"</span>,lpopCommand,2,</td></tr>
<tr class="codeline" data-linenumber="293"><td class="num" id="LN293">293</td><td class="line">     <span class='string_literal'>"write fast @list"</span>,</td></tr>
<tr class="codeline" data-linenumber="294"><td class="num" id="LN294">294</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="295"><td class="num" id="LN295">295</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="296"><td class="num" id="LN296">296</td><td class="line">    {<span class='string_literal'>"brpop"</span>,brpopCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="297"><td class="num" id="LN297">297</td><td class="line">     <span class='string_literal'>"write no-script @list @blocking"</span>,</td></tr>
<tr class="codeline" data-linenumber="298"><td class="num" id="LN298">298</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,-2,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="299"><td class="num" id="LN299">299</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="300"><td class="num" id="LN300">300</td><td class="line">    {<span class='string_literal'>"brpoplpush"</span>,brpoplpushCommand,4,</td></tr>
<tr class="codeline" data-linenumber="301"><td class="num" id="LN301">301</td><td class="line">     <span class='string_literal'>"write use-memory no-script @list @blocking"</span>,</td></tr>
<tr class="codeline" data-linenumber="302"><td class="num" id="LN302">302</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,2,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="303"><td class="num" id="LN303">303</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="304"><td class="num" id="LN304">304</td><td class="line">    {<span class='string_literal'>"blpop"</span>,blpopCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="305"><td class="num" id="LN305">305</td><td class="line">     <span class='string_literal'>"write no-script @list @blocking"</span>,</td></tr>
<tr class="codeline" data-linenumber="306"><td class="num" id="LN306">306</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,-2,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="307"><td class="num" id="LN307">307</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="308"><td class="num" id="LN308">308</td><td class="line">    {<span class='string_literal'>"llen"</span>,llenCommand,2,</td></tr>
<tr class="codeline" data-linenumber="309"><td class="num" id="LN309">309</td><td class="line">     <span class='string_literal'>"read-only fast @list"</span>,</td></tr>
<tr class="codeline" data-linenumber="310"><td class="num" id="LN310">310</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="311"><td class="num" id="LN311">311</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="312"><td class="num" id="LN312">312</td><td class="line">    {<span class='string_literal'>"lindex"</span>,lindexCommand,3,</td></tr>
<tr class="codeline" data-linenumber="313"><td class="num" id="LN313">313</td><td class="line">     <span class='string_literal'>"read-only @list"</span>,</td></tr>
<tr class="codeline" data-linenumber="314"><td class="num" id="LN314">314</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="315"><td class="num" id="LN315">315</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="316"><td class="num" id="LN316">316</td><td class="line">    {<span class='string_literal'>"lset"</span>,lsetCommand,4,</td></tr>
<tr class="codeline" data-linenumber="317"><td class="num" id="LN317">317</td><td class="line">     <span class='string_literal'>"write use-memory @list"</span>,</td></tr>
<tr class="codeline" data-linenumber="318"><td class="num" id="LN318">318</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="319"><td class="num" id="LN319">319</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="320"><td class="num" id="LN320">320</td><td class="line">    {<span class='string_literal'>"lrange"</span>,lrangeCommand,4,</td></tr>
<tr class="codeline" data-linenumber="321"><td class="num" id="LN321">321</td><td class="line">     <span class='string_literal'>"read-only @list"</span>,</td></tr>
<tr class="codeline" data-linenumber="322"><td class="num" id="LN322">322</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="323"><td class="num" id="LN323">323</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="324"><td class="num" id="LN324">324</td><td class="line">    {<span class='string_literal'>"ltrim"</span>,ltrimCommand,4,</td></tr>
<tr class="codeline" data-linenumber="325"><td class="num" id="LN325">325</td><td class="line">     <span class='string_literal'>"write @list"</span>,</td></tr>
<tr class="codeline" data-linenumber="326"><td class="num" id="LN326">326</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="327"><td class="num" id="LN327">327</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="328"><td class="num" id="LN328">328</td><td class="line">    {<span class='string_literal'>"lpos"</span>,lposCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="329"><td class="num" id="LN329">329</td><td class="line">     <span class='string_literal'>"read-only @list"</span>,</td></tr>
<tr class="codeline" data-linenumber="330"><td class="num" id="LN330">330</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="331"><td class="num" id="LN331">331</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="332"><td class="num" id="LN332">332</td><td class="line">    {<span class='string_literal'>"lrem"</span>,lremCommand,4,</td></tr>
<tr class="codeline" data-linenumber="333"><td class="num" id="LN333">333</td><td class="line">     <span class='string_literal'>"write @list"</span>,</td></tr>
<tr class="codeline" data-linenumber="334"><td class="num" id="LN334">334</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="335"><td class="num" id="LN335">335</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="336"><td class="num" id="LN336">336</td><td class="line">    {<span class='string_literal'>"rpoplpush"</span>,rpoplpushCommand,3,</td></tr>
<tr class="codeline" data-linenumber="337"><td class="num" id="LN337">337</td><td class="line">     <span class='string_literal'>"write use-memory @list"</span>,</td></tr>
<tr class="codeline" data-linenumber="338"><td class="num" id="LN338">338</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,2,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="339"><td class="num" id="LN339">339</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="340"><td class="num" id="LN340">340</td><td class="line">    {<span class='string_literal'>"sadd"</span>,saddCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="341"><td class="num" id="LN341">341</td><td class="line">     <span class='string_literal'>"write use-memory fast @set"</span>,</td></tr>
<tr class="codeline" data-linenumber="342"><td class="num" id="LN342">342</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="343"><td class="num" id="LN343">343</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="344"><td class="num" id="LN344">344</td><td class="line">    {<span class='string_literal'>"srem"</span>,sremCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="345"><td class="num" id="LN345">345</td><td class="line">     <span class='string_literal'>"write fast @set"</span>,</td></tr>
<tr class="codeline" data-linenumber="346"><td class="num" id="LN346">346</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="347"><td class="num" id="LN347">347</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="348"><td class="num" id="LN348">348</td><td class="line">    {<span class='string_literal'>"smove"</span>,smoveCommand,4,</td></tr>
<tr class="codeline" data-linenumber="349"><td class="num" id="LN349">349</td><td class="line">     <span class='string_literal'>"write fast @set"</span>,</td></tr>
<tr class="codeline" data-linenumber="350"><td class="num" id="LN350">350</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,2,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="351"><td class="num" id="LN351">351</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="352"><td class="num" id="LN352">352</td><td class="line">    {<span class='string_literal'>"sismember"</span>,sismemberCommand,3,</td></tr>
<tr class="codeline" data-linenumber="353"><td class="num" id="LN353">353</td><td class="line">     <span class='string_literal'>"read-only fast @set"</span>,</td></tr>
<tr class="codeline" data-linenumber="354"><td class="num" id="LN354">354</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="355"><td class="num" id="LN355">355</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="356"><td class="num" id="LN356">356</td><td class="line">    {<span class='string_literal'>"scard"</span>,scardCommand,2,</td></tr>
<tr class="codeline" data-linenumber="357"><td class="num" id="LN357">357</td><td class="line">     <span class='string_literal'>"read-only fast @set"</span>,</td></tr>
<tr class="codeline" data-linenumber="358"><td class="num" id="LN358">358</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="359"><td class="num" id="LN359">359</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="360"><td class="num" id="LN360">360</td><td class="line">    {<span class='string_literal'>"spop"</span>,spopCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="361"><td class="num" id="LN361">361</td><td class="line">     <span class='string_literal'>"write random fast @set"</span>,</td></tr>
<tr class="codeline" data-linenumber="362"><td class="num" id="LN362">362</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="363"><td class="num" id="LN363">363</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="364"><td class="num" id="LN364">364</td><td class="line">    {<span class='string_literal'>"srandmember"</span>,srandmemberCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="365"><td class="num" id="LN365">365</td><td class="line">     <span class='string_literal'>"read-only random @set"</span>,</td></tr>
<tr class="codeline" data-linenumber="366"><td class="num" id="LN366">366</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="367"><td class="num" id="LN367">367</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="368"><td class="num" id="LN368">368</td><td class="line">    {<span class='string_literal'>"sinter"</span>,sinterCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="369"><td class="num" id="LN369">369</td><td class="line">     <span class='string_literal'>"read-only to-sort @set"</span>,</td></tr>
<tr class="codeline" data-linenumber="370"><td class="num" id="LN370">370</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,-1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="371"><td class="num" id="LN371">371</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="372"><td class="num" id="LN372">372</td><td class="line">    {<span class='string_literal'>"sinterstore"</span>,sinterstoreCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="373"><td class="num" id="LN373">373</td><td class="line">     <span class='string_literal'>"write use-memory @set"</span>,</td></tr>
<tr class="codeline" data-linenumber="374"><td class="num" id="LN374">374</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,-1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="375"><td class="num" id="LN375">375</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="376"><td class="num" id="LN376">376</td><td class="line">    {<span class='string_literal'>"sunion"</span>,sunionCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="377"><td class="num" id="LN377">377</td><td class="line">     <span class='string_literal'>"read-only to-sort @set"</span>,</td></tr>
<tr class="codeline" data-linenumber="378"><td class="num" id="LN378">378</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,-1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="379"><td class="num" id="LN379">379</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="380"><td class="num" id="LN380">380</td><td class="line">    {<span class='string_literal'>"sunionstore"</span>,sunionstoreCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="381"><td class="num" id="LN381">381</td><td class="line">     <span class='string_literal'>"write use-memory @set"</span>,</td></tr>
<tr class="codeline" data-linenumber="382"><td class="num" id="LN382">382</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,-1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="383"><td class="num" id="LN383">383</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="384"><td class="num" id="LN384">384</td><td class="line">    {<span class='string_literal'>"sdiff"</span>,sdiffCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="385"><td class="num" id="LN385">385</td><td class="line">     <span class='string_literal'>"read-only to-sort @set"</span>,</td></tr>
<tr class="codeline" data-linenumber="386"><td class="num" id="LN386">386</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,-1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="387"><td class="num" id="LN387">387</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="388"><td class="num" id="LN388">388</td><td class="line">    {<span class='string_literal'>"sdiffstore"</span>,sdiffstoreCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="389"><td class="num" id="LN389">389</td><td class="line">     <span class='string_literal'>"write use-memory @set"</span>,</td></tr>
<tr class="codeline" data-linenumber="390"><td class="num" id="LN390">390</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,-1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="391"><td class="num" id="LN391">391</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="392"><td class="num" id="LN392">392</td><td class="line">    {<span class='string_literal'>"smembers"</span>,sinterCommand,2,</td></tr>
<tr class="codeline" data-linenumber="393"><td class="num" id="LN393">393</td><td class="line">     <span class='string_literal'>"read-only to-sort @set"</span>,</td></tr>
<tr class="codeline" data-linenumber="394"><td class="num" id="LN394">394</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="395"><td class="num" id="LN395">395</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="396"><td class="num" id="LN396">396</td><td class="line">    {<span class='string_literal'>"sscan"</span>,sscanCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="397"><td class="num" id="LN397">397</td><td class="line">     <span class='string_literal'>"read-only random @set"</span>,</td></tr>
<tr class="codeline" data-linenumber="398"><td class="num" id="LN398">398</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="399"><td class="num" id="LN399">399</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="400"><td class="num" id="LN400">400</td><td class="line">    {<span class='string_literal'>"zadd"</span>,zaddCommand,-4,</td></tr>
<tr class="codeline" data-linenumber="401"><td class="num" id="LN401">401</td><td class="line">     <span class='string_literal'>"write use-memory fast @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="402"><td class="num" id="LN402">402</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="403"><td class="num" id="LN403">403</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="404"><td class="num" id="LN404">404</td><td class="line">    {<span class='string_literal'>"zincrby"</span>,zincrbyCommand,4,</td></tr>
<tr class="codeline" data-linenumber="405"><td class="num" id="LN405">405</td><td class="line">     <span class='string_literal'>"write use-memory fast @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="406"><td class="num" id="LN406">406</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="407"><td class="num" id="LN407">407</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="408"><td class="num" id="LN408">408</td><td class="line">    {<span class='string_literal'>"zrem"</span>,zremCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="409"><td class="num" id="LN409">409</td><td class="line">     <span class='string_literal'>"write fast @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="410"><td class="num" id="LN410">410</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="411"><td class="num" id="LN411">411</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="412"><td class="num" id="LN412">412</td><td class="line">    {<span class='string_literal'>"zremrangebyscore"</span>,zremrangebyscoreCommand,4,</td></tr>
<tr class="codeline" data-linenumber="413"><td class="num" id="LN413">413</td><td class="line">     <span class='string_literal'>"write @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="414"><td class="num" id="LN414">414</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="415"><td class="num" id="LN415">415</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="416"><td class="num" id="LN416">416</td><td class="line">    {<span class='string_literal'>"zremrangebyrank"</span>,zremrangebyrankCommand,4,</td></tr>
<tr class="codeline" data-linenumber="417"><td class="num" id="LN417">417</td><td class="line">     <span class='string_literal'>"write @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="418"><td class="num" id="LN418">418</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="419"><td class="num" id="LN419">419</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="420"><td class="num" id="LN420">420</td><td class="line">    {<span class='string_literal'>"zremrangebylex"</span>,zremrangebylexCommand,4,</td></tr>
<tr class="codeline" data-linenumber="421"><td class="num" id="LN421">421</td><td class="line">     <span class='string_literal'>"write @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="422"><td class="num" id="LN422">422</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="423"><td class="num" id="LN423">423</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="424"><td class="num" id="LN424">424</td><td class="line">    {<span class='string_literal'>"zunionstore"</span>,zunionstoreCommand,-4,</td></tr>
<tr class="codeline" data-linenumber="425"><td class="num" id="LN425">425</td><td class="line">     <span class='string_literal'>"write use-memory @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="426"><td class="num" id="LN426">426</td><td class="line">     0,zunionInterGetKeys,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="427"><td class="num" id="LN427">427</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="428"><td class="num" id="LN428">428</td><td class="line">    {<span class='string_literal'>"zinterstore"</span>,zinterstoreCommand,-4,</td></tr>
<tr class="codeline" data-linenumber="429"><td class="num" id="LN429">429</td><td class="line">     <span class='string_literal'>"write use-memory @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="430"><td class="num" id="LN430">430</td><td class="line">     0,zunionInterGetKeys,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="431"><td class="num" id="LN431">431</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="432"><td class="num" id="LN432">432</td><td class="line">    {<span class='string_literal'>"zrange"</span>,zrangeCommand,-4,</td></tr>
<tr class="codeline" data-linenumber="433"><td class="num" id="LN433">433</td><td class="line">     <span class='string_literal'>"read-only @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="434"><td class="num" id="LN434">434</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="435"><td class="num" id="LN435">435</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="436"><td class="num" id="LN436">436</td><td class="line">    {<span class='string_literal'>"zrangebyscore"</span>,zrangebyscoreCommand,-4,</td></tr>
<tr class="codeline" data-linenumber="437"><td class="num" id="LN437">437</td><td class="line">     <span class='string_literal'>"read-only @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="438"><td class="num" id="LN438">438</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="439"><td class="num" id="LN439">439</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="440"><td class="num" id="LN440">440</td><td class="line">    {<span class='string_literal'>"zrevrangebyscore"</span>,zrevrangebyscoreCommand,-4,</td></tr>
<tr class="codeline" data-linenumber="441"><td class="num" id="LN441">441</td><td class="line">     <span class='string_literal'>"read-only @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="442"><td class="num" id="LN442">442</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="443"><td class="num" id="LN443">443</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="444"><td class="num" id="LN444">444</td><td class="line">    {<span class='string_literal'>"zrangebylex"</span>,zrangebylexCommand,-4,</td></tr>
<tr class="codeline" data-linenumber="445"><td class="num" id="LN445">445</td><td class="line">     <span class='string_literal'>"read-only @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="446"><td class="num" id="LN446">446</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="447"><td class="num" id="LN447">447</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="448"><td class="num" id="LN448">448</td><td class="line">    {<span class='string_literal'>"zrevrangebylex"</span>,zrevrangebylexCommand,-4,</td></tr>
<tr class="codeline" data-linenumber="449"><td class="num" id="LN449">449</td><td class="line">     <span class='string_literal'>"read-only @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="450"><td class="num" id="LN450">450</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="451"><td class="num" id="LN451">451</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="452"><td class="num" id="LN452">452</td><td class="line">    {<span class='string_literal'>"zcount"</span>,zcountCommand,4,</td></tr>
<tr class="codeline" data-linenumber="453"><td class="num" id="LN453">453</td><td class="line">     <span class='string_literal'>"read-only fast @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="454"><td class="num" id="LN454">454</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="455"><td class="num" id="LN455">455</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="456"><td class="num" id="LN456">456</td><td class="line">    {<span class='string_literal'>"zlexcount"</span>,zlexcountCommand,4,</td></tr>
<tr class="codeline" data-linenumber="457"><td class="num" id="LN457">457</td><td class="line">     <span class='string_literal'>"read-only fast @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="458"><td class="num" id="LN458">458</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="459"><td class="num" id="LN459">459</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="460"><td class="num" id="LN460">460</td><td class="line">    {<span class='string_literal'>"zrevrange"</span>,zrevrangeCommand,-4,</td></tr>
<tr class="codeline" data-linenumber="461"><td class="num" id="LN461">461</td><td class="line">     <span class='string_literal'>"read-only @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="462"><td class="num" id="LN462">462</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="463"><td class="num" id="LN463">463</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="464"><td class="num" id="LN464">464</td><td class="line">    {<span class='string_literal'>"zcard"</span>,zcardCommand,2,</td></tr>
<tr class="codeline" data-linenumber="465"><td class="num" id="LN465">465</td><td class="line">     <span class='string_literal'>"read-only fast @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="466"><td class="num" id="LN466">466</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="467"><td class="num" id="LN467">467</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="468"><td class="num" id="LN468">468</td><td class="line">    {<span class='string_literal'>"zscore"</span>,zscoreCommand,3,</td></tr>
<tr class="codeline" data-linenumber="469"><td class="num" id="LN469">469</td><td class="line">     <span class='string_literal'>"read-only fast @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="470"><td class="num" id="LN470">470</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="471"><td class="num" id="LN471">471</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="472"><td class="num" id="LN472">472</td><td class="line">    {<span class='string_literal'>"zrank"</span>,zrankCommand,3,</td></tr>
<tr class="codeline" data-linenumber="473"><td class="num" id="LN473">473</td><td class="line">     <span class='string_literal'>"read-only fast @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="474"><td class="num" id="LN474">474</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="475"><td class="num" id="LN475">475</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="476"><td class="num" id="LN476">476</td><td class="line">    {<span class='string_literal'>"zrevrank"</span>,zrevrankCommand,3,</td></tr>
<tr class="codeline" data-linenumber="477"><td class="num" id="LN477">477</td><td class="line">     <span class='string_literal'>"read-only fast @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="478"><td class="num" id="LN478">478</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="479"><td class="num" id="LN479">479</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="480"><td class="num" id="LN480">480</td><td class="line">    {<span class='string_literal'>"zscan"</span>,zscanCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="481"><td class="num" id="LN481">481</td><td class="line">     <span class='string_literal'>"read-only random @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="482"><td class="num" id="LN482">482</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="483"><td class="num" id="LN483">483</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="484"><td class="num" id="LN484">484</td><td class="line">    {<span class='string_literal'>"zpopmin"</span>,zpopminCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="485"><td class="num" id="LN485">485</td><td class="line">     <span class='string_literal'>"write fast @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="486"><td class="num" id="LN486">486</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="487"><td class="num" id="LN487">487</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="488"><td class="num" id="LN488">488</td><td class="line">    {<span class='string_literal'>"zpopmax"</span>,zpopmaxCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="489"><td class="num" id="LN489">489</td><td class="line">     <span class='string_literal'>"write fast @sortedset"</span>,</td></tr>
<tr class="codeline" data-linenumber="490"><td class="num" id="LN490">490</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="491"><td class="num" id="LN491">491</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="492"><td class="num" id="LN492">492</td><td class="line">    {<span class='string_literal'>"bzpopmin"</span>,bzpopminCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="493"><td class="num" id="LN493">493</td><td class="line">     <span class='string_literal'>"write no-script fast @sortedset @blocking"</span>,</td></tr>
<tr class="codeline" data-linenumber="494"><td class="num" id="LN494">494</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,-2,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="495"><td class="num" id="LN495">495</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="496"><td class="num" id="LN496">496</td><td class="line">    {<span class='string_literal'>"bzpopmax"</span>,bzpopmaxCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="497"><td class="num" id="LN497">497</td><td class="line">     <span class='string_literal'>"write no-script fast @sortedset @blocking"</span>,</td></tr>
<tr class="codeline" data-linenumber="498"><td class="num" id="LN498">498</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,-2,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="499"><td class="num" id="LN499">499</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="500"><td class="num" id="LN500">500</td><td class="line">    {<span class='string_literal'>"hset"</span>,hsetCommand,-4,</td></tr>
<tr class="codeline" data-linenumber="501"><td class="num" id="LN501">501</td><td class="line">     <span class='string_literal'>"write use-memory fast @hash"</span>,</td></tr>
<tr class="codeline" data-linenumber="502"><td class="num" id="LN502">502</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="503"><td class="num" id="LN503">503</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="504"><td class="num" id="LN504">504</td><td class="line">    {<span class='string_literal'>"hsetnx"</span>,hsetnxCommand,4,</td></tr>
<tr class="codeline" data-linenumber="505"><td class="num" id="LN505">505</td><td class="line">     <span class='string_literal'>"write use-memory fast @hash"</span>,</td></tr>
<tr class="codeline" data-linenumber="506"><td class="num" id="LN506">506</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="507"><td class="num" id="LN507">507</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="508"><td class="num" id="LN508">508</td><td class="line">    {<span class='string_literal'>"hget"</span>,hgetCommand,3,</td></tr>
<tr class="codeline" data-linenumber="509"><td class="num" id="LN509">509</td><td class="line">     <span class='string_literal'>"read-only fast @hash"</span>,</td></tr>
<tr class="codeline" data-linenumber="510"><td class="num" id="LN510">510</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="511"><td class="num" id="LN511">511</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="512"><td class="num" id="LN512">512</td><td class="line">    {<span class='string_literal'>"hmset"</span>,hsetCommand,-4,</td></tr>
<tr class="codeline" data-linenumber="513"><td class="num" id="LN513">513</td><td class="line">     <span class='string_literal'>"write use-memory fast @hash"</span>,</td></tr>
<tr class="codeline" data-linenumber="514"><td class="num" id="LN514">514</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="515"><td class="num" id="LN515">515</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="516"><td class="num" id="LN516">516</td><td class="line">    {<span class='string_literal'>"hmget"</span>,hmgetCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="517"><td class="num" id="LN517">517</td><td class="line">     <span class='string_literal'>"read-only fast @hash"</span>,</td></tr>
<tr class="codeline" data-linenumber="518"><td class="num" id="LN518">518</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="519"><td class="num" id="LN519">519</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="520"><td class="num" id="LN520">520</td><td class="line">    {<span class='string_literal'>"hincrby"</span>,hincrbyCommand,4,</td></tr>
<tr class="codeline" data-linenumber="521"><td class="num" id="LN521">521</td><td class="line">     <span class='string_literal'>"write use-memory fast @hash"</span>,</td></tr>
<tr class="codeline" data-linenumber="522"><td class="num" id="LN522">522</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="523"><td class="num" id="LN523">523</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="524"><td class="num" id="LN524">524</td><td class="line">    {<span class='string_literal'>"hincrbyfloat"</span>,hincrbyfloatCommand,4,</td></tr>
<tr class="codeline" data-linenumber="525"><td class="num" id="LN525">525</td><td class="line">     <span class='string_literal'>"write use-memory fast @hash"</span>,</td></tr>
<tr class="codeline" data-linenumber="526"><td class="num" id="LN526">526</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="527"><td class="num" id="LN527">527</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="528"><td class="num" id="LN528">528</td><td class="line">    {<span class='string_literal'>"hdel"</span>,hdelCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="529"><td class="num" id="LN529">529</td><td class="line">     <span class='string_literal'>"write fast @hash"</span>,</td></tr>
<tr class="codeline" data-linenumber="530"><td class="num" id="LN530">530</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="531"><td class="num" id="LN531">531</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="532"><td class="num" id="LN532">532</td><td class="line">    {<span class='string_literal'>"hlen"</span>,hlenCommand,2,</td></tr>
<tr class="codeline" data-linenumber="533"><td class="num" id="LN533">533</td><td class="line">     <span class='string_literal'>"read-only fast @hash"</span>,</td></tr>
<tr class="codeline" data-linenumber="534"><td class="num" id="LN534">534</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="535"><td class="num" id="LN535">535</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="536"><td class="num" id="LN536">536</td><td class="line">    {<span class='string_literal'>"hstrlen"</span>,hstrlenCommand,3,</td></tr>
<tr class="codeline" data-linenumber="537"><td class="num" id="LN537">537</td><td class="line">     <span class='string_literal'>"read-only fast @hash"</span>,</td></tr>
<tr class="codeline" data-linenumber="538"><td class="num" id="LN538">538</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="539"><td class="num" id="LN539">539</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="540"><td class="num" id="LN540">540</td><td class="line">    {<span class='string_literal'>"hkeys"</span>,hkeysCommand,2,</td></tr>
<tr class="codeline" data-linenumber="541"><td class="num" id="LN541">541</td><td class="line">     <span class='string_literal'>"read-only to-sort @hash"</span>,</td></tr>
<tr class="codeline" data-linenumber="542"><td class="num" id="LN542">542</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="543"><td class="num" id="LN543">543</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="544"><td class="num" id="LN544">544</td><td class="line">    {<span class='string_literal'>"hvals"</span>,hvalsCommand,2,</td></tr>
<tr class="codeline" data-linenumber="545"><td class="num" id="LN545">545</td><td class="line">     <span class='string_literal'>"read-only to-sort @hash"</span>,</td></tr>
<tr class="codeline" data-linenumber="546"><td class="num" id="LN546">546</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="547"><td class="num" id="LN547">547</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="548"><td class="num" id="LN548">548</td><td class="line">    {<span class='string_literal'>"hgetall"</span>,hgetallCommand,2,</td></tr>
<tr class="codeline" data-linenumber="549"><td class="num" id="LN549">549</td><td class="line">     <span class='string_literal'>"read-only random @hash"</span>,</td></tr>
<tr class="codeline" data-linenumber="550"><td class="num" id="LN550">550</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="551"><td class="num" id="LN551">551</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="552"><td class="num" id="LN552">552</td><td class="line">    {<span class='string_literal'>"hexists"</span>,hexistsCommand,3,</td></tr>
<tr class="codeline" data-linenumber="553"><td class="num" id="LN553">553</td><td class="line">     <span class='string_literal'>"read-only fast @hash"</span>,</td></tr>
<tr class="codeline" data-linenumber="554"><td class="num" id="LN554">554</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="555"><td class="num" id="LN555">555</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="556"><td class="num" id="LN556">556</td><td class="line">    {<span class='string_literal'>"hscan"</span>,hscanCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="557"><td class="num" id="LN557">557</td><td class="line">     <span class='string_literal'>"read-only random @hash"</span>,</td></tr>
<tr class="codeline" data-linenumber="558"><td class="num" id="LN558">558</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="559"><td class="num" id="LN559">559</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="560"><td class="num" id="LN560">560</td><td class="line">    {<span class='string_literal'>"incrby"</span>,incrbyCommand,3,</td></tr>
<tr class="codeline" data-linenumber="561"><td class="num" id="LN561">561</td><td class="line">     <span class='string_literal'>"write use-memory fast @string"</span>,</td></tr>
<tr class="codeline" data-linenumber="562"><td class="num" id="LN562">562</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="563"><td class="num" id="LN563">563</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="564"><td class="num" id="LN564">564</td><td class="line">    {<span class='string_literal'>"decrby"</span>,decrbyCommand,3,</td></tr>
<tr class="codeline" data-linenumber="565"><td class="num" id="LN565">565</td><td class="line">     <span class='string_literal'>"write use-memory fast @string"</span>,</td></tr>
<tr class="codeline" data-linenumber="566"><td class="num" id="LN566">566</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="567"><td class="num" id="LN567">567</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="568"><td class="num" id="LN568">568</td><td class="line">    {<span class='string_literal'>"incrbyfloat"</span>,incrbyfloatCommand,3,</td></tr>
<tr class="codeline" data-linenumber="569"><td class="num" id="LN569">569</td><td class="line">     <span class='string_literal'>"write use-memory fast @string"</span>,</td></tr>
<tr class="codeline" data-linenumber="570"><td class="num" id="LN570">570</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="571"><td class="num" id="LN571">571</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="572"><td class="num" id="LN572">572</td><td class="line">    {<span class='string_literal'>"getset"</span>,getsetCommand,3,</td></tr>
<tr class="codeline" data-linenumber="573"><td class="num" id="LN573">573</td><td class="line">     <span class='string_literal'>"write use-memory fast @string"</span>,</td></tr>
<tr class="codeline" data-linenumber="574"><td class="num" id="LN574">574</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="575"><td class="num" id="LN575">575</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="576"><td class="num" id="LN576">576</td><td class="line">    {<span class='string_literal'>"mset"</span>,msetCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="577"><td class="num" id="LN577">577</td><td class="line">     <span class='string_literal'>"write use-memory @string"</span>,</td></tr>
<tr class="codeline" data-linenumber="578"><td class="num" id="LN578">578</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,-1,2,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="579"><td class="num" id="LN579">579</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="580"><td class="num" id="LN580">580</td><td class="line">    {<span class='string_literal'>"msetnx"</span>,msetnxCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="581"><td class="num" id="LN581">581</td><td class="line">     <span class='string_literal'>"write use-memory @string"</span>,</td></tr>
<tr class="codeline" data-linenumber="582"><td class="num" id="LN582">582</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,-1,2,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="583"><td class="num" id="LN583">583</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="584"><td class="num" id="LN584">584</td><td class="line">    {<span class='string_literal'>"randomkey"</span>,randomkeyCommand,1,</td></tr>
<tr class="codeline" data-linenumber="585"><td class="num" id="LN585">585</td><td class="line">     <span class='string_literal'>"read-only random @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="586"><td class="num" id="LN586">586</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="587"><td class="num" id="LN587">587</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="588"><td class="num" id="LN588">588</td><td class="line">    {<span class='string_literal'>"select"</span>,selectCommand,2,</td></tr>
<tr class="codeline" data-linenumber="589"><td class="num" id="LN589">589</td><td class="line">     <span class='string_literal'>"ok-loading fast ok-stale @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="590"><td class="num" id="LN590">590</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="591"><td class="num" id="LN591">591</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="592"><td class="num" id="LN592">592</td><td class="line">    {<span class='string_literal'>"swapdb"</span>,swapdbCommand,3,</td></tr>
<tr class="codeline" data-linenumber="593"><td class="num" id="LN593">593</td><td class="line">     <span class='string_literal'>"write fast @keyspace @dangerous"</span>,</td></tr>
<tr class="codeline" data-linenumber="594"><td class="num" id="LN594">594</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="595"><td class="num" id="LN595">595</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="596"><td class="num" id="LN596">596</td><td class="line">    {<span class='string_literal'>"move"</span>,moveCommand,3,</td></tr>
<tr class="codeline" data-linenumber="597"><td class="num" id="LN597">597</td><td class="line">     <span class='string_literal'>"write fast @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="598"><td class="num" id="LN598">598</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="599"><td class="num" id="LN599">599</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="600"><td class="num" id="LN600">600</td><td class="line">    <span class='comment'>/* Like for SET, we can't mark rename as a fast command because</span></td></tr>
<tr class="codeline" data-linenumber="601"><td class="num" id="LN601">601</td><td class="line">     <span class='comment'>* overwriting the target key may result in an implicit slow DEL. */</span></td></tr>
<tr class="codeline" data-linenumber="602"><td class="num" id="LN602">602</td><td class="line">    {<span class='string_literal'>"rename"</span>,renameCommand,3,</td></tr>
<tr class="codeline" data-linenumber="603"><td class="num" id="LN603">603</td><td class="line">     <span class='string_literal'>"write @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="604"><td class="num" id="LN604">604</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,2,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="605"><td class="num" id="LN605">605</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="606"><td class="num" id="LN606">606</td><td class="line">    {<span class='string_literal'>"renamenx"</span>,renamenxCommand,3,</td></tr>
<tr class="codeline" data-linenumber="607"><td class="num" id="LN607">607</td><td class="line">     <span class='string_literal'>"write fast @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="608"><td class="num" id="LN608">608</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,2,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="609"><td class="num" id="LN609">609</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="610"><td class="num" id="LN610">610</td><td class="line">    {<span class='string_literal'>"expire"</span>,expireCommand,3,</td></tr>
<tr class="codeline" data-linenumber="611"><td class="num" id="LN611">611</td><td class="line">     <span class='string_literal'>"write fast @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="612"><td class="num" id="LN612">612</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="613"><td class="num" id="LN613">613</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="614"><td class="num" id="LN614">614</td><td class="line">    {<span class='string_literal'>"expireat"</span>,expireatCommand,3,</td></tr>
<tr class="codeline" data-linenumber="615"><td class="num" id="LN615">615</td><td class="line">     <span class='string_literal'>"write fast @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="616"><td class="num" id="LN616">616</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="617"><td class="num" id="LN617">617</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="618"><td class="num" id="LN618">618</td><td class="line">    {<span class='string_literal'>"pexpire"</span>,pexpireCommand,3,</td></tr>
<tr class="codeline" data-linenumber="619"><td class="num" id="LN619">619</td><td class="line">     <span class='string_literal'>"write fast @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="620"><td class="num" id="LN620">620</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="621"><td class="num" id="LN621">621</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="622"><td class="num" id="LN622">622</td><td class="line">    {<span class='string_literal'>"pexpireat"</span>,pexpireatCommand,3,</td></tr>
<tr class="codeline" data-linenumber="623"><td class="num" id="LN623">623</td><td class="line">     <span class='string_literal'>"write fast @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="624"><td class="num" id="LN624">624</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="625"><td class="num" id="LN625">625</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="626"><td class="num" id="LN626">626</td><td class="line">    {<span class='string_literal'>"keys"</span>,keysCommand,2,</td></tr>
<tr class="codeline" data-linenumber="627"><td class="num" id="LN627">627</td><td class="line">     <span class='string_literal'>"read-only to-sort @keyspace @dangerous"</span>,</td></tr>
<tr class="codeline" data-linenumber="628"><td class="num" id="LN628">628</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="629"><td class="num" id="LN629">629</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="630"><td class="num" id="LN630">630</td><td class="line">    {<span class='string_literal'>"scan"</span>,scanCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="631"><td class="num" id="LN631">631</td><td class="line">     <span class='string_literal'>"read-only random @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="632"><td class="num" id="LN632">632</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="633"><td class="num" id="LN633">633</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="634"><td class="num" id="LN634">634</td><td class="line">    {<span class='string_literal'>"dbsize"</span>,dbsizeCommand,1,</td></tr>
<tr class="codeline" data-linenumber="635"><td class="num" id="LN635">635</td><td class="line">     <span class='string_literal'>"read-only fast @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="636"><td class="num" id="LN636">636</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="637"><td class="num" id="LN637">637</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="638"><td class="num" id="LN638">638</td><td class="line">    {<span class='string_literal'>"auth"</span>,authCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="639"><td class="num" id="LN639">639</td><td class="line">     <span class='string_literal'>"no-auth no-script ok-loading ok-stale fast no-monitor no-slowlog @connection"</span>,</td></tr>
<tr class="codeline" data-linenumber="640"><td class="num" id="LN640">640</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="641"><td class="num" id="LN641">641</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="642"><td class="num" id="LN642">642</td><td class="line">    <span class='comment'>/* We don't allow PING during loading since in Redis PING is used as</span></td></tr>
<tr class="codeline" data-linenumber="643"><td class="num" id="LN643">643</td><td class="line">     <span class='comment'>* failure detection, and a loading server is considered to be</span></td></tr>
<tr class="codeline" data-linenumber="644"><td class="num" id="LN644">644</td><td class="line">     <span class='comment'>* not available. */</span></td></tr>
<tr class="codeline" data-linenumber="645"><td class="num" id="LN645">645</td><td class="line">    {<span class='string_literal'>"ping"</span>,pingCommand,-1,</td></tr>
<tr class="codeline" data-linenumber="646"><td class="num" id="LN646">646</td><td class="line">     <span class='string_literal'>"ok-stale fast @connection"</span>,</td></tr>
<tr class="codeline" data-linenumber="647"><td class="num" id="LN647">647</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="648"><td class="num" id="LN648">648</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="649"><td class="num" id="LN649">649</td><td class="line">    {<span class='string_literal'>"echo"</span>,echoCommand,2,</td></tr>
<tr class="codeline" data-linenumber="650"><td class="num" id="LN650">650</td><td class="line">     <span class='string_literal'>"read-only fast @connection"</span>,</td></tr>
<tr class="codeline" data-linenumber="651"><td class="num" id="LN651">651</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="652"><td class="num" id="LN652">652</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="653"><td class="num" id="LN653">653</td><td class="line">    {<span class='string_literal'>"save"</span>,saveCommand,1,</td></tr>
<tr class="codeline" data-linenumber="654"><td class="num" id="LN654">654</td><td class="line">     <span class='string_literal'>"admin no-script"</span>,</td></tr>
<tr class="codeline" data-linenumber="655"><td class="num" id="LN655">655</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="656"><td class="num" id="LN656">656</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="657"><td class="num" id="LN657">657</td><td class="line">    {<span class='string_literal'>"bgsave"</span>,bgsaveCommand,-1,</td></tr>
<tr class="codeline" data-linenumber="658"><td class="num" id="LN658">658</td><td class="line">     <span class='string_literal'>"admin no-script"</span>,</td></tr>
<tr class="codeline" data-linenumber="659"><td class="num" id="LN659">659</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="660"><td class="num" id="LN660">660</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="661"><td class="num" id="LN661">661</td><td class="line">    {<span class='string_literal'>"bgrewriteaof"</span>,bgrewriteaofCommand,1,</td></tr>
<tr class="codeline" data-linenumber="662"><td class="num" id="LN662">662</td><td class="line">     <span class='string_literal'>"admin no-script"</span>,</td></tr>
<tr class="codeline" data-linenumber="663"><td class="num" id="LN663">663</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="664"><td class="num" id="LN664">664</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="665"><td class="num" id="LN665">665</td><td class="line">    {<span class='string_literal'>"shutdown"</span>,shutdownCommand,-1,</td></tr>
<tr class="codeline" data-linenumber="666"><td class="num" id="LN666">666</td><td class="line">     <span class='string_literal'>"admin no-script ok-loading ok-stale"</span>,</td></tr>
<tr class="codeline" data-linenumber="667"><td class="num" id="LN667">667</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="668"><td class="num" id="LN668">668</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="669"><td class="num" id="LN669">669</td><td class="line">    {<span class='string_literal'>"lastsave"</span>,lastsaveCommand,1,</td></tr>
<tr class="codeline" data-linenumber="670"><td class="num" id="LN670">670</td><td class="line">     <span class='string_literal'>"read-only random fast ok-loading ok-stale @admin @dangerous"</span>,</td></tr>
<tr class="codeline" data-linenumber="671"><td class="num" id="LN671">671</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="672"><td class="num" id="LN672">672</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="673"><td class="num" id="LN673">673</td><td class="line">    {<span class='string_literal'>"type"</span>,typeCommand,2,</td></tr>
<tr class="codeline" data-linenumber="674"><td class="num" id="LN674">674</td><td class="line">     <span class='string_literal'>"read-only fast @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="675"><td class="num" id="LN675">675</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="676"><td class="num" id="LN676">676</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="677"><td class="num" id="LN677">677</td><td class="line">    {<span class='string_literal'>"multi"</span>,multiCommand,1,</td></tr>
<tr class="codeline" data-linenumber="678"><td class="num" id="LN678">678</td><td class="line">     <span class='string_literal'>"no-script fast ok-loading ok-stale @transaction"</span>,</td></tr>
<tr class="codeline" data-linenumber="679"><td class="num" id="LN679">679</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="680"><td class="num" id="LN680">680</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="681"><td class="num" id="LN681">681</td><td class="line">    {<span class='string_literal'>"exec"</span>,execCommand,1,</td></tr>
<tr class="codeline" data-linenumber="682"><td class="num" id="LN682">682</td><td class="line">     <span class='string_literal'>"no-script no-monitor no-slowlog ok-loading ok-stale @transaction"</span>,</td></tr>
<tr class="codeline" data-linenumber="683"><td class="num" id="LN683">683</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="684"><td class="num" id="LN684">684</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="685"><td class="num" id="LN685">685</td><td class="line">    {<span class='string_literal'>"discard"</span>,discardCommand,1,</td></tr>
<tr class="codeline" data-linenumber="686"><td class="num" id="LN686">686</td><td class="line">     <span class='string_literal'>"no-script fast ok-loading ok-stale @transaction"</span>,</td></tr>
<tr class="codeline" data-linenumber="687"><td class="num" id="LN687">687</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="688"><td class="num" id="LN688">688</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="689"><td class="num" id="LN689">689</td><td class="line">    {<span class='string_literal'>"sync"</span>,syncCommand,1,</td></tr>
<tr class="codeline" data-linenumber="690"><td class="num" id="LN690">690</td><td class="line">     <span class='string_literal'>"admin no-script"</span>,</td></tr>
<tr class="codeline" data-linenumber="691"><td class="num" id="LN691">691</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="692"><td class="num" id="LN692">692</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="693"><td class="num" id="LN693">693</td><td class="line">    {<span class='string_literal'>"psync"</span>,syncCommand,3,</td></tr>
<tr class="codeline" data-linenumber="694"><td class="num" id="LN694">694</td><td class="line">     <span class='string_literal'>"admin no-script"</span>,</td></tr>
<tr class="codeline" data-linenumber="695"><td class="num" id="LN695">695</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="696"><td class="num" id="LN696">696</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="697"><td class="num" id="LN697">697</td><td class="line">    {<span class='string_literal'>"replconf"</span>,replconfCommand,-1,</td></tr>
<tr class="codeline" data-linenumber="698"><td class="num" id="LN698">698</td><td class="line">     <span class='string_literal'>"admin no-script ok-loading ok-stale"</span>,</td></tr>
<tr class="codeline" data-linenumber="699"><td class="num" id="LN699">699</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="700"><td class="num" id="LN700">700</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="701"><td class="num" id="LN701">701</td><td class="line">    {<span class='string_literal'>"flushdb"</span>,flushdbCommand,-1,</td></tr>
<tr class="codeline" data-linenumber="702"><td class="num" id="LN702">702</td><td class="line">     <span class='string_literal'>"write @keyspace @dangerous"</span>,</td></tr>
<tr class="codeline" data-linenumber="703"><td class="num" id="LN703">703</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="704"><td class="num" id="LN704">704</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="705"><td class="num" id="LN705">705</td><td class="line">    {<span class='string_literal'>"flushall"</span>,flushallCommand,-1,</td></tr>
<tr class="codeline" data-linenumber="706"><td class="num" id="LN706">706</td><td class="line">     <span class='string_literal'>"write @keyspace @dangerous"</span>,</td></tr>
<tr class="codeline" data-linenumber="707"><td class="num" id="LN707">707</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="708"><td class="num" id="LN708">708</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="709"><td class="num" id="LN709">709</td><td class="line">    {<span class='string_literal'>"sort"</span>,sortCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="710"><td class="num" id="LN710">710</td><td class="line">     <span class='string_literal'>"write use-memory @list @set @sortedset @dangerous"</span>,</td></tr>
<tr class="codeline" data-linenumber="711"><td class="num" id="LN711">711</td><td class="line">     0,sortGetKeys,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="712"><td class="num" id="LN712">712</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="713"><td class="num" id="LN713">713</td><td class="line">    {<span class='string_literal'>"info"</span>,infoCommand,-1,</td></tr>
<tr class="codeline" data-linenumber="714"><td class="num" id="LN714">714</td><td class="line">     <span class='string_literal'>"ok-loading ok-stale random @dangerous"</span>,</td></tr>
<tr class="codeline" data-linenumber="715"><td class="num" id="LN715">715</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="716"><td class="num" id="LN716">716</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="717"><td class="num" id="LN717">717</td><td class="line">    {<span class='string_literal'>"monitor"</span>,monitorCommand,1,</td></tr>
<tr class="codeline" data-linenumber="718"><td class="num" id="LN718">718</td><td class="line">     <span class='string_literal'>"admin no-script ok-loading ok-stale"</span>,</td></tr>
<tr class="codeline" data-linenumber="719"><td class="num" id="LN719">719</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="720"><td class="num" id="LN720">720</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="721"><td class="num" id="LN721">721</td><td class="line">    {<span class='string_literal'>"ttl"</span>,ttlCommand,2,</td></tr>
<tr class="codeline" data-linenumber="722"><td class="num" id="LN722">722</td><td class="line">     <span class='string_literal'>"read-only fast random @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="723"><td class="num" id="LN723">723</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="724"><td class="num" id="LN724">724</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="725"><td class="num" id="LN725">725</td><td class="line">    {<span class='string_literal'>"touch"</span>,touchCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="726"><td class="num" id="LN726">726</td><td class="line">     <span class='string_literal'>"read-only fast @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="727"><td class="num" id="LN727">727</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,-1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="728"><td class="num" id="LN728">728</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="729"><td class="num" id="LN729">729</td><td class="line">    {<span class='string_literal'>"pttl"</span>,pttlCommand,2,</td></tr>
<tr class="codeline" data-linenumber="730"><td class="num" id="LN730">730</td><td class="line">     <span class='string_literal'>"read-only fast random @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="731"><td class="num" id="LN731">731</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="732"><td class="num" id="LN732">732</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="733"><td class="num" id="LN733">733</td><td class="line">    {<span class='string_literal'>"persist"</span>,persistCommand,2,</td></tr>
<tr class="codeline" data-linenumber="734"><td class="num" id="LN734">734</td><td class="line">     <span class='string_literal'>"write fast @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="735"><td class="num" id="LN735">735</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="736"><td class="num" id="LN736">736</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="737"><td class="num" id="LN737">737</td><td class="line">    {<span class='string_literal'>"slaveof"</span>,replicaofCommand,3,</td></tr>
<tr class="codeline" data-linenumber="738"><td class="num" id="LN738">738</td><td class="line">     <span class='string_literal'>"admin no-script ok-stale"</span>,</td></tr>
<tr class="codeline" data-linenumber="739"><td class="num" id="LN739">739</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="740"><td class="num" id="LN740">740</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="741"><td class="num" id="LN741">741</td><td class="line">    {<span class='string_literal'>"replicaof"</span>,replicaofCommand,3,</td></tr>
<tr class="codeline" data-linenumber="742"><td class="num" id="LN742">742</td><td class="line">     <span class='string_literal'>"admin no-script ok-stale"</span>,</td></tr>
<tr class="codeline" data-linenumber="743"><td class="num" id="LN743">743</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="744"><td class="num" id="LN744">744</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="745"><td class="num" id="LN745">745</td><td class="line">    {<span class='string_literal'>"role"</span>,roleCommand,1,</td></tr>
<tr class="codeline" data-linenumber="746"><td class="num" id="LN746">746</td><td class="line">     <span class='string_literal'>"ok-loading ok-stale no-script fast read-only @dangerous"</span>,</td></tr>
<tr class="codeline" data-linenumber="747"><td class="num" id="LN747">747</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="748"><td class="num" id="LN748">748</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="749"><td class="num" id="LN749">749</td><td class="line">    {<span class='string_literal'>"debug"</span>,debugCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="750"><td class="num" id="LN750">750</td><td class="line">     <span class='string_literal'>"admin no-script ok-loading ok-stale"</span>,</td></tr>
<tr class="codeline" data-linenumber="751"><td class="num" id="LN751">751</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="752"><td class="num" id="LN752">752</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="753"><td class="num" id="LN753">753</td><td class="line">    {<span class='string_literal'>"config"</span>,configCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="754"><td class="num" id="LN754">754</td><td class="line">     <span class='string_literal'>"admin ok-loading ok-stale no-script"</span>,</td></tr>
<tr class="codeline" data-linenumber="755"><td class="num" id="LN755">755</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="756"><td class="num" id="LN756">756</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="757"><td class="num" id="LN757">757</td><td class="line">    {<span class='string_literal'>"subscribe"</span>,subscribeCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="758"><td class="num" id="LN758">758</td><td class="line">     <span class='string_literal'>"pub-sub no-script ok-loading ok-stale"</span>,</td></tr>
<tr class="codeline" data-linenumber="759"><td class="num" id="LN759">759</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="760"><td class="num" id="LN760">760</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="761"><td class="num" id="LN761">761</td><td class="line">    {<span class='string_literal'>"unsubscribe"</span>,unsubscribeCommand,-1,</td></tr>
<tr class="codeline" data-linenumber="762"><td class="num" id="LN762">762</td><td class="line">     <span class='string_literal'>"pub-sub no-script ok-loading ok-stale"</span>,</td></tr>
<tr class="codeline" data-linenumber="763"><td class="num" id="LN763">763</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="764"><td class="num" id="LN764">764</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="765"><td class="num" id="LN765">765</td><td class="line">    {<span class='string_literal'>"psubscribe"</span>,psubscribeCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="766"><td class="num" id="LN766">766</td><td class="line">     <span class='string_literal'>"pub-sub no-script ok-loading ok-stale"</span>,</td></tr>
<tr class="codeline" data-linenumber="767"><td class="num" id="LN767">767</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="768"><td class="num" id="LN768">768</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="769"><td class="num" id="LN769">769</td><td class="line">    {<span class='string_literal'>"punsubscribe"</span>,punsubscribeCommand,-1,</td></tr>
<tr class="codeline" data-linenumber="770"><td class="num" id="LN770">770</td><td class="line">     <span class='string_literal'>"pub-sub no-script ok-loading ok-stale"</span>,</td></tr>
<tr class="codeline" data-linenumber="771"><td class="num" id="LN771">771</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="772"><td class="num" id="LN772">772</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="773"><td class="num" id="LN773">773</td><td class="line">    {<span class='string_literal'>"publish"</span>,publishCommand,3,</td></tr>
<tr class="codeline" data-linenumber="774"><td class="num" id="LN774">774</td><td class="line">     <span class='string_literal'>"pub-sub ok-loading ok-stale fast"</span>,</td></tr>
<tr class="codeline" data-linenumber="775"><td class="num" id="LN775">775</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="776"><td class="num" id="LN776">776</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="777"><td class="num" id="LN777">777</td><td class="line">    {<span class='string_literal'>"pubsub"</span>,pubsubCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="778"><td class="num" id="LN778">778</td><td class="line">     <span class='string_literal'>"pub-sub ok-loading ok-stale random"</span>,</td></tr>
<tr class="codeline" data-linenumber="779"><td class="num" id="LN779">779</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="780"><td class="num" id="LN780">780</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="781"><td class="num" id="LN781">781</td><td class="line">    {<span class='string_literal'>"watch"</span>,watchCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="782"><td class="num" id="LN782">782</td><td class="line">     <span class='string_literal'>"no-script fast ok-loading ok-stale @transaction"</span>,</td></tr>
<tr class="codeline" data-linenumber="783"><td class="num" id="LN783">783</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,-1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="784"><td class="num" id="LN784">784</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="785"><td class="num" id="LN785">785</td><td class="line">    {<span class='string_literal'>"unwatch"</span>,unwatchCommand,1,</td></tr>
<tr class="codeline" data-linenumber="786"><td class="num" id="LN786">786</td><td class="line">     <span class='string_literal'>"no-script fast ok-loading ok-stale @transaction"</span>,</td></tr>
<tr class="codeline" data-linenumber="787"><td class="num" id="LN787">787</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="788"><td class="num" id="LN788">788</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="789"><td class="num" id="LN789">789</td><td class="line">    {<span class='string_literal'>"cluster"</span>,clusterCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="790"><td class="num" id="LN790">790</td><td class="line">     <span class='string_literal'>"admin ok-stale random"</span>,</td></tr>
<tr class="codeline" data-linenumber="791"><td class="num" id="LN791">791</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="792"><td class="num" id="LN792">792</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="793"><td class="num" id="LN793">793</td><td class="line">    {<span class='string_literal'>"restore"</span>,restoreCommand,-4,</td></tr>
<tr class="codeline" data-linenumber="794"><td class="num" id="LN794">794</td><td class="line">     <span class='string_literal'>"write use-memory @keyspace @dangerous"</span>,</td></tr>
<tr class="codeline" data-linenumber="795"><td class="num" id="LN795">795</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="796"><td class="num" id="LN796">796</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="797"><td class="num" id="LN797">797</td><td class="line">    {<span class='string_literal'>"restore-asking"</span>,restoreCommand,-4,</td></tr>
<tr class="codeline" data-linenumber="798"><td class="num" id="LN798">798</td><td class="line">    <span class='string_literal'>"write use-memory cluster-asking @keyspace @dangerous"</span>,</td></tr>
<tr class="codeline" data-linenumber="799"><td class="num" id="LN799">799</td><td class="line">    0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="800"><td class="num" id="LN800">800</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="801"><td class="num" id="LN801">801</td><td class="line">    {<span class='string_literal'>"migrate"</span>,migrateCommand,-6,</td></tr>
<tr class="codeline" data-linenumber="802"><td class="num" id="LN802">802</td><td class="line">     <span class='string_literal'>"write random @keyspace @dangerous"</span>,</td></tr>
<tr class="codeline" data-linenumber="803"><td class="num" id="LN803">803</td><td class="line">     0,migrateGetKeys,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="804"><td class="num" id="LN804">804</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="805"><td class="num" id="LN805">805</td><td class="line">    {<span class='string_literal'>"asking"</span>,askingCommand,1,</td></tr>
<tr class="codeline" data-linenumber="806"><td class="num" id="LN806">806</td><td class="line">     <span class='string_literal'>"fast @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="807"><td class="num" id="LN807">807</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="808"><td class="num" id="LN808">808</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="809"><td class="num" id="LN809">809</td><td class="line">    {<span class='string_literal'>"readonly"</span>,readonlyCommand,1,</td></tr>
<tr class="codeline" data-linenumber="810"><td class="num" id="LN810">810</td><td class="line">     <span class='string_literal'>"fast @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="811"><td class="num" id="LN811">811</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="812"><td class="num" id="LN812">812</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="813"><td class="num" id="LN813">813</td><td class="line">    {<span class='string_literal'>"readwrite"</span>,readwriteCommand,1,</td></tr>
<tr class="codeline" data-linenumber="814"><td class="num" id="LN814">814</td><td class="line">     <span class='string_literal'>"fast @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="815"><td class="num" id="LN815">815</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="816"><td class="num" id="LN816">816</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="817"><td class="num" id="LN817">817</td><td class="line">    {<span class='string_literal'>"dump"</span>,dumpCommand,2,</td></tr>
<tr class="codeline" data-linenumber="818"><td class="num" id="LN818">818</td><td class="line">     <span class='string_literal'>"read-only random @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="819"><td class="num" id="LN819">819</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="820"><td class="num" id="LN820">820</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="821"><td class="num" id="LN821">821</td><td class="line">    {<span class='string_literal'>"object"</span>,objectCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="822"><td class="num" id="LN822">822</td><td class="line">     <span class='string_literal'>"read-only random @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="823"><td class="num" id="LN823">823</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,2,2,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="824"><td class="num" id="LN824">824</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="825"><td class="num" id="LN825">825</td><td class="line">    {<span class='string_literal'>"memory"</span>,memoryCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="826"><td class="num" id="LN826">826</td><td class="line">     <span class='string_literal'>"random read-only"</span>,</td></tr>
<tr class="codeline" data-linenumber="827"><td class="num" id="LN827">827</td><td class="line">     0,memoryGetKeys,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="828"><td class="num" id="LN828">828</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="829"><td class="num" id="LN829">829</td><td class="line">    {<span class='string_literal'>"client"</span>,clientCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="830"><td class="num" id="LN830">830</td><td class="line">     <span class='string_literal'>"admin no-script random ok-loading ok-stale @connection"</span>,</td></tr>
<tr class="codeline" data-linenumber="831"><td class="num" id="LN831">831</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="832"><td class="num" id="LN832">832</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="833"><td class="num" id="LN833">833</td><td class="line">    {<span class='string_literal'>"hello"</span>,helloCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="834"><td class="num" id="LN834">834</td><td class="line">     <span class='string_literal'>"no-auth no-script fast no-monitor ok-loading ok-stale no-slowlog @connection"</span>,</td></tr>
<tr class="codeline" data-linenumber="835"><td class="num" id="LN835">835</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="836"><td class="num" id="LN836">836</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="837"><td class="num" id="LN837">837</td><td class="line">    <span class='comment'>/* EVAL can modify the dataset, however it is not flagged as a write</span></td></tr>
<tr class="codeline" data-linenumber="838"><td class="num" id="LN838">838</td><td class="line">     <span class='comment'>* command since we do the check while running commands from Lua. */</span></td></tr>
<tr class="codeline" data-linenumber="839"><td class="num" id="LN839">839</td><td class="line">    {<span class='string_literal'>"eval"</span>,evalCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="840"><td class="num" id="LN840">840</td><td class="line">     <span class='string_literal'>"no-script @scripting"</span>,</td></tr>
<tr class="codeline" data-linenumber="841"><td class="num" id="LN841">841</td><td class="line">     0,evalGetKeys,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="842"><td class="num" id="LN842">842</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="843"><td class="num" id="LN843">843</td><td class="line">    {<span class='string_literal'>"evalsha"</span>,evalShaCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="844"><td class="num" id="LN844">844</td><td class="line">     <span class='string_literal'>"no-script @scripting"</span>,</td></tr>
<tr class="codeline" data-linenumber="845"><td class="num" id="LN845">845</td><td class="line">     0,evalGetKeys,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="846"><td class="num" id="LN846">846</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="847"><td class="num" id="LN847">847</td><td class="line">    {<span class='string_literal'>"slowlog"</span>,slowlogCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="848"><td class="num" id="LN848">848</td><td class="line">     <span class='string_literal'>"admin random ok-loading ok-stale"</span>,</td></tr>
<tr class="codeline" data-linenumber="849"><td class="num" id="LN849">849</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="850"><td class="num" id="LN850">850</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="851"><td class="num" id="LN851">851</td><td class="line">    {<span class='string_literal'>"script"</span>,scriptCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="852"><td class="num" id="LN852">852</td><td class="line">     <span class='string_literal'>"no-script @scripting"</span>,</td></tr>
<tr class="codeline" data-linenumber="853"><td class="num" id="LN853">853</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="854"><td class="num" id="LN854">854</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="855"><td class="num" id="LN855">855</td><td class="line">    {<span class='string_literal'>"time"</span>,timeCommand,1,</td></tr>
<tr class="codeline" data-linenumber="856"><td class="num" id="LN856">856</td><td class="line">     <span class='string_literal'>"read-only random fast ok-loading ok-stale"</span>,</td></tr>
<tr class="codeline" data-linenumber="857"><td class="num" id="LN857">857</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="858"><td class="num" id="LN858">858</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="859"><td class="num" id="LN859">859</td><td class="line">    {<span class='string_literal'>"bitop"</span>,bitopCommand,-4,</td></tr>
<tr class="codeline" data-linenumber="860"><td class="num" id="LN860">860</td><td class="line">     <span class='string_literal'>"write use-memory @bitmap"</span>,</td></tr>
<tr class="codeline" data-linenumber="861"><td class="num" id="LN861">861</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,2,-1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="862"><td class="num" id="LN862">862</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="863"><td class="num" id="LN863">863</td><td class="line">    {<span class='string_literal'>"bitcount"</span>,bitcountCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="864"><td class="num" id="LN864">864</td><td class="line">     <span class='string_literal'>"read-only @bitmap"</span>,</td></tr>
<tr class="codeline" data-linenumber="865"><td class="num" id="LN865">865</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="866"><td class="num" id="LN866">866</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="867"><td class="num" id="LN867">867</td><td class="line">    {<span class='string_literal'>"bitpos"</span>,bitposCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="868"><td class="num" id="LN868">868</td><td class="line">     <span class='string_literal'>"read-only @bitmap"</span>,</td></tr>
<tr class="codeline" data-linenumber="869"><td class="num" id="LN869">869</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="870"><td class="num" id="LN870">870</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="871"><td class="num" id="LN871">871</td><td class="line">    {<span class='string_literal'>"wait"</span>,waitCommand,3,</td></tr>
<tr class="codeline" data-linenumber="872"><td class="num" id="LN872">872</td><td class="line">     <span class='string_literal'>"no-script @keyspace"</span>,</td></tr>
<tr class="codeline" data-linenumber="873"><td class="num" id="LN873">873</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="874"><td class="num" id="LN874">874</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="875"><td class="num" id="LN875">875</td><td class="line">    {<span class='string_literal'>"command"</span>,commandCommand,-1,</td></tr>
<tr class="codeline" data-linenumber="876"><td class="num" id="LN876">876</td><td class="line">     <span class='string_literal'>"ok-loading ok-stale random @connection"</span>,</td></tr>
<tr class="codeline" data-linenumber="877"><td class="num" id="LN877">877</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="878"><td class="num" id="LN878">878</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="879"><td class="num" id="LN879">879</td><td class="line">    {<span class='string_literal'>"geoadd"</span>,geoaddCommand,-5,</td></tr>
<tr class="codeline" data-linenumber="880"><td class="num" id="LN880">880</td><td class="line">     <span class='string_literal'>"write use-memory @geo"</span>,</td></tr>
<tr class="codeline" data-linenumber="881"><td class="num" id="LN881">881</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="882"><td class="num" id="LN882">882</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="883"><td class="num" id="LN883">883</td><td class="line">    <span class='comment'>/* GEORADIUS has store options that may write. */</span></td></tr>
<tr class="codeline" data-linenumber="884"><td class="num" id="LN884">884</td><td class="line">    {<span class='string_literal'>"georadius"</span>,georadiusCommand,-6,</td></tr>
<tr class="codeline" data-linenumber="885"><td class="num" id="LN885">885</td><td class="line">     <span class='string_literal'>"write @geo"</span>,</td></tr>
<tr class="codeline" data-linenumber="886"><td class="num" id="LN886">886</td><td class="line">     0,georadiusGetKeys,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="887"><td class="num" id="LN887">887</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="888"><td class="num" id="LN888">888</td><td class="line">    {<span class='string_literal'>"georadius_ro"</span>,georadiusroCommand,-6,</td></tr>
<tr class="codeline" data-linenumber="889"><td class="num" id="LN889">889</td><td class="line">     <span class='string_literal'>"read-only @geo"</span>,</td></tr>
<tr class="codeline" data-linenumber="890"><td class="num" id="LN890">890</td><td class="line">     0,georadiusGetKeys,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="891"><td class="num" id="LN891">891</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="892"><td class="num" id="LN892">892</td><td class="line">    {<span class='string_literal'>"georadiusbymember"</span>,georadiusbymemberCommand,-5,</td></tr>
<tr class="codeline" data-linenumber="893"><td class="num" id="LN893">893</td><td class="line">     <span class='string_literal'>"write @geo"</span>,</td></tr>
<tr class="codeline" data-linenumber="894"><td class="num" id="LN894">894</td><td class="line">     0,georadiusGetKeys,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="895"><td class="num" id="LN895">895</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="896"><td class="num" id="LN896">896</td><td class="line">    {<span class='string_literal'>"georadiusbymember_ro"</span>,georadiusbymemberroCommand,-5,</td></tr>
<tr class="codeline" data-linenumber="897"><td class="num" id="LN897">897</td><td class="line">     <span class='string_literal'>"read-only @geo"</span>,</td></tr>
<tr class="codeline" data-linenumber="898"><td class="num" id="LN898">898</td><td class="line">     0,georadiusGetKeys,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="899"><td class="num" id="LN899">899</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="900"><td class="num" id="LN900">900</td><td class="line">    {<span class='string_literal'>"geohash"</span>,geohashCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="901"><td class="num" id="LN901">901</td><td class="line">     <span class='string_literal'>"read-only @geo"</span>,</td></tr>
<tr class="codeline" data-linenumber="902"><td class="num" id="LN902">902</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="903"><td class="num" id="LN903">903</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="904"><td class="num" id="LN904">904</td><td class="line">    {<span class='string_literal'>"geopos"</span>,geoposCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="905"><td class="num" id="LN905">905</td><td class="line">     <span class='string_literal'>"read-only @geo"</span>,</td></tr>
<tr class="codeline" data-linenumber="906"><td class="num" id="LN906">906</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="907"><td class="num" id="LN907">907</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="908"><td class="num" id="LN908">908</td><td class="line">    {<span class='string_literal'>"geodist"</span>,geodistCommand,-4,</td></tr>
<tr class="codeline" data-linenumber="909"><td class="num" id="LN909">909</td><td class="line">     <span class='string_literal'>"read-only @geo"</span>,</td></tr>
<tr class="codeline" data-linenumber="910"><td class="num" id="LN910">910</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="911"><td class="num" id="LN911">911</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="912"><td class="num" id="LN912">912</td><td class="line">    {<span class='string_literal'>"pfselftest"</span>,pfselftestCommand,1,</td></tr>
<tr class="codeline" data-linenumber="913"><td class="num" id="LN913">913</td><td class="line">     <span class='string_literal'>"admin @hyperloglog"</span>,</td></tr>
<tr class="codeline" data-linenumber="914"><td class="num" id="LN914">914</td><td class="line">      0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="915"><td class="num" id="LN915">915</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="916"><td class="num" id="LN916">916</td><td class="line">    {<span class='string_literal'>"pfadd"</span>,pfaddCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="917"><td class="num" id="LN917">917</td><td class="line">     <span class='string_literal'>"write use-memory fast @hyperloglog"</span>,</td></tr>
<tr class="codeline" data-linenumber="918"><td class="num" id="LN918">918</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="919"><td class="num" id="LN919">919</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="920"><td class="num" id="LN920">920</td><td class="line">    <span class='comment'>/* Technically speaking PFCOUNT may change the key since it changes the</span></td></tr>
<tr class="codeline" data-linenumber="921"><td class="num" id="LN921">921</td><td class="line">     <span class='comment'>* final bytes in the HyperLogLog representation. However in this case</span></td></tr>
<tr class="codeline" data-linenumber="922"><td class="num" id="LN922">922</td><td class="line">     <span class='comment'>* we claim that the representation, even if accessible, is an internal</span></td></tr>
<tr class="codeline" data-linenumber="923"><td class="num" id="LN923">923</td><td class="line">     <span class='comment'>* affair, and the command is semantically read only. */</span></td></tr>
<tr class="codeline" data-linenumber="924"><td class="num" id="LN924">924</td><td class="line">    {<span class='string_literal'>"pfcount"</span>,pfcountCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="925"><td class="num" id="LN925">925</td><td class="line">     <span class='string_literal'>"read-only @hyperloglog"</span>,</td></tr>
<tr class="codeline" data-linenumber="926"><td class="num" id="LN926">926</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,-1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="927"><td class="num" id="LN927">927</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="928"><td class="num" id="LN928">928</td><td class="line">    {<span class='string_literal'>"pfmerge"</span>,pfmergeCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="929"><td class="num" id="LN929">929</td><td class="line">     <span class='string_literal'>"write use-memory @hyperloglog"</span>,</td></tr>
<tr class="codeline" data-linenumber="930"><td class="num" id="LN930">930</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,-1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="931"><td class="num" id="LN931">931</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="932"><td class="num" id="LN932">932</td><td class="line">    {<span class='string_literal'>"pfdebug"</span>,pfdebugCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="933"><td class="num" id="LN933">933</td><td class="line">     <span class='string_literal'>"admin write"</span>,</td></tr>
<tr class="codeline" data-linenumber="934"><td class="num" id="LN934">934</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="935"><td class="num" id="LN935">935</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="936"><td class="num" id="LN936">936</td><td class="line">    {<span class='string_literal'>"xadd"</span>,xaddCommand,-5,</td></tr>
<tr class="codeline" data-linenumber="937"><td class="num" id="LN937">937</td><td class="line">     <span class='string_literal'>"write use-memory fast random @stream"</span>,</td></tr>
<tr class="codeline" data-linenumber="938"><td class="num" id="LN938">938</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="939"><td class="num" id="LN939">939</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="940"><td class="num" id="LN940">940</td><td class="line">    {<span class='string_literal'>"xrange"</span>,xrangeCommand,-4,</td></tr>
<tr class="codeline" data-linenumber="941"><td class="num" id="LN941">941</td><td class="line">     <span class='string_literal'>"read-only @stream"</span>,</td></tr>
<tr class="codeline" data-linenumber="942"><td class="num" id="LN942">942</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="943"><td class="num" id="LN943">943</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="944"><td class="num" id="LN944">944</td><td class="line">    {<span class='string_literal'>"xrevrange"</span>,xrevrangeCommand,-4,</td></tr>
<tr class="codeline" data-linenumber="945"><td class="num" id="LN945">945</td><td class="line">     <span class='string_literal'>"read-only @stream"</span>,</td></tr>
<tr class="codeline" data-linenumber="946"><td class="num" id="LN946">946</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="947"><td class="num" id="LN947">947</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="948"><td class="num" id="LN948">948</td><td class="line">    {<span class='string_literal'>"xlen"</span>,xlenCommand,2,</td></tr>
<tr class="codeline" data-linenumber="949"><td class="num" id="LN949">949</td><td class="line">     <span class='string_literal'>"read-only fast @stream"</span>,</td></tr>
<tr class="codeline" data-linenumber="950"><td class="num" id="LN950">950</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="951"><td class="num" id="LN951">951</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="952"><td class="num" id="LN952">952</td><td class="line">    {<span class='string_literal'>"xread"</span>,xreadCommand,-4,</td></tr>
<tr class="codeline" data-linenumber="953"><td class="num" id="LN953">953</td><td class="line">     <span class='string_literal'>"read-only @stream @blocking"</span>,</td></tr>
<tr class="codeline" data-linenumber="954"><td class="num" id="LN954">954</td><td class="line">     0,xreadGetKeys,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="955"><td class="num" id="LN955">955</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="956"><td class="num" id="LN956">956</td><td class="line">    {<span class='string_literal'>"xreadgroup"</span>,xreadCommand,-7,</td></tr>
<tr class="codeline" data-linenumber="957"><td class="num" id="LN957">957</td><td class="line">     <span class='string_literal'>"write @stream @blocking"</span>,</td></tr>
<tr class="codeline" data-linenumber="958"><td class="num" id="LN958">958</td><td class="line">     0,xreadGetKeys,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="959"><td class="num" id="LN959">959</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="960"><td class="num" id="LN960">960</td><td class="line">    {<span class='string_literal'>"xgroup"</span>,xgroupCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="961"><td class="num" id="LN961">961</td><td class="line">     <span class='string_literal'>"write use-memory @stream"</span>,</td></tr>
<tr class="codeline" data-linenumber="962"><td class="num" id="LN962">962</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,2,2,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="963"><td class="num" id="LN963">963</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="964"><td class="num" id="LN964">964</td><td class="line">    {<span class='string_literal'>"xsetid"</span>,xsetidCommand,3,</td></tr>
<tr class="codeline" data-linenumber="965"><td class="num" id="LN965">965</td><td class="line">     <span class='string_literal'>"write use-memory fast @stream"</span>,</td></tr>
<tr class="codeline" data-linenumber="966"><td class="num" id="LN966">966</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="967"><td class="num" id="LN967">967</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="968"><td class="num" id="LN968">968</td><td class="line">    {<span class='string_literal'>"xack"</span>,xackCommand,-4,</td></tr>
<tr class="codeline" data-linenumber="969"><td class="num" id="LN969">969</td><td class="line">     <span class='string_literal'>"write fast random @stream"</span>,</td></tr>
<tr class="codeline" data-linenumber="970"><td class="num" id="LN970">970</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="971"><td class="num" id="LN971">971</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="972"><td class="num" id="LN972">972</td><td class="line">    {<span class='string_literal'>"xpending"</span>,xpendingCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="973"><td class="num" id="LN973">973</td><td class="line">     <span class='string_literal'>"read-only random @stream"</span>,</td></tr>
<tr class="codeline" data-linenumber="974"><td class="num" id="LN974">974</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="975"><td class="num" id="LN975">975</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="976"><td class="num" id="LN976">976</td><td class="line">    {<span class='string_literal'>"xclaim"</span>,xclaimCommand,-6,</td></tr>
<tr class="codeline" data-linenumber="977"><td class="num" id="LN977">977</td><td class="line">     <span class='string_literal'>"write random fast @stream"</span>,</td></tr>
<tr class="codeline" data-linenumber="978"><td class="num" id="LN978">978</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="979"><td class="num" id="LN979">979</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="980"><td class="num" id="LN980">980</td><td class="line">    {<span class='string_literal'>"xinfo"</span>,xinfoCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="981"><td class="num" id="LN981">981</td><td class="line">     <span class='string_literal'>"read-only random @stream"</span>,</td></tr>
<tr class="codeline" data-linenumber="982"><td class="num" id="LN982">982</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,2,2,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="983"><td class="num" id="LN983">983</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="984"><td class="num" id="LN984">984</td><td class="line">    {<span class='string_literal'>"xdel"</span>,xdelCommand,-3,</td></tr>
<tr class="codeline" data-linenumber="985"><td class="num" id="LN985">985</td><td class="line">     <span class='string_literal'>"write fast @stream"</span>,</td></tr>
<tr class="codeline" data-linenumber="986"><td class="num" id="LN986">986</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="987"><td class="num" id="LN987">987</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="988"><td class="num" id="LN988">988</td><td class="line">    {<span class='string_literal'>"xtrim"</span>,xtrimCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="989"><td class="num" id="LN989">989</td><td class="line">     <span class='string_literal'>"write random @stream"</span>,</td></tr>
<tr class="codeline" data-linenumber="990"><td class="num" id="LN990">990</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,1,1,1,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="991"><td class="num" id="LN991">991</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="992"><td class="num" id="LN992">992</td><td class="line">    {<span class='string_literal'>"post"</span>,securityWarningCommand,-1,</td></tr>
<tr class="codeline" data-linenumber="993"><td class="num" id="LN993">993</td><td class="line">     <span class='string_literal'>"ok-loading ok-stale read-only"</span>,</td></tr>
<tr class="codeline" data-linenumber="994"><td class="num" id="LN994">994</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="995"><td class="num" id="LN995">995</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="996"><td class="num" id="LN996">996</td><td class="line">    {<span class='string_literal'>"host:"</span>,securityWarningCommand,-1,</td></tr>
<tr class="codeline" data-linenumber="997"><td class="num" id="LN997">997</td><td class="line">     <span class='string_literal'>"ok-loading ok-stale read-only"</span>,</td></tr>
<tr class="codeline" data-linenumber="998"><td class="num" id="LN998">998</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="999"><td class="num" id="LN999">999</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1000"><td class="num" id="LN1000">1000</td><td class="line">    {<span class='string_literal'>"latency"</span>,latencyCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="1001"><td class="num" id="LN1001">1001</td><td class="line">     <span class='string_literal'>"admin no-script ok-loading ok-stale"</span>,</td></tr>
<tr class="codeline" data-linenumber="1002"><td class="num" id="LN1002">1002</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="1003"><td class="num" id="LN1003">1003</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1004"><td class="num" id="LN1004">1004</td><td class="line">    {<span class='string_literal'>"lolwut"</span>,lolwutCommand,-1,</td></tr>
<tr class="codeline" data-linenumber="1005"><td class="num" id="LN1005">1005</td><td class="line">     <span class='string_literal'>"read-only fast"</span>,</td></tr>
<tr class="codeline" data-linenumber="1006"><td class="num" id="LN1006">1006</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="1007"><td class="num" id="LN1007">1007</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1008"><td class="num" id="LN1008">1008</td><td class="line">    {<span class='string_literal'>"acl"</span>,aclCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="1009"><td class="num" id="LN1009">1009</td><td class="line">     <span class='string_literal'>"admin no-script no-slowlog ok-loading ok-stale"</span>,</td></tr>
<tr class="codeline" data-linenumber="1010"><td class="num" id="LN1010">1010</td><td class="line">     0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0,0,0,0,0},</td></tr>
<tr class="codeline" data-linenumber="1011"><td class="num" id="LN1011">1011</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1012"><td class="num" id="LN1012">1012</td><td class="line">    {<span class='string_literal'>"stralgo"</span>,stralgoCommand,-2,</td></tr>
<tr class="codeline" data-linenumber="1013"><td class="num" id="LN1013">1013</td><td class="line">     <span class='string_literal'>"read-only @string"</span>,</td></tr>
<tr class="codeline" data-linenumber="1014"><td class="num" id="LN1014">1014</td><td class="line">     0,lcsGetKeys,0,0,0,0,0,0}</td></tr>
<tr class="codeline" data-linenumber="1015"><td class="num" id="LN1015">1015</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="1016"><td class="num" id="LN1016">1016</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1017"><td class="num" id="LN1017">1017</td><td class="line"><span class='comment'>/*============================ Utility functions ============================ */</span></td></tr>
<tr class="codeline" data-linenumber="1018"><td class="num" id="LN1018">1018</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1019"><td class="num" id="LN1019">1019</td><td class="line"><span class='comment'>/* We use a private localtime implementation which is fork-safe. The logging</span></td></tr>
<tr class="codeline" data-linenumber="1020"><td class="num" id="LN1020">1020</td><td class="line"> <span class='comment'>* function of Redis may be called from other threads. */</span></td></tr>
<tr class="codeline" data-linenumber="1021"><td class="num" id="LN1021">1021</td><td class="line"><span class='keyword'>void</span> nolocks_localtime(<span class='keyword'>struct</span> tm *tmp, time_t t, time_t tz, <span class='keyword'>int</span> dst);</td></tr>
<tr class="codeline" data-linenumber="1022"><td class="num" id="LN1022">1022</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1023"><td class="num" id="LN1023">1023</td><td class="line"><span class='comment'>/* Low level logging. To use only for very big messages, otherwise</span></td></tr>
<tr class="codeline" data-linenumber="1024"><td class="num" id="LN1024">1024</td><td class="line"> <span class='comment'>* serverLog() is to prefer. */</span></td></tr>
<tr class="codeline" data-linenumber="1025"><td class="num" id="LN1025">1025</td><td class="line"><span class='keyword'>void</span> serverLogRaw(<span class='keyword'>int</span> level, <span class='keyword'>const</span> <span class='keyword'>char</span> *msg) {</td></tr>
<tr class="codeline" data-linenumber="1026"><td class="num" id="LN1026">1026</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>int</span> syslogLevelMap[] = { <span class='macro'>LOG_DEBUG<span class='macro_popup'>7</span></span>, <span class='macro'>LOG_INFO<span class='macro_popup'>6</span></span>, <span class='macro'>LOG_NOTICE<span class='macro_popup'>5</span></span>, <span class='macro'>LOG_WARNING<span class='macro_popup'>4</span></span> };</td></tr>
<tr class="codeline" data-linenumber="1027"><td class="num" id="LN1027">1027</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span> *c = <span class='string_literal'>".-*#"</span>;</td></tr>
<tr class="codeline" data-linenumber="1028"><td class="num" id="LN1028">1028</td><td class="line">    FILE *fp;</td></tr>
<tr class="codeline" data-linenumber="1029"><td class="num" id="LN1029">1029</td><td class="line">    <span class='keyword'>char</span> buf[64];</td></tr>
<tr class="codeline" data-linenumber="1030"><td class="num" id="LN1030">1030</td><td class="line">    <span class='keyword'>int</span> rawmode = (level &amp; <span class='macro'>LL_RAW<span class='macro_popup'>(1&lt;&lt;10)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1031"><td class="num" id="LN1031">1031</td><td class="line">    <span class='keyword'>int</span> log_to_stdout = server.logfile[0] == '\0';</td></tr>
<tr class="codeline" data-linenumber="1032"><td class="num" id="LN1032">1032</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1033"><td class="num" id="LN1033">1033</td><td class="line">    level &amp;= 0xff; <span class='comment'>/* clear flags */</span></td></tr>
<tr class="codeline" data-linenumber="1034"><td class="num" id="LN1034">1034</td><td class="line">    <span class='keyword'>if</span> (level &lt; server.verbosity) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1035"><td class="num" id="LN1035">1035</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1036"><td class="num" id="LN1036">1036</td><td class="line">    fp = log_to_stdout ? <span class='macro'>stdout<span class='macro_popup'>stdout</span></span> : fopen(server.logfile,<span class='string_literal'>"a"</span>);</td></tr>
<tr class="codeline" data-linenumber="1037"><td class="num" id="LN1037">1037</td><td class="line">    <span class='keyword'>if</span> (!fp) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1038"><td class="num" id="LN1038">1038</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1039"><td class="num" id="LN1039">1039</td><td class="line">    <span class='keyword'>if</span> (rawmode) {</td></tr>
<tr class="codeline" data-linenumber="1040"><td class="num" id="LN1040">1040</td><td class="line">        fprintf(fp,<span class='string_literal'>"%s"</span>,msg);</td></tr>
<tr class="codeline" data-linenumber="1041"><td class="num" id="LN1041">1041</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1042"><td class="num" id="LN1042">1042</td><td class="line">        <span class='keyword'>int</span> off;</td></tr>
<tr class="codeline" data-linenumber="1043"><td class="num" id="LN1043">1043</td><td class="line">        <span class='keyword'>struct</span> timeval tv;</td></tr>
<tr class="codeline" data-linenumber="1044"><td class="num" id="LN1044">1044</td><td class="line">        <span class='keyword'>int</span> role_char;</td></tr>
<tr class="codeline" data-linenumber="1045"><td class="num" id="LN1045">1045</td><td class="line">        pid_t pid = getpid();</td></tr>
<tr class="codeline" data-linenumber="1046"><td class="num" id="LN1046">1046</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1047"><td class="num" id="LN1047">1047</td><td class="line">        gettimeofday(&amp;tv,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1048"><td class="num" id="LN1048">1048</td><td class="line">        <span class='keyword'>struct</span> tm tm;</td></tr>
<tr class="codeline" data-linenumber="1049"><td class="num" id="LN1049">1049</td><td class="line">        nolocks_localtime(&amp;tm,tv.tv_sec,server.timezone,server.daylight_active);</td></tr>
<tr class="codeline" data-linenumber="1050"><td class="num" id="LN1050">1050</td><td class="line">        off = strftime(buf,<span class='keyword'>sizeof</span>(buf),<span class='string_literal'>"%d %b %Y %H:%M:%S."</span>,&amp;tm);</td></tr>
<tr class="codeline" data-linenumber="1051"><td class="num" id="LN1051">1051</td><td class="line">        snprintf(buf+off,<span class='keyword'>sizeof</span>(buf)-off,<span class='string_literal'>"%03d"</span>,(<span class='keyword'>int</span>)tv.tv_usec/1000);</td></tr>
<tr class="codeline" data-linenumber="1052"><td class="num" id="LN1052">1052</td><td class="line">        <span class='keyword'>if</span> (server.sentinel_mode) {</td></tr>
<tr class="codeline" data-linenumber="1053"><td class="num" id="LN1053">1053</td><td class="line">            role_char = 'X'; <span class='comment'>/* Sentinel. */</span></td></tr>
<tr class="codeline" data-linenumber="1054"><td class="num" id="LN1054">1054</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (pid != server.pid) {</td></tr>
<tr class="codeline" data-linenumber="1055"><td class="num" id="LN1055">1055</td><td class="line">            role_char = 'C'; <span class='comment'>/* RDB / AOF writing child. */</span></td></tr>
<tr class="codeline" data-linenumber="1056"><td class="num" id="LN1056">1056</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1057"><td class="num" id="LN1057">1057</td><td class="line">            role_char = (server.masterhost ? 'S':'M'); <span class='comment'>/* Slave or Master. */</span></td></tr>
<tr class="codeline" data-linenumber="1058"><td class="num" id="LN1058">1058</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1059"><td class="num" id="LN1059">1059</td><td class="line">        fprintf(fp,<span class='string_literal'>"%d:%c %s %c %s\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="1060"><td class="num" id="LN1060">1060</td><td class="line">            (<span class='keyword'>int</span>)getpid(),role_char, buf,c[level],msg);</td></tr>
<tr class="codeline" data-linenumber="1061"><td class="num" id="LN1061">1061</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1062"><td class="num" id="LN1062">1062</td><td class="line">    fflush(fp);</td></tr>
<tr class="codeline" data-linenumber="1063"><td class="num" id="LN1063">1063</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1064"><td class="num" id="LN1064">1064</td><td class="line">    <span class='keyword'>if</span> (!log_to_stdout) fclose(fp);</td></tr>
<tr class="codeline" data-linenumber="1065"><td class="num" id="LN1065">1065</td><td class="line">    <span class='keyword'>if</span> (server.syslog_enabled) syslog(syslogLevelMap[level], <span class='string_literal'>"%s"</span>, msg);</td></tr>
<tr class="codeline" data-linenumber="1066"><td class="num" id="LN1066">1066</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1067"><td class="num" id="LN1067">1067</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1068"><td class="num" id="LN1068">1068</td><td class="line"><span class='comment'>/* Like serverLogRaw() but with printf-alike support. This is the function that</span></td></tr>
<tr class="codeline" data-linenumber="1069"><td class="num" id="LN1069">1069</td><td class="line"> <span class='comment'>* is used across the code. The raw version is only used in order to dump</span></td></tr>
<tr class="codeline" data-linenumber="1070"><td class="num" id="LN1070">1070</td><td class="line"> <span class='comment'>* the INFO output on crash. */</span></td></tr>
<tr class="codeline" data-linenumber="1071"><td class="num" id="LN1071">1071</td><td class="line"><span class='keyword'>void</span> serverLog(<span class='keyword'>int</span> level, <span class='keyword'>const</span> <span class='keyword'>char</span> *fmt, ...) {</td></tr>
<tr class="codeline" data-linenumber="1072"><td class="num" id="LN1072">1072</td><td class="line">    va_list ap;</td></tr>
<tr class="codeline" data-linenumber="1073"><td class="num" id="LN1073">1073</td><td class="line">    <span class='keyword'>char</span> msg[<span class='macro'>LOG_MAX_LEN<span class='macro_popup'>1024</span></span>];</td></tr>
<tr class="codeline" data-linenumber="1074"><td class="num" id="LN1074">1074</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1075"><td class="num" id="LN1075">1075</td><td class="line">    <span class='keyword'>if</span> ((level&amp;0xff) &lt; server.verbosity) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1076"><td class="num" id="LN1076">1076</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1077"><td class="num" id="LN1077">1077</td><td class="line">    <span class='macro'>va_start(ap, fmt)<span class='macro_popup'>__builtin_va_start(ap, fmt)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1078"><td class="num" id="LN1078">1078</td><td class="line">    vsnprintf(msg, <span class='keyword'>sizeof</span>(msg), fmt, ap);</td></tr>
<tr class="codeline" data-linenumber="1079"><td class="num" id="LN1079">1079</td><td class="line">    <span class='macro'>va_end(ap)<span class='macro_popup'>__builtin_va_end(ap)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1080"><td class="num" id="LN1080">1080</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1081"><td class="num" id="LN1081">1081</td><td class="line">    serverLogRaw(level,msg);</td></tr>
<tr class="codeline" data-linenumber="1082"><td class="num" id="LN1082">1082</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1083"><td class="num" id="LN1083">1083</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1084"><td class="num" id="LN1084">1084</td><td class="line"><span class='comment'>/* Log a fixed message without printf-alike capabilities, in a way that is</span></td></tr>
<tr class="codeline" data-linenumber="1085"><td class="num" id="LN1085">1085</td><td class="line"> <span class='comment'>* safe to call from a signal handler.</span></td></tr>
<tr class="codeline" data-linenumber="1086"><td class="num" id="LN1086">1086</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1087"><td class="num" id="LN1087">1087</td><td class="line"> <span class='comment'>* We actually use this only for signals that are not fatal from the point</span></td></tr>
<tr class="codeline" data-linenumber="1088"><td class="num" id="LN1088">1088</td><td class="line"> <span class='comment'>* of view of Redis. Signals that are going to kill the server anyway and</span></td></tr>
<tr class="codeline" data-linenumber="1089"><td class="num" id="LN1089">1089</td><td class="line"> <span class='comment'>* where we need printf-alike features are served by serverLog(). */</span></td></tr>
<tr class="codeline" data-linenumber="1090"><td class="num" id="LN1090">1090</td><td class="line"><span class='keyword'>void</span> serverLogFromHandler(<span class='keyword'>int</span> level, <span class='keyword'>const</span> <span class='keyword'>char</span> *msg) {</td></tr>
<tr class="codeline" data-linenumber="1091"><td class="num" id="LN1091">1091</td><td class="line">    <span class='keyword'>int</span> fd;</td></tr>
<tr class="codeline" data-linenumber="1092"><td class="num" id="LN1092">1092</td><td class="line">    <span class='keyword'>int</span> log_to_stdout = server.logfile[0] == '\0';</td></tr>
<tr class="codeline" data-linenumber="1093"><td class="num" id="LN1093">1093</td><td class="line">    <span class='keyword'>char</span> buf[64];</td></tr>
<tr class="codeline" data-linenumber="1094"><td class="num" id="LN1094">1094</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1095"><td class="num" id="LN1095">1095</td><td class="line">    <span class='keyword'>if</span> ((level&amp;0xff) &lt; server.verbosity || (log_to_stdout &amp;&amp; server.daemonize))</td></tr>
<tr class="codeline" data-linenumber="1096"><td class="num" id="LN1096">1096</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1097"><td class="num" id="LN1097">1097</td><td class="line">    fd = log_to_stdout ? <span class='macro'>STDOUT_FILENO<span class='macro_popup'>1</span></span> :</td></tr>
<tr class="codeline" data-linenumber="1098"><td class="num" id="LN1098">1098</td><td class="line">                         open(server.logfile, <span class='macro'>O_APPEND<span class='macro_popup'>02000</span></span>|<span class='macro'>O_CREAT<span class='macro_popup'>0100</span></span>|<span class='macro'>O_WRONLY<span class='macro_popup'>01</span></span>, 0644);</td></tr>
<tr class="codeline" data-linenumber="1099"><td class="num" id="LN1099">1099</td><td class="line">    <span class='keyword'>if</span> (fd == -1) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1100"><td class="num" id="LN1100">1100</td><td class="line">    ll2string(buf,<span class='keyword'>sizeof</span>(buf),getpid());</td></tr>
<tr class="codeline" data-linenumber="1101"><td class="num" id="LN1101">1101</td><td class="line">    <span class='keyword'>if</span> (write(fd,buf,strlen(buf)) == -1) <span class='keyword'>goto</span> err;</td></tr>
<tr class="codeline" data-linenumber="1102"><td class="num" id="LN1102">1102</td><td class="line">    <span class='keyword'>if</span> (write(fd,<span class='string_literal'>":signal-handler ("</span>,17) == -1) <span class='keyword'>goto</span> err;</td></tr>
<tr class="codeline" data-linenumber="1103"><td class="num" id="LN1103">1103</td><td class="line">    ll2string(buf,<span class='keyword'>sizeof</span>(buf),time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>));</td></tr>
<tr class="codeline" data-linenumber="1104"><td class="num" id="LN1104">1104</td><td class="line">    <span class='keyword'>if</span> (write(fd,buf,strlen(buf)) == -1) <span class='keyword'>goto</span> err;</td></tr>
<tr class="codeline" data-linenumber="1105"><td class="num" id="LN1105">1105</td><td class="line">    <span class='keyword'>if</span> (write(fd,<span class='string_literal'>") "</span>,2) == -1) <span class='keyword'>goto</span> err;</td></tr>
<tr class="codeline" data-linenumber="1106"><td class="num" id="LN1106">1106</td><td class="line">    <span class='keyword'>if</span> (write(fd,msg,strlen(msg)) == -1) <span class='keyword'>goto</span> err;</td></tr>
<tr class="codeline" data-linenumber="1107"><td class="num" id="LN1107">1107</td><td class="line">    <span class='keyword'>if</span> (write(fd,<span class='string_literal'>"\n"</span>,1) == -1) <span class='keyword'>goto</span> err;</td></tr>
<tr class="codeline" data-linenumber="1108"><td class="num" id="LN1108">1108</td><td class="line">err:</td></tr>
<tr class="codeline" data-linenumber="1109"><td class="num" id="LN1109">1109</td><td class="line">    <span class='keyword'>if</span> (!log_to_stdout) close(fd);</td></tr>
<tr class="codeline" data-linenumber="1110"><td class="num" id="LN1110">1110</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1111"><td class="num" id="LN1111">1111</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1112"><td class="num" id="LN1112">1112</td><td class="line"><span class='comment'>/* Return the UNIX time in microseconds */</span></td></tr>
<tr class="codeline" data-linenumber="1113"><td class="num" id="LN1113">1113</td><td class="line"><span class='keyword'>long</span> <span class='keyword'>long</span> ustime(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1114"><td class="num" id="LN1114">1114</td><td class="line">    <span class='keyword'>struct</span> timeval tv;</td></tr>
<tr class="codeline" data-linenumber="1115"><td class="num" id="LN1115">1115</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> ust;</td></tr>
<tr class="codeline" data-linenumber="1116"><td class="num" id="LN1116">1116</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1117"><td class="num" id="LN1117">1117</td><td class="line">    gettimeofday(&amp;tv, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1118"><td class="num" id="LN1118">1118</td><td class="line">    ust = ((<span class='keyword'>long</span> <span class='keyword'>long</span>)tv.tv_sec)*1000000;</td></tr>
<tr class="codeline" data-linenumber="1119"><td class="num" id="LN1119">1119</td><td class="line">    ust += tv.tv_usec;</td></tr>
<tr class="codeline" data-linenumber="1120"><td class="num" id="LN1120">1120</td><td class="line">    <span class='keyword'>return</span> ust;</td></tr>
<tr class="codeline" data-linenumber="1121"><td class="num" id="LN1121">1121</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1122"><td class="num" id="LN1122">1122</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1123"><td class="num" id="LN1123">1123</td><td class="line"><span class='comment'>/* Return the UNIX time in milliseconds */</span></td></tr>
<tr class="codeline" data-linenumber="1124"><td class="num" id="LN1124">1124</td><td class="line">mstime_t mstime(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1125"><td class="num" id="LN1125">1125</td><td class="line">    <span class='keyword'>return</span> ustime()/1000;</td></tr>
<tr class="codeline" data-linenumber="1126"><td class="num" id="LN1126">1126</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1127"><td class="num" id="LN1127">1127</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1128"><td class="num" id="LN1128">1128</td><td class="line"><span class='comment'>/* After an RDB dump or AOF rewrite we exit from children using _exit() instead of</span></td></tr>
<tr class="codeline" data-linenumber="1129"><td class="num" id="LN1129">1129</td><td class="line"> <span class='comment'>* exit(), because the latter may interact with the same file objects used by</span></td></tr>
<tr class="codeline" data-linenumber="1130"><td class="num" id="LN1130">1130</td><td class="line"> <span class='comment'>* the parent process. However if we are testing the coverage normal exit() is</span></td></tr>
<tr class="codeline" data-linenumber="1131"><td class="num" id="LN1131">1131</td><td class="line"> <span class='comment'>* used in order to obtain the right coverage information. */</span></td></tr>
<tr class="codeline" data-linenumber="1132"><td class="num" id="LN1132">1132</td><td class="line"><span class='keyword'>void</span> exitFromChild(<span class='keyword'>int</span> retcode) {</td></tr>
<tr class="codeline" data-linenumber="1133"><td class="num" id="LN1133">1133</td><td class="line"><span class='directive'>#ifdef COVERAGE_TEST</span></td></tr>
<tr class="codeline" data-linenumber="1134"><td class="num" id="LN1134">1134</td><td class="line">    exit(retcode);</td></tr>
<tr class="codeline" data-linenumber="1135"><td class="num" id="LN1135">1135</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="1136"><td class="num" id="LN1136">1136</td><td class="line">    _exit(retcode);</td></tr>
<tr class="codeline" data-linenumber="1137"><td class="num" id="LN1137">1137</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1138"><td class="num" id="LN1138">1138</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1139"><td class="num" id="LN1139">1139</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1140"><td class="num" id="LN1140">1140</td><td class="line"><span class='comment'>/*====================== Hash table type implementation  ==================== */</span></td></tr>
<tr class="codeline" data-linenumber="1141"><td class="num" id="LN1141">1141</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1142"><td class="num" id="LN1142">1142</td><td class="line"><span class='comment'>/* This is a hash table type that uses the SDS dynamic strings library as</span></td></tr>
<tr class="codeline" data-linenumber="1143"><td class="num" id="LN1143">1143</td><td class="line"> <span class='comment'>* keys and redis objects as values (objects can hold SDS strings,</span></td></tr>
<tr class="codeline" data-linenumber="1144"><td class="num" id="LN1144">1144</td><td class="line"> <span class='comment'>* lists, sets). */</span></td></tr>
<tr class="codeline" data-linenumber="1145"><td class="num" id="LN1145">1145</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1146"><td class="num" id="LN1146">1146</td><td class="line"><span class='keyword'>void</span> dictVanillaFree(<span class='keyword'>void</span> *privdata, <span class='keyword'>void</span> *val)</td></tr>
<tr class="codeline" data-linenumber="1147"><td class="num" id="LN1147">1147</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1148"><td class="num" id="LN1148">1148</td><td class="line">    <span class='macro'>DICT_NOTUSED(privdata)<span class='macro_popup'>((void) privdata)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1149"><td class="num" id="LN1149">1149</td><td class="line">    zfree(val);</td></tr>
<tr class="codeline" data-linenumber="1150"><td class="num" id="LN1150">1150</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1151"><td class="num" id="LN1151">1151</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1152"><td class="num" id="LN1152">1152</td><td class="line"><span class='keyword'>void</span> dictListDestructor(<span class='keyword'>void</span> *privdata, <span class='keyword'>void</span> *val)</td></tr>
<tr class="codeline" data-linenumber="1153"><td class="num" id="LN1153">1153</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1154"><td class="num" id="LN1154">1154</td><td class="line">    <span class='macro'>DICT_NOTUSED(privdata)<span class='macro_popup'>((void) privdata)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1155"><td class="num" id="LN1155">1155</td><td class="line">    listRelease((list*)val);</td></tr>
<tr class="codeline" data-linenumber="1156"><td class="num" id="LN1156">1156</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1157"><td class="num" id="LN1157">1157</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1158"><td class="num" id="LN1158">1158</td><td class="line"><span class='keyword'>int</span> dictSdsKeyCompare(<span class='keyword'>void</span> *privdata, <span class='keyword'>const</span> <span class='keyword'>void</span> *key1,</td></tr>
<tr class="codeline" data-linenumber="1159"><td class="num" id="LN1159">1159</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>void</span> *key2)</td></tr>
<tr class="codeline" data-linenumber="1160"><td class="num" id="LN1160">1160</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1161"><td class="num" id="LN1161">1161</td><td class="line">    <span class='keyword'>int</span> l1,l2;</td></tr>
<tr class="codeline" data-linenumber="1162"><td class="num" id="LN1162">1162</td><td class="line">    <span class='macro'>DICT_NOTUSED(privdata)<span class='macro_popup'>((void) privdata)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1163"><td class="num" id="LN1163">1163</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1164"><td class="num" id="LN1164">1164</td><td class="line">    l1 = sdslen((sds)key1);</td></tr>
<tr class="codeline" data-linenumber="1165"><td class="num" id="LN1165">1165</td><td class="line">    l2 = sdslen((sds)key2);</td></tr>
<tr class="codeline" data-linenumber="1166"><td class="num" id="LN1166">1166</td><td class="line">    <span class='keyword'>if</span> (l1 != l2) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1167"><td class="num" id="LN1167">1167</td><td class="line">    <span class='keyword'>return</span> memcmp(key1, key2, l1) == 0;</td></tr>
<tr class="codeline" data-linenumber="1168"><td class="num" id="LN1168">1168</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1169"><td class="num" id="LN1169">1169</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1170"><td class="num" id="LN1170">1170</td><td class="line"><span class='comment'>/* A case insensitive version used for the command lookup table and other</span></td></tr>
<tr class="codeline" data-linenumber="1171"><td class="num" id="LN1171">1171</td><td class="line"> <span class='comment'>* places where case insensitive non binary-safe comparison is needed. */</span></td></tr>
<tr class="codeline" data-linenumber="1172"><td class="num" id="LN1172">1172</td><td class="line"><span class='keyword'>int</span> dictSdsKeyCaseCompare(<span class='keyword'>void</span> *privdata, <span class='keyword'>const</span> <span class='keyword'>void</span> *key1,</td></tr>
<tr class="codeline" data-linenumber="1173"><td class="num" id="LN1173">1173</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>void</span> *key2)</td></tr>
<tr class="codeline" data-linenumber="1174"><td class="num" id="LN1174">1174</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1175"><td class="num" id="LN1175">1175</td><td class="line">    <span class='macro'>DICT_NOTUSED(privdata)<span class='macro_popup'>((void) privdata)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1176"><td class="num" id="LN1176">1176</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1177"><td class="num" id="LN1177">1177</td><td class="line">    <span class='keyword'>return</span> strcasecmp(key1, key2) == 0;</td></tr>
<tr class="codeline" data-linenumber="1178"><td class="num" id="LN1178">1178</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1179"><td class="num" id="LN1179">1179</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1180"><td class="num" id="LN1180">1180</td><td class="line"><span class='keyword'>void</span> dictObjectDestructor(<span class='keyword'>void</span> *privdata, <span class='keyword'>void</span> *val)</td></tr>
<tr class="codeline" data-linenumber="1181"><td class="num" id="LN1181">1181</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1182"><td class="num" id="LN1182">1182</td><td class="line">    <span class='macro'>DICT_NOTUSED(privdata)<span class='macro_popup'>((void) privdata)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1183"><td class="num" id="LN1183">1183</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1184"><td class="num" id="LN1184">1184</td><td class="line">    <span class='keyword'>if</span> (val == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span>; <span class='comment'>/* Lazy freeing will set value to NULL. */</span></td></tr>
<tr class="codeline" data-linenumber="1185"><td class="num" id="LN1185">1185</td><td class="line">    decrRefCount(val);</td></tr>
<tr class="codeline" data-linenumber="1186"><td class="num" id="LN1186">1186</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1187"><td class="num" id="LN1187">1187</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1188"><td class="num" id="LN1188">1188</td><td class="line"><span class='keyword'>void</span> dictSdsDestructor(<span class='keyword'>void</span> *privdata, <span class='keyword'>void</span> *val)</td></tr>
<tr class="codeline" data-linenumber="1189"><td class="num" id="LN1189">1189</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1190"><td class="num" id="LN1190">1190</td><td class="line">    <span class='macro'>DICT_NOTUSED(privdata)<span class='macro_popup'>((void) privdata)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1191"><td class="num" id="LN1191">1191</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1192"><td class="num" id="LN1192">1192</td><td class="line">    sdsfree(val);</td></tr>
<tr class="codeline" data-linenumber="1193"><td class="num" id="LN1193">1193</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1194"><td class="num" id="LN1194">1194</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1195"><td class="num" id="LN1195">1195</td><td class="line"><span class='keyword'>int</span> dictObjKeyCompare(<span class='keyword'>void</span> *privdata, <span class='keyword'>const</span> <span class='keyword'>void</span> *key1,</td></tr>
<tr class="codeline" data-linenumber="1196"><td class="num" id="LN1196">1196</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>void</span> *key2)</td></tr>
<tr class="codeline" data-linenumber="1197"><td class="num" id="LN1197">1197</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1198"><td class="num" id="LN1198">1198</td><td class="line">    <span class='keyword'>const</span> robj *o1 = key1, *o2 = key2;</td></tr>
<tr class="codeline" data-linenumber="1199"><td class="num" id="LN1199">1199</td><td class="line">    <span class='keyword'>return</span> dictSdsKeyCompare(privdata,o1-&gt;ptr,o2-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="1200"><td class="num" id="LN1200">1200</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1201"><td class="num" id="LN1201">1201</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1202"><td class="num" id="LN1202">1202</td><td class="line">uint64_t dictObjHash(<span class='keyword'>const</span> <span class='keyword'>void</span> *key) {</td></tr>
<tr class="codeline" data-linenumber="1203"><td class="num" id="LN1203">1203</td><td class="line">    <span class='keyword'>const</span> robj *o = key;</td></tr>
<tr class="codeline" data-linenumber="1204"><td class="num" id="LN1204">1204</td><td class="line">    <span class='keyword'>return</span> dictGenHashFunction(o-&gt;ptr, sdslen((sds)o-&gt;ptr));</td></tr>
<tr class="codeline" data-linenumber="1205"><td class="num" id="LN1205">1205</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1206"><td class="num" id="LN1206">1206</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1207"><td class="num" id="LN1207">1207</td><td class="line">uint64_t dictSdsHash(<span class='keyword'>const</span> <span class='keyword'>void</span> *key) {</td></tr>
<tr class="codeline" data-linenumber="1208"><td class="num" id="LN1208">1208</td><td class="line">    <span class='keyword'>return</span> dictGenHashFunction((<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)key, sdslen((<span class='keyword'>char</span>*)key));</td></tr>
<tr class="codeline" data-linenumber="1209"><td class="num" id="LN1209">1209</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1210"><td class="num" id="LN1210">1210</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1211"><td class="num" id="LN1211">1211</td><td class="line">uint64_t dictSdsCaseHash(<span class='keyword'>const</span> <span class='keyword'>void</span> *key) {</td></tr>
<tr class="codeline" data-linenumber="1212"><td class="num" id="LN1212">1212</td><td class="line">    <span class='keyword'>return</span> dictGenCaseHashFunction((<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)key, sdslen((<span class='keyword'>char</span>*)key));</td></tr>
<tr class="codeline" data-linenumber="1213"><td class="num" id="LN1213">1213</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1214"><td class="num" id="LN1214">1214</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1215"><td class="num" id="LN1215">1215</td><td class="line"><span class='keyword'>int</span> dictEncObjKeyCompare(<span class='keyword'>void</span> *privdata, <span class='keyword'>const</span> <span class='keyword'>void</span> *key1,</td></tr>
<tr class="codeline" data-linenumber="1216"><td class="num" id="LN1216">1216</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>void</span> *key2)</td></tr>
<tr class="codeline" data-linenumber="1217"><td class="num" id="LN1217">1217</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1218"><td class="num" id="LN1218">1218</td><td class="line">    robj *o1 = (robj*) key1, *o2 = (robj*) key2;</td></tr>
<tr class="codeline" data-linenumber="1219"><td class="num" id="LN1219">1219</td><td class="line">    <span class='keyword'>int</span> cmp;</td></tr>
<tr class="codeline" data-linenumber="1220"><td class="num" id="LN1220">1220</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1221"><td class="num" id="LN1221">1221</td><td class="line">    <span class='keyword'>if</span> (o1-&gt;encoding == <span class='macro'>OBJ_ENCODING_INT<span class='macro_popup'>1</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1222"><td class="num" id="LN1222">1222</td><td class="line">        o2-&gt;encoding == <span class='macro'>OBJ_ENCODING_INT<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1223"><td class="num" id="LN1223">1223</td><td class="line">            <span class='keyword'>return</span> o1-&gt;ptr == o2-&gt;ptr;</td></tr>
<tr class="codeline" data-linenumber="1224"><td class="num" id="LN1224">1224</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1225"><td class="num" id="LN1225">1225</td><td class="line">    <span class='comment'>/* Due to OBJ_STATIC_REFCOUNT, we avoid calling getDecodedObject() without</span></td></tr>
<tr class="codeline" data-linenumber="1226"><td class="num" id="LN1226">1226</td><td class="line">     <span class='comment'>* good reasons, because it would incrRefCount() the object, which</span></td></tr>
<tr class="codeline" data-linenumber="1227"><td class="num" id="LN1227">1227</td><td class="line">     <span class='comment'>* is invalid. So we check to make sure dictFind() works with static</span></td></tr>
<tr class="codeline" data-linenumber="1228"><td class="num" id="LN1228">1228</td><td class="line">     <span class='comment'>* objects as well. */</span></td></tr>
<tr class="codeline" data-linenumber="1229"><td class="num" id="LN1229">1229</td><td class="line">    <span class='keyword'>if</span> (o1-&gt;refcount != <span class='macro'>OBJ_STATIC_REFCOUNT<span class='macro_popup'>(2147483647 -1)</span></span>) o1 = getDecodedObject(o1);</td></tr>
<tr class="codeline" data-linenumber="1230"><td class="num" id="LN1230">1230</td><td class="line">    <span class='keyword'>if</span> (o2-&gt;refcount != <span class='macro'>OBJ_STATIC_REFCOUNT<span class='macro_popup'>(2147483647 -1)</span></span>) o2 = getDecodedObject(o2);</td></tr>
<tr class="codeline" data-linenumber="1231"><td class="num" id="LN1231">1231</td><td class="line">    cmp = dictSdsKeyCompare(privdata,o1-&gt;ptr,o2-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="1232"><td class="num" id="LN1232">1232</td><td class="line">    <span class='keyword'>if</span> (o1-&gt;refcount != <span class='macro'>OBJ_STATIC_REFCOUNT<span class='macro_popup'>(2147483647 -1)</span></span>) decrRefCount(o1);</td></tr>
<tr class="codeline" data-linenumber="1233"><td class="num" id="LN1233">1233</td><td class="line">    <span class='keyword'>if</span> (o2-&gt;refcount != <span class='macro'>OBJ_STATIC_REFCOUNT<span class='macro_popup'>(2147483647 -1)</span></span>) decrRefCount(o2);</td></tr>
<tr class="codeline" data-linenumber="1234"><td class="num" id="LN1234">1234</td><td class="line">    <span class='keyword'>return</span> cmp;</td></tr>
<tr class="codeline" data-linenumber="1235"><td class="num" id="LN1235">1235</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1236"><td class="num" id="LN1236">1236</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1237"><td class="num" id="LN1237">1237</td><td class="line">uint64_t dictEncObjHash(<span class='keyword'>const</span> <span class='keyword'>void</span> *key) {</td></tr>
<tr class="codeline" data-linenumber="1238"><td class="num" id="LN1238">1238</td><td class="line">    robj *o = (robj*) key;</td></tr>
<tr class="codeline" data-linenumber="1239"><td class="num" id="LN1239">1239</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1240"><td class="num" id="LN1240">1240</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>sdsEncodedObject(o)<span class='macro_popup'>(o-&gt;encoding == 0 || o-&gt;encoding == 8)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1241"><td class="num" id="LN1241">1241</td><td class="line">        <span class='keyword'>return</span> dictGenHashFunction(o-&gt;ptr, sdslen((sds)o-&gt;ptr));</td></tr>
<tr class="codeline" data-linenumber="1242"><td class="num" id="LN1242">1242</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1243"><td class="num" id="LN1243">1243</td><td class="line">        <span class='keyword'>if</span> (o-&gt;encoding == <span class='macro'>OBJ_ENCODING_INT<span class='macro_popup'>1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1244"><td class="num" id="LN1244">1244</td><td class="line">            <span class='keyword'>char</span> buf[32];</td></tr>
<tr class="codeline" data-linenumber="1245"><td class="num" id="LN1245">1245</td><td class="line">            <span class='keyword'>int</span> len;</td></tr>
<tr class="codeline" data-linenumber="1246"><td class="num" id="LN1246">1246</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1247"><td class="num" id="LN1247">1247</td><td class="line">            len = ll2string(buf,32,(<span class='keyword'>long</span>)o-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="1248"><td class="num" id="LN1248">1248</td><td class="line">            <span class='keyword'>return</span> dictGenHashFunction((<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)buf, len);</td></tr>
<tr class="codeline" data-linenumber="1249"><td class="num" id="LN1249">1249</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1250"><td class="num" id="LN1250">1250</td><td class="line">            uint64_t hash;</td></tr>
<tr class="codeline" data-linenumber="1251"><td class="num" id="LN1251">1251</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1252"><td class="num" id="LN1252">1252</td><td class="line">            o = getDecodedObject(o);</td></tr>
<tr class="codeline" data-linenumber="1253"><td class="num" id="LN1253">1253</td><td class="line">            hash = dictGenHashFunction(o-&gt;ptr, sdslen((sds)o-&gt;ptr));</td></tr>
<tr class="codeline" data-linenumber="1254"><td class="num" id="LN1254">1254</td><td class="line">            decrRefCount(o);</td></tr>
<tr class="codeline" data-linenumber="1255"><td class="num" id="LN1255">1255</td><td class="line">            <span class='keyword'>return</span> hash;</td></tr>
<tr class="codeline" data-linenumber="1256"><td class="num" id="LN1256">1256</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1257"><td class="num" id="LN1257">1257</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1258"><td class="num" id="LN1258">1258</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1259"><td class="num" id="LN1259">1259</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1260"><td class="num" id="LN1260">1260</td><td class="line"><span class='comment'>/* Generic hash table type where keys are Redis Objects, Values</span></td></tr>
<tr class="codeline" data-linenumber="1261"><td class="num" id="LN1261">1261</td><td class="line"> <span class='comment'>* dummy pointers. */</span></td></tr>
<tr class="codeline" data-linenumber="1262"><td class="num" id="LN1262">1262</td><td class="line">dictType objectKeyPointerValueDictType = {</td></tr>
<tr class="codeline" data-linenumber="1263"><td class="num" id="LN1263">1263</td><td class="line">    dictEncObjHash,            <span class='comment'>/* hash function */</span></td></tr>
<tr class="codeline" data-linenumber="1264"><td class="num" id="LN1264">1264</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                      <span class='comment'>/* key dup */</span></td></tr>
<tr class="codeline" data-linenumber="1265"><td class="num" id="LN1265">1265</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                      <span class='comment'>/* val dup */</span></td></tr>
<tr class="codeline" data-linenumber="1266"><td class="num" id="LN1266">1266</td><td class="line">    dictEncObjKeyCompare,      <span class='comment'>/* key compare */</span></td></tr>
<tr class="codeline" data-linenumber="1267"><td class="num" id="LN1267">1267</td><td class="line">    dictObjectDestructor,      <span class='comment'>/* key destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1268"><td class="num" id="LN1268">1268</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>                       <span class='comment'>/* val destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1269"><td class="num" id="LN1269">1269</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="1270"><td class="num" id="LN1270">1270</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1271"><td class="num" id="LN1271">1271</td><td class="line"><span class='comment'>/* Like objectKeyPointerValueDictType(), but values can be destroyed, if</span></td></tr>
<tr class="codeline" data-linenumber="1272"><td class="num" id="LN1272">1272</td><td class="line"> <span class='comment'>* not NULL, calling zfree(). */</span></td></tr>
<tr class="codeline" data-linenumber="1273"><td class="num" id="LN1273">1273</td><td class="line">dictType objectKeyHeapPointerValueDictType = {</td></tr>
<tr class="codeline" data-linenumber="1274"><td class="num" id="LN1274">1274</td><td class="line">    dictEncObjHash,            <span class='comment'>/* hash function */</span></td></tr>
<tr class="codeline" data-linenumber="1275"><td class="num" id="LN1275">1275</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                      <span class='comment'>/* key dup */</span></td></tr>
<tr class="codeline" data-linenumber="1276"><td class="num" id="LN1276">1276</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                      <span class='comment'>/* val dup */</span></td></tr>
<tr class="codeline" data-linenumber="1277"><td class="num" id="LN1277">1277</td><td class="line">    dictEncObjKeyCompare,      <span class='comment'>/* key compare */</span></td></tr>
<tr class="codeline" data-linenumber="1278"><td class="num" id="LN1278">1278</td><td class="line">    dictObjectDestructor,      <span class='comment'>/* key destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1279"><td class="num" id="LN1279">1279</td><td class="line">    dictVanillaFree            <span class='comment'>/* val destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1280"><td class="num" id="LN1280">1280</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="1281"><td class="num" id="LN1281">1281</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1282"><td class="num" id="LN1282">1282</td><td class="line"><span class='comment'>/* Set dictionary type. Keys are SDS strings, values are not used. */</span></td></tr>
<tr class="codeline" data-linenumber="1283"><td class="num" id="LN1283">1283</td><td class="line">dictType setDictType = {</td></tr>
<tr class="codeline" data-linenumber="1284"><td class="num" id="LN1284">1284</td><td class="line">    dictSdsHash,               <span class='comment'>/* hash function */</span></td></tr>
<tr class="codeline" data-linenumber="1285"><td class="num" id="LN1285">1285</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                      <span class='comment'>/* key dup */</span></td></tr>
<tr class="codeline" data-linenumber="1286"><td class="num" id="LN1286">1286</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                      <span class='comment'>/* val dup */</span></td></tr>
<tr class="codeline" data-linenumber="1287"><td class="num" id="LN1287">1287</td><td class="line">    dictSdsKeyCompare,         <span class='comment'>/* key compare */</span></td></tr>
<tr class="codeline" data-linenumber="1288"><td class="num" id="LN1288">1288</td><td class="line">    dictSdsDestructor,         <span class='comment'>/* key destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1289"><td class="num" id="LN1289">1289</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>                       <span class='comment'>/* val destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1290"><td class="num" id="LN1290">1290</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="1291"><td class="num" id="LN1291">1291</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1292"><td class="num" id="LN1292">1292</td><td class="line"><span class='comment'>/* Sorted sets hash (note: a skiplist is used in addition to the hash table) */</span></td></tr>
<tr class="codeline" data-linenumber="1293"><td class="num" id="LN1293">1293</td><td class="line">dictType zsetDictType = {</td></tr>
<tr class="codeline" data-linenumber="1294"><td class="num" id="LN1294">1294</td><td class="line">    dictSdsHash,               <span class='comment'>/* hash function */</span></td></tr>
<tr class="codeline" data-linenumber="1295"><td class="num" id="LN1295">1295</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                      <span class='comment'>/* key dup */</span></td></tr>
<tr class="codeline" data-linenumber="1296"><td class="num" id="LN1296">1296</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                      <span class='comment'>/* val dup */</span></td></tr>
<tr class="codeline" data-linenumber="1297"><td class="num" id="LN1297">1297</td><td class="line">    dictSdsKeyCompare,         <span class='comment'>/* key compare */</span></td></tr>
<tr class="codeline" data-linenumber="1298"><td class="num" id="LN1298">1298</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                      <span class='comment'>/* Note: SDS string shared &amp; freed by skiplist */</span></td></tr>
<tr class="codeline" data-linenumber="1299"><td class="num" id="LN1299">1299</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>                       <span class='comment'>/* val destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1300"><td class="num" id="LN1300">1300</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="1301"><td class="num" id="LN1301">1301</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1302"><td class="num" id="LN1302">1302</td><td class="line"><span class='comment'>/* Db-&gt;dict, keys are sds strings, vals are Redis objects. */</span></td></tr>
<tr class="codeline" data-linenumber="1303"><td class="num" id="LN1303">1303</td><td class="line">dictType dbDictType = {</td></tr>
<tr class="codeline" data-linenumber="1304"><td class="num" id="LN1304">1304</td><td class="line">    dictSdsHash,                <span class='comment'>/* hash function */</span></td></tr>
<tr class="codeline" data-linenumber="1305"><td class="num" id="LN1305">1305</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* key dup */</span></td></tr>
<tr class="codeline" data-linenumber="1306"><td class="num" id="LN1306">1306</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* val dup */</span></td></tr>
<tr class="codeline" data-linenumber="1307"><td class="num" id="LN1307">1307</td><td class="line">    dictSdsKeyCompare,          <span class='comment'>/* key compare */</span></td></tr>
<tr class="codeline" data-linenumber="1308"><td class="num" id="LN1308">1308</td><td class="line">    dictSdsDestructor,          <span class='comment'>/* key destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1309"><td class="num" id="LN1309">1309</td><td class="line">    dictObjectDestructor   <span class='comment'>/* val destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1310"><td class="num" id="LN1310">1310</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="1311"><td class="num" id="LN1311">1311</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1312"><td class="num" id="LN1312">1312</td><td class="line"><span class='comment'>/* server.lua_scripts sha (as sds string) -&gt; scripts (as robj) cache. */</span></td></tr>
<tr class="codeline" data-linenumber="1313"><td class="num" id="LN1313">1313</td><td class="line">dictType shaScriptObjectDictType = {</td></tr>
<tr class="codeline" data-linenumber="1314"><td class="num" id="LN1314">1314</td><td class="line">    dictSdsCaseHash,            <span class='comment'>/* hash function */</span></td></tr>
<tr class="codeline" data-linenumber="1315"><td class="num" id="LN1315">1315</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* key dup */</span></td></tr>
<tr class="codeline" data-linenumber="1316"><td class="num" id="LN1316">1316</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* val dup */</span></td></tr>
<tr class="codeline" data-linenumber="1317"><td class="num" id="LN1317">1317</td><td class="line">    dictSdsKeyCaseCompare,      <span class='comment'>/* key compare */</span></td></tr>
<tr class="codeline" data-linenumber="1318"><td class="num" id="LN1318">1318</td><td class="line">    dictSdsDestructor,          <span class='comment'>/* key destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1319"><td class="num" id="LN1319">1319</td><td class="line">    dictObjectDestructor        <span class='comment'>/* val destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1320"><td class="num" id="LN1320">1320</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="1321"><td class="num" id="LN1321">1321</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1322"><td class="num" id="LN1322">1322</td><td class="line"><span class='comment'>/* Db-&gt;expires */</span></td></tr>
<tr class="codeline" data-linenumber="1323"><td class="num" id="LN1323">1323</td><td class="line">dictType keyptrDictType = {</td></tr>
<tr class="codeline" data-linenumber="1324"><td class="num" id="LN1324">1324</td><td class="line">    dictSdsHash,                <span class='comment'>/* hash function */</span></td></tr>
<tr class="codeline" data-linenumber="1325"><td class="num" id="LN1325">1325</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* key dup */</span></td></tr>
<tr class="codeline" data-linenumber="1326"><td class="num" id="LN1326">1326</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* val dup */</span></td></tr>
<tr class="codeline" data-linenumber="1327"><td class="num" id="LN1327">1327</td><td class="line">    dictSdsKeyCompare,          <span class='comment'>/* key compare */</span></td></tr>
<tr class="codeline" data-linenumber="1328"><td class="num" id="LN1328">1328</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* key destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1329"><td class="num" id="LN1329">1329</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>                        <span class='comment'>/* val destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1330"><td class="num" id="LN1330">1330</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="1331"><td class="num" id="LN1331">1331</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1332"><td class="num" id="LN1332">1332</td><td class="line"><span class='comment'>/* Command table. sds string -&gt; command struct pointer. */</span></td></tr>
<tr class="codeline" data-linenumber="1333"><td class="num" id="LN1333">1333</td><td class="line">dictType commandTableDictType = {</td></tr>
<tr class="codeline" data-linenumber="1334"><td class="num" id="LN1334">1334</td><td class="line">    dictSdsCaseHash,            <span class='comment'>/* hash function */</span></td></tr>
<tr class="codeline" data-linenumber="1335"><td class="num" id="LN1335">1335</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* key dup */</span></td></tr>
<tr class="codeline" data-linenumber="1336"><td class="num" id="LN1336">1336</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* val dup */</span></td></tr>
<tr class="codeline" data-linenumber="1337"><td class="num" id="LN1337">1337</td><td class="line">    dictSdsKeyCaseCompare,      <span class='comment'>/* key compare */</span></td></tr>
<tr class="codeline" data-linenumber="1338"><td class="num" id="LN1338">1338</td><td class="line">    dictSdsDestructor,          <span class='comment'>/* key destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1339"><td class="num" id="LN1339">1339</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>                        <span class='comment'>/* val destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1340"><td class="num" id="LN1340">1340</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="1341"><td class="num" id="LN1341">1341</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1342"><td class="num" id="LN1342">1342</td><td class="line"><span class='comment'>/* Hash type hash table (note that small hashes are represented with ziplists) */</span></td></tr>
<tr class="codeline" data-linenumber="1343"><td class="num" id="LN1343">1343</td><td class="line">dictType hashDictType = {</td></tr>
<tr class="codeline" data-linenumber="1344"><td class="num" id="LN1344">1344</td><td class="line">    dictSdsHash,                <span class='comment'>/* hash function */</span></td></tr>
<tr class="codeline" data-linenumber="1345"><td class="num" id="LN1345">1345</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* key dup */</span></td></tr>
<tr class="codeline" data-linenumber="1346"><td class="num" id="LN1346">1346</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* val dup */</span></td></tr>
<tr class="codeline" data-linenumber="1347"><td class="num" id="LN1347">1347</td><td class="line">    dictSdsKeyCompare,          <span class='comment'>/* key compare */</span></td></tr>
<tr class="codeline" data-linenumber="1348"><td class="num" id="LN1348">1348</td><td class="line">    dictSdsDestructor,          <span class='comment'>/* key destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1349"><td class="num" id="LN1349">1349</td><td class="line">    dictSdsDestructor           <span class='comment'>/* val destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1350"><td class="num" id="LN1350">1350</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="1351"><td class="num" id="LN1351">1351</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1352"><td class="num" id="LN1352">1352</td><td class="line"><span class='comment'>/* Keylist hash table type has unencoded redis objects as keys and</span></td></tr>
<tr class="codeline" data-linenumber="1353"><td class="num" id="LN1353">1353</td><td class="line"> <span class='comment'>* lists as values. It's used for blocking operations (BLPOP) and to</span></td></tr>
<tr class="codeline" data-linenumber="1354"><td class="num" id="LN1354">1354</td><td class="line"> <span class='comment'>* map swapped keys to a list of clients waiting for this keys to be loaded. */</span></td></tr>
<tr class="codeline" data-linenumber="1355"><td class="num" id="LN1355">1355</td><td class="line">dictType keylistDictType = {</td></tr>
<tr class="codeline" data-linenumber="1356"><td class="num" id="LN1356">1356</td><td class="line">    dictObjHash,                <span class='comment'>/* hash function */</span></td></tr>
<tr class="codeline" data-linenumber="1357"><td class="num" id="LN1357">1357</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* key dup */</span></td></tr>
<tr class="codeline" data-linenumber="1358"><td class="num" id="LN1358">1358</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* val dup */</span></td></tr>
<tr class="codeline" data-linenumber="1359"><td class="num" id="LN1359">1359</td><td class="line">    dictObjKeyCompare,          <span class='comment'>/* key compare */</span></td></tr>
<tr class="codeline" data-linenumber="1360"><td class="num" id="LN1360">1360</td><td class="line">    dictObjectDestructor,       <span class='comment'>/* key destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1361"><td class="num" id="LN1361">1361</td><td class="line">    dictListDestructor          <span class='comment'>/* val destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1362"><td class="num" id="LN1362">1362</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="1363"><td class="num" id="LN1363">1363</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1364"><td class="num" id="LN1364">1364</td><td class="line"><span class='comment'>/* Cluster nodes hash table, mapping nodes addresses 1.2.3.4:6379 to</span></td></tr>
<tr class="codeline" data-linenumber="1365"><td class="num" id="LN1365">1365</td><td class="line"> <span class='comment'>* clusterNode structures. */</span></td></tr>
<tr class="codeline" data-linenumber="1366"><td class="num" id="LN1366">1366</td><td class="line">dictType clusterNodesDictType = {</td></tr>
<tr class="codeline" data-linenumber="1367"><td class="num" id="LN1367">1367</td><td class="line">    dictSdsHash,                <span class='comment'>/* hash function */</span></td></tr>
<tr class="codeline" data-linenumber="1368"><td class="num" id="LN1368">1368</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* key dup */</span></td></tr>
<tr class="codeline" data-linenumber="1369"><td class="num" id="LN1369">1369</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* val dup */</span></td></tr>
<tr class="codeline" data-linenumber="1370"><td class="num" id="LN1370">1370</td><td class="line">    dictSdsKeyCompare,          <span class='comment'>/* key compare */</span></td></tr>
<tr class="codeline" data-linenumber="1371"><td class="num" id="LN1371">1371</td><td class="line">    dictSdsDestructor,          <span class='comment'>/* key destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1372"><td class="num" id="LN1372">1372</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>                        <span class='comment'>/* val destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1373"><td class="num" id="LN1373">1373</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="1374"><td class="num" id="LN1374">1374</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1375"><td class="num" id="LN1375">1375</td><td class="line"><span class='comment'>/* Cluster re-addition blacklist. This maps node IDs to the time</span></td></tr>
<tr class="codeline" data-linenumber="1376"><td class="num" id="LN1376">1376</td><td class="line"> <span class='comment'>* we can re-add this node. The goal is to avoid readding a removed</span></td></tr>
<tr class="codeline" data-linenumber="1377"><td class="num" id="LN1377">1377</td><td class="line"> <span class='comment'>* node for some time. */</span></td></tr>
<tr class="codeline" data-linenumber="1378"><td class="num" id="LN1378">1378</td><td class="line">dictType clusterNodesBlackListDictType = {</td></tr>
<tr class="codeline" data-linenumber="1379"><td class="num" id="LN1379">1379</td><td class="line">    dictSdsCaseHash,            <span class='comment'>/* hash function */</span></td></tr>
<tr class="codeline" data-linenumber="1380"><td class="num" id="LN1380">1380</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* key dup */</span></td></tr>
<tr class="codeline" data-linenumber="1381"><td class="num" id="LN1381">1381</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* val dup */</span></td></tr>
<tr class="codeline" data-linenumber="1382"><td class="num" id="LN1382">1382</td><td class="line">    dictSdsKeyCaseCompare,      <span class='comment'>/* key compare */</span></td></tr>
<tr class="codeline" data-linenumber="1383"><td class="num" id="LN1383">1383</td><td class="line">    dictSdsDestructor,          <span class='comment'>/* key destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1384"><td class="num" id="LN1384">1384</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>                        <span class='comment'>/* val destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1385"><td class="num" id="LN1385">1385</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="1386"><td class="num" id="LN1386">1386</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1387"><td class="num" id="LN1387">1387</td><td class="line"><span class='comment'>/* Modules system dictionary type. Keys are module name,</span></td></tr>
<tr class="codeline" data-linenumber="1388"><td class="num" id="LN1388">1388</td><td class="line"> <span class='comment'>* values are pointer to RedisModule struct. */</span></td></tr>
<tr class="codeline" data-linenumber="1389"><td class="num" id="LN1389">1389</td><td class="line">dictType modulesDictType = {</td></tr>
<tr class="codeline" data-linenumber="1390"><td class="num" id="LN1390">1390</td><td class="line">    dictSdsCaseHash,            <span class='comment'>/* hash function */</span></td></tr>
<tr class="codeline" data-linenumber="1391"><td class="num" id="LN1391">1391</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* key dup */</span></td></tr>
<tr class="codeline" data-linenumber="1392"><td class="num" id="LN1392">1392</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* val dup */</span></td></tr>
<tr class="codeline" data-linenumber="1393"><td class="num" id="LN1393">1393</td><td class="line">    dictSdsKeyCaseCompare,      <span class='comment'>/* key compare */</span></td></tr>
<tr class="codeline" data-linenumber="1394"><td class="num" id="LN1394">1394</td><td class="line">    dictSdsDestructor,          <span class='comment'>/* key destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1395"><td class="num" id="LN1395">1395</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>                        <span class='comment'>/* val destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1396"><td class="num" id="LN1396">1396</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="1397"><td class="num" id="LN1397">1397</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1398"><td class="num" id="LN1398">1398</td><td class="line"><span class='comment'>/* Migrate cache dict type. */</span></td></tr>
<tr class="codeline" data-linenumber="1399"><td class="num" id="LN1399">1399</td><td class="line">dictType migrateCacheDictType = {</td></tr>
<tr class="codeline" data-linenumber="1400"><td class="num" id="LN1400">1400</td><td class="line">    dictSdsHash,                <span class='comment'>/* hash function */</span></td></tr>
<tr class="codeline" data-linenumber="1401"><td class="num" id="LN1401">1401</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* key dup */</span></td></tr>
<tr class="codeline" data-linenumber="1402"><td class="num" id="LN1402">1402</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* val dup */</span></td></tr>
<tr class="codeline" data-linenumber="1403"><td class="num" id="LN1403">1403</td><td class="line">    dictSdsKeyCompare,          <span class='comment'>/* key compare */</span></td></tr>
<tr class="codeline" data-linenumber="1404"><td class="num" id="LN1404">1404</td><td class="line">    dictSdsDestructor,          <span class='comment'>/* key destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1405"><td class="num" id="LN1405">1405</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>                        <span class='comment'>/* val destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1406"><td class="num" id="LN1406">1406</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="1407"><td class="num" id="LN1407">1407</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1408"><td class="num" id="LN1408">1408</td><td class="line"><span class='comment'>/* Replication cached script dict (server.repl_scriptcache_dict).</span></td></tr>
<tr class="codeline" data-linenumber="1409"><td class="num" id="LN1409">1409</td><td class="line"> <span class='comment'>* Keys are sds SHA1 strings, while values are not used at all in the current</span></td></tr>
<tr class="codeline" data-linenumber="1410"><td class="num" id="LN1410">1410</td><td class="line"> <span class='comment'>* implementation. */</span></td></tr>
<tr class="codeline" data-linenumber="1411"><td class="num" id="LN1411">1411</td><td class="line">dictType replScriptCacheDictType = {</td></tr>
<tr class="codeline" data-linenumber="1412"><td class="num" id="LN1412">1412</td><td class="line">    dictSdsCaseHash,            <span class='comment'>/* hash function */</span></td></tr>
<tr class="codeline" data-linenumber="1413"><td class="num" id="LN1413">1413</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* key dup */</span></td></tr>
<tr class="codeline" data-linenumber="1414"><td class="num" id="LN1414">1414</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,                       <span class='comment'>/* val dup */</span></td></tr>
<tr class="codeline" data-linenumber="1415"><td class="num" id="LN1415">1415</td><td class="line">    dictSdsKeyCaseCompare,      <span class='comment'>/* key compare */</span></td></tr>
<tr class="codeline" data-linenumber="1416"><td class="num" id="LN1416">1416</td><td class="line">    dictSdsDestructor,          <span class='comment'>/* key destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1417"><td class="num" id="LN1417">1417</td><td class="line">    <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>                        <span class='comment'>/* val destructor */</span></td></tr>
<tr class="codeline" data-linenumber="1418"><td class="num" id="LN1418">1418</td><td class="line">};</td></tr>
<tr class="codeline" data-linenumber="1419"><td class="num" id="LN1419">1419</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1420"><td class="num" id="LN1420">1420</td><td class="line"><span class='keyword'>int</span> htNeedsResize(dict *dict) {</td></tr>
<tr class="codeline" data-linenumber="1421"><td class="num" id="LN1421">1421</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> size, used;</td></tr>
<tr class="codeline" data-linenumber="1422"><td class="num" id="LN1422">1422</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1423"><td class="num" id="LN1423">1423</td><td class="line">    size = <span class='macro'>dictSlots(dict)<span class='macro_popup'>((dict)-&gt;ht[0].size+(dict)-&gt;ht[1].size)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1424"><td class="num" id="LN1424">1424</td><td class="line">    used = <span class='macro'>dictSize(dict)<span class='macro_popup'>((dict)-&gt;ht[0].used+(dict)-&gt;ht[1].used)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1425"><td class="num" id="LN1425">1425</td><td class="line">    <span class='keyword'>return</span> (size &gt; <span class='macro'>DICT_HT_INITIAL_SIZE<span class='macro_popup'>4</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1426"><td class="num" id="LN1426">1426</td><td class="line">            (used*100/size &lt; <span class='macro'>HASHTABLE_MIN_FILL<span class='macro_popup'>10</span></span>));</td></tr>
<tr class="codeline" data-linenumber="1427"><td class="num" id="LN1427">1427</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1428"><td class="num" id="LN1428">1428</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1429"><td class="num" id="LN1429">1429</td><td class="line"><span class='comment'>/* If the percentage of used slots in the HT reaches HASHTABLE_MIN_FILL</span></td></tr>
<tr class="codeline" data-linenumber="1430"><td class="num" id="LN1430">1430</td><td class="line"> <span class='comment'>* we resize the hash table to save memory */</span></td></tr>
<tr class="codeline" data-linenumber="1431"><td class="num" id="LN1431">1431</td><td class="line"><span class='keyword'>void</span> tryResizeHashTables(<span class='keyword'>int</span> dbid) {</td></tr>
<tr class="codeline" data-linenumber="1432"><td class="num" id="LN1432">1432</td><td class="line">    <span class='keyword'>if</span> (htNeedsResize(server.db[dbid].dict))</td></tr>
<tr class="codeline" data-linenumber="1433"><td class="num" id="LN1433">1433</td><td class="line">        dictResize(server.db[dbid].dict);</td></tr>
<tr class="codeline" data-linenumber="1434"><td class="num" id="LN1434">1434</td><td class="line">    <span class='keyword'>if</span> (htNeedsResize(server.db[dbid].expires))</td></tr>
<tr class="codeline" data-linenumber="1435"><td class="num" id="LN1435">1435</td><td class="line">        dictResize(server.db[dbid].expires);</td></tr>
<tr class="codeline" data-linenumber="1436"><td class="num" id="LN1436">1436</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1437"><td class="num" id="LN1437">1437</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1438"><td class="num" id="LN1438">1438</td><td class="line"><span class='comment'>/* Our hash table implementation performs rehashing incrementally while</span></td></tr>
<tr class="codeline" data-linenumber="1439"><td class="num" id="LN1439">1439</td><td class="line"> <span class='comment'>* we write/read from the hash table. Still if the server is idle, the hash</span></td></tr>
<tr class="codeline" data-linenumber="1440"><td class="num" id="LN1440">1440</td><td class="line"> <span class='comment'>* table will use two tables for a long time. So we try to use 1 millisecond</span></td></tr>
<tr class="codeline" data-linenumber="1441"><td class="num" id="LN1441">1441</td><td class="line"> <span class='comment'>* of CPU time at every call of this function to perform some rehashing.</span></td></tr>
<tr class="codeline" data-linenumber="1442"><td class="num" id="LN1442">1442</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1443"><td class="num" id="LN1443">1443</td><td class="line"> <span class='comment'>* The function returns 1 if some rehashing was performed, otherwise 0</span></td></tr>
<tr class="codeline" data-linenumber="1444"><td class="num" id="LN1444">1444</td><td class="line"> <span class='comment'>* is returned. */</span></td></tr>
<tr class="codeline" data-linenumber="1445"><td class="num" id="LN1445">1445</td><td class="line"><span class='keyword'>int</span> incrementallyRehash(<span class='keyword'>int</span> dbid) {</td></tr>
<tr class="codeline" data-linenumber="1446"><td class="num" id="LN1446">1446</td><td class="line">    <span class='comment'>/* Keys dictionary */</span></td></tr>
<tr class="codeline" data-linenumber="1447"><td class="num" id="LN1447">1447</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>dictIsRehashing(server.db[dbid].dict)<span class='macro_popup'>((server.db[dbid].dict)-&gt;rehashidx != -1)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1448"><td class="num" id="LN1448">1448</td><td class="line">        dictRehashMilliseconds(server.db[dbid].dict,1);</td></tr>
<tr class="codeline" data-linenumber="1449"><td class="num" id="LN1449">1449</td><td class="line">        <span class='keyword'>return</span> 1; <span class='comment'>/* already used our millisecond for this loop... */</span></td></tr>
<tr class="codeline" data-linenumber="1450"><td class="num" id="LN1450">1450</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1451"><td class="num" id="LN1451">1451</td><td class="line">    <span class='comment'>/* Expires */</span></td></tr>
<tr class="codeline" data-linenumber="1452"><td class="num" id="LN1452">1452</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>dictIsRehashing(server.db[dbid].expires)<span class='macro_popup'>((server.db[dbid].expires)-&gt;rehashidx != -1)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1453"><td class="num" id="LN1453">1453</td><td class="line">        dictRehashMilliseconds(server.db[dbid].expires,1);</td></tr>
<tr class="codeline" data-linenumber="1454"><td class="num" id="LN1454">1454</td><td class="line">        <span class='keyword'>return</span> 1; <span class='comment'>/* already used our millisecond for this loop... */</span></td></tr>
<tr class="codeline" data-linenumber="1455"><td class="num" id="LN1455">1455</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1456"><td class="num" id="LN1456">1456</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1457"><td class="num" id="LN1457">1457</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1458"><td class="num" id="LN1458">1458</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1459"><td class="num" id="LN1459">1459</td><td class="line"><span class='comment'>/* This function is called once a background process of some kind terminates,</span></td></tr>
<tr class="codeline" data-linenumber="1460"><td class="num" id="LN1460">1460</td><td class="line"> <span class='comment'>* as we want to avoid resizing the hash tables when there is a child in order</span></td></tr>
<tr class="codeline" data-linenumber="1461"><td class="num" id="LN1461">1461</td><td class="line"> <span class='comment'>* to play well with copy-on-write (otherwise when a resize happens lots of</span></td></tr>
<tr class="codeline" data-linenumber="1462"><td class="num" id="LN1462">1462</td><td class="line"> <span class='comment'>* memory pages are copied). The goal of this function is to update the ability</span></td></tr>
<tr class="codeline" data-linenumber="1463"><td class="num" id="LN1463">1463</td><td class="line"> <span class='comment'>* for dict.c to resize the hash tables accordingly to the fact we have an</span></td></tr>
<tr class="codeline" data-linenumber="1464"><td class="num" id="LN1464">1464</td><td class="line"> <span class='comment'>* active fork child running. */</span></td></tr>
<tr class="codeline" data-linenumber="1465"><td class="num" id="LN1465">1465</td><td class="line"><span class='keyword'>void</span> updateDictResizePolicy(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1466"><td class="num" id="LN1466">1466</td><td class="line">    <span class='keyword'>if</span> (!hasActiveChildProcess())</td></tr>
<tr class="codeline" data-linenumber="1467"><td class="num" id="LN1467">1467</td><td class="line">        dictEnableResize();</td></tr>
<tr class="codeline" data-linenumber="1468"><td class="num" id="LN1468">1468</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1469"><td class="num" id="LN1469">1469</td><td class="line">        dictDisableResize();</td></tr>
<tr class="codeline" data-linenumber="1470"><td class="num" id="LN1470">1470</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1471"><td class="num" id="LN1471">1471</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1472"><td class="num" id="LN1472">1472</td><td class="line"><span class='comment'>/* Return true if there are no active children processes doing RDB saving,</span></td></tr>
<tr class="codeline" data-linenumber="1473"><td class="num" id="LN1473">1473</td><td class="line"> <span class='comment'>* AOF rewriting, or some side process spawned by a loaded module. */</span></td></tr>
<tr class="codeline" data-linenumber="1474"><td class="num" id="LN1474">1474</td><td class="line"><span class='keyword'>int</span> hasActiveChildProcess() {</td></tr>
<tr class="codeline" data-linenumber="1475"><td class="num" id="LN1475">1475</td><td class="line">    <span class='keyword'>return</span> server.rdb_child_pid != -1 ||</td></tr>
<tr class="codeline" data-linenumber="1476"><td class="num" id="LN1476">1476</td><td class="line">           server.aof_child_pid != -1 ||</td></tr>
<tr class="codeline" data-linenumber="1477"><td class="num" id="LN1477">1477</td><td class="line">           server.module_child_pid != -1;</td></tr>
<tr class="codeline" data-linenumber="1478"><td class="num" id="LN1478">1478</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1479"><td class="num" id="LN1479">1479</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1480"><td class="num" id="LN1480">1480</td><td class="line"><span class='comment'>/* Return true if this instance has persistence completely turned off:</span></td></tr>
<tr class="codeline" data-linenumber="1481"><td class="num" id="LN1481">1481</td><td class="line"> <span class='comment'>* both RDB and AOF are disabled. */</span></td></tr>
<tr class="codeline" data-linenumber="1482"><td class="num" id="LN1482">1482</td><td class="line"><span class='keyword'>int</span> allPersistenceDisabled(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1483"><td class="num" id="LN1483">1483</td><td class="line">    <span class='keyword'>return</span> server.saveparamslen == 0 &amp;&amp; server.aof_state == <span class='macro'>AOF_OFF<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1484"><td class="num" id="LN1484">1484</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1485"><td class="num" id="LN1485">1485</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1486"><td class="num" id="LN1486">1486</td><td class="line"><span class='comment'>/* ======================= Cron: called every 100 ms ======================== */</span></td></tr>
<tr class="codeline" data-linenumber="1487"><td class="num" id="LN1487">1487</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1488"><td class="num" id="LN1488">1488</td><td class="line"><span class='comment'>/* Add a sample to the operations per second array of samples. */</span></td></tr>
<tr class="codeline" data-linenumber="1489"><td class="num" id="LN1489">1489</td><td class="line"><span class='keyword'>void</span> trackInstantaneousMetric(<span class='keyword'>int</span> metric, <span class='keyword'>long</span> <span class='keyword'>long</span> current_reading) {</td></tr>
<tr class="codeline" data-linenumber="1490"><td class="num" id="LN1490">1490</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> t = mstime() - server.inst_metric[metric].last_sample_time;</td></tr>
<tr class="codeline" data-linenumber="1491"><td class="num" id="LN1491">1491</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> ops = current_reading -</td></tr>
<tr class="codeline" data-linenumber="1492"><td class="num" id="LN1492">1492</td><td class="line">                    server.inst_metric[metric].last_sample_count;</td></tr>
<tr class="codeline" data-linenumber="1493"><td class="num" id="LN1493">1493</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> ops_sec;</td></tr>
<tr class="codeline" data-linenumber="1494"><td class="num" id="LN1494">1494</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1495"><td class="num" id="LN1495">1495</td><td class="line">    ops_sec = t &gt; 0 ? (ops*1000/t) : 0;</td></tr>
<tr class="codeline" data-linenumber="1496"><td class="num" id="LN1496">1496</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1497"><td class="num" id="LN1497">1497</td><td class="line">    server.inst_metric[metric].samples[server.inst_metric[metric].idx] =</td></tr>
<tr class="codeline" data-linenumber="1498"><td class="num" id="LN1498">1498</td><td class="line">        ops_sec;</td></tr>
<tr class="codeline" data-linenumber="1499"><td class="num" id="LN1499">1499</td><td class="line">    server.inst_metric[metric].idx++;</td></tr>
<tr class="codeline" data-linenumber="1500"><td class="num" id="LN1500">1500</td><td class="line">    server.inst_metric[metric].idx %= <span class='macro'>STATS_METRIC_SAMPLES<span class='macro_popup'>16</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1501"><td class="num" id="LN1501">1501</td><td class="line">    server.inst_metric[metric].last_sample_time = mstime();</td></tr>
<tr class="codeline" data-linenumber="1502"><td class="num" id="LN1502">1502</td><td class="line">    server.inst_metric[metric].last_sample_count = current_reading;</td></tr>
<tr class="codeline" data-linenumber="1503"><td class="num" id="LN1503">1503</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1504"><td class="num" id="LN1504">1504</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1505"><td class="num" id="LN1505">1505</td><td class="line"><span class='comment'>/* Return the mean of all the samples. */</span></td></tr>
<tr class="codeline" data-linenumber="1506"><td class="num" id="LN1506">1506</td><td class="line"><span class='keyword'>long</span> <span class='keyword'>long</span> getInstantaneousMetric(<span class='keyword'>int</span> metric) {</td></tr>
<tr class="codeline" data-linenumber="1507"><td class="num" id="LN1507">1507</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="1508"><td class="num" id="LN1508">1508</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> sum = 0;</td></tr>
<tr class="codeline" data-linenumber="1509"><td class="num" id="LN1509">1509</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1510"><td class="num" id="LN1510">1510</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; <span class='macro'>STATS_METRIC_SAMPLES<span class='macro_popup'>16</span></span>; j++)</td></tr>
<tr class="codeline" data-linenumber="1511"><td class="num" id="LN1511">1511</td><td class="line">        sum += server.inst_metric[metric].samples[j];</td></tr>
<tr class="codeline" data-linenumber="1512"><td class="num" id="LN1512">1512</td><td class="line">    <span class='keyword'>return</span> sum / <span class='macro'>STATS_METRIC_SAMPLES<span class='macro_popup'>16</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1513"><td class="num" id="LN1513">1513</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1514"><td class="num" id="LN1514">1514</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1515"><td class="num" id="LN1515">1515</td><td class="line"><span class='comment'>/* The client query buffer is an sds.c string that can end with a lot of</span></td></tr>
<tr class="codeline" data-linenumber="1516"><td class="num" id="LN1516">1516</td><td class="line"> <span class='comment'>* free space not used, this function reclaims space if needed.</span></td></tr>
<tr class="codeline" data-linenumber="1517"><td class="num" id="LN1517">1517</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1518"><td class="num" id="LN1518">1518</td><td class="line"> <span class='comment'>* The function always returns 0 as it never terminates the client. */</span></td></tr>
<tr class="codeline" data-linenumber="1519"><td class="num" id="LN1519">1519</td><td class="line"><span class='keyword'>int</span> clientsCronResizeQueryBuffer(client *c) {</td></tr>
<tr class="codeline" data-linenumber="1520"><td class="num" id="LN1520">1520</td><td class="line">    size_t querybuf_size = sdsAllocSize(c-&gt;querybuf);</td></tr>
<tr class="codeline" data-linenumber="1521"><td class="num" id="LN1521">1521</td><td class="line">    time_t idletime = server.unixtime - c-&gt;lastinteraction;</td></tr>
<tr class="codeline" data-linenumber="1522"><td class="num" id="LN1522">1522</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1523"><td class="num" id="LN1523">1523</td><td class="line">    <span class='comment'>/* There are two conditions to resize the query buffer:</span></td></tr>
<tr class="codeline" data-linenumber="1524"><td class="num" id="LN1524">1524</td><td class="line">     <span class='comment'>* 1) Query buffer is &gt; BIG_ARG and too big for latest peak.</span></td></tr>
<tr class="codeline" data-linenumber="1525"><td class="num" id="LN1525">1525</td><td class="line">     <span class='comment'>* 2) Query buffer is &gt; BIG_ARG and client is idle. */</span></td></tr>
<tr class="codeline" data-linenumber="1526"><td class="num" id="LN1526">1526</td><td class="line">    <span class='keyword'>if</span> (querybuf_size &gt; <span class='macro'>PROTO_MBULK_BIG_ARG<span class='macro_popup'>(1024*32)</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1527"><td class="num" id="LN1527">1527</td><td class="line">         ((querybuf_size/(c-&gt;querybuf_peak+1)) &gt; 2 ||</td></tr>
<tr class="codeline" data-linenumber="1528"><td class="num" id="LN1528">1528</td><td class="line">          idletime &gt; 2))</td></tr>
<tr class="codeline" data-linenumber="1529"><td class="num" id="LN1529">1529</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1530"><td class="num" id="LN1530">1530</td><td class="line">        <span class='comment'>/* Only resize the query buffer if it is actually wasting</span></td></tr>
<tr class="codeline" data-linenumber="1531"><td class="num" id="LN1531">1531</td><td class="line">         <span class='comment'>* at least a few kbytes. */</span></td></tr>
<tr class="codeline" data-linenumber="1532"><td class="num" id="LN1532">1532</td><td class="line">        <span class='keyword'>if</span> (sdsavail(c-&gt;querybuf) &gt; 1024*4) {</td></tr>
<tr class="codeline" data-linenumber="1533"><td class="num" id="LN1533">1533</td><td class="line">            c-&gt;querybuf = sdsRemoveFreeSpace(c-&gt;querybuf);</td></tr>
<tr class="codeline" data-linenumber="1534"><td class="num" id="LN1534">1534</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1535"><td class="num" id="LN1535">1535</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1536"><td class="num" id="LN1536">1536</td><td class="line">    <span class='comment'>/* Reset the peak again to capture the peak memory usage in the next</span></td></tr>
<tr class="codeline" data-linenumber="1537"><td class="num" id="LN1537">1537</td><td class="line">     <span class='comment'>* cycle. */</span></td></tr>
<tr class="codeline" data-linenumber="1538"><td class="num" id="LN1538">1538</td><td class="line">    c-&gt;querybuf_peak = 0;</td></tr>
<tr class="codeline" data-linenumber="1539"><td class="num" id="LN1539">1539</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1540"><td class="num" id="LN1540">1540</td><td class="line">    <span class='comment'>/* Clients representing masters also use a "pending query buffer" that</span></td></tr>
<tr class="codeline" data-linenumber="1541"><td class="num" id="LN1541">1541</td><td class="line">     <span class='comment'>* is the yet not applied part of the stream we are reading. Such buffer</span></td></tr>
<tr class="codeline" data-linenumber="1542"><td class="num" id="LN1542">1542</td><td class="line">     <span class='comment'>* also needs resizing from time to time, otherwise after a very large</span></td></tr>
<tr class="codeline" data-linenumber="1543"><td class="num" id="LN1543">1543</td><td class="line">     <span class='comment'>* transfer (a huge value or a big MIGRATE operation) it will keep using</span></td></tr>
<tr class="codeline" data-linenumber="1544"><td class="num" id="LN1544">1544</td><td class="line">     <span class='comment'>* a lot of memory. */</span></td></tr>
<tr class="codeline" data-linenumber="1545"><td class="num" id="LN1545">1545</td><td class="line">    <span class='keyword'>if</span> (c-&gt;flags &amp; <span class='macro'>CLIENT_MASTER<span class='macro_popup'>(1&lt;&lt;1)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1546"><td class="num" id="LN1546">1546</td><td class="line">        <span class='comment'>/* There are two conditions to resize the pending query buffer:</span></td></tr>
<tr class="codeline" data-linenumber="1547"><td class="num" id="LN1547">1547</td><td class="line">         <span class='comment'>* 1) Pending Query buffer is &gt; LIMIT_PENDING_QUERYBUF.</span></td></tr>
<tr class="codeline" data-linenumber="1548"><td class="num" id="LN1548">1548</td><td class="line">         <span class='comment'>* 2) Used length is smaller than pending_querybuf_size/2 */</span></td></tr>
<tr class="codeline" data-linenumber="1549"><td class="num" id="LN1549">1549</td><td class="line">        size_t pending_querybuf_size = sdsAllocSize(c-&gt;pending_querybuf);</td></tr>
<tr class="codeline" data-linenumber="1550"><td class="num" id="LN1550">1550</td><td class="line">        <span class='keyword'>if</span>(pending_querybuf_size &gt; <span class='macro'>LIMIT_PENDING_QUERYBUF<span class='macro_popup'>(4*1024*1024)</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1551"><td class="num" id="LN1551">1551</td><td class="line">           sdslen(c-&gt;pending_querybuf) &lt; (pending_querybuf_size/2))</td></tr>
<tr class="codeline" data-linenumber="1552"><td class="num" id="LN1552">1552</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="1553"><td class="num" id="LN1553">1553</td><td class="line">            c-&gt;pending_querybuf = sdsRemoveFreeSpace(c-&gt;pending_querybuf);</td></tr>
<tr class="codeline" data-linenumber="1554"><td class="num" id="LN1554">1554</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1555"><td class="num" id="LN1555">1555</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1556"><td class="num" id="LN1556">1556</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1557"><td class="num" id="LN1557">1557</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1558"><td class="num" id="LN1558">1558</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1559"><td class="num" id="LN1559">1559</td><td class="line"><span class='comment'>/* This function is used in order to track clients using the biggest amount</span></td></tr>
<tr class="codeline" data-linenumber="1560"><td class="num" id="LN1560">1560</td><td class="line"> <span class='comment'>* of memory in the latest few seconds. This way we can provide such information</span></td></tr>
<tr class="codeline" data-linenumber="1561"><td class="num" id="LN1561">1561</td><td class="line"> <span class='comment'>* in the INFO output (clients section), without having to do an O(N) scan for</span></td></tr>
<tr class="codeline" data-linenumber="1562"><td class="num" id="LN1562">1562</td><td class="line"> <span class='comment'>* all the clients.</span></td></tr>
<tr class="codeline" data-linenumber="1563"><td class="num" id="LN1563">1563</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1564"><td class="num" id="LN1564">1564</td><td class="line"> <span class='comment'>* This is how it works. We have an array of CLIENTS_PEAK_MEM_USAGE_SLOTS slots</span></td></tr>
<tr class="codeline" data-linenumber="1565"><td class="num" id="LN1565">1565</td><td class="line"> <span class='comment'>* where we track, for each, the biggest client output and input buffers we</span></td></tr>
<tr class="codeline" data-linenumber="1566"><td class="num" id="LN1566">1566</td><td class="line"> <span class='comment'>* saw in that slot. Every slot correspond to one of the latest seconds, since</span></td></tr>
<tr class="codeline" data-linenumber="1567"><td class="num" id="LN1567">1567</td><td class="line"> <span class='comment'>* the array is indexed by doing UNIXTIME % CLIENTS_PEAK_MEM_USAGE_SLOTS.</span></td></tr>
<tr class="codeline" data-linenumber="1568"><td class="num" id="LN1568">1568</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1569"><td class="num" id="LN1569">1569</td><td class="line"> <span class='comment'>* When we want to know what was recently the peak memory usage, we just scan</span></td></tr>
<tr class="codeline" data-linenumber="1570"><td class="num" id="LN1570">1570</td><td class="line"> <span class='comment'>* such few slots searching for the maximum value. */</span></td></tr>
<tr class="codeline" data-linenumber="1571"><td class="num" id="LN1571">1571</td><td class="line"><span class='directive'>#define <span class='macro'>CLIENTS_PEAK_MEM_USAGE_SLOTS<span class='macro_popup'>8</span></span> 8</span></td></tr>
<tr class="codeline" data-linenumber="1572"><td class="num" id="LN1572">1572</td><td class="line">size_t ClientsPeakMemInput[<span class='macro'>CLIENTS_PEAK_MEM_USAGE_SLOTS<span class='macro_popup'>8</span></span>];</td></tr>
<tr class="codeline" data-linenumber="1573"><td class="num" id="LN1573">1573</td><td class="line">size_t ClientsPeakMemOutput[<span class='macro'>CLIENTS_PEAK_MEM_USAGE_SLOTS<span class='macro_popup'>8</span></span>];</td></tr>
<tr class="codeline" data-linenumber="1574"><td class="num" id="LN1574">1574</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1575"><td class="num" id="LN1575">1575</td><td class="line"><span class='keyword'>int</span> clientsCronTrackExpansiveClients(client *c) {</td></tr>
<tr class="codeline" data-linenumber="1576"><td class="num" id="LN1576">1576</td><td class="line">    size_t in_usage = sdsZmallocSize(c-&gt;querybuf) + c-&gt;argv_len_sum;</td></tr>
<tr class="codeline" data-linenumber="1577"><td class="num" id="LN1577">1577</td><td class="line">    size_t out_usage = getClientOutputBufferMemoryUsage(c);</td></tr>
<tr class="codeline" data-linenumber="1578"><td class="num" id="LN1578">1578</td><td class="line">    <span class='keyword'>int</span> i = server.unixtime % <span class='macro'>CLIENTS_PEAK_MEM_USAGE_SLOTS<span class='macro_popup'>8</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1579"><td class="num" id="LN1579">1579</td><td class="line">    <span class='keyword'>int</span> zeroidx = (i+1) % <span class='macro'>CLIENTS_PEAK_MEM_USAGE_SLOTS<span class='macro_popup'>8</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1580"><td class="num" id="LN1580">1580</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1581"><td class="num" id="LN1581">1581</td><td class="line">    <span class='comment'>/* Always zero the next sample, so that when we switch to that second, we'll</span></td></tr>
<tr class="codeline" data-linenumber="1582"><td class="num" id="LN1582">1582</td><td class="line">     <span class='comment'>* only register samples that are greater in that second without considering</span></td></tr>
<tr class="codeline" data-linenumber="1583"><td class="num" id="LN1583">1583</td><td class="line">     <span class='comment'>* the history of such slot.</span></td></tr>
<tr class="codeline" data-linenumber="1584"><td class="num" id="LN1584">1584</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1585"><td class="num" id="LN1585">1585</td><td class="line">     <span class='comment'>* Note: our index may jump to any random position if serverCron() is not</span></td></tr>
<tr class="codeline" data-linenumber="1586"><td class="num" id="LN1586">1586</td><td class="line">     <span class='comment'>* called for some reason with the normal frequency, for instance because</span></td></tr>
<tr class="codeline" data-linenumber="1587"><td class="num" id="LN1587">1587</td><td class="line">     <span class='comment'>* some slow command is called taking multiple seconds to execute. In that</span></td></tr>
<tr class="codeline" data-linenumber="1588"><td class="num" id="LN1588">1588</td><td class="line">     <span class='comment'>* case our array may end containing data which is potentially older</span></td></tr>
<tr class="codeline" data-linenumber="1589"><td class="num" id="LN1589">1589</td><td class="line">     <span class='comment'>* than CLIENTS_PEAK_MEM_USAGE_SLOTS seconds: however this is not a problem</span></td></tr>
<tr class="codeline" data-linenumber="1590"><td class="num" id="LN1590">1590</td><td class="line">     <span class='comment'>* since here we want just to track if "recently" there were very expansive</span></td></tr>
<tr class="codeline" data-linenumber="1591"><td class="num" id="LN1591">1591</td><td class="line">     <span class='comment'>* clients from the POV of memory usage. */</span></td></tr>
<tr class="codeline" data-linenumber="1592"><td class="num" id="LN1592">1592</td><td class="line">    ClientsPeakMemInput[zeroidx] = 0;</td></tr>
<tr class="codeline" data-linenumber="1593"><td class="num" id="LN1593">1593</td><td class="line">    ClientsPeakMemOutput[zeroidx] = 0;</td></tr>
<tr class="codeline" data-linenumber="1594"><td class="num" id="LN1594">1594</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1595"><td class="num" id="LN1595">1595</td><td class="line">    <span class='comment'>/* Track the biggest values observed so far in this slot. */</span></td></tr>
<tr class="codeline" data-linenumber="1596"><td class="num" id="LN1596">1596</td><td class="line">    <span class='keyword'>if</span> (in_usage &gt; ClientsPeakMemInput[i]) ClientsPeakMemInput[i] = in_usage;</td></tr>
<tr class="codeline" data-linenumber="1597"><td class="num" id="LN1597">1597</td><td class="line">    <span class='keyword'>if</span> (out_usage &gt; ClientsPeakMemOutput[i]) ClientsPeakMemOutput[i] = out_usage;</td></tr>
<tr class="codeline" data-linenumber="1598"><td class="num" id="LN1598">1598</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1599"><td class="num" id="LN1599">1599</td><td class="line">    <span class='keyword'>return</span> 0; <span class='comment'>/* This function never terminates the client. */</span></td></tr>
<tr class="codeline" data-linenumber="1600"><td class="num" id="LN1600">1600</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1601"><td class="num" id="LN1601">1601</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1602"><td class="num" id="LN1602">1602</td><td class="line"><span class='comment'>/* Iterating all the clients in getMemoryOverheadData() is too slow and</span></td></tr>
<tr class="codeline" data-linenumber="1603"><td class="num" id="LN1603">1603</td><td class="line"> <span class='comment'>* in turn would make the INFO command too slow. So we perform this</span></td></tr>
<tr class="codeline" data-linenumber="1604"><td class="num" id="LN1604">1604</td><td class="line"> <span class='comment'>* computation incrementally and track the (not instantaneous but updated</span></td></tr>
<tr class="codeline" data-linenumber="1605"><td class="num" id="LN1605">1605</td><td class="line"> <span class='comment'>* to the second) total memory used by clients using clinetsCron() in</span></td></tr>
<tr class="codeline" data-linenumber="1606"><td class="num" id="LN1606">1606</td><td class="line"> <span class='comment'>* a more incremental way (depending on server.hz). */</span></td></tr>
<tr class="codeline" data-linenumber="1607"><td class="num" id="LN1607">1607</td><td class="line"><span class='keyword'>int</span> clientsCronTrackClientsMemUsage(client *c) {</td></tr>
<tr class="codeline" data-linenumber="1608"><td class="num" id="LN1608">1608</td><td class="line">    size_t mem = 0;</td></tr>
<tr class="codeline" data-linenumber="1609"><td class="num" id="LN1609">1609</td><td class="line">    <span class='keyword'>int</span> type = getClientType(c);</td></tr>
<tr class="codeline" data-linenumber="1610"><td class="num" id="LN1610">1610</td><td class="line">    mem += getClientOutputBufferMemoryUsage(c);</td></tr>
<tr class="codeline" data-linenumber="1611"><td class="num" id="LN1611">1611</td><td class="line">    mem += sdsZmallocSize(c-&gt;querybuf);</td></tr>
<tr class="codeline" data-linenumber="1612"><td class="num" id="LN1612">1612</td><td class="line">    mem += <span class='macro'>zmalloc_size(c)<span class='macro_popup'>je_malloc_usable_size(c)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1613"><td class="num" id="LN1613">1613</td><td class="line">    mem += c-&gt;argv_len_sum;</td></tr>
<tr class="codeline" data-linenumber="1614"><td class="num" id="LN1614">1614</td><td class="line">    <span class='keyword'>if</span> (c-&gt;argv) mem += <span class='macro'>zmalloc_size(c-&gt;argv)<span class='macro_popup'>je_malloc_usable_size(c-&gt;argv)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1615"><td class="num" id="LN1615">1615</td><td class="line">    <span class='comment'>/* Now that we have the memory used by the client, remove the old</span></td></tr>
<tr class="codeline" data-linenumber="1616"><td class="num" id="LN1616">1616</td><td class="line">     <span class='comment'>* value from the old category, and add it back. */</span></td></tr>
<tr class="codeline" data-linenumber="1617"><td class="num" id="LN1617">1617</td><td class="line">    server.stat_clients_type_memory[c-&gt;client_cron_last_memory_type] -=</td></tr>
<tr class="codeline" data-linenumber="1618"><td class="num" id="LN1618">1618</td><td class="line">        c-&gt;client_cron_last_memory_usage;</td></tr>
<tr class="codeline" data-linenumber="1619"><td class="num" id="LN1619">1619</td><td class="line">    server.stat_clients_type_memory[type] += mem;</td></tr>
<tr class="codeline" data-linenumber="1620"><td class="num" id="LN1620">1620</td><td class="line">    <span class='comment'>/* Remember what we added and where, to remove it next time. */</span></td></tr>
<tr class="codeline" data-linenumber="1621"><td class="num" id="LN1621">1621</td><td class="line">    c-&gt;client_cron_last_memory_usage = mem;</td></tr>
<tr class="codeline" data-linenumber="1622"><td class="num" id="LN1622">1622</td><td class="line">    c-&gt;client_cron_last_memory_type = type;</td></tr>
<tr class="codeline" data-linenumber="1623"><td class="num" id="LN1623">1623</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1624"><td class="num" id="LN1624">1624</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1625"><td class="num" id="LN1625">1625</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1626"><td class="num" id="LN1626">1626</td><td class="line"><span class='comment'>/* Return the max samples in the memory usage of clients tracked by</span></td></tr>
<tr class="codeline" data-linenumber="1627"><td class="num" id="LN1627">1627</td><td class="line"> <span class='comment'>* the function clientsCronTrackExpansiveClients(). */</span></td></tr>
<tr class="codeline" data-linenumber="1628"><td class="num" id="LN1628">1628</td><td class="line"><span class='keyword'>void</span> getExpansiveClientsInfo(size_t *in_usage, size_t *out_usage) {</td></tr>
<tr class="codeline" data-linenumber="1629"><td class="num" id="LN1629">1629</td><td class="line">    size_t i = 0, o = 0;</td></tr>
<tr class="codeline" data-linenumber="1630"><td class="num" id="LN1630">1630</td><td class="line">    <span class='keyword'>for</span> (<span class='keyword'>int</span> j = 0; j &lt; <span class='macro'>CLIENTS_PEAK_MEM_USAGE_SLOTS<span class='macro_popup'>8</span></span>; j++) {</td></tr>
<tr class="codeline" data-linenumber="1631"><td class="num" id="LN1631">1631</td><td class="line">        <span class='keyword'>if</span> (ClientsPeakMemInput[j] &gt; i) i = ClientsPeakMemInput[j];</td></tr>
<tr class="codeline" data-linenumber="1632"><td class="num" id="LN1632">1632</td><td class="line">        <span class='keyword'>if</span> (ClientsPeakMemOutput[j] &gt; o) o = ClientsPeakMemOutput[j];</td></tr>
<tr class="codeline" data-linenumber="1633"><td class="num" id="LN1633">1633</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1634"><td class="num" id="LN1634">1634</td><td class="line">    *in_usage = i;</td></tr>
<tr class="codeline" data-linenumber="1635"><td class="num" id="LN1635">1635</td><td class="line">    *out_usage = o;</td></tr>
<tr class="codeline" data-linenumber="1636"><td class="num" id="LN1636">1636</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1637"><td class="num" id="LN1637">1637</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1638"><td class="num" id="LN1638">1638</td><td class="line"><span class='comment'>/* This function is called by serverCron() and is used in order to perform</span></td></tr>
<tr class="codeline" data-linenumber="1639"><td class="num" id="LN1639">1639</td><td class="line"> <span class='comment'>* operations on clients that are important to perform constantly. For instance</span></td></tr>
<tr class="codeline" data-linenumber="1640"><td class="num" id="LN1640">1640</td><td class="line"> <span class='comment'>* we use this function in order to disconnect clients after a timeout, including</span></td></tr>
<tr class="codeline" data-linenumber="1641"><td class="num" id="LN1641">1641</td><td class="line"> <span class='comment'>* clients blocked in some blocking command with a non-zero timeout.</span></td></tr>
<tr class="codeline" data-linenumber="1642"><td class="num" id="LN1642">1642</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1643"><td class="num" id="LN1643">1643</td><td class="line"> <span class='comment'>* The function makes some effort to process all the clients every second, even</span></td></tr>
<tr class="codeline" data-linenumber="1644"><td class="num" id="LN1644">1644</td><td class="line"> <span class='comment'>* if this cannot be strictly guaranteed, since serverCron() may be called with</span></td></tr>
<tr class="codeline" data-linenumber="1645"><td class="num" id="LN1645">1645</td><td class="line"> <span class='comment'>* an actual frequency lower than server.hz in case of latency events like slow</span></td></tr>
<tr class="codeline" data-linenumber="1646"><td class="num" id="LN1646">1646</td><td class="line"> <span class='comment'>* commands.</span></td></tr>
<tr class="codeline" data-linenumber="1647"><td class="num" id="LN1647">1647</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1648"><td class="num" id="LN1648">1648</td><td class="line"> <span class='comment'>* It is very important for this function, and the functions it calls, to be</span></td></tr>
<tr class="codeline" data-linenumber="1649"><td class="num" id="LN1649">1649</td><td class="line"> <span class='comment'>* very fast: sometimes Redis has tens of hundreds of connected clients, and the</span></td></tr>
<tr class="codeline" data-linenumber="1650"><td class="num" id="LN1650">1650</td><td class="line"> <span class='comment'>* default server.hz value is 10, so sometimes here we need to process thousands</span></td></tr>
<tr class="codeline" data-linenumber="1651"><td class="num" id="LN1651">1651</td><td class="line"> <span class='comment'>* of clients per second, turning this function into a source of latency.</span></td></tr>
<tr class="codeline" data-linenumber="1652"><td class="num" id="LN1652">1652</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1653"><td class="num" id="LN1653">1653</td><td class="line"><span class='directive'>#define <span class='macro'>CLIENTS_CRON_MIN_ITERATIONS<span class='macro_popup'>5</span></span> 5</span></td></tr>
<tr class="codeline" data-linenumber="1654"><td class="num" id="LN1654">1654</td><td class="line"><span class='keyword'>void</span> clientsCron(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1655"><td class="num" id="LN1655">1655</td><td class="line">    <span class='comment'>/* Try to process at least numclients/server.hz of clients</span></td></tr>
<tr class="codeline" data-linenumber="1656"><td class="num" id="LN1656">1656</td><td class="line">     <span class='comment'>* per call. Since normally (if there are no big latency events) this</span></td></tr>
<tr class="codeline" data-linenumber="1657"><td class="num" id="LN1657">1657</td><td class="line">     <span class='comment'>* function is called server.hz times per second, in the average case we</span></td></tr>
<tr class="codeline" data-linenumber="1658"><td class="num" id="LN1658">1658</td><td class="line">     <span class='comment'>* process all the clients in 1 second. */</span></td></tr>
<tr class="codeline" data-linenumber="1659"><td class="num" id="LN1659">1659</td><td class="line">    <span class='keyword'>int</span> numclients = <span class='macro'>listLength(server.clients)<span class='macro_popup'>((server.clients)-&gt;len)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1660"><td class="num" id="LN1660">1660</td><td class="line">    <span class='keyword'>int</span> iterations = numclients/server.hz;</td></tr>
<tr class="codeline" data-linenumber="1661"><td class="num" id="LN1661">1661</td><td class="line">    mstime_t now = mstime();</td></tr>
<tr class="codeline" data-linenumber="1662"><td class="num" id="LN1662">1662</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1663"><td class="num" id="LN1663">1663</td><td class="line">    <span class='comment'>/* Process at least a few clients while we are at it, even if we need</span></td></tr>
<tr class="codeline" data-linenumber="1664"><td class="num" id="LN1664">1664</td><td class="line">     <span class='comment'>* to process less than CLIENTS_CRON_MIN_ITERATIONS to meet our contract</span></td></tr>
<tr class="codeline" data-linenumber="1665"><td class="num" id="LN1665">1665</td><td class="line">     <span class='comment'>* of processing each client once per second. */</span></td></tr>
<tr class="codeline" data-linenumber="1666"><td class="num" id="LN1666">1666</td><td class="line">    <span class='keyword'>if</span> (iterations &lt; <span class='macro'>CLIENTS_CRON_MIN_ITERATIONS<span class='macro_popup'>5</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1667"><td class="num" id="LN1667">1667</td><td class="line">        iterations = (numclients &lt; <span class='macro'>CLIENTS_CRON_MIN_ITERATIONS<span class='macro_popup'>5</span></span>) ?</td></tr>
<tr class="codeline" data-linenumber="1668"><td class="num" id="LN1668">1668</td><td class="line">                     numclients : <span class='macro'>CLIENTS_CRON_MIN_ITERATIONS<span class='macro_popup'>5</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1669"><td class="num" id="LN1669">1669</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1670"><td class="num" id="LN1670">1670</td><td class="line">    <span class='keyword'>while</span>(<span class='macro'>listLength(server.clients)<span class='macro_popup'>((server.clients)-&gt;len)</span></span> &amp;&amp; iterations--) {</td></tr>
<tr class="codeline" data-linenumber="1671"><td class="num" id="LN1671">1671</td><td class="line">        client *c;</td></tr>
<tr class="codeline" data-linenumber="1672"><td class="num" id="LN1672">1672</td><td class="line">        listNode *head;</td></tr>
<tr class="codeline" data-linenumber="1673"><td class="num" id="LN1673">1673</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1674"><td class="num" id="LN1674">1674</td><td class="line">        <span class='comment'>/* Rotate the list, take the current head, process.</span></td></tr>
<tr class="codeline" data-linenumber="1675"><td class="num" id="LN1675">1675</td><td class="line">         <span class='comment'>* This way if the client must be removed from the list it's the</span></td></tr>
<tr class="codeline" data-linenumber="1676"><td class="num" id="LN1676">1676</td><td class="line">         <span class='comment'>* first element and we don't incur into O(N) computation. */</span></td></tr>
<tr class="codeline" data-linenumber="1677"><td class="num" id="LN1677">1677</td><td class="line">        listRotateTailToHead(server.clients);</td></tr>
<tr class="codeline" data-linenumber="1678"><td class="num" id="LN1678">1678</td><td class="line">        head = <span class='macro'>listFirst(server.clients)<span class='macro_popup'>((server.clients)-&gt;head)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1679"><td class="num" id="LN1679">1679</td><td class="line">        c = <span class='macro'>listNodeValue(head)<span class='macro_popup'>((head)-&gt;value)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1680"><td class="num" id="LN1680">1680</td><td class="line">        <span class='comment'>/* The following functions do different service checks on the client.</span></td></tr>
<tr class="codeline" data-linenumber="1681"><td class="num" id="LN1681">1681</td><td class="line">         <span class='comment'>* The protocol is that they return non-zero if the client was</span></td></tr>
<tr class="codeline" data-linenumber="1682"><td class="num" id="LN1682">1682</td><td class="line">         <span class='comment'>* terminated. */</span></td></tr>
<tr class="codeline" data-linenumber="1683"><td class="num" id="LN1683">1683</td><td class="line">        <span class='keyword'>if</span> (clientsCronHandleTimeout(c,now)) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1684"><td class="num" id="LN1684">1684</td><td class="line">        <span class='keyword'>if</span> (clientsCronResizeQueryBuffer(c)) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1685"><td class="num" id="LN1685">1685</td><td class="line">        <span class='keyword'>if</span> (clientsCronTrackExpansiveClients(c)) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1686"><td class="num" id="LN1686">1686</td><td class="line">        <span class='keyword'>if</span> (clientsCronTrackClientsMemUsage(c)) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1687"><td class="num" id="LN1687">1687</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1688"><td class="num" id="LN1688">1688</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1689"><td class="num" id="LN1689">1689</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1690"><td class="num" id="LN1690">1690</td><td class="line"><span class='comment'>/* This function handles 'background' operations we are required to do</span></td></tr>
<tr class="codeline" data-linenumber="1691"><td class="num" id="LN1691">1691</td><td class="line"> <span class='comment'>* incrementally in Redis databases, such as active key expiring, resizing,</span></td></tr>
<tr class="codeline" data-linenumber="1692"><td class="num" id="LN1692">1692</td><td class="line"> <span class='comment'>* rehashing. */</span></td></tr>
<tr class="codeline" data-linenumber="1693"><td class="num" id="LN1693">1693</td><td class="line"><span class='keyword'>void</span> databasesCron(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1694"><td class="num" id="LN1694">1694</td><td class="line">    <span class='comment'>/* Expire keys by random sampling. Not required for slaves</span></td></tr>
<tr class="codeline" data-linenumber="1695"><td class="num" id="LN1695">1695</td><td class="line">     <span class='comment'>* as master will synthesize DELs for us. */</span></td></tr>
<tr class="codeline" data-linenumber="1696"><td class="num" id="LN1696">1696</td><td class="line">    <span class='keyword'>if</span> (server.active_expire_enabled) {</td></tr>
<tr class="codeline" data-linenumber="1697"><td class="num" id="LN1697">1697</td><td class="line">        <span class='keyword'>if</span> (iAmMaster()) {</td></tr>
<tr class="codeline" data-linenumber="1698"><td class="num" id="LN1698">1698</td><td class="line">            activeExpireCycle(<span class='macro'>ACTIVE_EXPIRE_CYCLE_SLOW<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1699"><td class="num" id="LN1699">1699</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1700"><td class="num" id="LN1700">1700</td><td class="line">            expireSlaveKeys();</td></tr>
<tr class="codeline" data-linenumber="1701"><td class="num" id="LN1701">1701</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1702"><td class="num" id="LN1702">1702</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1703"><td class="num" id="LN1703">1703</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1704"><td class="num" id="LN1704">1704</td><td class="line">    <span class='comment'>/* Defrag keys gradually. */</span></td></tr>
<tr class="codeline" data-linenumber="1705"><td class="num" id="LN1705">1705</td><td class="line">    activeDefragCycle();</td></tr>
<tr class="codeline" data-linenumber="1706"><td class="num" id="LN1706">1706</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1707"><td class="num" id="LN1707">1707</td><td class="line">    <span class='comment'>/* Perform hash tables rehashing if needed, but only if there are no</span></td></tr>
<tr class="codeline" data-linenumber="1708"><td class="num" id="LN1708">1708</td><td class="line">     <span class='comment'>* other processes saving the DB on disk. Otherwise rehashing is bad</span></td></tr>
<tr class="codeline" data-linenumber="1709"><td class="num" id="LN1709">1709</td><td class="line">     <span class='comment'>* as will cause a lot of copy-on-write of memory pages. */</span></td></tr>
<tr class="codeline" data-linenumber="1710"><td class="num" id="LN1710">1710</td><td class="line">    <span class='keyword'>if</span> (!hasActiveChildProcess()) {</td></tr>
<tr class="codeline" data-linenumber="1711"><td class="num" id="LN1711">1711</td><td class="line">        <span class='comment'>/* We use global counters so if we stop the computation at a given</span></td></tr>
<tr class="codeline" data-linenumber="1712"><td class="num" id="LN1712">1712</td><td class="line">         <span class='comment'>* DB we'll be able to start from the successive in the next</span></td></tr>
<tr class="codeline" data-linenumber="1713"><td class="num" id="LN1713">1713</td><td class="line">         <span class='comment'>* cron loop iteration. */</span></td></tr>
<tr class="codeline" data-linenumber="1714"><td class="num" id="LN1714">1714</td><td class="line">        <span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>int</span> resize_db = 0;</td></tr>
<tr class="codeline" data-linenumber="1715"><td class="num" id="LN1715">1715</td><td class="line">        <span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>int</span> rehash_db = 0;</td></tr>
<tr class="codeline" data-linenumber="1716"><td class="num" id="LN1716">1716</td><td class="line">        <span class='keyword'>int</span> dbs_per_call = <span class='macro'>CRON_DBS_PER_CALL<span class='macro_popup'>16</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1717"><td class="num" id="LN1717">1717</td><td class="line">        <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="1718"><td class="num" id="LN1718">1718</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1719"><td class="num" id="LN1719">1719</td><td class="line">        <span class='comment'>/* Don't test more DBs than we have. */</span></td></tr>
<tr class="codeline" data-linenumber="1720"><td class="num" id="LN1720">1720</td><td class="line">        <span class='keyword'>if</span> (dbs_per_call &gt; server.dbnum) dbs_per_call = server.dbnum;</td></tr>
<tr class="codeline" data-linenumber="1721"><td class="num" id="LN1721">1721</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1722"><td class="num" id="LN1722">1722</td><td class="line">        <span class='comment'>/* Resize */</span></td></tr>
<tr class="codeline" data-linenumber="1723"><td class="num" id="LN1723">1723</td><td class="line">        <span class='keyword'>for</span> (j = 0; j &lt; dbs_per_call; j++) {</td></tr>
<tr class="codeline" data-linenumber="1724"><td class="num" id="LN1724">1724</td><td class="line">            tryResizeHashTables(resize_db % server.dbnum);</td></tr>
<tr class="codeline" data-linenumber="1725"><td class="num" id="LN1725">1725</td><td class="line">            resize_db++;</td></tr>
<tr class="codeline" data-linenumber="1726"><td class="num" id="LN1726">1726</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1727"><td class="num" id="LN1727">1727</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1728"><td class="num" id="LN1728">1728</td><td class="line">        <span class='comment'>/* Rehash */</span></td></tr>
<tr class="codeline" data-linenumber="1729"><td class="num" id="LN1729">1729</td><td class="line">        <span class='keyword'>if</span> (server.activerehashing) {</td></tr>
<tr class="codeline" data-linenumber="1730"><td class="num" id="LN1730">1730</td><td class="line">            <span class='keyword'>for</span> (j = 0; j &lt; dbs_per_call; j++) {</td></tr>
<tr class="codeline" data-linenumber="1731"><td class="num" id="LN1731">1731</td><td class="line">                <span class='keyword'>int</span> work_done = incrementallyRehash(rehash_db);</td></tr>
<tr class="codeline" data-linenumber="1732"><td class="num" id="LN1732">1732</td><td class="line">                <span class='keyword'>if</span> (work_done) {</td></tr>
<tr class="codeline" data-linenumber="1733"><td class="num" id="LN1733">1733</td><td class="line">                    <span class='comment'>/* If the function did some work, stop here, we'll do</span></td></tr>
<tr class="codeline" data-linenumber="1734"><td class="num" id="LN1734">1734</td><td class="line">                     <span class='comment'>* more at the next cron loop. */</span></td></tr>
<tr class="codeline" data-linenumber="1735"><td class="num" id="LN1735">1735</td><td class="line">                    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1736"><td class="num" id="LN1736">1736</td><td class="line">                } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1737"><td class="num" id="LN1737">1737</td><td class="line">                    <span class='comment'>/* If this db didn't need rehash, we'll try the next one. */</span></td></tr>
<tr class="codeline" data-linenumber="1738"><td class="num" id="LN1738">1738</td><td class="line">                    rehash_db++;</td></tr>
<tr class="codeline" data-linenumber="1739"><td class="num" id="LN1739">1739</td><td class="line">                    rehash_db %= server.dbnum;</td></tr>
<tr class="codeline" data-linenumber="1740"><td class="num" id="LN1740">1740</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1741"><td class="num" id="LN1741">1741</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1742"><td class="num" id="LN1742">1742</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1743"><td class="num" id="LN1743">1743</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1744"><td class="num" id="LN1744">1744</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1745"><td class="num" id="LN1745">1745</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1746"><td class="num" id="LN1746">1746</td><td class="line"><span class='comment'>/* We take a cached value of the unix time in the global state because with</span></td></tr>
<tr class="codeline" data-linenumber="1747"><td class="num" id="LN1747">1747</td><td class="line"> <span class='comment'>* virtual memory and aging there is to store the current time in objects at</span></td></tr>
<tr class="codeline" data-linenumber="1748"><td class="num" id="LN1748">1748</td><td class="line"> <span class='comment'>* every object access, and accuracy is not needed. To access a global var is</span></td></tr>
<tr class="codeline" data-linenumber="1749"><td class="num" id="LN1749">1749</td><td class="line"> <span class='comment'>* a lot faster than calling time(NULL).</span></td></tr>
<tr class="codeline" data-linenumber="1750"><td class="num" id="LN1750">1750</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1751"><td class="num" id="LN1751">1751</td><td class="line"> <span class='comment'>* This function should be fast because it is called at every command execution</span></td></tr>
<tr class="codeline" data-linenumber="1752"><td class="num" id="LN1752">1752</td><td class="line"> <span class='comment'>* in call(), so it is possible to decide if to update the daylight saving</span></td></tr>
<tr class="codeline" data-linenumber="1753"><td class="num" id="LN1753">1753</td><td class="line"> <span class='comment'>* info or not using the 'update_daylight_info' argument. Normally we update</span></td></tr>
<tr class="codeline" data-linenumber="1754"><td class="num" id="LN1754">1754</td><td class="line"> <span class='comment'>* such info only when calling this function from serverCron() but not when</span></td></tr>
<tr class="codeline" data-linenumber="1755"><td class="num" id="LN1755">1755</td><td class="line"> <span class='comment'>* calling it from call(). */</span></td></tr>
<tr class="codeline" data-linenumber="1756"><td class="num" id="LN1756">1756</td><td class="line"><span class='keyword'>void</span> updateCachedTime(<span class='keyword'>int</span> update_daylight_info) {</td></tr>
<tr class="codeline" data-linenumber="1757"><td class="num" id="LN1757">1757</td><td class="line">    server.ustime = ustime();</td></tr>
<tr class="codeline" data-linenumber="1758"><td class="num" id="LN1758">1758</td><td class="line">    server.mstime = server.ustime / 1000;</td></tr>
<tr class="codeline" data-linenumber="1759"><td class="num" id="LN1759">1759</td><td class="line">    server.unixtime = server.mstime / 1000;</td></tr>
<tr class="codeline" data-linenumber="1760"><td class="num" id="LN1760">1760</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1761"><td class="num" id="LN1761">1761</td><td class="line">    <span class='comment'>/* To get information about daylight saving time, we need to call</span></td></tr>
<tr class="codeline" data-linenumber="1762"><td class="num" id="LN1762">1762</td><td class="line">     <span class='comment'>* localtime_r and cache the result. However calling localtime_r in this</span></td></tr>
<tr class="codeline" data-linenumber="1763"><td class="num" id="LN1763">1763</td><td class="line">     <span class='comment'>* context is safe since we will never fork() while here, in the main</span></td></tr>
<tr class="codeline" data-linenumber="1764"><td class="num" id="LN1764">1764</td><td class="line">     <span class='comment'>* thread. The logging function will call a thread safe version of</span></td></tr>
<tr class="codeline" data-linenumber="1765"><td class="num" id="LN1765">1765</td><td class="line">     <span class='comment'>* localtime that has no locks. */</span></td></tr>
<tr class="codeline" data-linenumber="1766"><td class="num" id="LN1766">1766</td><td class="line">    <span class='keyword'>if</span> (update_daylight_info) {</td></tr>
<tr class="codeline" data-linenumber="1767"><td class="num" id="LN1767">1767</td><td class="line">        <span class='keyword'>struct</span> tm tm;</td></tr>
<tr class="codeline" data-linenumber="1768"><td class="num" id="LN1768">1768</td><td class="line">        time_t ut = server.unixtime;</td></tr>
<tr class="codeline" data-linenumber="1769"><td class="num" id="LN1769">1769</td><td class="line">        localtime_r(&amp;ut,&amp;tm);</td></tr>
<tr class="codeline" data-linenumber="1770"><td class="num" id="LN1770">1770</td><td class="line">        server.daylight_active = tm.tm_isdst;</td></tr>
<tr class="codeline" data-linenumber="1771"><td class="num" id="LN1771">1771</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1772"><td class="num" id="LN1772">1772</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1773"><td class="num" id="LN1773">1773</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1774"><td class="num" id="LN1774">1774</td><td class="line"><span class='keyword'>void</span> checkChildrenDone(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1775"><td class="num" id="LN1775">1775</td><td class="line">    <span class='keyword'>int</span> statloc;</td></tr>
<tr class="codeline" data-linenumber="1776"><td class="num" id="LN1776">1776</td><td class="line">    pid_t pid;</td></tr>
<tr class="codeline" data-linenumber="1777"><td class="num" id="LN1777">1777</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1778"><td class="num" id="LN1778">1778</td><td class="line">    <span class='comment'>/* If we have a diskless rdb child (note that we support only one concurrent</span></td></tr>
<tr class="codeline" data-linenumber="1779"><td class="num" id="LN1779">1779</td><td class="line">     <span class='comment'>* child), we want to avoid collecting it's exit status and acting on it</span></td></tr>
<tr class="codeline" data-linenumber="1780"><td class="num" id="LN1780">1780</td><td class="line">     <span class='comment'>* as long as we didn't finish to drain the pipe, since then we're at risk</span></td></tr>
<tr class="codeline" data-linenumber="1781"><td class="num" id="LN1781">1781</td><td class="line">     <span class='comment'>* of starting a new fork and a new pipe before we're done with the previous</span></td></tr>
<tr class="codeline" data-linenumber="1782"><td class="num" id="LN1782">1782</td><td class="line">     <span class='comment'>* one. */</span></td></tr>
<tr class="codeline" data-linenumber="1783"><td class="num" id="LN1783">1783</td><td class="line">    <span class='keyword'>if</span> (server.rdb_child_pid != -1 &amp;&amp; server.rdb_pipe_conns)</td></tr>
<tr class="codeline" data-linenumber="1784"><td class="num" id="LN1784">1784</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1785"><td class="num" id="LN1785">1785</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1786"><td class="num" id="LN1786">1786</td><td class="line">    <span class='keyword'>if</span> ((pid = wait3(&amp;statloc,<span class='macro'>WNOHANG<span class='macro_popup'>1</span></span>,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)) != 0) {</td></tr>
<tr class="codeline" data-linenumber="1787"><td class="num" id="LN1787">1787</td><td class="line">        <span class='keyword'>int</span> exitcode = <span class='macro'>WEXITSTATUS(statloc)<span class='macro_popup'>(((statloc) &amp; 0xff00) &gt;&gt; 8)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1788"><td class="num" id="LN1788">1788</td><td class="line">        <span class='keyword'>int</span> bysignal = 0;</td></tr>
<tr class="codeline" data-linenumber="1789"><td class="num" id="LN1789">1789</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1790"><td class="num" id="LN1790">1790</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>WIFSIGNALED(statloc)<span class='macro_popup'>(((signed char) (((statloc) &amp; 0x7f) + 1) &gt;&gt; 1) &gt;<br> 0)</span></span>) bysignal = <span class='macro'>WTERMSIG(statloc)<span class='macro_popup'>((statloc) &amp; 0x7f)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1791"><td class="num" id="LN1791">1791</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1792"><td class="num" id="LN1792">1792</td><td class="line">        <span class='comment'>/* sigKillChildHandler catches the signal and calls exit(), but we</span></td></tr>
<tr class="codeline" data-linenumber="1793"><td class="num" id="LN1793">1793</td><td class="line">         <span class='comment'>* must make sure not to flag lastbgsave_status, etc incorrectly.</span></td></tr>
<tr class="codeline" data-linenumber="1794"><td class="num" id="LN1794">1794</td><td class="line">         <span class='comment'>* We could directly terminate the child process via SIGUSR1</span></td></tr>
<tr class="codeline" data-linenumber="1795"><td class="num" id="LN1795">1795</td><td class="line">         <span class='comment'>* without handling it, but in this case Valgrind will log an</span></td></tr>
<tr class="codeline" data-linenumber="1796"><td class="num" id="LN1796">1796</td><td class="line">         <span class='comment'>* annoying error. */</span></td></tr>
<tr class="codeline" data-linenumber="1797"><td class="num" id="LN1797">1797</td><td class="line">        <span class='keyword'>if</span> (exitcode == <span class='macro'>SERVER_CHILD_NOERROR_RETVAL<span class='macro_popup'>255</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1798"><td class="num" id="LN1798">1798</td><td class="line">            bysignal = <span class='macro'>SIGUSR1<span class='macro_popup'>10</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1799"><td class="num" id="LN1799">1799</td><td class="line">            exitcode = 1;</td></tr>
<tr class="codeline" data-linenumber="1800"><td class="num" id="LN1800">1800</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1801"><td class="num" id="LN1801">1801</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1802"><td class="num" id="LN1802">1802</td><td class="line">        <span class='keyword'>if</span> (pid == -1) {</td></tr>
<tr class="codeline" data-linenumber="1803"><td class="num" id="LN1803">1803</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"wait3() returned an error: %s. "</span></td></tr>
<tr class="codeline" data-linenumber="1804"><td class="num" id="LN1804">1804</td><td class="line">                <span class='string_literal'>"rdb_child_pid = %d, aof_child_pid = %d, module_child_pid = %d"</span>,</td></tr>
<tr class="codeline" data-linenumber="1805"><td class="num" id="LN1805">1805</td><td class="line">                strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>),</td></tr>
<tr class="codeline" data-linenumber="1806"><td class="num" id="LN1806">1806</td><td class="line">                (<span class='keyword'>int</span>) server.rdb_child_pid,</td></tr>
<tr class="codeline" data-linenumber="1807"><td class="num" id="LN1807">1807</td><td class="line">                (<span class='keyword'>int</span>) server.aof_child_pid,</td></tr>
<tr class="codeline" data-linenumber="1808"><td class="num" id="LN1808">1808</td><td class="line">                (<span class='keyword'>int</span>) server.module_child_pid);</td></tr>
<tr class="codeline" data-linenumber="1809"><td class="num" id="LN1809">1809</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (pid == server.rdb_child_pid) {</td></tr>
<tr class="codeline" data-linenumber="1810"><td class="num" id="LN1810">1810</td><td class="line">            backgroundSaveDoneHandler(exitcode,bysignal);</td></tr>
<tr class="codeline" data-linenumber="1811"><td class="num" id="LN1811">1811</td><td class="line">            <span class='keyword'>if</span> (!bysignal &amp;&amp; exitcode == 0) receiveChildInfo();</td></tr>
<tr class="codeline" data-linenumber="1812"><td class="num" id="LN1812">1812</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (pid == server.aof_child_pid) {</td></tr>
<tr class="codeline" data-linenumber="1813"><td class="num" id="LN1813">1813</td><td class="line">            backgroundRewriteDoneHandler(exitcode,bysignal);</td></tr>
<tr class="codeline" data-linenumber="1814"><td class="num" id="LN1814">1814</td><td class="line">            <span class='keyword'>if</span> (!bysignal &amp;&amp; exitcode == 0) receiveChildInfo();</td></tr>
<tr class="codeline" data-linenumber="1815"><td class="num" id="LN1815">1815</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (pid == server.module_child_pid) {</td></tr>
<tr class="codeline" data-linenumber="1816"><td class="num" id="LN1816">1816</td><td class="line">            ModuleForkDoneHandler(exitcode,bysignal);</td></tr>
<tr class="codeline" data-linenumber="1817"><td class="num" id="LN1817">1817</td><td class="line">            <span class='keyword'>if</span> (!bysignal &amp;&amp; exitcode == 0) receiveChildInfo();</td></tr>
<tr class="codeline" data-linenumber="1818"><td class="num" id="LN1818">1818</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1819"><td class="num" id="LN1819">1819</td><td class="line">            <span class='keyword'>if</span> (!ldbRemoveChild(pid)) {</td></tr>
<tr class="codeline" data-linenumber="1820"><td class="num" id="LN1820">1820</td><td class="line">                serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1821"><td class="num" id="LN1821">1821</td><td class="line">                    <span class='string_literal'>"Warning, detected child with unmatched pid: %ld"</span>,</td></tr>
<tr class="codeline" data-linenumber="1822"><td class="num" id="LN1822">1822</td><td class="line">                    (<span class='keyword'>long</span>)pid);</td></tr>
<tr class="codeline" data-linenumber="1823"><td class="num" id="LN1823">1823</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1824"><td class="num" id="LN1824">1824</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1825"><td class="num" id="LN1825">1825</td><td class="line">        updateDictResizePolicy();</td></tr>
<tr class="codeline" data-linenumber="1826"><td class="num" id="LN1826">1826</td><td class="line">        closeChildInfoPipe();</td></tr>
<tr class="codeline" data-linenumber="1827"><td class="num" id="LN1827">1827</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1828"><td class="num" id="LN1828">1828</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1829"><td class="num" id="LN1829">1829</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1830"><td class="num" id="LN1830">1830</td><td class="line"><span class='comment'>/* This is our timer interrupt, called server.hz times per second.</span></td></tr>
<tr class="codeline" data-linenumber="1831"><td class="num" id="LN1831">1831</td><td class="line"> <span class='comment'>* Here is where we do a number of things that need to be done asynchronously.</span></td></tr>
<tr class="codeline" data-linenumber="1832"><td class="num" id="LN1832">1832</td><td class="line"> <span class='comment'>* For instance:</span></td></tr>
<tr class="codeline" data-linenumber="1833"><td class="num" id="LN1833">1833</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1834"><td class="num" id="LN1834">1834</td><td class="line"> <span class='comment'>* - Active expired keys collection (it is also performed in a lazy way on</span></td></tr>
<tr class="codeline" data-linenumber="1835"><td class="num" id="LN1835">1835</td><td class="line"> <span class='comment'>*   lookup).</span></td></tr>
<tr class="codeline" data-linenumber="1836"><td class="num" id="LN1836">1836</td><td class="line"> <span class='comment'>* - Software watchdog.</span></td></tr>
<tr class="codeline" data-linenumber="1837"><td class="num" id="LN1837">1837</td><td class="line"> <span class='comment'>* - Update some statistic.</span></td></tr>
<tr class="codeline" data-linenumber="1838"><td class="num" id="LN1838">1838</td><td class="line"> <span class='comment'>* - Incremental rehashing of the DBs hash tables.</span></td></tr>
<tr class="codeline" data-linenumber="1839"><td class="num" id="LN1839">1839</td><td class="line"> <span class='comment'>* - Triggering BGSAVE / AOF rewrite, and handling of terminated children.</span></td></tr>
<tr class="codeline" data-linenumber="1840"><td class="num" id="LN1840">1840</td><td class="line"> <span class='comment'>* - Clients timeout of different kinds.</span></td></tr>
<tr class="codeline" data-linenumber="1841"><td class="num" id="LN1841">1841</td><td class="line"> <span class='comment'>* - Replication reconnection.</span></td></tr>
<tr class="codeline" data-linenumber="1842"><td class="num" id="LN1842">1842</td><td class="line"> <span class='comment'>* - Many more...</span></td></tr>
<tr class="codeline" data-linenumber="1843"><td class="num" id="LN1843">1843</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1844"><td class="num" id="LN1844">1844</td><td class="line"> <span class='comment'>* Everything directly called here will be called server.hz times per second,</span></td></tr>
<tr class="codeline" data-linenumber="1845"><td class="num" id="LN1845">1845</td><td class="line"> <span class='comment'>* so in order to throttle execution of things we want to do less frequently</span></td></tr>
<tr class="codeline" data-linenumber="1846"><td class="num" id="LN1846">1846</td><td class="line"> <span class='comment'>* a macro is used: run_with_period(milliseconds) { .... }</span></td></tr>
<tr class="codeline" data-linenumber="1847"><td class="num" id="LN1847">1847</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1848"><td class="num" id="LN1848">1848</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1849"><td class="num" id="LN1849">1849</td><td class="line"><span class='keyword'>int</span> serverCron(<span class='keyword'>struct</span> aeEventLoop *eventLoop, <span class='keyword'>long</span> <span class='keyword'>long</span> id, <span class='keyword'>void</span> *clientData) {</td></tr>
<tr class="codeline" data-linenumber="1850"><td class="num" id="LN1850">1850</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="1851"><td class="num" id="LN1851">1851</td><td class="line">    <span class='macro'>UNUSED(eventLoop)<span class='macro_popup'>((void) eventLoop)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1852"><td class="num" id="LN1852">1852</td><td class="line">    <span class='macro'>UNUSED(id)<span class='macro_popup'>((void) id)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1853"><td class="num" id="LN1853">1853</td><td class="line">    <span class='macro'>UNUSED(clientData)<span class='macro_popup'>((void) clientData)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1854"><td class="num" id="LN1854">1854</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1855"><td class="num" id="LN1855">1855</td><td class="line">    <span class='comment'>/* Software watchdog: deliver the SIGALRM that will reach the signal</span></td></tr>
<tr class="codeline" data-linenumber="1856"><td class="num" id="LN1856">1856</td><td class="line">     <span class='comment'>* handler if we don't return here fast enough. */</span></td></tr>
<tr class="codeline" data-linenumber="1857"><td class="num" id="LN1857">1857</td><td class="line">    <span class='keyword'>if</span> (server.watchdog_period) watchdogScheduleSignal(server.watchdog_period);</td></tr>
<tr class="codeline" data-linenumber="1858"><td class="num" id="LN1858">1858</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1859"><td class="num" id="LN1859">1859</td><td class="line">    <span class='comment'>/* Update the time cache. */</span></td></tr>
<tr class="codeline" data-linenumber="1860"><td class="num" id="LN1860">1860</td><td class="line">    updateCachedTime(1);</td></tr>
<tr class="codeline" data-linenumber="1861"><td class="num" id="LN1861">1861</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1862"><td class="num" id="LN1862">1862</td><td class="line">    server.hz = server.config_hz;</td></tr>
<tr class="codeline" data-linenumber="1863"><td class="num" id="LN1863">1863</td><td class="line">    <span class='comment'>/* Adapt the server.hz value to the number of configured clients. If we have</span></td></tr>
<tr class="codeline" data-linenumber="1864"><td class="num" id="LN1864">1864</td><td class="line">     <span class='comment'>* many clients, we want to call serverCron() with an higher frequency. */</span></td></tr>
<tr class="codeline" data-linenumber="1865"><td class="num" id="LN1865">1865</td><td class="line">    <span class='keyword'>if</span> (server.dynamic_hz) {</td></tr>
<tr class="codeline" data-linenumber="1866"><td class="num" id="LN1866">1866</td><td class="line">        <span class='keyword'>while</span> (<span class='macro'>listLength(server.clients)<span class='macro_popup'>((server.clients)-&gt;len)</span></span> / server.hz &gt;</td></tr>
<tr class="codeline" data-linenumber="1867"><td class="num" id="LN1867">1867</td><td class="line">               <span class='macro'>MAX_CLIENTS_PER_CLOCK_TICK<span class='macro_popup'>200</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1868"><td class="num" id="LN1868">1868</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="1869"><td class="num" id="LN1869">1869</td><td class="line">            server.hz *= 2;</td></tr>
<tr class="codeline" data-linenumber="1870"><td class="num" id="LN1870">1870</td><td class="line">            <span class='keyword'>if</span> (server.hz &gt; <span class='macro'>CONFIG_MAX_HZ<span class='macro_popup'>500</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1871"><td class="num" id="LN1871">1871</td><td class="line">                server.hz = <span class='macro'>CONFIG_MAX_HZ<span class='macro_popup'>500</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1872"><td class="num" id="LN1872">1872</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1873"><td class="num" id="LN1873">1873</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1874"><td class="num" id="LN1874">1874</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1875"><td class="num" id="LN1875">1875</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1876"><td class="num" id="LN1876">1876</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1877"><td class="num" id="LN1877">1877</td><td class="line">    <span class='macro'>run_with_period(100)<span class='macro_popup'>if ((100 &lt;= 1000/server.hz) || !(server.cronloops%((100)/(<br>1000/server.hz))))</span></span> {</td></tr>
<tr class="codeline" data-linenumber="1878"><td class="num" id="LN1878">1878</td><td class="line">        trackInstantaneousMetric(<span class='macro'>STATS_METRIC_COMMAND<span class='macro_popup'>0</span></span>,server.stat_numcommands);</td></tr>
<tr class="codeline" data-linenumber="1879"><td class="num" id="LN1879">1879</td><td class="line">        trackInstantaneousMetric(<span class='macro'>STATS_METRIC_NET_INPUT<span class='macro_popup'>1</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1880"><td class="num" id="LN1880">1880</td><td class="line">                server.stat_net_input_bytes);</td></tr>
<tr class="codeline" data-linenumber="1881"><td class="num" id="LN1881">1881</td><td class="line">        trackInstantaneousMetric(<span class='macro'>STATS_METRIC_NET_OUTPUT<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1882"><td class="num" id="LN1882">1882</td><td class="line">                server.stat_net_output_bytes);</td></tr>
<tr class="codeline" data-linenumber="1883"><td class="num" id="LN1883">1883</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1884"><td class="num" id="LN1884">1884</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1885"><td class="num" id="LN1885">1885</td><td class="line">    <span class='comment'>/* We have just LRU_BITS bits per object for LRU information.</span></td></tr>
<tr class="codeline" data-linenumber="1886"><td class="num" id="LN1886">1886</td><td class="line">     <span class='comment'>* So we use an (eventually wrapping) LRU clock.</span></td></tr>
<tr class="codeline" data-linenumber="1887"><td class="num" id="LN1887">1887</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1888"><td class="num" id="LN1888">1888</td><td class="line">     <span class='comment'>* Note that even if the counter wraps it's not a big problem,</span></td></tr>
<tr class="codeline" data-linenumber="1889"><td class="num" id="LN1889">1889</td><td class="line">     <span class='comment'>* everything will still work but some object will appear younger</span></td></tr>
<tr class="codeline" data-linenumber="1890"><td class="num" id="LN1890">1890</td><td class="line">     <span class='comment'>* to Redis. However for this to happen a given object should never be</span></td></tr>
<tr class="codeline" data-linenumber="1891"><td class="num" id="LN1891">1891</td><td class="line">     <span class='comment'>* touched for all the time needed to the counter to wrap, which is</span></td></tr>
<tr class="codeline" data-linenumber="1892"><td class="num" id="LN1892">1892</td><td class="line">     <span class='comment'>* not likely.</span></td></tr>
<tr class="codeline" data-linenumber="1893"><td class="num" id="LN1893">1893</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1894"><td class="num" id="LN1894">1894</td><td class="line">     <span class='comment'>* Note that you can change the resolution altering the</span></td></tr>
<tr class="codeline" data-linenumber="1895"><td class="num" id="LN1895">1895</td><td class="line">     <span class='comment'>* LRU_CLOCK_RESOLUTION define. */</span></td></tr>
<tr class="codeline" data-linenumber="1896"><td class="num" id="LN1896">1896</td><td class="line">    server.lruclock = getLRUClock();</td></tr>
<tr class="codeline" data-linenumber="1897"><td class="num" id="LN1897">1897</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1898"><td class="num" id="LN1898">1898</td><td class="line">    <span class='comment'>/* Record the max memory used since the server was started. */</span></td></tr>
<tr class="codeline" data-linenumber="1899"><td class="num" id="LN1899">1899</td><td class="line">    <span class='keyword'>if</span> (zmalloc_used_memory() &gt; server.stat_peak_memory)</td></tr>
<tr class="codeline" data-linenumber="1900"><td class="num" id="LN1900">1900</td><td class="line">        server.stat_peak_memory = zmalloc_used_memory();</td></tr>
<tr class="codeline" data-linenumber="1901"><td class="num" id="LN1901">1901</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1902"><td class="num" id="LN1902">1902</td><td class="line">    <span class='macro'>run_with_period(100)<span class='macro_popup'>if ((100 &lt;= 1000/server.hz) || !(server.cronloops%((100)/(<br>1000/server.hz))))</span></span> {</td></tr>
<tr class="codeline" data-linenumber="1903"><td class="num" id="LN1903">1903</td><td class="line">        <span class='comment'>/* Sample the RSS and other metrics here since this is a relatively slow call.</span></td></tr>
<tr class="codeline" data-linenumber="1904"><td class="num" id="LN1904">1904</td><td class="line">         <span class='comment'>* We must sample the zmalloc_used at the same time we take the rss, otherwise</span></td></tr>
<tr class="codeline" data-linenumber="1905"><td class="num" id="LN1905">1905</td><td class="line">         <span class='comment'>* the frag ratio calculate may be off (ratio of two samples at different times) */</span></td></tr>
<tr class="codeline" data-linenumber="1906"><td class="num" id="LN1906">1906</td><td class="line">        server.cron_malloc_stats.process_rss = zmalloc_get_rss();</td></tr>
<tr class="codeline" data-linenumber="1907"><td class="num" id="LN1907">1907</td><td class="line">        server.cron_malloc_stats.zmalloc_used = zmalloc_used_memory();</td></tr>
<tr class="codeline" data-linenumber="1908"><td class="num" id="LN1908">1908</td><td class="line">        <span class='comment'>/* Sampling the allcator info can be slow too.</span></td></tr>
<tr class="codeline" data-linenumber="1909"><td class="num" id="LN1909">1909</td><td class="line">         <span class='comment'>* The fragmentation ratio it'll show is potentically more accurate</span></td></tr>
<tr class="codeline" data-linenumber="1910"><td class="num" id="LN1910">1910</td><td class="line">         <span class='comment'>* it excludes other RSS pages such as: shared libraries, LUA and other non-zmalloc</span></td></tr>
<tr class="codeline" data-linenumber="1911"><td class="num" id="LN1911">1911</td><td class="line">         <span class='comment'>* allocations, and allocator reserved pages that can be pursed (all not actual frag) */</span></td></tr>
<tr class="codeline" data-linenumber="1912"><td class="num" id="LN1912">1912</td><td class="line">        zmalloc_get_allocator_info(&amp;server.cron_malloc_stats.allocator_allocated,</td></tr>
<tr class="codeline" data-linenumber="1913"><td class="num" id="LN1913">1913</td><td class="line">                                   &amp;server.cron_malloc_stats.allocator_active,</td></tr>
<tr class="codeline" data-linenumber="1914"><td class="num" id="LN1914">1914</td><td class="line">                                   &amp;server.cron_malloc_stats.allocator_resident);</td></tr>
<tr class="codeline" data-linenumber="1915"><td class="num" id="LN1915">1915</td><td class="line">        <span class='comment'>/* in case the allocator isn't providing these stats, fake them so that</span></td></tr>
<tr class="codeline" data-linenumber="1916"><td class="num" id="LN1916">1916</td><td class="line">         <span class='comment'>* fragmention info still shows some (inaccurate metrics) */</span></td></tr>
<tr class="codeline" data-linenumber="1917"><td class="num" id="LN1917">1917</td><td class="line">        <span class='keyword'>if</span> (!server.cron_malloc_stats.allocator_resident) {</td></tr>
<tr class="codeline" data-linenumber="1918"><td class="num" id="LN1918">1918</td><td class="line">            <span class='comment'>/* LUA memory isn't part of zmalloc_used, but it is part of the process RSS,</span></td></tr>
<tr class="codeline" data-linenumber="1919"><td class="num" id="LN1919">1919</td><td class="line">             <span class='comment'>* so we must desuct it in order to be able to calculate correct</span></td></tr>
<tr class="codeline" data-linenumber="1920"><td class="num" id="LN1920">1920</td><td class="line">             <span class='comment'>* "allocator fragmentation" ratio */</span></td></tr>
<tr class="codeline" data-linenumber="1921"><td class="num" id="LN1921">1921</td><td class="line">            size_t lua_memory = lua_gc(server.lua,<span class='macro'>LUA_GCCOUNT<span class='macro_popup'>3</span></span>,0)*1024LL;</td></tr>
<tr class="codeline" data-linenumber="1922"><td class="num" id="LN1922">1922</td><td class="line">            server.cron_malloc_stats.allocator_resident = server.cron_malloc_stats.process_rss - lua_memory;</td></tr>
<tr class="codeline" data-linenumber="1923"><td class="num" id="LN1923">1923</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1924"><td class="num" id="LN1924">1924</td><td class="line">        <span class='keyword'>if</span> (!server.cron_malloc_stats.allocator_active)</td></tr>
<tr class="codeline" data-linenumber="1925"><td class="num" id="LN1925">1925</td><td class="line">            server.cron_malloc_stats.allocator_active = server.cron_malloc_stats.allocator_resident;</td></tr>
<tr class="codeline" data-linenumber="1926"><td class="num" id="LN1926">1926</td><td class="line">        <span class='keyword'>if</span> (!server.cron_malloc_stats.allocator_allocated)</td></tr>
<tr class="codeline" data-linenumber="1927"><td class="num" id="LN1927">1927</td><td class="line">            server.cron_malloc_stats.allocator_allocated = server.cron_malloc_stats.zmalloc_used;</td></tr>
<tr class="codeline" data-linenumber="1928"><td class="num" id="LN1928">1928</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1929"><td class="num" id="LN1929">1929</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1930"><td class="num" id="LN1930">1930</td><td class="line">    <span class='comment'>/* We received a SIGTERM, shutting down here in a safe way, as it is</span></td></tr>
<tr class="codeline" data-linenumber="1931"><td class="num" id="LN1931">1931</td><td class="line">     <span class='comment'>* not ok doing so inside the signal handler. */</span></td></tr>
<tr class="codeline" data-linenumber="1932"><td class="num" id="LN1932">1932</td><td class="line">    <span class='keyword'>if</span> (server.shutdown_asap) {</td></tr>
<tr class="codeline" data-linenumber="1933"><td class="num" id="LN1933">1933</td><td class="line">        <span class='keyword'>if</span> (prepareForShutdown(<span class='macro'>SHUTDOWN_NOFLAGS<span class='macro_popup'>0</span></span>) == <span class='macro'>C_OK<span class='macro_popup'>0</span></span>) exit(0);</td></tr>
<tr class="codeline" data-linenumber="1934"><td class="num" id="LN1934">1934</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"SIGTERM received but errors trying to shut down the server, check the logs for more information"</span>);</td></tr>
<tr class="codeline" data-linenumber="1935"><td class="num" id="LN1935">1935</td><td class="line">        server.shutdown_asap = 0;</td></tr>
<tr class="codeline" data-linenumber="1936"><td class="num" id="LN1936">1936</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1937"><td class="num" id="LN1937">1937</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1938"><td class="num" id="LN1938">1938</td><td class="line">    <span class='comment'>/* Show some info about non-empty databases */</span></td></tr>
<tr class="codeline" data-linenumber="1939"><td class="num" id="LN1939">1939</td><td class="line">    <span class='macro'>run_with_period(5000)<span class='macro_popup'>if ((5000 &lt;= 1000/server.hz) || !(server.cronloops%((5000)<br>/(1000/server.hz))))</span></span> {</td></tr>
<tr class="codeline" data-linenumber="1940"><td class="num" id="LN1940">1940</td><td class="line">        <span class='keyword'>for</span> (j = 0; j &lt; server.dbnum; j++) {</td></tr>
<tr class="codeline" data-linenumber="1941"><td class="num" id="LN1941">1941</td><td class="line">            <span class='keyword'>long</span> <span class='keyword'>long</span> size, used, vkeys;</td></tr>
<tr class="codeline" data-linenumber="1942"><td class="num" id="LN1942">1942</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1943"><td class="num" id="LN1943">1943</td><td class="line">            size = <span class='macro'>dictSlots(server.db[j].dict)<span class='macro_popup'>((server.db[j].dict)-&gt;ht[0].size+(server.db[j].dict)-&gt;ht<br>[1].size)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1944"><td class="num" id="LN1944">1944</td><td class="line">            used = <span class='macro'>dictSize(server.db[j].dict)<span class='macro_popup'>((server.db[j].dict)-&gt;ht[0].used+(server.db[j].dict)-&gt;ht<br>[1].used)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1945"><td class="num" id="LN1945">1945</td><td class="line">            vkeys = <span class='macro'>dictSize(server.db[j].expires)<span class='macro_popup'>((server.db[j].expires)-&gt;ht[0].used+(server.db[j].expires)<br>-&gt;ht[1].used)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1946"><td class="num" id="LN1946">1946</td><td class="line">            <span class='keyword'>if</span> (used || vkeys) {</td></tr>
<tr class="codeline" data-linenumber="1947"><td class="num" id="LN1947">1947</td><td class="line">                serverLog(<span class='macro'>LL_VERBOSE<span class='macro_popup'>1</span></span>,<span class='string_literal'>"DB %d: %lld keys (%lld volatile) in %lld slots HT."</span>,j,used,vkeys,size);</td></tr>
<tr class="codeline" data-linenumber="1948"><td class="num" id="LN1948">1948</td><td class="line">                <span class='comment'>/* dictPrintStats(server.dict); */</span></td></tr>
<tr class="codeline" data-linenumber="1949"><td class="num" id="LN1949">1949</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1950"><td class="num" id="LN1950">1950</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1951"><td class="num" id="LN1951">1951</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1952"><td class="num" id="LN1952">1952</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1953"><td class="num" id="LN1953">1953</td><td class="line">    <span class='comment'>/* Show information about connected clients */</span></td></tr>
<tr class="codeline" data-linenumber="1954"><td class="num" id="LN1954">1954</td><td class="line">    <span class='keyword'>if</span> (!server.sentinel_mode) {</td></tr>
<tr class="codeline" data-linenumber="1955"><td class="num" id="LN1955">1955</td><td class="line">        <span class='macro'>run_with_period(5000)<span class='macro_popup'>if ((5000 &lt;= 1000/server.hz) || !(server.cronloops%((5000)<br>/(1000/server.hz))))</span></span> {</td></tr>
<tr class="codeline" data-linenumber="1956"><td class="num" id="LN1956">1956</td><td class="line">            serverLog(<span class='macro'>LL_DEBUG<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1957"><td class="num" id="LN1957">1957</td><td class="line">                <span class='string_literal'>"%lu clients connected (%lu replicas), %zu bytes in use"</span>,</td></tr>
<tr class="codeline" data-linenumber="1958"><td class="num" id="LN1958">1958</td><td class="line">                <span class='macro'>listLength(server.clients)<span class='macro_popup'>((server.clients)-&gt;len)</span></span>-<span class='macro'>listLength(server.slaves)<span class='macro_popup'>((server.slaves)-&gt;len)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1959"><td class="num" id="LN1959">1959</td><td class="line">                <span class='macro'>listLength(server.slaves)<span class='macro_popup'>((server.slaves)-&gt;len)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1960"><td class="num" id="LN1960">1960</td><td class="line">                zmalloc_used_memory());</td></tr>
<tr class="codeline" data-linenumber="1961"><td class="num" id="LN1961">1961</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1962"><td class="num" id="LN1962">1962</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1963"><td class="num" id="LN1963">1963</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1964"><td class="num" id="LN1964">1964</td><td class="line">    <span class='comment'>/* We need to do a few operations on clients asynchronously. */</span></td></tr>
<tr class="codeline" data-linenumber="1965"><td class="num" id="LN1965">1965</td><td class="line">    clientsCron();</td></tr>
<tr class="codeline" data-linenumber="1966"><td class="num" id="LN1966">1966</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1967"><td class="num" id="LN1967">1967</td><td class="line">    <span class='comment'>/* Handle background operations on Redis databases. */</span></td></tr>
<tr class="codeline" data-linenumber="1968"><td class="num" id="LN1968">1968</td><td class="line">    databasesCron();</td></tr>
<tr class="codeline" data-linenumber="1969"><td class="num" id="LN1969">1969</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1970"><td class="num" id="LN1970">1970</td><td class="line">    <span class='comment'>/* Start a scheduled AOF rewrite if this was requested by the user while</span></td></tr>
<tr class="codeline" data-linenumber="1971"><td class="num" id="LN1971">1971</td><td class="line">     <span class='comment'>* a BGSAVE was in progress. */</span></td></tr>
<tr class="codeline" data-linenumber="1972"><td class="num" id="LN1972">1972</td><td class="line">    <span class='keyword'>if</span> (!hasActiveChildProcess() &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1973"><td class="num" id="LN1973">1973</td><td class="line">        server.aof_rewrite_scheduled)</td></tr>
<tr class="codeline" data-linenumber="1974"><td class="num" id="LN1974">1974</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1975"><td class="num" id="LN1975">1975</td><td class="line">        rewriteAppendOnlyFileBackground();</td></tr>
<tr class="codeline" data-linenumber="1976"><td class="num" id="LN1976">1976</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1977"><td class="num" id="LN1977">1977</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1978"><td class="num" id="LN1978">1978</td><td class="line">    <span class='comment'>/* Check if a background saving or AOF rewrite in progress terminated. */</span></td></tr>
<tr class="codeline" data-linenumber="1979"><td class="num" id="LN1979">1979</td><td class="line">    <span class='keyword'>if</span> (hasActiveChildProcess() || ldbPendingChildren())</td></tr>
<tr class="codeline" data-linenumber="1980"><td class="num" id="LN1980">1980</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1981"><td class="num" id="LN1981">1981</td><td class="line">        checkChildrenDone();</td></tr>
<tr class="codeline" data-linenumber="1982"><td class="num" id="LN1982">1982</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1983"><td class="num" id="LN1983">1983</td><td class="line">        <span class='comment'>/* If there is not a background saving/rewrite in progress check if</span></td></tr>
<tr class="codeline" data-linenumber="1984"><td class="num" id="LN1984">1984</td><td class="line">         <span class='comment'>* we have to save/rewrite now. */</span></td></tr>
<tr class="codeline" data-linenumber="1985"><td class="num" id="LN1985">1985</td><td class="line">        <span class='keyword'>for</span> (j = 0; j &lt; server.saveparamslen; j++) {</td></tr>
<tr class="codeline" data-linenumber="1986"><td class="num" id="LN1986">1986</td><td class="line">            <span class='keyword'>struct</span> saveparam *sp = server.saveparams+j;</td></tr>
<tr class="codeline" data-linenumber="1987"><td class="num" id="LN1987">1987</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1988"><td class="num" id="LN1988">1988</td><td class="line">            <span class='comment'>/* Save if we reached the given amount of changes,</span></td></tr>
<tr class="codeline" data-linenumber="1989"><td class="num" id="LN1989">1989</td><td class="line">             <span class='comment'>* the given amount of seconds, and if the latest bgsave was</span></td></tr>
<tr class="codeline" data-linenumber="1990"><td class="num" id="LN1990">1990</td><td class="line">             <span class='comment'>* successful or if, in case of an error, at least</span></td></tr>
<tr class="codeline" data-linenumber="1991"><td class="num" id="LN1991">1991</td><td class="line">             <span class='comment'>* CONFIG_BGSAVE_RETRY_DELAY seconds already elapsed. */</span></td></tr>
<tr class="codeline" data-linenumber="1992"><td class="num" id="LN1992">1992</td><td class="line">            <span class='keyword'>if</span> (server.dirty &gt;= sp-&gt;changes &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1993"><td class="num" id="LN1993">1993</td><td class="line">                server.unixtime-server.lastsave &gt; sp-&gt;seconds &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1994"><td class="num" id="LN1994">1994</td><td class="line">                (server.unixtime-server.lastbgsave_try &gt;</td></tr>
<tr class="codeline" data-linenumber="1995"><td class="num" id="LN1995">1995</td><td class="line">                 <span class='macro'>CONFIG_BGSAVE_RETRY_DELAY<span class='macro_popup'>5</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="1996"><td class="num" id="LN1996">1996</td><td class="line">                 server.lastbgsave_status == <span class='macro'>C_OK<span class='macro_popup'>0</span></span>))</td></tr>
<tr class="codeline" data-linenumber="1997"><td class="num" id="LN1997">1997</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="1998"><td class="num" id="LN1998">1998</td><td class="line">                serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"%d changes in %d seconds. Saving..."</span>,</td></tr>
<tr class="codeline" data-linenumber="1999"><td class="num" id="LN1999">1999</td><td class="line">                    sp-&gt;changes, (<span class='keyword'>int</span>)sp-&gt;seconds);</td></tr>
<tr class="codeline" data-linenumber="2000"><td class="num" id="LN2000">2000</td><td class="line">                rdbSaveInfo rsi, *rsiptr;</td></tr>
<tr class="codeline" data-linenumber="2001"><td class="num" id="LN2001">2001</td><td class="line">                rsiptr = rdbPopulateSaveInfo(&amp;rsi);</td></tr>
<tr class="codeline" data-linenumber="2002"><td class="num" id="LN2002">2002</td><td class="line">                rdbSaveBackground(server.rdb_filename,rsiptr);</td></tr>
<tr class="codeline" data-linenumber="2003"><td class="num" id="LN2003">2003</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2004"><td class="num" id="LN2004">2004</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2005"><td class="num" id="LN2005">2005</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2006"><td class="num" id="LN2006">2006</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2007"><td class="num" id="LN2007">2007</td><td class="line">        <span class='comment'>/* Trigger an AOF rewrite if needed. */</span></td></tr>
<tr class="codeline" data-linenumber="2008"><td class="num" id="LN2008">2008</td><td class="line">        <span class='keyword'>if</span> (server.aof_state == <span class='macro'>AOF_ON<span class='macro_popup'>1</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2009"><td class="num" id="LN2009">2009</td><td class="line">            !hasActiveChildProcess() &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2010"><td class="num" id="LN2010">2010</td><td class="line">            server.aof_rewrite_perc &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2011"><td class="num" id="LN2011">2011</td><td class="line">            server.aof_current_size &gt; server.aof_rewrite_min_size)</td></tr>
<tr class="codeline" data-linenumber="2012"><td class="num" id="LN2012">2012</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="2013"><td class="num" id="LN2013">2013</td><td class="line">            <span class='keyword'>long</span> <span class='keyword'>long</span> base = server.aof_rewrite_base_size ?</td></tr>
<tr class="codeline" data-linenumber="2014"><td class="num" id="LN2014">2014</td><td class="line">                server.aof_rewrite_base_size : 1;</td></tr>
<tr class="codeline" data-linenumber="2015"><td class="num" id="LN2015">2015</td><td class="line">            <span class='keyword'>long</span> <span class='keyword'>long</span> growth = (server.aof_current_size*100/base) - 100;</td></tr>
<tr class="codeline" data-linenumber="2016"><td class="num" id="LN2016">2016</td><td class="line">            <span class='keyword'>if</span> (growth &gt;= server.aof_rewrite_perc) {</td></tr>
<tr class="codeline" data-linenumber="2017"><td class="num" id="LN2017">2017</td><td class="line">                serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Starting automatic rewriting of AOF on %lld%% growth"</span>,growth);</td></tr>
<tr class="codeline" data-linenumber="2018"><td class="num" id="LN2018">2018</td><td class="line">                rewriteAppendOnlyFileBackground();</td></tr>
<tr class="codeline" data-linenumber="2019"><td class="num" id="LN2019">2019</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2020"><td class="num" id="LN2020">2020</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2021"><td class="num" id="LN2021">2021</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2022"><td class="num" id="LN2022">2022</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2023"><td class="num" id="LN2023">2023</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2024"><td class="num" id="LN2024">2024</td><td class="line">    <span class='comment'>/* AOF postponed flush: Try at every cron cycle if the slow fsync</span></td></tr>
<tr class="codeline" data-linenumber="2025"><td class="num" id="LN2025">2025</td><td class="line">     <span class='comment'>* completed. */</span></td></tr>
<tr class="codeline" data-linenumber="2026"><td class="num" id="LN2026">2026</td><td class="line">    <span class='keyword'>if</span> (server.aof_flush_postponed_start) flushAppendOnlyFile(0);</td></tr>
<tr class="codeline" data-linenumber="2027"><td class="num" id="LN2027">2027</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2028"><td class="num" id="LN2028">2028</td><td class="line">    <span class='comment'>/* AOF write errors: in this case we have a buffer to flush as well and</span></td></tr>
<tr class="codeline" data-linenumber="2029"><td class="num" id="LN2029">2029</td><td class="line">     <span class='comment'>* clear the AOF error in case of success to make the DB writable again,</span></td></tr>
<tr class="codeline" data-linenumber="2030"><td class="num" id="LN2030">2030</td><td class="line">     <span class='comment'>* however to try every second is enough in case of 'hz' is set to</span></td></tr>
<tr class="codeline" data-linenumber="2031"><td class="num" id="LN2031">2031</td><td class="line">     <span class='comment'>* a higher frequency. */</span></td></tr>
<tr class="codeline" data-linenumber="2032"><td class="num" id="LN2032">2032</td><td class="line">    <span class='macro'>run_with_period(1000)<span class='macro_popup'>if ((1000 &lt;= 1000/server.hz) || !(server.cronloops%((1000)<br>/(1000/server.hz))))</span></span> {</td></tr>
<tr class="codeline" data-linenumber="2033"><td class="num" id="LN2033">2033</td><td class="line">        <span class='keyword'>if</span> (server.aof_last_write_status == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2034"><td class="num" id="LN2034">2034</td><td class="line">            flushAppendOnlyFile(0);</td></tr>
<tr class="codeline" data-linenumber="2035"><td class="num" id="LN2035">2035</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2036"><td class="num" id="LN2036">2036</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2037"><td class="num" id="LN2037">2037</td><td class="line">    <span class='comment'>/* Clear the paused clients flag if needed. */</span></td></tr>
<tr class="codeline" data-linenumber="2038"><td class="num" id="LN2038">2038</td><td class="line">    clientsArePaused(); <span class='comment'>/* Don't check return value, just use the side effect.*/</span></td></tr>
<tr class="codeline" data-linenumber="2039"><td class="num" id="LN2039">2039</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2040"><td class="num" id="LN2040">2040</td><td class="line">    <span class='comment'>/* Replication cron function -- used to reconnect to master,</span></td></tr>
<tr class="codeline" data-linenumber="2041"><td class="num" id="LN2041">2041</td><td class="line">     <span class='comment'>* detect transfer failures, start background RDB transfers and so forth. */</span></td></tr>
<tr class="codeline" data-linenumber="2042"><td class="num" id="LN2042">2042</td><td class="line">    <span class='macro'>run_with_period(1000)<span class='macro_popup'>if ((1000 &lt;= 1000/server.hz) || !(server.cronloops%((1000)<br>/(1000/server.hz))))</span></span> replicationCron();</td></tr>
<tr class="codeline" data-linenumber="2043"><td class="num" id="LN2043">2043</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2044"><td class="num" id="LN2044">2044</td><td class="line">    <span class='comment'>/* Run the Redis Cluster cron. */</span></td></tr>
<tr class="codeline" data-linenumber="2045"><td class="num" id="LN2045">2045</td><td class="line">    <span class='macro'>run_with_period(100)<span class='macro_popup'>if ((100 &lt;= 1000/server.hz) || !(server.cronloops%((100)/(<br>1000/server.hz))))</span></span> {</td></tr>
<tr class="codeline" data-linenumber="2046"><td class="num" id="LN2046">2046</td><td class="line">        <span class='keyword'>if</span> (server.cluster_enabled) clusterCron();</td></tr>
<tr class="codeline" data-linenumber="2047"><td class="num" id="LN2047">2047</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2048"><td class="num" id="LN2048">2048</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2049"><td class="num" id="LN2049">2049</td><td class="line">    <span class='comment'>/* Run the Sentinel timer if we are in sentinel mode. */</span></td></tr>
<tr class="codeline" data-linenumber="2050"><td class="num" id="LN2050">2050</td><td class="line">    <span class='keyword'>if</span> (server.sentinel_mode) sentinelTimer();</td></tr>
<tr class="codeline" data-linenumber="2051"><td class="num" id="LN2051">2051</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2052"><td class="num" id="LN2052">2052</td><td class="line">    <span class='comment'>/* Cleanup expired MIGRATE cached sockets. */</span></td></tr>
<tr class="codeline" data-linenumber="2053"><td class="num" id="LN2053">2053</td><td class="line">    <span class='macro'>run_with_period(1000)<span class='macro_popup'>if ((1000 &lt;= 1000/server.hz) || !(server.cronloops%((1000)<br>/(1000/server.hz))))</span></span> {</td></tr>
<tr class="codeline" data-linenumber="2054"><td class="num" id="LN2054">2054</td><td class="line">        migrateCloseTimedoutSockets();</td></tr>
<tr class="codeline" data-linenumber="2055"><td class="num" id="LN2055">2055</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2056"><td class="num" id="LN2056">2056</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2057"><td class="num" id="LN2057">2057</td><td class="line">    <span class='comment'>/* Stop the I/O threads if we don't have enough pending work. */</span></td></tr>
<tr class="codeline" data-linenumber="2058"><td class="num" id="LN2058">2058</td><td class="line">    stopThreadedIOIfNeeded();</td></tr>
<tr class="codeline" data-linenumber="2059"><td class="num" id="LN2059">2059</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2060"><td class="num" id="LN2060">2060</td><td class="line">    <span class='comment'>/* Resize tracking keys table if needed. This is also done at every</span></td></tr>
<tr class="codeline" data-linenumber="2061"><td class="num" id="LN2061">2061</td><td class="line">     <span class='comment'>* command execution, but we want to be sure that if the last command</span></td></tr>
<tr class="codeline" data-linenumber="2062"><td class="num" id="LN2062">2062</td><td class="line">     <span class='comment'>* executed changes the value via CONFIG SET, the server will perform</span></td></tr>
<tr class="codeline" data-linenumber="2063"><td class="num" id="LN2063">2063</td><td class="line">     <span class='comment'>* the operation even if completely idle. */</span></td></tr>
<tr class="codeline" data-linenumber="2064"><td class="num" id="LN2064">2064</td><td class="line">    <span class='keyword'>if</span> (server.tracking_clients) trackingLimitUsedSlots();</td></tr>
<tr class="codeline" data-linenumber="2065"><td class="num" id="LN2065">2065</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2066"><td class="num" id="LN2066">2066</td><td class="line">    <span class='comment'>/* Start a scheduled BGSAVE if the corresponding flag is set. This is</span></td></tr>
<tr class="codeline" data-linenumber="2067"><td class="num" id="LN2067">2067</td><td class="line">     <span class='comment'>* useful when we are forced to postpone a BGSAVE because an AOF</span></td></tr>
<tr class="codeline" data-linenumber="2068"><td class="num" id="LN2068">2068</td><td class="line">     <span class='comment'>* rewrite is in progress.</span></td></tr>
<tr class="codeline" data-linenumber="2069"><td class="num" id="LN2069">2069</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2070"><td class="num" id="LN2070">2070</td><td class="line">     <span class='comment'>* Note: this code must be after the replicationCron() call above so</span></td></tr>
<tr class="codeline" data-linenumber="2071"><td class="num" id="LN2071">2071</td><td class="line">     <span class='comment'>* make sure when refactoring this file to keep this order. This is useful</span></td></tr>
<tr class="codeline" data-linenumber="2072"><td class="num" id="LN2072">2072</td><td class="line">     <span class='comment'>* because we want to give priority to RDB savings for replication. */</span></td></tr>
<tr class="codeline" data-linenumber="2073"><td class="num" id="LN2073">2073</td><td class="line">    <span class='keyword'>if</span> (!hasActiveChildProcess() &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2074"><td class="num" id="LN2074">2074</td><td class="line">        server.rdb_bgsave_scheduled &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2075"><td class="num" id="LN2075">2075</td><td class="line">        (server.unixtime-server.lastbgsave_try &gt; <span class='macro'>CONFIG_BGSAVE_RETRY_DELAY<span class='macro_popup'>5</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="2076"><td class="num" id="LN2076">2076</td><td class="line">         server.lastbgsave_status == <span class='macro'>C_OK<span class='macro_popup'>0</span></span>))</td></tr>
<tr class="codeline" data-linenumber="2077"><td class="num" id="LN2077">2077</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2078"><td class="num" id="LN2078">2078</td><td class="line">        rdbSaveInfo rsi, *rsiptr;</td></tr>
<tr class="codeline" data-linenumber="2079"><td class="num" id="LN2079">2079</td><td class="line">        rsiptr = rdbPopulateSaveInfo(&amp;rsi);</td></tr>
<tr class="codeline" data-linenumber="2080"><td class="num" id="LN2080">2080</td><td class="line">        <span class='keyword'>if</span> (rdbSaveBackground(server.rdb_filename,rsiptr) == <span class='macro'>C_OK<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2081"><td class="num" id="LN2081">2081</td><td class="line">            server.rdb_bgsave_scheduled = 0;</td></tr>
<tr class="codeline" data-linenumber="2082"><td class="num" id="LN2082">2082</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2083"><td class="num" id="LN2083">2083</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2084"><td class="num" id="LN2084">2084</td><td class="line">    <span class='comment'>/* Fire the cron loop modules event. */</span></td></tr>
<tr class="codeline" data-linenumber="2085"><td class="num" id="LN2085">2085</td><td class="line">    RedisModuleCronLoopV1 ei = {<span class='macro'>REDISMODULE_CRON_LOOP_VERSION<span class='macro_popup'>1</span></span>,server.hz};</td></tr>
<tr class="codeline" data-linenumber="2086"><td class="num" id="LN2086">2086</td><td class="line">    moduleFireServerEvent(<span class='macro'>REDISMODULE_EVENT_CRON_LOOP<span class='macro_popup'>8</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2087"><td class="num" id="LN2087">2087</td><td class="line">                          0,</td></tr>
<tr class="codeline" data-linenumber="2088"><td class="num" id="LN2088">2088</td><td class="line">                          &amp;ei);</td></tr>
<tr class="codeline" data-linenumber="2089"><td class="num" id="LN2089">2089</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2090"><td class="num" id="LN2090">2090</td><td class="line">    server.cronloops++;</td></tr>
<tr class="codeline" data-linenumber="2091"><td class="num" id="LN2091">2091</td><td class="line">    <span class='keyword'>return</span> 1000/server.hz;</td></tr>
<tr class="codeline" data-linenumber="2092"><td class="num" id="LN2092">2092</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2093"><td class="num" id="LN2093">2093</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2094"><td class="num" id="LN2094">2094</td><td class="line"><span class='keyword'>extern</span> <span class='keyword'>int</span> ProcessingEventsWhileBlocked;</td></tr>
<tr class="codeline" data-linenumber="2095"><td class="num" id="LN2095">2095</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2096"><td class="num" id="LN2096">2096</td><td class="line"><span class='comment'>/* This function gets called every time Redis is entering the</span></td></tr>
<tr class="codeline" data-linenumber="2097"><td class="num" id="LN2097">2097</td><td class="line"> <span class='comment'>* main loop of the event driven library, that is, before to sleep</span></td></tr>
<tr class="codeline" data-linenumber="2098"><td class="num" id="LN2098">2098</td><td class="line"> <span class='comment'>* for ready file descriptors.</span></td></tr>
<tr class="codeline" data-linenumber="2099"><td class="num" id="LN2099">2099</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2100"><td class="num" id="LN2100">2100</td><td class="line"> <span class='comment'>* Note: This function is (currently) called from two functions:</span></td></tr>
<tr class="codeline" data-linenumber="2101"><td class="num" id="LN2101">2101</td><td class="line"> <span class='comment'>* 1. aeMain - The main server loop</span></td></tr>
<tr class="codeline" data-linenumber="2102"><td class="num" id="LN2102">2102</td><td class="line"> <span class='comment'>* 2. processEventsWhileBlocked - Process clients during RDB/AOF load</span></td></tr>
<tr class="codeline" data-linenumber="2103"><td class="num" id="LN2103">2103</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2104"><td class="num" id="LN2104">2104</td><td class="line"> <span class='comment'>* If it was called from processEventsWhileBlocked we don't want</span></td></tr>
<tr class="codeline" data-linenumber="2105"><td class="num" id="LN2105">2105</td><td class="line"> <span class='comment'>* to perform all actions (For example, we don't want to expire</span></td></tr>
<tr class="codeline" data-linenumber="2106"><td class="num" id="LN2106">2106</td><td class="line"> <span class='comment'>* keys), but we do need to perform some actions.</span></td></tr>
<tr class="codeline" data-linenumber="2107"><td class="num" id="LN2107">2107</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2108"><td class="num" id="LN2108">2108</td><td class="line"> <span class='comment'>* The most important is freeClientsInAsyncFreeQueue but we also</span></td></tr>
<tr class="codeline" data-linenumber="2109"><td class="num" id="LN2109">2109</td><td class="line"> <span class='comment'>* call some other low-risk functions. */</span></td></tr>
<tr class="codeline" data-linenumber="2110"><td class="num" id="LN2110">2110</td><td class="line"><span class='keyword'>void</span> beforeSleep(<span class='keyword'>struct</span> aeEventLoop *eventLoop) {</td></tr>
<tr class="codeline" data-linenumber="2111"><td class="num" id="LN2111">2111</td><td class="line">    <span class='macro'>UNUSED(eventLoop)<span class='macro_popup'>((void) eventLoop)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2112"><td class="num" id="LN2112">2112</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2113"><td class="num" id="LN2113">2113</td><td class="line">    size_t zmalloc_used = zmalloc_used_memory();</td></tr>
<tr class="codeline" data-linenumber="2114"><td class="num" id="LN2114">2114</td><td class="line">    <span class='keyword'>if</span> (zmalloc_used &gt; server.stat_peak_memory)</td></tr>
<tr class="codeline" data-linenumber="2115"><td class="num" id="LN2115">2115</td><td class="line">        server.stat_peak_memory = zmalloc_used;</td></tr>
<tr class="codeline" data-linenumber="2116"><td class="num" id="LN2116">2116</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2117"><td class="num" id="LN2117">2117</td><td class="line">    <span class='comment'>/* Just call a subset of vital functions in case we are re-entering</span></td></tr>
<tr class="codeline" data-linenumber="2118"><td class="num" id="LN2118">2118</td><td class="line">     <span class='comment'>* the event loop from processEventsWhileBlocked(). Note that in this</span></td></tr>
<tr class="codeline" data-linenumber="2119"><td class="num" id="LN2119">2119</td><td class="line">     <span class='comment'>* case we keep track of the number of events we are processing, since</span></td></tr>
<tr class="codeline" data-linenumber="2120"><td class="num" id="LN2120">2120</td><td class="line">     <span class='comment'>* processEventsWhileBlocked() wants to stop ASAP if there are no longer</span></td></tr>
<tr class="codeline" data-linenumber="2121"><td class="num" id="LN2121">2121</td><td class="line">     <span class='comment'>* events to handle. */</span></td></tr>
<tr class="codeline" data-linenumber="2122"><td class="num" id="LN2122">2122</td><td class="line">    <span class='keyword'>if</span> (ProcessingEventsWhileBlocked) {</td></tr>
<tr class="codeline" data-linenumber="2123"><td class="num" id="LN2123">2123</td><td class="line">        uint64_t processed = 0;</td></tr>
<tr class="codeline" data-linenumber="2124"><td class="num" id="LN2124">2124</td><td class="line">        processed += handleClientsWithPendingReadsUsingThreads();</td></tr>
<tr class="codeline" data-linenumber="2125"><td class="num" id="LN2125">2125</td><td class="line">        processed += tlsProcessPendingData();</td></tr>
<tr class="codeline" data-linenumber="2126"><td class="num" id="LN2126">2126</td><td class="line">        processed += handleClientsWithPendingWrites();</td></tr>
<tr class="codeline" data-linenumber="2127"><td class="num" id="LN2127">2127</td><td class="line">        processed += freeClientsInAsyncFreeQueue();</td></tr>
<tr class="codeline" data-linenumber="2128"><td class="num" id="LN2128">2128</td><td class="line">        server.events_processed_while_blocked += processed;</td></tr>
<tr class="codeline" data-linenumber="2129"><td class="num" id="LN2129">2129</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2130"><td class="num" id="LN2130">2130</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2131"><td class="num" id="LN2131">2131</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2132"><td class="num" id="LN2132">2132</td><td class="line">    <span class='comment'>/* Handle precise timeouts of blocked clients. */</span></td></tr>
<tr class="codeline" data-linenumber="2133"><td class="num" id="LN2133">2133</td><td class="line">    handleBlockedClientsTimeout();</td></tr>
<tr class="codeline" data-linenumber="2134"><td class="num" id="LN2134">2134</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2135"><td class="num" id="LN2135">2135</td><td class="line">    <span class='comment'>/* We should handle pending reads clients ASAP after event loop. */</span></td></tr>
<tr class="codeline" data-linenumber="2136"><td class="num" id="LN2136">2136</td><td class="line">    handleClientsWithPendingReadsUsingThreads();</td></tr>
<tr class="codeline" data-linenumber="2137"><td class="num" id="LN2137">2137</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2138"><td class="num" id="LN2138">2138</td><td class="line">    <span class='comment'>/* Handle TLS pending data. (must be done before flushAppendOnlyFile) */</span></td></tr>
<tr class="codeline" data-linenumber="2139"><td class="num" id="LN2139">2139</td><td class="line">    tlsProcessPendingData();</td></tr>
<tr class="codeline" data-linenumber="2140"><td class="num" id="LN2140">2140</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2141"><td class="num" id="LN2141">2141</td><td class="line">    <span class='comment'>/* If tls still has pending unread data don't sleep at all. */</span></td></tr>
<tr class="codeline" data-linenumber="2142"><td class="num" id="LN2142">2142</td><td class="line">    aeSetDontWait(server.el, tlsHasPendingData());</td></tr>
<tr class="codeline" data-linenumber="2143"><td class="num" id="LN2143">2143</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2144"><td class="num" id="LN2144">2144</td><td class="line">    <span class='comment'>/* Call the Redis Cluster before sleep function. Note that this function</span></td></tr>
<tr class="codeline" data-linenumber="2145"><td class="num" id="LN2145">2145</td><td class="line">     <span class='comment'>* may change the state of Redis Cluster (from ok to fail or vice versa),</span></td></tr>
<tr class="codeline" data-linenumber="2146"><td class="num" id="LN2146">2146</td><td class="line">     <span class='comment'>* so it's a good idea to call it before serving the unblocked clients</span></td></tr>
<tr class="codeline" data-linenumber="2147"><td class="num" id="LN2147">2147</td><td class="line">     <span class='comment'>* later in this function. */</span></td></tr>
<tr class="codeline" data-linenumber="2148"><td class="num" id="LN2148">2148</td><td class="line">    <span class='keyword'>if</span> (server.cluster_enabled) clusterBeforeSleep();</td></tr>
<tr class="codeline" data-linenumber="2149"><td class="num" id="LN2149">2149</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2150"><td class="num" id="LN2150">2150</td><td class="line">    <span class='comment'>/* Run a fast expire cycle (the called function will return</span></td></tr>
<tr class="codeline" data-linenumber="2151"><td class="num" id="LN2151">2151</td><td class="line">     <span class='comment'>* ASAP if a fast cycle is not needed). */</span></td></tr>
<tr class="codeline" data-linenumber="2152"><td class="num" id="LN2152">2152</td><td class="line">    <span class='keyword'>if</span> (server.active_expire_enabled &amp;&amp; server.masterhost == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2153"><td class="num" id="LN2153">2153</td><td class="line">        activeExpireCycle(<span class='macro'>ACTIVE_EXPIRE_CYCLE_FAST<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2154"><td class="num" id="LN2154">2154</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2155"><td class="num" id="LN2155">2155</td><td class="line">    <span class='comment'>/* Unblock all the clients blocked for synchronous replication</span></td></tr>
<tr class="codeline" data-linenumber="2156"><td class="num" id="LN2156">2156</td><td class="line">     <span class='comment'>* in WAIT. */</span></td></tr>
<tr class="codeline" data-linenumber="2157"><td class="num" id="LN2157">2157</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>listLength(server.clients_waiting_acks)<span class='macro_popup'>((server.clients_waiting_acks)-&gt;len)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2158"><td class="num" id="LN2158">2158</td><td class="line">        processClientsWaitingReplicas();</td></tr>
<tr class="codeline" data-linenumber="2159"><td class="num" id="LN2159">2159</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2160"><td class="num" id="LN2160">2160</td><td class="line">    <span class='comment'>/* Check if there are clients unblocked by modules that implement</span></td></tr>
<tr class="codeline" data-linenumber="2161"><td class="num" id="LN2161">2161</td><td class="line">     <span class='comment'>* blocking commands. */</span></td></tr>
<tr class="codeline" data-linenumber="2162"><td class="num" id="LN2162">2162</td><td class="line">    <span class='keyword'>if</span> (moduleCount()) moduleHandleBlockedClients();</td></tr>
<tr class="codeline" data-linenumber="2163"><td class="num" id="LN2163">2163</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2164"><td class="num" id="LN2164">2164</td><td class="line">    <span class='comment'>/* Try to process pending commands for clients that were just unblocked. */</span></td></tr>
<tr class="codeline" data-linenumber="2165"><td class="num" id="LN2165">2165</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>listLength(server.unblocked_clients)<span class='macro_popup'>((server.unblocked_clients)-&gt;len)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2166"><td class="num" id="LN2166">2166</td><td class="line">        processUnblockedClients();</td></tr>
<tr class="codeline" data-linenumber="2167"><td class="num" id="LN2167">2167</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2168"><td class="num" id="LN2168">2168</td><td class="line">    <span class='comment'>/* Send all the slaves an ACK request if at least one client blocked</span></td></tr>
<tr class="codeline" data-linenumber="2169"><td class="num" id="LN2169">2169</td><td class="line">     <span class='comment'>* during the previous event loop iteration. Note that we do this after</span></td></tr>
<tr class="codeline" data-linenumber="2170"><td class="num" id="LN2170">2170</td><td class="line">     <span class='comment'>* processUnblockedClients(), so if there are multiple pipelined WAITs</span></td></tr>
<tr class="codeline" data-linenumber="2171"><td class="num" id="LN2171">2171</td><td class="line">     <span class='comment'>* and the just unblocked WAIT gets blocked again, we don't have to wait</span></td></tr>
<tr class="codeline" data-linenumber="2172"><td class="num" id="LN2172">2172</td><td class="line">     <span class='comment'>* a server cron cycle in absence of other event loop events. See #6623. */</span></td></tr>
<tr class="codeline" data-linenumber="2173"><td class="num" id="LN2173">2173</td><td class="line">    <span class='keyword'>if</span> (server.get_ack_from_slaves) {</td></tr>
<tr class="codeline" data-linenumber="2174"><td class="num" id="LN2174">2174</td><td class="line">        robj *argv[3];</td></tr>
<tr class="codeline" data-linenumber="2175"><td class="num" id="LN2175">2175</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2176"><td class="num" id="LN2176">2176</td><td class="line">        argv[0] = createStringObject(<span class='string_literal'>"REPLCONF"</span>,8);</td></tr>
<tr class="codeline" data-linenumber="2177"><td class="num" id="LN2177">2177</td><td class="line">        argv[1] = createStringObject(<span class='string_literal'>"GETACK"</span>,6);</td></tr>
<tr class="codeline" data-linenumber="2178"><td class="num" id="LN2178">2178</td><td class="line">        argv[2] = createStringObject(<span class='string_literal'>"*"</span>,1); <span class='comment'>/* Not used argument. */</span></td></tr>
<tr class="codeline" data-linenumber="2179"><td class="num" id="LN2179">2179</td><td class="line">        replicationFeedSlaves(server.slaves, server.slaveseldb, argv, 3);</td></tr>
<tr class="codeline" data-linenumber="2180"><td class="num" id="LN2180">2180</td><td class="line">        decrRefCount(argv[0]);</td></tr>
<tr class="codeline" data-linenumber="2181"><td class="num" id="LN2181">2181</td><td class="line">        decrRefCount(argv[1]);</td></tr>
<tr class="codeline" data-linenumber="2182"><td class="num" id="LN2182">2182</td><td class="line">        decrRefCount(argv[2]);</td></tr>
<tr class="codeline" data-linenumber="2183"><td class="num" id="LN2183">2183</td><td class="line">        server.get_ack_from_slaves = 0;</td></tr>
<tr class="codeline" data-linenumber="2184"><td class="num" id="LN2184">2184</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2185"><td class="num" id="LN2185">2185</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2186"><td class="num" id="LN2186">2186</td><td class="line">    <span class='comment'>/* Send the invalidation messages to clients participating to the</span></td></tr>
<tr class="codeline" data-linenumber="2187"><td class="num" id="LN2187">2187</td><td class="line">     <span class='comment'>* client side caching protocol in broadcasting (BCAST) mode. */</span></td></tr>
<tr class="codeline" data-linenumber="2188"><td class="num" id="LN2188">2188</td><td class="line">    trackingBroadcastInvalidationMessages();</td></tr>
<tr class="codeline" data-linenumber="2189"><td class="num" id="LN2189">2189</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2190"><td class="num" id="LN2190">2190</td><td class="line">    <span class='comment'>/* Write the AOF buffer on disk */</span></td></tr>
<tr class="codeline" data-linenumber="2191"><td class="num" id="LN2191">2191</td><td class="line">    flushAppendOnlyFile(0);</td></tr>
<tr class="codeline" data-linenumber="2192"><td class="num" id="LN2192">2192</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2193"><td class="num" id="LN2193">2193</td><td class="line">    <span class='comment'>/* Handle writes with pending output buffers. */</span></td></tr>
<tr class="codeline" data-linenumber="2194"><td class="num" id="LN2194">2194</td><td class="line">    handleClientsWithPendingWritesUsingThreads();</td></tr>
<tr class="codeline" data-linenumber="2195"><td class="num" id="LN2195">2195</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2196"><td class="num" id="LN2196">2196</td><td class="line">    <span class='comment'>/* Close clients that need to be closed asynchronous */</span></td></tr>
<tr class="codeline" data-linenumber="2197"><td class="num" id="LN2197">2197</td><td class="line">    freeClientsInAsyncFreeQueue();</td></tr>
<tr class="codeline" data-linenumber="2198"><td class="num" id="LN2198">2198</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2199"><td class="num" id="LN2199">2199</td><td class="line">    <span class='comment'>/* Before we are going to sleep, let the threads access the dataset by</span></td></tr>
<tr class="codeline" data-linenumber="2200"><td class="num" id="LN2200">2200</td><td class="line">     <span class='comment'>* releasing the GIL. Redis main thread will not touch anything at this</span></td></tr>
<tr class="codeline" data-linenumber="2201"><td class="num" id="LN2201">2201</td><td class="line">     <span class='comment'>* time. */</span></td></tr>
<tr class="codeline" data-linenumber="2202"><td class="num" id="LN2202">2202</td><td class="line">    <span class='keyword'>if</span> (moduleCount()) moduleReleaseGIL();</td></tr>
<tr class="codeline" data-linenumber="2203"><td class="num" id="LN2203">2203</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2204"><td class="num" id="LN2204">2204</td><td class="line">    <span class='comment'>/* Try to process blocked clients every once in while. Example: A module</span></td></tr>
<tr class="codeline" data-linenumber="2205"><td class="num" id="LN2205">2205</td><td class="line">     <span class='comment'>* calls RM_SignalKeyAsReady from within a timer callback (So we don't</span></td></tr>
<tr class="codeline" data-linenumber="2206"><td class="num" id="LN2206">2206</td><td class="line">     <span class='comment'>* visit processCommand() at all). */</span></td></tr>
<tr class="codeline" data-linenumber="2207"><td class="num" id="LN2207">2207</td><td class="line">    handleClientsBlockedOnKeys();</td></tr>
<tr class="codeline" data-linenumber="2208"><td class="num" id="LN2208">2208</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2209"><td class="num" id="LN2209">2209</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2210"><td class="num" id="LN2210">2210</td><td class="line"><span class='comment'>/* This function is called immediately after the event loop multiplexing</span></td></tr>
<tr class="codeline" data-linenumber="2211"><td class="num" id="LN2211">2211</td><td class="line"> <span class='comment'>* API returned, and the control is going to soon return to Redis by invoking</span></td></tr>
<tr class="codeline" data-linenumber="2212"><td class="num" id="LN2212">2212</td><td class="line"> <span class='comment'>* the different events callbacks. */</span></td></tr>
<tr class="codeline" data-linenumber="2213"><td class="num" id="LN2213">2213</td><td class="line"><span class='keyword'>void</span> afterSleep(<span class='keyword'>struct</span> aeEventLoop *eventLoop) {</td></tr>
<tr class="codeline" data-linenumber="2214"><td class="num" id="LN2214">2214</td><td class="line">    <span class='macro'>UNUSED(eventLoop)<span class='macro_popup'>((void) eventLoop)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2215"><td class="num" id="LN2215">2215</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2216"><td class="num" id="LN2216">2216</td><td class="line">    <span class='keyword'>if</span> (!ProcessingEventsWhileBlocked) {</td></tr>
<tr class="codeline" data-linenumber="2217"><td class="num" id="LN2217">2217</td><td class="line">        <span class='keyword'>if</span> (moduleCount()) moduleAcquireGIL();</td></tr>
<tr class="codeline" data-linenumber="2218"><td class="num" id="LN2218">2218</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2219"><td class="num" id="LN2219">2219</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2220"><td class="num" id="LN2220">2220</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2221"><td class="num" id="LN2221">2221</td><td class="line"><span class='comment'>/* =========================== Server initialization ======================== */</span></td></tr>
<tr class="codeline" data-linenumber="2222"><td class="num" id="LN2222">2222</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2223"><td class="num" id="LN2223">2223</td><td class="line"><span class='keyword'>void</span> createSharedObjects(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="2224"><td class="num" id="LN2224">2224</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="2225"><td class="num" id="LN2225">2225</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2226"><td class="num" id="LN2226">2226</td><td class="line">    shared.crlf = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(<span class='string_literal'>"\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2227"><td class="num" id="LN2227">2227</td><td class="line">    shared.ok = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(<span class='string_literal'>"+OK\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2228"><td class="num" id="LN2228">2228</td><td class="line">    shared.err = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(<span class='string_literal'>"-ERR\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2229"><td class="num" id="LN2229">2229</td><td class="line">    shared.emptybulk = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(<span class='string_literal'>"$0\r\n\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2230"><td class="num" id="LN2230">2230</td><td class="line">    shared.czero = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(<span class='string_literal'>":0\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2231"><td class="num" id="LN2231">2231</td><td class="line">    shared.cone = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(<span class='string_literal'>":1\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2232"><td class="num" id="LN2232">2232</td><td class="line">    shared.emptyarray = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(<span class='string_literal'>"*0\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2233"><td class="num" id="LN2233">2233</td><td class="line">    shared.pong = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(<span class='string_literal'>"+PONG\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2234"><td class="num" id="LN2234">2234</td><td class="line">    shared.queued = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(<span class='string_literal'>"+QUEUED\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2235"><td class="num" id="LN2235">2235</td><td class="line">    shared.emptyscan = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(<span class='string_literal'>"*2\r\n$1\r\n0\r\n*0\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2236"><td class="num" id="LN2236">2236</td><td class="line">    shared.wrongtypeerr = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(</td></tr>
<tr class="codeline" data-linenumber="2237"><td class="num" id="LN2237">2237</td><td class="line">        <span class='string_literal'>"-WRONGTYPE Operation against a key holding the wrong kind of value\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2238"><td class="num" id="LN2238">2238</td><td class="line">    shared.nokeyerr = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(</td></tr>
<tr class="codeline" data-linenumber="2239"><td class="num" id="LN2239">2239</td><td class="line">        <span class='string_literal'>"-ERR no such key\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2240"><td class="num" id="LN2240">2240</td><td class="line">    shared.syntaxerr = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(</td></tr>
<tr class="codeline" data-linenumber="2241"><td class="num" id="LN2241">2241</td><td class="line">        <span class='string_literal'>"-ERR syntax error\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2242"><td class="num" id="LN2242">2242</td><td class="line">    shared.sameobjecterr = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(</td></tr>
<tr class="codeline" data-linenumber="2243"><td class="num" id="LN2243">2243</td><td class="line">        <span class='string_literal'>"-ERR source and destination objects are the same\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2244"><td class="num" id="LN2244">2244</td><td class="line">    shared.outofrangeerr = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(</td></tr>
<tr class="codeline" data-linenumber="2245"><td class="num" id="LN2245">2245</td><td class="line">        <span class='string_literal'>"-ERR index out of range\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2246"><td class="num" id="LN2246">2246</td><td class="line">    shared.noscripterr = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(</td></tr>
<tr class="codeline" data-linenumber="2247"><td class="num" id="LN2247">2247</td><td class="line">        <span class='string_literal'>"-NOSCRIPT No matching script. Please use EVAL.\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2248"><td class="num" id="LN2248">2248</td><td class="line">    shared.loadingerr = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(</td></tr>
<tr class="codeline" data-linenumber="2249"><td class="num" id="LN2249">2249</td><td class="line">        <span class='string_literal'>"-LOADING Redis is loading the dataset in memory\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2250"><td class="num" id="LN2250">2250</td><td class="line">    shared.slowscripterr = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(</td></tr>
<tr class="codeline" data-linenumber="2251"><td class="num" id="LN2251">2251</td><td class="line">        <span class='string_literal'>"-BUSY Redis is busy running a script. You can only call SCRIPT KILL or SHUTDOWN NOSAVE.\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2252"><td class="num" id="LN2252">2252</td><td class="line">    shared.masterdownerr = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(</td></tr>
<tr class="codeline" data-linenumber="2253"><td class="num" id="LN2253">2253</td><td class="line">        <span class='string_literal'>"-MASTERDOWN Link with MASTER is down and replica-serve-stale-data is set to 'no'.\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2254"><td class="num" id="LN2254">2254</td><td class="line">    shared.bgsaveerr = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(</td></tr>
<tr class="codeline" data-linenumber="2255"><td class="num" id="LN2255">2255</td><td class="line">        <span class='string_literal'>"-MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commands that may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error.\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2256"><td class="num" id="LN2256">2256</td><td class="line">    shared.roslaveerr = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(</td></tr>
<tr class="codeline" data-linenumber="2257"><td class="num" id="LN2257">2257</td><td class="line">        <span class='string_literal'>"-READONLY You can't write against a read only replica.\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2258"><td class="num" id="LN2258">2258</td><td class="line">    shared.noautherr = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(</td></tr>
<tr class="codeline" data-linenumber="2259"><td class="num" id="LN2259">2259</td><td class="line">        <span class='string_literal'>"-NOAUTH Authentication required.\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2260"><td class="num" id="LN2260">2260</td><td class="line">    shared.oomerr = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(</td></tr>
<tr class="codeline" data-linenumber="2261"><td class="num" id="LN2261">2261</td><td class="line">        <span class='string_literal'>"-OOM command not allowed when used memory &gt; 'maxmemory'.\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2262"><td class="num" id="LN2262">2262</td><td class="line">    shared.execaborterr = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(</td></tr>
<tr class="codeline" data-linenumber="2263"><td class="num" id="LN2263">2263</td><td class="line">        <span class='string_literal'>"-EXECABORT Transaction discarded because of previous errors.\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2264"><td class="num" id="LN2264">2264</td><td class="line">    shared.noreplicaserr = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(</td></tr>
<tr class="codeline" data-linenumber="2265"><td class="num" id="LN2265">2265</td><td class="line">        <span class='string_literal'>"-NOREPLICAS Not enough good replicas to write.\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2266"><td class="num" id="LN2266">2266</td><td class="line">    shared.busykeyerr = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(</td></tr>
<tr class="codeline" data-linenumber="2267"><td class="num" id="LN2267">2267</td><td class="line">        <span class='string_literal'>"-BUSYKEY Target key name already exists.\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2268"><td class="num" id="LN2268">2268</td><td class="line">    shared.space = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(<span class='string_literal'>" "</span>));</td></tr>
<tr class="codeline" data-linenumber="2269"><td class="num" id="LN2269">2269</td><td class="line">    shared.colon = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(<span class='string_literal'>":"</span>));</td></tr>
<tr class="codeline" data-linenumber="2270"><td class="num" id="LN2270">2270</td><td class="line">    shared.plus = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(<span class='string_literal'>"+"</span>));</td></tr>
<tr class="codeline" data-linenumber="2271"><td class="num" id="LN2271">2271</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2272"><td class="num" id="LN2272">2272</td><td class="line">    <span class='comment'>/* The shared NULL depends on the protocol version. */</span></td></tr>
<tr class="codeline" data-linenumber="2273"><td class="num" id="LN2273">2273</td><td class="line">    shared.null[0] = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2274"><td class="num" id="LN2274">2274</td><td class="line">    shared.null[1] = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2275"><td class="num" id="LN2275">2275</td><td class="line">    shared.null[2] = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(<span class='string_literal'>"$-1\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2276"><td class="num" id="LN2276">2276</td><td class="line">    shared.null[3] = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(<span class='string_literal'>"_\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2277"><td class="num" id="LN2277">2277</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2278"><td class="num" id="LN2278">2278</td><td class="line">    shared.nullarray[0] = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2279"><td class="num" id="LN2279">2279</td><td class="line">    shared.nullarray[1] = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2280"><td class="num" id="LN2280">2280</td><td class="line">    shared.nullarray[2] = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(<span class='string_literal'>"*-1\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2281"><td class="num" id="LN2281">2281</td><td class="line">    shared.nullarray[3] = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(<span class='string_literal'>"_\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2282"><td class="num" id="LN2282">2282</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2283"><td class="num" id="LN2283">2283</td><td class="line">    shared.emptymap[0] = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2284"><td class="num" id="LN2284">2284</td><td class="line">    shared.emptymap[1] = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2285"><td class="num" id="LN2285">2285</td><td class="line">    shared.emptymap[2] = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(<span class='string_literal'>"*0\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2286"><td class="num" id="LN2286">2286</td><td class="line">    shared.emptymap[3] = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(<span class='string_literal'>"%0\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2287"><td class="num" id="LN2287">2287</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2288"><td class="num" id="LN2288">2288</td><td class="line">    shared.emptyset[0] = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2289"><td class="num" id="LN2289">2289</td><td class="line">    shared.emptyset[1] = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2290"><td class="num" id="LN2290">2290</td><td class="line">    shared.emptyset[2] = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(<span class='string_literal'>"*0\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2291"><td class="num" id="LN2291">2291</td><td class="line">    shared.emptyset[3] = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,sdsnew(<span class='string_literal'>"~0\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2292"><td class="num" id="LN2292">2292</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2293"><td class="num" id="LN2293">2293</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; <span class='macro'>PROTO_SHARED_SELECT_CMDS<span class='macro_popup'>10</span></span>; j++) {</td></tr>
<tr class="codeline" data-linenumber="2294"><td class="num" id="LN2294">2294</td><td class="line">        <span class='keyword'>char</span> dictid_str[64];</td></tr>
<tr class="codeline" data-linenumber="2295"><td class="num" id="LN2295">2295</td><td class="line">        <span class='keyword'>int</span> dictid_len;</td></tr>
<tr class="codeline" data-linenumber="2296"><td class="num" id="LN2296">2296</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2297"><td class="num" id="LN2297">2297</td><td class="line">        dictid_len = ll2string(dictid_str,<span class='keyword'>sizeof</span>(dictid_str),j);</td></tr>
<tr class="codeline" data-linenumber="2298"><td class="num" id="LN2298">2298</td><td class="line">        shared.select[j] = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2299"><td class="num" id="LN2299">2299</td><td class="line">            sdscatprintf(sdsempty(),</td></tr>
<tr class="codeline" data-linenumber="2300"><td class="num" id="LN2300">2300</td><td class="line">                <span class='string_literal'>"*2\r\n$6\r\nSELECT\r\n$%d\r\n%s\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="2301"><td class="num" id="LN2301">2301</td><td class="line">                dictid_len, dictid_str));</td></tr>
<tr class="codeline" data-linenumber="2302"><td class="num" id="LN2302">2302</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2303"><td class="num" id="LN2303">2303</td><td class="line">    shared.messagebulk = createStringObject(<span class='string_literal'>"$7\r\nmessage\r\n"</span>,13);</td></tr>
<tr class="codeline" data-linenumber="2304"><td class="num" id="LN2304">2304</td><td class="line">    shared.pmessagebulk = createStringObject(<span class='string_literal'>"$8\r\npmessage\r\n"</span>,14);</td></tr>
<tr class="codeline" data-linenumber="2305"><td class="num" id="LN2305">2305</td><td class="line">    shared.subscribebulk = createStringObject(<span class='string_literal'>"$9\r\nsubscribe\r\n"</span>,15);</td></tr>
<tr class="codeline" data-linenumber="2306"><td class="num" id="LN2306">2306</td><td class="line">    shared.unsubscribebulk = createStringObject(<span class='string_literal'>"$11\r\nunsubscribe\r\n"</span>,18);</td></tr>
<tr class="codeline" data-linenumber="2307"><td class="num" id="LN2307">2307</td><td class="line">    shared.psubscribebulk = createStringObject(<span class='string_literal'>"$10\r\npsubscribe\r\n"</span>,17);</td></tr>
<tr class="codeline" data-linenumber="2308"><td class="num" id="LN2308">2308</td><td class="line">    shared.punsubscribebulk = createStringObject(<span class='string_literal'>"$12\r\npunsubscribe\r\n"</span>,19);</td></tr>
<tr class="codeline" data-linenumber="2309"><td class="num" id="LN2309">2309</td><td class="line">    shared.del = createStringObject(<span class='string_literal'>"DEL"</span>,3);</td></tr>
<tr class="codeline" data-linenumber="2310"><td class="num" id="LN2310">2310</td><td class="line">    shared.unlink = createStringObject(<span class='string_literal'>"UNLINK"</span>,6);</td></tr>
<tr class="codeline" data-linenumber="2311"><td class="num" id="LN2311">2311</td><td class="line">    shared.rpop = createStringObject(<span class='string_literal'>"RPOP"</span>,4);</td></tr>
<tr class="codeline" data-linenumber="2312"><td class="num" id="LN2312">2312</td><td class="line">    shared.lpop = createStringObject(<span class='string_literal'>"LPOP"</span>,4);</td></tr>
<tr class="codeline" data-linenumber="2313"><td class="num" id="LN2313">2313</td><td class="line">    shared.lpush = createStringObject(<span class='string_literal'>"LPUSH"</span>,5);</td></tr>
<tr class="codeline" data-linenumber="2314"><td class="num" id="LN2314">2314</td><td class="line">    shared.rpoplpush = createStringObject(<span class='string_literal'>"RPOPLPUSH"</span>,9);</td></tr>
<tr class="codeline" data-linenumber="2315"><td class="num" id="LN2315">2315</td><td class="line">    shared.zpopmin = createStringObject(<span class='string_literal'>"ZPOPMIN"</span>,7);</td></tr>
<tr class="codeline" data-linenumber="2316"><td class="num" id="LN2316">2316</td><td class="line">    shared.zpopmax = createStringObject(<span class='string_literal'>"ZPOPMAX"</span>,7);</td></tr>
<tr class="codeline" data-linenumber="2317"><td class="num" id="LN2317">2317</td><td class="line">    shared.multi = createStringObject(<span class='string_literal'>"MULTI"</span>,5);</td></tr>
<tr class="codeline" data-linenumber="2318"><td class="num" id="LN2318">2318</td><td class="line">    shared.exec = createStringObject(<span class='string_literal'>"EXEC"</span>,4);</td></tr>
<tr class="codeline" data-linenumber="2319"><td class="num" id="LN2319">2319</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; <span class='macro'>OBJ_SHARED_INTEGERS<span class='macro_popup'>10000</span></span>; j++) {</td></tr>
<tr class="codeline" data-linenumber="2320"><td class="num" id="LN2320">2320</td><td class="line">        shared.integers[j] =</td></tr>
<tr class="codeline" data-linenumber="2321"><td class="num" id="LN2321">2321</td><td class="line">            makeObjectShared(createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,(<span class='keyword'>void</span>*)(<span class='keyword'>long</span>)j));</td></tr>
<tr class="codeline" data-linenumber="2322"><td class="num" id="LN2322">2322</td><td class="line">        shared.integers[j]-&gt;encoding = <span class='macro'>OBJ_ENCODING_INT<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2323"><td class="num" id="LN2323">2323</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2324"><td class="num" id="LN2324">2324</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; <span class='macro'>OBJ_SHARED_BULKHDR_LEN<span class='macro_popup'>32</span></span>; j++) {</td></tr>
<tr class="codeline" data-linenumber="2325"><td class="num" id="LN2325">2325</td><td class="line">        shared.mbulkhdr[j] = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2326"><td class="num" id="LN2326">2326</td><td class="line">            sdscatprintf(sdsempty(),<span class='string_literal'>"*%d\r\n"</span>,j));</td></tr>
<tr class="codeline" data-linenumber="2327"><td class="num" id="LN2327">2327</td><td class="line">        shared.bulkhdr[j] = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2328"><td class="num" id="LN2328">2328</td><td class="line">            sdscatprintf(sdsempty(),<span class='string_literal'>"$%d\r\n"</span>,j));</td></tr>
<tr class="codeline" data-linenumber="2329"><td class="num" id="LN2329">2329</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2330"><td class="num" id="LN2330">2330</td><td class="line">    <span class='comment'>/* The following two shared objects, minstring and maxstrings, are not</span></td></tr>
<tr class="codeline" data-linenumber="2331"><td class="num" id="LN2331">2331</td><td class="line">     <span class='comment'>* actually used for their value but as a special object meaning</span></td></tr>
<tr class="codeline" data-linenumber="2332"><td class="num" id="LN2332">2332</td><td class="line">     <span class='comment'>* respectively the minimum possible string and the maximum possible</span></td></tr>
<tr class="codeline" data-linenumber="2333"><td class="num" id="LN2333">2333</td><td class="line">     <span class='comment'>* string in string comparisons for the ZRANGEBYLEX command. */</span></td></tr>
<tr class="codeline" data-linenumber="2334"><td class="num" id="LN2334">2334</td><td class="line">    shared.minstring = sdsnew(<span class='string_literal'>"minstring"</span>);</td></tr>
<tr class="codeline" data-linenumber="2335"><td class="num" id="LN2335">2335</td><td class="line">    shared.maxstring = sdsnew(<span class='string_literal'>"maxstring"</span>);</td></tr>
<tr class="codeline" data-linenumber="2336"><td class="num" id="LN2336">2336</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2337"><td class="num" id="LN2337">2337</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2338"><td class="num" id="LN2338">2338</td><td class="line"><span class='keyword'>void</span> initServerConfig(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="2339"><td class="num" id="LN2339">2339</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="2340"><td class="num" id="LN2340">2340</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2341"><td class="num" id="LN2341">2341</td><td class="line">    updateCachedTime(1);</td></tr>
<tr class="codeline" data-linenumber="2342"><td class="num" id="LN2342">2342</td><td class="line">    getRandomHexChars(server.runid,<span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2343"><td class="num" id="LN2343">2343</td><td class="line">    server.runid[<span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>] = '\0';</td></tr>
<tr class="codeline" data-linenumber="2344"><td class="num" id="LN2344">2344</td><td class="line">    changeReplicationId();</td></tr>
<tr class="codeline" data-linenumber="2345"><td class="num" id="LN2345">2345</td><td class="line">    clearReplicationId2();</td></tr>
<tr class="codeline" data-linenumber="2346"><td class="num" id="LN2346">2346</td><td class="line">    server.hz = <span class='macro'>CONFIG_DEFAULT_HZ<span class='macro_popup'>10</span></span>; <span class='comment'>/* Initialize it ASAP, even if it may get</span></td></tr>
<tr class="codeline" data-linenumber="2347"><td class="num" id="LN2347">2347</td><td class="line">                                      <span class='comment'>updated later after loading the config.</span></td></tr>
<tr class="codeline" data-linenumber="2348"><td class="num" id="LN2348">2348</td><td class="line">                                      <span class='comment'>This value may be used before the server</span></td></tr>
<tr class="codeline" data-linenumber="2349"><td class="num" id="LN2349">2349</td><td class="line">                                      <span class='comment'>is initialized. */</span></td></tr>
<tr class="codeline" data-linenumber="2350"><td class="num" id="LN2350">2350</td><td class="line">    server.timezone = getTimeZone(); <span class='comment'>/* Initialized by tzset(). */</span></td></tr>
<tr class="codeline" data-linenumber="2351"><td class="num" id="LN2351">2351</td><td class="line">    server.configfile = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2352"><td class="num" id="LN2352">2352</td><td class="line">    server.executable = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2353"><td class="num" id="LN2353">2353</td><td class="line">    server.arch_bits = (<span class='keyword'>sizeof</span>(<span class='keyword'>long</span>) == 8) ? 64 : 32;</td></tr>
<tr class="codeline" data-linenumber="2354"><td class="num" id="LN2354">2354</td><td class="line">    server.bindaddr_count = 0;</td></tr>
<tr class="codeline" data-linenumber="2355"><td class="num" id="LN2355">2355</td><td class="line">    server.unixsocketperm = <span class='macro'>CONFIG_DEFAULT_UNIX_SOCKET_PERM<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2356"><td class="num" id="LN2356">2356</td><td class="line">    server.ipfd_count = 0;</td></tr>
<tr class="codeline" data-linenumber="2357"><td class="num" id="LN2357">2357</td><td class="line">    server.tlsfd_count = 0;</td></tr>
<tr class="codeline" data-linenumber="2358"><td class="num" id="LN2358">2358</td><td class="line">    server.sofd = -1;</td></tr>
<tr class="codeline" data-linenumber="2359"><td class="num" id="LN2359">2359</td><td class="line">    server.active_expire_enabled = 1;</td></tr>
<tr class="codeline" data-linenumber="2360"><td class="num" id="LN2360">2360</td><td class="line">    server.client_max_querybuf_len = <span class='macro'>PROTO_MAX_QUERYBUF_LEN<span class='macro_popup'>(1024*1024*1024)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2361"><td class="num" id="LN2361">2361</td><td class="line">    server.saveparams = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2362"><td class="num" id="LN2362">2362</td><td class="line">    server.loading = 0;</td></tr>
<tr class="codeline" data-linenumber="2363"><td class="num" id="LN2363">2363</td><td class="line">    server.logfile = zstrdup(<span class='macro'>CONFIG_DEFAULT_LOGFILE<span class='macro_popup'>""</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2364"><td class="num" id="LN2364">2364</td><td class="line">    server.aof_state = <span class='macro'>AOF_OFF<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2365"><td class="num" id="LN2365">2365</td><td class="line">    server.aof_rewrite_base_size = 0;</td></tr>
<tr class="codeline" data-linenumber="2366"><td class="num" id="LN2366">2366</td><td class="line">    server.aof_rewrite_scheduled = 0;</td></tr>
<tr class="codeline" data-linenumber="2367"><td class="num" id="LN2367">2367</td><td class="line">    server.aof_flush_sleep = 0;</td></tr>
<tr class="codeline" data-linenumber="2368"><td class="num" id="LN2368">2368</td><td class="line">    server.aof_last_fsync = time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2369"><td class="num" id="LN2369">2369</td><td class="line">    server.aof_rewrite_time_last = -1;</td></tr>
<tr class="codeline" data-linenumber="2370"><td class="num" id="LN2370">2370</td><td class="line">    server.aof_rewrite_time_start = -1;</td></tr>
<tr class="codeline" data-linenumber="2371"><td class="num" id="LN2371">2371</td><td class="line">    server.aof_lastbgrewrite_status = <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2372"><td class="num" id="LN2372">2372</td><td class="line">    server.aof_delayed_fsync = 0;</td></tr>
<tr class="codeline" data-linenumber="2373"><td class="num" id="LN2373">2373</td><td class="line">    server.aof_fd = -1;</td></tr>
<tr class="codeline" data-linenumber="2374"><td class="num" id="LN2374">2374</td><td class="line">    server.aof_selected_db = -1; <span class='comment'>/* Make sure the first time will not match */</span></td></tr>
<tr class="codeline" data-linenumber="2375"><td class="num" id="LN2375">2375</td><td class="line">    server.aof_flush_postponed_start = 0;</td></tr>
<tr class="codeline" data-linenumber="2376"><td class="num" id="LN2376">2376</td><td class="line">    server.pidfile = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2377"><td class="num" id="LN2377">2377</td><td class="line">    server.active_defrag_running = 0;</td></tr>
<tr class="codeline" data-linenumber="2378"><td class="num" id="LN2378">2378</td><td class="line">    server.notify_keyspace_events = 0;</td></tr>
<tr class="codeline" data-linenumber="2379"><td class="num" id="LN2379">2379</td><td class="line">    server.blocked_clients = 0;</td></tr>
<tr class="codeline" data-linenumber="2380"><td class="num" id="LN2380">2380</td><td class="line">    <span class="mrange">memset</span>(server.blocked_clients_by_type,0,</td></tr>
<tr><td class="num"></td><td class="line"><div id="EndPath" class="msg msgEvent" style="margin-left:5ex; max-width:58em">Call to function 'memset' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memset_s' in case of C11</div></td></tr>
<tr class="codeline" data-linenumber="2381"><td class="num" id="LN2381">2381</td><td class="line">           <span class='keyword'>sizeof</span>(server.blocked_clients_by_type));</td></tr>
<tr class="codeline" data-linenumber="2382"><td class="num" id="LN2382">2382</td><td class="line">    server.shutdown_asap = 0;</td></tr>
<tr class="codeline" data-linenumber="2383"><td class="num" id="LN2383">2383</td><td class="line">    server.cluster_configfile = zstrdup(<span class='macro'>CONFIG_DEFAULT_CLUSTER_CONFIG_FILE<span class='macro_popup'>"nodes.conf"</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2384"><td class="num" id="LN2384">2384</td><td class="line">    server.cluster_module_flags = <span class='macro'>CLUSTER_MODULE_FLAG_NONE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2385"><td class="num" id="LN2385">2385</td><td class="line">    server.migrate_cached_sockets = dictCreate(&amp;migrateCacheDictType,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2386"><td class="num" id="LN2386">2386</td><td class="line">    server.next_client_id = 1; <span class='comment'>/* Client IDs, start from 1 .*/</span></td></tr>
<tr class="codeline" data-linenumber="2387"><td class="num" id="LN2387">2387</td><td class="line">    server.loading_process_events_interval_bytes = (1024*1024*2);</td></tr>
<tr class="codeline" data-linenumber="2388"><td class="num" id="LN2388">2388</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2389"><td class="num" id="LN2389">2389</td><td class="line">    server.lruclock = getLRUClock();</td></tr>
<tr class="codeline" data-linenumber="2390"><td class="num" id="LN2390">2390</td><td class="line">    resetServerSaveParams();</td></tr>
<tr class="codeline" data-linenumber="2391"><td class="num" id="LN2391">2391</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2392"><td class="num" id="LN2392">2392</td><td class="line">    appendServerSaveParams(60*60,1);  <span class='comment'>/* save after 1 hour and 1 change */</span></td></tr>
<tr class="codeline" data-linenumber="2393"><td class="num" id="LN2393">2393</td><td class="line">    appendServerSaveParams(300,100);  <span class='comment'>/* save after 5 minutes and 100 changes */</span></td></tr>
<tr class="codeline" data-linenumber="2394"><td class="num" id="LN2394">2394</td><td class="line">    appendServerSaveParams(60,10000); <span class='comment'>/* save after 1 minute and 10000 changes */</span></td></tr>
<tr class="codeline" data-linenumber="2395"><td class="num" id="LN2395">2395</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2396"><td class="num" id="LN2396">2396</td><td class="line">    <span class='comment'>/* Replication related */</span></td></tr>
<tr class="codeline" data-linenumber="2397"><td class="num" id="LN2397">2397</td><td class="line">    server.masterauth = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2398"><td class="num" id="LN2398">2398</td><td class="line">    server.masterhost = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2399"><td class="num" id="LN2399">2399</td><td class="line">    server.masterport = 6379;</td></tr>
<tr class="codeline" data-linenumber="2400"><td class="num" id="LN2400">2400</td><td class="line">    server.master = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2401"><td class="num" id="LN2401">2401</td><td class="line">    server.cached_master = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2402"><td class="num" id="LN2402">2402</td><td class="line">    server.master_initial_offset = -1;</td></tr>
<tr class="codeline" data-linenumber="2403"><td class="num" id="LN2403">2403</td><td class="line">    server.repl_state = <span class='macro'>REPL_STATE_NONE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2404"><td class="num" id="LN2404">2404</td><td class="line">    server.repl_transfer_tmpfile = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2405"><td class="num" id="LN2405">2405</td><td class="line">    server.repl_transfer_fd = -1;</td></tr>
<tr class="codeline" data-linenumber="2406"><td class="num" id="LN2406">2406</td><td class="line">    server.repl_transfer_s = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2407"><td class="num" id="LN2407">2407</td><td class="line">    server.repl_syncio_timeout = <span class='macro'>CONFIG_REPL_SYNCIO_TIMEOUT<span class='macro_popup'>5</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2408"><td class="num" id="LN2408">2408</td><td class="line">    server.repl_down_since = 0; <span class='comment'>/* Never connected, repl is down since EVER. */</span></td></tr>
<tr class="codeline" data-linenumber="2409"><td class="num" id="LN2409">2409</td><td class="line">    server.master_repl_offset = 0;</td></tr>
<tr class="codeline" data-linenumber="2410"><td class="num" id="LN2410">2410</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2411"><td class="num" id="LN2411">2411</td><td class="line">    <span class='comment'>/* Replication partial resync backlog */</span></td></tr>
<tr class="codeline" data-linenumber="2412"><td class="num" id="LN2412">2412</td><td class="line">    server.repl_backlog = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2413"><td class="num" id="LN2413">2413</td><td class="line">    server.repl_backlog_histlen = 0;</td></tr>
<tr class="codeline" data-linenumber="2414"><td class="num" id="LN2414">2414</td><td class="line">    server.repl_backlog_idx = 0;</td></tr>
<tr class="codeline" data-linenumber="2415"><td class="num" id="LN2415">2415</td><td class="line">    server.repl_backlog_off = 0;</td></tr>
<tr class="codeline" data-linenumber="2416"><td class="num" id="LN2416">2416</td><td class="line">    server.repl_no_slaves_since = time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2417"><td class="num" id="LN2417">2417</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2418"><td class="num" id="LN2418">2418</td><td class="line">    <span class='comment'>/* Client output buffer limits */</span></td></tr>
<tr class="codeline" data-linenumber="2419"><td class="num" id="LN2419">2419</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; <span class='macro'>CLIENT_TYPE_OBUF_COUNT<span class='macro_popup'>3</span></span>; j++)</td></tr>
<tr class="codeline" data-linenumber="2420"><td class="num" id="LN2420">2420</td><td class="line">        server.client_obuf_limits[j] = clientBufferLimitsDefaults[j];</td></tr>
<tr class="codeline" data-linenumber="2421"><td class="num" id="LN2421">2421</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2422"><td class="num" id="LN2422">2422</td><td class="line">    <span class='comment'>/* Linux OOM Score config */</span></td></tr>
<tr class="codeline" data-linenumber="2423"><td class="num" id="LN2423">2423</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; <span class='macro'>CONFIG_OOM_COUNT<span class='macro_popup'>3</span></span>; j++)</td></tr>
<tr class="codeline" data-linenumber="2424"><td class="num" id="LN2424">2424</td><td class="line">        server.oom_score_adj_values[j] = configOOMScoreAdjValuesDefaults[j];</td></tr>
<tr class="codeline" data-linenumber="2425"><td class="num" id="LN2425">2425</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2426"><td class="num" id="LN2426">2426</td><td class="line">    <span class='comment'>/* Double constants initialization */</span></td></tr>
<tr class="codeline" data-linenumber="2427"><td class="num" id="LN2427">2427</td><td class="line">    R_Zero = 0.0;</td></tr>
<tr class="codeline" data-linenumber="2428"><td class="num" id="LN2428">2428</td><td class="line">    R_PosInf = 1.0/R_Zero;</td></tr>
<tr class="codeline" data-linenumber="2429"><td class="num" id="LN2429">2429</td><td class="line">    R_NegInf = -1.0/R_Zero;</td></tr>
<tr class="codeline" data-linenumber="2430"><td class="num" id="LN2430">2430</td><td class="line">    R_Nan = R_Zero/R_Zero;</td></tr>
<tr class="codeline" data-linenumber="2431"><td class="num" id="LN2431">2431</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2432"><td class="num" id="LN2432">2432</td><td class="line">    <span class='comment'>/* Command table -- we initialize it here as it is part of the</span></td></tr>
<tr class="codeline" data-linenumber="2433"><td class="num" id="LN2433">2433</td><td class="line">     <span class='comment'>* initial configuration, since command names may be changed via</span></td></tr>
<tr class="codeline" data-linenumber="2434"><td class="num" id="LN2434">2434</td><td class="line">     <span class='comment'>* redis.conf using the rename-command directive. */</span></td></tr>
<tr class="codeline" data-linenumber="2435"><td class="num" id="LN2435">2435</td><td class="line">    server.commands = dictCreate(&amp;commandTableDictType,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2436"><td class="num" id="LN2436">2436</td><td class="line">    server.orig_commands = dictCreate(&amp;commandTableDictType,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2437"><td class="num" id="LN2437">2437</td><td class="line">    populateCommandTable();</td></tr>
<tr class="codeline" data-linenumber="2438"><td class="num" id="LN2438">2438</td><td class="line">    server.delCommand = lookupCommandByCString(<span class='string_literal'>"del"</span>);</td></tr>
<tr class="codeline" data-linenumber="2439"><td class="num" id="LN2439">2439</td><td class="line">    server.multiCommand = lookupCommandByCString(<span class='string_literal'>"multi"</span>);</td></tr>
<tr class="codeline" data-linenumber="2440"><td class="num" id="LN2440">2440</td><td class="line">    server.lpushCommand = lookupCommandByCString(<span class='string_literal'>"lpush"</span>);</td></tr>
<tr class="codeline" data-linenumber="2441"><td class="num" id="LN2441">2441</td><td class="line">    server.lpopCommand = lookupCommandByCString(<span class='string_literal'>"lpop"</span>);</td></tr>
<tr class="codeline" data-linenumber="2442"><td class="num" id="LN2442">2442</td><td class="line">    server.rpopCommand = lookupCommandByCString(<span class='string_literal'>"rpop"</span>);</td></tr>
<tr class="codeline" data-linenumber="2443"><td class="num" id="LN2443">2443</td><td class="line">    server.zpopminCommand = lookupCommandByCString(<span class='string_literal'>"zpopmin"</span>);</td></tr>
<tr class="codeline" data-linenumber="2444"><td class="num" id="LN2444">2444</td><td class="line">    server.zpopmaxCommand = lookupCommandByCString(<span class='string_literal'>"zpopmax"</span>);</td></tr>
<tr class="codeline" data-linenumber="2445"><td class="num" id="LN2445">2445</td><td class="line">    server.sremCommand = lookupCommandByCString(<span class='string_literal'>"srem"</span>);</td></tr>
<tr class="codeline" data-linenumber="2446"><td class="num" id="LN2446">2446</td><td class="line">    server.execCommand = lookupCommandByCString(<span class='string_literal'>"exec"</span>);</td></tr>
<tr class="codeline" data-linenumber="2447"><td class="num" id="LN2447">2447</td><td class="line">    server.expireCommand = lookupCommandByCString(<span class='string_literal'>"expire"</span>);</td></tr>
<tr class="codeline" data-linenumber="2448"><td class="num" id="LN2448">2448</td><td class="line">    server.pexpireCommand = lookupCommandByCString(<span class='string_literal'>"pexpire"</span>);</td></tr>
<tr class="codeline" data-linenumber="2449"><td class="num" id="LN2449">2449</td><td class="line">    server.xclaimCommand = lookupCommandByCString(<span class='string_literal'>"xclaim"</span>);</td></tr>
<tr class="codeline" data-linenumber="2450"><td class="num" id="LN2450">2450</td><td class="line">    server.xgroupCommand = lookupCommandByCString(<span class='string_literal'>"xgroup"</span>);</td></tr>
<tr class="codeline" data-linenumber="2451"><td class="num" id="LN2451">2451</td><td class="line">    server.rpoplpushCommand = lookupCommandByCString(<span class='string_literal'>"rpoplpush"</span>);</td></tr>
<tr class="codeline" data-linenumber="2452"><td class="num" id="LN2452">2452</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2453"><td class="num" id="LN2453">2453</td><td class="line">    <span class='comment'>/* Debugging */</span></td></tr>
<tr class="codeline" data-linenumber="2454"><td class="num" id="LN2454">2454</td><td class="line">    server.assert_failed = <span class='string_literal'>"&lt;no assertion failed&gt;"</span>;</td></tr>
<tr class="codeline" data-linenumber="2455"><td class="num" id="LN2455">2455</td><td class="line">    server.assert_file = <span class='string_literal'>"&lt;no file&gt;"</span>;</td></tr>
<tr class="codeline" data-linenumber="2456"><td class="num" id="LN2456">2456</td><td class="line">    server.assert_line = 0;</td></tr>
<tr class="codeline" data-linenumber="2457"><td class="num" id="LN2457">2457</td><td class="line">    server.bug_report_start = 0;</td></tr>
<tr class="codeline" data-linenumber="2458"><td class="num" id="LN2458">2458</td><td class="line">    server.watchdog_period = 0;</td></tr>
<tr class="codeline" data-linenumber="2459"><td class="num" id="LN2459">2459</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2460"><td class="num" id="LN2460">2460</td><td class="line">    <span class='comment'>/* By default we want scripts to be always replicated by effects</span></td></tr>
<tr class="codeline" data-linenumber="2461"><td class="num" id="LN2461">2461</td><td class="line">     <span class='comment'>* (single commands executed by the script), and not by sending the</span></td></tr>
<tr class="codeline" data-linenumber="2462"><td class="num" id="LN2462">2462</td><td class="line">     <span class='comment'>* script to the slave / AOF. This is the new way starting from</span></td></tr>
<tr class="codeline" data-linenumber="2463"><td class="num" id="LN2463">2463</td><td class="line">     <span class='comment'>* Redis 5. However it is possible to revert it via redis.conf. */</span></td></tr>
<tr class="codeline" data-linenumber="2464"><td class="num" id="LN2464">2464</td><td class="line">    server.lua_always_replicate_commands = 1;</td></tr>
<tr class="codeline" data-linenumber="2465"><td class="num" id="LN2465">2465</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2466"><td class="num" id="LN2466">2466</td><td class="line">    initConfigValues();</td></tr>
<tr class="codeline" data-linenumber="2467"><td class="num" id="LN2467">2467</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2468"><td class="num" id="LN2468">2468</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2469"><td class="num" id="LN2469">2469</td><td class="line"><span class='keyword'>extern</span> <span class='keyword'>char</span> **environ;</td></tr>
<tr class="codeline" data-linenumber="2470"><td class="num" id="LN2470">2470</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2471"><td class="num" id="LN2471">2471</td><td class="line"><span class='comment'>/* Restart the server, executing the same executable that started this</span></td></tr>
<tr class="codeline" data-linenumber="2472"><td class="num" id="LN2472">2472</td><td class="line"> <span class='comment'>* instance, with the same arguments and configuration file.</span></td></tr>
<tr class="codeline" data-linenumber="2473"><td class="num" id="LN2473">2473</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2474"><td class="num" id="LN2474">2474</td><td class="line"> <span class='comment'>* The function is designed to directly call execve() so that the new</span></td></tr>
<tr class="codeline" data-linenumber="2475"><td class="num" id="LN2475">2475</td><td class="line"> <span class='comment'>* server instance will retain the PID of the previous one.</span></td></tr>
<tr class="codeline" data-linenumber="2476"><td class="num" id="LN2476">2476</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2477"><td class="num" id="LN2477">2477</td><td class="line"> <span class='comment'>* The list of flags, that may be bitwise ORed together, alter the</span></td></tr>
<tr class="codeline" data-linenumber="2478"><td class="num" id="LN2478">2478</td><td class="line"> <span class='comment'>* behavior of this function:</span></td></tr>
<tr class="codeline" data-linenumber="2479"><td class="num" id="LN2479">2479</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2480"><td class="num" id="LN2480">2480</td><td class="line"> <span class='comment'>* RESTART_SERVER_NONE              No flags.</span></td></tr>
<tr class="codeline" data-linenumber="2481"><td class="num" id="LN2481">2481</td><td class="line"> <span class='comment'>* RESTART_SERVER_GRACEFULLY        Do a proper shutdown before restarting.</span></td></tr>
<tr class="codeline" data-linenumber="2482"><td class="num" id="LN2482">2482</td><td class="line"> <span class='comment'>* RESTART_SERVER_CONFIG_REWRITE    Rewrite the config file before restarting.</span></td></tr>
<tr class="codeline" data-linenumber="2483"><td class="num" id="LN2483">2483</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2484"><td class="num" id="LN2484">2484</td><td class="line"> <span class='comment'>* On success the function does not return, because the process turns into</span></td></tr>
<tr class="codeline" data-linenumber="2485"><td class="num" id="LN2485">2485</td><td class="line"> <span class='comment'>* a different process. On error C_ERR is returned. */</span></td></tr>
<tr class="codeline" data-linenumber="2486"><td class="num" id="LN2486">2486</td><td class="line"><span class='keyword'>int</span> restartServer(<span class='keyword'>int</span> flags, mstime_t delay) {</td></tr>
<tr class="codeline" data-linenumber="2487"><td class="num" id="LN2487">2487</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="2488"><td class="num" id="LN2488">2488</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2489"><td class="num" id="LN2489">2489</td><td class="line">    <span class='comment'>/* Check if we still have accesses to the executable that started this</span></td></tr>
<tr class="codeline" data-linenumber="2490"><td class="num" id="LN2490">2490</td><td class="line">     <span class='comment'>* server instance. */</span></td></tr>
<tr class="codeline" data-linenumber="2491"><td class="num" id="LN2491">2491</td><td class="line">    <span class='keyword'>if</span> (access(server.executable,<span class='macro'>X_OK<span class='macro_popup'>1</span></span>) == -1) {</td></tr>
<tr class="codeline" data-linenumber="2492"><td class="num" id="LN2492">2492</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Can't restart: this process has no "</span></td></tr>
<tr class="codeline" data-linenumber="2493"><td class="num" id="LN2493">2493</td><td class="line">                             <span class='string_literal'>"permissions to execute %s"</span>, server.executable);</td></tr>
<tr class="codeline" data-linenumber="2494"><td class="num" id="LN2494">2494</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2495"><td class="num" id="LN2495">2495</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2496"><td class="num" id="LN2496">2496</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2497"><td class="num" id="LN2497">2497</td><td class="line">    <span class='comment'>/* Config rewriting. */</span></td></tr>
<tr class="codeline" data-linenumber="2498"><td class="num" id="LN2498">2498</td><td class="line">    <span class='keyword'>if</span> (flags &amp; <span class='macro'>RESTART_SERVER_CONFIG_REWRITE<span class='macro_popup'>(1&lt;&lt;1)</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2499"><td class="num" id="LN2499">2499</td><td class="line">        server.configfile &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2500"><td class="num" id="LN2500">2500</td><td class="line">        rewriteConfig(server.configfile, 0) == -1)</td></tr>
<tr class="codeline" data-linenumber="2501"><td class="num" id="LN2501">2501</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2502"><td class="num" id="LN2502">2502</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Can't restart: configuration rewrite process "</span></td></tr>
<tr class="codeline" data-linenumber="2503"><td class="num" id="LN2503">2503</td><td class="line">                             <span class='string_literal'>"failed"</span>);</td></tr>
<tr class="codeline" data-linenumber="2504"><td class="num" id="LN2504">2504</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2505"><td class="num" id="LN2505">2505</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2506"><td class="num" id="LN2506">2506</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2507"><td class="num" id="LN2507">2507</td><td class="line">    <span class='comment'>/* Perform a proper shutdown. */</span></td></tr>
<tr class="codeline" data-linenumber="2508"><td class="num" id="LN2508">2508</td><td class="line">    <span class='keyword'>if</span> (flags &amp; <span class='macro'>RESTART_SERVER_GRACEFULLY<span class='macro_popup'>(1&lt;&lt;0)</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2509"><td class="num" id="LN2509">2509</td><td class="line">        prepareForShutdown(<span class='macro'>SHUTDOWN_NOFLAGS<span class='macro_popup'>0</span></span>) != <span class='macro'>C_OK<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2510"><td class="num" id="LN2510">2510</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2511"><td class="num" id="LN2511">2511</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Can't restart: error preparing for shutdown"</span>);</td></tr>
<tr class="codeline" data-linenumber="2512"><td class="num" id="LN2512">2512</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2513"><td class="num" id="LN2513">2513</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2514"><td class="num" id="LN2514">2514</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2515"><td class="num" id="LN2515">2515</td><td class="line">    <span class='comment'>/* Close all file descriptors, with the exception of stdin, stdout, strerr</span></td></tr>
<tr class="codeline" data-linenumber="2516"><td class="num" id="LN2516">2516</td><td class="line">     <span class='comment'>* which are useful if we restart a Redis server which is not daemonized. */</span></td></tr>
<tr class="codeline" data-linenumber="2517"><td class="num" id="LN2517">2517</td><td class="line">    <span class='keyword'>for</span> (j = 3; j &lt; (<span class='keyword'>int</span>)server.maxclients + 1024; j++) {</td></tr>
<tr class="codeline" data-linenumber="2518"><td class="num" id="LN2518">2518</td><td class="line">        <span class='comment'>/* Test the descriptor validity before closing it, otherwise</span></td></tr>
<tr class="codeline" data-linenumber="2519"><td class="num" id="LN2519">2519</td><td class="line">         <span class='comment'>* Valgrind issues a warning on close(). */</span></td></tr>
<tr class="codeline" data-linenumber="2520"><td class="num" id="LN2520">2520</td><td class="line">        <span class='keyword'>if</span> (fcntl(j,<span class='macro'>F_GETFD<span class='macro_popup'>1</span></span>) != -1) close(j);</td></tr>
<tr class="codeline" data-linenumber="2521"><td class="num" id="LN2521">2521</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2522"><td class="num" id="LN2522">2522</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2523"><td class="num" id="LN2523">2523</td><td class="line">    <span class='comment'>/* Execute the server with the original command line. */</span></td></tr>
<tr class="codeline" data-linenumber="2524"><td class="num" id="LN2524">2524</td><td class="line">    <span class='keyword'>if</span> (delay) usleep(delay*1000);</td></tr>
<tr class="codeline" data-linenumber="2525"><td class="num" id="LN2525">2525</td><td class="line">    zfree(server.exec_argv[0]);</td></tr>
<tr class="codeline" data-linenumber="2526"><td class="num" id="LN2526">2526</td><td class="line">    server.exec_argv[0] = zstrdup(server.executable);</td></tr>
<tr class="codeline" data-linenumber="2527"><td class="num" id="LN2527">2527</td><td class="line">    execve(server.executable,server.exec_argv,environ);</td></tr>
<tr class="codeline" data-linenumber="2528"><td class="num" id="LN2528">2528</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2529"><td class="num" id="LN2529">2529</td><td class="line">    <span class='comment'>/* If an error occurred here, there is nothing we can do, but exit. */</span></td></tr>
<tr class="codeline" data-linenumber="2530"><td class="num" id="LN2530">2530</td><td class="line">    _exit(1);</td></tr>
<tr class="codeline" data-linenumber="2531"><td class="num" id="LN2531">2531</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2532"><td class="num" id="LN2532">2532</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>; <span class='comment'>/* Never reached. */</span></td></tr>
<tr class="codeline" data-linenumber="2533"><td class="num" id="LN2533">2533</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2534"><td class="num" id="LN2534">2534</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2535"><td class="num" id="LN2535">2535</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> readOOMScoreAdj(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="2536"><td class="num" id="LN2536">2536</td><td class="line"><span class='directive'>#ifdef <span class='macro'>HAVE_PROC_OOM_SCORE_ADJ<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="2537"><td class="num" id="LN2537">2537</td><td class="line">    <span class='keyword'>char</span> buf[64];</td></tr>
<tr class="codeline" data-linenumber="2538"><td class="num" id="LN2538">2538</td><td class="line">    <span class='keyword'>int</span> fd = open(<span class='string_literal'>"/proc/self/oom_score_adj"</span>, <span class='macro'>O_RDONLY<span class='macro_popup'>00</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2539"><td class="num" id="LN2539">2539</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2540"><td class="num" id="LN2540">2540</td><td class="line">    <span class='keyword'>if</span> (fd &lt; 0) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2541"><td class="num" id="LN2541">2541</td><td class="line">    <span class='keyword'>if</span> (read(fd, buf, <span class='keyword'>sizeof</span>(buf)) &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="2542"><td class="num" id="LN2542">2542</td><td class="line">        server.oom_score_adj_base = atoi(buf);</td></tr>
<tr class="codeline" data-linenumber="2543"><td class="num" id="LN2543">2543</td><td class="line">    close(fd);</td></tr>
<tr class="codeline" data-linenumber="2544"><td class="num" id="LN2544">2544</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2545"><td class="num" id="LN2545">2545</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2546"><td class="num" id="LN2546">2546</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2547"><td class="num" id="LN2547">2547</td><td class="line"><span class='comment'>/* This function will configure the current process's oom_score_adj according</span></td></tr>
<tr class="codeline" data-linenumber="2548"><td class="num" id="LN2548">2548</td><td class="line"> <span class='comment'>* to user specified configuration. This is currently implemented on Linux</span></td></tr>
<tr class="codeline" data-linenumber="2549"><td class="num" id="LN2549">2549</td><td class="line"> <span class='comment'>* only.</span></td></tr>
<tr class="codeline" data-linenumber="2550"><td class="num" id="LN2550">2550</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2551"><td class="num" id="LN2551">2551</td><td class="line"> <span class='comment'>* A process_class value of -1 implies OOM_CONFIG_MASTER or OOM_CONFIG_REPLICA,</span></td></tr>
<tr class="codeline" data-linenumber="2552"><td class="num" id="LN2552">2552</td><td class="line"> <span class='comment'>* depending on current role.</span></td></tr>
<tr class="codeline" data-linenumber="2553"><td class="num" id="LN2553">2553</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2554"><td class="num" id="LN2554">2554</td><td class="line"><span class='keyword'>int</span> setOOMScoreAdj(<span class='keyword'>int</span> process_class) {</td></tr>
<tr class="codeline" data-linenumber="2555"><td class="num" id="LN2555">2555</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2556"><td class="num" id="LN2556">2556</td><td class="line">    <span class='keyword'>if</span> (!server.oom_score_adj) <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2557"><td class="num" id="LN2557">2557</td><td class="line">    <span class='keyword'>if</span> (process_class == -1)</td></tr>
<tr class="codeline" data-linenumber="2558"><td class="num" id="LN2558">2558</td><td class="line">        process_class = (server.masterhost ? <span class='macro'>CONFIG_OOM_REPLICA<span class='macro_popup'>1</span></span> : <span class='macro'>CONFIG_OOM_MASTER<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2559"><td class="num" id="LN2559">2559</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2560"><td class="num" id="LN2560">2560</td><td class="line">    <span class='macro'>serverAssert(process_class &gt;= 0 &amp;&amp; process_class &lt; CONFIG_OOM_COUNT)<span class='macro_popup'>((process_class &gt;= 0 &amp;&amp; process_class &lt; 3)?(void<br>)0 : (_serverAssert("process_class &gt;= 0 &amp;&amp; process_class &lt; CONFIG_OOM_COUNT"<br>,"server.c",2560),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2561"><td class="num" id="LN2561">2561</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2562"><td class="num" id="LN2562">2562</td><td class="line"><span class='directive'>#ifdef <span class='macro'>HAVE_PROC_OOM_SCORE_ADJ<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="2563"><td class="num" id="LN2563">2563</td><td class="line">    <span class='keyword'>int</span> fd;</td></tr>
<tr class="codeline" data-linenumber="2564"><td class="num" id="LN2564">2564</td><td class="line">    <span class='keyword'>int</span> val;</td></tr>
<tr class="codeline" data-linenumber="2565"><td class="num" id="LN2565">2565</td><td class="line">    <span class='keyword'>char</span> buf[64];</td></tr>
<tr class="codeline" data-linenumber="2566"><td class="num" id="LN2566">2566</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2567"><td class="num" id="LN2567">2567</td><td class="line">    val = server.oom_score_adj_base + server.oom_score_adj_values[process_class];</td></tr>
<tr class="codeline" data-linenumber="2568"><td class="num" id="LN2568">2568</td><td class="line">    <span class='keyword'>if</span> (val &gt; 1000) val = 1000;</td></tr>
<tr class="codeline" data-linenumber="2569"><td class="num" id="LN2569">2569</td><td class="line">    <span class='keyword'>if</span> (val &lt; -1000) val = -1000;</td></tr>
<tr class="codeline" data-linenumber="2570"><td class="num" id="LN2570">2570</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2571"><td class="num" id="LN2571">2571</td><td class="line">    snprintf(buf, <span class='keyword'>sizeof</span>(buf) - 1, <span class='string_literal'>"%d\n"</span>, val);</td></tr>
<tr class="codeline" data-linenumber="2572"><td class="num" id="LN2572">2572</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2573"><td class="num" id="LN2573">2573</td><td class="line">    fd = open(<span class='string_literal'>"/proc/self/oom_score_adj"</span>, <span class='macro'>O_WRONLY<span class='macro_popup'>01</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2574"><td class="num" id="LN2574">2574</td><td class="line">    <span class='keyword'>if</span> (fd &lt; 0 || write(fd, buf, strlen(buf)) &lt; 0) {</td></tr>
<tr class="codeline" data-linenumber="2575"><td class="num" id="LN2575">2575</td><td class="line">        serverLog(<span class='macro'>LOG_WARNING<span class='macro_popup'>4</span></span>, <span class='string_literal'>"Unable to write oom_score_adj: %s"</span>, strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="2576"><td class="num" id="LN2576">2576</td><td class="line">        <span class='keyword'>if</span> (fd != -1) close(fd);</td></tr>
<tr class="codeline" data-linenumber="2577"><td class="num" id="LN2577">2577</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2578"><td class="num" id="LN2578">2578</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2579"><td class="num" id="LN2579">2579</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2580"><td class="num" id="LN2580">2580</td><td class="line">    close(fd);</td></tr>
<tr class="codeline" data-linenumber="2581"><td class="num" id="LN2581">2581</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2582"><td class="num" id="LN2582">2582</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="2583"><td class="num" id="LN2583">2583</td><td class="line">    <span class='comment'>/* Unsupported */</span></td></tr>
<tr class="codeline" data-linenumber="2584"><td class="num" id="LN2584">2584</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2585"><td class="num" id="LN2585">2585</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2586"><td class="num" id="LN2586">2586</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2587"><td class="num" id="LN2587">2587</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2588"><td class="num" id="LN2588">2588</td><td class="line"><span class='comment'>/* This function will try to raise the max number of open files accordingly to</span></td></tr>
<tr class="codeline" data-linenumber="2589"><td class="num" id="LN2589">2589</td><td class="line"> <span class='comment'>* the configured max number of clients. It also reserves a number of file</span></td></tr>
<tr class="codeline" data-linenumber="2590"><td class="num" id="LN2590">2590</td><td class="line"> <span class='comment'>* descriptors (CONFIG_MIN_RESERVED_FDS) for extra operations of</span></td></tr>
<tr class="codeline" data-linenumber="2591"><td class="num" id="LN2591">2591</td><td class="line"> <span class='comment'>* persistence, listening sockets, log files and so forth.</span></td></tr>
<tr class="codeline" data-linenumber="2592"><td class="num" id="LN2592">2592</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2593"><td class="num" id="LN2593">2593</td><td class="line"> <span class='comment'>* If it will not be possible to set the limit accordingly to the configured</span></td></tr>
<tr class="codeline" data-linenumber="2594"><td class="num" id="LN2594">2594</td><td class="line"> <span class='comment'>* max number of clients, the function will do the reverse setting</span></td></tr>
<tr class="codeline" data-linenumber="2595"><td class="num" id="LN2595">2595</td><td class="line"> <span class='comment'>* server.maxclients to the value that we can actually handle. */</span></td></tr>
<tr class="codeline" data-linenumber="2596"><td class="num" id="LN2596">2596</td><td class="line"><span class='keyword'>void</span> adjustOpenFilesLimit(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="2597"><td class="num" id="LN2597">2597</td><td class="line">    rlim_t maxfiles = server.maxclients+<span class='macro'>CONFIG_MIN_RESERVED_FDS<span class='macro_popup'>32</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2598"><td class="num" id="LN2598">2598</td><td class="line">    <span class='keyword'>struct</span> rlimit limit;</td></tr>
<tr class="codeline" data-linenumber="2599"><td class="num" id="LN2599">2599</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2600"><td class="num" id="LN2600">2600</td><td class="line">    <span class='keyword'>if</span> (getrlimit(<span class='macro'>RLIMIT_NOFILE<span class='macro_popup'>RLIMIT_NOFILE</span></span>,&amp;limit) == -1) {</td></tr>
<tr class="codeline" data-linenumber="2601"><td class="num" id="LN2601">2601</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Unable to obtain the current NOFILE limit (%s), assuming 1024 and setting the max clients configuration accordingly."</span>,</td></tr>
<tr class="codeline" data-linenumber="2602"><td class="num" id="LN2602">2602</td><td class="line">            strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="2603"><td class="num" id="LN2603">2603</td><td class="line">        server.maxclients = 1024-<span class='macro'>CONFIG_MIN_RESERVED_FDS<span class='macro_popup'>32</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2604"><td class="num" id="LN2604">2604</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2605"><td class="num" id="LN2605">2605</td><td class="line">        rlim_t oldlimit = limit.rlim_cur;</td></tr>
<tr class="codeline" data-linenumber="2606"><td class="num" id="LN2606">2606</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2607"><td class="num" id="LN2607">2607</td><td class="line">        <span class='comment'>/* Set the max number of files if the current limit is not enough</span></td></tr>
<tr class="codeline" data-linenumber="2608"><td class="num" id="LN2608">2608</td><td class="line">         <span class='comment'>* for our needs. */</span></td></tr>
<tr class="codeline" data-linenumber="2609"><td class="num" id="LN2609">2609</td><td class="line">        <span class='keyword'>if</span> (oldlimit &lt; maxfiles) {</td></tr>
<tr class="codeline" data-linenumber="2610"><td class="num" id="LN2610">2610</td><td class="line">            rlim_t bestlimit;</td></tr>
<tr class="codeline" data-linenumber="2611"><td class="num" id="LN2611">2611</td><td class="line">            <span class='keyword'>int</span> setrlimit_error = 0;</td></tr>
<tr class="codeline" data-linenumber="2612"><td class="num" id="LN2612">2612</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2613"><td class="num" id="LN2613">2613</td><td class="line">            <span class='comment'>/* Try to set the file limit to match 'maxfiles' or at least</span></td></tr>
<tr class="codeline" data-linenumber="2614"><td class="num" id="LN2614">2614</td><td class="line">             <span class='comment'>* to the higher value supported less than maxfiles. */</span></td></tr>
<tr class="codeline" data-linenumber="2615"><td class="num" id="LN2615">2615</td><td class="line">            bestlimit = maxfiles;</td></tr>
<tr class="codeline" data-linenumber="2616"><td class="num" id="LN2616">2616</td><td class="line">            <span class='keyword'>while</span>(bestlimit &gt; oldlimit) {</td></tr>
<tr class="codeline" data-linenumber="2617"><td class="num" id="LN2617">2617</td><td class="line">                rlim_t decr_step = 16;</td></tr>
<tr class="codeline" data-linenumber="2618"><td class="num" id="LN2618">2618</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2619"><td class="num" id="LN2619">2619</td><td class="line">                limit.rlim_cur = bestlimit;</td></tr>
<tr class="codeline" data-linenumber="2620"><td class="num" id="LN2620">2620</td><td class="line">                limit.rlim_max = bestlimit;</td></tr>
<tr class="codeline" data-linenumber="2621"><td class="num" id="LN2621">2621</td><td class="line">                <span class='keyword'>if</span> (setrlimit(<span class='macro'>RLIMIT_NOFILE<span class='macro_popup'>RLIMIT_NOFILE</span></span>,&amp;limit) != -1) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2622"><td class="num" id="LN2622">2622</td><td class="line">                setrlimit_error = <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2623"><td class="num" id="LN2623">2623</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2624"><td class="num" id="LN2624">2624</td><td class="line">                <span class='comment'>/* We failed to set file limit to 'bestlimit'. Try with a</span></td></tr>
<tr class="codeline" data-linenumber="2625"><td class="num" id="LN2625">2625</td><td class="line">                 <span class='comment'>* smaller limit decrementing by a few FDs per iteration. */</span></td></tr>
<tr class="codeline" data-linenumber="2626"><td class="num" id="LN2626">2626</td><td class="line">                <span class='keyword'>if</span> (bestlimit &lt; decr_step) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2627"><td class="num" id="LN2627">2627</td><td class="line">                bestlimit -= decr_step;</td></tr>
<tr class="codeline" data-linenumber="2628"><td class="num" id="LN2628">2628</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2629"><td class="num" id="LN2629">2629</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2630"><td class="num" id="LN2630">2630</td><td class="line">            <span class='comment'>/* Assume that the limit we get initially is still valid if</span></td></tr>
<tr class="codeline" data-linenumber="2631"><td class="num" id="LN2631">2631</td><td class="line">             <span class='comment'>* our last try was even lower. */</span></td></tr>
<tr class="codeline" data-linenumber="2632"><td class="num" id="LN2632">2632</td><td class="line">            <span class='keyword'>if</span> (bestlimit &lt; oldlimit) bestlimit = oldlimit;</td></tr>
<tr class="codeline" data-linenumber="2633"><td class="num" id="LN2633">2633</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2634"><td class="num" id="LN2634">2634</td><td class="line">            <span class='keyword'>if</span> (bestlimit &lt; maxfiles) {</td></tr>
<tr class="codeline" data-linenumber="2635"><td class="num" id="LN2635">2635</td><td class="line">                <span class='keyword'>unsigned</span> <span class='keyword'>int</span> old_maxclients = server.maxclients;</td></tr>
<tr class="codeline" data-linenumber="2636"><td class="num" id="LN2636">2636</td><td class="line">                server.maxclients = bestlimit-<span class='macro'>CONFIG_MIN_RESERVED_FDS<span class='macro_popup'>32</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2637"><td class="num" id="LN2637">2637</td><td class="line">                <span class='comment'>/* maxclients is unsigned so may overflow: in order</span></td></tr>
<tr class="codeline" data-linenumber="2638"><td class="num" id="LN2638">2638</td><td class="line">                 <span class='comment'>* to check if maxclients is now logically less than 1</span></td></tr>
<tr class="codeline" data-linenumber="2639"><td class="num" id="LN2639">2639</td><td class="line">                 <span class='comment'>* we test indirectly via bestlimit. */</span></td></tr>
<tr class="codeline" data-linenumber="2640"><td class="num" id="LN2640">2640</td><td class="line">                <span class='keyword'>if</span> (bestlimit &lt;= <span class='macro'>CONFIG_MIN_RESERVED_FDS<span class='macro_popup'>32</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2641"><td class="num" id="LN2641">2641</td><td class="line">                    serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Your current 'ulimit -n' "</span></td></tr>
<tr class="codeline" data-linenumber="2642"><td class="num" id="LN2642">2642</td><td class="line">                        <span class='string_literal'>"of %llu is not enough for the server to start. "</span></td></tr>
<tr class="codeline" data-linenumber="2643"><td class="num" id="LN2643">2643</td><td class="line">                        <span class='string_literal'>"Please increase your open file limit to at least "</span></td></tr>
<tr class="codeline" data-linenumber="2644"><td class="num" id="LN2644">2644</td><td class="line">                        <span class='string_literal'>"%llu. Exiting."</span>,</td></tr>
<tr class="codeline" data-linenumber="2645"><td class="num" id="LN2645">2645</td><td class="line">                        (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>) oldlimit,</td></tr>
<tr class="codeline" data-linenumber="2646"><td class="num" id="LN2646">2646</td><td class="line">                        (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>) maxfiles);</td></tr>
<tr class="codeline" data-linenumber="2647"><td class="num" id="LN2647">2647</td><td class="line">                    exit(1);</td></tr>
<tr class="codeline" data-linenumber="2648"><td class="num" id="LN2648">2648</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2649"><td class="num" id="LN2649">2649</td><td class="line">                serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"You requested maxclients of %d "</span></td></tr>
<tr class="codeline" data-linenumber="2650"><td class="num" id="LN2650">2650</td><td class="line">                    <span class='string_literal'>"requiring at least %llu max file descriptors."</span>,</td></tr>
<tr class="codeline" data-linenumber="2651"><td class="num" id="LN2651">2651</td><td class="line">                    old_maxclients,</td></tr>
<tr class="codeline" data-linenumber="2652"><td class="num" id="LN2652">2652</td><td class="line">                    (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>) maxfiles);</td></tr>
<tr class="codeline" data-linenumber="2653"><td class="num" id="LN2653">2653</td><td class="line">                serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Server can't set maximum open files "</span></td></tr>
<tr class="codeline" data-linenumber="2654"><td class="num" id="LN2654">2654</td><td class="line">                    <span class='string_literal'>"to %llu because of OS error: %s."</span>,</td></tr>
<tr class="codeline" data-linenumber="2655"><td class="num" id="LN2655">2655</td><td class="line">                    (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>) maxfiles, strerror(setrlimit_error));</td></tr>
<tr class="codeline" data-linenumber="2656"><td class="num" id="LN2656">2656</td><td class="line">                serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Current maximum open files is %llu. "</span></td></tr>
<tr class="codeline" data-linenumber="2657"><td class="num" id="LN2657">2657</td><td class="line">                    <span class='string_literal'>"maxclients has been reduced to %d to compensate for "</span></td></tr>
<tr class="codeline" data-linenumber="2658"><td class="num" id="LN2658">2658</td><td class="line">                    <span class='string_literal'>"low ulimit. "</span></td></tr>
<tr class="codeline" data-linenumber="2659"><td class="num" id="LN2659">2659</td><td class="line">                    <span class='string_literal'>"If you need higher maxclients increase 'ulimit -n'."</span>,</td></tr>
<tr class="codeline" data-linenumber="2660"><td class="num" id="LN2660">2660</td><td class="line">                    (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>) bestlimit, server.maxclients);</td></tr>
<tr class="codeline" data-linenumber="2661"><td class="num" id="LN2661">2661</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2662"><td class="num" id="LN2662">2662</td><td class="line">                serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Increased maximum number of open files "</span></td></tr>
<tr class="codeline" data-linenumber="2663"><td class="num" id="LN2663">2663</td><td class="line">                    <span class='string_literal'>"to %llu (it was originally set to %llu)."</span>,</td></tr>
<tr class="codeline" data-linenumber="2664"><td class="num" id="LN2664">2664</td><td class="line">                    (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>) maxfiles,</td></tr>
<tr class="codeline" data-linenumber="2665"><td class="num" id="LN2665">2665</td><td class="line">                    (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>) oldlimit);</td></tr>
<tr class="codeline" data-linenumber="2666"><td class="num" id="LN2666">2666</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2667"><td class="num" id="LN2667">2667</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2668"><td class="num" id="LN2668">2668</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2669"><td class="num" id="LN2669">2669</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2670"><td class="num" id="LN2670">2670</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2671"><td class="num" id="LN2671">2671</td><td class="line"><span class='comment'>/* Check that server.tcp_backlog can be actually enforced in Linux according</span></td></tr>
<tr class="codeline" data-linenumber="2672"><td class="num" id="LN2672">2672</td><td class="line"> <span class='comment'>* to the value of /proc/sys/net/core/somaxconn, or warn about it. */</span></td></tr>
<tr class="codeline" data-linenumber="2673"><td class="num" id="LN2673">2673</td><td class="line"><span class='keyword'>void</span> checkTcpBacklogSettings(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="2674"><td class="num" id="LN2674">2674</td><td class="line"><span class='directive'>#ifdef <span class='macro'>HAVE_PROC_SOMAXCONN<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="2675"><td class="num" id="LN2675">2675</td><td class="line">    FILE *fp = fopen(<span class='string_literal'>"/proc/sys/net/core/somaxconn"</span>,<span class='string_literal'>"r"</span>);</td></tr>
<tr class="codeline" data-linenumber="2676"><td class="num" id="LN2676">2676</td><td class="line">    <span class='keyword'>char</span> buf[1024];</td></tr>
<tr class="codeline" data-linenumber="2677"><td class="num" id="LN2677">2677</td><td class="line">    <span class='keyword'>if</span> (!fp) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2678"><td class="num" id="LN2678">2678</td><td class="line">    <span class='keyword'>if</span> (fgets(buf,<span class='keyword'>sizeof</span>(buf),fp) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2679"><td class="num" id="LN2679">2679</td><td class="line">        <span class='keyword'>int</span> somaxconn = atoi(buf);</td></tr>
<tr class="codeline" data-linenumber="2680"><td class="num" id="LN2680">2680</td><td class="line">        <span class='keyword'>if</span> (somaxconn &gt; 0 &amp;&amp; somaxconn &lt; server.tcp_backlog) {</td></tr>
<tr class="codeline" data-linenumber="2681"><td class="num" id="LN2681">2681</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"WARNING: The TCP backlog setting of %d cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of %d."</span>, server.tcp_backlog, somaxconn);</td></tr>
<tr class="codeline" data-linenumber="2682"><td class="num" id="LN2682">2682</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2683"><td class="num" id="LN2683">2683</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2684"><td class="num" id="LN2684">2684</td><td class="line">    fclose(fp);</td></tr>
<tr class="codeline" data-linenumber="2685"><td class="num" id="LN2685">2685</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="2686"><td class="num" id="LN2686">2686</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2687"><td class="num" id="LN2687">2687</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2688"><td class="num" id="LN2688">2688</td><td class="line"><span class='comment'>/* Initialize a set of file descriptors to listen to the specified 'port'</span></td></tr>
<tr class="codeline" data-linenumber="2689"><td class="num" id="LN2689">2689</td><td class="line"> <span class='comment'>* binding the addresses specified in the Redis server configuration.</span></td></tr>
<tr class="codeline" data-linenumber="2690"><td class="num" id="LN2690">2690</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2691"><td class="num" id="LN2691">2691</td><td class="line"> <span class='comment'>* The listening file descriptors are stored in the integer array 'fds'</span></td></tr>
<tr class="codeline" data-linenumber="2692"><td class="num" id="LN2692">2692</td><td class="line"> <span class='comment'>* and their number is set in '*count'.</span></td></tr>
<tr class="codeline" data-linenumber="2693"><td class="num" id="LN2693">2693</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2694"><td class="num" id="LN2694">2694</td><td class="line"> <span class='comment'>* The addresses to bind are specified in the global server.bindaddr array</span></td></tr>
<tr class="codeline" data-linenumber="2695"><td class="num" id="LN2695">2695</td><td class="line"> <span class='comment'>* and their number is server.bindaddr_count. If the server configuration</span></td></tr>
<tr class="codeline" data-linenumber="2696"><td class="num" id="LN2696">2696</td><td class="line"> <span class='comment'>* contains no specific addresses to bind, this function will try to</span></td></tr>
<tr class="codeline" data-linenumber="2697"><td class="num" id="LN2697">2697</td><td class="line"> <span class='comment'>* bind * (all addresses) for both the IPv4 and IPv6 protocols.</span></td></tr>
<tr class="codeline" data-linenumber="2698"><td class="num" id="LN2698">2698</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2699"><td class="num" id="LN2699">2699</td><td class="line"> <span class='comment'>* On success the function returns C_OK.</span></td></tr>
<tr class="codeline" data-linenumber="2700"><td class="num" id="LN2700">2700</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2701"><td class="num" id="LN2701">2701</td><td class="line"> <span class='comment'>* On error the function returns C_ERR. For the function to be on</span></td></tr>
<tr class="codeline" data-linenumber="2702"><td class="num" id="LN2702">2702</td><td class="line"> <span class='comment'>* error, at least one of the server.bindaddr addresses was</span></td></tr>
<tr class="codeline" data-linenumber="2703"><td class="num" id="LN2703">2703</td><td class="line"> <span class='comment'>* impossible to bind, or no bind addresses were specified in the server</span></td></tr>
<tr class="codeline" data-linenumber="2704"><td class="num" id="LN2704">2704</td><td class="line"> <span class='comment'>* configuration but the function is not able to bind * for at least</span></td></tr>
<tr class="codeline" data-linenumber="2705"><td class="num" id="LN2705">2705</td><td class="line"> <span class='comment'>* one of the IPv4 or IPv6 protocols. */</span></td></tr>
<tr class="codeline" data-linenumber="2706"><td class="num" id="LN2706">2706</td><td class="line"><span class='keyword'>int</span> listenToPort(<span class='keyword'>int</span> port, <span class='keyword'>int</span> *fds, <span class='keyword'>int</span> *count) {</td></tr>
<tr class="codeline" data-linenumber="2707"><td class="num" id="LN2707">2707</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="2708"><td class="num" id="LN2708">2708</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2709"><td class="num" id="LN2709">2709</td><td class="line">    <span class='comment'>/* Force binding of 0.0.0.0 if no bind address is specified, always</span></td></tr>
<tr class="codeline" data-linenumber="2710"><td class="num" id="LN2710">2710</td><td class="line">     <span class='comment'>* entering the loop if j == 0. */</span></td></tr>
<tr class="codeline" data-linenumber="2711"><td class="num" id="LN2711">2711</td><td class="line">    <span class='keyword'>if</span> (server.bindaddr_count == 0) server.bindaddr[0] = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2712"><td class="num" id="LN2712">2712</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; server.bindaddr_count || j == 0; j++) {</td></tr>
<tr class="codeline" data-linenumber="2713"><td class="num" id="LN2713">2713</td><td class="line">        <span class='keyword'>if</span> (server.bindaddr[j] == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2714"><td class="num" id="LN2714">2714</td><td class="line">            <span class='keyword'>int</span> unsupported = 0;</td></tr>
<tr class="codeline" data-linenumber="2715"><td class="num" id="LN2715">2715</td><td class="line">            <span class='comment'>/* Bind * for both IPv6 and IPv4, we enter here only if</span></td></tr>
<tr class="codeline" data-linenumber="2716"><td class="num" id="LN2716">2716</td><td class="line">             <span class='comment'>* server.bindaddr_count == 0. */</span></td></tr>
<tr class="codeline" data-linenumber="2717"><td class="num" id="LN2717">2717</td><td class="line">            fds[*count] = anetTcp6Server(server.neterr,port,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2718"><td class="num" id="LN2718">2718</td><td class="line">                server.tcp_backlog);</td></tr>
<tr class="codeline" data-linenumber="2719"><td class="num" id="LN2719">2719</td><td class="line">            <span class='keyword'>if</span> (fds[*count] != <span class='macro'>ANET_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2720"><td class="num" id="LN2720">2720</td><td class="line">                anetNonBlock(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,fds[*count]);</td></tr>
<tr class="codeline" data-linenumber="2721"><td class="num" id="LN2721">2721</td><td class="line">                (*count)++;</td></tr>
<tr class="codeline" data-linenumber="2722"><td class="num" id="LN2722">2722</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> == <span class='macro'>EAFNOSUPPORT<span class='macro_popup'>97</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2723"><td class="num" id="LN2723">2723</td><td class="line">                unsupported++;</td></tr>
<tr class="codeline" data-linenumber="2724"><td class="num" id="LN2724">2724</td><td class="line">                serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Not listening to IPv6: unsupported"</span>);</td></tr>
<tr class="codeline" data-linenumber="2725"><td class="num" id="LN2725">2725</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2726"><td class="num" id="LN2726">2726</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2727"><td class="num" id="LN2727">2727</td><td class="line">            <span class='keyword'>if</span> (*count == 1 || unsupported) {</td></tr>
<tr class="codeline" data-linenumber="2728"><td class="num" id="LN2728">2728</td><td class="line">                <span class='comment'>/* Bind the IPv4 address as well. */</span></td></tr>
<tr class="codeline" data-linenumber="2729"><td class="num" id="LN2729">2729</td><td class="line">                fds[*count] = anetTcpServer(server.neterr,port,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2730"><td class="num" id="LN2730">2730</td><td class="line">                    server.tcp_backlog);</td></tr>
<tr class="codeline" data-linenumber="2731"><td class="num" id="LN2731">2731</td><td class="line">                <span class='keyword'>if</span> (fds[*count] != <span class='macro'>ANET_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2732"><td class="num" id="LN2732">2732</td><td class="line">                    anetNonBlock(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,fds[*count]);</td></tr>
<tr class="codeline" data-linenumber="2733"><td class="num" id="LN2733">2733</td><td class="line">                    (*count)++;</td></tr>
<tr class="codeline" data-linenumber="2734"><td class="num" id="LN2734">2734</td><td class="line">                } <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> == <span class='macro'>EAFNOSUPPORT<span class='macro_popup'>97</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2735"><td class="num" id="LN2735">2735</td><td class="line">                    unsupported++;</td></tr>
<tr class="codeline" data-linenumber="2736"><td class="num" id="LN2736">2736</td><td class="line">                    serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Not listening to IPv4: unsupported"</span>);</td></tr>
<tr class="codeline" data-linenumber="2737"><td class="num" id="LN2737">2737</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2738"><td class="num" id="LN2738">2738</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2739"><td class="num" id="LN2739">2739</td><td class="line">            <span class='comment'>/* Exit the loop if we were able to bind * on IPv4 and IPv6,</span></td></tr>
<tr class="codeline" data-linenumber="2740"><td class="num" id="LN2740">2740</td><td class="line">             <span class='comment'>* otherwise fds[*count] will be ANET_ERR and we'll print an</span></td></tr>
<tr class="codeline" data-linenumber="2741"><td class="num" id="LN2741">2741</td><td class="line">             <span class='comment'>* error and return to the caller with an error. */</span></td></tr>
<tr class="codeline" data-linenumber="2742"><td class="num" id="LN2742">2742</td><td class="line">            <span class='keyword'>if</span> (*count + unsupported == 2) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2743"><td class="num" id="LN2743">2743</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (strchr(server.bindaddr[j],':')) {</td></tr>
<tr class="codeline" data-linenumber="2744"><td class="num" id="LN2744">2744</td><td class="line">            <span class='comment'>/* Bind IPv6 address. */</span></td></tr>
<tr class="codeline" data-linenumber="2745"><td class="num" id="LN2745">2745</td><td class="line">            fds[*count] = anetTcp6Server(server.neterr,port,server.bindaddr[j],</td></tr>
<tr class="codeline" data-linenumber="2746"><td class="num" id="LN2746">2746</td><td class="line">                server.tcp_backlog);</td></tr>
<tr class="codeline" data-linenumber="2747"><td class="num" id="LN2747">2747</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2748"><td class="num" id="LN2748">2748</td><td class="line">            <span class='comment'>/* Bind IPv4 address. */</span></td></tr>
<tr class="codeline" data-linenumber="2749"><td class="num" id="LN2749">2749</td><td class="line">            fds[*count] = anetTcpServer(server.neterr,port,server.bindaddr[j],</td></tr>
<tr class="codeline" data-linenumber="2750"><td class="num" id="LN2750">2750</td><td class="line">                server.tcp_backlog);</td></tr>
<tr class="codeline" data-linenumber="2751"><td class="num" id="LN2751">2751</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2752"><td class="num" id="LN2752">2752</td><td class="line">        <span class='keyword'>if</span> (fds[*count] == <span class='macro'>ANET_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2753"><td class="num" id="LN2753">2753</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2754"><td class="num" id="LN2754">2754</td><td class="line">                <span class='string_literal'>"Could not create server TCP listening socket %s:%d: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="2755"><td class="num" id="LN2755">2755</td><td class="line">                server.bindaddr[j] ? server.bindaddr[j] : <span class='string_literal'>"*"</span>,</td></tr>
<tr class="codeline" data-linenumber="2756"><td class="num" id="LN2756">2756</td><td class="line">                port, server.neterr);</td></tr>
<tr class="codeline" data-linenumber="2757"><td class="num" id="LN2757">2757</td><td class="line">                <span class='keyword'>if</span> (<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> == <span class='macro'>ENOPROTOOPT<span class='macro_popup'>92</span></span>     || <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> == <span class='macro'>EPROTONOSUPPORT<span class='macro_popup'>93</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="2758"><td class="num" id="LN2758">2758</td><td class="line">                    <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> == <span class='macro'>ESOCKTNOSUPPORT<span class='macro_popup'>94</span></span> || <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> == <span class='macro'>EPFNOSUPPORT<span class='macro_popup'>96</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="2759"><td class="num" id="LN2759">2759</td><td class="line">                    <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> == <span class='macro'>EAFNOSUPPORT<span class='macro_popup'>97</span></span>    || <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> == <span class='macro'>EADDRNOTAVAIL<span class='macro_popup'>99</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2760"><td class="num" id="LN2760">2760</td><td class="line">                    <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2761"><td class="num" id="LN2761">2761</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2762"><td class="num" id="LN2762">2762</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2763"><td class="num" id="LN2763">2763</td><td class="line">        anetNonBlock(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,fds[*count]);</td></tr>
<tr class="codeline" data-linenumber="2764"><td class="num" id="LN2764">2764</td><td class="line">        (*count)++;</td></tr>
<tr class="codeline" data-linenumber="2765"><td class="num" id="LN2765">2765</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2766"><td class="num" id="LN2766">2766</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2767"><td class="num" id="LN2767">2767</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2768"><td class="num" id="LN2768">2768</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2769"><td class="num" id="LN2769">2769</td><td class="line"><span class='comment'>/* Resets the stats that we expose via INFO or other means that we want</span></td></tr>
<tr class="codeline" data-linenumber="2770"><td class="num" id="LN2770">2770</td><td class="line"> <span class='comment'>* to reset via CONFIG RESETSTAT. The function is also used in order to</span></td></tr>
<tr class="codeline" data-linenumber="2771"><td class="num" id="LN2771">2771</td><td class="line"> <span class='comment'>* initialize these fields in initServer() at server startup. */</span></td></tr>
<tr class="codeline" data-linenumber="2772"><td class="num" id="LN2772">2772</td><td class="line"><span class='keyword'>void</span> resetServerStats(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="2773"><td class="num" id="LN2773">2773</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="2774"><td class="num" id="LN2774">2774</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2775"><td class="num" id="LN2775">2775</td><td class="line">    server.stat_numcommands = 0;</td></tr>
<tr class="codeline" data-linenumber="2776"><td class="num" id="LN2776">2776</td><td class="line">    server.stat_numconnections = 0;</td></tr>
<tr class="codeline" data-linenumber="2777"><td class="num" id="LN2777">2777</td><td class="line">    server.stat_expiredkeys = 0;</td></tr>
<tr class="codeline" data-linenumber="2778"><td class="num" id="LN2778">2778</td><td class="line">    server.stat_expired_stale_perc = 0;</td></tr>
<tr class="codeline" data-linenumber="2779"><td class="num" id="LN2779">2779</td><td class="line">    server.stat_expired_time_cap_reached_count = 0;</td></tr>
<tr class="codeline" data-linenumber="2780"><td class="num" id="LN2780">2780</td><td class="line">    server.stat_expire_cycle_time_used = 0;</td></tr>
<tr class="codeline" data-linenumber="2781"><td class="num" id="LN2781">2781</td><td class="line">    server.stat_evictedkeys = 0;</td></tr>
<tr class="codeline" data-linenumber="2782"><td class="num" id="LN2782">2782</td><td class="line">    server.stat_keyspace_misses = 0;</td></tr>
<tr class="codeline" data-linenumber="2783"><td class="num" id="LN2783">2783</td><td class="line">    server.stat_keyspace_hits = 0;</td></tr>
<tr class="codeline" data-linenumber="2784"><td class="num" id="LN2784">2784</td><td class="line">    server.stat_active_defrag_hits = 0;</td></tr>
<tr class="codeline" data-linenumber="2785"><td class="num" id="LN2785">2785</td><td class="line">    server.stat_active_defrag_misses = 0;</td></tr>
<tr class="codeline" data-linenumber="2786"><td class="num" id="LN2786">2786</td><td class="line">    server.stat_active_defrag_key_hits = 0;</td></tr>
<tr class="codeline" data-linenumber="2787"><td class="num" id="LN2787">2787</td><td class="line">    server.stat_active_defrag_key_misses = 0;</td></tr>
<tr class="codeline" data-linenumber="2788"><td class="num" id="LN2788">2788</td><td class="line">    server.stat_active_defrag_scanned = 0;</td></tr>
<tr class="codeline" data-linenumber="2789"><td class="num" id="LN2789">2789</td><td class="line">    server.stat_fork_time = 0;</td></tr>
<tr class="codeline" data-linenumber="2790"><td class="num" id="LN2790">2790</td><td class="line">    server.stat_fork_rate = 0;</td></tr>
<tr class="codeline" data-linenumber="2791"><td class="num" id="LN2791">2791</td><td class="line">    server.stat_rejected_conn = 0;</td></tr>
<tr class="codeline" data-linenumber="2792"><td class="num" id="LN2792">2792</td><td class="line">    server.stat_sync_full = 0;</td></tr>
<tr class="codeline" data-linenumber="2793"><td class="num" id="LN2793">2793</td><td class="line">    server.stat_sync_partial_ok = 0;</td></tr>
<tr class="codeline" data-linenumber="2794"><td class="num" id="LN2794">2794</td><td class="line">    server.stat_sync_partial_err = 0;</td></tr>
<tr class="codeline" data-linenumber="2795"><td class="num" id="LN2795">2795</td><td class="line">    server.stat_io_reads_processed = 0;</td></tr>
<tr class="codeline" data-linenumber="2796"><td class="num" id="LN2796">2796</td><td class="line">    server.stat_total_reads_processed = 0;</td></tr>
<tr class="codeline" data-linenumber="2797"><td class="num" id="LN2797">2797</td><td class="line">    server.stat_io_writes_processed = 0;</td></tr>
<tr class="codeline" data-linenumber="2798"><td class="num" id="LN2798">2798</td><td class="line">    server.stat_total_writes_processed = 0;</td></tr>
<tr class="codeline" data-linenumber="2799"><td class="num" id="LN2799">2799</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; <span class='macro'>STATS_METRIC_COUNT<span class='macro_popup'>3</span></span>; j++) {</td></tr>
<tr class="codeline" data-linenumber="2800"><td class="num" id="LN2800">2800</td><td class="line">        server.inst_metric[j].idx = 0;</td></tr>
<tr class="codeline" data-linenumber="2801"><td class="num" id="LN2801">2801</td><td class="line">        server.inst_metric[j].last_sample_time = mstime();</td></tr>
<tr class="codeline" data-linenumber="2802"><td class="num" id="LN2802">2802</td><td class="line">        server.inst_metric[j].last_sample_count = 0;</td></tr>
<tr class="codeline" data-linenumber="2803"><td class="num" id="LN2803">2803</td><td class="line">        memset(server.inst_metric[j].samples,0,</td></tr>
<tr class="codeline" data-linenumber="2804"><td class="num" id="LN2804">2804</td><td class="line">            <span class='keyword'>sizeof</span>(server.inst_metric[j].samples));</td></tr>
<tr class="codeline" data-linenumber="2805"><td class="num" id="LN2805">2805</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2806"><td class="num" id="LN2806">2806</td><td class="line">    server.stat_net_input_bytes = 0;</td></tr>
<tr class="codeline" data-linenumber="2807"><td class="num" id="LN2807">2807</td><td class="line">    server.stat_net_output_bytes = 0;</td></tr>
<tr class="codeline" data-linenumber="2808"><td class="num" id="LN2808">2808</td><td class="line">    server.stat_unexpected_error_replies = 0;</td></tr>
<tr class="codeline" data-linenumber="2809"><td class="num" id="LN2809">2809</td><td class="line">    server.aof_delayed_fsync = 0;</td></tr>
<tr class="codeline" data-linenumber="2810"><td class="num" id="LN2810">2810</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2811"><td class="num" id="LN2811">2811</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2812"><td class="num" id="LN2812">2812</td><td class="line"><span class='comment'>/* Make the thread killable at any time, so that kill threads functions</span></td></tr>
<tr class="codeline" data-linenumber="2813"><td class="num" id="LN2813">2813</td><td class="line"> <span class='comment'>* can work reliably (default cancelability type is PTHREAD_CANCEL_DEFERRED).</span></td></tr>
<tr class="codeline" data-linenumber="2814"><td class="num" id="LN2814">2814</td><td class="line"> <span class='comment'>* Needed for pthread_cancel used by the fast memory test used by the crash report. */</span></td></tr>
<tr class="codeline" data-linenumber="2815"><td class="num" id="LN2815">2815</td><td class="line"><span class='keyword'>void</span> makeThreadKillable(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="2816"><td class="num" id="LN2816">2816</td><td class="line">    pthread_setcancelstate(<span class='macro'>PTHREAD_CANCEL_ENABLE<span class='macro_popup'>PTHREAD_CANCEL_ENABLE</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2817"><td class="num" id="LN2817">2817</td><td class="line">    pthread_setcanceltype(<span class='macro'>PTHREAD_CANCEL_ASYNCHRONOUS<span class='macro_popup'>PTHREAD_CANCEL_ASYNCHRONOUS</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2818"><td class="num" id="LN2818">2818</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2819"><td class="num" id="LN2819">2819</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2820"><td class="num" id="LN2820">2820</td><td class="line"><span class='keyword'>void</span> initServer(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="2821"><td class="num" id="LN2821">2821</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="2822"><td class="num" id="LN2822">2822</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2823"><td class="num" id="LN2823">2823</td><td class="line">    signal(<span class='macro'>SIGHUP<span class='macro_popup'>1</span></span>, <span class='macro'>SIG_IGN<span class='macro_popup'>((__sighandler_t) 1)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2824"><td class="num" id="LN2824">2824</td><td class="line">    signal(<span class='macro'>SIGPIPE<span class='macro_popup'>13</span></span>, <span class='macro'>SIG_IGN<span class='macro_popup'>((__sighandler_t) 1)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2825"><td class="num" id="LN2825">2825</td><td class="line">    setupSignalHandlers();</td></tr>
<tr class="codeline" data-linenumber="2826"><td class="num" id="LN2826">2826</td><td class="line">    makeThreadKillable();</td></tr>
<tr class="codeline" data-linenumber="2827"><td class="num" id="LN2827">2827</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2828"><td class="num" id="LN2828">2828</td><td class="line">    <span class='keyword'>if</span> (server.syslog_enabled) {</td></tr>
<tr class="codeline" data-linenumber="2829"><td class="num" id="LN2829">2829</td><td class="line">        openlog(server.syslog_ident, <span class='macro'>LOG_PID<span class='macro_popup'>0x01</span></span> | <span class='macro'>LOG_NDELAY<span class='macro_popup'>0x08</span></span> | <span class='macro'>LOG_NOWAIT<span class='macro_popup'>0x10</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2830"><td class="num" id="LN2830">2830</td><td class="line">            server.syslog_facility);</td></tr>
<tr class="codeline" data-linenumber="2831"><td class="num" id="LN2831">2831</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2832"><td class="num" id="LN2832">2832</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2833"><td class="num" id="LN2833">2833</td><td class="line">    <span class='comment'>/* Initialization after setting defaults from the config system. */</span></td></tr>
<tr class="codeline" data-linenumber="2834"><td class="num" id="LN2834">2834</td><td class="line">    server.aof_state = server.aof_enabled ? <span class='macro'>AOF_ON<span class='macro_popup'>1</span></span> : <span class='macro'>AOF_OFF<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2835"><td class="num" id="LN2835">2835</td><td class="line">    server.hz = server.config_hz;</td></tr>
<tr class="codeline" data-linenumber="2836"><td class="num" id="LN2836">2836</td><td class="line">    server.pid = getpid();</td></tr>
<tr class="codeline" data-linenumber="2837"><td class="num" id="LN2837">2837</td><td class="line">    server.in_fork_child = <span class='macro'>CHILD_TYPE_NONE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2838"><td class="num" id="LN2838">2838</td><td class="line">    server.main_thread_id = pthread_self();</td></tr>
<tr class="codeline" data-linenumber="2839"><td class="num" id="LN2839">2839</td><td class="line">    server.current_client = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2840"><td class="num" id="LN2840">2840</td><td class="line">    server.fixed_time_expire = 0;</td></tr>
<tr class="codeline" data-linenumber="2841"><td class="num" id="LN2841">2841</td><td class="line">    server.clients = listCreate();</td></tr>
<tr class="codeline" data-linenumber="2842"><td class="num" id="LN2842">2842</td><td class="line">    server.clients_index = raxNew();</td></tr>
<tr class="codeline" data-linenumber="2843"><td class="num" id="LN2843">2843</td><td class="line">    server.clients_to_close = listCreate();</td></tr>
<tr class="codeline" data-linenumber="2844"><td class="num" id="LN2844">2844</td><td class="line">    server.slaves = listCreate();</td></tr>
<tr class="codeline" data-linenumber="2845"><td class="num" id="LN2845">2845</td><td class="line">    server.monitors = listCreate();</td></tr>
<tr class="codeline" data-linenumber="2846"><td class="num" id="LN2846">2846</td><td class="line">    server.clients_pending_write = listCreate();</td></tr>
<tr class="codeline" data-linenumber="2847"><td class="num" id="LN2847">2847</td><td class="line">    server.clients_pending_read = listCreate();</td></tr>
<tr class="codeline" data-linenumber="2848"><td class="num" id="LN2848">2848</td><td class="line">    server.clients_timeout_table = raxNew();</td></tr>
<tr class="codeline" data-linenumber="2849"><td class="num" id="LN2849">2849</td><td class="line">    server.slaveseldb = -1; <span class='comment'>/* Force to emit the first SELECT command. */</span></td></tr>
<tr class="codeline" data-linenumber="2850"><td class="num" id="LN2850">2850</td><td class="line">    server.unblocked_clients = listCreate();</td></tr>
<tr class="codeline" data-linenumber="2851"><td class="num" id="LN2851">2851</td><td class="line">    server.ready_keys = listCreate();</td></tr>
<tr class="codeline" data-linenumber="2852"><td class="num" id="LN2852">2852</td><td class="line">    server.clients_waiting_acks = listCreate();</td></tr>
<tr class="codeline" data-linenumber="2853"><td class="num" id="LN2853">2853</td><td class="line">    server.get_ack_from_slaves = 0;</td></tr>
<tr class="codeline" data-linenumber="2854"><td class="num" id="LN2854">2854</td><td class="line">    server.clients_paused = 0;</td></tr>
<tr class="codeline" data-linenumber="2855"><td class="num" id="LN2855">2855</td><td class="line">    server.events_processed_while_blocked = 0;</td></tr>
<tr class="codeline" data-linenumber="2856"><td class="num" id="LN2856">2856</td><td class="line">    server.system_memory_size = zmalloc_get_memory_size();</td></tr>
<tr class="codeline" data-linenumber="2857"><td class="num" id="LN2857">2857</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2858"><td class="num" id="LN2858">2858</td><td class="line">    <span class='keyword'>if</span> ((server.tls_port || server.tls_replication || server.tls_cluster)</td></tr>
<tr class="codeline" data-linenumber="2859"><td class="num" id="LN2859">2859</td><td class="line">                &amp;&amp; tlsConfigure(&amp;server.tls_ctx_config) == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2860"><td class="num" id="LN2860">2860</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>, <span class='string_literal'>"Failed to configure TLS. Check logs for more info."</span>);</td></tr>
<tr class="codeline" data-linenumber="2861"><td class="num" id="LN2861">2861</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="2862"><td class="num" id="LN2862">2862</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2863"><td class="num" id="LN2863">2863</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2864"><td class="num" id="LN2864">2864</td><td class="line">    createSharedObjects();</td></tr>
<tr class="codeline" data-linenumber="2865"><td class="num" id="LN2865">2865</td><td class="line">    adjustOpenFilesLimit();</td></tr>
<tr class="codeline" data-linenumber="2866"><td class="num" id="LN2866">2866</td><td class="line">    server.el = aeCreateEventLoop(server.maxclients+<span class='macro'>CONFIG_FDSET_INCR<span class='macro_popup'>(32 +96)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2867"><td class="num" id="LN2867">2867</td><td class="line">    <span class='keyword'>if</span> (server.el == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2868"><td class="num" id="LN2868">2868</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2869"><td class="num" id="LN2869">2869</td><td class="line">            <span class='string_literal'>"Failed creating the event loop. Error message: '%s'"</span>,</td></tr>
<tr class="codeline" data-linenumber="2870"><td class="num" id="LN2870">2870</td><td class="line">            strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="2871"><td class="num" id="LN2871">2871</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="2872"><td class="num" id="LN2872">2872</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2873"><td class="num" id="LN2873">2873</td><td class="line">    server.db = zmalloc(<span class='keyword'>sizeof</span>(redisDb)*server.dbnum);</td></tr>
<tr class="codeline" data-linenumber="2874"><td class="num" id="LN2874">2874</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2875"><td class="num" id="LN2875">2875</td><td class="line">    <span class='comment'>/* Open the TCP listening socket for the user commands. */</span></td></tr>
<tr class="codeline" data-linenumber="2876"><td class="num" id="LN2876">2876</td><td class="line">    <span class='keyword'>if</span> (server.port != 0 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2877"><td class="num" id="LN2877">2877</td><td class="line">        listenToPort(server.port,server.ipfd,&amp;server.ipfd_count) == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2878"><td class="num" id="LN2878">2878</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="2879"><td class="num" id="LN2879">2879</td><td class="line">    <span class='keyword'>if</span> (server.tls_port != 0 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2880"><td class="num" id="LN2880">2880</td><td class="line">        listenToPort(server.tls_port,server.tlsfd,&amp;server.tlsfd_count) == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2881"><td class="num" id="LN2881">2881</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="2882"><td class="num" id="LN2882">2882</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2883"><td class="num" id="LN2883">2883</td><td class="line">    <span class='comment'>/* Open the listening Unix domain socket. */</span></td></tr>
<tr class="codeline" data-linenumber="2884"><td class="num" id="LN2884">2884</td><td class="line">    <span class='keyword'>if</span> (server.unixsocket != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2885"><td class="num" id="LN2885">2885</td><td class="line">        unlink(server.unixsocket); <span class='comment'>/* don't care if this fails */</span></td></tr>
<tr class="codeline" data-linenumber="2886"><td class="num" id="LN2886">2886</td><td class="line">        server.sofd = anetUnixServer(server.neterr,server.unixsocket,</td></tr>
<tr class="codeline" data-linenumber="2887"><td class="num" id="LN2887">2887</td><td class="line">            server.unixsocketperm, server.tcp_backlog);</td></tr>
<tr class="codeline" data-linenumber="2888"><td class="num" id="LN2888">2888</td><td class="line">        <span class='keyword'>if</span> (server.sofd == <span class='macro'>ANET_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2889"><td class="num" id="LN2889">2889</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>, <span class='string_literal'>"Opening Unix socket: %s"</span>, server.neterr);</td></tr>
<tr class="codeline" data-linenumber="2890"><td class="num" id="LN2890">2890</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="2891"><td class="num" id="LN2891">2891</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2892"><td class="num" id="LN2892">2892</td><td class="line">        anetNonBlock(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,server.sofd);</td></tr>
<tr class="codeline" data-linenumber="2893"><td class="num" id="LN2893">2893</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2894"><td class="num" id="LN2894">2894</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2895"><td class="num" id="LN2895">2895</td><td class="line">    <span class='comment'>/* Abort if there are no listening sockets at all. */</span></td></tr>
<tr class="codeline" data-linenumber="2896"><td class="num" id="LN2896">2896</td><td class="line">    <span class='keyword'>if</span> (server.ipfd_count == 0 &amp;&amp; server.tlsfd_count == 0 &amp;&amp; server.sofd &lt; 0) {</td></tr>
<tr class="codeline" data-linenumber="2897"><td class="num" id="LN2897">2897</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>, <span class='string_literal'>"Configured to not listen anywhere, exiting."</span>);</td></tr>
<tr class="codeline" data-linenumber="2898"><td class="num" id="LN2898">2898</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="2899"><td class="num" id="LN2899">2899</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2900"><td class="num" id="LN2900">2900</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2901"><td class="num" id="LN2901">2901</td><td class="line">    <span class='comment'>/* Create the Redis databases, and initialize other internal state. */</span></td></tr>
<tr class="codeline" data-linenumber="2902"><td class="num" id="LN2902">2902</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; server.dbnum; j++) {</td></tr>
<tr class="codeline" data-linenumber="2903"><td class="num" id="LN2903">2903</td><td class="line">        server.db[j].dict = dictCreate(&amp;dbDictType,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2904"><td class="num" id="LN2904">2904</td><td class="line">        server.db[j].expires = dictCreate(&amp;keyptrDictType,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2905"><td class="num" id="LN2905">2905</td><td class="line">        server.db[j].expires_cursor = 0;</td></tr>
<tr class="codeline" data-linenumber="2906"><td class="num" id="LN2906">2906</td><td class="line">        server.db[j].blocking_keys = dictCreate(&amp;keylistDictType,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2907"><td class="num" id="LN2907">2907</td><td class="line">        server.db[j].ready_keys = dictCreate(&amp;objectKeyPointerValueDictType,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2908"><td class="num" id="LN2908">2908</td><td class="line">        server.db[j].watched_keys = dictCreate(&amp;keylistDictType,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2909"><td class="num" id="LN2909">2909</td><td class="line">        server.db[j].id = j;</td></tr>
<tr class="codeline" data-linenumber="2910"><td class="num" id="LN2910">2910</td><td class="line">        server.db[j].avg_ttl = 0;</td></tr>
<tr class="codeline" data-linenumber="2911"><td class="num" id="LN2911">2911</td><td class="line">        server.db[j].defrag_later = listCreate();</td></tr>
<tr class="codeline" data-linenumber="2912"><td class="num" id="LN2912">2912</td><td class="line">        <span class='macro'>listSetFreeMethod(server.db[j].defrag_later,(<span class='keyword'>void</span> (*)(<span class='keyword'>void</span>*))sdsfree)<span class='macro_popup'>((server.db[j].defrag_later)-&gt;free = ((void (*)(void*))sdsfree<br>))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2913"><td class="num" id="LN2913">2913</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2914"><td class="num" id="LN2914">2914</td><td class="line">    evictionPoolAlloc(); <span class='comment'>/* Initialize the LRU keys pool. */</span></td></tr>
<tr class="codeline" data-linenumber="2915"><td class="num" id="LN2915">2915</td><td class="line">    server.pubsub_channels = dictCreate(&amp;keylistDictType,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2916"><td class="num" id="LN2916">2916</td><td class="line">    server.pubsub_patterns = listCreate();</td></tr>
<tr class="codeline" data-linenumber="2917"><td class="num" id="LN2917">2917</td><td class="line">    server.pubsub_patterns_dict = dictCreate(&amp;keylistDictType,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2918"><td class="num" id="LN2918">2918</td><td class="line">    <span class='macro'>listSetFreeMethod(server.pubsub_patterns,freePubsubPattern)<span class='macro_popup'>((server.pubsub_patterns)-&gt;free = (freePubsubPattern))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2919"><td class="num" id="LN2919">2919</td><td class="line">    <span class='macro'>listSetMatchMethod(server.pubsub_patterns,listMatchPubsubPattern)<span class='macro_popup'>((server.pubsub_patterns)-&gt;match = (listMatchPubsubPattern<br>))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2920"><td class="num" id="LN2920">2920</td><td class="line">    server.cronloops = 0;</td></tr>
<tr class="codeline" data-linenumber="2921"><td class="num" id="LN2921">2921</td><td class="line">    server.rdb_child_pid = -1;</td></tr>
<tr class="codeline" data-linenumber="2922"><td class="num" id="LN2922">2922</td><td class="line">    server.aof_child_pid = -1;</td></tr>
<tr class="codeline" data-linenumber="2923"><td class="num" id="LN2923">2923</td><td class="line">    server.module_child_pid = -1;</td></tr>
<tr class="codeline" data-linenumber="2924"><td class="num" id="LN2924">2924</td><td class="line">    server.rdb_child_type = <span class='macro'>RDB_CHILD_TYPE_NONE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2925"><td class="num" id="LN2925">2925</td><td class="line">    server.rdb_pipe_conns = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2926"><td class="num" id="LN2926">2926</td><td class="line">    server.rdb_pipe_numconns = 0;</td></tr>
<tr class="codeline" data-linenumber="2927"><td class="num" id="LN2927">2927</td><td class="line">    server.rdb_pipe_numconns_writing = 0;</td></tr>
<tr class="codeline" data-linenumber="2928"><td class="num" id="LN2928">2928</td><td class="line">    server.rdb_pipe_buff = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2929"><td class="num" id="LN2929">2929</td><td class="line">    server.rdb_pipe_bufflen = 0;</td></tr>
<tr class="codeline" data-linenumber="2930"><td class="num" id="LN2930">2930</td><td class="line">    server.rdb_bgsave_scheduled = 0;</td></tr>
<tr class="codeline" data-linenumber="2931"><td class="num" id="LN2931">2931</td><td class="line">    server.child_info_pipe[0] = -1;</td></tr>
<tr class="codeline" data-linenumber="2932"><td class="num" id="LN2932">2932</td><td class="line">    server.child_info_pipe[1] = -1;</td></tr>
<tr class="codeline" data-linenumber="2933"><td class="num" id="LN2933">2933</td><td class="line">    server.child_info_data.magic = 0;</td></tr>
<tr class="codeline" data-linenumber="2934"><td class="num" id="LN2934">2934</td><td class="line">    aofRewriteBufferReset();</td></tr>
<tr class="codeline" data-linenumber="2935"><td class="num" id="LN2935">2935</td><td class="line">    server.aof_buf = sdsempty();</td></tr>
<tr class="codeline" data-linenumber="2936"><td class="num" id="LN2936">2936</td><td class="line">    server.lastsave = time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>); <span class='comment'>/* At startup we consider the DB saved. */</span></td></tr>
<tr class="codeline" data-linenumber="2937"><td class="num" id="LN2937">2937</td><td class="line">    server.lastbgsave_try = 0;    <span class='comment'>/* At startup we never tried to BGSAVE. */</span></td></tr>
<tr class="codeline" data-linenumber="2938"><td class="num" id="LN2938">2938</td><td class="line">    server.rdb_save_time_last = -1;</td></tr>
<tr class="codeline" data-linenumber="2939"><td class="num" id="LN2939">2939</td><td class="line">    server.rdb_save_time_start = -1;</td></tr>
<tr class="codeline" data-linenumber="2940"><td class="num" id="LN2940">2940</td><td class="line">    server.dirty = 0;</td></tr>
<tr class="codeline" data-linenumber="2941"><td class="num" id="LN2941">2941</td><td class="line">    resetServerStats();</td></tr>
<tr class="codeline" data-linenumber="2942"><td class="num" id="LN2942">2942</td><td class="line">    <span class='comment'>/* A few stats we don't want to reset: server startup time, and peak mem. */</span></td></tr>
<tr class="codeline" data-linenumber="2943"><td class="num" id="LN2943">2943</td><td class="line">    server.stat_starttime = time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2944"><td class="num" id="LN2944">2944</td><td class="line">    server.stat_peak_memory = 0;</td></tr>
<tr class="codeline" data-linenumber="2945"><td class="num" id="LN2945">2945</td><td class="line">    server.stat_rdb_cow_bytes = 0;</td></tr>
<tr class="codeline" data-linenumber="2946"><td class="num" id="LN2946">2946</td><td class="line">    server.stat_aof_cow_bytes = 0;</td></tr>
<tr class="codeline" data-linenumber="2947"><td class="num" id="LN2947">2947</td><td class="line">    server.stat_module_cow_bytes = 0;</td></tr>
<tr class="codeline" data-linenumber="2948"><td class="num" id="LN2948">2948</td><td class="line">    <span class='keyword'>for</span> (<span class='keyword'>int</span> j = 0; j &lt; <span class='macro'>CLIENT_TYPE_COUNT<span class='macro_popup'>4</span></span>; j++)</td></tr>
<tr class="codeline" data-linenumber="2949"><td class="num" id="LN2949">2949</td><td class="line">        server.stat_clients_type_memory[j] = 0;</td></tr>
<tr class="codeline" data-linenumber="2950"><td class="num" id="LN2950">2950</td><td class="line">    server.cron_malloc_stats.zmalloc_used = 0;</td></tr>
<tr class="codeline" data-linenumber="2951"><td class="num" id="LN2951">2951</td><td class="line">    server.cron_malloc_stats.process_rss = 0;</td></tr>
<tr class="codeline" data-linenumber="2952"><td class="num" id="LN2952">2952</td><td class="line">    server.cron_malloc_stats.allocator_allocated = 0;</td></tr>
<tr class="codeline" data-linenumber="2953"><td class="num" id="LN2953">2953</td><td class="line">    server.cron_malloc_stats.allocator_active = 0;</td></tr>
<tr class="codeline" data-linenumber="2954"><td class="num" id="LN2954">2954</td><td class="line">    server.cron_malloc_stats.allocator_resident = 0;</td></tr>
<tr class="codeline" data-linenumber="2955"><td class="num" id="LN2955">2955</td><td class="line">    server.lastbgsave_status = <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2956"><td class="num" id="LN2956">2956</td><td class="line">    server.aof_last_write_status = <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2957"><td class="num" id="LN2957">2957</td><td class="line">    server.aof_last_write_errno = 0;</td></tr>
<tr class="codeline" data-linenumber="2958"><td class="num" id="LN2958">2958</td><td class="line">    server.repl_good_slaves_count = 0;</td></tr>
<tr class="codeline" data-linenumber="2959"><td class="num" id="LN2959">2959</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2960"><td class="num" id="LN2960">2960</td><td class="line">    <span class='comment'>/* Create the timer callback, this is our way to process many background</span></td></tr>
<tr class="codeline" data-linenumber="2961"><td class="num" id="LN2961">2961</td><td class="line">     <span class='comment'>* operations incrementally, like clients timeout, eviction of unaccessed</span></td></tr>
<tr class="codeline" data-linenumber="2962"><td class="num" id="LN2962">2962</td><td class="line">     <span class='comment'>* expired keys and so forth. */</span></td></tr>
<tr class="codeline" data-linenumber="2963"><td class="num" id="LN2963">2963</td><td class="line">    <span class='keyword'>if</span> (aeCreateTimeEvent(server.el, 1, serverCron, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) == <span class='macro'>AE_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2964"><td class="num" id="LN2964">2964</td><td class="line">        <span class='macro'>serverPanic(<span class='string_literal'>"Can't create event loop timers."</span>)<span class='macro_popup'>_serverPanic("server.c",2964,"Can't create event loop timers."<br>),_exit(1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2965"><td class="num" id="LN2965">2965</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="2966"><td class="num" id="LN2966">2966</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2967"><td class="num" id="LN2967">2967</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2968"><td class="num" id="LN2968">2968</td><td class="line">    <span class='comment'>/* Create an event handler for accepting new connections in TCP and Unix</span></td></tr>
<tr class="codeline" data-linenumber="2969"><td class="num" id="LN2969">2969</td><td class="line">     <span class='comment'>* domain sockets. */</span></td></tr>
<tr class="codeline" data-linenumber="2970"><td class="num" id="LN2970">2970</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; server.ipfd_count; j++) {</td></tr>
<tr class="codeline" data-linenumber="2971"><td class="num" id="LN2971">2971</td><td class="line">        <span class='keyword'>if</span> (aeCreateFileEvent(server.el, server.ipfd[j], <span class='macro'>AE_READABLE<span class='macro_popup'>1</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2972"><td class="num" id="LN2972">2972</td><td class="line">            acceptTcpHandler,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) == <span class='macro'>AE_ERR<span class='macro_popup'>-1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2973"><td class="num" id="LN2973">2973</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="2974"><td class="num" id="LN2974">2974</td><td class="line">                <span class='macro'>serverPanic(<span class='macro_popup'>_serverPanic("server.c",2975,"Unrecoverable error creating server.ipfd file event."<br>),_exit(1)</span></span></td></tr>
<tr class="codeline" data-linenumber="2975"><td class="num" id="LN2975">2975</td><td class="line">                    <span class='string_literal'><span class='macro'>"Unrecoverable error creating server.ipfd file event."</span>)<span class='macro_popup'>_serverPanic("server.c",2975,"Unrecoverable error creating server.ipfd file event."<br>),_exit(1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2976"><td class="num" id="LN2976">2976</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2977"><td class="num" id="LN2977">2977</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2978"><td class="num" id="LN2978">2978</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; server.tlsfd_count; j++) {</td></tr>
<tr class="codeline" data-linenumber="2979"><td class="num" id="LN2979">2979</td><td class="line">        <span class='keyword'>if</span> (aeCreateFileEvent(server.el, server.tlsfd[j], <span class='macro'>AE_READABLE<span class='macro_popup'>1</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2980"><td class="num" id="LN2980">2980</td><td class="line">            acceptTLSHandler,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) == <span class='macro'>AE_ERR<span class='macro_popup'>-1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2981"><td class="num" id="LN2981">2981</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="2982"><td class="num" id="LN2982">2982</td><td class="line">                <span class='macro'>serverPanic(<span class='macro_popup'>_serverPanic("server.c",2983,"Unrecoverable error creating server.tlsfd file event."<br>),_exit(1)</span></span></td></tr>
<tr class="codeline" data-linenumber="2983"><td class="num" id="LN2983">2983</td><td class="line">                    <span class='string_literal'><span class='macro'>"Unrecoverable error creating server.tlsfd file event."</span>)<span class='macro_popup'>_serverPanic("server.c",2983,"Unrecoverable error creating server.tlsfd file event."<br>),_exit(1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2984"><td class="num" id="LN2984">2984</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2985"><td class="num" id="LN2985">2985</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2986"><td class="num" id="LN2986">2986</td><td class="line">    <span class='keyword'>if</span> (server.sofd &gt; 0 &amp;&amp; aeCreateFileEvent(server.el,server.sofd,<span class='macro'>AE_READABLE<span class='macro_popup'>1</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2987"><td class="num" id="LN2987">2987</td><td class="line">        acceptUnixHandler,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) == <span class='macro'>AE_ERR<span class='macro_popup'>-1</span></span>) <span class='macro'>serverPanic(<span class='string_literal'>"Unrecoverable error creating server.sofd file event."</span>)<span class='macro_popup'>_serverPanic("server.c",2987,"Unrecoverable error creating server.sofd file event."<br>),_exit(1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2988"><td class="num" id="LN2988">2988</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2989"><td class="num" id="LN2989">2989</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2990"><td class="num" id="LN2990">2990</td><td class="line">    <span class='comment'>/* Register a readable event for the pipe used to awake the event loop</span></td></tr>
<tr class="codeline" data-linenumber="2991"><td class="num" id="LN2991">2991</td><td class="line">     <span class='comment'>* when a blocked client in a module needs attention. */</span></td></tr>
<tr class="codeline" data-linenumber="2992"><td class="num" id="LN2992">2992</td><td class="line">    <span class='keyword'>if</span> (aeCreateFileEvent(server.el, server.module_blocked_pipe[0], <span class='macro'>AE_READABLE<span class='macro_popup'>1</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2993"><td class="num" id="LN2993">2993</td><td class="line">        moduleBlockedClientPipeReadable,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) == <span class='macro'>AE_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2994"><td class="num" id="LN2994">2994</td><td class="line">            <span class='macro'>serverPanic(<span class='macro_popup'>_serverPanic("server.c",2996,"Error registering the readable event for the module "<br> "blocked clients subsystem."),_exit(1)</span></span></td></tr>
<tr class="codeline" data-linenumber="2995"><td class="num" id="LN2995">2995</td><td class="line">                <span class='string_literal'><span class='macro'>"Error registering the readable event for the module "<span class='macro_popup'>_serverPanic("server.c",2996,"Error registering the readable event for the module "<br> "blocked clients subsystem."),_exit(1)</span></span></span></td></tr>
<tr class="codeline" data-linenumber="2996"><td class="num" id="LN2996">2996</td><td class="line">                <span class='string_literal'><span class='macro'>"blocked clients subsystem."</span>)<span class='macro_popup'>_serverPanic("server.c",2996,"Error registering the readable event for the module "<br> "blocked clients subsystem."),_exit(1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2997"><td class="num" id="LN2997">2997</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2998"><td class="num" id="LN2998">2998</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2999"><td class="num" id="LN2999">2999</td><td class="line">    <span class='comment'>/* Register before and after sleep handlers (note this needs to be done</span></td></tr>
<tr class="codeline" data-linenumber="3000"><td class="num" id="LN3000">3000</td><td class="line">     <span class='comment'>* before loading persistence since it is used by processEventsWhileBlocked. */</span></td></tr>
<tr class="codeline" data-linenumber="3001"><td class="num" id="LN3001">3001</td><td class="line">    aeSetBeforeSleepProc(server.el,beforeSleep);</td></tr>
<tr class="codeline" data-linenumber="3002"><td class="num" id="LN3002">3002</td><td class="line">    aeSetAfterSleepProc(server.el,afterSleep);</td></tr>
<tr class="codeline" data-linenumber="3003"><td class="num" id="LN3003">3003</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3004"><td class="num" id="LN3004">3004</td><td class="line">    <span class='comment'>/* Open the AOF file if needed. */</span></td></tr>
<tr class="codeline" data-linenumber="3005"><td class="num" id="LN3005">3005</td><td class="line">    <span class='keyword'>if</span> (server.aof_state == <span class='macro'>AOF_ON<span class='macro_popup'>1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3006"><td class="num" id="LN3006">3006</td><td class="line">        server.aof_fd = open(server.aof_filename,</td></tr>
<tr class="codeline" data-linenumber="3007"><td class="num" id="LN3007">3007</td><td class="line">                               <span class='macro'>O_WRONLY<span class='macro_popup'>01</span></span>|<span class='macro'>O_APPEND<span class='macro_popup'>02000</span></span>|<span class='macro'>O_CREAT<span class='macro_popup'>0100</span></span>,0644);</td></tr>
<tr class="codeline" data-linenumber="3008"><td class="num" id="LN3008">3008</td><td class="line">        <span class='keyword'>if</span> (server.aof_fd == -1) {</td></tr>
<tr class="codeline" data-linenumber="3009"><td class="num" id="LN3009">3009</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>, <span class='string_literal'>"Can't open the append-only file: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="3010"><td class="num" id="LN3010">3010</td><td class="line">                strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="3011"><td class="num" id="LN3011">3011</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="3012"><td class="num" id="LN3012">3012</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3013"><td class="num" id="LN3013">3013</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3014"><td class="num" id="LN3014">3014</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3015"><td class="num" id="LN3015">3015</td><td class="line">    <span class='comment'>/* 32 bit instances are limited to 4GB of address space, so if there is</span></td></tr>
<tr class="codeline" data-linenumber="3016"><td class="num" id="LN3016">3016</td><td class="line">     <span class='comment'>* no explicit limit in the user provided configuration we set a limit</span></td></tr>
<tr class="codeline" data-linenumber="3017"><td class="num" id="LN3017">3017</td><td class="line">     <span class='comment'>* at 3 GB using maxmemory with 'noeviction' policy'. This avoids</span></td></tr>
<tr class="codeline" data-linenumber="3018"><td class="num" id="LN3018">3018</td><td class="line">     <span class='comment'>* useless crashes of the Redis instance for out of memory. */</span></td></tr>
<tr class="codeline" data-linenumber="3019"><td class="num" id="LN3019">3019</td><td class="line">    <span class='keyword'>if</span> (server.arch_bits == 32 &amp;&amp; server.maxmemory == 0) {</td></tr>
<tr class="codeline" data-linenumber="3020"><td class="num" id="LN3020">3020</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Warning: 32 bit instance detected but no memory limit set. Setting 3 GB maxmemory limit with 'noeviction' policy now."</span>);</td></tr>
<tr class="codeline" data-linenumber="3021"><td class="num" id="LN3021">3021</td><td class="line">        server.maxmemory = 3072LL*(1024*1024); <span class='comment'>/* 3 GB */</span></td></tr>
<tr class="codeline" data-linenumber="3022"><td class="num" id="LN3022">3022</td><td class="line">        server.maxmemory_policy = <span class='macro'>MAXMEMORY_NO_EVICTION<span class='macro_popup'>(7&lt;&lt;8)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3023"><td class="num" id="LN3023">3023</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3024"><td class="num" id="LN3024">3024</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3025"><td class="num" id="LN3025">3025</td><td class="line">    <span class='keyword'>if</span> (server.cluster_enabled) clusterInit();</td></tr>
<tr class="codeline" data-linenumber="3026"><td class="num" id="LN3026">3026</td><td class="line">    replicationScriptCacheInit();</td></tr>
<tr class="codeline" data-linenumber="3027"><td class="num" id="LN3027">3027</td><td class="line">    scriptingInit(1);</td></tr>
<tr class="codeline" data-linenumber="3028"><td class="num" id="LN3028">3028</td><td class="line">    slowlogInit();</td></tr>
<tr class="codeline" data-linenumber="3029"><td class="num" id="LN3029">3029</td><td class="line">    latencyMonitorInit();</td></tr>
<tr class="codeline" data-linenumber="3030"><td class="num" id="LN3030">3030</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3031"><td class="num" id="LN3031">3031</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3032"><td class="num" id="LN3032">3032</td><td class="line"><span class='comment'>/* Some steps in server initialization need to be done last (after modules</span></td></tr>
<tr class="codeline" data-linenumber="3033"><td class="num" id="LN3033">3033</td><td class="line"> <span class='comment'>* are loaded).</span></td></tr>
<tr class="codeline" data-linenumber="3034"><td class="num" id="LN3034">3034</td><td class="line"> <span class='comment'>* Specifically, creation of threads due to a race bug in ld.so, in which</span></td></tr>
<tr class="codeline" data-linenumber="3035"><td class="num" id="LN3035">3035</td><td class="line"> <span class='comment'>* Thread Local Storage initialization collides with dlopen call.</span></td></tr>
<tr class="codeline" data-linenumber="3036"><td class="num" id="LN3036">3036</td><td class="line"> <span class='comment'>* see: https://sourceware.org/bugzilla/show_bug.cgi?id=19329 */</span></td></tr>
<tr class="codeline" data-linenumber="3037"><td class="num" id="LN3037">3037</td><td class="line"><span class='keyword'>void</span> InitServerLast() {</td></tr>
<tr class="codeline" data-linenumber="3038"><td class="num" id="LN3038">3038</td><td class="line">    bioInit();</td></tr>
<tr class="codeline" data-linenumber="3039"><td class="num" id="LN3039">3039</td><td class="line">    initThreadedIO();</td></tr>
<tr class="codeline" data-linenumber="3040"><td class="num" id="LN3040">3040</td><td class="line">    set_jemalloc_bg_thread(server.jemalloc_bg_thread);</td></tr>
<tr class="codeline" data-linenumber="3041"><td class="num" id="LN3041">3041</td><td class="line">    server.initial_memory_usage = zmalloc_used_memory();</td></tr>
<tr class="codeline" data-linenumber="3042"><td class="num" id="LN3042">3042</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3043"><td class="num" id="LN3043">3043</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3044"><td class="num" id="LN3044">3044</td><td class="line"><span class='comment'>/* Parse the flags string description 'strflags' and set them to the</span></td></tr>
<tr class="codeline" data-linenumber="3045"><td class="num" id="LN3045">3045</td><td class="line"> <span class='comment'>* command 'c'. If the flags are all valid C_OK is returned, otherwise</span></td></tr>
<tr class="codeline" data-linenumber="3046"><td class="num" id="LN3046">3046</td><td class="line"> <span class='comment'>* C_ERR is returned (yet the recognized flags are set in the command). */</span></td></tr>
<tr class="codeline" data-linenumber="3047"><td class="num" id="LN3047">3047</td><td class="line"><span class='keyword'>int</span> populateCommandTableParseFlags(<span class='keyword'>struct</span> redisCommand *c, <span class='keyword'>char</span> *strflags) {</td></tr>
<tr class="codeline" data-linenumber="3048"><td class="num" id="LN3048">3048</td><td class="line">    <span class='keyword'>int</span> argc;</td></tr>
<tr class="codeline" data-linenumber="3049"><td class="num" id="LN3049">3049</td><td class="line">    sds *argv;</td></tr>
<tr class="codeline" data-linenumber="3050"><td class="num" id="LN3050">3050</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3051"><td class="num" id="LN3051">3051</td><td class="line">    <span class='comment'>/* Split the line into arguments for processing. */</span></td></tr>
<tr class="codeline" data-linenumber="3052"><td class="num" id="LN3052">3052</td><td class="line">    argv = sdssplitargs(strflags,&amp;argc);</td></tr>
<tr class="codeline" data-linenumber="3053"><td class="num" id="LN3053">3053</td><td class="line">    <span class='keyword'>if</span> (argv == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3054"><td class="num" id="LN3054">3054</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3055"><td class="num" id="LN3055">3055</td><td class="line">    <span class='keyword'>for</span> (<span class='keyword'>int</span> j = 0; j &lt; argc; j++) {</td></tr>
<tr class="codeline" data-linenumber="3056"><td class="num" id="LN3056">3056</td><td class="line">        <span class='keyword'>char</span> *flag = argv[j];</td></tr>
<tr class="codeline" data-linenumber="3057"><td class="num" id="LN3057">3057</td><td class="line">        <span class='keyword'>if</span> (!strcasecmp(flag,<span class='string_literal'>"write"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="3058"><td class="num" id="LN3058">3058</td><td class="line">            c-&gt;flags |= <span class='macro'>CMD_WRITE<span class='macro_popup'>(1ULL&lt;&lt;0)</span></span>|<span class='macro'>CMD_CATEGORY_WRITE<span class='macro_popup'>(1ULL&lt;&lt;20)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3059"><td class="num" id="LN3059">3059</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(flag,<span class='string_literal'>"read-only"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="3060"><td class="num" id="LN3060">3060</td><td class="line">            c-&gt;flags |= <span class='macro'>CMD_READONLY<span class='macro_popup'>(1ULL&lt;&lt;1)</span></span>|<span class='macro'>CMD_CATEGORY_READ<span class='macro_popup'>(1ULL&lt;&lt;19)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3061"><td class="num" id="LN3061">3061</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(flag,<span class='string_literal'>"use-memory"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="3062"><td class="num" id="LN3062">3062</td><td class="line">            c-&gt;flags |= <span class='macro'>CMD_DENYOOM<span class='macro_popup'>(1ULL&lt;&lt;2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3063"><td class="num" id="LN3063">3063</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(flag,<span class='string_literal'>"admin"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="3064"><td class="num" id="LN3064">3064</td><td class="line">            c-&gt;flags |= <span class='macro'>CMD_ADMIN<span class='macro_popup'>(1ULL&lt;&lt;4)</span></span>|<span class='macro'>CMD_CATEGORY_ADMIN<span class='macro_popup'>(1ULL&lt;&lt;31)</span></span>|<span class='macro'>CMD_CATEGORY_DANGEROUS<span class='macro_popup'>(1ULL&lt;&lt;35)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3065"><td class="num" id="LN3065">3065</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(flag,<span class='string_literal'>"pub-sub"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="3066"><td class="num" id="LN3066">3066</td><td class="line">            c-&gt;flags |= <span class='macro'>CMD_PUBSUB<span class='macro_popup'>(1ULL&lt;&lt;5)</span></span>|<span class='macro'>CMD_CATEGORY_PUBSUB<span class='macro_popup'>(1ULL&lt;&lt;30)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3067"><td class="num" id="LN3067">3067</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(flag,<span class='string_literal'>"no-script"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="3068"><td class="num" id="LN3068">3068</td><td class="line">            c-&gt;flags |= <span class='macro'>CMD_NOSCRIPT<span class='macro_popup'>(1ULL&lt;&lt;6)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3069"><td class="num" id="LN3069">3069</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(flag,<span class='string_literal'>"random"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="3070"><td class="num" id="LN3070">3070</td><td class="line">            c-&gt;flags |= <span class='macro'>CMD_RANDOM<span class='macro_popup'>(1ULL&lt;&lt;7)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3071"><td class="num" id="LN3071">3071</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(flag,<span class='string_literal'>"to-sort"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="3072"><td class="num" id="LN3072">3072</td><td class="line">            c-&gt;flags |= <span class='macro'>CMD_SORT_FOR_SCRIPT<span class='macro_popup'>(1ULL&lt;&lt;8)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3073"><td class="num" id="LN3073">3073</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(flag,<span class='string_literal'>"ok-loading"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="3074"><td class="num" id="LN3074">3074</td><td class="line">            c-&gt;flags |= <span class='macro'>CMD_LOADING<span class='macro_popup'>(1ULL&lt;&lt;9)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3075"><td class="num" id="LN3075">3075</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(flag,<span class='string_literal'>"ok-stale"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="3076"><td class="num" id="LN3076">3076</td><td class="line">            c-&gt;flags |= <span class='macro'>CMD_STALE<span class='macro_popup'>(1ULL&lt;&lt;10)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3077"><td class="num" id="LN3077">3077</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(flag,<span class='string_literal'>"no-monitor"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="3078"><td class="num" id="LN3078">3078</td><td class="line">            c-&gt;flags |= <span class='macro'>CMD_SKIP_MONITOR<span class='macro_popup'>(1ULL&lt;&lt;11)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3079"><td class="num" id="LN3079">3079</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(flag,<span class='string_literal'>"no-slowlog"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="3080"><td class="num" id="LN3080">3080</td><td class="line">            c-&gt;flags |= <span class='macro'>CMD_SKIP_SLOWLOG<span class='macro_popup'>(1ULL&lt;&lt;12)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3081"><td class="num" id="LN3081">3081</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(flag,<span class='string_literal'>"cluster-asking"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="3082"><td class="num" id="LN3082">3082</td><td class="line">            c-&gt;flags |= <span class='macro'>CMD_ASKING<span class='macro_popup'>(1ULL&lt;&lt;13)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3083"><td class="num" id="LN3083">3083</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(flag,<span class='string_literal'>"fast"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="3084"><td class="num" id="LN3084">3084</td><td class="line">            c-&gt;flags |= <span class='macro'>CMD_FAST<span class='macro_popup'>(1ULL&lt;&lt;14)</span></span> | <span class='macro'>CMD_CATEGORY_FAST<span class='macro_popup'>(1ULL&lt;&lt;32)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3085"><td class="num" id="LN3085">3085</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(flag,<span class='string_literal'>"no-auth"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="3086"><td class="num" id="LN3086">3086</td><td class="line">            c-&gt;flags |= <span class='macro'>CMD_NO_AUTH<span class='macro_popup'>(1ULL&lt;&lt;15)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3087"><td class="num" id="LN3087">3087</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3088"><td class="num" id="LN3088">3088</td><td class="line">            <span class='comment'>/* Parse ACL categories here if the flag name starts with @. */</span></td></tr>
<tr class="codeline" data-linenumber="3089"><td class="num" id="LN3089">3089</td><td class="line">            uint64_t catflag;</td></tr>
<tr class="codeline" data-linenumber="3090"><td class="num" id="LN3090">3090</td><td class="line">            <span class='keyword'>if</span> (flag[0] == '@' &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3091"><td class="num" id="LN3091">3091</td><td class="line">                (catflag = ACLGetCommandCategoryFlagByName(flag+1)) != 0)</td></tr>
<tr class="codeline" data-linenumber="3092"><td class="num" id="LN3092">3092</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="3093"><td class="num" id="LN3093">3093</td><td class="line">                c-&gt;flags |= catflag;</td></tr>
<tr class="codeline" data-linenumber="3094"><td class="num" id="LN3094">3094</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3095"><td class="num" id="LN3095">3095</td><td class="line">                sdsfreesplitres(argv,argc);</td></tr>
<tr class="codeline" data-linenumber="3096"><td class="num" id="LN3096">3096</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3097"><td class="num" id="LN3097">3097</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3098"><td class="num" id="LN3098">3098</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3099"><td class="num" id="LN3099">3099</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3100"><td class="num" id="LN3100">3100</td><td class="line">    <span class='comment'>/* If it's not @fast is @slow in this binary world. */</span></td></tr>
<tr class="codeline" data-linenumber="3101"><td class="num" id="LN3101">3101</td><td class="line">    <span class='keyword'>if</span> (!(c-&gt;flags &amp; <span class='macro'>CMD_CATEGORY_FAST<span class='macro_popup'>(1ULL&lt;&lt;32)</span></span>)) c-&gt;flags |= <span class='macro'>CMD_CATEGORY_SLOW<span class='macro_popup'>(1ULL&lt;&lt;33)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3102"><td class="num" id="LN3102">3102</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3103"><td class="num" id="LN3103">3103</td><td class="line">    sdsfreesplitres(argv,argc);</td></tr>
<tr class="codeline" data-linenumber="3104"><td class="num" id="LN3104">3104</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3105"><td class="num" id="LN3105">3105</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3106"><td class="num" id="LN3106">3106</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3107"><td class="num" id="LN3107">3107</td><td class="line"><span class='comment'>/* Populates the Redis Command Table starting from the hard coded list</span></td></tr>
<tr class="codeline" data-linenumber="3108"><td class="num" id="LN3108">3108</td><td class="line"> <span class='comment'>* we have on top of server.c file. */</span></td></tr>
<tr class="codeline" data-linenumber="3109"><td class="num" id="LN3109">3109</td><td class="line"><span class='keyword'>void</span> populateCommandTable(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="3110"><td class="num" id="LN3110">3110</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="3111"><td class="num" id="LN3111">3111</td><td class="line">    <span class='keyword'>int</span> numcommands = <span class='keyword'>sizeof</span>(redisCommandTable)/<span class='keyword'>sizeof</span>(<span class='keyword'>struct</span> redisCommand);</td></tr>
<tr class="codeline" data-linenumber="3112"><td class="num" id="LN3112">3112</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3113"><td class="num" id="LN3113">3113</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; numcommands; j++) {</td></tr>
<tr class="codeline" data-linenumber="3114"><td class="num" id="LN3114">3114</td><td class="line">        <span class='keyword'>struct</span> redisCommand *c = redisCommandTable+j;</td></tr>
<tr class="codeline" data-linenumber="3115"><td class="num" id="LN3115">3115</td><td class="line">        <span class='keyword'>int</span> retval1, retval2;</td></tr>
<tr class="codeline" data-linenumber="3116"><td class="num" id="LN3116">3116</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3117"><td class="num" id="LN3117">3117</td><td class="line">        <span class='comment'>/* Translate the command string flags description into an actual</span></td></tr>
<tr class="codeline" data-linenumber="3118"><td class="num" id="LN3118">3118</td><td class="line">         <span class='comment'>* set of flags. */</span></td></tr>
<tr class="codeline" data-linenumber="3119"><td class="num" id="LN3119">3119</td><td class="line">        <span class='keyword'>if</span> (populateCommandTableParseFlags(c,c-&gt;sflags) == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3120"><td class="num" id="LN3120">3120</td><td class="line">            <span class='macro'>serverPanic(<span class='string_literal'>"Unsupported command flag"</span>)<span class='macro_popup'>_serverPanic("server.c",3120,"Unsupported command flag"),_exit<br>(1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3121"><td class="num" id="LN3121">3121</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3122"><td class="num" id="LN3122">3122</td><td class="line">        c-&gt;id = ACLGetCommandID(c-&gt;name); <span class='comment'>/* Assign the ID used for ACL. */</span></td></tr>
<tr class="codeline" data-linenumber="3123"><td class="num" id="LN3123">3123</td><td class="line">        retval1 = dictAdd(server.commands, sdsnew(c-&gt;name), c);</td></tr>
<tr class="codeline" data-linenumber="3124"><td class="num" id="LN3124">3124</td><td class="line">        <span class='comment'>/* Populate an additional dictionary that will be unaffected</span></td></tr>
<tr class="codeline" data-linenumber="3125"><td class="num" id="LN3125">3125</td><td class="line">         <span class='comment'>* by rename-command statements in redis.conf. */</span></td></tr>
<tr class="codeline" data-linenumber="3126"><td class="num" id="LN3126">3126</td><td class="line">        retval2 = dictAdd(server.orig_commands, sdsnew(c-&gt;name), c);</td></tr>
<tr class="codeline" data-linenumber="3127"><td class="num" id="LN3127">3127</td><td class="line">        <span class='macro'>serverAssert(retval1 == DICT_OK &amp;&amp; retval2 == DICT_OK)<span class='macro_popup'>((retval1 == 0 &amp;&amp; retval2 == 0)?(void)0 : (_serverAssert<br>("retval1 == DICT_OK &amp;&amp; retval2 == DICT_OK","server.c"<br>,3127),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3128"><td class="num" id="LN3128">3128</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3129"><td class="num" id="LN3129">3129</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3130"><td class="num" id="LN3130">3130</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3131"><td class="num" id="LN3131">3131</td><td class="line"><span class='keyword'>void</span> resetCommandTableStats(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="3132"><td class="num" id="LN3132">3132</td><td class="line">    <span class='keyword'>struct</span> redisCommand *c;</td></tr>
<tr class="codeline" data-linenumber="3133"><td class="num" id="LN3133">3133</td><td class="line">    dictEntry *de;</td></tr>
<tr class="codeline" data-linenumber="3134"><td class="num" id="LN3134">3134</td><td class="line">    dictIterator *di;</td></tr>
<tr class="codeline" data-linenumber="3135"><td class="num" id="LN3135">3135</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3136"><td class="num" id="LN3136">3136</td><td class="line">    di = dictGetSafeIterator(server.commands);</td></tr>
<tr class="codeline" data-linenumber="3137"><td class="num" id="LN3137">3137</td><td class="line">    <span class='keyword'>while</span>((de = dictNext(di)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3138"><td class="num" id="LN3138">3138</td><td class="line">        c = (<span class='keyword'>struct</span> redisCommand *) <span class='macro'>dictGetVal(de)<span class='macro_popup'>((de)-&gt;v.val)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3139"><td class="num" id="LN3139">3139</td><td class="line">        c-&gt;microseconds = 0;</td></tr>
<tr class="codeline" data-linenumber="3140"><td class="num" id="LN3140">3140</td><td class="line">        c-&gt;calls = 0;</td></tr>
<tr class="codeline" data-linenumber="3141"><td class="num" id="LN3141">3141</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3142"><td class="num" id="LN3142">3142</td><td class="line">    dictReleaseIterator(di);</td></tr>
<tr class="codeline" data-linenumber="3143"><td class="num" id="LN3143">3143</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3144"><td class="num" id="LN3144">3144</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3145"><td class="num" id="LN3145">3145</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3146"><td class="num" id="LN3146">3146</td><td class="line"><span class='comment'>/* ========================== Redis OP Array API ============================ */</span></td></tr>
<tr class="codeline" data-linenumber="3147"><td class="num" id="LN3147">3147</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3148"><td class="num" id="LN3148">3148</td><td class="line"><span class='keyword'>void</span> redisOpArrayInit(redisOpArray *oa) {</td></tr>
<tr class="codeline" data-linenumber="3149"><td class="num" id="LN3149">3149</td><td class="line">    oa-&gt;ops = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3150"><td class="num" id="LN3150">3150</td><td class="line">    oa-&gt;numops = 0;</td></tr>
<tr class="codeline" data-linenumber="3151"><td class="num" id="LN3151">3151</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3152"><td class="num" id="LN3152">3152</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3153"><td class="num" id="LN3153">3153</td><td class="line"><span class='keyword'>int</span> redisOpArrayAppend(redisOpArray *oa, <span class='keyword'>struct</span> redisCommand *cmd, <span class='keyword'>int</span> dbid,</td></tr>
<tr class="codeline" data-linenumber="3154"><td class="num" id="LN3154">3154</td><td class="line">                       robj **argv, <span class='keyword'>int</span> argc, <span class='keyword'>int</span> target)</td></tr>
<tr class="codeline" data-linenumber="3155"><td class="num" id="LN3155">3155</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3156"><td class="num" id="LN3156">3156</td><td class="line">    redisOp *op;</td></tr>
<tr class="codeline" data-linenumber="3157"><td class="num" id="LN3157">3157</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3158"><td class="num" id="LN3158">3158</td><td class="line">    oa-&gt;ops = zrealloc(oa-&gt;ops,<span class='keyword'>sizeof</span>(redisOp)*(oa-&gt;numops+1));</td></tr>
<tr class="codeline" data-linenumber="3159"><td class="num" id="LN3159">3159</td><td class="line">    op = oa-&gt;ops+oa-&gt;numops;</td></tr>
<tr class="codeline" data-linenumber="3160"><td class="num" id="LN3160">3160</td><td class="line">    op-&gt;cmd = cmd;</td></tr>
<tr class="codeline" data-linenumber="3161"><td class="num" id="LN3161">3161</td><td class="line">    op-&gt;dbid = dbid;</td></tr>
<tr class="codeline" data-linenumber="3162"><td class="num" id="LN3162">3162</td><td class="line">    op-&gt;argv = argv;</td></tr>
<tr class="codeline" data-linenumber="3163"><td class="num" id="LN3163">3163</td><td class="line">    op-&gt;argc = argc;</td></tr>
<tr class="codeline" data-linenumber="3164"><td class="num" id="LN3164">3164</td><td class="line">    op-&gt;target = target;</td></tr>
<tr class="codeline" data-linenumber="3165"><td class="num" id="LN3165">3165</td><td class="line">    oa-&gt;numops++;</td></tr>
<tr class="codeline" data-linenumber="3166"><td class="num" id="LN3166">3166</td><td class="line">    <span class='keyword'>return</span> oa-&gt;numops;</td></tr>
<tr class="codeline" data-linenumber="3167"><td class="num" id="LN3167">3167</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3168"><td class="num" id="LN3168">3168</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3169"><td class="num" id="LN3169">3169</td><td class="line"><span class='keyword'>void</span> redisOpArrayFree(redisOpArray *oa) {</td></tr>
<tr class="codeline" data-linenumber="3170"><td class="num" id="LN3170">3170</td><td class="line">    <span class='keyword'>while</span>(oa-&gt;numops) {</td></tr>
<tr class="codeline" data-linenumber="3171"><td class="num" id="LN3171">3171</td><td class="line">        <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="3172"><td class="num" id="LN3172">3172</td><td class="line">        redisOp *op;</td></tr>
<tr class="codeline" data-linenumber="3173"><td class="num" id="LN3173">3173</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3174"><td class="num" id="LN3174">3174</td><td class="line">        oa-&gt;numops--;</td></tr>
<tr class="codeline" data-linenumber="3175"><td class="num" id="LN3175">3175</td><td class="line">        op = oa-&gt;ops+oa-&gt;numops;</td></tr>
<tr class="codeline" data-linenumber="3176"><td class="num" id="LN3176">3176</td><td class="line">        <span class='keyword'>for</span> (j = 0; j &lt; op-&gt;argc; j++)</td></tr>
<tr class="codeline" data-linenumber="3177"><td class="num" id="LN3177">3177</td><td class="line">            decrRefCount(op-&gt;argv[j]);</td></tr>
<tr class="codeline" data-linenumber="3178"><td class="num" id="LN3178">3178</td><td class="line">        zfree(op-&gt;argv);</td></tr>
<tr class="codeline" data-linenumber="3179"><td class="num" id="LN3179">3179</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3180"><td class="num" id="LN3180">3180</td><td class="line">    zfree(oa-&gt;ops);</td></tr>
<tr class="codeline" data-linenumber="3181"><td class="num" id="LN3181">3181</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3182"><td class="num" id="LN3182">3182</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3183"><td class="num" id="LN3183">3183</td><td class="line"><span class='comment'>/* ====================== Commands lookup and execution ===================== */</span></td></tr>
<tr class="codeline" data-linenumber="3184"><td class="num" id="LN3184">3184</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3185"><td class="num" id="LN3185">3185</td><td class="line"><span class='keyword'>struct</span> redisCommand *lookupCommand(sds name) {</td></tr>
<tr class="codeline" data-linenumber="3186"><td class="num" id="LN3186">3186</td><td class="line">    <span class='keyword'>return</span> dictFetchValue(server.commands, name);</td></tr>
<tr class="codeline" data-linenumber="3187"><td class="num" id="LN3187">3187</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3188"><td class="num" id="LN3188">3188</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3189"><td class="num" id="LN3189">3189</td><td class="line"><span class='keyword'>struct</span> redisCommand *lookupCommandByCString(<span class='keyword'>const</span> <span class='keyword'>char</span> *s) {</td></tr>
<tr class="codeline" data-linenumber="3190"><td class="num" id="LN3190">3190</td><td class="line">    <span class='keyword'>struct</span> redisCommand *cmd;</td></tr>
<tr class="codeline" data-linenumber="3191"><td class="num" id="LN3191">3191</td><td class="line">    sds name = sdsnew(s);</td></tr>
<tr class="codeline" data-linenumber="3192"><td class="num" id="LN3192">3192</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3193"><td class="num" id="LN3193">3193</td><td class="line">    cmd = dictFetchValue(server.commands, name);</td></tr>
<tr class="codeline" data-linenumber="3194"><td class="num" id="LN3194">3194</td><td class="line">    sdsfree(name);</td></tr>
<tr class="codeline" data-linenumber="3195"><td class="num" id="LN3195">3195</td><td class="line">    <span class='keyword'>return</span> cmd;</td></tr>
<tr class="codeline" data-linenumber="3196"><td class="num" id="LN3196">3196</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3197"><td class="num" id="LN3197">3197</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3198"><td class="num" id="LN3198">3198</td><td class="line"><span class='comment'>/* Lookup the command in the current table, if not found also check in</span></td></tr>
<tr class="codeline" data-linenumber="3199"><td class="num" id="LN3199">3199</td><td class="line"> <span class='comment'>* the original table containing the original command names unaffected by</span></td></tr>
<tr class="codeline" data-linenumber="3200"><td class="num" id="LN3200">3200</td><td class="line"> <span class='comment'>* redis.conf rename-command statement.</span></td></tr>
<tr class="codeline" data-linenumber="3201"><td class="num" id="LN3201">3201</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3202"><td class="num" id="LN3202">3202</td><td class="line"> <span class='comment'>* This is used by functions rewriting the argument vector such as</span></td></tr>
<tr class="codeline" data-linenumber="3203"><td class="num" id="LN3203">3203</td><td class="line"> <span class='comment'>* rewriteClientCommandVector() in order to set client-&gt;cmd pointer</span></td></tr>
<tr class="codeline" data-linenumber="3204"><td class="num" id="LN3204">3204</td><td class="line"> <span class='comment'>* correctly even if the command was renamed. */</span></td></tr>
<tr class="codeline" data-linenumber="3205"><td class="num" id="LN3205">3205</td><td class="line"><span class='keyword'>struct</span> redisCommand *lookupCommandOrOriginal(sds name) {</td></tr>
<tr class="codeline" data-linenumber="3206"><td class="num" id="LN3206">3206</td><td class="line">    <span class='keyword'>struct</span> redisCommand *cmd = dictFetchValue(server.commands, name);</td></tr>
<tr class="codeline" data-linenumber="3207"><td class="num" id="LN3207">3207</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3208"><td class="num" id="LN3208">3208</td><td class="line">    <span class='keyword'>if</span> (!cmd) cmd = dictFetchValue(server.orig_commands,name);</td></tr>
<tr class="codeline" data-linenumber="3209"><td class="num" id="LN3209">3209</td><td class="line">    <span class='keyword'>return</span> cmd;</td></tr>
<tr class="codeline" data-linenumber="3210"><td class="num" id="LN3210">3210</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3211"><td class="num" id="LN3211">3211</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3212"><td class="num" id="LN3212">3212</td><td class="line"><span class='comment'>/* Propagate the specified command (in the context of the specified database id)</span></td></tr>
<tr class="codeline" data-linenumber="3213"><td class="num" id="LN3213">3213</td><td class="line"> <span class='comment'>* to AOF and Slaves.</span></td></tr>
<tr class="codeline" data-linenumber="3214"><td class="num" id="LN3214">3214</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3215"><td class="num" id="LN3215">3215</td><td class="line"> <span class='comment'>* flags are an xor between:</span></td></tr>
<tr class="codeline" data-linenumber="3216"><td class="num" id="LN3216">3216</td><td class="line"> <span class='comment'>* + PROPAGATE_NONE (no propagation of command at all)</span></td></tr>
<tr class="codeline" data-linenumber="3217"><td class="num" id="LN3217">3217</td><td class="line"> <span class='comment'>* + PROPAGATE_AOF (propagate into the AOF file if is enabled)</span></td></tr>
<tr class="codeline" data-linenumber="3218"><td class="num" id="LN3218">3218</td><td class="line"> <span class='comment'>* + PROPAGATE_REPL (propagate into the replication link)</span></td></tr>
<tr class="codeline" data-linenumber="3219"><td class="num" id="LN3219">3219</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3220"><td class="num" id="LN3220">3220</td><td class="line"> <span class='comment'>* This should not be used inside commands implementation since it will not</span></td></tr>
<tr class="codeline" data-linenumber="3221"><td class="num" id="LN3221">3221</td><td class="line"> <span class='comment'>* wrap the resulting commands in MULTI/EXEC. Use instead alsoPropagate(),</span></td></tr>
<tr class="codeline" data-linenumber="3222"><td class="num" id="LN3222">3222</td><td class="line"> <span class='comment'>* preventCommandPropagation(), forceCommandPropagation().</span></td></tr>
<tr class="codeline" data-linenumber="3223"><td class="num" id="LN3223">3223</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3224"><td class="num" id="LN3224">3224</td><td class="line"> <span class='comment'>* However for functions that need to (also) propagate out of the context of a</span></td></tr>
<tr class="codeline" data-linenumber="3225"><td class="num" id="LN3225">3225</td><td class="line"> <span class='comment'>* command execution, for example when serving a blocked client, you</span></td></tr>
<tr class="codeline" data-linenumber="3226"><td class="num" id="LN3226">3226</td><td class="line"> <span class='comment'>* want to use propagate().</span></td></tr>
<tr class="codeline" data-linenumber="3227"><td class="num" id="LN3227">3227</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3228"><td class="num" id="LN3228">3228</td><td class="line"><span class='keyword'>void</span> propagate(<span class='keyword'>struct</span> redisCommand *cmd, <span class='keyword'>int</span> dbid, robj **argv, <span class='keyword'>int</span> argc,</td></tr>
<tr class="codeline" data-linenumber="3229"><td class="num" id="LN3229">3229</td><td class="line">               <span class='keyword'>int</span> flags)</td></tr>
<tr class="codeline" data-linenumber="3230"><td class="num" id="LN3230">3230</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3231"><td class="num" id="LN3231">3231</td><td class="line">    <span class='keyword'>if</span> (server.aof_state != <span class='macro'>AOF_OFF<span class='macro_popup'>0</span></span> &amp;&amp; flags &amp; <span class='macro'>PROPAGATE_AOF<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3232"><td class="num" id="LN3232">3232</td><td class="line">        feedAppendOnlyFile(cmd,dbid,argv,argc);</td></tr>
<tr class="codeline" data-linenumber="3233"><td class="num" id="LN3233">3233</td><td class="line">    <span class='keyword'>if</span> (flags &amp; <span class='macro'>PROPAGATE_REPL<span class='macro_popup'>2</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3234"><td class="num" id="LN3234">3234</td><td class="line">        replicationFeedSlaves(server.slaves,dbid,argv,argc);</td></tr>
<tr class="codeline" data-linenumber="3235"><td class="num" id="LN3235">3235</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3236"><td class="num" id="LN3236">3236</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3237"><td class="num" id="LN3237">3237</td><td class="line"><span class='comment'>/* Used inside commands to schedule the propagation of additional commands</span></td></tr>
<tr class="codeline" data-linenumber="3238"><td class="num" id="LN3238">3238</td><td class="line"> <span class='comment'>* after the current command is propagated to AOF / Replication.</span></td></tr>
<tr class="codeline" data-linenumber="3239"><td class="num" id="LN3239">3239</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3240"><td class="num" id="LN3240">3240</td><td class="line"> <span class='comment'>* 'cmd' must be a pointer to the Redis command to replicate, dbid is the</span></td></tr>
<tr class="codeline" data-linenumber="3241"><td class="num" id="LN3241">3241</td><td class="line"> <span class='comment'>* database ID the command should be propagated into.</span></td></tr>
<tr class="codeline" data-linenumber="3242"><td class="num" id="LN3242">3242</td><td class="line"> <span class='comment'>* Arguments of the command to propagate are passed as an array of redis</span></td></tr>
<tr class="codeline" data-linenumber="3243"><td class="num" id="LN3243">3243</td><td class="line"> <span class='comment'>* objects pointers of len 'argc', using the 'argv' vector.</span></td></tr>
<tr class="codeline" data-linenumber="3244"><td class="num" id="LN3244">3244</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3245"><td class="num" id="LN3245">3245</td><td class="line"> <span class='comment'>* The function does not take a reference to the passed 'argv' vector,</span></td></tr>
<tr class="codeline" data-linenumber="3246"><td class="num" id="LN3246">3246</td><td class="line"> <span class='comment'>* so it is up to the caller to release the passed argv (but it is usually</span></td></tr>
<tr class="codeline" data-linenumber="3247"><td class="num" id="LN3247">3247</td><td class="line"> <span class='comment'>* stack allocated).  The function automatically increments ref count of</span></td></tr>
<tr class="codeline" data-linenumber="3248"><td class="num" id="LN3248">3248</td><td class="line"> <span class='comment'>* passed objects, so the caller does not need to. */</span></td></tr>
<tr class="codeline" data-linenumber="3249"><td class="num" id="LN3249">3249</td><td class="line"><span class='keyword'>void</span> alsoPropagate(<span class='keyword'>struct</span> redisCommand *cmd, <span class='keyword'>int</span> dbid, robj **argv, <span class='keyword'>int</span> argc,</td></tr>
<tr class="codeline" data-linenumber="3250"><td class="num" id="LN3250">3250</td><td class="line">                   <span class='keyword'>int</span> target)</td></tr>
<tr class="codeline" data-linenumber="3251"><td class="num" id="LN3251">3251</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="3252"><td class="num" id="LN3252">3252</td><td class="line">    robj **argvcopy;</td></tr>
<tr class="codeline" data-linenumber="3253"><td class="num" id="LN3253">3253</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="3254"><td class="num" id="LN3254">3254</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3255"><td class="num" id="LN3255">3255</td><td class="line">    <span class='keyword'>if</span> (server.loading) <span class='keyword'>return</span>; <span class='comment'>/* No propagation during loading. */</span></td></tr>
<tr class="codeline" data-linenumber="3256"><td class="num" id="LN3256">3256</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3257"><td class="num" id="LN3257">3257</td><td class="line">    argvcopy = zmalloc(<span class='keyword'>sizeof</span>(robj*)*argc);</td></tr>
<tr class="codeline" data-linenumber="3258"><td class="num" id="LN3258">3258</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; argc; j++) {</td></tr>
<tr class="codeline" data-linenumber="3259"><td class="num" id="LN3259">3259</td><td class="line">        argvcopy[j] = argv[j];</td></tr>
<tr class="codeline" data-linenumber="3260"><td class="num" id="LN3260">3260</td><td class="line">        incrRefCount(argv[j]);</td></tr>
<tr class="codeline" data-linenumber="3261"><td class="num" id="LN3261">3261</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3262"><td class="num" id="LN3262">3262</td><td class="line">    redisOpArrayAppend(&amp;server.also_propagate,cmd,dbid,argvcopy,argc,target);</td></tr>
<tr class="codeline" data-linenumber="3263"><td class="num" id="LN3263">3263</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3264"><td class="num" id="LN3264">3264</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3265"><td class="num" id="LN3265">3265</td><td class="line"><span class='comment'>/* It is possible to call the function forceCommandPropagation() inside a</span></td></tr>
<tr class="codeline" data-linenumber="3266"><td class="num" id="LN3266">3266</td><td class="line"> <span class='comment'>* Redis command implementation in order to to force the propagation of a</span></td></tr>
<tr class="codeline" data-linenumber="3267"><td class="num" id="LN3267">3267</td><td class="line"> <span class='comment'>* specific command execution into AOF / Replication. */</span></td></tr>
<tr class="codeline" data-linenumber="3268"><td class="num" id="LN3268">3268</td><td class="line"><span class='keyword'>void</span> forceCommandPropagation(client *c, <span class='keyword'>int</span> flags) {</td></tr>
<tr class="codeline" data-linenumber="3269"><td class="num" id="LN3269">3269</td><td class="line">    <span class='keyword'>if</span> (flags &amp; <span class='macro'>PROPAGATE_REPL<span class='macro_popup'>2</span></span>) c-&gt;flags |= <span class='macro'>CLIENT_FORCE_REPL<span class='macro_popup'>(1&lt;&lt;15)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3270"><td class="num" id="LN3270">3270</td><td class="line">    <span class='keyword'>if</span> (flags &amp; <span class='macro'>PROPAGATE_AOF<span class='macro_popup'>1</span></span>) c-&gt;flags |= <span class='macro'>CLIENT_FORCE_AOF<span class='macro_popup'>(1&lt;&lt;14)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3271"><td class="num" id="LN3271">3271</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3272"><td class="num" id="LN3272">3272</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3273"><td class="num" id="LN3273">3273</td><td class="line"><span class='comment'>/* Avoid that the executed command is propagated at all. This way we</span></td></tr>
<tr class="codeline" data-linenumber="3274"><td class="num" id="LN3274">3274</td><td class="line"> <span class='comment'>* are free to just propagate what we want using the alsoPropagate()</span></td></tr>
<tr class="codeline" data-linenumber="3275"><td class="num" id="LN3275">3275</td><td class="line"> <span class='comment'>* API. */</span></td></tr>
<tr class="codeline" data-linenumber="3276"><td class="num" id="LN3276">3276</td><td class="line"><span class='keyword'>void</span> preventCommandPropagation(client *c) {</td></tr>
<tr class="codeline" data-linenumber="3277"><td class="num" id="LN3277">3277</td><td class="line">    c-&gt;flags |= <span class='macro'>CLIENT_PREVENT_PROP<span class='macro_popup'>((1&lt;&lt;19)|(1&lt;&lt;20))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3278"><td class="num" id="LN3278">3278</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3279"><td class="num" id="LN3279">3279</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3280"><td class="num" id="LN3280">3280</td><td class="line"><span class='comment'>/* AOF specific version of preventCommandPropagation(). */</span></td></tr>
<tr class="codeline" data-linenumber="3281"><td class="num" id="LN3281">3281</td><td class="line"><span class='keyword'>void</span> preventCommandAOF(client *c) {</td></tr>
<tr class="codeline" data-linenumber="3282"><td class="num" id="LN3282">3282</td><td class="line">    c-&gt;flags |= <span class='macro'>CLIENT_PREVENT_AOF_PROP<span class='macro_popup'>(1&lt;&lt;19)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3283"><td class="num" id="LN3283">3283</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3284"><td class="num" id="LN3284">3284</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3285"><td class="num" id="LN3285">3285</td><td class="line"><span class='comment'>/* Replication specific version of preventCommandPropagation(). */</span></td></tr>
<tr class="codeline" data-linenumber="3286"><td class="num" id="LN3286">3286</td><td class="line"><span class='keyword'>void</span> preventCommandReplication(client *c) {</td></tr>
<tr class="codeline" data-linenumber="3287"><td class="num" id="LN3287">3287</td><td class="line">    c-&gt;flags |= <span class='macro'>CLIENT_PREVENT_REPL_PROP<span class='macro_popup'>(1&lt;&lt;20)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3288"><td class="num" id="LN3288">3288</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3289"><td class="num" id="LN3289">3289</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3290"><td class="num" id="LN3290">3290</td><td class="line"><span class='comment'>/* Call() is the core of Redis execution of a command.</span></td></tr>
<tr class="codeline" data-linenumber="3291"><td class="num" id="LN3291">3291</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3292"><td class="num" id="LN3292">3292</td><td class="line"> <span class='comment'>* The following flags can be passed:</span></td></tr>
<tr class="codeline" data-linenumber="3293"><td class="num" id="LN3293">3293</td><td class="line"> <span class='comment'>* CMD_CALL_NONE        No flags.</span></td></tr>
<tr class="codeline" data-linenumber="3294"><td class="num" id="LN3294">3294</td><td class="line"> <span class='comment'>* CMD_CALL_SLOWLOG     Check command speed and log in the slow log if needed.</span></td></tr>
<tr class="codeline" data-linenumber="3295"><td class="num" id="LN3295">3295</td><td class="line"> <span class='comment'>* CMD_CALL_STATS       Populate command stats.</span></td></tr>
<tr class="codeline" data-linenumber="3296"><td class="num" id="LN3296">3296</td><td class="line"> <span class='comment'>* CMD_CALL_PROPAGATE_AOF   Append command to AOF if it modified the dataset</span></td></tr>
<tr class="codeline" data-linenumber="3297"><td class="num" id="LN3297">3297</td><td class="line"> <span class='comment'>*                          or if the client flags are forcing propagation.</span></td></tr>
<tr class="codeline" data-linenumber="3298"><td class="num" id="LN3298">3298</td><td class="line"> <span class='comment'>* CMD_CALL_PROPAGATE_REPL  Send command to slaves if it modified the dataset</span></td></tr>
<tr class="codeline" data-linenumber="3299"><td class="num" id="LN3299">3299</td><td class="line"> <span class='comment'>*                          or if the client flags are forcing propagation.</span></td></tr>
<tr class="codeline" data-linenumber="3300"><td class="num" id="LN3300">3300</td><td class="line"> <span class='comment'>* CMD_CALL_PROPAGATE   Alias for PROPAGATE_AOF|PROPAGATE_REPL.</span></td></tr>
<tr class="codeline" data-linenumber="3301"><td class="num" id="LN3301">3301</td><td class="line"> <span class='comment'>* CMD_CALL_FULL        Alias for SLOWLOG|STATS|PROPAGATE.</span></td></tr>
<tr class="codeline" data-linenumber="3302"><td class="num" id="LN3302">3302</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3303"><td class="num" id="LN3303">3303</td><td class="line"> <span class='comment'>* The exact propagation behavior depends on the client flags.</span></td></tr>
<tr class="codeline" data-linenumber="3304"><td class="num" id="LN3304">3304</td><td class="line"> <span class='comment'>* Specifically:</span></td></tr>
<tr class="codeline" data-linenumber="3305"><td class="num" id="LN3305">3305</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3306"><td class="num" id="LN3306">3306</td><td class="line"> <span class='comment'>* 1. If the client flags CLIENT_FORCE_AOF or CLIENT_FORCE_REPL are set</span></td></tr>
<tr class="codeline" data-linenumber="3307"><td class="num" id="LN3307">3307</td><td class="line"> <span class='comment'>*    and assuming the corresponding CMD_CALL_PROPAGATE_AOF/REPL is set</span></td></tr>
<tr class="codeline" data-linenumber="3308"><td class="num" id="LN3308">3308</td><td class="line"> <span class='comment'>*    in the call flags, then the command is propagated even if the</span></td></tr>
<tr class="codeline" data-linenumber="3309"><td class="num" id="LN3309">3309</td><td class="line"> <span class='comment'>*    dataset was not affected by the command.</span></td></tr>
<tr class="codeline" data-linenumber="3310"><td class="num" id="LN3310">3310</td><td class="line"> <span class='comment'>* 2. If the client flags CLIENT_PREVENT_REPL_PROP or CLIENT_PREVENT_AOF_PROP</span></td></tr>
<tr class="codeline" data-linenumber="3311"><td class="num" id="LN3311">3311</td><td class="line"> <span class='comment'>*    are set, the propagation into AOF or to slaves is not performed even</span></td></tr>
<tr class="codeline" data-linenumber="3312"><td class="num" id="LN3312">3312</td><td class="line"> <span class='comment'>*    if the command modified the dataset.</span></td></tr>
<tr class="codeline" data-linenumber="3313"><td class="num" id="LN3313">3313</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3314"><td class="num" id="LN3314">3314</td><td class="line"> <span class='comment'>* Note that regardless of the client flags, if CMD_CALL_PROPAGATE_AOF</span></td></tr>
<tr class="codeline" data-linenumber="3315"><td class="num" id="LN3315">3315</td><td class="line"> <span class='comment'>* or CMD_CALL_PROPAGATE_REPL are not set, then respectively AOF or</span></td></tr>
<tr class="codeline" data-linenumber="3316"><td class="num" id="LN3316">3316</td><td class="line"> <span class='comment'>* slaves propagation will never occur.</span></td></tr>
<tr class="codeline" data-linenumber="3317"><td class="num" id="LN3317">3317</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3318"><td class="num" id="LN3318">3318</td><td class="line"> <span class='comment'>* Client flags are modified by the implementation of a given command</span></td></tr>
<tr class="codeline" data-linenumber="3319"><td class="num" id="LN3319">3319</td><td class="line"> <span class='comment'>* using the following API:</span></td></tr>
<tr class="codeline" data-linenumber="3320"><td class="num" id="LN3320">3320</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3321"><td class="num" id="LN3321">3321</td><td class="line"> <span class='comment'>* forceCommandPropagation(client *c, int flags);</span></td></tr>
<tr class="codeline" data-linenumber="3322"><td class="num" id="LN3322">3322</td><td class="line"> <span class='comment'>* preventCommandPropagation(client *c);</span></td></tr>
<tr class="codeline" data-linenumber="3323"><td class="num" id="LN3323">3323</td><td class="line"> <span class='comment'>* preventCommandAOF(client *c);</span></td></tr>
<tr class="codeline" data-linenumber="3324"><td class="num" id="LN3324">3324</td><td class="line"> <span class='comment'>* preventCommandReplication(client *c);</span></td></tr>
<tr class="codeline" data-linenumber="3325"><td class="num" id="LN3325">3325</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3326"><td class="num" id="LN3326">3326</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3327"><td class="num" id="LN3327">3327</td><td class="line"><span class='keyword'>void</span> call(client *c, <span class='keyword'>int</span> flags) {</td></tr>
<tr class="codeline" data-linenumber="3328"><td class="num" id="LN3328">3328</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> dirty;</td></tr>
<tr class="codeline" data-linenumber="3329"><td class="num" id="LN3329">3329</td><td class="line">    ustime_t start, duration;</td></tr>
<tr class="codeline" data-linenumber="3330"><td class="num" id="LN3330">3330</td><td class="line">    <span class='keyword'>int</span> client_old_flags = c-&gt;flags;</td></tr>
<tr class="codeline" data-linenumber="3331"><td class="num" id="LN3331">3331</td><td class="line">    <span class='keyword'>struct</span> redisCommand *real_cmd = c-&gt;cmd;</td></tr>
<tr class="codeline" data-linenumber="3332"><td class="num" id="LN3332">3332</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3333"><td class="num" id="LN3333">3333</td><td class="line">    server.fixed_time_expire++;</td></tr>
<tr class="codeline" data-linenumber="3334"><td class="num" id="LN3334">3334</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3335"><td class="num" id="LN3335">3335</td><td class="line">    <span class='comment'>/* Send the command to clients in MONITOR mode if applicable.</span></td></tr>
<tr class="codeline" data-linenumber="3336"><td class="num" id="LN3336">3336</td><td class="line">     <span class='comment'>* Administrative commands are considered too dangerous to be shown. */</span></td></tr>
<tr class="codeline" data-linenumber="3337"><td class="num" id="LN3337">3337</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>listLength(server.monitors)<span class='macro_popup'>((server.monitors)-&gt;len)</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3338"><td class="num" id="LN3338">3338</td><td class="line">        !server.loading &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3339"><td class="num" id="LN3339">3339</td><td class="line">        !(c-&gt;cmd-&gt;flags &amp; (<span class='macro'>CMD_SKIP_MONITOR<span class='macro_popup'>(1ULL&lt;&lt;11)</span></span>|<span class='macro'>CMD_ADMIN<span class='macro_popup'>(1ULL&lt;&lt;4)</span></span>)))</td></tr>
<tr class="codeline" data-linenumber="3340"><td class="num" id="LN3340">3340</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3341"><td class="num" id="LN3341">3341</td><td class="line">        replicationFeedMonitors(c,server.monitors,c-&gt;db-&gt;id,c-&gt;argv,c-&gt;argc);</td></tr>
<tr class="codeline" data-linenumber="3342"><td class="num" id="LN3342">3342</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3343"><td class="num" id="LN3343">3343</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3344"><td class="num" id="LN3344">3344</td><td class="line">    <span class='comment'>/* Initialization: clear the flags that must be set by the command on</span></td></tr>
<tr class="codeline" data-linenumber="3345"><td class="num" id="LN3345">3345</td><td class="line">     <span class='comment'>* demand, and initialize the array for additional commands propagation. */</span></td></tr>
<tr class="codeline" data-linenumber="3346"><td class="num" id="LN3346">3346</td><td class="line">    c-&gt;flags &amp;= ~(<span class='macro'>CLIENT_FORCE_AOF<span class='macro_popup'>(1&lt;&lt;14)</span></span>|<span class='macro'>CLIENT_FORCE_REPL<span class='macro_popup'>(1&lt;&lt;15)</span></span>|<span class='macro'>CLIENT_PREVENT_PROP<span class='macro_popup'>((1&lt;&lt;19)|(1&lt;&lt;20))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3347"><td class="num" id="LN3347">3347</td><td class="line">    redisOpArray prev_also_propagate = server.also_propagate;</td></tr>
<tr class="codeline" data-linenumber="3348"><td class="num" id="LN3348">3348</td><td class="line">    redisOpArrayInit(&amp;server.also_propagate);</td></tr>
<tr class="codeline" data-linenumber="3349"><td class="num" id="LN3349">3349</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3350"><td class="num" id="LN3350">3350</td><td class="line">    <span class='comment'>/* Call the command. */</span></td></tr>
<tr class="codeline" data-linenumber="3351"><td class="num" id="LN3351">3351</td><td class="line">    dirty = server.dirty;</td></tr>
<tr class="codeline" data-linenumber="3352"><td class="num" id="LN3352">3352</td><td class="line">    updateCachedTime(0);</td></tr>
<tr class="codeline" data-linenumber="3353"><td class="num" id="LN3353">3353</td><td class="line">    start = server.ustime;</td></tr>
<tr class="codeline" data-linenumber="3354"><td class="num" id="LN3354">3354</td><td class="line">    c-&gt;cmd-&gt;proc(c);</td></tr>
<tr class="codeline" data-linenumber="3355"><td class="num" id="LN3355">3355</td><td class="line">    duration = ustime()-start;</td></tr>
<tr class="codeline" data-linenumber="3356"><td class="num" id="LN3356">3356</td><td class="line">    dirty = server.dirty-dirty;</td></tr>
<tr class="codeline" data-linenumber="3357"><td class="num" id="LN3357">3357</td><td class="line">    <span class='keyword'>if</span> (dirty &lt; 0) dirty = 0;</td></tr>
<tr class="codeline" data-linenumber="3358"><td class="num" id="LN3358">3358</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3359"><td class="num" id="LN3359">3359</td><td class="line">    <span class='comment'>/* After executing command, we will close the client after writing entire</span></td></tr>
<tr class="codeline" data-linenumber="3360"><td class="num" id="LN3360">3360</td><td class="line">     <span class='comment'>* reply if it is set 'CLIENT_CLOSE_AFTER_COMMAND' flag. */</span></td></tr>
<tr class="codeline" data-linenumber="3361"><td class="num" id="LN3361">3361</td><td class="line">    <span class='keyword'>if</span> (c-&gt;flags &amp; <span class='macro'>CLIENT_CLOSE_AFTER_COMMAND<span class='macro_popup'>(1ULL&lt;&lt;40)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3362"><td class="num" id="LN3362">3362</td><td class="line">        c-&gt;flags &amp;= ~<span class='macro'>CLIENT_CLOSE_AFTER_COMMAND<span class='macro_popup'>(1ULL&lt;&lt;40)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3363"><td class="num" id="LN3363">3363</td><td class="line">        c-&gt;flags |= <span class='macro'>CLIENT_CLOSE_AFTER_REPLY<span class='macro_popup'>(1&lt;&lt;6)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3364"><td class="num" id="LN3364">3364</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3365"><td class="num" id="LN3365">3365</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3366"><td class="num" id="LN3366">3366</td><td class="line">    <span class='comment'>/* When EVAL is called loading the AOF we don't want commands called</span></td></tr>
<tr class="codeline" data-linenumber="3367"><td class="num" id="LN3367">3367</td><td class="line">     <span class='comment'>* from Lua to go into the slowlog or to populate statistics. */</span></td></tr>
<tr class="codeline" data-linenumber="3368"><td class="num" id="LN3368">3368</td><td class="line">    <span class='keyword'>if</span> (server.loading &amp;&amp; c-&gt;flags &amp; <span class='macro'>CLIENT_LUA<span class='macro_popup'>(1&lt;&lt;8)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3369"><td class="num" id="LN3369">3369</td><td class="line">        flags &amp;= ~(<span class='macro'>CMD_CALL_SLOWLOG<span class='macro_popup'>(1&lt;&lt;0)</span></span> | <span class='macro'>CMD_CALL_STATS<span class='macro_popup'>(1&lt;&lt;1)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3370"><td class="num" id="LN3370">3370</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3371"><td class="num" id="LN3371">3371</td><td class="line">    <span class='comment'>/* If the caller is Lua, we want to force the EVAL caller to propagate</span></td></tr>
<tr class="codeline" data-linenumber="3372"><td class="num" id="LN3372">3372</td><td class="line">     <span class='comment'>* the script if the command flag or client flag are forcing the</span></td></tr>
<tr class="codeline" data-linenumber="3373"><td class="num" id="LN3373">3373</td><td class="line">     <span class='comment'>* propagation. */</span></td></tr>
<tr class="codeline" data-linenumber="3374"><td class="num" id="LN3374">3374</td><td class="line">    <span class='keyword'>if</span> (c-&gt;flags &amp; <span class='macro'>CLIENT_LUA<span class='macro_popup'>(1&lt;&lt;8)</span></span> &amp;&amp; server.lua_caller) {</td></tr>
<tr class="codeline" data-linenumber="3375"><td class="num" id="LN3375">3375</td><td class="line">        <span class='keyword'>if</span> (c-&gt;flags &amp; <span class='macro'>CLIENT_FORCE_REPL<span class='macro_popup'>(1&lt;&lt;15)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3376"><td class="num" id="LN3376">3376</td><td class="line">            server.lua_caller-&gt;flags |= <span class='macro'>CLIENT_FORCE_REPL<span class='macro_popup'>(1&lt;&lt;15)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3377"><td class="num" id="LN3377">3377</td><td class="line">        <span class='keyword'>if</span> (c-&gt;flags &amp; <span class='macro'>CLIENT_FORCE_AOF<span class='macro_popup'>(1&lt;&lt;14)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3378"><td class="num" id="LN3378">3378</td><td class="line">            server.lua_caller-&gt;flags |= <span class='macro'>CLIENT_FORCE_AOF<span class='macro_popup'>(1&lt;&lt;14)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3379"><td class="num" id="LN3379">3379</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3380"><td class="num" id="LN3380">3380</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3381"><td class="num" id="LN3381">3381</td><td class="line">    <span class='comment'>/* Log the command into the Slow log if needed, and populate the</span></td></tr>
<tr class="codeline" data-linenumber="3382"><td class="num" id="LN3382">3382</td><td class="line">     <span class='comment'>* per-command statistics that we show in INFO commandstats. */</span></td></tr>
<tr class="codeline" data-linenumber="3383"><td class="num" id="LN3383">3383</td><td class="line">    <span class='keyword'>if</span> (flags &amp; <span class='macro'>CMD_CALL_SLOWLOG<span class='macro_popup'>(1&lt;&lt;0)</span></span> &amp;&amp; !(c-&gt;cmd-&gt;flags &amp; <span class='macro'>CMD_SKIP_SLOWLOG<span class='macro_popup'>(1ULL&lt;&lt;12)</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="3384"><td class="num" id="LN3384">3384</td><td class="line">        <span class='keyword'>char</span> *latency_event = (c-&gt;cmd-&gt;flags &amp; <span class='macro'>CMD_FAST<span class='macro_popup'>(1ULL&lt;&lt;14)</span></span>) ?</td></tr>
<tr class="codeline" data-linenumber="3385"><td class="num" id="LN3385">3385</td><td class="line">                              <span class='string_literal'>"fast-command"</span> : <span class='string_literal'>"command"</span>;</td></tr>
<tr class="codeline" data-linenumber="3386"><td class="num" id="LN3386">3386</td><td class="line">        <span class='macro'>latencyAddSampleIfNeeded(latency_event,duration/1000)<span class='macro_popup'>if (server.latency_monitor_threshold &amp;&amp; (duration/1000<br>) &gt;= server.latency_monitor_threshold) latencyAddSample((latency_event<br>),(duration/1000));</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3387"><td class="num" id="LN3387">3387</td><td class="line">        slowlogPushEntryIfNeeded(c,c-&gt;argv,c-&gt;argc,duration);</td></tr>
<tr class="codeline" data-linenumber="3388"><td class="num" id="LN3388">3388</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3389"><td class="num" id="LN3389">3389</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3390"><td class="num" id="LN3390">3390</td><td class="line">    <span class='keyword'>if</span> (flags &amp; <span class='macro'>CMD_CALL_STATS<span class='macro_popup'>(1&lt;&lt;1)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3391"><td class="num" id="LN3391">3391</td><td class="line">        <span class='comment'>/* use the real command that was executed (cmd and lastamc) may be</span></td></tr>
<tr class="codeline" data-linenumber="3392"><td class="num" id="LN3392">3392</td><td class="line">         <span class='comment'>* different, in case of MULTI-EXEC or re-written commands such as</span></td></tr>
<tr class="codeline" data-linenumber="3393"><td class="num" id="LN3393">3393</td><td class="line">         <span class='comment'>* EXPIRE, GEOADD, etc. */</span></td></tr>
<tr class="codeline" data-linenumber="3394"><td class="num" id="LN3394">3394</td><td class="line">        real_cmd-&gt;microseconds += duration;</td></tr>
<tr class="codeline" data-linenumber="3395"><td class="num" id="LN3395">3395</td><td class="line">        real_cmd-&gt;calls++;</td></tr>
<tr class="codeline" data-linenumber="3396"><td class="num" id="LN3396">3396</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3397"><td class="num" id="LN3397">3397</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3398"><td class="num" id="LN3398">3398</td><td class="line">    <span class='comment'>/* Propagate the command into the AOF and replication link */</span></td></tr>
<tr class="codeline" data-linenumber="3399"><td class="num" id="LN3399">3399</td><td class="line">    <span class='keyword'>if</span> (flags &amp; <span class='macro'>CMD_CALL_PROPAGATE<span class='macro_popup'>((1&lt;&lt;2)|(1&lt;&lt;3))</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3400"><td class="num" id="LN3400">3400</td><td class="line">        (c-&gt;flags &amp; <span class='macro'>CLIENT_PREVENT_PROP<span class='macro_popup'>((1&lt;&lt;19)|(1&lt;&lt;20))</span></span>) != <span class='macro'>CLIENT_PREVENT_PROP<span class='macro_popup'>((1&lt;&lt;19)|(1&lt;&lt;20))</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3401"><td class="num" id="LN3401">3401</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3402"><td class="num" id="LN3402">3402</td><td class="line">        <span class='keyword'>int</span> propagate_flags = <span class='macro'>PROPAGATE_NONE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3403"><td class="num" id="LN3403">3403</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3404"><td class="num" id="LN3404">3404</td><td class="line">        <span class='comment'>/* Check if the command operated changes in the data set. If so</span></td></tr>
<tr class="codeline" data-linenumber="3405"><td class="num" id="LN3405">3405</td><td class="line">         <span class='comment'>* set for replication / AOF propagation. */</span></td></tr>
<tr class="codeline" data-linenumber="3406"><td class="num" id="LN3406">3406</td><td class="line">        <span class='keyword'>if</span> (dirty) propagate_flags |= (<span class='macro'>PROPAGATE_AOF<span class='macro_popup'>1</span></span>|<span class='macro'>PROPAGATE_REPL<span class='macro_popup'>2</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3407"><td class="num" id="LN3407">3407</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3408"><td class="num" id="LN3408">3408</td><td class="line">        <span class='comment'>/* If the client forced AOF / replication of the command, set</span></td></tr>
<tr class="codeline" data-linenumber="3409"><td class="num" id="LN3409">3409</td><td class="line">         <span class='comment'>* the flags regardless of the command effects on the data set. */</span></td></tr>
<tr class="codeline" data-linenumber="3410"><td class="num" id="LN3410">3410</td><td class="line">        <span class='keyword'>if</span> (c-&gt;flags &amp; <span class='macro'>CLIENT_FORCE_REPL<span class='macro_popup'>(1&lt;&lt;15)</span></span>) propagate_flags |= <span class='macro'>PROPAGATE_REPL<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3411"><td class="num" id="LN3411">3411</td><td class="line">        <span class='keyword'>if</span> (c-&gt;flags &amp; <span class='macro'>CLIENT_FORCE_AOF<span class='macro_popup'>(1&lt;&lt;14)</span></span>) propagate_flags |= <span class='macro'>PROPAGATE_AOF<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3412"><td class="num" id="LN3412">3412</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3413"><td class="num" id="LN3413">3413</td><td class="line">        <span class='comment'>/* However prevent AOF / replication propagation if the command</span></td></tr>
<tr class="codeline" data-linenumber="3414"><td class="num" id="LN3414">3414</td><td class="line">         <span class='comment'>* implementation called preventCommandPropagation() or similar,</span></td></tr>
<tr class="codeline" data-linenumber="3415"><td class="num" id="LN3415">3415</td><td class="line">         <span class='comment'>* or if we don't have the call() flags to do so. */</span></td></tr>
<tr class="codeline" data-linenumber="3416"><td class="num" id="LN3416">3416</td><td class="line">        <span class='keyword'>if</span> (c-&gt;flags &amp; <span class='macro'>CLIENT_PREVENT_REPL_PROP<span class='macro_popup'>(1&lt;&lt;20)</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="3417"><td class="num" id="LN3417">3417</td><td class="line">            !(flags &amp; <span class='macro'>CMD_CALL_PROPAGATE_REPL<span class='macro_popup'>(1&lt;&lt;3)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="3418"><td class="num" id="LN3418">3418</td><td class="line">                propagate_flags &amp;= ~<span class='macro'>PROPAGATE_REPL<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3419"><td class="num" id="LN3419">3419</td><td class="line">        <span class='keyword'>if</span> (c-&gt;flags &amp; <span class='macro'>CLIENT_PREVENT_AOF_PROP<span class='macro_popup'>(1&lt;&lt;19)</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="3420"><td class="num" id="LN3420">3420</td><td class="line">            !(flags &amp; <span class='macro'>CMD_CALL_PROPAGATE_AOF<span class='macro_popup'>(1&lt;&lt;2)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="3421"><td class="num" id="LN3421">3421</td><td class="line">                propagate_flags &amp;= ~<span class='macro'>PROPAGATE_AOF<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3422"><td class="num" id="LN3422">3422</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3423"><td class="num" id="LN3423">3423</td><td class="line">        <span class='comment'>/* Call propagate() only if at least one of AOF / replication</span></td></tr>
<tr class="codeline" data-linenumber="3424"><td class="num" id="LN3424">3424</td><td class="line">         <span class='comment'>* propagation is needed. Note that modules commands handle replication</span></td></tr>
<tr class="codeline" data-linenumber="3425"><td class="num" id="LN3425">3425</td><td class="line">         <span class='comment'>* in an explicit way, so we never replicate them automatically. */</span></td></tr>
<tr class="codeline" data-linenumber="3426"><td class="num" id="LN3426">3426</td><td class="line">        <span class='keyword'>if</span> (propagate_flags != <span class='macro'>PROPAGATE_NONE<span class='macro_popup'>0</span></span> &amp;&amp; !(c-&gt;cmd-&gt;flags &amp; <span class='macro'>CMD_MODULE<span class='macro_popup'>(1ULL&lt;&lt;3)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="3427"><td class="num" id="LN3427">3427</td><td class="line">            propagate(c-&gt;cmd,c-&gt;db-&gt;id,c-&gt;argv,c-&gt;argc,propagate_flags);</td></tr>
<tr class="codeline" data-linenumber="3428"><td class="num" id="LN3428">3428</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3429"><td class="num" id="LN3429">3429</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3430"><td class="num" id="LN3430">3430</td><td class="line">    <span class='comment'>/* Restore the old replication flags, since call() can be executed</span></td></tr>
<tr class="codeline" data-linenumber="3431"><td class="num" id="LN3431">3431</td><td class="line">     <span class='comment'>* recursively. */</span></td></tr>
<tr class="codeline" data-linenumber="3432"><td class="num" id="LN3432">3432</td><td class="line">    c-&gt;flags &amp;= ~(<span class='macro'>CLIENT_FORCE_AOF<span class='macro_popup'>(1&lt;&lt;14)</span></span>|<span class='macro'>CLIENT_FORCE_REPL<span class='macro_popup'>(1&lt;&lt;15)</span></span>|<span class='macro'>CLIENT_PREVENT_PROP<span class='macro_popup'>((1&lt;&lt;19)|(1&lt;&lt;20))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3433"><td class="num" id="LN3433">3433</td><td class="line">    c-&gt;flags |= client_old_flags &amp;</td></tr>
<tr class="codeline" data-linenumber="3434"><td class="num" id="LN3434">3434</td><td class="line">        (<span class='macro'>CLIENT_FORCE_AOF<span class='macro_popup'>(1&lt;&lt;14)</span></span>|<span class='macro'>CLIENT_FORCE_REPL<span class='macro_popup'>(1&lt;&lt;15)</span></span>|<span class='macro'>CLIENT_PREVENT_PROP<span class='macro_popup'>((1&lt;&lt;19)|(1&lt;&lt;20))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3435"><td class="num" id="LN3435">3435</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3436"><td class="num" id="LN3436">3436</td><td class="line">    <span class='comment'>/* Handle the alsoPropagate() API to handle commands that want to propagate</span></td></tr>
<tr class="codeline" data-linenumber="3437"><td class="num" id="LN3437">3437</td><td class="line">     <span class='comment'>* multiple separated commands. Note that alsoPropagate() is not affected</span></td></tr>
<tr class="codeline" data-linenumber="3438"><td class="num" id="LN3438">3438</td><td class="line">     <span class='comment'>* by CLIENT_PREVENT_PROP flag. */</span></td></tr>
<tr class="codeline" data-linenumber="3439"><td class="num" id="LN3439">3439</td><td class="line">    <span class='keyword'>if</span> (server.also_propagate.numops) {</td></tr>
<tr class="codeline" data-linenumber="3440"><td class="num" id="LN3440">3440</td><td class="line">        <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="3441"><td class="num" id="LN3441">3441</td><td class="line">        redisOp *rop;</td></tr>
<tr class="codeline" data-linenumber="3442"><td class="num" id="LN3442">3442</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3443"><td class="num" id="LN3443">3443</td><td class="line">        <span class='keyword'>if</span> (flags &amp; <span class='macro'>CMD_CALL_PROPAGATE<span class='macro_popup'>((1&lt;&lt;2)|(1&lt;&lt;3))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3444"><td class="num" id="LN3444">3444</td><td class="line">            <span class='keyword'>int</span> multi_emitted = 0;</td></tr>
<tr class="codeline" data-linenumber="3445"><td class="num" id="LN3445">3445</td><td class="line">            <span class='comment'>/* Wrap the commands in server.also_propagate array,</span></td></tr>
<tr class="codeline" data-linenumber="3446"><td class="num" id="LN3446">3446</td><td class="line">             <span class='comment'>* but don't wrap it if we are already in MULTI context,</span></td></tr>
<tr class="codeline" data-linenumber="3447"><td class="num" id="LN3447">3447</td><td class="line">             <span class='comment'>* in case the nested MULTI/EXEC.</span></td></tr>
<tr class="codeline" data-linenumber="3448"><td class="num" id="LN3448">3448</td><td class="line">             <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3449"><td class="num" id="LN3449">3449</td><td class="line">             <span class='comment'>* And if the array contains only one command, no need to</span></td></tr>
<tr class="codeline" data-linenumber="3450"><td class="num" id="LN3450">3450</td><td class="line">             <span class='comment'>* wrap it, since the single command is atomic. */</span></td></tr>
<tr class="codeline" data-linenumber="3451"><td class="num" id="LN3451">3451</td><td class="line">            <span class='keyword'>if</span> (server.also_propagate.numops &gt; 1 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3452"><td class="num" id="LN3452">3452</td><td class="line">                !(c-&gt;cmd-&gt;flags &amp; <span class='macro'>CMD_MODULE<span class='macro_popup'>(1ULL&lt;&lt;3)</span></span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3453"><td class="num" id="LN3453">3453</td><td class="line">                !(c-&gt;flags &amp; <span class='macro'>CLIENT_MULTI<span class='macro_popup'>(1&lt;&lt;3)</span></span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3454"><td class="num" id="LN3454">3454</td><td class="line">                !(flags &amp; <span class='macro'>CMD_CALL_NOWRAP<span class='macro_popup'>(1&lt;&lt;4)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="3455"><td class="num" id="LN3455">3455</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="3456"><td class="num" id="LN3456">3456</td><td class="line">                execCommandPropagateMulti(c);</td></tr>
<tr class="codeline" data-linenumber="3457"><td class="num" id="LN3457">3457</td><td class="line">                multi_emitted = 1;</td></tr>
<tr class="codeline" data-linenumber="3458"><td class="num" id="LN3458">3458</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3459"><td class="num" id="LN3459">3459</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3460"><td class="num" id="LN3460">3460</td><td class="line">            <span class='keyword'>for</span> (j = 0; j &lt; server.also_propagate.numops; j++) {</td></tr>
<tr class="codeline" data-linenumber="3461"><td class="num" id="LN3461">3461</td><td class="line">                rop = &amp;server.also_propagate.ops[j];</td></tr>
<tr class="codeline" data-linenumber="3462"><td class="num" id="LN3462">3462</td><td class="line">                <span class='keyword'>int</span> target = rop-&gt;target;</td></tr>
<tr class="codeline" data-linenumber="3463"><td class="num" id="LN3463">3463</td><td class="line">                <span class='comment'>/* Whatever the command wish is, we honor the call() flags. */</span></td></tr>
<tr class="codeline" data-linenumber="3464"><td class="num" id="LN3464">3464</td><td class="line">                <span class='keyword'>if</span> (!(flags&amp;<span class='macro'>CMD_CALL_PROPAGATE_AOF<span class='macro_popup'>(1&lt;&lt;2)</span></span>)) target &amp;= ~<span class='macro'>PROPAGATE_AOF<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3465"><td class="num" id="LN3465">3465</td><td class="line">                <span class='keyword'>if</span> (!(flags&amp;<span class='macro'>CMD_CALL_PROPAGATE_REPL<span class='macro_popup'>(1&lt;&lt;3)</span></span>)) target &amp;= ~<span class='macro'>PROPAGATE_REPL<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3466"><td class="num" id="LN3466">3466</td><td class="line">                <span class='keyword'>if</span> (target)</td></tr>
<tr class="codeline" data-linenumber="3467"><td class="num" id="LN3467">3467</td><td class="line">                    propagate(rop-&gt;cmd,rop-&gt;dbid,rop-&gt;argv,rop-&gt;argc,target);</td></tr>
<tr class="codeline" data-linenumber="3468"><td class="num" id="LN3468">3468</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3469"><td class="num" id="LN3469">3469</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3470"><td class="num" id="LN3470">3470</td><td class="line">            <span class='keyword'>if</span> (multi_emitted) {</td></tr>
<tr class="codeline" data-linenumber="3471"><td class="num" id="LN3471">3471</td><td class="line">                execCommandPropagateExec(c);</td></tr>
<tr class="codeline" data-linenumber="3472"><td class="num" id="LN3472">3472</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3473"><td class="num" id="LN3473">3473</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3474"><td class="num" id="LN3474">3474</td><td class="line">        redisOpArrayFree(&amp;server.also_propagate);</td></tr>
<tr class="codeline" data-linenumber="3475"><td class="num" id="LN3475">3475</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3476"><td class="num" id="LN3476">3476</td><td class="line">    server.also_propagate = prev_also_propagate;</td></tr>
<tr class="codeline" data-linenumber="3477"><td class="num" id="LN3477">3477</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3478"><td class="num" id="LN3478">3478</td><td class="line">    <span class='comment'>/* If the client has keys tracking enabled for client side caching,</span></td></tr>
<tr class="codeline" data-linenumber="3479"><td class="num" id="LN3479">3479</td><td class="line">     <span class='comment'>* make sure to remember the keys it fetched via this command. */</span></td></tr>
<tr class="codeline" data-linenumber="3480"><td class="num" id="LN3480">3480</td><td class="line">    <span class='keyword'>if</span> (c-&gt;cmd-&gt;flags &amp; <span class='macro'>CMD_READONLY<span class='macro_popup'>(1ULL&lt;&lt;1)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3481"><td class="num" id="LN3481">3481</td><td class="line">        client *caller = (c-&gt;flags &amp; <span class='macro'>CLIENT_LUA<span class='macro_popup'>(1&lt;&lt;8)</span></span> &amp;&amp; server.lua_caller) ?</td></tr>
<tr class="codeline" data-linenumber="3482"><td class="num" id="LN3482">3482</td><td class="line">                            server.lua_caller : c;</td></tr>
<tr class="codeline" data-linenumber="3483"><td class="num" id="LN3483">3483</td><td class="line">        <span class='keyword'>if</span> (caller-&gt;flags &amp; <span class='macro'>CLIENT_TRACKING<span class='macro_popup'>(1ULL&lt;&lt;31)</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3484"><td class="num" id="LN3484">3484</td><td class="line">            !(caller-&gt;flags &amp; <span class='macro'>CLIENT_TRACKING_BCAST<span class='macro_popup'>(1ULL&lt;&lt;33)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="3485"><td class="num" id="LN3485">3485</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="3486"><td class="num" id="LN3486">3486</td><td class="line">            trackingRememberKeys(caller);</td></tr>
<tr class="codeline" data-linenumber="3487"><td class="num" id="LN3487">3487</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3488"><td class="num" id="LN3488">3488</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3489"><td class="num" id="LN3489">3489</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3490"><td class="num" id="LN3490">3490</td><td class="line">    server.fixed_time_expire--;</td></tr>
<tr class="codeline" data-linenumber="3491"><td class="num" id="LN3491">3491</td><td class="line">    server.stat_numcommands++;</td></tr>
<tr class="codeline" data-linenumber="3492"><td class="num" id="LN3492">3492</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3493"><td class="num" id="LN3493">3493</td><td class="line">    <span class='comment'>/* Record peak memory after each command and before the eviction that runs</span></td></tr>
<tr class="codeline" data-linenumber="3494"><td class="num" id="LN3494">3494</td><td class="line">     <span class='comment'>* before the next command. */</span></td></tr>
<tr class="codeline" data-linenumber="3495"><td class="num" id="LN3495">3495</td><td class="line">    size_t zmalloc_used = zmalloc_used_memory();</td></tr>
<tr class="codeline" data-linenumber="3496"><td class="num" id="LN3496">3496</td><td class="line">    <span class='keyword'>if</span> (zmalloc_used &gt; server.stat_peak_memory)</td></tr>
<tr class="codeline" data-linenumber="3497"><td class="num" id="LN3497">3497</td><td class="line">        server.stat_peak_memory = zmalloc_used;</td></tr>
<tr class="codeline" data-linenumber="3498"><td class="num" id="LN3498">3498</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3499"><td class="num" id="LN3499">3499</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3500"><td class="num" id="LN3500">3500</td><td class="line"><span class='comment'>/* Used when a command that is ready for execution needs to be rejected, due to</span></td></tr>
<tr class="codeline" data-linenumber="3501"><td class="num" id="LN3501">3501</td><td class="line"> <span class='comment'>* varios pre-execution checks. it returns the appropriate error to the client.</span></td></tr>
<tr class="codeline" data-linenumber="3502"><td class="num" id="LN3502">3502</td><td class="line"> <span class='comment'>* If there's a transaction is flags it as dirty, and if the command is EXEC,</span></td></tr>
<tr class="codeline" data-linenumber="3503"><td class="num" id="LN3503">3503</td><td class="line"> <span class='comment'>* it aborts the transaction.</span></td></tr>
<tr class="codeline" data-linenumber="3504"><td class="num" id="LN3504">3504</td><td class="line"> <span class='comment'>* Note: 'reply' is expected to end with \r\n */</span></td></tr>
<tr class="codeline" data-linenumber="3505"><td class="num" id="LN3505">3505</td><td class="line"><span class='keyword'>void</span> rejectCommand(client *c, robj *reply) {</td></tr>
<tr class="codeline" data-linenumber="3506"><td class="num" id="LN3506">3506</td><td class="line">    flagTransaction(c);</td></tr>
<tr class="codeline" data-linenumber="3507"><td class="num" id="LN3507">3507</td><td class="line">    <span class='keyword'>if</span> (c-&gt;cmd &amp;&amp; c-&gt;cmd-&gt;proc == execCommand) {</td></tr>
<tr class="codeline" data-linenumber="3508"><td class="num" id="LN3508">3508</td><td class="line">        execCommandAbort(c, reply-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="3509"><td class="num" id="LN3509">3509</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3510"><td class="num" id="LN3510">3510</td><td class="line">        <span class='comment'>/* using addReplyError* rather than addReply so that the error can be logged. */</span></td></tr>
<tr class="codeline" data-linenumber="3511"><td class="num" id="LN3511">3511</td><td class="line">        addReplyErrorObject(c, reply);</td></tr>
<tr class="codeline" data-linenumber="3512"><td class="num" id="LN3512">3512</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3513"><td class="num" id="LN3513">3513</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3514"><td class="num" id="LN3514">3514</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3515"><td class="num" id="LN3515">3515</td><td class="line"><span class='keyword'>void</span> rejectCommandFormat(client *c, <span class='keyword'>const</span> <span class='keyword'>char</span> *fmt, ...) {</td></tr>
<tr class="codeline" data-linenumber="3516"><td class="num" id="LN3516">3516</td><td class="line">    flagTransaction(c);</td></tr>
<tr class="codeline" data-linenumber="3517"><td class="num" id="LN3517">3517</td><td class="line">    va_list ap;</td></tr>
<tr class="codeline" data-linenumber="3518"><td class="num" id="LN3518">3518</td><td class="line">    <span class='macro'>va_start(ap,fmt)<span class='macro_popup'>__builtin_va_start(ap, fmt)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3519"><td class="num" id="LN3519">3519</td><td class="line">    sds s = sdscatvprintf(sdsempty(),fmt,ap);</td></tr>
<tr class="codeline" data-linenumber="3520"><td class="num" id="LN3520">3520</td><td class="line">    <span class='macro'>va_end(ap)<span class='macro_popup'>__builtin_va_end(ap)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3521"><td class="num" id="LN3521">3521</td><td class="line">    <span class='comment'>/* Make sure there are no newlines in the string, otherwise invalid protocol</span></td></tr>
<tr class="codeline" data-linenumber="3522"><td class="num" id="LN3522">3522</td><td class="line">     <span class='comment'>* is emitted (The args come from the user, they may contain any character). */</span></td></tr>
<tr class="codeline" data-linenumber="3523"><td class="num" id="LN3523">3523</td><td class="line">    sdsmapchars(s, <span class='string_literal'>"\r\n"</span>, <span class='string_literal'>"  "</span>,  2);</td></tr>
<tr class="codeline" data-linenumber="3524"><td class="num" id="LN3524">3524</td><td class="line">    <span class='keyword'>if</span> (c-&gt;cmd &amp;&amp; c-&gt;cmd-&gt;proc == execCommand) {</td></tr>
<tr class="codeline" data-linenumber="3525"><td class="num" id="LN3525">3525</td><td class="line">        execCommandAbort(c, s);</td></tr>
<tr class="codeline" data-linenumber="3526"><td class="num" id="LN3526">3526</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3527"><td class="num" id="LN3527">3527</td><td class="line">        addReplyErrorSds(c, s);</td></tr>
<tr class="codeline" data-linenumber="3528"><td class="num" id="LN3528">3528</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3529"><td class="num" id="LN3529">3529</td><td class="line">    sdsfree(s);</td></tr>
<tr class="codeline" data-linenumber="3530"><td class="num" id="LN3530">3530</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3531"><td class="num" id="LN3531">3531</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3532"><td class="num" id="LN3532">3532</td><td class="line"><span class='comment'>/* If this function gets called we already read a whole</span></td></tr>
<tr class="codeline" data-linenumber="3533"><td class="num" id="LN3533">3533</td><td class="line"> <span class='comment'>* command, arguments are in the client argv/argc fields.</span></td></tr>
<tr class="codeline" data-linenumber="3534"><td class="num" id="LN3534">3534</td><td class="line"> <span class='comment'>* processCommand() execute the command or prepare the</span></td></tr>
<tr class="codeline" data-linenumber="3535"><td class="num" id="LN3535">3535</td><td class="line"> <span class='comment'>* server for a bulk read from the client.</span></td></tr>
<tr class="codeline" data-linenumber="3536"><td class="num" id="LN3536">3536</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3537"><td class="num" id="LN3537">3537</td><td class="line"> <span class='comment'>* If C_OK is returned the client is still alive and valid and</span></td></tr>
<tr class="codeline" data-linenumber="3538"><td class="num" id="LN3538">3538</td><td class="line"> <span class='comment'>* other operations can be performed by the caller. Otherwise</span></td></tr>
<tr class="codeline" data-linenumber="3539"><td class="num" id="LN3539">3539</td><td class="line"> <span class='comment'>* if C_ERR is returned the client was destroyed (i.e. after QUIT). */</span></td></tr>
<tr class="codeline" data-linenumber="3540"><td class="num" id="LN3540">3540</td><td class="line"><span class='keyword'>int</span> processCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="3541"><td class="num" id="LN3541">3541</td><td class="line">    moduleCallCommandFilters(c);</td></tr>
<tr class="codeline" data-linenumber="3542"><td class="num" id="LN3542">3542</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3543"><td class="num" id="LN3543">3543</td><td class="line">    <span class='comment'>/* The QUIT command is handled separately. Normal command procs will</span></td></tr>
<tr class="codeline" data-linenumber="3544"><td class="num" id="LN3544">3544</td><td class="line">     <span class='comment'>* go through checking for replication and QUIT will cause trouble</span></td></tr>
<tr class="codeline" data-linenumber="3545"><td class="num" id="LN3545">3545</td><td class="line">     <span class='comment'>* when FORCE_REPLICATION is enabled and would be implemented in</span></td></tr>
<tr class="codeline" data-linenumber="3546"><td class="num" id="LN3546">3546</td><td class="line">     <span class='comment'>* a regular command proc. */</span></td></tr>
<tr class="codeline" data-linenumber="3547"><td class="num" id="LN3547">3547</td><td class="line">    <span class='keyword'>if</span> (!strcasecmp(c-&gt;argv[0]-&gt;ptr,<span class='string_literal'>"quit"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="3548"><td class="num" id="LN3548">3548</td><td class="line">        addReply(c,shared.ok);</td></tr>
<tr class="codeline" data-linenumber="3549"><td class="num" id="LN3549">3549</td><td class="line">        c-&gt;flags |= <span class='macro'>CLIENT_CLOSE_AFTER_REPLY<span class='macro_popup'>(1&lt;&lt;6)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3550"><td class="num" id="LN3550">3550</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3551"><td class="num" id="LN3551">3551</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3552"><td class="num" id="LN3552">3552</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3553"><td class="num" id="LN3553">3553</td><td class="line">    <span class='comment'>/* Now lookup the command and check ASAP about trivial error conditions</span></td></tr>
<tr class="codeline" data-linenumber="3554"><td class="num" id="LN3554">3554</td><td class="line">     <span class='comment'>* such as wrong arity, bad command name and so forth. */</span></td></tr>
<tr class="codeline" data-linenumber="3555"><td class="num" id="LN3555">3555</td><td class="line">    c-&gt;cmd = c-&gt;lastcmd = lookupCommand(c-&gt;argv[0]-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="3556"><td class="num" id="LN3556">3556</td><td class="line">    <span class='keyword'>if</span> (!c-&gt;cmd) {</td></tr>
<tr class="codeline" data-linenumber="3557"><td class="num" id="LN3557">3557</td><td class="line">        sds args = sdsempty();</td></tr>
<tr class="codeline" data-linenumber="3558"><td class="num" id="LN3558">3558</td><td class="line">        <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="3559"><td class="num" id="LN3559">3559</td><td class="line">        <span class='keyword'>for</span> (i=1; i &lt; c-&gt;argc &amp;&amp; sdslen(args) &lt; 128; i++)</td></tr>
<tr class="codeline" data-linenumber="3560"><td class="num" id="LN3560">3560</td><td class="line">            args = sdscatprintf(args, <span class='string_literal'>"`%.*s`, "</span>, 128-(<span class='keyword'>int</span>)sdslen(args), (<span class='keyword'>char</span>*)c-&gt;argv[i]-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="3561"><td class="num" id="LN3561">3561</td><td class="line">        rejectCommandFormat(c,<span class='string_literal'>"unknown command `%s`, with args beginning with: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="3562"><td class="num" id="LN3562">3562</td><td class="line">            (<span class='keyword'>char</span>*)c-&gt;argv[0]-&gt;ptr, args);</td></tr>
<tr class="codeline" data-linenumber="3563"><td class="num" id="LN3563">3563</td><td class="line">        sdsfree(args);</td></tr>
<tr class="codeline" data-linenumber="3564"><td class="num" id="LN3564">3564</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3565"><td class="num" id="LN3565">3565</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> ((c-&gt;cmd-&gt;arity &gt; 0 &amp;&amp; c-&gt;cmd-&gt;arity != c-&gt;argc) ||</td></tr>
<tr class="codeline" data-linenumber="3566"><td class="num" id="LN3566">3566</td><td class="line">               (c-&gt;argc &lt; -c-&gt;cmd-&gt;arity)) {</td></tr>
<tr class="codeline" data-linenumber="3567"><td class="num" id="LN3567">3567</td><td class="line">        rejectCommandFormat(c,<span class='string_literal'>"wrong number of arguments for '%s' command"</span>,</td></tr>
<tr class="codeline" data-linenumber="3568"><td class="num" id="LN3568">3568</td><td class="line">            c-&gt;cmd-&gt;name);</td></tr>
<tr class="codeline" data-linenumber="3569"><td class="num" id="LN3569">3569</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3570"><td class="num" id="LN3570">3570</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3571"><td class="num" id="LN3571">3571</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3572"><td class="num" id="LN3572">3572</td><td class="line">    <span class='keyword'>int</span> is_write_command = (c-&gt;cmd-&gt;flags &amp; <span class='macro'>CMD_WRITE<span class='macro_popup'>(1ULL&lt;&lt;0)</span></span>) ||</td></tr>
<tr class="codeline" data-linenumber="3573"><td class="num" id="LN3573">3573</td><td class="line">                           (c-&gt;cmd-&gt;proc == execCommand &amp;&amp; (c-&gt;mstate.cmd_flags &amp; <span class='macro'>CMD_WRITE<span class='macro_popup'>(1ULL&lt;&lt;0)</span></span>));</td></tr>
<tr class="codeline" data-linenumber="3574"><td class="num" id="LN3574">3574</td><td class="line">    <span class='keyword'>int</span> is_denyoom_command = (c-&gt;cmd-&gt;flags &amp; <span class='macro'>CMD_DENYOOM<span class='macro_popup'>(1ULL&lt;&lt;2)</span></span>) ||</td></tr>
<tr class="codeline" data-linenumber="3575"><td class="num" id="LN3575">3575</td><td class="line">                             (c-&gt;cmd-&gt;proc == execCommand &amp;&amp; (c-&gt;mstate.cmd_flags &amp; <span class='macro'>CMD_DENYOOM<span class='macro_popup'>(1ULL&lt;&lt;2)</span></span>));</td></tr>
<tr class="codeline" data-linenumber="3576"><td class="num" id="LN3576">3576</td><td class="line">    <span class='keyword'>int</span> is_denystale_command = !(c-&gt;cmd-&gt;flags &amp; <span class='macro'>CMD_STALE<span class='macro_popup'>(1ULL&lt;&lt;10)</span></span>) ||</td></tr>
<tr class="codeline" data-linenumber="3577"><td class="num" id="LN3577">3577</td><td class="line">                               (c-&gt;cmd-&gt;proc == execCommand &amp;&amp; (c-&gt;mstate.cmd_inv_flags &amp; <span class='macro'>CMD_STALE<span class='macro_popup'>(1ULL&lt;&lt;10)</span></span>));</td></tr>
<tr class="codeline" data-linenumber="3578"><td class="num" id="LN3578">3578</td><td class="line">    <span class='keyword'>int</span> is_denyloading_command = !(c-&gt;cmd-&gt;flags &amp; <span class='macro'>CMD_LOADING<span class='macro_popup'>(1ULL&lt;&lt;9)</span></span>) ||</td></tr>
<tr class="codeline" data-linenumber="3579"><td class="num" id="LN3579">3579</td><td class="line">                                 (c-&gt;cmd-&gt;proc == execCommand &amp;&amp; (c-&gt;mstate.cmd_inv_flags &amp; <span class='macro'>CMD_LOADING<span class='macro_popup'>(1ULL&lt;&lt;9)</span></span>));</td></tr>
<tr class="codeline" data-linenumber="3580"><td class="num" id="LN3580">3580</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3581"><td class="num" id="LN3581">3581</td><td class="line">    <span class='comment'>/* Check if the user is authenticated. This check is skipped in case</span></td></tr>
<tr class="codeline" data-linenumber="3582"><td class="num" id="LN3582">3582</td><td class="line">     <span class='comment'>* the default user is flagged as "nopass" and is active. */</span></td></tr>
<tr class="codeline" data-linenumber="3583"><td class="num" id="LN3583">3583</td><td class="line">    <span class='keyword'>int</span> auth_required = (!(DefaultUser-&gt;flags &amp; <span class='macro'>USER_FLAG_NOPASS<span class='macro_popup'>(1&lt;&lt;4)</span></span>) ||</td></tr>
<tr class="codeline" data-linenumber="3584"><td class="num" id="LN3584">3584</td><td class="line">                          (DefaultUser-&gt;flags &amp; <span class='macro'>USER_FLAG_DISABLED<span class='macro_popup'>(1&lt;&lt;1)</span></span>)) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3585"><td class="num" id="LN3585">3585</td><td class="line">                        !c-&gt;authenticated;</td></tr>
<tr class="codeline" data-linenumber="3586"><td class="num" id="LN3586">3586</td><td class="line">    <span class='keyword'>if</span> (auth_required) {</td></tr>
<tr class="codeline" data-linenumber="3587"><td class="num" id="LN3587">3587</td><td class="line">        <span class='comment'>/* AUTH and HELLO and no auth modules are valid even in</span></td></tr>
<tr class="codeline" data-linenumber="3588"><td class="num" id="LN3588">3588</td><td class="line">         <span class='comment'>* non-authenticated state. */</span></td></tr>
<tr class="codeline" data-linenumber="3589"><td class="num" id="LN3589">3589</td><td class="line">        <span class='keyword'>if</span> (!(c-&gt;cmd-&gt;flags &amp; <span class='macro'>CMD_NO_AUTH<span class='macro_popup'>(1ULL&lt;&lt;15)</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="3590"><td class="num" id="LN3590">3590</td><td class="line">            rejectCommand(c,shared.noautherr);</td></tr>
<tr class="codeline" data-linenumber="3591"><td class="num" id="LN3591">3591</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3592"><td class="num" id="LN3592">3592</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3593"><td class="num" id="LN3593">3593</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3594"><td class="num" id="LN3594">3594</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3595"><td class="num" id="LN3595">3595</td><td class="line">    <span class='comment'>/* Check if the user can run this command according to the current</span></td></tr>
<tr class="codeline" data-linenumber="3596"><td class="num" id="LN3596">3596</td><td class="line">     <span class='comment'>* ACLs. */</span></td></tr>
<tr class="codeline" data-linenumber="3597"><td class="num" id="LN3597">3597</td><td class="line">    <span class='keyword'>int</span> acl_keypos;</td></tr>
<tr class="codeline" data-linenumber="3598"><td class="num" id="LN3598">3598</td><td class="line">    <span class='keyword'>int</span> acl_retval = ACLCheckCommandPerm(c,&amp;acl_keypos);</td></tr>
<tr class="codeline" data-linenumber="3599"><td class="num" id="LN3599">3599</td><td class="line">    <span class='keyword'>if</span> (acl_retval != <span class='macro'>ACL_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3600"><td class="num" id="LN3600">3600</td><td class="line">        addACLLogEntry(c,acl_retval,acl_keypos,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3601"><td class="num" id="LN3601">3601</td><td class="line">        <span class='keyword'>if</span> (acl_retval == <span class='macro'>ACL_DENIED_CMD<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3602"><td class="num" id="LN3602">3602</td><td class="line">            rejectCommandFormat(c,</td></tr>
<tr class="codeline" data-linenumber="3603"><td class="num" id="LN3603">3603</td><td class="line">                <span class='string_literal'>"-NOPERM this user has no permissions to run "</span></td></tr>
<tr class="codeline" data-linenumber="3604"><td class="num" id="LN3604">3604</td><td class="line">                <span class='string_literal'>"the '%s' command or its subcommand"</span>, c-&gt;cmd-&gt;name);</td></tr>
<tr class="codeline" data-linenumber="3605"><td class="num" id="LN3605">3605</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3606"><td class="num" id="LN3606">3606</td><td class="line">            rejectCommandFormat(c,</td></tr>
<tr class="codeline" data-linenumber="3607"><td class="num" id="LN3607">3607</td><td class="line">                <span class='string_literal'>"-NOPERM this user has no permissions to access "</span></td></tr>
<tr class="codeline" data-linenumber="3608"><td class="num" id="LN3608">3608</td><td class="line">                <span class='string_literal'>"one of the keys used as arguments"</span>);</td></tr>
<tr class="codeline" data-linenumber="3609"><td class="num" id="LN3609">3609</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3610"><td class="num" id="LN3610">3610</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3611"><td class="num" id="LN3611">3611</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3612"><td class="num" id="LN3612">3612</td><td class="line">    <span class='comment'>/* If cluster is enabled perform the cluster redirection here.</span></td></tr>
<tr class="codeline" data-linenumber="3613"><td class="num" id="LN3613">3613</td><td class="line">     <span class='comment'>* However we don't perform the redirection if:</span></td></tr>
<tr class="codeline" data-linenumber="3614"><td class="num" id="LN3614">3614</td><td class="line">     <span class='comment'>* 1) The sender of this command is our master.</span></td></tr>
<tr class="codeline" data-linenumber="3615"><td class="num" id="LN3615">3615</td><td class="line">     <span class='comment'>* 2) The command has no key arguments. */</span></td></tr>
<tr class="codeline" data-linenumber="3616"><td class="num" id="LN3616">3616</td><td class="line">    <span class='keyword'>if</span> (server.cluster_enabled &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3617"><td class="num" id="LN3617">3617</td><td class="line">        !(c-&gt;flags &amp; <span class='macro'>CLIENT_MASTER<span class='macro_popup'>(1&lt;&lt;1)</span></span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3618"><td class="num" id="LN3618">3618</td><td class="line">        !(c-&gt;flags &amp; <span class='macro'>CLIENT_LUA<span class='macro_popup'>(1&lt;&lt;8)</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3619"><td class="num" id="LN3619">3619</td><td class="line">          server.lua_caller-&gt;flags &amp; <span class='macro'>CLIENT_MASTER<span class='macro_popup'>(1&lt;&lt;1)</span></span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3620"><td class="num" id="LN3620">3620</td><td class="line">        !(c-&gt;cmd-&gt;getkeys_proc == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; c-&gt;cmd-&gt;firstkey == 0 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3621"><td class="num" id="LN3621">3621</td><td class="line">          c-&gt;cmd-&gt;proc != execCommand))</td></tr>
<tr class="codeline" data-linenumber="3622"><td class="num" id="LN3622">3622</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3623"><td class="num" id="LN3623">3623</td><td class="line">        <span class='keyword'>int</span> hashslot;</td></tr>
<tr class="codeline" data-linenumber="3624"><td class="num" id="LN3624">3624</td><td class="line">        <span class='keyword'>int</span> error_code;</td></tr>
<tr class="codeline" data-linenumber="3625"><td class="num" id="LN3625">3625</td><td class="line">        clusterNode *n = getNodeByQuery(c,c-&gt;cmd,c-&gt;argv,c-&gt;argc,</td></tr>
<tr class="codeline" data-linenumber="3626"><td class="num" id="LN3626">3626</td><td class="line">                                        &amp;hashslot,&amp;error_code);</td></tr>
<tr class="codeline" data-linenumber="3627"><td class="num" id="LN3627">3627</td><td class="line">        <span class='keyword'>if</span> (n == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || n != server.cluster-&gt;myself) {</td></tr>
<tr class="codeline" data-linenumber="3628"><td class="num" id="LN3628">3628</td><td class="line">            <span class='keyword'>if</span> (c-&gt;cmd-&gt;proc == execCommand) {</td></tr>
<tr class="codeline" data-linenumber="3629"><td class="num" id="LN3629">3629</td><td class="line">                discardTransaction(c);</td></tr>
<tr class="codeline" data-linenumber="3630"><td class="num" id="LN3630">3630</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3631"><td class="num" id="LN3631">3631</td><td class="line">                flagTransaction(c);</td></tr>
<tr class="codeline" data-linenumber="3632"><td class="num" id="LN3632">3632</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3633"><td class="num" id="LN3633">3633</td><td class="line">            clusterRedirectClient(c,n,hashslot,error_code);</td></tr>
<tr class="codeline" data-linenumber="3634"><td class="num" id="LN3634">3634</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3635"><td class="num" id="LN3635">3635</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3636"><td class="num" id="LN3636">3636</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3637"><td class="num" id="LN3637">3637</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3638"><td class="num" id="LN3638">3638</td><td class="line">    <span class='comment'>/* Handle the maxmemory directive.</span></td></tr>
<tr class="codeline" data-linenumber="3639"><td class="num" id="LN3639">3639</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3640"><td class="num" id="LN3640">3640</td><td class="line">     <span class='comment'>* Note that we do not want to reclaim memory if we are here re-entering</span></td></tr>
<tr class="codeline" data-linenumber="3641"><td class="num" id="LN3641">3641</td><td class="line">     <span class='comment'>* the event loop since there is a busy Lua script running in timeout</span></td></tr>
<tr class="codeline" data-linenumber="3642"><td class="num" id="LN3642">3642</td><td class="line">     <span class='comment'>* condition, to avoid mixing the propagation of scripts with the</span></td></tr>
<tr class="codeline" data-linenumber="3643"><td class="num" id="LN3643">3643</td><td class="line">     <span class='comment'>* propagation of DELs due to eviction. */</span></td></tr>
<tr class="codeline" data-linenumber="3644"><td class="num" id="LN3644">3644</td><td class="line">    <span class='keyword'>if</span> (server.maxmemory &amp;&amp; !server.lua_timedout) {</td></tr>
<tr class="codeline" data-linenumber="3645"><td class="num" id="LN3645">3645</td><td class="line">        <span class='keyword'>int</span> out_of_memory = freeMemoryIfNeededAndSafe() == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3646"><td class="num" id="LN3646">3646</td><td class="line">        <span class='comment'>/* freeMemoryIfNeeded may flush slave output buffers. This may result</span></td></tr>
<tr class="codeline" data-linenumber="3647"><td class="num" id="LN3647">3647</td><td class="line">         <span class='comment'>* into a slave, that may be the active client, to be freed. */</span></td></tr>
<tr class="codeline" data-linenumber="3648"><td class="num" id="LN3648">3648</td><td class="line">        <span class='keyword'>if</span> (server.current_client == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3649"><td class="num" id="LN3649">3649</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3650"><td class="num" id="LN3650">3650</td><td class="line">        <span class='keyword'>int</span> reject_cmd_on_oom = is_denyoom_command;</td></tr>
<tr class="codeline" data-linenumber="3651"><td class="num" id="LN3651">3651</td><td class="line">        <span class='comment'>/* If client is in MULTI/EXEC context, queuing may consume an unlimited</span></td></tr>
<tr class="codeline" data-linenumber="3652"><td class="num" id="LN3652">3652</td><td class="line">         <span class='comment'>* amount of memory, so we want to stop that.</span></td></tr>
<tr class="codeline" data-linenumber="3653"><td class="num" id="LN3653">3653</td><td class="line">         <span class='comment'>* However, we never want to reject DISCARD, or even EXEC (unless it</span></td></tr>
<tr class="codeline" data-linenumber="3654"><td class="num" id="LN3654">3654</td><td class="line">         <span class='comment'>* contains denied commands, in which case is_denyoom_command is already</span></td></tr>
<tr class="codeline" data-linenumber="3655"><td class="num" id="LN3655">3655</td><td class="line">         <span class='comment'>* set. */</span></td></tr>
<tr class="codeline" data-linenumber="3656"><td class="num" id="LN3656">3656</td><td class="line">        <span class='keyword'>if</span> (c-&gt;flags &amp; <span class='macro'>CLIENT_MULTI<span class='macro_popup'>(1&lt;&lt;3)</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3657"><td class="num" id="LN3657">3657</td><td class="line">            c-&gt;cmd-&gt;proc != execCommand &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3658"><td class="num" id="LN3658">3658</td><td class="line">            c-&gt;cmd-&gt;proc != discardCommand) {</td></tr>
<tr class="codeline" data-linenumber="3659"><td class="num" id="LN3659">3659</td><td class="line">            reject_cmd_on_oom = 1;</td></tr>
<tr class="codeline" data-linenumber="3660"><td class="num" id="LN3660">3660</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3661"><td class="num" id="LN3661">3661</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3662"><td class="num" id="LN3662">3662</td><td class="line">        <span class='keyword'>if</span> (out_of_memory &amp;&amp; reject_cmd_on_oom) {</td></tr>
<tr class="codeline" data-linenumber="3663"><td class="num" id="LN3663">3663</td><td class="line">            rejectCommand(c, shared.oomerr);</td></tr>
<tr class="codeline" data-linenumber="3664"><td class="num" id="LN3664">3664</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3665"><td class="num" id="LN3665">3665</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3666"><td class="num" id="LN3666">3666</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3667"><td class="num" id="LN3667">3667</td><td class="line">        <span class='comment'>/* Save out_of_memory result at script start, otherwise if we check OOM</span></td></tr>
<tr class="codeline" data-linenumber="3668"><td class="num" id="LN3668">3668</td><td class="line">         <span class='comment'>* until first write within script, memory used by lua stack and</span></td></tr>
<tr class="codeline" data-linenumber="3669"><td class="num" id="LN3669">3669</td><td class="line">         <span class='comment'>* arguments might interfere. */</span></td></tr>
<tr class="codeline" data-linenumber="3670"><td class="num" id="LN3670">3670</td><td class="line">        <span class='keyword'>if</span> (c-&gt;cmd-&gt;proc == evalCommand || c-&gt;cmd-&gt;proc == evalShaCommand) {</td></tr>
<tr class="codeline" data-linenumber="3671"><td class="num" id="LN3671">3671</td><td class="line">            server.lua_oom = out_of_memory;</td></tr>
<tr class="codeline" data-linenumber="3672"><td class="num" id="LN3672">3672</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3673"><td class="num" id="LN3673">3673</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3674"><td class="num" id="LN3674">3674</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3675"><td class="num" id="LN3675">3675</td><td class="line">    <span class='comment'>/* Make sure to use a reasonable amount of memory for client side</span></td></tr>
<tr class="codeline" data-linenumber="3676"><td class="num" id="LN3676">3676</td><td class="line">     <span class='comment'>* caching metadata. */</span></td></tr>
<tr class="codeline" data-linenumber="3677"><td class="num" id="LN3677">3677</td><td class="line">    <span class='keyword'>if</span> (server.tracking_clients) trackingLimitUsedSlots();</td></tr>
<tr class="codeline" data-linenumber="3678"><td class="num" id="LN3678">3678</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3679"><td class="num" id="LN3679">3679</td><td class="line">    <span class='comment'>/* Don't accept write commands if there are problems persisting on disk</span></td></tr>
<tr class="codeline" data-linenumber="3680"><td class="num" id="LN3680">3680</td><td class="line">     <span class='comment'>* and if this is a master instance. */</span></td></tr>
<tr class="codeline" data-linenumber="3681"><td class="num" id="LN3681">3681</td><td class="line">    <span class='keyword'>int</span> deny_write_type = writeCommandsDeniedByDiskError();</td></tr>
<tr class="codeline" data-linenumber="3682"><td class="num" id="LN3682">3682</td><td class="line">    <span class='keyword'>if</span> (deny_write_type != <span class='macro'>DISK_ERROR_TYPE_NONE<span class='macro_popup'>0</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3683"><td class="num" id="LN3683">3683</td><td class="line">        server.masterhost == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3684"><td class="num" id="LN3684">3684</td><td class="line">        (is_write_command ||c-&gt;cmd-&gt;proc == pingCommand))</td></tr>
<tr class="codeline" data-linenumber="3685"><td class="num" id="LN3685">3685</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3686"><td class="num" id="LN3686">3686</td><td class="line">        <span class='keyword'>if</span> (deny_write_type == <span class='macro'>DISK_ERROR_TYPE_RDB<span class='macro_popup'>2</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3687"><td class="num" id="LN3687">3687</td><td class="line">            rejectCommand(c, shared.bgsaveerr);</td></tr>
<tr class="codeline" data-linenumber="3688"><td class="num" id="LN3688">3688</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3689"><td class="num" id="LN3689">3689</td><td class="line">            rejectCommandFormat(c,</td></tr>
<tr class="codeline" data-linenumber="3690"><td class="num" id="LN3690">3690</td><td class="line">                <span class='string_literal'>"-MISCONF Errors writing to the AOF file: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="3691"><td class="num" id="LN3691">3691</td><td class="line">                strerror(server.aof_last_write_errno));</td></tr>
<tr class="codeline" data-linenumber="3692"><td class="num" id="LN3692">3692</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3693"><td class="num" id="LN3693">3693</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3694"><td class="num" id="LN3694">3694</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3695"><td class="num" id="LN3695">3695</td><td class="line">    <span class='comment'>/* Don't accept write commands if there are not enough good slaves and</span></td></tr>
<tr class="codeline" data-linenumber="3696"><td class="num" id="LN3696">3696</td><td class="line">     <span class='comment'>* user configured the min-slaves-to-write option. */</span></td></tr>
<tr class="codeline" data-linenumber="3697"><td class="num" id="LN3697">3697</td><td class="line">    <span class='keyword'>if</span> (server.masterhost == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3698"><td class="num" id="LN3698">3698</td><td class="line">        server.repl_min_slaves_to_write &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3699"><td class="num" id="LN3699">3699</td><td class="line">        server.repl_min_slaves_max_lag &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3700"><td class="num" id="LN3700">3700</td><td class="line">        is_write_command &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3701"><td class="num" id="LN3701">3701</td><td class="line">        server.repl_good_slaves_count &lt; server.repl_min_slaves_to_write)</td></tr>
<tr class="codeline" data-linenumber="3702"><td class="num" id="LN3702">3702</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3703"><td class="num" id="LN3703">3703</td><td class="line">        rejectCommand(c, shared.noreplicaserr);</td></tr>
<tr class="codeline" data-linenumber="3704"><td class="num" id="LN3704">3704</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3705"><td class="num" id="LN3705">3705</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3706"><td class="num" id="LN3706">3706</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3707"><td class="num" id="LN3707">3707</td><td class="line">    <span class='comment'>/* Don't accept write commands if this is a read only slave. But</span></td></tr>
<tr class="codeline" data-linenumber="3708"><td class="num" id="LN3708">3708</td><td class="line">     <span class='comment'>* accept write commands if this is our master. */</span></td></tr>
<tr class="codeline" data-linenumber="3709"><td class="num" id="LN3709">3709</td><td class="line">    <span class='keyword'>if</span> (server.masterhost &amp;&amp; server.repl_slave_ro &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3710"><td class="num" id="LN3710">3710</td><td class="line">        !(c-&gt;flags &amp; <span class='macro'>CLIENT_MASTER<span class='macro_popup'>(1&lt;&lt;1)</span></span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3711"><td class="num" id="LN3711">3711</td><td class="line">        is_write_command)</td></tr>
<tr class="codeline" data-linenumber="3712"><td class="num" id="LN3712">3712</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3713"><td class="num" id="LN3713">3713</td><td class="line">        rejectCommand(c, shared.roslaveerr);</td></tr>
<tr class="codeline" data-linenumber="3714"><td class="num" id="LN3714">3714</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3715"><td class="num" id="LN3715">3715</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3716"><td class="num" id="LN3716">3716</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3717"><td class="num" id="LN3717">3717</td><td class="line">    <span class='comment'>/* Only allow a subset of commands in the context of Pub/Sub if the</span></td></tr>
<tr class="codeline" data-linenumber="3718"><td class="num" id="LN3718">3718</td><td class="line">     <span class='comment'>* connection is in RESP2 mode. With RESP3 there are no limits. */</span></td></tr>
<tr class="codeline" data-linenumber="3719"><td class="num" id="LN3719">3719</td><td class="line">    <span class='keyword'>if</span> ((c-&gt;flags &amp; <span class='macro'>CLIENT_PUBSUB<span class='macro_popup'>(1&lt;&lt;18)</span></span> &amp;&amp; c-&gt;resp == 2) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3720"><td class="num" id="LN3720">3720</td><td class="line">        c-&gt;cmd-&gt;proc != pingCommand &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3721"><td class="num" id="LN3721">3721</td><td class="line">        c-&gt;cmd-&gt;proc != subscribeCommand &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3722"><td class="num" id="LN3722">3722</td><td class="line">        c-&gt;cmd-&gt;proc != unsubscribeCommand &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3723"><td class="num" id="LN3723">3723</td><td class="line">        c-&gt;cmd-&gt;proc != psubscribeCommand &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3724"><td class="num" id="LN3724">3724</td><td class="line">        c-&gt;cmd-&gt;proc != punsubscribeCommand) {</td></tr>
<tr class="codeline" data-linenumber="3725"><td class="num" id="LN3725">3725</td><td class="line">        rejectCommandFormat(c,</td></tr>
<tr class="codeline" data-linenumber="3726"><td class="num" id="LN3726">3726</td><td class="line">            <span class='string_literal'>"Can't execute '%s': only (P)SUBSCRIBE / "</span></td></tr>
<tr class="codeline" data-linenumber="3727"><td class="num" id="LN3727">3727</td><td class="line">            <span class='string_literal'>"(P)UNSUBSCRIBE / PING / QUIT are allowed in this context"</span>,</td></tr>
<tr class="codeline" data-linenumber="3728"><td class="num" id="LN3728">3728</td><td class="line">            c-&gt;cmd-&gt;name);</td></tr>
<tr class="codeline" data-linenumber="3729"><td class="num" id="LN3729">3729</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3730"><td class="num" id="LN3730">3730</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3731"><td class="num" id="LN3731">3731</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3732"><td class="num" id="LN3732">3732</td><td class="line">    <span class='comment'>/* Only allow commands with flag "t", such as INFO, SLAVEOF and so on,</span></td></tr>
<tr class="codeline" data-linenumber="3733"><td class="num" id="LN3733">3733</td><td class="line">     <span class='comment'>* when slave-serve-stale-data is no and we are a slave with a broken</span></td></tr>
<tr class="codeline" data-linenumber="3734"><td class="num" id="LN3734">3734</td><td class="line">     <span class='comment'>* link with master. */</span></td></tr>
<tr class="codeline" data-linenumber="3735"><td class="num" id="LN3735">3735</td><td class="line">    <span class='keyword'>if</span> (server.masterhost &amp;&amp; server.repl_state != <span class='macro'>REPL_STATE_CONNECTED<span class='macro_popup'>15</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3736"><td class="num" id="LN3736">3736</td><td class="line">        server.repl_serve_stale_data == 0 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3737"><td class="num" id="LN3737">3737</td><td class="line">        is_denystale_command)</td></tr>
<tr class="codeline" data-linenumber="3738"><td class="num" id="LN3738">3738</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3739"><td class="num" id="LN3739">3739</td><td class="line">        rejectCommand(c, shared.masterdownerr);</td></tr>
<tr class="codeline" data-linenumber="3740"><td class="num" id="LN3740">3740</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3741"><td class="num" id="LN3741">3741</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3742"><td class="num" id="LN3742">3742</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3743"><td class="num" id="LN3743">3743</td><td class="line">    <span class='comment'>/* Loading DB? Return an error if the command has not the</span></td></tr>
<tr class="codeline" data-linenumber="3744"><td class="num" id="LN3744">3744</td><td class="line">     <span class='comment'>* CMD_LOADING flag. */</span></td></tr>
<tr class="codeline" data-linenumber="3745"><td class="num" id="LN3745">3745</td><td class="line">    <span class='keyword'>if</span> (server.loading &amp;&amp; is_denyloading_command) {</td></tr>
<tr class="codeline" data-linenumber="3746"><td class="num" id="LN3746">3746</td><td class="line">        rejectCommand(c, shared.loadingerr);</td></tr>
<tr class="codeline" data-linenumber="3747"><td class="num" id="LN3747">3747</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3748"><td class="num" id="LN3748">3748</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3749"><td class="num" id="LN3749">3749</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3750"><td class="num" id="LN3750">3750</td><td class="line">    <span class='comment'>/* Lua script too slow? Only allow a limited number of commands.</span></td></tr>
<tr class="codeline" data-linenumber="3751"><td class="num" id="LN3751">3751</td><td class="line">     <span class='comment'>* Note that we need to allow the transactions commands, otherwise clients</span></td></tr>
<tr class="codeline" data-linenumber="3752"><td class="num" id="LN3752">3752</td><td class="line">     <span class='comment'>* sending a transaction with pipelining without error checking, may have</span></td></tr>
<tr class="codeline" data-linenumber="3753"><td class="num" id="LN3753">3753</td><td class="line">     <span class='comment'>* the MULTI plus a few initial commands refused, then the timeout</span></td></tr>
<tr class="codeline" data-linenumber="3754"><td class="num" id="LN3754">3754</td><td class="line">     <span class='comment'>* condition resolves, and the bottom-half of the transaction gets</span></td></tr>
<tr class="codeline" data-linenumber="3755"><td class="num" id="LN3755">3755</td><td class="line">     <span class='comment'>* executed, see Github PR #7022. */</span></td></tr>
<tr class="codeline" data-linenumber="3756"><td class="num" id="LN3756">3756</td><td class="line">    <span class='keyword'>if</span> (server.lua_timedout &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3757"><td class="num" id="LN3757">3757</td><td class="line">          c-&gt;cmd-&gt;proc != authCommand &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3758"><td class="num" id="LN3758">3758</td><td class="line">          c-&gt;cmd-&gt;proc != helloCommand &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3759"><td class="num" id="LN3759">3759</td><td class="line">          c-&gt;cmd-&gt;proc != replconfCommand &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3760"><td class="num" id="LN3760">3760</td><td class="line">          c-&gt;cmd-&gt;proc != multiCommand &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3761"><td class="num" id="LN3761">3761</td><td class="line">          c-&gt;cmd-&gt;proc != discardCommand &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3762"><td class="num" id="LN3762">3762</td><td class="line">          c-&gt;cmd-&gt;proc != watchCommand &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3763"><td class="num" id="LN3763">3763</td><td class="line">          c-&gt;cmd-&gt;proc != unwatchCommand &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3764"><td class="num" id="LN3764">3764</td><td class="line">        !(c-&gt;cmd-&gt;proc == shutdownCommand &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3765"><td class="num" id="LN3765">3765</td><td class="line">          c-&gt;argc == 2 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3766"><td class="num" id="LN3766">3766</td><td class="line">          <span class='macro'>tolower(((<span class='keyword'>char</span>*)c-&gt;argv[1]-&gt;ptr)[0])<span class='macro_popup'>(__extension__ ({ int __res; if (sizeof (((char*)c-&gt;argv[1<br>]-&gt;ptr)[0]) &gt; 1) { if (__builtin_constant_p (((char*)c-&gt;<br>argv[1]-&gt;ptr)[0])) { int __c = (((char*)c-&gt;argv[1]-&gt;<br>ptr)[0]); __res = __c &lt; -128 || __c &gt; 255 ? __c : (*__ctype_tolower_loc<br> ())[__c]; } else __res = tolower (((char*)c-&gt;argv[1]-&gt;<br>ptr)[0]); } else __res = (*__ctype_tolower_loc ())[(int) (((char<br>*)c-&gt;argv[1]-&gt;ptr)[0])]; __res; }))</span></span> == 'n') &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3767"><td class="num" id="LN3767">3767</td><td class="line">        !(c-&gt;cmd-&gt;proc == scriptCommand &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3768"><td class="num" id="LN3768">3768</td><td class="line">          c-&gt;argc == 2 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3769"><td class="num" id="LN3769">3769</td><td class="line">          <span class='macro'>tolower(((<span class='keyword'>char</span>*)c-&gt;argv[1]-&gt;ptr)[0])<span class='macro_popup'>(__extension__ ({ int __res; if (sizeof (((char*)c-&gt;argv[1<br>]-&gt;ptr)[0]) &gt; 1) { if (__builtin_constant_p (((char*)c-&gt;<br>argv[1]-&gt;ptr)[0])) { int __c = (((char*)c-&gt;argv[1]-&gt;<br>ptr)[0]); __res = __c &lt; -128 || __c &gt; 255 ? __c : (*__ctype_tolower_loc<br> ())[__c]; } else __res = tolower (((char*)c-&gt;argv[1]-&gt;<br>ptr)[0]); } else __res = (*__ctype_tolower_loc ())[(int) (((char<br>*)c-&gt;argv[1]-&gt;ptr)[0])]; __res; }))</span></span> == 'k'))</td></tr>
<tr class="codeline" data-linenumber="3770"><td class="num" id="LN3770">3770</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3771"><td class="num" id="LN3771">3771</td><td class="line">        rejectCommand(c, shared.slowscripterr);</td></tr>
<tr class="codeline" data-linenumber="3772"><td class="num" id="LN3772">3772</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3773"><td class="num" id="LN3773">3773</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3774"><td class="num" id="LN3774">3774</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3775"><td class="num" id="LN3775">3775</td><td class="line">    <span class='comment'>/* Exec the command */</span></td></tr>
<tr class="codeline" data-linenumber="3776"><td class="num" id="LN3776">3776</td><td class="line">    <span class='keyword'>if</span> (c-&gt;flags &amp; <span class='macro'>CLIENT_MULTI<span class='macro_popup'>(1&lt;&lt;3)</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3777"><td class="num" id="LN3777">3777</td><td class="line">        c-&gt;cmd-&gt;proc != execCommand &amp;&amp; c-&gt;cmd-&gt;proc != discardCommand &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3778"><td class="num" id="LN3778">3778</td><td class="line">        c-&gt;cmd-&gt;proc != multiCommand &amp;&amp; c-&gt;cmd-&gt;proc != watchCommand)</td></tr>
<tr class="codeline" data-linenumber="3779"><td class="num" id="LN3779">3779</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3780"><td class="num" id="LN3780">3780</td><td class="line">        queueMultiCommand(c);</td></tr>
<tr class="codeline" data-linenumber="3781"><td class="num" id="LN3781">3781</td><td class="line">        addReply(c,shared.queued);</td></tr>
<tr class="codeline" data-linenumber="3782"><td class="num" id="LN3782">3782</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3783"><td class="num" id="LN3783">3783</td><td class="line">        call(c,<span class='macro'>CMD_CALL_FULL<span class='macro_popup'>((1&lt;&lt;0) | (1&lt;&lt;1) | ((1&lt;&lt;2)|(1&lt;&lt;3)))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3784"><td class="num" id="LN3784">3784</td><td class="line">        c-&gt;woff = server.master_repl_offset;</td></tr>
<tr class="codeline" data-linenumber="3785"><td class="num" id="LN3785">3785</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>listLength(server.ready_keys)<span class='macro_popup'>((server.ready_keys)-&gt;len)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3786"><td class="num" id="LN3786">3786</td><td class="line">            handleClientsBlockedOnKeys();</td></tr>
<tr class="codeline" data-linenumber="3787"><td class="num" id="LN3787">3787</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3788"><td class="num" id="LN3788">3788</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3789"><td class="num" id="LN3789">3789</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3790"><td class="num" id="LN3790">3790</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3791"><td class="num" id="LN3791">3791</td><td class="line"><span class='comment'>/*================================== Shutdown =============================== */</span></td></tr>
<tr class="codeline" data-linenumber="3792"><td class="num" id="LN3792">3792</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3793"><td class="num" id="LN3793">3793</td><td class="line"><span class='comment'>/* Close listening sockets. Also unlink the unix domain socket if</span></td></tr>
<tr class="codeline" data-linenumber="3794"><td class="num" id="LN3794">3794</td><td class="line"> <span class='comment'>* unlink_unix_socket is non-zero. */</span></td></tr>
<tr class="codeline" data-linenumber="3795"><td class="num" id="LN3795">3795</td><td class="line"><span class='keyword'>void</span> closeListeningSockets(<span class='keyword'>int</span> unlink_unix_socket) {</td></tr>
<tr class="codeline" data-linenumber="3796"><td class="num" id="LN3796">3796</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="3797"><td class="num" id="LN3797">3797</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3798"><td class="num" id="LN3798">3798</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; server.ipfd_count; j++) close(server.ipfd[j]);</td></tr>
<tr class="codeline" data-linenumber="3799"><td class="num" id="LN3799">3799</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; server.tlsfd_count; j++) close(server.tlsfd[j]);</td></tr>
<tr class="codeline" data-linenumber="3800"><td class="num" id="LN3800">3800</td><td class="line">    <span class='keyword'>if</span> (server.sofd != -1) close(server.sofd);</td></tr>
<tr class="codeline" data-linenumber="3801"><td class="num" id="LN3801">3801</td><td class="line">    <span class='keyword'>if</span> (server.cluster_enabled)</td></tr>
<tr class="codeline" data-linenumber="3802"><td class="num" id="LN3802">3802</td><td class="line">        <span class='keyword'>for</span> (j = 0; j &lt; server.cfd_count; j++) close(server.cfd[j]);</td></tr>
<tr class="codeline" data-linenumber="3803"><td class="num" id="LN3803">3803</td><td class="line">    <span class='keyword'>if</span> (unlink_unix_socket &amp;&amp; server.unixsocket) {</td></tr>
<tr class="codeline" data-linenumber="3804"><td class="num" id="LN3804">3804</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Removing the unix socket file."</span>);</td></tr>
<tr class="codeline" data-linenumber="3805"><td class="num" id="LN3805">3805</td><td class="line">        unlink(server.unixsocket); <span class='comment'>/* don't care if this fails */</span></td></tr>
<tr class="codeline" data-linenumber="3806"><td class="num" id="LN3806">3806</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3807"><td class="num" id="LN3807">3807</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3808"><td class="num" id="LN3808">3808</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3809"><td class="num" id="LN3809">3809</td><td class="line"><span class='keyword'>int</span> prepareForShutdown(<span class='keyword'>int</span> flags) {</td></tr>
<tr class="codeline" data-linenumber="3810"><td class="num" id="LN3810">3810</td><td class="line">    <span class='comment'>/* When SHUTDOWN is called while the server is loading a dataset in</span></td></tr>
<tr class="codeline" data-linenumber="3811"><td class="num" id="LN3811">3811</td><td class="line">     <span class='comment'>* memory we need to make sure no attempt is performed to save</span></td></tr>
<tr class="codeline" data-linenumber="3812"><td class="num" id="LN3812">3812</td><td class="line">     <span class='comment'>* the dataset on shutdown (otherwise it could overwrite the current DB</span></td></tr>
<tr class="codeline" data-linenumber="3813"><td class="num" id="LN3813">3813</td><td class="line">     <span class='comment'>* with half-read data).</span></td></tr>
<tr class="codeline" data-linenumber="3814"><td class="num" id="LN3814">3814</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3815"><td class="num" id="LN3815">3815</td><td class="line">     <span class='comment'>* Also when in Sentinel mode clear the SAVE flag and force NOSAVE. */</span></td></tr>
<tr class="codeline" data-linenumber="3816"><td class="num" id="LN3816">3816</td><td class="line">    <span class='keyword'>if</span> (server.loading || server.sentinel_mode)</td></tr>
<tr class="codeline" data-linenumber="3817"><td class="num" id="LN3817">3817</td><td class="line">        flags = (flags &amp; ~<span class='macro'>SHUTDOWN_SAVE<span class='macro_popup'>1</span></span>) | <span class='macro'>SHUTDOWN_NOSAVE<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3818"><td class="num" id="LN3818">3818</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3819"><td class="num" id="LN3819">3819</td><td class="line">    <span class='keyword'>int</span> save = flags &amp; <span class='macro'>SHUTDOWN_SAVE<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3820"><td class="num" id="LN3820">3820</td><td class="line">    <span class='keyword'>int</span> nosave = flags &amp; <span class='macro'>SHUTDOWN_NOSAVE<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3821"><td class="num" id="LN3821">3821</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3822"><td class="num" id="LN3822">3822</td><td class="line">    serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"User requested shutdown..."</span>);</td></tr>
<tr class="codeline" data-linenumber="3823"><td class="num" id="LN3823">3823</td><td class="line">    <span class='keyword'>if</span> (server.supervised_mode == <span class='macro'>SUPERVISED_SYSTEMD<span class='macro_popup'>2</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3824"><td class="num" id="LN3824">3824</td><td class="line">        redisCommunicateSystemd(<span class='string_literal'>"STOPPING=1\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="3825"><td class="num" id="LN3825">3825</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3826"><td class="num" id="LN3826">3826</td><td class="line">    <span class='comment'>/* Kill all the Lua debugger forked sessions. */</span></td></tr>
<tr class="codeline" data-linenumber="3827"><td class="num" id="LN3827">3827</td><td class="line">    ldbKillForkedSessions();</td></tr>
<tr class="codeline" data-linenumber="3828"><td class="num" id="LN3828">3828</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3829"><td class="num" id="LN3829">3829</td><td class="line">    <span class='comment'>/* Kill the saving child if there is a background saving in progress.</span></td></tr>
<tr class="codeline" data-linenumber="3830"><td class="num" id="LN3830">3830</td><td class="line">       <span class='comment'>We want to avoid race conditions, for instance our saving child may</span></td></tr>
<tr class="codeline" data-linenumber="3831"><td class="num" id="LN3831">3831</td><td class="line">       <span class='comment'>overwrite the synchronous saving did by SHUTDOWN. */</span></td></tr>
<tr class="codeline" data-linenumber="3832"><td class="num" id="LN3832">3832</td><td class="line">    <span class='keyword'>if</span> (server.rdb_child_pid != -1) {</td></tr>
<tr class="codeline" data-linenumber="3833"><td class="num" id="LN3833">3833</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"There is a child saving an .rdb. Killing it!"</span>);</td></tr>
<tr class="codeline" data-linenumber="3834"><td class="num" id="LN3834">3834</td><td class="line">        <span class='comment'>/* Note that, in killRDBChild, we call rdbRemoveTempFile that will</span></td></tr>
<tr class="codeline" data-linenumber="3835"><td class="num" id="LN3835">3835</td><td class="line">         <span class='comment'>* do close fd(in order to unlink file actully) in background thread.</span></td></tr>
<tr class="codeline" data-linenumber="3836"><td class="num" id="LN3836">3836</td><td class="line">         <span class='comment'>* The temp rdb file fd may won't be closed when redis exits quickly,</span></td></tr>
<tr class="codeline" data-linenumber="3837"><td class="num" id="LN3837">3837</td><td class="line">         <span class='comment'>* but OS will close this fd when process exits. */</span></td></tr>
<tr class="codeline" data-linenumber="3838"><td class="num" id="LN3838">3838</td><td class="line">        killRDBChild();</td></tr>
<tr class="codeline" data-linenumber="3839"><td class="num" id="LN3839">3839</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3840"><td class="num" id="LN3840">3840</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3841"><td class="num" id="LN3841">3841</td><td class="line">    <span class='comment'>/* Kill module child if there is one. */</span></td></tr>
<tr class="codeline" data-linenumber="3842"><td class="num" id="LN3842">3842</td><td class="line">    <span class='keyword'>if</span> (server.module_child_pid != -1) {</td></tr>
<tr class="codeline" data-linenumber="3843"><td class="num" id="LN3843">3843</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"There is a module fork child. Killing it!"</span>);</td></tr>
<tr class="codeline" data-linenumber="3844"><td class="num" id="LN3844">3844</td><td class="line">        TerminateModuleForkChild(server.module_child_pid,0);</td></tr>
<tr class="codeline" data-linenumber="3845"><td class="num" id="LN3845">3845</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3846"><td class="num" id="LN3846">3846</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3847"><td class="num" id="LN3847">3847</td><td class="line">    <span class='keyword'>if</span> (server.aof_state != <span class='macro'>AOF_OFF<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3848"><td class="num" id="LN3848">3848</td><td class="line">        <span class='comment'>/* Kill the AOF saving child as the AOF we already have may be longer</span></td></tr>
<tr class="codeline" data-linenumber="3849"><td class="num" id="LN3849">3849</td><td class="line">         <span class='comment'>* but contains the full dataset anyway. */</span></td></tr>
<tr class="codeline" data-linenumber="3850"><td class="num" id="LN3850">3850</td><td class="line">        <span class='keyword'>if</span> (server.aof_child_pid != -1) {</td></tr>
<tr class="codeline" data-linenumber="3851"><td class="num" id="LN3851">3851</td><td class="line">            <span class='comment'>/* If we have AOF enabled but haven't written the AOF yet, don't</span></td></tr>
<tr class="codeline" data-linenumber="3852"><td class="num" id="LN3852">3852</td><td class="line">             <span class='comment'>* shutdown or else the dataset will be lost. */</span></td></tr>
<tr class="codeline" data-linenumber="3853"><td class="num" id="LN3853">3853</td><td class="line">            <span class='keyword'>if</span> (server.aof_state == <span class='macro'>AOF_WAIT_REWRITE<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3854"><td class="num" id="LN3854">3854</td><td class="line">                serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>, <span class='string_literal'>"Writing initial AOF, can't exit."</span>);</td></tr>
<tr class="codeline" data-linenumber="3855"><td class="num" id="LN3855">3855</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3856"><td class="num" id="LN3856">3856</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3857"><td class="num" id="LN3857">3857</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="3858"><td class="num" id="LN3858">3858</td><td class="line">                <span class='string_literal'>"There is a child rewriting the AOF. Killing it!"</span>);</td></tr>
<tr class="codeline" data-linenumber="3859"><td class="num" id="LN3859">3859</td><td class="line">            killAppendOnlyChild();</td></tr>
<tr class="codeline" data-linenumber="3860"><td class="num" id="LN3860">3860</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3861"><td class="num" id="LN3861">3861</td><td class="line">        <span class='comment'>/* Append only file: flush buffers and fsync() the AOF at exit */</span></td></tr>
<tr class="codeline" data-linenumber="3862"><td class="num" id="LN3862">3862</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Calling fsync() on the AOF file."</span>);</td></tr>
<tr class="codeline" data-linenumber="3863"><td class="num" id="LN3863">3863</td><td class="line">        flushAppendOnlyFile(1);</td></tr>
<tr class="codeline" data-linenumber="3864"><td class="num" id="LN3864">3864</td><td class="line">        <span class='macro'>redis_fsync<span class='macro_popup'>fdatasync</span></span>(server.aof_fd);</td></tr>
<tr class="codeline" data-linenumber="3865"><td class="num" id="LN3865">3865</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3866"><td class="num" id="LN3866">3866</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3867"><td class="num" id="LN3867">3867</td><td class="line">    <span class='comment'>/* Create a new RDB file before exiting. */</span></td></tr>
<tr class="codeline" data-linenumber="3868"><td class="num" id="LN3868">3868</td><td class="line">    <span class='keyword'>if</span> ((server.saveparamslen &gt; 0 &amp;&amp; !nosave) || save) {</td></tr>
<tr class="codeline" data-linenumber="3869"><td class="num" id="LN3869">3869</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Saving the final RDB snapshot before exiting."</span>);</td></tr>
<tr class="codeline" data-linenumber="3870"><td class="num" id="LN3870">3870</td><td class="line">        <span class='keyword'>if</span> (server.supervised_mode == <span class='macro'>SUPERVISED_SYSTEMD<span class='macro_popup'>2</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3871"><td class="num" id="LN3871">3871</td><td class="line">            redisCommunicateSystemd(<span class='string_literal'>"STATUS=Saving the final RDB snapshot\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="3872"><td class="num" id="LN3872">3872</td><td class="line">        <span class='comment'>/* Snapshotting. Perform a SYNC SAVE and exit */</span></td></tr>
<tr class="codeline" data-linenumber="3873"><td class="num" id="LN3873">3873</td><td class="line">        rdbSaveInfo rsi, *rsiptr;</td></tr>
<tr class="codeline" data-linenumber="3874"><td class="num" id="LN3874">3874</td><td class="line">        rsiptr = rdbPopulateSaveInfo(&amp;rsi);</td></tr>
<tr class="codeline" data-linenumber="3875"><td class="num" id="LN3875">3875</td><td class="line">        <span class='keyword'>if</span> (rdbSave(server.rdb_filename,rsiptr) != <span class='macro'>C_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3876"><td class="num" id="LN3876">3876</td><td class="line">            <span class='comment'>/* Ooops.. error saving! The best we can do is to continue</span></td></tr>
<tr class="codeline" data-linenumber="3877"><td class="num" id="LN3877">3877</td><td class="line">             <span class='comment'>* operating. Note that if there was a background saving process,</span></td></tr>
<tr class="codeline" data-linenumber="3878"><td class="num" id="LN3878">3878</td><td class="line">             <span class='comment'>* in the next cron() Redis will be notified that the background</span></td></tr>
<tr class="codeline" data-linenumber="3879"><td class="num" id="LN3879">3879</td><td class="line">             <span class='comment'>* saving aborted, handling special stuff like slaves pending for</span></td></tr>
<tr class="codeline" data-linenumber="3880"><td class="num" id="LN3880">3880</td><td class="line">             <span class='comment'>* synchronization... */</span></td></tr>
<tr class="codeline" data-linenumber="3881"><td class="num" id="LN3881">3881</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Error trying to save the DB, can't exit."</span>);</td></tr>
<tr class="codeline" data-linenumber="3882"><td class="num" id="LN3882">3882</td><td class="line">            <span class='keyword'>if</span> (server.supervised_mode == <span class='macro'>SUPERVISED_SYSTEMD<span class='macro_popup'>2</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3883"><td class="num" id="LN3883">3883</td><td class="line">                redisCommunicateSystemd(<span class='string_literal'>"STATUS=Error trying to save the DB, can't exit.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="3884"><td class="num" id="LN3884">3884</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3885"><td class="num" id="LN3885">3885</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3886"><td class="num" id="LN3886">3886</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3887"><td class="num" id="LN3887">3887</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3888"><td class="num" id="LN3888">3888</td><td class="line">    <span class='comment'>/* Fire the shutdown modules event. */</span></td></tr>
<tr class="codeline" data-linenumber="3889"><td class="num" id="LN3889">3889</td><td class="line">    moduleFireServerEvent(<span class='macro'>REDISMODULE_EVENT_SHUTDOWN<span class='macro_popup'>5</span></span>,0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3890"><td class="num" id="LN3890">3890</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3891"><td class="num" id="LN3891">3891</td><td class="line">    <span class='comment'>/* Remove the pid file if possible and needed. */</span></td></tr>
<tr class="codeline" data-linenumber="3892"><td class="num" id="LN3892">3892</td><td class="line">    <span class='keyword'>if</span> (server.daemonize || server.pidfile) {</td></tr>
<tr class="codeline" data-linenumber="3893"><td class="num" id="LN3893">3893</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Removing the pid file."</span>);</td></tr>
<tr class="codeline" data-linenumber="3894"><td class="num" id="LN3894">3894</td><td class="line">        unlink(server.pidfile);</td></tr>
<tr class="codeline" data-linenumber="3895"><td class="num" id="LN3895">3895</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3896"><td class="num" id="LN3896">3896</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3897"><td class="num" id="LN3897">3897</td><td class="line">    <span class='comment'>/* Best effort flush of slave output buffers, so that we hopefully</span></td></tr>
<tr class="codeline" data-linenumber="3898"><td class="num" id="LN3898">3898</td><td class="line">     <span class='comment'>* send them pending writes. */</span></td></tr>
<tr class="codeline" data-linenumber="3899"><td class="num" id="LN3899">3899</td><td class="line">    flushSlavesOutputBuffers();</td></tr>
<tr class="codeline" data-linenumber="3900"><td class="num" id="LN3900">3900</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3901"><td class="num" id="LN3901">3901</td><td class="line">    <span class='comment'>/* Close the listening sockets. Apparently this allows faster restarts. */</span></td></tr>
<tr class="codeline" data-linenumber="3902"><td class="num" id="LN3902">3902</td><td class="line">    closeListeningSockets(1);</td></tr>
<tr class="codeline" data-linenumber="3903"><td class="num" id="LN3903">3903</td><td class="line">    serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"%s is now ready to exit, bye bye..."</span>,</td></tr>
<tr class="codeline" data-linenumber="3904"><td class="num" id="LN3904">3904</td><td class="line">        server.sentinel_mode ? <span class='string_literal'>"Sentinel"</span> : <span class='string_literal'>"Redis"</span>);</td></tr>
<tr class="codeline" data-linenumber="3905"><td class="num" id="LN3905">3905</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3906"><td class="num" id="LN3906">3906</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3907"><td class="num" id="LN3907">3907</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3908"><td class="num" id="LN3908">3908</td><td class="line"><span class='comment'>/*================================== Commands =============================== */</span></td></tr>
<tr class="codeline" data-linenumber="3909"><td class="num" id="LN3909">3909</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3910"><td class="num" id="LN3910">3910</td><td class="line"><span class='comment'>/* Sometimes Redis cannot accept write commands because there is a persistence</span></td></tr>
<tr class="codeline" data-linenumber="3911"><td class="num" id="LN3911">3911</td><td class="line"> <span class='comment'>* error with the RDB or AOF file, and Redis is configured in order to stop</span></td></tr>
<tr class="codeline" data-linenumber="3912"><td class="num" id="LN3912">3912</td><td class="line"> <span class='comment'>* accepting writes in such situation. This function returns if such a</span></td></tr>
<tr class="codeline" data-linenumber="3913"><td class="num" id="LN3913">3913</td><td class="line"> <span class='comment'>* condition is active, and the type of the condition.</span></td></tr>
<tr class="codeline" data-linenumber="3914"><td class="num" id="LN3914">3914</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3915"><td class="num" id="LN3915">3915</td><td class="line"> <span class='comment'>* Function return values:</span></td></tr>
<tr class="codeline" data-linenumber="3916"><td class="num" id="LN3916">3916</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3917"><td class="num" id="LN3917">3917</td><td class="line"> <span class='comment'>* DISK_ERROR_TYPE_NONE:    No problems, we can accept writes.</span></td></tr>
<tr class="codeline" data-linenumber="3918"><td class="num" id="LN3918">3918</td><td class="line"> <span class='comment'>* DISK_ERROR_TYPE_AOF:     Don't accept writes: AOF errors.</span></td></tr>
<tr class="codeline" data-linenumber="3919"><td class="num" id="LN3919">3919</td><td class="line"> <span class='comment'>* DISK_ERROR_TYPE_RDB:     Don't accept writes: RDB errors.</span></td></tr>
<tr class="codeline" data-linenumber="3920"><td class="num" id="LN3920">3920</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3921"><td class="num" id="LN3921">3921</td><td class="line"><span class='keyword'>int</span> writeCommandsDeniedByDiskError(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="3922"><td class="num" id="LN3922">3922</td><td class="line">    <span class='keyword'>if</span> (server.stop_writes_on_bgsave_err &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3923"><td class="num" id="LN3923">3923</td><td class="line">        server.saveparamslen &gt; 0 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3924"><td class="num" id="LN3924">3924</td><td class="line">        server.lastbgsave_status == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3925"><td class="num" id="LN3925">3925</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3926"><td class="num" id="LN3926">3926</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>DISK_ERROR_TYPE_RDB<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3927"><td class="num" id="LN3927">3927</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (server.aof_state != <span class='macro'>AOF_OFF<span class='macro_popup'>0</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3928"><td class="num" id="LN3928">3928</td><td class="line">               server.aof_last_write_status == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3929"><td class="num" id="LN3929">3929</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3930"><td class="num" id="LN3930">3930</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>DISK_ERROR_TYPE_AOF<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3931"><td class="num" id="LN3931">3931</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3932"><td class="num" id="LN3932">3932</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>DISK_ERROR_TYPE_NONE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3933"><td class="num" id="LN3933">3933</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3934"><td class="num" id="LN3934">3934</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3935"><td class="num" id="LN3935">3935</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3936"><td class="num" id="LN3936">3936</td><td class="line"><span class='comment'>/* The PING command. It works in a different way if the client is in</span></td></tr>
<tr class="codeline" data-linenumber="3937"><td class="num" id="LN3937">3937</td><td class="line"> <span class='comment'>* in Pub/Sub mode. */</span></td></tr>
<tr class="codeline" data-linenumber="3938"><td class="num" id="LN3938">3938</td><td class="line"><span class='keyword'>void</span> pingCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="3939"><td class="num" id="LN3939">3939</td><td class="line">    <span class='comment'>/* The command takes zero or one arguments. */</span></td></tr>
<tr class="codeline" data-linenumber="3940"><td class="num" id="LN3940">3940</td><td class="line">    <span class='keyword'>if</span> (c-&gt;argc &gt; 2) {</td></tr>
<tr class="codeline" data-linenumber="3941"><td class="num" id="LN3941">3941</td><td class="line">        addReplyErrorFormat(c,<span class='string_literal'>"wrong number of arguments for '%s' command"</span>,</td></tr>
<tr class="codeline" data-linenumber="3942"><td class="num" id="LN3942">3942</td><td class="line">            c-&gt;cmd-&gt;name);</td></tr>
<tr class="codeline" data-linenumber="3943"><td class="num" id="LN3943">3943</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="3944"><td class="num" id="LN3944">3944</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3945"><td class="num" id="LN3945">3945</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3946"><td class="num" id="LN3946">3946</td><td class="line">    <span class='keyword'>if</span> (c-&gt;flags &amp; <span class='macro'>CLIENT_PUBSUB<span class='macro_popup'>(1&lt;&lt;18)</span></span> &amp;&amp; c-&gt;resp == 2) {</td></tr>
<tr class="codeline" data-linenumber="3947"><td class="num" id="LN3947">3947</td><td class="line">        addReply(c,shared.mbulkhdr[2]);</td></tr>
<tr class="codeline" data-linenumber="3948"><td class="num" id="LN3948">3948</td><td class="line">        addReplyBulkCBuffer(c,<span class='string_literal'>"pong"</span>,4);</td></tr>
<tr class="codeline" data-linenumber="3949"><td class="num" id="LN3949">3949</td><td class="line">        <span class='keyword'>if</span> (c-&gt;argc == 1)</td></tr>
<tr class="codeline" data-linenumber="3950"><td class="num" id="LN3950">3950</td><td class="line">            addReplyBulkCBuffer(c,<span class='string_literal'>""</span>,0);</td></tr>
<tr class="codeline" data-linenumber="3951"><td class="num" id="LN3951">3951</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3952"><td class="num" id="LN3952">3952</td><td class="line">            addReplyBulk(c,c-&gt;argv[1]);</td></tr>
<tr class="codeline" data-linenumber="3953"><td class="num" id="LN3953">3953</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3954"><td class="num" id="LN3954">3954</td><td class="line">        <span class='keyword'>if</span> (c-&gt;argc == 1)</td></tr>
<tr class="codeline" data-linenumber="3955"><td class="num" id="LN3955">3955</td><td class="line">            addReply(c,shared.pong);</td></tr>
<tr class="codeline" data-linenumber="3956"><td class="num" id="LN3956">3956</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="3957"><td class="num" id="LN3957">3957</td><td class="line">            addReplyBulk(c,c-&gt;argv[1]);</td></tr>
<tr class="codeline" data-linenumber="3958"><td class="num" id="LN3958">3958</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3959"><td class="num" id="LN3959">3959</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3960"><td class="num" id="LN3960">3960</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3961"><td class="num" id="LN3961">3961</td><td class="line"><span class='keyword'>void</span> echoCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="3962"><td class="num" id="LN3962">3962</td><td class="line">    addReplyBulk(c,c-&gt;argv[1]);</td></tr>
<tr class="codeline" data-linenumber="3963"><td class="num" id="LN3963">3963</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3964"><td class="num" id="LN3964">3964</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3965"><td class="num" id="LN3965">3965</td><td class="line"><span class='keyword'>void</span> timeCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="3966"><td class="num" id="LN3966">3966</td><td class="line">    <span class='keyword'>struct</span> timeval tv;</td></tr>
<tr class="codeline" data-linenumber="3967"><td class="num" id="LN3967">3967</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3968"><td class="num" id="LN3968">3968</td><td class="line">    <span class='comment'>/* gettimeofday() can only fail if &amp;tv is a bad address so we</span></td></tr>
<tr class="codeline" data-linenumber="3969"><td class="num" id="LN3969">3969</td><td class="line">     <span class='comment'>* don't check for errors. */</span></td></tr>
<tr class="codeline" data-linenumber="3970"><td class="num" id="LN3970">3970</td><td class="line">    gettimeofday(&amp;tv,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3971"><td class="num" id="LN3971">3971</td><td class="line">    addReplyArrayLen(c,2);</td></tr>
<tr class="codeline" data-linenumber="3972"><td class="num" id="LN3972">3972</td><td class="line">    addReplyBulkLongLong(c,tv.tv_sec);</td></tr>
<tr class="codeline" data-linenumber="3973"><td class="num" id="LN3973">3973</td><td class="line">    addReplyBulkLongLong(c,tv.tv_usec);</td></tr>
<tr class="codeline" data-linenumber="3974"><td class="num" id="LN3974">3974</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3975"><td class="num" id="LN3975">3975</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3976"><td class="num" id="LN3976">3976</td><td class="line"><span class='comment'>/* Helper function for addReplyCommand() to output flags. */</span></td></tr>
<tr class="codeline" data-linenumber="3977"><td class="num" id="LN3977">3977</td><td class="line"><span class='keyword'>int</span> addReplyCommandFlag(client *c, <span class='keyword'>struct</span> redisCommand *cmd, <span class='keyword'>int</span> f, <span class='keyword'>char</span> *reply) {</td></tr>
<tr class="codeline" data-linenumber="3978"><td class="num" id="LN3978">3978</td><td class="line">    <span class='keyword'>if</span> (cmd-&gt;flags &amp; f) {</td></tr>
<tr class="codeline" data-linenumber="3979"><td class="num" id="LN3979">3979</td><td class="line">        addReplyStatus(c, reply);</td></tr>
<tr class="codeline" data-linenumber="3980"><td class="num" id="LN3980">3980</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="3981"><td class="num" id="LN3981">3981</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3982"><td class="num" id="LN3982">3982</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="3983"><td class="num" id="LN3983">3983</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3984"><td class="num" id="LN3984">3984</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3985"><td class="num" id="LN3985">3985</td><td class="line"><span class='comment'>/* Output the representation of a Redis command. Used by the COMMAND command. */</span></td></tr>
<tr class="codeline" data-linenumber="3986"><td class="num" id="LN3986">3986</td><td class="line"><span class='keyword'>void</span> addReplyCommand(client *c, <span class='keyword'>struct</span> redisCommand *cmd) {</td></tr>
<tr class="codeline" data-linenumber="3987"><td class="num" id="LN3987">3987</td><td class="line">    <span class='keyword'>if</span> (!cmd) {</td></tr>
<tr class="codeline" data-linenumber="3988"><td class="num" id="LN3988">3988</td><td class="line">        addReplyNull(c);</td></tr>
<tr class="codeline" data-linenumber="3989"><td class="num" id="LN3989">3989</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3990"><td class="num" id="LN3990">3990</td><td class="line">        <span class='comment'>/* We are adding: command name, arg count, flags, first, last, offset, categories */</span></td></tr>
<tr class="codeline" data-linenumber="3991"><td class="num" id="LN3991">3991</td><td class="line">        addReplyArrayLen(c, 7);</td></tr>
<tr class="codeline" data-linenumber="3992"><td class="num" id="LN3992">3992</td><td class="line">        addReplyBulkCString(c, cmd-&gt;name);</td></tr>
<tr class="codeline" data-linenumber="3993"><td class="num" id="LN3993">3993</td><td class="line">        addReplyLongLong(c, cmd-&gt;arity);</td></tr>
<tr class="codeline" data-linenumber="3994"><td class="num" id="LN3994">3994</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3995"><td class="num" id="LN3995">3995</td><td class="line">        <span class='keyword'>int</span> flagcount = 0;</td></tr>
<tr class="codeline" data-linenumber="3996"><td class="num" id="LN3996">3996</td><td class="line">        <span class='keyword'>void</span> *flaglen = addReplyDeferredLen(c);</td></tr>
<tr class="codeline" data-linenumber="3997"><td class="num" id="LN3997">3997</td><td class="line">        flagcount += addReplyCommandFlag(c,cmd,<span class='macro'>CMD_WRITE<span class='macro_popup'>(1ULL&lt;&lt;0)</span></span>, <span class='string_literal'>"write"</span>);</td></tr>
<tr class="codeline" data-linenumber="3998"><td class="num" id="LN3998">3998</td><td class="line">        flagcount += addReplyCommandFlag(c,cmd,<span class='macro'>CMD_READONLY<span class='macro_popup'>(1ULL&lt;&lt;1)</span></span>, <span class='string_literal'>"readonly"</span>);</td></tr>
<tr class="codeline" data-linenumber="3999"><td class="num" id="LN3999">3999</td><td class="line">        flagcount += addReplyCommandFlag(c,cmd,<span class='macro'>CMD_DENYOOM<span class='macro_popup'>(1ULL&lt;&lt;2)</span></span>, <span class='string_literal'>"denyoom"</span>);</td></tr>
<tr class="codeline" data-linenumber="4000"><td class="num" id="LN4000">4000</td><td class="line">        flagcount += addReplyCommandFlag(c,cmd,<span class='macro'>CMD_ADMIN<span class='macro_popup'>(1ULL&lt;&lt;4)</span></span>, <span class='string_literal'>"admin"</span>);</td></tr>
<tr class="codeline" data-linenumber="4001"><td class="num" id="LN4001">4001</td><td class="line">        flagcount += addReplyCommandFlag(c,cmd,<span class='macro'>CMD_PUBSUB<span class='macro_popup'>(1ULL&lt;&lt;5)</span></span>, <span class='string_literal'>"pubsub"</span>);</td></tr>
<tr class="codeline" data-linenumber="4002"><td class="num" id="LN4002">4002</td><td class="line">        flagcount += addReplyCommandFlag(c,cmd,<span class='macro'>CMD_NOSCRIPT<span class='macro_popup'>(1ULL&lt;&lt;6)</span></span>, <span class='string_literal'>"noscript"</span>);</td></tr>
<tr class="codeline" data-linenumber="4003"><td class="num" id="LN4003">4003</td><td class="line">        flagcount += addReplyCommandFlag(c,cmd,<span class='macro'>CMD_RANDOM<span class='macro_popup'>(1ULL&lt;&lt;7)</span></span>, <span class='string_literal'>"random"</span>);</td></tr>
<tr class="codeline" data-linenumber="4004"><td class="num" id="LN4004">4004</td><td class="line">        flagcount += addReplyCommandFlag(c,cmd,<span class='macro'>CMD_SORT_FOR_SCRIPT<span class='macro_popup'>(1ULL&lt;&lt;8)</span></span>,<span class='string_literal'>"sort_for_script"</span>);</td></tr>
<tr class="codeline" data-linenumber="4005"><td class="num" id="LN4005">4005</td><td class="line">        flagcount += addReplyCommandFlag(c,cmd,<span class='macro'>CMD_LOADING<span class='macro_popup'>(1ULL&lt;&lt;9)</span></span>, <span class='string_literal'>"loading"</span>);</td></tr>
<tr class="codeline" data-linenumber="4006"><td class="num" id="LN4006">4006</td><td class="line">        flagcount += addReplyCommandFlag(c,cmd,<span class='macro'>CMD_STALE<span class='macro_popup'>(1ULL&lt;&lt;10)</span></span>, <span class='string_literal'>"stale"</span>);</td></tr>
<tr class="codeline" data-linenumber="4007"><td class="num" id="LN4007">4007</td><td class="line">        flagcount += addReplyCommandFlag(c,cmd,<span class='macro'>CMD_SKIP_MONITOR<span class='macro_popup'>(1ULL&lt;&lt;11)</span></span>, <span class='string_literal'>"skip_monitor"</span>);</td></tr>
<tr class="codeline" data-linenumber="4008"><td class="num" id="LN4008">4008</td><td class="line">        flagcount += addReplyCommandFlag(c,cmd,<span class='macro'>CMD_SKIP_SLOWLOG<span class='macro_popup'>(1ULL&lt;&lt;12)</span></span>, <span class='string_literal'>"skip_slowlog"</span>);</td></tr>
<tr class="codeline" data-linenumber="4009"><td class="num" id="LN4009">4009</td><td class="line">        flagcount += addReplyCommandFlag(c,cmd,<span class='macro'>CMD_ASKING<span class='macro_popup'>(1ULL&lt;&lt;13)</span></span>, <span class='string_literal'>"asking"</span>);</td></tr>
<tr class="codeline" data-linenumber="4010"><td class="num" id="LN4010">4010</td><td class="line">        flagcount += addReplyCommandFlag(c,cmd,<span class='macro'>CMD_FAST<span class='macro_popup'>(1ULL&lt;&lt;14)</span></span>, <span class='string_literal'>"fast"</span>);</td></tr>
<tr class="codeline" data-linenumber="4011"><td class="num" id="LN4011">4011</td><td class="line">        flagcount += addReplyCommandFlag(c,cmd,<span class='macro'>CMD_NO_AUTH<span class='macro_popup'>(1ULL&lt;&lt;15)</span></span>, <span class='string_literal'>"no_auth"</span>);</td></tr>
<tr class="codeline" data-linenumber="4012"><td class="num" id="LN4012">4012</td><td class="line">        <span class='keyword'>if</span> ((cmd-&gt;getkeys_proc &amp;&amp; !(cmd-&gt;flags &amp; <span class='macro'>CMD_MODULE<span class='macro_popup'>(1ULL&lt;&lt;3)</span></span>)) ||</td></tr>
<tr class="codeline" data-linenumber="4013"><td class="num" id="LN4013">4013</td><td class="line">            cmd-&gt;flags &amp; <span class='macro'>CMD_MODULE_GETKEYS<span class='macro_popup'>(1ULL&lt;&lt;16)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4014"><td class="num" id="LN4014">4014</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="4015"><td class="num" id="LN4015">4015</td><td class="line">            addReplyStatus(c, <span class='string_literal'>"movablekeys"</span>);</td></tr>
<tr class="codeline" data-linenumber="4016"><td class="num" id="LN4016">4016</td><td class="line">            flagcount += 1;</td></tr>
<tr class="codeline" data-linenumber="4017"><td class="num" id="LN4017">4017</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4018"><td class="num" id="LN4018">4018</td><td class="line">        setDeferredSetLen(c, flaglen, flagcount);</td></tr>
<tr class="codeline" data-linenumber="4019"><td class="num" id="LN4019">4019</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4020"><td class="num" id="LN4020">4020</td><td class="line">        addReplyLongLong(c, cmd-&gt;firstkey);</td></tr>
<tr class="codeline" data-linenumber="4021"><td class="num" id="LN4021">4021</td><td class="line">        addReplyLongLong(c, cmd-&gt;lastkey);</td></tr>
<tr class="codeline" data-linenumber="4022"><td class="num" id="LN4022">4022</td><td class="line">        addReplyLongLong(c, cmd-&gt;keystep);</td></tr>
<tr class="codeline" data-linenumber="4023"><td class="num" id="LN4023">4023</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4024"><td class="num" id="LN4024">4024</td><td class="line">        addReplyCommandCategories(c,cmd);</td></tr>
<tr class="codeline" data-linenumber="4025"><td class="num" id="LN4025">4025</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4026"><td class="num" id="LN4026">4026</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4027"><td class="num" id="LN4027">4027</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4028"><td class="num" id="LN4028">4028</td><td class="line"><span class='comment'>/* COMMAND &lt;subcommand&gt; &lt;args&gt; */</span></td></tr>
<tr class="codeline" data-linenumber="4029"><td class="num" id="LN4029">4029</td><td class="line"><span class='keyword'>void</span> commandCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="4030"><td class="num" id="LN4030">4030</td><td class="line">    dictIterator *di;</td></tr>
<tr class="codeline" data-linenumber="4031"><td class="num" id="LN4031">4031</td><td class="line">    dictEntry *de;</td></tr>
<tr class="codeline" data-linenumber="4032"><td class="num" id="LN4032">4032</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4033"><td class="num" id="LN4033">4033</td><td class="line">    <span class='keyword'>if</span> (c-&gt;argc == 2 &amp;&amp; !strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class='string_literal'>"help"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="4034"><td class="num" id="LN4034">4034</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>char</span> *help[] = {</td></tr>
<tr class="codeline" data-linenumber="4035"><td class="num" id="LN4035">4035</td><td class="line"><span class='string_literal'>"(no subcommand) -- Return details about all Redis commands."</span>,</td></tr>
<tr class="codeline" data-linenumber="4036"><td class="num" id="LN4036">4036</td><td class="line"><span class='string_literal'>"COUNT -- Return the total number of commands in this Redis server."</span>,</td></tr>
<tr class="codeline" data-linenumber="4037"><td class="num" id="LN4037">4037</td><td class="line"><span class='string_literal'>"GETKEYS &lt;full-command&gt; -- Return the keys from a full Redis command."</span>,</td></tr>
<tr class="codeline" data-linenumber="4038"><td class="num" id="LN4038">4038</td><td class="line"><span class='string_literal'>"INFO [command-name ...] -- Return details about multiple Redis commands."</span>,</td></tr>
<tr class="codeline" data-linenumber="4039"><td class="num" id="LN4039">4039</td><td class="line"><span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="4040"><td class="num" id="LN4040">4040</td><td class="line">        };</td></tr>
<tr class="codeline" data-linenumber="4041"><td class="num" id="LN4041">4041</td><td class="line">        addReplyHelp(c, help);</td></tr>
<tr class="codeline" data-linenumber="4042"><td class="num" id="LN4042">4042</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (c-&gt;argc == 1) {</td></tr>
<tr class="codeline" data-linenumber="4043"><td class="num" id="LN4043">4043</td><td class="line">        addReplyArrayLen(c, <span class='macro'>dictSize(server.commands)<span class='macro_popup'>((server.commands)-&gt;ht[0].used+(server.commands)-&gt;ht[1]<br>.used)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4044"><td class="num" id="LN4044">4044</td><td class="line">        di = dictGetIterator(server.commands);</td></tr>
<tr class="codeline" data-linenumber="4045"><td class="num" id="LN4045">4045</td><td class="line">        <span class='keyword'>while</span> ((de = dictNext(di)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4046"><td class="num" id="LN4046">4046</td><td class="line">            addReplyCommand(c, <span class='macro'>dictGetVal(de)<span class='macro_popup'>((de)-&gt;v.val)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4047"><td class="num" id="LN4047">4047</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4048"><td class="num" id="LN4048">4048</td><td class="line">        dictReleaseIterator(di);</td></tr>
<tr class="codeline" data-linenumber="4049"><td class="num" id="LN4049">4049</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(c-&gt;argv[1]-&gt;ptr, <span class='string_literal'>"info"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="4050"><td class="num" id="LN4050">4050</td><td class="line">        <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="4051"><td class="num" id="LN4051">4051</td><td class="line">        addReplyArrayLen(c, c-&gt;argc-2);</td></tr>
<tr class="codeline" data-linenumber="4052"><td class="num" id="LN4052">4052</td><td class="line">        <span class='keyword'>for</span> (i = 2; i &lt; c-&gt;argc; i++) {</td></tr>
<tr class="codeline" data-linenumber="4053"><td class="num" id="LN4053">4053</td><td class="line">            addReplyCommand(c, dictFetchValue(server.commands, c-&gt;argv[i]-&gt;ptr));</td></tr>
<tr class="codeline" data-linenumber="4054"><td class="num" id="LN4054">4054</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4055"><td class="num" id="LN4055">4055</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(c-&gt;argv[1]-&gt;ptr, <span class='string_literal'>"count"</span>) &amp;&amp; c-&gt;argc == 2) {</td></tr>
<tr class="codeline" data-linenumber="4056"><td class="num" id="LN4056">4056</td><td class="line">        addReplyLongLong(c, <span class='macro'>dictSize(server.commands)<span class='macro_popup'>((server.commands)-&gt;ht[0].used+(server.commands)-&gt;ht[1]<br>.used)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4057"><td class="num" id="LN4057">4057</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class='string_literal'>"getkeys"</span>) &amp;&amp; c-&gt;argc &gt;= 3) {</td></tr>
<tr class="codeline" data-linenumber="4058"><td class="num" id="LN4058">4058</td><td class="line">        <span class='keyword'>struct</span> redisCommand *cmd = lookupCommand(c-&gt;argv[2]-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="4059"><td class="num" id="LN4059">4059</td><td class="line">        getKeysResult result = <span class='macro'>GETKEYS_RESULT_INIT<span class='macro_popup'>{ {0}, ((void*)0), 0, 256 }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4060"><td class="num" id="LN4060">4060</td><td class="line">        <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="4061"><td class="num" id="LN4061">4061</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4062"><td class="num" id="LN4062">4062</td><td class="line">        <span class='keyword'>if</span> (!cmd) {</td></tr>
<tr class="codeline" data-linenumber="4063"><td class="num" id="LN4063">4063</td><td class="line">            addReplyError(c,<span class='string_literal'>"Invalid command specified"</span>);</td></tr>
<tr class="codeline" data-linenumber="4064"><td class="num" id="LN4064">4064</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="4065"><td class="num" id="LN4065">4065</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (cmd-&gt;getkeys_proc == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; cmd-&gt;firstkey == 0) {</td></tr>
<tr class="codeline" data-linenumber="4066"><td class="num" id="LN4066">4066</td><td class="line">            addReplyError(c,<span class='string_literal'>"The command has no key arguments"</span>);</td></tr>
<tr class="codeline" data-linenumber="4067"><td class="num" id="LN4067">4067</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="4068"><td class="num" id="LN4068">4068</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> ((cmd-&gt;arity &gt; 0 &amp;&amp; cmd-&gt;arity != c-&gt;argc-2) ||</td></tr>
<tr class="codeline" data-linenumber="4069"><td class="num" id="LN4069">4069</td><td class="line">                   ((c-&gt;argc-2) &lt; -cmd-&gt;arity))</td></tr>
<tr class="codeline" data-linenumber="4070"><td class="num" id="LN4070">4070</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="4071"><td class="num" id="LN4071">4071</td><td class="line">            addReplyError(c,<span class='string_literal'>"Invalid number of arguments specified for command"</span>);</td></tr>
<tr class="codeline" data-linenumber="4072"><td class="num" id="LN4072">4072</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="4073"><td class="num" id="LN4073">4073</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4074"><td class="num" id="LN4074">4074</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4075"><td class="num" id="LN4075">4075</td><td class="line">        <span class='keyword'>if</span> (!getKeysFromCommand(cmd,c-&gt;argv+2,c-&gt;argc-2,&amp;result)) {</td></tr>
<tr class="codeline" data-linenumber="4076"><td class="num" id="LN4076">4076</td><td class="line">            addReplyError(c,<span class='string_literal'>"Invalid arguments specified for command"</span>);</td></tr>
<tr class="codeline" data-linenumber="4077"><td class="num" id="LN4077">4077</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="4078"><td class="num" id="LN4078">4078</td><td class="line">            addReplyArrayLen(c,result.numkeys);</td></tr>
<tr class="codeline" data-linenumber="4079"><td class="num" id="LN4079">4079</td><td class="line">            <span class='keyword'>for</span> (j = 0; j &lt; result.numkeys; j++) addReplyBulk(c,c-&gt;argv[result.keys[j]+2]);</td></tr>
<tr class="codeline" data-linenumber="4080"><td class="num" id="LN4080">4080</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4081"><td class="num" id="LN4081">4081</td><td class="line">        getKeysFreeResult(&amp;result);</td></tr>
<tr class="codeline" data-linenumber="4082"><td class="num" id="LN4082">4082</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="4083"><td class="num" id="LN4083">4083</td><td class="line">        addReplySubcommandSyntaxError(c);</td></tr>
<tr class="codeline" data-linenumber="4084"><td class="num" id="LN4084">4084</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4085"><td class="num" id="LN4085">4085</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4086"><td class="num" id="LN4086">4086</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4087"><td class="num" id="LN4087">4087</td><td class="line"><span class='comment'>/* Convert an amount of bytes into a human readable string in the form</span></td></tr>
<tr class="codeline" data-linenumber="4088"><td class="num" id="LN4088">4088</td><td class="line"> <span class='comment'>* of 100B, 2G, 100M, 4K, and so forth. */</span></td></tr>
<tr class="codeline" data-linenumber="4089"><td class="num" id="LN4089">4089</td><td class="line"><span class='keyword'>void</span> bytesToHuman(<span class='keyword'>char</span> *s, <span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span> n) {</td></tr>
<tr class="codeline" data-linenumber="4090"><td class="num" id="LN4090">4090</td><td class="line">    <span class='keyword'>double</span> d;</td></tr>
<tr class="codeline" data-linenumber="4091"><td class="num" id="LN4091">4091</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4092"><td class="num" id="LN4092">4092</td><td class="line">    <span class='keyword'>if</span> (n &lt; 1024) {</td></tr>
<tr class="codeline" data-linenumber="4093"><td class="num" id="LN4093">4093</td><td class="line">        <span class='comment'>/* Bytes */</span></td></tr>
<tr class="codeline" data-linenumber="4094"><td class="num" id="LN4094">4094</td><td class="line">        sprintf(s,<span class='string_literal'>"%lluB"</span>,n);</td></tr>
<tr class="codeline" data-linenumber="4095"><td class="num" id="LN4095">4095</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (n &lt; (1024*1024)) {</td></tr>
<tr class="codeline" data-linenumber="4096"><td class="num" id="LN4096">4096</td><td class="line">        d = (<span class='keyword'>double</span>)n/(1024);</td></tr>
<tr class="codeline" data-linenumber="4097"><td class="num" id="LN4097">4097</td><td class="line">        sprintf(s,<span class='string_literal'>"%.2fK"</span>,d);</td></tr>
<tr class="codeline" data-linenumber="4098"><td class="num" id="LN4098">4098</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (n &lt; (1024LL*1024*1024)) {</td></tr>
<tr class="codeline" data-linenumber="4099"><td class="num" id="LN4099">4099</td><td class="line">        d = (<span class='keyword'>double</span>)n/(1024*1024);</td></tr>
<tr class="codeline" data-linenumber="4100"><td class="num" id="LN4100">4100</td><td class="line">        sprintf(s,<span class='string_literal'>"%.2fM"</span>,d);</td></tr>
<tr class="codeline" data-linenumber="4101"><td class="num" id="LN4101">4101</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (n &lt; (1024LL*1024*1024*1024)) {</td></tr>
<tr class="codeline" data-linenumber="4102"><td class="num" id="LN4102">4102</td><td class="line">        d = (<span class='keyword'>double</span>)n/(1024LL*1024*1024);</td></tr>
<tr class="codeline" data-linenumber="4103"><td class="num" id="LN4103">4103</td><td class="line">        sprintf(s,<span class='string_literal'>"%.2fG"</span>,d);</td></tr>
<tr class="codeline" data-linenumber="4104"><td class="num" id="LN4104">4104</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (n &lt; (1024LL*1024*1024*1024*1024)) {</td></tr>
<tr class="codeline" data-linenumber="4105"><td class="num" id="LN4105">4105</td><td class="line">        d = (<span class='keyword'>double</span>)n/(1024LL*1024*1024*1024);</td></tr>
<tr class="codeline" data-linenumber="4106"><td class="num" id="LN4106">4106</td><td class="line">        sprintf(s,<span class='string_literal'>"%.2fT"</span>,d);</td></tr>
<tr class="codeline" data-linenumber="4107"><td class="num" id="LN4107">4107</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (n &lt; (1024LL*1024*1024*1024*1024*1024)) {</td></tr>
<tr class="codeline" data-linenumber="4108"><td class="num" id="LN4108">4108</td><td class="line">        d = (<span class='keyword'>double</span>)n/(1024LL*1024*1024*1024*1024);</td></tr>
<tr class="codeline" data-linenumber="4109"><td class="num" id="LN4109">4109</td><td class="line">        sprintf(s,<span class='string_literal'>"%.2fP"</span>,d);</td></tr>
<tr class="codeline" data-linenumber="4110"><td class="num" id="LN4110">4110</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="4111"><td class="num" id="LN4111">4111</td><td class="line">        <span class='comment'>/* Let's hope we never need this */</span></td></tr>
<tr class="codeline" data-linenumber="4112"><td class="num" id="LN4112">4112</td><td class="line">        sprintf(s,<span class='string_literal'>"%lluB"</span>,n);</td></tr>
<tr class="codeline" data-linenumber="4113"><td class="num" id="LN4113">4113</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4114"><td class="num" id="LN4114">4114</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4115"><td class="num" id="LN4115">4115</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4116"><td class="num" id="LN4116">4116</td><td class="line"><span class='comment'>/* Create the string returned by the INFO command. This is decoupled</span></td></tr>
<tr class="codeline" data-linenumber="4117"><td class="num" id="LN4117">4117</td><td class="line"> <span class='comment'>* by the INFO command itself as we need to report the same information</span></td></tr>
<tr class="codeline" data-linenumber="4118"><td class="num" id="LN4118">4118</td><td class="line"> <span class='comment'>* on memory corruption problems. */</span></td></tr>
<tr class="codeline" data-linenumber="4119"><td class="num" id="LN4119">4119</td><td class="line">sds genRedisInfoString(<span class='keyword'>const</span> <span class='keyword'>char</span> *section) {</td></tr>
<tr class="codeline" data-linenumber="4120"><td class="num" id="LN4120">4120</td><td class="line">    sds info = sdsempty();</td></tr>
<tr class="codeline" data-linenumber="4121"><td class="num" id="LN4121">4121</td><td class="line">    time_t uptime = server.unixtime-server.stat_starttime;</td></tr>
<tr class="codeline" data-linenumber="4122"><td class="num" id="LN4122">4122</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="4123"><td class="num" id="LN4123">4123</td><td class="line">    <span class='keyword'>struct</span> rusage self_ru, c_ru;</td></tr>
<tr class="codeline" data-linenumber="4124"><td class="num" id="LN4124">4124</td><td class="line">    <span class='keyword'>int</span> allsections = 0, defsections = 0, everything = 0, modules = 0;</td></tr>
<tr class="codeline" data-linenumber="4125"><td class="num" id="LN4125">4125</td><td class="line">    <span class='keyword'>int</span> sections = 0;</td></tr>
<tr class="codeline" data-linenumber="4126"><td class="num" id="LN4126">4126</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4127"><td class="num" id="LN4127">4127</td><td class="line">    <span class='keyword'>if</span> (section == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) section = <span class='string_literal'>"default"</span>;</td></tr>
<tr class="codeline" data-linenumber="4128"><td class="num" id="LN4128">4128</td><td class="line">    allsections = strcasecmp(section,<span class='string_literal'>"all"</span>) == 0;</td></tr>
<tr class="codeline" data-linenumber="4129"><td class="num" id="LN4129">4129</td><td class="line">    defsections = strcasecmp(section,<span class='string_literal'>"default"</span>) == 0;</td></tr>
<tr class="codeline" data-linenumber="4130"><td class="num" id="LN4130">4130</td><td class="line">    everything = strcasecmp(section,<span class='string_literal'>"everything"</span>) == 0;</td></tr>
<tr class="codeline" data-linenumber="4131"><td class="num" id="LN4131">4131</td><td class="line">    modules = strcasecmp(section,<span class='string_literal'>"modules"</span>) == 0;</td></tr>
<tr class="codeline" data-linenumber="4132"><td class="num" id="LN4132">4132</td><td class="line">    <span class='keyword'>if</span> (everything) allsections = 1;</td></tr>
<tr class="codeline" data-linenumber="4133"><td class="num" id="LN4133">4133</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4134"><td class="num" id="LN4134">4134</td><td class="line">    getrusage(<span class='macro'>RUSAGE_SELF<span class='macro_popup'>RUSAGE_SELF</span></span>, &amp;self_ru);</td></tr>
<tr class="codeline" data-linenumber="4135"><td class="num" id="LN4135">4135</td><td class="line">    getrusage(<span class='macro'>RUSAGE_CHILDREN<span class='macro_popup'>RUSAGE_CHILDREN</span></span>, &amp;c_ru);</td></tr>
<tr class="codeline" data-linenumber="4136"><td class="num" id="LN4136">4136</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4137"><td class="num" id="LN4137">4137</td><td class="line">    <span class='comment'>/* Server */</span></td></tr>
<tr class="codeline" data-linenumber="4138"><td class="num" id="LN4138">4138</td><td class="line">    <span class='keyword'>if</span> (allsections || defsections || !strcasecmp(section,<span class='string_literal'>"server"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="4139"><td class="num" id="LN4139">4139</td><td class="line">        <span class='keyword'>static</span> <span class='keyword'>int</span> call_uname = 1;</td></tr>
<tr class="codeline" data-linenumber="4140"><td class="num" id="LN4140">4140</td><td class="line">        <span class='keyword'>static</span> <span class='keyword'>struct</span> utsname name;</td></tr>
<tr class="codeline" data-linenumber="4141"><td class="num" id="LN4141">4141</td><td class="line">        <span class='keyword'>char</span> *mode;</td></tr>
<tr class="codeline" data-linenumber="4142"><td class="num" id="LN4142">4142</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4143"><td class="num" id="LN4143">4143</td><td class="line">        <span class='keyword'>if</span> (server.cluster_enabled) mode = <span class='string_literal'>"cluster"</span>;</td></tr>
<tr class="codeline" data-linenumber="4144"><td class="num" id="LN4144">4144</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (server.sentinel_mode) mode = <span class='string_literal'>"sentinel"</span>;</td></tr>
<tr class="codeline" data-linenumber="4145"><td class="num" id="LN4145">4145</td><td class="line">        <span class='keyword'>else</span> mode = <span class='string_literal'>"standalone"</span>;</td></tr>
<tr class="codeline" data-linenumber="4146"><td class="num" id="LN4146">4146</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4147"><td class="num" id="LN4147">4147</td><td class="line">        <span class='keyword'>if</span> (sections++) info = sdscat(info,<span class='string_literal'>"\r\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4148"><td class="num" id="LN4148">4148</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4149"><td class="num" id="LN4149">4149</td><td class="line">        <span class='keyword'>if</span> (call_uname) {</td></tr>
<tr class="codeline" data-linenumber="4150"><td class="num" id="LN4150">4150</td><td class="line">            <span class='comment'>/* Uname can be slow and is always the same output. Cache it. */</span></td></tr>
<tr class="codeline" data-linenumber="4151"><td class="num" id="LN4151">4151</td><td class="line">            uname(&amp;name);</td></tr>
<tr class="codeline" data-linenumber="4152"><td class="num" id="LN4152">4152</td><td class="line">            call_uname = 0;</td></tr>
<tr class="codeline" data-linenumber="4153"><td class="num" id="LN4153">4153</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4154"><td class="num" id="LN4154">4154</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4155"><td class="num" id="LN4155">4155</td><td class="line">        info = sdscatfmt(info,</td></tr>
<tr class="codeline" data-linenumber="4156"><td class="num" id="LN4156">4156</td><td class="line">            <span class='string_literal'>"# Server\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4157"><td class="num" id="LN4157">4157</td><td class="line">            <span class='string_literal'>"redis_version:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4158"><td class="num" id="LN4158">4158</td><td class="line">            <span class='string_literal'>"redis_git_sha1:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4159"><td class="num" id="LN4159">4159</td><td class="line">            <span class='string_literal'>"redis_git_dirty:%i\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4160"><td class="num" id="LN4160">4160</td><td class="line">            <span class='string_literal'>"redis_build_id:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4161"><td class="num" id="LN4161">4161</td><td class="line">            <span class='string_literal'>"redis_mode:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4162"><td class="num" id="LN4162">4162</td><td class="line">            <span class='string_literal'>"os:%s %s %s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4163"><td class="num" id="LN4163">4163</td><td class="line">            <span class='string_literal'>"arch_bits:%i\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4164"><td class="num" id="LN4164">4164</td><td class="line">            <span class='string_literal'>"multiplexing_api:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4165"><td class="num" id="LN4165">4165</td><td class="line">            <span class='string_literal'>"atomicvar_api:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4166"><td class="num" id="LN4166">4166</td><td class="line">            <span class='string_literal'>"gcc_version:%i.%i.%i\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4167"><td class="num" id="LN4167">4167</td><td class="line">            <span class='string_literal'>"process_id:%I\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4168"><td class="num" id="LN4168">4168</td><td class="line">            <span class='string_literal'>"run_id:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4169"><td class="num" id="LN4169">4169</td><td class="line">            <span class='string_literal'>"tcp_port:%i\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4170"><td class="num" id="LN4170">4170</td><td class="line">            <span class='string_literal'>"uptime_in_seconds:%I\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4171"><td class="num" id="LN4171">4171</td><td class="line">            <span class='string_literal'>"uptime_in_days:%I\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4172"><td class="num" id="LN4172">4172</td><td class="line">            <span class='string_literal'>"hz:%i\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4173"><td class="num" id="LN4173">4173</td><td class="line">            <span class='string_literal'>"configured_hz:%i\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4174"><td class="num" id="LN4174">4174</td><td class="line">            <span class='string_literal'>"lru_clock:%u\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4175"><td class="num" id="LN4175">4175</td><td class="line">            <span class='string_literal'>"executable:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4176"><td class="num" id="LN4176">4176</td><td class="line">            <span class='string_literal'>"config_file:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4177"><td class="num" id="LN4177">4177</td><td class="line">            <span class='string_literal'>"io_threads_active:%i\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="4178"><td class="num" id="LN4178">4178</td><td class="line">            <span class='macro'>REDIS_VERSION<span class='macro_popup'>"6.0.9"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4179"><td class="num" id="LN4179">4179</td><td class="line">            redisGitSHA1(),</td></tr>
<tr class="codeline" data-linenumber="4180"><td class="num" id="LN4180">4180</td><td class="line">            strtol(redisGitDirty(),<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,10) &gt; 0,</td></tr>
<tr class="codeline" data-linenumber="4181"><td class="num" id="LN4181">4181</td><td class="line">            redisBuildIdString(),</td></tr>
<tr class="codeline" data-linenumber="4182"><td class="num" id="LN4182">4182</td><td class="line">            mode,</td></tr>
<tr class="codeline" data-linenumber="4183"><td class="num" id="LN4183">4183</td><td class="line">            name.sysname, name.release, name.machine,</td></tr>
<tr class="codeline" data-linenumber="4184"><td class="num" id="LN4184">4184</td><td class="line">            server.arch_bits,</td></tr>
<tr class="codeline" data-linenumber="4185"><td class="num" id="LN4185">4185</td><td class="line">            aeGetApiName(),</td></tr>
<tr class="codeline" data-linenumber="4186"><td class="num" id="LN4186">4186</td><td class="line">            <span class='macro'>REDIS_ATOMIC_API<span class='macro_popup'>"atomic-builtin"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4187"><td class="num" id="LN4187">4187</td><td class="line"><span class='directive'>#ifdef <span class='macro'>__GNUC__<span class='macro_popup'>4</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4188"><td class="num" id="LN4188">4188</td><td class="line">            <span class='macro'>__GNUC__<span class='macro_popup'>4</span></span>,<span class='macro'>__GNUC_MINOR__<span class='macro_popup'>2</span></span>,<span class='macro'>__GNUC_PATCHLEVEL__<span class='macro_popup'>1</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4189"><td class="num" id="LN4189">4189</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="4190"><td class="num" id="LN4190">4190</td><td class="line">            0,0,0,</td></tr>
<tr class="codeline" data-linenumber="4191"><td class="num" id="LN4191">4191</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="4192"><td class="num" id="LN4192">4192</td><td class="line">            (int64_t) getpid(),</td></tr>
<tr class="codeline" data-linenumber="4193"><td class="num" id="LN4193">4193</td><td class="line">            server.runid,</td></tr>
<tr class="codeline" data-linenumber="4194"><td class="num" id="LN4194">4194</td><td class="line">            server.port ? server.port : server.tls_port,</td></tr>
<tr class="codeline" data-linenumber="4195"><td class="num" id="LN4195">4195</td><td class="line">            (int64_t)uptime,</td></tr>
<tr class="codeline" data-linenumber="4196"><td class="num" id="LN4196">4196</td><td class="line">            (int64_t)(uptime/(3600*24)),</td></tr>
<tr class="codeline" data-linenumber="4197"><td class="num" id="LN4197">4197</td><td class="line">            server.hz,</td></tr>
<tr class="codeline" data-linenumber="4198"><td class="num" id="LN4198">4198</td><td class="line">            server.config_hz,</td></tr>
<tr class="codeline" data-linenumber="4199"><td class="num" id="LN4199">4199</td><td class="line">            server.lruclock,</td></tr>
<tr class="codeline" data-linenumber="4200"><td class="num" id="LN4200">4200</td><td class="line">            server.executable ? server.executable : <span class='string_literal'>""</span>,</td></tr>
<tr class="codeline" data-linenumber="4201"><td class="num" id="LN4201">4201</td><td class="line">            server.configfile ? server.configfile : <span class='string_literal'>""</span>,</td></tr>
<tr class="codeline" data-linenumber="4202"><td class="num" id="LN4202">4202</td><td class="line">            server.io_threads_active);</td></tr>
<tr class="codeline" data-linenumber="4203"><td class="num" id="LN4203">4203</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4204"><td class="num" id="LN4204">4204</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4205"><td class="num" id="LN4205">4205</td><td class="line">    <span class='comment'>/* Clients */</span></td></tr>
<tr class="codeline" data-linenumber="4206"><td class="num" id="LN4206">4206</td><td class="line">    <span class='keyword'>if</span> (allsections || defsections || !strcasecmp(section,<span class='string_literal'>"clients"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="4207"><td class="num" id="LN4207">4207</td><td class="line">        size_t maxin, maxout;</td></tr>
<tr class="codeline" data-linenumber="4208"><td class="num" id="LN4208">4208</td><td class="line">        getExpansiveClientsInfo(&amp;maxin,&amp;maxout);</td></tr>
<tr class="codeline" data-linenumber="4209"><td class="num" id="LN4209">4209</td><td class="line">        <span class='keyword'>if</span> (sections++) info = sdscat(info,<span class='string_literal'>"\r\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4210"><td class="num" id="LN4210">4210</td><td class="line">        info = sdscatprintf(info,</td></tr>
<tr class="codeline" data-linenumber="4211"><td class="num" id="LN4211">4211</td><td class="line">            <span class='string_literal'>"# Clients\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4212"><td class="num" id="LN4212">4212</td><td class="line">            <span class='string_literal'>"connected_clients:%lu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4213"><td class="num" id="LN4213">4213</td><td class="line">            <span class='string_literal'>"client_recent_max_input_buffer:%zu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4214"><td class="num" id="LN4214">4214</td><td class="line">            <span class='string_literal'>"client_recent_max_output_buffer:%zu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4215"><td class="num" id="LN4215">4215</td><td class="line">            <span class='string_literal'>"blocked_clients:%d\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4216"><td class="num" id="LN4216">4216</td><td class="line">            <span class='string_literal'>"tracking_clients:%d\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4217"><td class="num" id="LN4217">4217</td><td class="line">            <span class='string_literal'>"clients_in_timeout_table:%llu\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="4218"><td class="num" id="LN4218">4218</td><td class="line">            <span class='macro'>listLength(server.clients)<span class='macro_popup'>((server.clients)-&gt;len)</span></span>-<span class='macro'>listLength(server.slaves)<span class='macro_popup'>((server.slaves)-&gt;len)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4219"><td class="num" id="LN4219">4219</td><td class="line">            maxin, maxout,</td></tr>
<tr class="codeline" data-linenumber="4220"><td class="num" id="LN4220">4220</td><td class="line">            server.blocked_clients,</td></tr>
<tr class="codeline" data-linenumber="4221"><td class="num" id="LN4221">4221</td><td class="line">            server.tracking_clients,</td></tr>
<tr class="codeline" data-linenumber="4222"><td class="num" id="LN4222">4222</td><td class="line">            (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>) raxSize(server.clients_timeout_table));</td></tr>
<tr class="codeline" data-linenumber="4223"><td class="num" id="LN4223">4223</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4224"><td class="num" id="LN4224">4224</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4225"><td class="num" id="LN4225">4225</td><td class="line">    <span class='comment'>/* Memory */</span></td></tr>
<tr class="codeline" data-linenumber="4226"><td class="num" id="LN4226">4226</td><td class="line">    <span class='keyword'>if</span> (allsections || defsections || !strcasecmp(section,<span class='string_literal'>"memory"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="4227"><td class="num" id="LN4227">4227</td><td class="line">        <span class='keyword'>char</span> hmem[64];</td></tr>
<tr class="codeline" data-linenumber="4228"><td class="num" id="LN4228">4228</td><td class="line">        <span class='keyword'>char</span> peak_hmem[64];</td></tr>
<tr class="codeline" data-linenumber="4229"><td class="num" id="LN4229">4229</td><td class="line">        <span class='keyword'>char</span> total_system_hmem[64];</td></tr>
<tr class="codeline" data-linenumber="4230"><td class="num" id="LN4230">4230</td><td class="line">        <span class='keyword'>char</span> used_memory_lua_hmem[64];</td></tr>
<tr class="codeline" data-linenumber="4231"><td class="num" id="LN4231">4231</td><td class="line">        <span class='keyword'>char</span> used_memory_scripts_hmem[64];</td></tr>
<tr class="codeline" data-linenumber="4232"><td class="num" id="LN4232">4232</td><td class="line">        <span class='keyword'>char</span> used_memory_rss_hmem[64];</td></tr>
<tr class="codeline" data-linenumber="4233"><td class="num" id="LN4233">4233</td><td class="line">        <span class='keyword'>char</span> maxmemory_hmem[64];</td></tr>
<tr class="codeline" data-linenumber="4234"><td class="num" id="LN4234">4234</td><td class="line">        size_t zmalloc_used = zmalloc_used_memory();</td></tr>
<tr class="codeline" data-linenumber="4235"><td class="num" id="LN4235">4235</td><td class="line">        size_t total_system_mem = server.system_memory_size;</td></tr>
<tr class="codeline" data-linenumber="4236"><td class="num" id="LN4236">4236</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>char</span> *evict_policy = evictPolicyToString();</td></tr>
<tr class="codeline" data-linenumber="4237"><td class="num" id="LN4237">4237</td><td class="line">        <span class='keyword'>long</span> <span class='keyword'>long</span> memory_lua = server.lua ? (<span class='keyword'>long</span> <span class='keyword'>long</span>)lua_gc(server.lua,<span class='macro'>LUA_GCCOUNT<span class='macro_popup'>3</span></span>,0)*1024 : 0;</td></tr>
<tr class="codeline" data-linenumber="4238"><td class="num" id="LN4238">4238</td><td class="line">        <span class='keyword'>struct</span> redisMemOverhead *mh = getMemoryOverheadData();</td></tr>
<tr class="codeline" data-linenumber="4239"><td class="num" id="LN4239">4239</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4240"><td class="num" id="LN4240">4240</td><td class="line">        <span class='comment'>/* Peak memory is updated from time to time by serverCron() so it</span></td></tr>
<tr class="codeline" data-linenumber="4241"><td class="num" id="LN4241">4241</td><td class="line">         <span class='comment'>* may happen that the instantaneous value is slightly bigger than</span></td></tr>
<tr class="codeline" data-linenumber="4242"><td class="num" id="LN4242">4242</td><td class="line">         <span class='comment'>* the peak value. This may confuse users, so we update the peak</span></td></tr>
<tr class="codeline" data-linenumber="4243"><td class="num" id="LN4243">4243</td><td class="line">         <span class='comment'>* if found smaller than the current memory usage. */</span></td></tr>
<tr class="codeline" data-linenumber="4244"><td class="num" id="LN4244">4244</td><td class="line">        <span class='keyword'>if</span> (zmalloc_used &gt; server.stat_peak_memory)</td></tr>
<tr class="codeline" data-linenumber="4245"><td class="num" id="LN4245">4245</td><td class="line">            server.stat_peak_memory = zmalloc_used;</td></tr>
<tr class="codeline" data-linenumber="4246"><td class="num" id="LN4246">4246</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4247"><td class="num" id="LN4247">4247</td><td class="line">        bytesToHuman(hmem,zmalloc_used);</td></tr>
<tr class="codeline" data-linenumber="4248"><td class="num" id="LN4248">4248</td><td class="line">        bytesToHuman(peak_hmem,server.stat_peak_memory);</td></tr>
<tr class="codeline" data-linenumber="4249"><td class="num" id="LN4249">4249</td><td class="line">        bytesToHuman(total_system_hmem,total_system_mem);</td></tr>
<tr class="codeline" data-linenumber="4250"><td class="num" id="LN4250">4250</td><td class="line">        bytesToHuman(used_memory_lua_hmem,memory_lua);</td></tr>
<tr class="codeline" data-linenumber="4251"><td class="num" id="LN4251">4251</td><td class="line">        bytesToHuman(used_memory_scripts_hmem,mh-&gt;lua_caches);</td></tr>
<tr class="codeline" data-linenumber="4252"><td class="num" id="LN4252">4252</td><td class="line">        bytesToHuman(used_memory_rss_hmem,server.cron_malloc_stats.process_rss);</td></tr>
<tr class="codeline" data-linenumber="4253"><td class="num" id="LN4253">4253</td><td class="line">        bytesToHuman(maxmemory_hmem,server.maxmemory);</td></tr>
<tr class="codeline" data-linenumber="4254"><td class="num" id="LN4254">4254</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4255"><td class="num" id="LN4255">4255</td><td class="line">        <span class='keyword'>if</span> (sections++) info = sdscat(info,<span class='string_literal'>"\r\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4256"><td class="num" id="LN4256">4256</td><td class="line">        info = sdscatprintf(info,</td></tr>
<tr class="codeline" data-linenumber="4257"><td class="num" id="LN4257">4257</td><td class="line">            <span class='string_literal'>"# Memory\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4258"><td class="num" id="LN4258">4258</td><td class="line">            <span class='string_literal'>"used_memory:%zu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4259"><td class="num" id="LN4259">4259</td><td class="line">            <span class='string_literal'>"used_memory_human:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4260"><td class="num" id="LN4260">4260</td><td class="line">            <span class='string_literal'>"used_memory_rss:%zu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4261"><td class="num" id="LN4261">4261</td><td class="line">            <span class='string_literal'>"used_memory_rss_human:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4262"><td class="num" id="LN4262">4262</td><td class="line">            <span class='string_literal'>"used_memory_peak:%zu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4263"><td class="num" id="LN4263">4263</td><td class="line">            <span class='string_literal'>"used_memory_peak_human:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4264"><td class="num" id="LN4264">4264</td><td class="line">            <span class='string_literal'>"used_memory_peak_perc:%.2f%%\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4265"><td class="num" id="LN4265">4265</td><td class="line">            <span class='string_literal'>"used_memory_overhead:%zu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4266"><td class="num" id="LN4266">4266</td><td class="line">            <span class='string_literal'>"used_memory_startup:%zu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4267"><td class="num" id="LN4267">4267</td><td class="line">            <span class='string_literal'>"used_memory_dataset:%zu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4268"><td class="num" id="LN4268">4268</td><td class="line">            <span class='string_literal'>"used_memory_dataset_perc:%.2f%%\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4269"><td class="num" id="LN4269">4269</td><td class="line">            <span class='string_literal'>"allocator_allocated:%zu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4270"><td class="num" id="LN4270">4270</td><td class="line">            <span class='string_literal'>"allocator_active:%zu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4271"><td class="num" id="LN4271">4271</td><td class="line">            <span class='string_literal'>"allocator_resident:%zu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4272"><td class="num" id="LN4272">4272</td><td class="line">            <span class='string_literal'>"total_system_memory:%lu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4273"><td class="num" id="LN4273">4273</td><td class="line">            <span class='string_literal'>"total_system_memory_human:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4274"><td class="num" id="LN4274">4274</td><td class="line">            <span class='string_literal'>"used_memory_lua:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4275"><td class="num" id="LN4275">4275</td><td class="line">            <span class='string_literal'>"used_memory_lua_human:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4276"><td class="num" id="LN4276">4276</td><td class="line">            <span class='string_literal'>"used_memory_scripts:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4277"><td class="num" id="LN4277">4277</td><td class="line">            <span class='string_literal'>"used_memory_scripts_human:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4278"><td class="num" id="LN4278">4278</td><td class="line">            <span class='string_literal'>"number_of_cached_scripts:%lu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4279"><td class="num" id="LN4279">4279</td><td class="line">            <span class='string_literal'>"maxmemory:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4280"><td class="num" id="LN4280">4280</td><td class="line">            <span class='string_literal'>"maxmemory_human:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4281"><td class="num" id="LN4281">4281</td><td class="line">            <span class='string_literal'>"maxmemory_policy:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4282"><td class="num" id="LN4282">4282</td><td class="line">            <span class='string_literal'>"allocator_frag_ratio:%.2f\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4283"><td class="num" id="LN4283">4283</td><td class="line">            <span class='string_literal'>"allocator_frag_bytes:%zu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4284"><td class="num" id="LN4284">4284</td><td class="line">            <span class='string_literal'>"allocator_rss_ratio:%.2f\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4285"><td class="num" id="LN4285">4285</td><td class="line">            <span class='string_literal'>"allocator_rss_bytes:%zd\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4286"><td class="num" id="LN4286">4286</td><td class="line">            <span class='string_literal'>"rss_overhead_ratio:%.2f\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4287"><td class="num" id="LN4287">4287</td><td class="line">            <span class='string_literal'>"rss_overhead_bytes:%zd\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4288"><td class="num" id="LN4288">4288</td><td class="line">            <span class='string_literal'>"mem_fragmentation_ratio:%.2f\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4289"><td class="num" id="LN4289">4289</td><td class="line">            <span class='string_literal'>"mem_fragmentation_bytes:%zd\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4290"><td class="num" id="LN4290">4290</td><td class="line">            <span class='string_literal'>"mem_not_counted_for_evict:%zu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4291"><td class="num" id="LN4291">4291</td><td class="line">            <span class='string_literal'>"mem_replication_backlog:%zu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4292"><td class="num" id="LN4292">4292</td><td class="line">            <span class='string_literal'>"mem_clients_slaves:%zu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4293"><td class="num" id="LN4293">4293</td><td class="line">            <span class='string_literal'>"mem_clients_normal:%zu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4294"><td class="num" id="LN4294">4294</td><td class="line">            <span class='string_literal'>"mem_aof_buffer:%zu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4295"><td class="num" id="LN4295">4295</td><td class="line">            <span class='string_literal'>"mem_allocator:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4296"><td class="num" id="LN4296">4296</td><td class="line">            <span class='string_literal'>"active_defrag_running:%d\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4297"><td class="num" id="LN4297">4297</td><td class="line">            <span class='string_literal'>"lazyfree_pending_objects:%zu\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="4298"><td class="num" id="LN4298">4298</td><td class="line">            zmalloc_used,</td></tr>
<tr class="codeline" data-linenumber="4299"><td class="num" id="LN4299">4299</td><td class="line">            hmem,</td></tr>
<tr class="codeline" data-linenumber="4300"><td class="num" id="LN4300">4300</td><td class="line">            server.cron_malloc_stats.process_rss,</td></tr>
<tr class="codeline" data-linenumber="4301"><td class="num" id="LN4301">4301</td><td class="line">            used_memory_rss_hmem,</td></tr>
<tr class="codeline" data-linenumber="4302"><td class="num" id="LN4302">4302</td><td class="line">            server.stat_peak_memory,</td></tr>
<tr class="codeline" data-linenumber="4303"><td class="num" id="LN4303">4303</td><td class="line">            peak_hmem,</td></tr>
<tr class="codeline" data-linenumber="4304"><td class="num" id="LN4304">4304</td><td class="line">            mh-&gt;peak_perc,</td></tr>
<tr class="codeline" data-linenumber="4305"><td class="num" id="LN4305">4305</td><td class="line">            mh-&gt;overhead_total,</td></tr>
<tr class="codeline" data-linenumber="4306"><td class="num" id="LN4306">4306</td><td class="line">            mh-&gt;startup_allocated,</td></tr>
<tr class="codeline" data-linenumber="4307"><td class="num" id="LN4307">4307</td><td class="line">            mh-&gt;dataset,</td></tr>
<tr class="codeline" data-linenumber="4308"><td class="num" id="LN4308">4308</td><td class="line">            mh-&gt;dataset_perc,</td></tr>
<tr class="codeline" data-linenumber="4309"><td class="num" id="LN4309">4309</td><td class="line">            server.cron_malloc_stats.allocator_allocated,</td></tr>
<tr class="codeline" data-linenumber="4310"><td class="num" id="LN4310">4310</td><td class="line">            server.cron_malloc_stats.allocator_active,</td></tr>
<tr class="codeline" data-linenumber="4311"><td class="num" id="LN4311">4311</td><td class="line">            server.cron_malloc_stats.allocator_resident,</td></tr>
<tr class="codeline" data-linenumber="4312"><td class="num" id="LN4312">4312</td><td class="line">            (<span class='keyword'>unsigned</span> <span class='keyword'>long</span>)total_system_mem,</td></tr>
<tr class="codeline" data-linenumber="4313"><td class="num" id="LN4313">4313</td><td class="line">            total_system_hmem,</td></tr>
<tr class="codeline" data-linenumber="4314"><td class="num" id="LN4314">4314</td><td class="line">            memory_lua,</td></tr>
<tr class="codeline" data-linenumber="4315"><td class="num" id="LN4315">4315</td><td class="line">            used_memory_lua_hmem,</td></tr>
<tr class="codeline" data-linenumber="4316"><td class="num" id="LN4316">4316</td><td class="line">            (<span class='keyword'>long</span> <span class='keyword'>long</span>) mh-&gt;lua_caches,</td></tr>
<tr class="codeline" data-linenumber="4317"><td class="num" id="LN4317">4317</td><td class="line">            used_memory_scripts_hmem,</td></tr>
<tr class="codeline" data-linenumber="4318"><td class="num" id="LN4318">4318</td><td class="line">            <span class='macro'>dictSize(server.lua_scripts)<span class='macro_popup'>((server.lua_scripts)-&gt;ht[0].used+(server.lua_scripts)-&gt;<br>ht[1].used)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4319"><td class="num" id="LN4319">4319</td><td class="line">            server.maxmemory,</td></tr>
<tr class="codeline" data-linenumber="4320"><td class="num" id="LN4320">4320</td><td class="line">            maxmemory_hmem,</td></tr>
<tr class="codeline" data-linenumber="4321"><td class="num" id="LN4321">4321</td><td class="line">            evict_policy,</td></tr>
<tr class="codeline" data-linenumber="4322"><td class="num" id="LN4322">4322</td><td class="line">            mh-&gt;allocator_frag,</td></tr>
<tr class="codeline" data-linenumber="4323"><td class="num" id="LN4323">4323</td><td class="line">            mh-&gt;allocator_frag_bytes,</td></tr>
<tr class="codeline" data-linenumber="4324"><td class="num" id="LN4324">4324</td><td class="line">            mh-&gt;allocator_rss,</td></tr>
<tr class="codeline" data-linenumber="4325"><td class="num" id="LN4325">4325</td><td class="line">            mh-&gt;allocator_rss_bytes,</td></tr>
<tr class="codeline" data-linenumber="4326"><td class="num" id="LN4326">4326</td><td class="line">            mh-&gt;rss_extra,</td></tr>
<tr class="codeline" data-linenumber="4327"><td class="num" id="LN4327">4327</td><td class="line">            mh-&gt;rss_extra_bytes,</td></tr>
<tr class="codeline" data-linenumber="4328"><td class="num" id="LN4328">4328</td><td class="line">            mh-&gt;total_frag,       <span class='comment'>/* This is the total RSS overhead, including</span></td></tr>
<tr class="codeline" data-linenumber="4329"><td class="num" id="LN4329">4329</td><td class="line">                                     <span class='comment'>fragmentation, but not just it. This field</span></td></tr>
<tr class="codeline" data-linenumber="4330"><td class="num" id="LN4330">4330</td><td class="line">                                     <span class='comment'>(and the next one) is named like that just</span></td></tr>
<tr class="codeline" data-linenumber="4331"><td class="num" id="LN4331">4331</td><td class="line">                                     <span class='comment'>for backward compatibility. */</span></td></tr>
<tr class="codeline" data-linenumber="4332"><td class="num" id="LN4332">4332</td><td class="line">            mh-&gt;total_frag_bytes,</td></tr>
<tr class="codeline" data-linenumber="4333"><td class="num" id="LN4333">4333</td><td class="line">            freeMemoryGetNotCountedMemory(),</td></tr>
<tr class="codeline" data-linenumber="4334"><td class="num" id="LN4334">4334</td><td class="line">            mh-&gt;repl_backlog,</td></tr>
<tr class="codeline" data-linenumber="4335"><td class="num" id="LN4335">4335</td><td class="line">            mh-&gt;clients_slaves,</td></tr>
<tr class="codeline" data-linenumber="4336"><td class="num" id="LN4336">4336</td><td class="line">            mh-&gt;clients_normal,</td></tr>
<tr class="codeline" data-linenumber="4337"><td class="num" id="LN4337">4337</td><td class="line">            mh-&gt;aof_buffer,</td></tr>
<tr class="codeline" data-linenumber="4338"><td class="num" id="LN4338">4338</td><td class="line">            <span class='macro'>ZMALLOC_LIB<span class='macro_popup'>("jemalloc-" "5" "." "1" "." "0")</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4339"><td class="num" id="LN4339">4339</td><td class="line">            server.active_defrag_running,</td></tr>
<tr class="codeline" data-linenumber="4340"><td class="num" id="LN4340">4340</td><td class="line">            lazyfreeGetPendingObjectsCount()</td></tr>
<tr class="codeline" data-linenumber="4341"><td class="num" id="LN4341">4341</td><td class="line">        );</td></tr>
<tr class="codeline" data-linenumber="4342"><td class="num" id="LN4342">4342</td><td class="line">        freeMemoryOverheadData(mh);</td></tr>
<tr class="codeline" data-linenumber="4343"><td class="num" id="LN4343">4343</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4344"><td class="num" id="LN4344">4344</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4345"><td class="num" id="LN4345">4345</td><td class="line">    <span class='comment'>/* Persistence */</span></td></tr>
<tr class="codeline" data-linenumber="4346"><td class="num" id="LN4346">4346</td><td class="line">    <span class='keyword'>if</span> (allsections || defsections || !strcasecmp(section,<span class='string_literal'>"persistence"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="4347"><td class="num" id="LN4347">4347</td><td class="line">        <span class='keyword'>if</span> (sections++) info = sdscat(info,<span class='string_literal'>"\r\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4348"><td class="num" id="LN4348">4348</td><td class="line">        info = sdscatprintf(info,</td></tr>
<tr class="codeline" data-linenumber="4349"><td class="num" id="LN4349">4349</td><td class="line">            <span class='string_literal'>"# Persistence\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4350"><td class="num" id="LN4350">4350</td><td class="line">            <span class='string_literal'>"loading:%d\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4351"><td class="num" id="LN4351">4351</td><td class="line">            <span class='string_literal'>"rdb_changes_since_last_save:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4352"><td class="num" id="LN4352">4352</td><td class="line">            <span class='string_literal'>"rdb_bgsave_in_progress:%d\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4353"><td class="num" id="LN4353">4353</td><td class="line">            <span class='string_literal'>"rdb_last_save_time:%jd\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4354"><td class="num" id="LN4354">4354</td><td class="line">            <span class='string_literal'>"rdb_last_bgsave_status:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4355"><td class="num" id="LN4355">4355</td><td class="line">            <span class='string_literal'>"rdb_last_bgsave_time_sec:%jd\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4356"><td class="num" id="LN4356">4356</td><td class="line">            <span class='string_literal'>"rdb_current_bgsave_time_sec:%jd\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4357"><td class="num" id="LN4357">4357</td><td class="line">            <span class='string_literal'>"rdb_last_cow_size:%zu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4358"><td class="num" id="LN4358">4358</td><td class="line">            <span class='string_literal'>"aof_enabled:%d\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4359"><td class="num" id="LN4359">4359</td><td class="line">            <span class='string_literal'>"aof_rewrite_in_progress:%d\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4360"><td class="num" id="LN4360">4360</td><td class="line">            <span class='string_literal'>"aof_rewrite_scheduled:%d\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4361"><td class="num" id="LN4361">4361</td><td class="line">            <span class='string_literal'>"aof_last_rewrite_time_sec:%jd\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4362"><td class="num" id="LN4362">4362</td><td class="line">            <span class='string_literal'>"aof_current_rewrite_time_sec:%jd\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4363"><td class="num" id="LN4363">4363</td><td class="line">            <span class='string_literal'>"aof_last_bgrewrite_status:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4364"><td class="num" id="LN4364">4364</td><td class="line">            <span class='string_literal'>"aof_last_write_status:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4365"><td class="num" id="LN4365">4365</td><td class="line">            <span class='string_literal'>"aof_last_cow_size:%zu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4366"><td class="num" id="LN4366">4366</td><td class="line">            <span class='string_literal'>"module_fork_in_progress:%d\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4367"><td class="num" id="LN4367">4367</td><td class="line">            <span class='string_literal'>"module_fork_last_cow_size:%zu\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="4368"><td class="num" id="LN4368">4368</td><td class="line">            server.loading,</td></tr>
<tr class="codeline" data-linenumber="4369"><td class="num" id="LN4369">4369</td><td class="line">            server.dirty,</td></tr>
<tr class="codeline" data-linenumber="4370"><td class="num" id="LN4370">4370</td><td class="line">            server.rdb_child_pid != -1,</td></tr>
<tr class="codeline" data-linenumber="4371"><td class="num" id="LN4371">4371</td><td class="line">            (intmax_t)server.lastsave,</td></tr>
<tr class="codeline" data-linenumber="4372"><td class="num" id="LN4372">4372</td><td class="line">            (server.lastbgsave_status == <span class='macro'>C_OK<span class='macro_popup'>0</span></span>) ? <span class='string_literal'>"ok"</span> : <span class='string_literal'>"err"</span>,</td></tr>
<tr class="codeline" data-linenumber="4373"><td class="num" id="LN4373">4373</td><td class="line">            (intmax_t)server.rdb_save_time_last,</td></tr>
<tr class="codeline" data-linenumber="4374"><td class="num" id="LN4374">4374</td><td class="line">            (intmax_t)((server.rdb_child_pid == -1) ?</td></tr>
<tr class="codeline" data-linenumber="4375"><td class="num" id="LN4375">4375</td><td class="line">                -1 : time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)-server.rdb_save_time_start),</td></tr>
<tr class="codeline" data-linenumber="4376"><td class="num" id="LN4376">4376</td><td class="line">            server.stat_rdb_cow_bytes,</td></tr>
<tr class="codeline" data-linenumber="4377"><td class="num" id="LN4377">4377</td><td class="line">            server.aof_state != <span class='macro'>AOF_OFF<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4378"><td class="num" id="LN4378">4378</td><td class="line">            server.aof_child_pid != -1,</td></tr>
<tr class="codeline" data-linenumber="4379"><td class="num" id="LN4379">4379</td><td class="line">            server.aof_rewrite_scheduled,</td></tr>
<tr class="codeline" data-linenumber="4380"><td class="num" id="LN4380">4380</td><td class="line">            (intmax_t)server.aof_rewrite_time_last,</td></tr>
<tr class="codeline" data-linenumber="4381"><td class="num" id="LN4381">4381</td><td class="line">            (intmax_t)((server.aof_child_pid == -1) ?</td></tr>
<tr class="codeline" data-linenumber="4382"><td class="num" id="LN4382">4382</td><td class="line">                -1 : time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)-server.aof_rewrite_time_start),</td></tr>
<tr class="codeline" data-linenumber="4383"><td class="num" id="LN4383">4383</td><td class="line">            (server.aof_lastbgrewrite_status == <span class='macro'>C_OK<span class='macro_popup'>0</span></span>) ? <span class='string_literal'>"ok"</span> : <span class='string_literal'>"err"</span>,</td></tr>
<tr class="codeline" data-linenumber="4384"><td class="num" id="LN4384">4384</td><td class="line">            (server.aof_last_write_status == <span class='macro'>C_OK<span class='macro_popup'>0</span></span>) ? <span class='string_literal'>"ok"</span> : <span class='string_literal'>"err"</span>,</td></tr>
<tr class="codeline" data-linenumber="4385"><td class="num" id="LN4385">4385</td><td class="line">            server.stat_aof_cow_bytes,</td></tr>
<tr class="codeline" data-linenumber="4386"><td class="num" id="LN4386">4386</td><td class="line">            server.module_child_pid != -1,</td></tr>
<tr class="codeline" data-linenumber="4387"><td class="num" id="LN4387">4387</td><td class="line">            server.stat_module_cow_bytes);</td></tr>
<tr class="codeline" data-linenumber="4388"><td class="num" id="LN4388">4388</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4389"><td class="num" id="LN4389">4389</td><td class="line">        <span class='keyword'>if</span> (server.aof_enabled) {</td></tr>
<tr class="codeline" data-linenumber="4390"><td class="num" id="LN4390">4390</td><td class="line">            info = sdscatprintf(info,</td></tr>
<tr class="codeline" data-linenumber="4391"><td class="num" id="LN4391">4391</td><td class="line">                <span class='string_literal'>"aof_current_size:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4392"><td class="num" id="LN4392">4392</td><td class="line">                <span class='string_literal'>"aof_base_size:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4393"><td class="num" id="LN4393">4393</td><td class="line">                <span class='string_literal'>"aof_pending_rewrite:%d\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4394"><td class="num" id="LN4394">4394</td><td class="line">                <span class='string_literal'>"aof_buffer_length:%zu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4395"><td class="num" id="LN4395">4395</td><td class="line">                <span class='string_literal'>"aof_rewrite_buffer_length:%lu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4396"><td class="num" id="LN4396">4396</td><td class="line">                <span class='string_literal'>"aof_pending_bio_fsync:%llu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4397"><td class="num" id="LN4397">4397</td><td class="line">                <span class='string_literal'>"aof_delayed_fsync:%lu\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="4398"><td class="num" id="LN4398">4398</td><td class="line">                (<span class='keyword'>long</span> <span class='keyword'>long</span>) server.aof_current_size,</td></tr>
<tr class="codeline" data-linenumber="4399"><td class="num" id="LN4399">4399</td><td class="line">                (<span class='keyword'>long</span> <span class='keyword'>long</span>) server.aof_rewrite_base_size,</td></tr>
<tr class="codeline" data-linenumber="4400"><td class="num" id="LN4400">4400</td><td class="line">                server.aof_rewrite_scheduled,</td></tr>
<tr class="codeline" data-linenumber="4401"><td class="num" id="LN4401">4401</td><td class="line">                sdslen(server.aof_buf),</td></tr>
<tr class="codeline" data-linenumber="4402"><td class="num" id="LN4402">4402</td><td class="line">                aofRewriteBufferSize(),</td></tr>
<tr class="codeline" data-linenumber="4403"><td class="num" id="LN4403">4403</td><td class="line">                bioPendingJobsOfType(<span class='macro'>BIO_AOF_FSYNC<span class='macro_popup'>1</span></span>),</td></tr>
<tr class="codeline" data-linenumber="4404"><td class="num" id="LN4404">4404</td><td class="line">                server.aof_delayed_fsync);</td></tr>
<tr class="codeline" data-linenumber="4405"><td class="num" id="LN4405">4405</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4406"><td class="num" id="LN4406">4406</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4407"><td class="num" id="LN4407">4407</td><td class="line">        <span class='keyword'>if</span> (server.loading) {</td></tr>
<tr class="codeline" data-linenumber="4408"><td class="num" id="LN4408">4408</td><td class="line">            <span class='keyword'>double</span> perc;</td></tr>
<tr class="codeline" data-linenumber="4409"><td class="num" id="LN4409">4409</td><td class="line">            time_t eta, elapsed;</td></tr>
<tr class="codeline" data-linenumber="4410"><td class="num" id="LN4410">4410</td><td class="line">            off_t remaining_bytes = server.loading_total_bytes-</td></tr>
<tr class="codeline" data-linenumber="4411"><td class="num" id="LN4411">4411</td><td class="line">                                    server.loading_loaded_bytes;</td></tr>
<tr class="codeline" data-linenumber="4412"><td class="num" id="LN4412">4412</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4413"><td class="num" id="LN4413">4413</td><td class="line">            perc = ((<span class='keyword'>double</span>)server.loading_loaded_bytes /</td></tr>
<tr class="codeline" data-linenumber="4414"><td class="num" id="LN4414">4414</td><td class="line">                   (server.loading_total_bytes+1)) * 100;</td></tr>
<tr class="codeline" data-linenumber="4415"><td class="num" id="LN4415">4415</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4416"><td class="num" id="LN4416">4416</td><td class="line">            elapsed = time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)-server.loading_start_time;</td></tr>
<tr class="codeline" data-linenumber="4417"><td class="num" id="LN4417">4417</td><td class="line">            <span class='keyword'>if</span> (elapsed == 0) {</td></tr>
<tr class="codeline" data-linenumber="4418"><td class="num" id="LN4418">4418</td><td class="line">                eta = 1; <span class='comment'>/* A fake 1 second figure if we don't have</span></td></tr>
<tr class="codeline" data-linenumber="4419"><td class="num" id="LN4419">4419</td><td class="line">                            <span class='comment'>enough info */</span></td></tr>
<tr class="codeline" data-linenumber="4420"><td class="num" id="LN4420">4420</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="4421"><td class="num" id="LN4421">4421</td><td class="line">                eta = (elapsed*remaining_bytes)/(server.loading_loaded_bytes+1);</td></tr>
<tr class="codeline" data-linenumber="4422"><td class="num" id="LN4422">4422</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="4423"><td class="num" id="LN4423">4423</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4424"><td class="num" id="LN4424">4424</td><td class="line">            info = sdscatprintf(info,</td></tr>
<tr class="codeline" data-linenumber="4425"><td class="num" id="LN4425">4425</td><td class="line">                <span class='string_literal'>"loading_start_time:%jd\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4426"><td class="num" id="LN4426">4426</td><td class="line">                <span class='string_literal'>"loading_total_bytes:%llu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4427"><td class="num" id="LN4427">4427</td><td class="line">                <span class='string_literal'>"loading_loaded_bytes:%llu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4428"><td class="num" id="LN4428">4428</td><td class="line">                <span class='string_literal'>"loading_loaded_perc:%.2f\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4429"><td class="num" id="LN4429">4429</td><td class="line">                <span class='string_literal'>"loading_eta_seconds:%jd\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="4430"><td class="num" id="LN4430">4430</td><td class="line">                (intmax_t) server.loading_start_time,</td></tr>
<tr class="codeline" data-linenumber="4431"><td class="num" id="LN4431">4431</td><td class="line">                (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>) server.loading_total_bytes,</td></tr>
<tr class="codeline" data-linenumber="4432"><td class="num" id="LN4432">4432</td><td class="line">                (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>) server.loading_loaded_bytes,</td></tr>
<tr class="codeline" data-linenumber="4433"><td class="num" id="LN4433">4433</td><td class="line">                perc,</td></tr>
<tr class="codeline" data-linenumber="4434"><td class="num" id="LN4434">4434</td><td class="line">                (intmax_t)eta</td></tr>
<tr class="codeline" data-linenumber="4435"><td class="num" id="LN4435">4435</td><td class="line">            );</td></tr>
<tr class="codeline" data-linenumber="4436"><td class="num" id="LN4436">4436</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4437"><td class="num" id="LN4437">4437</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4438"><td class="num" id="LN4438">4438</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4439"><td class="num" id="LN4439">4439</td><td class="line">    <span class='comment'>/* Stats */</span></td></tr>
<tr class="codeline" data-linenumber="4440"><td class="num" id="LN4440">4440</td><td class="line">    <span class='keyword'>if</span> (allsections || defsections || !strcasecmp(section,<span class='string_literal'>"stats"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="4441"><td class="num" id="LN4441">4441</td><td class="line">        <span class='keyword'>if</span> (sections++) info = sdscat(info,<span class='string_literal'>"\r\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4442"><td class="num" id="LN4442">4442</td><td class="line">        info = sdscatprintf(info,</td></tr>
<tr class="codeline" data-linenumber="4443"><td class="num" id="LN4443">4443</td><td class="line">            <span class='string_literal'>"# Stats\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4444"><td class="num" id="LN4444">4444</td><td class="line">            <span class='string_literal'>"total_connections_received:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4445"><td class="num" id="LN4445">4445</td><td class="line">            <span class='string_literal'>"total_commands_processed:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4446"><td class="num" id="LN4446">4446</td><td class="line">            <span class='string_literal'>"instantaneous_ops_per_sec:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4447"><td class="num" id="LN4447">4447</td><td class="line">            <span class='string_literal'>"total_net_input_bytes:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4448"><td class="num" id="LN4448">4448</td><td class="line">            <span class='string_literal'>"total_net_output_bytes:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4449"><td class="num" id="LN4449">4449</td><td class="line">            <span class='string_literal'>"instantaneous_input_kbps:%.2f\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4450"><td class="num" id="LN4450">4450</td><td class="line">            <span class='string_literal'>"instantaneous_output_kbps:%.2f\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4451"><td class="num" id="LN4451">4451</td><td class="line">            <span class='string_literal'>"rejected_connections:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4452"><td class="num" id="LN4452">4452</td><td class="line">            <span class='string_literal'>"sync_full:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4453"><td class="num" id="LN4453">4453</td><td class="line">            <span class='string_literal'>"sync_partial_ok:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4454"><td class="num" id="LN4454">4454</td><td class="line">            <span class='string_literal'>"sync_partial_err:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4455"><td class="num" id="LN4455">4455</td><td class="line">            <span class='string_literal'>"expired_keys:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4456"><td class="num" id="LN4456">4456</td><td class="line">            <span class='string_literal'>"expired_stale_perc:%.2f\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4457"><td class="num" id="LN4457">4457</td><td class="line">            <span class='string_literal'>"expired_time_cap_reached_count:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4458"><td class="num" id="LN4458">4458</td><td class="line">            <span class='string_literal'>"expire_cycle_cpu_milliseconds:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4459"><td class="num" id="LN4459">4459</td><td class="line">            <span class='string_literal'>"evicted_keys:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4460"><td class="num" id="LN4460">4460</td><td class="line">            <span class='string_literal'>"keyspace_hits:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4461"><td class="num" id="LN4461">4461</td><td class="line">            <span class='string_literal'>"keyspace_misses:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4462"><td class="num" id="LN4462">4462</td><td class="line">            <span class='string_literal'>"pubsub_channels:%ld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4463"><td class="num" id="LN4463">4463</td><td class="line">            <span class='string_literal'>"pubsub_patterns:%lu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4464"><td class="num" id="LN4464">4464</td><td class="line">            <span class='string_literal'>"latest_fork_usec:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4465"><td class="num" id="LN4465">4465</td><td class="line">            <span class='string_literal'>"migrate_cached_sockets:%ld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4466"><td class="num" id="LN4466">4466</td><td class="line">            <span class='string_literal'>"slave_expires_tracked_keys:%zu\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4467"><td class="num" id="LN4467">4467</td><td class="line">            <span class='string_literal'>"active_defrag_hits:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4468"><td class="num" id="LN4468">4468</td><td class="line">            <span class='string_literal'>"active_defrag_misses:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4469"><td class="num" id="LN4469">4469</td><td class="line">            <span class='string_literal'>"active_defrag_key_hits:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4470"><td class="num" id="LN4470">4470</td><td class="line">            <span class='string_literal'>"active_defrag_key_misses:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4471"><td class="num" id="LN4471">4471</td><td class="line">            <span class='string_literal'>"tracking_total_keys:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4472"><td class="num" id="LN4472">4472</td><td class="line">            <span class='string_literal'>"tracking_total_items:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4473"><td class="num" id="LN4473">4473</td><td class="line">            <span class='string_literal'>"tracking_total_prefixes:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4474"><td class="num" id="LN4474">4474</td><td class="line">            <span class='string_literal'>"unexpected_error_replies:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4475"><td class="num" id="LN4475">4475</td><td class="line">            <span class='string_literal'>"total_reads_processed:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4476"><td class="num" id="LN4476">4476</td><td class="line">            <span class='string_literal'>"total_writes_processed:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4477"><td class="num" id="LN4477">4477</td><td class="line">            <span class='string_literal'>"io_threaded_reads_processed:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4478"><td class="num" id="LN4478">4478</td><td class="line">            <span class='string_literal'>"io_threaded_writes_processed:%lld\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="4479"><td class="num" id="LN4479">4479</td><td class="line">            server.stat_numconnections,</td></tr>
<tr class="codeline" data-linenumber="4480"><td class="num" id="LN4480">4480</td><td class="line">            server.stat_numcommands,</td></tr>
<tr class="codeline" data-linenumber="4481"><td class="num" id="LN4481">4481</td><td class="line">            getInstantaneousMetric(<span class='macro'>STATS_METRIC_COMMAND<span class='macro_popup'>0</span></span>),</td></tr>
<tr class="codeline" data-linenumber="4482"><td class="num" id="LN4482">4482</td><td class="line">            server.stat_net_input_bytes,</td></tr>
<tr class="codeline" data-linenumber="4483"><td class="num" id="LN4483">4483</td><td class="line">            server.stat_net_output_bytes,</td></tr>
<tr class="codeline" data-linenumber="4484"><td class="num" id="LN4484">4484</td><td class="line">            (<span class='keyword'>float</span>)getInstantaneousMetric(<span class='macro'>STATS_METRIC_NET_INPUT<span class='macro_popup'>1</span></span>)/1024,</td></tr>
<tr class="codeline" data-linenumber="4485"><td class="num" id="LN4485">4485</td><td class="line">            (<span class='keyword'>float</span>)getInstantaneousMetric(<span class='macro'>STATS_METRIC_NET_OUTPUT<span class='macro_popup'>2</span></span>)/1024,</td></tr>
<tr class="codeline" data-linenumber="4486"><td class="num" id="LN4486">4486</td><td class="line">            server.stat_rejected_conn,</td></tr>
<tr class="codeline" data-linenumber="4487"><td class="num" id="LN4487">4487</td><td class="line">            server.stat_sync_full,</td></tr>
<tr class="codeline" data-linenumber="4488"><td class="num" id="LN4488">4488</td><td class="line">            server.stat_sync_partial_ok,</td></tr>
<tr class="codeline" data-linenumber="4489"><td class="num" id="LN4489">4489</td><td class="line">            server.stat_sync_partial_err,</td></tr>
<tr class="codeline" data-linenumber="4490"><td class="num" id="LN4490">4490</td><td class="line">            server.stat_expiredkeys,</td></tr>
<tr class="codeline" data-linenumber="4491"><td class="num" id="LN4491">4491</td><td class="line">            server.stat_expired_stale_perc*100,</td></tr>
<tr class="codeline" data-linenumber="4492"><td class="num" id="LN4492">4492</td><td class="line">            server.stat_expired_time_cap_reached_count,</td></tr>
<tr class="codeline" data-linenumber="4493"><td class="num" id="LN4493">4493</td><td class="line">            server.stat_expire_cycle_time_used/1000,</td></tr>
<tr class="codeline" data-linenumber="4494"><td class="num" id="LN4494">4494</td><td class="line">            server.stat_evictedkeys,</td></tr>
<tr class="codeline" data-linenumber="4495"><td class="num" id="LN4495">4495</td><td class="line">            server.stat_keyspace_hits,</td></tr>
<tr class="codeline" data-linenumber="4496"><td class="num" id="LN4496">4496</td><td class="line">            server.stat_keyspace_misses,</td></tr>
<tr class="codeline" data-linenumber="4497"><td class="num" id="LN4497">4497</td><td class="line">            <span class='macro'>dictSize(server.pubsub_channels)<span class='macro_popup'>((server.pubsub_channels)-&gt;ht[0].used+(server.pubsub_channels<br>)-&gt;ht[1].used)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4498"><td class="num" id="LN4498">4498</td><td class="line">            <span class='macro'>listLength(server.pubsub_patterns)<span class='macro_popup'>((server.pubsub_patterns)-&gt;len)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4499"><td class="num" id="LN4499">4499</td><td class="line">            server.stat_fork_time,</td></tr>
<tr class="codeline" data-linenumber="4500"><td class="num" id="LN4500">4500</td><td class="line">            <span class='macro'>dictSize(server.migrate_cached_sockets)<span class='macro_popup'>((server.migrate_cached_sockets)-&gt;ht[0].used+(server.migrate_cached_sockets<br>)-&gt;ht[1].used)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4501"><td class="num" id="LN4501">4501</td><td class="line">            getSlaveKeyWithExpireCount(),</td></tr>
<tr class="codeline" data-linenumber="4502"><td class="num" id="LN4502">4502</td><td class="line">            server.stat_active_defrag_hits,</td></tr>
<tr class="codeline" data-linenumber="4503"><td class="num" id="LN4503">4503</td><td class="line">            server.stat_active_defrag_misses,</td></tr>
<tr class="codeline" data-linenumber="4504"><td class="num" id="LN4504">4504</td><td class="line">            server.stat_active_defrag_key_hits,</td></tr>
<tr class="codeline" data-linenumber="4505"><td class="num" id="LN4505">4505</td><td class="line">            server.stat_active_defrag_key_misses,</td></tr>
<tr class="codeline" data-linenumber="4506"><td class="num" id="LN4506">4506</td><td class="line">            (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>) trackingGetTotalKeys(),</td></tr>
<tr class="codeline" data-linenumber="4507"><td class="num" id="LN4507">4507</td><td class="line">            (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>) trackingGetTotalItems(),</td></tr>
<tr class="codeline" data-linenumber="4508"><td class="num" id="LN4508">4508</td><td class="line">            (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>) trackingGetTotalPrefixes(),</td></tr>
<tr class="codeline" data-linenumber="4509"><td class="num" id="LN4509">4509</td><td class="line">            server.stat_unexpected_error_replies,</td></tr>
<tr class="codeline" data-linenumber="4510"><td class="num" id="LN4510">4510</td><td class="line">            server.stat_total_reads_processed,</td></tr>
<tr class="codeline" data-linenumber="4511"><td class="num" id="LN4511">4511</td><td class="line">            server.stat_total_writes_processed,</td></tr>
<tr class="codeline" data-linenumber="4512"><td class="num" id="LN4512">4512</td><td class="line">            server.stat_io_reads_processed,</td></tr>
<tr class="codeline" data-linenumber="4513"><td class="num" id="LN4513">4513</td><td class="line">            server.stat_io_writes_processed);</td></tr>
<tr class="codeline" data-linenumber="4514"><td class="num" id="LN4514">4514</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4515"><td class="num" id="LN4515">4515</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4516"><td class="num" id="LN4516">4516</td><td class="line">    <span class='comment'>/* Replication */</span></td></tr>
<tr class="codeline" data-linenumber="4517"><td class="num" id="LN4517">4517</td><td class="line">    <span class='keyword'>if</span> (allsections || defsections || !strcasecmp(section,<span class='string_literal'>"replication"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="4518"><td class="num" id="LN4518">4518</td><td class="line">        <span class='keyword'>if</span> (sections++) info = sdscat(info,<span class='string_literal'>"\r\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4519"><td class="num" id="LN4519">4519</td><td class="line">        info = sdscatprintf(info,</td></tr>
<tr class="codeline" data-linenumber="4520"><td class="num" id="LN4520">4520</td><td class="line">            <span class='string_literal'>"# Replication\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4521"><td class="num" id="LN4521">4521</td><td class="line">            <span class='string_literal'>"role:%s\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="4522"><td class="num" id="LN4522">4522</td><td class="line">            server.masterhost == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> ? <span class='string_literal'>"master"</span> : <span class='string_literal'>"slave"</span>);</td></tr>
<tr class="codeline" data-linenumber="4523"><td class="num" id="LN4523">4523</td><td class="line">        <span class='keyword'>if</span> (server.masterhost) {</td></tr>
<tr class="codeline" data-linenumber="4524"><td class="num" id="LN4524">4524</td><td class="line">            <span class='keyword'>long</span> <span class='keyword'>long</span> slave_repl_offset = 1;</td></tr>
<tr class="codeline" data-linenumber="4525"><td class="num" id="LN4525">4525</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4526"><td class="num" id="LN4526">4526</td><td class="line">            <span class='keyword'>if</span> (server.master)</td></tr>
<tr class="codeline" data-linenumber="4527"><td class="num" id="LN4527">4527</td><td class="line">                slave_repl_offset = server.master-&gt;reploff;</td></tr>
<tr class="codeline" data-linenumber="4528"><td class="num" id="LN4528">4528</td><td class="line">            <span class='keyword'>else</span> <span class='keyword'>if</span> (server.cached_master)</td></tr>
<tr class="codeline" data-linenumber="4529"><td class="num" id="LN4529">4529</td><td class="line">                slave_repl_offset = server.cached_master-&gt;reploff;</td></tr>
<tr class="codeline" data-linenumber="4530"><td class="num" id="LN4530">4530</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4531"><td class="num" id="LN4531">4531</td><td class="line">            info = sdscatprintf(info,</td></tr>
<tr class="codeline" data-linenumber="4532"><td class="num" id="LN4532">4532</td><td class="line">                <span class='string_literal'>"master_host:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4533"><td class="num" id="LN4533">4533</td><td class="line">                <span class='string_literal'>"master_port:%d\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4534"><td class="num" id="LN4534">4534</td><td class="line">                <span class='string_literal'>"master_link_status:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4535"><td class="num" id="LN4535">4535</td><td class="line">                <span class='string_literal'>"master_last_io_seconds_ago:%d\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4536"><td class="num" id="LN4536">4536</td><td class="line">                <span class='string_literal'>"master_sync_in_progress:%d\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4537"><td class="num" id="LN4537">4537</td><td class="line">                <span class='string_literal'>"slave_repl_offset:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4538"><td class="num" id="LN4538">4538</td><td class="line">                ,server.masterhost,</td></tr>
<tr class="codeline" data-linenumber="4539"><td class="num" id="LN4539">4539</td><td class="line">                server.masterport,</td></tr>
<tr class="codeline" data-linenumber="4540"><td class="num" id="LN4540">4540</td><td class="line">                (server.repl_state == <span class='macro'>REPL_STATE_CONNECTED<span class='macro_popup'>15</span></span>) ?</td></tr>
<tr class="codeline" data-linenumber="4541"><td class="num" id="LN4541">4541</td><td class="line">                    <span class='string_literal'>"up"</span> : <span class='string_literal'>"down"</span>,</td></tr>
<tr class="codeline" data-linenumber="4542"><td class="num" id="LN4542">4542</td><td class="line">                server.master ?</td></tr>
<tr class="codeline" data-linenumber="4543"><td class="num" id="LN4543">4543</td><td class="line">                ((<span class='keyword'>int</span>)(server.unixtime-server.master-&gt;lastinteraction)) : -1,</td></tr>
<tr class="codeline" data-linenumber="4544"><td class="num" id="LN4544">4544</td><td class="line">                server.repl_state == <span class='macro'>REPL_STATE_TRANSFER<span class='macro_popup'>14</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4545"><td class="num" id="LN4545">4545</td><td class="line">                slave_repl_offset</td></tr>
<tr class="codeline" data-linenumber="4546"><td class="num" id="LN4546">4546</td><td class="line">            );</td></tr>
<tr class="codeline" data-linenumber="4547"><td class="num" id="LN4547">4547</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4548"><td class="num" id="LN4548">4548</td><td class="line">            <span class='keyword'>if</span> (server.repl_state == <span class='macro'>REPL_STATE_TRANSFER<span class='macro_popup'>14</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4549"><td class="num" id="LN4549">4549</td><td class="line">                info = sdscatprintf(info,</td></tr>
<tr class="codeline" data-linenumber="4550"><td class="num" id="LN4550">4550</td><td class="line">                    <span class='string_literal'>"master_sync_left_bytes:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4551"><td class="num" id="LN4551">4551</td><td class="line">                    <span class='string_literal'>"master_sync_last_io_seconds_ago:%d\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4552"><td class="num" id="LN4552">4552</td><td class="line">                    , (<span class='keyword'>long</span> <span class='keyword'>long</span>)</td></tr>
<tr class="codeline" data-linenumber="4553"><td class="num" id="LN4553">4553</td><td class="line">                        (server.repl_transfer_size - server.repl_transfer_read),</td></tr>
<tr class="codeline" data-linenumber="4554"><td class="num" id="LN4554">4554</td><td class="line">                    (<span class='keyword'>int</span>)(server.unixtime-server.repl_transfer_lastio)</td></tr>
<tr class="codeline" data-linenumber="4555"><td class="num" id="LN4555">4555</td><td class="line">                );</td></tr>
<tr class="codeline" data-linenumber="4556"><td class="num" id="LN4556">4556</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="4557"><td class="num" id="LN4557">4557</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4558"><td class="num" id="LN4558">4558</td><td class="line">            <span class='keyword'>if</span> (server.repl_state != <span class='macro'>REPL_STATE_CONNECTED<span class='macro_popup'>15</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4559"><td class="num" id="LN4559">4559</td><td class="line">                info = sdscatprintf(info,</td></tr>
<tr class="codeline" data-linenumber="4560"><td class="num" id="LN4560">4560</td><td class="line">                    <span class='string_literal'>"master_link_down_since_seconds:%jd\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="4561"><td class="num" id="LN4561">4561</td><td class="line">                    (intmax_t)(server.unixtime-server.repl_down_since));</td></tr>
<tr class="codeline" data-linenumber="4562"><td class="num" id="LN4562">4562</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="4563"><td class="num" id="LN4563">4563</td><td class="line">            info = sdscatprintf(info,</td></tr>
<tr class="codeline" data-linenumber="4564"><td class="num" id="LN4564">4564</td><td class="line">                <span class='string_literal'>"slave_priority:%d\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4565"><td class="num" id="LN4565">4565</td><td class="line">                <span class='string_literal'>"slave_read_only:%d\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="4566"><td class="num" id="LN4566">4566</td><td class="line">                server.slave_priority,</td></tr>
<tr class="codeline" data-linenumber="4567"><td class="num" id="LN4567">4567</td><td class="line">                server.repl_slave_ro);</td></tr>
<tr class="codeline" data-linenumber="4568"><td class="num" id="LN4568">4568</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4569"><td class="num" id="LN4569">4569</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4570"><td class="num" id="LN4570">4570</td><td class="line">        info = sdscatprintf(info,</td></tr>
<tr class="codeline" data-linenumber="4571"><td class="num" id="LN4571">4571</td><td class="line">            <span class='string_literal'>"connected_slaves:%lu\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="4572"><td class="num" id="LN4572">4572</td><td class="line">            <span class='macro'>listLength(server.slaves)<span class='macro_popup'>((server.slaves)-&gt;len)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4573"><td class="num" id="LN4573">4573</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4574"><td class="num" id="LN4574">4574</td><td class="line">        <span class='comment'>/* If min-slaves-to-write is active, write the number of slaves</span></td></tr>
<tr class="codeline" data-linenumber="4575"><td class="num" id="LN4575">4575</td><td class="line">         <span class='comment'>* currently considered 'good'. */</span></td></tr>
<tr class="codeline" data-linenumber="4576"><td class="num" id="LN4576">4576</td><td class="line">        <span class='keyword'>if</span> (server.repl_min_slaves_to_write &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="4577"><td class="num" id="LN4577">4577</td><td class="line">            server.repl_min_slaves_max_lag) {</td></tr>
<tr class="codeline" data-linenumber="4578"><td class="num" id="LN4578">4578</td><td class="line">            info = sdscatprintf(info,</td></tr>
<tr class="codeline" data-linenumber="4579"><td class="num" id="LN4579">4579</td><td class="line">                <span class='string_literal'>"min_slaves_good_slaves:%d\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="4580"><td class="num" id="LN4580">4580</td><td class="line">                server.repl_good_slaves_count);</td></tr>
<tr class="codeline" data-linenumber="4581"><td class="num" id="LN4581">4581</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4582"><td class="num" id="LN4582">4582</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4583"><td class="num" id="LN4583">4583</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>listLength(server.slaves)<span class='macro_popup'>((server.slaves)-&gt;len)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4584"><td class="num" id="LN4584">4584</td><td class="line">            <span class='keyword'>int</span> slaveid = 0;</td></tr>
<tr class="codeline" data-linenumber="4585"><td class="num" id="LN4585">4585</td><td class="line">            listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="4586"><td class="num" id="LN4586">4586</td><td class="line">            listIter li;</td></tr>
<tr class="codeline" data-linenumber="4587"><td class="num" id="LN4587">4587</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4588"><td class="num" id="LN4588">4588</td><td class="line">            listRewind(server.slaves,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="4589"><td class="num" id="LN4589">4589</td><td class="line">            <span class='keyword'>while</span>((ln = listNext(&amp;li))) {</td></tr>
<tr class="codeline" data-linenumber="4590"><td class="num" id="LN4590">4590</td><td class="line">                client *slave = <span class='macro'>listNodeValue(ln)<span class='macro_popup'>((ln)-&gt;value)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4591"><td class="num" id="LN4591">4591</td><td class="line">                <span class='keyword'>char</span> *state = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4592"><td class="num" id="LN4592">4592</td><td class="line">                <span class='keyword'>char</span> ip[<span class='macro'>NET_IP_STR_LEN<span class='macro_popup'>46</span></span>], *slaveip = slave-&gt;slave_ip;</td></tr>
<tr class="codeline" data-linenumber="4593"><td class="num" id="LN4593">4593</td><td class="line">                <span class='keyword'>int</span> port;</td></tr>
<tr class="codeline" data-linenumber="4594"><td class="num" id="LN4594">4594</td><td class="line">                <span class='keyword'>long</span> lag = 0;</td></tr>
<tr class="codeline" data-linenumber="4595"><td class="num" id="LN4595">4595</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4596"><td class="num" id="LN4596">4596</td><td class="line">                <span class='keyword'>if</span> (slaveip[0] == '\0') {</td></tr>
<tr class="codeline" data-linenumber="4597"><td class="num" id="LN4597">4597</td><td class="line">                    <span class='keyword'>if</span> (connPeerToString(slave-&gt;conn,ip,<span class='keyword'>sizeof</span>(ip),&amp;port) == -1)</td></tr>
<tr class="codeline" data-linenumber="4598"><td class="num" id="LN4598">4598</td><td class="line">                        <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="4599"><td class="num" id="LN4599">4599</td><td class="line">                    slaveip = ip;</td></tr>
<tr class="codeline" data-linenumber="4600"><td class="num" id="LN4600">4600</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="4601"><td class="num" id="LN4601">4601</td><td class="line">                <span class='keyword'>switch</span>(slave-&gt;replstate) {</td></tr>
<tr class="codeline" data-linenumber="4602"><td class="num" id="LN4602">4602</td><td class="line">                <span class='keyword'>case</span> <span class='macro'>SLAVE_STATE_WAIT_BGSAVE_START<span class='macro_popup'>6</span></span>:</td></tr>
<tr class="codeline" data-linenumber="4603"><td class="num" id="LN4603">4603</td><td class="line">                <span class='keyword'>case</span> <span class='macro'>SLAVE_STATE_WAIT_BGSAVE_END<span class='macro_popup'>7</span></span>:</td></tr>
<tr class="codeline" data-linenumber="4604"><td class="num" id="LN4604">4604</td><td class="line">                    state = <span class='string_literal'>"wait_bgsave"</span>;</td></tr>
<tr class="codeline" data-linenumber="4605"><td class="num" id="LN4605">4605</td><td class="line">                    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4606"><td class="num" id="LN4606">4606</td><td class="line">                <span class='keyword'>case</span> <span class='macro'>SLAVE_STATE_SEND_BULK<span class='macro_popup'>8</span></span>:</td></tr>
<tr class="codeline" data-linenumber="4607"><td class="num" id="LN4607">4607</td><td class="line">                    state = <span class='string_literal'>"send_bulk"</span>;</td></tr>
<tr class="codeline" data-linenumber="4608"><td class="num" id="LN4608">4608</td><td class="line">                    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4609"><td class="num" id="LN4609">4609</td><td class="line">                <span class='keyword'>case</span> <span class='macro'>SLAVE_STATE_ONLINE<span class='macro_popup'>9</span></span>:</td></tr>
<tr class="codeline" data-linenumber="4610"><td class="num" id="LN4610">4610</td><td class="line">                    state = <span class='string_literal'>"online"</span>;</td></tr>
<tr class="codeline" data-linenumber="4611"><td class="num" id="LN4611">4611</td><td class="line">                    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4612"><td class="num" id="LN4612">4612</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="4613"><td class="num" id="LN4613">4613</td><td class="line">                <span class='keyword'>if</span> (state == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="4614"><td class="num" id="LN4614">4614</td><td class="line">                <span class='keyword'>if</span> (slave-&gt;replstate == <span class='macro'>SLAVE_STATE_ONLINE<span class='macro_popup'>9</span></span>)</td></tr>
<tr class="codeline" data-linenumber="4615"><td class="num" id="LN4615">4615</td><td class="line">                    lag = time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) - slave-&gt;repl_ack_time;</td></tr>
<tr class="codeline" data-linenumber="4616"><td class="num" id="LN4616">4616</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4617"><td class="num" id="LN4617">4617</td><td class="line">                info = sdscatprintf(info,</td></tr>
<tr class="codeline" data-linenumber="4618"><td class="num" id="LN4618">4618</td><td class="line">                    <span class='string_literal'>"slave%d:ip=%s,port=%d,state=%s,"</span></td></tr>
<tr class="codeline" data-linenumber="4619"><td class="num" id="LN4619">4619</td><td class="line">                    <span class='string_literal'>"offset=%lld,lag=%ld\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="4620"><td class="num" id="LN4620">4620</td><td class="line">                    slaveid,slaveip,slave-&gt;slave_listening_port,state,</td></tr>
<tr class="codeline" data-linenumber="4621"><td class="num" id="LN4621">4621</td><td class="line">                    slave-&gt;repl_ack_off, lag);</td></tr>
<tr class="codeline" data-linenumber="4622"><td class="num" id="LN4622">4622</td><td class="line">                slaveid++;</td></tr>
<tr class="codeline" data-linenumber="4623"><td class="num" id="LN4623">4623</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="4624"><td class="num" id="LN4624">4624</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4625"><td class="num" id="LN4625">4625</td><td class="line">        info = sdscatprintf(info,</td></tr>
<tr class="codeline" data-linenumber="4626"><td class="num" id="LN4626">4626</td><td class="line">            <span class='string_literal'>"master_replid:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4627"><td class="num" id="LN4627">4627</td><td class="line">            <span class='string_literal'>"master_replid2:%s\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4628"><td class="num" id="LN4628">4628</td><td class="line">            <span class='string_literal'>"master_repl_offset:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4629"><td class="num" id="LN4629">4629</td><td class="line">            <span class='string_literal'>"second_repl_offset:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4630"><td class="num" id="LN4630">4630</td><td class="line">            <span class='string_literal'>"repl_backlog_active:%d\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4631"><td class="num" id="LN4631">4631</td><td class="line">            <span class='string_literal'>"repl_backlog_size:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4632"><td class="num" id="LN4632">4632</td><td class="line">            <span class='string_literal'>"repl_backlog_first_byte_offset:%lld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4633"><td class="num" id="LN4633">4633</td><td class="line">            <span class='string_literal'>"repl_backlog_histlen:%lld\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="4634"><td class="num" id="LN4634">4634</td><td class="line">            server.replid,</td></tr>
<tr class="codeline" data-linenumber="4635"><td class="num" id="LN4635">4635</td><td class="line">            server.replid2,</td></tr>
<tr class="codeline" data-linenumber="4636"><td class="num" id="LN4636">4636</td><td class="line">            server.master_repl_offset,</td></tr>
<tr class="codeline" data-linenumber="4637"><td class="num" id="LN4637">4637</td><td class="line">            server.second_replid_offset,</td></tr>
<tr class="codeline" data-linenumber="4638"><td class="num" id="LN4638">4638</td><td class="line">            server.repl_backlog != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4639"><td class="num" id="LN4639">4639</td><td class="line">            server.repl_backlog_size,</td></tr>
<tr class="codeline" data-linenumber="4640"><td class="num" id="LN4640">4640</td><td class="line">            server.repl_backlog_off,</td></tr>
<tr class="codeline" data-linenumber="4641"><td class="num" id="LN4641">4641</td><td class="line">            server.repl_backlog_histlen);</td></tr>
<tr class="codeline" data-linenumber="4642"><td class="num" id="LN4642">4642</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4643"><td class="num" id="LN4643">4643</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4644"><td class="num" id="LN4644">4644</td><td class="line">    <span class='comment'>/* CPU */</span></td></tr>
<tr class="codeline" data-linenumber="4645"><td class="num" id="LN4645">4645</td><td class="line">    <span class='keyword'>if</span> (allsections || defsections || !strcasecmp(section,<span class='string_literal'>"cpu"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="4646"><td class="num" id="LN4646">4646</td><td class="line">        <span class='keyword'>if</span> (sections++) info = sdscat(info,<span class='string_literal'>"\r\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4647"><td class="num" id="LN4647">4647</td><td class="line">        info = sdscatprintf(info,</td></tr>
<tr class="codeline" data-linenumber="4648"><td class="num" id="LN4648">4648</td><td class="line">        <span class='string_literal'>"# CPU\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4649"><td class="num" id="LN4649">4649</td><td class="line">        <span class='string_literal'>"used_cpu_sys:%ld.%06ld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4650"><td class="num" id="LN4650">4650</td><td class="line">        <span class='string_literal'>"used_cpu_user:%ld.%06ld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4651"><td class="num" id="LN4651">4651</td><td class="line">        <span class='string_literal'>"used_cpu_sys_children:%ld.%06ld\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4652"><td class="num" id="LN4652">4652</td><td class="line">        <span class='string_literal'>"used_cpu_user_children:%ld.%06ld\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="4653"><td class="num" id="LN4653">4653</td><td class="line">        (<span class='keyword'>long</span>)self_ru.ru_stime.tv_sec, (<span class='keyword'>long</span>)self_ru.ru_stime.tv_usec,</td></tr>
<tr class="codeline" data-linenumber="4654"><td class="num" id="LN4654">4654</td><td class="line">        (<span class='keyword'>long</span>)self_ru.ru_utime.tv_sec, (<span class='keyword'>long</span>)self_ru.ru_utime.tv_usec,</td></tr>
<tr class="codeline" data-linenumber="4655"><td class="num" id="LN4655">4655</td><td class="line">        (<span class='keyword'>long</span>)c_ru.ru_stime.tv_sec, (<span class='keyword'>long</span>)c_ru.ru_stime.tv_usec,</td></tr>
<tr class="codeline" data-linenumber="4656"><td class="num" id="LN4656">4656</td><td class="line">        (<span class='keyword'>long</span>)c_ru.ru_utime.tv_sec, (<span class='keyword'>long</span>)c_ru.ru_utime.tv_usec);</td></tr>
<tr class="codeline" data-linenumber="4657"><td class="num" id="LN4657">4657</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4658"><td class="num" id="LN4658">4658</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4659"><td class="num" id="LN4659">4659</td><td class="line">    <span class='comment'>/* Modules */</span></td></tr>
<tr class="codeline" data-linenumber="4660"><td class="num" id="LN4660">4660</td><td class="line">    <span class='keyword'>if</span> (allsections || defsections || !strcasecmp(section,<span class='string_literal'>"modules"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="4661"><td class="num" id="LN4661">4661</td><td class="line">        <span class='keyword'>if</span> (sections++) info = sdscat(info,<span class='string_literal'>"\r\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4662"><td class="num" id="LN4662">4662</td><td class="line">        info = sdscatprintf(info,<span class='string_literal'>"# Modules\r\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4663"><td class="num" id="LN4663">4663</td><td class="line">        info = genModulesInfoString(info);</td></tr>
<tr class="codeline" data-linenumber="4664"><td class="num" id="LN4664">4664</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4665"><td class="num" id="LN4665">4665</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4666"><td class="num" id="LN4666">4666</td><td class="line">    <span class='comment'>/* Command statistics */</span></td></tr>
<tr class="codeline" data-linenumber="4667"><td class="num" id="LN4667">4667</td><td class="line">    <span class='keyword'>if</span> (allsections || !strcasecmp(section,<span class='string_literal'>"commandstats"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="4668"><td class="num" id="LN4668">4668</td><td class="line">        <span class='keyword'>if</span> (sections++) info = sdscat(info,<span class='string_literal'>"\r\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4669"><td class="num" id="LN4669">4669</td><td class="line">        info = sdscatprintf(info, <span class='string_literal'>"# Commandstats\r\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4670"><td class="num" id="LN4670">4670</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4671"><td class="num" id="LN4671">4671</td><td class="line">        <span class='keyword'>struct</span> redisCommand *c;</td></tr>
<tr class="codeline" data-linenumber="4672"><td class="num" id="LN4672">4672</td><td class="line">        dictEntry *de;</td></tr>
<tr class="codeline" data-linenumber="4673"><td class="num" id="LN4673">4673</td><td class="line">        dictIterator *di;</td></tr>
<tr class="codeline" data-linenumber="4674"><td class="num" id="LN4674">4674</td><td class="line">        di = dictGetSafeIterator(server.commands);</td></tr>
<tr class="codeline" data-linenumber="4675"><td class="num" id="LN4675">4675</td><td class="line">        <span class='keyword'>while</span>((de = dictNext(di)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4676"><td class="num" id="LN4676">4676</td><td class="line">            c = (<span class='keyword'>struct</span> redisCommand *) <span class='macro'>dictGetVal(de)<span class='macro_popup'>((de)-&gt;v.val)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4677"><td class="num" id="LN4677">4677</td><td class="line">            <span class='keyword'>if</span> (!c-&gt;calls) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="4678"><td class="num" id="LN4678">4678</td><td class="line">            info = sdscatprintf(info,</td></tr>
<tr class="codeline" data-linenumber="4679"><td class="num" id="LN4679">4679</td><td class="line">                <span class='string_literal'>"cmdstat_%s:calls=%lld,usec=%lld,usec_per_call=%.2f\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="4680"><td class="num" id="LN4680">4680</td><td class="line">                c-&gt;name, c-&gt;calls, c-&gt;microseconds,</td></tr>
<tr class="codeline" data-linenumber="4681"><td class="num" id="LN4681">4681</td><td class="line">                (c-&gt;calls == 0) ? 0 : ((<span class='keyword'>float</span>)c-&gt;microseconds/c-&gt;calls));</td></tr>
<tr class="codeline" data-linenumber="4682"><td class="num" id="LN4682">4682</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4683"><td class="num" id="LN4683">4683</td><td class="line">        dictReleaseIterator(di);</td></tr>
<tr class="codeline" data-linenumber="4684"><td class="num" id="LN4684">4684</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4685"><td class="num" id="LN4685">4685</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4686"><td class="num" id="LN4686">4686</td><td class="line">    <span class='comment'>/* Cluster */</span></td></tr>
<tr class="codeline" data-linenumber="4687"><td class="num" id="LN4687">4687</td><td class="line">    <span class='keyword'>if</span> (allsections || defsections || !strcasecmp(section,<span class='string_literal'>"cluster"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="4688"><td class="num" id="LN4688">4688</td><td class="line">        <span class='keyword'>if</span> (sections++) info = sdscat(info,<span class='string_literal'>"\r\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4689"><td class="num" id="LN4689">4689</td><td class="line">        info = sdscatprintf(info,</td></tr>
<tr class="codeline" data-linenumber="4690"><td class="num" id="LN4690">4690</td><td class="line">        <span class='string_literal'>"# Cluster\r\n"</span></td></tr>
<tr class="codeline" data-linenumber="4691"><td class="num" id="LN4691">4691</td><td class="line">        <span class='string_literal'>"cluster_enabled:%d\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="4692"><td class="num" id="LN4692">4692</td><td class="line">        server.cluster_enabled);</td></tr>
<tr class="codeline" data-linenumber="4693"><td class="num" id="LN4693">4693</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4694"><td class="num" id="LN4694">4694</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4695"><td class="num" id="LN4695">4695</td><td class="line">    <span class='comment'>/* Key space */</span></td></tr>
<tr class="codeline" data-linenumber="4696"><td class="num" id="LN4696">4696</td><td class="line">    <span class='keyword'>if</span> (allsections || defsections || !strcasecmp(section,<span class='string_literal'>"keyspace"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="4697"><td class="num" id="LN4697">4697</td><td class="line">        <span class='keyword'>if</span> (sections++) info = sdscat(info,<span class='string_literal'>"\r\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4698"><td class="num" id="LN4698">4698</td><td class="line">        info = sdscatprintf(info, <span class='string_literal'>"# Keyspace\r\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4699"><td class="num" id="LN4699">4699</td><td class="line">        <span class='keyword'>for</span> (j = 0; j &lt; server.dbnum; j++) {</td></tr>
<tr class="codeline" data-linenumber="4700"><td class="num" id="LN4700">4700</td><td class="line">            <span class='keyword'>long</span> <span class='keyword'>long</span> keys, vkeys;</td></tr>
<tr class="codeline" data-linenumber="4701"><td class="num" id="LN4701">4701</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4702"><td class="num" id="LN4702">4702</td><td class="line">            keys = <span class='macro'>dictSize(server.db[j].dict)<span class='macro_popup'>((server.db[j].dict)-&gt;ht[0].used+(server.db[j].dict)-&gt;ht<br>[1].used)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4703"><td class="num" id="LN4703">4703</td><td class="line">            vkeys = <span class='macro'>dictSize(server.db[j].expires)<span class='macro_popup'>((server.db[j].expires)-&gt;ht[0].used+(server.db[j].expires)<br>-&gt;ht[1].used)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4704"><td class="num" id="LN4704">4704</td><td class="line">            <span class='keyword'>if</span> (keys || vkeys) {</td></tr>
<tr class="codeline" data-linenumber="4705"><td class="num" id="LN4705">4705</td><td class="line">                info = sdscatprintf(info,</td></tr>
<tr class="codeline" data-linenumber="4706"><td class="num" id="LN4706">4706</td><td class="line">                    <span class='string_literal'>"db%d:keys=%lld,expires=%lld,avg_ttl=%lld\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="4707"><td class="num" id="LN4707">4707</td><td class="line">                    j, keys, vkeys, server.db[j].avg_ttl);</td></tr>
<tr class="codeline" data-linenumber="4708"><td class="num" id="LN4708">4708</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="4709"><td class="num" id="LN4709">4709</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4710"><td class="num" id="LN4710">4710</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4711"><td class="num" id="LN4711">4711</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4712"><td class="num" id="LN4712">4712</td><td class="line">    <span class='comment'>/* Get info from modules.</span></td></tr>
<tr class="codeline" data-linenumber="4713"><td class="num" id="LN4713">4713</td><td class="line">     <span class='comment'>* if user asked for "everything" or "modules", or a specific section</span></td></tr>
<tr class="codeline" data-linenumber="4714"><td class="num" id="LN4714">4714</td><td class="line">     <span class='comment'>* that's not found yet. */</span></td></tr>
<tr class="codeline" data-linenumber="4715"><td class="num" id="LN4715">4715</td><td class="line">    <span class='keyword'>if</span> (everything || modules ||</td></tr>
<tr class="codeline" data-linenumber="4716"><td class="num" id="LN4716">4716</td><td class="line">        (!allsections &amp;&amp; !defsections &amp;&amp; sections==0)) {</td></tr>
<tr class="codeline" data-linenumber="4717"><td class="num" id="LN4717">4717</td><td class="line">        info = modulesCollectInfo(info,</td></tr>
<tr class="codeline" data-linenumber="4718"><td class="num" id="LN4718">4718</td><td class="line">                                  everything || modules ? <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>: section,</td></tr>
<tr class="codeline" data-linenumber="4719"><td class="num" id="LN4719">4719</td><td class="line">                                  0, <span class='comment'>/* not a crash report */</span></td></tr>
<tr class="codeline" data-linenumber="4720"><td class="num" id="LN4720">4720</td><td class="line">                                  sections);</td></tr>
<tr class="codeline" data-linenumber="4721"><td class="num" id="LN4721">4721</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4722"><td class="num" id="LN4722">4722</td><td class="line">    <span class='keyword'>return</span> info;</td></tr>
<tr class="codeline" data-linenumber="4723"><td class="num" id="LN4723">4723</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4724"><td class="num" id="LN4724">4724</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4725"><td class="num" id="LN4725">4725</td><td class="line"><span class='keyword'>void</span> infoCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="4726"><td class="num" id="LN4726">4726</td><td class="line">    <span class='keyword'>char</span> *section = c-&gt;argc == 2 ? c-&gt;argv[1]-&gt;ptr : <span class='string_literal'>"default"</span>;</td></tr>
<tr class="codeline" data-linenumber="4727"><td class="num" id="LN4727">4727</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4728"><td class="num" id="LN4728">4728</td><td class="line">    <span class='keyword'>if</span> (c-&gt;argc &gt; 2) {</td></tr>
<tr class="codeline" data-linenumber="4729"><td class="num" id="LN4729">4729</td><td class="line">        addReply(c,shared.syntaxerr);</td></tr>
<tr class="codeline" data-linenumber="4730"><td class="num" id="LN4730">4730</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="4731"><td class="num" id="LN4731">4731</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4732"><td class="num" id="LN4732">4732</td><td class="line">    sds info = genRedisInfoString(section);</td></tr>
<tr class="codeline" data-linenumber="4733"><td class="num" id="LN4733">4733</td><td class="line">    addReplyVerbatim(c,info,sdslen(info),<span class='string_literal'>"txt"</span>);</td></tr>
<tr class="codeline" data-linenumber="4734"><td class="num" id="LN4734">4734</td><td class="line">    sdsfree(info);</td></tr>
<tr class="codeline" data-linenumber="4735"><td class="num" id="LN4735">4735</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4736"><td class="num" id="LN4736">4736</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4737"><td class="num" id="LN4737">4737</td><td class="line"><span class='keyword'>void</span> monitorCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="4738"><td class="num" id="LN4738">4738</td><td class="line">    <span class='comment'>/* ignore MONITOR if already slave or in monitor mode */</span></td></tr>
<tr class="codeline" data-linenumber="4739"><td class="num" id="LN4739">4739</td><td class="line">    <span class='keyword'>if</span> (c-&gt;flags &amp; <span class='macro'>CLIENT_SLAVE<span class='macro_popup'>(1&lt;&lt;0)</span></span>) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="4740"><td class="num" id="LN4740">4740</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4741"><td class="num" id="LN4741">4741</td><td class="line">    c-&gt;flags |= (<span class='macro'>CLIENT_SLAVE<span class='macro_popup'>(1&lt;&lt;0)</span></span>|<span class='macro'>CLIENT_MONITOR<span class='macro_popup'>(1&lt;&lt;2)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4742"><td class="num" id="LN4742">4742</td><td class="line">    listAddNodeTail(server.monitors,c);</td></tr>
<tr class="codeline" data-linenumber="4743"><td class="num" id="LN4743">4743</td><td class="line">    addReply(c,shared.ok);</td></tr>
<tr class="codeline" data-linenumber="4744"><td class="num" id="LN4744">4744</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4745"><td class="num" id="LN4745">4745</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4746"><td class="num" id="LN4746">4746</td><td class="line"><span class='comment'>/* =================================== Main! ================================ */</span></td></tr>
<tr class="codeline" data-linenumber="4747"><td class="num" id="LN4747">4747</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4748"><td class="num" id="LN4748">4748</td><td class="line"><span class='directive'>#ifdef <span class='macro'>__linux__<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4749"><td class="num" id="LN4749">4749</td><td class="line"><span class='keyword'>int</span> linuxOvercommitMemoryValue(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="4750"><td class="num" id="LN4750">4750</td><td class="line">    FILE *fp = fopen(<span class='string_literal'>"/proc/sys/vm/overcommit_memory"</span>,<span class='string_literal'>"r"</span>);</td></tr>
<tr class="codeline" data-linenumber="4751"><td class="num" id="LN4751">4751</td><td class="line">    <span class='keyword'>char</span> buf[64];</td></tr>
<tr class="codeline" data-linenumber="4752"><td class="num" id="LN4752">4752</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4753"><td class="num" id="LN4753">4753</td><td class="line">    <span class='keyword'>if</span> (!fp) <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="4754"><td class="num" id="LN4754">4754</td><td class="line">    <span class='keyword'>if</span> (fgets(buf,64,fp) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4755"><td class="num" id="LN4755">4755</td><td class="line">        fclose(fp);</td></tr>
<tr class="codeline" data-linenumber="4756"><td class="num" id="LN4756">4756</td><td class="line">        <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="4757"><td class="num" id="LN4757">4757</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4758"><td class="num" id="LN4758">4758</td><td class="line">    fclose(fp);</td></tr>
<tr class="codeline" data-linenumber="4759"><td class="num" id="LN4759">4759</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4760"><td class="num" id="LN4760">4760</td><td class="line">    <span class='keyword'>return</span> atoi(buf);</td></tr>
<tr class="codeline" data-linenumber="4761"><td class="num" id="LN4761">4761</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4762"><td class="num" id="LN4762">4762</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4763"><td class="num" id="LN4763">4763</td><td class="line"><span class='keyword'>void</span> linuxMemoryWarnings(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="4764"><td class="num" id="LN4764">4764</td><td class="line">    <span class='keyword'>if</span> (linuxOvercommitMemoryValue() == 0) {</td></tr>
<tr class="codeline" data-linenumber="4765"><td class="num" id="LN4765">4765</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect."</span>);</td></tr>
<tr class="codeline" data-linenumber="4766"><td class="num" id="LN4766">4766</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4767"><td class="num" id="LN4767">4767</td><td class="line">    <span class='keyword'>if</span> (THPIsEnabled()) {</td></tr>
<tr class="codeline" data-linenumber="4768"><td class="num" id="LN4768">4768</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo madvise &gt; /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled (set to 'madvise' or 'never')."</span>);</td></tr>
<tr class="codeline" data-linenumber="4769"><td class="num" id="LN4769">4769</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4770"><td class="num" id="LN4770">4770</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4771"><td class="num" id="LN4771">4771</td><td class="line"><span class='directive'>#endif /* __linux__ */</span></td></tr>
<tr class="codeline" data-linenumber="4772"><td class="num" id="LN4772">4772</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4773"><td class="num" id="LN4773">4773</td><td class="line"><span class='keyword'>void</span> createPidFile(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="4774"><td class="num" id="LN4774">4774</td><td class="line">    <span class='comment'>/* If pidfile requested, but no pidfile defined, use</span></td></tr>
<tr class="codeline" data-linenumber="4775"><td class="num" id="LN4775">4775</td><td class="line">     <span class='comment'>* default pidfile path */</span></td></tr>
<tr class="codeline" data-linenumber="4776"><td class="num" id="LN4776">4776</td><td class="line">    <span class='keyword'>if</span> (!server.pidfile) server.pidfile = zstrdup(<span class='macro'>CONFIG_DEFAULT_PID_FILE<span class='macro_popup'>"/var/run/redis.pid"</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4777"><td class="num" id="LN4777">4777</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4778"><td class="num" id="LN4778">4778</td><td class="line">    <span class='comment'>/* Try to write the pid file in a best-effort way. */</span></td></tr>
<tr class="codeline" data-linenumber="4779"><td class="num" id="LN4779">4779</td><td class="line">    FILE *fp = fopen(server.pidfile,<span class='string_literal'>"w"</span>);</td></tr>
<tr class="codeline" data-linenumber="4780"><td class="num" id="LN4780">4780</td><td class="line">    <span class='keyword'>if</span> (fp) {</td></tr>
<tr class="codeline" data-linenumber="4781"><td class="num" id="LN4781">4781</td><td class="line">        fprintf(fp,<span class='string_literal'>"%d\n"</span>,(<span class='keyword'>int</span>)getpid());</td></tr>
<tr class="codeline" data-linenumber="4782"><td class="num" id="LN4782">4782</td><td class="line">        fclose(fp);</td></tr>
<tr class="codeline" data-linenumber="4783"><td class="num" id="LN4783">4783</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4784"><td class="num" id="LN4784">4784</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4785"><td class="num" id="LN4785">4785</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4786"><td class="num" id="LN4786">4786</td><td class="line"><span class='keyword'>void</span> daemonize(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="4787"><td class="num" id="LN4787">4787</td><td class="line">    <span class='keyword'>int</span> fd;</td></tr>
<tr class="codeline" data-linenumber="4788"><td class="num" id="LN4788">4788</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4789"><td class="num" id="LN4789">4789</td><td class="line">    <span class='keyword'>if</span> (fork() != 0) exit(0); <span class='comment'>/* parent exits */</span></td></tr>
<tr class="codeline" data-linenumber="4790"><td class="num" id="LN4790">4790</td><td class="line">    setsid(); <span class='comment'>/* create a new session */</span></td></tr>
<tr class="codeline" data-linenumber="4791"><td class="num" id="LN4791">4791</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4792"><td class="num" id="LN4792">4792</td><td class="line">    <span class='comment'>/* Every output goes to /dev/null. If Redis is daemonized but</span></td></tr>
<tr class="codeline" data-linenumber="4793"><td class="num" id="LN4793">4793</td><td class="line">     <span class='comment'>* the 'logfile' is set to 'stdout' in the configuration file</span></td></tr>
<tr class="codeline" data-linenumber="4794"><td class="num" id="LN4794">4794</td><td class="line">     <span class='comment'>* it will not log at all. */</span></td></tr>
<tr class="codeline" data-linenumber="4795"><td class="num" id="LN4795">4795</td><td class="line">    <span class='keyword'>if</span> ((fd = open(<span class='string_literal'>"/dev/null"</span>, <span class='macro'>O_RDWR<span class='macro_popup'>02</span></span>, 0)) != -1) {</td></tr>
<tr class="codeline" data-linenumber="4796"><td class="num" id="LN4796">4796</td><td class="line">        dup2(fd, <span class='macro'>STDIN_FILENO<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4797"><td class="num" id="LN4797">4797</td><td class="line">        dup2(fd, <span class='macro'>STDOUT_FILENO<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4798"><td class="num" id="LN4798">4798</td><td class="line">        dup2(fd, <span class='macro'>STDERR_FILENO<span class='macro_popup'>2</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4799"><td class="num" id="LN4799">4799</td><td class="line">        <span class='keyword'>if</span> (fd &gt; <span class='macro'>STDERR_FILENO<span class='macro_popup'>2</span></span>) close(fd);</td></tr>
<tr class="codeline" data-linenumber="4800"><td class="num" id="LN4800">4800</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4801"><td class="num" id="LN4801">4801</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4802"><td class="num" id="LN4802">4802</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4803"><td class="num" id="LN4803">4803</td><td class="line"><span class='keyword'>void</span> version(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="4804"><td class="num" id="LN4804">4804</td><td class="line">    printf(<span class='string_literal'>"Redis server v=%s sha=%s:%d malloc=%s bits=%d build=%llx\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="4805"><td class="num" id="LN4805">4805</td><td class="line">        <span class='macro'>REDIS_VERSION<span class='macro_popup'>"6.0.9"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4806"><td class="num" id="LN4806">4806</td><td class="line">        redisGitSHA1(),</td></tr>
<tr class="codeline" data-linenumber="4807"><td class="num" id="LN4807">4807</td><td class="line">        atoi(redisGitDirty()) &gt; 0,</td></tr>
<tr class="codeline" data-linenumber="4808"><td class="num" id="LN4808">4808</td><td class="line">        <span class='macro'>ZMALLOC_LIB<span class='macro_popup'>("jemalloc-" "5" "." "1" "." "0")</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4809"><td class="num" id="LN4809">4809</td><td class="line">        <span class='keyword'>sizeof</span>(<span class='keyword'>long</span>) == 4 ? 32 : 64,</td></tr>
<tr class="codeline" data-linenumber="4810"><td class="num" id="LN4810">4810</td><td class="line">        (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>) redisBuildId());</td></tr>
<tr class="codeline" data-linenumber="4811"><td class="num" id="LN4811">4811</td><td class="line">    exit(0);</td></tr>
<tr class="codeline" data-linenumber="4812"><td class="num" id="LN4812">4812</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4813"><td class="num" id="LN4813">4813</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4814"><td class="num" id="LN4814">4814</td><td class="line"><span class='keyword'>void</span> usage(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="4815"><td class="num" id="LN4815">4815</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Usage: ./redis-server [/path/to/redis.conf] [options]\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4816"><td class="num" id="LN4816">4816</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"       ./redis-server - (read config from stdin)\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4817"><td class="num" id="LN4817">4817</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"       ./redis-server -v or --version\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4818"><td class="num" id="LN4818">4818</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"       ./redis-server -h or --help\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4819"><td class="num" id="LN4819">4819</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"       ./redis-server --test-memory &lt;megabytes&gt;\n\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4820"><td class="num" id="LN4820">4820</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Examples:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4821"><td class="num" id="LN4821">4821</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"       ./redis-server (run the server with default conf)\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4822"><td class="num" id="LN4822">4822</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"       ./redis-server /etc/redis/6379.conf\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4823"><td class="num" id="LN4823">4823</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"       ./redis-server --port 7777\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4824"><td class="num" id="LN4824">4824</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"       ./redis-server --port 7777 --replicaof 127.0.0.1 8888\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4825"><td class="num" id="LN4825">4825</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"       ./redis-server /etc/myredis.conf --loglevel verbose\n\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4826"><td class="num" id="LN4826">4826</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Sentinel mode:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4827"><td class="num" id="LN4827">4827</td><td class="line">    fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"       ./redis-server /etc/sentinel.conf --sentinel\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="4828"><td class="num" id="LN4828">4828</td><td class="line">    exit(1);</td></tr>
<tr class="codeline" data-linenumber="4829"><td class="num" id="LN4829">4829</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4830"><td class="num" id="LN4830">4830</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4831"><td class="num" id="LN4831">4831</td><td class="line"><span class='keyword'>void</span> redisAsciiArt(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="4832"><td class="num" id="LN4832">4832</td><td class="line"><span class='directive'>#include "asciilogo.h"</span></td></tr>
<tr class="codeline" data-linenumber="4833"><td class="num" id="LN4833">4833</td><td class="line">    <span class='keyword'>char</span> *buf = zmalloc(1024*16);</td></tr>
<tr class="codeline" data-linenumber="4834"><td class="num" id="LN4834">4834</td><td class="line">    <span class='keyword'>char</span> *mode;</td></tr>
<tr class="codeline" data-linenumber="4835"><td class="num" id="LN4835">4835</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4836"><td class="num" id="LN4836">4836</td><td class="line">    <span class='keyword'>if</span> (server.cluster_enabled) mode = <span class='string_literal'>"cluster"</span>;</td></tr>
<tr class="codeline" data-linenumber="4837"><td class="num" id="LN4837">4837</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (server.sentinel_mode) mode = <span class='string_literal'>"sentinel"</span>;</td></tr>
<tr class="codeline" data-linenumber="4838"><td class="num" id="LN4838">4838</td><td class="line">    <span class='keyword'>else</span> mode = <span class='string_literal'>"standalone"</span>;</td></tr>
<tr class="codeline" data-linenumber="4839"><td class="num" id="LN4839">4839</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4840"><td class="num" id="LN4840">4840</td><td class="line">    <span class='comment'>/* Show the ASCII logo if: log file is stdout AND stdout is a</span></td></tr>
<tr class="codeline" data-linenumber="4841"><td class="num" id="LN4841">4841</td><td class="line">     <span class='comment'>* tty AND syslog logging is disabled. Also show logo if the user</span></td></tr>
<tr class="codeline" data-linenumber="4842"><td class="num" id="LN4842">4842</td><td class="line">     <span class='comment'>* forced us to do so via redis.conf. */</span></td></tr>
<tr class="codeline" data-linenumber="4843"><td class="num" id="LN4843">4843</td><td class="line">    <span class='keyword'>int</span> show_logo = ((!server.syslog_enabled &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="4844"><td class="num" id="LN4844">4844</td><td class="line">                      server.logfile[0] == '\0' &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="4845"><td class="num" id="LN4845">4845</td><td class="line">                      isatty(fileno(<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>))) ||</td></tr>
<tr class="codeline" data-linenumber="4846"><td class="num" id="LN4846">4846</td><td class="line">                     server.always_show_logo);</td></tr>
<tr class="codeline" data-linenumber="4847"><td class="num" id="LN4847">4847</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4848"><td class="num" id="LN4848">4848</td><td class="line">    <span class='keyword'>if</span> (!show_logo) {</td></tr>
<tr class="codeline" data-linenumber="4849"><td class="num" id="LN4849">4849</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4850"><td class="num" id="LN4850">4850</td><td class="line">            <span class='string_literal'>"Running mode=%s, port=%d."</span>,</td></tr>
<tr class="codeline" data-linenumber="4851"><td class="num" id="LN4851">4851</td><td class="line">            mode, server.port ? server.port : server.tls_port</td></tr>
<tr class="codeline" data-linenumber="4852"><td class="num" id="LN4852">4852</td><td class="line">        );</td></tr>
<tr class="codeline" data-linenumber="4853"><td class="num" id="LN4853">4853</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="4854"><td class="num" id="LN4854">4854</td><td class="line">        snprintf(buf,1024*16,ascii_logo,</td></tr>
<tr class="codeline" data-linenumber="4855"><td class="num" id="LN4855">4855</td><td class="line">            <span class='macro'>REDIS_VERSION<span class='macro_popup'>"6.0.9"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4856"><td class="num" id="LN4856">4856</td><td class="line">            redisGitSHA1(),</td></tr>
<tr class="codeline" data-linenumber="4857"><td class="num" id="LN4857">4857</td><td class="line">            strtol(redisGitDirty(),<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,10) &gt; 0,</td></tr>
<tr class="codeline" data-linenumber="4858"><td class="num" id="LN4858">4858</td><td class="line">            (<span class='keyword'>sizeof</span>(<span class='keyword'>long</span>) == 8) ? <span class='string_literal'>"64"</span> : <span class='string_literal'>"32"</span>,</td></tr>
<tr class="codeline" data-linenumber="4859"><td class="num" id="LN4859">4859</td><td class="line">            mode, server.port ? server.port : server.tls_port,</td></tr>
<tr class="codeline" data-linenumber="4860"><td class="num" id="LN4860">4860</td><td class="line">            (<span class='keyword'>long</span>) getpid()</td></tr>
<tr class="codeline" data-linenumber="4861"><td class="num" id="LN4861">4861</td><td class="line">        );</td></tr>
<tr class="codeline" data-linenumber="4862"><td class="num" id="LN4862">4862</td><td class="line">        serverLogRaw(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>|<span class='macro'>LL_RAW<span class='macro_popup'>(1&lt;&lt;10)</span></span>,buf);</td></tr>
<tr class="codeline" data-linenumber="4863"><td class="num" id="LN4863">4863</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4864"><td class="num" id="LN4864">4864</td><td class="line">    zfree(buf);</td></tr>
<tr class="codeline" data-linenumber="4865"><td class="num" id="LN4865">4865</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4866"><td class="num" id="LN4866">4866</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4867"><td class="num" id="LN4867">4867</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> sigShutdownHandler(<span class='keyword'>int</span> sig) {</td></tr>
<tr class="codeline" data-linenumber="4868"><td class="num" id="LN4868">4868</td><td class="line">    <span class='keyword'>char</span> *msg;</td></tr>
<tr class="codeline" data-linenumber="4869"><td class="num" id="LN4869">4869</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4870"><td class="num" id="LN4870">4870</td><td class="line">    <span class='keyword'>switch</span> (sig) {</td></tr>
<tr class="codeline" data-linenumber="4871"><td class="num" id="LN4871">4871</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>SIGINT<span class='macro_popup'>2</span></span>:</td></tr>
<tr class="codeline" data-linenumber="4872"><td class="num" id="LN4872">4872</td><td class="line">        msg = <span class='string_literal'>"Received SIGINT scheduling shutdown..."</span>;</td></tr>
<tr class="codeline" data-linenumber="4873"><td class="num" id="LN4873">4873</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4874"><td class="num" id="LN4874">4874</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>SIGTERM<span class='macro_popup'>15</span></span>:</td></tr>
<tr class="codeline" data-linenumber="4875"><td class="num" id="LN4875">4875</td><td class="line">        msg = <span class='string_literal'>"Received SIGTERM scheduling shutdown..."</span>;</td></tr>
<tr class="codeline" data-linenumber="4876"><td class="num" id="LN4876">4876</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="4877"><td class="num" id="LN4877">4877</td><td class="line">    <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="4878"><td class="num" id="LN4878">4878</td><td class="line">        msg = <span class='string_literal'>"Received shutdown signal, scheduling shutdown..."</span>;</td></tr>
<tr class="codeline" data-linenumber="4879"><td class="num" id="LN4879">4879</td><td class="line">    };</td></tr>
<tr class="codeline" data-linenumber="4880"><td class="num" id="LN4880">4880</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4881"><td class="num" id="LN4881">4881</td><td class="line">    <span class='comment'>/* SIGINT is often delivered via Ctrl+C in an interactive session.</span></td></tr>
<tr class="codeline" data-linenumber="4882"><td class="num" id="LN4882">4882</td><td class="line">     <span class='comment'>* If we receive the signal the second time, we interpret this as</span></td></tr>
<tr class="codeline" data-linenumber="4883"><td class="num" id="LN4883">4883</td><td class="line">     <span class='comment'>* the user really wanting to quit ASAP without waiting to persist</span></td></tr>
<tr class="codeline" data-linenumber="4884"><td class="num" id="LN4884">4884</td><td class="line">     <span class='comment'>* on disk. */</span></td></tr>
<tr class="codeline" data-linenumber="4885"><td class="num" id="LN4885">4885</td><td class="line">    <span class='keyword'>if</span> (server.shutdown_asap &amp;&amp; sig == <span class='macro'>SIGINT<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="4886"><td class="num" id="LN4886">4886</td><td class="line">        serverLogFromHandler(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>, <span class='string_literal'>"You insist... exiting now."</span>);</td></tr>
<tr class="codeline" data-linenumber="4887"><td class="num" id="LN4887">4887</td><td class="line">        rdbRemoveTempFile(getpid(), 1);</td></tr>
<tr class="codeline" data-linenumber="4888"><td class="num" id="LN4888">4888</td><td class="line">        exit(1); <span class='comment'>/* Exit with an error since this was not a clean shutdown. */</span></td></tr>
<tr class="codeline" data-linenumber="4889"><td class="num" id="LN4889">4889</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (server.loading) {</td></tr>
<tr class="codeline" data-linenumber="4890"><td class="num" id="LN4890">4890</td><td class="line">        serverLogFromHandler(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>, <span class='string_literal'>"Received shutdown signal during loading, exiting now."</span>);</td></tr>
<tr class="codeline" data-linenumber="4891"><td class="num" id="LN4891">4891</td><td class="line">        exit(0);</td></tr>
<tr class="codeline" data-linenumber="4892"><td class="num" id="LN4892">4892</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4893"><td class="num" id="LN4893">4893</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4894"><td class="num" id="LN4894">4894</td><td class="line">    serverLogFromHandler(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>, msg);</td></tr>
<tr class="codeline" data-linenumber="4895"><td class="num" id="LN4895">4895</td><td class="line">    server.shutdown_asap = 1;</td></tr>
<tr class="codeline" data-linenumber="4896"><td class="num" id="LN4896">4896</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4897"><td class="num" id="LN4897">4897</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4898"><td class="num" id="LN4898">4898</td><td class="line"><span class='keyword'>void</span> setupSignalHandlers(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="4899"><td class="num" id="LN4899">4899</td><td class="line">    <span class='keyword'>struct</span> sigaction act;</td></tr>
<tr class="codeline" data-linenumber="4900"><td class="num" id="LN4900">4900</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4901"><td class="num" id="LN4901">4901</td><td class="line">    <span class='comment'>/* When the SA_SIGINFO flag is set in sa_flags then sa_sigaction is used.</span></td></tr>
<tr class="codeline" data-linenumber="4902"><td class="num" id="LN4902">4902</td><td class="line">     <span class='comment'>* Otherwise, sa_handler is used. */</span></td></tr>
<tr class="codeline" data-linenumber="4903"><td class="num" id="LN4903">4903</td><td class="line">    sigemptyset(&amp;act.sa_mask);</td></tr>
<tr class="codeline" data-linenumber="4904"><td class="num" id="LN4904">4904</td><td class="line">    act.sa_flags = 0;</td></tr>
<tr class="codeline" data-linenumber="4905"><td class="num" id="LN4905">4905</td><td class="line">    act.<span class='macro'>sa_handler<span class='macro_popup'>__sigaction_handler.sa_handler</span></span> = sigShutdownHandler;</td></tr>
<tr class="codeline" data-linenumber="4906"><td class="num" id="LN4906">4906</td><td class="line">    sigaction(<span class='macro'>SIGTERM<span class='macro_popup'>15</span></span>, &amp;act, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4907"><td class="num" id="LN4907">4907</td><td class="line">    sigaction(<span class='macro'>SIGINT<span class='macro_popup'>2</span></span>, &amp;act, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4908"><td class="num" id="LN4908">4908</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4909"><td class="num" id="LN4909">4909</td><td class="line"><span class='directive'>#ifdef <span class='macro'>HAVE_BACKTRACE<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="4910"><td class="num" id="LN4910">4910</td><td class="line">    sigemptyset(&amp;act.sa_mask);</td></tr>
<tr class="codeline" data-linenumber="4911"><td class="num" id="LN4911">4911</td><td class="line">    act.sa_flags = <span class='macro'>SA_NODEFER<span class='macro_popup'>0x40000000</span></span> | <span class='macro'>SA_RESETHAND<span class='macro_popup'>0x80000000</span></span> | <span class='macro'>SA_SIGINFO<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4912"><td class="num" id="LN4912">4912</td><td class="line">    act.<span class='macro'>sa_sigaction<span class='macro_popup'>__sigaction_handler.sa_sigaction</span></span> = sigsegvHandler;</td></tr>
<tr class="codeline" data-linenumber="4913"><td class="num" id="LN4913">4913</td><td class="line">    sigaction(<span class='macro'>SIGSEGV<span class='macro_popup'>11</span></span>, &amp;act, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4914"><td class="num" id="LN4914">4914</td><td class="line">    sigaction(<span class='macro'>SIGBUS<span class='macro_popup'>7</span></span>, &amp;act, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4915"><td class="num" id="LN4915">4915</td><td class="line">    sigaction(<span class='macro'>SIGFPE<span class='macro_popup'>8</span></span>, &amp;act, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4916"><td class="num" id="LN4916">4916</td><td class="line">    sigaction(<span class='macro'>SIGILL<span class='macro_popup'>4</span></span>, &amp;act, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4917"><td class="num" id="LN4917">4917</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="4918"><td class="num" id="LN4918">4918</td><td class="line">    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="4919"><td class="num" id="LN4919">4919</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4920"><td class="num" id="LN4920">4920</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4921"><td class="num" id="LN4921">4921</td><td class="line"><span class='comment'>/* This is the signal handler for children process. It is currently useful</span></td></tr>
<tr class="codeline" data-linenumber="4922"><td class="num" id="LN4922">4922</td><td class="line"> <span class='comment'>* in order to track the SIGUSR1, that we send to a child in order to terminate</span></td></tr>
<tr class="codeline" data-linenumber="4923"><td class="num" id="LN4923">4923</td><td class="line"> <span class='comment'>* it in a clean way, without the parent detecting an error and stop</span></td></tr>
<tr class="codeline" data-linenumber="4924"><td class="num" id="LN4924">4924</td><td class="line"> <span class='comment'>* accepting writes because of a write error condition. */</span></td></tr>
<tr class="codeline" data-linenumber="4925"><td class="num" id="LN4925">4925</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> sigKillChildHandler(<span class='keyword'>int</span> sig) {</td></tr>
<tr class="codeline" data-linenumber="4926"><td class="num" id="LN4926">4926</td><td class="line">    <span class='macro'>UNUSED(sig)<span class='macro_popup'>((void) sig)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4927"><td class="num" id="LN4927">4927</td><td class="line">    <span class='keyword'>int</span> level = server.in_fork_child == <span class='macro'>CHILD_TYPE_MODULE<span class='macro_popup'>4</span></span>? <span class='macro'>LL_VERBOSE<span class='macro_popup'>1</span></span>: <span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4928"><td class="num" id="LN4928">4928</td><td class="line">    serverLogFromHandler(level, <span class='string_literal'>"Received SIGUSR1 in child, exiting now."</span>);</td></tr>
<tr class="codeline" data-linenumber="4929"><td class="num" id="LN4929">4929</td><td class="line">    exitFromChild(<span class='macro'>SERVER_CHILD_NOERROR_RETVAL<span class='macro_popup'>255</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4930"><td class="num" id="LN4930">4930</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4931"><td class="num" id="LN4931">4931</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4932"><td class="num" id="LN4932">4932</td><td class="line"><span class='keyword'>void</span> setupChildSignalHandlers(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="4933"><td class="num" id="LN4933">4933</td><td class="line">    <span class='keyword'>struct</span> sigaction act;</td></tr>
<tr class="codeline" data-linenumber="4934"><td class="num" id="LN4934">4934</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4935"><td class="num" id="LN4935">4935</td><td class="line">    <span class='comment'>/* When the SA_SIGINFO flag is set in sa_flags then sa_sigaction is used.</span></td></tr>
<tr class="codeline" data-linenumber="4936"><td class="num" id="LN4936">4936</td><td class="line">     <span class='comment'>* Otherwise, sa_handler is used. */</span></td></tr>
<tr class="codeline" data-linenumber="4937"><td class="num" id="LN4937">4937</td><td class="line">    sigemptyset(&amp;act.sa_mask);</td></tr>
<tr class="codeline" data-linenumber="4938"><td class="num" id="LN4938">4938</td><td class="line">    act.sa_flags = 0;</td></tr>
<tr class="codeline" data-linenumber="4939"><td class="num" id="LN4939">4939</td><td class="line">    act.<span class='macro'>sa_handler<span class='macro_popup'>__sigaction_handler.sa_handler</span></span> = sigKillChildHandler;</td></tr>
<tr class="codeline" data-linenumber="4940"><td class="num" id="LN4940">4940</td><td class="line">    sigaction(<span class='macro'>SIGUSR1<span class='macro_popup'>10</span></span>, &amp;act, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4941"><td class="num" id="LN4941">4941</td><td class="line">    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="4942"><td class="num" id="LN4942">4942</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4943"><td class="num" id="LN4943">4943</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4944"><td class="num" id="LN4944">4944</td><td class="line"><span class='comment'>/* After fork, the child process will inherit the resources</span></td></tr>
<tr class="codeline" data-linenumber="4945"><td class="num" id="LN4945">4945</td><td class="line"> <span class='comment'>* of the parent process, e.g. fd(socket or flock) etc.</span></td></tr>
<tr class="codeline" data-linenumber="4946"><td class="num" id="LN4946">4946</td><td class="line"> <span class='comment'>* should close the resources not used by the child process, so that if the</span></td></tr>
<tr class="codeline" data-linenumber="4947"><td class="num" id="LN4947">4947</td><td class="line"> <span class='comment'>* parent restarts it can bind/lock despite the child possibly still running. */</span></td></tr>
<tr class="codeline" data-linenumber="4948"><td class="num" id="LN4948">4948</td><td class="line"><span class='keyword'>void</span> closeClildUnusedResourceAfterFork() {</td></tr>
<tr class="codeline" data-linenumber="4949"><td class="num" id="LN4949">4949</td><td class="line">    closeListeningSockets(0);</td></tr>
<tr class="codeline" data-linenumber="4950"><td class="num" id="LN4950">4950</td><td class="line">    <span class='keyword'>if</span> (server.cluster_enabled &amp;&amp; server.cluster_config_file_lock_fd != -1)</td></tr>
<tr class="codeline" data-linenumber="4951"><td class="num" id="LN4951">4951</td><td class="line">        close(server.cluster_config_file_lock_fd);  <span class='comment'>/* don't care if this fails */</span></td></tr>
<tr class="codeline" data-linenumber="4952"><td class="num" id="LN4952">4952</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4953"><td class="num" id="LN4953">4953</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4954"><td class="num" id="LN4954">4954</td><td class="line"><span class='comment'>/* purpose is one of CHILD_TYPE_ types */</span></td></tr>
<tr class="codeline" data-linenumber="4955"><td class="num" id="LN4955">4955</td><td class="line"><span class='keyword'>int</span> redisFork(<span class='keyword'>int</span> purpose) {</td></tr>
<tr class="codeline" data-linenumber="4956"><td class="num" id="LN4956">4956</td><td class="line">    <span class='keyword'>int</span> childpid;</td></tr>
<tr class="codeline" data-linenumber="4957"><td class="num" id="LN4957">4957</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> start = ustime();</td></tr>
<tr class="codeline" data-linenumber="4958"><td class="num" id="LN4958">4958</td><td class="line">    <span class='keyword'>if</span> ((childpid = fork()) == 0) {</td></tr>
<tr class="codeline" data-linenumber="4959"><td class="num" id="LN4959">4959</td><td class="line">        <span class='comment'>/* Child */</span></td></tr>
<tr class="codeline" data-linenumber="4960"><td class="num" id="LN4960">4960</td><td class="line">        server.in_fork_child = purpose;</td></tr>
<tr class="codeline" data-linenumber="4961"><td class="num" id="LN4961">4961</td><td class="line">        setOOMScoreAdj(<span class='macro'>CONFIG_OOM_BGCHILD<span class='macro_popup'>2</span></span>);</td></tr>
<tr class="codeline" data-linenumber="4962"><td class="num" id="LN4962">4962</td><td class="line">        setupChildSignalHandlers();</td></tr>
<tr class="codeline" data-linenumber="4963"><td class="num" id="LN4963">4963</td><td class="line">        closeClildUnusedResourceAfterFork();</td></tr>
<tr class="codeline" data-linenumber="4964"><td class="num" id="LN4964">4964</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="4965"><td class="num" id="LN4965">4965</td><td class="line">        <span class='comment'>/* Parent */</span></td></tr>
<tr class="codeline" data-linenumber="4966"><td class="num" id="LN4966">4966</td><td class="line">        server.stat_fork_time = ustime()-start;</td></tr>
<tr class="codeline" data-linenumber="4967"><td class="num" id="LN4967">4967</td><td class="line">        server.stat_fork_rate = (<span class='keyword'>double</span>) zmalloc_used_memory() * 1000000 / server.stat_fork_time / (1024*1024*1024); <span class='comment'>/* GB per second. */</span></td></tr>
<tr class="codeline" data-linenumber="4968"><td class="num" id="LN4968">4968</td><td class="line">        <span class='macro'>latencyAddSampleIfNeeded(<span class='string_literal'>"fork"</span>,server.stat_fork_time/1000)<span class='macro_popup'>if (server.latency_monitor_threshold &amp;&amp; (server.stat_fork_time<br>/1000) &gt;= server.latency_monitor_threshold) latencyAddSample<br>(("fork"),(server.stat_fork_time/1000));</span></span>;</td></tr>
<tr class="codeline" data-linenumber="4969"><td class="num" id="LN4969">4969</td><td class="line">        <span class='keyword'>if</span> (childpid == -1) {</td></tr>
<tr class="codeline" data-linenumber="4970"><td class="num" id="LN4970">4970</td><td class="line">            <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="4971"><td class="num" id="LN4971">4971</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="4972"><td class="num" id="LN4972">4972</td><td class="line">        updateDictResizePolicy();</td></tr>
<tr class="codeline" data-linenumber="4973"><td class="num" id="LN4973">4973</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4974"><td class="num" id="LN4974">4974</td><td class="line">    <span class='keyword'>return</span> childpid;</td></tr>
<tr class="codeline" data-linenumber="4975"><td class="num" id="LN4975">4975</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4976"><td class="num" id="LN4976">4976</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4977"><td class="num" id="LN4977">4977</td><td class="line"><span class='keyword'>void</span> sendChildCOWInfo(<span class='keyword'>int</span> ptype, <span class='keyword'>char</span> *pname) {</td></tr>
<tr class="codeline" data-linenumber="4978"><td class="num" id="LN4978">4978</td><td class="line">    size_t private_dirty = zmalloc_get_private_dirty(-1);</td></tr>
<tr class="codeline" data-linenumber="4979"><td class="num" id="LN4979">4979</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4980"><td class="num" id="LN4980">4980</td><td class="line">    <span class='keyword'>if</span> (private_dirty) {</td></tr>
<tr class="codeline" data-linenumber="4981"><td class="num" id="LN4981">4981</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="4982"><td class="num" id="LN4982">4982</td><td class="line">            <span class='string_literal'>"%s: %zu MB of memory used by copy-on-write"</span>,</td></tr>
<tr class="codeline" data-linenumber="4983"><td class="num" id="LN4983">4983</td><td class="line">            pname, private_dirty/(1024*1024));</td></tr>
<tr class="codeline" data-linenumber="4984"><td class="num" id="LN4984">4984</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="4985"><td class="num" id="LN4985">4985</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4986"><td class="num" id="LN4986">4986</td><td class="line">    server.child_info_data.cow_size = private_dirty;</td></tr>
<tr class="codeline" data-linenumber="4987"><td class="num" id="LN4987">4987</td><td class="line">    sendChildInfo(ptype);</td></tr>
<tr class="codeline" data-linenumber="4988"><td class="num" id="LN4988">4988</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="4989"><td class="num" id="LN4989">4989</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4990"><td class="num" id="LN4990">4990</td><td class="line"><span class='keyword'>void</span> memtest(size_t megabytes, <span class='keyword'>int</span> passes);</td></tr>
<tr class="codeline" data-linenumber="4991"><td class="num" id="LN4991">4991</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4992"><td class="num" id="LN4992">4992</td><td class="line"><span class='comment'>/* Returns 1 if there is --sentinel among the arguments or if</span></td></tr>
<tr class="codeline" data-linenumber="4993"><td class="num" id="LN4993">4993</td><td class="line"> <span class='comment'>* argv[0] contains "redis-sentinel". */</span></td></tr>
<tr class="codeline" data-linenumber="4994"><td class="num" id="LN4994">4994</td><td class="line"><span class='keyword'>int</span> checkForSentinelMode(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="4995"><td class="num" id="LN4995">4995</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="4996"><td class="num" id="LN4996">4996</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="4997"><td class="num" id="LN4997">4997</td><td class="line">    <span class='keyword'>if</span> (strstr(argv[0],<span class='string_literal'>"redis-sentinel"</span>) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="4998"><td class="num" id="LN4998">4998</td><td class="line">    <span class='keyword'>for</span> (j = 1; j &lt; argc; j++)</td></tr>
<tr class="codeline" data-linenumber="4999"><td class="num" id="LN4999">4999</td><td class="line">        <span class='keyword'>if</span> (!strcmp(argv[j],<span class='string_literal'>"--sentinel"</span>)) <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="5000"><td class="num" id="LN5000">5000</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="5001"><td class="num" id="LN5001">5001</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5002"><td class="num" id="LN5002">5002</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5003"><td class="num" id="LN5003">5003</td><td class="line"><span class='comment'>/* Function called at startup to load RDB or AOF file in memory. */</span></td></tr>
<tr class="codeline" data-linenumber="5004"><td class="num" id="LN5004">5004</td><td class="line"><span class='keyword'>void</span> loadDataFromDisk(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="5005"><td class="num" id="LN5005">5005</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> start = ustime();</td></tr>
<tr class="codeline" data-linenumber="5006"><td class="num" id="LN5006">5006</td><td class="line">    <span class='keyword'>if</span> (server.aof_state == <span class='macro'>AOF_ON<span class='macro_popup'>1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5007"><td class="num" id="LN5007">5007</td><td class="line">        <span class='keyword'>if</span> (loadAppendOnlyFile(server.aof_filename) == <span class='macro'>C_OK<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5008"><td class="num" id="LN5008">5008</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"DB loaded from append only file: %.3f seconds"</span>,(<span class='keyword'>float</span>)(ustime()-start)/1000000);</td></tr>
<tr class="codeline" data-linenumber="5009"><td class="num" id="LN5009">5009</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="5010"><td class="num" id="LN5010">5010</td><td class="line">        rdbSaveInfo rsi = <span class='macro'>RDB_SAVE_INFO_INIT<span class='macro_popup'>{-1,0,"000000000000000000000000000000",-1}</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5011"><td class="num" id="LN5011">5011</td><td class="line">        <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> = 0; <span class='comment'>/* Prevent a stale value from affecting error checking */</span></td></tr>
<tr class="codeline" data-linenumber="5012"><td class="num" id="LN5012">5012</td><td class="line">        <span class='keyword'>if</span> (rdbLoad(server.rdb_filename,&amp;rsi,<span class='macro'>RDBFLAGS_NONE<span class='macro_popup'>0</span></span>) == <span class='macro'>C_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5013"><td class="num" id="LN5013">5013</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"DB loaded from disk: %.3f seconds"</span>,</td></tr>
<tr class="codeline" data-linenumber="5014"><td class="num" id="LN5014">5014</td><td class="line">                (<span class='keyword'>float</span>)(ustime()-start)/1000000);</td></tr>
<tr class="codeline" data-linenumber="5015"><td class="num" id="LN5015">5015</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5016"><td class="num" id="LN5016">5016</td><td class="line">            <span class='comment'>/* Restore the replication ID / offset from the RDB file. */</span></td></tr>
<tr class="codeline" data-linenumber="5017"><td class="num" id="LN5017">5017</td><td class="line">            <span class='keyword'>if</span> ((server.masterhost ||</td></tr>
<tr class="codeline" data-linenumber="5018"><td class="num" id="LN5018">5018</td><td class="line">                (server.cluster_enabled &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="5019"><td class="num" id="LN5019">5019</td><td class="line">                <span class='macro'>nodeIsSlave(server.cluster-&gt;myself)<span class='macro_popup'>((server.cluster-&gt;myself)-&gt;flags &amp; 2)</span></span>)) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="5020"><td class="num" id="LN5020">5020</td><td class="line">                rsi.repl_id_is_set &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="5021"><td class="num" id="LN5021">5021</td><td class="line">                rsi.repl_offset != -1 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="5022"><td class="num" id="LN5022">5022</td><td class="line">                <span class='comment'>/* Note that older implementations may save a repl_stream_db</span></td></tr>
<tr class="codeline" data-linenumber="5023"><td class="num" id="LN5023">5023</td><td class="line">                 <span class='comment'>* of -1 inside the RDB file in a wrong way, see more</span></td></tr>
<tr class="codeline" data-linenumber="5024"><td class="num" id="LN5024">5024</td><td class="line">                 <span class='comment'>* information in function rdbPopulateSaveInfo. */</span></td></tr>
<tr class="codeline" data-linenumber="5025"><td class="num" id="LN5025">5025</td><td class="line">                rsi.repl_stream_db != -1)</td></tr>
<tr class="codeline" data-linenumber="5026"><td class="num" id="LN5026">5026</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="5027"><td class="num" id="LN5027">5027</td><td class="line">                memcpy(server.replid,rsi.repl_id,<span class='keyword'>sizeof</span>(server.replid));</td></tr>
<tr class="codeline" data-linenumber="5028"><td class="num" id="LN5028">5028</td><td class="line">                server.master_repl_offset = rsi.repl_offset;</td></tr>
<tr class="codeline" data-linenumber="5029"><td class="num" id="LN5029">5029</td><td class="line">                <span class='comment'>/* If we are a slave, create a cached master from this</span></td></tr>
<tr class="codeline" data-linenumber="5030"><td class="num" id="LN5030">5030</td><td class="line">                 <span class='comment'>* information, in order to allow partial resynchronizations</span></td></tr>
<tr class="codeline" data-linenumber="5031"><td class="num" id="LN5031">5031</td><td class="line">                 <span class='comment'>* with masters. */</span></td></tr>
<tr class="codeline" data-linenumber="5032"><td class="num" id="LN5032">5032</td><td class="line">                replicationCacheMasterUsingMyself();</td></tr>
<tr class="codeline" data-linenumber="5033"><td class="num" id="LN5033">5033</td><td class="line">                selectDb(server.cached_master,rsi.repl_stream_db);</td></tr>
<tr class="codeline" data-linenumber="5034"><td class="num" id="LN5034">5034</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5035"><td class="num" id="LN5035">5035</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> != <span class='macro'>ENOENT<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5036"><td class="num" id="LN5036">5036</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Fatal error loading the DB: %s. Exiting."</span>,strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="5037"><td class="num" id="LN5037">5037</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="5038"><td class="num" id="LN5038">5038</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5039"><td class="num" id="LN5039">5039</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5040"><td class="num" id="LN5040">5040</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5041"><td class="num" id="LN5041">5041</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5042"><td class="num" id="LN5042">5042</td><td class="line"><span class='keyword'>void</span> redisOutOfMemoryHandler(size_t allocation_size) {</td></tr>
<tr class="codeline" data-linenumber="5043"><td class="num" id="LN5043">5043</td><td class="line">    serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Out Of Memory allocating %zu bytes!"</span>,</td></tr>
<tr class="codeline" data-linenumber="5044"><td class="num" id="LN5044">5044</td><td class="line">        allocation_size);</td></tr>
<tr class="codeline" data-linenumber="5045"><td class="num" id="LN5045">5045</td><td class="line">    <span class='macro'>serverPanic(<span class='string_literal'>"Redis aborting for OUT OF MEMORY. Allocating %zu bytes!"</span>,<span class='macro_popup'>_serverPanic("server.c",5046,"Redis aborting for OUT OF MEMORY. Allocating %zu bytes!"<br>, allocation_size),_exit(1)</span></span> </td></tr>
<tr class="codeline" data-linenumber="5046"><td class="num" id="LN5046">5046</td><td class="line">        <span class='macro'>allocation_size)<span class='macro_popup'>_serverPanic("server.c",5046,"Redis aborting for OUT OF MEMORY. Allocating %zu bytes!"<br>, allocation_size),_exit(1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5047"><td class="num" id="LN5047">5047</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5048"><td class="num" id="LN5048">5048</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5049"><td class="num" id="LN5049">5049</td><td class="line"><span class='keyword'>void</span> redisSetProcTitle(<span class='keyword'>char</span> *title) {</td></tr>
<tr class="codeline" data-linenumber="5050"><td class="num" id="LN5050">5050</td><td class="line"><span class='directive'>#ifdef USE_SETPROCTITLE</span></td></tr>
<tr class="codeline" data-linenumber="5051"><td class="num" id="LN5051">5051</td><td class="line">    <span class='keyword'>char</span> *server_mode = <span class='string_literal'>""</span>;</td></tr>
<tr class="codeline" data-linenumber="5052"><td class="num" id="LN5052">5052</td><td class="line">    <span class='keyword'>if</span> (server.cluster_enabled) server_mode = <span class='string_literal'>" [cluster]"</span>;</td></tr>
<tr class="codeline" data-linenumber="5053"><td class="num" id="LN5053">5053</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (server.sentinel_mode) server_mode = <span class='string_literal'>" [sentinel]"</span>;</td></tr>
<tr class="codeline" data-linenumber="5054"><td class="num" id="LN5054">5054</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5055"><td class="num" id="LN5055">5055</td><td class="line">    setproctitle(<span class='string_literal'>"%s %s:%d%s"</span>,</td></tr>
<tr class="codeline" data-linenumber="5056"><td class="num" id="LN5056">5056</td><td class="line">        title,</td></tr>
<tr class="codeline" data-linenumber="5057"><td class="num" id="LN5057">5057</td><td class="line">        server.bindaddr_count ? server.bindaddr[0] : <span class='string_literal'>"*"</span>,</td></tr>
<tr class="codeline" data-linenumber="5058"><td class="num" id="LN5058">5058</td><td class="line">        server.port ? server.port : server.tls_port,</td></tr>
<tr class="codeline" data-linenumber="5059"><td class="num" id="LN5059">5059</td><td class="line">        server_mode);</td></tr>
<tr class="codeline" data-linenumber="5060"><td class="num" id="LN5060">5060</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="5061"><td class="num" id="LN5061">5061</td><td class="line">    <span class='macro'>UNUSED(title)<span class='macro_popup'>((void) title)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5062"><td class="num" id="LN5062">5062</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="5063"><td class="num" id="LN5063">5063</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5064"><td class="num" id="LN5064">5064</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5065"><td class="num" id="LN5065">5065</td><td class="line"><span class='keyword'>void</span> redisSetCpuAffinity(<span class='keyword'>const</span> <span class='keyword'>char</span> *cpulist) {</td></tr>
<tr class="codeline" data-linenumber="5066"><td class="num" id="LN5066">5066</td><td class="line"><span class='directive'>#ifdef USE_SETCPUAFFINITY</span></td></tr>
<tr class="codeline" data-linenumber="5067"><td class="num" id="LN5067">5067</td><td class="line">    setcpuaffinity(cpulist);</td></tr>
<tr class="codeline" data-linenumber="5068"><td class="num" id="LN5068">5068</td><td class="line"><span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="5069"><td class="num" id="LN5069">5069</td><td class="line">    <span class='macro'>UNUSED(cpulist)<span class='macro_popup'>((void) cpulist)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5070"><td class="num" id="LN5070">5070</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="5071"><td class="num" id="LN5071">5071</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5072"><td class="num" id="LN5072">5072</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5073"><td class="num" id="LN5073">5073</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="5074"><td class="num" id="LN5074">5074</td><td class="line"> <span class='comment'>* Check whether systemd or upstart have been used to start redis.</span></td></tr>
<tr class="codeline" data-linenumber="5075"><td class="num" id="LN5075">5075</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="5076"><td class="num" id="LN5076">5076</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5077"><td class="num" id="LN5077">5077</td><td class="line"><span class='keyword'>int</span> redisSupervisedUpstart(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="5078"><td class="num" id="LN5078">5078</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span> *upstart_job = getenv(<span class='string_literal'>"UPSTART_JOB"</span>);</td></tr>
<tr class="codeline" data-linenumber="5079"><td class="num" id="LN5079">5079</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5080"><td class="num" id="LN5080">5080</td><td class="line">    <span class='keyword'>if</span> (!upstart_job) {</td></tr>
<tr class="codeline" data-linenumber="5081"><td class="num" id="LN5081">5081</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="5082"><td class="num" id="LN5082">5082</td><td class="line">                <span class='string_literal'>"upstart supervision requested, but UPSTART_JOB not found"</span>);</td></tr>
<tr class="codeline" data-linenumber="5083"><td class="num" id="LN5083">5083</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="5084"><td class="num" id="LN5084">5084</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5085"><td class="num" id="LN5085">5085</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5086"><td class="num" id="LN5086">5086</td><td class="line">    serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>, <span class='string_literal'>"supervised by upstart, will stop to signal readiness"</span>);</td></tr>
<tr class="codeline" data-linenumber="5087"><td class="num" id="LN5087">5087</td><td class="line">    raise(<span class='macro'>SIGSTOP<span class='macro_popup'>19</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5088"><td class="num" id="LN5088">5088</td><td class="line">    unsetenv(<span class='string_literal'>"UPSTART_JOB"</span>);</td></tr>
<tr class="codeline" data-linenumber="5089"><td class="num" id="LN5089">5089</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="5090"><td class="num" id="LN5090">5090</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5091"><td class="num" id="LN5091">5091</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5092"><td class="num" id="LN5092">5092</td><td class="line"><span class='keyword'>int</span> redisCommunicateSystemd(<span class='keyword'>const</span> <span class='keyword'>char</span> *sd_notify_msg) {</td></tr>
<tr class="codeline" data-linenumber="5093"><td class="num" id="LN5093">5093</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>char</span> *notify_socket = getenv(<span class='string_literal'>"NOTIFY_SOCKET"</span>);</td></tr>
<tr class="codeline" data-linenumber="5094"><td class="num" id="LN5094">5094</td><td class="line">    <span class='keyword'>if</span> (!notify_socket) {</td></tr>
<tr class="codeline" data-linenumber="5095"><td class="num" id="LN5095">5095</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="5096"><td class="num" id="LN5096">5096</td><td class="line">                <span class='string_literal'>"systemd supervision requested, but NOTIFY_SOCKET not found"</span>);</td></tr>
<tr class="codeline" data-linenumber="5097"><td class="num" id="LN5097">5097</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5098"><td class="num" id="LN5098">5098</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5099"><td class="num" id="LN5099">5099</td><td class="line">    <span class='directive'>#ifdef HAVE_LIBSYSTEMD</span></td></tr>
<tr class="codeline" data-linenumber="5100"><td class="num" id="LN5100">5100</td><td class="line">    (<span class='keyword'>void</span>) sd_notify(0, sd_notify_msg);</td></tr>
<tr class="codeline" data-linenumber="5101"><td class="num" id="LN5101">5101</td><td class="line">    <span class='directive'>#else</span></td></tr>
<tr class="codeline" data-linenumber="5102"><td class="num" id="LN5102">5102</td><td class="line">    <span class='macro'>UNUSED(sd_notify_msg)<span class='macro_popup'>((void) sd_notify_msg)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5103"><td class="num" id="LN5103">5103</td><td class="line">    <span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="5104"><td class="num" id="LN5104">5104</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="5105"><td class="num" id="LN5105">5105</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5106"><td class="num" id="LN5106">5106</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5107"><td class="num" id="LN5107">5107</td><td class="line"><span class='keyword'>int</span> redisIsSupervised(<span class='keyword'>int</span> mode) {</td></tr>
<tr class="codeline" data-linenumber="5108"><td class="num" id="LN5108">5108</td><td class="line">    <span class='keyword'>if</span> (mode == <span class='macro'>SUPERVISED_AUTODETECT<span class='macro_popup'>1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5109"><td class="num" id="LN5109">5109</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>char</span> *upstart_job = getenv(<span class='string_literal'>"UPSTART_JOB"</span>);</td></tr>
<tr class="codeline" data-linenumber="5110"><td class="num" id="LN5110">5110</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>char</span> *notify_socket = getenv(<span class='string_literal'>"NOTIFY_SOCKET"</span>);</td></tr>
<tr class="codeline" data-linenumber="5111"><td class="num" id="LN5111">5111</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5112"><td class="num" id="LN5112">5112</td><td class="line">        <span class='keyword'>if</span> (upstart_job) {</td></tr>
<tr class="codeline" data-linenumber="5113"><td class="num" id="LN5113">5113</td><td class="line">            redisSupervisedUpstart();</td></tr>
<tr class="codeline" data-linenumber="5114"><td class="num" id="LN5114">5114</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (notify_socket) {</td></tr>
<tr class="codeline" data-linenumber="5115"><td class="num" id="LN5115">5115</td><td class="line">            server.supervised_mode = <span class='macro'>SUPERVISED_SYSTEMD<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5116"><td class="num" id="LN5116">5116</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="5117"><td class="num" id="LN5117">5117</td><td class="line">                <span class='string_literal'>"WARNING auto-supervised by systemd - you MUST set appropriate values for TimeoutStartSec and TimeoutStopSec in your service unit."</span>);</td></tr>
<tr class="codeline" data-linenumber="5118"><td class="num" id="LN5118">5118</td><td class="line">            <span class='keyword'>return</span> redisCommunicateSystemd(<span class='string_literal'>"STATUS=Redis is loading...\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="5119"><td class="num" id="LN5119">5119</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5120"><td class="num" id="LN5120">5120</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (mode == <span class='macro'>SUPERVISED_UPSTART<span class='macro_popup'>3</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5121"><td class="num" id="LN5121">5121</td><td class="line">        <span class='keyword'>return</span> redisSupervisedUpstart();</td></tr>
<tr class="codeline" data-linenumber="5122"><td class="num" id="LN5122">5122</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (mode == <span class='macro'>SUPERVISED_SYSTEMD<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5123"><td class="num" id="LN5123">5123</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="5124"><td class="num" id="LN5124">5124</td><td class="line">            <span class='string_literal'>"WARNING supervised by systemd - you MUST set appropriate values for TimeoutStartSec and TimeoutStopSec in your service unit."</span>);</td></tr>
<tr class="codeline" data-linenumber="5125"><td class="num" id="LN5125">5125</td><td class="line">        <span class='keyword'>return</span> redisCommunicateSystemd(<span class='string_literal'>"STATUS=Redis is loading...\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="5126"><td class="num" id="LN5126">5126</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5127"><td class="num" id="LN5127">5127</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5128"><td class="num" id="LN5128">5128</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="5129"><td class="num" id="LN5129">5129</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5130"><td class="num" id="LN5130">5130</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5131"><td class="num" id="LN5131">5131</td><td class="line"><span class='keyword'>int</span> iAmMaster(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="5132"><td class="num" id="LN5132">5132</td><td class="line">    <span class='keyword'>return</span> ((!server.cluster_enabled &amp;&amp; server.masterhost == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) ||</td></tr>
<tr class="codeline" data-linenumber="5133"><td class="num" id="LN5133">5133</td><td class="line">            (server.cluster_enabled &amp;&amp; <span class='macro'>nodeIsMaster(server.cluster-&gt;myself)<span class='macro_popup'>((server.cluster-&gt;myself)-&gt;flags &amp; 1)</span></span>));</td></tr>
<tr class="codeline" data-linenumber="5134"><td class="num" id="LN5134">5134</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5135"><td class="num" id="LN5135">5135</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5136"><td class="num" id="LN5136">5136</td><td class="line"><span class='keyword'>int</span> main(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="5137"><td class="num" id="LN5137">5137</td><td class="line">    <span class='keyword'>struct</span> timeval tv;</td></tr>
<tr class="codeline" data-linenumber="5138"><td class="num" id="LN5138">5138</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="5139"><td class="num" id="LN5139">5139</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5140"><td class="num" id="LN5140">5140</td><td class="line"><span class='directive'>#ifdef REDIS_TEST</span></td></tr>
<tr class="codeline" data-linenumber="5141"><td class="num" id="LN5141">5141</td><td class="line">    <span class='keyword'>if</span> (argc == 3 &amp;&amp; !strcasecmp(argv[1], <span class='string_literal'>"test"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="5142"><td class="num" id="LN5142">5142</td><td class="line">        <span class='keyword'>if</span> (!strcasecmp(argv[2], <span class='string_literal'>"ziplist"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="5143"><td class="num" id="LN5143">5143</td><td class="line">            <span class='keyword'>return</span> ziplistTest(argc, argv);</td></tr>
<tr class="codeline" data-linenumber="5144"><td class="num" id="LN5144">5144</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(argv[2], <span class='string_literal'>"quicklist"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="5145"><td class="num" id="LN5145">5145</td><td class="line">            quicklistTest(argc, argv);</td></tr>
<tr class="codeline" data-linenumber="5146"><td class="num" id="LN5146">5146</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(argv[2], <span class='string_literal'>"intset"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="5147"><td class="num" id="LN5147">5147</td><td class="line">            <span class='keyword'>return</span> intsetTest(argc, argv);</td></tr>
<tr class="codeline" data-linenumber="5148"><td class="num" id="LN5148">5148</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(argv[2], <span class='string_literal'>"zipmap"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="5149"><td class="num" id="LN5149">5149</td><td class="line">            <span class='keyword'>return</span> zipmapTest(argc, argv);</td></tr>
<tr class="codeline" data-linenumber="5150"><td class="num" id="LN5150">5150</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(argv[2], <span class='string_literal'>"sha1test"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="5151"><td class="num" id="LN5151">5151</td><td class="line">            <span class='keyword'>return</span> sha1Test(argc, argv);</td></tr>
<tr class="codeline" data-linenumber="5152"><td class="num" id="LN5152">5152</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(argv[2], <span class='string_literal'>"util"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="5153"><td class="num" id="LN5153">5153</td><td class="line">            <span class='keyword'>return</span> utilTest(argc, argv);</td></tr>
<tr class="codeline" data-linenumber="5154"><td class="num" id="LN5154">5154</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(argv[2], <span class='string_literal'>"endianconv"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="5155"><td class="num" id="LN5155">5155</td><td class="line">            <span class='keyword'>return</span> endianconvTest(argc, argv);</td></tr>
<tr class="codeline" data-linenumber="5156"><td class="num" id="LN5156">5156</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(argv[2], <span class='string_literal'>"crc64"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="5157"><td class="num" id="LN5157">5157</td><td class="line">            <span class='keyword'>return</span> crc64Test(argc, argv);</td></tr>
<tr class="codeline" data-linenumber="5158"><td class="num" id="LN5158">5158</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(argv[2], <span class='string_literal'>"zmalloc"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="5159"><td class="num" id="LN5159">5159</td><td class="line">            <span class='keyword'>return</span> zmalloc_test(argc, argv);</td></tr>
<tr class="codeline" data-linenumber="5160"><td class="num" id="LN5160">5160</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5161"><td class="num" id="LN5161">5161</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5162"><td class="num" id="LN5162">5162</td><td class="line">        <span class='keyword'>return</span> -1; <span class='comment'>/* test not found */</span></td></tr>
<tr class="codeline" data-linenumber="5163"><td class="num" id="LN5163">5163</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5164"><td class="num" id="LN5164">5164</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="5165"><td class="num" id="LN5165">5165</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5166"><td class="num" id="LN5166">5166</td><td class="line">    <span class='comment'>/* We need to initialize our libraries, and the server configuration. */</span></td></tr>
<tr class="codeline" data-linenumber="5167"><td class="num" id="LN5167">5167</td><td class="line"><span class='directive'>#ifdef INIT_SETPROCTITLE_REPLACEMENT</span></td></tr>
<tr class="codeline" data-linenumber="5168"><td class="num" id="LN5168">5168</td><td class="line">    spt_init(argc, argv);</td></tr>
<tr class="codeline" data-linenumber="5169"><td class="num" id="LN5169">5169</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="5170"><td class="num" id="LN5170">5170</td><td class="line">    setlocale(<span class='macro'>LC_COLLATE<span class='macro_popup'>3</span></span>,<span class='string_literal'>""</span>);</td></tr>
<tr class="codeline" data-linenumber="5171"><td class="num" id="LN5171">5171</td><td class="line">    tzset(); <span class='comment'>/* Populates 'timezone' global. */</span></td></tr>
<tr class="codeline" data-linenumber="5172"><td class="num" id="LN5172">5172</td><td class="line">    zmalloc_set_oom_handler(redisOutOfMemoryHandler);</td></tr>
<tr class="codeline" data-linenumber="5173"><td class="num" id="LN5173">5173</td><td class="line">    srand(time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)^getpid());</td></tr>
<tr class="codeline" data-linenumber="5174"><td class="num" id="LN5174">5174</td><td class="line">    gettimeofday(&amp;tv,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5175"><td class="num" id="LN5175">5175</td><td class="line">    crc64_init();</td></tr>
<tr class="codeline" data-linenumber="5176"><td class="num" id="LN5176">5176</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5177"><td class="num" id="LN5177">5177</td><td class="line">    uint8_t hashseed[16];</td></tr>
<tr class="codeline" data-linenumber="5178"><td class="num" id="LN5178">5178</td><td class="line">    getRandomBytes(hashseed,<span class='keyword'>sizeof</span>(hashseed));</td></tr>
<tr class="codeline" data-linenumber="5179"><td class="num" id="LN5179">5179</td><td class="line">    dictSetHashFunctionSeed(hashseed);</td></tr>
<tr class="codeline" data-linenumber="5180"><td class="num" id="LN5180">5180</td><td class="line">    server.sentinel_mode = checkForSentinelMode(argc,argv);</td></tr>
<tr class="codeline" data-linenumber="5181"><td class="num" id="LN5181">5181</td><td class="line">    initServerConfig();</td></tr>
<tr class="codeline" data-linenumber="5182"><td class="num" id="LN5182">5182</td><td class="line">    ACLInit(); <span class='comment'>/* The ACL subsystem must be initialized ASAP because the</span></td></tr>
<tr class="codeline" data-linenumber="5183"><td class="num" id="LN5183">5183</td><td class="line">                  <span class='comment'>basic networking code and client creation depends on it. */</span></td></tr>
<tr class="codeline" data-linenumber="5184"><td class="num" id="LN5184">5184</td><td class="line">    moduleInitModulesSystem();</td></tr>
<tr class="codeline" data-linenumber="5185"><td class="num" id="LN5185">5185</td><td class="line">    tlsInit();</td></tr>
<tr class="codeline" data-linenumber="5186"><td class="num" id="LN5186">5186</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5187"><td class="num" id="LN5187">5187</td><td class="line">    <span class='comment'>/* Store the executable path and arguments in a safe place in order</span></td></tr>
<tr class="codeline" data-linenumber="5188"><td class="num" id="LN5188">5188</td><td class="line">     <span class='comment'>* to be able to restart the server later. */</span></td></tr>
<tr class="codeline" data-linenumber="5189"><td class="num" id="LN5189">5189</td><td class="line">    server.executable = getAbsolutePath(argv[0]);</td></tr>
<tr class="codeline" data-linenumber="5190"><td class="num" id="LN5190">5190</td><td class="line">    server.exec_argv = zmalloc(<span class='keyword'>sizeof</span>(<span class='keyword'>char</span>*)*(argc+1));</td></tr>
<tr class="codeline" data-linenumber="5191"><td class="num" id="LN5191">5191</td><td class="line">    server.exec_argv[argc] = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5192"><td class="num" id="LN5192">5192</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; argc; j++) server.exec_argv[j] = zstrdup(argv[j]);</td></tr>
<tr class="codeline" data-linenumber="5193"><td class="num" id="LN5193">5193</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5194"><td class="num" id="LN5194">5194</td><td class="line">    <span class='comment'>/* We need to init sentinel right now as parsing the configuration file</span></td></tr>
<tr class="codeline" data-linenumber="5195"><td class="num" id="LN5195">5195</td><td class="line">     <span class='comment'>* in sentinel mode will have the effect of populating the sentinel</span></td></tr>
<tr class="codeline" data-linenumber="5196"><td class="num" id="LN5196">5196</td><td class="line">     <span class='comment'>* data structures with master nodes to monitor. */</span></td></tr>
<tr class="codeline" data-linenumber="5197"><td class="num" id="LN5197">5197</td><td class="line">    <span class='keyword'>if</span> (server.sentinel_mode) {</td></tr>
<tr class="codeline" data-linenumber="5198"><td class="num" id="LN5198">5198</td><td class="line">        initSentinelConfig();</td></tr>
<tr class="codeline" data-linenumber="5199"><td class="num" id="LN5199">5199</td><td class="line">        initSentinel();</td></tr>
<tr class="codeline" data-linenumber="5200"><td class="num" id="LN5200">5200</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5201"><td class="num" id="LN5201">5201</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5202"><td class="num" id="LN5202">5202</td><td class="line">    <span class='comment'>/* Check if we need to start in redis-check-rdb/aof mode. We just execute</span></td></tr>
<tr class="codeline" data-linenumber="5203"><td class="num" id="LN5203">5203</td><td class="line">     <span class='comment'>* the program main. However the program is part of the Redis executable</span></td></tr>
<tr class="codeline" data-linenumber="5204"><td class="num" id="LN5204">5204</td><td class="line">     <span class='comment'>* so that we can easily execute an RDB check on loading errors. */</span></td></tr>
<tr class="codeline" data-linenumber="5205"><td class="num" id="LN5205">5205</td><td class="line">    <span class='keyword'>if</span> (strstr(argv[0],<span class='string_literal'>"redis-check-rdb"</span>) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5206"><td class="num" id="LN5206">5206</td><td class="line">        redis_check_rdb_main(argc,argv,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="5207"><td class="num" id="LN5207">5207</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (strstr(argv[0],<span class='string_literal'>"redis-check-aof"</span>) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="5208"><td class="num" id="LN5208">5208</td><td class="line">        redis_check_aof_main(argc,argv);</td></tr>
<tr class="codeline" data-linenumber="5209"><td class="num" id="LN5209">5209</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5210"><td class="num" id="LN5210">5210</td><td class="line">    <span class='keyword'>if</span> (argc &gt;= 2) {</td></tr>
<tr class="codeline" data-linenumber="5211"><td class="num" id="LN5211">5211</td><td class="line">        j = 1; <span class='comment'>/* First option to parse in argv[] */</span></td></tr>
<tr class="codeline" data-linenumber="5212"><td class="num" id="LN5212">5212</td><td class="line">        sds options = sdsempty();</td></tr>
<tr class="codeline" data-linenumber="5213"><td class="num" id="LN5213">5213</td><td class="line">        <span class='keyword'>char</span> *configfile = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="5214"><td class="num" id="LN5214">5214</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5215"><td class="num" id="LN5215">5215</td><td class="line">        <span class='comment'>/* Handle special options --help and --version */</span></td></tr>
<tr class="codeline" data-linenumber="5216"><td class="num" id="LN5216">5216</td><td class="line">        <span class='keyword'>if</span> (strcmp(argv[1], <span class='string_literal'>"-v"</span>) == 0 ||</td></tr>
<tr class="codeline" data-linenumber="5217"><td class="num" id="LN5217">5217</td><td class="line">            strcmp(argv[1], <span class='string_literal'>"--version"</span>) == 0) version();</td></tr>
<tr class="codeline" data-linenumber="5218"><td class="num" id="LN5218">5218</td><td class="line">        <span class='keyword'>if</span> (strcmp(argv[1], <span class='string_literal'>"--help"</span>) == 0 ||</td></tr>
<tr class="codeline" data-linenumber="5219"><td class="num" id="LN5219">5219</td><td class="line">            strcmp(argv[1], <span class='string_literal'>"-h"</span>) == 0) usage();</td></tr>
<tr class="codeline" data-linenumber="5220"><td class="num" id="LN5220">5220</td><td class="line">        <span class='keyword'>if</span> (strcmp(argv[1], <span class='string_literal'>"--test-memory"</span>) == 0) {</td></tr>
<tr class="codeline" data-linenumber="5221"><td class="num" id="LN5221">5221</td><td class="line">            <span class='keyword'>if</span> (argc == 3) {</td></tr>
<tr class="codeline" data-linenumber="5222"><td class="num" id="LN5222">5222</td><td class="line">                memtest(atoi(argv[2]),50);</td></tr>
<tr class="codeline" data-linenumber="5223"><td class="num" id="LN5223">5223</td><td class="line">                exit(0);</td></tr>
<tr class="codeline" data-linenumber="5224"><td class="num" id="LN5224">5224</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="5225"><td class="num" id="LN5225">5225</td><td class="line">                fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Please specify the amount of memory to test in megabytes.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="5226"><td class="num" id="LN5226">5226</td><td class="line">                fprintf(<span class='macro'>stderr<span class='macro_popup'>stderr</span></span>,<span class='string_literal'>"Example: ./redis-server --test-memory 4096\n\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="5227"><td class="num" id="LN5227">5227</td><td class="line">                exit(1);</td></tr>
<tr class="codeline" data-linenumber="5228"><td class="num" id="LN5228">5228</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5229"><td class="num" id="LN5229">5229</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5230"><td class="num" id="LN5230">5230</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5231"><td class="num" id="LN5231">5231</td><td class="line">        <span class='comment'>/* First argument is the config file name? */</span></td></tr>
<tr class="codeline" data-linenumber="5232"><td class="num" id="LN5232">5232</td><td class="line">        <span class='keyword'>if</span> (argv[j][0] != '-' || argv[j][1] != '-') {</td></tr>
<tr class="codeline" data-linenumber="5233"><td class="num" id="LN5233">5233</td><td class="line">            configfile = argv[j];</td></tr>
<tr class="codeline" data-linenumber="5234"><td class="num" id="LN5234">5234</td><td class="line">            server.configfile = getAbsolutePath(configfile);</td></tr>
<tr class="codeline" data-linenumber="5235"><td class="num" id="LN5235">5235</td><td class="line">            <span class='comment'>/* Replace the config file in server.exec_argv with</span></td></tr>
<tr class="codeline" data-linenumber="5236"><td class="num" id="LN5236">5236</td><td class="line">             <span class='comment'>* its absolute path. */</span></td></tr>
<tr class="codeline" data-linenumber="5237"><td class="num" id="LN5237">5237</td><td class="line">            zfree(server.exec_argv[j]);</td></tr>
<tr class="codeline" data-linenumber="5238"><td class="num" id="LN5238">5238</td><td class="line">            server.exec_argv[j] = zstrdup(server.configfile);</td></tr>
<tr class="codeline" data-linenumber="5239"><td class="num" id="LN5239">5239</td><td class="line">            j++;</td></tr>
<tr class="codeline" data-linenumber="5240"><td class="num" id="LN5240">5240</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5241"><td class="num" id="LN5241">5241</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5242"><td class="num" id="LN5242">5242</td><td class="line">        <span class='comment'>/* All the other options are parsed and conceptually appended to the</span></td></tr>
<tr class="codeline" data-linenumber="5243"><td class="num" id="LN5243">5243</td><td class="line">         <span class='comment'>* configuration file. For instance --port 6380 will generate the</span></td></tr>
<tr class="codeline" data-linenumber="5244"><td class="num" id="LN5244">5244</td><td class="line">         <span class='comment'>* string "port 6380\n" to be parsed after the actual file name</span></td></tr>
<tr class="codeline" data-linenumber="5245"><td class="num" id="LN5245">5245</td><td class="line">         <span class='comment'>* is parsed, if any. */</span></td></tr>
<tr class="codeline" data-linenumber="5246"><td class="num" id="LN5246">5246</td><td class="line">        <span class='keyword'>while</span>(j != argc) {</td></tr>
<tr class="codeline" data-linenumber="5247"><td class="num" id="LN5247">5247</td><td class="line">            <span class='keyword'>if</span> (argv[j][0] == '-' &amp;&amp; argv[j][1] == '-') {</td></tr>
<tr class="codeline" data-linenumber="5248"><td class="num" id="LN5248">5248</td><td class="line">                <span class='comment'>/* Option name */</span></td></tr>
<tr class="codeline" data-linenumber="5249"><td class="num" id="LN5249">5249</td><td class="line">                <span class='keyword'>if</span> (!strcmp(argv[j], <span class='string_literal'>"--check-rdb"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="5250"><td class="num" id="LN5250">5250</td><td class="line">                    <span class='comment'>/* Argument has no options, need to skip for parsing. */</span></td></tr>
<tr class="codeline" data-linenumber="5251"><td class="num" id="LN5251">5251</td><td class="line">                    j++;</td></tr>
<tr class="codeline" data-linenumber="5252"><td class="num" id="LN5252">5252</td><td class="line">                    <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="5253"><td class="num" id="LN5253">5253</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="5254"><td class="num" id="LN5254">5254</td><td class="line">                <span class='keyword'>if</span> (sdslen(options)) options = sdscat(options,<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="5255"><td class="num" id="LN5255">5255</td><td class="line">                options = sdscat(options,argv[j]+2);</td></tr>
<tr class="codeline" data-linenumber="5256"><td class="num" id="LN5256">5256</td><td class="line">                options = sdscat(options,<span class='string_literal'>" "</span>);</td></tr>
<tr class="codeline" data-linenumber="5257"><td class="num" id="LN5257">5257</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="5258"><td class="num" id="LN5258">5258</td><td class="line">                <span class='comment'>/* Option argument */</span></td></tr>
<tr class="codeline" data-linenumber="5259"><td class="num" id="LN5259">5259</td><td class="line">                options = sdscatrepr(options,argv[j],strlen(argv[j]));</td></tr>
<tr class="codeline" data-linenumber="5260"><td class="num" id="LN5260">5260</td><td class="line">                options = sdscat(options,<span class='string_literal'>" "</span>);</td></tr>
<tr class="codeline" data-linenumber="5261"><td class="num" id="LN5261">5261</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5262"><td class="num" id="LN5262">5262</td><td class="line">            j++;</td></tr>
<tr class="codeline" data-linenumber="5263"><td class="num" id="LN5263">5263</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5264"><td class="num" id="LN5264">5264</td><td class="line">        <span class='keyword'>if</span> (server.sentinel_mode &amp;&amp; configfile &amp;&amp; *configfile == '-') {</td></tr>
<tr class="codeline" data-linenumber="5265"><td class="num" id="LN5265">5265</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="5266"><td class="num" id="LN5266">5266</td><td class="line">                <span class='string_literal'>"Sentinel config from STDIN not allowed."</span>);</td></tr>
<tr class="codeline" data-linenumber="5267"><td class="num" id="LN5267">5267</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="5268"><td class="num" id="LN5268">5268</td><td class="line">                <span class='string_literal'>"Sentinel needs config file on disk to save state.  Exiting..."</span>);</td></tr>
<tr class="codeline" data-linenumber="5269"><td class="num" id="LN5269">5269</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="5270"><td class="num" id="LN5270">5270</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5271"><td class="num" id="LN5271">5271</td><td class="line">        resetServerSaveParams();</td></tr>
<tr class="codeline" data-linenumber="5272"><td class="num" id="LN5272">5272</td><td class="line">        loadServerConfig(configfile,options);</td></tr>
<tr class="codeline" data-linenumber="5273"><td class="num" id="LN5273">5273</td><td class="line">        sdsfree(options);</td></tr>
<tr class="codeline" data-linenumber="5274"><td class="num" id="LN5274">5274</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5275"><td class="num" id="LN5275">5275</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5276"><td class="num" id="LN5276">5276</td><td class="line">    server.supervised = redisIsSupervised(server.supervised_mode);</td></tr>
<tr class="codeline" data-linenumber="5277"><td class="num" id="LN5277">5277</td><td class="line">    <span class='keyword'>int</span> background = server.daemonize &amp;&amp; !server.supervised;</td></tr>
<tr class="codeline" data-linenumber="5278"><td class="num" id="LN5278">5278</td><td class="line">    <span class='keyword'>if</span> (background) daemonize();</td></tr>
<tr class="codeline" data-linenumber="5279"><td class="num" id="LN5279">5279</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5280"><td class="num" id="LN5280">5280</td><td class="line">    serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>, <span class='string_literal'>"oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo"</span>);</td></tr>
<tr class="codeline" data-linenumber="5281"><td class="num" id="LN5281">5281</td><td class="line">    serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="5282"><td class="num" id="LN5282">5282</td><td class="line">        <span class='string_literal'>"Redis version=%s, bits=%d, commit=%s, modified=%d, pid=%d, just started"</span>,</td></tr>
<tr class="codeline" data-linenumber="5283"><td class="num" id="LN5283">5283</td><td class="line">            <span class='macro'>REDIS_VERSION<span class='macro_popup'>"6.0.9"</span></span>,</td></tr>
<tr class="codeline" data-linenumber="5284"><td class="num" id="LN5284">5284</td><td class="line">            (<span class='keyword'>sizeof</span>(<span class='keyword'>long</span>) == 8) ? 64 : 32,</td></tr>
<tr class="codeline" data-linenumber="5285"><td class="num" id="LN5285">5285</td><td class="line">            redisGitSHA1(),</td></tr>
<tr class="codeline" data-linenumber="5286"><td class="num" id="LN5286">5286</td><td class="line">            strtol(redisGitDirty(),<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,10) &gt; 0,</td></tr>
<tr class="codeline" data-linenumber="5287"><td class="num" id="LN5287">5287</td><td class="line">            (<span class='keyword'>int</span>)getpid());</td></tr>
<tr class="codeline" data-linenumber="5288"><td class="num" id="LN5288">5288</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5289"><td class="num" id="LN5289">5289</td><td class="line">    <span class='keyword'>if</span> (argc == 1) {</td></tr>
<tr class="codeline" data-linenumber="5290"><td class="num" id="LN5290">5290</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>, <span class='string_literal'>"Warning: no config file specified, using the default config. In order to specify a config file use %s /path/to/%s.conf"</span>, argv[0], server.sentinel_mode ? <span class='string_literal'>"sentinel"</span> : <span class='string_literal'>"redis"</span>);</td></tr>
<tr class="codeline" data-linenumber="5291"><td class="num" id="LN5291">5291</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="5292"><td class="num" id="LN5292">5292</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>, <span class='string_literal'>"Configuration loaded"</span>);</td></tr>
<tr class="codeline" data-linenumber="5293"><td class="num" id="LN5293">5293</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5294"><td class="num" id="LN5294">5294</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5295"><td class="num" id="LN5295">5295</td><td class="line">    readOOMScoreAdj();</td></tr>
<tr class="codeline" data-linenumber="5296"><td class="num" id="LN5296">5296</td><td class="line">    initServer();</td></tr>
<tr class="codeline" data-linenumber="5297"><td class="num" id="LN5297">5297</td><td class="line">    <span class='keyword'>if</span> (background || server.pidfile) createPidFile();</td></tr>
<tr class="codeline" data-linenumber="5298"><td class="num" id="LN5298">5298</td><td class="line">    redisSetProcTitle(argv[0]);</td></tr>
<tr class="codeline" data-linenumber="5299"><td class="num" id="LN5299">5299</td><td class="line">    redisAsciiArt();</td></tr>
<tr class="codeline" data-linenumber="5300"><td class="num" id="LN5300">5300</td><td class="line">    checkTcpBacklogSettings();</td></tr>
<tr class="codeline" data-linenumber="5301"><td class="num" id="LN5301">5301</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5302"><td class="num" id="LN5302">5302</td><td class="line">    <span class='keyword'>if</span> (!server.sentinel_mode) {</td></tr>
<tr class="codeline" data-linenumber="5303"><td class="num" id="LN5303">5303</td><td class="line">        <span class='comment'>/* Things not needed when running in Sentinel mode. */</span></td></tr>
<tr class="codeline" data-linenumber="5304"><td class="num" id="LN5304">5304</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Server initialized"</span>);</td></tr>
<tr class="codeline" data-linenumber="5305"><td class="num" id="LN5305">5305</td><td class="line">    <span class='directive'>#ifdef <span class='macro'>__linux__<span class='macro_popup'>1</span></span></span></td></tr>
<tr class="codeline" data-linenumber="5306"><td class="num" id="LN5306">5306</td><td class="line">        linuxMemoryWarnings();</td></tr>
<tr class="codeline" data-linenumber="5307"><td class="num" id="LN5307">5307</td><td class="line">    <span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="5308"><td class="num" id="LN5308">5308</td><td class="line">        moduleLoadFromQueue();</td></tr>
<tr class="codeline" data-linenumber="5309"><td class="num" id="LN5309">5309</td><td class="line">        ACLLoadUsersAtStartup();</td></tr>
<tr class="codeline" data-linenumber="5310"><td class="num" id="LN5310">5310</td><td class="line">        InitServerLast();</td></tr>
<tr class="codeline" data-linenumber="5311"><td class="num" id="LN5311">5311</td><td class="line">        loadDataFromDisk();</td></tr>
<tr class="codeline" data-linenumber="5312"><td class="num" id="LN5312">5312</td><td class="line">        <span class='keyword'>if</span> (server.cluster_enabled) {</td></tr>
<tr class="codeline" data-linenumber="5313"><td class="num" id="LN5313">5313</td><td class="line">            <span class='keyword'>if</span> (verifyClusterConfigWithData() == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5314"><td class="num" id="LN5314">5314</td><td class="line">                serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="5315"><td class="num" id="LN5315">5315</td><td class="line">                    <span class='string_literal'>"You can't have keys in a DB different than DB 0 when in "</span></td></tr>
<tr class="codeline" data-linenumber="5316"><td class="num" id="LN5316">5316</td><td class="line">                    <span class='string_literal'>"Cluster mode. Exiting."</span>);</td></tr>
<tr class="codeline" data-linenumber="5317"><td class="num" id="LN5317">5317</td><td class="line">                exit(1);</td></tr>
<tr class="codeline" data-linenumber="5318"><td class="num" id="LN5318">5318</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5319"><td class="num" id="LN5319">5319</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5320"><td class="num" id="LN5320">5320</td><td class="line">        <span class='keyword'>if</span> (server.ipfd_count &gt; 0 || server.tlsfd_count &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="5321"><td class="num" id="LN5321">5321</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Ready to accept connections"</span>);</td></tr>
<tr class="codeline" data-linenumber="5322"><td class="num" id="LN5322">5322</td><td class="line">        <span class='keyword'>if</span> (server.sofd &gt; 0)</td></tr>
<tr class="codeline" data-linenumber="5323"><td class="num" id="LN5323">5323</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"The server is now ready to accept connections at %s"</span>, server.unixsocket);</td></tr>
<tr class="codeline" data-linenumber="5324"><td class="num" id="LN5324">5324</td><td class="line">        <span class='keyword'>if</span> (server.supervised_mode == <span class='macro'>SUPERVISED_SYSTEMD<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5325"><td class="num" id="LN5325">5325</td><td class="line">            <span class='keyword'>if</span> (!server.masterhost) {</td></tr>
<tr class="codeline" data-linenumber="5326"><td class="num" id="LN5326">5326</td><td class="line">                redisCommunicateSystemd(<span class='string_literal'>"STATUS=Ready to accept connections\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="5327"><td class="num" id="LN5327">5327</td><td class="line">                redisCommunicateSystemd(<span class='string_literal'>"READY=1\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="5328"><td class="num" id="LN5328">5328</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="5329"><td class="num" id="LN5329">5329</td><td class="line">                redisCommunicateSystemd(<span class='string_literal'>"STATUS=Waiting for MASTER &lt;-&gt; REPLICA sync\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="5330"><td class="num" id="LN5330">5330</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="5331"><td class="num" id="LN5331">5331</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5332"><td class="num" id="LN5332">5332</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="5333"><td class="num" id="LN5333">5333</td><td class="line">        InitServerLast();</td></tr>
<tr class="codeline" data-linenumber="5334"><td class="num" id="LN5334">5334</td><td class="line">        sentinelIsRunning();</td></tr>
<tr class="codeline" data-linenumber="5335"><td class="num" id="LN5335">5335</td><td class="line">        <span class='keyword'>if</span> (server.supervised_mode == <span class='macro'>SUPERVISED_SYSTEMD<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="5336"><td class="num" id="LN5336">5336</td><td class="line">            redisCommunicateSystemd(<span class='string_literal'>"STATUS=Ready to accept connections\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="5337"><td class="num" id="LN5337">5337</td><td class="line">            redisCommunicateSystemd(<span class='string_literal'>"READY=1\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="5338"><td class="num" id="LN5338">5338</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="5339"><td class="num" id="LN5339">5339</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5340"><td class="num" id="LN5340">5340</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5341"><td class="num" id="LN5341">5341</td><td class="line">    <span class='comment'>/* Warning the user about suspicious maxmemory setting. */</span></td></tr>
<tr class="codeline" data-linenumber="5342"><td class="num" id="LN5342">5342</td><td class="line">    <span class='keyword'>if</span> (server.maxmemory &gt; 0 &amp;&amp; server.maxmemory &lt; 1024*1024) {</td></tr>
<tr class="codeline" data-linenumber="5343"><td class="num" id="LN5343">5343</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"WARNING: You specified a maxmemory value that is less than 1MB (current value is %llu bytes). Are you sure this is what you really want?"</span>, server.maxmemory);</td></tr>
<tr class="codeline" data-linenumber="5344"><td class="num" id="LN5344">5344</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="5345"><td class="num" id="LN5345">5345</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5346"><td class="num" id="LN5346">5346</td><td class="line">    redisSetCpuAffinity(server.server_cpulist);</td></tr>
<tr class="codeline" data-linenumber="5347"><td class="num" id="LN5347">5347</td><td class="line">    setOOMScoreAdj(-1);</td></tr>
<tr class="codeline" data-linenumber="5348"><td class="num" id="LN5348">5348</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5349"><td class="num" id="LN5349">5349</td><td class="line">    aeMain(server.el);</td></tr>
<tr class="codeline" data-linenumber="5350"><td class="num" id="LN5350">5350</td><td class="line">    aeDeleteEventLoop(server.el);</td></tr>
<tr class="codeline" data-linenumber="5351"><td class="num" id="LN5351">5351</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="5352"><td class="num" id="LN5352">5352</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="5353"><td class="num" id="LN5353">5353</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="5354"><td class="num" id="LN5354">5354</td><td class="line"><span class='comment'>/* The End */</span></td></tr>
</table></body></html>
