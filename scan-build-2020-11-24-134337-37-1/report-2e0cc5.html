<!doctype html>
<html>
<head>
<title>aof.c</title>

<style type="text/css">
body { color:#000000; background-color:#ffffff }
body { font-family:Helvetica, sans-serif; font-size:10pt }
h1 { font-size:14pt }
.FileName { margin-top: 5px; margin-bottom: 5px; display: inline; }
.FileNav { margin-left: 5px; margin-right: 5px; display: inline; }
.FileNav a { text-decoration:none; font-size: larger; }
.divider { margin-top: 30px; margin-bottom: 30px; height: 15px; }
.divider { background-color: gray; }
.code { border-collapse:collapse; width:100%; }
.code { font-family: "Monospace", monospace; font-size:10pt }
.code { line-height: 1.2em }
.comment { color: green; font-style: oblique }
.keyword { color: blue }
.string_literal { color: red }
.directive { color: darkmagenta }

/* Macros and variables could have pop-up notes hidden by default.
  - Macro pop-up:    expansion of the macro
  - Variable pop-up: value (table) of the variable */
.macro_popup, .variable_popup { display: none; }

/* Pop-up appears on mouse-hover event. */
.macro:hover .macro_popup, .variable:hover .variable_popup {
  display: block;
  padding: 2px;
  -webkit-border-radius:5px;
  -webkit-box-shadow:1px 1px 7px #000;
  border-radius:5px;
  box-shadow:1px 1px 7px #000;
  position: absolute;
  top: -1em;
  left:10em;
  z-index: 1
}

.macro_popup {
  border: 2px solid red;
  background-color:#FFF0F0;
  font-weight: normal;
}

.variable_popup {
  border: 2px solid blue;
  background-color:#F0F0FF;
  font-weight: bold;
  font-family: Helvetica, sans-serif;
  font-size: 9pt;
}

/* Pop-up notes needs a relative position as a base where they pops up. */
.macro, .variable {
  background-color: PaleGoldenRod;
  position: relative;
}
.macro { color: DarkMagenta; }

#tooltiphint {
  position: fixed;
  width: 50em;
  margin-left: -25em;
  left: 50%;
  padding: 10px;
  border: 1px solid #b0b0b0;
  border-radius: 2px;
  box-shadow: 1px 1px 7px black;
  background-color: #c0c0c0;
  z-index: 2;
}

.num { width:2.5em; padding-right:2ex; background-color:#eeeeee }
.num { text-align:right; font-size:8pt }
.num { color:#444444 }
.line { padding-left: 1ex; border-left: 3px solid #ccc }
.line { white-space: pre }
.msg { -webkit-box-shadow:1px 1px 7px #000 }
.msg { box-shadow:1px 1px 7px #000 }
.msg { -webkit-border-radius:5px }
.msg { border-radius:5px }
.msg { font-family:Helvetica, sans-serif; font-size:8pt }
.msg { float:left }
.msg { padding:0.25em 1ex 0.25em 1ex }
.msg { margin-top:10px; margin-bottom:10px }
.msg { font-weight:bold }
.msg { max-width:60em; word-wrap: break-word; white-space: pre-wrap }
.msgT { padding:0x; spacing:0x }
.msgEvent { background-color:#fff8b4; color:#000000 }
.msgControl { background-color:#bbbbbb; color:#000000 }
.msgNote { background-color:#ddeeff; color:#000000 }
.mrange { background-color:#dfddf3 }
.mrange { border-bottom:1px solid #6F9DBE }
.PathIndex { font-weight: bold; padding:0px 5px; margin-right:5px; }
.PathIndex { -webkit-border-radius:8px }
.PathIndex { border-radius:8px }
.PathIndexEvent { background-color:#bfba87 }
.PathIndexControl { background-color:#8c8c8c }
.PathIndexPopUp { background-color: #879abc; }
.PathNav a { text-decoration:none; font-size: larger }
.CodeInsertionHint { font-weight: bold; background-color: #10dd10 }
.CodeRemovalHint { background-color:#de1010 }
.CodeRemovalHint { border-bottom:1px solid #6F9DBE }
.selected{ background-color:orange !important; }

table.simpletable {
  padding: 5px;
  font-size:12pt;
  margin:20px;
  border-collapse: collapse; border-spacing: 0px;
}
td.rowname {
  text-align: right;
  vertical-align: top;
  font-weight: bold;
  color:#444444;
  padding-right:2ex;
}

/* Hidden text. */
input.spoilerhider + label {
  cursor: pointer;
  text-decoration: underline;
  display: block;
}
input.spoilerhider {
 display: none;
}
input.spoilerhider ~ .spoiler {
  overflow: hidden;
  margin: 10px auto 0;
  height: 0;
  opacity: 0;
}
input.spoilerhider:checked + label + .spoiler{
  height: auto;
  opacity: 1;
}
</style>
</head>
<body>
<!-- BUGDESC Call to function 'snprintf' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'snprintf_s' in case of C11 -->

<!-- BUGTYPE Potential insecure memory buffer bounds restriction in call 'snprintf' -->

<!-- BUGCATEGORY Security -->

<!-- BUGFILE /tmp/sslab_clang/c_redis/redis/src/aof.c -->

<!-- FILENAME aof.c -->

<!-- FUNCTIONNAME aofRemoveTempFile -->

<!-- ISSUEHASHCONTENTOFLINEINCONTEXT 674c8f008f4d41315c9a122a68ee3276 -->

<!-- BUGLINE 1683 -->

<!-- BUGCOLUMN 5 -->

<!-- BUGPATHLENGTH 1 -->

<!-- BUGMETAEND -->
<!-- REPORTHEADER -->
<h3>Bug Summary</h3>
<table class="simpletable">
<tr><td class="rowname">File:</td><td>src/aof.c</td></tr>
<tr><td class="rowname">Warning:</td><td><a href="#EndPath">line 1683, column 5</a><br />Call to function 'snprintf' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'snprintf_s' in case of C11</td></tr>

</table>
<!-- REPORTSUMMARYEXTRA -->
<h3>Annotated Source Code</h3>
<p>Press <a href="#" onclick="toggleHelp(); return false;">'?'</a>
   to see keyboard shortcuts</p>
<input type="checkbox" class="spoilerhider" id="showinvocation" />
<label for="showinvocation" >Show analyzer invocation</label>
<div class="spoiler">clang -cc1 -cc1 -triple x86_64-unknown-linux-gnu -analyze -disable-free -main-file-name aof.c -analyzer-store=region -analyzer-opt-analyze-nested-blocks -analyzer-checker=core -analyzer-checker=apiModeling -analyzer-checker=unix -analyzer-checker=deadcode -analyzer-checker=security.insecureAPI.UncheckedReturn -analyzer-checker=security.insecureAPI.getpw -analyzer-checker=security.insecureAPI.gets -analyzer-checker=security.insecureAPI.mktemp -analyzer-checker=security.insecureAPI.mkstemp -analyzer-checker=security.insecureAPI.vfork -analyzer-checker=nullability.NullPassedToNonnull -analyzer-checker=nullability.NullReturnedFromNonnull -analyzer-output plist -w -setup-static-analyzer -mrelocation-model static -mframe-pointer=none -fmath-errno -fno-rounding-math -mconstructor-aliases -munwind-tables -target-cpu x86-64 -fno-split-dwarf-inlining -debugger-tuning=gdb -resource-dir /llvm-project/build/lib/clang/12.0.0 -D REDIS_STATIC= -I ../deps/hiredis -I ../deps/linenoise -I ../deps/lua/src -D USE_JEMALLOC -I ../deps/jemalloc/include -internal-isystem /usr/local/include -internal-isystem /llvm-project/build/lib/clang/12.0.0/include -internal-externc-isystem /usr/include/x86_64-linux-gnu -internal-externc-isystem /include -internal-externc-isystem /usr/include -O2 -Wno-missing-field-initializers -std=c11 -fdebug-compilation-dir /tmp/sslab_clang/c_redis/redis/src -ferror-limit 19 -fgnuc-version=4.2.1 -vectorize-loops -vectorize-slp -analyzer-checker core -analyzer-checker cplusplus -analyzer-checker nullability -analyzer-checker optin -analyzer-checker security -analyzer-checker unix -analyzer-checker osx -analyzer-checker fuchsia -analyzer-checker webkit -analyzer-output=html -faddrsig -o /tmp/scan-build-2020-11-24-134337-37-1 -x c aof.c
</div>
<div id='tooltiphint' hidden="true">
  <p>Keyboard shortcuts: </p>
  <ul>
    <li>Use 'j/k' keys for keyboard navigation</li>
    <li>Use 'Shift+S' to show/hide relevant lines</li>
    <li>Use '?' to toggle this window</li>
  </ul>
  <a href="#" onclick="toggleHelp(); return false;">Close</a>
</div>
<script type='text/javascript'>
var relevant_lines = {"1": {"1683": 1}};

var filterCounterexample = function (hide) {
  var tables = document.getElementsByClassName("code");
  for (var t=0; t<tables.length; t++) {
    var table = tables[t];
    var file_id = table.getAttribute("data-fileid");
    var lines_in_fid = relevant_lines[file_id];
    if (!lines_in_fid) {
      lines_in_fid = {};
    }
    var lines = table.getElementsByClassName("codeline");
    for (var i=0; i<lines.length; i++) {
        var el = lines[i];
        var lineNo = el.getAttribute("data-linenumber");
        if (!lines_in_fid[lineNo]) {
          if (hide) {
            el.setAttribute("hidden", "");
          } else {
            el.removeAttribute("hidden");
          }
        }
    }
  }
}

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "S") {
    var checked = document.getElementsByName("showCounterexample")[0].checked;
    filterCounterexample(!checked);
    document.getElementsByName("showCounterexample")[0].checked = !checked;
  } else {
    return;
  }
  event.preventDefault();
}, true);

document.addEventListener("DOMContentLoaded", function() {
    document.querySelector('input[name="showCounterexample"]').onchange=
        function (event) {
      filterCounterexample(this.checked);
    };
});
</script>

<form>
    <input type="checkbox" name="showCounterexample" id="showCounterexample" />
    <label for="showCounterexample">
       Show only relevant lines
    </label>
</form>

<script type='text/javascript'>
var digitMatcher = new RegExp("[0-9]+");

var querySelectorAllArray = function(selector) {
  return Array.prototype.slice.call(
    document.querySelectorAll(selector));
}

document.addEventListener("DOMContentLoaded", function() {
    querySelectorAllArray(".PathNav > a").forEach(
        function(currentValue, currentIndex) {
            var hrefValue = currentValue.getAttribute("href");
            currentValue.onclick = function() {
                scrollTo(document.querySelector(hrefValue));
                return false;
            };
        });
});

var findNum = function() {
    var s = document.querySelector(".selected");
    if (!s || s.id == "EndPath") {
        return 0;
    }
    var out = parseInt(digitMatcher.exec(s.id)[0]);
    return out;
};

var scrollTo = function(el) {
    querySelectorAllArray(".selected").forEach(function(s) {
        s.classList.remove("selected");
    });
    el.classList.add("selected");
    window.scrollBy(0, el.getBoundingClientRect().top -
        (window.innerHeight / 2));
}

var move = function(num, up, numItems) {
  if (num == 1 && up || num == numItems - 1 && !up) {
    return 0;
  } else if (num == 0 && up) {
    return numItems - 1;
  } else if (num == 0 && !up) {
    return 1 % numItems;
  }
  return up ? num - 1 : num + 1;
}

var numToId = function(num) {
  if (num == 0) {
    return document.getElementById("EndPath")
  }
  return document.getElementById("Path" + num);
};

var navigateTo = function(up) {
  var numItems = document.querySelectorAll(
      ".line > .msgEvent, .line > .msgControl").length;
  var currentSelected = findNum();
  var newSelected = move(currentSelected, up, numItems);
  var newEl = numToId(newSelected, numItems);

  // Scroll element into center.
  scrollTo(newEl);
};

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "j") {
    navigateTo(/*up=*/false);
  } else if (event.key == "k") {
    navigateTo(/*up=*/true);
  } else {
    return;
  }
  event.preventDefault();
}, true);
</script>
  
<script type='text/javascript'>

var toggleHelp = function() {
    var hint = document.querySelector("#tooltiphint");
    var attributeName = "hidden";
    if (hint.hasAttribute(attributeName)) {
      hint.removeAttribute(attributeName);
    } else {
      hint.setAttribute("hidden", "true");
    }
};
window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "?") {
    toggleHelp();
  } else {
    return;
  }
  event.preventDefault();
});
</script>
<table class="code" data-fileid="1">
<tr class="codeline" data-linenumber="1"><td class="num" id="LN1">1</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2"><td class="num" id="LN2">2</td><td class="line"> <span class='comment'>* Copyright (c) 2009-2012, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;</span></td></tr>
<tr class="codeline" data-linenumber="3"><td class="num" id="LN3">3</td><td class="line"> <span class='comment'>* All rights reserved.</span></td></tr>
<tr class="codeline" data-linenumber="4"><td class="num" id="LN4">4</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="5"><td class="num" id="LN5">5</td><td class="line"> <span class='comment'>* Redistribution and use in source and binary forms, with or without</span></td></tr>
<tr class="codeline" data-linenumber="6"><td class="num" id="LN6">6</td><td class="line"> <span class='comment'>* modification, are permitted provided that the following conditions are met:</span></td></tr>
<tr class="codeline" data-linenumber="7"><td class="num" id="LN7">7</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="8"><td class="num" id="LN8">8</td><td class="line"> <span class='comment'>*   * Redistributions of source code must retain the above copyright notice,</span></td></tr>
<tr class="codeline" data-linenumber="9"><td class="num" id="LN9">9</td><td class="line"> <span class='comment'>*     this list of conditions and the following disclaimer.</span></td></tr>
<tr class="codeline" data-linenumber="10"><td class="num" id="LN10">10</td><td class="line"> <span class='comment'>*   * Redistributions in binary form must reproduce the above copyright</span></td></tr>
<tr class="codeline" data-linenumber="11"><td class="num" id="LN11">11</td><td class="line"> <span class='comment'>*     notice, this list of conditions and the following disclaimer in the</span></td></tr>
<tr class="codeline" data-linenumber="12"><td class="num" id="LN12">12</td><td class="line"> <span class='comment'>*     documentation and/or other materials provided with the distribution.</span></td></tr>
<tr class="codeline" data-linenumber="13"><td class="num" id="LN13">13</td><td class="line"> <span class='comment'>*   * Neither the name of Redis nor the names of its contributors may be used</span></td></tr>
<tr class="codeline" data-linenumber="14"><td class="num" id="LN14">14</td><td class="line"> <span class='comment'>*     to endorse or promote products derived from this software without</span></td></tr>
<tr class="codeline" data-linenumber="15"><td class="num" id="LN15">15</td><td class="line"> <span class='comment'>*     specific prior written permission.</span></td></tr>
<tr class="codeline" data-linenumber="16"><td class="num" id="LN16">16</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="17"><td class="num" id="LN17">17</td><td class="line"> <span class='comment'>* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"</span></td></tr>
<tr class="codeline" data-linenumber="18"><td class="num" id="LN18">18</td><td class="line"> <span class='comment'>* AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span></td></tr>
<tr class="codeline" data-linenumber="19"><td class="num" id="LN19">19</td><td class="line"> <span class='comment'>* IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span></td></tr>
<tr class="codeline" data-linenumber="20"><td class="num" id="LN20">20</td><td class="line"> <span class='comment'>* ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span></td></tr>
<tr class="codeline" data-linenumber="21"><td class="num" id="LN21">21</td><td class="line"> <span class='comment'>* LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span></td></tr>
<tr class="codeline" data-linenumber="22"><td class="num" id="LN22">22</td><td class="line"> <span class='comment'>* CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span></td></tr>
<tr class="codeline" data-linenumber="23"><td class="num" id="LN23">23</td><td class="line"> <span class='comment'>* SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span></td></tr>
<tr class="codeline" data-linenumber="24"><td class="num" id="LN24">24</td><td class="line"> <span class='comment'>* INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span></td></tr>
<tr class="codeline" data-linenumber="25"><td class="num" id="LN25">25</td><td class="line"> <span class='comment'>* CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span></td></tr>
<tr class="codeline" data-linenumber="26"><td class="num" id="LN26">26</td><td class="line"> <span class='comment'>* ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span></td></tr>
<tr class="codeline" data-linenumber="27"><td class="num" id="LN27">27</td><td class="line"> <span class='comment'>* POSSIBILITY OF SUCH DAMAGE.</span></td></tr>
<tr class="codeline" data-linenumber="28"><td class="num" id="LN28">28</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="29"><td class="num" id="LN29">29</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="30"><td class="num" id="LN30">30</td><td class="line"><span class='directive'>#include "server.h"</span></td></tr>
<tr class="codeline" data-linenumber="31"><td class="num" id="LN31">31</td><td class="line"><span class='directive'>#include "bio.h"</span></td></tr>
<tr class="codeline" data-linenumber="32"><td class="num" id="LN32">32</td><td class="line"><span class='directive'>#include "rio.h"</span></td></tr>
<tr class="codeline" data-linenumber="33"><td class="num" id="LN33">33</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="34"><td class="num" id="LN34">34</td><td class="line"><span class='directive'>#include &lt;signal.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="35"><td class="num" id="LN35">35</td><td class="line"><span class='directive'>#include &lt;fcntl.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="36"><td class="num" id="LN36">36</td><td class="line"><span class='directive'>#include &lt;sys/stat.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="37"><td class="num" id="LN37">37</td><td class="line"><span class='directive'>#include &lt;sys/types.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="38"><td class="num" id="LN38">38</td><td class="line"><span class='directive'>#include &lt;sys/time.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="39"><td class="num" id="LN39">39</td><td class="line"><span class='directive'>#include &lt;sys/resource.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="40"><td class="num" id="LN40">40</td><td class="line"><span class='directive'>#include &lt;sys/wait.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="41"><td class="num" id="LN41">41</td><td class="line"><span class='directive'>#include &lt;sys/param.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="42"><td class="num" id="LN42">42</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="43"><td class="num" id="LN43">43</td><td class="line"><span class='keyword'>void</span> aofUpdateCurrentSize(<span class='keyword'>void</span>);</td></tr>
<tr class="codeline" data-linenumber="44"><td class="num" id="LN44">44</td><td class="line"><span class='keyword'>void</span> aofClosePipes(<span class='keyword'>void</span>);</td></tr>
<tr class="codeline" data-linenumber="45"><td class="num" id="LN45">45</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="46"><td class="num" id="LN46">46</td><td class="line"><span class='comment'>/* ----------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="47"><td class="num" id="LN47">47</td><td class="line"> <span class='comment'>* AOF rewrite buffer implementation.</span></td></tr>
<tr class="codeline" data-linenumber="48"><td class="num" id="LN48">48</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="49"><td class="num" id="LN49">49</td><td class="line"> <span class='comment'>* The following code implement a simple buffer used in order to accumulate</span></td></tr>
<tr class="codeline" data-linenumber="50"><td class="num" id="LN50">50</td><td class="line"> <span class='comment'>* changes while the background process is rewriting the AOF file.</span></td></tr>
<tr class="codeline" data-linenumber="51"><td class="num" id="LN51">51</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="52"><td class="num" id="LN52">52</td><td class="line"> <span class='comment'>* We only need to append, but can't just use realloc with a large block</span></td></tr>
<tr class="codeline" data-linenumber="53"><td class="num" id="LN53">53</td><td class="line"> <span class='comment'>* because 'huge' reallocs are not always handled as one could expect</span></td></tr>
<tr class="codeline" data-linenumber="54"><td class="num" id="LN54">54</td><td class="line"> <span class='comment'>* (via remapping of pages at OS level) but may involve copying data.</span></td></tr>
<tr class="codeline" data-linenumber="55"><td class="num" id="LN55">55</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="56"><td class="num" id="LN56">56</td><td class="line"> <span class='comment'>* For this reason we use a list of blocks, every block is</span></td></tr>
<tr class="codeline" data-linenumber="57"><td class="num" id="LN57">57</td><td class="line"> <span class='comment'>* AOF_RW_BUF_BLOCK_SIZE bytes.</span></td></tr>
<tr class="codeline" data-linenumber="58"><td class="num" id="LN58">58</td><td class="line"> <span class='comment'>* ------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="59"><td class="num" id="LN59">59</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="60"><td class="num" id="LN60">60</td><td class="line"><span class='directive'>#define <span class='macro'>AOF_RW_BUF_BLOCK_SIZE<span class='macro_popup'>(1024*1024*10)</span></span> (1024*1024*10)    /* 10 MB per block */</span></td></tr>
<tr class="codeline" data-linenumber="61"><td class="num" id="LN61">61</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="62"><td class="num" id="LN62">62</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> aofrwblock {</td></tr>
<tr class="codeline" data-linenumber="63"><td class="num" id="LN63">63</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> used, free;</td></tr>
<tr class="codeline" data-linenumber="64"><td class="num" id="LN64">64</td><td class="line">    <span class='keyword'>char</span> buf[<span class='macro'>AOF_RW_BUF_BLOCK_SIZE<span class='macro_popup'>(1024*1024*10)</span></span>];</td></tr>
<tr class="codeline" data-linenumber="65"><td class="num" id="LN65">65</td><td class="line">} aofrwblock;</td></tr>
<tr class="codeline" data-linenumber="66"><td class="num" id="LN66">66</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="67"><td class="num" id="LN67">67</td><td class="line"><span class='comment'>/* This function free the old AOF rewrite buffer if needed, and initialize</span></td></tr>
<tr class="codeline" data-linenumber="68"><td class="num" id="LN68">68</td><td class="line"> <span class='comment'>* a fresh new one. It tests for server.aof_rewrite_buf_blocks equal to NULL</span></td></tr>
<tr class="codeline" data-linenumber="69"><td class="num" id="LN69">69</td><td class="line"> <span class='comment'>* so can be used for the first initialization as well. */</span></td></tr>
<tr class="codeline" data-linenumber="70"><td class="num" id="LN70">70</td><td class="line"><span class='keyword'>void</span> aofRewriteBufferReset(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="71"><td class="num" id="LN71">71</td><td class="line">    <span class='keyword'>if</span> (server.aof_rewrite_buf_blocks)</td></tr>
<tr class="codeline" data-linenumber="72"><td class="num" id="LN72">72</td><td class="line">        listRelease(server.aof_rewrite_buf_blocks);</td></tr>
<tr class="codeline" data-linenumber="73"><td class="num" id="LN73">73</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="74"><td class="num" id="LN74">74</td><td class="line">    server.aof_rewrite_buf_blocks = listCreate();</td></tr>
<tr class="codeline" data-linenumber="75"><td class="num" id="LN75">75</td><td class="line">    <span class='macro'>listSetFreeMethod(server.aof_rewrite_buf_blocks,zfree)<span class='macro_popup'>((server.aof_rewrite_buf_blocks)-&gt;free = (zfree))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="76"><td class="num" id="LN76">76</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="77"><td class="num" id="LN77">77</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="78"><td class="num" id="LN78">78</td><td class="line"><span class='comment'>/* Return the current size of the AOF rewrite buffer. */</span></td></tr>
<tr class="codeline" data-linenumber="79"><td class="num" id="LN79">79</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>long</span> aofRewriteBufferSize(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="80"><td class="num" id="LN80">80</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="81"><td class="num" id="LN81">81</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="82"><td class="num" id="LN82">82</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>long</span> size = 0;</td></tr>
<tr class="codeline" data-linenumber="83"><td class="num" id="LN83">83</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="84"><td class="num" id="LN84">84</td><td class="line">    listRewind(server.aof_rewrite_buf_blocks,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="85"><td class="num" id="LN85">85</td><td class="line">    <span class='keyword'>while</span>((ln = listNext(&amp;li))) {</td></tr>
<tr class="codeline" data-linenumber="86"><td class="num" id="LN86">86</td><td class="line">        aofrwblock *block = <span class='macro'>listNodeValue(ln)<span class='macro_popup'>((ln)-&gt;value)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="87"><td class="num" id="LN87">87</td><td class="line">        size += block-&gt;used;</td></tr>
<tr class="codeline" data-linenumber="88"><td class="num" id="LN88">88</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="89"><td class="num" id="LN89">89</td><td class="line">    <span class='keyword'>return</span> size;</td></tr>
<tr class="codeline" data-linenumber="90"><td class="num" id="LN90">90</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="91"><td class="num" id="LN91">91</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="92"><td class="num" id="LN92">92</td><td class="line"><span class='comment'>/* Event handler used to send data to the child process doing the AOF</span></td></tr>
<tr class="codeline" data-linenumber="93"><td class="num" id="LN93">93</td><td class="line"> <span class='comment'>* rewrite. We send pieces of our AOF differences buffer so that the final</span></td></tr>
<tr class="codeline" data-linenumber="94"><td class="num" id="LN94">94</td><td class="line"> <span class='comment'>* write when the child finishes the rewrite will be small. */</span></td></tr>
<tr class="codeline" data-linenumber="95"><td class="num" id="LN95">95</td><td class="line"><span class='keyword'>void</span> aofChildWriteDiffData(aeEventLoop *el, <span class='keyword'>int</span> fd, <span class='keyword'>void</span> *privdata, <span class='keyword'>int</span> mask) {</td></tr>
<tr class="codeline" data-linenumber="96"><td class="num" id="LN96">96</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="97"><td class="num" id="LN97">97</td><td class="line">    aofrwblock *block;</td></tr>
<tr class="codeline" data-linenumber="98"><td class="num" id="LN98">98</td><td class="line">    ssize_t nwritten;</td></tr>
<tr class="codeline" data-linenumber="99"><td class="num" id="LN99">99</td><td class="line">    <span class='macro'>UNUSED(el)<span class='macro_popup'>((void) el)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="100"><td class="num" id="LN100">100</td><td class="line">    <span class='macro'>UNUSED(fd)<span class='macro_popup'>((void) fd)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="101"><td class="num" id="LN101">101</td><td class="line">    <span class='macro'>UNUSED(privdata)<span class='macro_popup'>((void) privdata)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="102"><td class="num" id="LN102">102</td><td class="line">    <span class='macro'>UNUSED(mask)<span class='macro_popup'>((void) mask)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="103"><td class="num" id="LN103">103</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="104"><td class="num" id="LN104">104</td><td class="line">    <span class='keyword'>while</span>(1) {</td></tr>
<tr class="codeline" data-linenumber="105"><td class="num" id="LN105">105</td><td class="line">        ln = <span class='macro'>listFirst(server.aof_rewrite_buf_blocks)<span class='macro_popup'>((server.aof_rewrite_buf_blocks)-&gt;head)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="106"><td class="num" id="LN106">106</td><td class="line">        block = ln ? ln-&gt;value : <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="107"><td class="num" id="LN107">107</td><td class="line">        <span class='keyword'>if</span> (server.aof_stop_sending_diff || !block) {</td></tr>
<tr class="codeline" data-linenumber="108"><td class="num" id="LN108">108</td><td class="line">            aeDeleteFileEvent(server.el,server.aof_pipe_write_data_to_child,</td></tr>
<tr class="codeline" data-linenumber="109"><td class="num" id="LN109">109</td><td class="line">                              <span class='macro'>AE_WRITABLE<span class='macro_popup'>2</span></span>);</td></tr>
<tr class="codeline" data-linenumber="110"><td class="num" id="LN110">110</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="111"><td class="num" id="LN111">111</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="112"><td class="num" id="LN112">112</td><td class="line">        <span class='keyword'>if</span> (block-&gt;used &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="113"><td class="num" id="LN113">113</td><td class="line">            nwritten = write(server.aof_pipe_write_data_to_child,</td></tr>
<tr class="codeline" data-linenumber="114"><td class="num" id="LN114">114</td><td class="line">                             block-&gt;buf,block-&gt;used);</td></tr>
<tr class="codeline" data-linenumber="115"><td class="num" id="LN115">115</td><td class="line">            <span class='keyword'>if</span> (nwritten &lt;= 0) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="116"><td class="num" id="LN116">116</td><td class="line">            memmove(block-&gt;buf,block-&gt;buf+nwritten,block-&gt;used-nwritten);</td></tr>
<tr class="codeline" data-linenumber="117"><td class="num" id="LN117">117</td><td class="line">            block-&gt;used -= nwritten;</td></tr>
<tr class="codeline" data-linenumber="118"><td class="num" id="LN118">118</td><td class="line">            block-&gt;free += nwritten;</td></tr>
<tr class="codeline" data-linenumber="119"><td class="num" id="LN119">119</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="120"><td class="num" id="LN120">120</td><td class="line">        <span class='keyword'>if</span> (block-&gt;used == 0) listDelNode(server.aof_rewrite_buf_blocks,ln);</td></tr>
<tr class="codeline" data-linenumber="121"><td class="num" id="LN121">121</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="122"><td class="num" id="LN122">122</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="123"><td class="num" id="LN123">123</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="124"><td class="num" id="LN124">124</td><td class="line"><span class='comment'>/* Append data to the AOF rewrite buffer, allocating new blocks if needed. */</span></td></tr>
<tr class="codeline" data-linenumber="125"><td class="num" id="LN125">125</td><td class="line"><span class='keyword'>void</span> aofRewriteBufferAppend(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *s, <span class='keyword'>unsigned</span> <span class='keyword'>long</span> len) {</td></tr>
<tr class="codeline" data-linenumber="126"><td class="num" id="LN126">126</td><td class="line">    listNode *ln = <span class='macro'>listLast(server.aof_rewrite_buf_blocks)<span class='macro_popup'>((server.aof_rewrite_buf_blocks)-&gt;tail)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="127"><td class="num" id="LN127">127</td><td class="line">    aofrwblock *block = ln ? ln-&gt;value : <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="128"><td class="num" id="LN128">128</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="129"><td class="num" id="LN129">129</td><td class="line">    <span class='keyword'>while</span>(len) {</td></tr>
<tr class="codeline" data-linenumber="130"><td class="num" id="LN130">130</td><td class="line">        <span class='comment'>/* If we already got at least an allocated block, try appending</span></td></tr>
<tr class="codeline" data-linenumber="131"><td class="num" id="LN131">131</td><td class="line">         <span class='comment'>* at least some piece into it. */</span></td></tr>
<tr class="codeline" data-linenumber="132"><td class="num" id="LN132">132</td><td class="line">        <span class='keyword'>if</span> (block) {</td></tr>
<tr class="codeline" data-linenumber="133"><td class="num" id="LN133">133</td><td class="line">            <span class='keyword'>unsigned</span> <span class='keyword'>long</span> thislen = (block-&gt;free &lt; len) ? block-&gt;free : len;</td></tr>
<tr class="codeline" data-linenumber="134"><td class="num" id="LN134">134</td><td class="line">            <span class='keyword'>if</span> (thislen) {  <span class='comment'>/* The current block is not already full. */</span></td></tr>
<tr class="codeline" data-linenumber="135"><td class="num" id="LN135">135</td><td class="line">                memcpy(block-&gt;buf+block-&gt;used, s, thislen);</td></tr>
<tr class="codeline" data-linenumber="136"><td class="num" id="LN136">136</td><td class="line">                block-&gt;used += thislen;</td></tr>
<tr class="codeline" data-linenumber="137"><td class="num" id="LN137">137</td><td class="line">                block-&gt;free -= thislen;</td></tr>
<tr class="codeline" data-linenumber="138"><td class="num" id="LN138">138</td><td class="line">                s += thislen;</td></tr>
<tr class="codeline" data-linenumber="139"><td class="num" id="LN139">139</td><td class="line">                len -= thislen;</td></tr>
<tr class="codeline" data-linenumber="140"><td class="num" id="LN140">140</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="141"><td class="num" id="LN141">141</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="142"><td class="num" id="LN142">142</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="143"><td class="num" id="LN143">143</td><td class="line">        <span class='keyword'>if</span> (len) { <span class='comment'>/* First block to allocate, or need another block. */</span></td></tr>
<tr class="codeline" data-linenumber="144"><td class="num" id="LN144">144</td><td class="line">            <span class='keyword'>int</span> numblocks;</td></tr>
<tr class="codeline" data-linenumber="145"><td class="num" id="LN145">145</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="146"><td class="num" id="LN146">146</td><td class="line">            block = zmalloc(<span class='keyword'>sizeof</span>(*block));</td></tr>
<tr class="codeline" data-linenumber="147"><td class="num" id="LN147">147</td><td class="line">            block-&gt;free = <span class='macro'>AOF_RW_BUF_BLOCK_SIZE<span class='macro_popup'>(1024*1024*10)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="148"><td class="num" id="LN148">148</td><td class="line">            block-&gt;used = 0;</td></tr>
<tr class="codeline" data-linenumber="149"><td class="num" id="LN149">149</td><td class="line">            listAddNodeTail(server.aof_rewrite_buf_blocks,block);</td></tr>
<tr class="codeline" data-linenumber="150"><td class="num" id="LN150">150</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="151"><td class="num" id="LN151">151</td><td class="line">            <span class='comment'>/* Log every time we cross more 10 or 100 blocks, respectively</span></td></tr>
<tr class="codeline" data-linenumber="152"><td class="num" id="LN152">152</td><td class="line">             <span class='comment'>* as a notice or warning. */</span></td></tr>
<tr class="codeline" data-linenumber="153"><td class="num" id="LN153">153</td><td class="line">            numblocks = <span class='macro'>listLength(server.aof_rewrite_buf_blocks)<span class='macro_popup'>((server.aof_rewrite_buf_blocks)-&gt;len)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="154"><td class="num" id="LN154">154</td><td class="line">            <span class='keyword'>if</span> (((numblocks+1) % 10) == 0) {</td></tr>
<tr class="codeline" data-linenumber="155"><td class="num" id="LN155">155</td><td class="line">                <span class='keyword'>int</span> level = ((numblocks+1) % 100) == 0 ? <span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span> :</td></tr>
<tr class="codeline" data-linenumber="156"><td class="num" id="LN156">156</td><td class="line">                                                         <span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="157"><td class="num" id="LN157">157</td><td class="line">                serverLog(level,<span class='string_literal'>"Background AOF buffer size: %lu MB"</span>,</td></tr>
<tr class="codeline" data-linenumber="158"><td class="num" id="LN158">158</td><td class="line">                    aofRewriteBufferSize()/(1024*1024));</td></tr>
<tr class="codeline" data-linenumber="159"><td class="num" id="LN159">159</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="160"><td class="num" id="LN160">160</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="161"><td class="num" id="LN161">161</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="162"><td class="num" id="LN162">162</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="163"><td class="num" id="LN163">163</td><td class="line">    <span class='comment'>/* Install a file event to send data to the rewrite child if there is</span></td></tr>
<tr class="codeline" data-linenumber="164"><td class="num" id="LN164">164</td><td class="line">     <span class='comment'>* not one already. */</span></td></tr>
<tr class="codeline" data-linenumber="165"><td class="num" id="LN165">165</td><td class="line">    <span class='keyword'>if</span> (aeGetFileEvents(server.el,server.aof_pipe_write_data_to_child) == 0) {</td></tr>
<tr class="codeline" data-linenumber="166"><td class="num" id="LN166">166</td><td class="line">        aeCreateFileEvent(server.el, server.aof_pipe_write_data_to_child,</td></tr>
<tr class="codeline" data-linenumber="167"><td class="num" id="LN167">167</td><td class="line">            <span class='macro'>AE_WRITABLE<span class='macro_popup'>2</span></span>, aofChildWriteDiffData, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="168"><td class="num" id="LN168">168</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="169"><td class="num" id="LN169">169</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="170"><td class="num" id="LN170">170</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="171"><td class="num" id="LN171">171</td><td class="line"><span class='comment'>/* Write the buffer (possibly composed of multiple blocks) into the specified</span></td></tr>
<tr class="codeline" data-linenumber="172"><td class="num" id="LN172">172</td><td class="line"> <span class='comment'>* fd. If a short write or any other error happens -1 is returned,</span></td></tr>
<tr class="codeline" data-linenumber="173"><td class="num" id="LN173">173</td><td class="line"> <span class='comment'>* otherwise the number of bytes written is returned. */</span></td></tr>
<tr class="codeline" data-linenumber="174"><td class="num" id="LN174">174</td><td class="line">ssize_t aofRewriteBufferWrite(<span class='keyword'>int</span> fd) {</td></tr>
<tr class="codeline" data-linenumber="175"><td class="num" id="LN175">175</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="176"><td class="num" id="LN176">176</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="177"><td class="num" id="LN177">177</td><td class="line">    ssize_t count = 0;</td></tr>
<tr class="codeline" data-linenumber="178"><td class="num" id="LN178">178</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="179"><td class="num" id="LN179">179</td><td class="line">    listRewind(server.aof_rewrite_buf_blocks,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="180"><td class="num" id="LN180">180</td><td class="line">    <span class='keyword'>while</span>((ln = listNext(&amp;li))) {</td></tr>
<tr class="codeline" data-linenumber="181"><td class="num" id="LN181">181</td><td class="line">        aofrwblock *block = <span class='macro'>listNodeValue(ln)<span class='macro_popup'>((ln)-&gt;value)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="182"><td class="num" id="LN182">182</td><td class="line">        ssize_t nwritten;</td></tr>
<tr class="codeline" data-linenumber="183"><td class="num" id="LN183">183</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="184"><td class="num" id="LN184">184</td><td class="line">        <span class='keyword'>if</span> (block-&gt;used) {</td></tr>
<tr class="codeline" data-linenumber="185"><td class="num" id="LN185">185</td><td class="line">            nwritten = write(fd,block-&gt;buf,block-&gt;used);</td></tr>
<tr class="codeline" data-linenumber="186"><td class="num" id="LN186">186</td><td class="line">            <span class='keyword'>if</span> (nwritten != (ssize_t)block-&gt;used) {</td></tr>
<tr class="codeline" data-linenumber="187"><td class="num" id="LN187">187</td><td class="line">                <span class='keyword'>if</span> (nwritten == 0) <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> = <span class='macro'>EIO<span class='macro_popup'>5</span></span>;</td></tr>
<tr class="codeline" data-linenumber="188"><td class="num" id="LN188">188</td><td class="line">                <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="189"><td class="num" id="LN189">189</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="190"><td class="num" id="LN190">190</td><td class="line">            count += nwritten;</td></tr>
<tr class="codeline" data-linenumber="191"><td class="num" id="LN191">191</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="192"><td class="num" id="LN192">192</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="193"><td class="num" id="LN193">193</td><td class="line">    <span class='keyword'>return</span> count;</td></tr>
<tr class="codeline" data-linenumber="194"><td class="num" id="LN194">194</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="195"><td class="num" id="LN195">195</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="196"><td class="num" id="LN196">196</td><td class="line"><span class='comment'>/* ----------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="197"><td class="num" id="LN197">197</td><td class="line"> <span class='comment'>* AOF file implementation</span></td></tr>
<tr class="codeline" data-linenumber="198"><td class="num" id="LN198">198</td><td class="line"> <span class='comment'>* ------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="199"><td class="num" id="LN199">199</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="200"><td class="num" id="LN200">200</td><td class="line"><span class='comment'>/* Return true if an AOf fsync is currently already in progress in a</span></td></tr>
<tr class="codeline" data-linenumber="201"><td class="num" id="LN201">201</td><td class="line"> <span class='comment'>* BIO thread. */</span></td></tr>
<tr class="codeline" data-linenumber="202"><td class="num" id="LN202">202</td><td class="line"><span class='keyword'>int</span> aofFsyncInProgress(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="203"><td class="num" id="LN203">203</td><td class="line">    <span class='keyword'>return</span> bioPendingJobsOfType(<span class='macro'>BIO_AOF_FSYNC<span class='macro_popup'>1</span></span>) != 0;</td></tr>
<tr class="codeline" data-linenumber="204"><td class="num" id="LN204">204</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="205"><td class="num" id="LN205">205</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="206"><td class="num" id="LN206">206</td><td class="line"><span class='comment'>/* Starts a background task that performs fsync() against the specified</span></td></tr>
<tr class="codeline" data-linenumber="207"><td class="num" id="LN207">207</td><td class="line"> <span class='comment'>* file descriptor (the one of the AOF file) in another thread. */</span></td></tr>
<tr class="codeline" data-linenumber="208"><td class="num" id="LN208">208</td><td class="line"><span class='keyword'>void</span> aof_background_fsync(<span class='keyword'>int</span> fd) {</td></tr>
<tr class="codeline" data-linenumber="209"><td class="num" id="LN209">209</td><td class="line">    bioCreateBackgroundJob(<span class='macro'>BIO_AOF_FSYNC<span class='macro_popup'>1</span></span>,(<span class='keyword'>void</span>*)(<span class='keyword'>long</span>)fd,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="210"><td class="num" id="LN210">210</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="211"><td class="num" id="LN211">211</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="212"><td class="num" id="LN212">212</td><td class="line"><span class='comment'>/* Kills an AOFRW child process if exists */</span></td></tr>
<tr class="codeline" data-linenumber="213"><td class="num" id="LN213">213</td><td class="line"><span class='keyword'>void</span> killAppendOnlyChild(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="214"><td class="num" id="LN214">214</td><td class="line">    <span class='keyword'>int</span> statloc;</td></tr>
<tr class="codeline" data-linenumber="215"><td class="num" id="LN215">215</td><td class="line">    <span class='comment'>/* No AOFRW child? return. */</span></td></tr>
<tr class="codeline" data-linenumber="216"><td class="num" id="LN216">216</td><td class="line">    <span class='keyword'>if</span> (server.aof_child_pid == -1) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="217"><td class="num" id="LN217">217</td><td class="line">    <span class='comment'>/* Kill AOFRW child, wait for child exit. */</span></td></tr>
<tr class="codeline" data-linenumber="218"><td class="num" id="LN218">218</td><td class="line">    serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Killing running AOF rewrite child: %ld"</span>,</td></tr>
<tr class="codeline" data-linenumber="219"><td class="num" id="LN219">219</td><td class="line">        (<span class='keyword'>long</span>) server.aof_child_pid);</td></tr>
<tr class="codeline" data-linenumber="220"><td class="num" id="LN220">220</td><td class="line">    <span class='keyword'>if</span> (kill(server.aof_child_pid,<span class='macro'>SIGUSR1<span class='macro_popup'>10</span></span>) != -1) {</td></tr>
<tr class="codeline" data-linenumber="221"><td class="num" id="LN221">221</td><td class="line">        <span class='keyword'>while</span>(wait3(&amp;statloc,0,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) != server.aof_child_pid);</td></tr>
<tr class="codeline" data-linenumber="222"><td class="num" id="LN222">222</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="223"><td class="num" id="LN223">223</td><td class="line">    <span class='comment'>/* Reset the buffer accumulating changes while the child saves. */</span></td></tr>
<tr class="codeline" data-linenumber="224"><td class="num" id="LN224">224</td><td class="line">    aofRewriteBufferReset();</td></tr>
<tr class="codeline" data-linenumber="225"><td class="num" id="LN225">225</td><td class="line">    aofRemoveTempFile(server.aof_child_pid);</td></tr>
<tr class="codeline" data-linenumber="226"><td class="num" id="LN226">226</td><td class="line">    server.aof_child_pid = -1;</td></tr>
<tr class="codeline" data-linenumber="227"><td class="num" id="LN227">227</td><td class="line">    server.aof_rewrite_time_start = -1;</td></tr>
<tr class="codeline" data-linenumber="228"><td class="num" id="LN228">228</td><td class="line">    <span class='comment'>/* Close pipes used for IPC between the two processes. */</span></td></tr>
<tr class="codeline" data-linenumber="229"><td class="num" id="LN229">229</td><td class="line">    aofClosePipes();</td></tr>
<tr class="codeline" data-linenumber="230"><td class="num" id="LN230">230</td><td class="line">    closeChildInfoPipe();</td></tr>
<tr class="codeline" data-linenumber="231"><td class="num" id="LN231">231</td><td class="line">    updateDictResizePolicy();</td></tr>
<tr class="codeline" data-linenumber="232"><td class="num" id="LN232">232</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="233"><td class="num" id="LN233">233</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="234"><td class="num" id="LN234">234</td><td class="line"><span class='comment'>/* Called when the user switches from "appendonly yes" to "appendonly no"</span></td></tr>
<tr class="codeline" data-linenumber="235"><td class="num" id="LN235">235</td><td class="line"> <span class='comment'>* at runtime using the CONFIG command. */</span></td></tr>
<tr class="codeline" data-linenumber="236"><td class="num" id="LN236">236</td><td class="line"><span class='keyword'>void</span> stopAppendOnly(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="237"><td class="num" id="LN237">237</td><td class="line">    <span class='macro'>serverAssert(server.aof_state != AOF_OFF)<span class='macro_popup'>((server.aof_state != 0)?(void)0 : (_serverAssert("server.aof_state != AOF_OFF"<br>,"aof.c",237),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="238"><td class="num" id="LN238">238</td><td class="line">    flushAppendOnlyFile(1);</td></tr>
<tr class="codeline" data-linenumber="239"><td class="num" id="LN239">239</td><td class="line">    <span class='macro'>redis_fsync<span class='macro_popup'>fdatasync</span></span>(server.aof_fd);</td></tr>
<tr class="codeline" data-linenumber="240"><td class="num" id="LN240">240</td><td class="line">    close(server.aof_fd);</td></tr>
<tr class="codeline" data-linenumber="241"><td class="num" id="LN241">241</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="242"><td class="num" id="LN242">242</td><td class="line">    server.aof_fd = -1;</td></tr>
<tr class="codeline" data-linenumber="243"><td class="num" id="LN243">243</td><td class="line">    server.aof_selected_db = -1;</td></tr>
<tr class="codeline" data-linenumber="244"><td class="num" id="LN244">244</td><td class="line">    server.aof_state = <span class='macro'>AOF_OFF<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="245"><td class="num" id="LN245">245</td><td class="line">    server.aof_rewrite_scheduled = 0;</td></tr>
<tr class="codeline" data-linenumber="246"><td class="num" id="LN246">246</td><td class="line">    killAppendOnlyChild();</td></tr>
<tr class="codeline" data-linenumber="247"><td class="num" id="LN247">247</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="248"><td class="num" id="LN248">248</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="249"><td class="num" id="LN249">249</td><td class="line"><span class='comment'>/* Called when the user switches from "appendonly no" to "appendonly yes"</span></td></tr>
<tr class="codeline" data-linenumber="250"><td class="num" id="LN250">250</td><td class="line"> <span class='comment'>* at runtime using the CONFIG command. */</span></td></tr>
<tr class="codeline" data-linenumber="251"><td class="num" id="LN251">251</td><td class="line"><span class='keyword'>int</span> startAppendOnly(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="252"><td class="num" id="LN252">252</td><td class="line">    <span class='keyword'>char</span> cwd[<span class='macro'>MAXPATHLEN<span class='macro_popup'>4096</span></span>]; <span class='comment'>/* Current working dir path for error messages. */</span></td></tr>
<tr class="codeline" data-linenumber="253"><td class="num" id="LN253">253</td><td class="line">    <span class='keyword'>int</span> newfd;</td></tr>
<tr class="codeline" data-linenumber="254"><td class="num" id="LN254">254</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="255"><td class="num" id="LN255">255</td><td class="line">    newfd = open(server.aof_filename,<span class='macro'>O_WRONLY<span class='macro_popup'>01</span></span>|<span class='macro'>O_APPEND<span class='macro_popup'>02000</span></span>|<span class='macro'>O_CREAT<span class='macro_popup'>0100</span></span>,0644);</td></tr>
<tr class="codeline" data-linenumber="256"><td class="num" id="LN256">256</td><td class="line">    <span class='macro'>serverAssert(server.aof_state == AOF_OFF)<span class='macro_popup'>((server.aof_state == 0)?(void)0 : (_serverAssert("server.aof_state == AOF_OFF"<br>,"aof.c",256),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="257"><td class="num" id="LN257">257</td><td class="line">    <span class='keyword'>if</span> (newfd == -1) {</td></tr>
<tr class="codeline" data-linenumber="258"><td class="num" id="LN258">258</td><td class="line">        <span class='keyword'>char</span> *cwdp = getcwd(cwd,<span class='macro'>MAXPATHLEN<span class='macro_popup'>4096</span></span>);</td></tr>
<tr class="codeline" data-linenumber="259"><td class="num" id="LN259">259</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="260"><td class="num" id="LN260">260</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="261"><td class="num" id="LN261">261</td><td class="line">            <span class='string_literal'>"Redis needs to enable the AOF but can't open the "</span></td></tr>
<tr class="codeline" data-linenumber="262"><td class="num" id="LN262">262</td><td class="line">            <span class='string_literal'>"append only file %s (in server root dir %s): %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="263"><td class="num" id="LN263">263</td><td class="line">            server.aof_filename,</td></tr>
<tr class="codeline" data-linenumber="264"><td class="num" id="LN264">264</td><td class="line">            cwdp ? cwdp : <span class='string_literal'>"unknown"</span>,</td></tr>
<tr class="codeline" data-linenumber="265"><td class="num" id="LN265">265</td><td class="line">            strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="266"><td class="num" id="LN266">266</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="267"><td class="num" id="LN267">267</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="268"><td class="num" id="LN268">268</td><td class="line">    <span class='keyword'>if</span> (hasActiveChildProcess() &amp;&amp; server.aof_child_pid == -1) {</td></tr>
<tr class="codeline" data-linenumber="269"><td class="num" id="LN269">269</td><td class="line">        server.aof_rewrite_scheduled = 1;</td></tr>
<tr class="codeline" data-linenumber="270"><td class="num" id="LN270">270</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"AOF was enabled but there is already another background operation. An AOF background was scheduled to start when possible."</span>);</td></tr>
<tr class="codeline" data-linenumber="271"><td class="num" id="LN271">271</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="272"><td class="num" id="LN272">272</td><td class="line">        <span class='comment'>/* If there is a pending AOF rewrite, we need to switch it off and</span></td></tr>
<tr class="codeline" data-linenumber="273"><td class="num" id="LN273">273</td><td class="line">         <span class='comment'>* start a new one: the old one cannot be reused because it is not</span></td></tr>
<tr class="codeline" data-linenumber="274"><td class="num" id="LN274">274</td><td class="line">         <span class='comment'>* accumulating the AOF buffer. */</span></td></tr>
<tr class="codeline" data-linenumber="275"><td class="num" id="LN275">275</td><td class="line">        <span class='keyword'>if</span> (server.aof_child_pid != -1) {</td></tr>
<tr class="codeline" data-linenumber="276"><td class="num" id="LN276">276</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"AOF was enabled but there is already an AOF rewriting in background. Stopping background AOF and starting a rewrite now."</span>);</td></tr>
<tr class="codeline" data-linenumber="277"><td class="num" id="LN277">277</td><td class="line">            killAppendOnlyChild();</td></tr>
<tr class="codeline" data-linenumber="278"><td class="num" id="LN278">278</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="279"><td class="num" id="LN279">279</td><td class="line">        <span class='keyword'>if</span> (rewriteAppendOnlyFileBackground() == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="280"><td class="num" id="LN280">280</td><td class="line">            close(newfd);</td></tr>
<tr class="codeline" data-linenumber="281"><td class="num" id="LN281">281</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Redis needs to enable the AOF but can't trigger a background AOF rewrite operation. Check the above logs for more info about the error."</span>);</td></tr>
<tr class="codeline" data-linenumber="282"><td class="num" id="LN282">282</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="283"><td class="num" id="LN283">283</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="284"><td class="num" id="LN284">284</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="285"><td class="num" id="LN285">285</td><td class="line">    <span class='comment'>/* We correctly switched on AOF, now wait for the rewrite to be complete</span></td></tr>
<tr class="codeline" data-linenumber="286"><td class="num" id="LN286">286</td><td class="line">     <span class='comment'>* in order to append data on disk. */</span></td></tr>
<tr class="codeline" data-linenumber="287"><td class="num" id="LN287">287</td><td class="line">    server.aof_state = <span class='macro'>AOF_WAIT_REWRITE<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="288"><td class="num" id="LN288">288</td><td class="line">    server.aof_last_fsync = server.unixtime;</td></tr>
<tr class="codeline" data-linenumber="289"><td class="num" id="LN289">289</td><td class="line">    server.aof_fd = newfd;</td></tr>
<tr class="codeline" data-linenumber="290"><td class="num" id="LN290">290</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="291"><td class="num" id="LN291">291</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="292"><td class="num" id="LN292">292</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="293"><td class="num" id="LN293">293</td><td class="line"><span class='comment'>/* This is a wrapper to the write syscall in order to retry on short writes</span></td></tr>
<tr class="codeline" data-linenumber="294"><td class="num" id="LN294">294</td><td class="line"> <span class='comment'>* or if the syscall gets interrupted. It could look strange that we retry</span></td></tr>
<tr class="codeline" data-linenumber="295"><td class="num" id="LN295">295</td><td class="line"> <span class='comment'>* on short writes given that we are writing to a block device: normally if</span></td></tr>
<tr class="codeline" data-linenumber="296"><td class="num" id="LN296">296</td><td class="line"> <span class='comment'>* the first call is short, there is a end-of-space condition, so the next</span></td></tr>
<tr class="codeline" data-linenumber="297"><td class="num" id="LN297">297</td><td class="line"> <span class='comment'>* is likely to fail. However apparently in modern systems this is no longer</span></td></tr>
<tr class="codeline" data-linenumber="298"><td class="num" id="LN298">298</td><td class="line"> <span class='comment'>* true, and in general it looks just more resilient to retry the write. If</span></td></tr>
<tr class="codeline" data-linenumber="299"><td class="num" id="LN299">299</td><td class="line"> <span class='comment'>* there is an actual error condition we'll get it at the next try. */</span></td></tr>
<tr class="codeline" data-linenumber="300"><td class="num" id="LN300">300</td><td class="line">ssize_t aofWrite(<span class='keyword'>int</span> fd, <span class='keyword'>const</span> <span class='keyword'>char</span> *buf, size_t len) {</td></tr>
<tr class="codeline" data-linenumber="301"><td class="num" id="LN301">301</td><td class="line">    ssize_t nwritten = 0, totwritten = 0;</td></tr>
<tr class="codeline" data-linenumber="302"><td class="num" id="LN302">302</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="303"><td class="num" id="LN303">303</td><td class="line">    <span class='keyword'>while</span>(len) {</td></tr>
<tr class="codeline" data-linenumber="304"><td class="num" id="LN304">304</td><td class="line">        nwritten = write(fd, buf, len);</td></tr>
<tr class="codeline" data-linenumber="305"><td class="num" id="LN305">305</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="306"><td class="num" id="LN306">306</td><td class="line">        <span class='keyword'>if</span> (nwritten &lt; 0) {</td></tr>
<tr class="codeline" data-linenumber="307"><td class="num" id="LN307">307</td><td class="line">            <span class='keyword'>if</span> (<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> == <span class='macro'>EINTR<span class='macro_popup'>4</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="308"><td class="num" id="LN308">308</td><td class="line">            <span class='keyword'>return</span> totwritten ? totwritten : -1;</td></tr>
<tr class="codeline" data-linenumber="309"><td class="num" id="LN309">309</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="310"><td class="num" id="LN310">310</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="311"><td class="num" id="LN311">311</td><td class="line">        len -= nwritten;</td></tr>
<tr class="codeline" data-linenumber="312"><td class="num" id="LN312">312</td><td class="line">        buf += nwritten;</td></tr>
<tr class="codeline" data-linenumber="313"><td class="num" id="LN313">313</td><td class="line">        totwritten += nwritten;</td></tr>
<tr class="codeline" data-linenumber="314"><td class="num" id="LN314">314</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="315"><td class="num" id="LN315">315</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="316"><td class="num" id="LN316">316</td><td class="line">    <span class='keyword'>return</span> totwritten;</td></tr>
<tr class="codeline" data-linenumber="317"><td class="num" id="LN317">317</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="318"><td class="num" id="LN318">318</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="319"><td class="num" id="LN319">319</td><td class="line"><span class='comment'>/* Write the append only file buffer on disk.</span></td></tr>
<tr class="codeline" data-linenumber="320"><td class="num" id="LN320">320</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="321"><td class="num" id="LN321">321</td><td class="line"> <span class='comment'>* Since we are required to write the AOF before replying to the client,</span></td></tr>
<tr class="codeline" data-linenumber="322"><td class="num" id="LN322">322</td><td class="line"> <span class='comment'>* and the only way the client socket can get a write is entering when the</span></td></tr>
<tr class="codeline" data-linenumber="323"><td class="num" id="LN323">323</td><td class="line"> <span class='comment'>* the event loop, we accumulate all the AOF writes in a memory</span></td></tr>
<tr class="codeline" data-linenumber="324"><td class="num" id="LN324">324</td><td class="line"> <span class='comment'>* buffer and write it on disk using this function just before entering</span></td></tr>
<tr class="codeline" data-linenumber="325"><td class="num" id="LN325">325</td><td class="line"> <span class='comment'>* the event loop again.</span></td></tr>
<tr class="codeline" data-linenumber="326"><td class="num" id="LN326">326</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="327"><td class="num" id="LN327">327</td><td class="line"> <span class='comment'>* About the 'force' argument:</span></td></tr>
<tr class="codeline" data-linenumber="328"><td class="num" id="LN328">328</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="329"><td class="num" id="LN329">329</td><td class="line"> <span class='comment'>* When the fsync policy is set to 'everysec' we may delay the flush if there</span></td></tr>
<tr class="codeline" data-linenumber="330"><td class="num" id="LN330">330</td><td class="line"> <span class='comment'>* is still an fsync() going on in the background thread, since for instance</span></td></tr>
<tr class="codeline" data-linenumber="331"><td class="num" id="LN331">331</td><td class="line"> <span class='comment'>* on Linux write(2) will be blocked by the background fsync anyway.</span></td></tr>
<tr class="codeline" data-linenumber="332"><td class="num" id="LN332">332</td><td class="line"> <span class='comment'>* When this happens we remember that there is some aof buffer to be</span></td></tr>
<tr class="codeline" data-linenumber="333"><td class="num" id="LN333">333</td><td class="line"> <span class='comment'>* flushed ASAP, and will try to do that in the serverCron() function.</span></td></tr>
<tr class="codeline" data-linenumber="334"><td class="num" id="LN334">334</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="335"><td class="num" id="LN335">335</td><td class="line"> <span class='comment'>* However if force is set to 1 we'll write regardless of the background</span></td></tr>
<tr class="codeline" data-linenumber="336"><td class="num" id="LN336">336</td><td class="line"> <span class='comment'>* fsync. */</span></td></tr>
<tr class="codeline" data-linenumber="337"><td class="num" id="LN337">337</td><td class="line"><span class='directive'>#define <span class='macro'>AOF_WRITE_LOG_ERROR_RATE<span class='macro_popup'>30</span></span> 30 /* Seconds between errors logging. */</span></td></tr>
<tr class="codeline" data-linenumber="338"><td class="num" id="LN338">338</td><td class="line"><span class='keyword'>void</span> flushAppendOnlyFile(<span class='keyword'>int</span> force) {</td></tr>
<tr class="codeline" data-linenumber="339"><td class="num" id="LN339">339</td><td class="line">    ssize_t nwritten;</td></tr>
<tr class="codeline" data-linenumber="340"><td class="num" id="LN340">340</td><td class="line">    <span class='keyword'>int</span> sync_in_progress = 0;</td></tr>
<tr class="codeline" data-linenumber="341"><td class="num" id="LN341">341</td><td class="line">    mstime_t latency;</td></tr>
<tr class="codeline" data-linenumber="342"><td class="num" id="LN342">342</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="343"><td class="num" id="LN343">343</td><td class="line">    <span class='keyword'>if</span> (sdslen(server.aof_buf) == 0) {</td></tr>
<tr class="codeline" data-linenumber="344"><td class="num" id="LN344">344</td><td class="line">        <span class='comment'>/* Check if we need to do fsync even the aof buffer is empty,</span></td></tr>
<tr class="codeline" data-linenumber="345"><td class="num" id="LN345">345</td><td class="line">         <span class='comment'>* because previously in AOF_FSYNC_EVERYSEC mode, fsync is</span></td></tr>
<tr class="codeline" data-linenumber="346"><td class="num" id="LN346">346</td><td class="line">         <span class='comment'>* called only when aof buffer is not empty, so if users</span></td></tr>
<tr class="codeline" data-linenumber="347"><td class="num" id="LN347">347</td><td class="line">         <span class='comment'>* stop write commands before fsync called in one second,</span></td></tr>
<tr class="codeline" data-linenumber="348"><td class="num" id="LN348">348</td><td class="line">         <span class='comment'>* the data in page cache cannot be flushed in time. */</span></td></tr>
<tr class="codeline" data-linenumber="349"><td class="num" id="LN349">349</td><td class="line">        <span class='keyword'>if</span> (server.aof_fsync == <span class='macro'>AOF_FSYNC_EVERYSEC<span class='macro_popup'>2</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="350"><td class="num" id="LN350">350</td><td class="line">            server.aof_fsync_offset != server.aof_current_size &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="351"><td class="num" id="LN351">351</td><td class="line">            server.unixtime &gt; server.aof_last_fsync &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="352"><td class="num" id="LN352">352</td><td class="line">            !(sync_in_progress = aofFsyncInProgress())) {</td></tr>
<tr class="codeline" data-linenumber="353"><td class="num" id="LN353">353</td><td class="line">            <span class='keyword'>goto</span> try_fsync;</td></tr>
<tr class="codeline" data-linenumber="354"><td class="num" id="LN354">354</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="355"><td class="num" id="LN355">355</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="356"><td class="num" id="LN356">356</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="357"><td class="num" id="LN357">357</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="358"><td class="num" id="LN358">358</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="359"><td class="num" id="LN359">359</td><td class="line">    <span class='keyword'>if</span> (server.aof_fsync == <span class='macro'>AOF_FSYNC_EVERYSEC<span class='macro_popup'>2</span></span>)</td></tr>
<tr class="codeline" data-linenumber="360"><td class="num" id="LN360">360</td><td class="line">        sync_in_progress = aofFsyncInProgress();</td></tr>
<tr class="codeline" data-linenumber="361"><td class="num" id="LN361">361</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="362"><td class="num" id="LN362">362</td><td class="line">    <span class='keyword'>if</span> (server.aof_fsync == <span class='macro'>AOF_FSYNC_EVERYSEC<span class='macro_popup'>2</span></span> &amp;&amp; !force) {</td></tr>
<tr class="codeline" data-linenumber="363"><td class="num" id="LN363">363</td><td class="line">        <span class='comment'>/* With this append fsync policy we do background fsyncing.</span></td></tr>
<tr class="codeline" data-linenumber="364"><td class="num" id="LN364">364</td><td class="line">         <span class='comment'>* If the fsync is still in progress we can try to delay</span></td></tr>
<tr class="codeline" data-linenumber="365"><td class="num" id="LN365">365</td><td class="line">         <span class='comment'>* the write for a couple of seconds. */</span></td></tr>
<tr class="codeline" data-linenumber="366"><td class="num" id="LN366">366</td><td class="line">        <span class='keyword'>if</span> (sync_in_progress) {</td></tr>
<tr class="codeline" data-linenumber="367"><td class="num" id="LN367">367</td><td class="line">            <span class='keyword'>if</span> (server.aof_flush_postponed_start == 0) {</td></tr>
<tr class="codeline" data-linenumber="368"><td class="num" id="LN368">368</td><td class="line">                <span class='comment'>/* No previous write postponing, remember that we are</span></td></tr>
<tr class="codeline" data-linenumber="369"><td class="num" id="LN369">369</td><td class="line">                 <span class='comment'>* postponing the flush and return. */</span></td></tr>
<tr class="codeline" data-linenumber="370"><td class="num" id="LN370">370</td><td class="line">                server.aof_flush_postponed_start = server.unixtime;</td></tr>
<tr class="codeline" data-linenumber="371"><td class="num" id="LN371">371</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="372"><td class="num" id="LN372">372</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (server.unixtime - server.aof_flush_postponed_start &lt; 2) {</td></tr>
<tr class="codeline" data-linenumber="373"><td class="num" id="LN373">373</td><td class="line">                <span class='comment'>/* We were already waiting for fsync to finish, but for less</span></td></tr>
<tr class="codeline" data-linenumber="374"><td class="num" id="LN374">374</td><td class="line">                 <span class='comment'>* than two seconds this is still ok. Postpone again. */</span></td></tr>
<tr class="codeline" data-linenumber="375"><td class="num" id="LN375">375</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="376"><td class="num" id="LN376">376</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="377"><td class="num" id="LN377">377</td><td class="line">            <span class='comment'>/* Otherwise fall trough, and go write since we can't wait</span></td></tr>
<tr class="codeline" data-linenumber="378"><td class="num" id="LN378">378</td><td class="line">             <span class='comment'>* over two seconds. */</span></td></tr>
<tr class="codeline" data-linenumber="379"><td class="num" id="LN379">379</td><td class="line">            server.aof_delayed_fsync++;</td></tr>
<tr class="codeline" data-linenumber="380"><td class="num" id="LN380">380</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Asynchronous AOF fsync is taking too long (disk is busy?). Writing the AOF buffer without waiting for fsync to complete, this may slow down Redis."</span>);</td></tr>
<tr class="codeline" data-linenumber="381"><td class="num" id="LN381">381</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="382"><td class="num" id="LN382">382</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="383"><td class="num" id="LN383">383</td><td class="line">    <span class='comment'>/* We want to perform a single write. This should be guaranteed atomic</span></td></tr>
<tr class="codeline" data-linenumber="384"><td class="num" id="LN384">384</td><td class="line">     <span class='comment'>* at least if the filesystem we are writing is a real physical one.</span></td></tr>
<tr class="codeline" data-linenumber="385"><td class="num" id="LN385">385</td><td class="line">     <span class='comment'>* While this will save us against the server being killed I don't think</span></td></tr>
<tr class="codeline" data-linenumber="386"><td class="num" id="LN386">386</td><td class="line">     <span class='comment'>* there is much to do about the whole server stopping for power problems</span></td></tr>
<tr class="codeline" data-linenumber="387"><td class="num" id="LN387">387</td><td class="line">     <span class='comment'>* or alike */</span></td></tr>
<tr class="codeline" data-linenumber="388"><td class="num" id="LN388">388</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="389"><td class="num" id="LN389">389</td><td class="line">    <span class='keyword'>if</span> (server.aof_flush_sleep &amp;&amp; sdslen(server.aof_buf)) {</td></tr>
<tr class="codeline" data-linenumber="390"><td class="num" id="LN390">390</td><td class="line">        usleep(server.aof_flush_sleep);</td></tr>
<tr class="codeline" data-linenumber="391"><td class="num" id="LN391">391</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="392"><td class="num" id="LN392">392</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="393"><td class="num" id="LN393">393</td><td class="line">    <span class='macro'>latencyStartMonitor(latency)<span class='macro_popup'>if (server.latency_monitor_threshold) { latency = mstime(); }<br> else { latency = 0; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="394"><td class="num" id="LN394">394</td><td class="line">    nwritten = aofWrite(server.aof_fd,server.aof_buf,sdslen(server.aof_buf));</td></tr>
<tr class="codeline" data-linenumber="395"><td class="num" id="LN395">395</td><td class="line">    <span class='macro'>latencyEndMonitor(latency)<span class='macro_popup'>if (server.latency_monitor_threshold) { latency = mstime() - latency<br>; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="396"><td class="num" id="LN396">396</td><td class="line">    <span class='comment'>/* We want to capture different events for delayed writes:</span></td></tr>
<tr class="codeline" data-linenumber="397"><td class="num" id="LN397">397</td><td class="line">     <span class='comment'>* when the delay happens with a pending fsync, or with a saving child</span></td></tr>
<tr class="codeline" data-linenumber="398"><td class="num" id="LN398">398</td><td class="line">     <span class='comment'>* active, and when the above two conditions are missing.</span></td></tr>
<tr class="codeline" data-linenumber="399"><td class="num" id="LN399">399</td><td class="line">     <span class='comment'>* We also use an additional event name to save all samples which is</span></td></tr>
<tr class="codeline" data-linenumber="400"><td class="num" id="LN400">400</td><td class="line">     <span class='comment'>* useful for graphing / monitoring purposes. */</span></td></tr>
<tr class="codeline" data-linenumber="401"><td class="num" id="LN401">401</td><td class="line">    <span class='keyword'>if</span> (sync_in_progress) {</td></tr>
<tr class="codeline" data-linenumber="402"><td class="num" id="LN402">402</td><td class="line">        <span class='macro'>latencyAddSampleIfNeeded(<span class='string_literal'>"aof-write-pending-fsync"</span>,latency)<span class='macro_popup'>if (server.latency_monitor_threshold &amp;&amp; (latency) &gt;=<br> server.latency_monitor_threshold) latencyAddSample(("aof-write-pending-fsync"<br>),(latency));</span></span>;</td></tr>
<tr class="codeline" data-linenumber="403"><td class="num" id="LN403">403</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (hasActiveChildProcess()) {</td></tr>
<tr class="codeline" data-linenumber="404"><td class="num" id="LN404">404</td><td class="line">        <span class='macro'>latencyAddSampleIfNeeded(<span class='string_literal'>"aof-write-active-child"</span>,latency)<span class='macro_popup'>if (server.latency_monitor_threshold &amp;&amp; (latency) &gt;=<br> server.latency_monitor_threshold) latencyAddSample(("aof-write-active-child"<br>),(latency));</span></span>;</td></tr>
<tr class="codeline" data-linenumber="405"><td class="num" id="LN405">405</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="406"><td class="num" id="LN406">406</td><td class="line">        <span class='macro'>latencyAddSampleIfNeeded(<span class='string_literal'>"aof-write-alone"</span>,latency)<span class='macro_popup'>if (server.latency_monitor_threshold &amp;&amp; (latency) &gt;=<br> server.latency_monitor_threshold) latencyAddSample(("aof-write-alone"<br>),(latency));</span></span>;</td></tr>
<tr class="codeline" data-linenumber="407"><td class="num" id="LN407">407</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="408"><td class="num" id="LN408">408</td><td class="line">    <span class='macro'>latencyAddSampleIfNeeded(<span class='string_literal'>"aof-write"</span>,latency)<span class='macro_popup'>if (server.latency_monitor_threshold &amp;&amp; (latency) &gt;=<br> server.latency_monitor_threshold) latencyAddSample(("aof-write"<br>),(latency));</span></span>;</td></tr>
<tr class="codeline" data-linenumber="409"><td class="num" id="LN409">409</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="410"><td class="num" id="LN410">410</td><td class="line">    <span class='comment'>/* We performed the write so reset the postponed flush sentinel to zero. */</span></td></tr>
<tr class="codeline" data-linenumber="411"><td class="num" id="LN411">411</td><td class="line">    server.aof_flush_postponed_start = 0;</td></tr>
<tr class="codeline" data-linenumber="412"><td class="num" id="LN412">412</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="413"><td class="num" id="LN413">413</td><td class="line">    <span class='keyword'>if</span> (nwritten != (ssize_t)sdslen(server.aof_buf)) {</td></tr>
<tr class="codeline" data-linenumber="414"><td class="num" id="LN414">414</td><td class="line">        <span class='keyword'>static</span> time_t last_write_error_log = 0;</td></tr>
<tr class="codeline" data-linenumber="415"><td class="num" id="LN415">415</td><td class="line">        <span class='keyword'>int</span> can_log = 0;</td></tr>
<tr class="codeline" data-linenumber="416"><td class="num" id="LN416">416</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="417"><td class="num" id="LN417">417</td><td class="line">        <span class='comment'>/* Limit logging rate to 1 line per AOF_WRITE_LOG_ERROR_RATE seconds. */</span></td></tr>
<tr class="codeline" data-linenumber="418"><td class="num" id="LN418">418</td><td class="line">        <span class='keyword'>if</span> ((server.unixtime - last_write_error_log) &gt; <span class='macro'>AOF_WRITE_LOG_ERROR_RATE<span class='macro_popup'>30</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="419"><td class="num" id="LN419">419</td><td class="line">            can_log = 1;</td></tr>
<tr class="codeline" data-linenumber="420"><td class="num" id="LN420">420</td><td class="line">            last_write_error_log = server.unixtime;</td></tr>
<tr class="codeline" data-linenumber="421"><td class="num" id="LN421">421</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="422"><td class="num" id="LN422">422</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="423"><td class="num" id="LN423">423</td><td class="line">        <span class='comment'>/* Log the AOF write error and record the error code. */</span></td></tr>
<tr class="codeline" data-linenumber="424"><td class="num" id="LN424">424</td><td class="line">        <span class='keyword'>if</span> (nwritten == -1) {</td></tr>
<tr class="codeline" data-linenumber="425"><td class="num" id="LN425">425</td><td class="line">            <span class='keyword'>if</span> (can_log) {</td></tr>
<tr class="codeline" data-linenumber="426"><td class="num" id="LN426">426</td><td class="line">                serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Error writing to the AOF file: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="427"><td class="num" id="LN427">427</td><td class="line">                    strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="428"><td class="num" id="LN428">428</td><td class="line">                server.aof_last_write_errno = <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>;</td></tr>
<tr class="codeline" data-linenumber="429"><td class="num" id="LN429">429</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="430"><td class="num" id="LN430">430</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="431"><td class="num" id="LN431">431</td><td class="line">            <span class='keyword'>if</span> (can_log) {</td></tr>
<tr class="codeline" data-linenumber="432"><td class="num" id="LN432">432</td><td class="line">                serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Short write while writing to "</span></td></tr>
<tr class="codeline" data-linenumber="433"><td class="num" id="LN433">433</td><td class="line">                                       <span class='string_literal'>"the AOF file: (nwritten=%lld, "</span></td></tr>
<tr class="codeline" data-linenumber="434"><td class="num" id="LN434">434</td><td class="line">                                       <span class='string_literal'>"expected=%lld)"</span>,</td></tr>
<tr class="codeline" data-linenumber="435"><td class="num" id="LN435">435</td><td class="line">                                       (<span class='keyword'>long</span> <span class='keyword'>long</span>)nwritten,</td></tr>
<tr class="codeline" data-linenumber="436"><td class="num" id="LN436">436</td><td class="line">                                       (<span class='keyword'>long</span> <span class='keyword'>long</span>)sdslen(server.aof_buf));</td></tr>
<tr class="codeline" data-linenumber="437"><td class="num" id="LN437">437</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="438"><td class="num" id="LN438">438</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="439"><td class="num" id="LN439">439</td><td class="line">            <span class='keyword'>if</span> (ftruncate(server.aof_fd, server.aof_current_size) == -1) {</td></tr>
<tr class="codeline" data-linenumber="440"><td class="num" id="LN440">440</td><td class="line">                <span class='keyword'>if</span> (can_log) {</td></tr>
<tr class="codeline" data-linenumber="441"><td class="num" id="LN441">441</td><td class="line">                    serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>, <span class='string_literal'>"Could not remove short write "</span></td></tr>
<tr class="codeline" data-linenumber="442"><td class="num" id="LN442">442</td><td class="line">                             <span class='string_literal'>"from the append-only file.  Redis may refuse "</span></td></tr>
<tr class="codeline" data-linenumber="443"><td class="num" id="LN443">443</td><td class="line">                             <span class='string_literal'>"to load the AOF the next time it starts.  "</span></td></tr>
<tr class="codeline" data-linenumber="444"><td class="num" id="LN444">444</td><td class="line">                             <span class='string_literal'>"ftruncate: %s"</span>, strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="445"><td class="num" id="LN445">445</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="446"><td class="num" id="LN446">446</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="447"><td class="num" id="LN447">447</td><td class="line">                <span class='comment'>/* If the ftruncate() succeeded we can set nwritten to</span></td></tr>
<tr class="codeline" data-linenumber="448"><td class="num" id="LN448">448</td><td class="line">                 <span class='comment'>* -1 since there is no longer partial data into the AOF. */</span></td></tr>
<tr class="codeline" data-linenumber="449"><td class="num" id="LN449">449</td><td class="line">                nwritten = -1;</td></tr>
<tr class="codeline" data-linenumber="450"><td class="num" id="LN450">450</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="451"><td class="num" id="LN451">451</td><td class="line">            server.aof_last_write_errno = <span class='macro'>ENOSPC<span class='macro_popup'>28</span></span>;</td></tr>
<tr class="codeline" data-linenumber="452"><td class="num" id="LN452">452</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="453"><td class="num" id="LN453">453</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="454"><td class="num" id="LN454">454</td><td class="line">        <span class='comment'>/* Handle the AOF write error. */</span></td></tr>
<tr class="codeline" data-linenumber="455"><td class="num" id="LN455">455</td><td class="line">        <span class='keyword'>if</span> (server.aof_fsync == <span class='macro'>AOF_FSYNC_ALWAYS<span class='macro_popup'>1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="456"><td class="num" id="LN456">456</td><td class="line">            <span class='comment'>/* We can't recover when the fsync policy is ALWAYS since the</span></td></tr>
<tr class="codeline" data-linenumber="457"><td class="num" id="LN457">457</td><td class="line">             <span class='comment'>* reply for the client is already in the output buffers, and we</span></td></tr>
<tr class="codeline" data-linenumber="458"><td class="num" id="LN458">458</td><td class="line">             <span class='comment'>* have the contract with the user that on acknowledged write data</span></td></tr>
<tr class="codeline" data-linenumber="459"><td class="num" id="LN459">459</td><td class="line">             <span class='comment'>* is synced on disk. */</span></td></tr>
<tr class="codeline" data-linenumber="460"><td class="num" id="LN460">460</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Can't recover from AOF write error when the AOF fsync policy is 'always'. Exiting..."</span>);</td></tr>
<tr class="codeline" data-linenumber="461"><td class="num" id="LN461">461</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="462"><td class="num" id="LN462">462</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="463"><td class="num" id="LN463">463</td><td class="line">            <span class='comment'>/* Recover from failed write leaving data into the buffer. However</span></td></tr>
<tr class="codeline" data-linenumber="464"><td class="num" id="LN464">464</td><td class="line">             <span class='comment'>* set an error to stop accepting writes as long as the error</span></td></tr>
<tr class="codeline" data-linenumber="465"><td class="num" id="LN465">465</td><td class="line">             <span class='comment'>* condition is not cleared. */</span></td></tr>
<tr class="codeline" data-linenumber="466"><td class="num" id="LN466">466</td><td class="line">            server.aof_last_write_status = <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="467"><td class="num" id="LN467">467</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="468"><td class="num" id="LN468">468</td><td class="line">            <span class='comment'>/* Trim the sds buffer if there was a partial write, and there</span></td></tr>
<tr class="codeline" data-linenumber="469"><td class="num" id="LN469">469</td><td class="line">             <span class='comment'>* was no way to undo it with ftruncate(2). */</span></td></tr>
<tr class="codeline" data-linenumber="470"><td class="num" id="LN470">470</td><td class="line">            <span class='keyword'>if</span> (nwritten &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="471"><td class="num" id="LN471">471</td><td class="line">                server.aof_current_size += nwritten;</td></tr>
<tr class="codeline" data-linenumber="472"><td class="num" id="LN472">472</td><td class="line">                sdsrange(server.aof_buf,nwritten,-1);</td></tr>
<tr class="codeline" data-linenumber="473"><td class="num" id="LN473">473</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="474"><td class="num" id="LN474">474</td><td class="line">            <span class='keyword'>return</span>; <span class='comment'>/* We'll try again on the next call... */</span></td></tr>
<tr class="codeline" data-linenumber="475"><td class="num" id="LN475">475</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="476"><td class="num" id="LN476">476</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="477"><td class="num" id="LN477">477</td><td class="line">        <span class='comment'>/* Successful write(2). If AOF was in error state, restore the</span></td></tr>
<tr class="codeline" data-linenumber="478"><td class="num" id="LN478">478</td><td class="line">         <span class='comment'>* OK state and log the event. */</span></td></tr>
<tr class="codeline" data-linenumber="479"><td class="num" id="LN479">479</td><td class="line">        <span class='keyword'>if</span> (server.aof_last_write_status == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="480"><td class="num" id="LN480">480</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="481"><td class="num" id="LN481">481</td><td class="line">                <span class='string_literal'>"AOF write error looks solved, Redis can write again."</span>);</td></tr>
<tr class="codeline" data-linenumber="482"><td class="num" id="LN482">482</td><td class="line">            server.aof_last_write_status = <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="483"><td class="num" id="LN483">483</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="484"><td class="num" id="LN484">484</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="485"><td class="num" id="LN485">485</td><td class="line">    server.aof_current_size += nwritten;</td></tr>
<tr class="codeline" data-linenumber="486"><td class="num" id="LN486">486</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="487"><td class="num" id="LN487">487</td><td class="line">    <span class='comment'>/* Re-use AOF buffer when it is small enough. The maximum comes from the</span></td></tr>
<tr class="codeline" data-linenumber="488"><td class="num" id="LN488">488</td><td class="line">     <span class='comment'>* arena size of 4k minus some overhead (but is otherwise arbitrary). */</span></td></tr>
<tr class="codeline" data-linenumber="489"><td class="num" id="LN489">489</td><td class="line">    <span class='keyword'>if</span> ((sdslen(server.aof_buf)+sdsavail(server.aof_buf)) &lt; 4000) {</td></tr>
<tr class="codeline" data-linenumber="490"><td class="num" id="LN490">490</td><td class="line">        sdsclear(server.aof_buf);</td></tr>
<tr class="codeline" data-linenumber="491"><td class="num" id="LN491">491</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="492"><td class="num" id="LN492">492</td><td class="line">        sdsfree(server.aof_buf);</td></tr>
<tr class="codeline" data-linenumber="493"><td class="num" id="LN493">493</td><td class="line">        server.aof_buf = sdsempty();</td></tr>
<tr class="codeline" data-linenumber="494"><td class="num" id="LN494">494</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="495"><td class="num" id="LN495">495</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="496"><td class="num" id="LN496">496</td><td class="line">try_fsync:</td></tr>
<tr class="codeline" data-linenumber="497"><td class="num" id="LN497">497</td><td class="line">    <span class='comment'>/* Don't fsync if no-appendfsync-on-rewrite is set to yes and there are</span></td></tr>
<tr class="codeline" data-linenumber="498"><td class="num" id="LN498">498</td><td class="line">     <span class='comment'>* children doing I/O in the background. */</span></td></tr>
<tr class="codeline" data-linenumber="499"><td class="num" id="LN499">499</td><td class="line">    <span class='keyword'>if</span> (server.aof_no_fsync_on_rewrite &amp;&amp; hasActiveChildProcess())</td></tr>
<tr class="codeline" data-linenumber="500"><td class="num" id="LN500">500</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="501"><td class="num" id="LN501">501</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="502"><td class="num" id="LN502">502</td><td class="line">    <span class='comment'>/* Perform the fsync if needed. */</span></td></tr>
<tr class="codeline" data-linenumber="503"><td class="num" id="LN503">503</td><td class="line">    <span class='keyword'>if</span> (server.aof_fsync == <span class='macro'>AOF_FSYNC_ALWAYS<span class='macro_popup'>1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="504"><td class="num" id="LN504">504</td><td class="line">        <span class='comment'>/* redis_fsync is defined as fdatasync() for Linux in order to avoid</span></td></tr>
<tr class="codeline" data-linenumber="505"><td class="num" id="LN505">505</td><td class="line">         <span class='comment'>* flushing metadata. */</span></td></tr>
<tr class="codeline" data-linenumber="506"><td class="num" id="LN506">506</td><td class="line">        <span class='macro'>latencyStartMonitor(latency)<span class='macro_popup'>if (server.latency_monitor_threshold) { latency = mstime(); }<br> else { latency = 0; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="507"><td class="num" id="LN507">507</td><td class="line">        <span class='macro'>redis_fsync<span class='macro_popup'>fdatasync</span></span>(server.aof_fd); <span class='comment'>/* Let's try to get this data on the disk */</span></td></tr>
<tr class="codeline" data-linenumber="508"><td class="num" id="LN508">508</td><td class="line">        <span class='macro'>latencyEndMonitor(latency)<span class='macro_popup'>if (server.latency_monitor_threshold) { latency = mstime() - latency<br>; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="509"><td class="num" id="LN509">509</td><td class="line">        <span class='macro'>latencyAddSampleIfNeeded(<span class='string_literal'>"aof-fsync-always"</span>,latency)<span class='macro_popup'>if (server.latency_monitor_threshold &amp;&amp; (latency) &gt;=<br> server.latency_monitor_threshold) latencyAddSample(("aof-fsync-always"<br>),(latency));</span></span>;</td></tr>
<tr class="codeline" data-linenumber="510"><td class="num" id="LN510">510</td><td class="line">        server.aof_fsync_offset = server.aof_current_size;</td></tr>
<tr class="codeline" data-linenumber="511"><td class="num" id="LN511">511</td><td class="line">        server.aof_last_fsync = server.unixtime;</td></tr>
<tr class="codeline" data-linenumber="512"><td class="num" id="LN512">512</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> ((server.aof_fsync == <span class='macro'>AOF_FSYNC_EVERYSEC<span class='macro_popup'>2</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="513"><td class="num" id="LN513">513</td><td class="line">                server.unixtime &gt; server.aof_last_fsync)) {</td></tr>
<tr class="codeline" data-linenumber="514"><td class="num" id="LN514">514</td><td class="line">        <span class='keyword'>if</span> (!sync_in_progress) {</td></tr>
<tr class="codeline" data-linenumber="515"><td class="num" id="LN515">515</td><td class="line">            aof_background_fsync(server.aof_fd);</td></tr>
<tr class="codeline" data-linenumber="516"><td class="num" id="LN516">516</td><td class="line">            server.aof_fsync_offset = server.aof_current_size;</td></tr>
<tr class="codeline" data-linenumber="517"><td class="num" id="LN517">517</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="518"><td class="num" id="LN518">518</td><td class="line">        server.aof_last_fsync = server.unixtime;</td></tr>
<tr class="codeline" data-linenumber="519"><td class="num" id="LN519">519</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="520"><td class="num" id="LN520">520</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="521"><td class="num" id="LN521">521</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="522"><td class="num" id="LN522">522</td><td class="line">sds catAppendOnlyGenericCommand(sds dst, <span class='keyword'>int</span> argc, robj **argv) {</td></tr>
<tr class="codeline" data-linenumber="523"><td class="num" id="LN523">523</td><td class="line">    <span class='keyword'>char</span> buf[32];</td></tr>
<tr class="codeline" data-linenumber="524"><td class="num" id="LN524">524</td><td class="line">    <span class='keyword'>int</span> len, j;</td></tr>
<tr class="codeline" data-linenumber="525"><td class="num" id="LN525">525</td><td class="line">    robj *o;</td></tr>
<tr class="codeline" data-linenumber="526"><td class="num" id="LN526">526</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="527"><td class="num" id="LN527">527</td><td class="line">    buf[0] = '*';</td></tr>
<tr class="codeline" data-linenumber="528"><td class="num" id="LN528">528</td><td class="line">    len = 1+ll2string(buf+1,<span class='keyword'>sizeof</span>(buf)-1,argc);</td></tr>
<tr class="codeline" data-linenumber="529"><td class="num" id="LN529">529</td><td class="line">    buf[len++] = '\r';</td></tr>
<tr class="codeline" data-linenumber="530"><td class="num" id="LN530">530</td><td class="line">    buf[len++] = '\n';</td></tr>
<tr class="codeline" data-linenumber="531"><td class="num" id="LN531">531</td><td class="line">    dst = sdscatlen(dst,buf,len);</td></tr>
<tr class="codeline" data-linenumber="532"><td class="num" id="LN532">532</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="533"><td class="num" id="LN533">533</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; argc; j++) {</td></tr>
<tr class="codeline" data-linenumber="534"><td class="num" id="LN534">534</td><td class="line">        o = getDecodedObject(argv[j]);</td></tr>
<tr class="codeline" data-linenumber="535"><td class="num" id="LN535">535</td><td class="line">        buf[0] = '$';</td></tr>
<tr class="codeline" data-linenumber="536"><td class="num" id="LN536">536</td><td class="line">        len = 1+ll2string(buf+1,<span class='keyword'>sizeof</span>(buf)-1,sdslen(o-&gt;ptr));</td></tr>
<tr class="codeline" data-linenumber="537"><td class="num" id="LN537">537</td><td class="line">        buf[len++] = '\r';</td></tr>
<tr class="codeline" data-linenumber="538"><td class="num" id="LN538">538</td><td class="line">        buf[len++] = '\n';</td></tr>
<tr class="codeline" data-linenumber="539"><td class="num" id="LN539">539</td><td class="line">        dst = sdscatlen(dst,buf,len);</td></tr>
<tr class="codeline" data-linenumber="540"><td class="num" id="LN540">540</td><td class="line">        dst = sdscatlen(dst,o-&gt;ptr,sdslen(o-&gt;ptr));</td></tr>
<tr class="codeline" data-linenumber="541"><td class="num" id="LN541">541</td><td class="line">        dst = sdscatlen(dst,<span class='string_literal'>"\r\n"</span>,2);</td></tr>
<tr class="codeline" data-linenumber="542"><td class="num" id="LN542">542</td><td class="line">        decrRefCount(o);</td></tr>
<tr class="codeline" data-linenumber="543"><td class="num" id="LN543">543</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="544"><td class="num" id="LN544">544</td><td class="line">    <span class='keyword'>return</span> dst;</td></tr>
<tr class="codeline" data-linenumber="545"><td class="num" id="LN545">545</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="546"><td class="num" id="LN546">546</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="547"><td class="num" id="LN547">547</td><td class="line"><span class='comment'>/* Create the sds representation of a PEXPIREAT command, using</span></td></tr>
<tr class="codeline" data-linenumber="548"><td class="num" id="LN548">548</td><td class="line"> <span class='comment'>* 'seconds' as time to live and 'cmd' to understand what command</span></td></tr>
<tr class="codeline" data-linenumber="549"><td class="num" id="LN549">549</td><td class="line"> <span class='comment'>* we are translating into a PEXPIREAT.</span></td></tr>
<tr class="codeline" data-linenumber="550"><td class="num" id="LN550">550</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="551"><td class="num" id="LN551">551</td><td class="line"> <span class='comment'>* This command is used in order to translate EXPIRE and PEXPIRE commands</span></td></tr>
<tr class="codeline" data-linenumber="552"><td class="num" id="LN552">552</td><td class="line"> <span class='comment'>* into PEXPIREAT command so that we retain precision in the append only</span></td></tr>
<tr class="codeline" data-linenumber="553"><td class="num" id="LN553">553</td><td class="line"> <span class='comment'>* file, and the time is always absolute and not relative. */</span></td></tr>
<tr class="codeline" data-linenumber="554"><td class="num" id="LN554">554</td><td class="line">sds catAppendOnlyExpireAtCommand(sds buf, <span class='keyword'>struct</span> redisCommand *cmd, robj *key, robj *seconds) {</td></tr>
<tr class="codeline" data-linenumber="555"><td class="num" id="LN555">555</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> when;</td></tr>
<tr class="codeline" data-linenumber="556"><td class="num" id="LN556">556</td><td class="line">    robj *argv[3];</td></tr>
<tr class="codeline" data-linenumber="557"><td class="num" id="LN557">557</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="558"><td class="num" id="LN558">558</td><td class="line">    <span class='comment'>/* Make sure we can use strtoll */</span></td></tr>
<tr class="codeline" data-linenumber="559"><td class="num" id="LN559">559</td><td class="line">    seconds = getDecodedObject(seconds);</td></tr>
<tr class="codeline" data-linenumber="560"><td class="num" id="LN560">560</td><td class="line">    when = strtoll(seconds-&gt;ptr,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,10);</td></tr>
<tr class="codeline" data-linenumber="561"><td class="num" id="LN561">561</td><td class="line">    <span class='comment'>/* Convert argument into milliseconds for EXPIRE, SETEX, EXPIREAT */</span></td></tr>
<tr class="codeline" data-linenumber="562"><td class="num" id="LN562">562</td><td class="line">    <span class='keyword'>if</span> (cmd-&gt;proc == expireCommand || cmd-&gt;proc == setexCommand ||</td></tr>
<tr class="codeline" data-linenumber="563"><td class="num" id="LN563">563</td><td class="line">        cmd-&gt;proc == expireatCommand)</td></tr>
<tr class="codeline" data-linenumber="564"><td class="num" id="LN564">564</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="565"><td class="num" id="LN565">565</td><td class="line">        when *= 1000;</td></tr>
<tr class="codeline" data-linenumber="566"><td class="num" id="LN566">566</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="567"><td class="num" id="LN567">567</td><td class="line">    <span class='comment'>/* Convert into absolute time for EXPIRE, PEXPIRE, SETEX, PSETEX */</span></td></tr>
<tr class="codeline" data-linenumber="568"><td class="num" id="LN568">568</td><td class="line">    <span class='keyword'>if</span> (cmd-&gt;proc == expireCommand || cmd-&gt;proc == pexpireCommand ||</td></tr>
<tr class="codeline" data-linenumber="569"><td class="num" id="LN569">569</td><td class="line">        cmd-&gt;proc == setexCommand || cmd-&gt;proc == psetexCommand)</td></tr>
<tr class="codeline" data-linenumber="570"><td class="num" id="LN570">570</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="571"><td class="num" id="LN571">571</td><td class="line">        when += mstime();</td></tr>
<tr class="codeline" data-linenumber="572"><td class="num" id="LN572">572</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="573"><td class="num" id="LN573">573</td><td class="line">    decrRefCount(seconds);</td></tr>
<tr class="codeline" data-linenumber="574"><td class="num" id="LN574">574</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="575"><td class="num" id="LN575">575</td><td class="line">    argv[0] = createStringObject(<span class='string_literal'>"PEXPIREAT"</span>,9);</td></tr>
<tr class="codeline" data-linenumber="576"><td class="num" id="LN576">576</td><td class="line">    argv[1] = key;</td></tr>
<tr class="codeline" data-linenumber="577"><td class="num" id="LN577">577</td><td class="line">    argv[2] = createStringObjectFromLongLong(when);</td></tr>
<tr class="codeline" data-linenumber="578"><td class="num" id="LN578">578</td><td class="line">    buf = catAppendOnlyGenericCommand(buf, 3, argv);</td></tr>
<tr class="codeline" data-linenumber="579"><td class="num" id="LN579">579</td><td class="line">    decrRefCount(argv[0]);</td></tr>
<tr class="codeline" data-linenumber="580"><td class="num" id="LN580">580</td><td class="line">    decrRefCount(argv[2]);</td></tr>
<tr class="codeline" data-linenumber="581"><td class="num" id="LN581">581</td><td class="line">    <span class='keyword'>return</span> buf;</td></tr>
<tr class="codeline" data-linenumber="582"><td class="num" id="LN582">582</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="583"><td class="num" id="LN583">583</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="584"><td class="num" id="LN584">584</td><td class="line"><span class='keyword'>void</span> feedAppendOnlyFile(<span class='keyword'>struct</span> redisCommand *cmd, <span class='keyword'>int</span> dictid, robj **argv, <span class='keyword'>int</span> argc) {</td></tr>
<tr class="codeline" data-linenumber="585"><td class="num" id="LN585">585</td><td class="line">    sds buf = sdsempty();</td></tr>
<tr class="codeline" data-linenumber="586"><td class="num" id="LN586">586</td><td class="line">    robj *tmpargv[3];</td></tr>
<tr class="codeline" data-linenumber="587"><td class="num" id="LN587">587</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="588"><td class="num" id="LN588">588</td><td class="line">    <span class='comment'>/* The DB this command was targeting is not the same as the last command</span></td></tr>
<tr class="codeline" data-linenumber="589"><td class="num" id="LN589">589</td><td class="line">     <span class='comment'>* we appended. To issue a SELECT command is needed. */</span></td></tr>
<tr class="codeline" data-linenumber="590"><td class="num" id="LN590">590</td><td class="line">    <span class='keyword'>if</span> (dictid != server.aof_selected_db) {</td></tr>
<tr class="codeline" data-linenumber="591"><td class="num" id="LN591">591</td><td class="line">        <span class='keyword'>char</span> seldb[64];</td></tr>
<tr class="codeline" data-linenumber="592"><td class="num" id="LN592">592</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="593"><td class="num" id="LN593">593</td><td class="line">        snprintf(seldb,<span class='keyword'>sizeof</span>(seldb),<span class='string_literal'>"%d"</span>,dictid);</td></tr>
<tr class="codeline" data-linenumber="594"><td class="num" id="LN594">594</td><td class="line">        buf = sdscatprintf(buf,<span class='string_literal'>"*2\r\n$6\r\nSELECT\r\n$%lu\r\n%s\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="595"><td class="num" id="LN595">595</td><td class="line">            (<span class='keyword'>unsigned</span> <span class='keyword'>long</span>)strlen(seldb),seldb);</td></tr>
<tr class="codeline" data-linenumber="596"><td class="num" id="LN596">596</td><td class="line">        server.aof_selected_db = dictid;</td></tr>
<tr class="codeline" data-linenumber="597"><td class="num" id="LN597">597</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="598"><td class="num" id="LN598">598</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="599"><td class="num" id="LN599">599</td><td class="line">    <span class='keyword'>if</span> (cmd-&gt;proc == expireCommand || cmd-&gt;proc == pexpireCommand ||</td></tr>
<tr class="codeline" data-linenumber="600"><td class="num" id="LN600">600</td><td class="line">        cmd-&gt;proc == expireatCommand) {</td></tr>
<tr class="codeline" data-linenumber="601"><td class="num" id="LN601">601</td><td class="line">        <span class='comment'>/* Translate EXPIRE/PEXPIRE/EXPIREAT into PEXPIREAT */</span></td></tr>
<tr class="codeline" data-linenumber="602"><td class="num" id="LN602">602</td><td class="line">        buf = catAppendOnlyExpireAtCommand(buf,cmd,argv[1],argv[2]);</td></tr>
<tr class="codeline" data-linenumber="603"><td class="num" id="LN603">603</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (cmd-&gt;proc == setexCommand || cmd-&gt;proc == psetexCommand) {</td></tr>
<tr class="codeline" data-linenumber="604"><td class="num" id="LN604">604</td><td class="line">        <span class='comment'>/* Translate SETEX/PSETEX to SET and PEXPIREAT */</span></td></tr>
<tr class="codeline" data-linenumber="605"><td class="num" id="LN605">605</td><td class="line">        tmpargv[0] = createStringObject(<span class='string_literal'>"SET"</span>,3);</td></tr>
<tr class="codeline" data-linenumber="606"><td class="num" id="LN606">606</td><td class="line">        tmpargv[1] = argv[1];</td></tr>
<tr class="codeline" data-linenumber="607"><td class="num" id="LN607">607</td><td class="line">        tmpargv[2] = argv[3];</td></tr>
<tr class="codeline" data-linenumber="608"><td class="num" id="LN608">608</td><td class="line">        buf = catAppendOnlyGenericCommand(buf,3,tmpargv);</td></tr>
<tr class="codeline" data-linenumber="609"><td class="num" id="LN609">609</td><td class="line">        decrRefCount(tmpargv[0]);</td></tr>
<tr class="codeline" data-linenumber="610"><td class="num" id="LN610">610</td><td class="line">        buf = catAppendOnlyExpireAtCommand(buf,cmd,argv[1],argv[2]);</td></tr>
<tr class="codeline" data-linenumber="611"><td class="num" id="LN611">611</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (cmd-&gt;proc == setCommand &amp;&amp; argc &gt; 3) {</td></tr>
<tr class="codeline" data-linenumber="612"><td class="num" id="LN612">612</td><td class="line">        <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="613"><td class="num" id="LN613">613</td><td class="line">        robj *exarg = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, *pxarg = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="614"><td class="num" id="LN614">614</td><td class="line">        <span class='keyword'>for</span> (i = 3; i &lt; argc; i ++) {</td></tr>
<tr class="codeline" data-linenumber="615"><td class="num" id="LN615">615</td><td class="line">            <span class='keyword'>if</span> (!strcasecmp(argv[i]-&gt;ptr, <span class='string_literal'>"ex"</span>)) exarg = argv[i+1];</td></tr>
<tr class="codeline" data-linenumber="616"><td class="num" id="LN616">616</td><td class="line">            <span class='keyword'>if</span> (!strcasecmp(argv[i]-&gt;ptr, <span class='string_literal'>"px"</span>)) pxarg = argv[i+1];</td></tr>
<tr class="codeline" data-linenumber="617"><td class="num" id="LN617">617</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="618"><td class="num" id="LN618">618</td><td class="line">        <span class='macro'>serverAssert(!(exarg &amp;&amp; pxarg))<span class='macro_popup'>((!(exarg &amp;&amp; pxarg))?(void)0 : (_serverAssert("!(exarg &amp;&amp; pxarg)"<br>,"aof.c",618),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="619"><td class="num" id="LN619">619</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="620"><td class="num" id="LN620">620</td><td class="line">        <span class='keyword'>if</span> (exarg || pxarg) {</td></tr>
<tr class="codeline" data-linenumber="621"><td class="num" id="LN621">621</td><td class="line">            <span class='comment'>/* Translate SET [EX seconds][PX milliseconds] to SET and PEXPIREAT */</span></td></tr>
<tr class="codeline" data-linenumber="622"><td class="num" id="LN622">622</td><td class="line">            buf = catAppendOnlyGenericCommand(buf,3,argv);</td></tr>
<tr class="codeline" data-linenumber="623"><td class="num" id="LN623">623</td><td class="line">            <span class='keyword'>if</span> (exarg)</td></tr>
<tr class="codeline" data-linenumber="624"><td class="num" id="LN624">624</td><td class="line">                buf = catAppendOnlyExpireAtCommand(buf,server.expireCommand,argv[1],</td></tr>
<tr class="codeline" data-linenumber="625"><td class="num" id="LN625">625</td><td class="line">                                                   exarg);</td></tr>
<tr class="codeline" data-linenumber="626"><td class="num" id="LN626">626</td><td class="line">            <span class='keyword'>if</span> (pxarg)</td></tr>
<tr class="codeline" data-linenumber="627"><td class="num" id="LN627">627</td><td class="line">                buf = catAppendOnlyExpireAtCommand(buf,server.pexpireCommand,argv[1],</td></tr>
<tr class="codeline" data-linenumber="628"><td class="num" id="LN628">628</td><td class="line">                                                   pxarg);</td></tr>
<tr class="codeline" data-linenumber="629"><td class="num" id="LN629">629</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="630"><td class="num" id="LN630">630</td><td class="line">            buf = catAppendOnlyGenericCommand(buf,argc,argv);</td></tr>
<tr class="codeline" data-linenumber="631"><td class="num" id="LN631">631</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="632"><td class="num" id="LN632">632</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="633"><td class="num" id="LN633">633</td><td class="line">        <span class='comment'>/* All the other commands don't need translation or need the</span></td></tr>
<tr class="codeline" data-linenumber="634"><td class="num" id="LN634">634</td><td class="line">         <span class='comment'>* same translation already operated in the command vector</span></td></tr>
<tr class="codeline" data-linenumber="635"><td class="num" id="LN635">635</td><td class="line">         <span class='comment'>* for the replication itself. */</span></td></tr>
<tr class="codeline" data-linenumber="636"><td class="num" id="LN636">636</td><td class="line">        buf = catAppendOnlyGenericCommand(buf,argc,argv);</td></tr>
<tr class="codeline" data-linenumber="637"><td class="num" id="LN637">637</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="638"><td class="num" id="LN638">638</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="639"><td class="num" id="LN639">639</td><td class="line">    <span class='comment'>/* Append to the AOF buffer. This will be flushed on disk just before</span></td></tr>
<tr class="codeline" data-linenumber="640"><td class="num" id="LN640">640</td><td class="line">     <span class='comment'>* of re-entering the event loop, so before the client will get a</span></td></tr>
<tr class="codeline" data-linenumber="641"><td class="num" id="LN641">641</td><td class="line">     <span class='comment'>* positive reply about the operation performed. */</span></td></tr>
<tr class="codeline" data-linenumber="642"><td class="num" id="LN642">642</td><td class="line">    <span class='keyword'>if</span> (server.aof_state == <span class='macro'>AOF_ON<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="643"><td class="num" id="LN643">643</td><td class="line">        server.aof_buf = sdscatlen(server.aof_buf,buf,sdslen(buf));</td></tr>
<tr class="codeline" data-linenumber="644"><td class="num" id="LN644">644</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="645"><td class="num" id="LN645">645</td><td class="line">    <span class='comment'>/* If a background append only file rewriting is in progress we want to</span></td></tr>
<tr class="codeline" data-linenumber="646"><td class="num" id="LN646">646</td><td class="line">     <span class='comment'>* accumulate the differences between the child DB and the current one</span></td></tr>
<tr class="codeline" data-linenumber="647"><td class="num" id="LN647">647</td><td class="line">     <span class='comment'>* in a buffer, so that when the child process will do its work we</span></td></tr>
<tr class="codeline" data-linenumber="648"><td class="num" id="LN648">648</td><td class="line">     <span class='comment'>* can append the differences to the new append only file. */</span></td></tr>
<tr class="codeline" data-linenumber="649"><td class="num" id="LN649">649</td><td class="line">    <span class='keyword'>if</span> (server.aof_child_pid != -1)</td></tr>
<tr class="codeline" data-linenumber="650"><td class="num" id="LN650">650</td><td class="line">        aofRewriteBufferAppend((<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)buf,sdslen(buf));</td></tr>
<tr class="codeline" data-linenumber="651"><td class="num" id="LN651">651</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="652"><td class="num" id="LN652">652</td><td class="line">    sdsfree(buf);</td></tr>
<tr class="codeline" data-linenumber="653"><td class="num" id="LN653">653</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="654"><td class="num" id="LN654">654</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="655"><td class="num" id="LN655">655</td><td class="line"><span class='comment'>/* ----------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="656"><td class="num" id="LN656">656</td><td class="line"> <span class='comment'>* AOF loading</span></td></tr>
<tr class="codeline" data-linenumber="657"><td class="num" id="LN657">657</td><td class="line"> <span class='comment'>* ------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="658"><td class="num" id="LN658">658</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="659"><td class="num" id="LN659">659</td><td class="line"><span class='comment'>/* In Redis commands are always executed in the context of a client, so in</span></td></tr>
<tr class="codeline" data-linenumber="660"><td class="num" id="LN660">660</td><td class="line"> <span class='comment'>* order to load the append only file we need to create a fake client. */</span></td></tr>
<tr class="codeline" data-linenumber="661"><td class="num" id="LN661">661</td><td class="line"><span class='keyword'>struct</span> client *createAOFClient(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="662"><td class="num" id="LN662">662</td><td class="line">    <span class='keyword'>struct</span> client *c = zmalloc(<span class='keyword'>sizeof</span>(*c));</td></tr>
<tr class="codeline" data-linenumber="663"><td class="num" id="LN663">663</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="664"><td class="num" id="LN664">664</td><td class="line">    selectDb(c,0);</td></tr>
<tr class="codeline" data-linenumber="665"><td class="num" id="LN665">665</td><td class="line">    c-&gt;id = <span class='macro'>CLIENT_ID_AOF<span class='macro_popup'>((18446744073709551615UL))</span></span>; <span class='comment'>/* So modules can identify it's the AOF client. */</span></td></tr>
<tr class="codeline" data-linenumber="666"><td class="num" id="LN666">666</td><td class="line">    c-&gt;conn = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="667"><td class="num" id="LN667">667</td><td class="line">    c-&gt;name = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="668"><td class="num" id="LN668">668</td><td class="line">    c-&gt;querybuf = sdsempty();</td></tr>
<tr class="codeline" data-linenumber="669"><td class="num" id="LN669">669</td><td class="line">    c-&gt;querybuf_peak = 0;</td></tr>
<tr class="codeline" data-linenumber="670"><td class="num" id="LN670">670</td><td class="line">    c-&gt;argc = 0;</td></tr>
<tr class="codeline" data-linenumber="671"><td class="num" id="LN671">671</td><td class="line">    c-&gt;argv = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="672"><td class="num" id="LN672">672</td><td class="line">    c-&gt;argv_len_sum = 0;</td></tr>
<tr class="codeline" data-linenumber="673"><td class="num" id="LN673">673</td><td class="line">    c-&gt;bufpos = 0;</td></tr>
<tr class="codeline" data-linenumber="674"><td class="num" id="LN674">674</td><td class="line">    c-&gt;flags = 0;</td></tr>
<tr class="codeline" data-linenumber="675"><td class="num" id="LN675">675</td><td class="line">    c-&gt;btype = <span class='macro'>BLOCKED_NONE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="676"><td class="num" id="LN676">676</td><td class="line">    <span class='comment'>/* We set the fake client as a slave waiting for the synchronization</span></td></tr>
<tr class="codeline" data-linenumber="677"><td class="num" id="LN677">677</td><td class="line">     <span class='comment'>* so that Redis will not try to send replies to this client. */</span></td></tr>
<tr class="codeline" data-linenumber="678"><td class="num" id="LN678">678</td><td class="line">    c-&gt;replstate = <span class='macro'>SLAVE_STATE_WAIT_BGSAVE_START<span class='macro_popup'>6</span></span>;</td></tr>
<tr class="codeline" data-linenumber="679"><td class="num" id="LN679">679</td><td class="line">    c-&gt;reply = listCreate();</td></tr>
<tr class="codeline" data-linenumber="680"><td class="num" id="LN680">680</td><td class="line">    c-&gt;reply_bytes = 0;</td></tr>
<tr class="codeline" data-linenumber="681"><td class="num" id="LN681">681</td><td class="line">    c-&gt;obuf_soft_limit_reached_time = 0;</td></tr>
<tr class="codeline" data-linenumber="682"><td class="num" id="LN682">682</td><td class="line">    c-&gt;watched_keys = listCreate();</td></tr>
<tr class="codeline" data-linenumber="683"><td class="num" id="LN683">683</td><td class="line">    c-&gt;peerid = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="684"><td class="num" id="LN684">684</td><td class="line">    c-&gt;resp = 2;</td></tr>
<tr class="codeline" data-linenumber="685"><td class="num" id="LN685">685</td><td class="line">    c-&gt;user = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="686"><td class="num" id="LN686">686</td><td class="line">    <span class='macro'>listSetFreeMethod(c-&gt;reply,freeClientReplyValue)<span class='macro_popup'>((c-&gt;reply)-&gt;free = (freeClientReplyValue))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="687"><td class="num" id="LN687">687</td><td class="line">    <span class='macro'>listSetDupMethod(c-&gt;reply,dupClientReplyValue)<span class='macro_popup'>((c-&gt;reply)-&gt;dup = (dupClientReplyValue))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="688"><td class="num" id="LN688">688</td><td class="line">    initClientMultiState(c);</td></tr>
<tr class="codeline" data-linenumber="689"><td class="num" id="LN689">689</td><td class="line">    <span class='keyword'>return</span> c;</td></tr>
<tr class="codeline" data-linenumber="690"><td class="num" id="LN690">690</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="691"><td class="num" id="LN691">691</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="692"><td class="num" id="LN692">692</td><td class="line"><span class='keyword'>void</span> freeFakeClientArgv(<span class='keyword'>struct</span> client *c) {</td></tr>
<tr class="codeline" data-linenumber="693"><td class="num" id="LN693">693</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="694"><td class="num" id="LN694">694</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="695"><td class="num" id="LN695">695</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; c-&gt;argc; j++)</td></tr>
<tr class="codeline" data-linenumber="696"><td class="num" id="LN696">696</td><td class="line">        decrRefCount(c-&gt;argv[j]);</td></tr>
<tr class="codeline" data-linenumber="697"><td class="num" id="LN697">697</td><td class="line">    zfree(c-&gt;argv);</td></tr>
<tr class="codeline" data-linenumber="698"><td class="num" id="LN698">698</td><td class="line">    c-&gt;argv_len_sum = 0;</td></tr>
<tr class="codeline" data-linenumber="699"><td class="num" id="LN699">699</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="700"><td class="num" id="LN700">700</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="701"><td class="num" id="LN701">701</td><td class="line"><span class='keyword'>void</span> freeFakeClient(<span class='keyword'>struct</span> client *c) {</td></tr>
<tr class="codeline" data-linenumber="702"><td class="num" id="LN702">702</td><td class="line">    sdsfree(c-&gt;querybuf);</td></tr>
<tr class="codeline" data-linenumber="703"><td class="num" id="LN703">703</td><td class="line">    listRelease(c-&gt;reply);</td></tr>
<tr class="codeline" data-linenumber="704"><td class="num" id="LN704">704</td><td class="line">    listRelease(c-&gt;watched_keys);</td></tr>
<tr class="codeline" data-linenumber="705"><td class="num" id="LN705">705</td><td class="line">    freeClientMultiState(c);</td></tr>
<tr class="codeline" data-linenumber="706"><td class="num" id="LN706">706</td><td class="line">    zfree(c);</td></tr>
<tr class="codeline" data-linenumber="707"><td class="num" id="LN707">707</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="708"><td class="num" id="LN708">708</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="709"><td class="num" id="LN709">709</td><td class="line"><span class='comment'>/* Replay the append log file. On success C_OK is returned. On non fatal</span></td></tr>
<tr class="codeline" data-linenumber="710"><td class="num" id="LN710">710</td><td class="line"> <span class='comment'>* error (the append only file is zero-length) C_ERR is returned. On</span></td></tr>
<tr class="codeline" data-linenumber="711"><td class="num" id="LN711">711</td><td class="line"> <span class='comment'>* fatal error an error message is logged and the program exists. */</span></td></tr>
<tr class="codeline" data-linenumber="712"><td class="num" id="LN712">712</td><td class="line"><span class='keyword'>int</span> loadAppendOnlyFile(<span class='keyword'>char</span> *filename) {</td></tr>
<tr class="codeline" data-linenumber="713"><td class="num" id="LN713">713</td><td class="line">    <span class='keyword'>struct</span> client *fakeClient;</td></tr>
<tr class="codeline" data-linenumber="714"><td class="num" id="LN714">714</td><td class="line">    FILE *fp = fopen(filename,<span class='string_literal'>"r"</span>);</td></tr>
<tr class="codeline" data-linenumber="715"><td class="num" id="LN715">715</td><td class="line">    <span class='keyword'>struct</span> <span class='macro'>redis_stat<span class='macro_popup'>stat</span></span> sb;</td></tr>
<tr class="codeline" data-linenumber="716"><td class="num" id="LN716">716</td><td class="line">    <span class='keyword'>int</span> old_aof_state = server.aof_state;</td></tr>
<tr class="codeline" data-linenumber="717"><td class="num" id="LN717">717</td><td class="line">    <span class='keyword'>long</span> loops = 0;</td></tr>
<tr class="codeline" data-linenumber="718"><td class="num" id="LN718">718</td><td class="line">    off_t valid_up_to = 0; <span class='comment'>/* Offset of latest well-formed command loaded. */</span></td></tr>
<tr class="codeline" data-linenumber="719"><td class="num" id="LN719">719</td><td class="line">    off_t valid_before_multi = 0; <span class='comment'>/* Offset before MULTI command loaded. */</span></td></tr>
<tr class="codeline" data-linenumber="720"><td class="num" id="LN720">720</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="721"><td class="num" id="LN721">721</td><td class="line">    <span class='keyword'>if</span> (fp == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="722"><td class="num" id="LN722">722</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Fatal error: can't open the append log file for reading: %s"</span>,strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="723"><td class="num" id="LN723">723</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="724"><td class="num" id="LN724">724</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="725"><td class="num" id="LN725">725</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="726"><td class="num" id="LN726">726</td><td class="line">    <span class='comment'>/* Handle a zero-length AOF file as a special case. An empty AOF file</span></td></tr>
<tr class="codeline" data-linenumber="727"><td class="num" id="LN727">727</td><td class="line">     <span class='comment'>* is a valid AOF because an empty server with AOF enabled will create</span></td></tr>
<tr class="codeline" data-linenumber="728"><td class="num" id="LN728">728</td><td class="line">     <span class='comment'>* a zero length file at startup, that will remain like that if no write</span></td></tr>
<tr class="codeline" data-linenumber="729"><td class="num" id="LN729">729</td><td class="line">     <span class='comment'>* operation is received. */</span></td></tr>
<tr class="codeline" data-linenumber="730"><td class="num" id="LN730">730</td><td class="line">    <span class='keyword'>if</span> (fp &amp;&amp; <span class='macro'>redis_fstat<span class='macro_popup'>fstat</span></span>(fileno(fp),&amp;sb) != -1 &amp;&amp; sb.st_size == 0) {</td></tr>
<tr class="codeline" data-linenumber="731"><td class="num" id="LN731">731</td><td class="line">        server.aof_current_size = 0;</td></tr>
<tr class="codeline" data-linenumber="732"><td class="num" id="LN732">732</td><td class="line">        server.aof_fsync_offset = server.aof_current_size;</td></tr>
<tr class="codeline" data-linenumber="733"><td class="num" id="LN733">733</td><td class="line">        fclose(fp);</td></tr>
<tr class="codeline" data-linenumber="734"><td class="num" id="LN734">734</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="735"><td class="num" id="LN735">735</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="736"><td class="num" id="LN736">736</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="737"><td class="num" id="LN737">737</td><td class="line">    <span class='comment'>/* Temporarily disable AOF, to prevent EXEC from feeding a MULTI</span></td></tr>
<tr class="codeline" data-linenumber="738"><td class="num" id="LN738">738</td><td class="line">     <span class='comment'>* to the same file we're about to read. */</span></td></tr>
<tr class="codeline" data-linenumber="739"><td class="num" id="LN739">739</td><td class="line">    server.aof_state = <span class='macro'>AOF_OFF<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="740"><td class="num" id="LN740">740</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="741"><td class="num" id="LN741">741</td><td class="line">    fakeClient = createAOFClient();</td></tr>
<tr class="codeline" data-linenumber="742"><td class="num" id="LN742">742</td><td class="line">    startLoadingFile(fp, filename, <span class='macro'>RDBFLAGS_AOF_PREAMBLE<span class='macro_popup'>(1&lt;&lt;0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="743"><td class="num" id="LN743">743</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="744"><td class="num" id="LN744">744</td><td class="line">    <span class='comment'>/* Check if this AOF file has an RDB preamble. In that case we need to</span></td></tr>
<tr class="codeline" data-linenumber="745"><td class="num" id="LN745">745</td><td class="line">     <span class='comment'>* load the RDB file and later continue loading the AOF tail. */</span></td></tr>
<tr class="codeline" data-linenumber="746"><td class="num" id="LN746">746</td><td class="line">    <span class='keyword'>char</span> sig[5]; <span class='comment'>/* "REDIS" */</span></td></tr>
<tr class="codeline" data-linenumber="747"><td class="num" id="LN747">747</td><td class="line">    <span class='keyword'>if</span> (fread(sig,1,5,fp) != 5 || memcmp(sig,<span class='string_literal'>"REDIS"</span>,5) != 0) {</td></tr>
<tr class="codeline" data-linenumber="748"><td class="num" id="LN748">748</td><td class="line">        <span class='comment'>/* No RDB preamble, seek back at 0 offset. */</span></td></tr>
<tr class="codeline" data-linenumber="749"><td class="num" id="LN749">749</td><td class="line">        <span class='keyword'>if</span> (fseek(fp,0,<span class='macro'>SEEK_SET<span class='macro_popup'>0</span></span>) == -1) <span class='keyword'>goto</span> readerr;</td></tr>
<tr class="codeline" data-linenumber="750"><td class="num" id="LN750">750</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="751"><td class="num" id="LN751">751</td><td class="line">        <span class='comment'>/* RDB preamble. Pass loading the RDB functions. */</span></td></tr>
<tr class="codeline" data-linenumber="752"><td class="num" id="LN752">752</td><td class="line">        rio rdb;</td></tr>
<tr class="codeline" data-linenumber="753"><td class="num" id="LN753">753</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="754"><td class="num" id="LN754">754</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Reading RDB preamble from AOF file..."</span>);</td></tr>
<tr class="codeline" data-linenumber="755"><td class="num" id="LN755">755</td><td class="line">        <span class='keyword'>if</span> (fseek(fp,0,<span class='macro'>SEEK_SET<span class='macro_popup'>0</span></span>) == -1) <span class='keyword'>goto</span> readerr;</td></tr>
<tr class="codeline" data-linenumber="756"><td class="num" id="LN756">756</td><td class="line">        rioInitWithFile(&amp;rdb,fp);</td></tr>
<tr class="codeline" data-linenumber="757"><td class="num" id="LN757">757</td><td class="line">        <span class='keyword'>if</span> (rdbLoadRio(&amp;rdb,<span class='macro'>RDBFLAGS_AOF_PREAMBLE<span class='macro_popup'>(1&lt;&lt;0)</span></span>,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) != <span class='macro'>C_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="758"><td class="num" id="LN758">758</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Error reading the RDB preamble of the AOF file, AOF loading aborted"</span>);</td></tr>
<tr class="codeline" data-linenumber="759"><td class="num" id="LN759">759</td><td class="line">            <span class='keyword'>goto</span> readerr;</td></tr>
<tr class="codeline" data-linenumber="760"><td class="num" id="LN760">760</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="761"><td class="num" id="LN761">761</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Reading the remaining AOF tail..."</span>);</td></tr>
<tr class="codeline" data-linenumber="762"><td class="num" id="LN762">762</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="763"><td class="num" id="LN763">763</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="764"><td class="num" id="LN764">764</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="765"><td class="num" id="LN765">765</td><td class="line">    <span class='comment'>/* Read the actual AOF file, in REPL format, command by command. */</span></td></tr>
<tr class="codeline" data-linenumber="766"><td class="num" id="LN766">766</td><td class="line">    <span class='keyword'>while</span>(1) {</td></tr>
<tr class="codeline" data-linenumber="767"><td class="num" id="LN767">767</td><td class="line">        <span class='keyword'>int</span> argc, j;</td></tr>
<tr class="codeline" data-linenumber="768"><td class="num" id="LN768">768</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>long</span> len;</td></tr>
<tr class="codeline" data-linenumber="769"><td class="num" id="LN769">769</td><td class="line">        robj **argv;</td></tr>
<tr class="codeline" data-linenumber="770"><td class="num" id="LN770">770</td><td class="line">        <span class='keyword'>char</span> buf[128];</td></tr>
<tr class="codeline" data-linenumber="771"><td class="num" id="LN771">771</td><td class="line">        sds argsds;</td></tr>
<tr class="codeline" data-linenumber="772"><td class="num" id="LN772">772</td><td class="line">        <span class='keyword'>struct</span> redisCommand *cmd;</td></tr>
<tr class="codeline" data-linenumber="773"><td class="num" id="LN773">773</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="774"><td class="num" id="LN774">774</td><td class="line">        <span class='comment'>/* Serve the clients from time to time */</span></td></tr>
<tr class="codeline" data-linenumber="775"><td class="num" id="LN775">775</td><td class="line">        <span class='keyword'>if</span> (!(loops++ % 1000)) {</td></tr>
<tr class="codeline" data-linenumber="776"><td class="num" id="LN776">776</td><td class="line">            loadingProgress(ftello(fp));</td></tr>
<tr class="codeline" data-linenumber="777"><td class="num" id="LN777">777</td><td class="line">            processEventsWhileBlocked();</td></tr>
<tr class="codeline" data-linenumber="778"><td class="num" id="LN778">778</td><td class="line">            processModuleLoadingProgressEvent(1);</td></tr>
<tr class="codeline" data-linenumber="779"><td class="num" id="LN779">779</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="780"><td class="num" id="LN780">780</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="781"><td class="num" id="LN781">781</td><td class="line">        <span class='keyword'>if</span> (fgets(buf,<span class='keyword'>sizeof</span>(buf),fp) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="782"><td class="num" id="LN782">782</td><td class="line">            <span class='keyword'>if</span> (feof(fp))</td></tr>
<tr class="codeline" data-linenumber="783"><td class="num" id="LN783">783</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="784"><td class="num" id="LN784">784</td><td class="line">            <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="785"><td class="num" id="LN785">785</td><td class="line">                <span class='keyword'>goto</span> readerr;</td></tr>
<tr class="codeline" data-linenumber="786"><td class="num" id="LN786">786</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="787"><td class="num" id="LN787">787</td><td class="line">        <span class='keyword'>if</span> (buf[0] != '*') <span class='keyword'>goto</span> fmterr;</td></tr>
<tr class="codeline" data-linenumber="788"><td class="num" id="LN788">788</td><td class="line">        <span class='keyword'>if</span> (buf[1] == '\0') <span class='keyword'>goto</span> readerr;</td></tr>
<tr class="codeline" data-linenumber="789"><td class="num" id="LN789">789</td><td class="line">        argc = atoi(buf+1);</td></tr>
<tr class="codeline" data-linenumber="790"><td class="num" id="LN790">790</td><td class="line">        <span class='keyword'>if</span> (argc &lt; 1) <span class='keyword'>goto</span> fmterr;</td></tr>
<tr class="codeline" data-linenumber="791"><td class="num" id="LN791">791</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="792"><td class="num" id="LN792">792</td><td class="line">        <span class='comment'>/* Load the next command in the AOF as our fake client</span></td></tr>
<tr class="codeline" data-linenumber="793"><td class="num" id="LN793">793</td><td class="line">         <span class='comment'>* argv. */</span></td></tr>
<tr class="codeline" data-linenumber="794"><td class="num" id="LN794">794</td><td class="line">        argv = zmalloc(<span class='keyword'>sizeof</span>(robj*)*argc);</td></tr>
<tr class="codeline" data-linenumber="795"><td class="num" id="LN795">795</td><td class="line">        fakeClient-&gt;argc = argc;</td></tr>
<tr class="codeline" data-linenumber="796"><td class="num" id="LN796">796</td><td class="line">        fakeClient-&gt;argv = argv;</td></tr>
<tr class="codeline" data-linenumber="797"><td class="num" id="LN797">797</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="798"><td class="num" id="LN798">798</td><td class="line">        <span class='keyword'>for</span> (j = 0; j &lt; argc; j++) {</td></tr>
<tr class="codeline" data-linenumber="799"><td class="num" id="LN799">799</td><td class="line">            <span class='comment'>/* Parse the argument len. */</span></td></tr>
<tr class="codeline" data-linenumber="800"><td class="num" id="LN800">800</td><td class="line">            <span class='keyword'>char</span> *readres = fgets(buf,<span class='keyword'>sizeof</span>(buf),fp);</td></tr>
<tr class="codeline" data-linenumber="801"><td class="num" id="LN801">801</td><td class="line">            <span class='keyword'>if</span> (readres == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || buf[0] != '$') {</td></tr>
<tr class="codeline" data-linenumber="802"><td class="num" id="LN802">802</td><td class="line">                fakeClient-&gt;argc = j; <span class='comment'>/* Free up to j-1. */</span></td></tr>
<tr class="codeline" data-linenumber="803"><td class="num" id="LN803">803</td><td class="line">                freeFakeClientArgv(fakeClient);</td></tr>
<tr class="codeline" data-linenumber="804"><td class="num" id="LN804">804</td><td class="line">                <span class='keyword'>if</span> (readres == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="805"><td class="num" id="LN805">805</td><td class="line">                    <span class='keyword'>goto</span> readerr;</td></tr>
<tr class="codeline" data-linenumber="806"><td class="num" id="LN806">806</td><td class="line">                <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="807"><td class="num" id="LN807">807</td><td class="line">                    <span class='keyword'>goto</span> fmterr;</td></tr>
<tr class="codeline" data-linenumber="808"><td class="num" id="LN808">808</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="809"><td class="num" id="LN809">809</td><td class="line">            len = strtol(buf+1,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,10);</td></tr>
<tr class="codeline" data-linenumber="810"><td class="num" id="LN810">810</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="811"><td class="num" id="LN811">811</td><td class="line">            <span class='comment'>/* Read it into a string object. */</span></td></tr>
<tr class="codeline" data-linenumber="812"><td class="num" id="LN812">812</td><td class="line">            argsds = sdsnewlen(SDS_NOINIT,len);</td></tr>
<tr class="codeline" data-linenumber="813"><td class="num" id="LN813">813</td><td class="line">            <span class='keyword'>if</span> (len &amp;&amp; fread(argsds,len,1,fp) == 0) {</td></tr>
<tr class="codeline" data-linenumber="814"><td class="num" id="LN814">814</td><td class="line">                sdsfree(argsds);</td></tr>
<tr class="codeline" data-linenumber="815"><td class="num" id="LN815">815</td><td class="line">                fakeClient-&gt;argc = j; <span class='comment'>/* Free up to j-1. */</span></td></tr>
<tr class="codeline" data-linenumber="816"><td class="num" id="LN816">816</td><td class="line">                freeFakeClientArgv(fakeClient);</td></tr>
<tr class="codeline" data-linenumber="817"><td class="num" id="LN817">817</td><td class="line">                <span class='keyword'>goto</span> readerr;</td></tr>
<tr class="codeline" data-linenumber="818"><td class="num" id="LN818">818</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="819"><td class="num" id="LN819">819</td><td class="line">            argv[j] = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,argsds);</td></tr>
<tr class="codeline" data-linenumber="820"><td class="num" id="LN820">820</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="821"><td class="num" id="LN821">821</td><td class="line">            <span class='comment'>/* Discard CRLF. */</span></td></tr>
<tr class="codeline" data-linenumber="822"><td class="num" id="LN822">822</td><td class="line">            <span class='keyword'>if</span> (fread(buf,2,1,fp) == 0) {</td></tr>
<tr class="codeline" data-linenumber="823"><td class="num" id="LN823">823</td><td class="line">                fakeClient-&gt;argc = j+1; <span class='comment'>/* Free up to j. */</span></td></tr>
<tr class="codeline" data-linenumber="824"><td class="num" id="LN824">824</td><td class="line">                freeFakeClientArgv(fakeClient);</td></tr>
<tr class="codeline" data-linenumber="825"><td class="num" id="LN825">825</td><td class="line">                <span class='keyword'>goto</span> readerr;</td></tr>
<tr class="codeline" data-linenumber="826"><td class="num" id="LN826">826</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="827"><td class="num" id="LN827">827</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="828"><td class="num" id="LN828">828</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="829"><td class="num" id="LN829">829</td><td class="line">        <span class='comment'>/* Command lookup */</span></td></tr>
<tr class="codeline" data-linenumber="830"><td class="num" id="LN830">830</td><td class="line">        cmd = lookupCommand(argv[0]-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="831"><td class="num" id="LN831">831</td><td class="line">        <span class='keyword'>if</span> (!cmd) {</td></tr>
<tr class="codeline" data-linenumber="832"><td class="num" id="LN832">832</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="833"><td class="num" id="LN833">833</td><td class="line">                <span class='string_literal'>"Unknown command '%s' reading the append only file"</span>,</td></tr>
<tr class="codeline" data-linenumber="834"><td class="num" id="LN834">834</td><td class="line">                (<span class='keyword'>char</span>*)argv[0]-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="835"><td class="num" id="LN835">835</td><td class="line">            exit(1);</td></tr>
<tr class="codeline" data-linenumber="836"><td class="num" id="LN836">836</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="837"><td class="num" id="LN837">837</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="838"><td class="num" id="LN838">838</td><td class="line">        <span class='keyword'>if</span> (cmd == server.multiCommand) valid_before_multi = valid_up_to;</td></tr>
<tr class="codeline" data-linenumber="839"><td class="num" id="LN839">839</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="840"><td class="num" id="LN840">840</td><td class="line">        <span class='comment'>/* Run the command in the context of a fake client */</span></td></tr>
<tr class="codeline" data-linenumber="841"><td class="num" id="LN841">841</td><td class="line">        fakeClient-&gt;cmd = fakeClient-&gt;lastcmd = cmd;</td></tr>
<tr class="codeline" data-linenumber="842"><td class="num" id="LN842">842</td><td class="line">        <span class='keyword'>if</span> (fakeClient-&gt;flags &amp; <span class='macro'>CLIENT_MULTI<span class='macro_popup'>(1&lt;&lt;3)</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="843"><td class="num" id="LN843">843</td><td class="line">            fakeClient-&gt;cmd-&gt;proc != execCommand)</td></tr>
<tr class="codeline" data-linenumber="844"><td class="num" id="LN844">844</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="845"><td class="num" id="LN845">845</td><td class="line">            queueMultiCommand(fakeClient);</td></tr>
<tr class="codeline" data-linenumber="846"><td class="num" id="LN846">846</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="847"><td class="num" id="LN847">847</td><td class="line">            cmd-&gt;proc(fakeClient);</td></tr>
<tr class="codeline" data-linenumber="848"><td class="num" id="LN848">848</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="849"><td class="num" id="LN849">849</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="850"><td class="num" id="LN850">850</td><td class="line">        <span class='comment'>/* The fake client should not have a reply */</span></td></tr>
<tr class="codeline" data-linenumber="851"><td class="num" id="LN851">851</td><td class="line">        <span class='macro'>serverAssert(fakeClient-&gt;bufpos == 0 &amp;&amp;<span class='macro_popup'>((fakeClient-&gt;bufpos == 0 &amp;&amp; ((fakeClient-&gt;reply<br>)-&gt;len) == 0)?(void)0 : (_serverAssert("fakeClient-&gt;bufpos == 0 &amp;&amp; listLength(fakeClient-&gt;reply) == 0"<br>,"aof.c",852),_exit(1)))</span></span></td></tr>
<tr class="codeline" data-linenumber="852"><td class="num" id="LN852">852</td><td class="line">                     <span class='macro'>listLength(fakeClient-&gt;reply) == 0)<span class='macro_popup'>((fakeClient-&gt;bufpos == 0 &amp;&amp; ((fakeClient-&gt;reply<br>)-&gt;len) == 0)?(void)0 : (_serverAssert("fakeClient-&gt;bufpos == 0 &amp;&amp; listLength(fakeClient-&gt;reply) == 0"<br>,"aof.c",852),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="853"><td class="num" id="LN853">853</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="854"><td class="num" id="LN854">854</td><td class="line">        <span class='comment'>/* The fake client should never get blocked */</span></td></tr>
<tr class="codeline" data-linenumber="855"><td class="num" id="LN855">855</td><td class="line">        <span class='macro'>serverAssert((fakeClient-&gt;flags &amp; CLIENT_BLOCKED) == 0)<span class='macro_popup'>(((fakeClient-&gt;flags &amp; (1&lt;&lt;4)) == 0)?(void)0 : (<br>_serverAssert("(fakeClient-&gt;flags &amp; CLIENT_BLOCKED) == 0"<br>,"aof.c",855),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="856"><td class="num" id="LN856">856</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="857"><td class="num" id="LN857">857</td><td class="line">        <span class='comment'>/* Clean up. Command code may have changed argv/argc so we use the</span></td></tr>
<tr class="codeline" data-linenumber="858"><td class="num" id="LN858">858</td><td class="line">         <span class='comment'>* argv/argc of the client instead of the local variables. */</span></td></tr>
<tr class="codeline" data-linenumber="859"><td class="num" id="LN859">859</td><td class="line">        freeFakeClientArgv(fakeClient);</td></tr>
<tr class="codeline" data-linenumber="860"><td class="num" id="LN860">860</td><td class="line">        fakeClient-&gt;cmd = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="861"><td class="num" id="LN861">861</td><td class="line">        <span class='keyword'>if</span> (server.aof_load_truncated) valid_up_to = ftello(fp);</td></tr>
<tr class="codeline" data-linenumber="862"><td class="num" id="LN862">862</td><td class="line">        <span class='keyword'>if</span> (server.key_load_delay)</td></tr>
<tr class="codeline" data-linenumber="863"><td class="num" id="LN863">863</td><td class="line">            usleep(server.key_load_delay);</td></tr>
<tr class="codeline" data-linenumber="864"><td class="num" id="LN864">864</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="865"><td class="num" id="LN865">865</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="866"><td class="num" id="LN866">866</td><td class="line">    <span class='comment'>/* This point can only be reached when EOF is reached without errors.</span></td></tr>
<tr class="codeline" data-linenumber="867"><td class="num" id="LN867">867</td><td class="line">     <span class='comment'>* If the client is in the middle of a MULTI/EXEC, handle it as it was</span></td></tr>
<tr class="codeline" data-linenumber="868"><td class="num" id="LN868">868</td><td class="line">     <span class='comment'>* a short read, even if technically the protocol is correct: we want</span></td></tr>
<tr class="codeline" data-linenumber="869"><td class="num" id="LN869">869</td><td class="line">     <span class='comment'>* to remove the unprocessed tail and continue. */</span></td></tr>
<tr class="codeline" data-linenumber="870"><td class="num" id="LN870">870</td><td class="line">    <span class='keyword'>if</span> (fakeClient-&gt;flags &amp; <span class='macro'>CLIENT_MULTI<span class='macro_popup'>(1&lt;&lt;3)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="871"><td class="num" id="LN871">871</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="872"><td class="num" id="LN872">872</td><td class="line">            <span class='string_literal'>"Revert incomplete MULTI/EXEC transaction in AOF file"</span>);</td></tr>
<tr class="codeline" data-linenumber="873"><td class="num" id="LN873">873</td><td class="line">        valid_up_to = valid_before_multi;</td></tr>
<tr class="codeline" data-linenumber="874"><td class="num" id="LN874">874</td><td class="line">        <span class='keyword'>goto</span> uxeof;</td></tr>
<tr class="codeline" data-linenumber="875"><td class="num" id="LN875">875</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="876"><td class="num" id="LN876">876</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="877"><td class="num" id="LN877">877</td><td class="line">loaded_ok: <span class='comment'>/* DB loaded, cleanup and return C_OK to the caller. */</span></td></tr>
<tr class="codeline" data-linenumber="878"><td class="num" id="LN878">878</td><td class="line">    fclose(fp);</td></tr>
<tr class="codeline" data-linenumber="879"><td class="num" id="LN879">879</td><td class="line">    freeFakeClient(fakeClient);</td></tr>
<tr class="codeline" data-linenumber="880"><td class="num" id="LN880">880</td><td class="line">    server.aof_state = old_aof_state;</td></tr>
<tr class="codeline" data-linenumber="881"><td class="num" id="LN881">881</td><td class="line">    stopLoading(1);</td></tr>
<tr class="codeline" data-linenumber="882"><td class="num" id="LN882">882</td><td class="line">    aofUpdateCurrentSize();</td></tr>
<tr class="codeline" data-linenumber="883"><td class="num" id="LN883">883</td><td class="line">    server.aof_rewrite_base_size = server.aof_current_size;</td></tr>
<tr class="codeline" data-linenumber="884"><td class="num" id="LN884">884</td><td class="line">    server.aof_fsync_offset = server.aof_current_size;</td></tr>
<tr class="codeline" data-linenumber="885"><td class="num" id="LN885">885</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="886"><td class="num" id="LN886">886</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="887"><td class="num" id="LN887">887</td><td class="line">readerr: <span class='comment'>/* Read error. If feof(fp) is true, fall through to unexpected EOF. */</span></td></tr>
<tr class="codeline" data-linenumber="888"><td class="num" id="LN888">888</td><td class="line">    <span class='keyword'>if</span> (!feof(fp)) {</td></tr>
<tr class="codeline" data-linenumber="889"><td class="num" id="LN889">889</td><td class="line">        <span class='keyword'>if</span> (fakeClient) freeFakeClient(fakeClient); <span class='comment'>/* avoid valgrind warning */</span></td></tr>
<tr class="codeline" data-linenumber="890"><td class="num" id="LN890">890</td><td class="line">        fclose(fp);</td></tr>
<tr class="codeline" data-linenumber="891"><td class="num" id="LN891">891</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Unrecoverable error reading the append only file: %s"</span>, strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="892"><td class="num" id="LN892">892</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="893"><td class="num" id="LN893">893</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="894"><td class="num" id="LN894">894</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="895"><td class="num" id="LN895">895</td><td class="line">uxeof: <span class='comment'>/* Unexpected AOF end of file. */</span></td></tr>
<tr class="codeline" data-linenumber="896"><td class="num" id="LN896">896</td><td class="line">    <span class='keyword'>if</span> (server.aof_load_truncated) {</td></tr>
<tr class="codeline" data-linenumber="897"><td class="num" id="LN897">897</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"!!! Warning: short read while loading the AOF file !!!"</span>);</td></tr>
<tr class="codeline" data-linenumber="898"><td class="num" id="LN898">898</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"!!! Truncating the AOF at offset %llu !!!"</span>,</td></tr>
<tr class="codeline" data-linenumber="899"><td class="num" id="LN899">899</td><td class="line">            (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>) valid_up_to);</td></tr>
<tr class="codeline" data-linenumber="900"><td class="num" id="LN900">900</td><td class="line">        <span class='keyword'>if</span> (valid_up_to == -1 || truncate(filename,valid_up_to) == -1) {</td></tr>
<tr class="codeline" data-linenumber="901"><td class="num" id="LN901">901</td><td class="line">            <span class='keyword'>if</span> (valid_up_to == -1) {</td></tr>
<tr class="codeline" data-linenumber="902"><td class="num" id="LN902">902</td><td class="line">                serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Last valid command offset is invalid"</span>);</td></tr>
<tr class="codeline" data-linenumber="903"><td class="num" id="LN903">903</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="904"><td class="num" id="LN904">904</td><td class="line">                serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Error truncating the AOF file: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="905"><td class="num" id="LN905">905</td><td class="line">                    strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="906"><td class="num" id="LN906">906</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="907"><td class="num" id="LN907">907</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="908"><td class="num" id="LN908">908</td><td class="line">            <span class='comment'>/* Make sure the AOF file descriptor points to the end of the</span></td></tr>
<tr class="codeline" data-linenumber="909"><td class="num" id="LN909">909</td><td class="line">             <span class='comment'>* file after the truncate call. */</span></td></tr>
<tr class="codeline" data-linenumber="910"><td class="num" id="LN910">910</td><td class="line">            <span class='keyword'>if</span> (server.aof_fd != -1 &amp;&amp; lseek(server.aof_fd,0,<span class='macro'>SEEK_END<span class='macro_popup'>2</span></span>) == -1) {</td></tr>
<tr class="codeline" data-linenumber="911"><td class="num" id="LN911">911</td><td class="line">                serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Can't seek the end of the AOF file: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="912"><td class="num" id="LN912">912</td><td class="line">                    strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="913"><td class="num" id="LN913">913</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="914"><td class="num" id="LN914">914</td><td class="line">                serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="915"><td class="num" id="LN915">915</td><td class="line">                    <span class='string_literal'>"AOF loaded anyway because aof-load-truncated is enabled"</span>);</td></tr>
<tr class="codeline" data-linenumber="916"><td class="num" id="LN916">916</td><td class="line">                <span class='keyword'>goto</span> loaded_ok;</td></tr>
<tr class="codeline" data-linenumber="917"><td class="num" id="LN917">917</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="918"><td class="num" id="LN918">918</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="919"><td class="num" id="LN919">919</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="920"><td class="num" id="LN920">920</td><td class="line">    <span class='keyword'>if</span> (fakeClient) freeFakeClient(fakeClient); <span class='comment'>/* avoid valgrind warning */</span></td></tr>
<tr class="codeline" data-linenumber="921"><td class="num" id="LN921">921</td><td class="line">    fclose(fp);</td></tr>
<tr class="codeline" data-linenumber="922"><td class="num" id="LN922">922</td><td class="line">    serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Unexpected end of file reading the append only file. You can: 1) Make a backup of your AOF file, then use ./redis-check-aof --fix &lt;filename&gt;. 2) Alternatively you can set the 'aof-load-truncated' configuration option to yes and restart the server."</span>);</td></tr>
<tr class="codeline" data-linenumber="923"><td class="num" id="LN923">923</td><td class="line">    exit(1);</td></tr>
<tr class="codeline" data-linenumber="924"><td class="num" id="LN924">924</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="925"><td class="num" id="LN925">925</td><td class="line">fmterr: <span class='comment'>/* Format error. */</span></td></tr>
<tr class="codeline" data-linenumber="926"><td class="num" id="LN926">926</td><td class="line">    <span class='keyword'>if</span> (fakeClient) freeFakeClient(fakeClient); <span class='comment'>/* avoid valgrind warning */</span></td></tr>
<tr class="codeline" data-linenumber="927"><td class="num" id="LN927">927</td><td class="line">    fclose(fp);</td></tr>
<tr class="codeline" data-linenumber="928"><td class="num" id="LN928">928</td><td class="line">    serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Bad file format reading the append only file: make a backup of your AOF file, then use ./redis-check-aof --fix &lt;filename&gt;"</span>);</td></tr>
<tr class="codeline" data-linenumber="929"><td class="num" id="LN929">929</td><td class="line">    exit(1);</td></tr>
<tr class="codeline" data-linenumber="930"><td class="num" id="LN930">930</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="931"><td class="num" id="LN931">931</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="932"><td class="num" id="LN932">932</td><td class="line"><span class='comment'>/* ----------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="933"><td class="num" id="LN933">933</td><td class="line"> <span class='comment'>* AOF rewrite</span></td></tr>
<tr class="codeline" data-linenumber="934"><td class="num" id="LN934">934</td><td class="line"> <span class='comment'>* ------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="935"><td class="num" id="LN935">935</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="936"><td class="num" id="LN936">936</td><td class="line"><span class='comment'>/* Delegate writing an object to writing a bulk string or bulk long long.</span></td></tr>
<tr class="codeline" data-linenumber="937"><td class="num" id="LN937">937</td><td class="line"> <span class='comment'>* This is not placed in rio.c since that adds the server.h dependency. */</span></td></tr>
<tr class="codeline" data-linenumber="938"><td class="num" id="LN938">938</td><td class="line"><span class='keyword'>int</span> rioWriteBulkObject(rio *r, robj *obj) {</td></tr>
<tr class="codeline" data-linenumber="939"><td class="num" id="LN939">939</td><td class="line">    <span class='comment'>/* Avoid using getDecodedObject to help copy-on-write (we are often</span></td></tr>
<tr class="codeline" data-linenumber="940"><td class="num" id="LN940">940</td><td class="line">     <span class='comment'>* in a child process when this function is called). */</span></td></tr>
<tr class="codeline" data-linenumber="941"><td class="num" id="LN941">941</td><td class="line">    <span class='keyword'>if</span> (obj-&gt;encoding == <span class='macro'>OBJ_ENCODING_INT<span class='macro_popup'>1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="942"><td class="num" id="LN942">942</td><td class="line">        <span class='keyword'>return</span> rioWriteBulkLongLong(r,(<span class='keyword'>long</span>)obj-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="943"><td class="num" id="LN943">943</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (<span class='macro'>sdsEncodedObject(obj)<span class='macro_popup'>(obj-&gt;encoding == 0 || obj-&gt;encoding == 8)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="944"><td class="num" id="LN944">944</td><td class="line">        <span class='keyword'>return</span> rioWriteBulkString(r,obj-&gt;ptr,sdslen(obj-&gt;ptr));</td></tr>
<tr class="codeline" data-linenumber="945"><td class="num" id="LN945">945</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="946"><td class="num" id="LN946">946</td><td class="line">        <span class='macro'>serverPanic(<span class='string_literal'>"Unknown string encoding"</span>)<span class='macro_popup'>_serverPanic("aof.c",946,"Unknown string encoding"),_exit(1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="947"><td class="num" id="LN947">947</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="948"><td class="num" id="LN948">948</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="949"><td class="num" id="LN949">949</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="950"><td class="num" id="LN950">950</td><td class="line"><span class='comment'>/* Emit the commands needed to rebuild a list object.</span></td></tr>
<tr class="codeline" data-linenumber="951"><td class="num" id="LN951">951</td><td class="line"> <span class='comment'>* The function returns 0 on error, 1 on success. */</span></td></tr>
<tr class="codeline" data-linenumber="952"><td class="num" id="LN952">952</td><td class="line"><span class='keyword'>int</span> rewriteListObject(rio *r, robj *key, robj *o) {</td></tr>
<tr class="codeline" data-linenumber="953"><td class="num" id="LN953">953</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> count = 0, items = listTypeLength(o);</td></tr>
<tr class="codeline" data-linenumber="954"><td class="num" id="LN954">954</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="955"><td class="num" id="LN955">955</td><td class="line">    <span class='keyword'>if</span> (o-&gt;encoding == <span class='macro'>OBJ_ENCODING_QUICKLIST<span class='macro_popup'>9</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="956"><td class="num" id="LN956">956</td><td class="line">        quicklist *list = o-&gt;ptr;</td></tr>
<tr class="codeline" data-linenumber="957"><td class="num" id="LN957">957</td><td class="line">        quicklistIter *li = quicklistGetIterator(list, <span class='macro'>AL_START_HEAD<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="958"><td class="num" id="LN958">958</td><td class="line">        quicklistEntry entry;</td></tr>
<tr class="codeline" data-linenumber="959"><td class="num" id="LN959">959</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="960"><td class="num" id="LN960">960</td><td class="line">        <span class='keyword'>while</span> (quicklistNext(li,&amp;entry)) {</td></tr>
<tr class="codeline" data-linenumber="961"><td class="num" id="LN961">961</td><td class="line">            <span class='keyword'>if</span> (count == 0) {</td></tr>
<tr class="codeline" data-linenumber="962"><td class="num" id="LN962">962</td><td class="line">                <span class='keyword'>int</span> cmd_items = (items &gt; <span class='macro'>AOF_REWRITE_ITEMS_PER_CMD<span class='macro_popup'>64</span></span>) ?</td></tr>
<tr class="codeline" data-linenumber="963"><td class="num" id="LN963">963</td><td class="line">                    <span class='macro'>AOF_REWRITE_ITEMS_PER_CMD<span class='macro_popup'>64</span></span> : items;</td></tr>
<tr class="codeline" data-linenumber="964"><td class="num" id="LN964">964</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkCount(r,'*',2+cmd_items) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="965"><td class="num" id="LN965">965</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkString(r,<span class='string_literal'>"RPUSH"</span>,5) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="966"><td class="num" id="LN966">966</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkObject(r,key) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="967"><td class="num" id="LN967">967</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="968"><td class="num" id="LN968">968</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="969"><td class="num" id="LN969">969</td><td class="line">            <span class='keyword'>if</span> (entry.value) {</td></tr>
<tr class="codeline" data-linenumber="970"><td class="num" id="LN970">970</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkString(r,(<span class='keyword'>char</span>*)entry.value,entry.sz) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="971"><td class="num" id="LN971">971</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="972"><td class="num" id="LN972">972</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkLongLong(r,entry.longval) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="973"><td class="num" id="LN973">973</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="974"><td class="num" id="LN974">974</td><td class="line">            <span class='keyword'>if</span> (++count == <span class='macro'>AOF_REWRITE_ITEMS_PER_CMD<span class='macro_popup'>64</span></span>) count = 0;</td></tr>
<tr class="codeline" data-linenumber="975"><td class="num" id="LN975">975</td><td class="line">            items--;</td></tr>
<tr class="codeline" data-linenumber="976"><td class="num" id="LN976">976</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="977"><td class="num" id="LN977">977</td><td class="line">        quicklistReleaseIterator(li);</td></tr>
<tr class="codeline" data-linenumber="978"><td class="num" id="LN978">978</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="979"><td class="num" id="LN979">979</td><td class="line">        <span class='macro'>serverPanic(<span class='string_literal'>"Unknown list encoding"</span>)<span class='macro_popup'>_serverPanic("aof.c",979,"Unknown list encoding"),_exit(1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="980"><td class="num" id="LN980">980</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="981"><td class="num" id="LN981">981</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="982"><td class="num" id="LN982">982</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="983"><td class="num" id="LN983">983</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="984"><td class="num" id="LN984">984</td><td class="line"><span class='comment'>/* Emit the commands needed to rebuild a set object.</span></td></tr>
<tr class="codeline" data-linenumber="985"><td class="num" id="LN985">985</td><td class="line"> <span class='comment'>* The function returns 0 on error, 1 on success. */</span></td></tr>
<tr class="codeline" data-linenumber="986"><td class="num" id="LN986">986</td><td class="line"><span class='keyword'>int</span> rewriteSetObject(rio *r, robj *key, robj *o) {</td></tr>
<tr class="codeline" data-linenumber="987"><td class="num" id="LN987">987</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> count = 0, items = setTypeSize(o);</td></tr>
<tr class="codeline" data-linenumber="988"><td class="num" id="LN988">988</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="989"><td class="num" id="LN989">989</td><td class="line">    <span class='keyword'>if</span> (o-&gt;encoding == <span class='macro'>OBJ_ENCODING_INTSET<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="990"><td class="num" id="LN990">990</td><td class="line">        <span class='keyword'>int</span> ii = 0;</td></tr>
<tr class="codeline" data-linenumber="991"><td class="num" id="LN991">991</td><td class="line">        int64_t llval;</td></tr>
<tr class="codeline" data-linenumber="992"><td class="num" id="LN992">992</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="993"><td class="num" id="LN993">993</td><td class="line">        <span class='keyword'>while</span>(intsetGet(o-&gt;ptr,ii++,&amp;llval)) {</td></tr>
<tr class="codeline" data-linenumber="994"><td class="num" id="LN994">994</td><td class="line">            <span class='keyword'>if</span> (count == 0) {</td></tr>
<tr class="codeline" data-linenumber="995"><td class="num" id="LN995">995</td><td class="line">                <span class='keyword'>int</span> cmd_items = (items &gt; <span class='macro'>AOF_REWRITE_ITEMS_PER_CMD<span class='macro_popup'>64</span></span>) ?</td></tr>
<tr class="codeline" data-linenumber="996"><td class="num" id="LN996">996</td><td class="line">                    <span class='macro'>AOF_REWRITE_ITEMS_PER_CMD<span class='macro_popup'>64</span></span> : items;</td></tr>
<tr class="codeline" data-linenumber="997"><td class="num" id="LN997">997</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="998"><td class="num" id="LN998">998</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkCount(r,'*',2+cmd_items) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="999"><td class="num" id="LN999">999</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkString(r,<span class='string_literal'>"SADD"</span>,4) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1000"><td class="num" id="LN1000">1000</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkObject(r,key) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1001"><td class="num" id="LN1001">1001</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1002"><td class="num" id="LN1002">1002</td><td class="line">            <span class='keyword'>if</span> (rioWriteBulkLongLong(r,llval) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1003"><td class="num" id="LN1003">1003</td><td class="line">            <span class='keyword'>if</span> (++count == <span class='macro'>AOF_REWRITE_ITEMS_PER_CMD<span class='macro_popup'>64</span></span>) count = 0;</td></tr>
<tr class="codeline" data-linenumber="1004"><td class="num" id="LN1004">1004</td><td class="line">            items--;</td></tr>
<tr class="codeline" data-linenumber="1005"><td class="num" id="LN1005">1005</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1006"><td class="num" id="LN1006">1006</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (o-&gt;encoding == <span class='macro'>OBJ_ENCODING_HT<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1007"><td class="num" id="LN1007">1007</td><td class="line">        dictIterator *di = dictGetIterator(o-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="1008"><td class="num" id="LN1008">1008</td><td class="line">        dictEntry *de;</td></tr>
<tr class="codeline" data-linenumber="1009"><td class="num" id="LN1009">1009</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1010"><td class="num" id="LN1010">1010</td><td class="line">        <span class='keyword'>while</span>((de = dictNext(di)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1011"><td class="num" id="LN1011">1011</td><td class="line">            sds ele = <span class='macro'>dictGetKey(de)<span class='macro_popup'>((de)-&gt;key)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1012"><td class="num" id="LN1012">1012</td><td class="line">            <span class='keyword'>if</span> (count == 0) {</td></tr>
<tr class="codeline" data-linenumber="1013"><td class="num" id="LN1013">1013</td><td class="line">                <span class='keyword'>int</span> cmd_items = (items &gt; <span class='macro'>AOF_REWRITE_ITEMS_PER_CMD<span class='macro_popup'>64</span></span>) ?</td></tr>
<tr class="codeline" data-linenumber="1014"><td class="num" id="LN1014">1014</td><td class="line">                    <span class='macro'>AOF_REWRITE_ITEMS_PER_CMD<span class='macro_popup'>64</span></span> : items;</td></tr>
<tr class="codeline" data-linenumber="1015"><td class="num" id="LN1015">1015</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1016"><td class="num" id="LN1016">1016</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkCount(r,'*',2+cmd_items) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1017"><td class="num" id="LN1017">1017</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkString(r,<span class='string_literal'>"SADD"</span>,4) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1018"><td class="num" id="LN1018">1018</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkObject(r,key) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1019"><td class="num" id="LN1019">1019</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1020"><td class="num" id="LN1020">1020</td><td class="line">            <span class='keyword'>if</span> (rioWriteBulkString(r,ele,sdslen(ele)) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1021"><td class="num" id="LN1021">1021</td><td class="line">            <span class='keyword'>if</span> (++count == <span class='macro'>AOF_REWRITE_ITEMS_PER_CMD<span class='macro_popup'>64</span></span>) count = 0;</td></tr>
<tr class="codeline" data-linenumber="1022"><td class="num" id="LN1022">1022</td><td class="line">            items--;</td></tr>
<tr class="codeline" data-linenumber="1023"><td class="num" id="LN1023">1023</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1024"><td class="num" id="LN1024">1024</td><td class="line">        dictReleaseIterator(di);</td></tr>
<tr class="codeline" data-linenumber="1025"><td class="num" id="LN1025">1025</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1026"><td class="num" id="LN1026">1026</td><td class="line">        <span class='macro'>serverPanic(<span class='string_literal'>"Unknown set encoding"</span>)<span class='macro_popup'>_serverPanic("aof.c",1026,"Unknown set encoding"),_exit(1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1027"><td class="num" id="LN1027">1027</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1028"><td class="num" id="LN1028">1028</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1029"><td class="num" id="LN1029">1029</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1030"><td class="num" id="LN1030">1030</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1031"><td class="num" id="LN1031">1031</td><td class="line"><span class='comment'>/* Emit the commands needed to rebuild a sorted set object.</span></td></tr>
<tr class="codeline" data-linenumber="1032"><td class="num" id="LN1032">1032</td><td class="line"> <span class='comment'>* The function returns 0 on error, 1 on success. */</span></td></tr>
<tr class="codeline" data-linenumber="1033"><td class="num" id="LN1033">1033</td><td class="line"><span class='keyword'>int</span> rewriteSortedSetObject(rio *r, robj *key, robj *o) {</td></tr>
<tr class="codeline" data-linenumber="1034"><td class="num" id="LN1034">1034</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> count = 0, items = zsetLength(o);</td></tr>
<tr class="codeline" data-linenumber="1035"><td class="num" id="LN1035">1035</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1036"><td class="num" id="LN1036">1036</td><td class="line">    <span class='keyword'>if</span> (o-&gt;encoding == <span class='macro'>OBJ_ENCODING_ZIPLIST<span class='macro_popup'>5</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1037"><td class="num" id="LN1037">1037</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl = o-&gt;ptr;</td></tr>
<tr class="codeline" data-linenumber="1038"><td class="num" id="LN1038">1038</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *eptr, *sptr;</td></tr>
<tr class="codeline" data-linenumber="1039"><td class="num" id="LN1039">1039</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *vstr;</td></tr>
<tr class="codeline" data-linenumber="1040"><td class="num" id="LN1040">1040</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>int</span> vlen;</td></tr>
<tr class="codeline" data-linenumber="1041"><td class="num" id="LN1041">1041</td><td class="line">        <span class='keyword'>long</span> <span class='keyword'>long</span> vll;</td></tr>
<tr class="codeline" data-linenumber="1042"><td class="num" id="LN1042">1042</td><td class="line">        <span class='keyword'>double</span> score;</td></tr>
<tr class="codeline" data-linenumber="1043"><td class="num" id="LN1043">1043</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1044"><td class="num" id="LN1044">1044</td><td class="line">        eptr = ziplistIndex(zl,0);</td></tr>
<tr class="codeline" data-linenumber="1045"><td class="num" id="LN1045">1045</td><td class="line">        <span class='macro'>serverAssert(eptr != NULL)<span class='macro_popup'>((eptr != ((void*)0))?(void)0 : (_serverAssert("eptr != NULL"<br>,"aof.c",1045),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1046"><td class="num" id="LN1046">1046</td><td class="line">        sptr = ziplistNext(zl,eptr);</td></tr>
<tr class="codeline" data-linenumber="1047"><td class="num" id="LN1047">1047</td><td class="line">        <span class='macro'>serverAssert(sptr != NULL)<span class='macro_popup'>((sptr != ((void*)0))?(void)0 : (_serverAssert("sptr != NULL"<br>,"aof.c",1047),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1048"><td class="num" id="LN1048">1048</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1049"><td class="num" id="LN1049">1049</td><td class="line">        <span class='keyword'>while</span> (eptr != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1050"><td class="num" id="LN1050">1050</td><td class="line">            <span class='macro'>serverAssert(ziplistGet(eptr,&amp;vstr,&amp;vlen,&amp;vll))<span class='macro_popup'>((ziplistGet(eptr,&amp;vstr,&amp;vlen,&amp;vll))?(void)0 : (_serverAssert<br>("ziplistGet(eptr,&amp;vstr,&amp;vlen,&amp;vll)","aof.c",1050<br>),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1051"><td class="num" id="LN1051">1051</td><td class="line">            score = zzlGetScore(sptr);</td></tr>
<tr class="codeline" data-linenumber="1052"><td class="num" id="LN1052">1052</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1053"><td class="num" id="LN1053">1053</td><td class="line">            <span class='keyword'>if</span> (count == 0) {</td></tr>
<tr class="codeline" data-linenumber="1054"><td class="num" id="LN1054">1054</td><td class="line">                <span class='keyword'>int</span> cmd_items = (items &gt; <span class='macro'>AOF_REWRITE_ITEMS_PER_CMD<span class='macro_popup'>64</span></span>) ?</td></tr>
<tr class="codeline" data-linenumber="1055"><td class="num" id="LN1055">1055</td><td class="line">                    <span class='macro'>AOF_REWRITE_ITEMS_PER_CMD<span class='macro_popup'>64</span></span> : items;</td></tr>
<tr class="codeline" data-linenumber="1056"><td class="num" id="LN1056">1056</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1057"><td class="num" id="LN1057">1057</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkCount(r,'*',2+cmd_items*2) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1058"><td class="num" id="LN1058">1058</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkString(r,<span class='string_literal'>"ZADD"</span>,4) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1059"><td class="num" id="LN1059">1059</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkObject(r,key) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1060"><td class="num" id="LN1060">1060</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1061"><td class="num" id="LN1061">1061</td><td class="line">            <span class='keyword'>if</span> (rioWriteBulkDouble(r,score) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1062"><td class="num" id="LN1062">1062</td><td class="line">            <span class='keyword'>if</span> (vstr != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1063"><td class="num" id="LN1063">1063</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkString(r,(<span class='keyword'>char</span>*)vstr,vlen) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1064"><td class="num" id="LN1064">1064</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1065"><td class="num" id="LN1065">1065</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkLongLong(r,vll) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1066"><td class="num" id="LN1066">1066</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1067"><td class="num" id="LN1067">1067</td><td class="line">            zzlNext(zl,&amp;eptr,&amp;sptr);</td></tr>
<tr class="codeline" data-linenumber="1068"><td class="num" id="LN1068">1068</td><td class="line">            <span class='keyword'>if</span> (++count == <span class='macro'>AOF_REWRITE_ITEMS_PER_CMD<span class='macro_popup'>64</span></span>) count = 0;</td></tr>
<tr class="codeline" data-linenumber="1069"><td class="num" id="LN1069">1069</td><td class="line">            items--;</td></tr>
<tr class="codeline" data-linenumber="1070"><td class="num" id="LN1070">1070</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1071"><td class="num" id="LN1071">1071</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (o-&gt;encoding == <span class='macro'>OBJ_ENCODING_SKIPLIST<span class='macro_popup'>7</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1072"><td class="num" id="LN1072">1072</td><td class="line">        zset *zs = o-&gt;ptr;</td></tr>
<tr class="codeline" data-linenumber="1073"><td class="num" id="LN1073">1073</td><td class="line">        dictIterator *di = dictGetIterator(zs-&gt;dict);</td></tr>
<tr class="codeline" data-linenumber="1074"><td class="num" id="LN1074">1074</td><td class="line">        dictEntry *de;</td></tr>
<tr class="codeline" data-linenumber="1075"><td class="num" id="LN1075">1075</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1076"><td class="num" id="LN1076">1076</td><td class="line">        <span class='keyword'>while</span>((de = dictNext(di)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1077"><td class="num" id="LN1077">1077</td><td class="line">            sds ele = <span class='macro'>dictGetKey(de)<span class='macro_popup'>((de)-&gt;key)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1078"><td class="num" id="LN1078">1078</td><td class="line">            <span class='keyword'>double</span> *score = <span class='macro'>dictGetVal(de)<span class='macro_popup'>((de)-&gt;v.val)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1079"><td class="num" id="LN1079">1079</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1080"><td class="num" id="LN1080">1080</td><td class="line">            <span class='keyword'>if</span> (count == 0) {</td></tr>
<tr class="codeline" data-linenumber="1081"><td class="num" id="LN1081">1081</td><td class="line">                <span class='keyword'>int</span> cmd_items = (items &gt; <span class='macro'>AOF_REWRITE_ITEMS_PER_CMD<span class='macro_popup'>64</span></span>) ?</td></tr>
<tr class="codeline" data-linenumber="1082"><td class="num" id="LN1082">1082</td><td class="line">                    <span class='macro'>AOF_REWRITE_ITEMS_PER_CMD<span class='macro_popup'>64</span></span> : items;</td></tr>
<tr class="codeline" data-linenumber="1083"><td class="num" id="LN1083">1083</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1084"><td class="num" id="LN1084">1084</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkCount(r,'*',2+cmd_items*2) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1085"><td class="num" id="LN1085">1085</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkString(r,<span class='string_literal'>"ZADD"</span>,4) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1086"><td class="num" id="LN1086">1086</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkObject(r,key) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1087"><td class="num" id="LN1087">1087</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1088"><td class="num" id="LN1088">1088</td><td class="line">            <span class='keyword'>if</span> (rioWriteBulkDouble(r,*score) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1089"><td class="num" id="LN1089">1089</td><td class="line">            <span class='keyword'>if</span> (rioWriteBulkString(r,ele,sdslen(ele)) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1090"><td class="num" id="LN1090">1090</td><td class="line">            <span class='keyword'>if</span> (++count == <span class='macro'>AOF_REWRITE_ITEMS_PER_CMD<span class='macro_popup'>64</span></span>) count = 0;</td></tr>
<tr class="codeline" data-linenumber="1091"><td class="num" id="LN1091">1091</td><td class="line">            items--;</td></tr>
<tr class="codeline" data-linenumber="1092"><td class="num" id="LN1092">1092</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1093"><td class="num" id="LN1093">1093</td><td class="line">        dictReleaseIterator(di);</td></tr>
<tr class="codeline" data-linenumber="1094"><td class="num" id="LN1094">1094</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1095"><td class="num" id="LN1095">1095</td><td class="line">        <span class='macro'>serverPanic(<span class='string_literal'>"Unknown sorted zset encoding"</span>)<span class='macro_popup'>_serverPanic("aof.c",1095,"Unknown sorted zset encoding"),_exit<br>(1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1096"><td class="num" id="LN1096">1096</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1097"><td class="num" id="LN1097">1097</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1098"><td class="num" id="LN1098">1098</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1099"><td class="num" id="LN1099">1099</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1100"><td class="num" id="LN1100">1100</td><td class="line"><span class='comment'>/* Write either the key or the value of the currently selected item of a hash.</span></td></tr>
<tr class="codeline" data-linenumber="1101"><td class="num" id="LN1101">1101</td><td class="line"> <span class='comment'>* The 'hi' argument passes a valid Redis hash iterator.</span></td></tr>
<tr class="codeline" data-linenumber="1102"><td class="num" id="LN1102">1102</td><td class="line"> <span class='comment'>* The 'what' filed specifies if to write a key or a value and can be</span></td></tr>
<tr class="codeline" data-linenumber="1103"><td class="num" id="LN1103">1103</td><td class="line"> <span class='comment'>* either OBJ_HASH_KEY or OBJ_HASH_VALUE.</span></td></tr>
<tr class="codeline" data-linenumber="1104"><td class="num" id="LN1104">1104</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1105"><td class="num" id="LN1105">1105</td><td class="line"> <span class='comment'>* The function returns 0 on error, non-zero on success. */</span></td></tr>
<tr class="codeline" data-linenumber="1106"><td class="num" id="LN1106">1106</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> rioWriteHashIteratorCursor(rio *r, hashTypeIterator *hi, <span class='keyword'>int</span> what) {</td></tr>
<tr class="codeline" data-linenumber="1107"><td class="num" id="LN1107">1107</td><td class="line">    <span class='keyword'>if</span> (hi-&gt;encoding == <span class='macro'>OBJ_ENCODING_ZIPLIST<span class='macro_popup'>5</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1108"><td class="num" id="LN1108">1108</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *vstr = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1109"><td class="num" id="LN1109">1109</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>int</span> vlen = <span class='macro'>UINT_MAX<span class='macro_popup'>(2147483647 *2U +1U)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1110"><td class="num" id="LN1110">1110</td><td class="line">        <span class='keyword'>long</span> <span class='keyword'>long</span> vll = <span class='macro'>LLONG_MAX<span class='macro_popup'>9223372036854775807LL</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1111"><td class="num" id="LN1111">1111</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1112"><td class="num" id="LN1112">1112</td><td class="line">        hashTypeCurrentFromZiplist(hi, what, &amp;vstr, &amp;vlen, &amp;vll);</td></tr>
<tr class="codeline" data-linenumber="1113"><td class="num" id="LN1113">1113</td><td class="line">        <span class='keyword'>if</span> (vstr)</td></tr>
<tr class="codeline" data-linenumber="1114"><td class="num" id="LN1114">1114</td><td class="line">            <span class='keyword'>return</span> rioWriteBulkString(r, (<span class='keyword'>char</span>*)vstr, vlen);</td></tr>
<tr class="codeline" data-linenumber="1115"><td class="num" id="LN1115">1115</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1116"><td class="num" id="LN1116">1116</td><td class="line">            <span class='keyword'>return</span> rioWriteBulkLongLong(r, vll);</td></tr>
<tr class="codeline" data-linenumber="1117"><td class="num" id="LN1117">1117</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (hi-&gt;encoding == <span class='macro'>OBJ_ENCODING_HT<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1118"><td class="num" id="LN1118">1118</td><td class="line">        sds value = hashTypeCurrentFromHashTable(hi, what);</td></tr>
<tr class="codeline" data-linenumber="1119"><td class="num" id="LN1119">1119</td><td class="line">        <span class='keyword'>return</span> rioWriteBulkString(r, value, sdslen(value));</td></tr>
<tr class="codeline" data-linenumber="1120"><td class="num" id="LN1120">1120</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1121"><td class="num" id="LN1121">1121</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1122"><td class="num" id="LN1122">1122</td><td class="line">    <span class='macro'>serverPanic(<span class='string_literal'>"Unknown hash encoding"</span>)<span class='macro_popup'>_serverPanic("aof.c",1122,"Unknown hash encoding"),_exit(1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1123"><td class="num" id="LN1123">1123</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1124"><td class="num" id="LN1124">1124</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1125"><td class="num" id="LN1125">1125</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1126"><td class="num" id="LN1126">1126</td><td class="line"><span class='comment'>/* Emit the commands needed to rebuild a hash object.</span></td></tr>
<tr class="codeline" data-linenumber="1127"><td class="num" id="LN1127">1127</td><td class="line"> <span class='comment'>* The function returns 0 on error, 1 on success. */</span></td></tr>
<tr class="codeline" data-linenumber="1128"><td class="num" id="LN1128">1128</td><td class="line"><span class='keyword'>int</span> rewriteHashObject(rio *r, robj *key, robj *o) {</td></tr>
<tr class="codeline" data-linenumber="1129"><td class="num" id="LN1129">1129</td><td class="line">    hashTypeIterator *hi;</td></tr>
<tr class="codeline" data-linenumber="1130"><td class="num" id="LN1130">1130</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> count = 0, items = hashTypeLength(o);</td></tr>
<tr class="codeline" data-linenumber="1131"><td class="num" id="LN1131">1131</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1132"><td class="num" id="LN1132">1132</td><td class="line">    hi = hashTypeInitIterator(o);</td></tr>
<tr class="codeline" data-linenumber="1133"><td class="num" id="LN1133">1133</td><td class="line">    <span class='keyword'>while</span> (hashTypeNext(hi) != <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1134"><td class="num" id="LN1134">1134</td><td class="line">        <span class='keyword'>if</span> (count == 0) {</td></tr>
<tr class="codeline" data-linenumber="1135"><td class="num" id="LN1135">1135</td><td class="line">            <span class='keyword'>int</span> cmd_items = (items &gt; <span class='macro'>AOF_REWRITE_ITEMS_PER_CMD<span class='macro_popup'>64</span></span>) ?</td></tr>
<tr class="codeline" data-linenumber="1136"><td class="num" id="LN1136">1136</td><td class="line">                <span class='macro'>AOF_REWRITE_ITEMS_PER_CMD<span class='macro_popup'>64</span></span> : items;</td></tr>
<tr class="codeline" data-linenumber="1137"><td class="num" id="LN1137">1137</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1138"><td class="num" id="LN1138">1138</td><td class="line">            <span class='keyword'>if</span> (rioWriteBulkCount(r,'*',2+cmd_items*2) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1139"><td class="num" id="LN1139">1139</td><td class="line">            <span class='keyword'>if</span> (rioWriteBulkString(r,<span class='string_literal'>"HMSET"</span>,5) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1140"><td class="num" id="LN1140">1140</td><td class="line">            <span class='keyword'>if</span> (rioWriteBulkObject(r,key) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1141"><td class="num" id="LN1141">1141</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1142"><td class="num" id="LN1142">1142</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1143"><td class="num" id="LN1143">1143</td><td class="line">        <span class='keyword'>if</span> (rioWriteHashIteratorCursor(r, hi, <span class='macro'>OBJ_HASH_KEY<span class='macro_popup'>1</span></span>) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1144"><td class="num" id="LN1144">1144</td><td class="line">        <span class='keyword'>if</span> (rioWriteHashIteratorCursor(r, hi, <span class='macro'>OBJ_HASH_VALUE<span class='macro_popup'>2</span></span>) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1145"><td class="num" id="LN1145">1145</td><td class="line">        <span class='keyword'>if</span> (++count == <span class='macro'>AOF_REWRITE_ITEMS_PER_CMD<span class='macro_popup'>64</span></span>) count = 0;</td></tr>
<tr class="codeline" data-linenumber="1146"><td class="num" id="LN1146">1146</td><td class="line">        items--;</td></tr>
<tr class="codeline" data-linenumber="1147"><td class="num" id="LN1147">1147</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1148"><td class="num" id="LN1148">1148</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1149"><td class="num" id="LN1149">1149</td><td class="line">    hashTypeReleaseIterator(hi);</td></tr>
<tr class="codeline" data-linenumber="1150"><td class="num" id="LN1150">1150</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1151"><td class="num" id="LN1151">1151</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1152"><td class="num" id="LN1152">1152</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1153"><td class="num" id="LN1153">1153</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1154"><td class="num" id="LN1154">1154</td><td class="line"><span class='comment'>/* Helper for rewriteStreamObject() that generates a bulk string into the</span></td></tr>
<tr class="codeline" data-linenumber="1155"><td class="num" id="LN1155">1155</td><td class="line"> <span class='comment'>* AOF representing the ID 'id'. */</span></td></tr>
<tr class="codeline" data-linenumber="1156"><td class="num" id="LN1156">1156</td><td class="line"><span class='keyword'>int</span> rioWriteBulkStreamID(rio *r,streamID *id) {</td></tr>
<tr class="codeline" data-linenumber="1157"><td class="num" id="LN1157">1157</td><td class="line">    <span class='keyword'>int</span> retval;</td></tr>
<tr class="codeline" data-linenumber="1158"><td class="num" id="LN1158">1158</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1159"><td class="num" id="LN1159">1159</td><td class="line">    sds replyid = sdscatfmt(sdsempty(),<span class='string_literal'>"%U-%U"</span>,id-&gt;ms,id-&gt;seq);</td></tr>
<tr class="codeline" data-linenumber="1160"><td class="num" id="LN1160">1160</td><td class="line">    retval = rioWriteBulkString(r,replyid,sdslen(replyid));</td></tr>
<tr class="codeline" data-linenumber="1161"><td class="num" id="LN1161">1161</td><td class="line">    sdsfree(replyid);</td></tr>
<tr class="codeline" data-linenumber="1162"><td class="num" id="LN1162">1162</td><td class="line">    <span class='keyword'>return</span> retval;</td></tr>
<tr class="codeline" data-linenumber="1163"><td class="num" id="LN1163">1163</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1164"><td class="num" id="LN1164">1164</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1165"><td class="num" id="LN1165">1165</td><td class="line"><span class='comment'>/* Helper for rewriteStreamObject(): emit the XCLAIM needed in order to</span></td></tr>
<tr class="codeline" data-linenumber="1166"><td class="num" id="LN1166">1166</td><td class="line"> <span class='comment'>* add the message described by 'nack' having the id 'rawid', into the pending</span></td></tr>
<tr class="codeline" data-linenumber="1167"><td class="num" id="LN1167">1167</td><td class="line"> <span class='comment'>* list of the specified consumer. All this in the context of the specified</span></td></tr>
<tr class="codeline" data-linenumber="1168"><td class="num" id="LN1168">1168</td><td class="line"> <span class='comment'>* key and group. */</span></td></tr>
<tr class="codeline" data-linenumber="1169"><td class="num" id="LN1169">1169</td><td class="line"><span class='keyword'>int</span> rioWriteStreamPendingEntry(rio *r, robj *key, <span class='keyword'>const</span> <span class='keyword'>char</span> *groupname, size_t groupname_len, streamConsumer *consumer, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *rawid, streamNACK *nack) {</td></tr>
<tr class="codeline" data-linenumber="1170"><td class="num" id="LN1170">1170</td><td class="line">     <span class='comment'>/* XCLAIM &lt;key&gt; &lt;group&gt; &lt;consumer&gt; 0 &lt;id&gt; TIME &lt;milliseconds-unix-time&gt;</span></td></tr>
<tr class="codeline" data-linenumber="1171"><td class="num" id="LN1171">1171</td><td class="line">               <span class='comment'>RETRYCOUNT &lt;count&gt; JUSTID FORCE. */</span></td></tr>
<tr class="codeline" data-linenumber="1172"><td class="num" id="LN1172">1172</td><td class="line">    streamID id;</td></tr>
<tr class="codeline" data-linenumber="1173"><td class="num" id="LN1173">1173</td><td class="line">    streamDecodeID(rawid,&amp;id);</td></tr>
<tr class="codeline" data-linenumber="1174"><td class="num" id="LN1174">1174</td><td class="line">    <span class='keyword'>if</span> (rioWriteBulkCount(r,'*',12) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1175"><td class="num" id="LN1175">1175</td><td class="line">    <span class='keyword'>if</span> (rioWriteBulkString(r,<span class='string_literal'>"XCLAIM"</span>,6) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1176"><td class="num" id="LN1176">1176</td><td class="line">    <span class='keyword'>if</span> (rioWriteBulkObject(r,key) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1177"><td class="num" id="LN1177">1177</td><td class="line">    <span class='keyword'>if</span> (rioWriteBulkString(r,groupname,groupname_len) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1178"><td class="num" id="LN1178">1178</td><td class="line">    <span class='keyword'>if</span> (rioWriteBulkString(r,consumer-&gt;name,sdslen(consumer-&gt;name)) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1179"><td class="num" id="LN1179">1179</td><td class="line">    <span class='keyword'>if</span> (rioWriteBulkString(r,<span class='string_literal'>"0"</span>,1) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1180"><td class="num" id="LN1180">1180</td><td class="line">    <span class='keyword'>if</span> (rioWriteBulkStreamID(r,&amp;id) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1181"><td class="num" id="LN1181">1181</td><td class="line">    <span class='keyword'>if</span> (rioWriteBulkString(r,<span class='string_literal'>"TIME"</span>,4) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1182"><td class="num" id="LN1182">1182</td><td class="line">    <span class='keyword'>if</span> (rioWriteBulkLongLong(r,nack-&gt;delivery_time) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1183"><td class="num" id="LN1183">1183</td><td class="line">    <span class='keyword'>if</span> (rioWriteBulkString(r,<span class='string_literal'>"RETRYCOUNT"</span>,10) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1184"><td class="num" id="LN1184">1184</td><td class="line">    <span class='keyword'>if</span> (rioWriteBulkLongLong(r,nack-&gt;delivery_count) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1185"><td class="num" id="LN1185">1185</td><td class="line">    <span class='keyword'>if</span> (rioWriteBulkString(r,<span class='string_literal'>"JUSTID"</span>,6) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1186"><td class="num" id="LN1186">1186</td><td class="line">    <span class='keyword'>if</span> (rioWriteBulkString(r,<span class='string_literal'>"FORCE"</span>,5) == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1187"><td class="num" id="LN1187">1187</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1188"><td class="num" id="LN1188">1188</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1189"><td class="num" id="LN1189">1189</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1190"><td class="num" id="LN1190">1190</td><td class="line"><span class='comment'>/* Emit the commands needed to rebuild a stream object.</span></td></tr>
<tr class="codeline" data-linenumber="1191"><td class="num" id="LN1191">1191</td><td class="line"> <span class='comment'>* The function returns 0 on error, 1 on success. */</span></td></tr>
<tr class="codeline" data-linenumber="1192"><td class="num" id="LN1192">1192</td><td class="line"><span class='keyword'>int</span> rewriteStreamObject(rio *r, robj *key, robj *o) {</td></tr>
<tr class="codeline" data-linenumber="1193"><td class="num" id="LN1193">1193</td><td class="line">    stream *s = o-&gt;ptr;</td></tr>
<tr class="codeline" data-linenumber="1194"><td class="num" id="LN1194">1194</td><td class="line">    streamIterator si;</td></tr>
<tr class="codeline" data-linenumber="1195"><td class="num" id="LN1195">1195</td><td class="line">    streamIteratorStart(&amp;si,s,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0);</td></tr>
<tr class="codeline" data-linenumber="1196"><td class="num" id="LN1196">1196</td><td class="line">    streamID id;</td></tr>
<tr class="codeline" data-linenumber="1197"><td class="num" id="LN1197">1197</td><td class="line">    int64_t numfields;</td></tr>
<tr class="codeline" data-linenumber="1198"><td class="num" id="LN1198">1198</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1199"><td class="num" id="LN1199">1199</td><td class="line">    <span class='keyword'>if</span> (s-&gt;length) {</td></tr>
<tr class="codeline" data-linenumber="1200"><td class="num" id="LN1200">1200</td><td class="line">        <span class='comment'>/* Reconstruct the stream data using XADD commands. */</span></td></tr>
<tr class="codeline" data-linenumber="1201"><td class="num" id="LN1201">1201</td><td class="line">        <span class='keyword'>while</span>(streamIteratorGetID(&amp;si,&amp;id,&amp;numfields)) {</td></tr>
<tr class="codeline" data-linenumber="1202"><td class="num" id="LN1202">1202</td><td class="line">            <span class='comment'>/* Emit a two elements array for each item. The first is</span></td></tr>
<tr class="codeline" data-linenumber="1203"><td class="num" id="LN1203">1203</td><td class="line">             <span class='comment'>* the ID, the second is an array of field-value pairs. */</span></td></tr>
<tr class="codeline" data-linenumber="1204"><td class="num" id="LN1204">1204</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1205"><td class="num" id="LN1205">1205</td><td class="line">            <span class='comment'>/* Emit the XADD &lt;key&gt; &lt;id&gt; ...fields... command. */</span></td></tr>
<tr class="codeline" data-linenumber="1206"><td class="num" id="LN1206">1206</td><td class="line">            <span class='keyword'>if</span> (!rioWriteBulkCount(r,'*',3+numfields*2) || </td></tr>
<tr class="codeline" data-linenumber="1207"><td class="num" id="LN1207">1207</td><td class="line">                !rioWriteBulkString(r,<span class='string_literal'>"XADD"</span>,4) ||</td></tr>
<tr class="codeline" data-linenumber="1208"><td class="num" id="LN1208">1208</td><td class="line">                !rioWriteBulkObject(r,key) ||</td></tr>
<tr class="codeline" data-linenumber="1209"><td class="num" id="LN1209">1209</td><td class="line">                !rioWriteBulkStreamID(r,&amp;id)) </td></tr>
<tr class="codeline" data-linenumber="1210"><td class="num" id="LN1210">1210</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="1211"><td class="num" id="LN1211">1211</td><td class="line">                streamIteratorStop(&amp;si);</td></tr>
<tr class="codeline" data-linenumber="1212"><td class="num" id="LN1212">1212</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1213"><td class="num" id="LN1213">1213</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1214"><td class="num" id="LN1214">1214</td><td class="line">            <span class='keyword'>while</span>(numfields--) {</td></tr>
<tr class="codeline" data-linenumber="1215"><td class="num" id="LN1215">1215</td><td class="line">                <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *field, *value;</td></tr>
<tr class="codeline" data-linenumber="1216"><td class="num" id="LN1216">1216</td><td class="line">                int64_t field_len, value_len;</td></tr>
<tr class="codeline" data-linenumber="1217"><td class="num" id="LN1217">1217</td><td class="line">                streamIteratorGetField(&amp;si,&amp;field,&amp;value,&amp;field_len,&amp;value_len);</td></tr>
<tr class="codeline" data-linenumber="1218"><td class="num" id="LN1218">1218</td><td class="line">                <span class='keyword'>if</span> (!rioWriteBulkString(r,(<span class='keyword'>char</span>*)field,field_len) ||</td></tr>
<tr class="codeline" data-linenumber="1219"><td class="num" id="LN1219">1219</td><td class="line">                    !rioWriteBulkString(r,(<span class='keyword'>char</span>*)value,value_len)) </td></tr>
<tr class="codeline" data-linenumber="1220"><td class="num" id="LN1220">1220</td><td class="line">                {</td></tr>
<tr class="codeline" data-linenumber="1221"><td class="num" id="LN1221">1221</td><td class="line">                    streamIteratorStop(&amp;si);</td></tr>
<tr class="codeline" data-linenumber="1222"><td class="num" id="LN1222">1222</td><td class="line">                    <span class='keyword'>return</span> 0;                  </td></tr>
<tr class="codeline" data-linenumber="1223"><td class="num" id="LN1223">1223</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1224"><td class="num" id="LN1224">1224</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1225"><td class="num" id="LN1225">1225</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1226"><td class="num" id="LN1226">1226</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1227"><td class="num" id="LN1227">1227</td><td class="line">        <span class='comment'>/* Use the XADD MAXLEN 0 trick to generate an empty stream if</span></td></tr>
<tr class="codeline" data-linenumber="1228"><td class="num" id="LN1228">1228</td><td class="line">         <span class='comment'>* the key we are serializing is an empty string, which is possible</span></td></tr>
<tr class="codeline" data-linenumber="1229"><td class="num" id="LN1229">1229</td><td class="line">         <span class='comment'>* for the Stream type. */</span></td></tr>
<tr class="codeline" data-linenumber="1230"><td class="num" id="LN1230">1230</td><td class="line">        id.ms = 0; id.seq = 1; </td></tr>
<tr class="codeline" data-linenumber="1231"><td class="num" id="LN1231">1231</td><td class="line">        <span class='keyword'>if</span> (!rioWriteBulkCount(r,'*',7) ||</td></tr>
<tr class="codeline" data-linenumber="1232"><td class="num" id="LN1232">1232</td><td class="line">            !rioWriteBulkString(r,<span class='string_literal'>"XADD"</span>,4) ||</td></tr>
<tr class="codeline" data-linenumber="1233"><td class="num" id="LN1233">1233</td><td class="line">            !rioWriteBulkObject(r,key) ||</td></tr>
<tr class="codeline" data-linenumber="1234"><td class="num" id="LN1234">1234</td><td class="line">            !rioWriteBulkString(r,<span class='string_literal'>"MAXLEN"</span>,6) ||</td></tr>
<tr class="codeline" data-linenumber="1235"><td class="num" id="LN1235">1235</td><td class="line">            !rioWriteBulkString(r,<span class='string_literal'>"0"</span>,1) ||</td></tr>
<tr class="codeline" data-linenumber="1236"><td class="num" id="LN1236">1236</td><td class="line">            !rioWriteBulkStreamID(r,&amp;id) ||</td></tr>
<tr class="codeline" data-linenumber="1237"><td class="num" id="LN1237">1237</td><td class="line">            !rioWriteBulkString(r,<span class='string_literal'>"x"</span>,1) ||</td></tr>
<tr class="codeline" data-linenumber="1238"><td class="num" id="LN1238">1238</td><td class="line">            !rioWriteBulkString(r,<span class='string_literal'>"y"</span>,1))</td></tr>
<tr class="codeline" data-linenumber="1239"><td class="num" id="LN1239">1239</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="1240"><td class="num" id="LN1240">1240</td><td class="line">            streamIteratorStop(&amp;si);</td></tr>
<tr class="codeline" data-linenumber="1241"><td class="num" id="LN1241">1241</td><td class="line">            <span class='keyword'>return</span> 0;     </td></tr>
<tr class="codeline" data-linenumber="1242"><td class="num" id="LN1242">1242</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1243"><td class="num" id="LN1243">1243</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1244"><td class="num" id="LN1244">1244</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1245"><td class="num" id="LN1245">1245</td><td class="line">    <span class='comment'>/* Append XSETID after XADD, make sure lastid is correct,</span></td></tr>
<tr class="codeline" data-linenumber="1246"><td class="num" id="LN1246">1246</td><td class="line">     <span class='comment'>* in case of XDEL lastid. */</span></td></tr>
<tr class="codeline" data-linenumber="1247"><td class="num" id="LN1247">1247</td><td class="line">    <span class='keyword'>if</span> (!rioWriteBulkCount(r,'*',3) ||</td></tr>
<tr class="codeline" data-linenumber="1248"><td class="num" id="LN1248">1248</td><td class="line">        !rioWriteBulkString(r,<span class='string_literal'>"XSETID"</span>,6) ||</td></tr>
<tr class="codeline" data-linenumber="1249"><td class="num" id="LN1249">1249</td><td class="line">        !rioWriteBulkObject(r,key) ||</td></tr>
<tr class="codeline" data-linenumber="1250"><td class="num" id="LN1250">1250</td><td class="line">        !rioWriteBulkStreamID(r,&amp;s-&gt;last_id)) </td></tr>
<tr class="codeline" data-linenumber="1251"><td class="num" id="LN1251">1251</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1252"><td class="num" id="LN1252">1252</td><td class="line">        streamIteratorStop(&amp;si);</td></tr>
<tr class="codeline" data-linenumber="1253"><td class="num" id="LN1253">1253</td><td class="line">        <span class='keyword'>return</span> 0; </td></tr>
<tr class="codeline" data-linenumber="1254"><td class="num" id="LN1254">1254</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1255"><td class="num" id="LN1255">1255</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1256"><td class="num" id="LN1256">1256</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1257"><td class="num" id="LN1257">1257</td><td class="line">    <span class='comment'>/* Create all the stream consumer groups. */</span></td></tr>
<tr class="codeline" data-linenumber="1258"><td class="num" id="LN1258">1258</td><td class="line">    <span class='keyword'>if</span> (s-&gt;cgroups) {</td></tr>
<tr class="codeline" data-linenumber="1259"><td class="num" id="LN1259">1259</td><td class="line">        raxIterator ri;</td></tr>
<tr class="codeline" data-linenumber="1260"><td class="num" id="LN1260">1260</td><td class="line">        raxStart(&amp;ri,s-&gt;cgroups);</td></tr>
<tr class="codeline" data-linenumber="1261"><td class="num" id="LN1261">1261</td><td class="line">        raxSeek(&amp;ri,<span class='string_literal'>"^"</span>,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0);</td></tr>
<tr class="codeline" data-linenumber="1262"><td class="num" id="LN1262">1262</td><td class="line">        <span class='keyword'>while</span>(raxNext(&amp;ri)) {</td></tr>
<tr class="codeline" data-linenumber="1263"><td class="num" id="LN1263">1263</td><td class="line">            streamCG *group = ri.data;</td></tr>
<tr class="codeline" data-linenumber="1264"><td class="num" id="LN1264">1264</td><td class="line">            <span class='comment'>/* Emit the XGROUP CREATE in order to create the group. */</span></td></tr>
<tr class="codeline" data-linenumber="1265"><td class="num" id="LN1265">1265</td><td class="line">            <span class='keyword'>if</span> (!rioWriteBulkCount(r,'*',5) ||</td></tr>
<tr class="codeline" data-linenumber="1266"><td class="num" id="LN1266">1266</td><td class="line">                !rioWriteBulkString(r,<span class='string_literal'>"XGROUP"</span>,6) ||</td></tr>
<tr class="codeline" data-linenumber="1267"><td class="num" id="LN1267">1267</td><td class="line">                !rioWriteBulkString(r,<span class='string_literal'>"CREATE"</span>,6) ||</td></tr>
<tr class="codeline" data-linenumber="1268"><td class="num" id="LN1268">1268</td><td class="line">                !rioWriteBulkObject(r,key) ||</td></tr>
<tr class="codeline" data-linenumber="1269"><td class="num" id="LN1269">1269</td><td class="line">                !rioWriteBulkString(r,(<span class='keyword'>char</span>*)ri.key,ri.key_len) ||</td></tr>
<tr class="codeline" data-linenumber="1270"><td class="num" id="LN1270">1270</td><td class="line">                !rioWriteBulkStreamID(r,&amp;group-&gt;last_id)) </td></tr>
<tr class="codeline" data-linenumber="1271"><td class="num" id="LN1271">1271</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="1272"><td class="num" id="LN1272">1272</td><td class="line">                raxStop(&amp;ri);</td></tr>
<tr class="codeline" data-linenumber="1273"><td class="num" id="LN1273">1273</td><td class="line">                streamIteratorStop(&amp;si);</td></tr>
<tr class="codeline" data-linenumber="1274"><td class="num" id="LN1274">1274</td><td class="line">                <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1275"><td class="num" id="LN1275">1275</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1276"><td class="num" id="LN1276">1276</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1277"><td class="num" id="LN1277">1277</td><td class="line">            <span class='comment'>/* Generate XCLAIMs for each consumer that happens to</span></td></tr>
<tr class="codeline" data-linenumber="1278"><td class="num" id="LN1278">1278</td><td class="line">             <span class='comment'>* have pending entries. Empty consumers have no semantical</span></td></tr>
<tr class="codeline" data-linenumber="1279"><td class="num" id="LN1279">1279</td><td class="line">             <span class='comment'>* value so they are discarded. */</span></td></tr>
<tr class="codeline" data-linenumber="1280"><td class="num" id="LN1280">1280</td><td class="line">            raxIterator ri_cons;</td></tr>
<tr class="codeline" data-linenumber="1281"><td class="num" id="LN1281">1281</td><td class="line">            raxStart(&amp;ri_cons,group-&gt;consumers);</td></tr>
<tr class="codeline" data-linenumber="1282"><td class="num" id="LN1282">1282</td><td class="line">            raxSeek(&amp;ri_cons,<span class='string_literal'>"^"</span>,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0);</td></tr>
<tr class="codeline" data-linenumber="1283"><td class="num" id="LN1283">1283</td><td class="line">            <span class='keyword'>while</span>(raxNext(&amp;ri_cons)) {</td></tr>
<tr class="codeline" data-linenumber="1284"><td class="num" id="LN1284">1284</td><td class="line">                streamConsumer *consumer = ri_cons.data;</td></tr>
<tr class="codeline" data-linenumber="1285"><td class="num" id="LN1285">1285</td><td class="line">                <span class='comment'>/* For the current consumer, iterate all the PEL entries</span></td></tr>
<tr class="codeline" data-linenumber="1286"><td class="num" id="LN1286">1286</td><td class="line">                 <span class='comment'>* to emit the XCLAIM protocol. */</span></td></tr>
<tr class="codeline" data-linenumber="1287"><td class="num" id="LN1287">1287</td><td class="line">                raxIterator ri_pel;</td></tr>
<tr class="codeline" data-linenumber="1288"><td class="num" id="LN1288">1288</td><td class="line">                raxStart(&amp;ri_pel,consumer-&gt;pel);</td></tr>
<tr class="codeline" data-linenumber="1289"><td class="num" id="LN1289">1289</td><td class="line">                raxSeek(&amp;ri_pel,<span class='string_literal'>"^"</span>,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0);</td></tr>
<tr class="codeline" data-linenumber="1290"><td class="num" id="LN1290">1290</td><td class="line">                <span class='keyword'>while</span>(raxNext(&amp;ri_pel)) {</td></tr>
<tr class="codeline" data-linenumber="1291"><td class="num" id="LN1291">1291</td><td class="line">                    streamNACK *nack = ri_pel.data;</td></tr>
<tr class="codeline" data-linenumber="1292"><td class="num" id="LN1292">1292</td><td class="line">                    <span class='keyword'>if</span> (rioWriteStreamPendingEntry(r,key,(<span class='keyword'>char</span>*)ri.key,</td></tr>
<tr class="codeline" data-linenumber="1293"><td class="num" id="LN1293">1293</td><td class="line">                                                   ri.key_len,consumer,</td></tr>
<tr class="codeline" data-linenumber="1294"><td class="num" id="LN1294">1294</td><td class="line">                                                   ri_pel.key,nack) == 0)</td></tr>
<tr class="codeline" data-linenumber="1295"><td class="num" id="LN1295">1295</td><td class="line">                    {</td></tr>
<tr class="codeline" data-linenumber="1296"><td class="num" id="LN1296">1296</td><td class="line">                        raxStop(&amp;ri_pel);</td></tr>
<tr class="codeline" data-linenumber="1297"><td class="num" id="LN1297">1297</td><td class="line">                        raxStop(&amp;ri_cons);</td></tr>
<tr class="codeline" data-linenumber="1298"><td class="num" id="LN1298">1298</td><td class="line">                        raxStop(&amp;ri);</td></tr>
<tr class="codeline" data-linenumber="1299"><td class="num" id="LN1299">1299</td><td class="line">                        streamIteratorStop(&amp;si);</td></tr>
<tr class="codeline" data-linenumber="1300"><td class="num" id="LN1300">1300</td><td class="line">                        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1301"><td class="num" id="LN1301">1301</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="1302"><td class="num" id="LN1302">1302</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1303"><td class="num" id="LN1303">1303</td><td class="line">                raxStop(&amp;ri_pel);</td></tr>
<tr class="codeline" data-linenumber="1304"><td class="num" id="LN1304">1304</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1305"><td class="num" id="LN1305">1305</td><td class="line">            raxStop(&amp;ri_cons);</td></tr>
<tr class="codeline" data-linenumber="1306"><td class="num" id="LN1306">1306</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1307"><td class="num" id="LN1307">1307</td><td class="line">        raxStop(&amp;ri);</td></tr>
<tr class="codeline" data-linenumber="1308"><td class="num" id="LN1308">1308</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1309"><td class="num" id="LN1309">1309</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1310"><td class="num" id="LN1310">1310</td><td class="line">    streamIteratorStop(&amp;si);</td></tr>
<tr class="codeline" data-linenumber="1311"><td class="num" id="LN1311">1311</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1312"><td class="num" id="LN1312">1312</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1313"><td class="num" id="LN1313">1313</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1314"><td class="num" id="LN1314">1314</td><td class="line"><span class='comment'>/* Call the module type callback in order to rewrite a data type</span></td></tr>
<tr class="codeline" data-linenumber="1315"><td class="num" id="LN1315">1315</td><td class="line"> <span class='comment'>* that is exported by a module and is not handled by Redis itself.</span></td></tr>
<tr class="codeline" data-linenumber="1316"><td class="num" id="LN1316">1316</td><td class="line"> <span class='comment'>* The function returns 0 on error, 1 on success. */</span></td></tr>
<tr class="codeline" data-linenumber="1317"><td class="num" id="LN1317">1317</td><td class="line"><span class='keyword'>int</span> rewriteModuleObject(rio *r, robj *key, robj *o) {</td></tr>
<tr class="codeline" data-linenumber="1318"><td class="num" id="LN1318">1318</td><td class="line">    RedisModuleIO io;</td></tr>
<tr class="codeline" data-linenumber="1319"><td class="num" id="LN1319">1319</td><td class="line">    moduleValue *mv = o-&gt;ptr;</td></tr>
<tr class="codeline" data-linenumber="1320"><td class="num" id="LN1320">1320</td><td class="line">    moduleType *mt = mv-&gt;type;</td></tr>
<tr class="codeline" data-linenumber="1321"><td class="num" id="LN1321">1321</td><td class="line">    <span class='macro'>moduleInitIOContext(io,mt,r,key)<span class='macro_popup'>do { io.rio = r; io.type = mt; io.bytes = 0; io.error = 0; io<br>.ver = 0; io.key = key; io.ctx = ((void*)0); } while(0);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1322"><td class="num" id="LN1322">1322</td><td class="line">    mt-&gt;aof_rewrite(&amp;io,key,mv-&gt;value);</td></tr>
<tr class="codeline" data-linenumber="1323"><td class="num" id="LN1323">1323</td><td class="line">    <span class='keyword'>if</span> (io.ctx) {</td></tr>
<tr class="codeline" data-linenumber="1324"><td class="num" id="LN1324">1324</td><td class="line">        moduleFreeContext(io.ctx);</td></tr>
<tr class="codeline" data-linenumber="1325"><td class="num" id="LN1325">1325</td><td class="line">        zfree(io.ctx);</td></tr>
<tr class="codeline" data-linenumber="1326"><td class="num" id="LN1326">1326</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1327"><td class="num" id="LN1327">1327</td><td class="line">    <span class='keyword'>return</span> io.error ? 0 : 1;</td></tr>
<tr class="codeline" data-linenumber="1328"><td class="num" id="LN1328">1328</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1329"><td class="num" id="LN1329">1329</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1330"><td class="num" id="LN1330">1330</td><td class="line"><span class='comment'>/* This function is called by the child rewriting the AOF file to read</span></td></tr>
<tr class="codeline" data-linenumber="1331"><td class="num" id="LN1331">1331</td><td class="line"> <span class='comment'>* the difference accumulated from the parent into a buffer, that is</span></td></tr>
<tr class="codeline" data-linenumber="1332"><td class="num" id="LN1332">1332</td><td class="line"> <span class='comment'>* concatenated at the end of the rewrite. */</span></td></tr>
<tr class="codeline" data-linenumber="1333"><td class="num" id="LN1333">1333</td><td class="line">ssize_t aofReadDiffFromParent(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1334"><td class="num" id="LN1334">1334</td><td class="line">    <span class='keyword'>char</span> buf[65536]; <span class='comment'>/* Default pipe buffer size on most Linux systems. */</span></td></tr>
<tr class="codeline" data-linenumber="1335"><td class="num" id="LN1335">1335</td><td class="line">    ssize_t nread, total = 0;</td></tr>
<tr class="codeline" data-linenumber="1336"><td class="num" id="LN1336">1336</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1337"><td class="num" id="LN1337">1337</td><td class="line">    <span class='keyword'>while</span> ((nread =</td></tr>
<tr class="codeline" data-linenumber="1338"><td class="num" id="LN1338">1338</td><td class="line">            read(server.aof_pipe_read_data_from_parent,buf,<span class='keyword'>sizeof</span>(buf))) &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="1339"><td class="num" id="LN1339">1339</td><td class="line">        server.aof_child_diff = sdscatlen(server.aof_child_diff,buf,nread);</td></tr>
<tr class="codeline" data-linenumber="1340"><td class="num" id="LN1340">1340</td><td class="line">        total += nread;</td></tr>
<tr class="codeline" data-linenumber="1341"><td class="num" id="LN1341">1341</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1342"><td class="num" id="LN1342">1342</td><td class="line">    <span class='keyword'>return</span> total;</td></tr>
<tr class="codeline" data-linenumber="1343"><td class="num" id="LN1343">1343</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1344"><td class="num" id="LN1344">1344</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1345"><td class="num" id="LN1345">1345</td><td class="line"><span class='keyword'>int</span> rewriteAppendOnlyFileRio(rio *aof) {</td></tr>
<tr class="codeline" data-linenumber="1346"><td class="num" id="LN1346">1346</td><td class="line">    dictIterator *di = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1347"><td class="num" id="LN1347">1347</td><td class="line">    dictEntry *de;</td></tr>
<tr class="codeline" data-linenumber="1348"><td class="num" id="LN1348">1348</td><td class="line">    size_t processed = 0;</td></tr>
<tr class="codeline" data-linenumber="1349"><td class="num" id="LN1349">1349</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="1350"><td class="num" id="LN1350">1350</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1351"><td class="num" id="LN1351">1351</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; server.dbnum; j++) {</td></tr>
<tr class="codeline" data-linenumber="1352"><td class="num" id="LN1352">1352</td><td class="line">        <span class='keyword'>char</span> selectcmd[] = <span class='string_literal'>"*2\r\n$6\r\nSELECT\r\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1353"><td class="num" id="LN1353">1353</td><td class="line">        redisDb *db = server.db+j;</td></tr>
<tr class="codeline" data-linenumber="1354"><td class="num" id="LN1354">1354</td><td class="line">        dict *d = db-&gt;dict;</td></tr>
<tr class="codeline" data-linenumber="1355"><td class="num" id="LN1355">1355</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>dictSize(d)<span class='macro_popup'>((d)-&gt;ht[0].used+(d)-&gt;ht[1].used)</span></span> == 0) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1356"><td class="num" id="LN1356">1356</td><td class="line">        di = dictGetSafeIterator(d);</td></tr>
<tr class="codeline" data-linenumber="1357"><td class="num" id="LN1357">1357</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1358"><td class="num" id="LN1358">1358</td><td class="line">        <span class='comment'>/* SELECT the new DB */</span></td></tr>
<tr class="codeline" data-linenumber="1359"><td class="num" id="LN1359">1359</td><td class="line">        <span class='keyword'>if</span> (rioWrite(aof,selectcmd,<span class='keyword'>sizeof</span>(selectcmd)-1) == 0) <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1360"><td class="num" id="LN1360">1360</td><td class="line">        <span class='keyword'>if</span> (rioWriteBulkLongLong(aof,j) == 0) <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1361"><td class="num" id="LN1361">1361</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1362"><td class="num" id="LN1362">1362</td><td class="line">        <span class='comment'>/* Iterate this DB writing every entry */</span></td></tr>
<tr class="codeline" data-linenumber="1363"><td class="num" id="LN1363">1363</td><td class="line">        <span class='keyword'>while</span>((de = dictNext(di)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1364"><td class="num" id="LN1364">1364</td><td class="line">            sds keystr;</td></tr>
<tr class="codeline" data-linenumber="1365"><td class="num" id="LN1365">1365</td><td class="line">            robj key, *o;</td></tr>
<tr class="codeline" data-linenumber="1366"><td class="num" id="LN1366">1366</td><td class="line">            <span class='keyword'>long</span> <span class='keyword'>long</span> expiretime;</td></tr>
<tr class="codeline" data-linenumber="1367"><td class="num" id="LN1367">1367</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1368"><td class="num" id="LN1368">1368</td><td class="line">            keystr = <span class='macro'>dictGetKey(de)<span class='macro_popup'>((de)-&gt;key)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1369"><td class="num" id="LN1369">1369</td><td class="line">            o = <span class='macro'>dictGetVal(de)<span class='macro_popup'>((de)-&gt;v.val)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1370"><td class="num" id="LN1370">1370</td><td class="line">            <span class='macro'>initStaticStringObject(key,keystr)<span class='macro_popup'>do { key.refcount = (2147483647 -1); key.type = 0; key.encoding<br> = 0; key.ptr = keystr; } while(0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1371"><td class="num" id="LN1371">1371</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1372"><td class="num" id="LN1372">1372</td><td class="line">            expiretime = getExpire(db,&amp;key);</td></tr>
<tr class="codeline" data-linenumber="1373"><td class="num" id="LN1373">1373</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1374"><td class="num" id="LN1374">1374</td><td class="line">            <span class='comment'>/* Save the key and associated value */</span></td></tr>
<tr class="codeline" data-linenumber="1375"><td class="num" id="LN1375">1375</td><td class="line">            <span class='keyword'>if</span> (o-&gt;type == <span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1376"><td class="num" id="LN1376">1376</td><td class="line">                <span class='comment'>/* Emit a SET command */</span></td></tr>
<tr class="codeline" data-linenumber="1377"><td class="num" id="LN1377">1377</td><td class="line">                <span class='keyword'>char</span> cmd[]=<span class='string_literal'>"*3\r\n$3\r\nSET\r\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1378"><td class="num" id="LN1378">1378</td><td class="line">                <span class='keyword'>if</span> (rioWrite(aof,cmd,<span class='keyword'>sizeof</span>(cmd)-1) == 0) <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1379"><td class="num" id="LN1379">1379</td><td class="line">                <span class='comment'>/* Key and value */</span></td></tr>
<tr class="codeline" data-linenumber="1380"><td class="num" id="LN1380">1380</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkObject(aof,&amp;key) == 0) <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1381"><td class="num" id="LN1381">1381</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkObject(aof,o) == 0) <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1382"><td class="num" id="LN1382">1382</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (o-&gt;type == <span class='macro'>OBJ_LIST<span class='macro_popup'>1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1383"><td class="num" id="LN1383">1383</td><td class="line">                <span class='keyword'>if</span> (rewriteListObject(aof,&amp;key,o) == 0) <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1384"><td class="num" id="LN1384">1384</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (o-&gt;type == <span class='macro'>OBJ_SET<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1385"><td class="num" id="LN1385">1385</td><td class="line">                <span class='keyword'>if</span> (rewriteSetObject(aof,&amp;key,o) == 0) <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1386"><td class="num" id="LN1386">1386</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (o-&gt;type == <span class='macro'>OBJ_ZSET<span class='macro_popup'>3</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1387"><td class="num" id="LN1387">1387</td><td class="line">                <span class='keyword'>if</span> (rewriteSortedSetObject(aof,&amp;key,o) == 0) <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1388"><td class="num" id="LN1388">1388</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (o-&gt;type == <span class='macro'>OBJ_HASH<span class='macro_popup'>4</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1389"><td class="num" id="LN1389">1389</td><td class="line">                <span class='keyword'>if</span> (rewriteHashObject(aof,&amp;key,o) == 0) <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1390"><td class="num" id="LN1390">1390</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (o-&gt;type == <span class='macro'>OBJ_STREAM<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1391"><td class="num" id="LN1391">1391</td><td class="line">                <span class='keyword'>if</span> (rewriteStreamObject(aof,&amp;key,o) == 0) <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1392"><td class="num" id="LN1392">1392</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (o-&gt;type == <span class='macro'>OBJ_MODULE<span class='macro_popup'>5</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1393"><td class="num" id="LN1393">1393</td><td class="line">                <span class='keyword'>if</span> (rewriteModuleObject(aof,&amp;key,o) == 0) <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1394"><td class="num" id="LN1394">1394</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1395"><td class="num" id="LN1395">1395</td><td class="line">                <span class='macro'>serverPanic(<span class='string_literal'>"Unknown object type"</span>)<span class='macro_popup'>_serverPanic("aof.c",1395,"Unknown object type"),_exit(1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1396"><td class="num" id="LN1396">1396</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1397"><td class="num" id="LN1397">1397</td><td class="line">            <span class='comment'>/* Save the expire time */</span></td></tr>
<tr class="codeline" data-linenumber="1398"><td class="num" id="LN1398">1398</td><td class="line">            <span class='keyword'>if</span> (expiretime != -1) {</td></tr>
<tr class="codeline" data-linenumber="1399"><td class="num" id="LN1399">1399</td><td class="line">                <span class='keyword'>char</span> cmd[]=<span class='string_literal'>"*3\r\n$9\r\nPEXPIREAT\r\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1400"><td class="num" id="LN1400">1400</td><td class="line">                <span class='keyword'>if</span> (rioWrite(aof,cmd,<span class='keyword'>sizeof</span>(cmd)-1) == 0) <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1401"><td class="num" id="LN1401">1401</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkObject(aof,&amp;key) == 0) <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1402"><td class="num" id="LN1402">1402</td><td class="line">                <span class='keyword'>if</span> (rioWriteBulkLongLong(aof,expiretime) == 0) <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1403"><td class="num" id="LN1403">1403</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1404"><td class="num" id="LN1404">1404</td><td class="line">            <span class='comment'>/* Read some diff from the parent process from time to time. */</span></td></tr>
<tr class="codeline" data-linenumber="1405"><td class="num" id="LN1405">1405</td><td class="line">            <span class='keyword'>if</span> (aof-&gt;processed_bytes &gt; processed+<span class='macro'>AOF_READ_DIFF_INTERVAL_BYTES<span class='macro_popup'>(1024*10)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1406"><td class="num" id="LN1406">1406</td><td class="line">                processed = aof-&gt;processed_bytes;</td></tr>
<tr class="codeline" data-linenumber="1407"><td class="num" id="LN1407">1407</td><td class="line">                aofReadDiffFromParent();</td></tr>
<tr class="codeline" data-linenumber="1408"><td class="num" id="LN1408">1408</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1409"><td class="num" id="LN1409">1409</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1410"><td class="num" id="LN1410">1410</td><td class="line">        dictReleaseIterator(di);</td></tr>
<tr class="codeline" data-linenumber="1411"><td class="num" id="LN1411">1411</td><td class="line">        di = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1412"><td class="num" id="LN1412">1412</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1413"><td class="num" id="LN1413">1413</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1414"><td class="num" id="LN1414">1414</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1415"><td class="num" id="LN1415">1415</td><td class="line">werr:</td></tr>
<tr class="codeline" data-linenumber="1416"><td class="num" id="LN1416">1416</td><td class="line">    <span class='keyword'>if</span> (di) dictReleaseIterator(di);</td></tr>
<tr class="codeline" data-linenumber="1417"><td class="num" id="LN1417">1417</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1418"><td class="num" id="LN1418">1418</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1419"><td class="num" id="LN1419">1419</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1420"><td class="num" id="LN1420">1420</td><td class="line"><span class='comment'>/* Write a sequence of commands able to fully rebuild the dataset into</span></td></tr>
<tr class="codeline" data-linenumber="1421"><td class="num" id="LN1421">1421</td><td class="line"> <span class='comment'>* "filename". Used both by REWRITEAOF and BGREWRITEAOF.</span></td></tr>
<tr class="codeline" data-linenumber="1422"><td class="num" id="LN1422">1422</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1423"><td class="num" id="LN1423">1423</td><td class="line"> <span class='comment'>* In order to minimize the number of commands needed in the rewritten</span></td></tr>
<tr class="codeline" data-linenumber="1424"><td class="num" id="LN1424">1424</td><td class="line"> <span class='comment'>* log Redis uses variadic commands when possible, such as RPUSH, SADD</span></td></tr>
<tr class="codeline" data-linenumber="1425"><td class="num" id="LN1425">1425</td><td class="line"> <span class='comment'>* and ZADD. However at max AOF_REWRITE_ITEMS_PER_CMD items per time</span></td></tr>
<tr class="codeline" data-linenumber="1426"><td class="num" id="LN1426">1426</td><td class="line"> <span class='comment'>* are inserted using a single command. */</span></td></tr>
<tr class="codeline" data-linenumber="1427"><td class="num" id="LN1427">1427</td><td class="line"><span class='keyword'>int</span> rewriteAppendOnlyFile(<span class='keyword'>char</span> *filename) {</td></tr>
<tr class="codeline" data-linenumber="1428"><td class="num" id="LN1428">1428</td><td class="line">    rio aof;</td></tr>
<tr class="codeline" data-linenumber="1429"><td class="num" id="LN1429">1429</td><td class="line">    FILE *fp = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1430"><td class="num" id="LN1430">1430</td><td class="line">    <span class='keyword'>char</span> tmpfile[256];</td></tr>
<tr class="codeline" data-linenumber="1431"><td class="num" id="LN1431">1431</td><td class="line">    <span class='keyword'>char</span> byte;</td></tr>
<tr class="codeline" data-linenumber="1432"><td class="num" id="LN1432">1432</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1433"><td class="num" id="LN1433">1433</td><td class="line">    <span class='comment'>/* Note that we have to use a different temp name here compared to the</span></td></tr>
<tr class="codeline" data-linenumber="1434"><td class="num" id="LN1434">1434</td><td class="line">     <span class='comment'>* one used by rewriteAppendOnlyFileBackground() function. */</span></td></tr>
<tr class="codeline" data-linenumber="1435"><td class="num" id="LN1435">1435</td><td class="line">    snprintf(tmpfile,256,<span class='string_literal'>"temp-rewriteaof-%d.aof"</span>, (<span class='keyword'>int</span>) getpid());</td></tr>
<tr class="codeline" data-linenumber="1436"><td class="num" id="LN1436">1436</td><td class="line">    fp = fopen(tmpfile,<span class='string_literal'>"w"</span>);</td></tr>
<tr class="codeline" data-linenumber="1437"><td class="num" id="LN1437">1437</td><td class="line">    <span class='keyword'>if</span> (!fp) {</td></tr>
<tr class="codeline" data-linenumber="1438"><td class="num" id="LN1438">1438</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>, <span class='string_literal'>"Opening the temp file for AOF rewrite in rewriteAppendOnlyFile(): %s"</span>, strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="1439"><td class="num" id="LN1439">1439</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1440"><td class="num" id="LN1440">1440</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1441"><td class="num" id="LN1441">1441</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1442"><td class="num" id="LN1442">1442</td><td class="line">    server.aof_child_diff = sdsempty();</td></tr>
<tr class="codeline" data-linenumber="1443"><td class="num" id="LN1443">1443</td><td class="line">    rioInitWithFile(&amp;aof,fp);</td></tr>
<tr class="codeline" data-linenumber="1444"><td class="num" id="LN1444">1444</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1445"><td class="num" id="LN1445">1445</td><td class="line">    <span class='keyword'>if</span> (server.aof_rewrite_incremental_fsync)</td></tr>
<tr class="codeline" data-linenumber="1446"><td class="num" id="LN1446">1446</td><td class="line">        rioSetAutoSync(&amp;aof,<span class='macro'>REDIS_AUTOSYNC_BYTES<span class='macro_popup'>(1024*1024*32)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1447"><td class="num" id="LN1447">1447</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1448"><td class="num" id="LN1448">1448</td><td class="line">    startSaving(<span class='macro'>RDBFLAGS_AOF_PREAMBLE<span class='macro_popup'>(1&lt;&lt;0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1449"><td class="num" id="LN1449">1449</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1450"><td class="num" id="LN1450">1450</td><td class="line">    <span class='keyword'>if</span> (server.aof_use_rdb_preamble) {</td></tr>
<tr class="codeline" data-linenumber="1451"><td class="num" id="LN1451">1451</td><td class="line">        <span class='keyword'>int</span> error;</td></tr>
<tr class="codeline" data-linenumber="1452"><td class="num" id="LN1452">1452</td><td class="line">        <span class='keyword'>if</span> (rdbSaveRio(&amp;aof,&amp;error,<span class='macro'>RDBFLAGS_AOF_PREAMBLE<span class='macro_popup'>(1&lt;&lt;0)</span></span>,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1453"><td class="num" id="LN1453">1453</td><td class="line">            <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> = error;</td></tr>
<tr class="codeline" data-linenumber="1454"><td class="num" id="LN1454">1454</td><td class="line">            <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1455"><td class="num" id="LN1455">1455</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1456"><td class="num" id="LN1456">1456</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1457"><td class="num" id="LN1457">1457</td><td class="line">        <span class='keyword'>if</span> (rewriteAppendOnlyFileRio(&amp;aof) == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>) <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1458"><td class="num" id="LN1458">1458</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1459"><td class="num" id="LN1459">1459</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1460"><td class="num" id="LN1460">1460</td><td class="line">    <span class='comment'>/* Do an initial slow fsync here while the parent is still sending</span></td></tr>
<tr class="codeline" data-linenumber="1461"><td class="num" id="LN1461">1461</td><td class="line">     <span class='comment'>* data, in order to make the next final fsync faster. */</span></td></tr>
<tr class="codeline" data-linenumber="1462"><td class="num" id="LN1462">1462</td><td class="line">    <span class='keyword'>if</span> (fflush(fp) == <span class='macro'>EOF<span class='macro_popup'>(-1)</span></span>) <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1463"><td class="num" id="LN1463">1463</td><td class="line">    <span class='keyword'>if</span> (fsync(fileno(fp)) == -1) <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1464"><td class="num" id="LN1464">1464</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1465"><td class="num" id="LN1465">1465</td><td class="line">    <span class='comment'>/* Read again a few times to get more data from the parent.</span></td></tr>
<tr class="codeline" data-linenumber="1466"><td class="num" id="LN1466">1466</td><td class="line">     <span class='comment'>* We can't read forever (the server may receive data from clients</span></td></tr>
<tr class="codeline" data-linenumber="1467"><td class="num" id="LN1467">1467</td><td class="line">     <span class='comment'>* faster than it is able to send data to the child), so we try to read</span></td></tr>
<tr class="codeline" data-linenumber="1468"><td class="num" id="LN1468">1468</td><td class="line">     <span class='comment'>* some more data in a loop as soon as there is a good chance more data</span></td></tr>
<tr class="codeline" data-linenumber="1469"><td class="num" id="LN1469">1469</td><td class="line">     <span class='comment'>* will come. If it looks like we are wasting time, we abort (this</span></td></tr>
<tr class="codeline" data-linenumber="1470"><td class="num" id="LN1470">1470</td><td class="line">     <span class='comment'>* happens after 20 ms without new data). */</span></td></tr>
<tr class="codeline" data-linenumber="1471"><td class="num" id="LN1471">1471</td><td class="line">    <span class='keyword'>int</span> nodata = 0;</td></tr>
<tr class="codeline" data-linenumber="1472"><td class="num" id="LN1472">1472</td><td class="line">    mstime_t start = mstime();</td></tr>
<tr class="codeline" data-linenumber="1473"><td class="num" id="LN1473">1473</td><td class="line">    <span class='keyword'>while</span>(mstime()-start &lt; 1000 &amp;&amp; nodata &lt; 20) {</td></tr>
<tr class="codeline" data-linenumber="1474"><td class="num" id="LN1474">1474</td><td class="line">        <span class='keyword'>if</span> (aeWait(server.aof_pipe_read_data_from_parent, <span class='macro'>AE_READABLE<span class='macro_popup'>1</span></span>, 1) &lt;= 0)</td></tr>
<tr class="codeline" data-linenumber="1475"><td class="num" id="LN1475">1475</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="1476"><td class="num" id="LN1476">1476</td><td class="line">            nodata++;</td></tr>
<tr class="codeline" data-linenumber="1477"><td class="num" id="LN1477">1477</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1478"><td class="num" id="LN1478">1478</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1479"><td class="num" id="LN1479">1479</td><td class="line">        nodata = 0; <span class='comment'>/* Start counting from zero, we stop on N *contiguous*</span></td></tr>
<tr class="codeline" data-linenumber="1480"><td class="num" id="LN1480">1480</td><td class="line">                       <span class='comment'>timeouts. */</span></td></tr>
<tr class="codeline" data-linenumber="1481"><td class="num" id="LN1481">1481</td><td class="line">        aofReadDiffFromParent();</td></tr>
<tr class="codeline" data-linenumber="1482"><td class="num" id="LN1482">1482</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1483"><td class="num" id="LN1483">1483</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1484"><td class="num" id="LN1484">1484</td><td class="line">    <span class='comment'>/* Ask the master to stop sending diffs. */</span></td></tr>
<tr class="codeline" data-linenumber="1485"><td class="num" id="LN1485">1485</td><td class="line">    <span class='keyword'>if</span> (write(server.aof_pipe_write_ack_to_parent,<span class='string_literal'>"!"</span>,1) != 1) <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1486"><td class="num" id="LN1486">1486</td><td class="line">    <span class='keyword'>if</span> (anetNonBlock(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,server.aof_pipe_read_ack_from_parent) != <span class='macro'>ANET_OK<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1487"><td class="num" id="LN1487">1487</td><td class="line">        <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1488"><td class="num" id="LN1488">1488</td><td class="line">    <span class='comment'>/* We read the ACK from the server using a 10 seconds timeout. Normally</span></td></tr>
<tr class="codeline" data-linenumber="1489"><td class="num" id="LN1489">1489</td><td class="line">     <span class='comment'>* it should reply ASAP, but just in case we lose its reply, we are sure</span></td></tr>
<tr class="codeline" data-linenumber="1490"><td class="num" id="LN1490">1490</td><td class="line">     <span class='comment'>* the child will eventually get terminated. */</span></td></tr>
<tr class="codeline" data-linenumber="1491"><td class="num" id="LN1491">1491</td><td class="line">    <span class='keyword'>if</span> (syncRead(server.aof_pipe_read_ack_from_parent,&amp;byte,1,5000) != 1 ||</td></tr>
<tr class="codeline" data-linenumber="1492"><td class="num" id="LN1492">1492</td><td class="line">        byte != '!') <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1493"><td class="num" id="LN1493">1493</td><td class="line">    serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Parent agreed to stop sending diffs. Finalizing AOF..."</span>);</td></tr>
<tr class="codeline" data-linenumber="1494"><td class="num" id="LN1494">1494</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1495"><td class="num" id="LN1495">1495</td><td class="line">    <span class='comment'>/* Read the final diff if any. */</span></td></tr>
<tr class="codeline" data-linenumber="1496"><td class="num" id="LN1496">1496</td><td class="line">    aofReadDiffFromParent();</td></tr>
<tr class="codeline" data-linenumber="1497"><td class="num" id="LN1497">1497</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1498"><td class="num" id="LN1498">1498</td><td class="line">    <span class='comment'>/* Write the received diff to the file. */</span></td></tr>
<tr class="codeline" data-linenumber="1499"><td class="num" id="LN1499">1499</td><td class="line">    serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1500"><td class="num" id="LN1500">1500</td><td class="line">        <span class='string_literal'>"Concatenating %.2f MB of AOF diff received from parent."</span>,</td></tr>
<tr class="codeline" data-linenumber="1501"><td class="num" id="LN1501">1501</td><td class="line">        (<span class='keyword'>double</span>) sdslen(server.aof_child_diff) / (1024*1024));</td></tr>
<tr class="codeline" data-linenumber="1502"><td class="num" id="LN1502">1502</td><td class="line">    <span class='keyword'>if</span> (rioWrite(&amp;aof,server.aof_child_diff,sdslen(server.aof_child_diff)) == 0)</td></tr>
<tr class="codeline" data-linenumber="1503"><td class="num" id="LN1503">1503</td><td class="line">        <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1504"><td class="num" id="LN1504">1504</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1505"><td class="num" id="LN1505">1505</td><td class="line">    <span class='comment'>/* Make sure data will not remain on the OS's output buffers */</span></td></tr>
<tr class="codeline" data-linenumber="1506"><td class="num" id="LN1506">1506</td><td class="line">    <span class='keyword'>if</span> (fflush(fp)) <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1507"><td class="num" id="LN1507">1507</td><td class="line">    <span class='keyword'>if</span> (fsync(fileno(fp))) <span class='keyword'>goto</span> werr;</td></tr>
<tr class="codeline" data-linenumber="1508"><td class="num" id="LN1508">1508</td><td class="line">    <span class='keyword'>if</span> (fclose(fp)) { fp = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>; <span class='keyword'>goto</span> werr; }</td></tr>
<tr class="codeline" data-linenumber="1509"><td class="num" id="LN1509">1509</td><td class="line">    fp = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1510"><td class="num" id="LN1510">1510</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1511"><td class="num" id="LN1511">1511</td><td class="line">    <span class='comment'>/* Use RENAME to make sure the DB file is changed atomically only</span></td></tr>
<tr class="codeline" data-linenumber="1512"><td class="num" id="LN1512">1512</td><td class="line">     <span class='comment'>* if the generate DB file is ok. */</span></td></tr>
<tr class="codeline" data-linenumber="1513"><td class="num" id="LN1513">1513</td><td class="line">    <span class='keyword'>if</span> (rename(tmpfile,filename) == -1) {</td></tr>
<tr class="codeline" data-linenumber="1514"><td class="num" id="LN1514">1514</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Error moving temp append only file on the final destination: %s"</span>, strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="1515"><td class="num" id="LN1515">1515</td><td class="line">        unlink(tmpfile);</td></tr>
<tr class="codeline" data-linenumber="1516"><td class="num" id="LN1516">1516</td><td class="line">        stopSaving(0);</td></tr>
<tr class="codeline" data-linenumber="1517"><td class="num" id="LN1517">1517</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1518"><td class="num" id="LN1518">1518</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1519"><td class="num" id="LN1519">1519</td><td class="line">    serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"SYNC append only file rewrite performed"</span>);</td></tr>
<tr class="codeline" data-linenumber="1520"><td class="num" id="LN1520">1520</td><td class="line">    stopSaving(1);</td></tr>
<tr class="codeline" data-linenumber="1521"><td class="num" id="LN1521">1521</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1522"><td class="num" id="LN1522">1522</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1523"><td class="num" id="LN1523">1523</td><td class="line">werr:</td></tr>
<tr class="codeline" data-linenumber="1524"><td class="num" id="LN1524">1524</td><td class="line">    serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Write error writing append only file on disk: %s"</span>, strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="1525"><td class="num" id="LN1525">1525</td><td class="line">    <span class='keyword'>if</span> (fp) fclose(fp);</td></tr>
<tr class="codeline" data-linenumber="1526"><td class="num" id="LN1526">1526</td><td class="line">    unlink(tmpfile);</td></tr>
<tr class="codeline" data-linenumber="1527"><td class="num" id="LN1527">1527</td><td class="line">    stopSaving(0);</td></tr>
<tr class="codeline" data-linenumber="1528"><td class="num" id="LN1528">1528</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1529"><td class="num" id="LN1529">1529</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1530"><td class="num" id="LN1530">1530</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1531"><td class="num" id="LN1531">1531</td><td class="line"><span class='comment'>/* ----------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="1532"><td class="num" id="LN1532">1532</td><td class="line"> <span class='comment'>* AOF rewrite pipes for IPC</span></td></tr>
<tr class="codeline" data-linenumber="1533"><td class="num" id="LN1533">1533</td><td class="line"> <span class='comment'>* -------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="1534"><td class="num" id="LN1534">1534</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1535"><td class="num" id="LN1535">1535</td><td class="line"><span class='comment'>/* This event handler is called when the AOF rewriting child sends us a</span></td></tr>
<tr class="codeline" data-linenumber="1536"><td class="num" id="LN1536">1536</td><td class="line"> <span class='comment'>* single '!' char to signal we should stop sending buffer diffs. The</span></td></tr>
<tr class="codeline" data-linenumber="1537"><td class="num" id="LN1537">1537</td><td class="line"> <span class='comment'>* parent sends a '!' as well to acknowledge. */</span></td></tr>
<tr class="codeline" data-linenumber="1538"><td class="num" id="LN1538">1538</td><td class="line"><span class='keyword'>void</span> aofChildPipeReadable(aeEventLoop *el, <span class='keyword'>int</span> fd, <span class='keyword'>void</span> *privdata, <span class='keyword'>int</span> mask) {</td></tr>
<tr class="codeline" data-linenumber="1539"><td class="num" id="LN1539">1539</td><td class="line">    <span class='keyword'>char</span> byte;</td></tr>
<tr class="codeline" data-linenumber="1540"><td class="num" id="LN1540">1540</td><td class="line">    <span class='macro'>UNUSED(el)<span class='macro_popup'>((void) el)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1541"><td class="num" id="LN1541">1541</td><td class="line">    <span class='macro'>UNUSED(privdata)<span class='macro_popup'>((void) privdata)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1542"><td class="num" id="LN1542">1542</td><td class="line">    <span class='macro'>UNUSED(mask)<span class='macro_popup'>((void) mask)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1543"><td class="num" id="LN1543">1543</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1544"><td class="num" id="LN1544">1544</td><td class="line">    <span class='keyword'>if</span> (read(fd,&amp;byte,1) == 1 &amp;&amp; byte == '!') {</td></tr>
<tr class="codeline" data-linenumber="1545"><td class="num" id="LN1545">1545</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"AOF rewrite child asks to stop sending diffs."</span>);</td></tr>
<tr class="codeline" data-linenumber="1546"><td class="num" id="LN1546">1546</td><td class="line">        server.aof_stop_sending_diff = 1;</td></tr>
<tr class="codeline" data-linenumber="1547"><td class="num" id="LN1547">1547</td><td class="line">        <span class='keyword'>if</span> (write(server.aof_pipe_write_ack_to_child,<span class='string_literal'>"!"</span>,1) != 1) {</td></tr>
<tr class="codeline" data-linenumber="1548"><td class="num" id="LN1548">1548</td><td class="line">            <span class='comment'>/* If we can't send the ack, inform the user, but don't try again</span></td></tr>
<tr class="codeline" data-linenumber="1549"><td class="num" id="LN1549">1549</td><td class="line">             <span class='comment'>* since in the other side the children will use a timeout if the</span></td></tr>
<tr class="codeline" data-linenumber="1550"><td class="num" id="LN1550">1550</td><td class="line">             <span class='comment'>* kernel can't buffer our write, or, the children was</span></td></tr>
<tr class="codeline" data-linenumber="1551"><td class="num" id="LN1551">1551</td><td class="line">             <span class='comment'>* terminated. */</span></td></tr>
<tr class="codeline" data-linenumber="1552"><td class="num" id="LN1552">1552</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Can't send ACK to AOF child: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="1553"><td class="num" id="LN1553">1553</td><td class="line">                strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="1554"><td class="num" id="LN1554">1554</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1555"><td class="num" id="LN1555">1555</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1556"><td class="num" id="LN1556">1556</td><td class="line">    <span class='comment'>/* Remove the handler since this can be called only one time during a</span></td></tr>
<tr class="codeline" data-linenumber="1557"><td class="num" id="LN1557">1557</td><td class="line">     <span class='comment'>* rewrite. */</span></td></tr>
<tr class="codeline" data-linenumber="1558"><td class="num" id="LN1558">1558</td><td class="line">    aeDeleteFileEvent(server.el,server.aof_pipe_read_ack_from_child,<span class='macro'>AE_READABLE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1559"><td class="num" id="LN1559">1559</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1560"><td class="num" id="LN1560">1560</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1561"><td class="num" id="LN1561">1561</td><td class="line"><span class='comment'>/* Create the pipes used for parent - child process IPC during rewrite.</span></td></tr>
<tr class="codeline" data-linenumber="1562"><td class="num" id="LN1562">1562</td><td class="line"> <span class='comment'>* We have a data pipe used to send AOF incremental diffs to the child,</span></td></tr>
<tr class="codeline" data-linenumber="1563"><td class="num" id="LN1563">1563</td><td class="line"> <span class='comment'>* and two other pipes used by the children to signal it finished with</span></td></tr>
<tr class="codeline" data-linenumber="1564"><td class="num" id="LN1564">1564</td><td class="line"> <span class='comment'>* the rewrite so no more data should be written, and another for the</span></td></tr>
<tr class="codeline" data-linenumber="1565"><td class="num" id="LN1565">1565</td><td class="line"> <span class='comment'>* parent to acknowledge it understood this new condition. */</span></td></tr>
<tr class="codeline" data-linenumber="1566"><td class="num" id="LN1566">1566</td><td class="line"><span class='keyword'>int</span> aofCreatePipes(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1567"><td class="num" id="LN1567">1567</td><td class="line">    <span class='keyword'>int</span> fds[6] = {-1, -1, -1, -1, -1, -1};</td></tr>
<tr class="codeline" data-linenumber="1568"><td class="num" id="LN1568">1568</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="1569"><td class="num" id="LN1569">1569</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1570"><td class="num" id="LN1570">1570</td><td class="line">    <span class='keyword'>if</span> (pipe(fds) == -1) <span class='keyword'>goto</span> error; <span class='comment'>/* parent -&gt; children data. */</span></td></tr>
<tr class="codeline" data-linenumber="1571"><td class="num" id="LN1571">1571</td><td class="line">    <span class='keyword'>if</span> (pipe(fds+2) == -1) <span class='keyword'>goto</span> error; <span class='comment'>/* children -&gt; parent ack. */</span></td></tr>
<tr class="codeline" data-linenumber="1572"><td class="num" id="LN1572">1572</td><td class="line">    <span class='keyword'>if</span> (pipe(fds+4) == -1) <span class='keyword'>goto</span> error; <span class='comment'>/* parent -&gt; children ack. */</span></td></tr>
<tr class="codeline" data-linenumber="1573"><td class="num" id="LN1573">1573</td><td class="line">    <span class='comment'>/* Parent -&gt; children data is non blocking. */</span></td></tr>
<tr class="codeline" data-linenumber="1574"><td class="num" id="LN1574">1574</td><td class="line">    <span class='keyword'>if</span> (anetNonBlock(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,fds[0]) != <span class='macro'>ANET_OK<span class='macro_popup'>0</span></span>) <span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="1575"><td class="num" id="LN1575">1575</td><td class="line">    <span class='keyword'>if</span> (anetNonBlock(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,fds[1]) != <span class='macro'>ANET_OK<span class='macro_popup'>0</span></span>) <span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="1576"><td class="num" id="LN1576">1576</td><td class="line">    <span class='keyword'>if</span> (aeCreateFileEvent(server.el, fds[2], <span class='macro'>AE_READABLE<span class='macro_popup'>1</span></span>, aofChildPipeReadable, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) == <span class='macro'>AE_ERR<span class='macro_popup'>-1</span></span>) <span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="1577"><td class="num" id="LN1577">1577</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1578"><td class="num" id="LN1578">1578</td><td class="line">    server.aof_pipe_write_data_to_child = fds[1];</td></tr>
<tr class="codeline" data-linenumber="1579"><td class="num" id="LN1579">1579</td><td class="line">    server.aof_pipe_read_data_from_parent = fds[0];</td></tr>
<tr class="codeline" data-linenumber="1580"><td class="num" id="LN1580">1580</td><td class="line">    server.aof_pipe_write_ack_to_parent = fds[3];</td></tr>
<tr class="codeline" data-linenumber="1581"><td class="num" id="LN1581">1581</td><td class="line">    server.aof_pipe_read_ack_from_child = fds[2];</td></tr>
<tr class="codeline" data-linenumber="1582"><td class="num" id="LN1582">1582</td><td class="line">    server.aof_pipe_write_ack_to_child = fds[5];</td></tr>
<tr class="codeline" data-linenumber="1583"><td class="num" id="LN1583">1583</td><td class="line">    server.aof_pipe_read_ack_from_parent = fds[4];</td></tr>
<tr class="codeline" data-linenumber="1584"><td class="num" id="LN1584">1584</td><td class="line">    server.aof_stop_sending_diff = 0;</td></tr>
<tr class="codeline" data-linenumber="1585"><td class="num" id="LN1585">1585</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1586"><td class="num" id="LN1586">1586</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1587"><td class="num" id="LN1587">1587</td><td class="line">error:</td></tr>
<tr class="codeline" data-linenumber="1588"><td class="num" id="LN1588">1588</td><td class="line">    serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Error opening /setting AOF rewrite IPC pipes: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="1589"><td class="num" id="LN1589">1589</td><td class="line">        strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="1590"><td class="num" id="LN1590">1590</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; 6; j++) <span class='keyword'>if</span>(fds[j] != -1) close(fds[j]);</td></tr>
<tr class="codeline" data-linenumber="1591"><td class="num" id="LN1591">1591</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1592"><td class="num" id="LN1592">1592</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1593"><td class="num" id="LN1593">1593</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1594"><td class="num" id="LN1594">1594</td><td class="line"><span class='keyword'>void</span> aofClosePipes(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1595"><td class="num" id="LN1595">1595</td><td class="line">    aeDeleteFileEvent(server.el,server.aof_pipe_read_ack_from_child,<span class='macro'>AE_READABLE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1596"><td class="num" id="LN1596">1596</td><td class="line">    aeDeleteFileEvent(server.el,server.aof_pipe_write_data_to_child,<span class='macro'>AE_WRITABLE<span class='macro_popup'>2</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1597"><td class="num" id="LN1597">1597</td><td class="line">    close(server.aof_pipe_write_data_to_child);</td></tr>
<tr class="codeline" data-linenumber="1598"><td class="num" id="LN1598">1598</td><td class="line">    close(server.aof_pipe_read_data_from_parent);</td></tr>
<tr class="codeline" data-linenumber="1599"><td class="num" id="LN1599">1599</td><td class="line">    close(server.aof_pipe_write_ack_to_parent);</td></tr>
<tr class="codeline" data-linenumber="1600"><td class="num" id="LN1600">1600</td><td class="line">    close(server.aof_pipe_read_ack_from_child);</td></tr>
<tr class="codeline" data-linenumber="1601"><td class="num" id="LN1601">1601</td><td class="line">    close(server.aof_pipe_write_ack_to_child);</td></tr>
<tr class="codeline" data-linenumber="1602"><td class="num" id="LN1602">1602</td><td class="line">    close(server.aof_pipe_read_ack_from_parent);</td></tr>
<tr class="codeline" data-linenumber="1603"><td class="num" id="LN1603">1603</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1604"><td class="num" id="LN1604">1604</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1605"><td class="num" id="LN1605">1605</td><td class="line"><span class='comment'>/* ----------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="1606"><td class="num" id="LN1606">1606</td><td class="line"> <span class='comment'>* AOF background rewrite</span></td></tr>
<tr class="codeline" data-linenumber="1607"><td class="num" id="LN1607">1607</td><td class="line"> <span class='comment'>* ------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="1608"><td class="num" id="LN1608">1608</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1609"><td class="num" id="LN1609">1609</td><td class="line"><span class='comment'>/* This is how rewriting of the append only file in background works:</span></td></tr>
<tr class="codeline" data-linenumber="1610"><td class="num" id="LN1610">1610</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1611"><td class="num" id="LN1611">1611</td><td class="line"> <span class='comment'>* 1) The user calls BGREWRITEAOF</span></td></tr>
<tr class="codeline" data-linenumber="1612"><td class="num" id="LN1612">1612</td><td class="line"> <span class='comment'>* 2) Redis calls this function, that forks():</span></td></tr>
<tr class="codeline" data-linenumber="1613"><td class="num" id="LN1613">1613</td><td class="line"> <span class='comment'>*    2a) the child rewrite the append only file in a temp file.</span></td></tr>
<tr class="codeline" data-linenumber="1614"><td class="num" id="LN1614">1614</td><td class="line"> <span class='comment'>*    2b) the parent accumulates differences in server.aof_rewrite_buf.</span></td></tr>
<tr class="codeline" data-linenumber="1615"><td class="num" id="LN1615">1615</td><td class="line"> <span class='comment'>* 3) When the child finished '2a' exists.</span></td></tr>
<tr class="codeline" data-linenumber="1616"><td class="num" id="LN1616">1616</td><td class="line"> <span class='comment'>* 4) The parent will trap the exit code, if it's OK, will append the</span></td></tr>
<tr class="codeline" data-linenumber="1617"><td class="num" id="LN1617">1617</td><td class="line"> <span class='comment'>*    data accumulated into server.aof_rewrite_buf into the temp file, and</span></td></tr>
<tr class="codeline" data-linenumber="1618"><td class="num" id="LN1618">1618</td><td class="line"> <span class='comment'>*    finally will rename(2) the temp file in the actual file name.</span></td></tr>
<tr class="codeline" data-linenumber="1619"><td class="num" id="LN1619">1619</td><td class="line"> <span class='comment'>*    The the new file is reopened as the new append only file. Profit!</span></td></tr>
<tr class="codeline" data-linenumber="1620"><td class="num" id="LN1620">1620</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1621"><td class="num" id="LN1621">1621</td><td class="line"><span class='keyword'>int</span> rewriteAppendOnlyFileBackground(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1622"><td class="num" id="LN1622">1622</td><td class="line">    pid_t childpid;</td></tr>
<tr class="codeline" data-linenumber="1623"><td class="num" id="LN1623">1623</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1624"><td class="num" id="LN1624">1624</td><td class="line">    <span class='keyword'>if</span> (hasActiveChildProcess()) <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1625"><td class="num" id="LN1625">1625</td><td class="line">    <span class='keyword'>if</span> (aofCreatePipes() != <span class='macro'>C_OK<span class='macro_popup'>0</span></span>) <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1626"><td class="num" id="LN1626">1626</td><td class="line">    openChildInfoPipe();</td></tr>
<tr class="codeline" data-linenumber="1627"><td class="num" id="LN1627">1627</td><td class="line">    <span class='keyword'>if</span> ((childpid = redisFork(<span class='macro'>CHILD_TYPE_AOF<span class='macro_popup'>2</span></span>)) == 0) {</td></tr>
<tr class="codeline" data-linenumber="1628"><td class="num" id="LN1628">1628</td><td class="line">        <span class='keyword'>char</span> tmpfile[256];</td></tr>
<tr class="codeline" data-linenumber="1629"><td class="num" id="LN1629">1629</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1630"><td class="num" id="LN1630">1630</td><td class="line">        <span class='comment'>/* Child */</span></td></tr>
<tr class="codeline" data-linenumber="1631"><td class="num" id="LN1631">1631</td><td class="line">        redisSetProcTitle(<span class='string_literal'>"redis-aof-rewrite"</span>);</td></tr>
<tr class="codeline" data-linenumber="1632"><td class="num" id="LN1632">1632</td><td class="line">        redisSetCpuAffinity(server.aof_rewrite_cpulist);</td></tr>
<tr class="codeline" data-linenumber="1633"><td class="num" id="LN1633">1633</td><td class="line">        snprintf(tmpfile,256,<span class='string_literal'>"temp-rewriteaof-bg-%d.aof"</span>, (<span class='keyword'>int</span>) getpid());</td></tr>
<tr class="codeline" data-linenumber="1634"><td class="num" id="LN1634">1634</td><td class="line">        <span class='keyword'>if</span> (rewriteAppendOnlyFile(tmpfile) == <span class='macro'>C_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1635"><td class="num" id="LN1635">1635</td><td class="line">            sendChildCOWInfo(<span class='macro'>CHILD_TYPE_AOF<span class='macro_popup'>2</span></span>, <span class='string_literal'>"AOF rewrite"</span>);</td></tr>
<tr class="codeline" data-linenumber="1636"><td class="num" id="LN1636">1636</td><td class="line">            exitFromChild(0);</td></tr>
<tr class="codeline" data-linenumber="1637"><td class="num" id="LN1637">1637</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1638"><td class="num" id="LN1638">1638</td><td class="line">            exitFromChild(1);</td></tr>
<tr class="codeline" data-linenumber="1639"><td class="num" id="LN1639">1639</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1640"><td class="num" id="LN1640">1640</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1641"><td class="num" id="LN1641">1641</td><td class="line">        <span class='comment'>/* Parent */</span></td></tr>
<tr class="codeline" data-linenumber="1642"><td class="num" id="LN1642">1642</td><td class="line">        <span class='keyword'>if</span> (childpid == -1) {</td></tr>
<tr class="codeline" data-linenumber="1643"><td class="num" id="LN1643">1643</td><td class="line">            closeChildInfoPipe();</td></tr>
<tr class="codeline" data-linenumber="1644"><td class="num" id="LN1644">1644</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1645"><td class="num" id="LN1645">1645</td><td class="line">                <span class='string_literal'>"Can't rewrite append only file in background: fork: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="1646"><td class="num" id="LN1646">1646</td><td class="line">                strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="1647"><td class="num" id="LN1647">1647</td><td class="line">            aofClosePipes();</td></tr>
<tr class="codeline" data-linenumber="1648"><td class="num" id="LN1648">1648</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1649"><td class="num" id="LN1649">1649</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1650"><td class="num" id="LN1650">1650</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1651"><td class="num" id="LN1651">1651</td><td class="line">            <span class='string_literal'>"Background append only file rewriting started by pid %d"</span>,childpid);</td></tr>
<tr class="codeline" data-linenumber="1652"><td class="num" id="LN1652">1652</td><td class="line">        server.aof_rewrite_scheduled = 0;</td></tr>
<tr class="codeline" data-linenumber="1653"><td class="num" id="LN1653">1653</td><td class="line">        server.aof_rewrite_time_start = time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1654"><td class="num" id="LN1654">1654</td><td class="line">        server.aof_child_pid = childpid;</td></tr>
<tr class="codeline" data-linenumber="1655"><td class="num" id="LN1655">1655</td><td class="line">        <span class='comment'>/* We set appendseldb to -1 in order to force the next call to the</span></td></tr>
<tr class="codeline" data-linenumber="1656"><td class="num" id="LN1656">1656</td><td class="line">         <span class='comment'>* feedAppendOnlyFile() to issue a SELECT command, so the differences</span></td></tr>
<tr class="codeline" data-linenumber="1657"><td class="num" id="LN1657">1657</td><td class="line">         <span class='comment'>* accumulated by the parent into server.aof_rewrite_buf will start</span></td></tr>
<tr class="codeline" data-linenumber="1658"><td class="num" id="LN1658">1658</td><td class="line">         <span class='comment'>* with a SELECT statement and it will be safe to merge. */</span></td></tr>
<tr class="codeline" data-linenumber="1659"><td class="num" id="LN1659">1659</td><td class="line">        server.aof_selected_db = -1;</td></tr>
<tr class="codeline" data-linenumber="1660"><td class="num" id="LN1660">1660</td><td class="line">        replicationScriptCacheFlush();</td></tr>
<tr class="codeline" data-linenumber="1661"><td class="num" id="LN1661">1661</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1662"><td class="num" id="LN1662">1662</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1663"><td class="num" id="LN1663">1663</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>; <span class='comment'>/* unreached */</span></td></tr>
<tr class="codeline" data-linenumber="1664"><td class="num" id="LN1664">1664</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1665"><td class="num" id="LN1665">1665</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1666"><td class="num" id="LN1666">1666</td><td class="line"><span class='keyword'>void</span> bgrewriteaofCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="1667"><td class="num" id="LN1667">1667</td><td class="line">    <span class='keyword'>if</span> (server.aof_child_pid != -1) {</td></tr>
<tr class="codeline" data-linenumber="1668"><td class="num" id="LN1668">1668</td><td class="line">        addReplyError(c,<span class='string_literal'>"Background append only file rewriting already in progress"</span>);</td></tr>
<tr class="codeline" data-linenumber="1669"><td class="num" id="LN1669">1669</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (hasActiveChildProcess()) {</td></tr>
<tr class="codeline" data-linenumber="1670"><td class="num" id="LN1670">1670</td><td class="line">        server.aof_rewrite_scheduled = 1;</td></tr>
<tr class="codeline" data-linenumber="1671"><td class="num" id="LN1671">1671</td><td class="line">        addReplyStatus(c,<span class='string_literal'>"Background append only file rewriting scheduled"</span>);</td></tr>
<tr class="codeline" data-linenumber="1672"><td class="num" id="LN1672">1672</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (rewriteAppendOnlyFileBackground() == <span class='macro'>C_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1673"><td class="num" id="LN1673">1673</td><td class="line">        addReplyStatus(c,<span class='string_literal'>"Background append only file rewriting started"</span>);</td></tr>
<tr class="codeline" data-linenumber="1674"><td class="num" id="LN1674">1674</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1675"><td class="num" id="LN1675">1675</td><td class="line">        addReplyError(c,<span class='string_literal'>"Can't execute an AOF background rewriting. "</span></td></tr>
<tr class="codeline" data-linenumber="1676"><td class="num" id="LN1676">1676</td><td class="line">                        <span class='string_literal'>"Please check the server logs for more information."</span>);</td></tr>
<tr class="codeline" data-linenumber="1677"><td class="num" id="LN1677">1677</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1678"><td class="num" id="LN1678">1678</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1679"><td class="num" id="LN1679">1679</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1680"><td class="num" id="LN1680">1680</td><td class="line"><span class='keyword'>void</span> aofRemoveTempFile(pid_t childpid) {</td></tr>
<tr class="codeline" data-linenumber="1681"><td class="num" id="LN1681">1681</td><td class="line">    <span class='keyword'>char</span> tmpfile[256];</td></tr>
<tr class="codeline" data-linenumber="1682"><td class="num" id="LN1682">1682</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1683"><td class="num" id="LN1683">1683</td><td class="line">    <span class="mrange">snprintf</span>(tmpfile,256,<span class='string_literal'>"temp-rewriteaof-bg-%d.aof"</span>, (<span class='keyword'>int</span>) childpid);</td></tr>
<tr><td class="num"></td><td class="line"><div id="EndPath" class="msg msgEvent" style="margin-left:5ex; max-width:59em">Call to function 'snprintf' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'snprintf_s' in case of C11</div></td></tr>
<tr class="codeline" data-linenumber="1684"><td class="num" id="LN1684">1684</td><td class="line">    bg_unlink(tmpfile);</td></tr>
<tr class="codeline" data-linenumber="1685"><td class="num" id="LN1685">1685</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1686"><td class="num" id="LN1686">1686</td><td class="line">    snprintf(tmpfile,256,<span class='string_literal'>"temp-rewriteaof-%d.aof"</span>, (<span class='keyword'>int</span>) childpid);</td></tr>
<tr class="codeline" data-linenumber="1687"><td class="num" id="LN1687">1687</td><td class="line">    bg_unlink(tmpfile);</td></tr>
<tr class="codeline" data-linenumber="1688"><td class="num" id="LN1688">1688</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1689"><td class="num" id="LN1689">1689</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1690"><td class="num" id="LN1690">1690</td><td class="line"><span class='comment'>/* Update the server.aof_current_size field explicitly using stat(2)</span></td></tr>
<tr class="codeline" data-linenumber="1691"><td class="num" id="LN1691">1691</td><td class="line"> <span class='comment'>* to check the size of the file. This is useful after a rewrite or after</span></td></tr>
<tr class="codeline" data-linenumber="1692"><td class="num" id="LN1692">1692</td><td class="line"> <span class='comment'>* a restart, normally the size is updated just adding the write length</span></td></tr>
<tr class="codeline" data-linenumber="1693"><td class="num" id="LN1693">1693</td><td class="line"> <span class='comment'>* to the current length, that is much faster. */</span></td></tr>
<tr class="codeline" data-linenumber="1694"><td class="num" id="LN1694">1694</td><td class="line"><span class='keyword'>void</span> aofUpdateCurrentSize(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1695"><td class="num" id="LN1695">1695</td><td class="line">    <span class='keyword'>struct</span> <span class='macro'>redis_stat<span class='macro_popup'>stat</span></span> sb;</td></tr>
<tr class="codeline" data-linenumber="1696"><td class="num" id="LN1696">1696</td><td class="line">    mstime_t latency;</td></tr>
<tr class="codeline" data-linenumber="1697"><td class="num" id="LN1697">1697</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1698"><td class="num" id="LN1698">1698</td><td class="line">    <span class='macro'>latencyStartMonitor(latency)<span class='macro_popup'>if (server.latency_monitor_threshold) { latency = mstime(); }<br> else { latency = 0; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1699"><td class="num" id="LN1699">1699</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>redis_fstat<span class='macro_popup'>fstat</span></span>(server.aof_fd,&amp;sb) == -1) {</td></tr>
<tr class="codeline" data-linenumber="1700"><td class="num" id="LN1700">1700</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Unable to obtain the AOF file length. stat: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="1701"><td class="num" id="LN1701">1701</td><td class="line">            strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="1702"><td class="num" id="LN1702">1702</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1703"><td class="num" id="LN1703">1703</td><td class="line">        server.aof_current_size = sb.st_size;</td></tr>
<tr class="codeline" data-linenumber="1704"><td class="num" id="LN1704">1704</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1705"><td class="num" id="LN1705">1705</td><td class="line">    <span class='macro'>latencyEndMonitor(latency)<span class='macro_popup'>if (server.latency_monitor_threshold) { latency = mstime() - latency<br>; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1706"><td class="num" id="LN1706">1706</td><td class="line">    <span class='macro'>latencyAddSampleIfNeeded(<span class='string_literal'>"aof-fstat"</span>,latency)<span class='macro_popup'>if (server.latency_monitor_threshold &amp;&amp; (latency) &gt;=<br> server.latency_monitor_threshold) latencyAddSample(("aof-fstat"<br>),(latency));</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1707"><td class="num" id="LN1707">1707</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1708"><td class="num" id="LN1708">1708</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1709"><td class="num" id="LN1709">1709</td><td class="line"><span class='comment'>/* A background append only file rewriting (BGREWRITEAOF) terminated its work.</span></td></tr>
<tr class="codeline" data-linenumber="1710"><td class="num" id="LN1710">1710</td><td class="line"> <span class='comment'>* Handle this. */</span></td></tr>
<tr class="codeline" data-linenumber="1711"><td class="num" id="LN1711">1711</td><td class="line"><span class='keyword'>void</span> backgroundRewriteDoneHandler(<span class='keyword'>int</span> exitcode, <span class='keyword'>int</span> bysignal) {</td></tr>
<tr class="codeline" data-linenumber="1712"><td class="num" id="LN1712">1712</td><td class="line">    <span class='keyword'>if</span> (!bysignal &amp;&amp; exitcode == 0) {</td></tr>
<tr class="codeline" data-linenumber="1713"><td class="num" id="LN1713">1713</td><td class="line">        <span class='keyword'>int</span> newfd, oldfd;</td></tr>
<tr class="codeline" data-linenumber="1714"><td class="num" id="LN1714">1714</td><td class="line">        <span class='keyword'>char</span> tmpfile[256];</td></tr>
<tr class="codeline" data-linenumber="1715"><td class="num" id="LN1715">1715</td><td class="line">        <span class='keyword'>long</span> <span class='keyword'>long</span> now = ustime();</td></tr>
<tr class="codeline" data-linenumber="1716"><td class="num" id="LN1716">1716</td><td class="line">        mstime_t latency;</td></tr>
<tr class="codeline" data-linenumber="1717"><td class="num" id="LN1717">1717</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1718"><td class="num" id="LN1718">1718</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1719"><td class="num" id="LN1719">1719</td><td class="line">            <span class='string_literal'>"Background AOF rewrite terminated with success"</span>);</td></tr>
<tr class="codeline" data-linenumber="1720"><td class="num" id="LN1720">1720</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1721"><td class="num" id="LN1721">1721</td><td class="line">        <span class='comment'>/* Flush the differences accumulated by the parent to the</span></td></tr>
<tr class="codeline" data-linenumber="1722"><td class="num" id="LN1722">1722</td><td class="line">         <span class='comment'>* rewritten AOF. */</span></td></tr>
<tr class="codeline" data-linenumber="1723"><td class="num" id="LN1723">1723</td><td class="line">        <span class='macro'>latencyStartMonitor(latency)<span class='macro_popup'>if (server.latency_monitor_threshold) { latency = mstime(); }<br> else { latency = 0; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1724"><td class="num" id="LN1724">1724</td><td class="line">        snprintf(tmpfile,256,<span class='string_literal'>"temp-rewriteaof-bg-%d.aof"</span>,</td></tr>
<tr class="codeline" data-linenumber="1725"><td class="num" id="LN1725">1725</td><td class="line">            (<span class='keyword'>int</span>)server.aof_child_pid);</td></tr>
<tr class="codeline" data-linenumber="1726"><td class="num" id="LN1726">1726</td><td class="line">        newfd = open(tmpfile,<span class='macro'>O_WRONLY<span class='macro_popup'>01</span></span>|<span class='macro'>O_APPEND<span class='macro_popup'>02000</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1727"><td class="num" id="LN1727">1727</td><td class="line">        <span class='keyword'>if</span> (newfd == -1) {</td></tr>
<tr class="codeline" data-linenumber="1728"><td class="num" id="LN1728">1728</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1729"><td class="num" id="LN1729">1729</td><td class="line">                <span class='string_literal'>"Unable to open the temporary AOF produced by the child: %s"</span>, strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="1730"><td class="num" id="LN1730">1730</td><td class="line">            <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="1731"><td class="num" id="LN1731">1731</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1732"><td class="num" id="LN1732">1732</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1733"><td class="num" id="LN1733">1733</td><td class="line">        <span class='keyword'>if</span> (aofRewriteBufferWrite(newfd) == -1) {</td></tr>
<tr class="codeline" data-linenumber="1734"><td class="num" id="LN1734">1734</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1735"><td class="num" id="LN1735">1735</td><td class="line">                <span class='string_literal'>"Error trying to flush the parent diff to the rewritten AOF: %s"</span>, strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="1736"><td class="num" id="LN1736">1736</td><td class="line">            close(newfd);</td></tr>
<tr class="codeline" data-linenumber="1737"><td class="num" id="LN1737">1737</td><td class="line">            <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="1738"><td class="num" id="LN1738">1738</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1739"><td class="num" id="LN1739">1739</td><td class="line">        <span class='macro'>latencyEndMonitor(latency)<span class='macro_popup'>if (server.latency_monitor_threshold) { latency = mstime() - latency<br>; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1740"><td class="num" id="LN1740">1740</td><td class="line">        <span class='macro'>latencyAddSampleIfNeeded(<span class='string_literal'>"aof-rewrite-diff-write"</span>,latency)<span class='macro_popup'>if (server.latency_monitor_threshold &amp;&amp; (latency) &gt;=<br> server.latency_monitor_threshold) latencyAddSample(("aof-rewrite-diff-write"<br>),(latency));</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1741"><td class="num" id="LN1741">1741</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1742"><td class="num" id="LN1742">1742</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1743"><td class="num" id="LN1743">1743</td><td class="line">            <span class='string_literal'>"Residual parent diff successfully flushed to the rewritten AOF (%.2f MB)"</span>, (<span class='keyword'>double</span>) aofRewriteBufferSize() / (1024*1024));</td></tr>
<tr class="codeline" data-linenumber="1744"><td class="num" id="LN1744">1744</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1745"><td class="num" id="LN1745">1745</td><td class="line">        <span class='comment'>/* The only remaining thing to do is to rename the temporary file to</span></td></tr>
<tr class="codeline" data-linenumber="1746"><td class="num" id="LN1746">1746</td><td class="line">         <span class='comment'>* the configured file and switch the file descriptor used to do AOF</span></td></tr>
<tr class="codeline" data-linenumber="1747"><td class="num" id="LN1747">1747</td><td class="line">         <span class='comment'>* writes. We don't want close(2) or rename(2) calls to block the</span></td></tr>
<tr class="codeline" data-linenumber="1748"><td class="num" id="LN1748">1748</td><td class="line">         <span class='comment'>* server on old file deletion.</span></td></tr>
<tr class="codeline" data-linenumber="1749"><td class="num" id="LN1749">1749</td><td class="line">         <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1750"><td class="num" id="LN1750">1750</td><td class="line">         <span class='comment'>* There are two possible scenarios:</span></td></tr>
<tr class="codeline" data-linenumber="1751"><td class="num" id="LN1751">1751</td><td class="line">         <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1752"><td class="num" id="LN1752">1752</td><td class="line">         <span class='comment'>* 1) AOF is DISABLED and this was a one time rewrite. The temporary</span></td></tr>
<tr class="codeline" data-linenumber="1753"><td class="num" id="LN1753">1753</td><td class="line">         <span class='comment'>* file will be renamed to the configured file. When this file already</span></td></tr>
<tr class="codeline" data-linenumber="1754"><td class="num" id="LN1754">1754</td><td class="line">         <span class='comment'>* exists, it will be unlinked, which may block the server.</span></td></tr>
<tr class="codeline" data-linenumber="1755"><td class="num" id="LN1755">1755</td><td class="line">         <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1756"><td class="num" id="LN1756">1756</td><td class="line">         <span class='comment'>* 2) AOF is ENABLED and the rewritten AOF will immediately start</span></td></tr>
<tr class="codeline" data-linenumber="1757"><td class="num" id="LN1757">1757</td><td class="line">         <span class='comment'>* receiving writes. After the temporary file is renamed to the</span></td></tr>
<tr class="codeline" data-linenumber="1758"><td class="num" id="LN1758">1758</td><td class="line">         <span class='comment'>* configured file, the original AOF file descriptor will be closed.</span></td></tr>
<tr class="codeline" data-linenumber="1759"><td class="num" id="LN1759">1759</td><td class="line">         <span class='comment'>* Since this will be the last reference to that file, closing it</span></td></tr>
<tr class="codeline" data-linenumber="1760"><td class="num" id="LN1760">1760</td><td class="line">         <span class='comment'>* causes the underlying file to be unlinked, which may block the</span></td></tr>
<tr class="codeline" data-linenumber="1761"><td class="num" id="LN1761">1761</td><td class="line">         <span class='comment'>* server.</span></td></tr>
<tr class="codeline" data-linenumber="1762"><td class="num" id="LN1762">1762</td><td class="line">         <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1763"><td class="num" id="LN1763">1763</td><td class="line">         <span class='comment'>* To mitigate the blocking effect of the unlink operation (either</span></td></tr>
<tr class="codeline" data-linenumber="1764"><td class="num" id="LN1764">1764</td><td class="line">         <span class='comment'>* caused by rename(2) in scenario 1, or by close(2) in scenario 2), we</span></td></tr>
<tr class="codeline" data-linenumber="1765"><td class="num" id="LN1765">1765</td><td class="line">         <span class='comment'>* use a background thread to take care of this. First, we</span></td></tr>
<tr class="codeline" data-linenumber="1766"><td class="num" id="LN1766">1766</td><td class="line">         <span class='comment'>* make scenario 1 identical to scenario 2 by opening the target file</span></td></tr>
<tr class="codeline" data-linenumber="1767"><td class="num" id="LN1767">1767</td><td class="line">         <span class='comment'>* when it exists. The unlink operation after the rename(2) will then</span></td></tr>
<tr class="codeline" data-linenumber="1768"><td class="num" id="LN1768">1768</td><td class="line">         <span class='comment'>* be executed upon calling close(2) for its descriptor. Everything to</span></td></tr>
<tr class="codeline" data-linenumber="1769"><td class="num" id="LN1769">1769</td><td class="line">         <span class='comment'>* guarantee atomicity for this switch has already happened by then, so</span></td></tr>
<tr class="codeline" data-linenumber="1770"><td class="num" id="LN1770">1770</td><td class="line">         <span class='comment'>* we don't care what the outcome or duration of that close operation</span></td></tr>
<tr class="codeline" data-linenumber="1771"><td class="num" id="LN1771">1771</td><td class="line">         <span class='comment'>* is, as long as the file descriptor is released again. */</span></td></tr>
<tr class="codeline" data-linenumber="1772"><td class="num" id="LN1772">1772</td><td class="line">        <span class='keyword'>if</span> (server.aof_fd == -1) {</td></tr>
<tr class="codeline" data-linenumber="1773"><td class="num" id="LN1773">1773</td><td class="line">            <span class='comment'>/* AOF disabled */</span></td></tr>
<tr class="codeline" data-linenumber="1774"><td class="num" id="LN1774">1774</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1775"><td class="num" id="LN1775">1775</td><td class="line">            <span class='comment'>/* Don't care if this fails: oldfd will be -1 and we handle that.</span></td></tr>
<tr class="codeline" data-linenumber="1776"><td class="num" id="LN1776">1776</td><td class="line">             <span class='comment'>* One notable case of -1 return is if the old file does</span></td></tr>
<tr class="codeline" data-linenumber="1777"><td class="num" id="LN1777">1777</td><td class="line">             <span class='comment'>* not exist. */</span></td></tr>
<tr class="codeline" data-linenumber="1778"><td class="num" id="LN1778">1778</td><td class="line">            oldfd = open(server.aof_filename,<span class='macro'>O_RDONLY<span class='macro_popup'>00</span></span>|<span class='macro'>O_NONBLOCK<span class='macro_popup'>04000</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1779"><td class="num" id="LN1779">1779</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1780"><td class="num" id="LN1780">1780</td><td class="line">            <span class='comment'>/* AOF enabled */</span></td></tr>
<tr class="codeline" data-linenumber="1781"><td class="num" id="LN1781">1781</td><td class="line">            oldfd = -1; <span class='comment'>/* We'll set this to the current AOF filedes later. */</span></td></tr>
<tr class="codeline" data-linenumber="1782"><td class="num" id="LN1782">1782</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1783"><td class="num" id="LN1783">1783</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1784"><td class="num" id="LN1784">1784</td><td class="line">        <span class='comment'>/* Rename the temporary file. This will not unlink the target file if</span></td></tr>
<tr class="codeline" data-linenumber="1785"><td class="num" id="LN1785">1785</td><td class="line">         <span class='comment'>* it exists, because we reference it with "oldfd". */</span></td></tr>
<tr class="codeline" data-linenumber="1786"><td class="num" id="LN1786">1786</td><td class="line">        <span class='macro'>latencyStartMonitor(latency)<span class='macro_popup'>if (server.latency_monitor_threshold) { latency = mstime(); }<br> else { latency = 0; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1787"><td class="num" id="LN1787">1787</td><td class="line">        <span class='keyword'>if</span> (rename(tmpfile,server.aof_filename) == -1) {</td></tr>
<tr class="codeline" data-linenumber="1788"><td class="num" id="LN1788">1788</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1789"><td class="num" id="LN1789">1789</td><td class="line">                <span class='string_literal'>"Error trying to rename the temporary AOF file %s into %s: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="1790"><td class="num" id="LN1790">1790</td><td class="line">                tmpfile,</td></tr>
<tr class="codeline" data-linenumber="1791"><td class="num" id="LN1791">1791</td><td class="line">                server.aof_filename,</td></tr>
<tr class="codeline" data-linenumber="1792"><td class="num" id="LN1792">1792</td><td class="line">                strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="1793"><td class="num" id="LN1793">1793</td><td class="line">            close(newfd);</td></tr>
<tr class="codeline" data-linenumber="1794"><td class="num" id="LN1794">1794</td><td class="line">            <span class='keyword'>if</span> (oldfd != -1) close(oldfd);</td></tr>
<tr class="codeline" data-linenumber="1795"><td class="num" id="LN1795">1795</td><td class="line">            <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="1796"><td class="num" id="LN1796">1796</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1797"><td class="num" id="LN1797">1797</td><td class="line">        <span class='macro'>latencyEndMonitor(latency)<span class='macro_popup'>if (server.latency_monitor_threshold) { latency = mstime() - latency<br>; }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1798"><td class="num" id="LN1798">1798</td><td class="line">        <span class='macro'>latencyAddSampleIfNeeded(<span class='string_literal'>"aof-rename"</span>,latency)<span class='macro_popup'>if (server.latency_monitor_threshold &amp;&amp; (latency) &gt;=<br> server.latency_monitor_threshold) latencyAddSample(("aof-rename"<br>),(latency));</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1799"><td class="num" id="LN1799">1799</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1800"><td class="num" id="LN1800">1800</td><td class="line">        <span class='keyword'>if</span> (server.aof_fd == -1) {</td></tr>
<tr class="codeline" data-linenumber="1801"><td class="num" id="LN1801">1801</td><td class="line">            <span class='comment'>/* AOF disabled, we don't need to set the AOF file descriptor</span></td></tr>
<tr class="codeline" data-linenumber="1802"><td class="num" id="LN1802">1802</td><td class="line">             <span class='comment'>* to this new file, so we can close it. */</span></td></tr>
<tr class="codeline" data-linenumber="1803"><td class="num" id="LN1803">1803</td><td class="line">            close(newfd);</td></tr>
<tr class="codeline" data-linenumber="1804"><td class="num" id="LN1804">1804</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1805"><td class="num" id="LN1805">1805</td><td class="line">            <span class='comment'>/* AOF enabled, replace the old fd with the new one. */</span></td></tr>
<tr class="codeline" data-linenumber="1806"><td class="num" id="LN1806">1806</td><td class="line">            oldfd = server.aof_fd;</td></tr>
<tr class="codeline" data-linenumber="1807"><td class="num" id="LN1807">1807</td><td class="line">            server.aof_fd = newfd;</td></tr>
<tr class="codeline" data-linenumber="1808"><td class="num" id="LN1808">1808</td><td class="line">            <span class='keyword'>if</span> (server.aof_fsync == <span class='macro'>AOF_FSYNC_ALWAYS<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1809"><td class="num" id="LN1809">1809</td><td class="line">                <span class='macro'>redis_fsync<span class='macro_popup'>fdatasync</span></span>(newfd);</td></tr>
<tr class="codeline" data-linenumber="1810"><td class="num" id="LN1810">1810</td><td class="line">            <span class='keyword'>else</span> <span class='keyword'>if</span> (server.aof_fsync == <span class='macro'>AOF_FSYNC_EVERYSEC<span class='macro_popup'>2</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1811"><td class="num" id="LN1811">1811</td><td class="line">                aof_background_fsync(newfd);</td></tr>
<tr class="codeline" data-linenumber="1812"><td class="num" id="LN1812">1812</td><td class="line">            server.aof_selected_db = -1; <span class='comment'>/* Make sure SELECT is re-issued */</span></td></tr>
<tr class="codeline" data-linenumber="1813"><td class="num" id="LN1813">1813</td><td class="line">            aofUpdateCurrentSize();</td></tr>
<tr class="codeline" data-linenumber="1814"><td class="num" id="LN1814">1814</td><td class="line">            server.aof_rewrite_base_size = server.aof_current_size;</td></tr>
<tr class="codeline" data-linenumber="1815"><td class="num" id="LN1815">1815</td><td class="line">            server.aof_fsync_offset = server.aof_current_size;</td></tr>
<tr class="codeline" data-linenumber="1816"><td class="num" id="LN1816">1816</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1817"><td class="num" id="LN1817">1817</td><td class="line">            <span class='comment'>/* Clear regular AOF buffer since its contents was just written to</span></td></tr>
<tr class="codeline" data-linenumber="1818"><td class="num" id="LN1818">1818</td><td class="line">             <span class='comment'>* the new AOF from the background rewrite buffer. */</span></td></tr>
<tr class="codeline" data-linenumber="1819"><td class="num" id="LN1819">1819</td><td class="line">            sdsfree(server.aof_buf);</td></tr>
<tr class="codeline" data-linenumber="1820"><td class="num" id="LN1820">1820</td><td class="line">            server.aof_buf = sdsempty();</td></tr>
<tr class="codeline" data-linenumber="1821"><td class="num" id="LN1821">1821</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1822"><td class="num" id="LN1822">1822</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1823"><td class="num" id="LN1823">1823</td><td class="line">        server.aof_lastbgrewrite_status = <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1824"><td class="num" id="LN1824">1824</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1825"><td class="num" id="LN1825">1825</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>, <span class='string_literal'>"Background AOF rewrite finished successfully"</span>);</td></tr>
<tr class="codeline" data-linenumber="1826"><td class="num" id="LN1826">1826</td><td class="line">        <span class='comment'>/* Change state from WAIT_REWRITE to ON if needed */</span></td></tr>
<tr class="codeline" data-linenumber="1827"><td class="num" id="LN1827">1827</td><td class="line">        <span class='keyword'>if</span> (server.aof_state == <span class='macro'>AOF_WAIT_REWRITE<span class='macro_popup'>2</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1828"><td class="num" id="LN1828">1828</td><td class="line">            server.aof_state = <span class='macro'>AOF_ON<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1829"><td class="num" id="LN1829">1829</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1830"><td class="num" id="LN1830">1830</td><td class="line">        <span class='comment'>/* Asynchronously close the overwritten AOF. */</span></td></tr>
<tr class="codeline" data-linenumber="1831"><td class="num" id="LN1831">1831</td><td class="line">        <span class='keyword'>if</span> (oldfd != -1) bioCreateBackgroundJob(<span class='macro'>BIO_CLOSE_FILE<span class='macro_popup'>0</span></span>,(<span class='keyword'>void</span>*)(<span class='keyword'>long</span>)oldfd,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1832"><td class="num" id="LN1832">1832</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1833"><td class="num" id="LN1833">1833</td><td class="line">        serverLog(<span class='macro'>LL_VERBOSE<span class='macro_popup'>1</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1834"><td class="num" id="LN1834">1834</td><td class="line">            <span class='string_literal'>"Background AOF rewrite signal handler took %lldus"</span>, ustime()-now);</td></tr>
<tr class="codeline" data-linenumber="1835"><td class="num" id="LN1835">1835</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (!bysignal &amp;&amp; exitcode != 0) {</td></tr>
<tr class="codeline" data-linenumber="1836"><td class="num" id="LN1836">1836</td><td class="line">        server.aof_lastbgrewrite_status = <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1837"><td class="num" id="LN1837">1837</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1838"><td class="num" id="LN1838">1838</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1839"><td class="num" id="LN1839">1839</td><td class="line">            <span class='string_literal'>"Background AOF rewrite terminated with error"</span>);</td></tr>
<tr class="codeline" data-linenumber="1840"><td class="num" id="LN1840">1840</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1841"><td class="num" id="LN1841">1841</td><td class="line">        <span class='comment'>/* SIGUSR1 is whitelisted, so we have a way to kill a child without</span></td></tr>
<tr class="codeline" data-linenumber="1842"><td class="num" id="LN1842">1842</td><td class="line">         <span class='comment'>* triggering an error condition. */</span></td></tr>
<tr class="codeline" data-linenumber="1843"><td class="num" id="LN1843">1843</td><td class="line">        <span class='keyword'>if</span> (bysignal != <span class='macro'>SIGUSR1<span class='macro_popup'>10</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1844"><td class="num" id="LN1844">1844</td><td class="line">            server.aof_lastbgrewrite_status = <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1845"><td class="num" id="LN1845">1845</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1846"><td class="num" id="LN1846">1846</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1847"><td class="num" id="LN1847">1847</td><td class="line">            <span class='string_literal'>"Background AOF rewrite terminated by signal %d"</span>, bysignal);</td></tr>
<tr class="codeline" data-linenumber="1848"><td class="num" id="LN1848">1848</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1849"><td class="num" id="LN1849">1849</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1850"><td class="num" id="LN1850">1850</td><td class="line">cleanup:</td></tr>
<tr class="codeline" data-linenumber="1851"><td class="num" id="LN1851">1851</td><td class="line">    aofClosePipes();</td></tr>
<tr class="codeline" data-linenumber="1852"><td class="num" id="LN1852">1852</td><td class="line">    aofRewriteBufferReset();</td></tr>
<tr class="codeline" data-linenumber="1853"><td class="num" id="LN1853">1853</td><td class="line">    aofRemoveTempFile(server.aof_child_pid);</td></tr>
<tr class="codeline" data-linenumber="1854"><td class="num" id="LN1854">1854</td><td class="line">    server.aof_child_pid = -1;</td></tr>
<tr class="codeline" data-linenumber="1855"><td class="num" id="LN1855">1855</td><td class="line">    server.aof_rewrite_time_last = time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)-server.aof_rewrite_time_start;</td></tr>
<tr class="codeline" data-linenumber="1856"><td class="num" id="LN1856">1856</td><td class="line">    server.aof_rewrite_time_start = -1;</td></tr>
<tr class="codeline" data-linenumber="1857"><td class="num" id="LN1857">1857</td><td class="line">    <span class='comment'>/* Schedule a new rewrite if we are waiting for it to switch the AOF ON. */</span></td></tr>
<tr class="codeline" data-linenumber="1858"><td class="num" id="LN1858">1858</td><td class="line">    <span class='keyword'>if</span> (server.aof_state == <span class='macro'>AOF_WAIT_REWRITE<span class='macro_popup'>2</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1859"><td class="num" id="LN1859">1859</td><td class="line">        server.aof_rewrite_scheduled = 1;</td></tr>
<tr class="codeline" data-linenumber="1860"><td class="num" id="LN1860">1860</td><td class="line">}</td></tr>
</table></body></html>
