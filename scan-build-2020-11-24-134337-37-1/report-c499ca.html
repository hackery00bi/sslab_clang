<!doctype html>
<html>
<head>
<title>scripting.c</title>

<style type="text/css">
body { color:#000000; background-color:#ffffff }
body { font-family:Helvetica, sans-serif; font-size:10pt }
h1 { font-size:14pt }
.FileName { margin-top: 5px; margin-bottom: 5px; display: inline; }
.FileNav { margin-left: 5px; margin-right: 5px; display: inline; }
.FileNav a { text-decoration:none; font-size: larger; }
.divider { margin-top: 30px; margin-bottom: 30px; height: 15px; }
.divider { background-color: gray; }
.code { border-collapse:collapse; width:100%; }
.code { font-family: "Monospace", monospace; font-size:10pt }
.code { line-height: 1.2em }
.comment { color: green; font-style: oblique }
.keyword { color: blue }
.string_literal { color: red }
.directive { color: darkmagenta }

/* Macros and variables could have pop-up notes hidden by default.
  - Macro pop-up:    expansion of the macro
  - Variable pop-up: value (table) of the variable */
.macro_popup, .variable_popup { display: none; }

/* Pop-up appears on mouse-hover event. */
.macro:hover .macro_popup, .variable:hover .variable_popup {
  display: block;
  padding: 2px;
  -webkit-border-radius:5px;
  -webkit-box-shadow:1px 1px 7px #000;
  border-radius:5px;
  box-shadow:1px 1px 7px #000;
  position: absolute;
  top: -1em;
  left:10em;
  z-index: 1
}

.macro_popup {
  border: 2px solid red;
  background-color:#FFF0F0;
  font-weight: normal;
}

.variable_popup {
  border: 2px solid blue;
  background-color:#F0F0FF;
  font-weight: bold;
  font-family: Helvetica, sans-serif;
  font-size: 9pt;
}

/* Pop-up notes needs a relative position as a base where they pops up. */
.macro, .variable {
  background-color: PaleGoldenRod;
  position: relative;
}
.macro { color: DarkMagenta; }

#tooltiphint {
  position: fixed;
  width: 50em;
  margin-left: -25em;
  left: 50%;
  padding: 10px;
  border: 1px solid #b0b0b0;
  border-radius: 2px;
  box-shadow: 1px 1px 7px black;
  background-color: #c0c0c0;
  z-index: 2;
}

.num { width:2.5em; padding-right:2ex; background-color:#eeeeee }
.num { text-align:right; font-size:8pt }
.num { color:#444444 }
.line { padding-left: 1ex; border-left: 3px solid #ccc }
.line { white-space: pre }
.msg { -webkit-box-shadow:1px 1px 7px #000 }
.msg { box-shadow:1px 1px 7px #000 }
.msg { -webkit-border-radius:5px }
.msg { border-radius:5px }
.msg { font-family:Helvetica, sans-serif; font-size:8pt }
.msg { float:left }
.msg { padding:0.25em 1ex 0.25em 1ex }
.msg { margin-top:10px; margin-bottom:10px }
.msg { font-weight:bold }
.msg { max-width:60em; word-wrap: break-word; white-space: pre-wrap }
.msgT { padding:0x; spacing:0x }
.msgEvent { background-color:#fff8b4; color:#000000 }
.msgControl { background-color:#bbbbbb; color:#000000 }
.msgNote { background-color:#ddeeff; color:#000000 }
.mrange { background-color:#dfddf3 }
.mrange { border-bottom:1px solid #6F9DBE }
.PathIndex { font-weight: bold; padding:0px 5px; margin-right:5px; }
.PathIndex { -webkit-border-radius:8px }
.PathIndex { border-radius:8px }
.PathIndexEvent { background-color:#bfba87 }
.PathIndexControl { background-color:#8c8c8c }
.PathIndexPopUp { background-color: #879abc; }
.PathNav a { text-decoration:none; font-size: larger }
.CodeInsertionHint { font-weight: bold; background-color: #10dd10 }
.CodeRemovalHint { background-color:#de1010 }
.CodeRemovalHint { border-bottom:1px solid #6F9DBE }
.selected{ background-color:orange !important; }

table.simpletable {
  padding: 5px;
  font-size:12pt;
  margin:20px;
  border-collapse: collapse; border-spacing: 0px;
}
td.rowname {
  text-align: right;
  vertical-align: top;
  font-weight: bold;
  color:#444444;
  padding-right:2ex;
}

/* Hidden text. */
input.spoilerhider + label {
  cursor: pointer;
  text-decoration: underline;
  display: block;
}
input.spoilerhider {
 display: none;
}
input.spoilerhider ~ .spoiler {
  overflow: hidden;
  margin: 10px auto 0;
  height: 0;
  opacity: 0;
}
input.spoilerhider:checked + label + .spoiler{
  height: auto;
  opacity: 1;
}
</style>
</head>
<body>
<!-- BUGDESC Call to function 'snprintf' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'snprintf_s' in case of C11 -->

<!-- BUGTYPE Potential insecure memory buffer bounds restriction in call 'snprintf' -->

<!-- BUGCATEGORY Security -->

<!-- BUGFILE /tmp/sslab_clang/c_redis/redis/src/scripting.c -->

<!-- FILENAME scripting.c -->

<!-- FUNCTIONNAME luaRedisGenericCommand -->

<!-- ISSUEHASHCONTENTOFLINEINCONTEXT 7a38569257bdf5606e001a19309c18e1 -->

<!-- BUGLINE 526 -->

<!-- BUGCOLUMN 23 -->

<!-- BUGPATHLENGTH 1 -->

<!-- BUGMETAEND -->
<!-- REPORTHEADER -->
<h3>Bug Summary</h3>
<table class="simpletable">
<tr><td class="rowname">File:</td><td>src/scripting.c</td></tr>
<tr><td class="rowname">Warning:</td><td><a href="#EndPath">line 526, column 23</a><br />Call to function 'snprintf' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'snprintf_s' in case of C11</td></tr>

</table>
<!-- REPORTSUMMARYEXTRA -->
<h3>Annotated Source Code</h3>
<p>Press <a href="#" onclick="toggleHelp(); return false;">'?'</a>
   to see keyboard shortcuts</p>
<input type="checkbox" class="spoilerhider" id="showinvocation" />
<label for="showinvocation" >Show analyzer invocation</label>
<div class="spoiler">clang -cc1 -cc1 -triple x86_64-unknown-linux-gnu -analyze -disable-free -main-file-name scripting.c -analyzer-store=region -analyzer-opt-analyze-nested-blocks -analyzer-checker=core -analyzer-checker=apiModeling -analyzer-checker=unix -analyzer-checker=deadcode -analyzer-checker=security.insecureAPI.UncheckedReturn -analyzer-checker=security.insecureAPI.getpw -analyzer-checker=security.insecureAPI.gets -analyzer-checker=security.insecureAPI.mktemp -analyzer-checker=security.insecureAPI.mkstemp -analyzer-checker=security.insecureAPI.vfork -analyzer-checker=nullability.NullPassedToNonnull -analyzer-checker=nullability.NullReturnedFromNonnull -analyzer-output plist -w -setup-static-analyzer -mrelocation-model static -mframe-pointer=none -fmath-errno -fno-rounding-math -mconstructor-aliases -munwind-tables -target-cpu x86-64 -fno-split-dwarf-inlining -debugger-tuning=gdb -resource-dir /llvm-project/build/lib/clang/12.0.0 -D REDIS_STATIC= -I ../deps/hiredis -I ../deps/linenoise -I ../deps/lua/src -D USE_JEMALLOC -I ../deps/jemalloc/include -internal-isystem /usr/local/include -internal-isystem /llvm-project/build/lib/clang/12.0.0/include -internal-externc-isystem /usr/include/x86_64-linux-gnu -internal-externc-isystem /include -internal-externc-isystem /usr/include -O2 -Wno-missing-field-initializers -std=c11 -fdebug-compilation-dir /tmp/sslab_clang/c_redis/redis/src -ferror-limit 19 -fgnuc-version=4.2.1 -vectorize-loops -vectorize-slp -analyzer-checker core -analyzer-checker cplusplus -analyzer-checker nullability -analyzer-checker optin -analyzer-checker security -analyzer-checker unix -analyzer-checker osx -analyzer-checker fuchsia -analyzer-checker webkit -analyzer-output=html -faddrsig -o /tmp/scan-build-2020-11-24-134337-37-1 -x c scripting.c
</div>
<div id='tooltiphint' hidden="true">
  <p>Keyboard shortcuts: </p>
  <ul>
    <li>Use 'j/k' keys for keyboard navigation</li>
    <li>Use 'Shift+S' to show/hide relevant lines</li>
    <li>Use '?' to toggle this window</li>
  </ul>
  <a href="#" onclick="toggleHelp(); return false;">Close</a>
</div>
<script type='text/javascript'>
var relevant_lines = {"1": {"526": 1}};

var filterCounterexample = function (hide) {
  var tables = document.getElementsByClassName("code");
  for (var t=0; t<tables.length; t++) {
    var table = tables[t];
    var file_id = table.getAttribute("data-fileid");
    var lines_in_fid = relevant_lines[file_id];
    if (!lines_in_fid) {
      lines_in_fid = {};
    }
    var lines = table.getElementsByClassName("codeline");
    for (var i=0; i<lines.length; i++) {
        var el = lines[i];
        var lineNo = el.getAttribute("data-linenumber");
        if (!lines_in_fid[lineNo]) {
          if (hide) {
            el.setAttribute("hidden", "");
          } else {
            el.removeAttribute("hidden");
          }
        }
    }
  }
}

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "S") {
    var checked = document.getElementsByName("showCounterexample")[0].checked;
    filterCounterexample(!checked);
    document.getElementsByName("showCounterexample")[0].checked = !checked;
  } else {
    return;
  }
  event.preventDefault();
}, true);

document.addEventListener("DOMContentLoaded", function() {
    document.querySelector('input[name="showCounterexample"]').onchange=
        function (event) {
      filterCounterexample(this.checked);
    };
});
</script>

<form>
    <input type="checkbox" name="showCounterexample" id="showCounterexample" />
    <label for="showCounterexample">
       Show only relevant lines
    </label>
</form>

<script type='text/javascript'>
var digitMatcher = new RegExp("[0-9]+");

var querySelectorAllArray = function(selector) {
  return Array.prototype.slice.call(
    document.querySelectorAll(selector));
}

document.addEventListener("DOMContentLoaded", function() {
    querySelectorAllArray(".PathNav > a").forEach(
        function(currentValue, currentIndex) {
            var hrefValue = currentValue.getAttribute("href");
            currentValue.onclick = function() {
                scrollTo(document.querySelector(hrefValue));
                return false;
            };
        });
});

var findNum = function() {
    var s = document.querySelector(".selected");
    if (!s || s.id == "EndPath") {
        return 0;
    }
    var out = parseInt(digitMatcher.exec(s.id)[0]);
    return out;
};

var scrollTo = function(el) {
    querySelectorAllArray(".selected").forEach(function(s) {
        s.classList.remove("selected");
    });
    el.classList.add("selected");
    window.scrollBy(0, el.getBoundingClientRect().top -
        (window.innerHeight / 2));
}

var move = function(num, up, numItems) {
  if (num == 1 && up || num == numItems - 1 && !up) {
    return 0;
  } else if (num == 0 && up) {
    return numItems - 1;
  } else if (num == 0 && !up) {
    return 1 % numItems;
  }
  return up ? num - 1 : num + 1;
}

var numToId = function(num) {
  if (num == 0) {
    return document.getElementById("EndPath")
  }
  return document.getElementById("Path" + num);
};

var navigateTo = function(up) {
  var numItems = document.querySelectorAll(
      ".line > .msgEvent, .line > .msgControl").length;
  var currentSelected = findNum();
  var newSelected = move(currentSelected, up, numItems);
  var newEl = numToId(newSelected, numItems);

  // Scroll element into center.
  scrollTo(newEl);
};

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "j") {
    navigateTo(/*up=*/false);
  } else if (event.key == "k") {
    navigateTo(/*up=*/true);
  } else {
    return;
  }
  event.preventDefault();
}, true);
</script>
  
<script type='text/javascript'>

var toggleHelp = function() {
    var hint = document.querySelector("#tooltiphint");
    var attributeName = "hidden";
    if (hint.hasAttribute(attributeName)) {
      hint.removeAttribute(attributeName);
    } else {
      hint.setAttribute("hidden", "true");
    }
};
window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "?") {
    toggleHelp();
  } else {
    return;
  }
  event.preventDefault();
});
</script>
<table class="code" data-fileid="1">
<tr class="codeline" data-linenumber="1"><td class="num" id="LN1">1</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2"><td class="num" id="LN2">2</td><td class="line"> <span class='comment'>* Copyright (c) 2009-2012, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;</span></td></tr>
<tr class="codeline" data-linenumber="3"><td class="num" id="LN3">3</td><td class="line"> <span class='comment'>* All rights reserved.</span></td></tr>
<tr class="codeline" data-linenumber="4"><td class="num" id="LN4">4</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="5"><td class="num" id="LN5">5</td><td class="line"> <span class='comment'>* Redistribution and use in source and binary forms, with or without</span></td></tr>
<tr class="codeline" data-linenumber="6"><td class="num" id="LN6">6</td><td class="line"> <span class='comment'>* modification, are permitted provided that the following conditions are met:</span></td></tr>
<tr class="codeline" data-linenumber="7"><td class="num" id="LN7">7</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="8"><td class="num" id="LN8">8</td><td class="line"> <span class='comment'>*   * Redistributions of source code must retain the above copyright notice,</span></td></tr>
<tr class="codeline" data-linenumber="9"><td class="num" id="LN9">9</td><td class="line"> <span class='comment'>*     this list of conditions and the following disclaimer.</span></td></tr>
<tr class="codeline" data-linenumber="10"><td class="num" id="LN10">10</td><td class="line"> <span class='comment'>*   * Redistributions in binary form must reproduce the above copyright</span></td></tr>
<tr class="codeline" data-linenumber="11"><td class="num" id="LN11">11</td><td class="line"> <span class='comment'>*     notice, this list of conditions and the following disclaimer in the</span></td></tr>
<tr class="codeline" data-linenumber="12"><td class="num" id="LN12">12</td><td class="line"> <span class='comment'>*     documentation and/or other materials provided with the distribution.</span></td></tr>
<tr class="codeline" data-linenumber="13"><td class="num" id="LN13">13</td><td class="line"> <span class='comment'>*   * Neither the name of Redis nor the names of its contributors may be used</span></td></tr>
<tr class="codeline" data-linenumber="14"><td class="num" id="LN14">14</td><td class="line"> <span class='comment'>*     to endorse or promote products derived from this software without</span></td></tr>
<tr class="codeline" data-linenumber="15"><td class="num" id="LN15">15</td><td class="line"> <span class='comment'>*     specific prior written permission.</span></td></tr>
<tr class="codeline" data-linenumber="16"><td class="num" id="LN16">16</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="17"><td class="num" id="LN17">17</td><td class="line"> <span class='comment'>* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"</span></td></tr>
<tr class="codeline" data-linenumber="18"><td class="num" id="LN18">18</td><td class="line"> <span class='comment'>* AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span></td></tr>
<tr class="codeline" data-linenumber="19"><td class="num" id="LN19">19</td><td class="line"> <span class='comment'>* IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span></td></tr>
<tr class="codeline" data-linenumber="20"><td class="num" id="LN20">20</td><td class="line"> <span class='comment'>* ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span></td></tr>
<tr class="codeline" data-linenumber="21"><td class="num" id="LN21">21</td><td class="line"> <span class='comment'>* LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span></td></tr>
<tr class="codeline" data-linenumber="22"><td class="num" id="LN22">22</td><td class="line"> <span class='comment'>* CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span></td></tr>
<tr class="codeline" data-linenumber="23"><td class="num" id="LN23">23</td><td class="line"> <span class='comment'>* SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span></td></tr>
<tr class="codeline" data-linenumber="24"><td class="num" id="LN24">24</td><td class="line"> <span class='comment'>* INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span></td></tr>
<tr class="codeline" data-linenumber="25"><td class="num" id="LN25">25</td><td class="line"> <span class='comment'>* CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span></td></tr>
<tr class="codeline" data-linenumber="26"><td class="num" id="LN26">26</td><td class="line"> <span class='comment'>* ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span></td></tr>
<tr class="codeline" data-linenumber="27"><td class="num" id="LN27">27</td><td class="line"> <span class='comment'>* POSSIBILITY OF SUCH DAMAGE.</span></td></tr>
<tr class="codeline" data-linenumber="28"><td class="num" id="LN28">28</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="29"><td class="num" id="LN29">29</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="30"><td class="num" id="LN30">30</td><td class="line"><span class='directive'>#include "server.h"</span></td></tr>
<tr class="codeline" data-linenumber="31"><td class="num" id="LN31">31</td><td class="line"><span class='directive'>#include "sha1.h"</span></td></tr>
<tr class="codeline" data-linenumber="32"><td class="num" id="LN32">32</td><td class="line"><span class='directive'>#include "rand.h"</span></td></tr>
<tr class="codeline" data-linenumber="33"><td class="num" id="LN33">33</td><td class="line"><span class='directive'>#include "cluster.h"</span></td></tr>
<tr class="codeline" data-linenumber="34"><td class="num" id="LN34">34</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="35"><td class="num" id="LN35">35</td><td class="line"><span class='directive'>#include &lt;lua.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="36"><td class="num" id="LN36">36</td><td class="line"><span class='directive'>#include &lt;lauxlib.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="37"><td class="num" id="LN37">37</td><td class="line"><span class='directive'>#include &lt;lualib.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="38"><td class="num" id="LN38">38</td><td class="line"><span class='directive'>#include &lt;ctype.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="39"><td class="num" id="LN39">39</td><td class="line"><span class='directive'>#include &lt;math.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="40"><td class="num" id="LN40">40</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="41"><td class="num" id="LN41">41</td><td class="line"><span class='keyword'>char</span> *redisProtocolToLuaType_Int(lua_State *lua, <span class='keyword'>char</span> *reply);</td></tr>
<tr class="codeline" data-linenumber="42"><td class="num" id="LN42">42</td><td class="line"><span class='keyword'>char</span> *redisProtocolToLuaType_Bulk(lua_State *lua, <span class='keyword'>char</span> *reply);</td></tr>
<tr class="codeline" data-linenumber="43"><td class="num" id="LN43">43</td><td class="line"><span class='keyword'>char</span> *redisProtocolToLuaType_Status(lua_State *lua, <span class='keyword'>char</span> *reply);</td></tr>
<tr class="codeline" data-linenumber="44"><td class="num" id="LN44">44</td><td class="line"><span class='keyword'>char</span> *redisProtocolToLuaType_Error(lua_State *lua, <span class='keyword'>char</span> *reply);</td></tr>
<tr class="codeline" data-linenumber="45"><td class="num" id="LN45">45</td><td class="line"><span class='keyword'>char</span> *redisProtocolToLuaType_Aggregate(lua_State *lua, <span class='keyword'>char</span> *reply, <span class='keyword'>int</span> atype);</td></tr>
<tr class="codeline" data-linenumber="46"><td class="num" id="LN46">46</td><td class="line"><span class='keyword'>char</span> *redisProtocolToLuaType_Null(lua_State *lua, <span class='keyword'>char</span> *reply);</td></tr>
<tr class="codeline" data-linenumber="47"><td class="num" id="LN47">47</td><td class="line"><span class='keyword'>char</span> *redisProtocolToLuaType_Bool(lua_State *lua, <span class='keyword'>char</span> *reply, <span class='keyword'>int</span> tf);</td></tr>
<tr class="codeline" data-linenumber="48"><td class="num" id="LN48">48</td><td class="line"><span class='keyword'>char</span> *redisProtocolToLuaType_Double(lua_State *lua, <span class='keyword'>char</span> *reply);</td></tr>
<tr class="codeline" data-linenumber="49"><td class="num" id="LN49">49</td><td class="line"><span class='keyword'>int</span> redis_math_random (lua_State *L);</td></tr>
<tr class="codeline" data-linenumber="50"><td class="num" id="LN50">50</td><td class="line"><span class='keyword'>int</span> redis_math_randomseed (lua_State *L);</td></tr>
<tr class="codeline" data-linenumber="51"><td class="num" id="LN51">51</td><td class="line"><span class='keyword'>void</span> ldbInit(<span class='keyword'>void</span>);</td></tr>
<tr class="codeline" data-linenumber="52"><td class="num" id="LN52">52</td><td class="line"><span class='keyword'>void</span> ldbDisable(client *c);</td></tr>
<tr class="codeline" data-linenumber="53"><td class="num" id="LN53">53</td><td class="line"><span class='keyword'>void</span> ldbEnable(client *c);</td></tr>
<tr class="codeline" data-linenumber="54"><td class="num" id="LN54">54</td><td class="line"><span class='keyword'>void</span> evalGenericCommandWithDebugging(client *c, <span class='keyword'>int</span> evalsha);</td></tr>
<tr class="codeline" data-linenumber="55"><td class="num" id="LN55">55</td><td class="line"><span class='keyword'>void</span> luaLdbLineHook(lua_State *lua, lua_Debug *ar);</td></tr>
<tr class="codeline" data-linenumber="56"><td class="num" id="LN56">56</td><td class="line"><span class='keyword'>void</span> ldbLog(sds entry);</td></tr>
<tr class="codeline" data-linenumber="57"><td class="num" id="LN57">57</td><td class="line"><span class='keyword'>void</span> ldbLogRedisReply(<span class='keyword'>char</span> *reply);</td></tr>
<tr class="codeline" data-linenumber="58"><td class="num" id="LN58">58</td><td class="line">sds ldbCatStackValue(sds s, lua_State *lua, <span class='keyword'>int</span> idx);</td></tr>
<tr class="codeline" data-linenumber="59"><td class="num" id="LN59">59</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="60"><td class="num" id="LN60">60</td><td class="line"><span class='comment'>/* Debugger shared state is stored inside this global structure. */</span></td></tr>
<tr class="codeline" data-linenumber="61"><td class="num" id="LN61">61</td><td class="line"><span class='directive'>#define <span class='macro'>LDB_BREAKPOINTS_MAX<span class='macro_popup'>64</span></span> 64  /* Max number of breakpoints. */</span></td></tr>
<tr class="codeline" data-linenumber="62"><td class="num" id="LN62">62</td><td class="line"><span class='directive'>#define <span class='macro'>LDB_MAX_LEN_DEFAULT<span class='macro_popup'>256</span></span> 256 /* Default len limit for replies / var dumps. */</span></td></tr>
<tr class="codeline" data-linenumber="63"><td class="num" id="LN63">63</td><td class="line"><span class='keyword'>struct</span> ldbState {</td></tr>
<tr class="codeline" data-linenumber="64"><td class="num" id="LN64">64</td><td class="line">    connection *conn; <span class='comment'>/* Connection of the debugging client. */</span></td></tr>
<tr class="codeline" data-linenumber="65"><td class="num" id="LN65">65</td><td class="line">    <span class='keyword'>int</span> active; <span class='comment'>/* Are we debugging EVAL right now? */</span></td></tr>
<tr class="codeline" data-linenumber="66"><td class="num" id="LN66">66</td><td class="line">    <span class='keyword'>int</span> forked; <span class='comment'>/* Is this a fork()ed debugging session? */</span></td></tr>
<tr class="codeline" data-linenumber="67"><td class="num" id="LN67">67</td><td class="line">    list *logs; <span class='comment'>/* List of messages to send to the client. */</span></td></tr>
<tr class="codeline" data-linenumber="68"><td class="num" id="LN68">68</td><td class="line">    list *traces; <span class='comment'>/* Messages about Redis commands executed since last stop.*/</span></td></tr>
<tr class="codeline" data-linenumber="69"><td class="num" id="LN69">69</td><td class="line">    list *children; <span class='comment'>/* All forked debugging sessions pids. */</span></td></tr>
<tr class="codeline" data-linenumber="70"><td class="num" id="LN70">70</td><td class="line">    <span class='keyword'>int</span> bp[<span class='macro'>LDB_BREAKPOINTS_MAX<span class='macro_popup'>64</span></span>]; <span class='comment'>/* An array of breakpoints line numbers. */</span></td></tr>
<tr class="codeline" data-linenumber="71"><td class="num" id="LN71">71</td><td class="line">    <span class='keyword'>int</span> bpcount; <span class='comment'>/* Number of valid entries inside bp. */</span></td></tr>
<tr class="codeline" data-linenumber="72"><td class="num" id="LN72">72</td><td class="line">    <span class='keyword'>int</span> step;   <span class='comment'>/* Stop at next line regardless of breakpoints. */</span></td></tr>
<tr class="codeline" data-linenumber="73"><td class="num" id="LN73">73</td><td class="line">    <span class='keyword'>int</span> luabp;  <span class='comment'>/* Stop at next line because redis.breakpoint() was called. */</span></td></tr>
<tr class="codeline" data-linenumber="74"><td class="num" id="LN74">74</td><td class="line">    sds *src;   <span class='comment'>/* Lua script source code split by line. */</span></td></tr>
<tr class="codeline" data-linenumber="75"><td class="num" id="LN75">75</td><td class="line">    <span class='keyword'>int</span> lines;  <span class='comment'>/* Number of lines in 'src'. */</span></td></tr>
<tr class="codeline" data-linenumber="76"><td class="num" id="LN76">76</td><td class="line">    <span class='keyword'>int</span> currentline;    <span class='comment'>/* Current line number. */</span></td></tr>
<tr class="codeline" data-linenumber="77"><td class="num" id="LN77">77</td><td class="line">    sds cbuf;   <span class='comment'>/* Debugger client command buffer. */</span></td></tr>
<tr class="codeline" data-linenumber="78"><td class="num" id="LN78">78</td><td class="line">    size_t maxlen;  <span class='comment'>/* Max var dump / reply length. */</span></td></tr>
<tr class="codeline" data-linenumber="79"><td class="num" id="LN79">79</td><td class="line">    <span class='keyword'>int</span> maxlen_hint_sent; <span class='comment'>/* Did we already hint about "set maxlen"? */</span></td></tr>
<tr class="codeline" data-linenumber="80"><td class="num" id="LN80">80</td><td class="line">} ldb;</td></tr>
<tr class="codeline" data-linenumber="81"><td class="num" id="LN81">81</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="82"><td class="num" id="LN82">82</td><td class="line"><span class='comment'>/* ---------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="83"><td class="num" id="LN83">83</td><td class="line"> <span class='comment'>* Utility functions.</span></td></tr>
<tr class="codeline" data-linenumber="84"><td class="num" id="LN84">84</td><td class="line"> <span class='comment'>* ------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="85"><td class="num" id="LN85">85</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="86"><td class="num" id="LN86">86</td><td class="line"><span class='comment'>/* Perform the SHA1 of the input string. We use this both for hashing script</span></td></tr>
<tr class="codeline" data-linenumber="87"><td class="num" id="LN87">87</td><td class="line"> <span class='comment'>* bodies in order to obtain the Lua function name, and in the implementation</span></td></tr>
<tr class="codeline" data-linenumber="88"><td class="num" id="LN88">88</td><td class="line"> <span class='comment'>* of redis.sha1().</span></td></tr>
<tr class="codeline" data-linenumber="89"><td class="num" id="LN89">89</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="90"><td class="num" id="LN90">90</td><td class="line"> <span class='comment'>* 'digest' should point to a 41 bytes buffer: 40 for SHA1 converted into an</span></td></tr>
<tr class="codeline" data-linenumber="91"><td class="num" id="LN91">91</td><td class="line"> <span class='comment'>* hexadecimal number, plus 1 byte for null term. */</span></td></tr>
<tr class="codeline" data-linenumber="92"><td class="num" id="LN92">92</td><td class="line"><span class='keyword'>void</span> sha1hex(<span class='keyword'>char</span> *digest, <span class='keyword'>char</span> *script, size_t len) {</td></tr>
<tr class="codeline" data-linenumber="93"><td class="num" id="LN93">93</td><td class="line">    SHA1_CTX ctx;</td></tr>
<tr class="codeline" data-linenumber="94"><td class="num" id="LN94">94</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> hash[20];</td></tr>
<tr class="codeline" data-linenumber="95"><td class="num" id="LN95">95</td><td class="line">    <span class='keyword'>char</span> *cset = <span class='string_literal'>"0123456789abcdef"</span>;</td></tr>
<tr class="codeline" data-linenumber="96"><td class="num" id="LN96">96</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="97"><td class="num" id="LN97">97</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="98"><td class="num" id="LN98">98</td><td class="line">    SHA1Init(&amp;ctx);</td></tr>
<tr class="codeline" data-linenumber="99"><td class="num" id="LN99">99</td><td class="line">    SHA1Update(&amp;ctx,(<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)script,len);</td></tr>
<tr class="codeline" data-linenumber="100"><td class="num" id="LN100">100</td><td class="line">    SHA1Final(hash,&amp;ctx);</td></tr>
<tr class="codeline" data-linenumber="101"><td class="num" id="LN101">101</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="102"><td class="num" id="LN102">102</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; 20; j++) {</td></tr>
<tr class="codeline" data-linenumber="103"><td class="num" id="LN103">103</td><td class="line">        digest[j*2] = cset[((hash[j]&amp;0xF0)&gt;&gt;4)];</td></tr>
<tr class="codeline" data-linenumber="104"><td class="num" id="LN104">104</td><td class="line">        digest[j*2+1] = cset[(hash[j]&amp;0xF)];</td></tr>
<tr class="codeline" data-linenumber="105"><td class="num" id="LN105">105</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="106"><td class="num" id="LN106">106</td><td class="line">    digest[40] = '\0';</td></tr>
<tr class="codeline" data-linenumber="107"><td class="num" id="LN107">107</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="108"><td class="num" id="LN108">108</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="109"><td class="num" id="LN109">109</td><td class="line"><span class='comment'>/* ---------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="110"><td class="num" id="LN110">110</td><td class="line"> <span class='comment'>* Redis reply to Lua type conversion functions.</span></td></tr>
<tr class="codeline" data-linenumber="111"><td class="num" id="LN111">111</td><td class="line"> <span class='comment'>* ------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="112"><td class="num" id="LN112">112</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="113"><td class="num" id="LN113">113</td><td class="line"><span class='comment'>/* Take a Redis reply in the Redis protocol format and convert it into a</span></td></tr>
<tr class="codeline" data-linenumber="114"><td class="num" id="LN114">114</td><td class="line"> <span class='comment'>* Lua type. Thanks to this function, and the introduction of not connected</span></td></tr>
<tr class="codeline" data-linenumber="115"><td class="num" id="LN115">115</td><td class="line"> <span class='comment'>* clients, it is trivial to implement the redis() lua function.</span></td></tr>
<tr class="codeline" data-linenumber="116"><td class="num" id="LN116">116</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="117"><td class="num" id="LN117">117</td><td class="line"> <span class='comment'>* Basically we take the arguments, execute the Redis command in the context</span></td></tr>
<tr class="codeline" data-linenumber="118"><td class="num" id="LN118">118</td><td class="line"> <span class='comment'>* of a non connected client, then take the generated reply and convert it</span></td></tr>
<tr class="codeline" data-linenumber="119"><td class="num" id="LN119">119</td><td class="line"> <span class='comment'>* into a suitable Lua type. With this trick the scripting feature does not</span></td></tr>
<tr class="codeline" data-linenumber="120"><td class="num" id="LN120">120</td><td class="line"> <span class='comment'>* need the introduction of a full Redis internals API. The script</span></td></tr>
<tr class="codeline" data-linenumber="121"><td class="num" id="LN121">121</td><td class="line"> <span class='comment'>* is like a normal client that bypasses all the slow I/O paths.</span></td></tr>
<tr class="codeline" data-linenumber="122"><td class="num" id="LN122">122</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="123"><td class="num" id="LN123">123</td><td class="line"> <span class='comment'>* Note: in this function we do not do any sanity check as the reply is</span></td></tr>
<tr class="codeline" data-linenumber="124"><td class="num" id="LN124">124</td><td class="line"> <span class='comment'>* generated by Redis directly. This allows us to go faster.</span></td></tr>
<tr class="codeline" data-linenumber="125"><td class="num" id="LN125">125</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="126"><td class="num" id="LN126">126</td><td class="line"> <span class='comment'>* Errors are returned as a table with a single 'err' field set to the</span></td></tr>
<tr class="codeline" data-linenumber="127"><td class="num" id="LN127">127</td><td class="line"> <span class='comment'>* error string.</span></td></tr>
<tr class="codeline" data-linenumber="128"><td class="num" id="LN128">128</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="129"><td class="num" id="LN129">129</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="130"><td class="num" id="LN130">130</td><td class="line"><span class='keyword'>char</span> *redisProtocolToLuaType(lua_State *lua, <span class='keyword'>char</span>* reply) {</td></tr>
<tr class="codeline" data-linenumber="131"><td class="num" id="LN131">131</td><td class="line">    <span class='keyword'>char</span> *p = reply;</td></tr>
<tr class="codeline" data-linenumber="132"><td class="num" id="LN132">132</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="133"><td class="num" id="LN133">133</td><td class="line">    <span class='keyword'>switch</span>(*p) {</td></tr>
<tr class="codeline" data-linenumber="134"><td class="num" id="LN134">134</td><td class="line">    <span class='keyword'>case</span> ':': p = redisProtocolToLuaType_Int(lua,reply); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="135"><td class="num" id="LN135">135</td><td class="line">    <span class='keyword'>case</span> '$': p = redisProtocolToLuaType_Bulk(lua,reply); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="136"><td class="num" id="LN136">136</td><td class="line">    <span class='keyword'>case</span> '+': p = redisProtocolToLuaType_Status(lua,reply); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="137"><td class="num" id="LN137">137</td><td class="line">    <span class='keyword'>case</span> '-': p = redisProtocolToLuaType_Error(lua,reply); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="138"><td class="num" id="LN138">138</td><td class="line">    <span class='keyword'>case</span> '*': p = redisProtocolToLuaType_Aggregate(lua,reply,*p); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="139"><td class="num" id="LN139">139</td><td class="line">    <span class='keyword'>case</span> '%': p = redisProtocolToLuaType_Aggregate(lua,reply,*p); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="140"><td class="num" id="LN140">140</td><td class="line">    <span class='keyword'>case</span> '~': p = redisProtocolToLuaType_Aggregate(lua,reply,*p); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="141"><td class="num" id="LN141">141</td><td class="line">    <span class='keyword'>case</span> '_': p = redisProtocolToLuaType_Null(lua,reply); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="142"><td class="num" id="LN142">142</td><td class="line">    <span class='keyword'>case</span> '#': p = redisProtocolToLuaType_Bool(lua,reply,p[1]); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="143"><td class="num" id="LN143">143</td><td class="line">    <span class='keyword'>case</span> ',': p = redisProtocolToLuaType_Double(lua,reply); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="144"><td class="num" id="LN144">144</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="145"><td class="num" id="LN145">145</td><td class="line">    <span class='keyword'>return</span> p;</td></tr>
<tr class="codeline" data-linenumber="146"><td class="num" id="LN146">146</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="147"><td class="num" id="LN147">147</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="148"><td class="num" id="LN148">148</td><td class="line"><span class='keyword'>char</span> *redisProtocolToLuaType_Int(lua_State *lua, <span class='keyword'>char</span> *reply) {</td></tr>
<tr class="codeline" data-linenumber="149"><td class="num" id="LN149">149</td><td class="line">    <span class='keyword'>char</span> *p = strchr(reply+1,'\r');</td></tr>
<tr class="codeline" data-linenumber="150"><td class="num" id="LN150">150</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> value;</td></tr>
<tr class="codeline" data-linenumber="151"><td class="num" id="LN151">151</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="152"><td class="num" id="LN152">152</td><td class="line">    string2ll(reply+1,p-reply-1,&amp;value);</td></tr>
<tr class="codeline" data-linenumber="153"><td class="num" id="LN153">153</td><td class="line">    lua_pushnumber(lua,(lua_Number)value);</td></tr>
<tr class="codeline" data-linenumber="154"><td class="num" id="LN154">154</td><td class="line">    <span class='keyword'>return</span> p+2;</td></tr>
<tr class="codeline" data-linenumber="155"><td class="num" id="LN155">155</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="156"><td class="num" id="LN156">156</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="157"><td class="num" id="LN157">157</td><td class="line"><span class='keyword'>char</span> *redisProtocolToLuaType_Bulk(lua_State *lua, <span class='keyword'>char</span> *reply) {</td></tr>
<tr class="codeline" data-linenumber="158"><td class="num" id="LN158">158</td><td class="line">    <span class='keyword'>char</span> *p = strchr(reply+1,'\r');</td></tr>
<tr class="codeline" data-linenumber="159"><td class="num" id="LN159">159</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> bulklen;</td></tr>
<tr class="codeline" data-linenumber="160"><td class="num" id="LN160">160</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="161"><td class="num" id="LN161">161</td><td class="line">    string2ll(reply+1,p-reply-1,&amp;bulklen);</td></tr>
<tr class="codeline" data-linenumber="162"><td class="num" id="LN162">162</td><td class="line">    <span class='keyword'>if</span> (bulklen == -1) {</td></tr>
<tr class="codeline" data-linenumber="163"><td class="num" id="LN163">163</td><td class="line">        lua_pushboolean(lua,0);</td></tr>
<tr class="codeline" data-linenumber="164"><td class="num" id="LN164">164</td><td class="line">        <span class='keyword'>return</span> p+2;</td></tr>
<tr class="codeline" data-linenumber="165"><td class="num" id="LN165">165</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="166"><td class="num" id="LN166">166</td><td class="line">        lua_pushlstring(lua,p+2,bulklen);</td></tr>
<tr class="codeline" data-linenumber="167"><td class="num" id="LN167">167</td><td class="line">        <span class='keyword'>return</span> p+2+bulklen+2;</td></tr>
<tr class="codeline" data-linenumber="168"><td class="num" id="LN168">168</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="169"><td class="num" id="LN169">169</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="170"><td class="num" id="LN170">170</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="171"><td class="num" id="LN171">171</td><td class="line"><span class='keyword'>char</span> *redisProtocolToLuaType_Status(lua_State *lua, <span class='keyword'>char</span> *reply) {</td></tr>
<tr class="codeline" data-linenumber="172"><td class="num" id="LN172">172</td><td class="line">    <span class='keyword'>char</span> *p = strchr(reply+1,'\r');</td></tr>
<tr class="codeline" data-linenumber="173"><td class="num" id="LN173">173</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="174"><td class="num" id="LN174">174</td><td class="line">    <span class='macro'>lua_newtable(lua)<span class='macro_popup'>lua_createtable(lua, 0, 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="175"><td class="num" id="LN175">175</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"ok"</span>);</td></tr>
<tr class="codeline" data-linenumber="176"><td class="num" id="LN176">176</td><td class="line">    lua_pushlstring(lua,reply+1,p-reply-1);</td></tr>
<tr class="codeline" data-linenumber="177"><td class="num" id="LN177">177</td><td class="line">    lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="178"><td class="num" id="LN178">178</td><td class="line">    <span class='keyword'>return</span> p+2;</td></tr>
<tr class="codeline" data-linenumber="179"><td class="num" id="LN179">179</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="180"><td class="num" id="LN180">180</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="181"><td class="num" id="LN181">181</td><td class="line"><span class='keyword'>char</span> *redisProtocolToLuaType_Error(lua_State *lua, <span class='keyword'>char</span> *reply) {</td></tr>
<tr class="codeline" data-linenumber="182"><td class="num" id="LN182">182</td><td class="line">    <span class='keyword'>char</span> *p = strchr(reply+1,'\r');</td></tr>
<tr class="codeline" data-linenumber="183"><td class="num" id="LN183">183</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="184"><td class="num" id="LN184">184</td><td class="line">    <span class='macro'>lua_newtable(lua)<span class='macro_popup'>lua_createtable(lua, 0, 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="185"><td class="num" id="LN185">185</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"err"</span>);</td></tr>
<tr class="codeline" data-linenumber="186"><td class="num" id="LN186">186</td><td class="line">    lua_pushlstring(lua,reply+1,p-reply-1);</td></tr>
<tr class="codeline" data-linenumber="187"><td class="num" id="LN187">187</td><td class="line">    lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="188"><td class="num" id="LN188">188</td><td class="line">    <span class='keyword'>return</span> p+2;</td></tr>
<tr class="codeline" data-linenumber="189"><td class="num" id="LN189">189</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="190"><td class="num" id="LN190">190</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="191"><td class="num" id="LN191">191</td><td class="line"><span class='keyword'>char</span> *redisProtocolToLuaType_Aggregate(lua_State *lua, <span class='keyword'>char</span> *reply, <span class='keyword'>int</span> atype) {</td></tr>
<tr class="codeline" data-linenumber="192"><td class="num" id="LN192">192</td><td class="line">    <span class='keyword'>char</span> *p = strchr(reply+1,'\r');</td></tr>
<tr class="codeline" data-linenumber="193"><td class="num" id="LN193">193</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> mbulklen;</td></tr>
<tr class="codeline" data-linenumber="194"><td class="num" id="LN194">194</td><td class="line">    <span class='keyword'>int</span> j = 0;</td></tr>
<tr class="codeline" data-linenumber="195"><td class="num" id="LN195">195</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="196"><td class="num" id="LN196">196</td><td class="line">    string2ll(reply+1,p-reply-1,&amp;mbulklen);</td></tr>
<tr class="codeline" data-linenumber="197"><td class="num" id="LN197">197</td><td class="line">    <span class='keyword'>if</span> (server.lua_client-&gt;resp == 2 || atype == '*') {</td></tr>
<tr class="codeline" data-linenumber="198"><td class="num" id="LN198">198</td><td class="line">        p += 2;</td></tr>
<tr class="codeline" data-linenumber="199"><td class="num" id="LN199">199</td><td class="line">        <span class='keyword'>if</span> (mbulklen == -1) {</td></tr>
<tr class="codeline" data-linenumber="200"><td class="num" id="LN200">200</td><td class="line">            lua_pushboolean(lua,0);</td></tr>
<tr class="codeline" data-linenumber="201"><td class="num" id="LN201">201</td><td class="line">            <span class='keyword'>return</span> p;</td></tr>
<tr class="codeline" data-linenumber="202"><td class="num" id="LN202">202</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="203"><td class="num" id="LN203">203</td><td class="line">        <span class='macro'>lua_newtable(lua)<span class='macro_popup'>lua_createtable(lua, 0, 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="204"><td class="num" id="LN204">204</td><td class="line">        <span class='keyword'>for</span> (j = 0; j &lt; mbulklen; j++) {</td></tr>
<tr class="codeline" data-linenumber="205"><td class="num" id="LN205">205</td><td class="line">            lua_pushnumber(lua,j+1);</td></tr>
<tr class="codeline" data-linenumber="206"><td class="num" id="LN206">206</td><td class="line">            p = redisProtocolToLuaType(lua,p);</td></tr>
<tr class="codeline" data-linenumber="207"><td class="num" id="LN207">207</td><td class="line">            lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="208"><td class="num" id="LN208">208</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="209"><td class="num" id="LN209">209</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (server.lua_client-&gt;resp == 3) {</td></tr>
<tr class="codeline" data-linenumber="210"><td class="num" id="LN210">210</td><td class="line">        <span class='comment'>/* Here we handle only Set and Map replies in RESP3 mode, since arrays</span></td></tr>
<tr class="codeline" data-linenumber="211"><td class="num" id="LN211">211</td><td class="line">         <span class='comment'>* follow the above RESP2 code path. Note that those are represented</span></td></tr>
<tr class="codeline" data-linenumber="212"><td class="num" id="LN212">212</td><td class="line">         <span class='comment'>* as a table with the "map" or "set" field populated with the actual</span></td></tr>
<tr class="codeline" data-linenumber="213"><td class="num" id="LN213">213</td><td class="line">         <span class='comment'>* table representing the set or the map type. */</span></td></tr>
<tr class="codeline" data-linenumber="214"><td class="num" id="LN214">214</td><td class="line">        p += 2;</td></tr>
<tr class="codeline" data-linenumber="215"><td class="num" id="LN215">215</td><td class="line">        <span class='macro'>lua_newtable(lua)<span class='macro_popup'>lua_createtable(lua, 0, 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="216"><td class="num" id="LN216">216</td><td class="line">        lua_pushstring(lua,atype == '%' ? <span class='string_literal'>"map"</span> : <span class='string_literal'>"set"</span>);</td></tr>
<tr class="codeline" data-linenumber="217"><td class="num" id="LN217">217</td><td class="line">        <span class='macro'>lua_newtable(lua)<span class='macro_popup'>lua_createtable(lua, 0, 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="218"><td class="num" id="LN218">218</td><td class="line">        <span class='keyword'>for</span> (j = 0; j &lt; mbulklen; j++) {</td></tr>
<tr class="codeline" data-linenumber="219"><td class="num" id="LN219">219</td><td class="line">            p = redisProtocolToLuaType(lua,p);</td></tr>
<tr class="codeline" data-linenumber="220"><td class="num" id="LN220">220</td><td class="line">            <span class='keyword'>if</span> (atype == '%') {</td></tr>
<tr class="codeline" data-linenumber="221"><td class="num" id="LN221">221</td><td class="line">                p = redisProtocolToLuaType(lua,p);</td></tr>
<tr class="codeline" data-linenumber="222"><td class="num" id="LN222">222</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="223"><td class="num" id="LN223">223</td><td class="line">                lua_pushboolean(lua,1);</td></tr>
<tr class="codeline" data-linenumber="224"><td class="num" id="LN224">224</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="225"><td class="num" id="LN225">225</td><td class="line">            lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="226"><td class="num" id="LN226">226</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="227"><td class="num" id="LN227">227</td><td class="line">        lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="228"><td class="num" id="LN228">228</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="229"><td class="num" id="LN229">229</td><td class="line">    <span class='keyword'>return</span> p;</td></tr>
<tr class="codeline" data-linenumber="230"><td class="num" id="LN230">230</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="231"><td class="num" id="LN231">231</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="232"><td class="num" id="LN232">232</td><td class="line"><span class='keyword'>char</span> *redisProtocolToLuaType_Null(lua_State *lua, <span class='keyword'>char</span> *reply) {</td></tr>
<tr class="codeline" data-linenumber="233"><td class="num" id="LN233">233</td><td class="line">    <span class='keyword'>char</span> *p = strchr(reply+1,'\r');</td></tr>
<tr class="codeline" data-linenumber="234"><td class="num" id="LN234">234</td><td class="line">    lua_pushnil(lua);</td></tr>
<tr class="codeline" data-linenumber="235"><td class="num" id="LN235">235</td><td class="line">    <span class='keyword'>return</span> p+2;</td></tr>
<tr class="codeline" data-linenumber="236"><td class="num" id="LN236">236</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="237"><td class="num" id="LN237">237</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="238"><td class="num" id="LN238">238</td><td class="line"><span class='keyword'>char</span> *redisProtocolToLuaType_Bool(lua_State *lua, <span class='keyword'>char</span> *reply, <span class='keyword'>int</span> tf) {</td></tr>
<tr class="codeline" data-linenumber="239"><td class="num" id="LN239">239</td><td class="line">    <span class='keyword'>char</span> *p = strchr(reply+1,'\r');</td></tr>
<tr class="codeline" data-linenumber="240"><td class="num" id="LN240">240</td><td class="line">    lua_pushboolean(lua,tf == 't');</td></tr>
<tr class="codeline" data-linenumber="241"><td class="num" id="LN241">241</td><td class="line">    <span class='keyword'>return</span> p+2;</td></tr>
<tr class="codeline" data-linenumber="242"><td class="num" id="LN242">242</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="243"><td class="num" id="LN243">243</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="244"><td class="num" id="LN244">244</td><td class="line"><span class='keyword'>char</span> *redisProtocolToLuaType_Double(lua_State *lua, <span class='keyword'>char</span> *reply) {</td></tr>
<tr class="codeline" data-linenumber="245"><td class="num" id="LN245">245</td><td class="line">    <span class='keyword'>char</span> *p = strchr(reply+1,'\r');</td></tr>
<tr class="codeline" data-linenumber="246"><td class="num" id="LN246">246</td><td class="line">    <span class='keyword'>char</span> buf[<span class='macro'>MAX_LONG_DOUBLE_CHARS<span class='macro_popup'>5*1024</span></span>+1];</td></tr>
<tr class="codeline" data-linenumber="247"><td class="num" id="LN247">247</td><td class="line">    size_t len = p-reply-1;</td></tr>
<tr class="codeline" data-linenumber="248"><td class="num" id="LN248">248</td><td class="line">    <span class='keyword'>double</span> d;</td></tr>
<tr class="codeline" data-linenumber="249"><td class="num" id="LN249">249</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="250"><td class="num" id="LN250">250</td><td class="line">    <span class='keyword'>if</span> (len &lt;= <span class='macro'>MAX_LONG_DOUBLE_CHARS<span class='macro_popup'>5*1024</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="251"><td class="num" id="LN251">251</td><td class="line">        memcpy(buf,reply+1,len);</td></tr>
<tr class="codeline" data-linenumber="252"><td class="num" id="LN252">252</td><td class="line">        buf[len] = '\0';</td></tr>
<tr class="codeline" data-linenumber="253"><td class="num" id="LN253">253</td><td class="line">        d = strtod(buf,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>); <span class='comment'>/* We expect a valid representation. */</span></td></tr>
<tr class="codeline" data-linenumber="254"><td class="num" id="LN254">254</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="255"><td class="num" id="LN255">255</td><td class="line">        d = 0;</td></tr>
<tr class="codeline" data-linenumber="256"><td class="num" id="LN256">256</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="257"><td class="num" id="LN257">257</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="258"><td class="num" id="LN258">258</td><td class="line">    <span class='macro'>lua_newtable(lua)<span class='macro_popup'>lua_createtable(lua, 0, 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="259"><td class="num" id="LN259">259</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"double"</span>);</td></tr>
<tr class="codeline" data-linenumber="260"><td class="num" id="LN260">260</td><td class="line">    lua_pushnumber(lua,d);</td></tr>
<tr class="codeline" data-linenumber="261"><td class="num" id="LN261">261</td><td class="line">    lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="262"><td class="num" id="LN262">262</td><td class="line">    <span class='keyword'>return</span> p+2;</td></tr>
<tr class="codeline" data-linenumber="263"><td class="num" id="LN263">263</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="264"><td class="num" id="LN264">264</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="265"><td class="num" id="LN265">265</td><td class="line"><span class='comment'>/* This function is used in order to push an error on the Lua stack in the</span></td></tr>
<tr class="codeline" data-linenumber="266"><td class="num" id="LN266">266</td><td class="line"> <span class='comment'>* format used by redis.pcall to return errors, which is a lua table</span></td></tr>
<tr class="codeline" data-linenumber="267"><td class="num" id="LN267">267</td><td class="line"> <span class='comment'>* with a single "err" field set to the error string. Note that this</span></td></tr>
<tr class="codeline" data-linenumber="268"><td class="num" id="LN268">268</td><td class="line"> <span class='comment'>* table is never a valid reply by proper commands, since the returned</span></td></tr>
<tr class="codeline" data-linenumber="269"><td class="num" id="LN269">269</td><td class="line"> <span class='comment'>* tables are otherwise always indexed by integers, never by strings. */</span></td></tr>
<tr class="codeline" data-linenumber="270"><td class="num" id="LN270">270</td><td class="line"><span class='keyword'>void</span> luaPushError(lua_State *lua, <span class='keyword'>char</span> *error) {</td></tr>
<tr class="codeline" data-linenumber="271"><td class="num" id="LN271">271</td><td class="line">    lua_Debug dbg;</td></tr>
<tr class="codeline" data-linenumber="272"><td class="num" id="LN272">272</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="273"><td class="num" id="LN273">273</td><td class="line">    <span class='comment'>/* If debugging is active and in step mode, log errors resulting from</span></td></tr>
<tr class="codeline" data-linenumber="274"><td class="num" id="LN274">274</td><td class="line">     <span class='comment'>* Redis commands. */</span></td></tr>
<tr class="codeline" data-linenumber="275"><td class="num" id="LN275">275</td><td class="line">    <span class='keyword'>if</span> (ldb.active &amp;&amp; ldb.step) {</td></tr>
<tr class="codeline" data-linenumber="276"><td class="num" id="LN276">276</td><td class="line">        ldbLog(sdscatprintf(sdsempty(),<span class='string_literal'>"&lt;error&gt; %s"</span>,error));</td></tr>
<tr class="codeline" data-linenumber="277"><td class="num" id="LN277">277</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="278"><td class="num" id="LN278">278</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="279"><td class="num" id="LN279">279</td><td class="line">    <span class='macro'>lua_newtable(lua)<span class='macro_popup'>lua_createtable(lua, 0, 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="280"><td class="num" id="LN280">280</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"err"</span>);</td></tr>
<tr class="codeline" data-linenumber="281"><td class="num" id="LN281">281</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="282"><td class="num" id="LN282">282</td><td class="line">    <span class='comment'>/* Attempt to figure out where this function was called, if possible */</span></td></tr>
<tr class="codeline" data-linenumber="283"><td class="num" id="LN283">283</td><td class="line">    <span class='keyword'>if</span>(lua_getstack(lua, 1, &amp;dbg) &amp;&amp; lua_getinfo(lua, <span class='string_literal'>"nSl"</span>, &amp;dbg)) {</td></tr>
<tr class="codeline" data-linenumber="284"><td class="num" id="LN284">284</td><td class="line">        sds msg = sdscatprintf(sdsempty(), <span class='string_literal'>"%s: %d: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="285"><td class="num" id="LN285">285</td><td class="line">            dbg.source, dbg.currentline, error);</td></tr>
<tr class="codeline" data-linenumber="286"><td class="num" id="LN286">286</td><td class="line">        lua_pushstring(lua, msg);</td></tr>
<tr class="codeline" data-linenumber="287"><td class="num" id="LN287">287</td><td class="line">        sdsfree(msg);</td></tr>
<tr class="codeline" data-linenumber="288"><td class="num" id="LN288">288</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="289"><td class="num" id="LN289">289</td><td class="line">        lua_pushstring(lua, error);</td></tr>
<tr class="codeline" data-linenumber="290"><td class="num" id="LN290">290</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="291"><td class="num" id="LN291">291</td><td class="line">    lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="292"><td class="num" id="LN292">292</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="293"><td class="num" id="LN293">293</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="294"><td class="num" id="LN294">294</td><td class="line"><span class='comment'>/* In case the error set into the Lua stack by luaPushError() was generated</span></td></tr>
<tr class="codeline" data-linenumber="295"><td class="num" id="LN295">295</td><td class="line"> <span class='comment'>* by the non-error-trapping version of redis.pcall(), which is redis.call(),</span></td></tr>
<tr class="codeline" data-linenumber="296"><td class="num" id="LN296">296</td><td class="line"> <span class='comment'>* this function will raise the Lua error so that the execution of the</span></td></tr>
<tr class="codeline" data-linenumber="297"><td class="num" id="LN297">297</td><td class="line"> <span class='comment'>* script will be halted. */</span></td></tr>
<tr class="codeline" data-linenumber="298"><td class="num" id="LN298">298</td><td class="line"><span class='keyword'>int</span> luaRaiseError(lua_State *lua) {</td></tr>
<tr class="codeline" data-linenumber="299"><td class="num" id="LN299">299</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"err"</span>);</td></tr>
<tr class="codeline" data-linenumber="300"><td class="num" id="LN300">300</td><td class="line">    lua_gettable(lua,-2);</td></tr>
<tr class="codeline" data-linenumber="301"><td class="num" id="LN301">301</td><td class="line">    <span class='keyword'>return</span> lua_error(lua);</td></tr>
<tr class="codeline" data-linenumber="302"><td class="num" id="LN302">302</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="303"><td class="num" id="LN303">303</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="304"><td class="num" id="LN304">304</td><td class="line"><span class='comment'>/* Sort the array currently in the stack. We do this to make the output</span></td></tr>
<tr class="codeline" data-linenumber="305"><td class="num" id="LN305">305</td><td class="line"> <span class='comment'>* of commands like KEYS or SMEMBERS something deterministic when called</span></td></tr>
<tr class="codeline" data-linenumber="306"><td class="num" id="LN306">306</td><td class="line"> <span class='comment'>* from Lua (to play well with AOf/replication).</span></td></tr>
<tr class="codeline" data-linenumber="307"><td class="num" id="LN307">307</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="308"><td class="num" id="LN308">308</td><td class="line"> <span class='comment'>* The array is sorted using table.sort itself, and assuming all the</span></td></tr>
<tr class="codeline" data-linenumber="309"><td class="num" id="LN309">309</td><td class="line"> <span class='comment'>* list elements are strings. */</span></td></tr>
<tr class="codeline" data-linenumber="310"><td class="num" id="LN310">310</td><td class="line"><span class='keyword'>void</span> luaSortArray(lua_State *lua) {</td></tr>
<tr class="codeline" data-linenumber="311"><td class="num" id="LN311">311</td><td class="line">    <span class='comment'>/* Initial Stack: array */</span></td></tr>
<tr class="codeline" data-linenumber="312"><td class="num" id="LN312">312</td><td class="line">    <span class='macro'>lua_getglobal(lua,<span class='string_literal'>"table"</span>)<span class='macro_popup'>lua_getfield(lua, (-10002), ("table"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="313"><td class="num" id="LN313">313</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"sort"</span>);</td></tr>
<tr class="codeline" data-linenumber="314"><td class="num" id="LN314">314</td><td class="line">    lua_gettable(lua,-2);       <span class='comment'>/* Stack: array, table, table.sort */</span></td></tr>
<tr class="codeline" data-linenumber="315"><td class="num" id="LN315">315</td><td class="line">    lua_pushvalue(lua,-3);      <span class='comment'>/* Stack: array, table, table.sort, array */</span></td></tr>
<tr class="codeline" data-linenumber="316"><td class="num" id="LN316">316</td><td class="line">    <span class='keyword'>if</span> (lua_pcall(lua,1,0,0)) {</td></tr>
<tr class="codeline" data-linenumber="317"><td class="num" id="LN317">317</td><td class="line">        <span class='comment'>/* Stack: array, table, error */</span></td></tr>
<tr class="codeline" data-linenumber="318"><td class="num" id="LN318">318</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="319"><td class="num" id="LN319">319</td><td class="line">        <span class='comment'>/* We are not interested in the error, we assume that the problem is</span></td></tr>
<tr class="codeline" data-linenumber="320"><td class="num" id="LN320">320</td><td class="line">         <span class='comment'>* that there are 'false' elements inside the array, so we try</span></td></tr>
<tr class="codeline" data-linenumber="321"><td class="num" id="LN321">321</td><td class="line">         <span class='comment'>* again with a slower function but able to handle this case, that</span></td></tr>
<tr class="codeline" data-linenumber="322"><td class="num" id="LN322">322</td><td class="line">         <span class='comment'>* is: table.sort(table, __redis__compare_helper) */</span></td></tr>
<tr class="codeline" data-linenumber="323"><td class="num" id="LN323">323</td><td class="line">        <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>;             <span class='comment'>/* Stack: array, table */</span></td></tr>
<tr class="codeline" data-linenumber="324"><td class="num" id="LN324">324</td><td class="line">        lua_pushstring(lua,<span class='string_literal'>"sort"</span>); <span class='comment'>/* Stack: array, table, sort */</span></td></tr>
<tr class="codeline" data-linenumber="325"><td class="num" id="LN325">325</td><td class="line">        lua_gettable(lua,-2);       <span class='comment'>/* Stack: array, table, table.sort */</span></td></tr>
<tr class="codeline" data-linenumber="326"><td class="num" id="LN326">326</td><td class="line">        lua_pushvalue(lua,-3);      <span class='comment'>/* Stack: array, table, table.sort, array */</span></td></tr>
<tr class="codeline" data-linenumber="327"><td class="num" id="LN327">327</td><td class="line">        <span class='macro'>lua_getglobal(lua,<span class='string_literal'>"__redis__compare_helper"</span>)<span class='macro_popup'>lua_getfield(lua, (-10002), ("__redis__compare_helper"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="328"><td class="num" id="LN328">328</td><td class="line">        <span class='comment'>/* Stack: array, table, table.sort, array, __redis__compare_helper */</span></td></tr>
<tr class="codeline" data-linenumber="329"><td class="num" id="LN329">329</td><td class="line">        lua_call(lua,2,0);</td></tr>
<tr class="codeline" data-linenumber="330"><td class="num" id="LN330">330</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="331"><td class="num" id="LN331">331</td><td class="line">    <span class='comment'>/* Stack: array (sorted), table */</span></td></tr>
<tr class="codeline" data-linenumber="332"><td class="num" id="LN332">332</td><td class="line">    <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>;             <span class='comment'>/* Stack: array (sorted) */</span></td></tr>
<tr class="codeline" data-linenumber="333"><td class="num" id="LN333">333</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="334"><td class="num" id="LN334">334</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="335"><td class="num" id="LN335">335</td><td class="line"><span class='comment'>/* ---------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="336"><td class="num" id="LN336">336</td><td class="line"> <span class='comment'>* Lua reply to Redis reply conversion functions.</span></td></tr>
<tr class="codeline" data-linenumber="337"><td class="num" id="LN337">337</td><td class="line"> <span class='comment'>* ------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="338"><td class="num" id="LN338">338</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="339"><td class="num" id="LN339">339</td><td class="line"><span class='comment'>/* Reply to client 'c' converting the top element in the Lua stack to a</span></td></tr>
<tr class="codeline" data-linenumber="340"><td class="num" id="LN340">340</td><td class="line"> <span class='comment'>* Redis reply. As a side effect the element is consumed from the stack.  */</span></td></tr>
<tr class="codeline" data-linenumber="341"><td class="num" id="LN341">341</td><td class="line"><span class='keyword'>void</span> luaReplyToRedisReply(client *c, lua_State *lua) {</td></tr>
<tr class="codeline" data-linenumber="342"><td class="num" id="LN342">342</td><td class="line">    <span class='keyword'>int</span> t = lua_type(lua,-1);</td></tr>
<tr class="codeline" data-linenumber="343"><td class="num" id="LN343">343</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="344"><td class="num" id="LN344">344</td><td class="line">    <span class='keyword'>switch</span>(t) {</td></tr>
<tr class="codeline" data-linenumber="345"><td class="num" id="LN345">345</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TSTRING<span class='macro_popup'>4</span></span>:</td></tr>
<tr class="codeline" data-linenumber="346"><td class="num" id="LN346">346</td><td class="line">        addReplyBulkCBuffer(c,(<span class='keyword'>char</span>*)<span class='macro'>lua_tostring(lua,-1)<span class='macro_popup'>lua_tolstring(lua, (-1), ((void*)0))</span></span>,<span class='macro'>lua_strlen(lua,-1)<span class='macro_popup'>lua_objlen(lua, (-1))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="347"><td class="num" id="LN347">347</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="348"><td class="num" id="LN348">348</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TBOOLEAN<span class='macro_popup'>1</span></span>:</td></tr>
<tr class="codeline" data-linenumber="349"><td class="num" id="LN349">349</td><td class="line">        <span class='keyword'>if</span> (server.lua_client-&gt;resp == 2)</td></tr>
<tr class="codeline" data-linenumber="350"><td class="num" id="LN350">350</td><td class="line">            addReply(c,lua_toboolean(lua,-1) ? shared.cone :</td></tr>
<tr class="codeline" data-linenumber="351"><td class="num" id="LN351">351</td><td class="line">                                               shared.null[c-&gt;resp]);</td></tr>
<tr class="codeline" data-linenumber="352"><td class="num" id="LN352">352</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="353"><td class="num" id="LN353">353</td><td class="line">            addReplyBool(c,lua_toboolean(lua,-1));</td></tr>
<tr class="codeline" data-linenumber="354"><td class="num" id="LN354">354</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="355"><td class="num" id="LN355">355</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TNUMBER<span class='macro_popup'>3</span></span>:</td></tr>
<tr class="codeline" data-linenumber="356"><td class="num" id="LN356">356</td><td class="line">        addReplyLongLong(c,(<span class='keyword'>long</span> <span class='keyword'>long</span>)lua_tonumber(lua,-1));</td></tr>
<tr class="codeline" data-linenumber="357"><td class="num" id="LN357">357</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="358"><td class="num" id="LN358">358</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TTABLE<span class='macro_popup'>5</span></span>:</td></tr>
<tr class="codeline" data-linenumber="359"><td class="num" id="LN359">359</td><td class="line">        <span class='comment'>/* We need to check if it is an array, an error, or a status reply.</span></td></tr>
<tr class="codeline" data-linenumber="360"><td class="num" id="LN360">360</td><td class="line">         <span class='comment'>* Error are returned as a single element table with 'err' field.</span></td></tr>
<tr class="codeline" data-linenumber="361"><td class="num" id="LN361">361</td><td class="line">         <span class='comment'>* Status replies are returned as single element table with 'ok'</span></td></tr>
<tr class="codeline" data-linenumber="362"><td class="num" id="LN362">362</td><td class="line">         <span class='comment'>* field. */</span></td></tr>
<tr class="codeline" data-linenumber="363"><td class="num" id="LN363">363</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="364"><td class="num" id="LN364">364</td><td class="line">        <span class='comment'>/* Handle error reply. */</span></td></tr>
<tr class="codeline" data-linenumber="365"><td class="num" id="LN365">365</td><td class="line">        lua_pushstring(lua,<span class='string_literal'>"err"</span>);</td></tr>
<tr class="codeline" data-linenumber="366"><td class="num" id="LN366">366</td><td class="line">        lua_gettable(lua,-2);</td></tr>
<tr class="codeline" data-linenumber="367"><td class="num" id="LN367">367</td><td class="line">        t = lua_type(lua,-1);</td></tr>
<tr class="codeline" data-linenumber="368"><td class="num" id="LN368">368</td><td class="line">        <span class='keyword'>if</span> (t == <span class='macro'>LUA_TSTRING<span class='macro_popup'>4</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="369"><td class="num" id="LN369">369</td><td class="line">            sds err = sdsnew(<span class='macro'>lua_tostring(lua,-1)<span class='macro_popup'>lua_tolstring(lua, (-1), ((void*)0))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="370"><td class="num" id="LN370">370</td><td class="line">            sdsmapchars(err,<span class='string_literal'>"\r\n"</span>,<span class='string_literal'>"  "</span>,2);</td></tr>
<tr class="codeline" data-linenumber="371"><td class="num" id="LN371">371</td><td class="line">            addReplySds(c,sdscatprintf(sdsempty(),<span class='string_literal'>"-%s\r\n"</span>,err));</td></tr>
<tr class="codeline" data-linenumber="372"><td class="num" id="LN372">372</td><td class="line">            sdsfree(err);</td></tr>
<tr class="codeline" data-linenumber="373"><td class="num" id="LN373">373</td><td class="line">            <span class='macro'>lua_pop(lua,2)<span class='macro_popup'>lua_settop(lua, -(2)-1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="374"><td class="num" id="LN374">374</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="375"><td class="num" id="LN375">375</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="376"><td class="num" id="LN376">376</td><td class="line">        <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>; <span class='comment'>/* Discard field name pushed before. */</span></td></tr>
<tr class="codeline" data-linenumber="377"><td class="num" id="LN377">377</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="378"><td class="num" id="LN378">378</td><td class="line">        <span class='comment'>/* Handle status reply. */</span></td></tr>
<tr class="codeline" data-linenumber="379"><td class="num" id="LN379">379</td><td class="line">        lua_pushstring(lua,<span class='string_literal'>"ok"</span>);</td></tr>
<tr class="codeline" data-linenumber="380"><td class="num" id="LN380">380</td><td class="line">        lua_gettable(lua,-2);</td></tr>
<tr class="codeline" data-linenumber="381"><td class="num" id="LN381">381</td><td class="line">        t = lua_type(lua,-1);</td></tr>
<tr class="codeline" data-linenumber="382"><td class="num" id="LN382">382</td><td class="line">        <span class='keyword'>if</span> (t == <span class='macro'>LUA_TSTRING<span class='macro_popup'>4</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="383"><td class="num" id="LN383">383</td><td class="line">            sds ok = sdsnew(<span class='macro'>lua_tostring(lua,-1)<span class='macro_popup'>lua_tolstring(lua, (-1), ((void*)0))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="384"><td class="num" id="LN384">384</td><td class="line">            sdsmapchars(ok,<span class='string_literal'>"\r\n"</span>,<span class='string_literal'>"  "</span>,2);</td></tr>
<tr class="codeline" data-linenumber="385"><td class="num" id="LN385">385</td><td class="line">            addReplySds(c,sdscatprintf(sdsempty(),<span class='string_literal'>"+%s\r\n"</span>,ok));</td></tr>
<tr class="codeline" data-linenumber="386"><td class="num" id="LN386">386</td><td class="line">            sdsfree(ok);</td></tr>
<tr class="codeline" data-linenumber="387"><td class="num" id="LN387">387</td><td class="line">            <span class='macro'>lua_pop(lua,2)<span class='macro_popup'>lua_settop(lua, -(2)-1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="388"><td class="num" id="LN388">388</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="389"><td class="num" id="LN389">389</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="390"><td class="num" id="LN390">390</td><td class="line">        <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>; <span class='comment'>/* Discard field name pushed before. */</span></td></tr>
<tr class="codeline" data-linenumber="391"><td class="num" id="LN391">391</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="392"><td class="num" id="LN392">392</td><td class="line">        <span class='comment'>/* Handle double reply. */</span></td></tr>
<tr class="codeline" data-linenumber="393"><td class="num" id="LN393">393</td><td class="line">        lua_pushstring(lua,<span class='string_literal'>"double"</span>);</td></tr>
<tr class="codeline" data-linenumber="394"><td class="num" id="LN394">394</td><td class="line">        lua_gettable(lua,-2);</td></tr>
<tr class="codeline" data-linenumber="395"><td class="num" id="LN395">395</td><td class="line">        t = lua_type(lua,-1);</td></tr>
<tr class="codeline" data-linenumber="396"><td class="num" id="LN396">396</td><td class="line">        <span class='keyword'>if</span> (t == <span class='macro'>LUA_TNUMBER<span class='macro_popup'>3</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="397"><td class="num" id="LN397">397</td><td class="line">            addReplyDouble(c,lua_tonumber(lua,-1));</td></tr>
<tr class="codeline" data-linenumber="398"><td class="num" id="LN398">398</td><td class="line">            <span class='macro'>lua_pop(lua,2)<span class='macro_popup'>lua_settop(lua, -(2)-1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="399"><td class="num" id="LN399">399</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="400"><td class="num" id="LN400">400</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="401"><td class="num" id="LN401">401</td><td class="line">        <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>; <span class='comment'>/* Discard field name pushed before. */</span></td></tr>
<tr class="codeline" data-linenumber="402"><td class="num" id="LN402">402</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="403"><td class="num" id="LN403">403</td><td class="line">        <span class='comment'>/* Handle map reply. */</span></td></tr>
<tr class="codeline" data-linenumber="404"><td class="num" id="LN404">404</td><td class="line">        lua_pushstring(lua,<span class='string_literal'>"map"</span>);</td></tr>
<tr class="codeline" data-linenumber="405"><td class="num" id="LN405">405</td><td class="line">        lua_gettable(lua,-2);</td></tr>
<tr class="codeline" data-linenumber="406"><td class="num" id="LN406">406</td><td class="line">        t = lua_type(lua,-1);</td></tr>
<tr class="codeline" data-linenumber="407"><td class="num" id="LN407">407</td><td class="line">        <span class='keyword'>if</span> (t == <span class='macro'>LUA_TTABLE<span class='macro_popup'>5</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="408"><td class="num" id="LN408">408</td><td class="line">            <span class='keyword'>int</span> maplen = 0;</td></tr>
<tr class="codeline" data-linenumber="409"><td class="num" id="LN409">409</td><td class="line">            <span class='keyword'>void</span> *replylen = addReplyDeferredLen(c);</td></tr>
<tr class="codeline" data-linenumber="410"><td class="num" id="LN410">410</td><td class="line">            lua_pushnil(lua); <span class='comment'>/* Use nil to start iteration. */</span></td></tr>
<tr class="codeline" data-linenumber="411"><td class="num" id="LN411">411</td><td class="line">            <span class='keyword'>while</span> (lua_next(lua,-2)) {</td></tr>
<tr class="codeline" data-linenumber="412"><td class="num" id="LN412">412</td><td class="line">                <span class='comment'>/* Stack now: table, key, value */</span></td></tr>
<tr class="codeline" data-linenumber="413"><td class="num" id="LN413">413</td><td class="line">                luaReplyToRedisReply(c, lua); <span class='comment'>/* Return value. */</span></td></tr>
<tr class="codeline" data-linenumber="414"><td class="num" id="LN414">414</td><td class="line">                lua_pushvalue(lua,-1);        <span class='comment'>/* Dup key before consuming. */</span></td></tr>
<tr class="codeline" data-linenumber="415"><td class="num" id="LN415">415</td><td class="line">                luaReplyToRedisReply(c, lua); <span class='comment'>/* Return key. */</span></td></tr>
<tr class="codeline" data-linenumber="416"><td class="num" id="LN416">416</td><td class="line">                <span class='comment'>/* Stack now: table, key. */</span></td></tr>
<tr class="codeline" data-linenumber="417"><td class="num" id="LN417">417</td><td class="line">                maplen++;</td></tr>
<tr class="codeline" data-linenumber="418"><td class="num" id="LN418">418</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="419"><td class="num" id="LN419">419</td><td class="line">            setDeferredMapLen(c,replylen,maplen);</td></tr>
<tr class="codeline" data-linenumber="420"><td class="num" id="LN420">420</td><td class="line">            <span class='macro'>lua_pop(lua,2)<span class='macro_popup'>lua_settop(lua, -(2)-1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="421"><td class="num" id="LN421">421</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="422"><td class="num" id="LN422">422</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="423"><td class="num" id="LN423">423</td><td class="line">        <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>; <span class='comment'>/* Discard field name pushed before. */</span></td></tr>
<tr class="codeline" data-linenumber="424"><td class="num" id="LN424">424</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="425"><td class="num" id="LN425">425</td><td class="line">        <span class='comment'>/* Handle set reply. */</span></td></tr>
<tr class="codeline" data-linenumber="426"><td class="num" id="LN426">426</td><td class="line">        lua_pushstring(lua,<span class='string_literal'>"set"</span>);</td></tr>
<tr class="codeline" data-linenumber="427"><td class="num" id="LN427">427</td><td class="line">        lua_gettable(lua,-2);</td></tr>
<tr class="codeline" data-linenumber="428"><td class="num" id="LN428">428</td><td class="line">        t = lua_type(lua,-1);</td></tr>
<tr class="codeline" data-linenumber="429"><td class="num" id="LN429">429</td><td class="line">        <span class='keyword'>if</span> (t == <span class='macro'>LUA_TTABLE<span class='macro_popup'>5</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="430"><td class="num" id="LN430">430</td><td class="line">            <span class='keyword'>int</span> setlen = 0;</td></tr>
<tr class="codeline" data-linenumber="431"><td class="num" id="LN431">431</td><td class="line">            <span class='keyword'>void</span> *replylen = addReplyDeferredLen(c);</td></tr>
<tr class="codeline" data-linenumber="432"><td class="num" id="LN432">432</td><td class="line">            lua_pushnil(lua); <span class='comment'>/* Use nil to start iteration. */</span></td></tr>
<tr class="codeline" data-linenumber="433"><td class="num" id="LN433">433</td><td class="line">            <span class='keyword'>while</span> (lua_next(lua,-2)) {</td></tr>
<tr class="codeline" data-linenumber="434"><td class="num" id="LN434">434</td><td class="line">                <span class='comment'>/* Stack now: table, key, true */</span></td></tr>
<tr class="codeline" data-linenumber="435"><td class="num" id="LN435">435</td><td class="line">                <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>;               <span class='comment'>/* Discard the boolean value. */</span></td></tr>
<tr class="codeline" data-linenumber="436"><td class="num" id="LN436">436</td><td class="line">                lua_pushvalue(lua,-1);        <span class='comment'>/* Dup key before consuming. */</span></td></tr>
<tr class="codeline" data-linenumber="437"><td class="num" id="LN437">437</td><td class="line">                luaReplyToRedisReply(c, lua); <span class='comment'>/* Return key. */</span></td></tr>
<tr class="codeline" data-linenumber="438"><td class="num" id="LN438">438</td><td class="line">                <span class='comment'>/* Stack now: table, key. */</span></td></tr>
<tr class="codeline" data-linenumber="439"><td class="num" id="LN439">439</td><td class="line">                setlen++;</td></tr>
<tr class="codeline" data-linenumber="440"><td class="num" id="LN440">440</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="441"><td class="num" id="LN441">441</td><td class="line">            setDeferredSetLen(c,replylen,setlen);</td></tr>
<tr class="codeline" data-linenumber="442"><td class="num" id="LN442">442</td><td class="line">            <span class='macro'>lua_pop(lua,2)<span class='macro_popup'>lua_settop(lua, -(2)-1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="443"><td class="num" id="LN443">443</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="444"><td class="num" id="LN444">444</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="445"><td class="num" id="LN445">445</td><td class="line">        <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>; <span class='comment'>/* Discard field name pushed before. */</span></td></tr>
<tr class="codeline" data-linenumber="446"><td class="num" id="LN446">446</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="447"><td class="num" id="LN447">447</td><td class="line">        <span class='comment'>/* Handle the array reply. */</span></td></tr>
<tr class="codeline" data-linenumber="448"><td class="num" id="LN448">448</td><td class="line">        <span class='keyword'>void</span> *replylen = addReplyDeferredLen(c);</td></tr>
<tr class="codeline" data-linenumber="449"><td class="num" id="LN449">449</td><td class="line">        <span class='keyword'>int</span> j = 1, mbulklen = 0;</td></tr>
<tr class="codeline" data-linenumber="450"><td class="num" id="LN450">450</td><td class="line">        <span class='keyword'>while</span>(1) {</td></tr>
<tr class="codeline" data-linenumber="451"><td class="num" id="LN451">451</td><td class="line">            lua_pushnumber(lua,j++);</td></tr>
<tr class="codeline" data-linenumber="452"><td class="num" id="LN452">452</td><td class="line">            lua_gettable(lua,-2);</td></tr>
<tr class="codeline" data-linenumber="453"><td class="num" id="LN453">453</td><td class="line">            t = lua_type(lua,-1);</td></tr>
<tr class="codeline" data-linenumber="454"><td class="num" id="LN454">454</td><td class="line">            <span class='keyword'>if</span> (t == <span class='macro'>LUA_TNIL<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="455"><td class="num" id="LN455">455</td><td class="line">                <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="456"><td class="num" id="LN456">456</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="457"><td class="num" id="LN457">457</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="458"><td class="num" id="LN458">458</td><td class="line">            luaReplyToRedisReply(c, lua);</td></tr>
<tr class="codeline" data-linenumber="459"><td class="num" id="LN459">459</td><td class="line">            mbulklen++;</td></tr>
<tr class="codeline" data-linenumber="460"><td class="num" id="LN460">460</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="461"><td class="num" id="LN461">461</td><td class="line">        setDeferredArrayLen(c,replylen,mbulklen);</td></tr>
<tr class="codeline" data-linenumber="462"><td class="num" id="LN462">462</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="463"><td class="num" id="LN463">463</td><td class="line">    <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="464"><td class="num" id="LN464">464</td><td class="line">        addReplyNull(c);</td></tr>
<tr class="codeline" data-linenumber="465"><td class="num" id="LN465">465</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="466"><td class="num" id="LN466">466</td><td class="line">    <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="467"><td class="num" id="LN467">467</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="468"><td class="num" id="LN468">468</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="469"><td class="num" id="LN469">469</td><td class="line"><span class='comment'>/* ---------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="470"><td class="num" id="LN470">470</td><td class="line"> <span class='comment'>* Lua redis.* functions implementations.</span></td></tr>
<tr class="codeline" data-linenumber="471"><td class="num" id="LN471">471</td><td class="line"> <span class='comment'>* ------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="472"><td class="num" id="LN472">472</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="473"><td class="num" id="LN473">473</td><td class="line"><span class='directive'>#define <span class='macro'>LUA_CMD_OBJCACHE_SIZE<span class='macro_popup'>32</span></span> 32</span></td></tr>
<tr class="codeline" data-linenumber="474"><td class="num" id="LN474">474</td><td class="line"><span class='directive'>#define <span class='macro'>LUA_CMD_OBJCACHE_MAX_LEN<span class='macro_popup'>64</span></span> 64</span></td></tr>
<tr class="codeline" data-linenumber="475"><td class="num" id="LN475">475</td><td class="line"><span class='keyword'>int</span> luaRedisGenericCommand(lua_State *lua, <span class='keyword'>int</span> raise_error) {</td></tr>
<tr class="codeline" data-linenumber="476"><td class="num" id="LN476">476</td><td class="line">    <span class='keyword'>int</span> j, argc = lua_gettop(lua);</td></tr>
<tr class="codeline" data-linenumber="477"><td class="num" id="LN477">477</td><td class="line">    <span class='keyword'>struct</span> redisCommand *cmd;</td></tr>
<tr class="codeline" data-linenumber="478"><td class="num" id="LN478">478</td><td class="line">    client *c = server.lua_client;</td></tr>
<tr class="codeline" data-linenumber="479"><td class="num" id="LN479">479</td><td class="line">    sds reply;</td></tr>
<tr class="codeline" data-linenumber="480"><td class="num" id="LN480">480</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="481"><td class="num" id="LN481">481</td><td class="line">    <span class='comment'>/* Cached across calls. */</span></td></tr>
<tr class="codeline" data-linenumber="482"><td class="num" id="LN482">482</td><td class="line">    <span class='keyword'>static</span> robj **argv = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="483"><td class="num" id="LN483">483</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>int</span> argv_size = 0;</td></tr>
<tr class="codeline" data-linenumber="484"><td class="num" id="LN484">484</td><td class="line">    <span class='keyword'>static</span> robj *cached_objects[<span class='macro'>LUA_CMD_OBJCACHE_SIZE<span class='macro_popup'>32</span></span>];</td></tr>
<tr class="codeline" data-linenumber="485"><td class="num" id="LN485">485</td><td class="line">    <span class='keyword'>static</span> size_t cached_objects_len[<span class='macro'>LUA_CMD_OBJCACHE_SIZE<span class='macro_popup'>32</span></span>];</td></tr>
<tr class="codeline" data-linenumber="486"><td class="num" id="LN486">486</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>int</span> inuse = 0;   <span class='comment'>/* Recursive calls detection. */</span></td></tr>
<tr class="codeline" data-linenumber="487"><td class="num" id="LN487">487</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="488"><td class="num" id="LN488">488</td><td class="line">    <span class='comment'>/* By using Lua debug hooks it is possible to trigger a recursive call</span></td></tr>
<tr class="codeline" data-linenumber="489"><td class="num" id="LN489">489</td><td class="line">     <span class='comment'>* to luaRedisGenericCommand(), which normally should never happen.</span></td></tr>
<tr class="codeline" data-linenumber="490"><td class="num" id="LN490">490</td><td class="line">     <span class='comment'>* To make this function reentrant is futile and makes it slower, but</span></td></tr>
<tr class="codeline" data-linenumber="491"><td class="num" id="LN491">491</td><td class="line">     <span class='comment'>* we should at least detect such a misuse, and abort. */</span></td></tr>
<tr class="codeline" data-linenumber="492"><td class="num" id="LN492">492</td><td class="line">    <span class='keyword'>if</span> (inuse) {</td></tr>
<tr class="codeline" data-linenumber="493"><td class="num" id="LN493">493</td><td class="line">        <span class='keyword'>char</span> *recursion_warning =</td></tr>
<tr class="codeline" data-linenumber="494"><td class="num" id="LN494">494</td><td class="line">            <span class='string_literal'>"luaRedisGenericCommand() recursive call detected. "</span></td></tr>
<tr class="codeline" data-linenumber="495"><td class="num" id="LN495">495</td><td class="line">            <span class='string_literal'>"Are you doing funny stuff with Lua debug hooks?"</span>;</td></tr>
<tr class="codeline" data-linenumber="496"><td class="num" id="LN496">496</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"%s"</span>,recursion_warning);</td></tr>
<tr class="codeline" data-linenumber="497"><td class="num" id="LN497">497</td><td class="line">        luaPushError(lua,recursion_warning);</td></tr>
<tr class="codeline" data-linenumber="498"><td class="num" id="LN498">498</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="499"><td class="num" id="LN499">499</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="500"><td class="num" id="LN500">500</td><td class="line">    inuse++;</td></tr>
<tr class="codeline" data-linenumber="501"><td class="num" id="LN501">501</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="502"><td class="num" id="LN502">502</td><td class="line">    <span class='comment'>/* Require at least one argument */</span></td></tr>
<tr class="codeline" data-linenumber="503"><td class="num" id="LN503">503</td><td class="line">    <span class='keyword'>if</span> (argc == 0) {</td></tr>
<tr class="codeline" data-linenumber="504"><td class="num" id="LN504">504</td><td class="line">        luaPushError(lua,</td></tr>
<tr class="codeline" data-linenumber="505"><td class="num" id="LN505">505</td><td class="line">            <span class='string_literal'>"Please specify at least one argument for redis.call()"</span>);</td></tr>
<tr class="codeline" data-linenumber="506"><td class="num" id="LN506">506</td><td class="line">        inuse--;</td></tr>
<tr class="codeline" data-linenumber="507"><td class="num" id="LN507">507</td><td class="line">        <span class='keyword'>return</span> raise_error ? luaRaiseError(lua) : 1;</td></tr>
<tr class="codeline" data-linenumber="508"><td class="num" id="LN508">508</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="509"><td class="num" id="LN509">509</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="510"><td class="num" id="LN510">510</td><td class="line">    <span class='comment'>/* Build the arguments vector */</span></td></tr>
<tr class="codeline" data-linenumber="511"><td class="num" id="LN511">511</td><td class="line">    <span class='keyword'>if</span> (argv_size &lt; argc) {</td></tr>
<tr class="codeline" data-linenumber="512"><td class="num" id="LN512">512</td><td class="line">        argv = zrealloc(argv,<span class='keyword'>sizeof</span>(robj*)*argc);</td></tr>
<tr class="codeline" data-linenumber="513"><td class="num" id="LN513">513</td><td class="line">        argv_size = argc;</td></tr>
<tr class="codeline" data-linenumber="514"><td class="num" id="LN514">514</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="515"><td class="num" id="LN515">515</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="516"><td class="num" id="LN516">516</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; argc; j++) {</td></tr>
<tr class="codeline" data-linenumber="517"><td class="num" id="LN517">517</td><td class="line">        <span class='keyword'>char</span> *obj_s;</td></tr>
<tr class="codeline" data-linenumber="518"><td class="num" id="LN518">518</td><td class="line">        size_t obj_len;</td></tr>
<tr class="codeline" data-linenumber="519"><td class="num" id="LN519">519</td><td class="line">        <span class='keyword'>char</span> dbuf[64];</td></tr>
<tr class="codeline" data-linenumber="520"><td class="num" id="LN520">520</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="521"><td class="num" id="LN521">521</td><td class="line">        <span class='keyword'>if</span> (lua_type(lua,j+1) == <span class='macro'>LUA_TNUMBER<span class='macro_popup'>3</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="522"><td class="num" id="LN522">522</td><td class="line">            <span class='comment'>/* We can't use lua_tolstring() for number -&gt; string conversion</span></td></tr>
<tr class="codeline" data-linenumber="523"><td class="num" id="LN523">523</td><td class="line">             <span class='comment'>* since Lua uses a format specifier that loses precision. */</span></td></tr>
<tr class="codeline" data-linenumber="524"><td class="num" id="LN524">524</td><td class="line">            lua_Number num = lua_tonumber(lua,j+1);</td></tr>
<tr class="codeline" data-linenumber="525"><td class="num" id="LN525">525</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="526"><td class="num" id="LN526">526</td><td class="line">            obj_len = <span class="mrange">snprintf</span>(dbuf,<span class='keyword'>sizeof</span>(dbuf),<span class='string_literal'>"%.17g"</span>,(<span class='keyword'>double</span>)num);</td></tr>
<tr><td class="num"></td><td class="line"><div id="EndPath" class="msg msgEvent" style="margin-left:23ex; max-width:59em">Call to function 'snprintf' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'snprintf_s' in case of C11</div></td></tr>
<tr class="codeline" data-linenumber="527"><td class="num" id="LN527">527</td><td class="line">            obj_s = dbuf;</td></tr>
<tr class="codeline" data-linenumber="528"><td class="num" id="LN528">528</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="529"><td class="num" id="LN529">529</td><td class="line">            obj_s = (<span class='keyword'>char</span>*)lua_tolstring(lua,j+1,&amp;obj_len);</td></tr>
<tr class="codeline" data-linenumber="530"><td class="num" id="LN530">530</td><td class="line">            <span class='keyword'>if</span> (obj_s == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>break</span>; <span class='comment'>/* Not a string. */</span></td></tr>
<tr class="codeline" data-linenumber="531"><td class="num" id="LN531">531</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="532"><td class="num" id="LN532">532</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="533"><td class="num" id="LN533">533</td><td class="line">        <span class='comment'>/* Try to use a cached object. */</span></td></tr>
<tr class="codeline" data-linenumber="534"><td class="num" id="LN534">534</td><td class="line">        <span class='keyword'>if</span> (j &lt; <span class='macro'>LUA_CMD_OBJCACHE_SIZE<span class='macro_popup'>32</span></span> &amp;&amp; cached_objects[j] &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="535"><td class="num" id="LN535">535</td><td class="line">            cached_objects_len[j] &gt;= obj_len)</td></tr>
<tr class="codeline" data-linenumber="536"><td class="num" id="LN536">536</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="537"><td class="num" id="LN537">537</td><td class="line">            sds s = cached_objects[j]-&gt;ptr;</td></tr>
<tr class="codeline" data-linenumber="538"><td class="num" id="LN538">538</td><td class="line">            argv[j] = cached_objects[j];</td></tr>
<tr class="codeline" data-linenumber="539"><td class="num" id="LN539">539</td><td class="line">            cached_objects[j] = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="540"><td class="num" id="LN540">540</td><td class="line">            memcpy(s,obj_s,obj_len+1);</td></tr>
<tr class="codeline" data-linenumber="541"><td class="num" id="LN541">541</td><td class="line">            sdssetlen(s, obj_len);</td></tr>
<tr class="codeline" data-linenumber="542"><td class="num" id="LN542">542</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="543"><td class="num" id="LN543">543</td><td class="line">            argv[j] = createStringObject(obj_s, obj_len);</td></tr>
<tr class="codeline" data-linenumber="544"><td class="num" id="LN544">544</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="545"><td class="num" id="LN545">545</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="546"><td class="num" id="LN546">546</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="547"><td class="num" id="LN547">547</td><td class="line">    <span class='comment'>/* Check if one of the arguments passed by the Lua script</span></td></tr>
<tr class="codeline" data-linenumber="548"><td class="num" id="LN548">548</td><td class="line">     <span class='comment'>* is not a string or an integer (lua_isstring() return true for</span></td></tr>
<tr class="codeline" data-linenumber="549"><td class="num" id="LN549">549</td><td class="line">     <span class='comment'>* integers as well). */</span></td></tr>
<tr class="codeline" data-linenumber="550"><td class="num" id="LN550">550</td><td class="line">    <span class='keyword'>if</span> (j != argc) {</td></tr>
<tr class="codeline" data-linenumber="551"><td class="num" id="LN551">551</td><td class="line">        j--;</td></tr>
<tr class="codeline" data-linenumber="552"><td class="num" id="LN552">552</td><td class="line">        <span class='keyword'>while</span> (j &gt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="553"><td class="num" id="LN553">553</td><td class="line">            decrRefCount(argv[j]);</td></tr>
<tr class="codeline" data-linenumber="554"><td class="num" id="LN554">554</td><td class="line">            j--;</td></tr>
<tr class="codeline" data-linenumber="555"><td class="num" id="LN555">555</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="556"><td class="num" id="LN556">556</td><td class="line">        luaPushError(lua,</td></tr>
<tr class="codeline" data-linenumber="557"><td class="num" id="LN557">557</td><td class="line">            <span class='string_literal'>"Lua redis() command arguments must be strings or integers"</span>);</td></tr>
<tr class="codeline" data-linenumber="558"><td class="num" id="LN558">558</td><td class="line">        inuse--;</td></tr>
<tr class="codeline" data-linenumber="559"><td class="num" id="LN559">559</td><td class="line">        <span class='keyword'>return</span> raise_error ? luaRaiseError(lua) : 1;</td></tr>
<tr class="codeline" data-linenumber="560"><td class="num" id="LN560">560</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="561"><td class="num" id="LN561">561</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="562"><td class="num" id="LN562">562</td><td class="line">    <span class='comment'>/* Setup our fake client for command execution */</span></td></tr>
<tr class="codeline" data-linenumber="563"><td class="num" id="LN563">563</td><td class="line">    c-&gt;argv = argv;</td></tr>
<tr class="codeline" data-linenumber="564"><td class="num" id="LN564">564</td><td class="line">    c-&gt;argc = argc;</td></tr>
<tr class="codeline" data-linenumber="565"><td class="num" id="LN565">565</td><td class="line">    c-&gt;user = server.lua_caller-&gt;user;</td></tr>
<tr class="codeline" data-linenumber="566"><td class="num" id="LN566">566</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="567"><td class="num" id="LN567">567</td><td class="line">    <span class='comment'>/* Process module hooks */</span></td></tr>
<tr class="codeline" data-linenumber="568"><td class="num" id="LN568">568</td><td class="line">    moduleCallCommandFilters(c);</td></tr>
<tr class="codeline" data-linenumber="569"><td class="num" id="LN569">569</td><td class="line">    argv = c-&gt;argv;</td></tr>
<tr class="codeline" data-linenumber="570"><td class="num" id="LN570">570</td><td class="line">    argc = c-&gt;argc;</td></tr>
<tr class="codeline" data-linenumber="571"><td class="num" id="LN571">571</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="572"><td class="num" id="LN572">572</td><td class="line">    <span class='comment'>/* Log the command if debugging is active. */</span></td></tr>
<tr class="codeline" data-linenumber="573"><td class="num" id="LN573">573</td><td class="line">    <span class='keyword'>if</span> (ldb.active &amp;&amp; ldb.step) {</td></tr>
<tr class="codeline" data-linenumber="574"><td class="num" id="LN574">574</td><td class="line">        sds cmdlog = sdsnew(<span class='string_literal'>"&lt;redis&gt;"</span>);</td></tr>
<tr class="codeline" data-linenumber="575"><td class="num" id="LN575">575</td><td class="line">        <span class='keyword'>for</span> (j = 0; j &lt; c-&gt;argc; j++) {</td></tr>
<tr class="codeline" data-linenumber="576"><td class="num" id="LN576">576</td><td class="line">            <span class='keyword'>if</span> (j == 10) {</td></tr>
<tr class="codeline" data-linenumber="577"><td class="num" id="LN577">577</td><td class="line">                cmdlog = sdscatprintf(cmdlog,<span class='string_literal'>" ... (%d more)"</span>,</td></tr>
<tr class="codeline" data-linenumber="578"><td class="num" id="LN578">578</td><td class="line">                    c-&gt;argc-j-1);</td></tr>
<tr class="codeline" data-linenumber="579"><td class="num" id="LN579">579</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="580"><td class="num" id="LN580">580</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="581"><td class="num" id="LN581">581</td><td class="line">                cmdlog = sdscatlen(cmdlog,<span class='string_literal'>" "</span>,1);</td></tr>
<tr class="codeline" data-linenumber="582"><td class="num" id="LN582">582</td><td class="line">                cmdlog = sdscatsds(cmdlog,c-&gt;argv[j]-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="583"><td class="num" id="LN583">583</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="584"><td class="num" id="LN584">584</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="585"><td class="num" id="LN585">585</td><td class="line">        ldbLog(cmdlog);</td></tr>
<tr class="codeline" data-linenumber="586"><td class="num" id="LN586">586</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="587"><td class="num" id="LN587">587</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="588"><td class="num" id="LN588">588</td><td class="line">    <span class='comment'>/* Command lookup */</span></td></tr>
<tr class="codeline" data-linenumber="589"><td class="num" id="LN589">589</td><td class="line">    cmd = lookupCommand(argv[0]-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="590"><td class="num" id="LN590">590</td><td class="line">    <span class='keyword'>if</span> (!cmd || ((cmd-&gt;arity &gt; 0 &amp;&amp; cmd-&gt;arity != argc) ||</td></tr>
<tr class="codeline" data-linenumber="591"><td class="num" id="LN591">591</td><td class="line">                   (argc &lt; -cmd-&gt;arity)))</td></tr>
<tr class="codeline" data-linenumber="592"><td class="num" id="LN592">592</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="593"><td class="num" id="LN593">593</td><td class="line">        <span class='keyword'>if</span> (cmd)</td></tr>
<tr class="codeline" data-linenumber="594"><td class="num" id="LN594">594</td><td class="line">            luaPushError(lua,</td></tr>
<tr class="codeline" data-linenumber="595"><td class="num" id="LN595">595</td><td class="line">                <span class='string_literal'>"Wrong number of args calling Redis command From Lua script"</span>);</td></tr>
<tr class="codeline" data-linenumber="596"><td class="num" id="LN596">596</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="597"><td class="num" id="LN597">597</td><td class="line">            luaPushError(lua,<span class='string_literal'>"Unknown Redis command called from Lua script"</span>);</td></tr>
<tr class="codeline" data-linenumber="598"><td class="num" id="LN598">598</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="599"><td class="num" id="LN599">599</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="600"><td class="num" id="LN600">600</td><td class="line">    c-&gt;cmd = c-&gt;lastcmd = cmd;</td></tr>
<tr class="codeline" data-linenumber="601"><td class="num" id="LN601">601</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="602"><td class="num" id="LN602">602</td><td class="line">    <span class='comment'>/* There are commands that are not allowed inside scripts. */</span></td></tr>
<tr class="codeline" data-linenumber="603"><td class="num" id="LN603">603</td><td class="line">    <span class='keyword'>if</span> (cmd-&gt;flags &amp; <span class='macro'>CMD_NOSCRIPT<span class='macro_popup'>(1ULL&lt;&lt;6)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="604"><td class="num" id="LN604">604</td><td class="line">        luaPushError(lua, <span class='string_literal'>"This Redis command is not allowed from scripts"</span>);</td></tr>
<tr class="codeline" data-linenumber="605"><td class="num" id="LN605">605</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="606"><td class="num" id="LN606">606</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="607"><td class="num" id="LN607">607</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="608"><td class="num" id="LN608">608</td><td class="line">    <span class='comment'>/* Check the ACLs. */</span></td></tr>
<tr class="codeline" data-linenumber="609"><td class="num" id="LN609">609</td><td class="line">    <span class='keyword'>int</span> acl_keypos;</td></tr>
<tr class="codeline" data-linenumber="610"><td class="num" id="LN610">610</td><td class="line">    <span class='keyword'>int</span> acl_retval = ACLCheckCommandPerm(c,&amp;acl_keypos);</td></tr>
<tr class="codeline" data-linenumber="611"><td class="num" id="LN611">611</td><td class="line">    <span class='keyword'>if</span> (acl_retval != <span class='macro'>ACL_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="612"><td class="num" id="LN612">612</td><td class="line">        addACLLogEntry(c,acl_retval,acl_keypos,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="613"><td class="num" id="LN613">613</td><td class="line">        <span class='keyword'>if</span> (acl_retval == <span class='macro'>ACL_DENIED_CMD<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="614"><td class="num" id="LN614">614</td><td class="line">            luaPushError(lua, <span class='string_literal'>"The user executing the script can't run this "</span></td></tr>
<tr class="codeline" data-linenumber="615"><td class="num" id="LN615">615</td><td class="line">                              <span class='string_literal'>"command or subcommand"</span>);</td></tr>
<tr class="codeline" data-linenumber="616"><td class="num" id="LN616">616</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="617"><td class="num" id="LN617">617</td><td class="line">            luaPushError(lua, <span class='string_literal'>"The user executing the script can't access "</span></td></tr>
<tr class="codeline" data-linenumber="618"><td class="num" id="LN618">618</td><td class="line">                              <span class='string_literal'>"at least one of the keys mentioned in the "</span></td></tr>
<tr class="codeline" data-linenumber="619"><td class="num" id="LN619">619</td><td class="line">                              <span class='string_literal'>"command arguments"</span>);</td></tr>
<tr class="codeline" data-linenumber="620"><td class="num" id="LN620">620</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="621"><td class="num" id="LN621">621</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="622"><td class="num" id="LN622">622</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="623"><td class="num" id="LN623">623</td><td class="line">    <span class='comment'>/* Write commands are forbidden against read-only slaves, or if a</span></td></tr>
<tr class="codeline" data-linenumber="624"><td class="num" id="LN624">624</td><td class="line">     <span class='comment'>* command marked as non-deterministic was already called in the context</span></td></tr>
<tr class="codeline" data-linenumber="625"><td class="num" id="LN625">625</td><td class="line">     <span class='comment'>* of this script. */</span></td></tr>
<tr class="codeline" data-linenumber="626"><td class="num" id="LN626">626</td><td class="line">    <span class='keyword'>if</span> (cmd-&gt;flags &amp; <span class='macro'>CMD_WRITE<span class='macro_popup'>(1ULL&lt;&lt;0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="627"><td class="num" id="LN627">627</td><td class="line">        <span class='keyword'>int</span> deny_write_type = writeCommandsDeniedByDiskError();</td></tr>
<tr class="codeline" data-linenumber="628"><td class="num" id="LN628">628</td><td class="line">        <span class='keyword'>if</span> (server.lua_random_dirty &amp;&amp; !server.lua_replicate_commands) {</td></tr>
<tr class="codeline" data-linenumber="629"><td class="num" id="LN629">629</td><td class="line">            luaPushError(lua,</td></tr>
<tr class="codeline" data-linenumber="630"><td class="num" id="LN630">630</td><td class="line">                <span class='string_literal'>"Write commands not allowed after non deterministic commands. Call redis.replicate_commands() at the start of your script in order to switch to single commands replication mode."</span>);</td></tr>
<tr class="codeline" data-linenumber="631"><td class="num" id="LN631">631</td><td class="line">            <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="632"><td class="num" id="LN632">632</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (server.masterhost &amp;&amp; server.repl_slave_ro &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="633"><td class="num" id="LN633">633</td><td class="line">                   !server.loading &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="634"><td class="num" id="LN634">634</td><td class="line">                   !(server.lua_caller-&gt;flags &amp; <span class='macro'>CLIENT_MASTER<span class='macro_popup'>(1&lt;&lt;1)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="635"><td class="num" id="LN635">635</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="636"><td class="num" id="LN636">636</td><td class="line">            luaPushError(lua, shared.roslaveerr-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="637"><td class="num" id="LN637">637</td><td class="line">            <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="638"><td class="num" id="LN638">638</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (deny_write_type != <span class='macro'>DISK_ERROR_TYPE_NONE<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="639"><td class="num" id="LN639">639</td><td class="line">            <span class='keyword'>if</span> (deny_write_type == <span class='macro'>DISK_ERROR_TYPE_RDB<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="640"><td class="num" id="LN640">640</td><td class="line">                luaPushError(lua, shared.bgsaveerr-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="641"><td class="num" id="LN641">641</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="642"><td class="num" id="LN642">642</td><td class="line">                sds aof_write_err = sdscatfmt(sdsempty(),</td></tr>
<tr class="codeline" data-linenumber="643"><td class="num" id="LN643">643</td><td class="line">                    <span class='string_literal'>"-MISCONF Errors writing to the AOF file: %s\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="644"><td class="num" id="LN644">644</td><td class="line">                    strerror(server.aof_last_write_errno));</td></tr>
<tr class="codeline" data-linenumber="645"><td class="num" id="LN645">645</td><td class="line">                luaPushError(lua, aof_write_err);</td></tr>
<tr class="codeline" data-linenumber="646"><td class="num" id="LN646">646</td><td class="line">                sdsfree(aof_write_err);</td></tr>
<tr class="codeline" data-linenumber="647"><td class="num" id="LN647">647</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="648"><td class="num" id="LN648">648</td><td class="line">            <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="649"><td class="num" id="LN649">649</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="650"><td class="num" id="LN650">650</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="651"><td class="num" id="LN651">651</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="652"><td class="num" id="LN652">652</td><td class="line">    <span class='comment'>/* If we reached the memory limit configured via maxmemory, commands that</span></td></tr>
<tr class="codeline" data-linenumber="653"><td class="num" id="LN653">653</td><td class="line">     <span class='comment'>* could enlarge the memory usage are not allowed, but only if this is the</span></td></tr>
<tr class="codeline" data-linenumber="654"><td class="num" id="LN654">654</td><td class="line">     <span class='comment'>* first write in the context of this script, otherwise we can't stop</span></td></tr>
<tr class="codeline" data-linenumber="655"><td class="num" id="LN655">655</td><td class="line">     <span class='comment'>* in the middle. */</span></td></tr>
<tr class="codeline" data-linenumber="656"><td class="num" id="LN656">656</td><td class="line">    <span class='keyword'>if</span> (server.maxmemory &amp;&amp;             <span class='comment'>/* Maxmemory is actually enabled. */</span></td></tr>
<tr class="codeline" data-linenumber="657"><td class="num" id="LN657">657</td><td class="line">        !server.loading &amp;&amp;              <span class='comment'>/* Don't care about mem if loading. */</span></td></tr>
<tr class="codeline" data-linenumber="658"><td class="num" id="LN658">658</td><td class="line">        !server.masterhost &amp;&amp;           <span class='comment'>/* Slave must execute the script. */</span></td></tr>
<tr class="codeline" data-linenumber="659"><td class="num" id="LN659">659</td><td class="line">        server.lua_write_dirty == 0 &amp;&amp;  <span class='comment'>/* Script had no side effects so far. */</span></td></tr>
<tr class="codeline" data-linenumber="660"><td class="num" id="LN660">660</td><td class="line">        server.lua_oom &amp;&amp;               <span class='comment'>/* Detected OOM when script start. */</span></td></tr>
<tr class="codeline" data-linenumber="661"><td class="num" id="LN661">661</td><td class="line">        (cmd-&gt;flags &amp; <span class='macro'>CMD_DENYOOM<span class='macro_popup'>(1ULL&lt;&lt;2)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="662"><td class="num" id="LN662">662</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="663"><td class="num" id="LN663">663</td><td class="line">        luaPushError(lua, shared.oomerr-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="664"><td class="num" id="LN664">664</td><td class="line">        <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="665"><td class="num" id="LN665">665</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="666"><td class="num" id="LN666">666</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="667"><td class="num" id="LN667">667</td><td class="line">    <span class='keyword'>if</span> (cmd-&gt;flags &amp; <span class='macro'>CMD_RANDOM<span class='macro_popup'>(1ULL&lt;&lt;7)</span></span>) server.lua_random_dirty = 1;</td></tr>
<tr class="codeline" data-linenumber="668"><td class="num" id="LN668">668</td><td class="line">    <span class='keyword'>if</span> (cmd-&gt;flags &amp; <span class='macro'>CMD_WRITE<span class='macro_popup'>(1ULL&lt;&lt;0)</span></span>) server.lua_write_dirty = 1;</td></tr>
<tr class="codeline" data-linenumber="669"><td class="num" id="LN669">669</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="670"><td class="num" id="LN670">670</td><td class="line">    <span class='comment'>/* If this is a Redis Cluster node, we need to make sure Lua is not</span></td></tr>
<tr class="codeline" data-linenumber="671"><td class="num" id="LN671">671</td><td class="line">     <span class='comment'>* trying to access non-local keys, with the exception of commands</span></td></tr>
<tr class="codeline" data-linenumber="672"><td class="num" id="LN672">672</td><td class="line">     <span class='comment'>* received from our master or when loading the AOF back in memory. */</span></td></tr>
<tr class="codeline" data-linenumber="673"><td class="num" id="LN673">673</td><td class="line">    <span class='keyword'>if</span> (server.cluster_enabled &amp;&amp; !server.loading &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="674"><td class="num" id="LN674">674</td><td class="line">        !(server.lua_caller-&gt;flags &amp; <span class='macro'>CLIENT_MASTER<span class='macro_popup'>(1&lt;&lt;1)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="675"><td class="num" id="LN675">675</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="676"><td class="num" id="LN676">676</td><td class="line">        <span class='keyword'>int</span> error_code;</td></tr>
<tr class="codeline" data-linenumber="677"><td class="num" id="LN677">677</td><td class="line">        <span class='comment'>/* Duplicate relevant flags in the lua client. */</span></td></tr>
<tr class="codeline" data-linenumber="678"><td class="num" id="LN678">678</td><td class="line">        c-&gt;flags &amp;= ~(<span class='macro'>CLIENT_READONLY<span class='macro_popup'>(1&lt;&lt;17)</span></span>|<span class='macro'>CLIENT_ASKING<span class='macro_popup'>(1&lt;&lt;9)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="679"><td class="num" id="LN679">679</td><td class="line">        c-&gt;flags |= server.lua_caller-&gt;flags &amp; (<span class='macro'>CLIENT_READONLY<span class='macro_popup'>(1&lt;&lt;17)</span></span>|<span class='macro'>CLIENT_ASKING<span class='macro_popup'>(1&lt;&lt;9)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="680"><td class="num" id="LN680">680</td><td class="line">        <span class='keyword'>if</span> (getNodeByQuery(c,c-&gt;cmd,c-&gt;argv,c-&gt;argc,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,&amp;error_code) !=</td></tr>
<tr class="codeline" data-linenumber="681"><td class="num" id="LN681">681</td><td class="line">                           server.cluster-&gt;myself)</td></tr>
<tr class="codeline" data-linenumber="682"><td class="num" id="LN682">682</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="683"><td class="num" id="LN683">683</td><td class="line">            <span class='keyword'>if</span> (error_code == <span class='macro'>CLUSTER_REDIR_DOWN_RO_STATE<span class='macro_popup'>7</span></span>) { </td></tr>
<tr class="codeline" data-linenumber="684"><td class="num" id="LN684">684</td><td class="line">                luaPushError(lua,</td></tr>
<tr class="codeline" data-linenumber="685"><td class="num" id="LN685">685</td><td class="line">                    <span class='string_literal'>"Lua script attempted to execute a write command while the "</span></td></tr>
<tr class="codeline" data-linenumber="686"><td class="num" id="LN686">686</td><td class="line">                    <span class='string_literal'>"cluster is down and readonly"</span>);</td></tr>
<tr class="codeline" data-linenumber="687"><td class="num" id="LN687">687</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (error_code == <span class='macro'>CLUSTER_REDIR_DOWN_STATE<span class='macro_popup'>5</span></span>) { </td></tr>
<tr class="codeline" data-linenumber="688"><td class="num" id="LN688">688</td><td class="line">                luaPushError(lua,</td></tr>
<tr class="codeline" data-linenumber="689"><td class="num" id="LN689">689</td><td class="line">                    <span class='string_literal'>"Lua script attempted to execute a command while the "</span></td></tr>
<tr class="codeline" data-linenumber="690"><td class="num" id="LN690">690</td><td class="line">                    <span class='string_literal'>"cluster is down"</span>);</td></tr>
<tr class="codeline" data-linenumber="691"><td class="num" id="LN691">691</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="692"><td class="num" id="LN692">692</td><td class="line">                luaPushError(lua,</td></tr>
<tr class="codeline" data-linenumber="693"><td class="num" id="LN693">693</td><td class="line">                    <span class='string_literal'>"Lua script attempted to access a non local key in a "</span></td></tr>
<tr class="codeline" data-linenumber="694"><td class="num" id="LN694">694</td><td class="line">                    <span class='string_literal'>"cluster node"</span>);</td></tr>
<tr class="codeline" data-linenumber="695"><td class="num" id="LN695">695</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="696"><td class="num" id="LN696">696</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="697"><td class="num" id="LN697">697</td><td class="line">            <span class='keyword'>goto</span> cleanup;</td></tr>
<tr class="codeline" data-linenumber="698"><td class="num" id="LN698">698</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="699"><td class="num" id="LN699">699</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="700"><td class="num" id="LN700">700</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="701"><td class="num" id="LN701">701</td><td class="line">    <span class='comment'>/* If we are using single commands replication, we need to wrap what</span></td></tr>
<tr class="codeline" data-linenumber="702"><td class="num" id="LN702">702</td><td class="line">     <span class='comment'>* we propagate into a MULTI/EXEC block, so that it will be atomic like</span></td></tr>
<tr class="codeline" data-linenumber="703"><td class="num" id="LN703">703</td><td class="line">     <span class='comment'>* a Lua script in the context of AOF and slaves. */</span></td></tr>
<tr class="codeline" data-linenumber="704"><td class="num" id="LN704">704</td><td class="line">    <span class='keyword'>if</span> (server.lua_replicate_commands &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="705"><td class="num" id="LN705">705</td><td class="line">        !server.lua_multi_emitted &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="706"><td class="num" id="LN706">706</td><td class="line">        !(server.lua_caller-&gt;flags &amp; <span class='macro'>CLIENT_MULTI<span class='macro_popup'>(1&lt;&lt;3)</span></span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="707"><td class="num" id="LN707">707</td><td class="line">        server.lua_write_dirty &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="708"><td class="num" id="LN708">708</td><td class="line">        server.lua_repl != <span class='macro'>PROPAGATE_NONE<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="709"><td class="num" id="LN709">709</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="710"><td class="num" id="LN710">710</td><td class="line">        execCommandPropagateMulti(server.lua_caller);</td></tr>
<tr class="codeline" data-linenumber="711"><td class="num" id="LN711">711</td><td class="line">        server.lua_multi_emitted = 1;</td></tr>
<tr class="codeline" data-linenumber="712"><td class="num" id="LN712">712</td><td class="line">        <span class='comment'>/* Now we are in the MULTI context, the lua_client should be</span></td></tr>
<tr class="codeline" data-linenumber="713"><td class="num" id="LN713">713</td><td class="line">         <span class='comment'>* flag as CLIENT_MULTI. */</span></td></tr>
<tr class="codeline" data-linenumber="714"><td class="num" id="LN714">714</td><td class="line">        c-&gt;flags |= <span class='macro'>CLIENT_MULTI<span class='macro_popup'>(1&lt;&lt;3)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="715"><td class="num" id="LN715">715</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="716"><td class="num" id="LN716">716</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="717"><td class="num" id="LN717">717</td><td class="line">    <span class='comment'>/* Run the command */</span></td></tr>
<tr class="codeline" data-linenumber="718"><td class="num" id="LN718">718</td><td class="line">    <span class='keyword'>int</span> call_flags = <span class='macro'>CMD_CALL_SLOWLOG<span class='macro_popup'>(1&lt;&lt;0)</span></span> | <span class='macro'>CMD_CALL_STATS<span class='macro_popup'>(1&lt;&lt;1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="719"><td class="num" id="LN719">719</td><td class="line">    <span class='keyword'>if</span> (server.lua_replicate_commands) {</td></tr>
<tr class="codeline" data-linenumber="720"><td class="num" id="LN720">720</td><td class="line">        <span class='comment'>/* Set flags according to redis.set_repl() settings. */</span></td></tr>
<tr class="codeline" data-linenumber="721"><td class="num" id="LN721">721</td><td class="line">        <span class='keyword'>if</span> (server.lua_repl &amp; <span class='macro'>PROPAGATE_AOF<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="722"><td class="num" id="LN722">722</td><td class="line">            call_flags |= <span class='macro'>CMD_CALL_PROPAGATE_AOF<span class='macro_popup'>(1&lt;&lt;2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="723"><td class="num" id="LN723">723</td><td class="line">        <span class='keyword'>if</span> (server.lua_repl &amp; <span class='macro'>PROPAGATE_REPL<span class='macro_popup'>2</span></span>)</td></tr>
<tr class="codeline" data-linenumber="724"><td class="num" id="LN724">724</td><td class="line">            call_flags |= <span class='macro'>CMD_CALL_PROPAGATE_REPL<span class='macro_popup'>(1&lt;&lt;3)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="725"><td class="num" id="LN725">725</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="726"><td class="num" id="LN726">726</td><td class="line">    call(c,call_flags);</td></tr>
<tr class="codeline" data-linenumber="727"><td class="num" id="LN727">727</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="728"><td class="num" id="LN728">728</td><td class="line">    <span class='comment'>/* Convert the result of the Redis command into a suitable Lua type.</span></td></tr>
<tr class="codeline" data-linenumber="729"><td class="num" id="LN729">729</td><td class="line">     <span class='comment'>* The first thing we need is to create a single string from the client</span></td></tr>
<tr class="codeline" data-linenumber="730"><td class="num" id="LN730">730</td><td class="line">     <span class='comment'>* output buffers. */</span></td></tr>
<tr class="codeline" data-linenumber="731"><td class="num" id="LN731">731</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>listLength(c-&gt;reply)<span class='macro_popup'>((c-&gt;reply)-&gt;len)</span></span> == 0 &amp;&amp; c-&gt;bufpos &lt; <span class='macro'>PROTO_REPLY_CHUNK_BYTES<span class='macro_popup'>(16*1024)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="732"><td class="num" id="LN732">732</td><td class="line">        <span class='comment'>/* This is a fast path for the common case of a reply inside the</span></td></tr>
<tr class="codeline" data-linenumber="733"><td class="num" id="LN733">733</td><td class="line">         <span class='comment'>* client static buffer. Don't create an SDS string but just use</span></td></tr>
<tr class="codeline" data-linenumber="734"><td class="num" id="LN734">734</td><td class="line">         <span class='comment'>* the client buffer directly. */</span></td></tr>
<tr class="codeline" data-linenumber="735"><td class="num" id="LN735">735</td><td class="line">        c-&gt;buf[c-&gt;bufpos] = '\0';</td></tr>
<tr class="codeline" data-linenumber="736"><td class="num" id="LN736">736</td><td class="line">        reply = c-&gt;buf;</td></tr>
<tr class="codeline" data-linenumber="737"><td class="num" id="LN737">737</td><td class="line">        c-&gt;bufpos = 0;</td></tr>
<tr class="codeline" data-linenumber="738"><td class="num" id="LN738">738</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="739"><td class="num" id="LN739">739</td><td class="line">        reply = sdsnewlen(c-&gt;buf,c-&gt;bufpos);</td></tr>
<tr class="codeline" data-linenumber="740"><td class="num" id="LN740">740</td><td class="line">        c-&gt;bufpos = 0;</td></tr>
<tr class="codeline" data-linenumber="741"><td class="num" id="LN741">741</td><td class="line">        <span class='keyword'>while</span>(<span class='macro'>listLength(c-&gt;reply)<span class='macro_popup'>((c-&gt;reply)-&gt;len)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="742"><td class="num" id="LN742">742</td><td class="line">            clientReplyBlock *o = <span class='macro'>listNodeValue(listFirst(c-&gt;reply))<span class='macro_popup'>((((c-&gt;reply)-&gt;head))-&gt;value)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="743"><td class="num" id="LN743">743</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="744"><td class="num" id="LN744">744</td><td class="line">            reply = sdscatlen(reply,o-&gt;buf,o-&gt;used);</td></tr>
<tr class="codeline" data-linenumber="745"><td class="num" id="LN745">745</td><td class="line">            listDelNode(c-&gt;reply,<span class='macro'>listFirst(c-&gt;reply)<span class='macro_popup'>((c-&gt;reply)-&gt;head)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="746"><td class="num" id="LN746">746</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="747"><td class="num" id="LN747">747</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="748"><td class="num" id="LN748">748</td><td class="line">    <span class='keyword'>if</span> (raise_error &amp;&amp; reply[0] != '-') raise_error = 0;</td></tr>
<tr class="codeline" data-linenumber="749"><td class="num" id="LN749">749</td><td class="line">    redisProtocolToLuaType(lua,reply);</td></tr>
<tr class="codeline" data-linenumber="750"><td class="num" id="LN750">750</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="751"><td class="num" id="LN751">751</td><td class="line">    <span class='comment'>/* If the debugger is active, log the reply from Redis. */</span></td></tr>
<tr class="codeline" data-linenumber="752"><td class="num" id="LN752">752</td><td class="line">    <span class='keyword'>if</span> (ldb.active &amp;&amp; ldb.step)</td></tr>
<tr class="codeline" data-linenumber="753"><td class="num" id="LN753">753</td><td class="line">        ldbLogRedisReply(reply);</td></tr>
<tr class="codeline" data-linenumber="754"><td class="num" id="LN754">754</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="755"><td class="num" id="LN755">755</td><td class="line">    <span class='comment'>/* Sort the output array if needed, assuming it is a non-null multi bulk</span></td></tr>
<tr class="codeline" data-linenumber="756"><td class="num" id="LN756">756</td><td class="line">     <span class='comment'>* reply as expected. */</span></td></tr>
<tr class="codeline" data-linenumber="757"><td class="num" id="LN757">757</td><td class="line">    <span class='keyword'>if</span> ((cmd-&gt;flags &amp; <span class='macro'>CMD_SORT_FOR_SCRIPT<span class='macro_popup'>(1ULL&lt;&lt;8)</span></span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="758"><td class="num" id="LN758">758</td><td class="line">        (server.lua_replicate_commands == 0) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="759"><td class="num" id="LN759">759</td><td class="line">        (reply[0] == '*' &amp;&amp; reply[1] != '-')) {</td></tr>
<tr class="codeline" data-linenumber="760"><td class="num" id="LN760">760</td><td class="line">            luaSortArray(lua);</td></tr>
<tr class="codeline" data-linenumber="761"><td class="num" id="LN761">761</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="762"><td class="num" id="LN762">762</td><td class="line">    <span class='keyword'>if</span> (reply != c-&gt;buf) sdsfree(reply);</td></tr>
<tr class="codeline" data-linenumber="763"><td class="num" id="LN763">763</td><td class="line">    c-&gt;reply_bytes = 0;</td></tr>
<tr class="codeline" data-linenumber="764"><td class="num" id="LN764">764</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="765"><td class="num" id="LN765">765</td><td class="line">cleanup:</td></tr>
<tr class="codeline" data-linenumber="766"><td class="num" id="LN766">766</td><td class="line">    <span class='comment'>/* Clean up. Command code may have changed argv/argc so we use the</span></td></tr>
<tr class="codeline" data-linenumber="767"><td class="num" id="LN767">767</td><td class="line">     <span class='comment'>* argv/argc of the client instead of the local variables. */</span></td></tr>
<tr class="codeline" data-linenumber="768"><td class="num" id="LN768">768</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; c-&gt;argc; j++) {</td></tr>
<tr class="codeline" data-linenumber="769"><td class="num" id="LN769">769</td><td class="line">        robj *o = c-&gt;argv[j];</td></tr>
<tr class="codeline" data-linenumber="770"><td class="num" id="LN770">770</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="771"><td class="num" id="LN771">771</td><td class="line">        <span class='comment'>/* Try to cache the object in the cached_objects array.</span></td></tr>
<tr class="codeline" data-linenumber="772"><td class="num" id="LN772">772</td><td class="line">         <span class='comment'>* The object must be small, SDS-encoded, and with refcount = 1</span></td></tr>
<tr class="codeline" data-linenumber="773"><td class="num" id="LN773">773</td><td class="line">         <span class='comment'>* (we must be the only owner) for us to cache it. */</span></td></tr>
<tr class="codeline" data-linenumber="774"><td class="num" id="LN774">774</td><td class="line">        <span class='keyword'>if</span> (j &lt; <span class='macro'>LUA_CMD_OBJCACHE_SIZE<span class='macro_popup'>32</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="775"><td class="num" id="LN775">775</td><td class="line">            o-&gt;refcount == 1 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="776"><td class="num" id="LN776">776</td><td class="line">            (o-&gt;encoding == <span class='macro'>OBJ_ENCODING_RAW<span class='macro_popup'>0</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="777"><td class="num" id="LN777">777</td><td class="line">             o-&gt;encoding == <span class='macro'>OBJ_ENCODING_EMBSTR<span class='macro_popup'>8</span></span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="778"><td class="num" id="LN778">778</td><td class="line">            sdslen(o-&gt;ptr) &lt;= <span class='macro'>LUA_CMD_OBJCACHE_MAX_LEN<span class='macro_popup'>64</span></span>)</td></tr>
<tr class="codeline" data-linenumber="779"><td class="num" id="LN779">779</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="780"><td class="num" id="LN780">780</td><td class="line">            sds s = o-&gt;ptr;</td></tr>
<tr class="codeline" data-linenumber="781"><td class="num" id="LN781">781</td><td class="line">            <span class='keyword'>if</span> (cached_objects[j]) decrRefCount(cached_objects[j]);</td></tr>
<tr class="codeline" data-linenumber="782"><td class="num" id="LN782">782</td><td class="line">            cached_objects[j] = o;</td></tr>
<tr class="codeline" data-linenumber="783"><td class="num" id="LN783">783</td><td class="line">            cached_objects_len[j] = sdsalloc(s);</td></tr>
<tr class="codeline" data-linenumber="784"><td class="num" id="LN784">784</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="785"><td class="num" id="LN785">785</td><td class="line">            decrRefCount(o);</td></tr>
<tr class="codeline" data-linenumber="786"><td class="num" id="LN786">786</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="787"><td class="num" id="LN787">787</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="788"><td class="num" id="LN788">788</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="789"><td class="num" id="LN789">789</td><td class="line">    <span class='keyword'>if</span> (c-&gt;argv != argv) {</td></tr>
<tr class="codeline" data-linenumber="790"><td class="num" id="LN790">790</td><td class="line">        zfree(c-&gt;argv);</td></tr>
<tr class="codeline" data-linenumber="791"><td class="num" id="LN791">791</td><td class="line">        argv = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="792"><td class="num" id="LN792">792</td><td class="line">        argv_size = 0;</td></tr>
<tr class="codeline" data-linenumber="793"><td class="num" id="LN793">793</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="794"><td class="num" id="LN794">794</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="795"><td class="num" id="LN795">795</td><td class="line">    c-&gt;user = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="796"><td class="num" id="LN796">796</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="797"><td class="num" id="LN797">797</td><td class="line">    <span class='keyword'>if</span> (raise_error) {</td></tr>
<tr class="codeline" data-linenumber="798"><td class="num" id="LN798">798</td><td class="line">        <span class='comment'>/* If we are here we should have an error in the stack, in the</span></td></tr>
<tr class="codeline" data-linenumber="799"><td class="num" id="LN799">799</td><td class="line">         <span class='comment'>* form of a table with an "err" field. Extract the string to</span></td></tr>
<tr class="codeline" data-linenumber="800"><td class="num" id="LN800">800</td><td class="line">         <span class='comment'>* return the plain error. */</span></td></tr>
<tr class="codeline" data-linenumber="801"><td class="num" id="LN801">801</td><td class="line">        inuse--;</td></tr>
<tr class="codeline" data-linenumber="802"><td class="num" id="LN802">802</td><td class="line">        <span class='keyword'>return</span> luaRaiseError(lua);</td></tr>
<tr class="codeline" data-linenumber="803"><td class="num" id="LN803">803</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="804"><td class="num" id="LN804">804</td><td class="line">    inuse--;</td></tr>
<tr class="codeline" data-linenumber="805"><td class="num" id="LN805">805</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="806"><td class="num" id="LN806">806</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="807"><td class="num" id="LN807">807</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="808"><td class="num" id="LN808">808</td><td class="line"><span class='comment'>/* redis.call() */</span></td></tr>
<tr class="codeline" data-linenumber="809"><td class="num" id="LN809">809</td><td class="line"><span class='keyword'>int</span> luaRedisCallCommand(lua_State *lua) {</td></tr>
<tr class="codeline" data-linenumber="810"><td class="num" id="LN810">810</td><td class="line">    <span class='keyword'>return</span> luaRedisGenericCommand(lua,1);</td></tr>
<tr class="codeline" data-linenumber="811"><td class="num" id="LN811">811</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="812"><td class="num" id="LN812">812</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="813"><td class="num" id="LN813">813</td><td class="line"><span class='comment'>/* redis.pcall() */</span></td></tr>
<tr class="codeline" data-linenumber="814"><td class="num" id="LN814">814</td><td class="line"><span class='keyword'>int</span> luaRedisPCallCommand(lua_State *lua) {</td></tr>
<tr class="codeline" data-linenumber="815"><td class="num" id="LN815">815</td><td class="line">    <span class='keyword'>return</span> luaRedisGenericCommand(lua,0);</td></tr>
<tr class="codeline" data-linenumber="816"><td class="num" id="LN816">816</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="817"><td class="num" id="LN817">817</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="818"><td class="num" id="LN818">818</td><td class="line"><span class='comment'>/* This adds redis.sha1hex(string) to Lua scripts using the same hashing</span></td></tr>
<tr class="codeline" data-linenumber="819"><td class="num" id="LN819">819</td><td class="line"> <span class='comment'>* function used for sha1ing lua scripts. */</span></td></tr>
<tr class="codeline" data-linenumber="820"><td class="num" id="LN820">820</td><td class="line"><span class='keyword'>int</span> luaRedisSha1hexCommand(lua_State *lua) {</td></tr>
<tr class="codeline" data-linenumber="821"><td class="num" id="LN821">821</td><td class="line">    <span class='keyword'>int</span> argc = lua_gettop(lua);</td></tr>
<tr class="codeline" data-linenumber="822"><td class="num" id="LN822">822</td><td class="line">    <span class='keyword'>char</span> digest[41];</td></tr>
<tr class="codeline" data-linenumber="823"><td class="num" id="LN823">823</td><td class="line">    size_t len;</td></tr>
<tr class="codeline" data-linenumber="824"><td class="num" id="LN824">824</td><td class="line">    <span class='keyword'>char</span> *s;</td></tr>
<tr class="codeline" data-linenumber="825"><td class="num" id="LN825">825</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="826"><td class="num" id="LN826">826</td><td class="line">    <span class='keyword'>if</span> (argc != 1) {</td></tr>
<tr class="codeline" data-linenumber="827"><td class="num" id="LN827">827</td><td class="line">        lua_pushstring(lua, <span class='string_literal'>"wrong number of arguments"</span>);</td></tr>
<tr class="codeline" data-linenumber="828"><td class="num" id="LN828">828</td><td class="line">        <span class='keyword'>return</span> lua_error(lua);</td></tr>
<tr class="codeline" data-linenumber="829"><td class="num" id="LN829">829</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="830"><td class="num" id="LN830">830</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="831"><td class="num" id="LN831">831</td><td class="line">    s = (<span class='keyword'>char</span>*)lua_tolstring(lua,1,&amp;len);</td></tr>
<tr class="codeline" data-linenumber="832"><td class="num" id="LN832">832</td><td class="line">    sha1hex(digest,s,len);</td></tr>
<tr class="codeline" data-linenumber="833"><td class="num" id="LN833">833</td><td class="line">    lua_pushstring(lua,digest);</td></tr>
<tr class="codeline" data-linenumber="834"><td class="num" id="LN834">834</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="835"><td class="num" id="LN835">835</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="836"><td class="num" id="LN836">836</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="837"><td class="num" id="LN837">837</td><td class="line"><span class='comment'>/* Returns a table with a single field 'field' set to the string value</span></td></tr>
<tr class="codeline" data-linenumber="838"><td class="num" id="LN838">838</td><td class="line"> <span class='comment'>* passed as argument. This helper function is handy when returning</span></td></tr>
<tr class="codeline" data-linenumber="839"><td class="num" id="LN839">839</td><td class="line"> <span class='comment'>* a Redis Protocol error or status reply from Lua:</span></td></tr>
<tr class="codeline" data-linenumber="840"><td class="num" id="LN840">840</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="841"><td class="num" id="LN841">841</td><td class="line"> <span class='comment'>* return redis.error_reply("ERR Some Error")</span></td></tr>
<tr class="codeline" data-linenumber="842"><td class="num" id="LN842">842</td><td class="line"> <span class='comment'>* return redis.status_reply("ERR Some Error")</span></td></tr>
<tr class="codeline" data-linenumber="843"><td class="num" id="LN843">843</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="844"><td class="num" id="LN844">844</td><td class="line"><span class='keyword'>int</span> luaRedisReturnSingleFieldTable(lua_State *lua, <span class='keyword'>char</span> *field) {</td></tr>
<tr class="codeline" data-linenumber="845"><td class="num" id="LN845">845</td><td class="line">    <span class='keyword'>if</span> (lua_gettop(lua) != 1 || lua_type(lua,-1) != <span class='macro'>LUA_TSTRING<span class='macro_popup'>4</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="846"><td class="num" id="LN846">846</td><td class="line">        luaPushError(lua, <span class='string_literal'>"wrong number or type of arguments"</span>);</td></tr>
<tr class="codeline" data-linenumber="847"><td class="num" id="LN847">847</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="848"><td class="num" id="LN848">848</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="849"><td class="num" id="LN849">849</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="850"><td class="num" id="LN850">850</td><td class="line">    <span class='macro'>lua_newtable(lua)<span class='macro_popup'>lua_createtable(lua, 0, 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="851"><td class="num" id="LN851">851</td><td class="line">    lua_pushstring(lua, field);</td></tr>
<tr class="codeline" data-linenumber="852"><td class="num" id="LN852">852</td><td class="line">    lua_pushvalue(lua, -3);</td></tr>
<tr class="codeline" data-linenumber="853"><td class="num" id="LN853">853</td><td class="line">    lua_settable(lua, -3);</td></tr>
<tr class="codeline" data-linenumber="854"><td class="num" id="LN854">854</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="855"><td class="num" id="LN855">855</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="856"><td class="num" id="LN856">856</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="857"><td class="num" id="LN857">857</td><td class="line"><span class='comment'>/* redis.error_reply() */</span></td></tr>
<tr class="codeline" data-linenumber="858"><td class="num" id="LN858">858</td><td class="line"><span class='keyword'>int</span> luaRedisErrorReplyCommand(lua_State *lua) {</td></tr>
<tr class="codeline" data-linenumber="859"><td class="num" id="LN859">859</td><td class="line">    <span class='keyword'>return</span> luaRedisReturnSingleFieldTable(lua,<span class='string_literal'>"err"</span>);</td></tr>
<tr class="codeline" data-linenumber="860"><td class="num" id="LN860">860</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="861"><td class="num" id="LN861">861</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="862"><td class="num" id="LN862">862</td><td class="line"><span class='comment'>/* redis.status_reply() */</span></td></tr>
<tr class="codeline" data-linenumber="863"><td class="num" id="LN863">863</td><td class="line"><span class='keyword'>int</span> luaRedisStatusReplyCommand(lua_State *lua) {</td></tr>
<tr class="codeline" data-linenumber="864"><td class="num" id="LN864">864</td><td class="line">    <span class='keyword'>return</span> luaRedisReturnSingleFieldTable(lua,<span class='string_literal'>"ok"</span>);</td></tr>
<tr class="codeline" data-linenumber="865"><td class="num" id="LN865">865</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="866"><td class="num" id="LN866">866</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="867"><td class="num" id="LN867">867</td><td class="line"><span class='comment'>/* redis.replicate_commands()</span></td></tr>
<tr class="codeline" data-linenumber="868"><td class="num" id="LN868">868</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="869"><td class="num" id="LN869">869</td><td class="line"> <span class='comment'>* Turn on single commands replication if the script never called</span></td></tr>
<tr class="codeline" data-linenumber="870"><td class="num" id="LN870">870</td><td class="line"> <span class='comment'>* a write command so far, and returns true. Otherwise if the script</span></td></tr>
<tr class="codeline" data-linenumber="871"><td class="num" id="LN871">871</td><td class="line"> <span class='comment'>* already started to write, returns false and stick to whole scripts</span></td></tr>
<tr class="codeline" data-linenumber="872"><td class="num" id="LN872">872</td><td class="line"> <span class='comment'>* replication, which is our default. */</span></td></tr>
<tr class="codeline" data-linenumber="873"><td class="num" id="LN873">873</td><td class="line"><span class='keyword'>int</span> luaRedisReplicateCommandsCommand(lua_State *lua) {</td></tr>
<tr class="codeline" data-linenumber="874"><td class="num" id="LN874">874</td><td class="line">    <span class='keyword'>if</span> (server.lua_write_dirty) {</td></tr>
<tr class="codeline" data-linenumber="875"><td class="num" id="LN875">875</td><td class="line">        lua_pushboolean(lua,0);</td></tr>
<tr class="codeline" data-linenumber="876"><td class="num" id="LN876">876</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="877"><td class="num" id="LN877">877</td><td class="line">        server.lua_replicate_commands = 1;</td></tr>
<tr class="codeline" data-linenumber="878"><td class="num" id="LN878">878</td><td class="line">        <span class='comment'>/* When we switch to single commands replication, we can provide</span></td></tr>
<tr class="codeline" data-linenumber="879"><td class="num" id="LN879">879</td><td class="line">         <span class='comment'>* different math.random() sequences at every call, which is what</span></td></tr>
<tr class="codeline" data-linenumber="880"><td class="num" id="LN880">880</td><td class="line">         <span class='comment'>* the user normally expects. */</span></td></tr>
<tr class="codeline" data-linenumber="881"><td class="num" id="LN881">881</td><td class="line">        redisSrand48(rand());</td></tr>
<tr class="codeline" data-linenumber="882"><td class="num" id="LN882">882</td><td class="line">        lua_pushboolean(lua,1);</td></tr>
<tr class="codeline" data-linenumber="883"><td class="num" id="LN883">883</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="884"><td class="num" id="LN884">884</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="885"><td class="num" id="LN885">885</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="886"><td class="num" id="LN886">886</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="887"><td class="num" id="LN887">887</td><td class="line"><span class='comment'>/* redis.breakpoint()</span></td></tr>
<tr class="codeline" data-linenumber="888"><td class="num" id="LN888">888</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="889"><td class="num" id="LN889">889</td><td class="line"> <span class='comment'>* Allows to stop execution during a debugging session from within</span></td></tr>
<tr class="codeline" data-linenumber="890"><td class="num" id="LN890">890</td><td class="line"> <span class='comment'>* the Lua code implementation, like if a breakpoint was set in the code</span></td></tr>
<tr class="codeline" data-linenumber="891"><td class="num" id="LN891">891</td><td class="line"> <span class='comment'>* immediately after the function. */</span></td></tr>
<tr class="codeline" data-linenumber="892"><td class="num" id="LN892">892</td><td class="line"><span class='keyword'>int</span> luaRedisBreakpointCommand(lua_State *lua) {</td></tr>
<tr class="codeline" data-linenumber="893"><td class="num" id="LN893">893</td><td class="line">    <span class='keyword'>if</span> (ldb.active) {</td></tr>
<tr class="codeline" data-linenumber="894"><td class="num" id="LN894">894</td><td class="line">        ldb.luabp = 1;</td></tr>
<tr class="codeline" data-linenumber="895"><td class="num" id="LN895">895</td><td class="line">        lua_pushboolean(lua,1);</td></tr>
<tr class="codeline" data-linenumber="896"><td class="num" id="LN896">896</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="897"><td class="num" id="LN897">897</td><td class="line">        lua_pushboolean(lua,0);</td></tr>
<tr class="codeline" data-linenumber="898"><td class="num" id="LN898">898</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="899"><td class="num" id="LN899">899</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="900"><td class="num" id="LN900">900</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="901"><td class="num" id="LN901">901</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="902"><td class="num" id="LN902">902</td><td class="line"><span class='comment'>/* redis.debug()</span></td></tr>
<tr class="codeline" data-linenumber="903"><td class="num" id="LN903">903</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="904"><td class="num" id="LN904">904</td><td class="line"> <span class='comment'>* Log a string message into the output console.</span></td></tr>
<tr class="codeline" data-linenumber="905"><td class="num" id="LN905">905</td><td class="line"> <span class='comment'>* Can take multiple arguments that will be separated by commas.</span></td></tr>
<tr class="codeline" data-linenumber="906"><td class="num" id="LN906">906</td><td class="line"> <span class='comment'>* Nothing is returned to the caller. */</span></td></tr>
<tr class="codeline" data-linenumber="907"><td class="num" id="LN907">907</td><td class="line"><span class='keyword'>int</span> luaRedisDebugCommand(lua_State *lua) {</td></tr>
<tr class="codeline" data-linenumber="908"><td class="num" id="LN908">908</td><td class="line">    <span class='keyword'>if</span> (!ldb.active) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="909"><td class="num" id="LN909">909</td><td class="line">    <span class='keyword'>int</span> argc = lua_gettop(lua);</td></tr>
<tr class="codeline" data-linenumber="910"><td class="num" id="LN910">910</td><td class="line">    sds log = sdscatprintf(sdsempty(),<span class='string_literal'>"&lt;debug&gt; line %d: "</span>, ldb.currentline);</td></tr>
<tr class="codeline" data-linenumber="911"><td class="num" id="LN911">911</td><td class="line">    <span class='keyword'>while</span>(argc--) {</td></tr>
<tr class="codeline" data-linenumber="912"><td class="num" id="LN912">912</td><td class="line">        log = ldbCatStackValue(log,lua,-1 - argc);</td></tr>
<tr class="codeline" data-linenumber="913"><td class="num" id="LN913">913</td><td class="line">        <span class='keyword'>if</span> (argc != 0) log = sdscatlen(log,<span class='string_literal'>", "</span>,2);</td></tr>
<tr class="codeline" data-linenumber="914"><td class="num" id="LN914">914</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="915"><td class="num" id="LN915">915</td><td class="line">    ldbLog(log);</td></tr>
<tr class="codeline" data-linenumber="916"><td class="num" id="LN916">916</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="917"><td class="num" id="LN917">917</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="918"><td class="num" id="LN918">918</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="919"><td class="num" id="LN919">919</td><td class="line"><span class='comment'>/* redis.set_repl()</span></td></tr>
<tr class="codeline" data-linenumber="920"><td class="num" id="LN920">920</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="921"><td class="num" id="LN921">921</td><td class="line"> <span class='comment'>* Set the propagation of write commands executed in the context of the</span></td></tr>
<tr class="codeline" data-linenumber="922"><td class="num" id="LN922">922</td><td class="line"> <span class='comment'>* script to on/off for AOF and slaves. */</span></td></tr>
<tr class="codeline" data-linenumber="923"><td class="num" id="LN923">923</td><td class="line"><span class='keyword'>int</span> luaRedisSetReplCommand(lua_State *lua) {</td></tr>
<tr class="codeline" data-linenumber="924"><td class="num" id="LN924">924</td><td class="line">    <span class='keyword'>int</span> argc = lua_gettop(lua);</td></tr>
<tr class="codeline" data-linenumber="925"><td class="num" id="LN925">925</td><td class="line">    <span class='keyword'>int</span> flags;</td></tr>
<tr class="codeline" data-linenumber="926"><td class="num" id="LN926">926</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="927"><td class="num" id="LN927">927</td><td class="line">    <span class='keyword'>if</span> (server.lua_replicate_commands == 0) {</td></tr>
<tr class="codeline" data-linenumber="928"><td class="num" id="LN928">928</td><td class="line">        lua_pushstring(lua, <span class='string_literal'>"You can set the replication behavior only after turning on single commands replication with redis.replicate_commands()."</span>);</td></tr>
<tr class="codeline" data-linenumber="929"><td class="num" id="LN929">929</td><td class="line">        <span class='keyword'>return</span> lua_error(lua);</td></tr>
<tr class="codeline" data-linenumber="930"><td class="num" id="LN930">930</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (argc != 1) {</td></tr>
<tr class="codeline" data-linenumber="931"><td class="num" id="LN931">931</td><td class="line">        lua_pushstring(lua, <span class='string_literal'>"redis.set_repl() requires two arguments."</span>);</td></tr>
<tr class="codeline" data-linenumber="932"><td class="num" id="LN932">932</td><td class="line">        <span class='keyword'>return</span> lua_error(lua);</td></tr>
<tr class="codeline" data-linenumber="933"><td class="num" id="LN933">933</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="934"><td class="num" id="LN934">934</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="935"><td class="num" id="LN935">935</td><td class="line">    flags = lua_tonumber(lua,-1);</td></tr>
<tr class="codeline" data-linenumber="936"><td class="num" id="LN936">936</td><td class="line">    <span class='keyword'>if</span> ((flags &amp; ~(<span class='macro'>PROPAGATE_AOF<span class='macro_popup'>1</span></span>|<span class='macro'>PROPAGATE_REPL<span class='macro_popup'>2</span></span>)) != 0) {</td></tr>
<tr class="codeline" data-linenumber="937"><td class="num" id="LN937">937</td><td class="line">        lua_pushstring(lua, <span class='string_literal'>"Invalid replication flags. Use REPL_AOF, REPL_REPLICA, REPL_ALL or REPL_NONE."</span>);</td></tr>
<tr class="codeline" data-linenumber="938"><td class="num" id="LN938">938</td><td class="line">        <span class='keyword'>return</span> lua_error(lua);</td></tr>
<tr class="codeline" data-linenumber="939"><td class="num" id="LN939">939</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="940"><td class="num" id="LN940">940</td><td class="line">    server.lua_repl = flags;</td></tr>
<tr class="codeline" data-linenumber="941"><td class="num" id="LN941">941</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="942"><td class="num" id="LN942">942</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="943"><td class="num" id="LN943">943</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="944"><td class="num" id="LN944">944</td><td class="line"><span class='comment'>/* redis.log() */</span></td></tr>
<tr class="codeline" data-linenumber="945"><td class="num" id="LN945">945</td><td class="line"><span class='keyword'>int</span> luaLogCommand(lua_State *lua) {</td></tr>
<tr class="codeline" data-linenumber="946"><td class="num" id="LN946">946</td><td class="line">    <span class='keyword'>int</span> j, argc = lua_gettop(lua);</td></tr>
<tr class="codeline" data-linenumber="947"><td class="num" id="LN947">947</td><td class="line">    <span class='keyword'>int</span> level;</td></tr>
<tr class="codeline" data-linenumber="948"><td class="num" id="LN948">948</td><td class="line">    sds log;</td></tr>
<tr class="codeline" data-linenumber="949"><td class="num" id="LN949">949</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="950"><td class="num" id="LN950">950</td><td class="line">    <span class='keyword'>if</span> (argc &lt; 2) {</td></tr>
<tr class="codeline" data-linenumber="951"><td class="num" id="LN951">951</td><td class="line">        lua_pushstring(lua, <span class='string_literal'>"redis.log() requires two arguments or more."</span>);</td></tr>
<tr class="codeline" data-linenumber="952"><td class="num" id="LN952">952</td><td class="line">        <span class='keyword'>return</span> lua_error(lua);</td></tr>
<tr class="codeline" data-linenumber="953"><td class="num" id="LN953">953</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (!lua_isnumber(lua,-argc)) {</td></tr>
<tr class="codeline" data-linenumber="954"><td class="num" id="LN954">954</td><td class="line">        lua_pushstring(lua, <span class='string_literal'>"First argument must be a number (log level)."</span>);</td></tr>
<tr class="codeline" data-linenumber="955"><td class="num" id="LN955">955</td><td class="line">        <span class='keyword'>return</span> lua_error(lua);</td></tr>
<tr class="codeline" data-linenumber="956"><td class="num" id="LN956">956</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="957"><td class="num" id="LN957">957</td><td class="line">    level = lua_tonumber(lua,-argc);</td></tr>
<tr class="codeline" data-linenumber="958"><td class="num" id="LN958">958</td><td class="line">    <span class='keyword'>if</span> (level &lt; <span class='macro'>LL_DEBUG<span class='macro_popup'>0</span></span> || level &gt; <span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="959"><td class="num" id="LN959">959</td><td class="line">        lua_pushstring(lua, <span class='string_literal'>"Invalid debug level."</span>);</td></tr>
<tr class="codeline" data-linenumber="960"><td class="num" id="LN960">960</td><td class="line">        <span class='keyword'>return</span> lua_error(lua);</td></tr>
<tr class="codeline" data-linenumber="961"><td class="num" id="LN961">961</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="962"><td class="num" id="LN962">962</td><td class="line">    <span class='keyword'>if</span> (level &lt; server.verbosity) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="963"><td class="num" id="LN963">963</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="964"><td class="num" id="LN964">964</td><td class="line">    <span class='comment'>/* Glue together all the arguments */</span></td></tr>
<tr class="codeline" data-linenumber="965"><td class="num" id="LN965">965</td><td class="line">    log = sdsempty();</td></tr>
<tr class="codeline" data-linenumber="966"><td class="num" id="LN966">966</td><td class="line">    <span class='keyword'>for</span> (j = 1; j &lt; argc; j++) {</td></tr>
<tr class="codeline" data-linenumber="967"><td class="num" id="LN967">967</td><td class="line">        size_t len;</td></tr>
<tr class="codeline" data-linenumber="968"><td class="num" id="LN968">968</td><td class="line">        <span class='keyword'>char</span> *s;</td></tr>
<tr class="codeline" data-linenumber="969"><td class="num" id="LN969">969</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="970"><td class="num" id="LN970">970</td><td class="line">        s = (<span class='keyword'>char</span>*)lua_tolstring(lua,(-argc)+j,&amp;len);</td></tr>
<tr class="codeline" data-linenumber="971"><td class="num" id="LN971">971</td><td class="line">        <span class='keyword'>if</span> (s) {</td></tr>
<tr class="codeline" data-linenumber="972"><td class="num" id="LN972">972</td><td class="line">            <span class='keyword'>if</span> (j != 1) log = sdscatlen(log,<span class='string_literal'>" "</span>,1);</td></tr>
<tr class="codeline" data-linenumber="973"><td class="num" id="LN973">973</td><td class="line">            log = sdscatlen(log,s,len);</td></tr>
<tr class="codeline" data-linenumber="974"><td class="num" id="LN974">974</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="975"><td class="num" id="LN975">975</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="976"><td class="num" id="LN976">976</td><td class="line">    serverLogRaw(level,log);</td></tr>
<tr class="codeline" data-linenumber="977"><td class="num" id="LN977">977</td><td class="line">    sdsfree(log);</td></tr>
<tr class="codeline" data-linenumber="978"><td class="num" id="LN978">978</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="979"><td class="num" id="LN979">979</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="980"><td class="num" id="LN980">980</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="981"><td class="num" id="LN981">981</td><td class="line"><span class='comment'>/* redis.setresp() */</span></td></tr>
<tr class="codeline" data-linenumber="982"><td class="num" id="LN982">982</td><td class="line"><span class='keyword'>int</span> luaSetResp(lua_State *lua) {</td></tr>
<tr class="codeline" data-linenumber="983"><td class="num" id="LN983">983</td><td class="line">    <span class='keyword'>int</span> argc = lua_gettop(lua);</td></tr>
<tr class="codeline" data-linenumber="984"><td class="num" id="LN984">984</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="985"><td class="num" id="LN985">985</td><td class="line">    <span class='keyword'>if</span> (argc != 1) {</td></tr>
<tr class="codeline" data-linenumber="986"><td class="num" id="LN986">986</td><td class="line">        lua_pushstring(lua, <span class='string_literal'>"redis.setresp() requires one argument."</span>);</td></tr>
<tr class="codeline" data-linenumber="987"><td class="num" id="LN987">987</td><td class="line">        <span class='keyword'>return</span> lua_error(lua);</td></tr>
<tr class="codeline" data-linenumber="988"><td class="num" id="LN988">988</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="989"><td class="num" id="LN989">989</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="990"><td class="num" id="LN990">990</td><td class="line">    <span class='keyword'>int</span> resp = lua_tonumber(lua,-argc);</td></tr>
<tr class="codeline" data-linenumber="991"><td class="num" id="LN991">991</td><td class="line">    <span class='keyword'>if</span> (resp != 2 &amp;&amp; resp != 3) {</td></tr>
<tr class="codeline" data-linenumber="992"><td class="num" id="LN992">992</td><td class="line">        lua_pushstring(lua, <span class='string_literal'>"RESP version must be 2 or 3."</span>);</td></tr>
<tr class="codeline" data-linenumber="993"><td class="num" id="LN993">993</td><td class="line">        <span class='keyword'>return</span> lua_error(lua);</td></tr>
<tr class="codeline" data-linenumber="994"><td class="num" id="LN994">994</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="995"><td class="num" id="LN995">995</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="996"><td class="num" id="LN996">996</td><td class="line">    server.lua_client-&gt;resp = resp;</td></tr>
<tr class="codeline" data-linenumber="997"><td class="num" id="LN997">997</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="998"><td class="num" id="LN998">998</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="999"><td class="num" id="LN999">999</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1000"><td class="num" id="LN1000">1000</td><td class="line"><span class='comment'>/* ---------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="1001"><td class="num" id="LN1001">1001</td><td class="line"> <span class='comment'>* Lua engine initialization and reset.</span></td></tr>
<tr class="codeline" data-linenumber="1002"><td class="num" id="LN1002">1002</td><td class="line"> <span class='comment'>* ------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="1003"><td class="num" id="LN1003">1003</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1004"><td class="num" id="LN1004">1004</td><td class="line"><span class='keyword'>void</span> luaLoadLib(lua_State *lua, <span class='keyword'>const</span> <span class='keyword'>char</span> *libname, lua_CFunction luafunc) {</td></tr>
<tr class="codeline" data-linenumber="1005"><td class="num" id="LN1005">1005</td><td class="line">  <span class='macro'>lua_pushcfunction(lua, luafunc)<span class='macro_popup'>lua_pushcclosure(lua, (luafunc), 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1006"><td class="num" id="LN1006">1006</td><td class="line">  lua_pushstring(lua, libname);</td></tr>
<tr class="codeline" data-linenumber="1007"><td class="num" id="LN1007">1007</td><td class="line">  lua_call(lua, 1, 0);</td></tr>
<tr class="codeline" data-linenumber="1008"><td class="num" id="LN1008">1008</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1009"><td class="num" id="LN1009">1009</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1010"><td class="num" id="LN1010">1010</td><td class="line"><span class='macro'>LUALIB_API<span class='macro_popup'>extern</span></span> <span class='keyword'>int</span> (luaopen_cjson) (lua_State *L);</td></tr>
<tr class="codeline" data-linenumber="1011"><td class="num" id="LN1011">1011</td><td class="line"><span class='macro'>LUALIB_API<span class='macro_popup'>extern</span></span> <span class='keyword'>int</span> (luaopen_struct) (lua_State *L);</td></tr>
<tr class="codeline" data-linenumber="1012"><td class="num" id="LN1012">1012</td><td class="line"><span class='macro'>LUALIB_API<span class='macro_popup'>extern</span></span> <span class='keyword'>int</span> (luaopen_cmsgpack) (lua_State *L);</td></tr>
<tr class="codeline" data-linenumber="1013"><td class="num" id="LN1013">1013</td><td class="line"><span class='macro'>LUALIB_API<span class='macro_popup'>extern</span></span> <span class='keyword'>int</span> (luaopen_bit) (lua_State *L);</td></tr>
<tr class="codeline" data-linenumber="1014"><td class="num" id="LN1014">1014</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1015"><td class="num" id="LN1015">1015</td><td class="line"><span class='keyword'>void</span> luaLoadLibraries(lua_State *lua) {</td></tr>
<tr class="codeline" data-linenumber="1016"><td class="num" id="LN1016">1016</td><td class="line">    luaLoadLib(lua, <span class='string_literal'>""</span>, luaopen_base);</td></tr>
<tr class="codeline" data-linenumber="1017"><td class="num" id="LN1017">1017</td><td class="line">    luaLoadLib(lua, <span class='macro'>LUA_TABLIBNAME<span class='macro_popup'>"table"</span></span>, luaopen_table);</td></tr>
<tr class="codeline" data-linenumber="1018"><td class="num" id="LN1018">1018</td><td class="line">    luaLoadLib(lua, <span class='macro'>LUA_STRLIBNAME<span class='macro_popup'>"string"</span></span>, luaopen_string);</td></tr>
<tr class="codeline" data-linenumber="1019"><td class="num" id="LN1019">1019</td><td class="line">    luaLoadLib(lua, <span class='macro'>LUA_MATHLIBNAME<span class='macro_popup'>"math"</span></span>, luaopen_math);</td></tr>
<tr class="codeline" data-linenumber="1020"><td class="num" id="LN1020">1020</td><td class="line">    luaLoadLib(lua, <span class='macro'>LUA_DBLIBNAME<span class='macro_popup'>"debug"</span></span>, luaopen_debug);</td></tr>
<tr class="codeline" data-linenumber="1021"><td class="num" id="LN1021">1021</td><td class="line">    luaLoadLib(lua, <span class='string_literal'>"cjson"</span>, luaopen_cjson);</td></tr>
<tr class="codeline" data-linenumber="1022"><td class="num" id="LN1022">1022</td><td class="line">    luaLoadLib(lua, <span class='string_literal'>"struct"</span>, luaopen_struct);</td></tr>
<tr class="codeline" data-linenumber="1023"><td class="num" id="LN1023">1023</td><td class="line">    luaLoadLib(lua, <span class='string_literal'>"cmsgpack"</span>, luaopen_cmsgpack);</td></tr>
<tr class="codeline" data-linenumber="1024"><td class="num" id="LN1024">1024</td><td class="line">    luaLoadLib(lua, <span class='string_literal'>"bit"</span>, luaopen_bit);</td></tr>
<tr class="codeline" data-linenumber="1025"><td class="num" id="LN1025">1025</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1026"><td class="num" id="LN1026">1026</td><td class="line"><span class='directive'>#if 0 /* Stuff that we don't load currently, for sandboxing concerns. */</span></td></tr>
<tr class="codeline" data-linenumber="1027"><td class="num" id="LN1027">1027</td><td class="line">    luaLoadLib(lua, <span class='macro'>LUA_LOADLIBNAME<span class='macro_popup'>"package"</span></span>, luaopen_package);</td></tr>
<tr class="codeline" data-linenumber="1028"><td class="num" id="LN1028">1028</td><td class="line">    luaLoadLib(lua, <span class='macro'>LUA_OSLIBNAME<span class='macro_popup'>"os"</span></span>, luaopen_os);</td></tr>
<tr class="codeline" data-linenumber="1029"><td class="num" id="LN1029">1029</td><td class="line"><span class='directive'>#endif</span></td></tr>
<tr class="codeline" data-linenumber="1030"><td class="num" id="LN1030">1030</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1031"><td class="num" id="LN1031">1031</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1032"><td class="num" id="LN1032">1032</td><td class="line"><span class='comment'>/* Remove a functions that we don't want to expose to the Redis scripting</span></td></tr>
<tr class="codeline" data-linenumber="1033"><td class="num" id="LN1033">1033</td><td class="line"> <span class='comment'>* environment. */</span></td></tr>
<tr class="codeline" data-linenumber="1034"><td class="num" id="LN1034">1034</td><td class="line"><span class='keyword'>void</span> luaRemoveUnsupportedFunctions(lua_State *lua) {</td></tr>
<tr class="codeline" data-linenumber="1035"><td class="num" id="LN1035">1035</td><td class="line">    lua_pushnil(lua);</td></tr>
<tr class="codeline" data-linenumber="1036"><td class="num" id="LN1036">1036</td><td class="line">    <span class='macro'>lua_setglobal(lua,<span class='string_literal'>"loadfile"</span>)<span class='macro_popup'>lua_setfield(lua, (-10002), ("loadfile"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1037"><td class="num" id="LN1037">1037</td><td class="line">    lua_pushnil(lua);</td></tr>
<tr class="codeline" data-linenumber="1038"><td class="num" id="LN1038">1038</td><td class="line">    <span class='macro'>lua_setglobal(lua,<span class='string_literal'>"dofile"</span>)<span class='macro_popup'>lua_setfield(lua, (-10002), ("dofile"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1039"><td class="num" id="LN1039">1039</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1040"><td class="num" id="LN1040">1040</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1041"><td class="num" id="LN1041">1041</td><td class="line"><span class='comment'>/* This function installs metamethods in the global table _G that prevent</span></td></tr>
<tr class="codeline" data-linenumber="1042"><td class="num" id="LN1042">1042</td><td class="line"> <span class='comment'>* the creation of globals accidentally.</span></td></tr>
<tr class="codeline" data-linenumber="1043"><td class="num" id="LN1043">1043</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1044"><td class="num" id="LN1044">1044</td><td class="line"> <span class='comment'>* It should be the last to be called in the scripting engine initialization</span></td></tr>
<tr class="codeline" data-linenumber="1045"><td class="num" id="LN1045">1045</td><td class="line"> <span class='comment'>* sequence, because it may interact with creation of globals. */</span></td></tr>
<tr class="codeline" data-linenumber="1046"><td class="num" id="LN1046">1046</td><td class="line"><span class='keyword'>void</span> scriptingEnableGlobalsProtection(lua_State *lua) {</td></tr>
<tr class="codeline" data-linenumber="1047"><td class="num" id="LN1047">1047</td><td class="line">    <span class='keyword'>char</span> *s[32];</td></tr>
<tr class="codeline" data-linenumber="1048"><td class="num" id="LN1048">1048</td><td class="line">    sds code = sdsempty();</td></tr>
<tr class="codeline" data-linenumber="1049"><td class="num" id="LN1049">1049</td><td class="line">    <span class='keyword'>int</span> j = 0;</td></tr>
<tr class="codeline" data-linenumber="1050"><td class="num" id="LN1050">1050</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1051"><td class="num" id="LN1051">1051</td><td class="line">    <span class='comment'>/* strict.lua from: http://metalua.luaforge.net/src/lib/strict.lua.html.</span></td></tr>
<tr class="codeline" data-linenumber="1052"><td class="num" id="LN1052">1052</td><td class="line">     <span class='comment'>* Modified to be adapted to Redis. */</span></td></tr>
<tr class="codeline" data-linenumber="1053"><td class="num" id="LN1053">1053</td><td class="line">    s[j++]=<span class='string_literal'>"local dbg=debug\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1054"><td class="num" id="LN1054">1054</td><td class="line">    s[j++]=<span class='string_literal'>"local mt = {}\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1055"><td class="num" id="LN1055">1055</td><td class="line">    s[j++]=<span class='string_literal'>"setmetatable(_G, mt)\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1056"><td class="num" id="LN1056">1056</td><td class="line">    s[j++]=<span class='string_literal'>"mt.__newindex = function (t, n, v)\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1057"><td class="num" id="LN1057">1057</td><td class="line">    s[j++]=<span class='string_literal'>"  if dbg.getinfo(2) then\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1058"><td class="num" id="LN1058">1058</td><td class="line">    s[j++]=<span class='string_literal'>"    local w = dbg.getinfo(2, \"S\").what\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1059"><td class="num" id="LN1059">1059</td><td class="line">    s[j++]=<span class='string_literal'>"    if w ~= \"main\" and w ~= \"C\" then\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1060"><td class="num" id="LN1060">1060</td><td class="line">    s[j++]=<span class='string_literal'>"      error(\"Script attempted to create global variable '\"..tostring(n)..\"'\", 2)\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1061"><td class="num" id="LN1061">1061</td><td class="line">    s[j++]=<span class='string_literal'>"    end\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1062"><td class="num" id="LN1062">1062</td><td class="line">    s[j++]=<span class='string_literal'>"  end\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1063"><td class="num" id="LN1063">1063</td><td class="line">    s[j++]=<span class='string_literal'>"  rawset(t, n, v)\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1064"><td class="num" id="LN1064">1064</td><td class="line">    s[j++]=<span class='string_literal'>"end\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1065"><td class="num" id="LN1065">1065</td><td class="line">    s[j++]=<span class='string_literal'>"mt.__index = function (t, n)\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1066"><td class="num" id="LN1066">1066</td><td class="line">    s[j++]=<span class='string_literal'>"  if dbg.getinfo(2) and dbg.getinfo(2, \"S\").what ~= \"C\" then\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1067"><td class="num" id="LN1067">1067</td><td class="line">    s[j++]=<span class='string_literal'>"    error(\"Script attempted to access nonexistent global variable '\"..tostring(n)..\"'\", 2)\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1068"><td class="num" id="LN1068">1068</td><td class="line">    s[j++]=<span class='string_literal'>"  end\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1069"><td class="num" id="LN1069">1069</td><td class="line">    s[j++]=<span class='string_literal'>"  return rawget(t, n)\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1070"><td class="num" id="LN1070">1070</td><td class="line">    s[j++]=<span class='string_literal'>"end\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1071"><td class="num" id="LN1071">1071</td><td class="line">    s[j++]=<span class='string_literal'>"debug = nil\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1072"><td class="num" id="LN1072">1072</td><td class="line">    s[j++]=<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1073"><td class="num" id="LN1073">1073</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1074"><td class="num" id="LN1074">1074</td><td class="line">    <span class='keyword'>for</span> (j = 0; s[j] != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>; j++) code = sdscatlen(code,s[j],strlen(s[j]));</td></tr>
<tr class="codeline" data-linenumber="1075"><td class="num" id="LN1075">1075</td><td class="line">    luaL_loadbuffer(lua,code,sdslen(code),<span class='string_literal'>"@enable_strict_lua"</span>);</td></tr>
<tr class="codeline" data-linenumber="1076"><td class="num" id="LN1076">1076</td><td class="line">    lua_pcall(lua,0,0,0);</td></tr>
<tr class="codeline" data-linenumber="1077"><td class="num" id="LN1077">1077</td><td class="line">    sdsfree(code);</td></tr>
<tr class="codeline" data-linenumber="1078"><td class="num" id="LN1078">1078</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1079"><td class="num" id="LN1079">1079</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1080"><td class="num" id="LN1080">1080</td><td class="line"><span class='comment'>/* Initialize the scripting environment.</span></td></tr>
<tr class="codeline" data-linenumber="1081"><td class="num" id="LN1081">1081</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1082"><td class="num" id="LN1082">1082</td><td class="line"> <span class='comment'>* This function is called the first time at server startup with</span></td></tr>
<tr class="codeline" data-linenumber="1083"><td class="num" id="LN1083">1083</td><td class="line"> <span class='comment'>* the 'setup' argument set to 1.</span></td></tr>
<tr class="codeline" data-linenumber="1084"><td class="num" id="LN1084">1084</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1085"><td class="num" id="LN1085">1085</td><td class="line"> <span class='comment'>* It can be called again multiple times during the lifetime of the Redis</span></td></tr>
<tr class="codeline" data-linenumber="1086"><td class="num" id="LN1086">1086</td><td class="line"> <span class='comment'>* process, with 'setup' set to 0, and following a scriptingRelease() call,</span></td></tr>
<tr class="codeline" data-linenumber="1087"><td class="num" id="LN1087">1087</td><td class="line"> <span class='comment'>* in order to reset the Lua scripting environment.</span></td></tr>
<tr class="codeline" data-linenumber="1088"><td class="num" id="LN1088">1088</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1089"><td class="num" id="LN1089">1089</td><td class="line"> <span class='comment'>* However it is simpler to just call scriptingReset() that does just that. */</span></td></tr>
<tr class="codeline" data-linenumber="1090"><td class="num" id="LN1090">1090</td><td class="line"><span class='keyword'>void</span> scriptingInit(<span class='keyword'>int</span> setup) {</td></tr>
<tr class="codeline" data-linenumber="1091"><td class="num" id="LN1091">1091</td><td class="line">    lua_State *lua = <span class='macro'>lua_open()<span class='macro_popup'>luaL_newstate()</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1092"><td class="num" id="LN1092">1092</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1093"><td class="num" id="LN1093">1093</td><td class="line">    <span class='keyword'>if</span> (setup) {</td></tr>
<tr class="codeline" data-linenumber="1094"><td class="num" id="LN1094">1094</td><td class="line">        server.lua_client = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1095"><td class="num" id="LN1095">1095</td><td class="line">        server.lua_caller = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1096"><td class="num" id="LN1096">1096</td><td class="line">        server.lua_cur_script = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1097"><td class="num" id="LN1097">1097</td><td class="line">        server.lua_timedout = 0;</td></tr>
<tr class="codeline" data-linenumber="1098"><td class="num" id="LN1098">1098</td><td class="line">        ldbInit();</td></tr>
<tr class="codeline" data-linenumber="1099"><td class="num" id="LN1099">1099</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1100"><td class="num" id="LN1100">1100</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1101"><td class="num" id="LN1101">1101</td><td class="line">    luaLoadLibraries(lua);</td></tr>
<tr class="codeline" data-linenumber="1102"><td class="num" id="LN1102">1102</td><td class="line">    luaRemoveUnsupportedFunctions(lua);</td></tr>
<tr class="codeline" data-linenumber="1103"><td class="num" id="LN1103">1103</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1104"><td class="num" id="LN1104">1104</td><td class="line">    <span class='comment'>/* Initialize a dictionary we use to map SHAs to scripts.</span></td></tr>
<tr class="codeline" data-linenumber="1105"><td class="num" id="LN1105">1105</td><td class="line">     <span class='comment'>* This is useful for replication, as we need to replicate EVALSHA</span></td></tr>
<tr class="codeline" data-linenumber="1106"><td class="num" id="LN1106">1106</td><td class="line">     <span class='comment'>* as EVAL, so we need to remember the associated script. */</span></td></tr>
<tr class="codeline" data-linenumber="1107"><td class="num" id="LN1107">1107</td><td class="line">    server.lua_scripts = dictCreate(&amp;shaScriptObjectDictType,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1108"><td class="num" id="LN1108">1108</td><td class="line">    server.lua_scripts_mem = 0;</td></tr>
<tr class="codeline" data-linenumber="1109"><td class="num" id="LN1109">1109</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1110"><td class="num" id="LN1110">1110</td><td class="line">    <span class='comment'>/* Register the redis commands table and fields */</span></td></tr>
<tr class="codeline" data-linenumber="1111"><td class="num" id="LN1111">1111</td><td class="line">    <span class='macro'>lua_newtable(lua)<span class='macro_popup'>lua_createtable(lua, 0, 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1112"><td class="num" id="LN1112">1112</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1113"><td class="num" id="LN1113">1113</td><td class="line">    <span class='comment'>/* redis.call */</span></td></tr>
<tr class="codeline" data-linenumber="1114"><td class="num" id="LN1114">1114</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"call"</span>);</td></tr>
<tr class="codeline" data-linenumber="1115"><td class="num" id="LN1115">1115</td><td class="line">    <span class='macro'>lua_pushcfunction(lua,luaRedisCallCommand)<span class='macro_popup'>lua_pushcclosure(lua, (luaRedisCallCommand), 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1116"><td class="num" id="LN1116">1116</td><td class="line">    lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="1117"><td class="num" id="LN1117">1117</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1118"><td class="num" id="LN1118">1118</td><td class="line">    <span class='comment'>/* redis.pcall */</span></td></tr>
<tr class="codeline" data-linenumber="1119"><td class="num" id="LN1119">1119</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"pcall"</span>);</td></tr>
<tr class="codeline" data-linenumber="1120"><td class="num" id="LN1120">1120</td><td class="line">    <span class='macro'>lua_pushcfunction(lua,luaRedisPCallCommand)<span class='macro_popup'>lua_pushcclosure(lua, (luaRedisPCallCommand), 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1121"><td class="num" id="LN1121">1121</td><td class="line">    lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="1122"><td class="num" id="LN1122">1122</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1123"><td class="num" id="LN1123">1123</td><td class="line">    <span class='comment'>/* redis.log and log levels. */</span></td></tr>
<tr class="codeline" data-linenumber="1124"><td class="num" id="LN1124">1124</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"log"</span>);</td></tr>
<tr class="codeline" data-linenumber="1125"><td class="num" id="LN1125">1125</td><td class="line">    <span class='macro'>lua_pushcfunction(lua,luaLogCommand)<span class='macro_popup'>lua_pushcclosure(lua, (luaLogCommand), 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1126"><td class="num" id="LN1126">1126</td><td class="line">    lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="1127"><td class="num" id="LN1127">1127</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1128"><td class="num" id="LN1128">1128</td><td class="line">    <span class='comment'>/* redis.setresp */</span></td></tr>
<tr class="codeline" data-linenumber="1129"><td class="num" id="LN1129">1129</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"setresp"</span>);</td></tr>
<tr class="codeline" data-linenumber="1130"><td class="num" id="LN1130">1130</td><td class="line">    <span class='macro'>lua_pushcfunction(lua,luaSetResp)<span class='macro_popup'>lua_pushcclosure(lua, (luaSetResp), 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1131"><td class="num" id="LN1131">1131</td><td class="line">    lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="1132"><td class="num" id="LN1132">1132</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1133"><td class="num" id="LN1133">1133</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"LOG_DEBUG"</span>);</td></tr>
<tr class="codeline" data-linenumber="1134"><td class="num" id="LN1134">1134</td><td class="line">    lua_pushnumber(lua,<span class='macro'>LL_DEBUG<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1135"><td class="num" id="LN1135">1135</td><td class="line">    lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="1136"><td class="num" id="LN1136">1136</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1137"><td class="num" id="LN1137">1137</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"LOG_VERBOSE"</span>);</td></tr>
<tr class="codeline" data-linenumber="1138"><td class="num" id="LN1138">1138</td><td class="line">    lua_pushnumber(lua,<span class='macro'>LL_VERBOSE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1139"><td class="num" id="LN1139">1139</td><td class="line">    lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="1140"><td class="num" id="LN1140">1140</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1141"><td class="num" id="LN1141">1141</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"LOG_NOTICE"</span>);</td></tr>
<tr class="codeline" data-linenumber="1142"><td class="num" id="LN1142">1142</td><td class="line">    lua_pushnumber(lua,<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1143"><td class="num" id="LN1143">1143</td><td class="line">    lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="1144"><td class="num" id="LN1144">1144</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1145"><td class="num" id="LN1145">1145</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"LOG_WARNING"</span>);</td></tr>
<tr class="codeline" data-linenumber="1146"><td class="num" id="LN1146">1146</td><td class="line">    lua_pushnumber(lua,<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1147"><td class="num" id="LN1147">1147</td><td class="line">    lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="1148"><td class="num" id="LN1148">1148</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1149"><td class="num" id="LN1149">1149</td><td class="line">    <span class='comment'>/* redis.sha1hex */</span></td></tr>
<tr class="codeline" data-linenumber="1150"><td class="num" id="LN1150">1150</td><td class="line">    lua_pushstring(lua, <span class='string_literal'>"sha1hex"</span>);</td></tr>
<tr class="codeline" data-linenumber="1151"><td class="num" id="LN1151">1151</td><td class="line">    <span class='macro'>lua_pushcfunction(lua, luaRedisSha1hexCommand)<span class='macro_popup'>lua_pushcclosure(lua, (luaRedisSha1hexCommand), 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1152"><td class="num" id="LN1152">1152</td><td class="line">    lua_settable(lua, -3);</td></tr>
<tr class="codeline" data-linenumber="1153"><td class="num" id="LN1153">1153</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1154"><td class="num" id="LN1154">1154</td><td class="line">    <span class='comment'>/* redis.error_reply and redis.status_reply */</span></td></tr>
<tr class="codeline" data-linenumber="1155"><td class="num" id="LN1155">1155</td><td class="line">    lua_pushstring(lua, <span class='string_literal'>"error_reply"</span>);</td></tr>
<tr class="codeline" data-linenumber="1156"><td class="num" id="LN1156">1156</td><td class="line">    <span class='macro'>lua_pushcfunction(lua, luaRedisErrorReplyCommand)<span class='macro_popup'>lua_pushcclosure(lua, (luaRedisErrorReplyCommand), 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1157"><td class="num" id="LN1157">1157</td><td class="line">    lua_settable(lua, -3);</td></tr>
<tr class="codeline" data-linenumber="1158"><td class="num" id="LN1158">1158</td><td class="line">    lua_pushstring(lua, <span class='string_literal'>"status_reply"</span>);</td></tr>
<tr class="codeline" data-linenumber="1159"><td class="num" id="LN1159">1159</td><td class="line">    <span class='macro'>lua_pushcfunction(lua, luaRedisStatusReplyCommand)<span class='macro_popup'>lua_pushcclosure(lua, (luaRedisStatusReplyCommand), 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1160"><td class="num" id="LN1160">1160</td><td class="line">    lua_settable(lua, -3);</td></tr>
<tr class="codeline" data-linenumber="1161"><td class="num" id="LN1161">1161</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1162"><td class="num" id="LN1162">1162</td><td class="line">    <span class='comment'>/* redis.replicate_commands */</span></td></tr>
<tr class="codeline" data-linenumber="1163"><td class="num" id="LN1163">1163</td><td class="line">    lua_pushstring(lua, <span class='string_literal'>"replicate_commands"</span>);</td></tr>
<tr class="codeline" data-linenumber="1164"><td class="num" id="LN1164">1164</td><td class="line">    <span class='macro'>lua_pushcfunction(lua, luaRedisReplicateCommandsCommand)<span class='macro_popup'>lua_pushcclosure(lua, (luaRedisReplicateCommandsCommand), 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1165"><td class="num" id="LN1165">1165</td><td class="line">    lua_settable(lua, -3);</td></tr>
<tr class="codeline" data-linenumber="1166"><td class="num" id="LN1166">1166</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1167"><td class="num" id="LN1167">1167</td><td class="line">    <span class='comment'>/* redis.set_repl and associated flags. */</span></td></tr>
<tr class="codeline" data-linenumber="1168"><td class="num" id="LN1168">1168</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"set_repl"</span>);</td></tr>
<tr class="codeline" data-linenumber="1169"><td class="num" id="LN1169">1169</td><td class="line">    <span class='macro'>lua_pushcfunction(lua,luaRedisSetReplCommand)<span class='macro_popup'>lua_pushcclosure(lua, (luaRedisSetReplCommand), 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1170"><td class="num" id="LN1170">1170</td><td class="line">    lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="1171"><td class="num" id="LN1171">1171</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1172"><td class="num" id="LN1172">1172</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"REPL_NONE"</span>);</td></tr>
<tr class="codeline" data-linenumber="1173"><td class="num" id="LN1173">1173</td><td class="line">    lua_pushnumber(lua,<span class='macro'>PROPAGATE_NONE<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1174"><td class="num" id="LN1174">1174</td><td class="line">    lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="1175"><td class="num" id="LN1175">1175</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1176"><td class="num" id="LN1176">1176</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"REPL_AOF"</span>);</td></tr>
<tr class="codeline" data-linenumber="1177"><td class="num" id="LN1177">1177</td><td class="line">    lua_pushnumber(lua,<span class='macro'>PROPAGATE_AOF<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1178"><td class="num" id="LN1178">1178</td><td class="line">    lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="1179"><td class="num" id="LN1179">1179</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1180"><td class="num" id="LN1180">1180</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"REPL_SLAVE"</span>);</td></tr>
<tr class="codeline" data-linenumber="1181"><td class="num" id="LN1181">1181</td><td class="line">    lua_pushnumber(lua,<span class='macro'>PROPAGATE_REPL<span class='macro_popup'>2</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1182"><td class="num" id="LN1182">1182</td><td class="line">    lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="1183"><td class="num" id="LN1183">1183</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1184"><td class="num" id="LN1184">1184</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"REPL_REPLICA"</span>);</td></tr>
<tr class="codeline" data-linenumber="1185"><td class="num" id="LN1185">1185</td><td class="line">    lua_pushnumber(lua,<span class='macro'>PROPAGATE_REPL<span class='macro_popup'>2</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1186"><td class="num" id="LN1186">1186</td><td class="line">    lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="1187"><td class="num" id="LN1187">1187</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1188"><td class="num" id="LN1188">1188</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"REPL_ALL"</span>);</td></tr>
<tr class="codeline" data-linenumber="1189"><td class="num" id="LN1189">1189</td><td class="line">    lua_pushnumber(lua,<span class='macro'>PROPAGATE_AOF<span class='macro_popup'>1</span></span>|<span class='macro'>PROPAGATE_REPL<span class='macro_popup'>2</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1190"><td class="num" id="LN1190">1190</td><td class="line">    lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="1191"><td class="num" id="LN1191">1191</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1192"><td class="num" id="LN1192">1192</td><td class="line">    <span class='comment'>/* redis.breakpoint */</span></td></tr>
<tr class="codeline" data-linenumber="1193"><td class="num" id="LN1193">1193</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"breakpoint"</span>);</td></tr>
<tr class="codeline" data-linenumber="1194"><td class="num" id="LN1194">1194</td><td class="line">    <span class='macro'>lua_pushcfunction(lua,luaRedisBreakpointCommand)<span class='macro_popup'>lua_pushcclosure(lua, (luaRedisBreakpointCommand), 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1195"><td class="num" id="LN1195">1195</td><td class="line">    lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="1196"><td class="num" id="LN1196">1196</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1197"><td class="num" id="LN1197">1197</td><td class="line">    <span class='comment'>/* redis.debug */</span></td></tr>
<tr class="codeline" data-linenumber="1198"><td class="num" id="LN1198">1198</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"debug"</span>);</td></tr>
<tr class="codeline" data-linenumber="1199"><td class="num" id="LN1199">1199</td><td class="line">    <span class='macro'>lua_pushcfunction(lua,luaRedisDebugCommand)<span class='macro_popup'>lua_pushcclosure(lua, (luaRedisDebugCommand), 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1200"><td class="num" id="LN1200">1200</td><td class="line">    lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="1201"><td class="num" id="LN1201">1201</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1202"><td class="num" id="LN1202">1202</td><td class="line">    <span class='comment'>/* Finally set the table as 'redis' global var. */</span></td></tr>
<tr class="codeline" data-linenumber="1203"><td class="num" id="LN1203">1203</td><td class="line">    <span class='macro'>lua_setglobal(lua,<span class='string_literal'>"redis"</span>)<span class='macro_popup'>lua_setfield(lua, (-10002), ("redis"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1204"><td class="num" id="LN1204">1204</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1205"><td class="num" id="LN1205">1205</td><td class="line">    <span class='comment'>/* Replace math.random and math.randomseed with our implementations. */</span></td></tr>
<tr class="codeline" data-linenumber="1206"><td class="num" id="LN1206">1206</td><td class="line">    <span class='macro'>lua_getglobal(lua,<span class='string_literal'>"math"</span>)<span class='macro_popup'>lua_getfield(lua, (-10002), ("math"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1207"><td class="num" id="LN1207">1207</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1208"><td class="num" id="LN1208">1208</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"random"</span>);</td></tr>
<tr class="codeline" data-linenumber="1209"><td class="num" id="LN1209">1209</td><td class="line">    <span class='macro'>lua_pushcfunction(lua,redis_math_random)<span class='macro_popup'>lua_pushcclosure(lua, (redis_math_random), 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1210"><td class="num" id="LN1210">1210</td><td class="line">    lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="1211"><td class="num" id="LN1211">1211</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1212"><td class="num" id="LN1212">1212</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"randomseed"</span>);</td></tr>
<tr class="codeline" data-linenumber="1213"><td class="num" id="LN1213">1213</td><td class="line">    <span class='macro'>lua_pushcfunction(lua,redis_math_randomseed)<span class='macro_popup'>lua_pushcclosure(lua, (redis_math_randomseed), 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1214"><td class="num" id="LN1214">1214</td><td class="line">    lua_settable(lua,-3);</td></tr>
<tr class="codeline" data-linenumber="1215"><td class="num" id="LN1215">1215</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1216"><td class="num" id="LN1216">1216</td><td class="line">    <span class='macro'>lua_setglobal(lua,<span class='string_literal'>"math"</span>)<span class='macro_popup'>lua_setfield(lua, (-10002), ("math"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1217"><td class="num" id="LN1217">1217</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1218"><td class="num" id="LN1218">1218</td><td class="line">    <span class='comment'>/* Add a helper function that we use to sort the multi bulk output of non</span></td></tr>
<tr class="codeline" data-linenumber="1219"><td class="num" id="LN1219">1219</td><td class="line">     <span class='comment'>* deterministic commands, when containing 'false' elements. */</span></td></tr>
<tr class="codeline" data-linenumber="1220"><td class="num" id="LN1220">1220</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1221"><td class="num" id="LN1221">1221</td><td class="line">        <span class='keyword'>char</span> *compare_func =    <span class='string_literal'>"function __redis__compare_helper(a,b)\n"</span></td></tr>
<tr class="codeline" data-linenumber="1222"><td class="num" id="LN1222">1222</td><td class="line">                                <span class='string_literal'>"  if a == false then a = '' end\n"</span></td></tr>
<tr class="codeline" data-linenumber="1223"><td class="num" id="LN1223">1223</td><td class="line">                                <span class='string_literal'>"  if b == false then b = '' end\n"</span></td></tr>
<tr class="codeline" data-linenumber="1224"><td class="num" id="LN1224">1224</td><td class="line">                                <span class='string_literal'>"  return a&lt;b\n"</span></td></tr>
<tr class="codeline" data-linenumber="1225"><td class="num" id="LN1225">1225</td><td class="line">                                <span class='string_literal'>"end\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1226"><td class="num" id="LN1226">1226</td><td class="line">        luaL_loadbuffer(lua,compare_func,strlen(compare_func),<span class='string_literal'>"@cmp_func_def"</span>);</td></tr>
<tr class="codeline" data-linenumber="1227"><td class="num" id="LN1227">1227</td><td class="line">        lua_pcall(lua,0,0,0);</td></tr>
<tr class="codeline" data-linenumber="1228"><td class="num" id="LN1228">1228</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1229"><td class="num" id="LN1229">1229</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1230"><td class="num" id="LN1230">1230</td><td class="line">    <span class='comment'>/* Add a helper function we use for pcall error reporting.</span></td></tr>
<tr class="codeline" data-linenumber="1231"><td class="num" id="LN1231">1231</td><td class="line">     <span class='comment'>* Note that when the error is in the C function we want to report the</span></td></tr>
<tr class="codeline" data-linenumber="1232"><td class="num" id="LN1232">1232</td><td class="line">     <span class='comment'>* information about the caller, that's what makes sense from the point</span></td></tr>
<tr class="codeline" data-linenumber="1233"><td class="num" id="LN1233">1233</td><td class="line">     <span class='comment'>* of view of the user debugging a script. */</span></td></tr>
<tr class="codeline" data-linenumber="1234"><td class="num" id="LN1234">1234</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1235"><td class="num" id="LN1235">1235</td><td class="line">        <span class='keyword'>char</span> *errh_func =       <span class='string_literal'>"local dbg = debug\n"</span></td></tr>
<tr class="codeline" data-linenumber="1236"><td class="num" id="LN1236">1236</td><td class="line">                                <span class='string_literal'>"function __redis__err__handler(err)\n"</span></td></tr>
<tr class="codeline" data-linenumber="1237"><td class="num" id="LN1237">1237</td><td class="line">                                <span class='string_literal'>"  local i = dbg.getinfo(2,'nSl')\n"</span></td></tr>
<tr class="codeline" data-linenumber="1238"><td class="num" id="LN1238">1238</td><td class="line">                                <span class='string_literal'>"  if i and i.what == 'C' then\n"</span></td></tr>
<tr class="codeline" data-linenumber="1239"><td class="num" id="LN1239">1239</td><td class="line">                                <span class='string_literal'>"    i = dbg.getinfo(3,'nSl')\n"</span></td></tr>
<tr class="codeline" data-linenumber="1240"><td class="num" id="LN1240">1240</td><td class="line">                                <span class='string_literal'>"  end\n"</span></td></tr>
<tr class="codeline" data-linenumber="1241"><td class="num" id="LN1241">1241</td><td class="line">                                <span class='string_literal'>"  if i then\n"</span></td></tr>
<tr class="codeline" data-linenumber="1242"><td class="num" id="LN1242">1242</td><td class="line">                                <span class='string_literal'>"    return i.source .. ':' .. i.currentline .. ': ' .. err\n"</span></td></tr>
<tr class="codeline" data-linenumber="1243"><td class="num" id="LN1243">1243</td><td class="line">                                <span class='string_literal'>"  else\n"</span></td></tr>
<tr class="codeline" data-linenumber="1244"><td class="num" id="LN1244">1244</td><td class="line">                                <span class='string_literal'>"    return err\n"</span></td></tr>
<tr class="codeline" data-linenumber="1245"><td class="num" id="LN1245">1245</td><td class="line">                                <span class='string_literal'>"  end\n"</span></td></tr>
<tr class="codeline" data-linenumber="1246"><td class="num" id="LN1246">1246</td><td class="line">                                <span class='string_literal'>"end\n"</span>;</td></tr>
<tr class="codeline" data-linenumber="1247"><td class="num" id="LN1247">1247</td><td class="line">        luaL_loadbuffer(lua,errh_func,strlen(errh_func),<span class='string_literal'>"@err_handler_def"</span>);</td></tr>
<tr class="codeline" data-linenumber="1248"><td class="num" id="LN1248">1248</td><td class="line">        lua_pcall(lua,0,0,0);</td></tr>
<tr class="codeline" data-linenumber="1249"><td class="num" id="LN1249">1249</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1250"><td class="num" id="LN1250">1250</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1251"><td class="num" id="LN1251">1251</td><td class="line">    <span class='comment'>/* Create the (non connected) client that we use to execute Redis commands</span></td></tr>
<tr class="codeline" data-linenumber="1252"><td class="num" id="LN1252">1252</td><td class="line">     <span class='comment'>* inside the Lua interpreter.</span></td></tr>
<tr class="codeline" data-linenumber="1253"><td class="num" id="LN1253">1253</td><td class="line">     <span class='comment'>* Note: there is no need to create it again when this function is called</span></td></tr>
<tr class="codeline" data-linenumber="1254"><td class="num" id="LN1254">1254</td><td class="line">     <span class='comment'>* by scriptingReset(). */</span></td></tr>
<tr class="codeline" data-linenumber="1255"><td class="num" id="LN1255">1255</td><td class="line">    <span class='keyword'>if</span> (server.lua_client == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1256"><td class="num" id="LN1256">1256</td><td class="line">        server.lua_client = createClient(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1257"><td class="num" id="LN1257">1257</td><td class="line">        server.lua_client-&gt;flags |= <span class='macro'>CLIENT_LUA<span class='macro_popup'>(1&lt;&lt;8)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1258"><td class="num" id="LN1258">1258</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1259"><td class="num" id="LN1259">1259</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1260"><td class="num" id="LN1260">1260</td><td class="line">    <span class='comment'>/* Lua beginners often don't use "local", this is likely to introduce</span></td></tr>
<tr class="codeline" data-linenumber="1261"><td class="num" id="LN1261">1261</td><td class="line">     <span class='comment'>* subtle bugs in their code. To prevent problems we protect accesses</span></td></tr>
<tr class="codeline" data-linenumber="1262"><td class="num" id="LN1262">1262</td><td class="line">     <span class='comment'>* to global variables. */</span></td></tr>
<tr class="codeline" data-linenumber="1263"><td class="num" id="LN1263">1263</td><td class="line">    scriptingEnableGlobalsProtection(lua);</td></tr>
<tr class="codeline" data-linenumber="1264"><td class="num" id="LN1264">1264</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1265"><td class="num" id="LN1265">1265</td><td class="line">    server.lua = lua;</td></tr>
<tr class="codeline" data-linenumber="1266"><td class="num" id="LN1266">1266</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1267"><td class="num" id="LN1267">1267</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1268"><td class="num" id="LN1268">1268</td><td class="line"><span class='comment'>/* Release resources related to Lua scripting.</span></td></tr>
<tr class="codeline" data-linenumber="1269"><td class="num" id="LN1269">1269</td><td class="line"> <span class='comment'>* This function is used in order to reset the scripting environment. */</span></td></tr>
<tr class="codeline" data-linenumber="1270"><td class="num" id="LN1270">1270</td><td class="line"><span class='keyword'>void</span> scriptingRelease(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1271"><td class="num" id="LN1271">1271</td><td class="line">    dictRelease(server.lua_scripts);</td></tr>
<tr class="codeline" data-linenumber="1272"><td class="num" id="LN1272">1272</td><td class="line">    server.lua_scripts_mem = 0;</td></tr>
<tr class="codeline" data-linenumber="1273"><td class="num" id="LN1273">1273</td><td class="line">    lua_close(server.lua);</td></tr>
<tr class="codeline" data-linenumber="1274"><td class="num" id="LN1274">1274</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1275"><td class="num" id="LN1275">1275</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1276"><td class="num" id="LN1276">1276</td><td class="line"><span class='keyword'>void</span> scriptingReset(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1277"><td class="num" id="LN1277">1277</td><td class="line">    scriptingRelease();</td></tr>
<tr class="codeline" data-linenumber="1278"><td class="num" id="LN1278">1278</td><td class="line">    scriptingInit(0);</td></tr>
<tr class="codeline" data-linenumber="1279"><td class="num" id="LN1279">1279</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1280"><td class="num" id="LN1280">1280</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1281"><td class="num" id="LN1281">1281</td><td class="line"><span class='comment'>/* Set an array of Redis String Objects as a Lua array (table) stored into a</span></td></tr>
<tr class="codeline" data-linenumber="1282"><td class="num" id="LN1282">1282</td><td class="line"> <span class='comment'>* global variable. */</span></td></tr>
<tr class="codeline" data-linenumber="1283"><td class="num" id="LN1283">1283</td><td class="line"><span class='keyword'>void</span> luaSetGlobalArray(lua_State *lua, <span class='keyword'>char</span> *var, robj **elev, <span class='keyword'>int</span> elec) {</td></tr>
<tr class="codeline" data-linenumber="1284"><td class="num" id="LN1284">1284</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="1285"><td class="num" id="LN1285">1285</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1286"><td class="num" id="LN1286">1286</td><td class="line">    <span class='macro'>lua_newtable(lua)<span class='macro_popup'>lua_createtable(lua, 0, 0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1287"><td class="num" id="LN1287">1287</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; elec; j++) {</td></tr>
<tr class="codeline" data-linenumber="1288"><td class="num" id="LN1288">1288</td><td class="line">        lua_pushlstring(lua,(<span class='keyword'>char</span>*)elev[j]-&gt;ptr,sdslen(elev[j]-&gt;ptr));</td></tr>
<tr class="codeline" data-linenumber="1289"><td class="num" id="LN1289">1289</td><td class="line">        lua_rawseti(lua,-2,j+1);</td></tr>
<tr class="codeline" data-linenumber="1290"><td class="num" id="LN1290">1290</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1291"><td class="num" id="LN1291">1291</td><td class="line">    <span class='macro'>lua_setglobal(lua,var)<span class='macro_popup'>lua_setfield(lua, (-10002), (var))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1292"><td class="num" id="LN1292">1292</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1293"><td class="num" id="LN1293">1293</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1294"><td class="num" id="LN1294">1294</td><td class="line"><span class='comment'>/* ---------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="1295"><td class="num" id="LN1295">1295</td><td class="line"> <span class='comment'>* Redis provided math.random</span></td></tr>
<tr class="codeline" data-linenumber="1296"><td class="num" id="LN1296">1296</td><td class="line"> <span class='comment'>* ------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="1297"><td class="num" id="LN1297">1297</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1298"><td class="num" id="LN1298">1298</td><td class="line"><span class='comment'>/* We replace math.random() with our implementation that is not affected</span></td></tr>
<tr class="codeline" data-linenumber="1299"><td class="num" id="LN1299">1299</td><td class="line"> <span class='comment'>* by specific libc random() implementations and will output the same sequence</span></td></tr>
<tr class="codeline" data-linenumber="1300"><td class="num" id="LN1300">1300</td><td class="line"> <span class='comment'>* (for the same seed) in every arch. */</span></td></tr>
<tr class="codeline" data-linenumber="1301"><td class="num" id="LN1301">1301</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1302"><td class="num" id="LN1302">1302</td><td class="line"><span class='comment'>/* The following implementation is the one shipped with Lua itself but with</span></td></tr>
<tr class="codeline" data-linenumber="1303"><td class="num" id="LN1303">1303</td><td class="line"> <span class='comment'>* rand() replaced by redisLrand48(). */</span></td></tr>
<tr class="codeline" data-linenumber="1304"><td class="num" id="LN1304">1304</td><td class="line"><span class='keyword'>int</span> redis_math_random (lua_State *L) {</td></tr>
<tr class="codeline" data-linenumber="1305"><td class="num" id="LN1305">1305</td><td class="line">  <span class='comment'>/* the `%' avoids the (rare) case of r==1, and is needed also because on</span></td></tr>
<tr class="codeline" data-linenumber="1306"><td class="num" id="LN1306">1306</td><td class="line">     <span class='comment'>some systems (SunOS!) `rand()' may return a value larger than RAND_MAX */</span></td></tr>
<tr class="codeline" data-linenumber="1307"><td class="num" id="LN1307">1307</td><td class="line">  lua_Number r = (lua_Number)(redisLrand48()%<span class='macro'>REDIS_LRAND48_MAX<span class='macro_popup'>(2147483647)</span></span>) /</td></tr>
<tr class="codeline" data-linenumber="1308"><td class="num" id="LN1308">1308</td><td class="line">                                (lua_Number)<span class='macro'>REDIS_LRAND48_MAX<span class='macro_popup'>(2147483647)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1309"><td class="num" id="LN1309">1309</td><td class="line">  <span class='keyword'>switch</span> (lua_gettop(L)) {  <span class='comment'>/* check number of arguments */</span></td></tr>
<tr class="codeline" data-linenumber="1310"><td class="num" id="LN1310">1310</td><td class="line">    <span class='keyword'>case</span> 0: {  <span class='comment'>/* no arguments */</span></td></tr>
<tr class="codeline" data-linenumber="1311"><td class="num" id="LN1311">1311</td><td class="line">      lua_pushnumber(L, r);  <span class='comment'>/* Number between 0 and 1 */</span></td></tr>
<tr class="codeline" data-linenumber="1312"><td class="num" id="LN1312">1312</td><td class="line">      <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1313"><td class="num" id="LN1313">1313</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1314"><td class="num" id="LN1314">1314</td><td class="line">    <span class='keyword'>case</span> 1: {  <span class='comment'>/* only upper limit */</span></td></tr>
<tr class="codeline" data-linenumber="1315"><td class="num" id="LN1315">1315</td><td class="line">      <span class='keyword'>int</span> u = <span class='macro'>luaL_checkint(L, 1)<span class='macro_popup'>((int)luaL_checkinteger(L, (1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1316"><td class="num" id="LN1316">1316</td><td class="line">      <span class='macro'>luaL_argcheck(L, 1&lt;=u, 1, <span class='string_literal'>"interval is empty"</span>)<span class='macro_popup'>((void)((1&lt;=u) || luaL_argerror(L, (1), ("interval is empty"<br>))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1317"><td class="num" id="LN1317">1317</td><td class="line">      lua_pushnumber(L, floor(r*u)+1);  <span class='comment'>/* int between 1 and `u' */</span></td></tr>
<tr class="codeline" data-linenumber="1318"><td class="num" id="LN1318">1318</td><td class="line">      <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1319"><td class="num" id="LN1319">1319</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1320"><td class="num" id="LN1320">1320</td><td class="line">    <span class='keyword'>case</span> 2: {  <span class='comment'>/* lower and upper limits */</span></td></tr>
<tr class="codeline" data-linenumber="1321"><td class="num" id="LN1321">1321</td><td class="line">      <span class='keyword'>int</span> l = <span class='macro'>luaL_checkint(L, 1)<span class='macro_popup'>((int)luaL_checkinteger(L, (1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1322"><td class="num" id="LN1322">1322</td><td class="line">      <span class='keyword'>int</span> u = <span class='macro'>luaL_checkint(L, 2)<span class='macro_popup'>((int)luaL_checkinteger(L, (2)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1323"><td class="num" id="LN1323">1323</td><td class="line">      <span class='macro'>luaL_argcheck(L, l&lt;=u, 2, <span class='string_literal'>"interval is empty"</span>)<span class='macro_popup'>((void)((l&lt;=u) || luaL_argerror(L, (2), ("interval is empty"<br>))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1324"><td class="num" id="LN1324">1324</td><td class="line">      lua_pushnumber(L, floor(r*(u-l+1))+l);  <span class='comment'>/* int between `l' and `u' */</span></td></tr>
<tr class="codeline" data-linenumber="1325"><td class="num" id="LN1325">1325</td><td class="line">      <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1326"><td class="num" id="LN1326">1326</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1327"><td class="num" id="LN1327">1327</td><td class="line">    <span class='keyword'>default</span>: <span class='keyword'>return</span> luaL_error(L, <span class='string_literal'>"wrong number of arguments"</span>);</td></tr>
<tr class="codeline" data-linenumber="1328"><td class="num" id="LN1328">1328</td><td class="line">  }</td></tr>
<tr class="codeline" data-linenumber="1329"><td class="num" id="LN1329">1329</td><td class="line">  <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1330"><td class="num" id="LN1330">1330</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1331"><td class="num" id="LN1331">1331</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1332"><td class="num" id="LN1332">1332</td><td class="line"><span class='keyword'>int</span> redis_math_randomseed (lua_State *L) {</td></tr>
<tr class="codeline" data-linenumber="1333"><td class="num" id="LN1333">1333</td><td class="line">  redisSrand48(<span class='macro'>luaL_checkint(L, 1)<span class='macro_popup'>((int)luaL_checkinteger(L, (1)))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1334"><td class="num" id="LN1334">1334</td><td class="line">  <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1335"><td class="num" id="LN1335">1335</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1336"><td class="num" id="LN1336">1336</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1337"><td class="num" id="LN1337">1337</td><td class="line"><span class='comment'>/* ---------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="1338"><td class="num" id="LN1338">1338</td><td class="line"> <span class='comment'>* EVAL and SCRIPT commands implementation</span></td></tr>
<tr class="codeline" data-linenumber="1339"><td class="num" id="LN1339">1339</td><td class="line"> <span class='comment'>* ------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="1340"><td class="num" id="LN1340">1340</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1341"><td class="num" id="LN1341">1341</td><td class="line"><span class='comment'>/* Define a Lua function with the specified body.</span></td></tr>
<tr class="codeline" data-linenumber="1342"><td class="num" id="LN1342">1342</td><td class="line"> <span class='comment'>* The function name will be generated in the following form:</span></td></tr>
<tr class="codeline" data-linenumber="1343"><td class="num" id="LN1343">1343</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1344"><td class="num" id="LN1344">1344</td><td class="line"> <span class='comment'>*   f_&lt;hex sha1 sum&gt;</span></td></tr>
<tr class="codeline" data-linenumber="1345"><td class="num" id="LN1345">1345</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1346"><td class="num" id="LN1346">1346</td><td class="line"> <span class='comment'>* The function increments the reference count of the 'body' object as a</span></td></tr>
<tr class="codeline" data-linenumber="1347"><td class="num" id="LN1347">1347</td><td class="line"> <span class='comment'>* side effect of a successful call.</span></td></tr>
<tr class="codeline" data-linenumber="1348"><td class="num" id="LN1348">1348</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1349"><td class="num" id="LN1349">1349</td><td class="line"> <span class='comment'>* On success a pointer to an SDS string representing the function SHA1 of the</span></td></tr>
<tr class="codeline" data-linenumber="1350"><td class="num" id="LN1350">1350</td><td class="line"> <span class='comment'>* just added function is returned (and will be valid until the next call</span></td></tr>
<tr class="codeline" data-linenumber="1351"><td class="num" id="LN1351">1351</td><td class="line"> <span class='comment'>* to scriptingReset() function), otherwise NULL is returned.</span></td></tr>
<tr class="codeline" data-linenumber="1352"><td class="num" id="LN1352">1352</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1353"><td class="num" id="LN1353">1353</td><td class="line"> <span class='comment'>* The function handles the fact of being called with a script that already</span></td></tr>
<tr class="codeline" data-linenumber="1354"><td class="num" id="LN1354">1354</td><td class="line"> <span class='comment'>* exists, and in such a case, it behaves like in the success case.</span></td></tr>
<tr class="codeline" data-linenumber="1355"><td class="num" id="LN1355">1355</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1356"><td class="num" id="LN1356">1356</td><td class="line"> <span class='comment'>* If 'c' is not NULL, on error the client is informed with an appropriate</span></td></tr>
<tr class="codeline" data-linenumber="1357"><td class="num" id="LN1357">1357</td><td class="line"> <span class='comment'>* error describing the nature of the problem and the Lua interpreter error. */</span></td></tr>
<tr class="codeline" data-linenumber="1358"><td class="num" id="LN1358">1358</td><td class="line">sds luaCreateFunction(client *c, lua_State *lua, robj *body) {</td></tr>
<tr class="codeline" data-linenumber="1359"><td class="num" id="LN1359">1359</td><td class="line">    <span class='keyword'>char</span> funcname[43];</td></tr>
<tr class="codeline" data-linenumber="1360"><td class="num" id="LN1360">1360</td><td class="line">    dictEntry *de;</td></tr>
<tr class="codeline" data-linenumber="1361"><td class="num" id="LN1361">1361</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1362"><td class="num" id="LN1362">1362</td><td class="line">    funcname[0] = 'f';</td></tr>
<tr class="codeline" data-linenumber="1363"><td class="num" id="LN1363">1363</td><td class="line">    funcname[1] = '_';</td></tr>
<tr class="codeline" data-linenumber="1364"><td class="num" id="LN1364">1364</td><td class="line">    sha1hex(funcname+2,body-&gt;ptr,sdslen(body-&gt;ptr));</td></tr>
<tr class="codeline" data-linenumber="1365"><td class="num" id="LN1365">1365</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1366"><td class="num" id="LN1366">1366</td><td class="line">    sds sha = sdsnewlen(funcname+2,40);</td></tr>
<tr class="codeline" data-linenumber="1367"><td class="num" id="LN1367">1367</td><td class="line">    <span class='keyword'>if</span> ((de = dictFind(server.lua_scripts,sha)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1368"><td class="num" id="LN1368">1368</td><td class="line">        sdsfree(sha);</td></tr>
<tr class="codeline" data-linenumber="1369"><td class="num" id="LN1369">1369</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>dictGetKey(de)<span class='macro_popup'>((de)-&gt;key)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1370"><td class="num" id="LN1370">1370</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1371"><td class="num" id="LN1371">1371</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1372"><td class="num" id="LN1372">1372</td><td class="line">    sds funcdef = sdsempty();</td></tr>
<tr class="codeline" data-linenumber="1373"><td class="num" id="LN1373">1373</td><td class="line">    funcdef = sdscat(funcdef,<span class='string_literal'>"function "</span>);</td></tr>
<tr class="codeline" data-linenumber="1374"><td class="num" id="LN1374">1374</td><td class="line">    funcdef = sdscatlen(funcdef,funcname,42);</td></tr>
<tr class="codeline" data-linenumber="1375"><td class="num" id="LN1375">1375</td><td class="line">    funcdef = sdscatlen(funcdef,<span class='string_literal'>"() "</span>,3);</td></tr>
<tr class="codeline" data-linenumber="1376"><td class="num" id="LN1376">1376</td><td class="line">    funcdef = sdscatlen(funcdef,body-&gt;ptr,sdslen(body-&gt;ptr));</td></tr>
<tr class="codeline" data-linenumber="1377"><td class="num" id="LN1377">1377</td><td class="line">    funcdef = sdscatlen(funcdef,<span class='string_literal'>"\nend"</span>,4);</td></tr>
<tr class="codeline" data-linenumber="1378"><td class="num" id="LN1378">1378</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1379"><td class="num" id="LN1379">1379</td><td class="line">    <span class='keyword'>if</span> (luaL_loadbuffer(lua,funcdef,sdslen(funcdef),<span class='string_literal'>"@user_script"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="1380"><td class="num" id="LN1380">1380</td><td class="line">        <span class='keyword'>if</span> (c != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1381"><td class="num" id="LN1381">1381</td><td class="line">            addReplyErrorFormat(c,</td></tr>
<tr class="codeline" data-linenumber="1382"><td class="num" id="LN1382">1382</td><td class="line">                <span class='string_literal'>"Error compiling script (new function): %s\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="1383"><td class="num" id="LN1383">1383</td><td class="line">                <span class='macro'>lua_tostring(lua,-1)<span class='macro_popup'>lua_tolstring(lua, (-1), ((void*)0))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1384"><td class="num" id="LN1384">1384</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1385"><td class="num" id="LN1385">1385</td><td class="line">        <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1386"><td class="num" id="LN1386">1386</td><td class="line">        sdsfree(sha);</td></tr>
<tr class="codeline" data-linenumber="1387"><td class="num" id="LN1387">1387</td><td class="line">        sdsfree(funcdef);</td></tr>
<tr class="codeline" data-linenumber="1388"><td class="num" id="LN1388">1388</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1389"><td class="num" id="LN1389">1389</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1390"><td class="num" id="LN1390">1390</td><td class="line">    sdsfree(funcdef);</td></tr>
<tr class="codeline" data-linenumber="1391"><td class="num" id="LN1391">1391</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1392"><td class="num" id="LN1392">1392</td><td class="line">    <span class='keyword'>if</span> (lua_pcall(lua,0,0,0)) {</td></tr>
<tr class="codeline" data-linenumber="1393"><td class="num" id="LN1393">1393</td><td class="line">        <span class='keyword'>if</span> (c != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1394"><td class="num" id="LN1394">1394</td><td class="line">            addReplyErrorFormat(c,<span class='string_literal'>"Error running script (new function): %s\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="1395"><td class="num" id="LN1395">1395</td><td class="line">                <span class='macro'>lua_tostring(lua,-1)<span class='macro_popup'>lua_tolstring(lua, (-1), ((void*)0))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1396"><td class="num" id="LN1396">1396</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1397"><td class="num" id="LN1397">1397</td><td class="line">        <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1398"><td class="num" id="LN1398">1398</td><td class="line">        sdsfree(sha);</td></tr>
<tr class="codeline" data-linenumber="1399"><td class="num" id="LN1399">1399</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1400"><td class="num" id="LN1400">1400</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1401"><td class="num" id="LN1401">1401</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1402"><td class="num" id="LN1402">1402</td><td class="line">    <span class='comment'>/* We also save a SHA1 -&gt; Original script map in a dictionary</span></td></tr>
<tr class="codeline" data-linenumber="1403"><td class="num" id="LN1403">1403</td><td class="line">     <span class='comment'>* so that we can replicate / write in the AOF all the</span></td></tr>
<tr class="codeline" data-linenumber="1404"><td class="num" id="LN1404">1404</td><td class="line">     <span class='comment'>* EVALSHA commands as EVAL using the original script. */</span></td></tr>
<tr class="codeline" data-linenumber="1405"><td class="num" id="LN1405">1405</td><td class="line">    <span class='keyword'>int</span> retval = dictAdd(server.lua_scripts,sha,body);</td></tr>
<tr class="codeline" data-linenumber="1406"><td class="num" id="LN1406">1406</td><td class="line">    <span class='macro'>serverAssertWithInfo(c ? c : server.lua_client,NULL,retval == DICT_OK)<span class='macro_popup'>((retval == 0)?(void)0 : (_serverAssertWithInfo(c ? c : server<br>.lua_client,((void*)0),"retval == DICT_OK","scripting.c",1406<br>),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1407"><td class="num" id="LN1407">1407</td><td class="line">    server.lua_scripts_mem += sdsZmallocSize(sha) + getStringObjectSdsUsedMemory(body);</td></tr>
<tr class="codeline" data-linenumber="1408"><td class="num" id="LN1408">1408</td><td class="line">    incrRefCount(body);</td></tr>
<tr class="codeline" data-linenumber="1409"><td class="num" id="LN1409">1409</td><td class="line">    <span class='keyword'>return</span> sha;</td></tr>
<tr class="codeline" data-linenumber="1410"><td class="num" id="LN1410">1410</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1411"><td class="num" id="LN1411">1411</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1412"><td class="num" id="LN1412">1412</td><td class="line"><span class='comment'>/* This is the Lua script "count" hook that we use to detect scripts timeout. */</span></td></tr>
<tr class="codeline" data-linenumber="1413"><td class="num" id="LN1413">1413</td><td class="line"><span class='keyword'>void</span> luaMaskCountHook(lua_State *lua, lua_Debug *ar) {</td></tr>
<tr class="codeline" data-linenumber="1414"><td class="num" id="LN1414">1414</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> elapsed = mstime() - server.lua_time_start;</td></tr>
<tr class="codeline" data-linenumber="1415"><td class="num" id="LN1415">1415</td><td class="line">    <span class='macro'>UNUSED(ar)<span class='macro_popup'>((void) ar)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1416"><td class="num" id="LN1416">1416</td><td class="line">    <span class='macro'>UNUSED(lua)<span class='macro_popup'>((void) lua)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1417"><td class="num" id="LN1417">1417</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1418"><td class="num" id="LN1418">1418</td><td class="line">    <span class='comment'>/* Set the timeout condition if not already set and the maximum</span></td></tr>
<tr class="codeline" data-linenumber="1419"><td class="num" id="LN1419">1419</td><td class="line">     <span class='comment'>* execution time was reached. */</span></td></tr>
<tr class="codeline" data-linenumber="1420"><td class="num" id="LN1420">1420</td><td class="line">    <span class='keyword'>if</span> (elapsed &gt;= server.lua_time_limit &amp;&amp; server.lua_timedout == 0) {</td></tr>
<tr class="codeline" data-linenumber="1421"><td class="num" id="LN1421">1421</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1422"><td class="num" id="LN1422">1422</td><td class="line">            <span class='string_literal'>"Lua slow script detected: still in execution after %lld milliseconds. "</span></td></tr>
<tr class="codeline" data-linenumber="1423"><td class="num" id="LN1423">1423</td><td class="line">            <span class='string_literal'>"You can try killing the script using the SCRIPT KILL command. "</span></td></tr>
<tr class="codeline" data-linenumber="1424"><td class="num" id="LN1424">1424</td><td class="line">            <span class='string_literal'>"Script SHA1 is: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="1425"><td class="num" id="LN1425">1425</td><td class="line">            elapsed, server.lua_cur_script);</td></tr>
<tr class="codeline" data-linenumber="1426"><td class="num" id="LN1426">1426</td><td class="line">        server.lua_timedout = 1;</td></tr>
<tr class="codeline" data-linenumber="1427"><td class="num" id="LN1427">1427</td><td class="line">        <span class='comment'>/* Once the script timeouts we reenter the event loop to permit others</span></td></tr>
<tr class="codeline" data-linenumber="1428"><td class="num" id="LN1428">1428</td><td class="line">         <span class='comment'>* to call SCRIPT KILL or SHUTDOWN NOSAVE if needed. For this reason</span></td></tr>
<tr class="codeline" data-linenumber="1429"><td class="num" id="LN1429">1429</td><td class="line">         <span class='comment'>* we need to mask the client executing the script from the event loop.</span></td></tr>
<tr class="codeline" data-linenumber="1430"><td class="num" id="LN1430">1430</td><td class="line">         <span class='comment'>* If we don't do that the client may disconnect and could no longer be</span></td></tr>
<tr class="codeline" data-linenumber="1431"><td class="num" id="LN1431">1431</td><td class="line">         <span class='comment'>* here when the EVAL command will return. */</span></td></tr>
<tr class="codeline" data-linenumber="1432"><td class="num" id="LN1432">1432</td><td class="line">        protectClient(server.lua_caller);</td></tr>
<tr class="codeline" data-linenumber="1433"><td class="num" id="LN1433">1433</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1434"><td class="num" id="LN1434">1434</td><td class="line">    <span class='keyword'>if</span> (server.lua_timedout) processEventsWhileBlocked();</td></tr>
<tr class="codeline" data-linenumber="1435"><td class="num" id="LN1435">1435</td><td class="line">    <span class='keyword'>if</span> (server.lua_kill) {</td></tr>
<tr class="codeline" data-linenumber="1436"><td class="num" id="LN1436">1436</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Lua script killed by user with SCRIPT KILL."</span>);</td></tr>
<tr class="codeline" data-linenumber="1437"><td class="num" id="LN1437">1437</td><td class="line">        lua_pushstring(lua,<span class='string_literal'>"Script killed by user with SCRIPT KILL..."</span>);</td></tr>
<tr class="codeline" data-linenumber="1438"><td class="num" id="LN1438">1438</td><td class="line">        lua_error(lua);</td></tr>
<tr class="codeline" data-linenumber="1439"><td class="num" id="LN1439">1439</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1440"><td class="num" id="LN1440">1440</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1441"><td class="num" id="LN1441">1441</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1442"><td class="num" id="LN1442">1442</td><td class="line"><span class='keyword'>void</span> prepareLuaClient(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1443"><td class="num" id="LN1443">1443</td><td class="line">    <span class='comment'>/* Select the right DB in the context of the Lua client */</span></td></tr>
<tr class="codeline" data-linenumber="1444"><td class="num" id="LN1444">1444</td><td class="line">    selectDb(server.lua_client,server.lua_caller-&gt;db-&gt;id);</td></tr>
<tr class="codeline" data-linenumber="1445"><td class="num" id="LN1445">1445</td><td class="line">    server.lua_client-&gt;resp = 2; <span class='comment'>/* Default is RESP2, scripts can change it. */</span></td></tr>
<tr class="codeline" data-linenumber="1446"><td class="num" id="LN1446">1446</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1447"><td class="num" id="LN1447">1447</td><td class="line">    <span class='comment'>/* If we are in MULTI context, flag Lua client as CLIENT_MULTI. */</span></td></tr>
<tr class="codeline" data-linenumber="1448"><td class="num" id="LN1448">1448</td><td class="line">    <span class='keyword'>if</span> (server.lua_caller-&gt;flags &amp; <span class='macro'>CLIENT_MULTI<span class='macro_popup'>(1&lt;&lt;3)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1449"><td class="num" id="LN1449">1449</td><td class="line">        server.lua_client-&gt;flags |= <span class='macro'>CLIENT_MULTI<span class='macro_popup'>(1&lt;&lt;3)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1450"><td class="num" id="LN1450">1450</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1451"><td class="num" id="LN1451">1451</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1452"><td class="num" id="LN1452">1452</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1453"><td class="num" id="LN1453">1453</td><td class="line"><span class='keyword'>void</span> resetLuaClient(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1454"><td class="num" id="LN1454">1454</td><td class="line">    <span class='comment'>/* After the script done, remove the MULTI state. */</span></td></tr>
<tr class="codeline" data-linenumber="1455"><td class="num" id="LN1455">1455</td><td class="line">    server.lua_client-&gt;flags &amp;= ~<span class='macro'>CLIENT_MULTI<span class='macro_popup'>(1&lt;&lt;3)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1456"><td class="num" id="LN1456">1456</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1457"><td class="num" id="LN1457">1457</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1458"><td class="num" id="LN1458">1458</td><td class="line"><span class='keyword'>void</span> evalGenericCommand(client *c, <span class='keyword'>int</span> evalsha) {</td></tr>
<tr class="codeline" data-linenumber="1459"><td class="num" id="LN1459">1459</td><td class="line">    lua_State *lua = server.lua;</td></tr>
<tr class="codeline" data-linenumber="1460"><td class="num" id="LN1460">1460</td><td class="line">    <span class='keyword'>char</span> funcname[43];</td></tr>
<tr class="codeline" data-linenumber="1461"><td class="num" id="LN1461">1461</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> numkeys;</td></tr>
<tr class="codeline" data-linenumber="1462"><td class="num" id="LN1462">1462</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> initial_server_dirty = server.dirty;</td></tr>
<tr class="codeline" data-linenumber="1463"><td class="num" id="LN1463">1463</td><td class="line">    <span class='keyword'>int</span> delhook = 0, err;</td></tr>
<tr class="codeline" data-linenumber="1464"><td class="num" id="LN1464">1464</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1465"><td class="num" id="LN1465">1465</td><td class="line">    <span class='comment'>/* When we replicate whole scripts, we want the same PRNG sequence at</span></td></tr>
<tr class="codeline" data-linenumber="1466"><td class="num" id="LN1466">1466</td><td class="line">     <span class='comment'>* every call so that our PRNG is not affected by external state. */</span></td></tr>
<tr class="codeline" data-linenumber="1467"><td class="num" id="LN1467">1467</td><td class="line">    redisSrand48(0);</td></tr>
<tr class="codeline" data-linenumber="1468"><td class="num" id="LN1468">1468</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1469"><td class="num" id="LN1469">1469</td><td class="line">    <span class='comment'>/* We set this flag to zero to remember that so far no random command</span></td></tr>
<tr class="codeline" data-linenumber="1470"><td class="num" id="LN1470">1470</td><td class="line">     <span class='comment'>* was called. This way we can allow the user to call commands like</span></td></tr>
<tr class="codeline" data-linenumber="1471"><td class="num" id="LN1471">1471</td><td class="line">     <span class='comment'>* SRANDMEMBER or RANDOMKEY from Lua scripts as far as no write command</span></td></tr>
<tr class="codeline" data-linenumber="1472"><td class="num" id="LN1472">1472</td><td class="line">     <span class='comment'>* is called (otherwise the replication and AOF would end with non</span></td></tr>
<tr class="codeline" data-linenumber="1473"><td class="num" id="LN1473">1473</td><td class="line">     <span class='comment'>* deterministic sequences).</span></td></tr>
<tr class="codeline" data-linenumber="1474"><td class="num" id="LN1474">1474</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1475"><td class="num" id="LN1475">1475</td><td class="line">     <span class='comment'>* Thanks to this flag we'll raise an error every time a write command</span></td></tr>
<tr class="codeline" data-linenumber="1476"><td class="num" id="LN1476">1476</td><td class="line">     <span class='comment'>* is called after a random command was used. */</span></td></tr>
<tr class="codeline" data-linenumber="1477"><td class="num" id="LN1477">1477</td><td class="line">    server.lua_random_dirty = 0;</td></tr>
<tr class="codeline" data-linenumber="1478"><td class="num" id="LN1478">1478</td><td class="line">    server.lua_write_dirty = 0;</td></tr>
<tr class="codeline" data-linenumber="1479"><td class="num" id="LN1479">1479</td><td class="line">    server.lua_replicate_commands = server.lua_always_replicate_commands;</td></tr>
<tr class="codeline" data-linenumber="1480"><td class="num" id="LN1480">1480</td><td class="line">    server.lua_multi_emitted = 0;</td></tr>
<tr class="codeline" data-linenumber="1481"><td class="num" id="LN1481">1481</td><td class="line">    server.lua_repl = <span class='macro'>PROPAGATE_AOF<span class='macro_popup'>1</span></span>|<span class='macro'>PROPAGATE_REPL<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1482"><td class="num" id="LN1482">1482</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1483"><td class="num" id="LN1483">1483</td><td class="line">    <span class='comment'>/* Get the number of arguments that are keys */</span></td></tr>
<tr class="codeline" data-linenumber="1484"><td class="num" id="LN1484">1484</td><td class="line">    <span class='keyword'>if</span> (getLongLongFromObjectOrReply(c,c-&gt;argv[2],&amp;numkeys,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) != <span class='macro'>C_OK<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1485"><td class="num" id="LN1485">1485</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1486"><td class="num" id="LN1486">1486</td><td class="line">    <span class='keyword'>if</span> (numkeys &gt; (c-&gt;argc - 3)) {</td></tr>
<tr class="codeline" data-linenumber="1487"><td class="num" id="LN1487">1487</td><td class="line">        addReplyError(c,<span class='string_literal'>"Number of keys can't be greater than number of args"</span>);</td></tr>
<tr class="codeline" data-linenumber="1488"><td class="num" id="LN1488">1488</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1489"><td class="num" id="LN1489">1489</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (numkeys &lt; 0) {</td></tr>
<tr class="codeline" data-linenumber="1490"><td class="num" id="LN1490">1490</td><td class="line">        addReplyError(c,<span class='string_literal'>"Number of keys can't be negative"</span>);</td></tr>
<tr class="codeline" data-linenumber="1491"><td class="num" id="LN1491">1491</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1492"><td class="num" id="LN1492">1492</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1493"><td class="num" id="LN1493">1493</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1494"><td class="num" id="LN1494">1494</td><td class="line">    <span class='comment'>/* We obtain the script SHA1, then check if this function is already</span></td></tr>
<tr class="codeline" data-linenumber="1495"><td class="num" id="LN1495">1495</td><td class="line">     <span class='comment'>* defined into the Lua state */</span></td></tr>
<tr class="codeline" data-linenumber="1496"><td class="num" id="LN1496">1496</td><td class="line">    funcname[0] = 'f';</td></tr>
<tr class="codeline" data-linenumber="1497"><td class="num" id="LN1497">1497</td><td class="line">    funcname[1] = '_';</td></tr>
<tr class="codeline" data-linenumber="1498"><td class="num" id="LN1498">1498</td><td class="line">    <span class='keyword'>if</span> (!evalsha) {</td></tr>
<tr class="codeline" data-linenumber="1499"><td class="num" id="LN1499">1499</td><td class="line">        <span class='comment'>/* Hash the code if this is an EVAL call */</span></td></tr>
<tr class="codeline" data-linenumber="1500"><td class="num" id="LN1500">1500</td><td class="line">        sha1hex(funcname+2,c-&gt;argv[1]-&gt;ptr,sdslen(c-&gt;argv[1]-&gt;ptr));</td></tr>
<tr class="codeline" data-linenumber="1501"><td class="num" id="LN1501">1501</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1502"><td class="num" id="LN1502">1502</td><td class="line">        <span class='comment'>/* We already have the SHA if it is an EVALSHA */</span></td></tr>
<tr class="codeline" data-linenumber="1503"><td class="num" id="LN1503">1503</td><td class="line">        <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="1504"><td class="num" id="LN1504">1504</td><td class="line">        <span class='keyword'>char</span> *sha = c-&gt;argv[1]-&gt;ptr;</td></tr>
<tr class="codeline" data-linenumber="1505"><td class="num" id="LN1505">1505</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1506"><td class="num" id="LN1506">1506</td><td class="line">        <span class='comment'>/* Convert to lowercase. We don't use tolower since the function</span></td></tr>
<tr class="codeline" data-linenumber="1507"><td class="num" id="LN1507">1507</td><td class="line">         <span class='comment'>* managed to always show up in the profiler output consuming</span></td></tr>
<tr class="codeline" data-linenumber="1508"><td class="num" id="LN1508">1508</td><td class="line">         <span class='comment'>* a non trivial amount of time. */</span></td></tr>
<tr class="codeline" data-linenumber="1509"><td class="num" id="LN1509">1509</td><td class="line">        <span class='keyword'>for</span> (j = 0; j &lt; 40; j++)</td></tr>
<tr class="codeline" data-linenumber="1510"><td class="num" id="LN1510">1510</td><td class="line">            funcname[j+2] = (sha[j] &gt;= 'A' &amp;&amp; sha[j] &lt;= 'Z') ?</td></tr>
<tr class="codeline" data-linenumber="1511"><td class="num" id="LN1511">1511</td><td class="line">                sha[j]+('a'-'A') : sha[j];</td></tr>
<tr class="codeline" data-linenumber="1512"><td class="num" id="LN1512">1512</td><td class="line">        funcname[42] = '\0';</td></tr>
<tr class="codeline" data-linenumber="1513"><td class="num" id="LN1513">1513</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1514"><td class="num" id="LN1514">1514</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1515"><td class="num" id="LN1515">1515</td><td class="line">    <span class='comment'>/* Push the pcall error handler function on the stack. */</span></td></tr>
<tr class="codeline" data-linenumber="1516"><td class="num" id="LN1516">1516</td><td class="line">    <span class='macro'>lua_getglobal(lua, <span class='string_literal'>"__redis__err__handler"</span>)<span class='macro_popup'>lua_getfield(lua, (-10002), ("__redis__err__handler"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1517"><td class="num" id="LN1517">1517</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1518"><td class="num" id="LN1518">1518</td><td class="line">    <span class='comment'>/* Try to lookup the Lua function */</span></td></tr>
<tr class="codeline" data-linenumber="1519"><td class="num" id="LN1519">1519</td><td class="line">    <span class='macro'>lua_getglobal(lua, funcname)<span class='macro_popup'>lua_getfield(lua, (-10002), (funcname))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1520"><td class="num" id="LN1520">1520</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>lua_isnil(lua,-1)<span class='macro_popup'>(lua_type(lua, (-1)) == 0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1521"><td class="num" id="LN1521">1521</td><td class="line">        <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>; <span class='comment'>/* remove the nil from the stack */</span></td></tr>
<tr class="codeline" data-linenumber="1522"><td class="num" id="LN1522">1522</td><td class="line">        <span class='comment'>/* Function not defined... let's define it if we have the</span></td></tr>
<tr class="codeline" data-linenumber="1523"><td class="num" id="LN1523">1523</td><td class="line">         <span class='comment'>* body of the function. If this is an EVALSHA call we can just</span></td></tr>
<tr class="codeline" data-linenumber="1524"><td class="num" id="LN1524">1524</td><td class="line">         <span class='comment'>* return an error. */</span></td></tr>
<tr class="codeline" data-linenumber="1525"><td class="num" id="LN1525">1525</td><td class="line">        <span class='keyword'>if</span> (evalsha) {</td></tr>
<tr class="codeline" data-linenumber="1526"><td class="num" id="LN1526">1526</td><td class="line">            <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>; <span class='comment'>/* remove the error handler from the stack. */</span></td></tr>
<tr class="codeline" data-linenumber="1527"><td class="num" id="LN1527">1527</td><td class="line">            addReply(c, shared.noscripterr);</td></tr>
<tr class="codeline" data-linenumber="1528"><td class="num" id="LN1528">1528</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1529"><td class="num" id="LN1529">1529</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1530"><td class="num" id="LN1530">1530</td><td class="line">        <span class='keyword'>if</span> (luaCreateFunction(c,lua,c-&gt;argv[1]) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1531"><td class="num" id="LN1531">1531</td><td class="line">            <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>; <span class='comment'>/* remove the error handler from the stack. */</span></td></tr>
<tr class="codeline" data-linenumber="1532"><td class="num" id="LN1532">1532</td><td class="line">            <span class='comment'>/* The error is sent to the client by luaCreateFunction()</span></td></tr>
<tr class="codeline" data-linenumber="1533"><td class="num" id="LN1533">1533</td><td class="line">             <span class='comment'>* itself when it returns NULL. */</span></td></tr>
<tr class="codeline" data-linenumber="1534"><td class="num" id="LN1534">1534</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1535"><td class="num" id="LN1535">1535</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1536"><td class="num" id="LN1536">1536</td><td class="line">        <span class='comment'>/* Now the following is guaranteed to return non nil */</span></td></tr>
<tr class="codeline" data-linenumber="1537"><td class="num" id="LN1537">1537</td><td class="line">        <span class='macro'>lua_getglobal(lua, funcname)<span class='macro_popup'>lua_getfield(lua, (-10002), (funcname))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1538"><td class="num" id="LN1538">1538</td><td class="line">        <span class='macro'>serverAssert(!lua_isnil(lua,-1))<span class='macro_popup'>((!(lua_type(lua, (-1)) == 0))?(void)0 : (_serverAssert("!lua_isnil(lua,-1)"<br>,"scripting.c",1538),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1539"><td class="num" id="LN1539">1539</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1540"><td class="num" id="LN1540">1540</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1541"><td class="num" id="LN1541">1541</td><td class="line">    <span class='comment'>/* Populate the argv and keys table accordingly to the arguments that</span></td></tr>
<tr class="codeline" data-linenumber="1542"><td class="num" id="LN1542">1542</td><td class="line">     <span class='comment'>* EVAL received. */</span></td></tr>
<tr class="codeline" data-linenumber="1543"><td class="num" id="LN1543">1543</td><td class="line">    luaSetGlobalArray(lua,<span class='string_literal'>"KEYS"</span>,c-&gt;argv+3,numkeys);</td></tr>
<tr class="codeline" data-linenumber="1544"><td class="num" id="LN1544">1544</td><td class="line">    luaSetGlobalArray(lua,<span class='string_literal'>"ARGV"</span>,c-&gt;argv+3+numkeys,c-&gt;argc-3-numkeys);</td></tr>
<tr class="codeline" data-linenumber="1545"><td class="num" id="LN1545">1545</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1546"><td class="num" id="LN1546">1546</td><td class="line">    <span class='comment'>/* Set a hook in order to be able to stop the script execution if it</span></td></tr>
<tr class="codeline" data-linenumber="1547"><td class="num" id="LN1547">1547</td><td class="line">     <span class='comment'>* is running for too much time.</span></td></tr>
<tr class="codeline" data-linenumber="1548"><td class="num" id="LN1548">1548</td><td class="line">     <span class='comment'>* We set the hook only if the time limit is enabled as the hook will</span></td></tr>
<tr class="codeline" data-linenumber="1549"><td class="num" id="LN1549">1549</td><td class="line">     <span class='comment'>* make the Lua script execution slower.</span></td></tr>
<tr class="codeline" data-linenumber="1550"><td class="num" id="LN1550">1550</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1551"><td class="num" id="LN1551">1551</td><td class="line">     <span class='comment'>* If we are debugging, we set instead a "line" hook so that the</span></td></tr>
<tr class="codeline" data-linenumber="1552"><td class="num" id="LN1552">1552</td><td class="line">     <span class='comment'>* debugger is call-back at every line executed by the script. */</span></td></tr>
<tr class="codeline" data-linenumber="1553"><td class="num" id="LN1553">1553</td><td class="line">    server.lua_caller = c;</td></tr>
<tr class="codeline" data-linenumber="1554"><td class="num" id="LN1554">1554</td><td class="line">    server.lua_cur_script = funcname + 2;</td></tr>
<tr class="codeline" data-linenumber="1555"><td class="num" id="LN1555">1555</td><td class="line">    server.lua_time_start = mstime();</td></tr>
<tr class="codeline" data-linenumber="1556"><td class="num" id="LN1556">1556</td><td class="line">    server.lua_kill = 0;</td></tr>
<tr class="codeline" data-linenumber="1557"><td class="num" id="LN1557">1557</td><td class="line">    <span class='keyword'>if</span> (server.lua_time_limit &gt; 0 &amp;&amp; ldb.active == 0) {</td></tr>
<tr class="codeline" data-linenumber="1558"><td class="num" id="LN1558">1558</td><td class="line">        lua_sethook(lua,luaMaskCountHook,<span class='macro'>LUA_MASKCOUNT<span class='macro_popup'>(1 &lt;&lt; 3)</span></span>,100000);</td></tr>
<tr class="codeline" data-linenumber="1559"><td class="num" id="LN1559">1559</td><td class="line">        delhook = 1;</td></tr>
<tr class="codeline" data-linenumber="1560"><td class="num" id="LN1560">1560</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (ldb.active) {</td></tr>
<tr class="codeline" data-linenumber="1561"><td class="num" id="LN1561">1561</td><td class="line">        lua_sethook(server.lua,luaLdbLineHook,<span class='macro'>LUA_MASKLINE<span class='macro_popup'>(1 &lt;&lt; 2)</span></span>|<span class='macro'>LUA_MASKCOUNT<span class='macro_popup'>(1 &lt;&lt; 3)</span></span>,100000);</td></tr>
<tr class="codeline" data-linenumber="1562"><td class="num" id="LN1562">1562</td><td class="line">        delhook = 1;</td></tr>
<tr class="codeline" data-linenumber="1563"><td class="num" id="LN1563">1563</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1564"><td class="num" id="LN1564">1564</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1565"><td class="num" id="LN1565">1565</td><td class="line">    prepareLuaClient();</td></tr>
<tr class="codeline" data-linenumber="1566"><td class="num" id="LN1566">1566</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1567"><td class="num" id="LN1567">1567</td><td class="line">    <span class='comment'>/* At this point whether this script was never seen before or if it was</span></td></tr>
<tr class="codeline" data-linenumber="1568"><td class="num" id="LN1568">1568</td><td class="line">     <span class='comment'>* already defined, we can call it. We have zero arguments and expect</span></td></tr>
<tr class="codeline" data-linenumber="1569"><td class="num" id="LN1569">1569</td><td class="line">     <span class='comment'>* a single return value. */</span></td></tr>
<tr class="codeline" data-linenumber="1570"><td class="num" id="LN1570">1570</td><td class="line">    err = lua_pcall(lua,0,1,-2);</td></tr>
<tr class="codeline" data-linenumber="1571"><td class="num" id="LN1571">1571</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1572"><td class="num" id="LN1572">1572</td><td class="line">    resetLuaClient();</td></tr>
<tr class="codeline" data-linenumber="1573"><td class="num" id="LN1573">1573</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1574"><td class="num" id="LN1574">1574</td><td class="line">    <span class='comment'>/* Perform some cleanup that we need to do both on error and success. */</span></td></tr>
<tr class="codeline" data-linenumber="1575"><td class="num" id="LN1575">1575</td><td class="line">    <span class='keyword'>if</span> (delhook) lua_sethook(lua,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,0,0); <span class='comment'>/* Disable hook */</span></td></tr>
<tr class="codeline" data-linenumber="1576"><td class="num" id="LN1576">1576</td><td class="line">    <span class='keyword'>if</span> (server.lua_timedout) {</td></tr>
<tr class="codeline" data-linenumber="1577"><td class="num" id="LN1577">1577</td><td class="line">        server.lua_timedout = 0;</td></tr>
<tr class="codeline" data-linenumber="1578"><td class="num" id="LN1578">1578</td><td class="line">        <span class='comment'>/* Restore the client that was protected when the script timeout</span></td></tr>
<tr class="codeline" data-linenumber="1579"><td class="num" id="LN1579">1579</td><td class="line">         <span class='comment'>* was detected. */</span></td></tr>
<tr class="codeline" data-linenumber="1580"><td class="num" id="LN1580">1580</td><td class="line">        unprotectClient(c);</td></tr>
<tr class="codeline" data-linenumber="1581"><td class="num" id="LN1581">1581</td><td class="line">        <span class='keyword'>if</span> (server.masterhost &amp;&amp; server.master)</td></tr>
<tr class="codeline" data-linenumber="1582"><td class="num" id="LN1582">1582</td><td class="line">            queueClientForReprocessing(server.master);</td></tr>
<tr class="codeline" data-linenumber="1583"><td class="num" id="LN1583">1583</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1584"><td class="num" id="LN1584">1584</td><td class="line">    server.lua_caller = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1585"><td class="num" id="LN1585">1585</td><td class="line">    server.lua_cur_script = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1586"><td class="num" id="LN1586">1586</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1587"><td class="num" id="LN1587">1587</td><td class="line">    <span class='comment'>/* Call the Lua garbage collector from time to time to avoid a</span></td></tr>
<tr class="codeline" data-linenumber="1588"><td class="num" id="LN1588">1588</td><td class="line">     <span class='comment'>* full cycle performed by Lua, which adds too latency.</span></td></tr>
<tr class="codeline" data-linenumber="1589"><td class="num" id="LN1589">1589</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1590"><td class="num" id="LN1590">1590</td><td class="line">     <span class='comment'>* The call is performed every LUA_GC_CYCLE_PERIOD executed commands</span></td></tr>
<tr class="codeline" data-linenumber="1591"><td class="num" id="LN1591">1591</td><td class="line">     <span class='comment'>* (and for LUA_GC_CYCLE_PERIOD collection steps) because calling it</span></td></tr>
<tr class="codeline" data-linenumber="1592"><td class="num" id="LN1592">1592</td><td class="line">     <span class='comment'>* for every command uses too much CPU. */</span></td></tr>
<tr class="codeline" data-linenumber="1593"><td class="num" id="LN1593">1593</td><td class="line">    <span class='directive'>#define <span class='macro'>LUA_GC_CYCLE_PERIOD<span class='macro_popup'>50</span></span> 50</span></td></tr>
<tr class="codeline" data-linenumber="1594"><td class="num" id="LN1594">1594</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1595"><td class="num" id="LN1595">1595</td><td class="line">        <span class='keyword'>static</span> <span class='keyword'>long</span> gc_count = 0;</td></tr>
<tr class="codeline" data-linenumber="1596"><td class="num" id="LN1596">1596</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1597"><td class="num" id="LN1597">1597</td><td class="line">        gc_count++;</td></tr>
<tr class="codeline" data-linenumber="1598"><td class="num" id="LN1598">1598</td><td class="line">        <span class='keyword'>if</span> (gc_count == <span class='macro'>LUA_GC_CYCLE_PERIOD<span class='macro_popup'>50</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1599"><td class="num" id="LN1599">1599</td><td class="line">            lua_gc(lua,<span class='macro'>LUA_GCSTEP<span class='macro_popup'>5</span></span>,<span class='macro'>LUA_GC_CYCLE_PERIOD<span class='macro_popup'>50</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1600"><td class="num" id="LN1600">1600</td><td class="line">            gc_count = 0;</td></tr>
<tr class="codeline" data-linenumber="1601"><td class="num" id="LN1601">1601</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1602"><td class="num" id="LN1602">1602</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1603"><td class="num" id="LN1603">1603</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1604"><td class="num" id="LN1604">1604</td><td class="line">    <span class='keyword'>if</span> (err) {</td></tr>
<tr class="codeline" data-linenumber="1605"><td class="num" id="LN1605">1605</td><td class="line">        addReplyErrorFormat(c,<span class='string_literal'>"Error running script (call to %s): %s\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="1606"><td class="num" id="LN1606">1606</td><td class="line">            funcname, <span class='macro'>lua_tostring(lua,-1)<span class='macro_popup'>lua_tolstring(lua, (-1), ((void*)0))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1607"><td class="num" id="LN1607">1607</td><td class="line">        <span class='macro'>lua_pop(lua,2)<span class='macro_popup'>lua_settop(lua, -(2)-1)</span></span>; <span class='comment'>/* Consume the Lua reply and remove error handler. */</span></td></tr>
<tr class="codeline" data-linenumber="1608"><td class="num" id="LN1608">1608</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1609"><td class="num" id="LN1609">1609</td><td class="line">        <span class='comment'>/* On success convert the Lua return value into Redis protocol, and</span></td></tr>
<tr class="codeline" data-linenumber="1610"><td class="num" id="LN1610">1610</td><td class="line">         <span class='comment'>* send it to * the client. */</span></td></tr>
<tr class="codeline" data-linenumber="1611"><td class="num" id="LN1611">1611</td><td class="line">        luaReplyToRedisReply(c,lua); <span class='comment'>/* Convert and consume the reply. */</span></td></tr>
<tr class="codeline" data-linenumber="1612"><td class="num" id="LN1612">1612</td><td class="line">        <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>; <span class='comment'>/* Remove the error handler. */</span></td></tr>
<tr class="codeline" data-linenumber="1613"><td class="num" id="LN1613">1613</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1614"><td class="num" id="LN1614">1614</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1615"><td class="num" id="LN1615">1615</td><td class="line">    <span class='comment'>/* If we are using single commands replication, emit EXEC if there</span></td></tr>
<tr class="codeline" data-linenumber="1616"><td class="num" id="LN1616">1616</td><td class="line">     <span class='comment'>* was at least a write. */</span></td></tr>
<tr class="codeline" data-linenumber="1617"><td class="num" id="LN1617">1617</td><td class="line">    <span class='keyword'>if</span> (server.lua_replicate_commands) {</td></tr>
<tr class="codeline" data-linenumber="1618"><td class="num" id="LN1618">1618</td><td class="line">        preventCommandPropagation(c);</td></tr>
<tr class="codeline" data-linenumber="1619"><td class="num" id="LN1619">1619</td><td class="line">        <span class='keyword'>if</span> (server.lua_multi_emitted) {</td></tr>
<tr class="codeline" data-linenumber="1620"><td class="num" id="LN1620">1620</td><td class="line">            execCommandPropagateExec(c);</td></tr>
<tr class="codeline" data-linenumber="1621"><td class="num" id="LN1621">1621</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1622"><td class="num" id="LN1622">1622</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1623"><td class="num" id="LN1623">1623</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1624"><td class="num" id="LN1624">1624</td><td class="line">    <span class='comment'>/* EVALSHA should be propagated to Slave and AOF file as full EVAL, unless</span></td></tr>
<tr class="codeline" data-linenumber="1625"><td class="num" id="LN1625">1625</td><td class="line">     <span class='comment'>* we are sure that the script was already in the context of all the</span></td></tr>
<tr class="codeline" data-linenumber="1626"><td class="num" id="LN1626">1626</td><td class="line">     <span class='comment'>* attached slaves *and* the current AOF file if enabled.</span></td></tr>
<tr class="codeline" data-linenumber="1627"><td class="num" id="LN1627">1627</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1628"><td class="num" id="LN1628">1628</td><td class="line">     <span class='comment'>* To do so we use a cache of SHA1s of scripts that we already propagated</span></td></tr>
<tr class="codeline" data-linenumber="1629"><td class="num" id="LN1629">1629</td><td class="line">     <span class='comment'>* as full EVAL, that's called the Replication Script Cache.</span></td></tr>
<tr class="codeline" data-linenumber="1630"><td class="num" id="LN1630">1630</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1631"><td class="num" id="LN1631">1631</td><td class="line">     <span class='comment'>* For replication, everytime a new slave attaches to the master, we need to</span></td></tr>
<tr class="codeline" data-linenumber="1632"><td class="num" id="LN1632">1632</td><td class="line">     <span class='comment'>* flush our cache of scripts that can be replicated as EVALSHA, while</span></td></tr>
<tr class="codeline" data-linenumber="1633"><td class="num" id="LN1633">1633</td><td class="line">     <span class='comment'>* for AOF we need to do so every time we rewrite the AOF file. */</span></td></tr>
<tr class="codeline" data-linenumber="1634"><td class="num" id="LN1634">1634</td><td class="line">    <span class='keyword'>if</span> (evalsha &amp;&amp; !server.lua_replicate_commands) {</td></tr>
<tr class="codeline" data-linenumber="1635"><td class="num" id="LN1635">1635</td><td class="line">        <span class='keyword'>if</span> (!replicationScriptCacheExists(c-&gt;argv[1]-&gt;ptr)) {</td></tr>
<tr class="codeline" data-linenumber="1636"><td class="num" id="LN1636">1636</td><td class="line">            <span class='comment'>/* This script is not in our script cache, replicate it as</span></td></tr>
<tr class="codeline" data-linenumber="1637"><td class="num" id="LN1637">1637</td><td class="line">             <span class='comment'>* EVAL, then add it into the script cache, as from now on</span></td></tr>
<tr class="codeline" data-linenumber="1638"><td class="num" id="LN1638">1638</td><td class="line">             <span class='comment'>* slaves and AOF know about it. */</span></td></tr>
<tr class="codeline" data-linenumber="1639"><td class="num" id="LN1639">1639</td><td class="line">            robj *script = dictFetchValue(server.lua_scripts,c-&gt;argv[1]-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="1640"><td class="num" id="LN1640">1640</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1641"><td class="num" id="LN1641">1641</td><td class="line">            replicationScriptCacheAdd(c-&gt;argv[1]-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="1642"><td class="num" id="LN1642">1642</td><td class="line">            <span class='macro'>serverAssertWithInfo(c,NULL,script != NULL)<span class='macro_popup'>((script != ((void*)0))?(void)0 : (_serverAssertWithInfo(c,((<br>void*)0),"script != NULL","scripting.c",1642),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1643"><td class="num" id="LN1643">1643</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1644"><td class="num" id="LN1644">1644</td><td class="line">            <span class='comment'>/* If the script did not produce any changes in the dataset we want</span></td></tr>
<tr class="codeline" data-linenumber="1645"><td class="num" id="LN1645">1645</td><td class="line">             <span class='comment'>* just to replicate it as SCRIPT LOAD, otherwise we risk running</span></td></tr>
<tr class="codeline" data-linenumber="1646"><td class="num" id="LN1646">1646</td><td class="line">             <span class='comment'>* an aborted script on slaves (that may then produce results there)</span></td></tr>
<tr class="codeline" data-linenumber="1647"><td class="num" id="LN1647">1647</td><td class="line">             <span class='comment'>* or just running a CPU costly read-only script on the slaves. */</span></td></tr>
<tr class="codeline" data-linenumber="1648"><td class="num" id="LN1648">1648</td><td class="line">            <span class='keyword'>if</span> (server.dirty == initial_server_dirty) {</td></tr>
<tr class="codeline" data-linenumber="1649"><td class="num" id="LN1649">1649</td><td class="line">                rewriteClientCommandVector(c,3,</td></tr>
<tr class="codeline" data-linenumber="1650"><td class="num" id="LN1650">1650</td><td class="line">                    resetRefCount(createStringObject(<span class='string_literal'>"SCRIPT"</span>,6)),</td></tr>
<tr class="codeline" data-linenumber="1651"><td class="num" id="LN1651">1651</td><td class="line">                    resetRefCount(createStringObject(<span class='string_literal'>"LOAD"</span>,4)),</td></tr>
<tr class="codeline" data-linenumber="1652"><td class="num" id="LN1652">1652</td><td class="line">                    script);</td></tr>
<tr class="codeline" data-linenumber="1653"><td class="num" id="LN1653">1653</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1654"><td class="num" id="LN1654">1654</td><td class="line">                rewriteClientCommandArgument(c,0,</td></tr>
<tr class="codeline" data-linenumber="1655"><td class="num" id="LN1655">1655</td><td class="line">                    resetRefCount(createStringObject(<span class='string_literal'>"EVAL"</span>,4)));</td></tr>
<tr class="codeline" data-linenumber="1656"><td class="num" id="LN1656">1656</td><td class="line">                rewriteClientCommandArgument(c,1,script);</td></tr>
<tr class="codeline" data-linenumber="1657"><td class="num" id="LN1657">1657</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1658"><td class="num" id="LN1658">1658</td><td class="line">            forceCommandPropagation(c,<span class='macro'>PROPAGATE_REPL<span class='macro_popup'>2</span></span>|<span class='macro'>PROPAGATE_AOF<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1659"><td class="num" id="LN1659">1659</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1660"><td class="num" id="LN1660">1660</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1661"><td class="num" id="LN1661">1661</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1662"><td class="num" id="LN1662">1662</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1663"><td class="num" id="LN1663">1663</td><td class="line"><span class='keyword'>void</span> evalCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="1664"><td class="num" id="LN1664">1664</td><td class="line">    <span class='keyword'>if</span> (!(c-&gt;flags &amp; <span class='macro'>CLIENT_LUA_DEBUG<span class='macro_popup'>(1&lt;&lt;25)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="1665"><td class="num" id="LN1665">1665</td><td class="line">        evalGenericCommand(c,0);</td></tr>
<tr class="codeline" data-linenumber="1666"><td class="num" id="LN1666">1666</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1667"><td class="num" id="LN1667">1667</td><td class="line">        evalGenericCommandWithDebugging(c,0);</td></tr>
<tr class="codeline" data-linenumber="1668"><td class="num" id="LN1668">1668</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1669"><td class="num" id="LN1669">1669</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1670"><td class="num" id="LN1670">1670</td><td class="line"><span class='keyword'>void</span> evalShaCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="1671"><td class="num" id="LN1671">1671</td><td class="line">    <span class='keyword'>if</span> (sdslen(c-&gt;argv[1]-&gt;ptr) != 40) {</td></tr>
<tr class="codeline" data-linenumber="1672"><td class="num" id="LN1672">1672</td><td class="line">        <span class='comment'>/* We know that a match is not possible if the provided SHA is</span></td></tr>
<tr class="codeline" data-linenumber="1673"><td class="num" id="LN1673">1673</td><td class="line">         <span class='comment'>* not the right length. So we return an error ASAP, this way</span></td></tr>
<tr class="codeline" data-linenumber="1674"><td class="num" id="LN1674">1674</td><td class="line">         <span class='comment'>* evalGenericCommand() can be implemented without string length</span></td></tr>
<tr class="codeline" data-linenumber="1675"><td class="num" id="LN1675">1675</td><td class="line">         <span class='comment'>* sanity check */</span></td></tr>
<tr class="codeline" data-linenumber="1676"><td class="num" id="LN1676">1676</td><td class="line">        addReply(c, shared.noscripterr);</td></tr>
<tr class="codeline" data-linenumber="1677"><td class="num" id="LN1677">1677</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1678"><td class="num" id="LN1678">1678</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1679"><td class="num" id="LN1679">1679</td><td class="line">    <span class='keyword'>if</span> (!(c-&gt;flags &amp; <span class='macro'>CLIENT_LUA_DEBUG<span class='macro_popup'>(1&lt;&lt;25)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="1680"><td class="num" id="LN1680">1680</td><td class="line">        evalGenericCommand(c,1);</td></tr>
<tr class="codeline" data-linenumber="1681"><td class="num" id="LN1681">1681</td><td class="line">    <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1682"><td class="num" id="LN1682">1682</td><td class="line">        addReplyError(c,<span class='string_literal'>"Please use EVAL instead of EVALSHA for debugging"</span>);</td></tr>
<tr class="codeline" data-linenumber="1683"><td class="num" id="LN1683">1683</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1684"><td class="num" id="LN1684">1684</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1685"><td class="num" id="LN1685">1685</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1686"><td class="num" id="LN1686">1686</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1687"><td class="num" id="LN1687">1687</td><td class="line"><span class='keyword'>void</span> scriptCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="1688"><td class="num" id="LN1688">1688</td><td class="line">    <span class='keyword'>if</span> (c-&gt;argc == 2 &amp;&amp; !strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class='string_literal'>"help"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="1689"><td class="num" id="LN1689">1689</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>char</span> *help[] = {</td></tr>
<tr class="codeline" data-linenumber="1690"><td class="num" id="LN1690">1690</td><td class="line"><span class='string_literal'>"DEBUG (yes|sync|no) -- Set the debug mode for subsequent scripts executed."</span>,</td></tr>
<tr class="codeline" data-linenumber="1691"><td class="num" id="LN1691">1691</td><td class="line"><span class='string_literal'>"EXISTS &lt;sha1&gt; [&lt;sha1&gt; ...] -- Return information about the existence of the scripts in the script cache."</span>,</td></tr>
<tr class="codeline" data-linenumber="1692"><td class="num" id="LN1692">1692</td><td class="line"><span class='string_literal'>"FLUSH -- Flush the Lua scripts cache. Very dangerous on replicas."</span>,</td></tr>
<tr class="codeline" data-linenumber="1693"><td class="num" id="LN1693">1693</td><td class="line"><span class='string_literal'>"KILL -- Kill the currently executing Lua script."</span>,</td></tr>
<tr class="codeline" data-linenumber="1694"><td class="num" id="LN1694">1694</td><td class="line"><span class='string_literal'>"LOAD &lt;script&gt; -- Load a script into the scripts cache, without executing it."</span>,</td></tr>
<tr class="codeline" data-linenumber="1695"><td class="num" id="LN1695">1695</td><td class="line"><span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span></td></tr>
<tr class="codeline" data-linenumber="1696"><td class="num" id="LN1696">1696</td><td class="line">        };</td></tr>
<tr class="codeline" data-linenumber="1697"><td class="num" id="LN1697">1697</td><td class="line">        addReplyHelp(c, help);</td></tr>
<tr class="codeline" data-linenumber="1698"><td class="num" id="LN1698">1698</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (c-&gt;argc == 2 &amp;&amp; !strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class='string_literal'>"flush"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="1699"><td class="num" id="LN1699">1699</td><td class="line">        scriptingReset();</td></tr>
<tr class="codeline" data-linenumber="1700"><td class="num" id="LN1700">1700</td><td class="line">        addReply(c,shared.ok);</td></tr>
<tr class="codeline" data-linenumber="1701"><td class="num" id="LN1701">1701</td><td class="line">        replicationScriptCacheFlush();</td></tr>
<tr class="codeline" data-linenumber="1702"><td class="num" id="LN1702">1702</td><td class="line">        server.dirty++; <span class='comment'>/* Propagating this command is a good idea. */</span></td></tr>
<tr class="codeline" data-linenumber="1703"><td class="num" id="LN1703">1703</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (c-&gt;argc &gt;= 2 &amp;&amp; !strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class='string_literal'>"exists"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="1704"><td class="num" id="LN1704">1704</td><td class="line">        <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="1705"><td class="num" id="LN1705">1705</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1706"><td class="num" id="LN1706">1706</td><td class="line">        addReplyArrayLen(c, c-&gt;argc-2);</td></tr>
<tr class="codeline" data-linenumber="1707"><td class="num" id="LN1707">1707</td><td class="line">        <span class='keyword'>for</span> (j = 2; j &lt; c-&gt;argc; j++) {</td></tr>
<tr class="codeline" data-linenumber="1708"><td class="num" id="LN1708">1708</td><td class="line">            <span class='keyword'>if</span> (dictFind(server.lua_scripts,c-&gt;argv[j]-&gt;ptr))</td></tr>
<tr class="codeline" data-linenumber="1709"><td class="num" id="LN1709">1709</td><td class="line">                addReply(c,shared.cone);</td></tr>
<tr class="codeline" data-linenumber="1710"><td class="num" id="LN1710">1710</td><td class="line">            <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1711"><td class="num" id="LN1711">1711</td><td class="line">                addReply(c,shared.czero);</td></tr>
<tr class="codeline" data-linenumber="1712"><td class="num" id="LN1712">1712</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1713"><td class="num" id="LN1713">1713</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (c-&gt;argc == 3 &amp;&amp; !strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class='string_literal'>"load"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="1714"><td class="num" id="LN1714">1714</td><td class="line">        sds sha = luaCreateFunction(c,server.lua,c-&gt;argv[2]);</td></tr>
<tr class="codeline" data-linenumber="1715"><td class="num" id="LN1715">1715</td><td class="line">        <span class='keyword'>if</span> (sha == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span>; <span class='comment'>/* The error was sent by luaCreateFunction(). */</span></td></tr>
<tr class="codeline" data-linenumber="1716"><td class="num" id="LN1716">1716</td><td class="line">        addReplyBulkCBuffer(c,sha,40);</td></tr>
<tr class="codeline" data-linenumber="1717"><td class="num" id="LN1717">1717</td><td class="line">        forceCommandPropagation(c,<span class='macro'>PROPAGATE_REPL<span class='macro_popup'>2</span></span>|<span class='macro'>PROPAGATE_AOF<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1718"><td class="num" id="LN1718">1718</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (c-&gt;argc == 2 &amp;&amp; !strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class='string_literal'>"kill"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="1719"><td class="num" id="LN1719">1719</td><td class="line">        <span class='keyword'>if</span> (server.lua_caller == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1720"><td class="num" id="LN1720">1720</td><td class="line">            addReplySds(c,sdsnew(<span class='string_literal'>"-NOTBUSY No scripts in execution right now.\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="1721"><td class="num" id="LN1721">1721</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (server.lua_caller-&gt;flags &amp; <span class='macro'>CLIENT_MASTER<span class='macro_popup'>(1&lt;&lt;1)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1722"><td class="num" id="LN1722">1722</td><td class="line">            addReplySds(c,sdsnew(<span class='string_literal'>"-UNKILLABLE The busy script was sent by a master instance in the context of replication and cannot be killed.\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="1723"><td class="num" id="LN1723">1723</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (server.lua_write_dirty) {</td></tr>
<tr class="codeline" data-linenumber="1724"><td class="num" id="LN1724">1724</td><td class="line">            addReplySds(c,sdsnew(<span class='string_literal'>"-UNKILLABLE Sorry the script already executed write commands against the dataset. You can either wait the script termination or kill the server in a hard way using the SHUTDOWN NOSAVE command.\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="1725"><td class="num" id="LN1725">1725</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1726"><td class="num" id="LN1726">1726</td><td class="line">            server.lua_kill = 1;</td></tr>
<tr class="codeline" data-linenumber="1727"><td class="num" id="LN1727">1727</td><td class="line">            addReply(c,shared.ok);</td></tr>
<tr class="codeline" data-linenumber="1728"><td class="num" id="LN1728">1728</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1729"><td class="num" id="LN1729">1729</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (c-&gt;argc == 3 &amp;&amp; !strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class='string_literal'>"debug"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="1730"><td class="num" id="LN1730">1730</td><td class="line">        <span class='keyword'>if</span> (clientHasPendingReplies(c)) {</td></tr>
<tr class="codeline" data-linenumber="1731"><td class="num" id="LN1731">1731</td><td class="line">            addReplyError(c,<span class='string_literal'>"SCRIPT DEBUG must be called outside a pipeline"</span>);</td></tr>
<tr class="codeline" data-linenumber="1732"><td class="num" id="LN1732">1732</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1733"><td class="num" id="LN1733">1733</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1734"><td class="num" id="LN1734">1734</td><td class="line">        <span class='keyword'>if</span> (!strcasecmp(c-&gt;argv[2]-&gt;ptr,<span class='string_literal'>"no"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="1735"><td class="num" id="LN1735">1735</td><td class="line">            ldbDisable(c);</td></tr>
<tr class="codeline" data-linenumber="1736"><td class="num" id="LN1736">1736</td><td class="line">            addReply(c,shared.ok);</td></tr>
<tr class="codeline" data-linenumber="1737"><td class="num" id="LN1737">1737</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(c-&gt;argv[2]-&gt;ptr,<span class='string_literal'>"yes"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="1738"><td class="num" id="LN1738">1738</td><td class="line">            ldbEnable(c);</td></tr>
<tr class="codeline" data-linenumber="1739"><td class="num" id="LN1739">1739</td><td class="line">            addReply(c,shared.ok);</td></tr>
<tr class="codeline" data-linenumber="1740"><td class="num" id="LN1740">1740</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(c-&gt;argv[2]-&gt;ptr,<span class='string_literal'>"sync"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="1741"><td class="num" id="LN1741">1741</td><td class="line">            ldbEnable(c);</td></tr>
<tr class="codeline" data-linenumber="1742"><td class="num" id="LN1742">1742</td><td class="line">            addReply(c,shared.ok);</td></tr>
<tr class="codeline" data-linenumber="1743"><td class="num" id="LN1743">1743</td><td class="line">            c-&gt;flags |= <span class='macro'>CLIENT_LUA_DEBUG_SYNC<span class='macro_popup'>(1&lt;&lt;26)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1744"><td class="num" id="LN1744">1744</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1745"><td class="num" id="LN1745">1745</td><td class="line">            addReplyError(c,<span class='string_literal'>"Use SCRIPT DEBUG yes/sync/no"</span>);</td></tr>
<tr class="codeline" data-linenumber="1746"><td class="num" id="LN1746">1746</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1747"><td class="num" id="LN1747">1747</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1748"><td class="num" id="LN1748">1748</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1749"><td class="num" id="LN1749">1749</td><td class="line">        addReplySubcommandSyntaxError(c);</td></tr>
<tr class="codeline" data-linenumber="1750"><td class="num" id="LN1750">1750</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1751"><td class="num" id="LN1751">1751</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1752"><td class="num" id="LN1752">1752</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1753"><td class="num" id="LN1753">1753</td><td class="line"><span class='comment'>/* ---------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="1754"><td class="num" id="LN1754">1754</td><td class="line"> <span class='comment'>* LDB: Redis Lua debugging facilities</span></td></tr>
<tr class="codeline" data-linenumber="1755"><td class="num" id="LN1755">1755</td><td class="line"> <span class='comment'>* ------------------------------------------------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="1756"><td class="num" id="LN1756">1756</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1757"><td class="num" id="LN1757">1757</td><td class="line"><span class='comment'>/* Initialize Lua debugger data structures. */</span></td></tr>
<tr class="codeline" data-linenumber="1758"><td class="num" id="LN1758">1758</td><td class="line"><span class='keyword'>void</span> ldbInit(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1759"><td class="num" id="LN1759">1759</td><td class="line">    ldb.conn = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1760"><td class="num" id="LN1760">1760</td><td class="line">    ldb.active = 0;</td></tr>
<tr class="codeline" data-linenumber="1761"><td class="num" id="LN1761">1761</td><td class="line">    ldb.logs = listCreate();</td></tr>
<tr class="codeline" data-linenumber="1762"><td class="num" id="LN1762">1762</td><td class="line">    <span class='macro'>listSetFreeMethod(ldb.logs,(<span class='keyword'>void</span> (*)(<span class='keyword'>void</span>*))sdsfree)<span class='macro_popup'>((ldb.logs)-&gt;free = ((void (*)(void*))sdsfree))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1763"><td class="num" id="LN1763">1763</td><td class="line">    ldb.children = listCreate();</td></tr>
<tr class="codeline" data-linenumber="1764"><td class="num" id="LN1764">1764</td><td class="line">    ldb.src = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1765"><td class="num" id="LN1765">1765</td><td class="line">    ldb.lines = 0;</td></tr>
<tr class="codeline" data-linenumber="1766"><td class="num" id="LN1766">1766</td><td class="line">    ldb.cbuf = sdsempty();</td></tr>
<tr class="codeline" data-linenumber="1767"><td class="num" id="LN1767">1767</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1768"><td class="num" id="LN1768">1768</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1769"><td class="num" id="LN1769">1769</td><td class="line"><span class='comment'>/* Remove all the pending messages in the specified list. */</span></td></tr>
<tr class="codeline" data-linenumber="1770"><td class="num" id="LN1770">1770</td><td class="line"><span class='keyword'>void</span> ldbFlushLog(list *log) {</td></tr>
<tr class="codeline" data-linenumber="1771"><td class="num" id="LN1771">1771</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="1772"><td class="num" id="LN1772">1772</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1773"><td class="num" id="LN1773">1773</td><td class="line">    <span class='keyword'>while</span>((ln = <span class='macro'>listFirst(log)<span class='macro_popup'>((log)-&gt;head)</span></span>) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1774"><td class="num" id="LN1774">1774</td><td class="line">        listDelNode(log,ln);</td></tr>
<tr class="codeline" data-linenumber="1775"><td class="num" id="LN1775">1775</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1776"><td class="num" id="LN1776">1776</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1777"><td class="num" id="LN1777">1777</td><td class="line"><span class='comment'>/* Enable debug mode of Lua scripts for this client. */</span></td></tr>
<tr class="codeline" data-linenumber="1778"><td class="num" id="LN1778">1778</td><td class="line"><span class='keyword'>void</span> ldbEnable(client *c) {</td></tr>
<tr class="codeline" data-linenumber="1779"><td class="num" id="LN1779">1779</td><td class="line">    c-&gt;flags |= <span class='macro'>CLIENT_LUA_DEBUG<span class='macro_popup'>(1&lt;&lt;25)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1780"><td class="num" id="LN1780">1780</td><td class="line">    ldbFlushLog(ldb.logs);</td></tr>
<tr class="codeline" data-linenumber="1781"><td class="num" id="LN1781">1781</td><td class="line">    ldb.conn = c-&gt;conn;</td></tr>
<tr class="codeline" data-linenumber="1782"><td class="num" id="LN1782">1782</td><td class="line">    ldb.step = 1;</td></tr>
<tr class="codeline" data-linenumber="1783"><td class="num" id="LN1783">1783</td><td class="line">    ldb.bpcount = 0;</td></tr>
<tr class="codeline" data-linenumber="1784"><td class="num" id="LN1784">1784</td><td class="line">    ldb.luabp = 0;</td></tr>
<tr class="codeline" data-linenumber="1785"><td class="num" id="LN1785">1785</td><td class="line">    sdsfree(ldb.cbuf);</td></tr>
<tr class="codeline" data-linenumber="1786"><td class="num" id="LN1786">1786</td><td class="line">    ldb.cbuf = sdsempty();</td></tr>
<tr class="codeline" data-linenumber="1787"><td class="num" id="LN1787">1787</td><td class="line">    ldb.maxlen = <span class='macro'>LDB_MAX_LEN_DEFAULT<span class='macro_popup'>256</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1788"><td class="num" id="LN1788">1788</td><td class="line">    ldb.maxlen_hint_sent = 0;</td></tr>
<tr class="codeline" data-linenumber="1789"><td class="num" id="LN1789">1789</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1790"><td class="num" id="LN1790">1790</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1791"><td class="num" id="LN1791">1791</td><td class="line"><span class='comment'>/* Exit debugging mode from the POV of client. This function is not enough</span></td></tr>
<tr class="codeline" data-linenumber="1792"><td class="num" id="LN1792">1792</td><td class="line"> <span class='comment'>* to properly shut down a client debugging session, see ldbEndSession()</span></td></tr>
<tr class="codeline" data-linenumber="1793"><td class="num" id="LN1793">1793</td><td class="line"> <span class='comment'>* for more information. */</span></td></tr>
<tr class="codeline" data-linenumber="1794"><td class="num" id="LN1794">1794</td><td class="line"><span class='keyword'>void</span> ldbDisable(client *c) {</td></tr>
<tr class="codeline" data-linenumber="1795"><td class="num" id="LN1795">1795</td><td class="line">    c-&gt;flags &amp;= ~(<span class='macro'>CLIENT_LUA_DEBUG<span class='macro_popup'>(1&lt;&lt;25)</span></span>|<span class='macro'>CLIENT_LUA_DEBUG_SYNC<span class='macro_popup'>(1&lt;&lt;26)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1796"><td class="num" id="LN1796">1796</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1797"><td class="num" id="LN1797">1797</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1798"><td class="num" id="LN1798">1798</td><td class="line"><span class='comment'>/* Append a log entry to the specified LDB log. */</span></td></tr>
<tr class="codeline" data-linenumber="1799"><td class="num" id="LN1799">1799</td><td class="line"><span class='keyword'>void</span> ldbLog(sds entry) {</td></tr>
<tr class="codeline" data-linenumber="1800"><td class="num" id="LN1800">1800</td><td class="line">    listAddNodeTail(ldb.logs,entry);</td></tr>
<tr class="codeline" data-linenumber="1801"><td class="num" id="LN1801">1801</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1802"><td class="num" id="LN1802">1802</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1803"><td class="num" id="LN1803">1803</td><td class="line"><span class='comment'>/* A version of ldbLog() which prevents producing logs greater than</span></td></tr>
<tr class="codeline" data-linenumber="1804"><td class="num" id="LN1804">1804</td><td class="line"> <span class='comment'>* ldb.maxlen. The first time the limit is reached a hint is generated</span></td></tr>
<tr class="codeline" data-linenumber="1805"><td class="num" id="LN1805">1805</td><td class="line"> <span class='comment'>* to inform the user that reply trimming can be disabled using the</span></td></tr>
<tr class="codeline" data-linenumber="1806"><td class="num" id="LN1806">1806</td><td class="line"> <span class='comment'>* debugger "maxlen" command. */</span></td></tr>
<tr class="codeline" data-linenumber="1807"><td class="num" id="LN1807">1807</td><td class="line"><span class='keyword'>void</span> ldbLogWithMaxLen(sds entry) {</td></tr>
<tr class="codeline" data-linenumber="1808"><td class="num" id="LN1808">1808</td><td class="line">    <span class='keyword'>int</span> trimmed = 0;</td></tr>
<tr class="codeline" data-linenumber="1809"><td class="num" id="LN1809">1809</td><td class="line">    <span class='keyword'>if</span> (ldb.maxlen &amp;&amp; sdslen(entry) &gt; ldb.maxlen) {</td></tr>
<tr class="codeline" data-linenumber="1810"><td class="num" id="LN1810">1810</td><td class="line">        sdsrange(entry,0,ldb.maxlen-1);</td></tr>
<tr class="codeline" data-linenumber="1811"><td class="num" id="LN1811">1811</td><td class="line">        entry = sdscatlen(entry,<span class='string_literal'>" ..."</span>,4);</td></tr>
<tr class="codeline" data-linenumber="1812"><td class="num" id="LN1812">1812</td><td class="line">        trimmed = 1;</td></tr>
<tr class="codeline" data-linenumber="1813"><td class="num" id="LN1813">1813</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1814"><td class="num" id="LN1814">1814</td><td class="line">    ldbLog(entry);</td></tr>
<tr class="codeline" data-linenumber="1815"><td class="num" id="LN1815">1815</td><td class="line">    <span class='keyword'>if</span> (trimmed &amp;&amp; ldb.maxlen_hint_sent == 0) {</td></tr>
<tr class="codeline" data-linenumber="1816"><td class="num" id="LN1816">1816</td><td class="line">        ldb.maxlen_hint_sent = 1;</td></tr>
<tr class="codeline" data-linenumber="1817"><td class="num" id="LN1817">1817</td><td class="line">        ldbLog(sdsnew(</td></tr>
<tr class="codeline" data-linenumber="1818"><td class="num" id="LN1818">1818</td><td class="line">        <span class='string_literal'>"&lt;hint&gt; The above reply was trimmed. Use 'maxlen 0' to disable trimming."</span>));</td></tr>
<tr class="codeline" data-linenumber="1819"><td class="num" id="LN1819">1819</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1820"><td class="num" id="LN1820">1820</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1821"><td class="num" id="LN1821">1821</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1822"><td class="num" id="LN1822">1822</td><td class="line"><span class='comment'>/* Send ldb.logs to the debugging client as a multi-bulk reply</span></td></tr>
<tr class="codeline" data-linenumber="1823"><td class="num" id="LN1823">1823</td><td class="line"> <span class='comment'>* consisting of simple strings. Log entries which include newlines have them</span></td></tr>
<tr class="codeline" data-linenumber="1824"><td class="num" id="LN1824">1824</td><td class="line"> <span class='comment'>* replaced with spaces. The entries sent are also consumed. */</span></td></tr>
<tr class="codeline" data-linenumber="1825"><td class="num" id="LN1825">1825</td><td class="line"><span class='keyword'>void</span> ldbSendLogs(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1826"><td class="num" id="LN1826">1826</td><td class="line">    sds proto = sdsempty();</td></tr>
<tr class="codeline" data-linenumber="1827"><td class="num" id="LN1827">1827</td><td class="line">    proto = sdscatfmt(proto,<span class='string_literal'>"*%i\r\n"</span>, (<span class='keyword'>int</span>)<span class='macro'>listLength(ldb.logs)<span class='macro_popup'>((ldb.logs)-&gt;len)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1828"><td class="num" id="LN1828">1828</td><td class="line">    <span class='keyword'>while</span>(<span class='macro'>listLength(ldb.logs)<span class='macro_popup'>((ldb.logs)-&gt;len)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1829"><td class="num" id="LN1829">1829</td><td class="line">        listNode *ln = <span class='macro'>listFirst(ldb.logs)<span class='macro_popup'>((ldb.logs)-&gt;head)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1830"><td class="num" id="LN1830">1830</td><td class="line">        proto = sdscatlen(proto,<span class='string_literal'>"+"</span>,1);</td></tr>
<tr class="codeline" data-linenumber="1831"><td class="num" id="LN1831">1831</td><td class="line">        sdsmapchars(ln-&gt;value,<span class='string_literal'>"\r\n"</span>,<span class='string_literal'>"  "</span>,2);</td></tr>
<tr class="codeline" data-linenumber="1832"><td class="num" id="LN1832">1832</td><td class="line">        proto = sdscatsds(proto,ln-&gt;value);</td></tr>
<tr class="codeline" data-linenumber="1833"><td class="num" id="LN1833">1833</td><td class="line">        proto = sdscatlen(proto,<span class='string_literal'>"\r\n"</span>,2);</td></tr>
<tr class="codeline" data-linenumber="1834"><td class="num" id="LN1834">1834</td><td class="line">        listDelNode(ldb.logs,ln);</td></tr>
<tr class="codeline" data-linenumber="1835"><td class="num" id="LN1835">1835</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1836"><td class="num" id="LN1836">1836</td><td class="line">    <span class='keyword'>if</span> (connWrite(ldb.conn,proto,sdslen(proto)) == -1) {</td></tr>
<tr class="codeline" data-linenumber="1837"><td class="num" id="LN1837">1837</td><td class="line">        <span class='comment'>/* Avoid warning. We don't check the return value of write()</span></td></tr>
<tr class="codeline" data-linenumber="1838"><td class="num" id="LN1838">1838</td><td class="line">         <span class='comment'>* since the next read() will catch the I/O error and will</span></td></tr>
<tr class="codeline" data-linenumber="1839"><td class="num" id="LN1839">1839</td><td class="line">         <span class='comment'>* close the debugging session. */</span></td></tr>
<tr class="codeline" data-linenumber="1840"><td class="num" id="LN1840">1840</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1841"><td class="num" id="LN1841">1841</td><td class="line">    sdsfree(proto);</td></tr>
<tr class="codeline" data-linenumber="1842"><td class="num" id="LN1842">1842</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1843"><td class="num" id="LN1843">1843</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1844"><td class="num" id="LN1844">1844</td><td class="line"><span class='comment'>/* Start a debugging session before calling EVAL implementation.</span></td></tr>
<tr class="codeline" data-linenumber="1845"><td class="num" id="LN1845">1845</td><td class="line"> <span class='comment'>* The technique we use is to capture the client socket file descriptor,</span></td></tr>
<tr class="codeline" data-linenumber="1846"><td class="num" id="LN1846">1846</td><td class="line"> <span class='comment'>* in order to perform direct I/O with it from within Lua hooks. This</span></td></tr>
<tr class="codeline" data-linenumber="1847"><td class="num" id="LN1847">1847</td><td class="line"> <span class='comment'>* way we don't have to re-enter Redis in order to handle I/O.</span></td></tr>
<tr class="codeline" data-linenumber="1848"><td class="num" id="LN1848">1848</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1849"><td class="num" id="LN1849">1849</td><td class="line"> <span class='comment'>* The function returns 1 if the caller should proceed to call EVAL,</span></td></tr>
<tr class="codeline" data-linenumber="1850"><td class="num" id="LN1850">1850</td><td class="line"> <span class='comment'>* and 0 if instead the caller should abort the operation (this happens</span></td></tr>
<tr class="codeline" data-linenumber="1851"><td class="num" id="LN1851">1851</td><td class="line"> <span class='comment'>* for the parent in a forked session, since it's up to the children</span></td></tr>
<tr class="codeline" data-linenumber="1852"><td class="num" id="LN1852">1852</td><td class="line"> <span class='comment'>* to continue, or when fork returned an error).</span></td></tr>
<tr class="codeline" data-linenumber="1853"><td class="num" id="LN1853">1853</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1854"><td class="num" id="LN1854">1854</td><td class="line"> <span class='comment'>* The caller should call ldbEndSession() only if ldbStartSession()</span></td></tr>
<tr class="codeline" data-linenumber="1855"><td class="num" id="LN1855">1855</td><td class="line"> <span class='comment'>* returned 1. */</span></td></tr>
<tr class="codeline" data-linenumber="1856"><td class="num" id="LN1856">1856</td><td class="line"><span class='keyword'>int</span> ldbStartSession(client *c) {</td></tr>
<tr class="codeline" data-linenumber="1857"><td class="num" id="LN1857">1857</td><td class="line">    ldb.forked = (c-&gt;flags &amp; <span class='macro'>CLIENT_LUA_DEBUG_SYNC<span class='macro_popup'>(1&lt;&lt;26)</span></span>) == 0;</td></tr>
<tr class="codeline" data-linenumber="1858"><td class="num" id="LN1858">1858</td><td class="line">    <span class='keyword'>if</span> (ldb.forked) {</td></tr>
<tr class="codeline" data-linenumber="1859"><td class="num" id="LN1859">1859</td><td class="line">        pid_t cp = redisFork(<span class='macro'>CHILD_TYPE_LDB<span class='macro_popup'>3</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1860"><td class="num" id="LN1860">1860</td><td class="line">        <span class='keyword'>if</span> (cp == -1) {</td></tr>
<tr class="codeline" data-linenumber="1861"><td class="num" id="LN1861">1861</td><td class="line">            addReplyError(c,<span class='string_literal'>"Fork() failed: can't run EVAL in debugging mode."</span>);</td></tr>
<tr class="codeline" data-linenumber="1862"><td class="num" id="LN1862">1862</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1863"><td class="num" id="LN1863">1863</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (cp == 0) {</td></tr>
<tr class="codeline" data-linenumber="1864"><td class="num" id="LN1864">1864</td><td class="line">            <span class='comment'>/* Child. Let's ignore important signals handled by the parent. */</span></td></tr>
<tr class="codeline" data-linenumber="1865"><td class="num" id="LN1865">1865</td><td class="line">            <span class='keyword'>struct</span> sigaction act;</td></tr>
<tr class="codeline" data-linenumber="1866"><td class="num" id="LN1866">1866</td><td class="line">            sigemptyset(&amp;act.sa_mask);</td></tr>
<tr class="codeline" data-linenumber="1867"><td class="num" id="LN1867">1867</td><td class="line">            act.sa_flags = 0;</td></tr>
<tr class="codeline" data-linenumber="1868"><td class="num" id="LN1868">1868</td><td class="line">            act.<span class='macro'>sa_handler<span class='macro_popup'>__sigaction_handler.sa_handler</span></span> = <span class='macro'>SIG_IGN<span class='macro_popup'>((__sighandler_t) 1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1869"><td class="num" id="LN1869">1869</td><td class="line">            sigaction(<span class='macro'>SIGTERM<span class='macro_popup'>15</span></span>, &amp;act, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1870"><td class="num" id="LN1870">1870</td><td class="line">            sigaction(<span class='macro'>SIGINT<span class='macro_popup'>2</span></span>, &amp;act, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1871"><td class="num" id="LN1871">1871</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1872"><td class="num" id="LN1872">1872</td><td class="line">            <span class='comment'>/* Log the creation of the child and close the listening</span></td></tr>
<tr class="codeline" data-linenumber="1873"><td class="num" id="LN1873">1873</td><td class="line">             <span class='comment'>* socket to make sure if the parent crashes a reset is sent</span></td></tr>
<tr class="codeline" data-linenumber="1874"><td class="num" id="LN1874">1874</td><td class="line">             <span class='comment'>* to the clients. */</span></td></tr>
<tr class="codeline" data-linenumber="1875"><td class="num" id="LN1875">1875</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Redis forked for debugging eval"</span>);</td></tr>
<tr class="codeline" data-linenumber="1876"><td class="num" id="LN1876">1876</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1877"><td class="num" id="LN1877">1877</td><td class="line">            <span class='comment'>/* Parent */</span></td></tr>
<tr class="codeline" data-linenumber="1878"><td class="num" id="LN1878">1878</td><td class="line">            listAddNodeTail(ldb.children,(<span class='keyword'>void</span>*)(<span class='keyword'>unsigned</span> <span class='keyword'>long</span>)cp);</td></tr>
<tr class="codeline" data-linenumber="1879"><td class="num" id="LN1879">1879</td><td class="line">            freeClientAsync(c); <span class='comment'>/* Close the client in the parent side. */</span></td></tr>
<tr class="codeline" data-linenumber="1880"><td class="num" id="LN1880">1880</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1881"><td class="num" id="LN1881">1881</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1882"><td class="num" id="LN1882">1882</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1883"><td class="num" id="LN1883">1883</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1884"><td class="num" id="LN1884">1884</td><td class="line">            <span class='string_literal'>"Redis synchronous debugging eval session started"</span>);</td></tr>
<tr class="codeline" data-linenumber="1885"><td class="num" id="LN1885">1885</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1886"><td class="num" id="LN1886">1886</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1887"><td class="num" id="LN1887">1887</td><td class="line">    <span class='comment'>/* Setup our debugging session. */</span></td></tr>
<tr class="codeline" data-linenumber="1888"><td class="num" id="LN1888">1888</td><td class="line">    connBlock(ldb.conn);</td></tr>
<tr class="codeline" data-linenumber="1889"><td class="num" id="LN1889">1889</td><td class="line">    connSendTimeout(ldb.conn,5000);</td></tr>
<tr class="codeline" data-linenumber="1890"><td class="num" id="LN1890">1890</td><td class="line">    ldb.active = 1;</td></tr>
<tr class="codeline" data-linenumber="1891"><td class="num" id="LN1891">1891</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1892"><td class="num" id="LN1892">1892</td><td class="line">    <span class='comment'>/* First argument of EVAL is the script itself. We split it into different</span></td></tr>
<tr class="codeline" data-linenumber="1893"><td class="num" id="LN1893">1893</td><td class="line">     <span class='comment'>* lines since this is the way the debugger accesses the source code. */</span></td></tr>
<tr class="codeline" data-linenumber="1894"><td class="num" id="LN1894">1894</td><td class="line">    sds srcstring = sdsdup(c-&gt;argv[1]-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="1895"><td class="num" id="LN1895">1895</td><td class="line">    size_t srclen = sdslen(srcstring);</td></tr>
<tr class="codeline" data-linenumber="1896"><td class="num" id="LN1896">1896</td><td class="line">    <span class='keyword'>while</span>(srclen &amp;&amp; (srcstring[srclen-1] == '\n' ||</td></tr>
<tr class="codeline" data-linenumber="1897"><td class="num" id="LN1897">1897</td><td class="line">                     srcstring[srclen-1] == '\r'))</td></tr>
<tr class="codeline" data-linenumber="1898"><td class="num" id="LN1898">1898</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1899"><td class="num" id="LN1899">1899</td><td class="line">        srcstring[--srclen] = '\0';</td></tr>
<tr class="codeline" data-linenumber="1900"><td class="num" id="LN1900">1900</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1901"><td class="num" id="LN1901">1901</td><td class="line">    sdssetlen(srcstring,srclen);</td></tr>
<tr class="codeline" data-linenumber="1902"><td class="num" id="LN1902">1902</td><td class="line">    ldb.src = sdssplitlen(srcstring,sdslen(srcstring),<span class='string_literal'>"\n"</span>,1,&amp;ldb.lines);</td></tr>
<tr class="codeline" data-linenumber="1903"><td class="num" id="LN1903">1903</td><td class="line">    sdsfree(srcstring);</td></tr>
<tr class="codeline" data-linenumber="1904"><td class="num" id="LN1904">1904</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1905"><td class="num" id="LN1905">1905</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1906"><td class="num" id="LN1906">1906</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1907"><td class="num" id="LN1907">1907</td><td class="line"><span class='comment'>/* End a debugging session after the EVAL call with debugging enabled</span></td></tr>
<tr class="codeline" data-linenumber="1908"><td class="num" id="LN1908">1908</td><td class="line"> <span class='comment'>* returned. */</span></td></tr>
<tr class="codeline" data-linenumber="1909"><td class="num" id="LN1909">1909</td><td class="line"><span class='keyword'>void</span> ldbEndSession(client *c) {</td></tr>
<tr class="codeline" data-linenumber="1910"><td class="num" id="LN1910">1910</td><td class="line">    <span class='comment'>/* Emit the remaining logs and an &lt;endsession&gt; mark. */</span></td></tr>
<tr class="codeline" data-linenumber="1911"><td class="num" id="LN1911">1911</td><td class="line">    ldbLog(sdsnew(<span class='string_literal'>"&lt;endsession&gt;"</span>));</td></tr>
<tr class="codeline" data-linenumber="1912"><td class="num" id="LN1912">1912</td><td class="line">    ldbSendLogs();</td></tr>
<tr class="codeline" data-linenumber="1913"><td class="num" id="LN1913">1913</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1914"><td class="num" id="LN1914">1914</td><td class="line">    <span class='comment'>/* If it's a fork()ed session, we just exit. */</span></td></tr>
<tr class="codeline" data-linenumber="1915"><td class="num" id="LN1915">1915</td><td class="line">    <span class='keyword'>if</span> (ldb.forked) {</td></tr>
<tr class="codeline" data-linenumber="1916"><td class="num" id="LN1916">1916</td><td class="line">        writeToClient(c,0);</td></tr>
<tr class="codeline" data-linenumber="1917"><td class="num" id="LN1917">1917</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Lua debugging session child exiting"</span>);</td></tr>
<tr class="codeline" data-linenumber="1918"><td class="num" id="LN1918">1918</td><td class="line">        exitFromChild(0);</td></tr>
<tr class="codeline" data-linenumber="1919"><td class="num" id="LN1919">1919</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1920"><td class="num" id="LN1920">1920</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1921"><td class="num" id="LN1921">1921</td><td class="line">            <span class='string_literal'>"Redis synchronous debugging eval session ended"</span>);</td></tr>
<tr class="codeline" data-linenumber="1922"><td class="num" id="LN1922">1922</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1923"><td class="num" id="LN1923">1923</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1924"><td class="num" id="LN1924">1924</td><td class="line">    <span class='comment'>/* Otherwise let's restore client's state. */</span></td></tr>
<tr class="codeline" data-linenumber="1925"><td class="num" id="LN1925">1925</td><td class="line">    connNonBlock(ldb.conn);</td></tr>
<tr class="codeline" data-linenumber="1926"><td class="num" id="LN1926">1926</td><td class="line">    connSendTimeout(ldb.conn,0);</td></tr>
<tr class="codeline" data-linenumber="1927"><td class="num" id="LN1927">1927</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1928"><td class="num" id="LN1928">1928</td><td class="line">    <span class='comment'>/* Close the client connection after sending the final EVAL reply</span></td></tr>
<tr class="codeline" data-linenumber="1929"><td class="num" id="LN1929">1929</td><td class="line">     <span class='comment'>* in order to signal the end of the debugging session. */</span></td></tr>
<tr class="codeline" data-linenumber="1930"><td class="num" id="LN1930">1930</td><td class="line">    c-&gt;flags |= <span class='macro'>CLIENT_CLOSE_AFTER_REPLY<span class='macro_popup'>(1&lt;&lt;6)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1931"><td class="num" id="LN1931">1931</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1932"><td class="num" id="LN1932">1932</td><td class="line">    <span class='comment'>/* Cleanup. */</span></td></tr>
<tr class="codeline" data-linenumber="1933"><td class="num" id="LN1933">1933</td><td class="line">    sdsfreesplitres(ldb.src,ldb.lines);</td></tr>
<tr class="codeline" data-linenumber="1934"><td class="num" id="LN1934">1934</td><td class="line">    ldb.lines = 0;</td></tr>
<tr class="codeline" data-linenumber="1935"><td class="num" id="LN1935">1935</td><td class="line">    ldb.active = 0;</td></tr>
<tr class="codeline" data-linenumber="1936"><td class="num" id="LN1936">1936</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1937"><td class="num" id="LN1937">1937</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1938"><td class="num" id="LN1938">1938</td><td class="line"><span class='comment'>/* If the specified pid is among the list of children spawned for</span></td></tr>
<tr class="codeline" data-linenumber="1939"><td class="num" id="LN1939">1939</td><td class="line"> <span class='comment'>* forked debugging sessions, it is removed from the children list.</span></td></tr>
<tr class="codeline" data-linenumber="1940"><td class="num" id="LN1940">1940</td><td class="line"> <span class='comment'>* If the pid was found non-zero is returned. */</span></td></tr>
<tr class="codeline" data-linenumber="1941"><td class="num" id="LN1941">1941</td><td class="line"><span class='keyword'>int</span> ldbRemoveChild(pid_t pid) {</td></tr>
<tr class="codeline" data-linenumber="1942"><td class="num" id="LN1942">1942</td><td class="line">    listNode *ln = listSearchKey(ldb.children,(<span class='keyword'>void</span>*)(<span class='keyword'>unsigned</span> <span class='keyword'>long</span>)pid);</td></tr>
<tr class="codeline" data-linenumber="1943"><td class="num" id="LN1943">1943</td><td class="line">    <span class='keyword'>if</span> (ln) {</td></tr>
<tr class="codeline" data-linenumber="1944"><td class="num" id="LN1944">1944</td><td class="line">        listDelNode(ldb.children,ln);</td></tr>
<tr class="codeline" data-linenumber="1945"><td class="num" id="LN1945">1945</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1946"><td class="num" id="LN1946">1946</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1947"><td class="num" id="LN1947">1947</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1948"><td class="num" id="LN1948">1948</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1949"><td class="num" id="LN1949">1949</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1950"><td class="num" id="LN1950">1950</td><td class="line"><span class='comment'>/* Return the number of children we still did not receive termination</span></td></tr>
<tr class="codeline" data-linenumber="1951"><td class="num" id="LN1951">1951</td><td class="line"> <span class='comment'>* acknowledge via wait() in the parent process. */</span></td></tr>
<tr class="codeline" data-linenumber="1952"><td class="num" id="LN1952">1952</td><td class="line"><span class='keyword'>int</span> ldbPendingChildren(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1953"><td class="num" id="LN1953">1953</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>listLength(ldb.children)<span class='macro_popup'>((ldb.children)-&gt;len)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1954"><td class="num" id="LN1954">1954</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1955"><td class="num" id="LN1955">1955</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1956"><td class="num" id="LN1956">1956</td><td class="line"><span class='comment'>/* Kill all the forked sessions. */</span></td></tr>
<tr class="codeline" data-linenumber="1957"><td class="num" id="LN1957">1957</td><td class="line"><span class='keyword'>void</span> ldbKillForkedSessions(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1958"><td class="num" id="LN1958">1958</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="1959"><td class="num" id="LN1959">1959</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="1960"><td class="num" id="LN1960">1960</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1961"><td class="num" id="LN1961">1961</td><td class="line">    listRewind(ldb.children,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="1962"><td class="num" id="LN1962">1962</td><td class="line">    <span class='keyword'>while</span>((ln = listNext(&amp;li))) {</td></tr>
<tr class="codeline" data-linenumber="1963"><td class="num" id="LN1963">1963</td><td class="line">        pid_t pid = (<span class='keyword'>unsigned</span> <span class='keyword'>long</span>) ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="1964"><td class="num" id="LN1964">1964</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Killing debugging session %ld"</span>,(<span class='keyword'>long</span>)pid);</td></tr>
<tr class="codeline" data-linenumber="1965"><td class="num" id="LN1965">1965</td><td class="line">        kill(pid,<span class='macro'>SIGKILL<span class='macro_popup'>9</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1966"><td class="num" id="LN1966">1966</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1967"><td class="num" id="LN1967">1967</td><td class="line">    listRelease(ldb.children);</td></tr>
<tr class="codeline" data-linenumber="1968"><td class="num" id="LN1968">1968</td><td class="line">    ldb.children = listCreate();</td></tr>
<tr class="codeline" data-linenumber="1969"><td class="num" id="LN1969">1969</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1970"><td class="num" id="LN1970">1970</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1971"><td class="num" id="LN1971">1971</td><td class="line"><span class='comment'>/* Wrapper for EVAL / EVALSHA that enables debugging, and makes sure</span></td></tr>
<tr class="codeline" data-linenumber="1972"><td class="num" id="LN1972">1972</td><td class="line"> <span class='comment'>* that when EVAL returns, whatever happened, the session is ended. */</span></td></tr>
<tr class="codeline" data-linenumber="1973"><td class="num" id="LN1973">1973</td><td class="line"><span class='keyword'>void</span> evalGenericCommandWithDebugging(client *c, <span class='keyword'>int</span> evalsha) {</td></tr>
<tr class="codeline" data-linenumber="1974"><td class="num" id="LN1974">1974</td><td class="line">    <span class='keyword'>if</span> (ldbStartSession(c)) {</td></tr>
<tr class="codeline" data-linenumber="1975"><td class="num" id="LN1975">1975</td><td class="line">        evalGenericCommand(c,evalsha);</td></tr>
<tr class="codeline" data-linenumber="1976"><td class="num" id="LN1976">1976</td><td class="line">        ldbEndSession(c);</td></tr>
<tr class="codeline" data-linenumber="1977"><td class="num" id="LN1977">1977</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1978"><td class="num" id="LN1978">1978</td><td class="line">        ldbDisable(c);</td></tr>
<tr class="codeline" data-linenumber="1979"><td class="num" id="LN1979">1979</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1980"><td class="num" id="LN1980">1980</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1981"><td class="num" id="LN1981">1981</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1982"><td class="num" id="LN1982">1982</td><td class="line"><span class='comment'>/* Return a pointer to ldb.src source code line, considering line to be</span></td></tr>
<tr class="codeline" data-linenumber="1983"><td class="num" id="LN1983">1983</td><td class="line"> <span class='comment'>* one-based, and returning a special string for out of range lines. */</span></td></tr>
<tr class="codeline" data-linenumber="1984"><td class="num" id="LN1984">1984</td><td class="line"><span class='keyword'>char</span> *ldbGetSourceLine(<span class='keyword'>int</span> line) {</td></tr>
<tr class="codeline" data-linenumber="1985"><td class="num" id="LN1985">1985</td><td class="line">    <span class='keyword'>int</span> idx = line-1;</td></tr>
<tr class="codeline" data-linenumber="1986"><td class="num" id="LN1986">1986</td><td class="line">    <span class='keyword'>if</span> (idx &lt; 0 || idx &gt;= ldb.lines) <span class='keyword'>return</span> <span class='string_literal'>"&lt;out of range source code line&gt;"</span>;</td></tr>
<tr class="codeline" data-linenumber="1987"><td class="num" id="LN1987">1987</td><td class="line">    <span class='keyword'>return</span> ldb.src[idx];</td></tr>
<tr class="codeline" data-linenumber="1988"><td class="num" id="LN1988">1988</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1989"><td class="num" id="LN1989">1989</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1990"><td class="num" id="LN1990">1990</td><td class="line"><span class='comment'>/* Return true if there is a breakpoint in the specified line. */</span></td></tr>
<tr class="codeline" data-linenumber="1991"><td class="num" id="LN1991">1991</td><td class="line"><span class='keyword'>int</span> ldbIsBreakpoint(<span class='keyword'>int</span> line) {</td></tr>
<tr class="codeline" data-linenumber="1992"><td class="num" id="LN1992">1992</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="1993"><td class="num" id="LN1993">1993</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1994"><td class="num" id="LN1994">1994</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; ldb.bpcount; j++)</td></tr>
<tr class="codeline" data-linenumber="1995"><td class="num" id="LN1995">1995</td><td class="line">        <span class='keyword'>if</span> (ldb.bp[j] == line) <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1996"><td class="num" id="LN1996">1996</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1997"><td class="num" id="LN1997">1997</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1998"><td class="num" id="LN1998">1998</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1999"><td class="num" id="LN1999">1999</td><td class="line"><span class='comment'>/* Add the specified breakpoint. Ignore it if we already reached the max.</span></td></tr>
<tr class="codeline" data-linenumber="2000"><td class="num" id="LN2000">2000</td><td class="line"> <span class='comment'>* Returns 1 if the breakpoint was added (or was already set). 0 if there is</span></td></tr>
<tr class="codeline" data-linenumber="2001"><td class="num" id="LN2001">2001</td><td class="line"> <span class='comment'>* no space for the breakpoint or if the line is invalid. */</span></td></tr>
<tr class="codeline" data-linenumber="2002"><td class="num" id="LN2002">2002</td><td class="line"><span class='keyword'>int</span> ldbAddBreakpoint(<span class='keyword'>int</span> line) {</td></tr>
<tr class="codeline" data-linenumber="2003"><td class="num" id="LN2003">2003</td><td class="line">    <span class='keyword'>if</span> (line &lt;= 0 || line &gt; ldb.lines) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2004"><td class="num" id="LN2004">2004</td><td class="line">    <span class='keyword'>if</span> (!ldbIsBreakpoint(line) &amp;&amp; ldb.bpcount != <span class='macro'>LDB_BREAKPOINTS_MAX<span class='macro_popup'>64</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2005"><td class="num" id="LN2005">2005</td><td class="line">        ldb.bp[ldb.bpcount++] = line;</td></tr>
<tr class="codeline" data-linenumber="2006"><td class="num" id="LN2006">2006</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2007"><td class="num" id="LN2007">2007</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2008"><td class="num" id="LN2008">2008</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2009"><td class="num" id="LN2009">2009</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2010"><td class="num" id="LN2010">2010</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2011"><td class="num" id="LN2011">2011</td><td class="line"><span class='comment'>/* Remove the specified breakpoint, returning 1 if the operation was</span></td></tr>
<tr class="codeline" data-linenumber="2012"><td class="num" id="LN2012">2012</td><td class="line"> <span class='comment'>* performed or 0 if there was no such breakpoint. */</span></td></tr>
<tr class="codeline" data-linenumber="2013"><td class="num" id="LN2013">2013</td><td class="line"><span class='keyword'>int</span> ldbDelBreakpoint(<span class='keyword'>int</span> line) {</td></tr>
<tr class="codeline" data-linenumber="2014"><td class="num" id="LN2014">2014</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="2015"><td class="num" id="LN2015">2015</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2016"><td class="num" id="LN2016">2016</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; ldb.bpcount; j++) {</td></tr>
<tr class="codeline" data-linenumber="2017"><td class="num" id="LN2017">2017</td><td class="line">        <span class='keyword'>if</span> (ldb.bp[j] == line) {</td></tr>
<tr class="codeline" data-linenumber="2018"><td class="num" id="LN2018">2018</td><td class="line">            ldb.bpcount--;</td></tr>
<tr class="codeline" data-linenumber="2019"><td class="num" id="LN2019">2019</td><td class="line">            memmove(ldb.bp+j,ldb.bp+j+1,ldb.bpcount-j);</td></tr>
<tr class="codeline" data-linenumber="2020"><td class="num" id="LN2020">2020</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2021"><td class="num" id="LN2021">2021</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2022"><td class="num" id="LN2022">2022</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2023"><td class="num" id="LN2023">2023</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2024"><td class="num" id="LN2024">2024</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2025"><td class="num" id="LN2025">2025</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2026"><td class="num" id="LN2026">2026</td><td class="line"><span class='comment'>/* Expect a valid multi-bulk command in the debugging client query buffer.</span></td></tr>
<tr class="codeline" data-linenumber="2027"><td class="num" id="LN2027">2027</td><td class="line"> <span class='comment'>* On success the command is parsed and returned as an array of SDS strings,</span></td></tr>
<tr class="codeline" data-linenumber="2028"><td class="num" id="LN2028">2028</td><td class="line"> <span class='comment'>* otherwise NULL is returned and there is to read more buffer. */</span></td></tr>
<tr class="codeline" data-linenumber="2029"><td class="num" id="LN2029">2029</td><td class="line">sds *ldbReplParseCommand(<span class='keyword'>int</span> *argcp) {</td></tr>
<tr class="codeline" data-linenumber="2030"><td class="num" id="LN2030">2030</td><td class="line">    sds *argv = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2031"><td class="num" id="LN2031">2031</td><td class="line">    <span class='keyword'>int</span> argc = 0;</td></tr>
<tr class="codeline" data-linenumber="2032"><td class="num" id="LN2032">2032</td><td class="line">    <span class='keyword'>if</span> (sdslen(ldb.cbuf) == 0) <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2033"><td class="num" id="LN2033">2033</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2034"><td class="num" id="LN2034">2034</td><td class="line">    <span class='comment'>/* Working on a copy is simpler in this case. We can modify it freely</span></td></tr>
<tr class="codeline" data-linenumber="2035"><td class="num" id="LN2035">2035</td><td class="line">     <span class='comment'>* for the sake of simpler parsing. */</span></td></tr>
<tr class="codeline" data-linenumber="2036"><td class="num" id="LN2036">2036</td><td class="line">    sds copy = sdsdup(ldb.cbuf);</td></tr>
<tr class="codeline" data-linenumber="2037"><td class="num" id="LN2037">2037</td><td class="line">    <span class='keyword'>char</span> *p = copy;</td></tr>
<tr class="codeline" data-linenumber="2038"><td class="num" id="LN2038">2038</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2039"><td class="num" id="LN2039">2039</td><td class="line">    <span class='comment'>/* This Redis protocol parser is a joke... just the simplest thing that</span></td></tr>
<tr class="codeline" data-linenumber="2040"><td class="num" id="LN2040">2040</td><td class="line">     <span class='comment'>* works in this context. It is also very forgiving regarding broken</span></td></tr>
<tr class="codeline" data-linenumber="2041"><td class="num" id="LN2041">2041</td><td class="line">     <span class='comment'>* protocol. */</span></td></tr>
<tr class="codeline" data-linenumber="2042"><td class="num" id="LN2042">2042</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2043"><td class="num" id="LN2043">2043</td><td class="line">    <span class='comment'>/* Seek and parse *&lt;count&gt;\r\n. */</span></td></tr>
<tr class="codeline" data-linenumber="2044"><td class="num" id="LN2044">2044</td><td class="line">    p = strchr(p,'*'); <span class='keyword'>if</span> (!p) <span class='keyword'>goto</span> protoerr;</td></tr>
<tr class="codeline" data-linenumber="2045"><td class="num" id="LN2045">2045</td><td class="line">    <span class='keyword'>char</span> *plen = p+1; <span class='comment'>/* Multi bulk len pointer. */</span></td></tr>
<tr class="codeline" data-linenumber="2046"><td class="num" id="LN2046">2046</td><td class="line">    p = strstr(p,<span class='string_literal'>"\r\n"</span>); <span class='keyword'>if</span> (!p) <span class='keyword'>goto</span> protoerr;</td></tr>
<tr class="codeline" data-linenumber="2047"><td class="num" id="LN2047">2047</td><td class="line">    *p = '\0'; p += 2;</td></tr>
<tr class="codeline" data-linenumber="2048"><td class="num" id="LN2048">2048</td><td class="line">    *argcp = atoi(plen);</td></tr>
<tr class="codeline" data-linenumber="2049"><td class="num" id="LN2049">2049</td><td class="line">    <span class='keyword'>if</span> (*argcp &lt;= 0 || *argcp &gt; 1024) <span class='keyword'>goto</span> protoerr;</td></tr>
<tr class="codeline" data-linenumber="2050"><td class="num" id="LN2050">2050</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2051"><td class="num" id="LN2051">2051</td><td class="line">    <span class='comment'>/* Parse each argument. */</span></td></tr>
<tr class="codeline" data-linenumber="2052"><td class="num" id="LN2052">2052</td><td class="line">    argv = zmalloc(<span class='keyword'>sizeof</span>(sds)*(*argcp));</td></tr>
<tr class="codeline" data-linenumber="2053"><td class="num" id="LN2053">2053</td><td class="line">    argc = 0;</td></tr>
<tr class="codeline" data-linenumber="2054"><td class="num" id="LN2054">2054</td><td class="line">    <span class='keyword'>while</span>(argc &lt; *argcp) {</td></tr>
<tr class="codeline" data-linenumber="2055"><td class="num" id="LN2055">2055</td><td class="line">        <span class='keyword'>if</span> (*p != '$') <span class='keyword'>goto</span> protoerr;</td></tr>
<tr class="codeline" data-linenumber="2056"><td class="num" id="LN2056">2056</td><td class="line">        plen = p+1; <span class='comment'>/* Bulk string len pointer. */</span></td></tr>
<tr class="codeline" data-linenumber="2057"><td class="num" id="LN2057">2057</td><td class="line">        p = strstr(p,<span class='string_literal'>"\r\n"</span>); <span class='keyword'>if</span> (!p) <span class='keyword'>goto</span> protoerr;</td></tr>
<tr class="codeline" data-linenumber="2058"><td class="num" id="LN2058">2058</td><td class="line">        *p = '\0'; p += 2;</td></tr>
<tr class="codeline" data-linenumber="2059"><td class="num" id="LN2059">2059</td><td class="line">        <span class='keyword'>int</span> slen = atoi(plen); <span class='comment'>/* Length of this arg. */</span></td></tr>
<tr class="codeline" data-linenumber="2060"><td class="num" id="LN2060">2060</td><td class="line">        <span class='keyword'>if</span> (slen &lt;= 0 || slen &gt; 1024) <span class='keyword'>goto</span> protoerr;</td></tr>
<tr class="codeline" data-linenumber="2061"><td class="num" id="LN2061">2061</td><td class="line">        argv[argc++] = sdsnewlen(p,slen);</td></tr>
<tr class="codeline" data-linenumber="2062"><td class="num" id="LN2062">2062</td><td class="line">        p += slen; <span class='comment'>/* Skip the already parsed argument. */</span></td></tr>
<tr class="codeline" data-linenumber="2063"><td class="num" id="LN2063">2063</td><td class="line">        <span class='keyword'>if</span> (p[0] != '\r' || p[1] != '\n') <span class='keyword'>goto</span> protoerr;</td></tr>
<tr class="codeline" data-linenumber="2064"><td class="num" id="LN2064">2064</td><td class="line">        p += 2; <span class='comment'>/* Skip \r\n. */</span></td></tr>
<tr class="codeline" data-linenumber="2065"><td class="num" id="LN2065">2065</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2066"><td class="num" id="LN2066">2066</td><td class="line">    sdsfree(copy);</td></tr>
<tr class="codeline" data-linenumber="2067"><td class="num" id="LN2067">2067</td><td class="line">    <span class='keyword'>return</span> argv;</td></tr>
<tr class="codeline" data-linenumber="2068"><td class="num" id="LN2068">2068</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2069"><td class="num" id="LN2069">2069</td><td class="line">protoerr:</td></tr>
<tr class="codeline" data-linenumber="2070"><td class="num" id="LN2070">2070</td><td class="line">    sdsfreesplitres(argv,argc);</td></tr>
<tr class="codeline" data-linenumber="2071"><td class="num" id="LN2071">2071</td><td class="line">    sdsfree(copy);</td></tr>
<tr class="codeline" data-linenumber="2072"><td class="num" id="LN2072">2072</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2073"><td class="num" id="LN2073">2073</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2074"><td class="num" id="LN2074">2074</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2075"><td class="num" id="LN2075">2075</td><td class="line"><span class='comment'>/* Log the specified line in the Lua debugger output. */</span></td></tr>
<tr class="codeline" data-linenumber="2076"><td class="num" id="LN2076">2076</td><td class="line"><span class='keyword'>void</span> ldbLogSourceLine(<span class='keyword'>int</span> lnum) {</td></tr>
<tr class="codeline" data-linenumber="2077"><td class="num" id="LN2077">2077</td><td class="line">    <span class='keyword'>char</span> *line = ldbGetSourceLine(lnum);</td></tr>
<tr class="codeline" data-linenumber="2078"><td class="num" id="LN2078">2078</td><td class="line">    <span class='keyword'>char</span> *prefix;</td></tr>
<tr class="codeline" data-linenumber="2079"><td class="num" id="LN2079">2079</td><td class="line">    <span class='keyword'>int</span> bp = ldbIsBreakpoint(lnum);</td></tr>
<tr class="codeline" data-linenumber="2080"><td class="num" id="LN2080">2080</td><td class="line">    <span class='keyword'>int</span> current = ldb.currentline == lnum;</td></tr>
<tr class="codeline" data-linenumber="2081"><td class="num" id="LN2081">2081</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2082"><td class="num" id="LN2082">2082</td><td class="line">    <span class='keyword'>if</span> (current &amp;&amp; bp)</td></tr>
<tr class="codeline" data-linenumber="2083"><td class="num" id="LN2083">2083</td><td class="line">        prefix = <span class='string_literal'>"-&gt;#"</span>;</td></tr>
<tr class="codeline" data-linenumber="2084"><td class="num" id="LN2084">2084</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (current)</td></tr>
<tr class="codeline" data-linenumber="2085"><td class="num" id="LN2085">2085</td><td class="line">        prefix = <span class='string_literal'>"-&gt; "</span>;</td></tr>
<tr class="codeline" data-linenumber="2086"><td class="num" id="LN2086">2086</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (bp)</td></tr>
<tr class="codeline" data-linenumber="2087"><td class="num" id="LN2087">2087</td><td class="line">        prefix = <span class='string_literal'>"  #"</span>;</td></tr>
<tr class="codeline" data-linenumber="2088"><td class="num" id="LN2088">2088</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2089"><td class="num" id="LN2089">2089</td><td class="line">        prefix = <span class='string_literal'>"   "</span>;</td></tr>
<tr class="codeline" data-linenumber="2090"><td class="num" id="LN2090">2090</td><td class="line">    sds thisline = sdscatprintf(sdsempty(),<span class='string_literal'>"%s%-3d %s"</span>, prefix, lnum, line);</td></tr>
<tr class="codeline" data-linenumber="2091"><td class="num" id="LN2091">2091</td><td class="line">    ldbLog(thisline);</td></tr>
<tr class="codeline" data-linenumber="2092"><td class="num" id="LN2092">2092</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2093"><td class="num" id="LN2093">2093</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2094"><td class="num" id="LN2094">2094</td><td class="line"><span class='comment'>/* Implement the "list" command of the Lua debugger. If around is 0</span></td></tr>
<tr class="codeline" data-linenumber="2095"><td class="num" id="LN2095">2095</td><td class="line"> <span class='comment'>* the whole file is listed, otherwise only a small portion of the file</span></td></tr>
<tr class="codeline" data-linenumber="2096"><td class="num" id="LN2096">2096</td><td class="line"> <span class='comment'>* around the specified line is shown. When a line number is specified</span></td></tr>
<tr class="codeline" data-linenumber="2097"><td class="num" id="LN2097">2097</td><td class="line"> <span class='comment'>* the amount of context (lines before/after) is specified via the</span></td></tr>
<tr class="codeline" data-linenumber="2098"><td class="num" id="LN2098">2098</td><td class="line"> <span class='comment'>* 'context' argument. */</span></td></tr>
<tr class="codeline" data-linenumber="2099"><td class="num" id="LN2099">2099</td><td class="line"><span class='keyword'>void</span> ldbList(<span class='keyword'>int</span> around, <span class='keyword'>int</span> context) {</td></tr>
<tr class="codeline" data-linenumber="2100"><td class="num" id="LN2100">2100</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="2101"><td class="num" id="LN2101">2101</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2102"><td class="num" id="LN2102">2102</td><td class="line">    <span class='keyword'>for</span> (j = 1; j &lt;= ldb.lines; j++) {</td></tr>
<tr class="codeline" data-linenumber="2103"><td class="num" id="LN2103">2103</td><td class="line">        <span class='keyword'>if</span> (around != 0 &amp;&amp; abs(around-j) &gt; context) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2104"><td class="num" id="LN2104">2104</td><td class="line">        ldbLogSourceLine(j);</td></tr>
<tr class="codeline" data-linenumber="2105"><td class="num" id="LN2105">2105</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2106"><td class="num" id="LN2106">2106</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2107"><td class="num" id="LN2107">2107</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2108"><td class="num" id="LN2108">2108</td><td class="line"><span class='comment'>/* Append a human readable representation of the Lua value at position 'idx'</span></td></tr>
<tr class="codeline" data-linenumber="2109"><td class="num" id="LN2109">2109</td><td class="line"> <span class='comment'>* on the stack of the 'lua' state, to the SDS string passed as argument.</span></td></tr>
<tr class="codeline" data-linenumber="2110"><td class="num" id="LN2110">2110</td><td class="line"> <span class='comment'>* The new SDS string with the represented value attached is returned.</span></td></tr>
<tr class="codeline" data-linenumber="2111"><td class="num" id="LN2111">2111</td><td class="line"> <span class='comment'>* Used in order to implement ldbLogStackValue().</span></td></tr>
<tr class="codeline" data-linenumber="2112"><td class="num" id="LN2112">2112</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2113"><td class="num" id="LN2113">2113</td><td class="line"> <span class='comment'>* The element is not automatically removed from the stack, nor it is</span></td></tr>
<tr class="codeline" data-linenumber="2114"><td class="num" id="LN2114">2114</td><td class="line"> <span class='comment'>* converted to a different type. */</span></td></tr>
<tr class="codeline" data-linenumber="2115"><td class="num" id="LN2115">2115</td><td class="line"><span class='directive'>#define <span class='macro'>LDB_MAX_VALUES_DEPTH<span class='macro_popup'>(20/2)</span></span> (<span class='macro'>LUA_MINSTACK<span class='macro_popup'>20</span></span>/2)</span></td></tr>
<tr class="codeline" data-linenumber="2116"><td class="num" id="LN2116">2116</td><td class="line">sds ldbCatStackValueRec(sds s, lua_State *lua, <span class='keyword'>int</span> idx, <span class='keyword'>int</span> level) {</td></tr>
<tr class="codeline" data-linenumber="2117"><td class="num" id="LN2117">2117</td><td class="line">    <span class='keyword'>int</span> t = lua_type(lua,idx);</td></tr>
<tr class="codeline" data-linenumber="2118"><td class="num" id="LN2118">2118</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2119"><td class="num" id="LN2119">2119</td><td class="line">    <span class='keyword'>if</span> (level++ == <span class='macro'>LDB_MAX_VALUES_DEPTH<span class='macro_popup'>(20/2)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2120"><td class="num" id="LN2120">2120</td><td class="line">        <span class='keyword'>return</span> sdscat(s,<span class='string_literal'>"&lt;max recursion level reached! Nested table?&gt;"</span>);</td></tr>
<tr class="codeline" data-linenumber="2121"><td class="num" id="LN2121">2121</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2122"><td class="num" id="LN2122">2122</td><td class="line">    <span class='keyword'>switch</span>(t) {</td></tr>
<tr class="codeline" data-linenumber="2123"><td class="num" id="LN2123">2123</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TSTRING<span class='macro_popup'>4</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2124"><td class="num" id="LN2124">2124</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="2125"><td class="num" id="LN2125">2125</td><td class="line">        size_t strl;</td></tr>
<tr class="codeline" data-linenumber="2126"><td class="num" id="LN2126">2126</td><td class="line">        <span class='keyword'>char</span> *strp = (<span class='keyword'>char</span>*)lua_tolstring(lua,idx,&amp;strl);</td></tr>
<tr class="codeline" data-linenumber="2127"><td class="num" id="LN2127">2127</td><td class="line">        s = sdscatrepr(s,strp,strl);</td></tr>
<tr class="codeline" data-linenumber="2128"><td class="num" id="LN2128">2128</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2129"><td class="num" id="LN2129">2129</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2130"><td class="num" id="LN2130">2130</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TBOOLEAN<span class='macro_popup'>1</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2131"><td class="num" id="LN2131">2131</td><td class="line">        s = sdscat(s,lua_toboolean(lua,idx) ? <span class='string_literal'>"true"</span> : <span class='string_literal'>"false"</span>);</td></tr>
<tr class="codeline" data-linenumber="2132"><td class="num" id="LN2132">2132</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2133"><td class="num" id="LN2133">2133</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TNUMBER<span class='macro_popup'>3</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2134"><td class="num" id="LN2134">2134</td><td class="line">        s = sdscatprintf(s,<span class='string_literal'>"%g"</span>,(<span class='keyword'>double</span>)lua_tonumber(lua,idx));</td></tr>
<tr class="codeline" data-linenumber="2135"><td class="num" id="LN2135">2135</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2136"><td class="num" id="LN2136">2136</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TNIL<span class='macro_popup'>0</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2137"><td class="num" id="LN2137">2137</td><td class="line">        s = sdscatlen(s,<span class='string_literal'>"nil"</span>,3);</td></tr>
<tr class="codeline" data-linenumber="2138"><td class="num" id="LN2138">2138</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2139"><td class="num" id="LN2139">2139</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TTABLE<span class='macro_popup'>5</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2140"><td class="num" id="LN2140">2140</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="2141"><td class="num" id="LN2141">2141</td><td class="line">        <span class='keyword'>int</span> expected_index = 1; <span class='comment'>/* First index we expect in an array. */</span></td></tr>
<tr class="codeline" data-linenumber="2142"><td class="num" id="LN2142">2142</td><td class="line">        <span class='keyword'>int</span> is_array = 1; <span class='comment'>/* Will be set to null if check fails. */</span></td></tr>
<tr class="codeline" data-linenumber="2143"><td class="num" id="LN2143">2143</td><td class="line">        <span class='comment'>/* Note: we create two representations at the same time, one</span></td></tr>
<tr class="codeline" data-linenumber="2144"><td class="num" id="LN2144">2144</td><td class="line">         <span class='comment'>* assuming the table is an array, one assuming it is not. At the</span></td></tr>
<tr class="codeline" data-linenumber="2145"><td class="num" id="LN2145">2145</td><td class="line">         <span class='comment'>* end we know what is true and select the right one. */</span></td></tr>
<tr class="codeline" data-linenumber="2146"><td class="num" id="LN2146">2146</td><td class="line">        sds repr1 = sdsempty();</td></tr>
<tr class="codeline" data-linenumber="2147"><td class="num" id="LN2147">2147</td><td class="line">        sds repr2 = sdsempty();</td></tr>
<tr class="codeline" data-linenumber="2148"><td class="num" id="LN2148">2148</td><td class="line">        lua_pushnil(lua); <span class='comment'>/* The first key to start the iteration is nil. */</span></td></tr>
<tr class="codeline" data-linenumber="2149"><td class="num" id="LN2149">2149</td><td class="line">        <span class='keyword'>while</span> (lua_next(lua,idx-1)) {</td></tr>
<tr class="codeline" data-linenumber="2150"><td class="num" id="LN2150">2150</td><td class="line">            <span class='comment'>/* Test if so far the table looks like an array. */</span></td></tr>
<tr class="codeline" data-linenumber="2151"><td class="num" id="LN2151">2151</td><td class="line">            <span class='keyword'>if</span> (is_array &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2152"><td class="num" id="LN2152">2152</td><td class="line">                (lua_type(lua,-2) != <span class='macro'>LUA_TNUMBER<span class='macro_popup'>3</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="2153"><td class="num" id="LN2153">2153</td><td class="line">                 lua_tonumber(lua,-2) != expected_index)) is_array = 0;</td></tr>
<tr class="codeline" data-linenumber="2154"><td class="num" id="LN2154">2154</td><td class="line">            <span class='comment'>/* Stack now: table, key, value */</span></td></tr>
<tr class="codeline" data-linenumber="2155"><td class="num" id="LN2155">2155</td><td class="line">            <span class='comment'>/* Array repr. */</span></td></tr>
<tr class="codeline" data-linenumber="2156"><td class="num" id="LN2156">2156</td><td class="line">            repr1 = ldbCatStackValueRec(repr1,lua,-1,level);</td></tr>
<tr class="codeline" data-linenumber="2157"><td class="num" id="LN2157">2157</td><td class="line">            repr1 = sdscatlen(repr1,<span class='string_literal'>"; "</span>,2);</td></tr>
<tr class="codeline" data-linenumber="2158"><td class="num" id="LN2158">2158</td><td class="line">            <span class='comment'>/* Full repr. */</span></td></tr>
<tr class="codeline" data-linenumber="2159"><td class="num" id="LN2159">2159</td><td class="line">            repr2 = sdscatlen(repr2,<span class='string_literal'>"["</span>,1);</td></tr>
<tr class="codeline" data-linenumber="2160"><td class="num" id="LN2160">2160</td><td class="line">            repr2 = ldbCatStackValueRec(repr2,lua,-2,level);</td></tr>
<tr class="codeline" data-linenumber="2161"><td class="num" id="LN2161">2161</td><td class="line">            repr2 = sdscatlen(repr2,<span class='string_literal'>"]="</span>,2);</td></tr>
<tr class="codeline" data-linenumber="2162"><td class="num" id="LN2162">2162</td><td class="line">            repr2 = ldbCatStackValueRec(repr2,lua,-1,level);</td></tr>
<tr class="codeline" data-linenumber="2163"><td class="num" id="LN2163">2163</td><td class="line">            repr2 = sdscatlen(repr2,<span class='string_literal'>"; "</span>,2);</td></tr>
<tr class="codeline" data-linenumber="2164"><td class="num" id="LN2164">2164</td><td class="line">            <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>; <span class='comment'>/* Stack: table, key. Ready for next iteration. */</span></td></tr>
<tr class="codeline" data-linenumber="2165"><td class="num" id="LN2165">2165</td><td class="line">            expected_index++;</td></tr>
<tr class="codeline" data-linenumber="2166"><td class="num" id="LN2166">2166</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2167"><td class="num" id="LN2167">2167</td><td class="line">        <span class='comment'>/* Strip the last " ;" from both the representations. */</span></td></tr>
<tr class="codeline" data-linenumber="2168"><td class="num" id="LN2168">2168</td><td class="line">        <span class='keyword'>if</span> (sdslen(repr1)) sdsrange(repr1,0,-3);</td></tr>
<tr class="codeline" data-linenumber="2169"><td class="num" id="LN2169">2169</td><td class="line">        <span class='keyword'>if</span> (sdslen(repr2)) sdsrange(repr2,0,-3);</td></tr>
<tr class="codeline" data-linenumber="2170"><td class="num" id="LN2170">2170</td><td class="line">        <span class='comment'>/* Select the right one and discard the other. */</span></td></tr>
<tr class="codeline" data-linenumber="2171"><td class="num" id="LN2171">2171</td><td class="line">        s = sdscatlen(s,<span class='string_literal'>"{"</span>,1);</td></tr>
<tr class="codeline" data-linenumber="2172"><td class="num" id="LN2172">2172</td><td class="line">        s = sdscatsds(s,is_array ? repr1 : repr2);</td></tr>
<tr class="codeline" data-linenumber="2173"><td class="num" id="LN2173">2173</td><td class="line">        s = sdscatlen(s,<span class='string_literal'>"}"</span>,1);</td></tr>
<tr class="codeline" data-linenumber="2174"><td class="num" id="LN2174">2174</td><td class="line">        sdsfree(repr1);</td></tr>
<tr class="codeline" data-linenumber="2175"><td class="num" id="LN2175">2175</td><td class="line">        sdsfree(repr2);</td></tr>
<tr class="codeline" data-linenumber="2176"><td class="num" id="LN2176">2176</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2177"><td class="num" id="LN2177">2177</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2178"><td class="num" id="LN2178">2178</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TFUNCTION<span class='macro_popup'>6</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2179"><td class="num" id="LN2179">2179</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TUSERDATA<span class='macro_popup'>7</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2180"><td class="num" id="LN2180">2180</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TTHREAD<span class='macro_popup'>8</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2181"><td class="num" id="LN2181">2181</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>LUA_TLIGHTUSERDATA<span class='macro_popup'>2</span></span>:</td></tr>
<tr class="codeline" data-linenumber="2182"><td class="num" id="LN2182">2182</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="2183"><td class="num" id="LN2183">2183</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>void</span> *p = lua_topointer(lua,idx);</td></tr>
<tr class="codeline" data-linenumber="2184"><td class="num" id="LN2184">2184</td><td class="line">        <span class='keyword'>char</span> *typename = <span class='string_literal'>"unknown"</span>;</td></tr>
<tr class="codeline" data-linenumber="2185"><td class="num" id="LN2185">2185</td><td class="line">        <span class='keyword'>if</span> (t == <span class='macro'>LUA_TFUNCTION<span class='macro_popup'>6</span></span>) typename = <span class='string_literal'>"function"</span>;</td></tr>
<tr class="codeline" data-linenumber="2186"><td class="num" id="LN2186">2186</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (t == <span class='macro'>LUA_TUSERDATA<span class='macro_popup'>7</span></span>) typename = <span class='string_literal'>"userdata"</span>;</td></tr>
<tr class="codeline" data-linenumber="2187"><td class="num" id="LN2187">2187</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (t == <span class='macro'>LUA_TTHREAD<span class='macro_popup'>8</span></span>) typename = <span class='string_literal'>"thread"</span>;</td></tr>
<tr class="codeline" data-linenumber="2188"><td class="num" id="LN2188">2188</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (t == <span class='macro'>LUA_TLIGHTUSERDATA<span class='macro_popup'>2</span></span>) typename = <span class='string_literal'>"light-userdata"</span>;</td></tr>
<tr class="codeline" data-linenumber="2189"><td class="num" id="LN2189">2189</td><td class="line">        s = sdscatprintf(s,<span class='string_literal'>"\"%s@%p\""</span>,typename,p);</td></tr>
<tr class="codeline" data-linenumber="2190"><td class="num" id="LN2190">2190</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2191"><td class="num" id="LN2191">2191</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2192"><td class="num" id="LN2192">2192</td><td class="line">    <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="2193"><td class="num" id="LN2193">2193</td><td class="line">        s = sdscat(s,<span class='string_literal'>"\"&lt;unknown-lua-type&gt;\""</span>);</td></tr>
<tr class="codeline" data-linenumber="2194"><td class="num" id="LN2194">2194</td><td class="line">        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2195"><td class="num" id="LN2195">2195</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2196"><td class="num" id="LN2196">2196</td><td class="line">    <span class='keyword'>return</span> s;</td></tr>
<tr class="codeline" data-linenumber="2197"><td class="num" id="LN2197">2197</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2198"><td class="num" id="LN2198">2198</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2199"><td class="num" id="LN2199">2199</td><td class="line"><span class='comment'>/* Higher level wrapper for ldbCatStackValueRec() that just uses an initial</span></td></tr>
<tr class="codeline" data-linenumber="2200"><td class="num" id="LN2200">2200</td><td class="line"> <span class='comment'>* recursion level of '0'. */</span></td></tr>
<tr class="codeline" data-linenumber="2201"><td class="num" id="LN2201">2201</td><td class="line">sds ldbCatStackValue(sds s, lua_State *lua, <span class='keyword'>int</span> idx) {</td></tr>
<tr class="codeline" data-linenumber="2202"><td class="num" id="LN2202">2202</td><td class="line">    <span class='keyword'>return</span> ldbCatStackValueRec(s,lua,idx,0);</td></tr>
<tr class="codeline" data-linenumber="2203"><td class="num" id="LN2203">2203</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2204"><td class="num" id="LN2204">2204</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2205"><td class="num" id="LN2205">2205</td><td class="line"><span class='comment'>/* Produce a debugger log entry representing the value of the Lua object</span></td></tr>
<tr class="codeline" data-linenumber="2206"><td class="num" id="LN2206">2206</td><td class="line"> <span class='comment'>* currently on the top of the stack. The element is ot popped nor modified.</span></td></tr>
<tr class="codeline" data-linenumber="2207"><td class="num" id="LN2207">2207</td><td class="line"> <span class='comment'>* Check ldbCatStackValue() for the actual implementation. */</span></td></tr>
<tr class="codeline" data-linenumber="2208"><td class="num" id="LN2208">2208</td><td class="line"><span class='keyword'>void</span> ldbLogStackValue(lua_State *lua, <span class='keyword'>char</span> *prefix) {</td></tr>
<tr class="codeline" data-linenumber="2209"><td class="num" id="LN2209">2209</td><td class="line">    sds s = sdsnew(prefix);</td></tr>
<tr class="codeline" data-linenumber="2210"><td class="num" id="LN2210">2210</td><td class="line">    s = ldbCatStackValue(s,lua,-1);</td></tr>
<tr class="codeline" data-linenumber="2211"><td class="num" id="LN2211">2211</td><td class="line">    ldbLogWithMaxLen(s);</td></tr>
<tr class="codeline" data-linenumber="2212"><td class="num" id="LN2212">2212</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2213"><td class="num" id="LN2213">2213</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2214"><td class="num" id="LN2214">2214</td><td class="line"><span class='keyword'>char</span> *ldbRedisProtocolToHuman_Int(sds *o, <span class='keyword'>char</span> *reply);</td></tr>
<tr class="codeline" data-linenumber="2215"><td class="num" id="LN2215">2215</td><td class="line"><span class='keyword'>char</span> *ldbRedisProtocolToHuman_Bulk(sds *o, <span class='keyword'>char</span> *reply);</td></tr>
<tr class="codeline" data-linenumber="2216"><td class="num" id="LN2216">2216</td><td class="line"><span class='keyword'>char</span> *ldbRedisProtocolToHuman_Status(sds *o, <span class='keyword'>char</span> *reply);</td></tr>
<tr class="codeline" data-linenumber="2217"><td class="num" id="LN2217">2217</td><td class="line"><span class='keyword'>char</span> *ldbRedisProtocolToHuman_MultiBulk(sds *o, <span class='keyword'>char</span> *reply);</td></tr>
<tr class="codeline" data-linenumber="2218"><td class="num" id="LN2218">2218</td><td class="line"><span class='keyword'>char</span> *ldbRedisProtocolToHuman_Set(sds *o, <span class='keyword'>char</span> *reply);</td></tr>
<tr class="codeline" data-linenumber="2219"><td class="num" id="LN2219">2219</td><td class="line"><span class='keyword'>char</span> *ldbRedisProtocolToHuman_Map(sds *o, <span class='keyword'>char</span> *reply);</td></tr>
<tr class="codeline" data-linenumber="2220"><td class="num" id="LN2220">2220</td><td class="line"><span class='keyword'>char</span> *ldbRedisProtocolToHuman_Null(sds *o, <span class='keyword'>char</span> *reply);</td></tr>
<tr class="codeline" data-linenumber="2221"><td class="num" id="LN2221">2221</td><td class="line"><span class='keyword'>char</span> *ldbRedisProtocolToHuman_Bool(sds *o, <span class='keyword'>char</span> *reply);</td></tr>
<tr class="codeline" data-linenumber="2222"><td class="num" id="LN2222">2222</td><td class="line"><span class='keyword'>char</span> *ldbRedisProtocolToHuman_Double(sds *o, <span class='keyword'>char</span> *reply);</td></tr>
<tr class="codeline" data-linenumber="2223"><td class="num" id="LN2223">2223</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2224"><td class="num" id="LN2224">2224</td><td class="line"><span class='comment'>/* Get Redis protocol from 'reply' and appends it in human readable form to</span></td></tr>
<tr class="codeline" data-linenumber="2225"><td class="num" id="LN2225">2225</td><td class="line"> <span class='comment'>* the passed SDS string 'o'.</span></td></tr>
<tr class="codeline" data-linenumber="2226"><td class="num" id="LN2226">2226</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2227"><td class="num" id="LN2227">2227</td><td class="line"> <span class='comment'>* Note that the SDS string is passed by reference (pointer of pointer to</span></td></tr>
<tr class="codeline" data-linenumber="2228"><td class="num" id="LN2228">2228</td><td class="line"> <span class='comment'>* char*) so that we can return a modified pointer, as for SDS semantics. */</span></td></tr>
<tr class="codeline" data-linenumber="2229"><td class="num" id="LN2229">2229</td><td class="line"><span class='keyword'>char</span> *ldbRedisProtocolToHuman(sds *o, <span class='keyword'>char</span> *reply) {</td></tr>
<tr class="codeline" data-linenumber="2230"><td class="num" id="LN2230">2230</td><td class="line">    <span class='keyword'>char</span> *p = reply;</td></tr>
<tr class="codeline" data-linenumber="2231"><td class="num" id="LN2231">2231</td><td class="line">    <span class='keyword'>switch</span>(*p) {</td></tr>
<tr class="codeline" data-linenumber="2232"><td class="num" id="LN2232">2232</td><td class="line">    <span class='keyword'>case</span> ':': p = ldbRedisProtocolToHuman_Int(o,reply); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2233"><td class="num" id="LN2233">2233</td><td class="line">    <span class='keyword'>case</span> '$': p = ldbRedisProtocolToHuman_Bulk(o,reply); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2234"><td class="num" id="LN2234">2234</td><td class="line">    <span class='keyword'>case</span> '+': p = ldbRedisProtocolToHuman_Status(o,reply); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2235"><td class="num" id="LN2235">2235</td><td class="line">    <span class='keyword'>case</span> '-': p = ldbRedisProtocolToHuman_Status(o,reply); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2236"><td class="num" id="LN2236">2236</td><td class="line">    <span class='keyword'>case</span> '*': p = ldbRedisProtocolToHuman_MultiBulk(o,reply); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2237"><td class="num" id="LN2237">2237</td><td class="line">    <span class='keyword'>case</span> '~': p = ldbRedisProtocolToHuman_Set(o,reply); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2238"><td class="num" id="LN2238">2238</td><td class="line">    <span class='keyword'>case</span> '%': p = ldbRedisProtocolToHuman_Map(o,reply); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2239"><td class="num" id="LN2239">2239</td><td class="line">    <span class='keyword'>case</span> '_': p = ldbRedisProtocolToHuman_Null(o,reply); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2240"><td class="num" id="LN2240">2240</td><td class="line">    <span class='keyword'>case</span> '#': p = ldbRedisProtocolToHuman_Bool(o,reply); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2241"><td class="num" id="LN2241">2241</td><td class="line">    <span class='keyword'>case</span> ',': p = ldbRedisProtocolToHuman_Double(o,reply); <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2242"><td class="num" id="LN2242">2242</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2243"><td class="num" id="LN2243">2243</td><td class="line">    <span class='keyword'>return</span> p;</td></tr>
<tr class="codeline" data-linenumber="2244"><td class="num" id="LN2244">2244</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2245"><td class="num" id="LN2245">2245</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2246"><td class="num" id="LN2246">2246</td><td class="line"><span class='comment'>/* The following functions are helpers for ldbRedisProtocolToHuman(), each</span></td></tr>
<tr class="codeline" data-linenumber="2247"><td class="num" id="LN2247">2247</td><td class="line"> <span class='comment'>* take care of a given Redis return type. */</span></td></tr>
<tr class="codeline" data-linenumber="2248"><td class="num" id="LN2248">2248</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2249"><td class="num" id="LN2249">2249</td><td class="line"><span class='keyword'>char</span> *ldbRedisProtocolToHuman_Int(sds *o, <span class='keyword'>char</span> *reply) {</td></tr>
<tr class="codeline" data-linenumber="2250"><td class="num" id="LN2250">2250</td><td class="line">    <span class='keyword'>char</span> *p = strchr(reply+1,'\r');</td></tr>
<tr class="codeline" data-linenumber="2251"><td class="num" id="LN2251">2251</td><td class="line">    *o = sdscatlen(*o,reply+1,p-reply-1);</td></tr>
<tr class="codeline" data-linenumber="2252"><td class="num" id="LN2252">2252</td><td class="line">    <span class='keyword'>return</span> p+2;</td></tr>
<tr class="codeline" data-linenumber="2253"><td class="num" id="LN2253">2253</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2254"><td class="num" id="LN2254">2254</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2255"><td class="num" id="LN2255">2255</td><td class="line"><span class='keyword'>char</span> *ldbRedisProtocolToHuman_Bulk(sds *o, <span class='keyword'>char</span> *reply) {</td></tr>
<tr class="codeline" data-linenumber="2256"><td class="num" id="LN2256">2256</td><td class="line">    <span class='keyword'>char</span> *p = strchr(reply+1,'\r');</td></tr>
<tr class="codeline" data-linenumber="2257"><td class="num" id="LN2257">2257</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> bulklen;</td></tr>
<tr class="codeline" data-linenumber="2258"><td class="num" id="LN2258">2258</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2259"><td class="num" id="LN2259">2259</td><td class="line">    string2ll(reply+1,p-reply-1,&amp;bulklen);</td></tr>
<tr class="codeline" data-linenumber="2260"><td class="num" id="LN2260">2260</td><td class="line">    <span class='keyword'>if</span> (bulklen == -1) {</td></tr>
<tr class="codeline" data-linenumber="2261"><td class="num" id="LN2261">2261</td><td class="line">        *o = sdscatlen(*o,<span class='string_literal'>"NULL"</span>,4);</td></tr>
<tr class="codeline" data-linenumber="2262"><td class="num" id="LN2262">2262</td><td class="line">        <span class='keyword'>return</span> p+2;</td></tr>
<tr class="codeline" data-linenumber="2263"><td class="num" id="LN2263">2263</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2264"><td class="num" id="LN2264">2264</td><td class="line">        *o = sdscatrepr(*o,p+2,bulklen);</td></tr>
<tr class="codeline" data-linenumber="2265"><td class="num" id="LN2265">2265</td><td class="line">        <span class='keyword'>return</span> p+2+bulklen+2;</td></tr>
<tr class="codeline" data-linenumber="2266"><td class="num" id="LN2266">2266</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2267"><td class="num" id="LN2267">2267</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2268"><td class="num" id="LN2268">2268</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2269"><td class="num" id="LN2269">2269</td><td class="line"><span class='keyword'>char</span> *ldbRedisProtocolToHuman_Status(sds *o, <span class='keyword'>char</span> *reply) {</td></tr>
<tr class="codeline" data-linenumber="2270"><td class="num" id="LN2270">2270</td><td class="line">    <span class='keyword'>char</span> *p = strchr(reply+1,'\r');</td></tr>
<tr class="codeline" data-linenumber="2271"><td class="num" id="LN2271">2271</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2272"><td class="num" id="LN2272">2272</td><td class="line">    *o = sdscatrepr(*o,reply,p-reply);</td></tr>
<tr class="codeline" data-linenumber="2273"><td class="num" id="LN2273">2273</td><td class="line">    <span class='keyword'>return</span> p+2;</td></tr>
<tr class="codeline" data-linenumber="2274"><td class="num" id="LN2274">2274</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2275"><td class="num" id="LN2275">2275</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2276"><td class="num" id="LN2276">2276</td><td class="line"><span class='keyword'>char</span> *ldbRedisProtocolToHuman_MultiBulk(sds *o, <span class='keyword'>char</span> *reply) {</td></tr>
<tr class="codeline" data-linenumber="2277"><td class="num" id="LN2277">2277</td><td class="line">    <span class='keyword'>char</span> *p = strchr(reply+1,'\r');</td></tr>
<tr class="codeline" data-linenumber="2278"><td class="num" id="LN2278">2278</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> mbulklen;</td></tr>
<tr class="codeline" data-linenumber="2279"><td class="num" id="LN2279">2279</td><td class="line">    <span class='keyword'>int</span> j = 0;</td></tr>
<tr class="codeline" data-linenumber="2280"><td class="num" id="LN2280">2280</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2281"><td class="num" id="LN2281">2281</td><td class="line">    string2ll(reply+1,p-reply-1,&amp;mbulklen);</td></tr>
<tr class="codeline" data-linenumber="2282"><td class="num" id="LN2282">2282</td><td class="line">    p += 2;</td></tr>
<tr class="codeline" data-linenumber="2283"><td class="num" id="LN2283">2283</td><td class="line">    <span class='keyword'>if</span> (mbulklen == -1) {</td></tr>
<tr class="codeline" data-linenumber="2284"><td class="num" id="LN2284">2284</td><td class="line">        *o = sdscatlen(*o,<span class='string_literal'>"NULL"</span>,4);</td></tr>
<tr class="codeline" data-linenumber="2285"><td class="num" id="LN2285">2285</td><td class="line">        <span class='keyword'>return</span> p;</td></tr>
<tr class="codeline" data-linenumber="2286"><td class="num" id="LN2286">2286</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2287"><td class="num" id="LN2287">2287</td><td class="line">    *o = sdscatlen(*o,<span class='string_literal'>"["</span>,1);</td></tr>
<tr class="codeline" data-linenumber="2288"><td class="num" id="LN2288">2288</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; mbulklen; j++) {</td></tr>
<tr class="codeline" data-linenumber="2289"><td class="num" id="LN2289">2289</td><td class="line">        p = ldbRedisProtocolToHuman(o,p);</td></tr>
<tr class="codeline" data-linenumber="2290"><td class="num" id="LN2290">2290</td><td class="line">        <span class='keyword'>if</span> (j != mbulklen-1) *o = sdscatlen(*o,<span class='string_literal'>","</span>,1);</td></tr>
<tr class="codeline" data-linenumber="2291"><td class="num" id="LN2291">2291</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2292"><td class="num" id="LN2292">2292</td><td class="line">    *o = sdscatlen(*o,<span class='string_literal'>"]"</span>,1);</td></tr>
<tr class="codeline" data-linenumber="2293"><td class="num" id="LN2293">2293</td><td class="line">    <span class='keyword'>return</span> p;</td></tr>
<tr class="codeline" data-linenumber="2294"><td class="num" id="LN2294">2294</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2295"><td class="num" id="LN2295">2295</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2296"><td class="num" id="LN2296">2296</td><td class="line"><span class='keyword'>char</span> *ldbRedisProtocolToHuman_Set(sds *o, <span class='keyword'>char</span> *reply) {</td></tr>
<tr class="codeline" data-linenumber="2297"><td class="num" id="LN2297">2297</td><td class="line">    <span class='keyword'>char</span> *p = strchr(reply+1,'\r');</td></tr>
<tr class="codeline" data-linenumber="2298"><td class="num" id="LN2298">2298</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> mbulklen;</td></tr>
<tr class="codeline" data-linenumber="2299"><td class="num" id="LN2299">2299</td><td class="line">    <span class='keyword'>int</span> j = 0;</td></tr>
<tr class="codeline" data-linenumber="2300"><td class="num" id="LN2300">2300</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2301"><td class="num" id="LN2301">2301</td><td class="line">    string2ll(reply+1,p-reply-1,&amp;mbulklen);</td></tr>
<tr class="codeline" data-linenumber="2302"><td class="num" id="LN2302">2302</td><td class="line">    p += 2;</td></tr>
<tr class="codeline" data-linenumber="2303"><td class="num" id="LN2303">2303</td><td class="line">    *o = sdscatlen(*o,<span class='string_literal'>"~("</span>,2);</td></tr>
<tr class="codeline" data-linenumber="2304"><td class="num" id="LN2304">2304</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; mbulklen; j++) {</td></tr>
<tr class="codeline" data-linenumber="2305"><td class="num" id="LN2305">2305</td><td class="line">        p = ldbRedisProtocolToHuman(o,p);</td></tr>
<tr class="codeline" data-linenumber="2306"><td class="num" id="LN2306">2306</td><td class="line">        <span class='keyword'>if</span> (j != mbulklen-1) *o = sdscatlen(*o,<span class='string_literal'>","</span>,1);</td></tr>
<tr class="codeline" data-linenumber="2307"><td class="num" id="LN2307">2307</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2308"><td class="num" id="LN2308">2308</td><td class="line">    *o = sdscatlen(*o,<span class='string_literal'>")"</span>,1);</td></tr>
<tr class="codeline" data-linenumber="2309"><td class="num" id="LN2309">2309</td><td class="line">    <span class='keyword'>return</span> p;</td></tr>
<tr class="codeline" data-linenumber="2310"><td class="num" id="LN2310">2310</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2311"><td class="num" id="LN2311">2311</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2312"><td class="num" id="LN2312">2312</td><td class="line"><span class='keyword'>char</span> *ldbRedisProtocolToHuman_Map(sds *o, <span class='keyword'>char</span> *reply) {</td></tr>
<tr class="codeline" data-linenumber="2313"><td class="num" id="LN2313">2313</td><td class="line">    <span class='keyword'>char</span> *p = strchr(reply+1,'\r');</td></tr>
<tr class="codeline" data-linenumber="2314"><td class="num" id="LN2314">2314</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> mbulklen;</td></tr>
<tr class="codeline" data-linenumber="2315"><td class="num" id="LN2315">2315</td><td class="line">    <span class='keyword'>int</span> j = 0;</td></tr>
<tr class="codeline" data-linenumber="2316"><td class="num" id="LN2316">2316</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2317"><td class="num" id="LN2317">2317</td><td class="line">    string2ll(reply+1,p-reply-1,&amp;mbulklen);</td></tr>
<tr class="codeline" data-linenumber="2318"><td class="num" id="LN2318">2318</td><td class="line">    p += 2;</td></tr>
<tr class="codeline" data-linenumber="2319"><td class="num" id="LN2319">2319</td><td class="line">    *o = sdscatlen(*o,<span class='string_literal'>"{"</span>,1);</td></tr>
<tr class="codeline" data-linenumber="2320"><td class="num" id="LN2320">2320</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; mbulklen; j++) {</td></tr>
<tr class="codeline" data-linenumber="2321"><td class="num" id="LN2321">2321</td><td class="line">        p = ldbRedisProtocolToHuman(o,p);</td></tr>
<tr class="codeline" data-linenumber="2322"><td class="num" id="LN2322">2322</td><td class="line">        *o = sdscatlen(*o,<span class='string_literal'>" =&gt; "</span>,4);</td></tr>
<tr class="codeline" data-linenumber="2323"><td class="num" id="LN2323">2323</td><td class="line">        p = ldbRedisProtocolToHuman(o,p);</td></tr>
<tr class="codeline" data-linenumber="2324"><td class="num" id="LN2324">2324</td><td class="line">        <span class='keyword'>if</span> (j != mbulklen-1) *o = sdscatlen(*o,<span class='string_literal'>","</span>,1);</td></tr>
<tr class="codeline" data-linenumber="2325"><td class="num" id="LN2325">2325</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2326"><td class="num" id="LN2326">2326</td><td class="line">    *o = sdscatlen(*o,<span class='string_literal'>"}"</span>,1);</td></tr>
<tr class="codeline" data-linenumber="2327"><td class="num" id="LN2327">2327</td><td class="line">    <span class='keyword'>return</span> p;</td></tr>
<tr class="codeline" data-linenumber="2328"><td class="num" id="LN2328">2328</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2329"><td class="num" id="LN2329">2329</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2330"><td class="num" id="LN2330">2330</td><td class="line"><span class='keyword'>char</span> *ldbRedisProtocolToHuman_Null(sds *o, <span class='keyword'>char</span> *reply) {</td></tr>
<tr class="codeline" data-linenumber="2331"><td class="num" id="LN2331">2331</td><td class="line">    <span class='keyword'>char</span> *p = strchr(reply+1,'\r');</td></tr>
<tr class="codeline" data-linenumber="2332"><td class="num" id="LN2332">2332</td><td class="line">    *o = sdscatlen(*o,<span class='string_literal'>"(null)"</span>,6);</td></tr>
<tr class="codeline" data-linenumber="2333"><td class="num" id="LN2333">2333</td><td class="line">    <span class='keyword'>return</span> p+2;</td></tr>
<tr class="codeline" data-linenumber="2334"><td class="num" id="LN2334">2334</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2335"><td class="num" id="LN2335">2335</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2336"><td class="num" id="LN2336">2336</td><td class="line"><span class='keyword'>char</span> *ldbRedisProtocolToHuman_Bool(sds *o, <span class='keyword'>char</span> *reply) {</td></tr>
<tr class="codeline" data-linenumber="2337"><td class="num" id="LN2337">2337</td><td class="line">    <span class='keyword'>char</span> *p = strchr(reply+1,'\r');</td></tr>
<tr class="codeline" data-linenumber="2338"><td class="num" id="LN2338">2338</td><td class="line">    <span class='keyword'>if</span> (reply[1] == 't')</td></tr>
<tr class="codeline" data-linenumber="2339"><td class="num" id="LN2339">2339</td><td class="line">        *o = sdscatlen(*o,<span class='string_literal'>"#true"</span>,5);</td></tr>
<tr class="codeline" data-linenumber="2340"><td class="num" id="LN2340">2340</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2341"><td class="num" id="LN2341">2341</td><td class="line">        *o = sdscatlen(*o,<span class='string_literal'>"#false"</span>,6);</td></tr>
<tr class="codeline" data-linenumber="2342"><td class="num" id="LN2342">2342</td><td class="line">    <span class='keyword'>return</span> p+2;</td></tr>
<tr class="codeline" data-linenumber="2343"><td class="num" id="LN2343">2343</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2344"><td class="num" id="LN2344">2344</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2345"><td class="num" id="LN2345">2345</td><td class="line"><span class='keyword'>char</span> *ldbRedisProtocolToHuman_Double(sds *o, <span class='keyword'>char</span> *reply) {</td></tr>
<tr class="codeline" data-linenumber="2346"><td class="num" id="LN2346">2346</td><td class="line">    <span class='keyword'>char</span> *p = strchr(reply+1,'\r');</td></tr>
<tr class="codeline" data-linenumber="2347"><td class="num" id="LN2347">2347</td><td class="line">    *o = sdscatlen(*o,<span class='string_literal'>"(double) "</span>,9);</td></tr>
<tr class="codeline" data-linenumber="2348"><td class="num" id="LN2348">2348</td><td class="line">    *o = sdscatlen(*o,reply+1,p-reply-1);</td></tr>
<tr class="codeline" data-linenumber="2349"><td class="num" id="LN2349">2349</td><td class="line">    <span class='keyword'>return</span> p+2;</td></tr>
<tr class="codeline" data-linenumber="2350"><td class="num" id="LN2350">2350</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2351"><td class="num" id="LN2351">2351</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2352"><td class="num" id="LN2352">2352</td><td class="line"><span class='comment'>/* Log a Redis reply as debugger output, in a human readable format.</span></td></tr>
<tr class="codeline" data-linenumber="2353"><td class="num" id="LN2353">2353</td><td class="line"> <span class='comment'>* If the resulting string is longer than 'len' plus a few more chars</span></td></tr>
<tr class="codeline" data-linenumber="2354"><td class="num" id="LN2354">2354</td><td class="line"> <span class='comment'>* used as prefix, it gets truncated. */</span></td></tr>
<tr class="codeline" data-linenumber="2355"><td class="num" id="LN2355">2355</td><td class="line"><span class='keyword'>void</span> ldbLogRedisReply(<span class='keyword'>char</span> *reply) {</td></tr>
<tr class="codeline" data-linenumber="2356"><td class="num" id="LN2356">2356</td><td class="line">    sds log = sdsnew(<span class='string_literal'>"&lt;reply&gt; "</span>);</td></tr>
<tr class="codeline" data-linenumber="2357"><td class="num" id="LN2357">2357</td><td class="line">    ldbRedisProtocolToHuman(&amp;log,reply);</td></tr>
<tr class="codeline" data-linenumber="2358"><td class="num" id="LN2358">2358</td><td class="line">    ldbLogWithMaxLen(log);</td></tr>
<tr class="codeline" data-linenumber="2359"><td class="num" id="LN2359">2359</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2360"><td class="num" id="LN2360">2360</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2361"><td class="num" id="LN2361">2361</td><td class="line"><span class='comment'>/* Implements the "print &lt;var&gt;" command of the Lua debugger. It scans for Lua</span></td></tr>
<tr class="codeline" data-linenumber="2362"><td class="num" id="LN2362">2362</td><td class="line"> <span class='comment'>* var "varname" starting from the current stack frame up to the top stack</span></td></tr>
<tr class="codeline" data-linenumber="2363"><td class="num" id="LN2363">2363</td><td class="line"> <span class='comment'>* frame. The first matching variable is printed. */</span></td></tr>
<tr class="codeline" data-linenumber="2364"><td class="num" id="LN2364">2364</td><td class="line"><span class='keyword'>void</span> ldbPrint(lua_State *lua, <span class='keyword'>char</span> *varname) {</td></tr>
<tr class="codeline" data-linenumber="2365"><td class="num" id="LN2365">2365</td><td class="line">    lua_Debug ar;</td></tr>
<tr class="codeline" data-linenumber="2366"><td class="num" id="LN2366">2366</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2367"><td class="num" id="LN2367">2367</td><td class="line">    <span class='keyword'>int</span> l = 0; <span class='comment'>/* Stack level. */</span></td></tr>
<tr class="codeline" data-linenumber="2368"><td class="num" id="LN2368">2368</td><td class="line">    <span class='keyword'>while</span> (lua_getstack(lua,l,&amp;ar) != 0) {</td></tr>
<tr class="codeline" data-linenumber="2369"><td class="num" id="LN2369">2369</td><td class="line">        l++;</td></tr>
<tr class="codeline" data-linenumber="2370"><td class="num" id="LN2370">2370</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>char</span> *name;</td></tr>
<tr class="codeline" data-linenumber="2371"><td class="num" id="LN2371">2371</td><td class="line">        <span class='keyword'>int</span> i = 1; <span class='comment'>/* Variable index. */</span></td></tr>
<tr class="codeline" data-linenumber="2372"><td class="num" id="LN2372">2372</td><td class="line">        <span class='keyword'>while</span>((name = lua_getlocal(lua,&amp;ar,i)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2373"><td class="num" id="LN2373">2373</td><td class="line">            i++;</td></tr>
<tr class="codeline" data-linenumber="2374"><td class="num" id="LN2374">2374</td><td class="line">            <span class='keyword'>if</span> (strcmp(varname,name) == 0) {</td></tr>
<tr class="codeline" data-linenumber="2375"><td class="num" id="LN2375">2375</td><td class="line">                ldbLogStackValue(lua,<span class='string_literal'>"&lt;value&gt; "</span>);</td></tr>
<tr class="codeline" data-linenumber="2376"><td class="num" id="LN2376">2376</td><td class="line">                <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2377"><td class="num" id="LN2377">2377</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2378"><td class="num" id="LN2378">2378</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2379"><td class="num" id="LN2379">2379</td><td class="line">                <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>; <span class='comment'>/* Discard the var name on the stack. */</span></td></tr>
<tr class="codeline" data-linenumber="2380"><td class="num" id="LN2380">2380</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2381"><td class="num" id="LN2381">2381</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2382"><td class="num" id="LN2382">2382</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2383"><td class="num" id="LN2383">2383</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2384"><td class="num" id="LN2384">2384</td><td class="line">    <span class='comment'>/* Let's try with global vars in two selected cases */</span></td></tr>
<tr class="codeline" data-linenumber="2385"><td class="num" id="LN2385">2385</td><td class="line">    <span class='keyword'>if</span> (!strcmp(varname,<span class='string_literal'>"ARGV"</span>) || !strcmp(varname,<span class='string_literal'>"KEYS"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2386"><td class="num" id="LN2386">2386</td><td class="line">        <span class='macro'>lua_getglobal(lua, varname)<span class='macro_popup'>lua_getfield(lua, (-10002), (varname))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2387"><td class="num" id="LN2387">2387</td><td class="line">        ldbLogStackValue(lua,<span class='string_literal'>"&lt;value&gt; "</span>);</td></tr>
<tr class="codeline" data-linenumber="2388"><td class="num" id="LN2388">2388</td><td class="line">        <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2389"><td class="num" id="LN2389">2389</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2390"><td class="num" id="LN2390">2390</td><td class="line">        ldbLog(sdsnew(<span class='string_literal'>"No such variable."</span>));</td></tr>
<tr class="codeline" data-linenumber="2391"><td class="num" id="LN2391">2391</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2392"><td class="num" id="LN2392">2392</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2393"><td class="num" id="LN2393">2393</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2394"><td class="num" id="LN2394">2394</td><td class="line"><span class='comment'>/* Implements the "print" command (without arguments) of the Lua debugger.</span></td></tr>
<tr class="codeline" data-linenumber="2395"><td class="num" id="LN2395">2395</td><td class="line"> <span class='comment'>* Prints all the variables in the current stack frame. */</span></td></tr>
<tr class="codeline" data-linenumber="2396"><td class="num" id="LN2396">2396</td><td class="line"><span class='keyword'>void</span> ldbPrintAll(lua_State *lua) {</td></tr>
<tr class="codeline" data-linenumber="2397"><td class="num" id="LN2397">2397</td><td class="line">    lua_Debug ar;</td></tr>
<tr class="codeline" data-linenumber="2398"><td class="num" id="LN2398">2398</td><td class="line">    <span class='keyword'>int</span> vars = 0;</td></tr>
<tr class="codeline" data-linenumber="2399"><td class="num" id="LN2399">2399</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2400"><td class="num" id="LN2400">2400</td><td class="line">    <span class='keyword'>if</span> (lua_getstack(lua,0,&amp;ar) != 0) {</td></tr>
<tr class="codeline" data-linenumber="2401"><td class="num" id="LN2401">2401</td><td class="line">        <span class='keyword'>const</span> <span class='keyword'>char</span> *name;</td></tr>
<tr class="codeline" data-linenumber="2402"><td class="num" id="LN2402">2402</td><td class="line">        <span class='keyword'>int</span> i = 1; <span class='comment'>/* Variable index. */</span></td></tr>
<tr class="codeline" data-linenumber="2403"><td class="num" id="LN2403">2403</td><td class="line">        <span class='keyword'>while</span>((name = lua_getlocal(lua,&amp;ar,i)) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2404"><td class="num" id="LN2404">2404</td><td class="line">            i++;</td></tr>
<tr class="codeline" data-linenumber="2405"><td class="num" id="LN2405">2405</td><td class="line">            <span class='keyword'>if</span> (!strstr(name,<span class='string_literal'>"(*temporary)"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2406"><td class="num" id="LN2406">2406</td><td class="line">                sds prefix = sdscatprintf(sdsempty(),<span class='string_literal'>"&lt;value&gt; %s = "</span>,name);</td></tr>
<tr class="codeline" data-linenumber="2407"><td class="num" id="LN2407">2407</td><td class="line">                ldbLogStackValue(lua,prefix);</td></tr>
<tr class="codeline" data-linenumber="2408"><td class="num" id="LN2408">2408</td><td class="line">                sdsfree(prefix);</td></tr>
<tr class="codeline" data-linenumber="2409"><td class="num" id="LN2409">2409</td><td class="line">                vars++;</td></tr>
<tr class="codeline" data-linenumber="2410"><td class="num" id="LN2410">2410</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2411"><td class="num" id="LN2411">2411</td><td class="line">            <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2412"><td class="num" id="LN2412">2412</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2413"><td class="num" id="LN2413">2413</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2414"><td class="num" id="LN2414">2414</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2415"><td class="num" id="LN2415">2415</td><td class="line">    <span class='keyword'>if</span> (vars == 0) {</td></tr>
<tr class="codeline" data-linenumber="2416"><td class="num" id="LN2416">2416</td><td class="line">        ldbLog(sdsnew(<span class='string_literal'>"No local variables in the current context."</span>));</td></tr>
<tr class="codeline" data-linenumber="2417"><td class="num" id="LN2417">2417</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2418"><td class="num" id="LN2418">2418</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2419"><td class="num" id="LN2419">2419</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2420"><td class="num" id="LN2420">2420</td><td class="line"><span class='comment'>/* Implements the break command to list, add and remove breakpoints. */</span></td></tr>
<tr class="codeline" data-linenumber="2421"><td class="num" id="LN2421">2421</td><td class="line"><span class='keyword'>void</span> ldbBreak(sds *argv, <span class='keyword'>int</span> argc) {</td></tr>
<tr class="codeline" data-linenumber="2422"><td class="num" id="LN2422">2422</td><td class="line">    <span class='keyword'>if</span> (argc == 1) {</td></tr>
<tr class="codeline" data-linenumber="2423"><td class="num" id="LN2423">2423</td><td class="line">        <span class='keyword'>if</span> (ldb.bpcount == 0) {</td></tr>
<tr class="codeline" data-linenumber="2424"><td class="num" id="LN2424">2424</td><td class="line">            ldbLog(sdsnew(<span class='string_literal'>"No breakpoints set. Use 'b &lt;line&gt;' to add one."</span>));</td></tr>
<tr class="codeline" data-linenumber="2425"><td class="num" id="LN2425">2425</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2426"><td class="num" id="LN2426">2426</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2427"><td class="num" id="LN2427">2427</td><td class="line">            ldbLog(sdscatfmt(sdsempty(),<span class='string_literal'>"%i breakpoints set:"</span>,ldb.bpcount));</td></tr>
<tr class="codeline" data-linenumber="2428"><td class="num" id="LN2428">2428</td><td class="line">            <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="2429"><td class="num" id="LN2429">2429</td><td class="line">            <span class='keyword'>for</span> (j = 0; j &lt; ldb.bpcount; j++)</td></tr>
<tr class="codeline" data-linenumber="2430"><td class="num" id="LN2430">2430</td><td class="line">                ldbLogSourceLine(ldb.bp[j]);</td></tr>
<tr class="codeline" data-linenumber="2431"><td class="num" id="LN2431">2431</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2432"><td class="num" id="LN2432">2432</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2433"><td class="num" id="LN2433">2433</td><td class="line">        <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="2434"><td class="num" id="LN2434">2434</td><td class="line">        <span class='keyword'>for</span> (j = 1; j &lt; argc; j++) {</td></tr>
<tr class="codeline" data-linenumber="2435"><td class="num" id="LN2435">2435</td><td class="line">            <span class='keyword'>char</span> *arg = argv[j];</td></tr>
<tr class="codeline" data-linenumber="2436"><td class="num" id="LN2436">2436</td><td class="line">            <span class='keyword'>long</span> line;</td></tr>
<tr class="codeline" data-linenumber="2437"><td class="num" id="LN2437">2437</td><td class="line">            <span class='keyword'>if</span> (!string2l(arg,sdslen(arg),&amp;line)) {</td></tr>
<tr class="codeline" data-linenumber="2438"><td class="num" id="LN2438">2438</td><td class="line">                ldbLog(sdscatfmt(sdsempty(),<span class='string_literal'>"Invalid argument:'%s'"</span>,arg));</td></tr>
<tr class="codeline" data-linenumber="2439"><td class="num" id="LN2439">2439</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2440"><td class="num" id="LN2440">2440</td><td class="line">                <span class='keyword'>if</span> (line == 0) {</td></tr>
<tr class="codeline" data-linenumber="2441"><td class="num" id="LN2441">2441</td><td class="line">                    ldb.bpcount = 0;</td></tr>
<tr class="codeline" data-linenumber="2442"><td class="num" id="LN2442">2442</td><td class="line">                    ldbLog(sdsnew(<span class='string_literal'>"All breakpoints removed."</span>));</td></tr>
<tr class="codeline" data-linenumber="2443"><td class="num" id="LN2443">2443</td><td class="line">                } <span class='keyword'>else</span> <span class='keyword'>if</span> (line &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="2444"><td class="num" id="LN2444">2444</td><td class="line">                    <span class='keyword'>if</span> (ldb.bpcount == <span class='macro'>LDB_BREAKPOINTS_MAX<span class='macro_popup'>64</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2445"><td class="num" id="LN2445">2445</td><td class="line">                        ldbLog(sdsnew(<span class='string_literal'>"Too many breakpoints set."</span>));</td></tr>
<tr class="codeline" data-linenumber="2446"><td class="num" id="LN2446">2446</td><td class="line">                    } <span class='keyword'>else</span> <span class='keyword'>if</span> (ldbAddBreakpoint(line)) {</td></tr>
<tr class="codeline" data-linenumber="2447"><td class="num" id="LN2447">2447</td><td class="line">                        ldbList(line,1);</td></tr>
<tr class="codeline" data-linenumber="2448"><td class="num" id="LN2448">2448</td><td class="line">                    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2449"><td class="num" id="LN2449">2449</td><td class="line">                        ldbLog(sdsnew(<span class='string_literal'>"Wrong line number."</span>));</td></tr>
<tr class="codeline" data-linenumber="2450"><td class="num" id="LN2450">2450</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="2451"><td class="num" id="LN2451">2451</td><td class="line">                } <span class='keyword'>else</span> <span class='keyword'>if</span> (line &lt; 0) {</td></tr>
<tr class="codeline" data-linenumber="2452"><td class="num" id="LN2452">2452</td><td class="line">                    <span class='keyword'>if</span> (ldbDelBreakpoint(-line))</td></tr>
<tr class="codeline" data-linenumber="2453"><td class="num" id="LN2453">2453</td><td class="line">                        ldbLog(sdsnew(<span class='string_literal'>"Breakpoint removed."</span>));</td></tr>
<tr class="codeline" data-linenumber="2454"><td class="num" id="LN2454">2454</td><td class="line">                    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2455"><td class="num" id="LN2455">2455</td><td class="line">                        ldbLog(sdsnew(<span class='string_literal'>"No breakpoint in the specified line."</span>));</td></tr>
<tr class="codeline" data-linenumber="2456"><td class="num" id="LN2456">2456</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="2457"><td class="num" id="LN2457">2457</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2458"><td class="num" id="LN2458">2458</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2459"><td class="num" id="LN2459">2459</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2460"><td class="num" id="LN2460">2460</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2461"><td class="num" id="LN2461">2461</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2462"><td class="num" id="LN2462">2462</td><td class="line"><span class='comment'>/* Implements the Lua debugger "eval" command. It just compiles the user</span></td></tr>
<tr class="codeline" data-linenumber="2463"><td class="num" id="LN2463">2463</td><td class="line"> <span class='comment'>* passed fragment of code and executes it, showing the result left on</span></td></tr>
<tr class="codeline" data-linenumber="2464"><td class="num" id="LN2464">2464</td><td class="line"> <span class='comment'>* the stack. */</span></td></tr>
<tr class="codeline" data-linenumber="2465"><td class="num" id="LN2465">2465</td><td class="line"><span class='keyword'>void</span> ldbEval(lua_State *lua, sds *argv, <span class='keyword'>int</span> argc) {</td></tr>
<tr class="codeline" data-linenumber="2466"><td class="num" id="LN2466">2466</td><td class="line">    <span class='comment'>/* Glue the script together if it is composed of multiple arguments. */</span></td></tr>
<tr class="codeline" data-linenumber="2467"><td class="num" id="LN2467">2467</td><td class="line">    sds code = sdsjoinsds(argv+1,argc-1,<span class='string_literal'>" "</span>,1);</td></tr>
<tr class="codeline" data-linenumber="2468"><td class="num" id="LN2468">2468</td><td class="line">    sds expr = sdscatsds(sdsnew(<span class='string_literal'>"return "</span>),code);</td></tr>
<tr class="codeline" data-linenumber="2469"><td class="num" id="LN2469">2469</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2470"><td class="num" id="LN2470">2470</td><td class="line">    <span class='comment'>/* Try to compile it as an expression, prepending "return ". */</span></td></tr>
<tr class="codeline" data-linenumber="2471"><td class="num" id="LN2471">2471</td><td class="line">    <span class='keyword'>if</span> (luaL_loadbuffer(lua,expr,sdslen(expr),<span class='string_literal'>"@ldb_eval"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2472"><td class="num" id="LN2472">2472</td><td class="line">        <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2473"><td class="num" id="LN2473">2473</td><td class="line">        <span class='comment'>/* Failed? Try as a statement. */</span></td></tr>
<tr class="codeline" data-linenumber="2474"><td class="num" id="LN2474">2474</td><td class="line">        <span class='keyword'>if</span> (luaL_loadbuffer(lua,code,sdslen(code),<span class='string_literal'>"@ldb_eval"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2475"><td class="num" id="LN2475">2475</td><td class="line">            ldbLog(sdscatfmt(sdsempty(),<span class='string_literal'>"&lt;error&gt; %s"</span>,<span class='macro'>lua_tostring(lua,-1)<span class='macro_popup'>lua_tolstring(lua, (-1), ((void*)0))</span></span>));</td></tr>
<tr class="codeline" data-linenumber="2476"><td class="num" id="LN2476">2476</td><td class="line">            <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2477"><td class="num" id="LN2477">2477</td><td class="line">            sdsfree(code);</td></tr>
<tr class="codeline" data-linenumber="2478"><td class="num" id="LN2478">2478</td><td class="line">            sdsfree(expr);</td></tr>
<tr class="codeline" data-linenumber="2479"><td class="num" id="LN2479">2479</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2480"><td class="num" id="LN2480">2480</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2481"><td class="num" id="LN2481">2481</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2482"><td class="num" id="LN2482">2482</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2483"><td class="num" id="LN2483">2483</td><td class="line">    <span class='comment'>/* Call it. */</span></td></tr>
<tr class="codeline" data-linenumber="2484"><td class="num" id="LN2484">2484</td><td class="line">    sdsfree(code);</td></tr>
<tr class="codeline" data-linenumber="2485"><td class="num" id="LN2485">2485</td><td class="line">    sdsfree(expr);</td></tr>
<tr class="codeline" data-linenumber="2486"><td class="num" id="LN2486">2486</td><td class="line">    <span class='keyword'>if</span> (lua_pcall(lua,0,1,0)) {</td></tr>
<tr class="codeline" data-linenumber="2487"><td class="num" id="LN2487">2487</td><td class="line">        ldbLog(sdscatfmt(sdsempty(),<span class='string_literal'>"&lt;error&gt; %s"</span>,<span class='macro'>lua_tostring(lua,-1)<span class='macro_popup'>lua_tolstring(lua, (-1), ((void*)0))</span></span>));</td></tr>
<tr class="codeline" data-linenumber="2488"><td class="num" id="LN2488">2488</td><td class="line">        <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2489"><td class="num" id="LN2489">2489</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2490"><td class="num" id="LN2490">2490</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2491"><td class="num" id="LN2491">2491</td><td class="line">    ldbLogStackValue(lua,<span class='string_literal'>"&lt;retval&gt; "</span>);</td></tr>
<tr class="codeline" data-linenumber="2492"><td class="num" id="LN2492">2492</td><td class="line">    <span class='macro'>lua_pop(lua,1)<span class='macro_popup'>lua_settop(lua, -(1)-1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2493"><td class="num" id="LN2493">2493</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2494"><td class="num" id="LN2494">2494</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2495"><td class="num" id="LN2495">2495</td><td class="line"><span class='comment'>/* Implement the debugger "redis" command. We use a trick in order to make</span></td></tr>
<tr class="codeline" data-linenumber="2496"><td class="num" id="LN2496">2496</td><td class="line"> <span class='comment'>* the implementation very simple: we just call the Lua redis.call() command</span></td></tr>
<tr class="codeline" data-linenumber="2497"><td class="num" id="LN2497">2497</td><td class="line"> <span class='comment'>* implementation, with ldb.step enabled, so as a side effect the Redis command</span></td></tr>
<tr class="codeline" data-linenumber="2498"><td class="num" id="LN2498">2498</td><td class="line"> <span class='comment'>* and its reply are logged. */</span></td></tr>
<tr class="codeline" data-linenumber="2499"><td class="num" id="LN2499">2499</td><td class="line"><span class='keyword'>void</span> ldbRedis(lua_State *lua, sds *argv, <span class='keyword'>int</span> argc) {</td></tr>
<tr class="codeline" data-linenumber="2500"><td class="num" id="LN2500">2500</td><td class="line">    <span class='keyword'>int</span> j, saved_rc = server.lua_replicate_commands;</td></tr>
<tr class="codeline" data-linenumber="2501"><td class="num" id="LN2501">2501</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2502"><td class="num" id="LN2502">2502</td><td class="line">    <span class='macro'>lua_getglobal(lua,<span class='string_literal'>"redis"</span>)<span class='macro_popup'>lua_getfield(lua, (-10002), ("redis"))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2503"><td class="num" id="LN2503">2503</td><td class="line">    lua_pushstring(lua,<span class='string_literal'>"call"</span>);</td></tr>
<tr class="codeline" data-linenumber="2504"><td class="num" id="LN2504">2504</td><td class="line">    lua_gettable(lua,-2);       <span class='comment'>/* Stack: redis, redis.call */</span></td></tr>
<tr class="codeline" data-linenumber="2505"><td class="num" id="LN2505">2505</td><td class="line">    <span class='keyword'>for</span> (j = 1; j &lt; argc; j++)</td></tr>
<tr class="codeline" data-linenumber="2506"><td class="num" id="LN2506">2506</td><td class="line">        lua_pushlstring(lua,argv[j],sdslen(argv[j]));</td></tr>
<tr class="codeline" data-linenumber="2507"><td class="num" id="LN2507">2507</td><td class="line">    ldb.step = 1;               <span class='comment'>/* Force redis.call() to log. */</span></td></tr>
<tr class="codeline" data-linenumber="2508"><td class="num" id="LN2508">2508</td><td class="line">    server.lua_replicate_commands = 1;</td></tr>
<tr class="codeline" data-linenumber="2509"><td class="num" id="LN2509">2509</td><td class="line">    lua_pcall(lua,argc-1,1,0);  <span class='comment'>/* Stack: redis, result */</span></td></tr>
<tr class="codeline" data-linenumber="2510"><td class="num" id="LN2510">2510</td><td class="line">    ldb.step = 0;               <span class='comment'>/* Disable logging. */</span></td></tr>
<tr class="codeline" data-linenumber="2511"><td class="num" id="LN2511">2511</td><td class="line">    server.lua_replicate_commands = saved_rc;</td></tr>
<tr class="codeline" data-linenumber="2512"><td class="num" id="LN2512">2512</td><td class="line">    <span class='macro'>lua_pop(lua,2)<span class='macro_popup'>lua_settop(lua, -(2)-1)</span></span>;             <span class='comment'>/* Discard the result and clean the stack. */</span></td></tr>
<tr class="codeline" data-linenumber="2513"><td class="num" id="LN2513">2513</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2514"><td class="num" id="LN2514">2514</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2515"><td class="num" id="LN2515">2515</td><td class="line"><span class='comment'>/* Implements "trace" command of the Lua debugger. It just prints a backtrace</span></td></tr>
<tr class="codeline" data-linenumber="2516"><td class="num" id="LN2516">2516</td><td class="line"> <span class='comment'>* querying Lua starting from the current callframe back to the outer one. */</span></td></tr>
<tr class="codeline" data-linenumber="2517"><td class="num" id="LN2517">2517</td><td class="line"><span class='keyword'>void</span> ldbTrace(lua_State *lua) {</td></tr>
<tr class="codeline" data-linenumber="2518"><td class="num" id="LN2518">2518</td><td class="line">    lua_Debug ar;</td></tr>
<tr class="codeline" data-linenumber="2519"><td class="num" id="LN2519">2519</td><td class="line">    <span class='keyword'>int</span> level = 0;</td></tr>
<tr class="codeline" data-linenumber="2520"><td class="num" id="LN2520">2520</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2521"><td class="num" id="LN2521">2521</td><td class="line">    <span class='keyword'>while</span>(lua_getstack(lua,level,&amp;ar)) {</td></tr>
<tr class="codeline" data-linenumber="2522"><td class="num" id="LN2522">2522</td><td class="line">        lua_getinfo(lua,<span class='string_literal'>"Snl"</span>,&amp;ar);</td></tr>
<tr class="codeline" data-linenumber="2523"><td class="num" id="LN2523">2523</td><td class="line">        <span class='keyword'>if</span>(strstr(ar.short_src,<span class='string_literal'>"user_script"</span>) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2524"><td class="num" id="LN2524">2524</td><td class="line">            ldbLog(sdscatprintf(sdsempty(),<span class='string_literal'>"%s %s:"</span>,</td></tr>
<tr class="codeline" data-linenumber="2525"><td class="num" id="LN2525">2525</td><td class="line">                (level == 0) ? <span class='string_literal'>"In"</span> : <span class='string_literal'>"From"</span>,</td></tr>
<tr class="codeline" data-linenumber="2526"><td class="num" id="LN2526">2526</td><td class="line">                ar.name ? ar.name : <span class='string_literal'>"top level"</span>));</td></tr>
<tr class="codeline" data-linenumber="2527"><td class="num" id="LN2527">2527</td><td class="line">            ldbLogSourceLine(ar.currentline);</td></tr>
<tr class="codeline" data-linenumber="2528"><td class="num" id="LN2528">2528</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2529"><td class="num" id="LN2529">2529</td><td class="line">        level++;</td></tr>
<tr class="codeline" data-linenumber="2530"><td class="num" id="LN2530">2530</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2531"><td class="num" id="LN2531">2531</td><td class="line">    <span class='keyword'>if</span> (level == 0) {</td></tr>
<tr class="codeline" data-linenumber="2532"><td class="num" id="LN2532">2532</td><td class="line">        ldbLog(sdsnew(<span class='string_literal'>"&lt;error&gt; Can't retrieve Lua stack."</span>));</td></tr>
<tr class="codeline" data-linenumber="2533"><td class="num" id="LN2533">2533</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2534"><td class="num" id="LN2534">2534</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2535"><td class="num" id="LN2535">2535</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2536"><td class="num" id="LN2536">2536</td><td class="line"><span class='comment'>/* Implements the debugger "maxlen" command. It just queries or sets the</span></td></tr>
<tr class="codeline" data-linenumber="2537"><td class="num" id="LN2537">2537</td><td class="line"> <span class='comment'>* ldb.maxlen variable. */</span></td></tr>
<tr class="codeline" data-linenumber="2538"><td class="num" id="LN2538">2538</td><td class="line"><span class='keyword'>void</span> ldbMaxlen(sds *argv, <span class='keyword'>int</span> argc) {</td></tr>
<tr class="codeline" data-linenumber="2539"><td class="num" id="LN2539">2539</td><td class="line">    <span class='keyword'>if</span> (argc == 2) {</td></tr>
<tr class="codeline" data-linenumber="2540"><td class="num" id="LN2540">2540</td><td class="line">        <span class='keyword'>int</span> newval = atoi(argv[1]);</td></tr>
<tr class="codeline" data-linenumber="2541"><td class="num" id="LN2541">2541</td><td class="line">        ldb.maxlen_hint_sent = 1; <span class='comment'>/* User knows about this command. */</span></td></tr>
<tr class="codeline" data-linenumber="2542"><td class="num" id="LN2542">2542</td><td class="line">        <span class='keyword'>if</span> (newval != 0 &amp;&amp; newval &lt;= 60) newval = 60;</td></tr>
<tr class="codeline" data-linenumber="2543"><td class="num" id="LN2543">2543</td><td class="line">        ldb.maxlen = newval;</td></tr>
<tr class="codeline" data-linenumber="2544"><td class="num" id="LN2544">2544</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2545"><td class="num" id="LN2545">2545</td><td class="line">    <span class='keyword'>if</span> (ldb.maxlen) {</td></tr>
<tr class="codeline" data-linenumber="2546"><td class="num" id="LN2546">2546</td><td class="line">        ldbLog(sdscatprintf(sdsempty(),<span class='string_literal'>"&lt;value&gt; replies are truncated at %d bytes."</span>,(<span class='keyword'>int</span>)ldb.maxlen));</td></tr>
<tr class="codeline" data-linenumber="2547"><td class="num" id="LN2547">2547</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2548"><td class="num" id="LN2548">2548</td><td class="line">        ldbLog(sdscatprintf(sdsempty(),<span class='string_literal'>"&lt;value&gt; replies are unlimited."</span>));</td></tr>
<tr class="codeline" data-linenumber="2549"><td class="num" id="LN2549">2549</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2550"><td class="num" id="LN2550">2550</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2551"><td class="num" id="LN2551">2551</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2552"><td class="num" id="LN2552">2552</td><td class="line"><span class='comment'>/* Read debugging commands from client.</span></td></tr>
<tr class="codeline" data-linenumber="2553"><td class="num" id="LN2553">2553</td><td class="line"> <span class='comment'>* Return C_OK if the debugging session is continuing, otherwise</span></td></tr>
<tr class="codeline" data-linenumber="2554"><td class="num" id="LN2554">2554</td><td class="line"> <span class='comment'>* C_ERR if the client closed the connection or is timing out. */</span></td></tr>
<tr class="codeline" data-linenumber="2555"><td class="num" id="LN2555">2555</td><td class="line"><span class='keyword'>int</span> ldbRepl(lua_State *lua) {</td></tr>
<tr class="codeline" data-linenumber="2556"><td class="num" id="LN2556">2556</td><td class="line">    sds *argv;</td></tr>
<tr class="codeline" data-linenumber="2557"><td class="num" id="LN2557">2557</td><td class="line">    <span class='keyword'>int</span> argc;</td></tr>
<tr class="codeline" data-linenumber="2558"><td class="num" id="LN2558">2558</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2559"><td class="num" id="LN2559">2559</td><td class="line">    <span class='comment'>/* We continue processing commands until a command that should return</span></td></tr>
<tr class="codeline" data-linenumber="2560"><td class="num" id="LN2560">2560</td><td class="line">     <span class='comment'>* to the Lua interpreter is found. */</span></td></tr>
<tr class="codeline" data-linenumber="2561"><td class="num" id="LN2561">2561</td><td class="line">    <span class='keyword'>while</span>(1) {</td></tr>
<tr class="codeline" data-linenumber="2562"><td class="num" id="LN2562">2562</td><td class="line">        <span class='keyword'>while</span>((argv = ldbReplParseCommand(&amp;argc)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2563"><td class="num" id="LN2563">2563</td><td class="line">            <span class='keyword'>char</span> buf[1024];</td></tr>
<tr class="codeline" data-linenumber="2564"><td class="num" id="LN2564">2564</td><td class="line">            <span class='keyword'>int</span> nread = connRead(ldb.conn,buf,<span class='keyword'>sizeof</span>(buf));</td></tr>
<tr class="codeline" data-linenumber="2565"><td class="num" id="LN2565">2565</td><td class="line">            <span class='keyword'>if</span> (nread &lt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="2566"><td class="num" id="LN2566">2566</td><td class="line">                <span class='comment'>/* Make sure the script runs without user input since the</span></td></tr>
<tr class="codeline" data-linenumber="2567"><td class="num" id="LN2567">2567</td><td class="line">                 <span class='comment'>* client is no longer connected. */</span></td></tr>
<tr class="codeline" data-linenumber="2568"><td class="num" id="LN2568">2568</td><td class="line">                ldb.step = 0;</td></tr>
<tr class="codeline" data-linenumber="2569"><td class="num" id="LN2569">2569</td><td class="line">                ldb.bpcount = 0;</td></tr>
<tr class="codeline" data-linenumber="2570"><td class="num" id="LN2570">2570</td><td class="line">                <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2571"><td class="num" id="LN2571">2571</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2572"><td class="num" id="LN2572">2572</td><td class="line">            ldb.cbuf = sdscatlen(ldb.cbuf,buf,nread);</td></tr>
<tr class="codeline" data-linenumber="2573"><td class="num" id="LN2573">2573</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2574"><td class="num" id="LN2574">2574</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2575"><td class="num" id="LN2575">2575</td><td class="line">        <span class='comment'>/* Flush the old buffer. */</span></td></tr>
<tr class="codeline" data-linenumber="2576"><td class="num" id="LN2576">2576</td><td class="line">        sdsfree(ldb.cbuf);</td></tr>
<tr class="codeline" data-linenumber="2577"><td class="num" id="LN2577">2577</td><td class="line">        ldb.cbuf = sdsempty();</td></tr>
<tr class="codeline" data-linenumber="2578"><td class="num" id="LN2578">2578</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2579"><td class="num" id="LN2579">2579</td><td class="line">        <span class='comment'>/* Execute the command. */</span></td></tr>
<tr class="codeline" data-linenumber="2580"><td class="num" id="LN2580">2580</td><td class="line">        <span class='keyword'>if</span> (!strcasecmp(argv[0],<span class='string_literal'>"h"</span>) || !strcasecmp(argv[0],<span class='string_literal'>"help"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2581"><td class="num" id="LN2581">2581</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"Redis Lua debugger help:"</span>));</td></tr>
<tr class="codeline" data-linenumber="2582"><td class="num" id="LN2582">2582</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"[h]elp               Show this help."</span>));</td></tr>
<tr class="codeline" data-linenumber="2583"><td class="num" id="LN2583">2583</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"[s]tep               Run current line and stop again."</span>));</td></tr>
<tr class="codeline" data-linenumber="2584"><td class="num" id="LN2584">2584</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"[n]ext               Alias for step."</span>));</td></tr>
<tr class="codeline" data-linenumber="2585"><td class="num" id="LN2585">2585</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"[c]continue          Run till next breakpoint."</span>));</td></tr>
<tr class="codeline" data-linenumber="2586"><td class="num" id="LN2586">2586</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"[l]list              List source code around current line."</span>));</td></tr>
<tr class="codeline" data-linenumber="2587"><td class="num" id="LN2587">2587</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"[l]list [line]       List source code around [line]."</span>));</td></tr>
<tr class="codeline" data-linenumber="2588"><td class="num" id="LN2588">2588</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"                     line = 0 means: current position."</span>));</td></tr>
<tr class="codeline" data-linenumber="2589"><td class="num" id="LN2589">2589</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"[l]list [line] [ctx] In this form [ctx] specifies how many lines"</span>));</td></tr>
<tr class="codeline" data-linenumber="2590"><td class="num" id="LN2590">2590</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"                     to show before/after [line]."</span>));</td></tr>
<tr class="codeline" data-linenumber="2591"><td class="num" id="LN2591">2591</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"[w]hole              List all source code. Alias for 'list 1 1000000'."</span>));</td></tr>
<tr class="codeline" data-linenumber="2592"><td class="num" id="LN2592">2592</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"[p]rint              Show all the local variables."</span>));</td></tr>
<tr class="codeline" data-linenumber="2593"><td class="num" id="LN2593">2593</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"[p]rint &lt;var&gt;        Show the value of the specified variable."</span>));</td></tr>
<tr class="codeline" data-linenumber="2594"><td class="num" id="LN2594">2594</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"                     Can also show global vars KEYS and ARGV."</span>));</td></tr>
<tr class="codeline" data-linenumber="2595"><td class="num" id="LN2595">2595</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"[b]reak              Show all breakpoints."</span>));</td></tr>
<tr class="codeline" data-linenumber="2596"><td class="num" id="LN2596">2596</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"[b]reak &lt;line&gt;       Add a breakpoint to the specified line."</span>));</td></tr>
<tr class="codeline" data-linenumber="2597"><td class="num" id="LN2597">2597</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"[b]reak -&lt;line&gt;      Remove breakpoint from the specified line."</span>));</td></tr>
<tr class="codeline" data-linenumber="2598"><td class="num" id="LN2598">2598</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"[b]reak 0            Remove all breakpoints."</span>));</td></tr>
<tr class="codeline" data-linenumber="2599"><td class="num" id="LN2599">2599</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"[t]race              Show a backtrace."</span>));</td></tr>
<tr class="codeline" data-linenumber="2600"><td class="num" id="LN2600">2600</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"[e]eval &lt;code&gt;       Execute some Lua code (in a different callframe)."</span>));</td></tr>
<tr class="codeline" data-linenumber="2601"><td class="num" id="LN2601">2601</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"[r]edis &lt;cmd&gt;        Execute a Redis command."</span>));</td></tr>
<tr class="codeline" data-linenumber="2602"><td class="num" id="LN2602">2602</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"[m]axlen [len]       Trim logged Redis replies and Lua var dumps to len."</span>));</td></tr>
<tr class="codeline" data-linenumber="2603"><td class="num" id="LN2603">2603</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"                     Specifying zero as &lt;len&gt; means unlimited."</span>));</td></tr>
<tr class="codeline" data-linenumber="2604"><td class="num" id="LN2604">2604</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"[a]bort              Stop the execution of the script. In sync"</span>));</td></tr>
<tr class="codeline" data-linenumber="2605"><td class="num" id="LN2605">2605</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"                     mode dataset changes will be retained."</span>));</td></tr>
<tr class="codeline" data-linenumber="2606"><td class="num" id="LN2606">2606</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>""</span>));</td></tr>
<tr class="codeline" data-linenumber="2607"><td class="num" id="LN2607">2607</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"Debugger functions you can call from Lua scripts:"</span>));</td></tr>
<tr class="codeline" data-linenumber="2608"><td class="num" id="LN2608">2608</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"redis.debug()        Produce logs in the debugger console."</span>));</td></tr>
<tr class="codeline" data-linenumber="2609"><td class="num" id="LN2609">2609</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"redis.breakpoint()   Stop execution like if there was a breakpoint in the"</span>));</td></tr>
<tr class="codeline" data-linenumber="2610"><td class="num" id="LN2610">2610</td><td class="line">ldbLog(sdsnew(<span class='string_literal'>"                     next line of code."</span>));</td></tr>
<tr class="codeline" data-linenumber="2611"><td class="num" id="LN2611">2611</td><td class="line">            ldbSendLogs();</td></tr>
<tr class="codeline" data-linenumber="2612"><td class="num" id="LN2612">2612</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(argv[0],<span class='string_literal'>"s"</span>) || !strcasecmp(argv[0],<span class='string_literal'>"step"</span>) ||</td></tr>
<tr class="codeline" data-linenumber="2613"><td class="num" id="LN2613">2613</td><td class="line">                   !strcasecmp(argv[0],<span class='string_literal'>"n"</span>) || !strcasecmp(argv[0],<span class='string_literal'>"next"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2614"><td class="num" id="LN2614">2614</td><td class="line">            ldb.step = 1;</td></tr>
<tr class="codeline" data-linenumber="2615"><td class="num" id="LN2615">2615</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2616"><td class="num" id="LN2616">2616</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(argv[0],<span class='string_literal'>"c"</span>) || !strcasecmp(argv[0],<span class='string_literal'>"continue"</span>)){</td></tr>
<tr class="codeline" data-linenumber="2617"><td class="num" id="LN2617">2617</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2618"><td class="num" id="LN2618">2618</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(argv[0],<span class='string_literal'>"t"</span>) || !strcasecmp(argv[0],<span class='string_literal'>"trace"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2619"><td class="num" id="LN2619">2619</td><td class="line">            ldbTrace(lua);</td></tr>
<tr class="codeline" data-linenumber="2620"><td class="num" id="LN2620">2620</td><td class="line">            ldbSendLogs();</td></tr>
<tr class="codeline" data-linenumber="2621"><td class="num" id="LN2621">2621</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(argv[0],<span class='string_literal'>"m"</span>) || !strcasecmp(argv[0],<span class='string_literal'>"maxlen"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2622"><td class="num" id="LN2622">2622</td><td class="line">            ldbMaxlen(argv,argc);</td></tr>
<tr class="codeline" data-linenumber="2623"><td class="num" id="LN2623">2623</td><td class="line">            ldbSendLogs();</td></tr>
<tr class="codeline" data-linenumber="2624"><td class="num" id="LN2624">2624</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(argv[0],<span class='string_literal'>"b"</span>) || !strcasecmp(argv[0],<span class='string_literal'>"break"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2625"><td class="num" id="LN2625">2625</td><td class="line">            ldbBreak(argv,argc);</td></tr>
<tr class="codeline" data-linenumber="2626"><td class="num" id="LN2626">2626</td><td class="line">            ldbSendLogs();</td></tr>
<tr class="codeline" data-linenumber="2627"><td class="num" id="LN2627">2627</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(argv[0],<span class='string_literal'>"e"</span>) || !strcasecmp(argv[0],<span class='string_literal'>"eval"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2628"><td class="num" id="LN2628">2628</td><td class="line">            ldbEval(lua,argv,argc);</td></tr>
<tr class="codeline" data-linenumber="2629"><td class="num" id="LN2629">2629</td><td class="line">            ldbSendLogs();</td></tr>
<tr class="codeline" data-linenumber="2630"><td class="num" id="LN2630">2630</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(argv[0],<span class='string_literal'>"a"</span>) || !strcasecmp(argv[0],<span class='string_literal'>"abort"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2631"><td class="num" id="LN2631">2631</td><td class="line">            lua_pushstring(lua, <span class='string_literal'>"script aborted for user request"</span>);</td></tr>
<tr class="codeline" data-linenumber="2632"><td class="num" id="LN2632">2632</td><td class="line">            lua_error(lua);</td></tr>
<tr class="codeline" data-linenumber="2633"><td class="num" id="LN2633">2633</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (argc &gt; 1 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2634"><td class="num" id="LN2634">2634</td><td class="line">                   (!strcasecmp(argv[0],<span class='string_literal'>"r"</span>) || !strcasecmp(argv[0],<span class='string_literal'>"redis"</span>))) {</td></tr>
<tr class="codeline" data-linenumber="2635"><td class="num" id="LN2635">2635</td><td class="line">            ldbRedis(lua,argv,argc);</td></tr>
<tr class="codeline" data-linenumber="2636"><td class="num" id="LN2636">2636</td><td class="line">            ldbSendLogs();</td></tr>
<tr class="codeline" data-linenumber="2637"><td class="num" id="LN2637">2637</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> ((!strcasecmp(argv[0],<span class='string_literal'>"p"</span>) || !strcasecmp(argv[0],<span class='string_literal'>"print"</span>))) {</td></tr>
<tr class="codeline" data-linenumber="2638"><td class="num" id="LN2638">2638</td><td class="line">            <span class='keyword'>if</span> (argc == 2)</td></tr>
<tr class="codeline" data-linenumber="2639"><td class="num" id="LN2639">2639</td><td class="line">                ldbPrint(lua,argv[1]);</td></tr>
<tr class="codeline" data-linenumber="2640"><td class="num" id="LN2640">2640</td><td class="line">            <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="2641"><td class="num" id="LN2641">2641</td><td class="line">                ldbPrintAll(lua);</td></tr>
<tr class="codeline" data-linenumber="2642"><td class="num" id="LN2642">2642</td><td class="line">            ldbSendLogs();</td></tr>
<tr class="codeline" data-linenumber="2643"><td class="num" id="LN2643">2643</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(argv[0],<span class='string_literal'>"l"</span>) || !strcasecmp(argv[0],<span class='string_literal'>"list"</span>)){</td></tr>
<tr class="codeline" data-linenumber="2644"><td class="num" id="LN2644">2644</td><td class="line">            <span class='keyword'>int</span> around = ldb.currentline, ctx = 5;</td></tr>
<tr class="codeline" data-linenumber="2645"><td class="num" id="LN2645">2645</td><td class="line">            <span class='keyword'>if</span> (argc &gt; 1) {</td></tr>
<tr class="codeline" data-linenumber="2646"><td class="num" id="LN2646">2646</td><td class="line">                <span class='keyword'>int</span> num = atoi(argv[1]);</td></tr>
<tr class="codeline" data-linenumber="2647"><td class="num" id="LN2647">2647</td><td class="line">                <span class='keyword'>if</span> (num &gt; 0) around = num;</td></tr>
<tr class="codeline" data-linenumber="2648"><td class="num" id="LN2648">2648</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2649"><td class="num" id="LN2649">2649</td><td class="line">            <span class='keyword'>if</span> (argc &gt; 2) ctx = atoi(argv[2]);</td></tr>
<tr class="codeline" data-linenumber="2650"><td class="num" id="LN2650">2650</td><td class="line">            ldbList(around,ctx);</td></tr>
<tr class="codeline" data-linenumber="2651"><td class="num" id="LN2651">2651</td><td class="line">            ldbSendLogs();</td></tr>
<tr class="codeline" data-linenumber="2652"><td class="num" id="LN2652">2652</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(argv[0],<span class='string_literal'>"w"</span>) || !strcasecmp(argv[0],<span class='string_literal'>"whole"</span>)){</td></tr>
<tr class="codeline" data-linenumber="2653"><td class="num" id="LN2653">2653</td><td class="line">            ldbList(1,1000000);</td></tr>
<tr class="codeline" data-linenumber="2654"><td class="num" id="LN2654">2654</td><td class="line">            ldbSendLogs();</td></tr>
<tr class="codeline" data-linenumber="2655"><td class="num" id="LN2655">2655</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2656"><td class="num" id="LN2656">2656</td><td class="line">            ldbLog(sdsnew(<span class='string_literal'>"&lt;error&gt; Unknown Redis Lua debugger command or "</span></td></tr>
<tr class="codeline" data-linenumber="2657"><td class="num" id="LN2657">2657</td><td class="line">                          <span class='string_literal'>"wrong number of arguments."</span>));</td></tr>
<tr class="codeline" data-linenumber="2658"><td class="num" id="LN2658">2658</td><td class="line">            ldbSendLogs();</td></tr>
<tr class="codeline" data-linenumber="2659"><td class="num" id="LN2659">2659</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2660"><td class="num" id="LN2660">2660</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2661"><td class="num" id="LN2661">2661</td><td class="line">        <span class='comment'>/* Free the command vector. */</span></td></tr>
<tr class="codeline" data-linenumber="2662"><td class="num" id="LN2662">2662</td><td class="line">        sdsfreesplitres(argv,argc);</td></tr>
<tr class="codeline" data-linenumber="2663"><td class="num" id="LN2663">2663</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2664"><td class="num" id="LN2664">2664</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2665"><td class="num" id="LN2665">2665</td><td class="line">    <span class='comment'>/* Free the current command argv if we break inside the while loop. */</span></td></tr>
<tr class="codeline" data-linenumber="2666"><td class="num" id="LN2666">2666</td><td class="line">    sdsfreesplitres(argv,argc);</td></tr>
<tr class="codeline" data-linenumber="2667"><td class="num" id="LN2667">2667</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2668"><td class="num" id="LN2668">2668</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2669"><td class="num" id="LN2669">2669</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2670"><td class="num" id="LN2670">2670</td><td class="line"><span class='comment'>/* This is the core of our Lua debugger, called each time Lua is about</span></td></tr>
<tr class="codeline" data-linenumber="2671"><td class="num" id="LN2671">2671</td><td class="line"> <span class='comment'>* to start executing a new line. */</span></td></tr>
<tr class="codeline" data-linenumber="2672"><td class="num" id="LN2672">2672</td><td class="line"><span class='keyword'>void</span> luaLdbLineHook(lua_State *lua, lua_Debug *ar) {</td></tr>
<tr class="codeline" data-linenumber="2673"><td class="num" id="LN2673">2673</td><td class="line">    lua_getstack(lua,0,ar);</td></tr>
<tr class="codeline" data-linenumber="2674"><td class="num" id="LN2674">2674</td><td class="line">    lua_getinfo(lua,<span class='string_literal'>"Sl"</span>,ar);</td></tr>
<tr class="codeline" data-linenumber="2675"><td class="num" id="LN2675">2675</td><td class="line">    ldb.currentline = ar-&gt;currentline;</td></tr>
<tr class="codeline" data-linenumber="2676"><td class="num" id="LN2676">2676</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2677"><td class="num" id="LN2677">2677</td><td class="line">    <span class='keyword'>int</span> bp = ldbIsBreakpoint(ldb.currentline) || ldb.luabp;</td></tr>
<tr class="codeline" data-linenumber="2678"><td class="num" id="LN2678">2678</td><td class="line">    <span class='keyword'>int</span> timeout = 0;</td></tr>
<tr class="codeline" data-linenumber="2679"><td class="num" id="LN2679">2679</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2680"><td class="num" id="LN2680">2680</td><td class="line">    <span class='comment'>/* Events outside our script are not interesting. */</span></td></tr>
<tr class="codeline" data-linenumber="2681"><td class="num" id="LN2681">2681</td><td class="line">    <span class='keyword'>if</span>(strstr(ar-&gt;short_src,<span class='string_literal'>"user_script"</span>) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2682"><td class="num" id="LN2682">2682</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2683"><td class="num" id="LN2683">2683</td><td class="line">    <span class='comment'>/* Check if a timeout occurred. */</span></td></tr>
<tr class="codeline" data-linenumber="2684"><td class="num" id="LN2684">2684</td><td class="line">    <span class='keyword'>if</span> (ar-&gt;event == <span class='macro'>LUA_HOOKCOUNT<span class='macro_popup'>3</span></span> &amp;&amp; ldb.step == 0 &amp;&amp; bp == 0) {</td></tr>
<tr class="codeline" data-linenumber="2685"><td class="num" id="LN2685">2685</td><td class="line">        mstime_t elapsed = mstime() - server.lua_time_start;</td></tr>
<tr class="codeline" data-linenumber="2686"><td class="num" id="LN2686">2686</td><td class="line">        mstime_t timelimit = server.lua_time_limit ?</td></tr>
<tr class="codeline" data-linenumber="2687"><td class="num" id="LN2687">2687</td><td class="line">                             server.lua_time_limit : 5000;</td></tr>
<tr class="codeline" data-linenumber="2688"><td class="num" id="LN2688">2688</td><td class="line">        <span class='keyword'>if</span> (elapsed &gt;= timelimit) {</td></tr>
<tr class="codeline" data-linenumber="2689"><td class="num" id="LN2689">2689</td><td class="line">            timeout = 1;</td></tr>
<tr class="codeline" data-linenumber="2690"><td class="num" id="LN2690">2690</td><td class="line">            ldb.step = 1;</td></tr>
<tr class="codeline" data-linenumber="2691"><td class="num" id="LN2691">2691</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2692"><td class="num" id="LN2692">2692</td><td class="line">            <span class='keyword'>return</span>; <span class='comment'>/* No timeout, ignore the COUNT event. */</span></td></tr>
<tr class="codeline" data-linenumber="2693"><td class="num" id="LN2693">2693</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2694"><td class="num" id="LN2694">2694</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2695"><td class="num" id="LN2695">2695</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2696"><td class="num" id="LN2696">2696</td><td class="line">    <span class='keyword'>if</span> (ldb.step || bp) {</td></tr>
<tr class="codeline" data-linenumber="2697"><td class="num" id="LN2697">2697</td><td class="line">        <span class='keyword'>char</span> *reason = <span class='string_literal'>"step over"</span>;</td></tr>
<tr class="codeline" data-linenumber="2698"><td class="num" id="LN2698">2698</td><td class="line">        <span class='keyword'>if</span> (bp) reason = ldb.luabp ? <span class='string_literal'>"redis.breakpoint() called"</span> :</td></tr>
<tr class="codeline" data-linenumber="2699"><td class="num" id="LN2699">2699</td><td class="line">                                     <span class='string_literal'>"break point"</span>;</td></tr>
<tr class="codeline" data-linenumber="2700"><td class="num" id="LN2700">2700</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (timeout) reason = <span class='string_literal'>"timeout reached, infinite loop?"</span>;</td></tr>
<tr class="codeline" data-linenumber="2701"><td class="num" id="LN2701">2701</td><td class="line">        ldb.step = 0;</td></tr>
<tr class="codeline" data-linenumber="2702"><td class="num" id="LN2702">2702</td><td class="line">        ldb.luabp = 0;</td></tr>
<tr class="codeline" data-linenumber="2703"><td class="num" id="LN2703">2703</td><td class="line">        ldbLog(sdscatprintf(sdsempty(),</td></tr>
<tr class="codeline" data-linenumber="2704"><td class="num" id="LN2704">2704</td><td class="line">            <span class='string_literal'>"* Stopped at %d, stop reason = %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="2705"><td class="num" id="LN2705">2705</td><td class="line">            ldb.currentline, reason));</td></tr>
<tr class="codeline" data-linenumber="2706"><td class="num" id="LN2706">2706</td><td class="line">        ldbLogSourceLine(ldb.currentline);</td></tr>
<tr class="codeline" data-linenumber="2707"><td class="num" id="LN2707">2707</td><td class="line">        ldbSendLogs();</td></tr>
<tr class="codeline" data-linenumber="2708"><td class="num" id="LN2708">2708</td><td class="line">        <span class='keyword'>if</span> (ldbRepl(lua) == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span> &amp;&amp; timeout) {</td></tr>
<tr class="codeline" data-linenumber="2709"><td class="num" id="LN2709">2709</td><td class="line">            <span class='comment'>/* If the client closed the connection and we have a timeout</span></td></tr>
<tr class="codeline" data-linenumber="2710"><td class="num" id="LN2710">2710</td><td class="line">             <span class='comment'>* connection, let's kill the script otherwise the process</span></td></tr>
<tr class="codeline" data-linenumber="2711"><td class="num" id="LN2711">2711</td><td class="line">             <span class='comment'>* will remain blocked indefinitely. */</span></td></tr>
<tr class="codeline" data-linenumber="2712"><td class="num" id="LN2712">2712</td><td class="line">            lua_pushstring(lua, <span class='string_literal'>"timeout during Lua debugging with client closing connection"</span>);</td></tr>
<tr class="codeline" data-linenumber="2713"><td class="num" id="LN2713">2713</td><td class="line">            lua_error(lua);</td></tr>
<tr class="codeline" data-linenumber="2714"><td class="num" id="LN2714">2714</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2715"><td class="num" id="LN2715">2715</td><td class="line">        server.lua_time_start = mstime();</td></tr>
<tr class="codeline" data-linenumber="2716"><td class="num" id="LN2716">2716</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2717"><td class="num" id="LN2717">2717</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2718"><td class="num" id="LN2718">2718</td><td class="line"> </td></tr>
</table></body></html>
