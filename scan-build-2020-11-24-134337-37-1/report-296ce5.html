<!doctype html>
<html>
<head>
<title>replication.c</title>

<style type="text/css">
body { color:#000000; background-color:#ffffff }
body { font-family:Helvetica, sans-serif; font-size:10pt }
h1 { font-size:14pt }
.FileName { margin-top: 5px; margin-bottom: 5px; display: inline; }
.FileNav { margin-left: 5px; margin-right: 5px; display: inline; }
.FileNav a { text-decoration:none; font-size: larger; }
.divider { margin-top: 30px; margin-bottom: 30px; height: 15px; }
.divider { background-color: gray; }
.code { border-collapse:collapse; width:100%; }
.code { font-family: "Monospace", monospace; font-size:10pt }
.code { line-height: 1.2em }
.comment { color: green; font-style: oblique }
.keyword { color: blue }
.string_literal { color: red }
.directive { color: darkmagenta }

/* Macros and variables could have pop-up notes hidden by default.
  - Macro pop-up:    expansion of the macro
  - Variable pop-up: value (table) of the variable */
.macro_popup, .variable_popup { display: none; }

/* Pop-up appears on mouse-hover event. */
.macro:hover .macro_popup, .variable:hover .variable_popup {
  display: block;
  padding: 2px;
  -webkit-border-radius:5px;
  -webkit-box-shadow:1px 1px 7px #000;
  border-radius:5px;
  box-shadow:1px 1px 7px #000;
  position: absolute;
  top: -1em;
  left:10em;
  z-index: 1
}

.macro_popup {
  border: 2px solid red;
  background-color:#FFF0F0;
  font-weight: normal;
}

.variable_popup {
  border: 2px solid blue;
  background-color:#F0F0FF;
  font-weight: bold;
  font-family: Helvetica, sans-serif;
  font-size: 9pt;
}

/* Pop-up notes needs a relative position as a base where they pops up. */
.macro, .variable {
  background-color: PaleGoldenRod;
  position: relative;
}
.macro { color: DarkMagenta; }

#tooltiphint {
  position: fixed;
  width: 50em;
  margin-left: -25em;
  left: 50%;
  padding: 10px;
  border: 1px solid #b0b0b0;
  border-radius: 2px;
  box-shadow: 1px 1px 7px black;
  background-color: #c0c0c0;
  z-index: 2;
}

.num { width:2.5em; padding-right:2ex; background-color:#eeeeee }
.num { text-align:right; font-size:8pt }
.num { color:#444444 }
.line { padding-left: 1ex; border-left: 3px solid #ccc }
.line { white-space: pre }
.msg { -webkit-box-shadow:1px 1px 7px #000 }
.msg { box-shadow:1px 1px 7px #000 }
.msg { -webkit-border-radius:5px }
.msg { border-radius:5px }
.msg { font-family:Helvetica, sans-serif; font-size:8pt }
.msg { float:left }
.msg { padding:0.25em 1ex 0.25em 1ex }
.msg { margin-top:10px; margin-bottom:10px }
.msg { font-weight:bold }
.msg { max-width:60em; word-wrap: break-word; white-space: pre-wrap }
.msgT { padding:0x; spacing:0x }
.msgEvent { background-color:#fff8b4; color:#000000 }
.msgControl { background-color:#bbbbbb; color:#000000 }
.msgNote { background-color:#ddeeff; color:#000000 }
.mrange { background-color:#dfddf3 }
.mrange { border-bottom:1px solid #6F9DBE }
.PathIndex { font-weight: bold; padding:0px 5px; margin-right:5px; }
.PathIndex { -webkit-border-radius:8px }
.PathIndex { border-radius:8px }
.PathIndexEvent { background-color:#bfba87 }
.PathIndexControl { background-color:#8c8c8c }
.PathIndexPopUp { background-color: #879abc; }
.PathNav a { text-decoration:none; font-size: larger }
.CodeInsertionHint { font-weight: bold; background-color: #10dd10 }
.CodeRemovalHint { background-color:#de1010 }
.CodeRemovalHint { border-bottom:1px solid #6F9DBE }
.selected{ background-color:orange !important; }

table.simpletable {
  padding: 5px;
  font-size:12pt;
  margin:20px;
  border-collapse: collapse; border-spacing: 0px;
}
td.rowname {
  text-align: right;
  vertical-align: top;
  font-weight: bold;
  color:#444444;
  padding-right:2ex;
}

/* Hidden text. */
input.spoilerhider + label {
  cursor: pointer;
  text-decoration: underline;
  display: block;
}
input.spoilerhider {
 display: none;
}
input.spoilerhider ~ .spoiler {
  overflow: hidden;
  margin: 10px auto 0;
  height: 0;
  opacity: 0;
}
input.spoilerhider:checked + label + .spoiler{
  height: auto;
  opacity: 1;
}
</style>
</head>
<body>
<!-- BUGDESC Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11 -->

<!-- BUGTYPE Potential insecure memory buffer bounds restriction in call 'memcpy' -->

<!-- BUGCATEGORY Security -->

<!-- BUGFILE /tmp/sslab_clang/c_redis/redis/src/replication.c -->

<!-- FILENAME replication.c -->

<!-- FUNCTIONNAME readSyncBulkPayload -->

<!-- ISSUEHASHCONTENTOFLINEINCONTEXT c1794c9faf8d84118104e78d8a0e1dd6 -->

<!-- BUGLINE 1585 -->

<!-- BUGCOLUMN 17 -->

<!-- BUGPATHLENGTH 1 -->

<!-- BUGMETAEND -->
<!-- REPORTHEADER -->
<h3>Bug Summary</h3>
<table class="simpletable">
<tr><td class="rowname">File:</td><td>src/replication.c</td></tr>
<tr><td class="rowname">Warning:</td><td><a href="#EndPath">line 1585, column 17</a><br />Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11</td></tr>

</table>
<!-- REPORTSUMMARYEXTRA -->
<h3>Annotated Source Code</h3>
<p>Press <a href="#" onclick="toggleHelp(); return false;">'?'</a>
   to see keyboard shortcuts</p>
<input type="checkbox" class="spoilerhider" id="showinvocation" />
<label for="showinvocation" >Show analyzer invocation</label>
<div class="spoiler">clang -cc1 -cc1 -triple x86_64-unknown-linux-gnu -analyze -disable-free -main-file-name replication.c -analyzer-store=region -analyzer-opt-analyze-nested-blocks -analyzer-checker=core -analyzer-checker=apiModeling -analyzer-checker=unix -analyzer-checker=deadcode -analyzer-checker=security.insecureAPI.UncheckedReturn -analyzer-checker=security.insecureAPI.getpw -analyzer-checker=security.insecureAPI.gets -analyzer-checker=security.insecureAPI.mktemp -analyzer-checker=security.insecureAPI.mkstemp -analyzer-checker=security.insecureAPI.vfork -analyzer-checker=nullability.NullPassedToNonnull -analyzer-checker=nullability.NullReturnedFromNonnull -analyzer-output plist -w -setup-static-analyzer -mrelocation-model static -mframe-pointer=none -fmath-errno -fno-rounding-math -mconstructor-aliases -munwind-tables -target-cpu x86-64 -fno-split-dwarf-inlining -debugger-tuning=gdb -resource-dir /llvm-project/build/lib/clang/12.0.0 -D REDIS_STATIC= -I ../deps/hiredis -I ../deps/linenoise -I ../deps/lua/src -D USE_JEMALLOC -I ../deps/jemalloc/include -internal-isystem /usr/local/include -internal-isystem /llvm-project/build/lib/clang/12.0.0/include -internal-externc-isystem /usr/include/x86_64-linux-gnu -internal-externc-isystem /include -internal-externc-isystem /usr/include -O2 -Wno-missing-field-initializers -std=c11 -fdebug-compilation-dir /tmp/sslab_clang/c_redis/redis/src -ferror-limit 19 -fgnuc-version=4.2.1 -vectorize-loops -vectorize-slp -analyzer-checker core -analyzer-checker cplusplus -analyzer-checker nullability -analyzer-checker optin -analyzer-checker security -analyzer-checker unix -analyzer-checker osx -analyzer-checker fuchsia -analyzer-checker webkit -analyzer-output=html -faddrsig -o /tmp/scan-build-2020-11-24-134337-37-1 -x c replication.c
</div>
<div id='tooltiphint' hidden="true">
  <p>Keyboard shortcuts: </p>
  <ul>
    <li>Use 'j/k' keys for keyboard navigation</li>
    <li>Use 'Shift+S' to show/hide relevant lines</li>
    <li>Use '?' to toggle this window</li>
  </ul>
  <a href="#" onclick="toggleHelp(); return false;">Close</a>
</div>
<script type='text/javascript'>
var relevant_lines = {"1": {"1585": 1}};

var filterCounterexample = function (hide) {
  var tables = document.getElementsByClassName("code");
  for (var t=0; t<tables.length; t++) {
    var table = tables[t];
    var file_id = table.getAttribute("data-fileid");
    var lines_in_fid = relevant_lines[file_id];
    if (!lines_in_fid) {
      lines_in_fid = {};
    }
    var lines = table.getElementsByClassName("codeline");
    for (var i=0; i<lines.length; i++) {
        var el = lines[i];
        var lineNo = el.getAttribute("data-linenumber");
        if (!lines_in_fid[lineNo]) {
          if (hide) {
            el.setAttribute("hidden", "");
          } else {
            el.removeAttribute("hidden");
          }
        }
    }
  }
}

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "S") {
    var checked = document.getElementsByName("showCounterexample")[0].checked;
    filterCounterexample(!checked);
    document.getElementsByName("showCounterexample")[0].checked = !checked;
  } else {
    return;
  }
  event.preventDefault();
}, true);

document.addEventListener("DOMContentLoaded", function() {
    document.querySelector('input[name="showCounterexample"]').onchange=
        function (event) {
      filterCounterexample(this.checked);
    };
});
</script>

<form>
    <input type="checkbox" name="showCounterexample" id="showCounterexample" />
    <label for="showCounterexample">
       Show only relevant lines
    </label>
</form>

<script type='text/javascript'>
var digitMatcher = new RegExp("[0-9]+");

var querySelectorAllArray = function(selector) {
  return Array.prototype.slice.call(
    document.querySelectorAll(selector));
}

document.addEventListener("DOMContentLoaded", function() {
    querySelectorAllArray(".PathNav > a").forEach(
        function(currentValue, currentIndex) {
            var hrefValue = currentValue.getAttribute("href");
            currentValue.onclick = function() {
                scrollTo(document.querySelector(hrefValue));
                return false;
            };
        });
});

var findNum = function() {
    var s = document.querySelector(".selected");
    if (!s || s.id == "EndPath") {
        return 0;
    }
    var out = parseInt(digitMatcher.exec(s.id)[0]);
    return out;
};

var scrollTo = function(el) {
    querySelectorAllArray(".selected").forEach(function(s) {
        s.classList.remove("selected");
    });
    el.classList.add("selected");
    window.scrollBy(0, el.getBoundingClientRect().top -
        (window.innerHeight / 2));
}

var move = function(num, up, numItems) {
  if (num == 1 && up || num == numItems - 1 && !up) {
    return 0;
  } else if (num == 0 && up) {
    return numItems - 1;
  } else if (num == 0 && !up) {
    return 1 % numItems;
  }
  return up ? num - 1 : num + 1;
}

var numToId = function(num) {
  if (num == 0) {
    return document.getElementById("EndPath")
  }
  return document.getElementById("Path" + num);
};

var navigateTo = function(up) {
  var numItems = document.querySelectorAll(
      ".line > .msgEvent, .line > .msgControl").length;
  var currentSelected = findNum();
  var newSelected = move(currentSelected, up, numItems);
  var newEl = numToId(newSelected, numItems);

  // Scroll element into center.
  scrollTo(newEl);
};

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "j") {
    navigateTo(/*up=*/false);
  } else if (event.key == "k") {
    navigateTo(/*up=*/true);
  } else {
    return;
  }
  event.preventDefault();
}, true);
</script>
  
<script type='text/javascript'>

var toggleHelp = function() {
    var hint = document.querySelector("#tooltiphint");
    var attributeName = "hidden";
    if (hint.hasAttribute(attributeName)) {
      hint.removeAttribute(attributeName);
    } else {
      hint.setAttribute("hidden", "true");
    }
};
window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "?") {
    toggleHelp();
  } else {
    return;
  }
  event.preventDefault();
});
</script>
<table class="code" data-fileid="1">
<tr class="codeline" data-linenumber="1"><td class="num" id="LN1">1</td><td class="line"><span class='comment'>/* Asynchronous replication implementation.</span></td></tr>
<tr class="codeline" data-linenumber="2"><td class="num" id="LN2">2</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3"><td class="num" id="LN3">3</td><td class="line"> <span class='comment'>* Copyright (c) 2009-2012, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;</span></td></tr>
<tr class="codeline" data-linenumber="4"><td class="num" id="LN4">4</td><td class="line"> <span class='comment'>* All rights reserved.</span></td></tr>
<tr class="codeline" data-linenumber="5"><td class="num" id="LN5">5</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="6"><td class="num" id="LN6">6</td><td class="line"> <span class='comment'>* Redistribution and use in source and binary forms, with or without</span></td></tr>
<tr class="codeline" data-linenumber="7"><td class="num" id="LN7">7</td><td class="line"> <span class='comment'>* modification, are permitted provided that the following conditions are met:</span></td></tr>
<tr class="codeline" data-linenumber="8"><td class="num" id="LN8">8</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="9"><td class="num" id="LN9">9</td><td class="line"> <span class='comment'>*   * Redistributions of source code must retain the above copyright notice,</span></td></tr>
<tr class="codeline" data-linenumber="10"><td class="num" id="LN10">10</td><td class="line"> <span class='comment'>*     this list of conditions and the following disclaimer.</span></td></tr>
<tr class="codeline" data-linenumber="11"><td class="num" id="LN11">11</td><td class="line"> <span class='comment'>*   * Redistributions in binary form must reproduce the above copyright</span></td></tr>
<tr class="codeline" data-linenumber="12"><td class="num" id="LN12">12</td><td class="line"> <span class='comment'>*     notice, this list of conditions and the following disclaimer in the</span></td></tr>
<tr class="codeline" data-linenumber="13"><td class="num" id="LN13">13</td><td class="line"> <span class='comment'>*     documentation and/or other materials provided with the distribution.</span></td></tr>
<tr class="codeline" data-linenumber="14"><td class="num" id="LN14">14</td><td class="line"> <span class='comment'>*   * Neither the name of Redis nor the names of its contributors may be used</span></td></tr>
<tr class="codeline" data-linenumber="15"><td class="num" id="LN15">15</td><td class="line"> <span class='comment'>*     to endorse or promote products derived from this software without</span></td></tr>
<tr class="codeline" data-linenumber="16"><td class="num" id="LN16">16</td><td class="line"> <span class='comment'>*     specific prior written permission.</span></td></tr>
<tr class="codeline" data-linenumber="17"><td class="num" id="LN17">17</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="18"><td class="num" id="LN18">18</td><td class="line"> <span class='comment'>* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"</span></td></tr>
<tr class="codeline" data-linenumber="19"><td class="num" id="LN19">19</td><td class="line"> <span class='comment'>* AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span></td></tr>
<tr class="codeline" data-linenumber="20"><td class="num" id="LN20">20</td><td class="line"> <span class='comment'>* IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span></td></tr>
<tr class="codeline" data-linenumber="21"><td class="num" id="LN21">21</td><td class="line"> <span class='comment'>* ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span></td></tr>
<tr class="codeline" data-linenumber="22"><td class="num" id="LN22">22</td><td class="line"> <span class='comment'>* LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span></td></tr>
<tr class="codeline" data-linenumber="23"><td class="num" id="LN23">23</td><td class="line"> <span class='comment'>* CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span></td></tr>
<tr class="codeline" data-linenumber="24"><td class="num" id="LN24">24</td><td class="line"> <span class='comment'>* SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span></td></tr>
<tr class="codeline" data-linenumber="25"><td class="num" id="LN25">25</td><td class="line"> <span class='comment'>* INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span></td></tr>
<tr class="codeline" data-linenumber="26"><td class="num" id="LN26">26</td><td class="line"> <span class='comment'>* CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span></td></tr>
<tr class="codeline" data-linenumber="27"><td class="num" id="LN27">27</td><td class="line"> <span class='comment'>* ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span></td></tr>
<tr class="codeline" data-linenumber="28"><td class="num" id="LN28">28</td><td class="line"> <span class='comment'>* POSSIBILITY OF SUCH DAMAGE.</span></td></tr>
<tr class="codeline" data-linenumber="29"><td class="num" id="LN29">29</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="30"><td class="num" id="LN30">30</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="31"><td class="num" id="LN31">31</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="32"><td class="num" id="LN32">32</td><td class="line"><span class='directive'>#include "server.h"</span></td></tr>
<tr class="codeline" data-linenumber="33"><td class="num" id="LN33">33</td><td class="line"><span class='directive'>#include "cluster.h"</span></td></tr>
<tr class="codeline" data-linenumber="34"><td class="num" id="LN34">34</td><td class="line"><span class='directive'>#include "bio.h"</span></td></tr>
<tr class="codeline" data-linenumber="35"><td class="num" id="LN35">35</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="36"><td class="num" id="LN36">36</td><td class="line"><span class='directive'>#include &lt;sys/time.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="37"><td class="num" id="LN37">37</td><td class="line"><span class='directive'>#include &lt;unistd.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="38"><td class="num" id="LN38">38</td><td class="line"><span class='directive'>#include &lt;fcntl.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="39"><td class="num" id="LN39">39</td><td class="line"><span class='directive'>#include &lt;sys/socket.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="40"><td class="num" id="LN40">40</td><td class="line"><span class='directive'>#include &lt;sys/stat.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="41"><td class="num" id="LN41">41</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="42"><td class="num" id="LN42">42</td><td class="line"><span class='keyword'>void</span> replicationDiscardCachedMaster(<span class='keyword'>void</span>);</td></tr>
<tr class="codeline" data-linenumber="43"><td class="num" id="LN43">43</td><td class="line"><span class='keyword'>void</span> replicationResurrectCachedMaster(connection *conn);</td></tr>
<tr class="codeline" data-linenumber="44"><td class="num" id="LN44">44</td><td class="line"><span class='keyword'>void</span> replicationSendAck(<span class='keyword'>void</span>);</td></tr>
<tr class="codeline" data-linenumber="45"><td class="num" id="LN45">45</td><td class="line"><span class='keyword'>void</span> putSlaveOnline(client *slave);</td></tr>
<tr class="codeline" data-linenumber="46"><td class="num" id="LN46">46</td><td class="line"><span class='keyword'>int</span> cancelReplicationHandshake(<span class='keyword'>void</span>);</td></tr>
<tr class="codeline" data-linenumber="47"><td class="num" id="LN47">47</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="48"><td class="num" id="LN48">48</td><td class="line"><span class='comment'>/* We take a global flag to remember if this instance generated an RDB</span></td></tr>
<tr class="codeline" data-linenumber="49"><td class="num" id="LN49">49</td><td class="line"> <span class='comment'>* because of replication, so that we can remove the RDB file in case</span></td></tr>
<tr class="codeline" data-linenumber="50"><td class="num" id="LN50">50</td><td class="line"> <span class='comment'>* the instance is configured to have no persistence. */</span></td></tr>
<tr class="codeline" data-linenumber="51"><td class="num" id="LN51">51</td><td class="line"><span class='keyword'>int</span> RDBGeneratedByReplication = 0;</td></tr>
<tr class="codeline" data-linenumber="52"><td class="num" id="LN52">52</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="53"><td class="num" id="LN53">53</td><td class="line"><span class='comment'>/* --------------------------- Utility functions ---------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="54"><td class="num" id="LN54">54</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="55"><td class="num" id="LN55">55</td><td class="line"><span class='comment'>/* Return the pointer to a string representing the slave ip:listening_port</span></td></tr>
<tr class="codeline" data-linenumber="56"><td class="num" id="LN56">56</td><td class="line"> <span class='comment'>* pair. Mostly useful for logging, since we want to log a slave using its</span></td></tr>
<tr class="codeline" data-linenumber="57"><td class="num" id="LN57">57</td><td class="line"> <span class='comment'>* IP address and its listening port which is more clear for the user, for</span></td></tr>
<tr class="codeline" data-linenumber="58"><td class="num" id="LN58">58</td><td class="line"> <span class='comment'>* example: "Closing connection with replica 10.1.2.3:6380". */</span></td></tr>
<tr class="codeline" data-linenumber="59"><td class="num" id="LN59">59</td><td class="line"><span class='keyword'>char</span> *replicationGetSlaveName(client *c) {</td></tr>
<tr class="codeline" data-linenumber="60"><td class="num" id="LN60">60</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>char</span> buf[<span class='macro'>NET_PEER_ID_LEN<span class='macro_popup'>(46 +32)</span></span>];</td></tr>
<tr class="codeline" data-linenumber="61"><td class="num" id="LN61">61</td><td class="line">    <span class='keyword'>char</span> ip[<span class='macro'>NET_IP_STR_LEN<span class='macro_popup'>46</span></span>];</td></tr>
<tr class="codeline" data-linenumber="62"><td class="num" id="LN62">62</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="63"><td class="num" id="LN63">63</td><td class="line">    ip[0] = '\0';</td></tr>
<tr class="codeline" data-linenumber="64"><td class="num" id="LN64">64</td><td class="line">    buf[0] = '\0';</td></tr>
<tr class="codeline" data-linenumber="65"><td class="num" id="LN65">65</td><td class="line">    <span class='keyword'>if</span> (c-&gt;slave_ip[0] != '\0' ||</td></tr>
<tr class="codeline" data-linenumber="66"><td class="num" id="LN66">66</td><td class="line">        connPeerToString(c-&gt;conn,ip,<span class='keyword'>sizeof</span>(ip),<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) != -1)</td></tr>
<tr class="codeline" data-linenumber="67"><td class="num" id="LN67">67</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="68"><td class="num" id="LN68">68</td><td class="line">        <span class='comment'>/* Note that the 'ip' buffer is always larger than 'c-&gt;slave_ip' */</span></td></tr>
<tr class="codeline" data-linenumber="69"><td class="num" id="LN69">69</td><td class="line">        <span class='keyword'>if</span> (c-&gt;slave_ip[0] != '\0') memcpy(ip,c-&gt;slave_ip,<span class='keyword'>sizeof</span>(c-&gt;slave_ip));</td></tr>
<tr class="codeline" data-linenumber="70"><td class="num" id="LN70">70</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="71"><td class="num" id="LN71">71</td><td class="line">        <span class='keyword'>if</span> (c-&gt;slave_listening_port)</td></tr>
<tr class="codeline" data-linenumber="72"><td class="num" id="LN72">72</td><td class="line">            anetFormatAddr(buf,<span class='keyword'>sizeof</span>(buf),ip,c-&gt;slave_listening_port);</td></tr>
<tr class="codeline" data-linenumber="73"><td class="num" id="LN73">73</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="74"><td class="num" id="LN74">74</td><td class="line">            snprintf(buf,<span class='keyword'>sizeof</span>(buf),<span class='string_literal'>"%s:&lt;unknown-replica-port&gt;"</span>,ip);</td></tr>
<tr class="codeline" data-linenumber="75"><td class="num" id="LN75">75</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="76"><td class="num" id="LN76">76</td><td class="line">        snprintf(buf,<span class='keyword'>sizeof</span>(buf),<span class='string_literal'>"client id #%llu"</span>,</td></tr>
<tr class="codeline" data-linenumber="77"><td class="num" id="LN77">77</td><td class="line">            (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>) c-&gt;id);</td></tr>
<tr class="codeline" data-linenumber="78"><td class="num" id="LN78">78</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="79"><td class="num" id="LN79">79</td><td class="line">    <span class='keyword'>return</span> buf;</td></tr>
<tr class="codeline" data-linenumber="80"><td class="num" id="LN80">80</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="81"><td class="num" id="LN81">81</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="82"><td class="num" id="LN82">82</td><td class="line"><span class='comment'>/* Plain unlink() can block for quite some time in order to actually apply</span></td></tr>
<tr class="codeline" data-linenumber="83"><td class="num" id="LN83">83</td><td class="line"> <span class='comment'>* the file deletion to the filesystem. This call removes the file in a</span></td></tr>
<tr class="codeline" data-linenumber="84"><td class="num" id="LN84">84</td><td class="line"> <span class='comment'>* background thread instead. We actually just do close() in the thread,</span></td></tr>
<tr class="codeline" data-linenumber="85"><td class="num" id="LN85">85</td><td class="line"> <span class='comment'>* by using the fact that if there is another instance of the same file open,</span></td></tr>
<tr class="codeline" data-linenumber="86"><td class="num" id="LN86">86</td><td class="line"> <span class='comment'>* the foreground unlink() will only remove the fs name, and deleting the</span></td></tr>
<tr class="codeline" data-linenumber="87"><td class="num" id="LN87">87</td><td class="line"> <span class='comment'>* file's storage space will only happen once the last reference is lost. */</span></td></tr>
<tr class="codeline" data-linenumber="88"><td class="num" id="LN88">88</td><td class="line"><span class='keyword'>int</span> bg_unlink(<span class='keyword'>const</span> <span class='keyword'>char</span> *filename) {</td></tr>
<tr class="codeline" data-linenumber="89"><td class="num" id="LN89">89</td><td class="line">    <span class='keyword'>int</span> fd = open(filename,<span class='macro'>O_RDONLY<span class='macro_popup'>00</span></span>|<span class='macro'>O_NONBLOCK<span class='macro_popup'>04000</span></span>);</td></tr>
<tr class="codeline" data-linenumber="90"><td class="num" id="LN90">90</td><td class="line">    <span class='keyword'>if</span> (fd == -1) {</td></tr>
<tr class="codeline" data-linenumber="91"><td class="num" id="LN91">91</td><td class="line">        <span class='comment'>/* Can't open the file? Fall back to unlinking in the main thread. */</span></td></tr>
<tr class="codeline" data-linenumber="92"><td class="num" id="LN92">92</td><td class="line">        <span class='keyword'>return</span> unlink(filename);</td></tr>
<tr class="codeline" data-linenumber="93"><td class="num" id="LN93">93</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="94"><td class="num" id="LN94">94</td><td class="line">        <span class='comment'>/* The following unlink() removes the name but doesn't free the</span></td></tr>
<tr class="codeline" data-linenumber="95"><td class="num" id="LN95">95</td><td class="line">         <span class='comment'>* file contents because a process still has it open. */</span></td></tr>
<tr class="codeline" data-linenumber="96"><td class="num" id="LN96">96</td><td class="line">        <span class='keyword'>int</span> retval = unlink(filename);</td></tr>
<tr class="codeline" data-linenumber="97"><td class="num" id="LN97">97</td><td class="line">        <span class='keyword'>if</span> (retval == -1) {</td></tr>
<tr class="codeline" data-linenumber="98"><td class="num" id="LN98">98</td><td class="line">            <span class='comment'>/* If we got an unlink error, we just return it, closing the</span></td></tr>
<tr class="codeline" data-linenumber="99"><td class="num" id="LN99">99</td><td class="line">             <span class='comment'>* new reference we have to the file. */</span></td></tr>
<tr class="codeline" data-linenumber="100"><td class="num" id="LN100">100</td><td class="line">            <span class='keyword'>int</span> old_errno = <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>;</td></tr>
<tr class="codeline" data-linenumber="101"><td class="num" id="LN101">101</td><td class="line">            close(fd);  <span class='comment'>/* This would overwrite our errno. So we saved it. */</span></td></tr>
<tr class="codeline" data-linenumber="102"><td class="num" id="LN102">102</td><td class="line">            <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> = old_errno;</td></tr>
<tr class="codeline" data-linenumber="103"><td class="num" id="LN103">103</td><td class="line">            <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="104"><td class="num" id="LN104">104</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="105"><td class="num" id="LN105">105</td><td class="line">        bioCreateBackgroundJob(<span class='macro'>BIO_CLOSE_FILE<span class='macro_popup'>0</span></span>,(<span class='keyword'>void</span>*)(<span class='keyword'>long</span>)fd,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="106"><td class="num" id="LN106">106</td><td class="line">        <span class='keyword'>return</span> 0; <span class='comment'>/* Success. */</span></td></tr>
<tr class="codeline" data-linenumber="107"><td class="num" id="LN107">107</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="108"><td class="num" id="LN108">108</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="109"><td class="num" id="LN109">109</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="110"><td class="num" id="LN110">110</td><td class="line"><span class='comment'>/* ---------------------------------- MASTER -------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="111"><td class="num" id="LN111">111</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="112"><td class="num" id="LN112">112</td><td class="line"><span class='keyword'>void</span> createReplicationBacklog(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="113"><td class="num" id="LN113">113</td><td class="line">    <span class='macro'>serverAssert(server.repl_backlog == NULL)<span class='macro_popup'>((server.repl_backlog == ((void*)0))?(void)0 : (_serverAssert<br>("server.repl_backlog == NULL","replication.c",113),_exit(1))<br>)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="114"><td class="num" id="LN114">114</td><td class="line">    server.repl_backlog = zmalloc(server.repl_backlog_size);</td></tr>
<tr class="codeline" data-linenumber="115"><td class="num" id="LN115">115</td><td class="line">    server.repl_backlog_histlen = 0;</td></tr>
<tr class="codeline" data-linenumber="116"><td class="num" id="LN116">116</td><td class="line">    server.repl_backlog_idx = 0;</td></tr>
<tr class="codeline" data-linenumber="117"><td class="num" id="LN117">117</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="118"><td class="num" id="LN118">118</td><td class="line">    <span class='comment'>/* We don't have any data inside our buffer, but virtually the first</span></td></tr>
<tr class="codeline" data-linenumber="119"><td class="num" id="LN119">119</td><td class="line">     <span class='comment'>* byte we have is the next byte that will be generated for the</span></td></tr>
<tr class="codeline" data-linenumber="120"><td class="num" id="LN120">120</td><td class="line">     <span class='comment'>* replication stream. */</span></td></tr>
<tr class="codeline" data-linenumber="121"><td class="num" id="LN121">121</td><td class="line">    server.repl_backlog_off = server.master_repl_offset+1;</td></tr>
<tr class="codeline" data-linenumber="122"><td class="num" id="LN122">122</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="123"><td class="num" id="LN123">123</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="124"><td class="num" id="LN124">124</td><td class="line"><span class='comment'>/* This function is called when the user modifies the replication backlog</span></td></tr>
<tr class="codeline" data-linenumber="125"><td class="num" id="LN125">125</td><td class="line"> <span class='comment'>* size at runtime. It is up to the function to both update the</span></td></tr>
<tr class="codeline" data-linenumber="126"><td class="num" id="LN126">126</td><td class="line"> <span class='comment'>* server.repl_backlog_size and to resize the buffer and setup it so that</span></td></tr>
<tr class="codeline" data-linenumber="127"><td class="num" id="LN127">127</td><td class="line"> <span class='comment'>* it contains the same data as the previous one (possibly less data, but</span></td></tr>
<tr class="codeline" data-linenumber="128"><td class="num" id="LN128">128</td><td class="line"> <span class='comment'>* the most recent bytes, or the same data and more free space in case the</span></td></tr>
<tr class="codeline" data-linenumber="129"><td class="num" id="LN129">129</td><td class="line"> <span class='comment'>* buffer is enlarged). */</span></td></tr>
<tr class="codeline" data-linenumber="130"><td class="num" id="LN130">130</td><td class="line"><span class='keyword'>void</span> resizeReplicationBacklog(<span class='keyword'>long</span> <span class='keyword'>long</span> newsize) {</td></tr>
<tr class="codeline" data-linenumber="131"><td class="num" id="LN131">131</td><td class="line">    <span class='keyword'>if</span> (newsize &lt; <span class='macro'>CONFIG_REPL_BACKLOG_MIN_SIZE<span class='macro_popup'>(1024*16)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="132"><td class="num" id="LN132">132</td><td class="line">        newsize = <span class='macro'>CONFIG_REPL_BACKLOG_MIN_SIZE<span class='macro_popup'>(1024*16)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="133"><td class="num" id="LN133">133</td><td class="line">    <span class='keyword'>if</span> (server.repl_backlog_size == newsize) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="134"><td class="num" id="LN134">134</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="135"><td class="num" id="LN135">135</td><td class="line">    server.repl_backlog_size = newsize;</td></tr>
<tr class="codeline" data-linenumber="136"><td class="num" id="LN136">136</td><td class="line">    <span class='keyword'>if</span> (server.repl_backlog != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="137"><td class="num" id="LN137">137</td><td class="line">        <span class='comment'>/* What we actually do is to flush the old buffer and realloc a new</span></td></tr>
<tr class="codeline" data-linenumber="138"><td class="num" id="LN138">138</td><td class="line">         <span class='comment'>* empty one. It will refill with new data incrementally.</span></td></tr>
<tr class="codeline" data-linenumber="139"><td class="num" id="LN139">139</td><td class="line">         <span class='comment'>* The reason is that copying a few gigabytes adds latency and even</span></td></tr>
<tr class="codeline" data-linenumber="140"><td class="num" id="LN140">140</td><td class="line">         <span class='comment'>* worse often we need to alloc additional space before freeing the</span></td></tr>
<tr class="codeline" data-linenumber="141"><td class="num" id="LN141">141</td><td class="line">         <span class='comment'>* old buffer. */</span></td></tr>
<tr class="codeline" data-linenumber="142"><td class="num" id="LN142">142</td><td class="line">        zfree(server.repl_backlog);</td></tr>
<tr class="codeline" data-linenumber="143"><td class="num" id="LN143">143</td><td class="line">        server.repl_backlog = zmalloc(server.repl_backlog_size);</td></tr>
<tr class="codeline" data-linenumber="144"><td class="num" id="LN144">144</td><td class="line">        server.repl_backlog_histlen = 0;</td></tr>
<tr class="codeline" data-linenumber="145"><td class="num" id="LN145">145</td><td class="line">        server.repl_backlog_idx = 0;</td></tr>
<tr class="codeline" data-linenumber="146"><td class="num" id="LN146">146</td><td class="line">        <span class='comment'>/* Next byte we have is... the next since the buffer is empty. */</span></td></tr>
<tr class="codeline" data-linenumber="147"><td class="num" id="LN147">147</td><td class="line">        server.repl_backlog_off = server.master_repl_offset+1;</td></tr>
<tr class="codeline" data-linenumber="148"><td class="num" id="LN148">148</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="149"><td class="num" id="LN149">149</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="150"><td class="num" id="LN150">150</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="151"><td class="num" id="LN151">151</td><td class="line"><span class='keyword'>void</span> freeReplicationBacklog(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="152"><td class="num" id="LN152">152</td><td class="line">    <span class='macro'>serverAssert(listLength(server.slaves) == 0)<span class='macro_popup'>((((server.slaves)-&gt;len) == 0)?(void)0 : (_serverAssert("listLength(server.slaves) == 0"<br>,"replication.c",152),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="153"><td class="num" id="LN153">153</td><td class="line">    zfree(server.repl_backlog);</td></tr>
<tr class="codeline" data-linenumber="154"><td class="num" id="LN154">154</td><td class="line">    server.repl_backlog = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="155"><td class="num" id="LN155">155</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="156"><td class="num" id="LN156">156</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="157"><td class="num" id="LN157">157</td><td class="line"><span class='comment'>/* Add data to the replication backlog.</span></td></tr>
<tr class="codeline" data-linenumber="158"><td class="num" id="LN158">158</td><td class="line"> <span class='comment'>* This function also increments the global replication offset stored at</span></td></tr>
<tr class="codeline" data-linenumber="159"><td class="num" id="LN159">159</td><td class="line"> <span class='comment'>* server.master_repl_offset, because there is no case where we want to feed</span></td></tr>
<tr class="codeline" data-linenumber="160"><td class="num" id="LN160">160</td><td class="line"> <span class='comment'>* the backlog without incrementing the offset. */</span></td></tr>
<tr class="codeline" data-linenumber="161"><td class="num" id="LN161">161</td><td class="line"><span class='keyword'>void</span> feedReplicationBacklog(<span class='keyword'>void</span> *ptr, size_t len) {</td></tr>
<tr class="codeline" data-linenumber="162"><td class="num" id="LN162">162</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p = ptr;</td></tr>
<tr class="codeline" data-linenumber="163"><td class="num" id="LN163">163</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="164"><td class="num" id="LN164">164</td><td class="line">    server.master_repl_offset += len;</td></tr>
<tr class="codeline" data-linenumber="165"><td class="num" id="LN165">165</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="166"><td class="num" id="LN166">166</td><td class="line">    <span class='comment'>/* This is a circular buffer, so write as much data we can at every</span></td></tr>
<tr class="codeline" data-linenumber="167"><td class="num" id="LN167">167</td><td class="line">     <span class='comment'>* iteration and rewind the "idx" index if we reach the limit. */</span></td></tr>
<tr class="codeline" data-linenumber="168"><td class="num" id="LN168">168</td><td class="line">    <span class='keyword'>while</span>(len) {</td></tr>
<tr class="codeline" data-linenumber="169"><td class="num" id="LN169">169</td><td class="line">        size_t thislen = server.repl_backlog_size - server.repl_backlog_idx;</td></tr>
<tr class="codeline" data-linenumber="170"><td class="num" id="LN170">170</td><td class="line">        <span class='keyword'>if</span> (thislen &gt; len) thislen = len;</td></tr>
<tr class="codeline" data-linenumber="171"><td class="num" id="LN171">171</td><td class="line">        memcpy(server.repl_backlog+server.repl_backlog_idx,p,thislen);</td></tr>
<tr class="codeline" data-linenumber="172"><td class="num" id="LN172">172</td><td class="line">        server.repl_backlog_idx += thislen;</td></tr>
<tr class="codeline" data-linenumber="173"><td class="num" id="LN173">173</td><td class="line">        <span class='keyword'>if</span> (server.repl_backlog_idx == server.repl_backlog_size)</td></tr>
<tr class="codeline" data-linenumber="174"><td class="num" id="LN174">174</td><td class="line">            server.repl_backlog_idx = 0;</td></tr>
<tr class="codeline" data-linenumber="175"><td class="num" id="LN175">175</td><td class="line">        len -= thislen;</td></tr>
<tr class="codeline" data-linenumber="176"><td class="num" id="LN176">176</td><td class="line">        p += thislen;</td></tr>
<tr class="codeline" data-linenumber="177"><td class="num" id="LN177">177</td><td class="line">        server.repl_backlog_histlen += thislen;</td></tr>
<tr class="codeline" data-linenumber="178"><td class="num" id="LN178">178</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="179"><td class="num" id="LN179">179</td><td class="line">    <span class='keyword'>if</span> (server.repl_backlog_histlen &gt; server.repl_backlog_size)</td></tr>
<tr class="codeline" data-linenumber="180"><td class="num" id="LN180">180</td><td class="line">        server.repl_backlog_histlen = server.repl_backlog_size;</td></tr>
<tr class="codeline" data-linenumber="181"><td class="num" id="LN181">181</td><td class="line">    <span class='comment'>/* Set the offset of the first byte we have in the backlog. */</span></td></tr>
<tr class="codeline" data-linenumber="182"><td class="num" id="LN182">182</td><td class="line">    server.repl_backlog_off = server.master_repl_offset -</td></tr>
<tr class="codeline" data-linenumber="183"><td class="num" id="LN183">183</td><td class="line">                              server.repl_backlog_histlen + 1;</td></tr>
<tr class="codeline" data-linenumber="184"><td class="num" id="LN184">184</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="185"><td class="num" id="LN185">185</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="186"><td class="num" id="LN186">186</td><td class="line"><span class='comment'>/* Wrapper for feedReplicationBacklog() that takes Redis string objects</span></td></tr>
<tr class="codeline" data-linenumber="187"><td class="num" id="LN187">187</td><td class="line"> <span class='comment'>* as input. */</span></td></tr>
<tr class="codeline" data-linenumber="188"><td class="num" id="LN188">188</td><td class="line"><span class='keyword'>void</span> feedReplicationBacklogWithObject(robj *o) {</td></tr>
<tr class="codeline" data-linenumber="189"><td class="num" id="LN189">189</td><td class="line">    <span class='keyword'>char</span> llstr[<span class='macro'>LONG_STR_SIZE<span class='macro_popup'>21</span></span>];</td></tr>
<tr class="codeline" data-linenumber="190"><td class="num" id="LN190">190</td><td class="line">    <span class='keyword'>void</span> *p;</td></tr>
<tr class="codeline" data-linenumber="191"><td class="num" id="LN191">191</td><td class="line">    size_t len;</td></tr>
<tr class="codeline" data-linenumber="192"><td class="num" id="LN192">192</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="193"><td class="num" id="LN193">193</td><td class="line">    <span class='keyword'>if</span> (o-&gt;encoding == <span class='macro'>OBJ_ENCODING_INT<span class='macro_popup'>1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="194"><td class="num" id="LN194">194</td><td class="line">        len = ll2string(llstr,<span class='keyword'>sizeof</span>(llstr),(<span class='keyword'>long</span>)o-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="195"><td class="num" id="LN195">195</td><td class="line">        p = llstr;</td></tr>
<tr class="codeline" data-linenumber="196"><td class="num" id="LN196">196</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="197"><td class="num" id="LN197">197</td><td class="line">        len = sdslen(o-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="198"><td class="num" id="LN198">198</td><td class="line">        p = o-&gt;ptr;</td></tr>
<tr class="codeline" data-linenumber="199"><td class="num" id="LN199">199</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="200"><td class="num" id="LN200">200</td><td class="line">    feedReplicationBacklog(p,len);</td></tr>
<tr class="codeline" data-linenumber="201"><td class="num" id="LN201">201</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="202"><td class="num" id="LN202">202</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="203"><td class="num" id="LN203">203</td><td class="line"><span class='comment'>/* Propagate write commands to slaves, and populate the replication backlog</span></td></tr>
<tr class="codeline" data-linenumber="204"><td class="num" id="LN204">204</td><td class="line"> <span class='comment'>* as well. This function is used if the instance is a master: we use</span></td></tr>
<tr class="codeline" data-linenumber="205"><td class="num" id="LN205">205</td><td class="line"> <span class='comment'>* the commands received by our clients in order to create the replication</span></td></tr>
<tr class="codeline" data-linenumber="206"><td class="num" id="LN206">206</td><td class="line"> <span class='comment'>* stream. Instead if the instance is a slave and has sub-slaves attached,</span></td></tr>
<tr class="codeline" data-linenumber="207"><td class="num" id="LN207">207</td><td class="line"> <span class='comment'>* we use replicationFeedSlavesFromMasterStream() */</span></td></tr>
<tr class="codeline" data-linenumber="208"><td class="num" id="LN208">208</td><td class="line"><span class='keyword'>void</span> replicationFeedSlaves(list *slaves, <span class='keyword'>int</span> dictid, robj **argv, <span class='keyword'>int</span> argc) {</td></tr>
<tr class="codeline" data-linenumber="209"><td class="num" id="LN209">209</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="210"><td class="num" id="LN210">210</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="211"><td class="num" id="LN211">211</td><td class="line">    <span class='keyword'>int</span> j, len;</td></tr>
<tr class="codeline" data-linenumber="212"><td class="num" id="LN212">212</td><td class="line">    <span class='keyword'>char</span> llstr[<span class='macro'>LONG_STR_SIZE<span class='macro_popup'>21</span></span>];</td></tr>
<tr class="codeline" data-linenumber="213"><td class="num" id="LN213">213</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="214"><td class="num" id="LN214">214</td><td class="line">    <span class='comment'>/* If the instance is not a top level master, return ASAP: we'll just proxy</span></td></tr>
<tr class="codeline" data-linenumber="215"><td class="num" id="LN215">215</td><td class="line">     <span class='comment'>* the stream of data we receive from our master instead, in order to</span></td></tr>
<tr class="codeline" data-linenumber="216"><td class="num" id="LN216">216</td><td class="line">     <span class='comment'>* propagate *identical* replication stream. In this way this slave can</span></td></tr>
<tr class="codeline" data-linenumber="217"><td class="num" id="LN217">217</td><td class="line">     <span class='comment'>* advertise the same replication ID as the master (since it shares the</span></td></tr>
<tr class="codeline" data-linenumber="218"><td class="num" id="LN218">218</td><td class="line">     <span class='comment'>* master replication history and has the same backlog and offsets). */</span></td></tr>
<tr class="codeline" data-linenumber="219"><td class="num" id="LN219">219</td><td class="line">    <span class='keyword'>if</span> (server.masterhost != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="220"><td class="num" id="LN220">220</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="221"><td class="num" id="LN221">221</td><td class="line">    <span class='comment'>/* If there aren't slaves, and there is no backlog buffer to populate,</span></td></tr>
<tr class="codeline" data-linenumber="222"><td class="num" id="LN222">222</td><td class="line">     <span class='comment'>* we can return ASAP. */</span></td></tr>
<tr class="codeline" data-linenumber="223"><td class="num" id="LN223">223</td><td class="line">    <span class='keyword'>if</span> (server.repl_backlog == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> &amp;&amp; <span class='macro'>listLength(slaves)<span class='macro_popup'>((slaves)-&gt;len)</span></span> == 0) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="224"><td class="num" id="LN224">224</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="225"><td class="num" id="LN225">225</td><td class="line">    <span class='comment'>/* We can't have slaves attached and no backlog. */</span></td></tr>
<tr class="codeline" data-linenumber="226"><td class="num" id="LN226">226</td><td class="line">    <span class='macro'>serverAssert(!(listLength(slaves) != 0 &amp;&amp; server.repl_backlog == NULL))<span class='macro_popup'>((!(((slaves)-&gt;len) != 0 &amp;&amp; server.repl_backlog ==<br> ((void*)0)))?(void)0 : (_serverAssert("!(listLength(slaves) != 0 &amp;&amp; server.repl_backlog == NULL)"<br>,"replication.c",226),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="227"><td class="num" id="LN227">227</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="228"><td class="num" id="LN228">228</td><td class="line">    <span class='comment'>/* Send SELECT command to every slave if needed. */</span></td></tr>
<tr class="codeline" data-linenumber="229"><td class="num" id="LN229">229</td><td class="line">    <span class='keyword'>if</span> (server.slaveseldb != dictid) {</td></tr>
<tr class="codeline" data-linenumber="230"><td class="num" id="LN230">230</td><td class="line">        robj *selectcmd;</td></tr>
<tr class="codeline" data-linenumber="231"><td class="num" id="LN231">231</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="232"><td class="num" id="LN232">232</td><td class="line">        <span class='comment'>/* For a few DBs we have pre-computed SELECT command. */</span></td></tr>
<tr class="codeline" data-linenumber="233"><td class="num" id="LN233">233</td><td class="line">        <span class='keyword'>if</span> (dictid &gt;= 0 &amp;&amp; dictid &lt; <span class='macro'>PROTO_SHARED_SELECT_CMDS<span class='macro_popup'>10</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="234"><td class="num" id="LN234">234</td><td class="line">            selectcmd = shared.select[dictid];</td></tr>
<tr class="codeline" data-linenumber="235"><td class="num" id="LN235">235</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="236"><td class="num" id="LN236">236</td><td class="line">            <span class='keyword'>int</span> dictid_len;</td></tr>
<tr class="codeline" data-linenumber="237"><td class="num" id="LN237">237</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="238"><td class="num" id="LN238">238</td><td class="line">            dictid_len = ll2string(llstr,<span class='keyword'>sizeof</span>(llstr),dictid);</td></tr>
<tr class="codeline" data-linenumber="239"><td class="num" id="LN239">239</td><td class="line">            selectcmd = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="240"><td class="num" id="LN240">240</td><td class="line">                sdscatprintf(sdsempty(),</td></tr>
<tr class="codeline" data-linenumber="241"><td class="num" id="LN241">241</td><td class="line">                <span class='string_literal'>"*2\r\n$6\r\nSELECT\r\n$%d\r\n%s\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="242"><td class="num" id="LN242">242</td><td class="line">                dictid_len, llstr));</td></tr>
<tr class="codeline" data-linenumber="243"><td class="num" id="LN243">243</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="244"><td class="num" id="LN244">244</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="245"><td class="num" id="LN245">245</td><td class="line">        <span class='comment'>/* Add the SELECT command into the backlog. */</span></td></tr>
<tr class="codeline" data-linenumber="246"><td class="num" id="LN246">246</td><td class="line">        <span class='keyword'>if</span> (server.repl_backlog) feedReplicationBacklogWithObject(selectcmd);</td></tr>
<tr class="codeline" data-linenumber="247"><td class="num" id="LN247">247</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="248"><td class="num" id="LN248">248</td><td class="line">        <span class='comment'>/* Send it to slaves. */</span></td></tr>
<tr class="codeline" data-linenumber="249"><td class="num" id="LN249">249</td><td class="line">        listRewind(slaves,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="250"><td class="num" id="LN250">250</td><td class="line">        <span class='keyword'>while</span>((ln = listNext(&amp;li))) {</td></tr>
<tr class="codeline" data-linenumber="251"><td class="num" id="LN251">251</td><td class="line">            client *slave = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="252"><td class="num" id="LN252">252</td><td class="line">            <span class='keyword'>if</span> (slave-&gt;replstate == <span class='macro'>SLAVE_STATE_WAIT_BGSAVE_START<span class='macro_popup'>6</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="253"><td class="num" id="LN253">253</td><td class="line">            addReply(slave,selectcmd);</td></tr>
<tr class="codeline" data-linenumber="254"><td class="num" id="LN254">254</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="255"><td class="num" id="LN255">255</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="256"><td class="num" id="LN256">256</td><td class="line">        <span class='keyword'>if</span> (dictid &lt; 0 || dictid &gt;= <span class='macro'>PROTO_SHARED_SELECT_CMDS<span class='macro_popup'>10</span></span>)</td></tr>
<tr class="codeline" data-linenumber="257"><td class="num" id="LN257">257</td><td class="line">            decrRefCount(selectcmd);</td></tr>
<tr class="codeline" data-linenumber="258"><td class="num" id="LN258">258</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="259"><td class="num" id="LN259">259</td><td class="line">    server.slaveseldb = dictid;</td></tr>
<tr class="codeline" data-linenumber="260"><td class="num" id="LN260">260</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="261"><td class="num" id="LN261">261</td><td class="line">    <span class='comment'>/* Write the command to the replication backlog if any. */</span></td></tr>
<tr class="codeline" data-linenumber="262"><td class="num" id="LN262">262</td><td class="line">    <span class='keyword'>if</span> (server.repl_backlog) {</td></tr>
<tr class="codeline" data-linenumber="263"><td class="num" id="LN263">263</td><td class="line">        <span class='keyword'>char</span> aux[<span class='macro'>LONG_STR_SIZE<span class='macro_popup'>21</span></span>+3];</td></tr>
<tr class="codeline" data-linenumber="264"><td class="num" id="LN264">264</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="265"><td class="num" id="LN265">265</td><td class="line">        <span class='comment'>/* Add the multi bulk reply length. */</span></td></tr>
<tr class="codeline" data-linenumber="266"><td class="num" id="LN266">266</td><td class="line">        aux[0] = '*';</td></tr>
<tr class="codeline" data-linenumber="267"><td class="num" id="LN267">267</td><td class="line">        len = ll2string(aux+1,<span class='keyword'>sizeof</span>(aux)-1,argc);</td></tr>
<tr class="codeline" data-linenumber="268"><td class="num" id="LN268">268</td><td class="line">        aux[len+1] = '\r';</td></tr>
<tr class="codeline" data-linenumber="269"><td class="num" id="LN269">269</td><td class="line">        aux[len+2] = '\n';</td></tr>
<tr class="codeline" data-linenumber="270"><td class="num" id="LN270">270</td><td class="line">        feedReplicationBacklog(aux,len+3);</td></tr>
<tr class="codeline" data-linenumber="271"><td class="num" id="LN271">271</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="272"><td class="num" id="LN272">272</td><td class="line">        <span class='keyword'>for</span> (j = 0; j &lt; argc; j++) {</td></tr>
<tr class="codeline" data-linenumber="273"><td class="num" id="LN273">273</td><td class="line">            <span class='keyword'>long</span> objlen = stringObjectLen(argv[j]);</td></tr>
<tr class="codeline" data-linenumber="274"><td class="num" id="LN274">274</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="275"><td class="num" id="LN275">275</td><td class="line">            <span class='comment'>/* We need to feed the buffer with the object as a bulk reply</span></td></tr>
<tr class="codeline" data-linenumber="276"><td class="num" id="LN276">276</td><td class="line">             <span class='comment'>* not just as a plain string, so create the $..CRLF payload len</span></td></tr>
<tr class="codeline" data-linenumber="277"><td class="num" id="LN277">277</td><td class="line">             <span class='comment'>* and add the final CRLF */</span></td></tr>
<tr class="codeline" data-linenumber="278"><td class="num" id="LN278">278</td><td class="line">            aux[0] = '$';</td></tr>
<tr class="codeline" data-linenumber="279"><td class="num" id="LN279">279</td><td class="line">            len = ll2string(aux+1,<span class='keyword'>sizeof</span>(aux)-1,objlen);</td></tr>
<tr class="codeline" data-linenumber="280"><td class="num" id="LN280">280</td><td class="line">            aux[len+1] = '\r';</td></tr>
<tr class="codeline" data-linenumber="281"><td class="num" id="LN281">281</td><td class="line">            aux[len+2] = '\n';</td></tr>
<tr class="codeline" data-linenumber="282"><td class="num" id="LN282">282</td><td class="line">            feedReplicationBacklog(aux,len+3);</td></tr>
<tr class="codeline" data-linenumber="283"><td class="num" id="LN283">283</td><td class="line">            feedReplicationBacklogWithObject(argv[j]);</td></tr>
<tr class="codeline" data-linenumber="284"><td class="num" id="LN284">284</td><td class="line">            feedReplicationBacklog(aux+len+1,2);</td></tr>
<tr class="codeline" data-linenumber="285"><td class="num" id="LN285">285</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="286"><td class="num" id="LN286">286</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="287"><td class="num" id="LN287">287</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="288"><td class="num" id="LN288">288</td><td class="line">    <span class='comment'>/* Write the command to every slave. */</span></td></tr>
<tr class="codeline" data-linenumber="289"><td class="num" id="LN289">289</td><td class="line">    listRewind(slaves,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="290"><td class="num" id="LN290">290</td><td class="line">    <span class='keyword'>while</span>((ln = listNext(&amp;li))) {</td></tr>
<tr class="codeline" data-linenumber="291"><td class="num" id="LN291">291</td><td class="line">        client *slave = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="292"><td class="num" id="LN292">292</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="293"><td class="num" id="LN293">293</td><td class="line">        <span class='comment'>/* Don't feed slaves that are still waiting for BGSAVE to start. */</span></td></tr>
<tr class="codeline" data-linenumber="294"><td class="num" id="LN294">294</td><td class="line">        <span class='keyword'>if</span> (slave-&gt;replstate == <span class='macro'>SLAVE_STATE_WAIT_BGSAVE_START<span class='macro_popup'>6</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="295"><td class="num" id="LN295">295</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="296"><td class="num" id="LN296">296</td><td class="line">        <span class='comment'>/* Feed slaves that are waiting for the initial SYNC (so these commands</span></td></tr>
<tr class="codeline" data-linenumber="297"><td class="num" id="LN297">297</td><td class="line">         <span class='comment'>* are queued in the output buffer until the initial SYNC completes),</span></td></tr>
<tr class="codeline" data-linenumber="298"><td class="num" id="LN298">298</td><td class="line">         <span class='comment'>* or are already in sync with the master. */</span></td></tr>
<tr class="codeline" data-linenumber="299"><td class="num" id="LN299">299</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="300"><td class="num" id="LN300">300</td><td class="line">        <span class='comment'>/* Add the multi bulk length. */</span></td></tr>
<tr class="codeline" data-linenumber="301"><td class="num" id="LN301">301</td><td class="line">        addReplyArrayLen(slave,argc);</td></tr>
<tr class="codeline" data-linenumber="302"><td class="num" id="LN302">302</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="303"><td class="num" id="LN303">303</td><td class="line">        <span class='comment'>/* Finally any additional argument that was not stored inside the</span></td></tr>
<tr class="codeline" data-linenumber="304"><td class="num" id="LN304">304</td><td class="line">         <span class='comment'>* static buffer if any (from j to argc). */</span></td></tr>
<tr class="codeline" data-linenumber="305"><td class="num" id="LN305">305</td><td class="line">        <span class='keyword'>for</span> (j = 0; j &lt; argc; j++)</td></tr>
<tr class="codeline" data-linenumber="306"><td class="num" id="LN306">306</td><td class="line">            addReplyBulk(slave,argv[j]);</td></tr>
<tr class="codeline" data-linenumber="307"><td class="num" id="LN307">307</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="308"><td class="num" id="LN308">308</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="309"><td class="num" id="LN309">309</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="310"><td class="num" id="LN310">310</td><td class="line"><span class='comment'>/* This is a debugging function that gets called when we detect something</span></td></tr>
<tr class="codeline" data-linenumber="311"><td class="num" id="LN311">311</td><td class="line"> <span class='comment'>* wrong with the replication protocol: the goal is to peek into the</span></td></tr>
<tr class="codeline" data-linenumber="312"><td class="num" id="LN312">312</td><td class="line"> <span class='comment'>* replication backlog and show a few final bytes to make simpler to</span></td></tr>
<tr class="codeline" data-linenumber="313"><td class="num" id="LN313">313</td><td class="line"> <span class='comment'>* guess what kind of bug it could be. */</span></td></tr>
<tr class="codeline" data-linenumber="314"><td class="num" id="LN314">314</td><td class="line"><span class='keyword'>void</span> showLatestBacklog(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="315"><td class="num" id="LN315">315</td><td class="line">    <span class='keyword'>if</span> (server.repl_backlog == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="316"><td class="num" id="LN316">316</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="317"><td class="num" id="LN317">317</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> dumplen = 256;</td></tr>
<tr class="codeline" data-linenumber="318"><td class="num" id="LN318">318</td><td class="line">    <span class='keyword'>if</span> (server.repl_backlog_histlen &lt; dumplen)</td></tr>
<tr class="codeline" data-linenumber="319"><td class="num" id="LN319">319</td><td class="line">        dumplen = server.repl_backlog_histlen;</td></tr>
<tr class="codeline" data-linenumber="320"><td class="num" id="LN320">320</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="321"><td class="num" id="LN321">321</td><td class="line">    <span class='comment'>/* Identify the first byte to dump. */</span></td></tr>
<tr class="codeline" data-linenumber="322"><td class="num" id="LN322">322</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> idx =</td></tr>
<tr class="codeline" data-linenumber="323"><td class="num" id="LN323">323</td><td class="line">      (server.repl_backlog_idx + (server.repl_backlog_size - dumplen)) %</td></tr>
<tr class="codeline" data-linenumber="324"><td class="num" id="LN324">324</td><td class="line">       server.repl_backlog_size;</td></tr>
<tr class="codeline" data-linenumber="325"><td class="num" id="LN325">325</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="326"><td class="num" id="LN326">326</td><td class="line">    <span class='comment'>/* Scan the circular buffer to collect 'dumplen' bytes. */</span></td></tr>
<tr class="codeline" data-linenumber="327"><td class="num" id="LN327">327</td><td class="line">    sds dump = sdsempty();</td></tr>
<tr class="codeline" data-linenumber="328"><td class="num" id="LN328">328</td><td class="line">    <span class='keyword'>while</span>(dumplen) {</td></tr>
<tr class="codeline" data-linenumber="329"><td class="num" id="LN329">329</td><td class="line">        <span class='keyword'>long</span> <span class='keyword'>long</span> thislen =</td></tr>
<tr class="codeline" data-linenumber="330"><td class="num" id="LN330">330</td><td class="line">            ((server.repl_backlog_size - idx) &lt; dumplen) ?</td></tr>
<tr class="codeline" data-linenumber="331"><td class="num" id="LN331">331</td><td class="line">            (server.repl_backlog_size - idx) : dumplen;</td></tr>
<tr class="codeline" data-linenumber="332"><td class="num" id="LN332">332</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="333"><td class="num" id="LN333">333</td><td class="line">        dump = sdscatrepr(dump,server.repl_backlog+idx,thislen);</td></tr>
<tr class="codeline" data-linenumber="334"><td class="num" id="LN334">334</td><td class="line">        dumplen -= thislen;</td></tr>
<tr class="codeline" data-linenumber="335"><td class="num" id="LN335">335</td><td class="line">        idx = 0;</td></tr>
<tr class="codeline" data-linenumber="336"><td class="num" id="LN336">336</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="337"><td class="num" id="LN337">337</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="338"><td class="num" id="LN338">338</td><td class="line">    <span class='comment'>/* Finally log such bytes: this is vital debugging info to</span></td></tr>
<tr class="codeline" data-linenumber="339"><td class="num" id="LN339">339</td><td class="line">     <span class='comment'>* understand what happened. */</span></td></tr>
<tr class="codeline" data-linenumber="340"><td class="num" id="LN340">340</td><td class="line">    serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Latest backlog is: '%s'"</span>, dump);</td></tr>
<tr class="codeline" data-linenumber="341"><td class="num" id="LN341">341</td><td class="line">    sdsfree(dump);</td></tr>
<tr class="codeline" data-linenumber="342"><td class="num" id="LN342">342</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="343"><td class="num" id="LN343">343</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="344"><td class="num" id="LN344">344</td><td class="line"><span class='comment'>/* This function is used in order to proxy what we receive from our master</span></td></tr>
<tr class="codeline" data-linenumber="345"><td class="num" id="LN345">345</td><td class="line"> <span class='comment'>* to our sub-slaves. */</span></td></tr>
<tr class="codeline" data-linenumber="346"><td class="num" id="LN346">346</td><td class="line"><span class='directive'>#include &lt;ctype.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="347"><td class="num" id="LN347">347</td><td class="line"><span class='keyword'>void</span> replicationFeedSlavesFromMasterStream(list *slaves, <span class='keyword'>char</span> *buf, size_t buflen) {</td></tr>
<tr class="codeline" data-linenumber="348"><td class="num" id="LN348">348</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="349"><td class="num" id="LN349">349</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="350"><td class="num" id="LN350">350</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="351"><td class="num" id="LN351">351</td><td class="line">    <span class='comment'>/* Debugging: this is handy to see the stream sent from master</span></td></tr>
<tr class="codeline" data-linenumber="352"><td class="num" id="LN352">352</td><td class="line">     <span class='comment'>* to slaves. Disabled with if(0). */</span></td></tr>
<tr class="codeline" data-linenumber="353"><td class="num" id="LN353">353</td><td class="line">    <span class='keyword'>if</span> (0) {</td></tr>
<tr class="codeline" data-linenumber="354"><td class="num" id="LN354">354</td><td class="line">        printf(<span class='string_literal'>"%zu:"</span>,buflen);</td></tr>
<tr class="codeline" data-linenumber="355"><td class="num" id="LN355">355</td><td class="line">        <span class='keyword'>for</span> (size_t j = 0; j &lt; buflen; j++) {</td></tr>
<tr class="codeline" data-linenumber="356"><td class="num" id="LN356">356</td><td class="line">            printf(<span class='string_literal'>"%c"</span>, <span class='macro'>isprint(buf[j])<span class='macro_popup'>((*__ctype_b_loc ())[(int) ((buf[j]))] &amp; (unsigned short int<br>) _ISprint)</span></span> ? buf[j] : '.');</td></tr>
<tr class="codeline" data-linenumber="357"><td class="num" id="LN357">357</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="358"><td class="num" id="LN358">358</td><td class="line">        printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="359"><td class="num" id="LN359">359</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="360"><td class="num" id="LN360">360</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="361"><td class="num" id="LN361">361</td><td class="line">    <span class='keyword'>if</span> (server.repl_backlog) feedReplicationBacklog(buf,buflen);</td></tr>
<tr class="codeline" data-linenumber="362"><td class="num" id="LN362">362</td><td class="line">    listRewind(slaves,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="363"><td class="num" id="LN363">363</td><td class="line">    <span class='keyword'>while</span>((ln = listNext(&amp;li))) {</td></tr>
<tr class="codeline" data-linenumber="364"><td class="num" id="LN364">364</td><td class="line">        client *slave = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="365"><td class="num" id="LN365">365</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="366"><td class="num" id="LN366">366</td><td class="line">        <span class='comment'>/* Don't feed slaves that are still waiting for BGSAVE to start. */</span></td></tr>
<tr class="codeline" data-linenumber="367"><td class="num" id="LN367">367</td><td class="line">        <span class='keyword'>if</span> (slave-&gt;replstate == <span class='macro'>SLAVE_STATE_WAIT_BGSAVE_START<span class='macro_popup'>6</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="368"><td class="num" id="LN368">368</td><td class="line">        addReplyProto(slave,buf,buflen);</td></tr>
<tr class="codeline" data-linenumber="369"><td class="num" id="LN369">369</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="370"><td class="num" id="LN370">370</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="371"><td class="num" id="LN371">371</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="372"><td class="num" id="LN372">372</td><td class="line"><span class='keyword'>void</span> replicationFeedMonitors(client *c, list *monitors, <span class='keyword'>int</span> dictid, robj **argv, <span class='keyword'>int</span> argc) {</td></tr>
<tr class="codeline" data-linenumber="373"><td class="num" id="LN373">373</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="374"><td class="num" id="LN374">374</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="375"><td class="num" id="LN375">375</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="376"><td class="num" id="LN376">376</td><td class="line">    sds cmdrepr = sdsnew(<span class='string_literal'>"+"</span>);</td></tr>
<tr class="codeline" data-linenumber="377"><td class="num" id="LN377">377</td><td class="line">    robj *cmdobj;</td></tr>
<tr class="codeline" data-linenumber="378"><td class="num" id="LN378">378</td><td class="line">    <span class='keyword'>struct</span> timeval tv;</td></tr>
<tr class="codeline" data-linenumber="379"><td class="num" id="LN379">379</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="380"><td class="num" id="LN380">380</td><td class="line">    gettimeofday(&amp;tv,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="381"><td class="num" id="LN381">381</td><td class="line">    cmdrepr = sdscatprintf(cmdrepr,<span class='string_literal'>"%ld.%06ld "</span>,(<span class='keyword'>long</span>)tv.tv_sec,(<span class='keyword'>long</span>)tv.tv_usec);</td></tr>
<tr class="codeline" data-linenumber="382"><td class="num" id="LN382">382</td><td class="line">    <span class='keyword'>if</span> (c-&gt;flags &amp; <span class='macro'>CLIENT_LUA<span class='macro_popup'>(1&lt;&lt;8)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="383"><td class="num" id="LN383">383</td><td class="line">        cmdrepr = sdscatprintf(cmdrepr,<span class='string_literal'>"[%d lua] "</span>,dictid);</td></tr>
<tr class="codeline" data-linenumber="384"><td class="num" id="LN384">384</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (c-&gt;flags &amp; <span class='macro'>CLIENT_UNIX_SOCKET<span class='macro_popup'>(1&lt;&lt;11)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="385"><td class="num" id="LN385">385</td><td class="line">        cmdrepr = sdscatprintf(cmdrepr,<span class='string_literal'>"[%d unix:%s] "</span>,dictid,server.unixsocket);</td></tr>
<tr class="codeline" data-linenumber="386"><td class="num" id="LN386">386</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="387"><td class="num" id="LN387">387</td><td class="line">        cmdrepr = sdscatprintf(cmdrepr,<span class='string_literal'>"[%d %s] "</span>,dictid,getClientPeerId(c));</td></tr>
<tr class="codeline" data-linenumber="388"><td class="num" id="LN388">388</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="389"><td class="num" id="LN389">389</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="390"><td class="num" id="LN390">390</td><td class="line">    <span class='keyword'>for</span> (j = 0; j &lt; argc; j++) {</td></tr>
<tr class="codeline" data-linenumber="391"><td class="num" id="LN391">391</td><td class="line">        <span class='keyword'>if</span> (argv[j]-&gt;encoding == <span class='macro'>OBJ_ENCODING_INT<span class='macro_popup'>1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="392"><td class="num" id="LN392">392</td><td class="line">            cmdrepr = sdscatprintf(cmdrepr, <span class='string_literal'>"\"%ld\""</span>, (<span class='keyword'>long</span>)argv[j]-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="393"><td class="num" id="LN393">393</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="394"><td class="num" id="LN394">394</td><td class="line">            cmdrepr = sdscatrepr(cmdrepr,(<span class='keyword'>char</span>*)argv[j]-&gt;ptr,</td></tr>
<tr class="codeline" data-linenumber="395"><td class="num" id="LN395">395</td><td class="line">                        sdslen(argv[j]-&gt;ptr));</td></tr>
<tr class="codeline" data-linenumber="396"><td class="num" id="LN396">396</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="397"><td class="num" id="LN397">397</td><td class="line">        <span class='keyword'>if</span> (j != argc-1)</td></tr>
<tr class="codeline" data-linenumber="398"><td class="num" id="LN398">398</td><td class="line">            cmdrepr = sdscatlen(cmdrepr,<span class='string_literal'>" "</span>,1);</td></tr>
<tr class="codeline" data-linenumber="399"><td class="num" id="LN399">399</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="400"><td class="num" id="LN400">400</td><td class="line">    cmdrepr = sdscatlen(cmdrepr,<span class='string_literal'>"\r\n"</span>,2);</td></tr>
<tr class="codeline" data-linenumber="401"><td class="num" id="LN401">401</td><td class="line">    cmdobj = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>,cmdrepr);</td></tr>
<tr class="codeline" data-linenumber="402"><td class="num" id="LN402">402</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="403"><td class="num" id="LN403">403</td><td class="line">    listRewind(monitors,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="404"><td class="num" id="LN404">404</td><td class="line">    <span class='keyword'>while</span>((ln = listNext(&amp;li))) {</td></tr>
<tr class="codeline" data-linenumber="405"><td class="num" id="LN405">405</td><td class="line">        client *monitor = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="406"><td class="num" id="LN406">406</td><td class="line">        addReply(monitor,cmdobj);</td></tr>
<tr class="codeline" data-linenumber="407"><td class="num" id="LN407">407</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="408"><td class="num" id="LN408">408</td><td class="line">    decrRefCount(cmdobj);</td></tr>
<tr class="codeline" data-linenumber="409"><td class="num" id="LN409">409</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="410"><td class="num" id="LN410">410</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="411"><td class="num" id="LN411">411</td><td class="line"><span class='comment'>/* Feed the slave 'c' with the replication backlog starting from the</span></td></tr>
<tr class="codeline" data-linenumber="412"><td class="num" id="LN412">412</td><td class="line"> <span class='comment'>* specified 'offset' up to the end of the backlog. */</span></td></tr>
<tr class="codeline" data-linenumber="413"><td class="num" id="LN413">413</td><td class="line"><span class='keyword'>long</span> <span class='keyword'>long</span> addReplyReplicationBacklog(client *c, <span class='keyword'>long</span> <span class='keyword'>long</span> offset) {</td></tr>
<tr class="codeline" data-linenumber="414"><td class="num" id="LN414">414</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> j, skip, len;</td></tr>
<tr class="codeline" data-linenumber="415"><td class="num" id="LN415">415</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="416"><td class="num" id="LN416">416</td><td class="line">    serverLog(<span class='macro'>LL_DEBUG<span class='macro_popup'>0</span></span>, <span class='string_literal'>"[PSYNC] Replica request offset: %lld"</span>, offset);</td></tr>
<tr class="codeline" data-linenumber="417"><td class="num" id="LN417">417</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="418"><td class="num" id="LN418">418</td><td class="line">    <span class='keyword'>if</span> (server.repl_backlog_histlen == 0) {</td></tr>
<tr class="codeline" data-linenumber="419"><td class="num" id="LN419">419</td><td class="line">        serverLog(<span class='macro'>LL_DEBUG<span class='macro_popup'>0</span></span>, <span class='string_literal'>"[PSYNC] Backlog history len is zero"</span>);</td></tr>
<tr class="codeline" data-linenumber="420"><td class="num" id="LN420">420</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="421"><td class="num" id="LN421">421</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="422"><td class="num" id="LN422">422</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="423"><td class="num" id="LN423">423</td><td class="line">    serverLog(<span class='macro'>LL_DEBUG<span class='macro_popup'>0</span></span>, <span class='string_literal'>"[PSYNC] Backlog size: %lld"</span>,</td></tr>
<tr class="codeline" data-linenumber="424"><td class="num" id="LN424">424</td><td class="line">             server.repl_backlog_size);</td></tr>
<tr class="codeline" data-linenumber="425"><td class="num" id="LN425">425</td><td class="line">    serverLog(<span class='macro'>LL_DEBUG<span class='macro_popup'>0</span></span>, <span class='string_literal'>"[PSYNC] First byte: %lld"</span>,</td></tr>
<tr class="codeline" data-linenumber="426"><td class="num" id="LN426">426</td><td class="line">             server.repl_backlog_off);</td></tr>
<tr class="codeline" data-linenumber="427"><td class="num" id="LN427">427</td><td class="line">    serverLog(<span class='macro'>LL_DEBUG<span class='macro_popup'>0</span></span>, <span class='string_literal'>"[PSYNC] History len: %lld"</span>,</td></tr>
<tr class="codeline" data-linenumber="428"><td class="num" id="LN428">428</td><td class="line">             server.repl_backlog_histlen);</td></tr>
<tr class="codeline" data-linenumber="429"><td class="num" id="LN429">429</td><td class="line">    serverLog(<span class='macro'>LL_DEBUG<span class='macro_popup'>0</span></span>, <span class='string_literal'>"[PSYNC] Current index: %lld"</span>,</td></tr>
<tr class="codeline" data-linenumber="430"><td class="num" id="LN430">430</td><td class="line">             server.repl_backlog_idx);</td></tr>
<tr class="codeline" data-linenumber="431"><td class="num" id="LN431">431</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="432"><td class="num" id="LN432">432</td><td class="line">    <span class='comment'>/* Compute the amount of bytes we need to discard. */</span></td></tr>
<tr class="codeline" data-linenumber="433"><td class="num" id="LN433">433</td><td class="line">    skip = offset - server.repl_backlog_off;</td></tr>
<tr class="codeline" data-linenumber="434"><td class="num" id="LN434">434</td><td class="line">    serverLog(<span class='macro'>LL_DEBUG<span class='macro_popup'>0</span></span>, <span class='string_literal'>"[PSYNC] Skipping: %lld"</span>, skip);</td></tr>
<tr class="codeline" data-linenumber="435"><td class="num" id="LN435">435</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="436"><td class="num" id="LN436">436</td><td class="line">    <span class='comment'>/* Point j to the oldest byte, that is actually our</span></td></tr>
<tr class="codeline" data-linenumber="437"><td class="num" id="LN437">437</td><td class="line">     <span class='comment'>* server.repl_backlog_off byte. */</span></td></tr>
<tr class="codeline" data-linenumber="438"><td class="num" id="LN438">438</td><td class="line">    j = (server.repl_backlog_idx +</td></tr>
<tr class="codeline" data-linenumber="439"><td class="num" id="LN439">439</td><td class="line">        (server.repl_backlog_size-server.repl_backlog_histlen)) %</td></tr>
<tr class="codeline" data-linenumber="440"><td class="num" id="LN440">440</td><td class="line">        server.repl_backlog_size;</td></tr>
<tr class="codeline" data-linenumber="441"><td class="num" id="LN441">441</td><td class="line">    serverLog(<span class='macro'>LL_DEBUG<span class='macro_popup'>0</span></span>, <span class='string_literal'>"[PSYNC] Index of first byte: %lld"</span>, j);</td></tr>
<tr class="codeline" data-linenumber="442"><td class="num" id="LN442">442</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="443"><td class="num" id="LN443">443</td><td class="line">    <span class='comment'>/* Discard the amount of data to seek to the specified 'offset'. */</span></td></tr>
<tr class="codeline" data-linenumber="444"><td class="num" id="LN444">444</td><td class="line">    j = (j + skip) % server.repl_backlog_size;</td></tr>
<tr class="codeline" data-linenumber="445"><td class="num" id="LN445">445</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="446"><td class="num" id="LN446">446</td><td class="line">    <span class='comment'>/* Feed slave with data. Since it is a circular buffer we have to</span></td></tr>
<tr class="codeline" data-linenumber="447"><td class="num" id="LN447">447</td><td class="line">     <span class='comment'>* split the reply in two parts if we are cross-boundary. */</span></td></tr>
<tr class="codeline" data-linenumber="448"><td class="num" id="LN448">448</td><td class="line">    len = server.repl_backlog_histlen - skip;</td></tr>
<tr class="codeline" data-linenumber="449"><td class="num" id="LN449">449</td><td class="line">    serverLog(<span class='macro'>LL_DEBUG<span class='macro_popup'>0</span></span>, <span class='string_literal'>"[PSYNC] Reply total length: %lld"</span>, len);</td></tr>
<tr class="codeline" data-linenumber="450"><td class="num" id="LN450">450</td><td class="line">    <span class='keyword'>while</span>(len) {</td></tr>
<tr class="codeline" data-linenumber="451"><td class="num" id="LN451">451</td><td class="line">        <span class='keyword'>long</span> <span class='keyword'>long</span> thislen =</td></tr>
<tr class="codeline" data-linenumber="452"><td class="num" id="LN452">452</td><td class="line">            ((server.repl_backlog_size - j) &lt; len) ?</td></tr>
<tr class="codeline" data-linenumber="453"><td class="num" id="LN453">453</td><td class="line">            (server.repl_backlog_size - j) : len;</td></tr>
<tr class="codeline" data-linenumber="454"><td class="num" id="LN454">454</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="455"><td class="num" id="LN455">455</td><td class="line">        serverLog(<span class='macro'>LL_DEBUG<span class='macro_popup'>0</span></span>, <span class='string_literal'>"[PSYNC] addReply() length: %lld"</span>, thislen);</td></tr>
<tr class="codeline" data-linenumber="456"><td class="num" id="LN456">456</td><td class="line">        addReplySds(c,sdsnewlen(server.repl_backlog + j, thislen));</td></tr>
<tr class="codeline" data-linenumber="457"><td class="num" id="LN457">457</td><td class="line">        len -= thislen;</td></tr>
<tr class="codeline" data-linenumber="458"><td class="num" id="LN458">458</td><td class="line">        j = 0;</td></tr>
<tr class="codeline" data-linenumber="459"><td class="num" id="LN459">459</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="460"><td class="num" id="LN460">460</td><td class="line">    <span class='keyword'>return</span> server.repl_backlog_histlen - skip;</td></tr>
<tr class="codeline" data-linenumber="461"><td class="num" id="LN461">461</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="462"><td class="num" id="LN462">462</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="463"><td class="num" id="LN463">463</td><td class="line"><span class='comment'>/* Return the offset to provide as reply to the PSYNC command received</span></td></tr>
<tr class="codeline" data-linenumber="464"><td class="num" id="LN464">464</td><td class="line"> <span class='comment'>* from the slave. The returned value is only valid immediately after</span></td></tr>
<tr class="codeline" data-linenumber="465"><td class="num" id="LN465">465</td><td class="line"> <span class='comment'>* the BGSAVE process started and before executing any other command</span></td></tr>
<tr class="codeline" data-linenumber="466"><td class="num" id="LN466">466</td><td class="line"> <span class='comment'>* from clients. */</span></td></tr>
<tr class="codeline" data-linenumber="467"><td class="num" id="LN467">467</td><td class="line"><span class='keyword'>long</span> <span class='keyword'>long</span> getPsyncInitialOffset(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="468"><td class="num" id="LN468">468</td><td class="line">    <span class='keyword'>return</span> server.master_repl_offset;</td></tr>
<tr class="codeline" data-linenumber="469"><td class="num" id="LN469">469</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="470"><td class="num" id="LN470">470</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="471"><td class="num" id="LN471">471</td><td class="line"><span class='comment'>/* Send a FULLRESYNC reply in the specific case of a full resynchronization,</span></td></tr>
<tr class="codeline" data-linenumber="472"><td class="num" id="LN472">472</td><td class="line"> <span class='comment'>* as a side effect setup the slave for a full sync in different ways:</span></td></tr>
<tr class="codeline" data-linenumber="473"><td class="num" id="LN473">473</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="474"><td class="num" id="LN474">474</td><td class="line"> <span class='comment'>* 1) Remember, into the slave client structure, the replication offset</span></td></tr>
<tr class="codeline" data-linenumber="475"><td class="num" id="LN475">475</td><td class="line"> <span class='comment'>*    we sent here, so that if new slaves will later attach to the same</span></td></tr>
<tr class="codeline" data-linenumber="476"><td class="num" id="LN476">476</td><td class="line"> <span class='comment'>*    background RDB saving process (by duplicating this client output</span></td></tr>
<tr class="codeline" data-linenumber="477"><td class="num" id="LN477">477</td><td class="line"> <span class='comment'>*    buffer), we can get the right offset from this slave.</span></td></tr>
<tr class="codeline" data-linenumber="478"><td class="num" id="LN478">478</td><td class="line"> <span class='comment'>* 2) Set the replication state of the slave to WAIT_BGSAVE_END so that</span></td></tr>
<tr class="codeline" data-linenumber="479"><td class="num" id="LN479">479</td><td class="line"> <span class='comment'>*    we start accumulating differences from this point.</span></td></tr>
<tr class="codeline" data-linenumber="480"><td class="num" id="LN480">480</td><td class="line"> <span class='comment'>* 3) Force the replication stream to re-emit a SELECT statement so</span></td></tr>
<tr class="codeline" data-linenumber="481"><td class="num" id="LN481">481</td><td class="line"> <span class='comment'>*    the new slave incremental differences will start selecting the</span></td></tr>
<tr class="codeline" data-linenumber="482"><td class="num" id="LN482">482</td><td class="line"> <span class='comment'>*    right database number.</span></td></tr>
<tr class="codeline" data-linenumber="483"><td class="num" id="LN483">483</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="484"><td class="num" id="LN484">484</td><td class="line"> <span class='comment'>* Normally this function should be called immediately after a successful</span></td></tr>
<tr class="codeline" data-linenumber="485"><td class="num" id="LN485">485</td><td class="line"> <span class='comment'>* BGSAVE for replication was started, or when there is one already in</span></td></tr>
<tr class="codeline" data-linenumber="486"><td class="num" id="LN486">486</td><td class="line"> <span class='comment'>* progress that we attached our slave to. */</span></td></tr>
<tr class="codeline" data-linenumber="487"><td class="num" id="LN487">487</td><td class="line"><span class='keyword'>int</span> replicationSetupSlaveForFullResync(client *slave, <span class='keyword'>long</span> <span class='keyword'>long</span> offset) {</td></tr>
<tr class="codeline" data-linenumber="488"><td class="num" id="LN488">488</td><td class="line">    <span class='keyword'>char</span> buf[128];</td></tr>
<tr class="codeline" data-linenumber="489"><td class="num" id="LN489">489</td><td class="line">    <span class='keyword'>int</span> buflen;</td></tr>
<tr class="codeline" data-linenumber="490"><td class="num" id="LN490">490</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="491"><td class="num" id="LN491">491</td><td class="line">    slave-&gt;psync_initial_offset = offset;</td></tr>
<tr class="codeline" data-linenumber="492"><td class="num" id="LN492">492</td><td class="line">    slave-&gt;replstate = <span class='macro'>SLAVE_STATE_WAIT_BGSAVE_END<span class='macro_popup'>7</span></span>;</td></tr>
<tr class="codeline" data-linenumber="493"><td class="num" id="LN493">493</td><td class="line">    <span class='comment'>/* We are going to accumulate the incremental changes for this</span></td></tr>
<tr class="codeline" data-linenumber="494"><td class="num" id="LN494">494</td><td class="line">     <span class='comment'>* slave as well. Set slaveseldb to -1 in order to force to re-emit</span></td></tr>
<tr class="codeline" data-linenumber="495"><td class="num" id="LN495">495</td><td class="line">     <span class='comment'>* a SELECT statement in the replication stream. */</span></td></tr>
<tr class="codeline" data-linenumber="496"><td class="num" id="LN496">496</td><td class="line">    server.slaveseldb = -1;</td></tr>
<tr class="codeline" data-linenumber="497"><td class="num" id="LN497">497</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="498"><td class="num" id="LN498">498</td><td class="line">    <span class='comment'>/* Don't send this reply to slaves that approached us with</span></td></tr>
<tr class="codeline" data-linenumber="499"><td class="num" id="LN499">499</td><td class="line">     <span class='comment'>* the old SYNC command. */</span></td></tr>
<tr class="codeline" data-linenumber="500"><td class="num" id="LN500">500</td><td class="line">    <span class='keyword'>if</span> (!(slave-&gt;flags &amp; <span class='macro'>CLIENT_PRE_PSYNC<span class='macro_popup'>(1&lt;&lt;16)</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="501"><td class="num" id="LN501">501</td><td class="line">        buflen = snprintf(buf,<span class='keyword'>sizeof</span>(buf),<span class='string_literal'>"+FULLRESYNC %s %lld\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="502"><td class="num" id="LN502">502</td><td class="line">                          server.replid,offset);</td></tr>
<tr class="codeline" data-linenumber="503"><td class="num" id="LN503">503</td><td class="line">        <span class='keyword'>if</span> (connWrite(slave-&gt;conn,buf,buflen) != buflen) {</td></tr>
<tr class="codeline" data-linenumber="504"><td class="num" id="LN504">504</td><td class="line">            freeClientAsync(slave);</td></tr>
<tr class="codeline" data-linenumber="505"><td class="num" id="LN505">505</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="506"><td class="num" id="LN506">506</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="507"><td class="num" id="LN507">507</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="508"><td class="num" id="LN508">508</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="509"><td class="num" id="LN509">509</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="510"><td class="num" id="LN510">510</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="511"><td class="num" id="LN511">511</td><td class="line"><span class='comment'>/* This function handles the PSYNC command from the point of view of a</span></td></tr>
<tr class="codeline" data-linenumber="512"><td class="num" id="LN512">512</td><td class="line"> <span class='comment'>* master receiving a request for partial resynchronization.</span></td></tr>
<tr class="codeline" data-linenumber="513"><td class="num" id="LN513">513</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="514"><td class="num" id="LN514">514</td><td class="line"> <span class='comment'>* On success return C_OK, otherwise C_ERR is returned and we proceed</span></td></tr>
<tr class="codeline" data-linenumber="515"><td class="num" id="LN515">515</td><td class="line"> <span class='comment'>* with the usual full resync. */</span></td></tr>
<tr class="codeline" data-linenumber="516"><td class="num" id="LN516">516</td><td class="line"><span class='keyword'>int</span> masterTryPartialResynchronization(client *c) {</td></tr>
<tr class="codeline" data-linenumber="517"><td class="num" id="LN517">517</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> psync_offset, psync_len;</td></tr>
<tr class="codeline" data-linenumber="518"><td class="num" id="LN518">518</td><td class="line">    <span class='keyword'>char</span> *master_replid = c-&gt;argv[1]-&gt;ptr;</td></tr>
<tr class="codeline" data-linenumber="519"><td class="num" id="LN519">519</td><td class="line">    <span class='keyword'>char</span> buf[128];</td></tr>
<tr class="codeline" data-linenumber="520"><td class="num" id="LN520">520</td><td class="line">    <span class='keyword'>int</span> buflen;</td></tr>
<tr class="codeline" data-linenumber="521"><td class="num" id="LN521">521</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="522"><td class="num" id="LN522">522</td><td class="line">    <span class='comment'>/* Parse the replication offset asked by the slave. Go to full sync</span></td></tr>
<tr class="codeline" data-linenumber="523"><td class="num" id="LN523">523</td><td class="line">     <span class='comment'>* on parse error: this should never happen but we try to handle</span></td></tr>
<tr class="codeline" data-linenumber="524"><td class="num" id="LN524">524</td><td class="line">     <span class='comment'>* it in a robust way compared to aborting. */</span></td></tr>
<tr class="codeline" data-linenumber="525"><td class="num" id="LN525">525</td><td class="line">    <span class='keyword'>if</span> (getLongLongFromObjectOrReply(c,c-&gt;argv[2],&amp;psync_offset,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) !=</td></tr>
<tr class="codeline" data-linenumber="526"><td class="num" id="LN526">526</td><td class="line">       <span class='macro'>C_OK<span class='macro_popup'>0</span></span>) <span class='keyword'>goto</span> need_full_resync;</td></tr>
<tr class="codeline" data-linenumber="527"><td class="num" id="LN527">527</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="528"><td class="num" id="LN528">528</td><td class="line">    <span class='comment'>/* Is the replication ID of this master the same advertised by the wannabe</span></td></tr>
<tr class="codeline" data-linenumber="529"><td class="num" id="LN529">529</td><td class="line">     <span class='comment'>* slave via PSYNC? If the replication ID changed this master has a</span></td></tr>
<tr class="codeline" data-linenumber="530"><td class="num" id="LN530">530</td><td class="line">     <span class='comment'>* different replication history, and there is no way to continue.</span></td></tr>
<tr class="codeline" data-linenumber="531"><td class="num" id="LN531">531</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="532"><td class="num" id="LN532">532</td><td class="line">     <span class='comment'>* Note that there are two potentially valid replication IDs: the ID1</span></td></tr>
<tr class="codeline" data-linenumber="533"><td class="num" id="LN533">533</td><td class="line">     <span class='comment'>* and the ID2. The ID2 however is only valid up to a specific offset. */</span></td></tr>
<tr class="codeline" data-linenumber="534"><td class="num" id="LN534">534</td><td class="line">    <span class='keyword'>if</span> (strcasecmp(master_replid, server.replid) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="535"><td class="num" id="LN535">535</td><td class="line">        (strcasecmp(master_replid, server.replid2) ||</td></tr>
<tr class="codeline" data-linenumber="536"><td class="num" id="LN536">536</td><td class="line">         psync_offset &gt; server.second_replid_offset))</td></tr>
<tr class="codeline" data-linenumber="537"><td class="num" id="LN537">537</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="538"><td class="num" id="LN538">538</td><td class="line">        <span class='comment'>/* Replid "?" is used by slaves that want to force a full resync. */</span></td></tr>
<tr class="codeline" data-linenumber="539"><td class="num" id="LN539">539</td><td class="line">        <span class='keyword'>if</span> (master_replid[0] != '?') {</td></tr>
<tr class="codeline" data-linenumber="540"><td class="num" id="LN540">540</td><td class="line">            <span class='keyword'>if</span> (strcasecmp(master_replid, server.replid) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="541"><td class="num" id="LN541">541</td><td class="line">                strcasecmp(master_replid, server.replid2))</td></tr>
<tr class="codeline" data-linenumber="542"><td class="num" id="LN542">542</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="543"><td class="num" id="LN543">543</td><td class="line">                serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Partial resynchronization not accepted: "</span></td></tr>
<tr class="codeline" data-linenumber="544"><td class="num" id="LN544">544</td><td class="line">                    <span class='string_literal'>"Replication ID mismatch (Replica asked for '%s', my "</span></td></tr>
<tr class="codeline" data-linenumber="545"><td class="num" id="LN545">545</td><td class="line">                    <span class='string_literal'>"replication IDs are '%s' and '%s')"</span>,</td></tr>
<tr class="codeline" data-linenumber="546"><td class="num" id="LN546">546</td><td class="line">                    master_replid, server.replid, server.replid2);</td></tr>
<tr class="codeline" data-linenumber="547"><td class="num" id="LN547">547</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="548"><td class="num" id="LN548">548</td><td class="line">                serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Partial resynchronization not accepted: "</span></td></tr>
<tr class="codeline" data-linenumber="549"><td class="num" id="LN549">549</td><td class="line">                    <span class='string_literal'>"Requested offset for second ID was %lld, but I can reply "</span></td></tr>
<tr class="codeline" data-linenumber="550"><td class="num" id="LN550">550</td><td class="line">                    <span class='string_literal'>"up to %lld"</span>, psync_offset, server.second_replid_offset);</td></tr>
<tr class="codeline" data-linenumber="551"><td class="num" id="LN551">551</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="552"><td class="num" id="LN552">552</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="553"><td class="num" id="LN553">553</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Full resync requested by replica %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="554"><td class="num" id="LN554">554</td><td class="line">                replicationGetSlaveName(c));</td></tr>
<tr class="codeline" data-linenumber="555"><td class="num" id="LN555">555</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="556"><td class="num" id="LN556">556</td><td class="line">        <span class='keyword'>goto</span> need_full_resync;</td></tr>
<tr class="codeline" data-linenumber="557"><td class="num" id="LN557">557</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="558"><td class="num" id="LN558">558</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="559"><td class="num" id="LN559">559</td><td class="line">    <span class='comment'>/* We still have the data our slave is asking for? */</span></td></tr>
<tr class="codeline" data-linenumber="560"><td class="num" id="LN560">560</td><td class="line">    <span class='keyword'>if</span> (!server.repl_backlog ||</td></tr>
<tr class="codeline" data-linenumber="561"><td class="num" id="LN561">561</td><td class="line">        psync_offset &lt; server.repl_backlog_off ||</td></tr>
<tr class="codeline" data-linenumber="562"><td class="num" id="LN562">562</td><td class="line">        psync_offset &gt; (server.repl_backlog_off + server.repl_backlog_histlen))</td></tr>
<tr class="codeline" data-linenumber="563"><td class="num" id="LN563">563</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="564"><td class="num" id="LN564">564</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="565"><td class="num" id="LN565">565</td><td class="line">            <span class='string_literal'>"Unable to partial resync with replica %s for lack of backlog (Replica request was: %lld)."</span>, replicationGetSlaveName(c), psync_offset);</td></tr>
<tr class="codeline" data-linenumber="566"><td class="num" id="LN566">566</td><td class="line">        <span class='keyword'>if</span> (psync_offset &gt; server.master_repl_offset) {</td></tr>
<tr class="codeline" data-linenumber="567"><td class="num" id="LN567">567</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="568"><td class="num" id="LN568">568</td><td class="line">                <span class='string_literal'>"Warning: replica %s tried to PSYNC with an offset that is greater than the master replication offset."</span>, replicationGetSlaveName(c));</td></tr>
<tr class="codeline" data-linenumber="569"><td class="num" id="LN569">569</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="570"><td class="num" id="LN570">570</td><td class="line">        <span class='keyword'>goto</span> need_full_resync;</td></tr>
<tr class="codeline" data-linenumber="571"><td class="num" id="LN571">571</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="572"><td class="num" id="LN572">572</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="573"><td class="num" id="LN573">573</td><td class="line">    <span class='comment'>/* If we reached this point, we are able to perform a partial resync:</span></td></tr>
<tr class="codeline" data-linenumber="574"><td class="num" id="LN574">574</td><td class="line">     <span class='comment'>* 1) Set client state to make it a slave.</span></td></tr>
<tr class="codeline" data-linenumber="575"><td class="num" id="LN575">575</td><td class="line">     <span class='comment'>* 2) Inform the client we can continue with +CONTINUE</span></td></tr>
<tr class="codeline" data-linenumber="576"><td class="num" id="LN576">576</td><td class="line">     <span class='comment'>* 3) Send the backlog data (from the offset to the end) to the slave. */</span></td></tr>
<tr class="codeline" data-linenumber="577"><td class="num" id="LN577">577</td><td class="line">    c-&gt;flags |= <span class='macro'>CLIENT_SLAVE<span class='macro_popup'>(1&lt;&lt;0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="578"><td class="num" id="LN578">578</td><td class="line">    c-&gt;replstate = <span class='macro'>SLAVE_STATE_ONLINE<span class='macro_popup'>9</span></span>;</td></tr>
<tr class="codeline" data-linenumber="579"><td class="num" id="LN579">579</td><td class="line">    c-&gt;repl_ack_time = server.unixtime;</td></tr>
<tr class="codeline" data-linenumber="580"><td class="num" id="LN580">580</td><td class="line">    c-&gt;repl_put_online_on_ack = 0;</td></tr>
<tr class="codeline" data-linenumber="581"><td class="num" id="LN581">581</td><td class="line">    listAddNodeTail(server.slaves,c);</td></tr>
<tr class="codeline" data-linenumber="582"><td class="num" id="LN582">582</td><td class="line">    <span class='comment'>/* We can't use the connection buffers since they are used to accumulate</span></td></tr>
<tr class="codeline" data-linenumber="583"><td class="num" id="LN583">583</td><td class="line">     <span class='comment'>* new commands at this stage. But we are sure the socket send buffer is</span></td></tr>
<tr class="codeline" data-linenumber="584"><td class="num" id="LN584">584</td><td class="line">     <span class='comment'>* empty so this write will never fail actually. */</span></td></tr>
<tr class="codeline" data-linenumber="585"><td class="num" id="LN585">585</td><td class="line">    <span class='keyword'>if</span> (c-&gt;slave_capa &amp; <span class='macro'>SLAVE_CAPA_PSYNC2<span class='macro_popup'>(1&lt;&lt;1)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="586"><td class="num" id="LN586">586</td><td class="line">        buflen = snprintf(buf,<span class='keyword'>sizeof</span>(buf),<span class='string_literal'>"+CONTINUE %s\r\n"</span>, server.replid);</td></tr>
<tr class="codeline" data-linenumber="587"><td class="num" id="LN587">587</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="588"><td class="num" id="LN588">588</td><td class="line">        buflen = snprintf(buf,<span class='keyword'>sizeof</span>(buf),<span class='string_literal'>"+CONTINUE\r\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="589"><td class="num" id="LN589">589</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="590"><td class="num" id="LN590">590</td><td class="line">    <span class='keyword'>if</span> (connWrite(c-&gt;conn,buf,buflen) != buflen) {</td></tr>
<tr class="codeline" data-linenumber="591"><td class="num" id="LN591">591</td><td class="line">        freeClientAsync(c);</td></tr>
<tr class="codeline" data-linenumber="592"><td class="num" id="LN592">592</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="593"><td class="num" id="LN593">593</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="594"><td class="num" id="LN594">594</td><td class="line">    psync_len = addReplyReplicationBacklog(c,psync_offset);</td></tr>
<tr class="codeline" data-linenumber="595"><td class="num" id="LN595">595</td><td class="line">    serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="596"><td class="num" id="LN596">596</td><td class="line">        <span class='string_literal'>"Partial resynchronization request from %s accepted. Sending %lld bytes of backlog starting from offset %lld."</span>,</td></tr>
<tr class="codeline" data-linenumber="597"><td class="num" id="LN597">597</td><td class="line">            replicationGetSlaveName(c),</td></tr>
<tr class="codeline" data-linenumber="598"><td class="num" id="LN598">598</td><td class="line">            psync_len, psync_offset);</td></tr>
<tr class="codeline" data-linenumber="599"><td class="num" id="LN599">599</td><td class="line">    <span class='comment'>/* Note that we don't need to set the selected DB at server.slaveseldb</span></td></tr>
<tr class="codeline" data-linenumber="600"><td class="num" id="LN600">600</td><td class="line">     <span class='comment'>* to -1 to force the master to emit SELECT, since the slave already</span></td></tr>
<tr class="codeline" data-linenumber="601"><td class="num" id="LN601">601</td><td class="line">     <span class='comment'>* has this state from the previous connection with the master. */</span></td></tr>
<tr class="codeline" data-linenumber="602"><td class="num" id="LN602">602</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="603"><td class="num" id="LN603">603</td><td class="line">    refreshGoodSlavesCount();</td></tr>
<tr class="codeline" data-linenumber="604"><td class="num" id="LN604">604</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="605"><td class="num" id="LN605">605</td><td class="line">    <span class='comment'>/* Fire the replica change modules event. */</span></td></tr>
<tr class="codeline" data-linenumber="606"><td class="num" id="LN606">606</td><td class="line">    moduleFireServerEvent(<span class='macro'>REDISMODULE_EVENT_REPLICA_CHANGE<span class='macro_popup'>6</span></span>,</td></tr>
<tr class="codeline" data-linenumber="607"><td class="num" id="LN607">607</td><td class="line">                          <span class='macro'>REDISMODULE_SUBEVENT_REPLICA_CHANGE_ONLINE<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="608"><td class="num" id="LN608">608</td><td class="line">                          <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="609"><td class="num" id="LN609">609</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="610"><td class="num" id="LN610">610</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>; <span class='comment'>/* The caller can return, no full resync needed. */</span></td></tr>
<tr class="codeline" data-linenumber="611"><td class="num" id="LN611">611</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="612"><td class="num" id="LN612">612</td><td class="line">need_full_resync:</td></tr>
<tr class="codeline" data-linenumber="613"><td class="num" id="LN613">613</td><td class="line">    <span class='comment'>/* We need a full resync for some reason... Note that we can't</span></td></tr>
<tr class="codeline" data-linenumber="614"><td class="num" id="LN614">614</td><td class="line">     <span class='comment'>* reply to PSYNC right now if a full SYNC is needed. The reply</span></td></tr>
<tr class="codeline" data-linenumber="615"><td class="num" id="LN615">615</td><td class="line">     <span class='comment'>* must include the master offset at the time the RDB file we transfer</span></td></tr>
<tr class="codeline" data-linenumber="616"><td class="num" id="LN616">616</td><td class="line">     <span class='comment'>* is generated, so we need to delay the reply to that moment. */</span></td></tr>
<tr class="codeline" data-linenumber="617"><td class="num" id="LN617">617</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="618"><td class="num" id="LN618">618</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="619"><td class="num" id="LN619">619</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="620"><td class="num" id="LN620">620</td><td class="line"><span class='comment'>/* Start a BGSAVE for replication goals, which is, selecting the disk or</span></td></tr>
<tr class="codeline" data-linenumber="621"><td class="num" id="LN621">621</td><td class="line"> <span class='comment'>* socket target depending on the configuration, and making sure that</span></td></tr>
<tr class="codeline" data-linenumber="622"><td class="num" id="LN622">622</td><td class="line"> <span class='comment'>* the script cache is flushed before to start.</span></td></tr>
<tr class="codeline" data-linenumber="623"><td class="num" id="LN623">623</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="624"><td class="num" id="LN624">624</td><td class="line"> <span class='comment'>* The mincapa argument is the bitwise AND among all the slaves capabilities</span></td></tr>
<tr class="codeline" data-linenumber="625"><td class="num" id="LN625">625</td><td class="line"> <span class='comment'>* of the slaves waiting for this BGSAVE, so represents the slave capabilities</span></td></tr>
<tr class="codeline" data-linenumber="626"><td class="num" id="LN626">626</td><td class="line"> <span class='comment'>* all the slaves support. Can be tested via SLAVE_CAPA_* macros.</span></td></tr>
<tr class="codeline" data-linenumber="627"><td class="num" id="LN627">627</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="628"><td class="num" id="LN628">628</td><td class="line"> <span class='comment'>* Side effects, other than starting a BGSAVE:</span></td></tr>
<tr class="codeline" data-linenumber="629"><td class="num" id="LN629">629</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="630"><td class="num" id="LN630">630</td><td class="line"> <span class='comment'>* 1) Handle the slaves in WAIT_START state, by preparing them for a full</span></td></tr>
<tr class="codeline" data-linenumber="631"><td class="num" id="LN631">631</td><td class="line"> <span class='comment'>*    sync if the BGSAVE was successfully started, or sending them an error</span></td></tr>
<tr class="codeline" data-linenumber="632"><td class="num" id="LN632">632</td><td class="line"> <span class='comment'>*    and dropping them from the list of slaves.</span></td></tr>
<tr class="codeline" data-linenumber="633"><td class="num" id="LN633">633</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="634"><td class="num" id="LN634">634</td><td class="line"> <span class='comment'>* 2) Flush the Lua scripting script cache if the BGSAVE was actually</span></td></tr>
<tr class="codeline" data-linenumber="635"><td class="num" id="LN635">635</td><td class="line"> <span class='comment'>*    started.</span></td></tr>
<tr class="codeline" data-linenumber="636"><td class="num" id="LN636">636</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="637"><td class="num" id="LN637">637</td><td class="line"> <span class='comment'>* Returns C_OK on success or C_ERR otherwise. */</span></td></tr>
<tr class="codeline" data-linenumber="638"><td class="num" id="LN638">638</td><td class="line"><span class='keyword'>int</span> startBgsaveForReplication(<span class='keyword'>int</span> mincapa) {</td></tr>
<tr class="codeline" data-linenumber="639"><td class="num" id="LN639">639</td><td class="line">    <span class='keyword'>int</span> retval;</td></tr>
<tr class="codeline" data-linenumber="640"><td class="num" id="LN640">640</td><td class="line">    <span class='keyword'>int</span> socket_target = server.repl_diskless_sync &amp;&amp; (mincapa &amp; <span class='macro'>SLAVE_CAPA_EOF<span class='macro_popup'>(1&lt;&lt;0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="641"><td class="num" id="LN641">641</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="642"><td class="num" id="LN642">642</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="643"><td class="num" id="LN643">643</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="644"><td class="num" id="LN644">644</td><td class="line">    serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Starting BGSAVE for SYNC with target: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="645"><td class="num" id="LN645">645</td><td class="line">        socket_target ? <span class='string_literal'>"replicas sockets"</span> : <span class='string_literal'>"disk"</span>);</td></tr>
<tr class="codeline" data-linenumber="646"><td class="num" id="LN646">646</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="647"><td class="num" id="LN647">647</td><td class="line">    rdbSaveInfo rsi, *rsiptr;</td></tr>
<tr class="codeline" data-linenumber="648"><td class="num" id="LN648">648</td><td class="line">    rsiptr = rdbPopulateSaveInfo(&amp;rsi);</td></tr>
<tr class="codeline" data-linenumber="649"><td class="num" id="LN649">649</td><td class="line">    <span class='comment'>/* Only do rdbSave* when rsiptr is not NULL,</span></td></tr>
<tr class="codeline" data-linenumber="650"><td class="num" id="LN650">650</td><td class="line">     <span class='comment'>* otherwise slave will miss repl-stream-db. */</span></td></tr>
<tr class="codeline" data-linenumber="651"><td class="num" id="LN651">651</td><td class="line">    <span class='keyword'>if</span> (rsiptr) {</td></tr>
<tr class="codeline" data-linenumber="652"><td class="num" id="LN652">652</td><td class="line">        <span class='keyword'>if</span> (socket_target)</td></tr>
<tr class="codeline" data-linenumber="653"><td class="num" id="LN653">653</td><td class="line">            retval = rdbSaveToSlavesSockets(rsiptr);</td></tr>
<tr class="codeline" data-linenumber="654"><td class="num" id="LN654">654</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="655"><td class="num" id="LN655">655</td><td class="line">            retval = rdbSaveBackground(server.rdb_filename,rsiptr);</td></tr>
<tr class="codeline" data-linenumber="656"><td class="num" id="LN656">656</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="657"><td class="num" id="LN657">657</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"BGSAVE for replication: replication information not available, can't generate the RDB file right now. Try later."</span>);</td></tr>
<tr class="codeline" data-linenumber="658"><td class="num" id="LN658">658</td><td class="line">        retval = <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="659"><td class="num" id="LN659">659</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="660"><td class="num" id="LN660">660</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="661"><td class="num" id="LN661">661</td><td class="line">    <span class='comment'>/* If we succeeded to start a BGSAVE with disk target, let's remember</span></td></tr>
<tr class="codeline" data-linenumber="662"><td class="num" id="LN662">662</td><td class="line">     <span class='comment'>* this fact, so that we can later delete the file if needed. Note</span></td></tr>
<tr class="codeline" data-linenumber="663"><td class="num" id="LN663">663</td><td class="line">     <span class='comment'>* that we don't set the flag to 1 if the feature is disabled, otherwise</span></td></tr>
<tr class="codeline" data-linenumber="664"><td class="num" id="LN664">664</td><td class="line">     <span class='comment'>* it would never be cleared: the file is not deleted. This way if</span></td></tr>
<tr class="codeline" data-linenumber="665"><td class="num" id="LN665">665</td><td class="line">     <span class='comment'>* the user enables it later with CONFIG SET, we are fine. */</span></td></tr>
<tr class="codeline" data-linenumber="666"><td class="num" id="LN666">666</td><td class="line">    <span class='keyword'>if</span> (retval == <span class='macro'>C_OK<span class='macro_popup'>0</span></span> &amp;&amp; !socket_target &amp;&amp; server.rdb_del_sync_files)</td></tr>
<tr class="codeline" data-linenumber="667"><td class="num" id="LN667">667</td><td class="line">        RDBGeneratedByReplication = 1;</td></tr>
<tr class="codeline" data-linenumber="668"><td class="num" id="LN668">668</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="669"><td class="num" id="LN669">669</td><td class="line">    <span class='comment'>/* If we failed to BGSAVE, remove the slaves waiting for a full</span></td></tr>
<tr class="codeline" data-linenumber="670"><td class="num" id="LN670">670</td><td class="line">     <span class='comment'>* resynchronization from the list of slaves, inform them with</span></td></tr>
<tr class="codeline" data-linenumber="671"><td class="num" id="LN671">671</td><td class="line">     <span class='comment'>* an error about what happened, close the connection ASAP. */</span></td></tr>
<tr class="codeline" data-linenumber="672"><td class="num" id="LN672">672</td><td class="line">    <span class='keyword'>if</span> (retval == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="673"><td class="num" id="LN673">673</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"BGSAVE for replication failed"</span>);</td></tr>
<tr class="codeline" data-linenumber="674"><td class="num" id="LN674">674</td><td class="line">        listRewind(server.slaves,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="675"><td class="num" id="LN675">675</td><td class="line">        <span class='keyword'>while</span>((ln = listNext(&amp;li))) {</td></tr>
<tr class="codeline" data-linenumber="676"><td class="num" id="LN676">676</td><td class="line">            client *slave = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="677"><td class="num" id="LN677">677</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="678"><td class="num" id="LN678">678</td><td class="line">            <span class='keyword'>if</span> (slave-&gt;replstate == <span class='macro'>SLAVE_STATE_WAIT_BGSAVE_START<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="679"><td class="num" id="LN679">679</td><td class="line">                slave-&gt;replstate = <span class='macro'>REPL_STATE_NONE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="680"><td class="num" id="LN680">680</td><td class="line">                slave-&gt;flags &amp;= ~<span class='macro'>CLIENT_SLAVE<span class='macro_popup'>(1&lt;&lt;0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="681"><td class="num" id="LN681">681</td><td class="line">                listDelNode(server.slaves,ln);</td></tr>
<tr class="codeline" data-linenumber="682"><td class="num" id="LN682">682</td><td class="line">                addReplyError(slave,</td></tr>
<tr class="codeline" data-linenumber="683"><td class="num" id="LN683">683</td><td class="line">                    <span class='string_literal'>"BGSAVE failed, replication can't continue"</span>);</td></tr>
<tr class="codeline" data-linenumber="684"><td class="num" id="LN684">684</td><td class="line">                slave-&gt;flags |= <span class='macro'>CLIENT_CLOSE_AFTER_REPLY<span class='macro_popup'>(1&lt;&lt;6)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="685"><td class="num" id="LN685">685</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="686"><td class="num" id="LN686">686</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="687"><td class="num" id="LN687">687</td><td class="line">        <span class='keyword'>return</span> retval;</td></tr>
<tr class="codeline" data-linenumber="688"><td class="num" id="LN688">688</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="689"><td class="num" id="LN689">689</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="690"><td class="num" id="LN690">690</td><td class="line">    <span class='comment'>/* If the target is socket, rdbSaveToSlavesSockets() already setup</span></td></tr>
<tr class="codeline" data-linenumber="691"><td class="num" id="LN691">691</td><td class="line">     <span class='comment'>* the slaves for a full resync. Otherwise for disk target do it now.*/</span></td></tr>
<tr class="codeline" data-linenumber="692"><td class="num" id="LN692">692</td><td class="line">    <span class='keyword'>if</span> (!socket_target) {</td></tr>
<tr class="codeline" data-linenumber="693"><td class="num" id="LN693">693</td><td class="line">        listRewind(server.slaves,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="694"><td class="num" id="LN694">694</td><td class="line">        <span class='keyword'>while</span>((ln = listNext(&amp;li))) {</td></tr>
<tr class="codeline" data-linenumber="695"><td class="num" id="LN695">695</td><td class="line">            client *slave = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="696"><td class="num" id="LN696">696</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="697"><td class="num" id="LN697">697</td><td class="line">            <span class='keyword'>if</span> (slave-&gt;replstate == <span class='macro'>SLAVE_STATE_WAIT_BGSAVE_START<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="698"><td class="num" id="LN698">698</td><td class="line">                    replicationSetupSlaveForFullResync(slave,</td></tr>
<tr class="codeline" data-linenumber="699"><td class="num" id="LN699">699</td><td class="line">                            getPsyncInitialOffset());</td></tr>
<tr class="codeline" data-linenumber="700"><td class="num" id="LN700">700</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="701"><td class="num" id="LN701">701</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="702"><td class="num" id="LN702">702</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="703"><td class="num" id="LN703">703</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="704"><td class="num" id="LN704">704</td><td class="line">    <span class='comment'>/* Flush the script cache, since we need that slave differences are</span></td></tr>
<tr class="codeline" data-linenumber="705"><td class="num" id="LN705">705</td><td class="line">     <span class='comment'>* accumulated without requiring slaves to match our cached scripts. */</span></td></tr>
<tr class="codeline" data-linenumber="706"><td class="num" id="LN706">706</td><td class="line">    <span class='keyword'>if</span> (retval == <span class='macro'>C_OK<span class='macro_popup'>0</span></span>) replicationScriptCacheFlush();</td></tr>
<tr class="codeline" data-linenumber="707"><td class="num" id="LN707">707</td><td class="line">    <span class='keyword'>return</span> retval;</td></tr>
<tr class="codeline" data-linenumber="708"><td class="num" id="LN708">708</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="709"><td class="num" id="LN709">709</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="710"><td class="num" id="LN710">710</td><td class="line"><span class='comment'>/* SYNC and PSYNC command implementation. */</span></td></tr>
<tr class="codeline" data-linenumber="711"><td class="num" id="LN711">711</td><td class="line"><span class='keyword'>void</span> syncCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="712"><td class="num" id="LN712">712</td><td class="line">    <span class='comment'>/* ignore SYNC if already slave or in monitor mode */</span></td></tr>
<tr class="codeline" data-linenumber="713"><td class="num" id="LN713">713</td><td class="line">    <span class='keyword'>if</span> (c-&gt;flags &amp; <span class='macro'>CLIENT_SLAVE<span class='macro_popup'>(1&lt;&lt;0)</span></span>) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="714"><td class="num" id="LN714">714</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="715"><td class="num" id="LN715">715</td><td class="line">    <span class='comment'>/* Refuse SYNC requests if we are a slave but the link with our master</span></td></tr>
<tr class="codeline" data-linenumber="716"><td class="num" id="LN716">716</td><td class="line">     <span class='comment'>* is not ok... */</span></td></tr>
<tr class="codeline" data-linenumber="717"><td class="num" id="LN717">717</td><td class="line">    <span class='keyword'>if</span> (server.masterhost &amp;&amp; server.repl_state != <span class='macro'>REPL_STATE_CONNECTED<span class='macro_popup'>15</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="718"><td class="num" id="LN718">718</td><td class="line">        addReplySds(c,sdsnew(<span class='string_literal'>"-NOMASTERLINK Can't SYNC while not connected with my master\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="719"><td class="num" id="LN719">719</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="720"><td class="num" id="LN720">720</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="721"><td class="num" id="LN721">721</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="722"><td class="num" id="LN722">722</td><td class="line">    <span class='comment'>/* SYNC can't be issued when the server has pending data to send to</span></td></tr>
<tr class="codeline" data-linenumber="723"><td class="num" id="LN723">723</td><td class="line">     <span class='comment'>* the client about already issued commands. We need a fresh reply</span></td></tr>
<tr class="codeline" data-linenumber="724"><td class="num" id="LN724">724</td><td class="line">     <span class='comment'>* buffer registering the differences between the BGSAVE and the current</span></td></tr>
<tr class="codeline" data-linenumber="725"><td class="num" id="LN725">725</td><td class="line">     <span class='comment'>* dataset, so that we can copy to other slaves if needed. */</span></td></tr>
<tr class="codeline" data-linenumber="726"><td class="num" id="LN726">726</td><td class="line">    <span class='keyword'>if</span> (clientHasPendingReplies(c)) {</td></tr>
<tr class="codeline" data-linenumber="727"><td class="num" id="LN727">727</td><td class="line">        addReplyError(c,<span class='string_literal'>"SYNC and PSYNC are invalid with pending output"</span>);</td></tr>
<tr class="codeline" data-linenumber="728"><td class="num" id="LN728">728</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="729"><td class="num" id="LN729">729</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="730"><td class="num" id="LN730">730</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="731"><td class="num" id="LN731">731</td><td class="line">    serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Replica %s asks for synchronization"</span>,</td></tr>
<tr class="codeline" data-linenumber="732"><td class="num" id="LN732">732</td><td class="line">        replicationGetSlaveName(c));</td></tr>
<tr class="codeline" data-linenumber="733"><td class="num" id="LN733">733</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="734"><td class="num" id="LN734">734</td><td class="line">    <span class='comment'>/* Try a partial resynchronization if this is a PSYNC command.</span></td></tr>
<tr class="codeline" data-linenumber="735"><td class="num" id="LN735">735</td><td class="line">     <span class='comment'>* If it fails, we continue with usual full resynchronization, however</span></td></tr>
<tr class="codeline" data-linenumber="736"><td class="num" id="LN736">736</td><td class="line">     <span class='comment'>* when this happens masterTryPartialResynchronization() already</span></td></tr>
<tr class="codeline" data-linenumber="737"><td class="num" id="LN737">737</td><td class="line">     <span class='comment'>* replied with:</span></td></tr>
<tr class="codeline" data-linenumber="738"><td class="num" id="LN738">738</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="739"><td class="num" id="LN739">739</td><td class="line">     <span class='comment'>* +FULLRESYNC &lt;replid&gt; &lt;offset&gt;</span></td></tr>
<tr class="codeline" data-linenumber="740"><td class="num" id="LN740">740</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="741"><td class="num" id="LN741">741</td><td class="line">     <span class='comment'>* So the slave knows the new replid and offset to try a PSYNC later</span></td></tr>
<tr class="codeline" data-linenumber="742"><td class="num" id="LN742">742</td><td class="line">     <span class='comment'>* if the connection with the master is lost. */</span></td></tr>
<tr class="codeline" data-linenumber="743"><td class="num" id="LN743">743</td><td class="line">    <span class='keyword'>if</span> (!strcasecmp(c-&gt;argv[0]-&gt;ptr,<span class='string_literal'>"psync"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="744"><td class="num" id="LN744">744</td><td class="line">        <span class='keyword'>if</span> (masterTryPartialResynchronization(c) == <span class='macro'>C_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="745"><td class="num" id="LN745">745</td><td class="line">            server.stat_sync_partial_ok++;</td></tr>
<tr class="codeline" data-linenumber="746"><td class="num" id="LN746">746</td><td class="line">            <span class='keyword'>return</span>; <span class='comment'>/* No full resync needed, return. */</span></td></tr>
<tr class="codeline" data-linenumber="747"><td class="num" id="LN747">747</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="748"><td class="num" id="LN748">748</td><td class="line">            <span class='keyword'>char</span> *master_replid = c-&gt;argv[1]-&gt;ptr;</td></tr>
<tr class="codeline" data-linenumber="749"><td class="num" id="LN749">749</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="750"><td class="num" id="LN750">750</td><td class="line">            <span class='comment'>/* Increment stats for failed PSYNCs, but only if the</span></td></tr>
<tr class="codeline" data-linenumber="751"><td class="num" id="LN751">751</td><td class="line">             <span class='comment'>* replid is not "?", as this is used by slaves to force a full</span></td></tr>
<tr class="codeline" data-linenumber="752"><td class="num" id="LN752">752</td><td class="line">             <span class='comment'>* resync on purpose when they are not albe to partially</span></td></tr>
<tr class="codeline" data-linenumber="753"><td class="num" id="LN753">753</td><td class="line">             <span class='comment'>* resync. */</span></td></tr>
<tr class="codeline" data-linenumber="754"><td class="num" id="LN754">754</td><td class="line">            <span class='keyword'>if</span> (master_replid[0] != '?') server.stat_sync_partial_err++;</td></tr>
<tr class="codeline" data-linenumber="755"><td class="num" id="LN755">755</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="756"><td class="num" id="LN756">756</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="757"><td class="num" id="LN757">757</td><td class="line">        <span class='comment'>/* If a slave uses SYNC, we are dealing with an old implementation</span></td></tr>
<tr class="codeline" data-linenumber="758"><td class="num" id="LN758">758</td><td class="line">         <span class='comment'>* of the replication protocol (like redis-cli --slave). Flag the client</span></td></tr>
<tr class="codeline" data-linenumber="759"><td class="num" id="LN759">759</td><td class="line">         <span class='comment'>* so that we don't expect to receive REPLCONF ACK feedbacks. */</span></td></tr>
<tr class="codeline" data-linenumber="760"><td class="num" id="LN760">760</td><td class="line">        c-&gt;flags |= <span class='macro'>CLIENT_PRE_PSYNC<span class='macro_popup'>(1&lt;&lt;16)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="761"><td class="num" id="LN761">761</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="762"><td class="num" id="LN762">762</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="763"><td class="num" id="LN763">763</td><td class="line">    <span class='comment'>/* Full resynchronization. */</span></td></tr>
<tr class="codeline" data-linenumber="764"><td class="num" id="LN764">764</td><td class="line">    server.stat_sync_full++;</td></tr>
<tr class="codeline" data-linenumber="765"><td class="num" id="LN765">765</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="766"><td class="num" id="LN766">766</td><td class="line">    <span class='comment'>/* Setup the slave as one waiting for BGSAVE to start. The following code</span></td></tr>
<tr class="codeline" data-linenumber="767"><td class="num" id="LN767">767</td><td class="line">     <span class='comment'>* paths will change the state if we handle the slave differently. */</span></td></tr>
<tr class="codeline" data-linenumber="768"><td class="num" id="LN768">768</td><td class="line">    c-&gt;replstate = <span class='macro'>SLAVE_STATE_WAIT_BGSAVE_START<span class='macro_popup'>6</span></span>;</td></tr>
<tr class="codeline" data-linenumber="769"><td class="num" id="LN769">769</td><td class="line">    <span class='keyword'>if</span> (server.repl_disable_tcp_nodelay)</td></tr>
<tr class="codeline" data-linenumber="770"><td class="num" id="LN770">770</td><td class="line">        connDisableTcpNoDelay(c-&gt;conn); <span class='comment'>/* Non critical if it fails. */</span></td></tr>
<tr class="codeline" data-linenumber="771"><td class="num" id="LN771">771</td><td class="line">    c-&gt;repldbfd = -1;</td></tr>
<tr class="codeline" data-linenumber="772"><td class="num" id="LN772">772</td><td class="line">    c-&gt;flags |= <span class='macro'>CLIENT_SLAVE<span class='macro_popup'>(1&lt;&lt;0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="773"><td class="num" id="LN773">773</td><td class="line">    listAddNodeTail(server.slaves,c);</td></tr>
<tr class="codeline" data-linenumber="774"><td class="num" id="LN774">774</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="775"><td class="num" id="LN775">775</td><td class="line">    <span class='comment'>/* Create the replication backlog if needed. */</span></td></tr>
<tr class="codeline" data-linenumber="776"><td class="num" id="LN776">776</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>listLength(server.slaves)<span class='macro_popup'>((server.slaves)-&gt;len)</span></span> == 1 &amp;&amp; server.repl_backlog == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="777"><td class="num" id="LN777">777</td><td class="line">        <span class='comment'>/* When we create the backlog from scratch, we always use a new</span></td></tr>
<tr class="codeline" data-linenumber="778"><td class="num" id="LN778">778</td><td class="line">         <span class='comment'>* replication ID and clear the ID2, since there is no valid</span></td></tr>
<tr class="codeline" data-linenumber="779"><td class="num" id="LN779">779</td><td class="line">         <span class='comment'>* past history. */</span></td></tr>
<tr class="codeline" data-linenumber="780"><td class="num" id="LN780">780</td><td class="line">        changeReplicationId();</td></tr>
<tr class="codeline" data-linenumber="781"><td class="num" id="LN781">781</td><td class="line">        clearReplicationId2();</td></tr>
<tr class="codeline" data-linenumber="782"><td class="num" id="LN782">782</td><td class="line">        createReplicationBacklog();</td></tr>
<tr class="codeline" data-linenumber="783"><td class="num" id="LN783">783</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Replication backlog created, my new "</span></td></tr>
<tr class="codeline" data-linenumber="784"><td class="num" id="LN784">784</td><td class="line">                            <span class='string_literal'>"replication IDs are '%s' and '%s'"</span>,</td></tr>
<tr class="codeline" data-linenumber="785"><td class="num" id="LN785">785</td><td class="line">                            server.replid, server.replid2);</td></tr>
<tr class="codeline" data-linenumber="786"><td class="num" id="LN786">786</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="787"><td class="num" id="LN787">787</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="788"><td class="num" id="LN788">788</td><td class="line">    <span class='comment'>/* CASE 1: BGSAVE is in progress, with disk target. */</span></td></tr>
<tr class="codeline" data-linenumber="789"><td class="num" id="LN789">789</td><td class="line">    <span class='keyword'>if</span> (server.rdb_child_pid != -1 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="790"><td class="num" id="LN790">790</td><td class="line">        server.rdb_child_type == <span class='macro'>RDB_CHILD_TYPE_DISK<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="791"><td class="num" id="LN791">791</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="792"><td class="num" id="LN792">792</td><td class="line">        <span class='comment'>/* Ok a background save is in progress. Let's check if it is a good</span></td></tr>
<tr class="codeline" data-linenumber="793"><td class="num" id="LN793">793</td><td class="line">         <span class='comment'>* one for replication, i.e. if there is another slave that is</span></td></tr>
<tr class="codeline" data-linenumber="794"><td class="num" id="LN794">794</td><td class="line">         <span class='comment'>* registering differences since the server forked to save. */</span></td></tr>
<tr class="codeline" data-linenumber="795"><td class="num" id="LN795">795</td><td class="line">        client *slave;</td></tr>
<tr class="codeline" data-linenumber="796"><td class="num" id="LN796">796</td><td class="line">        listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="797"><td class="num" id="LN797">797</td><td class="line">        listIter li;</td></tr>
<tr class="codeline" data-linenumber="798"><td class="num" id="LN798">798</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="799"><td class="num" id="LN799">799</td><td class="line">        listRewind(server.slaves,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="800"><td class="num" id="LN800">800</td><td class="line">        <span class='keyword'>while</span>((ln = listNext(&amp;li))) {</td></tr>
<tr class="codeline" data-linenumber="801"><td class="num" id="LN801">801</td><td class="line">            slave = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="802"><td class="num" id="LN802">802</td><td class="line">            <span class='keyword'>if</span> (slave-&gt;replstate == <span class='macro'>SLAVE_STATE_WAIT_BGSAVE_END<span class='macro_popup'>7</span></span>) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="803"><td class="num" id="LN803">803</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="804"><td class="num" id="LN804">804</td><td class="line">        <span class='comment'>/* To attach this slave, we check that it has at least all the</span></td></tr>
<tr class="codeline" data-linenumber="805"><td class="num" id="LN805">805</td><td class="line">         <span class='comment'>* capabilities of the slave that triggered the current BGSAVE. */</span></td></tr>
<tr class="codeline" data-linenumber="806"><td class="num" id="LN806">806</td><td class="line">        <span class='keyword'>if</span> (ln &amp;&amp; ((c-&gt;slave_capa &amp; slave-&gt;slave_capa) == slave-&gt;slave_capa)) {</td></tr>
<tr class="codeline" data-linenumber="807"><td class="num" id="LN807">807</td><td class="line">            <span class='comment'>/* Perfect, the server is already registering differences for</span></td></tr>
<tr class="codeline" data-linenumber="808"><td class="num" id="LN808">808</td><td class="line">             <span class='comment'>* another slave. Set the right state, and copy the buffer. */</span></td></tr>
<tr class="codeline" data-linenumber="809"><td class="num" id="LN809">809</td><td class="line">            copyClientOutputBuffer(c,slave);</td></tr>
<tr class="codeline" data-linenumber="810"><td class="num" id="LN810">810</td><td class="line">            replicationSetupSlaveForFullResync(c,slave-&gt;psync_initial_offset);</td></tr>
<tr class="codeline" data-linenumber="811"><td class="num" id="LN811">811</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Waiting for end of BGSAVE for SYNC"</span>);</td></tr>
<tr class="codeline" data-linenumber="812"><td class="num" id="LN812">812</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="813"><td class="num" id="LN813">813</td><td class="line">            <span class='comment'>/* No way, we need to wait for the next BGSAVE in order to</span></td></tr>
<tr class="codeline" data-linenumber="814"><td class="num" id="LN814">814</td><td class="line">             <span class='comment'>* register differences. */</span></td></tr>
<tr class="codeline" data-linenumber="815"><td class="num" id="LN815">815</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Can't attach the replica to the current BGSAVE. Waiting for next BGSAVE for SYNC"</span>);</td></tr>
<tr class="codeline" data-linenumber="816"><td class="num" id="LN816">816</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="817"><td class="num" id="LN817">817</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="818"><td class="num" id="LN818">818</td><td class="line">    <span class='comment'>/* CASE 2: BGSAVE is in progress, with socket target. */</span></td></tr>
<tr class="codeline" data-linenumber="819"><td class="num" id="LN819">819</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (server.rdb_child_pid != -1 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="820"><td class="num" id="LN820">820</td><td class="line">               server.rdb_child_type == <span class='macro'>RDB_CHILD_TYPE_SOCKET<span class='macro_popup'>2</span></span>)</td></tr>
<tr class="codeline" data-linenumber="821"><td class="num" id="LN821">821</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="822"><td class="num" id="LN822">822</td><td class="line">        <span class='comment'>/* There is an RDB child process but it is writing directly to</span></td></tr>
<tr class="codeline" data-linenumber="823"><td class="num" id="LN823">823</td><td class="line">         <span class='comment'>* children sockets. We need to wait for the next BGSAVE</span></td></tr>
<tr class="codeline" data-linenumber="824"><td class="num" id="LN824">824</td><td class="line">         <span class='comment'>* in order to synchronize. */</span></td></tr>
<tr class="codeline" data-linenumber="825"><td class="num" id="LN825">825</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Current BGSAVE has socket target. Waiting for next BGSAVE for SYNC"</span>);</td></tr>
<tr class="codeline" data-linenumber="826"><td class="num" id="LN826">826</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="827"><td class="num" id="LN827">827</td><td class="line">    <span class='comment'>/* CASE 3: There is no BGSAVE is progress. */</span></td></tr>
<tr class="codeline" data-linenumber="828"><td class="num" id="LN828">828</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="829"><td class="num" id="LN829">829</td><td class="line">        <span class='keyword'>if</span> (server.repl_diskless_sync &amp;&amp; (c-&gt;slave_capa &amp; <span class='macro'>SLAVE_CAPA_EOF<span class='macro_popup'>(1&lt;&lt;0)</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="830"><td class="num" id="LN830">830</td><td class="line">            <span class='comment'>/* Diskless replication RDB child is created inside</span></td></tr>
<tr class="codeline" data-linenumber="831"><td class="num" id="LN831">831</td><td class="line">             <span class='comment'>* replicationCron() since we want to delay its start a</span></td></tr>
<tr class="codeline" data-linenumber="832"><td class="num" id="LN832">832</td><td class="line">             <span class='comment'>* few seconds to wait for more slaves to arrive. */</span></td></tr>
<tr class="codeline" data-linenumber="833"><td class="num" id="LN833">833</td><td class="line">            <span class='keyword'>if</span> (server.repl_diskless_sync_delay)</td></tr>
<tr class="codeline" data-linenumber="834"><td class="num" id="LN834">834</td><td class="line">                serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Delay next BGSAVE for diskless SYNC"</span>);</td></tr>
<tr class="codeline" data-linenumber="835"><td class="num" id="LN835">835</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="836"><td class="num" id="LN836">836</td><td class="line">            <span class='comment'>/* Target is disk (or the slave is not capable of supporting</span></td></tr>
<tr class="codeline" data-linenumber="837"><td class="num" id="LN837">837</td><td class="line">             <span class='comment'>* diskless replication) and we don't have a BGSAVE in progress,</span></td></tr>
<tr class="codeline" data-linenumber="838"><td class="num" id="LN838">838</td><td class="line">             <span class='comment'>* let's start one. */</span></td></tr>
<tr class="codeline" data-linenumber="839"><td class="num" id="LN839">839</td><td class="line">            <span class='keyword'>if</span> (!hasActiveChildProcess()) {</td></tr>
<tr class="codeline" data-linenumber="840"><td class="num" id="LN840">840</td><td class="line">                startBgsaveForReplication(c-&gt;slave_capa);</td></tr>
<tr class="codeline" data-linenumber="841"><td class="num" id="LN841">841</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="842"><td class="num" id="LN842">842</td><td class="line">                serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="843"><td class="num" id="LN843">843</td><td class="line">                    <span class='string_literal'>"No BGSAVE in progress, but another BG operation is active. "</span></td></tr>
<tr class="codeline" data-linenumber="844"><td class="num" id="LN844">844</td><td class="line">                    <span class='string_literal'>"BGSAVE for replication delayed"</span>);</td></tr>
<tr class="codeline" data-linenumber="845"><td class="num" id="LN845">845</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="846"><td class="num" id="LN846">846</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="847"><td class="num" id="LN847">847</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="848"><td class="num" id="LN848">848</td><td class="line">    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="849"><td class="num" id="LN849">849</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="850"><td class="num" id="LN850">850</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="851"><td class="num" id="LN851">851</td><td class="line"><span class='comment'>/* REPLCONF &lt;option&gt; &lt;value&gt; &lt;option&gt; &lt;value&gt; ...</span></td></tr>
<tr class="codeline" data-linenumber="852"><td class="num" id="LN852">852</td><td class="line"> <span class='comment'>* This command is used by a slave in order to configure the replication</span></td></tr>
<tr class="codeline" data-linenumber="853"><td class="num" id="LN853">853</td><td class="line"> <span class='comment'>* process before starting it with the SYNC command.</span></td></tr>
<tr class="codeline" data-linenumber="854"><td class="num" id="LN854">854</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="855"><td class="num" id="LN855">855</td><td class="line"> <span class='comment'>* Currently the only use of this command is to communicate to the master</span></td></tr>
<tr class="codeline" data-linenumber="856"><td class="num" id="LN856">856</td><td class="line"> <span class='comment'>* what is the listening port of the Slave redis instance, so that the</span></td></tr>
<tr class="codeline" data-linenumber="857"><td class="num" id="LN857">857</td><td class="line"> <span class='comment'>* master can accurately list slaves and their listening ports in</span></td></tr>
<tr class="codeline" data-linenumber="858"><td class="num" id="LN858">858</td><td class="line"> <span class='comment'>* the INFO output.</span></td></tr>
<tr class="codeline" data-linenumber="859"><td class="num" id="LN859">859</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="860"><td class="num" id="LN860">860</td><td class="line"> <span class='comment'>* In the future the same command can be used in order to configure</span></td></tr>
<tr class="codeline" data-linenumber="861"><td class="num" id="LN861">861</td><td class="line"> <span class='comment'>* the replication to initiate an incremental replication instead of a</span></td></tr>
<tr class="codeline" data-linenumber="862"><td class="num" id="LN862">862</td><td class="line"> <span class='comment'>* full resync. */</span></td></tr>
<tr class="codeline" data-linenumber="863"><td class="num" id="LN863">863</td><td class="line"><span class='keyword'>void</span> replconfCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="864"><td class="num" id="LN864">864</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="865"><td class="num" id="LN865">865</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="866"><td class="num" id="LN866">866</td><td class="line">    <span class='keyword'>if</span> ((c-&gt;argc % 2) == 0) {</td></tr>
<tr class="codeline" data-linenumber="867"><td class="num" id="LN867">867</td><td class="line">        <span class='comment'>/* Number of arguments must be odd to make sure that every</span></td></tr>
<tr class="codeline" data-linenumber="868"><td class="num" id="LN868">868</td><td class="line">         <span class='comment'>* option has a corresponding value. */</span></td></tr>
<tr class="codeline" data-linenumber="869"><td class="num" id="LN869">869</td><td class="line">        addReply(c,shared.syntaxerr);</td></tr>
<tr class="codeline" data-linenumber="870"><td class="num" id="LN870">870</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="871"><td class="num" id="LN871">871</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="872"><td class="num" id="LN872">872</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="873"><td class="num" id="LN873">873</td><td class="line">    <span class='comment'>/* Process every option-value pair. */</span></td></tr>
<tr class="codeline" data-linenumber="874"><td class="num" id="LN874">874</td><td class="line">    <span class='keyword'>for</span> (j = 1; j &lt; c-&gt;argc; j+=2) {</td></tr>
<tr class="codeline" data-linenumber="875"><td class="num" id="LN875">875</td><td class="line">        <span class='keyword'>if</span> (!strcasecmp(c-&gt;argv[j]-&gt;ptr,<span class='string_literal'>"listening-port"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="876"><td class="num" id="LN876">876</td><td class="line">            <span class='keyword'>long</span> port;</td></tr>
<tr class="codeline" data-linenumber="877"><td class="num" id="LN877">877</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="878"><td class="num" id="LN878">878</td><td class="line">            <span class='keyword'>if</span> ((getLongFromObjectOrReply(c,c-&gt;argv[j+1],</td></tr>
<tr class="codeline" data-linenumber="879"><td class="num" id="LN879">879</td><td class="line">                    &amp;port,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) != <span class='macro'>C_OK<span class='macro_popup'>0</span></span>))</td></tr>
<tr class="codeline" data-linenumber="880"><td class="num" id="LN880">880</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="881"><td class="num" id="LN881">881</td><td class="line">            c-&gt;slave_listening_port = port;</td></tr>
<tr class="codeline" data-linenumber="882"><td class="num" id="LN882">882</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(c-&gt;argv[j]-&gt;ptr,<span class='string_literal'>"ip-address"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="883"><td class="num" id="LN883">883</td><td class="line">            sds ip = c-&gt;argv[j+1]-&gt;ptr;</td></tr>
<tr class="codeline" data-linenumber="884"><td class="num" id="LN884">884</td><td class="line">            <span class='keyword'>if</span> (sdslen(ip) &lt; <span class='keyword'>sizeof</span>(c-&gt;slave_ip)) {</td></tr>
<tr class="codeline" data-linenumber="885"><td class="num" id="LN885">885</td><td class="line">                memcpy(c-&gt;slave_ip,ip,sdslen(ip)+1);</td></tr>
<tr class="codeline" data-linenumber="886"><td class="num" id="LN886">886</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="887"><td class="num" id="LN887">887</td><td class="line">                addReplyErrorFormat(c,<span class='string_literal'>"REPLCONF ip-address provided by "</span></td></tr>
<tr class="codeline" data-linenumber="888"><td class="num" id="LN888">888</td><td class="line">                    <span class='string_literal'>"replica instance is too long: %zd bytes"</span>, sdslen(ip));</td></tr>
<tr class="codeline" data-linenumber="889"><td class="num" id="LN889">889</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="890"><td class="num" id="LN890">890</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="891"><td class="num" id="LN891">891</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(c-&gt;argv[j]-&gt;ptr,<span class='string_literal'>"capa"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="892"><td class="num" id="LN892">892</td><td class="line">            <span class='comment'>/* Ignore capabilities not understood by this master. */</span></td></tr>
<tr class="codeline" data-linenumber="893"><td class="num" id="LN893">893</td><td class="line">            <span class='keyword'>if</span> (!strcasecmp(c-&gt;argv[j+1]-&gt;ptr,<span class='string_literal'>"eof"</span>))</td></tr>
<tr class="codeline" data-linenumber="894"><td class="num" id="LN894">894</td><td class="line">                c-&gt;slave_capa |= <span class='macro'>SLAVE_CAPA_EOF<span class='macro_popup'>(1&lt;&lt;0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="895"><td class="num" id="LN895">895</td><td class="line">            <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(c-&gt;argv[j+1]-&gt;ptr,<span class='string_literal'>"psync2"</span>))</td></tr>
<tr class="codeline" data-linenumber="896"><td class="num" id="LN896">896</td><td class="line">                c-&gt;slave_capa |= <span class='macro'>SLAVE_CAPA_PSYNC2<span class='macro_popup'>(1&lt;&lt;1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="897"><td class="num" id="LN897">897</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(c-&gt;argv[j]-&gt;ptr,<span class='string_literal'>"ack"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="898"><td class="num" id="LN898">898</td><td class="line">            <span class='comment'>/* REPLCONF ACK is used by slave to inform the master the amount</span></td></tr>
<tr class="codeline" data-linenumber="899"><td class="num" id="LN899">899</td><td class="line">             <span class='comment'>* of replication stream that it processed so far. It is an</span></td></tr>
<tr class="codeline" data-linenumber="900"><td class="num" id="LN900">900</td><td class="line">             <span class='comment'>* internal only command that normal clients should never use. */</span></td></tr>
<tr class="codeline" data-linenumber="901"><td class="num" id="LN901">901</td><td class="line">            <span class='keyword'>long</span> <span class='keyword'>long</span> offset;</td></tr>
<tr class="codeline" data-linenumber="902"><td class="num" id="LN902">902</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="903"><td class="num" id="LN903">903</td><td class="line">            <span class='keyword'>if</span> (!(c-&gt;flags &amp; <span class='macro'>CLIENT_SLAVE<span class='macro_popup'>(1&lt;&lt;0)</span></span>)) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="904"><td class="num" id="LN904">904</td><td class="line">            <span class='keyword'>if</span> ((getLongLongFromObject(c-&gt;argv[j+1], &amp;offset) != <span class='macro'>C_OK<span class='macro_popup'>0</span></span>))</td></tr>
<tr class="codeline" data-linenumber="905"><td class="num" id="LN905">905</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="906"><td class="num" id="LN906">906</td><td class="line">            <span class='keyword'>if</span> (offset &gt; c-&gt;repl_ack_off)</td></tr>
<tr class="codeline" data-linenumber="907"><td class="num" id="LN907">907</td><td class="line">                c-&gt;repl_ack_off = offset;</td></tr>
<tr class="codeline" data-linenumber="908"><td class="num" id="LN908">908</td><td class="line">            c-&gt;repl_ack_time = server.unixtime;</td></tr>
<tr class="codeline" data-linenumber="909"><td class="num" id="LN909">909</td><td class="line">            <span class='comment'>/* If this was a diskless replication, we need to really put</span></td></tr>
<tr class="codeline" data-linenumber="910"><td class="num" id="LN910">910</td><td class="line">             <span class='comment'>* the slave online when the first ACK is received (which</span></td></tr>
<tr class="codeline" data-linenumber="911"><td class="num" id="LN911">911</td><td class="line">             <span class='comment'>* confirms slave is online and ready to get more data). This</span></td></tr>
<tr class="codeline" data-linenumber="912"><td class="num" id="LN912">912</td><td class="line">             <span class='comment'>* allows for simpler and less CPU intensive EOF detection</span></td></tr>
<tr class="codeline" data-linenumber="913"><td class="num" id="LN913">913</td><td class="line">             <span class='comment'>* when streaming RDB files. */</span></td></tr>
<tr class="codeline" data-linenumber="914"><td class="num" id="LN914">914</td><td class="line">            <span class='keyword'>if</span> (c-&gt;repl_put_online_on_ack &amp;&amp; c-&gt;replstate == <span class='macro'>SLAVE_STATE_ONLINE<span class='macro_popup'>9</span></span>)</td></tr>
<tr class="codeline" data-linenumber="915"><td class="num" id="LN915">915</td><td class="line">                putSlaveOnline(c);</td></tr>
<tr class="codeline" data-linenumber="916"><td class="num" id="LN916">916</td><td class="line">            <span class='comment'>/* Note: this command does not reply anything! */</span></td></tr>
<tr class="codeline" data-linenumber="917"><td class="num" id="LN917">917</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="918"><td class="num" id="LN918">918</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(c-&gt;argv[j]-&gt;ptr,<span class='string_literal'>"getack"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="919"><td class="num" id="LN919">919</td><td class="line">            <span class='comment'>/* REPLCONF GETACK is used in order to request an ACK ASAP</span></td></tr>
<tr class="codeline" data-linenumber="920"><td class="num" id="LN920">920</td><td class="line">             <span class='comment'>* to the slave. */</span></td></tr>
<tr class="codeline" data-linenumber="921"><td class="num" id="LN921">921</td><td class="line">            <span class='keyword'>if</span> (server.masterhost &amp;&amp; server.master) replicationSendAck();</td></tr>
<tr class="codeline" data-linenumber="922"><td class="num" id="LN922">922</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="923"><td class="num" id="LN923">923</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="924"><td class="num" id="LN924">924</td><td class="line">            addReplyErrorFormat(c,<span class='string_literal'>"Unrecognized REPLCONF option: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="925"><td class="num" id="LN925">925</td><td class="line">                (<span class='keyword'>char</span>*)c-&gt;argv[j]-&gt;ptr);</td></tr>
<tr class="codeline" data-linenumber="926"><td class="num" id="LN926">926</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="927"><td class="num" id="LN927">927</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="928"><td class="num" id="LN928">928</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="929"><td class="num" id="LN929">929</td><td class="line">    addReply(c,shared.ok);</td></tr>
<tr class="codeline" data-linenumber="930"><td class="num" id="LN930">930</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="931"><td class="num" id="LN931">931</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="932"><td class="num" id="LN932">932</td><td class="line"><span class='comment'>/* This function puts a replica in the online state, and should be called just</span></td></tr>
<tr class="codeline" data-linenumber="933"><td class="num" id="LN933">933</td><td class="line"> <span class='comment'>* after a replica received the RDB file for the initial synchronization, and</span></td></tr>
<tr class="codeline" data-linenumber="934"><td class="num" id="LN934">934</td><td class="line"> <span class='comment'>* we are finally ready to send the incremental stream of commands.</span></td></tr>
<tr class="codeline" data-linenumber="935"><td class="num" id="LN935">935</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="936"><td class="num" id="LN936">936</td><td class="line"> <span class='comment'>* It does a few things:</span></td></tr>
<tr class="codeline" data-linenumber="937"><td class="num" id="LN937">937</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="938"><td class="num" id="LN938">938</td><td class="line"> <span class='comment'>* 1) Put the slave in ONLINE state. Note that the function may also be called</span></td></tr>
<tr class="codeline" data-linenumber="939"><td class="num" id="LN939">939</td><td class="line"> <span class='comment'>*    for a replicas that are already in ONLINE state, but having the flag</span></td></tr>
<tr class="codeline" data-linenumber="940"><td class="num" id="LN940">940</td><td class="line"> <span class='comment'>*    repl_put_online_on_ack set to true: we still have to install the write</span></td></tr>
<tr class="codeline" data-linenumber="941"><td class="num" id="LN941">941</td><td class="line"> <span class='comment'>*    handler in that case. This function will take care of that.</span></td></tr>
<tr class="codeline" data-linenumber="942"><td class="num" id="LN942">942</td><td class="line"> <span class='comment'>* 2) Make sure the writable event is re-installed, since calling the SYNC</span></td></tr>
<tr class="codeline" data-linenumber="943"><td class="num" id="LN943">943</td><td class="line"> <span class='comment'>*    command disables it, so that we can accumulate output buffer without</span></td></tr>
<tr class="codeline" data-linenumber="944"><td class="num" id="LN944">944</td><td class="line"> <span class='comment'>*    sending it to the replica.</span></td></tr>
<tr class="codeline" data-linenumber="945"><td class="num" id="LN945">945</td><td class="line"> <span class='comment'>* 3) Update the count of "good replicas". */</span></td></tr>
<tr class="codeline" data-linenumber="946"><td class="num" id="LN946">946</td><td class="line"><span class='keyword'>void</span> putSlaveOnline(client *slave) {</td></tr>
<tr class="codeline" data-linenumber="947"><td class="num" id="LN947">947</td><td class="line">    slave-&gt;replstate = <span class='macro'>SLAVE_STATE_ONLINE<span class='macro_popup'>9</span></span>;</td></tr>
<tr class="codeline" data-linenumber="948"><td class="num" id="LN948">948</td><td class="line">    slave-&gt;repl_put_online_on_ack = 0;</td></tr>
<tr class="codeline" data-linenumber="949"><td class="num" id="LN949">949</td><td class="line">    slave-&gt;repl_ack_time = server.unixtime; <span class='comment'>/* Prevent false timeout. */</span></td></tr>
<tr class="codeline" data-linenumber="950"><td class="num" id="LN950">950</td><td class="line">    <span class='keyword'>if</span> (connSetWriteHandler(slave-&gt;conn, sendReplyToClient) == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="951"><td class="num" id="LN951">951</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Unable to register writable event for replica bulk transfer: %s"</span>, strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="952"><td class="num" id="LN952">952</td><td class="line">        freeClient(slave);</td></tr>
<tr class="codeline" data-linenumber="953"><td class="num" id="LN953">953</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="954"><td class="num" id="LN954">954</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="955"><td class="num" id="LN955">955</td><td class="line">    refreshGoodSlavesCount();</td></tr>
<tr class="codeline" data-linenumber="956"><td class="num" id="LN956">956</td><td class="line">    <span class='comment'>/* Fire the replica change modules event. */</span></td></tr>
<tr class="codeline" data-linenumber="957"><td class="num" id="LN957">957</td><td class="line">    moduleFireServerEvent(<span class='macro'>REDISMODULE_EVENT_REPLICA_CHANGE<span class='macro_popup'>6</span></span>,</td></tr>
<tr class="codeline" data-linenumber="958"><td class="num" id="LN958">958</td><td class="line">                          <span class='macro'>REDISMODULE_SUBEVENT_REPLICA_CHANGE_ONLINE<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="959"><td class="num" id="LN959">959</td><td class="line">                          <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="960"><td class="num" id="LN960">960</td><td class="line">    serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Synchronization with replica %s succeeded"</span>,</td></tr>
<tr class="codeline" data-linenumber="961"><td class="num" id="LN961">961</td><td class="line">        replicationGetSlaveName(slave));</td></tr>
<tr class="codeline" data-linenumber="962"><td class="num" id="LN962">962</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="963"><td class="num" id="LN963">963</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="964"><td class="num" id="LN964">964</td><td class="line"><span class='comment'>/* We call this function periodically to remove an RDB file that was</span></td></tr>
<tr class="codeline" data-linenumber="965"><td class="num" id="LN965">965</td><td class="line"> <span class='comment'>* generated because of replication, in an instance that is otherwise</span></td></tr>
<tr class="codeline" data-linenumber="966"><td class="num" id="LN966">966</td><td class="line"> <span class='comment'>* without any persistence. We don't want instances without persistence</span></td></tr>
<tr class="codeline" data-linenumber="967"><td class="num" id="LN967">967</td><td class="line"> <span class='comment'>* to take RDB files around, this violates certain policies in certain</span></td></tr>
<tr class="codeline" data-linenumber="968"><td class="num" id="LN968">968</td><td class="line"> <span class='comment'>* environments. */</span></td></tr>
<tr class="codeline" data-linenumber="969"><td class="num" id="LN969">969</td><td class="line"><span class='keyword'>void</span> removeRDBUsedToSyncReplicas(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="970"><td class="num" id="LN970">970</td><td class="line">    <span class='comment'>/* If the feature is disabled, return ASAP but also clear the</span></td></tr>
<tr class="codeline" data-linenumber="971"><td class="num" id="LN971">971</td><td class="line">     <span class='comment'>* RDBGeneratedByReplication flag in case it was set. Otherwise if the</span></td></tr>
<tr class="codeline" data-linenumber="972"><td class="num" id="LN972">972</td><td class="line">     <span class='comment'>* feature was enabled, but gets disabled later with CONFIG SET, the</span></td></tr>
<tr class="codeline" data-linenumber="973"><td class="num" id="LN973">973</td><td class="line">     <span class='comment'>* flag may remain set to one: then next time the feature is re-enabled</span></td></tr>
<tr class="codeline" data-linenumber="974"><td class="num" id="LN974">974</td><td class="line">     <span class='comment'>* via CONFIG SET we have have it set even if no RDB was generated</span></td></tr>
<tr class="codeline" data-linenumber="975"><td class="num" id="LN975">975</td><td class="line">     <span class='comment'>* because of replication recently. */</span></td></tr>
<tr class="codeline" data-linenumber="976"><td class="num" id="LN976">976</td><td class="line">    <span class='keyword'>if</span> (!server.rdb_del_sync_files) {</td></tr>
<tr class="codeline" data-linenumber="977"><td class="num" id="LN977">977</td><td class="line">        RDBGeneratedByReplication = 0;</td></tr>
<tr class="codeline" data-linenumber="978"><td class="num" id="LN978">978</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="979"><td class="num" id="LN979">979</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="980"><td class="num" id="LN980">980</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="981"><td class="num" id="LN981">981</td><td class="line">    <span class='keyword'>if</span> (allPersistenceDisabled() &amp;&amp; RDBGeneratedByReplication) {</td></tr>
<tr class="codeline" data-linenumber="982"><td class="num" id="LN982">982</td><td class="line">        client *slave;</td></tr>
<tr class="codeline" data-linenumber="983"><td class="num" id="LN983">983</td><td class="line">        listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="984"><td class="num" id="LN984">984</td><td class="line">        listIter li;</td></tr>
<tr class="codeline" data-linenumber="985"><td class="num" id="LN985">985</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="986"><td class="num" id="LN986">986</td><td class="line">        <span class='keyword'>int</span> delrdb = 1;</td></tr>
<tr class="codeline" data-linenumber="987"><td class="num" id="LN987">987</td><td class="line">        listRewind(server.slaves,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="988"><td class="num" id="LN988">988</td><td class="line">        <span class='keyword'>while</span>((ln = listNext(&amp;li))) {</td></tr>
<tr class="codeline" data-linenumber="989"><td class="num" id="LN989">989</td><td class="line">            slave = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="990"><td class="num" id="LN990">990</td><td class="line">            <span class='keyword'>if</span> (slave-&gt;replstate == <span class='macro'>SLAVE_STATE_WAIT_BGSAVE_START<span class='macro_popup'>6</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="991"><td class="num" id="LN991">991</td><td class="line">                slave-&gt;replstate == <span class='macro'>SLAVE_STATE_WAIT_BGSAVE_END<span class='macro_popup'>7</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="992"><td class="num" id="LN992">992</td><td class="line">                slave-&gt;replstate == <span class='macro'>SLAVE_STATE_SEND_BULK<span class='macro_popup'>8</span></span>)</td></tr>
<tr class="codeline" data-linenumber="993"><td class="num" id="LN993">993</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="994"><td class="num" id="LN994">994</td><td class="line">                delrdb = 0;</td></tr>
<tr class="codeline" data-linenumber="995"><td class="num" id="LN995">995</td><td class="line">                <span class='keyword'>break</span>; <span class='comment'>/* No need to check the other replicas. */</span></td></tr>
<tr class="codeline" data-linenumber="996"><td class="num" id="LN996">996</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="997"><td class="num" id="LN997">997</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="998"><td class="num" id="LN998">998</td><td class="line">        <span class='keyword'>if</span> (delrdb) {</td></tr>
<tr class="codeline" data-linenumber="999"><td class="num" id="LN999">999</td><td class="line">            <span class='keyword'>struct</span> stat sb;</td></tr>
<tr class="codeline" data-linenumber="1000"><td class="num" id="LN1000">1000</td><td class="line">            <span class='keyword'>if</span> (lstat(server.rdb_filename,&amp;sb) != -1) {</td></tr>
<tr class="codeline" data-linenumber="1001"><td class="num" id="LN1001">1001</td><td class="line">                RDBGeneratedByReplication = 0;</td></tr>
<tr class="codeline" data-linenumber="1002"><td class="num" id="LN1002">1002</td><td class="line">                serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1003"><td class="num" id="LN1003">1003</td><td class="line">                    <span class='string_literal'>"Removing the RDB file used to feed replicas "</span></td></tr>
<tr class="codeline" data-linenumber="1004"><td class="num" id="LN1004">1004</td><td class="line">                    <span class='string_literal'>"in a persistence-less instance"</span>);</td></tr>
<tr class="codeline" data-linenumber="1005"><td class="num" id="LN1005">1005</td><td class="line">                bg_unlink(server.rdb_filename);</td></tr>
<tr class="codeline" data-linenumber="1006"><td class="num" id="LN1006">1006</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1007"><td class="num" id="LN1007">1007</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1008"><td class="num" id="LN1008">1008</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1009"><td class="num" id="LN1009">1009</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1010"><td class="num" id="LN1010">1010</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1011"><td class="num" id="LN1011">1011</td><td class="line"><span class='keyword'>void</span> sendBulkToSlave(connection *conn) {</td></tr>
<tr class="codeline" data-linenumber="1012"><td class="num" id="LN1012">1012</td><td class="line">    client *slave = connGetPrivateData(conn);</td></tr>
<tr class="codeline" data-linenumber="1013"><td class="num" id="LN1013">1013</td><td class="line">    <span class='keyword'>char</span> buf[<span class='macro'>PROTO_IOBUF_LEN<span class='macro_popup'>(1024*16)</span></span>];</td></tr>
<tr class="codeline" data-linenumber="1014"><td class="num" id="LN1014">1014</td><td class="line">    ssize_t nwritten, buflen;</td></tr>
<tr class="codeline" data-linenumber="1015"><td class="num" id="LN1015">1015</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1016"><td class="num" id="LN1016">1016</td><td class="line">    <span class='comment'>/* Before sending the RDB file, we send the preamble as configured by the</span></td></tr>
<tr class="codeline" data-linenumber="1017"><td class="num" id="LN1017">1017</td><td class="line">     <span class='comment'>* replication process. Currently the preamble is just the bulk count of</span></td></tr>
<tr class="codeline" data-linenumber="1018"><td class="num" id="LN1018">1018</td><td class="line">     <span class='comment'>* the file in the form "$&lt;length&gt;\r\n". */</span></td></tr>
<tr class="codeline" data-linenumber="1019"><td class="num" id="LN1019">1019</td><td class="line">    <span class='keyword'>if</span> (slave-&gt;replpreamble) {</td></tr>
<tr class="codeline" data-linenumber="1020"><td class="num" id="LN1020">1020</td><td class="line">        nwritten = connWrite(conn,slave-&gt;replpreamble,sdslen(slave-&gt;replpreamble));</td></tr>
<tr class="codeline" data-linenumber="1021"><td class="num" id="LN1021">1021</td><td class="line">        <span class='keyword'>if</span> (nwritten == -1) {</td></tr>
<tr class="codeline" data-linenumber="1022"><td class="num" id="LN1022">1022</td><td class="line">            serverLog(<span class='macro'>LL_VERBOSE<span class='macro_popup'>1</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1023"><td class="num" id="LN1023">1023</td><td class="line">                <span class='string_literal'>"Write error sending RDB preamble to replica: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="1024"><td class="num" id="LN1024">1024</td><td class="line">                connGetLastError(conn));</td></tr>
<tr class="codeline" data-linenumber="1025"><td class="num" id="LN1025">1025</td><td class="line">            freeClient(slave);</td></tr>
<tr class="codeline" data-linenumber="1026"><td class="num" id="LN1026">1026</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1027"><td class="num" id="LN1027">1027</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1028"><td class="num" id="LN1028">1028</td><td class="line">        server.stat_net_output_bytes += nwritten;</td></tr>
<tr class="codeline" data-linenumber="1029"><td class="num" id="LN1029">1029</td><td class="line">        sdsrange(slave-&gt;replpreamble,nwritten,-1);</td></tr>
<tr class="codeline" data-linenumber="1030"><td class="num" id="LN1030">1030</td><td class="line">        <span class='keyword'>if</span> (sdslen(slave-&gt;replpreamble) == 0) {</td></tr>
<tr class="codeline" data-linenumber="1031"><td class="num" id="LN1031">1031</td><td class="line">            sdsfree(slave-&gt;replpreamble);</td></tr>
<tr class="codeline" data-linenumber="1032"><td class="num" id="LN1032">1032</td><td class="line">            slave-&gt;replpreamble = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1033"><td class="num" id="LN1033">1033</td><td class="line">            <span class='comment'>/* fall through sending data. */</span></td></tr>
<tr class="codeline" data-linenumber="1034"><td class="num" id="LN1034">1034</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1035"><td class="num" id="LN1035">1035</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1036"><td class="num" id="LN1036">1036</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1037"><td class="num" id="LN1037">1037</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1038"><td class="num" id="LN1038">1038</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1039"><td class="num" id="LN1039">1039</td><td class="line">    <span class='comment'>/* If the preamble was already transferred, send the RDB bulk data. */</span></td></tr>
<tr class="codeline" data-linenumber="1040"><td class="num" id="LN1040">1040</td><td class="line">    lseek(slave-&gt;repldbfd,slave-&gt;repldboff,<span class='macro'>SEEK_SET<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1041"><td class="num" id="LN1041">1041</td><td class="line">    buflen = read(slave-&gt;repldbfd,buf,<span class='macro'>PROTO_IOBUF_LEN<span class='macro_popup'>(1024*16)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1042"><td class="num" id="LN1042">1042</td><td class="line">    <span class='keyword'>if</span> (buflen &lt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="1043"><td class="num" id="LN1043">1043</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Read error sending DB to replica: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="1044"><td class="num" id="LN1044">1044</td><td class="line">            (buflen == 0) ? <span class='string_literal'>"premature EOF"</span> : strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="1045"><td class="num" id="LN1045">1045</td><td class="line">        freeClient(slave);</td></tr>
<tr class="codeline" data-linenumber="1046"><td class="num" id="LN1046">1046</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1047"><td class="num" id="LN1047">1047</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1048"><td class="num" id="LN1048">1048</td><td class="line">    <span class='keyword'>if</span> ((nwritten = connWrite(conn,buf,buflen)) == -1) {</td></tr>
<tr class="codeline" data-linenumber="1049"><td class="num" id="LN1049">1049</td><td class="line">        <span class='keyword'>if</span> (connGetState(conn) != CONN_STATE_CONNECTED) {</td></tr>
<tr class="codeline" data-linenumber="1050"><td class="num" id="LN1050">1050</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Write error sending DB to replica: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="1051"><td class="num" id="LN1051">1051</td><td class="line">                connGetLastError(conn));</td></tr>
<tr class="codeline" data-linenumber="1052"><td class="num" id="LN1052">1052</td><td class="line">            freeClient(slave);</td></tr>
<tr class="codeline" data-linenumber="1053"><td class="num" id="LN1053">1053</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1054"><td class="num" id="LN1054">1054</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1055"><td class="num" id="LN1055">1055</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1056"><td class="num" id="LN1056">1056</td><td class="line">    slave-&gt;repldboff += nwritten;</td></tr>
<tr class="codeline" data-linenumber="1057"><td class="num" id="LN1057">1057</td><td class="line">    server.stat_net_output_bytes += nwritten;</td></tr>
<tr class="codeline" data-linenumber="1058"><td class="num" id="LN1058">1058</td><td class="line">    <span class='keyword'>if</span> (slave-&gt;repldboff == slave-&gt;repldbsize) {</td></tr>
<tr class="codeline" data-linenumber="1059"><td class="num" id="LN1059">1059</td><td class="line">        close(slave-&gt;repldbfd);</td></tr>
<tr class="codeline" data-linenumber="1060"><td class="num" id="LN1060">1060</td><td class="line">        slave-&gt;repldbfd = -1;</td></tr>
<tr class="codeline" data-linenumber="1061"><td class="num" id="LN1061">1061</td><td class="line">        connSetWriteHandler(slave-&gt;conn,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1062"><td class="num" id="LN1062">1062</td><td class="line">        putSlaveOnline(slave);</td></tr>
<tr class="codeline" data-linenumber="1063"><td class="num" id="LN1063">1063</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1064"><td class="num" id="LN1064">1064</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1065"><td class="num" id="LN1065">1065</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1066"><td class="num" id="LN1066">1066</td><td class="line"><span class='comment'>/* Remove one write handler from the list of connections waiting to be writable</span></td></tr>
<tr class="codeline" data-linenumber="1067"><td class="num" id="LN1067">1067</td><td class="line"> <span class='comment'>* during rdb pipe transfer. */</span></td></tr>
<tr class="codeline" data-linenumber="1068"><td class="num" id="LN1068">1068</td><td class="line"><span class='keyword'>void</span> rdbPipeWriteHandlerConnRemoved(<span class='keyword'>struct</span> connection *conn) {</td></tr>
<tr class="codeline" data-linenumber="1069"><td class="num" id="LN1069">1069</td><td class="line">    <span class='keyword'>if</span> (!connHasWriteHandler(conn))</td></tr>
<tr class="codeline" data-linenumber="1070"><td class="num" id="LN1070">1070</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1071"><td class="num" id="LN1071">1071</td><td class="line">    connSetWriteHandler(conn, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1072"><td class="num" id="LN1072">1072</td><td class="line">    server.rdb_pipe_numconns_writing--;</td></tr>
<tr class="codeline" data-linenumber="1073"><td class="num" id="LN1073">1073</td><td class="line">    <span class='comment'>/* if there are no more writes for now for this conn, or write error: */</span></td></tr>
<tr class="codeline" data-linenumber="1074"><td class="num" id="LN1074">1074</td><td class="line">    <span class='keyword'>if</span> (server.rdb_pipe_numconns_writing == 0) {</td></tr>
<tr class="codeline" data-linenumber="1075"><td class="num" id="LN1075">1075</td><td class="line">        <span class='keyword'>if</span> (aeCreateFileEvent(server.el, server.rdb_pipe_read, <span class='macro'>AE_READABLE<span class='macro_popup'>1</span></span>, rdbPipeReadHandler,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) == <span class='macro'>AE_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1076"><td class="num" id="LN1076">1076</td><td class="line">            <span class='macro'>serverPanic(<span class='string_literal'>"Unrecoverable error creating server.rdb_pipe_read file event."</span>)<span class='macro_popup'>_serverPanic("replication.c",1076,"Unrecoverable error creating server.rdb_pipe_read file event."<br>),_exit(1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1077"><td class="num" id="LN1077">1077</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1078"><td class="num" id="LN1078">1078</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1079"><td class="num" id="LN1079">1079</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1080"><td class="num" id="LN1080">1080</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1081"><td class="num" id="LN1081">1081</td><td class="line"><span class='comment'>/* Called in diskless master during transfer of data from the rdb pipe, when</span></td></tr>
<tr class="codeline" data-linenumber="1082"><td class="num" id="LN1082">1082</td><td class="line"> <span class='comment'>* the replica becomes writable again. */</span></td></tr>
<tr class="codeline" data-linenumber="1083"><td class="num" id="LN1083">1083</td><td class="line"><span class='keyword'>void</span> rdbPipeWriteHandler(<span class='keyword'>struct</span> connection *conn) {</td></tr>
<tr class="codeline" data-linenumber="1084"><td class="num" id="LN1084">1084</td><td class="line">    <span class='macro'>serverAssert(server.rdb_pipe_bufflen&gt;0)<span class='macro_popup'>((server.rdb_pipe_bufflen&gt;0)?(void)0 : (_serverAssert("server.rdb_pipe_bufflen&gt;0"<br>,"replication.c",1084),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1085"><td class="num" id="LN1085">1085</td><td class="line">    client *slave = connGetPrivateData(conn);</td></tr>
<tr class="codeline" data-linenumber="1086"><td class="num" id="LN1086">1086</td><td class="line">    <span class='keyword'>int</span> nwritten;</td></tr>
<tr class="codeline" data-linenumber="1087"><td class="num" id="LN1087">1087</td><td class="line">    <span class='keyword'>if</span> ((nwritten = connWrite(conn, server.rdb_pipe_buff + slave-&gt;repldboff,</td></tr>
<tr class="codeline" data-linenumber="1088"><td class="num" id="LN1088">1088</td><td class="line">                              server.rdb_pipe_bufflen - slave-&gt;repldboff)) == -1)</td></tr>
<tr class="codeline" data-linenumber="1089"><td class="num" id="LN1089">1089</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1090"><td class="num" id="LN1090">1090</td><td class="line">        <span class='keyword'>if</span> (connGetState(conn) == CONN_STATE_CONNECTED)</td></tr>
<tr class="codeline" data-linenumber="1091"><td class="num" id="LN1091">1091</td><td class="line">            <span class='keyword'>return</span>; <span class='comment'>/* equivalent to EAGAIN */</span></td></tr>
<tr class="codeline" data-linenumber="1092"><td class="num" id="LN1092">1092</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Write error sending DB to replica: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="1093"><td class="num" id="LN1093">1093</td><td class="line">            connGetLastError(conn));</td></tr>
<tr class="codeline" data-linenumber="1094"><td class="num" id="LN1094">1094</td><td class="line">        freeClient(slave);</td></tr>
<tr class="codeline" data-linenumber="1095"><td class="num" id="LN1095">1095</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1096"><td class="num" id="LN1096">1096</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1097"><td class="num" id="LN1097">1097</td><td class="line">        slave-&gt;repldboff += nwritten;</td></tr>
<tr class="codeline" data-linenumber="1098"><td class="num" id="LN1098">1098</td><td class="line">        server.stat_net_output_bytes += nwritten;</td></tr>
<tr class="codeline" data-linenumber="1099"><td class="num" id="LN1099">1099</td><td class="line">        <span class='keyword'>if</span> (slave-&gt;repldboff &lt; server.rdb_pipe_bufflen)</td></tr>
<tr class="codeline" data-linenumber="1100"><td class="num" id="LN1100">1100</td><td class="line">            <span class='keyword'>return</span>; <span class='comment'>/* more data to write.. */</span></td></tr>
<tr class="codeline" data-linenumber="1101"><td class="num" id="LN1101">1101</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1102"><td class="num" id="LN1102">1102</td><td class="line">    rdbPipeWriteHandlerConnRemoved(conn);</td></tr>
<tr class="codeline" data-linenumber="1103"><td class="num" id="LN1103">1103</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1104"><td class="num" id="LN1104">1104</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1105"><td class="num" id="LN1105">1105</td><td class="line"><span class='comment'>/* When the the pipe serving diskless rdb transfer is drained (write end was</span></td></tr>
<tr class="codeline" data-linenumber="1106"><td class="num" id="LN1106">1106</td><td class="line"> <span class='comment'>* closed), we can clean up all the temporary variables, and cleanup after the</span></td></tr>
<tr class="codeline" data-linenumber="1107"><td class="num" id="LN1107">1107</td><td class="line"> <span class='comment'>* fork child. */</span></td></tr>
<tr class="codeline" data-linenumber="1108"><td class="num" id="LN1108">1108</td><td class="line"><span class='keyword'>void</span> RdbPipeCleanup() {</td></tr>
<tr class="codeline" data-linenumber="1109"><td class="num" id="LN1109">1109</td><td class="line">    close(server.rdb_pipe_read);</td></tr>
<tr class="codeline" data-linenumber="1110"><td class="num" id="LN1110">1110</td><td class="line">    zfree(server.rdb_pipe_conns);</td></tr>
<tr class="codeline" data-linenumber="1111"><td class="num" id="LN1111">1111</td><td class="line">    server.rdb_pipe_conns = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1112"><td class="num" id="LN1112">1112</td><td class="line">    server.rdb_pipe_numconns = 0;</td></tr>
<tr class="codeline" data-linenumber="1113"><td class="num" id="LN1113">1113</td><td class="line">    server.rdb_pipe_numconns_writing = 0;</td></tr>
<tr class="codeline" data-linenumber="1114"><td class="num" id="LN1114">1114</td><td class="line">    zfree(server.rdb_pipe_buff);</td></tr>
<tr class="codeline" data-linenumber="1115"><td class="num" id="LN1115">1115</td><td class="line">    server.rdb_pipe_buff = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1116"><td class="num" id="LN1116">1116</td><td class="line">    server.rdb_pipe_bufflen = 0;</td></tr>
<tr class="codeline" data-linenumber="1117"><td class="num" id="LN1117">1117</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1118"><td class="num" id="LN1118">1118</td><td class="line">    <span class='comment'>/* Since we're avoiding to detect the child exited as long as the pipe is</span></td></tr>
<tr class="codeline" data-linenumber="1119"><td class="num" id="LN1119">1119</td><td class="line">     <span class='comment'>* not drained, so now is the time to check. */</span></td></tr>
<tr class="codeline" data-linenumber="1120"><td class="num" id="LN1120">1120</td><td class="line">    checkChildrenDone();</td></tr>
<tr class="codeline" data-linenumber="1121"><td class="num" id="LN1121">1121</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1122"><td class="num" id="LN1122">1122</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1123"><td class="num" id="LN1123">1123</td><td class="line"><span class='comment'>/* Called in diskless master, when there's data to read from the child's rdb pipe */</span></td></tr>
<tr class="codeline" data-linenumber="1124"><td class="num" id="LN1124">1124</td><td class="line"><span class='keyword'>void</span> rdbPipeReadHandler(<span class='keyword'>struct</span> aeEventLoop *eventLoop, <span class='keyword'>int</span> fd, <span class='keyword'>void</span> *clientData, <span class='keyword'>int</span> mask) {</td></tr>
<tr class="codeline" data-linenumber="1125"><td class="num" id="LN1125">1125</td><td class="line">    <span class='macro'>UNUSED(mask)<span class='macro_popup'>((void) mask)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1126"><td class="num" id="LN1126">1126</td><td class="line">    <span class='macro'>UNUSED(clientData)<span class='macro_popup'>((void) clientData)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1127"><td class="num" id="LN1127">1127</td><td class="line">    <span class='macro'>UNUSED(eventLoop)<span class='macro_popup'>((void) eventLoop)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1128"><td class="num" id="LN1128">1128</td><td class="line">    <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="1129"><td class="num" id="LN1129">1129</td><td class="line">    <span class='keyword'>if</span> (!server.rdb_pipe_buff)</td></tr>
<tr class="codeline" data-linenumber="1130"><td class="num" id="LN1130">1130</td><td class="line">        server.rdb_pipe_buff = zmalloc(<span class='macro'>PROTO_IOBUF_LEN<span class='macro_popup'>(1024*16)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1131"><td class="num" id="LN1131">1131</td><td class="line">    <span class='macro'>serverAssert(server.rdb_pipe_numconns_writing==0)<span class='macro_popup'>((server.rdb_pipe_numconns_writing==0)?(void)0 : (_serverAssert<br>("server.rdb_pipe_numconns_writing==0","replication.c",1131),<br>_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1132"><td class="num" id="LN1132">1132</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1133"><td class="num" id="LN1133">1133</td><td class="line">    <span class='keyword'>while</span> (1) {</td></tr>
<tr class="codeline" data-linenumber="1134"><td class="num" id="LN1134">1134</td><td class="line">        server.rdb_pipe_bufflen = read(fd, server.rdb_pipe_buff, <span class='macro'>PROTO_IOBUF_LEN<span class='macro_popup'>(1024*16)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1135"><td class="num" id="LN1135">1135</td><td class="line">        <span class='keyword'>if</span> (server.rdb_pipe_bufflen &lt; 0) {</td></tr>
<tr class="codeline" data-linenumber="1136"><td class="num" id="LN1136">1136</td><td class="line">            <span class='keyword'>if</span> (<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> == <span class='macro'>EAGAIN<span class='macro_popup'>11</span></span> || <span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span> == <span class='macro'>EWOULDBLOCK<span class='macro_popup'>11</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1137"><td class="num" id="LN1137">1137</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1138"><td class="num" id="LN1138">1138</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Diskless rdb transfer, read error sending DB to replicas: %s"</span>, strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="1139"><td class="num" id="LN1139">1139</td><td class="line">            <span class='keyword'>for</span> (i=0; i &lt; server.rdb_pipe_numconns; i++) {</td></tr>
<tr class="codeline" data-linenumber="1140"><td class="num" id="LN1140">1140</td><td class="line">                connection *conn = server.rdb_pipe_conns[i];</td></tr>
<tr class="codeline" data-linenumber="1141"><td class="num" id="LN1141">1141</td><td class="line">                <span class='keyword'>if</span> (!conn)</td></tr>
<tr class="codeline" data-linenumber="1142"><td class="num" id="LN1142">1142</td><td class="line">                    <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1143"><td class="num" id="LN1143">1143</td><td class="line">                client *slave = connGetPrivateData(conn);</td></tr>
<tr class="codeline" data-linenumber="1144"><td class="num" id="LN1144">1144</td><td class="line">                freeClient(slave);</td></tr>
<tr class="codeline" data-linenumber="1145"><td class="num" id="LN1145">1145</td><td class="line">                server.rdb_pipe_conns[i] = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1146"><td class="num" id="LN1146">1146</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1147"><td class="num" id="LN1147">1147</td><td class="line">            killRDBChild();</td></tr>
<tr class="codeline" data-linenumber="1148"><td class="num" id="LN1148">1148</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1149"><td class="num" id="LN1149">1149</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1150"><td class="num" id="LN1150">1150</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1151"><td class="num" id="LN1151">1151</td><td class="line">        <span class='keyword'>if</span> (server.rdb_pipe_bufflen == 0) {</td></tr>
<tr class="codeline" data-linenumber="1152"><td class="num" id="LN1152">1152</td><td class="line">            <span class='comment'>/* EOF - write end was closed. */</span></td></tr>
<tr class="codeline" data-linenumber="1153"><td class="num" id="LN1153">1153</td><td class="line">            <span class='keyword'>int</span> stillUp = 0;</td></tr>
<tr class="codeline" data-linenumber="1154"><td class="num" id="LN1154">1154</td><td class="line">            aeDeleteFileEvent(server.el, server.rdb_pipe_read, <span class='macro'>AE_READABLE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1155"><td class="num" id="LN1155">1155</td><td class="line">            <span class='keyword'>for</span> (i=0; i &lt; server.rdb_pipe_numconns; i++)</td></tr>
<tr class="codeline" data-linenumber="1156"><td class="num" id="LN1156">1156</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="1157"><td class="num" id="LN1157">1157</td><td class="line">                connection *conn = server.rdb_pipe_conns[i];</td></tr>
<tr class="codeline" data-linenumber="1158"><td class="num" id="LN1158">1158</td><td class="line">                <span class='keyword'>if</span> (!conn)</td></tr>
<tr class="codeline" data-linenumber="1159"><td class="num" id="LN1159">1159</td><td class="line">                    <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1160"><td class="num" id="LN1160">1160</td><td class="line">                stillUp++;</td></tr>
<tr class="codeline" data-linenumber="1161"><td class="num" id="LN1161">1161</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1162"><td class="num" id="LN1162">1162</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Diskless rdb transfer, done reading from pipe, %d replicas still up."</span>, stillUp);</td></tr>
<tr class="codeline" data-linenumber="1163"><td class="num" id="LN1163">1163</td><td class="line">            RdbPipeCleanup();</td></tr>
<tr class="codeline" data-linenumber="1164"><td class="num" id="LN1164">1164</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1165"><td class="num" id="LN1165">1165</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1166"><td class="num" id="LN1166">1166</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1167"><td class="num" id="LN1167">1167</td><td class="line">        <span class='keyword'>int</span> stillAlive = 0;</td></tr>
<tr class="codeline" data-linenumber="1168"><td class="num" id="LN1168">1168</td><td class="line">        <span class='keyword'>for</span> (i=0; i &lt; server.rdb_pipe_numconns; i++)</td></tr>
<tr class="codeline" data-linenumber="1169"><td class="num" id="LN1169">1169</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="1170"><td class="num" id="LN1170">1170</td><td class="line">            <span class='keyword'>int</span> nwritten;</td></tr>
<tr class="codeline" data-linenumber="1171"><td class="num" id="LN1171">1171</td><td class="line">            connection *conn = server.rdb_pipe_conns[i];</td></tr>
<tr class="codeline" data-linenumber="1172"><td class="num" id="LN1172">1172</td><td class="line">            <span class='keyword'>if</span> (!conn)</td></tr>
<tr class="codeline" data-linenumber="1173"><td class="num" id="LN1173">1173</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1174"><td class="num" id="LN1174">1174</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1175"><td class="num" id="LN1175">1175</td><td class="line">            client *slave = connGetPrivateData(conn);</td></tr>
<tr class="codeline" data-linenumber="1176"><td class="num" id="LN1176">1176</td><td class="line">            <span class='keyword'>if</span> ((nwritten = connWrite(conn, server.rdb_pipe_buff, server.rdb_pipe_bufflen)) == -1) {</td></tr>
<tr class="codeline" data-linenumber="1177"><td class="num" id="LN1177">1177</td><td class="line">                <span class='keyword'>if</span> (connGetState(conn) != CONN_STATE_CONNECTED) {</td></tr>
<tr class="codeline" data-linenumber="1178"><td class="num" id="LN1178">1178</td><td class="line">                    serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Diskless rdb transfer, write error sending DB to replica: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="1179"><td class="num" id="LN1179">1179</td><td class="line">                        connGetLastError(conn));</td></tr>
<tr class="codeline" data-linenumber="1180"><td class="num" id="LN1180">1180</td><td class="line">                    freeClient(slave);</td></tr>
<tr class="codeline" data-linenumber="1181"><td class="num" id="LN1181">1181</td><td class="line">                    server.rdb_pipe_conns[i] = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1182"><td class="num" id="LN1182">1182</td><td class="line">                    <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1183"><td class="num" id="LN1183">1183</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1184"><td class="num" id="LN1184">1184</td><td class="line">                <span class='comment'>/* An error and still in connected state, is equivalent to EAGAIN */</span></td></tr>
<tr class="codeline" data-linenumber="1185"><td class="num" id="LN1185">1185</td><td class="line">                slave-&gt;repldboff = 0;</td></tr>
<tr class="codeline" data-linenumber="1186"><td class="num" id="LN1186">1186</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1187"><td class="num" id="LN1187">1187</td><td class="line">                slave-&gt;repldboff = nwritten;</td></tr>
<tr class="codeline" data-linenumber="1188"><td class="num" id="LN1188">1188</td><td class="line">                server.stat_net_output_bytes += nwritten;</td></tr>
<tr class="codeline" data-linenumber="1189"><td class="num" id="LN1189">1189</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1190"><td class="num" id="LN1190">1190</td><td class="line">            <span class='comment'>/* If we were unable to write all the data to one of the replicas,</span></td></tr>
<tr class="codeline" data-linenumber="1191"><td class="num" id="LN1191">1191</td><td class="line">             <span class='comment'>* setup write handler (and disable pipe read handler, below) */</span></td></tr>
<tr class="codeline" data-linenumber="1192"><td class="num" id="LN1192">1192</td><td class="line">            <span class='keyword'>if</span> (nwritten != server.rdb_pipe_bufflen) {</td></tr>
<tr class="codeline" data-linenumber="1193"><td class="num" id="LN1193">1193</td><td class="line">                server.rdb_pipe_numconns_writing++;</td></tr>
<tr class="codeline" data-linenumber="1194"><td class="num" id="LN1194">1194</td><td class="line">                connSetWriteHandler(conn, rdbPipeWriteHandler);</td></tr>
<tr class="codeline" data-linenumber="1195"><td class="num" id="LN1195">1195</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1196"><td class="num" id="LN1196">1196</td><td class="line">            stillAlive++;</td></tr>
<tr class="codeline" data-linenumber="1197"><td class="num" id="LN1197">1197</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1198"><td class="num" id="LN1198">1198</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1199"><td class="num" id="LN1199">1199</td><td class="line">        <span class='keyword'>if</span> (stillAlive == 0) {</td></tr>
<tr class="codeline" data-linenumber="1200"><td class="num" id="LN1200">1200</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Diskless rdb transfer, last replica dropped, killing fork child."</span>);</td></tr>
<tr class="codeline" data-linenumber="1201"><td class="num" id="LN1201">1201</td><td class="line">            killRDBChild();</td></tr>
<tr class="codeline" data-linenumber="1202"><td class="num" id="LN1202">1202</td><td class="line">            RdbPipeCleanup();</td></tr>
<tr class="codeline" data-linenumber="1203"><td class="num" id="LN1203">1203</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1204"><td class="num" id="LN1204">1204</td><td class="line">        <span class='comment'>/*  Remove the pipe read handler if at least one write handler was set. */</span></td></tr>
<tr class="codeline" data-linenumber="1205"><td class="num" id="LN1205">1205</td><td class="line">        <span class='keyword'>if</span> (server.rdb_pipe_numconns_writing || stillAlive == 0) {</td></tr>
<tr class="codeline" data-linenumber="1206"><td class="num" id="LN1206">1206</td><td class="line">            aeDeleteFileEvent(server.el, server.rdb_pipe_read, <span class='macro'>AE_READABLE<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1207"><td class="num" id="LN1207">1207</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1208"><td class="num" id="LN1208">1208</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1209"><td class="num" id="LN1209">1209</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1210"><td class="num" id="LN1210">1210</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1211"><td class="num" id="LN1211">1211</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1212"><td class="num" id="LN1212">1212</td><td class="line"><span class='comment'>/* This function is called at the end of every background saving,</span></td></tr>
<tr class="codeline" data-linenumber="1213"><td class="num" id="LN1213">1213</td><td class="line"> <span class='comment'>* or when the replication RDB transfer strategy is modified from</span></td></tr>
<tr class="codeline" data-linenumber="1214"><td class="num" id="LN1214">1214</td><td class="line"> <span class='comment'>* disk to socket or the other way around.</span></td></tr>
<tr class="codeline" data-linenumber="1215"><td class="num" id="LN1215">1215</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1216"><td class="num" id="LN1216">1216</td><td class="line"> <span class='comment'>* The goal of this function is to handle slaves waiting for a successful</span></td></tr>
<tr class="codeline" data-linenumber="1217"><td class="num" id="LN1217">1217</td><td class="line"> <span class='comment'>* background saving in order to perform non-blocking synchronization, and</span></td></tr>
<tr class="codeline" data-linenumber="1218"><td class="num" id="LN1218">1218</td><td class="line"> <span class='comment'>* to schedule a new BGSAVE if there are slaves that attached while a</span></td></tr>
<tr class="codeline" data-linenumber="1219"><td class="num" id="LN1219">1219</td><td class="line"> <span class='comment'>* BGSAVE was in progress, but it was not a good one for replication (no</span></td></tr>
<tr class="codeline" data-linenumber="1220"><td class="num" id="LN1220">1220</td><td class="line"> <span class='comment'>* other slave was accumulating differences).</span></td></tr>
<tr class="codeline" data-linenumber="1221"><td class="num" id="LN1221">1221</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1222"><td class="num" id="LN1222">1222</td><td class="line"> <span class='comment'>* The argument bgsaveerr is C_OK if the background saving succeeded</span></td></tr>
<tr class="codeline" data-linenumber="1223"><td class="num" id="LN1223">1223</td><td class="line"> <span class='comment'>* otherwise C_ERR is passed to the function.</span></td></tr>
<tr class="codeline" data-linenumber="1224"><td class="num" id="LN1224">1224</td><td class="line"> <span class='comment'>* The 'type' argument is the type of the child that terminated</span></td></tr>
<tr class="codeline" data-linenumber="1225"><td class="num" id="LN1225">1225</td><td class="line"> <span class='comment'>* (if it had a disk or socket target). */</span></td></tr>
<tr class="codeline" data-linenumber="1226"><td class="num" id="LN1226">1226</td><td class="line"><span class='keyword'>void</span> updateSlavesWaitingBgsave(<span class='keyword'>int</span> bgsaveerr, <span class='keyword'>int</span> type) {</td></tr>
<tr class="codeline" data-linenumber="1227"><td class="num" id="LN1227">1227</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="1228"><td class="num" id="LN1228">1228</td><td class="line">    <span class='keyword'>int</span> startbgsave = 0;</td></tr>
<tr class="codeline" data-linenumber="1229"><td class="num" id="LN1229">1229</td><td class="line">    <span class='keyword'>int</span> mincapa = -1;</td></tr>
<tr class="codeline" data-linenumber="1230"><td class="num" id="LN1230">1230</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="1231"><td class="num" id="LN1231">1231</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1232"><td class="num" id="LN1232">1232</td><td class="line">    listRewind(server.slaves,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="1233"><td class="num" id="LN1233">1233</td><td class="line">    <span class='keyword'>while</span>((ln = listNext(&amp;li))) {</td></tr>
<tr class="codeline" data-linenumber="1234"><td class="num" id="LN1234">1234</td><td class="line">        client *slave = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="1235"><td class="num" id="LN1235">1235</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1236"><td class="num" id="LN1236">1236</td><td class="line">        <span class='keyword'>if</span> (slave-&gt;replstate == <span class='macro'>SLAVE_STATE_WAIT_BGSAVE_START<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1237"><td class="num" id="LN1237">1237</td><td class="line">            startbgsave = 1;</td></tr>
<tr class="codeline" data-linenumber="1238"><td class="num" id="LN1238">1238</td><td class="line">            mincapa = (mincapa == -1) ? slave-&gt;slave_capa :</td></tr>
<tr class="codeline" data-linenumber="1239"><td class="num" id="LN1239">1239</td><td class="line">                                        (mincapa &amp; slave-&gt;slave_capa);</td></tr>
<tr class="codeline" data-linenumber="1240"><td class="num" id="LN1240">1240</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (slave-&gt;replstate == <span class='macro'>SLAVE_STATE_WAIT_BGSAVE_END<span class='macro_popup'>7</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1241"><td class="num" id="LN1241">1241</td><td class="line">            <span class='keyword'>struct</span> <span class='macro'>redis_stat<span class='macro_popup'>stat</span></span> buf;</td></tr>
<tr class="codeline" data-linenumber="1242"><td class="num" id="LN1242">1242</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1243"><td class="num" id="LN1243">1243</td><td class="line">            <span class='keyword'>if</span> (bgsaveerr != <span class='macro'>C_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1244"><td class="num" id="LN1244">1244</td><td class="line">                freeClient(slave);</td></tr>
<tr class="codeline" data-linenumber="1245"><td class="num" id="LN1245">1245</td><td class="line">                serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"SYNC failed. BGSAVE child returned an error"</span>);</td></tr>
<tr class="codeline" data-linenumber="1246"><td class="num" id="LN1246">1246</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1247"><td class="num" id="LN1247">1247</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1248"><td class="num" id="LN1248">1248</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1249"><td class="num" id="LN1249">1249</td><td class="line">            <span class='comment'>/* If this was an RDB on disk save, we have to prepare to send</span></td></tr>
<tr class="codeline" data-linenumber="1250"><td class="num" id="LN1250">1250</td><td class="line">             <span class='comment'>* the RDB from disk to the slave socket. Otherwise if this was</span></td></tr>
<tr class="codeline" data-linenumber="1251"><td class="num" id="LN1251">1251</td><td class="line">             <span class='comment'>* already an RDB -&gt; Slaves socket transfer, used in the case of</span></td></tr>
<tr class="codeline" data-linenumber="1252"><td class="num" id="LN1252">1252</td><td class="line">             <span class='comment'>* diskless replication, our work is trivial, we can just put</span></td></tr>
<tr class="codeline" data-linenumber="1253"><td class="num" id="LN1253">1253</td><td class="line">             <span class='comment'>* the slave online. */</span></td></tr>
<tr class="codeline" data-linenumber="1254"><td class="num" id="LN1254">1254</td><td class="line">            <span class='keyword'>if</span> (type == <span class='macro'>RDB_CHILD_TYPE_SOCKET<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1255"><td class="num" id="LN1255">1255</td><td class="line">                serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1256"><td class="num" id="LN1256">1256</td><td class="line">                    <span class='string_literal'>"Streamed RDB transfer with replica %s succeeded (socket). Waiting for REPLCONF ACK from slave to enable streaming"</span>,</td></tr>
<tr class="codeline" data-linenumber="1257"><td class="num" id="LN1257">1257</td><td class="line">                        replicationGetSlaveName(slave));</td></tr>
<tr class="codeline" data-linenumber="1258"><td class="num" id="LN1258">1258</td><td class="line">                <span class='comment'>/* Note: we wait for a REPLCONF ACK message from the replica in</span></td></tr>
<tr class="codeline" data-linenumber="1259"><td class="num" id="LN1259">1259</td><td class="line">                 <span class='comment'>* order to really put it online (install the write handler</span></td></tr>
<tr class="codeline" data-linenumber="1260"><td class="num" id="LN1260">1260</td><td class="line">                 <span class='comment'>* so that the accumulated data can be transferred). However</span></td></tr>
<tr class="codeline" data-linenumber="1261"><td class="num" id="LN1261">1261</td><td class="line">                 <span class='comment'>* we change the replication state ASAP, since our slave</span></td></tr>
<tr class="codeline" data-linenumber="1262"><td class="num" id="LN1262">1262</td><td class="line">                 <span class='comment'>* is technically online now.</span></td></tr>
<tr class="codeline" data-linenumber="1263"><td class="num" id="LN1263">1263</td><td class="line">                 <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1264"><td class="num" id="LN1264">1264</td><td class="line">                 <span class='comment'>* So things work like that:</span></td></tr>
<tr class="codeline" data-linenumber="1265"><td class="num" id="LN1265">1265</td><td class="line">                 <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1266"><td class="num" id="LN1266">1266</td><td class="line">                 <span class='comment'>* 1. We end trasnferring the RDB file via socket.</span></td></tr>
<tr class="codeline" data-linenumber="1267"><td class="num" id="LN1267">1267</td><td class="line">                 <span class='comment'>* 2. The replica is put ONLINE but the write handler</span></td></tr>
<tr class="codeline" data-linenumber="1268"><td class="num" id="LN1268">1268</td><td class="line">                 <span class='comment'>*    is not installed.</span></td></tr>
<tr class="codeline" data-linenumber="1269"><td class="num" id="LN1269">1269</td><td class="line">                 <span class='comment'>* 3. The replica however goes really online, and pings us</span></td></tr>
<tr class="codeline" data-linenumber="1270"><td class="num" id="LN1270">1270</td><td class="line">                 <span class='comment'>*    back via REPLCONF ACK commands.</span></td></tr>
<tr class="codeline" data-linenumber="1271"><td class="num" id="LN1271">1271</td><td class="line">                 <span class='comment'>* 4. Now we finally install the write handler, and send</span></td></tr>
<tr class="codeline" data-linenumber="1272"><td class="num" id="LN1272">1272</td><td class="line">                 <span class='comment'>*    the buffers accumulated so far to the replica.</span></td></tr>
<tr class="codeline" data-linenumber="1273"><td class="num" id="LN1273">1273</td><td class="line">                 <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1274"><td class="num" id="LN1274">1274</td><td class="line">                 <span class='comment'>* But why we do that? Because the replica, when we stream</span></td></tr>
<tr class="codeline" data-linenumber="1275"><td class="num" id="LN1275">1275</td><td class="line">                 <span class='comment'>* the RDB directly via the socket, must detect the RDB</span></td></tr>
<tr class="codeline" data-linenumber="1276"><td class="num" id="LN1276">1276</td><td class="line">                 <span class='comment'>* EOF (end of file), that is a special random string at the</span></td></tr>
<tr class="codeline" data-linenumber="1277"><td class="num" id="LN1277">1277</td><td class="line">                 <span class='comment'>* end of the RDB (for streamed RDBs we don't know the length</span></td></tr>
<tr class="codeline" data-linenumber="1278"><td class="num" id="LN1278">1278</td><td class="line">                 <span class='comment'>* in advance). Detecting such final EOF string is much</span></td></tr>
<tr class="codeline" data-linenumber="1279"><td class="num" id="LN1279">1279</td><td class="line">                 <span class='comment'>* simpler and less CPU intensive if no more data is sent</span></td></tr>
<tr class="codeline" data-linenumber="1280"><td class="num" id="LN1280">1280</td><td class="line">                 <span class='comment'>* after such final EOF. So we don't want to glue the end of</span></td></tr>
<tr class="codeline" data-linenumber="1281"><td class="num" id="LN1281">1281</td><td class="line">                 <span class='comment'>* the RDB trasfer with the start of the other replication</span></td></tr>
<tr class="codeline" data-linenumber="1282"><td class="num" id="LN1282">1282</td><td class="line">                 <span class='comment'>* data. */</span></td></tr>
<tr class="codeline" data-linenumber="1283"><td class="num" id="LN1283">1283</td><td class="line">                slave-&gt;replstate = <span class='macro'>SLAVE_STATE_ONLINE<span class='macro_popup'>9</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1284"><td class="num" id="LN1284">1284</td><td class="line">                slave-&gt;repl_put_online_on_ack = 1;</td></tr>
<tr class="codeline" data-linenumber="1285"><td class="num" id="LN1285">1285</td><td class="line">                slave-&gt;repl_ack_time = server.unixtime; <span class='comment'>/* Timeout otherwise. */</span></td></tr>
<tr class="codeline" data-linenumber="1286"><td class="num" id="LN1286">1286</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1287"><td class="num" id="LN1287">1287</td><td class="line">                <span class='keyword'>if</span> ((slave-&gt;repldbfd = open(server.rdb_filename,<span class='macro'>O_RDONLY<span class='macro_popup'>00</span></span>)) == -1 ||</td></tr>
<tr class="codeline" data-linenumber="1288"><td class="num" id="LN1288">1288</td><td class="line">                    <span class='macro'>redis_fstat<span class='macro_popup'>fstat</span></span>(slave-&gt;repldbfd,&amp;buf) == -1) {</td></tr>
<tr class="codeline" data-linenumber="1289"><td class="num" id="LN1289">1289</td><td class="line">                    freeClient(slave);</td></tr>
<tr class="codeline" data-linenumber="1290"><td class="num" id="LN1290">1290</td><td class="line">                    serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"SYNC failed. Can't open/stat DB after BGSAVE: %s"</span>, strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="1291"><td class="num" id="LN1291">1291</td><td class="line">                    <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1292"><td class="num" id="LN1292">1292</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1293"><td class="num" id="LN1293">1293</td><td class="line">                slave-&gt;repldboff = 0;</td></tr>
<tr class="codeline" data-linenumber="1294"><td class="num" id="LN1294">1294</td><td class="line">                slave-&gt;repldbsize = buf.st_size;</td></tr>
<tr class="codeline" data-linenumber="1295"><td class="num" id="LN1295">1295</td><td class="line">                slave-&gt;replstate = <span class='macro'>SLAVE_STATE_SEND_BULK<span class='macro_popup'>8</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1296"><td class="num" id="LN1296">1296</td><td class="line">                slave-&gt;replpreamble = sdscatprintf(sdsempty(),<span class='string_literal'>"$%lld\r\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="1297"><td class="num" id="LN1297">1297</td><td class="line">                    (<span class='keyword'>unsigned</span> <span class='keyword'>long</span> <span class='keyword'>long</span>) slave-&gt;repldbsize);</td></tr>
<tr class="codeline" data-linenumber="1298"><td class="num" id="LN1298">1298</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1299"><td class="num" id="LN1299">1299</td><td class="line">                connSetWriteHandler(slave-&gt;conn,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1300"><td class="num" id="LN1300">1300</td><td class="line">                <span class='keyword'>if</span> (connSetWriteHandler(slave-&gt;conn,sendBulkToSlave) == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1301"><td class="num" id="LN1301">1301</td><td class="line">                    freeClient(slave);</td></tr>
<tr class="codeline" data-linenumber="1302"><td class="num" id="LN1302">1302</td><td class="line">                    <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="1303"><td class="num" id="LN1303">1303</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1304"><td class="num" id="LN1304">1304</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1305"><td class="num" id="LN1305">1305</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1306"><td class="num" id="LN1306">1306</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1307"><td class="num" id="LN1307">1307</td><td class="line">    <span class='keyword'>if</span> (startbgsave) startBgsaveForReplication(mincapa);</td></tr>
<tr class="codeline" data-linenumber="1308"><td class="num" id="LN1308">1308</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1309"><td class="num" id="LN1309">1309</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1310"><td class="num" id="LN1310">1310</td><td class="line"><span class='comment'>/* Change the current instance replication ID with a new, random one.</span></td></tr>
<tr class="codeline" data-linenumber="1311"><td class="num" id="LN1311">1311</td><td class="line"> <span class='comment'>* This will prevent successful PSYNCs between this master and other</span></td></tr>
<tr class="codeline" data-linenumber="1312"><td class="num" id="LN1312">1312</td><td class="line"> <span class='comment'>* slaves, so the command should be called when something happens that</span></td></tr>
<tr class="codeline" data-linenumber="1313"><td class="num" id="LN1313">1313</td><td class="line"> <span class='comment'>* alters the current story of the dataset. */</span></td></tr>
<tr class="codeline" data-linenumber="1314"><td class="num" id="LN1314">1314</td><td class="line"><span class='keyword'>void</span> changeReplicationId(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1315"><td class="num" id="LN1315">1315</td><td class="line">    getRandomHexChars(server.replid,<span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1316"><td class="num" id="LN1316">1316</td><td class="line">    server.replid[<span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>] = '\0';</td></tr>
<tr class="codeline" data-linenumber="1317"><td class="num" id="LN1317">1317</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1318"><td class="num" id="LN1318">1318</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1319"><td class="num" id="LN1319">1319</td><td class="line"><span class='comment'>/* Clear (invalidate) the secondary replication ID. This happens, for</span></td></tr>
<tr class="codeline" data-linenumber="1320"><td class="num" id="LN1320">1320</td><td class="line"> <span class='comment'>* example, after a full resynchronization, when we start a new replication</span></td></tr>
<tr class="codeline" data-linenumber="1321"><td class="num" id="LN1321">1321</td><td class="line"> <span class='comment'>* history. */</span></td></tr>
<tr class="codeline" data-linenumber="1322"><td class="num" id="LN1322">1322</td><td class="line"><span class='keyword'>void</span> clearReplicationId2(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1323"><td class="num" id="LN1323">1323</td><td class="line">    memset(server.replid2,'0',<span class='keyword'>sizeof</span>(server.replid));</td></tr>
<tr class="codeline" data-linenumber="1324"><td class="num" id="LN1324">1324</td><td class="line">    server.replid2[<span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>] = '\0';</td></tr>
<tr class="codeline" data-linenumber="1325"><td class="num" id="LN1325">1325</td><td class="line">    server.second_replid_offset = -1;</td></tr>
<tr class="codeline" data-linenumber="1326"><td class="num" id="LN1326">1326</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1327"><td class="num" id="LN1327">1327</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1328"><td class="num" id="LN1328">1328</td><td class="line"><span class='comment'>/* Use the current replication ID / offset as secondary replication</span></td></tr>
<tr class="codeline" data-linenumber="1329"><td class="num" id="LN1329">1329</td><td class="line"> <span class='comment'>* ID, and change the current one in order to start a new history.</span></td></tr>
<tr class="codeline" data-linenumber="1330"><td class="num" id="LN1330">1330</td><td class="line"> <span class='comment'>* This should be used when an instance is switched from slave to master</span></td></tr>
<tr class="codeline" data-linenumber="1331"><td class="num" id="LN1331">1331</td><td class="line"> <span class='comment'>* so that it can serve PSYNC requests performed using the master</span></td></tr>
<tr class="codeline" data-linenumber="1332"><td class="num" id="LN1332">1332</td><td class="line"> <span class='comment'>* replication ID. */</span></td></tr>
<tr class="codeline" data-linenumber="1333"><td class="num" id="LN1333">1333</td><td class="line"><span class='keyword'>void</span> shiftReplicationId(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1334"><td class="num" id="LN1334">1334</td><td class="line">    memcpy(server.replid2,server.replid,<span class='keyword'>sizeof</span>(server.replid));</td></tr>
<tr class="codeline" data-linenumber="1335"><td class="num" id="LN1335">1335</td><td class="line">    <span class='comment'>/* We set the second replid offset to the master offset + 1, since</span></td></tr>
<tr class="codeline" data-linenumber="1336"><td class="num" id="LN1336">1336</td><td class="line">     <span class='comment'>* the slave will ask for the first byte it has not yet received, so</span></td></tr>
<tr class="codeline" data-linenumber="1337"><td class="num" id="LN1337">1337</td><td class="line">     <span class='comment'>* we need to add one to the offset: for example if, as a slave, we are</span></td></tr>
<tr class="codeline" data-linenumber="1338"><td class="num" id="LN1338">1338</td><td class="line">     <span class='comment'>* sure we have the same history as the master for 50 bytes, after we</span></td></tr>
<tr class="codeline" data-linenumber="1339"><td class="num" id="LN1339">1339</td><td class="line">     <span class='comment'>* are turned into a master, we can accept a PSYNC request with offset</span></td></tr>
<tr class="codeline" data-linenumber="1340"><td class="num" id="LN1340">1340</td><td class="line">     <span class='comment'>* 51, since the slave asking has the same history up to the 50th</span></td></tr>
<tr class="codeline" data-linenumber="1341"><td class="num" id="LN1341">1341</td><td class="line">     <span class='comment'>* byte, and is asking for the new bytes starting at offset 51. */</span></td></tr>
<tr class="codeline" data-linenumber="1342"><td class="num" id="LN1342">1342</td><td class="line">    server.second_replid_offset = server.master_repl_offset+1;</td></tr>
<tr class="codeline" data-linenumber="1343"><td class="num" id="LN1343">1343</td><td class="line">    changeReplicationId();</td></tr>
<tr class="codeline" data-linenumber="1344"><td class="num" id="LN1344">1344</td><td class="line">    serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Setting secondary replication ID to %s, valid up to offset: %lld. New replication ID is %s"</span>, server.replid2, server.second_replid_offset, server.replid);</td></tr>
<tr class="codeline" data-linenumber="1345"><td class="num" id="LN1345">1345</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1346"><td class="num" id="LN1346">1346</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1347"><td class="num" id="LN1347">1347</td><td class="line"><span class='comment'>/* ----------------------------------- SLAVE -------------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="1348"><td class="num" id="LN1348">1348</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1349"><td class="num" id="LN1349">1349</td><td class="line"><span class='comment'>/* Returns 1 if the given replication state is a handshake state,</span></td></tr>
<tr class="codeline" data-linenumber="1350"><td class="num" id="LN1350">1350</td><td class="line"> <span class='comment'>* 0 otherwise. */</span></td></tr>
<tr class="codeline" data-linenumber="1351"><td class="num" id="LN1351">1351</td><td class="line"><span class='keyword'>int</span> slaveIsInHandshakeState(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1352"><td class="num" id="LN1352">1352</td><td class="line">    <span class='keyword'>return</span> server.repl_state &gt;= <span class='macro'>REPL_STATE_RECEIVE_PONG<span class='macro_popup'>3</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1353"><td class="num" id="LN1353">1353</td><td class="line">           server.repl_state &lt;= <span class='macro'>REPL_STATE_RECEIVE_PSYNC<span class='macro_popup'>13</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1354"><td class="num" id="LN1354">1354</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1355"><td class="num" id="LN1355">1355</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1356"><td class="num" id="LN1356">1356</td><td class="line"><span class='comment'>/* Avoid the master to detect the slave is timing out while loading the</span></td></tr>
<tr class="codeline" data-linenumber="1357"><td class="num" id="LN1357">1357</td><td class="line"> <span class='comment'>* RDB file in initial synchronization. We send a single newline character</span></td></tr>
<tr class="codeline" data-linenumber="1358"><td class="num" id="LN1358">1358</td><td class="line"> <span class='comment'>* that is valid protocol but is guaranteed to either be sent entirely or</span></td></tr>
<tr class="codeline" data-linenumber="1359"><td class="num" id="LN1359">1359</td><td class="line"> <span class='comment'>* not, since the byte is indivisible.</span></td></tr>
<tr class="codeline" data-linenumber="1360"><td class="num" id="LN1360">1360</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1361"><td class="num" id="LN1361">1361</td><td class="line"> <span class='comment'>* The function is called in two contexts: while we flush the current</span></td></tr>
<tr class="codeline" data-linenumber="1362"><td class="num" id="LN1362">1362</td><td class="line"> <span class='comment'>* data with emptyDb(), and while we load the new data received as an</span></td></tr>
<tr class="codeline" data-linenumber="1363"><td class="num" id="LN1363">1363</td><td class="line"> <span class='comment'>* RDB file from the master. */</span></td></tr>
<tr class="codeline" data-linenumber="1364"><td class="num" id="LN1364">1364</td><td class="line"><span class='keyword'>void</span> replicationSendNewlineToMaster(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1365"><td class="num" id="LN1365">1365</td><td class="line">    <span class='keyword'>static</span> time_t newline_sent;</td></tr>
<tr class="codeline" data-linenumber="1366"><td class="num" id="LN1366">1366</td><td class="line">    <span class='keyword'>if</span> (time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) != newline_sent) {</td></tr>
<tr class="codeline" data-linenumber="1367"><td class="num" id="LN1367">1367</td><td class="line">        newline_sent = time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1368"><td class="num" id="LN1368">1368</td><td class="line">        <span class='comment'>/* Pinging back in this stage is best-effort. */</span></td></tr>
<tr class="codeline" data-linenumber="1369"><td class="num" id="LN1369">1369</td><td class="line">        <span class='keyword'>if</span> (server.repl_transfer_s) connWrite(server.repl_transfer_s, <span class='string_literal'>"\n"</span>, 1);</td></tr>
<tr class="codeline" data-linenumber="1370"><td class="num" id="LN1370">1370</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1371"><td class="num" id="LN1371">1371</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1372"><td class="num" id="LN1372">1372</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1373"><td class="num" id="LN1373">1373</td><td class="line"><span class='comment'>/* Callback used by emptyDb() while flushing away old data to load</span></td></tr>
<tr class="codeline" data-linenumber="1374"><td class="num" id="LN1374">1374</td><td class="line"> <span class='comment'>* the new dataset received by the master. */</span></td></tr>
<tr class="codeline" data-linenumber="1375"><td class="num" id="LN1375">1375</td><td class="line"><span class='keyword'>void</span> replicationEmptyDbCallback(<span class='keyword'>void</span> *privdata) {</td></tr>
<tr class="codeline" data-linenumber="1376"><td class="num" id="LN1376">1376</td><td class="line">    <span class='macro'>UNUSED(privdata)<span class='macro_popup'>((void) privdata)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1377"><td class="num" id="LN1377">1377</td><td class="line">    <span class='keyword'>if</span> (server.repl_state == <span class='macro'>REPL_STATE_TRANSFER<span class='macro_popup'>14</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1378"><td class="num" id="LN1378">1378</td><td class="line">        replicationSendNewlineToMaster();</td></tr>
<tr class="codeline" data-linenumber="1379"><td class="num" id="LN1379">1379</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1380"><td class="num" id="LN1380">1380</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1381"><td class="num" id="LN1381">1381</td><td class="line"><span class='comment'>/* Once we have a link with the master and the synchronization was</span></td></tr>
<tr class="codeline" data-linenumber="1382"><td class="num" id="LN1382">1382</td><td class="line"> <span class='comment'>* performed, this function materializes the master client we store</span></td></tr>
<tr class="codeline" data-linenumber="1383"><td class="num" id="LN1383">1383</td><td class="line"> <span class='comment'>* at server.master, starting from the specified file descriptor. */</span></td></tr>
<tr class="codeline" data-linenumber="1384"><td class="num" id="LN1384">1384</td><td class="line"><span class='keyword'>void</span> replicationCreateMasterClient(connection *conn, <span class='keyword'>int</span> dbid) {</td></tr>
<tr class="codeline" data-linenumber="1385"><td class="num" id="LN1385">1385</td><td class="line">    server.master = createClient(conn);</td></tr>
<tr class="codeline" data-linenumber="1386"><td class="num" id="LN1386">1386</td><td class="line">    <span class='keyword'>if</span> (conn)</td></tr>
<tr class="codeline" data-linenumber="1387"><td class="num" id="LN1387">1387</td><td class="line">        connSetReadHandler(server.master-&gt;conn, readQueryFromClient);</td></tr>
<tr class="codeline" data-linenumber="1388"><td class="num" id="LN1388">1388</td><td class="line">    server.master-&gt;flags |= <span class='macro'>CLIENT_MASTER<span class='macro_popup'>(1&lt;&lt;1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1389"><td class="num" id="LN1389">1389</td><td class="line">    server.master-&gt;authenticated = 1;</td></tr>
<tr class="codeline" data-linenumber="1390"><td class="num" id="LN1390">1390</td><td class="line">    server.master-&gt;reploff = server.master_initial_offset;</td></tr>
<tr class="codeline" data-linenumber="1391"><td class="num" id="LN1391">1391</td><td class="line">    server.master-&gt;read_reploff = server.master-&gt;reploff;</td></tr>
<tr class="codeline" data-linenumber="1392"><td class="num" id="LN1392">1392</td><td class="line">    server.master-&gt;user = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>; <span class='comment'>/* This client can do everything. */</span></td></tr>
<tr class="codeline" data-linenumber="1393"><td class="num" id="LN1393">1393</td><td class="line">    memcpy(server.master-&gt;replid, server.master_replid,</td></tr>
<tr class="codeline" data-linenumber="1394"><td class="num" id="LN1394">1394</td><td class="line">        <span class='keyword'>sizeof</span>(server.master_replid));</td></tr>
<tr class="codeline" data-linenumber="1395"><td class="num" id="LN1395">1395</td><td class="line">    <span class='comment'>/* If master offset is set to -1, this master is old and is not</span></td></tr>
<tr class="codeline" data-linenumber="1396"><td class="num" id="LN1396">1396</td><td class="line">     <span class='comment'>* PSYNC capable, so we flag it accordingly. */</span></td></tr>
<tr class="codeline" data-linenumber="1397"><td class="num" id="LN1397">1397</td><td class="line">    <span class='keyword'>if</span> (server.master-&gt;reploff == -1)</td></tr>
<tr class="codeline" data-linenumber="1398"><td class="num" id="LN1398">1398</td><td class="line">        server.master-&gt;flags |= <span class='macro'>CLIENT_PRE_PSYNC<span class='macro_popup'>(1&lt;&lt;16)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1399"><td class="num" id="LN1399">1399</td><td class="line">    <span class='keyword'>if</span> (dbid != -1) selectDb(server.master,dbid);</td></tr>
<tr class="codeline" data-linenumber="1400"><td class="num" id="LN1400">1400</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1401"><td class="num" id="LN1401">1401</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1402"><td class="num" id="LN1402">1402</td><td class="line"><span class='comment'>/* This function will try to re-enable the AOF file after the</span></td></tr>
<tr class="codeline" data-linenumber="1403"><td class="num" id="LN1403">1403</td><td class="line"> <span class='comment'>* master-replica synchronization: if it fails after multiple attempts</span></td></tr>
<tr class="codeline" data-linenumber="1404"><td class="num" id="LN1404">1404</td><td class="line"> <span class='comment'>* the replica cannot be considered reliable and exists with an</span></td></tr>
<tr class="codeline" data-linenumber="1405"><td class="num" id="LN1405">1405</td><td class="line"> <span class='comment'>* error. */</span></td></tr>
<tr class="codeline" data-linenumber="1406"><td class="num" id="LN1406">1406</td><td class="line"><span class='keyword'>void</span> restartAOFAfterSYNC() {</td></tr>
<tr class="codeline" data-linenumber="1407"><td class="num" id="LN1407">1407</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> tries, max_tries = 10;</td></tr>
<tr class="codeline" data-linenumber="1408"><td class="num" id="LN1408">1408</td><td class="line">    <span class='keyword'>for</span> (tries = 0; tries &lt; max_tries; ++tries) {</td></tr>
<tr class="codeline" data-linenumber="1409"><td class="num" id="LN1409">1409</td><td class="line">        <span class='keyword'>if</span> (startAppendOnly() == <span class='macro'>C_OK<span class='macro_popup'>0</span></span>) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1410"><td class="num" id="LN1410">1410</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1411"><td class="num" id="LN1411">1411</td><td class="line">            <span class='string_literal'>"Failed enabling the AOF after successful master synchronization! "</span></td></tr>
<tr class="codeline" data-linenumber="1412"><td class="num" id="LN1412">1412</td><td class="line">            <span class='string_literal'>"Trying it again in one second."</span>);</td></tr>
<tr class="codeline" data-linenumber="1413"><td class="num" id="LN1413">1413</td><td class="line">        sleep(1);</td></tr>
<tr class="codeline" data-linenumber="1414"><td class="num" id="LN1414">1414</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1415"><td class="num" id="LN1415">1415</td><td class="line">    <span class='keyword'>if</span> (tries == max_tries) {</td></tr>
<tr class="codeline" data-linenumber="1416"><td class="num" id="LN1416">1416</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1417"><td class="num" id="LN1417">1417</td><td class="line">            <span class='string_literal'>"FATAL: this replica instance finished the synchronization with "</span></td></tr>
<tr class="codeline" data-linenumber="1418"><td class="num" id="LN1418">1418</td><td class="line">            <span class='string_literal'>"its master, but the AOF can't be turned on. Exiting now."</span>);</td></tr>
<tr class="codeline" data-linenumber="1419"><td class="num" id="LN1419">1419</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="1420"><td class="num" id="LN1420">1420</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1421"><td class="num" id="LN1421">1421</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1422"><td class="num" id="LN1422">1422</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1423"><td class="num" id="LN1423">1423</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> useDisklessLoad() {</td></tr>
<tr class="codeline" data-linenumber="1424"><td class="num" id="LN1424">1424</td><td class="line">    <span class='comment'>/* compute boolean decision to use diskless load */</span></td></tr>
<tr class="codeline" data-linenumber="1425"><td class="num" id="LN1425">1425</td><td class="line">    <span class='keyword'>int</span> enabled = server.repl_diskless_load == <span class='macro'>REPL_DISKLESS_LOAD_SWAPDB<span class='macro_popup'>2</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="1426"><td class="num" id="LN1426">1426</td><td class="line">           (server.repl_diskless_load == <span class='macro'>REPL_DISKLESS_LOAD_WHEN_DB_EMPTY<span class='macro_popup'>1</span></span> &amp;&amp; dbTotalServerKeyCount()==0);</td></tr>
<tr class="codeline" data-linenumber="1427"><td class="num" id="LN1427">1427</td><td class="line">    <span class='comment'>/* Check all modules handle read errors, otherwise it's not safe to use diskless load. */</span></td></tr>
<tr class="codeline" data-linenumber="1428"><td class="num" id="LN1428">1428</td><td class="line">    <span class='keyword'>if</span> (enabled &amp;&amp; !moduleAllDatatypesHandleErrors()) {</td></tr>
<tr class="codeline" data-linenumber="1429"><td class="num" id="LN1429">1429</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1430"><td class="num" id="LN1430">1430</td><td class="line">            <span class='string_literal'>"Skipping diskless-load because there are modules that don't handle read errors."</span>);</td></tr>
<tr class="codeline" data-linenumber="1431"><td class="num" id="LN1431">1431</td><td class="line">        enabled = 0;</td></tr>
<tr class="codeline" data-linenumber="1432"><td class="num" id="LN1432">1432</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1433"><td class="num" id="LN1433">1433</td><td class="line">    <span class='keyword'>return</span> enabled;</td></tr>
<tr class="codeline" data-linenumber="1434"><td class="num" id="LN1434">1434</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1435"><td class="num" id="LN1435">1435</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1436"><td class="num" id="LN1436">1436</td><td class="line"><span class='comment'>/* Helper function for readSyncBulkPayload() to make backups of the current</span></td></tr>
<tr class="codeline" data-linenumber="1437"><td class="num" id="LN1437">1437</td><td class="line"> <span class='comment'>* DBs before socket-loading the new ones. The backups may be restored later</span></td></tr>
<tr class="codeline" data-linenumber="1438"><td class="num" id="LN1438">1438</td><td class="line"> <span class='comment'>* or freed by disklessLoadRestoreBackups(). */</span></td></tr>
<tr class="codeline" data-linenumber="1439"><td class="num" id="LN1439">1439</td><td class="line">redisDb *disklessLoadMakeBackups(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1440"><td class="num" id="LN1440">1440</td><td class="line">    redisDb *backups = zmalloc(<span class='keyword'>sizeof</span>(redisDb)*server.dbnum);</td></tr>
<tr class="codeline" data-linenumber="1441"><td class="num" id="LN1441">1441</td><td class="line">    <span class='keyword'>for</span> (<span class='keyword'>int</span> i=0; i&lt;server.dbnum; i++) {</td></tr>
<tr class="codeline" data-linenumber="1442"><td class="num" id="LN1442">1442</td><td class="line">        backups[i] = server.db[i];</td></tr>
<tr class="codeline" data-linenumber="1443"><td class="num" id="LN1443">1443</td><td class="line">        server.db[i].dict = dictCreate(&amp;dbDictType,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1444"><td class="num" id="LN1444">1444</td><td class="line">        server.db[i].expires = dictCreate(&amp;keyptrDictType,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1445"><td class="num" id="LN1445">1445</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1446"><td class="num" id="LN1446">1446</td><td class="line">    <span class='keyword'>return</span> backups;</td></tr>
<tr class="codeline" data-linenumber="1447"><td class="num" id="LN1447">1447</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1448"><td class="num" id="LN1448">1448</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1449"><td class="num" id="LN1449">1449</td><td class="line"><span class='comment'>/* Helper function for readSyncBulkPayload(): when replica-side diskless</span></td></tr>
<tr class="codeline" data-linenumber="1450"><td class="num" id="LN1450">1450</td><td class="line"> <span class='comment'>* database loading is used, Redis makes a backup of the existing databases</span></td></tr>
<tr class="codeline" data-linenumber="1451"><td class="num" id="LN1451">1451</td><td class="line"> <span class='comment'>* before loading the new ones from the socket.</span></td></tr>
<tr class="codeline" data-linenumber="1452"><td class="num" id="LN1452">1452</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1453"><td class="num" id="LN1453">1453</td><td class="line"> <span class='comment'>* If the socket loading went wrong, we want to restore the old backups</span></td></tr>
<tr class="codeline" data-linenumber="1454"><td class="num" id="LN1454">1454</td><td class="line"> <span class='comment'>* into the server databases. This function does just that in the case</span></td></tr>
<tr class="codeline" data-linenumber="1455"><td class="num" id="LN1455">1455</td><td class="line"> <span class='comment'>* the 'restore' argument (the number of DBs to replace) is non-zero.</span></td></tr>
<tr class="codeline" data-linenumber="1456"><td class="num" id="LN1456">1456</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1457"><td class="num" id="LN1457">1457</td><td class="line"> <span class='comment'>* When instead the loading succeeded we want just to free our old backups,</span></td></tr>
<tr class="codeline" data-linenumber="1458"><td class="num" id="LN1458">1458</td><td class="line"> <span class='comment'>* in that case the function will do just that when 'restore' is 0. */</span></td></tr>
<tr class="codeline" data-linenumber="1459"><td class="num" id="LN1459">1459</td><td class="line"><span class='keyword'>void</span> disklessLoadRestoreBackups(redisDb *backup, <span class='keyword'>int</span> restore, <span class='keyword'>int</span> empty_db_flags)</td></tr>
<tr class="codeline" data-linenumber="1460"><td class="num" id="LN1460">1460</td><td class="line">{</td></tr>
<tr class="codeline" data-linenumber="1461"><td class="num" id="LN1461">1461</td><td class="line">    <span class='keyword'>if</span> (restore) {</td></tr>
<tr class="codeline" data-linenumber="1462"><td class="num" id="LN1462">1462</td><td class="line">        <span class='comment'>/* Restore. */</span></td></tr>
<tr class="codeline" data-linenumber="1463"><td class="num" id="LN1463">1463</td><td class="line">        emptyDbGeneric(server.db,-1,empty_db_flags,replicationEmptyDbCallback);</td></tr>
<tr class="codeline" data-linenumber="1464"><td class="num" id="LN1464">1464</td><td class="line">        <span class='keyword'>for</span> (<span class='keyword'>int</span> i=0; i&lt;server.dbnum; i++) {</td></tr>
<tr class="codeline" data-linenumber="1465"><td class="num" id="LN1465">1465</td><td class="line">            dictRelease(server.db[i].dict);</td></tr>
<tr class="codeline" data-linenumber="1466"><td class="num" id="LN1466">1466</td><td class="line">            dictRelease(server.db[i].expires);</td></tr>
<tr class="codeline" data-linenumber="1467"><td class="num" id="LN1467">1467</td><td class="line">            server.db[i] = backup[i];</td></tr>
<tr class="codeline" data-linenumber="1468"><td class="num" id="LN1468">1468</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1469"><td class="num" id="LN1469">1469</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1470"><td class="num" id="LN1470">1470</td><td class="line">        <span class='comment'>/* Delete (Pass EMPTYDB_BACKUP in order to avoid firing module events) . */</span></td></tr>
<tr class="codeline" data-linenumber="1471"><td class="num" id="LN1471">1471</td><td class="line">        emptyDbGeneric(backup,-1,empty_db_flags|<span class='macro'>EMPTYDB_BACKUP<span class='macro_popup'>(1&lt;&lt;2)</span></span>,replicationEmptyDbCallback);</td></tr>
<tr class="codeline" data-linenumber="1472"><td class="num" id="LN1472">1472</td><td class="line">        <span class='keyword'>for</span> (<span class='keyword'>int</span> i=0; i&lt;server.dbnum; i++) {</td></tr>
<tr class="codeline" data-linenumber="1473"><td class="num" id="LN1473">1473</td><td class="line">            dictRelease(backup[i].dict);</td></tr>
<tr class="codeline" data-linenumber="1474"><td class="num" id="LN1474">1474</td><td class="line">            dictRelease(backup[i].expires);</td></tr>
<tr class="codeline" data-linenumber="1475"><td class="num" id="LN1475">1475</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1476"><td class="num" id="LN1476">1476</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1477"><td class="num" id="LN1477">1477</td><td class="line">    zfree(backup);</td></tr>
<tr class="codeline" data-linenumber="1478"><td class="num" id="LN1478">1478</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1479"><td class="num" id="LN1479">1479</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1480"><td class="num" id="LN1480">1480</td><td class="line"><span class='comment'>/* Asynchronously read the SYNC payload we receive from a master */</span></td></tr>
<tr class="codeline" data-linenumber="1481"><td class="num" id="LN1481">1481</td><td class="line"><span class='directive'>#define <span class='macro'>REPL_MAX_WRITTEN_BEFORE_FSYNC<span class='macro_popup'>(1024*1024*8)</span></span> (1024*1024*8) /* 8 MB */</span></td></tr>
<tr class="codeline" data-linenumber="1482"><td class="num" id="LN1482">1482</td><td class="line"><span class='keyword'>void</span> readSyncBulkPayload(connection *conn) {</td></tr>
<tr class="codeline" data-linenumber="1483"><td class="num" id="LN1483">1483</td><td class="line">    <span class='keyword'>char</span> buf[<span class='macro'>PROTO_IOBUF_LEN<span class='macro_popup'>(1024*16)</span></span>];</td></tr>
<tr class="codeline" data-linenumber="1484"><td class="num" id="LN1484">1484</td><td class="line">    ssize_t nread, readlen, nwritten;</td></tr>
<tr class="codeline" data-linenumber="1485"><td class="num" id="LN1485">1485</td><td class="line">    <span class='keyword'>int</span> use_diskless_load = useDisklessLoad();</td></tr>
<tr class="codeline" data-linenumber="1486"><td class="num" id="LN1486">1486</td><td class="line">    redisDb *diskless_load_backup = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1487"><td class="num" id="LN1487">1487</td><td class="line">    <span class='keyword'>int</span> empty_db_flags = server.repl_slave_lazy_flush ? <span class='macro'>EMPTYDB_ASYNC<span class='macro_popup'>(1&lt;&lt;0)</span></span> :</td></tr>
<tr class="codeline" data-linenumber="1488"><td class="num" id="LN1488">1488</td><td class="line">                                                        <span class='macro'>EMPTYDB_NO_FLAGS<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1489"><td class="num" id="LN1489">1489</td><td class="line">    off_t left;</td></tr>
<tr class="codeline" data-linenumber="1490"><td class="num" id="LN1490">1490</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1491"><td class="num" id="LN1491">1491</td><td class="line">    <span class='comment'>/* Static vars used to hold the EOF mark, and the last bytes received</span></td></tr>
<tr class="codeline" data-linenumber="1492"><td class="num" id="LN1492">1492</td><td class="line">     <span class='comment'>* from the server: when they match, we reached the end of the transfer. */</span></td></tr>
<tr class="codeline" data-linenumber="1493"><td class="num" id="LN1493">1493</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>char</span> eofmark[<span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>];</td></tr>
<tr class="codeline" data-linenumber="1494"><td class="num" id="LN1494">1494</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>char</span> lastbytes[<span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>];</td></tr>
<tr class="codeline" data-linenumber="1495"><td class="num" id="LN1495">1495</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>int</span> usemark = 0;</td></tr>
<tr class="codeline" data-linenumber="1496"><td class="num" id="LN1496">1496</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1497"><td class="num" id="LN1497">1497</td><td class="line">    <span class='comment'>/* If repl_transfer_size == -1 we still have to read the bulk length</span></td></tr>
<tr class="codeline" data-linenumber="1498"><td class="num" id="LN1498">1498</td><td class="line">     <span class='comment'>* from the master reply. */</span></td></tr>
<tr class="codeline" data-linenumber="1499"><td class="num" id="LN1499">1499</td><td class="line">    <span class='keyword'>if</span> (server.repl_transfer_size == -1) {</td></tr>
<tr class="codeline" data-linenumber="1500"><td class="num" id="LN1500">1500</td><td class="line">        <span class='keyword'>if</span> (connSyncReadLine(conn,buf,1024,server.repl_syncio_timeout*1000) == -1) {</td></tr>
<tr class="codeline" data-linenumber="1501"><td class="num" id="LN1501">1501</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1502"><td class="num" id="LN1502">1502</td><td class="line">                <span class='string_literal'>"I/O error reading bulk count from MASTER: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="1503"><td class="num" id="LN1503">1503</td><td class="line">                strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="1504"><td class="num" id="LN1504">1504</td><td class="line">            <span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="1505"><td class="num" id="LN1505">1505</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1506"><td class="num" id="LN1506">1506</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1507"><td class="num" id="LN1507">1507</td><td class="line">        <span class='keyword'>if</span> (buf[0] == '-') {</td></tr>
<tr class="codeline" data-linenumber="1508"><td class="num" id="LN1508">1508</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1509"><td class="num" id="LN1509">1509</td><td class="line">                <span class='string_literal'>"MASTER aborted replication with an error: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="1510"><td class="num" id="LN1510">1510</td><td class="line">                buf+1);</td></tr>
<tr class="codeline" data-linenumber="1511"><td class="num" id="LN1511">1511</td><td class="line">            <span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="1512"><td class="num" id="LN1512">1512</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (buf[0] == '\0') {</td></tr>
<tr class="codeline" data-linenumber="1513"><td class="num" id="LN1513">1513</td><td class="line">            <span class='comment'>/* At this stage just a newline works as a PING in order to take</span></td></tr>
<tr class="codeline" data-linenumber="1514"><td class="num" id="LN1514">1514</td><td class="line">             <span class='comment'>* the connection live. So we refresh our last interaction</span></td></tr>
<tr class="codeline" data-linenumber="1515"><td class="num" id="LN1515">1515</td><td class="line">             <span class='comment'>* timestamp. */</span></td></tr>
<tr class="codeline" data-linenumber="1516"><td class="num" id="LN1516">1516</td><td class="line">            server.repl_transfer_lastio = server.unixtime;</td></tr>
<tr class="codeline" data-linenumber="1517"><td class="num" id="LN1517">1517</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1518"><td class="num" id="LN1518">1518</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (buf[0] != '$') {</td></tr>
<tr class="codeline" data-linenumber="1519"><td class="num" id="LN1519">1519</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Bad protocol from MASTER, the first byte is not '$' (we received '%s'), are you sure the host and port are right?"</span>, buf);</td></tr>
<tr class="codeline" data-linenumber="1520"><td class="num" id="LN1520">1520</td><td class="line">            <span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="1521"><td class="num" id="LN1521">1521</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1522"><td class="num" id="LN1522">1522</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1523"><td class="num" id="LN1523">1523</td><td class="line">        <span class='comment'>/* There are two possible forms for the bulk payload. One is the</span></td></tr>
<tr class="codeline" data-linenumber="1524"><td class="num" id="LN1524">1524</td><td class="line">         <span class='comment'>* usual $&lt;count&gt; bulk format. The other is used for diskless transfers</span></td></tr>
<tr class="codeline" data-linenumber="1525"><td class="num" id="LN1525">1525</td><td class="line">         <span class='comment'>* when the master does not know beforehand the size of the file to</span></td></tr>
<tr class="codeline" data-linenumber="1526"><td class="num" id="LN1526">1526</td><td class="line">         <span class='comment'>* transfer. In the latter case, the following format is used:</span></td></tr>
<tr class="codeline" data-linenumber="1527"><td class="num" id="LN1527">1527</td><td class="line">         <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1528"><td class="num" id="LN1528">1528</td><td class="line">         <span class='comment'>* $EOF:&lt;40 bytes delimiter&gt;</span></td></tr>
<tr class="codeline" data-linenumber="1529"><td class="num" id="LN1529">1529</td><td class="line">         <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1530"><td class="num" id="LN1530">1530</td><td class="line">         <span class='comment'>* At the end of the file the announced delimiter is transmitted. The</span></td></tr>
<tr class="codeline" data-linenumber="1531"><td class="num" id="LN1531">1531</td><td class="line">         <span class='comment'>* delimiter is long and random enough that the probability of a</span></td></tr>
<tr class="codeline" data-linenumber="1532"><td class="num" id="LN1532">1532</td><td class="line">         <span class='comment'>* collision with the actual file content can be ignored. */</span></td></tr>
<tr class="codeline" data-linenumber="1533"><td class="num" id="LN1533">1533</td><td class="line">        <span class='keyword'>if</span> (strncmp(buf+1,<span class='string_literal'>"EOF:"</span>,4) == 0 &amp;&amp; strlen(buf+5) &gt;= <span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1534"><td class="num" id="LN1534">1534</td><td class="line">            usemark = 1;</td></tr>
<tr class="codeline" data-linenumber="1535"><td class="num" id="LN1535">1535</td><td class="line">            memcpy(eofmark,buf+5,<span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1536"><td class="num" id="LN1536">1536</td><td class="line">            memset(lastbytes,0,<span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1537"><td class="num" id="LN1537">1537</td><td class="line">            <span class='comment'>/* Set any repl_transfer_size to avoid entering this code path</span></td></tr>
<tr class="codeline" data-linenumber="1538"><td class="num" id="LN1538">1538</td><td class="line">             <span class='comment'>* at the next call. */</span></td></tr>
<tr class="codeline" data-linenumber="1539"><td class="num" id="LN1539">1539</td><td class="line">            server.repl_transfer_size = 0;</td></tr>
<tr class="codeline" data-linenumber="1540"><td class="num" id="LN1540">1540</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1541"><td class="num" id="LN1541">1541</td><td class="line">                <span class='string_literal'>"MASTER &lt;-&gt; REPLICA sync: receiving streamed RDB from master with EOF %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="1542"><td class="num" id="LN1542">1542</td><td class="line">                use_diskless_load? <span class='string_literal'>"to parser"</span>:<span class='string_literal'>"to disk"</span>);</td></tr>
<tr class="codeline" data-linenumber="1543"><td class="num" id="LN1543">1543</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1544"><td class="num" id="LN1544">1544</td><td class="line">            usemark = 0;</td></tr>
<tr class="codeline" data-linenumber="1545"><td class="num" id="LN1545">1545</td><td class="line">            server.repl_transfer_size = strtol(buf+1,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,10);</td></tr>
<tr class="codeline" data-linenumber="1546"><td class="num" id="LN1546">1546</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1547"><td class="num" id="LN1547">1547</td><td class="line">                <span class='string_literal'>"MASTER &lt;-&gt; REPLICA sync: receiving %lld bytes from master %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="1548"><td class="num" id="LN1548">1548</td><td class="line">                (<span class='keyword'>long</span> <span class='keyword'>long</span>) server.repl_transfer_size,</td></tr>
<tr class="codeline" data-linenumber="1549"><td class="num" id="LN1549">1549</td><td class="line">                use_diskless_load? <span class='string_literal'>"to parser"</span>:<span class='string_literal'>"to disk"</span>);</td></tr>
<tr class="codeline" data-linenumber="1550"><td class="num" id="LN1550">1550</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1551"><td class="num" id="LN1551">1551</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1552"><td class="num" id="LN1552">1552</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1553"><td class="num" id="LN1553">1553</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1554"><td class="num" id="LN1554">1554</td><td class="line">    <span class='keyword'>if</span> (!use_diskless_load) {</td></tr>
<tr class="codeline" data-linenumber="1555"><td class="num" id="LN1555">1555</td><td class="line">        <span class='comment'>/* Read the data from the socket, store it to a file and search</span></td></tr>
<tr class="codeline" data-linenumber="1556"><td class="num" id="LN1556">1556</td><td class="line">         <span class='comment'>* for the EOF. */</span></td></tr>
<tr class="codeline" data-linenumber="1557"><td class="num" id="LN1557">1557</td><td class="line">        <span class='keyword'>if</span> (usemark) {</td></tr>
<tr class="codeline" data-linenumber="1558"><td class="num" id="LN1558">1558</td><td class="line">            readlen = <span class='keyword'>sizeof</span>(buf);</td></tr>
<tr class="codeline" data-linenumber="1559"><td class="num" id="LN1559">1559</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1560"><td class="num" id="LN1560">1560</td><td class="line">            left = server.repl_transfer_size - server.repl_transfer_read;</td></tr>
<tr class="codeline" data-linenumber="1561"><td class="num" id="LN1561">1561</td><td class="line">            readlen = (left &lt; (<span class='keyword'>signed</span>)<span class='keyword'>sizeof</span>(buf)) ? left : (<span class='keyword'>signed</span>)<span class='keyword'>sizeof</span>(buf);</td></tr>
<tr class="codeline" data-linenumber="1562"><td class="num" id="LN1562">1562</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1563"><td class="num" id="LN1563">1563</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1564"><td class="num" id="LN1564">1564</td><td class="line">        nread = connRead(conn,buf,readlen);</td></tr>
<tr class="codeline" data-linenumber="1565"><td class="num" id="LN1565">1565</td><td class="line">        <span class='keyword'>if</span> (nread &lt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="1566"><td class="num" id="LN1566">1566</td><td class="line">            <span class='keyword'>if</span> (connGetState(conn) == CONN_STATE_CONNECTED) {</td></tr>
<tr class="codeline" data-linenumber="1567"><td class="num" id="LN1567">1567</td><td class="line">                <span class='comment'>/* equivalent to EAGAIN */</span></td></tr>
<tr class="codeline" data-linenumber="1568"><td class="num" id="LN1568">1568</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1569"><td class="num" id="LN1569">1569</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1570"><td class="num" id="LN1570">1570</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"I/O error trying to sync with MASTER: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="1571"><td class="num" id="LN1571">1571</td><td class="line">                (nread == -1) ? strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>) : <span class='string_literal'>"connection lost"</span>);</td></tr>
<tr class="codeline" data-linenumber="1572"><td class="num" id="LN1572">1572</td><td class="line">            cancelReplicationHandshake();</td></tr>
<tr class="codeline" data-linenumber="1573"><td class="num" id="LN1573">1573</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1574"><td class="num" id="LN1574">1574</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1575"><td class="num" id="LN1575">1575</td><td class="line">        server.stat_net_input_bytes += nread;</td></tr>
<tr class="codeline" data-linenumber="1576"><td class="num" id="LN1576">1576</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1577"><td class="num" id="LN1577">1577</td><td class="line">        <span class='comment'>/* When a mark is used, we want to detect EOF asap in order to avoid</span></td></tr>
<tr class="codeline" data-linenumber="1578"><td class="num" id="LN1578">1578</td><td class="line">         <span class='comment'>* writing the EOF mark into the file... */</span></td></tr>
<tr class="codeline" data-linenumber="1579"><td class="num" id="LN1579">1579</td><td class="line">        <span class='keyword'>int</span> eof_reached = 0;</td></tr>
<tr class="codeline" data-linenumber="1580"><td class="num" id="LN1580">1580</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1581"><td class="num" id="LN1581">1581</td><td class="line">        <span class='keyword'>if</span> (usemark) {</td></tr>
<tr class="codeline" data-linenumber="1582"><td class="num" id="LN1582">1582</td><td class="line">            <span class='comment'>/* Update the last bytes array, and check if it matches our</span></td></tr>
<tr class="codeline" data-linenumber="1583"><td class="num" id="LN1583">1583</td><td class="line">             <span class='comment'>* delimiter. */</span></td></tr>
<tr class="codeline" data-linenumber="1584"><td class="num" id="LN1584">1584</td><td class="line">            <span class='keyword'>if</span> (nread &gt;= <span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1585"><td class="num" id="LN1585">1585</td><td class="line">                <span class="mrange">memcpy</span>(lastbytes,buf+nread-<span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>,</td></tr>
<tr><td class="num"></td><td class="line"><div id="EndPath" class="msg msgEvent" style="margin-left:17ex; max-width:58em">Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11</div></td></tr>
<tr class="codeline" data-linenumber="1586"><td class="num" id="LN1586">1586</td><td class="line">                       <span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1587"><td class="num" id="LN1587">1587</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1588"><td class="num" id="LN1588">1588</td><td class="line">                <span class='keyword'>int</span> rem = <span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>-nread;</td></tr>
<tr class="codeline" data-linenumber="1589"><td class="num" id="LN1589">1589</td><td class="line">                memmove(lastbytes,lastbytes+nread,rem);</td></tr>
<tr class="codeline" data-linenumber="1590"><td class="num" id="LN1590">1590</td><td class="line">                memcpy(lastbytes+rem,buf,nread);</td></tr>
<tr class="codeline" data-linenumber="1591"><td class="num" id="LN1591">1591</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1592"><td class="num" id="LN1592">1592</td><td class="line">            <span class='keyword'>if</span> (memcmp(lastbytes,eofmark,<span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>) == 0)</td></tr>
<tr class="codeline" data-linenumber="1593"><td class="num" id="LN1593">1593</td><td class="line">                eof_reached = 1;</td></tr>
<tr class="codeline" data-linenumber="1594"><td class="num" id="LN1594">1594</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1595"><td class="num" id="LN1595">1595</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1596"><td class="num" id="LN1596">1596</td><td class="line">        <span class='comment'>/* Update the last I/O time for the replication transfer (used in</span></td></tr>
<tr class="codeline" data-linenumber="1597"><td class="num" id="LN1597">1597</td><td class="line">         <span class='comment'>* order to detect timeouts during replication), and write what we</span></td></tr>
<tr class="codeline" data-linenumber="1598"><td class="num" id="LN1598">1598</td><td class="line">         <span class='comment'>* got from the socket to the dump file on disk. */</span></td></tr>
<tr class="codeline" data-linenumber="1599"><td class="num" id="LN1599">1599</td><td class="line">        server.repl_transfer_lastio = server.unixtime;</td></tr>
<tr class="codeline" data-linenumber="1600"><td class="num" id="LN1600">1600</td><td class="line">        <span class='keyword'>if</span> ((nwritten = write(server.repl_transfer_fd,buf,nread)) != nread) {</td></tr>
<tr class="codeline" data-linenumber="1601"><td class="num" id="LN1601">1601</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1602"><td class="num" id="LN1602">1602</td><td class="line">                <span class='string_literal'>"Write error or short write writing to the DB dump file "</span></td></tr>
<tr class="codeline" data-linenumber="1603"><td class="num" id="LN1603">1603</td><td class="line">                <span class='string_literal'>"needed for MASTER &lt;-&gt; REPLICA synchronization: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="1604"><td class="num" id="LN1604">1604</td><td class="line">                (nwritten == -1) ? strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>) : <span class='string_literal'>"short write"</span>);</td></tr>
<tr class="codeline" data-linenumber="1605"><td class="num" id="LN1605">1605</td><td class="line">            <span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="1606"><td class="num" id="LN1606">1606</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1607"><td class="num" id="LN1607">1607</td><td class="line">        server.repl_transfer_read += nread;</td></tr>
<tr class="codeline" data-linenumber="1608"><td class="num" id="LN1608">1608</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1609"><td class="num" id="LN1609">1609</td><td class="line">        <span class='comment'>/* Delete the last 40 bytes from the file if we reached EOF. */</span></td></tr>
<tr class="codeline" data-linenumber="1610"><td class="num" id="LN1610">1610</td><td class="line">        <span class='keyword'>if</span> (usemark &amp;&amp; eof_reached) {</td></tr>
<tr class="codeline" data-linenumber="1611"><td class="num" id="LN1611">1611</td><td class="line">            <span class='keyword'>if</span> (ftruncate(server.repl_transfer_fd,</td></tr>
<tr class="codeline" data-linenumber="1612"><td class="num" id="LN1612">1612</td><td class="line">                server.repl_transfer_read - <span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>) == -1)</td></tr>
<tr class="codeline" data-linenumber="1613"><td class="num" id="LN1613">1613</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="1614"><td class="num" id="LN1614">1614</td><td class="line">                serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1615"><td class="num" id="LN1615">1615</td><td class="line">                    <span class='string_literal'>"Error truncating the RDB file received from the master "</span></td></tr>
<tr class="codeline" data-linenumber="1616"><td class="num" id="LN1616">1616</td><td class="line">                    <span class='string_literal'>"for SYNC: %s"</span>, strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="1617"><td class="num" id="LN1617">1617</td><td class="line">                <span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="1618"><td class="num" id="LN1618">1618</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1619"><td class="num" id="LN1619">1619</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1620"><td class="num" id="LN1620">1620</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1621"><td class="num" id="LN1621">1621</td><td class="line">        <span class='comment'>/* Sync data on disk from time to time, otherwise at the end of the</span></td></tr>
<tr class="codeline" data-linenumber="1622"><td class="num" id="LN1622">1622</td><td class="line">         <span class='comment'>* transfer we may suffer a big delay as the memory buffers are copied</span></td></tr>
<tr class="codeline" data-linenumber="1623"><td class="num" id="LN1623">1623</td><td class="line">         <span class='comment'>* into the actual disk. */</span></td></tr>
<tr class="codeline" data-linenumber="1624"><td class="num" id="LN1624">1624</td><td class="line">        <span class='keyword'>if</span> (server.repl_transfer_read &gt;=</td></tr>
<tr class="codeline" data-linenumber="1625"><td class="num" id="LN1625">1625</td><td class="line">            server.repl_transfer_last_fsync_off + <span class='macro'>REPL_MAX_WRITTEN_BEFORE_FSYNC<span class='macro_popup'>(1024*1024*8)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1626"><td class="num" id="LN1626">1626</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="1627"><td class="num" id="LN1627">1627</td><td class="line">            off_t sync_size = server.repl_transfer_read -</td></tr>
<tr class="codeline" data-linenumber="1628"><td class="num" id="LN1628">1628</td><td class="line">                              server.repl_transfer_last_fsync_off;</td></tr>
<tr class="codeline" data-linenumber="1629"><td class="num" id="LN1629">1629</td><td class="line">            <span class='macro'>rdb_fsync_range(server.repl_transfer_fd,<span class='macro_popup'>sync_file_range(server.repl_transfer_fd,server.repl_transfer_last_fsync_off<br>,sync_size,1|2)</span></span></td></tr>
<tr class="codeline" data-linenumber="1630"><td class="num" id="LN1630">1630</td><td class="line">                <span class='macro'>server.repl_transfer_last_fsync_off, sync_size)<span class='macro_popup'>sync_file_range(server.repl_transfer_fd,server.repl_transfer_last_fsync_off<br>,sync_size,1|2)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1631"><td class="num" id="LN1631">1631</td><td class="line">            server.repl_transfer_last_fsync_off += sync_size;</td></tr>
<tr class="codeline" data-linenumber="1632"><td class="num" id="LN1632">1632</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1633"><td class="num" id="LN1633">1633</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1634"><td class="num" id="LN1634">1634</td><td class="line">        <span class='comment'>/* Check if the transfer is now complete */</span></td></tr>
<tr class="codeline" data-linenumber="1635"><td class="num" id="LN1635">1635</td><td class="line">        <span class='keyword'>if</span> (!usemark) {</td></tr>
<tr class="codeline" data-linenumber="1636"><td class="num" id="LN1636">1636</td><td class="line">            <span class='keyword'>if</span> (server.repl_transfer_read == server.repl_transfer_size)</td></tr>
<tr class="codeline" data-linenumber="1637"><td class="num" id="LN1637">1637</td><td class="line">                eof_reached = 1;</td></tr>
<tr class="codeline" data-linenumber="1638"><td class="num" id="LN1638">1638</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1639"><td class="num" id="LN1639">1639</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1640"><td class="num" id="LN1640">1640</td><td class="line">        <span class='comment'>/* If the transfer is yet not complete, we need to read more, so</span></td></tr>
<tr class="codeline" data-linenumber="1641"><td class="num" id="LN1641">1641</td><td class="line">         <span class='comment'>* return ASAP and wait for the handler to be called again. */</span></td></tr>
<tr class="codeline" data-linenumber="1642"><td class="num" id="LN1642">1642</td><td class="line">        <span class='keyword'>if</span> (!eof_reached) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1643"><td class="num" id="LN1643">1643</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1644"><td class="num" id="LN1644">1644</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1645"><td class="num" id="LN1645">1645</td><td class="line">    <span class='comment'>/* We reach this point in one of the following cases:</span></td></tr>
<tr class="codeline" data-linenumber="1646"><td class="num" id="LN1646">1646</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1647"><td class="num" id="LN1647">1647</td><td class="line">     <span class='comment'>* 1. The replica is using diskless replication, that is, it reads data</span></td></tr>
<tr class="codeline" data-linenumber="1648"><td class="num" id="LN1648">1648</td><td class="line">     <span class='comment'>*    directly from the socket to the Redis memory, without using</span></td></tr>
<tr class="codeline" data-linenumber="1649"><td class="num" id="LN1649">1649</td><td class="line">     <span class='comment'>*    a temporary RDB file on disk. In that case we just block and</span></td></tr>
<tr class="codeline" data-linenumber="1650"><td class="num" id="LN1650">1650</td><td class="line">     <span class='comment'>*    read everything from the socket.</span></td></tr>
<tr class="codeline" data-linenumber="1651"><td class="num" id="LN1651">1651</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1652"><td class="num" id="LN1652">1652</td><td class="line">     <span class='comment'>* 2. Or when we are done reading from the socket to the RDB file, in</span></td></tr>
<tr class="codeline" data-linenumber="1653"><td class="num" id="LN1653">1653</td><td class="line">     <span class='comment'>*    such case we want just to read the RDB file in memory. */</span></td></tr>
<tr class="codeline" data-linenumber="1654"><td class="num" id="LN1654">1654</td><td class="line">    serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>, <span class='string_literal'>"MASTER &lt;-&gt; REPLICA sync: Flushing old data"</span>);</td></tr>
<tr class="codeline" data-linenumber="1655"><td class="num" id="LN1655">1655</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1656"><td class="num" id="LN1656">1656</td><td class="line">    <span class='comment'>/* We need to stop any AOF rewriting child before flusing and parsing</span></td></tr>
<tr class="codeline" data-linenumber="1657"><td class="num" id="LN1657">1657</td><td class="line">     <span class='comment'>* the RDB, otherwise we'll create a copy-on-write disaster. */</span></td></tr>
<tr class="codeline" data-linenumber="1658"><td class="num" id="LN1658">1658</td><td class="line">    <span class='keyword'>if</span> (server.aof_state != <span class='macro'>AOF_OFF<span class='macro_popup'>0</span></span>) stopAppendOnly();</td></tr>
<tr class="codeline" data-linenumber="1659"><td class="num" id="LN1659">1659</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1660"><td class="num" id="LN1660">1660</td><td class="line">    <span class='comment'>/* When diskless RDB loading is used by replicas, it may be configured</span></td></tr>
<tr class="codeline" data-linenumber="1661"><td class="num" id="LN1661">1661</td><td class="line">     <span class='comment'>* in order to save the current DB instead of throwing it away,</span></td></tr>
<tr class="codeline" data-linenumber="1662"><td class="num" id="LN1662">1662</td><td class="line">     <span class='comment'>* so that we can restore it in case of failed transfer. */</span></td></tr>
<tr class="codeline" data-linenumber="1663"><td class="num" id="LN1663">1663</td><td class="line">    <span class='keyword'>if</span> (use_diskless_load &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1664"><td class="num" id="LN1664">1664</td><td class="line">        server.repl_diskless_load == <span class='macro'>REPL_DISKLESS_LOAD_SWAPDB<span class='macro_popup'>2</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1665"><td class="num" id="LN1665">1665</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1666"><td class="num" id="LN1666">1666</td><td class="line">        <span class='comment'>/* Create a backup of server.db[] and initialize to empty</span></td></tr>
<tr class="codeline" data-linenumber="1667"><td class="num" id="LN1667">1667</td><td class="line">         <span class='comment'>* dictionaries */</span></td></tr>
<tr class="codeline" data-linenumber="1668"><td class="num" id="LN1668">1668</td><td class="line">        diskless_load_backup = disklessLoadMakeBackups();</td></tr>
<tr class="codeline" data-linenumber="1669"><td class="num" id="LN1669">1669</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1670"><td class="num" id="LN1670">1670</td><td class="line">    <span class='comment'>/* We call to emptyDb even in case of REPL_DISKLESS_LOAD_SWAPDB</span></td></tr>
<tr class="codeline" data-linenumber="1671"><td class="num" id="LN1671">1671</td><td class="line">     <span class='comment'>* (Where disklessLoadMakeBackups left server.db empty) because we</span></td></tr>
<tr class="codeline" data-linenumber="1672"><td class="num" id="LN1672">1672</td><td class="line">     <span class='comment'>* want to execute all the auxiliary logic of emptyDb (Namely,</span></td></tr>
<tr class="codeline" data-linenumber="1673"><td class="num" id="LN1673">1673</td><td class="line">     <span class='comment'>* fire module events) */</span></td></tr>
<tr class="codeline" data-linenumber="1674"><td class="num" id="LN1674">1674</td><td class="line">    emptyDb(-1,empty_db_flags,replicationEmptyDbCallback);</td></tr>
<tr class="codeline" data-linenumber="1675"><td class="num" id="LN1675">1675</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1676"><td class="num" id="LN1676">1676</td><td class="line">    <span class='comment'>/* Before loading the DB into memory we need to delete the readable</span></td></tr>
<tr class="codeline" data-linenumber="1677"><td class="num" id="LN1677">1677</td><td class="line">     <span class='comment'>* handler, otherwise it will get called recursively since</span></td></tr>
<tr class="codeline" data-linenumber="1678"><td class="num" id="LN1678">1678</td><td class="line">     <span class='comment'>* rdbLoad() will call the event loop to process events from time to</span></td></tr>
<tr class="codeline" data-linenumber="1679"><td class="num" id="LN1679">1679</td><td class="line">     <span class='comment'>* time for non blocking loading. */</span></td></tr>
<tr class="codeline" data-linenumber="1680"><td class="num" id="LN1680">1680</td><td class="line">    connSetReadHandler(conn, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1681"><td class="num" id="LN1681">1681</td><td class="line">    serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>, <span class='string_literal'>"MASTER &lt;-&gt; REPLICA sync: Loading DB in memory"</span>);</td></tr>
<tr class="codeline" data-linenumber="1682"><td class="num" id="LN1682">1682</td><td class="line">    rdbSaveInfo rsi = <span class='macro'>RDB_SAVE_INFO_INIT<span class='macro_popup'>{-1,0,"000000000000000000000000000000",-1}</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1683"><td class="num" id="LN1683">1683</td><td class="line">    <span class='keyword'>if</span> (use_diskless_load) {</td></tr>
<tr class="codeline" data-linenumber="1684"><td class="num" id="LN1684">1684</td><td class="line">        rio rdb;</td></tr>
<tr class="codeline" data-linenumber="1685"><td class="num" id="LN1685">1685</td><td class="line">        rioInitWithConn(&amp;rdb,conn,server.repl_transfer_size);</td></tr>
<tr class="codeline" data-linenumber="1686"><td class="num" id="LN1686">1686</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1687"><td class="num" id="LN1687">1687</td><td class="line">        <span class='comment'>/* Put the socket in blocking mode to simplify RDB transfer.</span></td></tr>
<tr class="codeline" data-linenumber="1688"><td class="num" id="LN1688">1688</td><td class="line">         <span class='comment'>* We'll restore it when the RDB is received. */</span></td></tr>
<tr class="codeline" data-linenumber="1689"><td class="num" id="LN1689">1689</td><td class="line">        connBlock(conn);</td></tr>
<tr class="codeline" data-linenumber="1690"><td class="num" id="LN1690">1690</td><td class="line">        connRecvTimeout(conn, server.repl_timeout*1000);</td></tr>
<tr class="codeline" data-linenumber="1691"><td class="num" id="LN1691">1691</td><td class="line">        startLoading(server.repl_transfer_size, <span class='macro'>RDBFLAGS_REPLICATION<span class='macro_popup'>(1&lt;&lt;1)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1692"><td class="num" id="LN1692">1692</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1693"><td class="num" id="LN1693">1693</td><td class="line">        <span class='keyword'>if</span> (rdbLoadRio(&amp;rdb,<span class='macro'>RDBFLAGS_REPLICATION<span class='macro_popup'>(1&lt;&lt;1)</span></span>,&amp;rsi) != <span class='macro'>C_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1694"><td class="num" id="LN1694">1694</td><td class="line">            <span class='comment'>/* RDB loading failed. */</span></td></tr>
<tr class="codeline" data-linenumber="1695"><td class="num" id="LN1695">1695</td><td class="line">            stopLoading(0);</td></tr>
<tr class="codeline" data-linenumber="1696"><td class="num" id="LN1696">1696</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1697"><td class="num" id="LN1697">1697</td><td class="line">                <span class='string_literal'>"Failed trying to load the MASTER synchronization DB "</span></td></tr>
<tr class="codeline" data-linenumber="1698"><td class="num" id="LN1698">1698</td><td class="line">                <span class='string_literal'>"from socket"</span>);</td></tr>
<tr class="codeline" data-linenumber="1699"><td class="num" id="LN1699">1699</td><td class="line">            cancelReplicationHandshake();</td></tr>
<tr class="codeline" data-linenumber="1700"><td class="num" id="LN1700">1700</td><td class="line">            rioFreeConn(&amp;rdb, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1701"><td class="num" id="LN1701">1701</td><td class="line">            <span class='keyword'>if</span> (server.repl_diskless_load == <span class='macro'>REPL_DISKLESS_LOAD_SWAPDB<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1702"><td class="num" id="LN1702">1702</td><td class="line">                <span class='comment'>/* Restore the backed up databases. */</span></td></tr>
<tr class="codeline" data-linenumber="1703"><td class="num" id="LN1703">1703</td><td class="line">                disklessLoadRestoreBackups(diskless_load_backup,1,</td></tr>
<tr class="codeline" data-linenumber="1704"><td class="num" id="LN1704">1704</td><td class="line">                                           empty_db_flags);</td></tr>
<tr class="codeline" data-linenumber="1705"><td class="num" id="LN1705">1705</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1706"><td class="num" id="LN1706">1706</td><td class="line">                <span class='comment'>/* Remove the half-loaded data in case we started with</span></td></tr>
<tr class="codeline" data-linenumber="1707"><td class="num" id="LN1707">1707</td><td class="line">                 <span class='comment'>* an empty replica. */</span></td></tr>
<tr class="codeline" data-linenumber="1708"><td class="num" id="LN1708">1708</td><td class="line">                emptyDb(-1,empty_db_flags,replicationEmptyDbCallback);</td></tr>
<tr class="codeline" data-linenumber="1709"><td class="num" id="LN1709">1709</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1710"><td class="num" id="LN1710">1710</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1711"><td class="num" id="LN1711">1711</td><td class="line">            <span class='comment'>/* Note that there's no point in restarting the AOF on SYNC</span></td></tr>
<tr class="codeline" data-linenumber="1712"><td class="num" id="LN1712">1712</td><td class="line">             <span class='comment'>* failure, it'll be restarted when sync succeeds or the replica</span></td></tr>
<tr class="codeline" data-linenumber="1713"><td class="num" id="LN1713">1713</td><td class="line">             <span class='comment'>* gets promoted. */</span></td></tr>
<tr class="codeline" data-linenumber="1714"><td class="num" id="LN1714">1714</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1715"><td class="num" id="LN1715">1715</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1716"><td class="num" id="LN1716">1716</td><td class="line">        stopLoading(1);</td></tr>
<tr class="codeline" data-linenumber="1717"><td class="num" id="LN1717">1717</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1718"><td class="num" id="LN1718">1718</td><td class="line">        <span class='comment'>/* RDB loading succeeded if we reach this point. */</span></td></tr>
<tr class="codeline" data-linenumber="1719"><td class="num" id="LN1719">1719</td><td class="line">        <span class='keyword'>if</span> (server.repl_diskless_load == <span class='macro'>REPL_DISKLESS_LOAD_SWAPDB<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1720"><td class="num" id="LN1720">1720</td><td class="line">            <span class='comment'>/* Delete the backup databases we created before starting to load</span></td></tr>
<tr class="codeline" data-linenumber="1721"><td class="num" id="LN1721">1721</td><td class="line">             <span class='comment'>* the new RDB. Now the RDB was loaded with success so the old</span></td></tr>
<tr class="codeline" data-linenumber="1722"><td class="num" id="LN1722">1722</td><td class="line">             <span class='comment'>* data is useless. */</span></td></tr>
<tr class="codeline" data-linenumber="1723"><td class="num" id="LN1723">1723</td><td class="line">            disklessLoadRestoreBackups(diskless_load_backup,0,empty_db_flags);</td></tr>
<tr class="codeline" data-linenumber="1724"><td class="num" id="LN1724">1724</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1725"><td class="num" id="LN1725">1725</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1726"><td class="num" id="LN1726">1726</td><td class="line">        <span class='comment'>/* Verify the end mark is correct. */</span></td></tr>
<tr class="codeline" data-linenumber="1727"><td class="num" id="LN1727">1727</td><td class="line">        <span class='keyword'>if</span> (usemark) {</td></tr>
<tr class="codeline" data-linenumber="1728"><td class="num" id="LN1728">1728</td><td class="line">            <span class='keyword'>if</span> (!rioRead(&amp;rdb,buf,<span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>) ||</td></tr>
<tr class="codeline" data-linenumber="1729"><td class="num" id="LN1729">1729</td><td class="line">                memcmp(buf,eofmark,<span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>) != 0)</td></tr>
<tr class="codeline" data-linenumber="1730"><td class="num" id="LN1730">1730</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="1731"><td class="num" id="LN1731">1731</td><td class="line">                serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Replication stream EOF marker is broken"</span>);</td></tr>
<tr class="codeline" data-linenumber="1732"><td class="num" id="LN1732">1732</td><td class="line">                cancelReplicationHandshake();</td></tr>
<tr class="codeline" data-linenumber="1733"><td class="num" id="LN1733">1733</td><td class="line">                rioFreeConn(&amp;rdb, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1734"><td class="num" id="LN1734">1734</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1735"><td class="num" id="LN1735">1735</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1736"><td class="num" id="LN1736">1736</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1737"><td class="num" id="LN1737">1737</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1738"><td class="num" id="LN1738">1738</td><td class="line">        <span class='comment'>/* Cleanup and restore the socket to the original state to continue</span></td></tr>
<tr class="codeline" data-linenumber="1739"><td class="num" id="LN1739">1739</td><td class="line">         <span class='comment'>* with the normal replication. */</span></td></tr>
<tr class="codeline" data-linenumber="1740"><td class="num" id="LN1740">1740</td><td class="line">        rioFreeConn(&amp;rdb, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1741"><td class="num" id="LN1741">1741</td><td class="line">        connNonBlock(conn);</td></tr>
<tr class="codeline" data-linenumber="1742"><td class="num" id="LN1742">1742</td><td class="line">        connRecvTimeout(conn,0);</td></tr>
<tr class="codeline" data-linenumber="1743"><td class="num" id="LN1743">1743</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1744"><td class="num" id="LN1744">1744</td><td class="line">        <span class='comment'>/* Ensure background save doesn't overwrite synced data */</span></td></tr>
<tr class="codeline" data-linenumber="1745"><td class="num" id="LN1745">1745</td><td class="line">        <span class='keyword'>if</span> (server.rdb_child_pid != -1) {</td></tr>
<tr class="codeline" data-linenumber="1746"><td class="num" id="LN1746">1746</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1747"><td class="num" id="LN1747">1747</td><td class="line">                <span class='string_literal'>"Replica is about to load the RDB file received from the "</span></td></tr>
<tr class="codeline" data-linenumber="1748"><td class="num" id="LN1748">1748</td><td class="line">                <span class='string_literal'>"master, but there is a pending RDB child running. "</span></td></tr>
<tr class="codeline" data-linenumber="1749"><td class="num" id="LN1749">1749</td><td class="line">                <span class='string_literal'>"Killing process %ld and removing its temp file to avoid "</span></td></tr>
<tr class="codeline" data-linenumber="1750"><td class="num" id="LN1750">1750</td><td class="line">                <span class='string_literal'>"any race"</span>,</td></tr>
<tr class="codeline" data-linenumber="1751"><td class="num" id="LN1751">1751</td><td class="line">                    (<span class='keyword'>long</span>) server.rdb_child_pid);</td></tr>
<tr class="codeline" data-linenumber="1752"><td class="num" id="LN1752">1752</td><td class="line">            killRDBChild();</td></tr>
<tr class="codeline" data-linenumber="1753"><td class="num" id="LN1753">1753</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1754"><td class="num" id="LN1754">1754</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1755"><td class="num" id="LN1755">1755</td><td class="line">        <span class='comment'>/* Make sure the new file (also used for persistence) is fully synced</span></td></tr>
<tr class="codeline" data-linenumber="1756"><td class="num" id="LN1756">1756</td><td class="line">         <span class='comment'>* (not covered by earlier calls to rdb_fsync_range). */</span></td></tr>
<tr class="codeline" data-linenumber="1757"><td class="num" id="LN1757">1757</td><td class="line">        <span class='keyword'>if</span> (fsync(server.repl_transfer_fd) == -1) {</td></tr>
<tr class="codeline" data-linenumber="1758"><td class="num" id="LN1758">1758</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1759"><td class="num" id="LN1759">1759</td><td class="line">                <span class='string_literal'>"Failed trying to sync the temp DB to disk in "</span></td></tr>
<tr class="codeline" data-linenumber="1760"><td class="num" id="LN1760">1760</td><td class="line">                <span class='string_literal'>"MASTER &lt;-&gt; REPLICA synchronization: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="1761"><td class="num" id="LN1761">1761</td><td class="line">                strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="1762"><td class="num" id="LN1762">1762</td><td class="line">            cancelReplicationHandshake();</td></tr>
<tr class="codeline" data-linenumber="1763"><td class="num" id="LN1763">1763</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1764"><td class="num" id="LN1764">1764</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1765"><td class="num" id="LN1765">1765</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1766"><td class="num" id="LN1766">1766</td><td class="line">        <span class='comment'>/* Rename rdb like renaming rewrite aof asynchronously. */</span></td></tr>
<tr class="codeline" data-linenumber="1767"><td class="num" id="LN1767">1767</td><td class="line">        <span class='keyword'>int</span> old_rdb_fd = open(server.rdb_filename,<span class='macro'>O_RDONLY<span class='macro_popup'>00</span></span>|<span class='macro'>O_NONBLOCK<span class='macro_popup'>04000</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1768"><td class="num" id="LN1768">1768</td><td class="line">        <span class='keyword'>if</span> (rename(server.repl_transfer_tmpfile,server.rdb_filename) == -1) {</td></tr>
<tr class="codeline" data-linenumber="1769"><td class="num" id="LN1769">1769</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1770"><td class="num" id="LN1770">1770</td><td class="line">                <span class='string_literal'>"Failed trying to rename the temp DB into %s in "</span></td></tr>
<tr class="codeline" data-linenumber="1771"><td class="num" id="LN1771">1771</td><td class="line">                <span class='string_literal'>"MASTER &lt;-&gt; REPLICA synchronization: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="1772"><td class="num" id="LN1772">1772</td><td class="line">                server.rdb_filename, strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="1773"><td class="num" id="LN1773">1773</td><td class="line">            cancelReplicationHandshake();</td></tr>
<tr class="codeline" data-linenumber="1774"><td class="num" id="LN1774">1774</td><td class="line">            <span class='keyword'>if</span> (old_rdb_fd != -1) close(old_rdb_fd);</td></tr>
<tr class="codeline" data-linenumber="1775"><td class="num" id="LN1775">1775</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1776"><td class="num" id="LN1776">1776</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1777"><td class="num" id="LN1777">1777</td><td class="line">        <span class='comment'>/* Close old rdb asynchronously. */</span></td></tr>
<tr class="codeline" data-linenumber="1778"><td class="num" id="LN1778">1778</td><td class="line">        <span class='keyword'>if</span> (old_rdb_fd != -1) bioCreateBackgroundJob(<span class='macro'>BIO_CLOSE_FILE<span class='macro_popup'>0</span></span>,(<span class='keyword'>void</span>*)(<span class='keyword'>long</span>)old_rdb_fd,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1779"><td class="num" id="LN1779">1779</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1780"><td class="num" id="LN1780">1780</td><td class="line">        <span class='keyword'>if</span> (rdbLoad(server.rdb_filename,&amp;rsi,<span class='macro'>RDBFLAGS_REPLICATION<span class='macro_popup'>(1&lt;&lt;1)</span></span>) != <span class='macro'>C_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1781"><td class="num" id="LN1781">1781</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1782"><td class="num" id="LN1782">1782</td><td class="line">                <span class='string_literal'>"Failed trying to load the MASTER synchronization "</span></td></tr>
<tr class="codeline" data-linenumber="1783"><td class="num" id="LN1783">1783</td><td class="line">                <span class='string_literal'>"DB from disk"</span>);</td></tr>
<tr class="codeline" data-linenumber="1784"><td class="num" id="LN1784">1784</td><td class="line">            cancelReplicationHandshake();</td></tr>
<tr class="codeline" data-linenumber="1785"><td class="num" id="LN1785">1785</td><td class="line">            <span class='keyword'>if</span> (server.rdb_del_sync_files &amp;&amp; allPersistenceDisabled()) {</td></tr>
<tr class="codeline" data-linenumber="1786"><td class="num" id="LN1786">1786</td><td class="line">                serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Removing the RDB file obtained from "</span></td></tr>
<tr class="codeline" data-linenumber="1787"><td class="num" id="LN1787">1787</td><td class="line">                                    <span class='string_literal'>"the master. This replica has persistence "</span></td></tr>
<tr class="codeline" data-linenumber="1788"><td class="num" id="LN1788">1788</td><td class="line">                                    <span class='string_literal'>"disabled"</span>);</td></tr>
<tr class="codeline" data-linenumber="1789"><td class="num" id="LN1789">1789</td><td class="line">                bg_unlink(server.rdb_filename);</td></tr>
<tr class="codeline" data-linenumber="1790"><td class="num" id="LN1790">1790</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1791"><td class="num" id="LN1791">1791</td><td class="line">            <span class='comment'>/* Note that there's no point in restarting the AOF on sync failure,</span></td></tr>
<tr class="codeline" data-linenumber="1792"><td class="num" id="LN1792">1792</td><td class="line">               <span class='comment'>it'll be restarted when sync succeeds or replica promoted. */</span></td></tr>
<tr class="codeline" data-linenumber="1793"><td class="num" id="LN1793">1793</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1794"><td class="num" id="LN1794">1794</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1795"><td class="num" id="LN1795">1795</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1796"><td class="num" id="LN1796">1796</td><td class="line">        <span class='comment'>/* Cleanup. */</span></td></tr>
<tr class="codeline" data-linenumber="1797"><td class="num" id="LN1797">1797</td><td class="line">        <span class='keyword'>if</span> (server.rdb_del_sync_files &amp;&amp; allPersistenceDisabled()) {</td></tr>
<tr class="codeline" data-linenumber="1798"><td class="num" id="LN1798">1798</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Removing the RDB file obtained from "</span></td></tr>
<tr class="codeline" data-linenumber="1799"><td class="num" id="LN1799">1799</td><td class="line">                                <span class='string_literal'>"the master. This replica has persistence "</span></td></tr>
<tr class="codeline" data-linenumber="1800"><td class="num" id="LN1800">1800</td><td class="line">                                <span class='string_literal'>"disabled"</span>);</td></tr>
<tr class="codeline" data-linenumber="1801"><td class="num" id="LN1801">1801</td><td class="line">            bg_unlink(server.rdb_filename);</td></tr>
<tr class="codeline" data-linenumber="1802"><td class="num" id="LN1802">1802</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1803"><td class="num" id="LN1803">1803</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1804"><td class="num" id="LN1804">1804</td><td class="line">        zfree(server.repl_transfer_tmpfile);</td></tr>
<tr class="codeline" data-linenumber="1805"><td class="num" id="LN1805">1805</td><td class="line">        close(server.repl_transfer_fd);</td></tr>
<tr class="codeline" data-linenumber="1806"><td class="num" id="LN1806">1806</td><td class="line">        server.repl_transfer_fd = -1;</td></tr>
<tr class="codeline" data-linenumber="1807"><td class="num" id="LN1807">1807</td><td class="line">        server.repl_transfer_tmpfile = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1808"><td class="num" id="LN1808">1808</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1809"><td class="num" id="LN1809">1809</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1810"><td class="num" id="LN1810">1810</td><td class="line">    <span class='comment'>/* Final setup of the connected slave &lt;- master link */</span></td></tr>
<tr class="codeline" data-linenumber="1811"><td class="num" id="LN1811">1811</td><td class="line">    replicationCreateMasterClient(server.repl_transfer_s,rsi.repl_stream_db);</td></tr>
<tr class="codeline" data-linenumber="1812"><td class="num" id="LN1812">1812</td><td class="line">    server.repl_state = <span class='macro'>REPL_STATE_CONNECTED<span class='macro_popup'>15</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1813"><td class="num" id="LN1813">1813</td><td class="line">    server.repl_down_since = 0;</td></tr>
<tr class="codeline" data-linenumber="1814"><td class="num" id="LN1814">1814</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1815"><td class="num" id="LN1815">1815</td><td class="line">    <span class='comment'>/* Fire the master link modules event. */</span></td></tr>
<tr class="codeline" data-linenumber="1816"><td class="num" id="LN1816">1816</td><td class="line">    moduleFireServerEvent(<span class='macro'>REDISMODULE_EVENT_MASTER_LINK_CHANGE<span class='macro_popup'>7</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1817"><td class="num" id="LN1817">1817</td><td class="line">                          <span class='macro'>REDISMODULE_SUBEVENT_MASTER_LINK_UP<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1818"><td class="num" id="LN1818">1818</td><td class="line">                          <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1819"><td class="num" id="LN1819">1819</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1820"><td class="num" id="LN1820">1820</td><td class="line">    <span class='comment'>/* After a full resynchronization we use the replication ID and</span></td></tr>
<tr class="codeline" data-linenumber="1821"><td class="num" id="LN1821">1821</td><td class="line">     <span class='comment'>* offset of the master. The secondary ID / offset are cleared since</span></td></tr>
<tr class="codeline" data-linenumber="1822"><td class="num" id="LN1822">1822</td><td class="line">     <span class='comment'>* we are starting a new history. */</span></td></tr>
<tr class="codeline" data-linenumber="1823"><td class="num" id="LN1823">1823</td><td class="line">    memcpy(server.replid,server.master-&gt;replid,<span class='keyword'>sizeof</span>(server.replid));</td></tr>
<tr class="codeline" data-linenumber="1824"><td class="num" id="LN1824">1824</td><td class="line">    server.master_repl_offset = server.master-&gt;reploff;</td></tr>
<tr class="codeline" data-linenumber="1825"><td class="num" id="LN1825">1825</td><td class="line">    clearReplicationId2();</td></tr>
<tr class="codeline" data-linenumber="1826"><td class="num" id="LN1826">1826</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1827"><td class="num" id="LN1827">1827</td><td class="line">    <span class='comment'>/* Let's create the replication backlog if needed. Slaves need to</span></td></tr>
<tr class="codeline" data-linenumber="1828"><td class="num" id="LN1828">1828</td><td class="line">     <span class='comment'>* accumulate the backlog regardless of the fact they have sub-slaves</span></td></tr>
<tr class="codeline" data-linenumber="1829"><td class="num" id="LN1829">1829</td><td class="line">     <span class='comment'>* or not, in order to behave correctly if they are promoted to</span></td></tr>
<tr class="codeline" data-linenumber="1830"><td class="num" id="LN1830">1830</td><td class="line">     <span class='comment'>* masters after a failover. */</span></td></tr>
<tr class="codeline" data-linenumber="1831"><td class="num" id="LN1831">1831</td><td class="line">    <span class='keyword'>if</span> (server.repl_backlog == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) createReplicationBacklog();</td></tr>
<tr class="codeline" data-linenumber="1832"><td class="num" id="LN1832">1832</td><td class="line">    serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>, <span class='string_literal'>"MASTER &lt;-&gt; REPLICA sync: Finished with success"</span>);</td></tr>
<tr class="codeline" data-linenumber="1833"><td class="num" id="LN1833">1833</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1834"><td class="num" id="LN1834">1834</td><td class="line">    <span class='keyword'>if</span> (server.supervised_mode == <span class='macro'>SUPERVISED_SYSTEMD<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1835"><td class="num" id="LN1835">1835</td><td class="line">        redisCommunicateSystemd(<span class='string_literal'>"STATUS=MASTER &lt;-&gt; REPLICA sync: Finished with success. Ready to accept connections.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1836"><td class="num" id="LN1836">1836</td><td class="line">        redisCommunicateSystemd(<span class='string_literal'>"READY=1\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1837"><td class="num" id="LN1837">1837</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1838"><td class="num" id="LN1838">1838</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1839"><td class="num" id="LN1839">1839</td><td class="line">    <span class='comment'>/* Restart the AOF subsystem now that we finished the sync. This</span></td></tr>
<tr class="codeline" data-linenumber="1840"><td class="num" id="LN1840">1840</td><td class="line">     <span class='comment'>* will trigger an AOF rewrite, and when done will start appending</span></td></tr>
<tr class="codeline" data-linenumber="1841"><td class="num" id="LN1841">1841</td><td class="line">     <span class='comment'>* to the new file. */</span></td></tr>
<tr class="codeline" data-linenumber="1842"><td class="num" id="LN1842">1842</td><td class="line">    <span class='keyword'>if</span> (server.aof_enabled) restartAOFAfterSYNC();</td></tr>
<tr class="codeline" data-linenumber="1843"><td class="num" id="LN1843">1843</td><td class="line">    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1844"><td class="num" id="LN1844">1844</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1845"><td class="num" id="LN1845">1845</td><td class="line">error:</td></tr>
<tr class="codeline" data-linenumber="1846"><td class="num" id="LN1846">1846</td><td class="line">    cancelReplicationHandshake();</td></tr>
<tr class="codeline" data-linenumber="1847"><td class="num" id="LN1847">1847</td><td class="line">    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="1848"><td class="num" id="LN1848">1848</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1849"><td class="num" id="LN1849">1849</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1850"><td class="num" id="LN1850">1850</td><td class="line"><span class='comment'>/* Send a synchronous command to the master. Used to send AUTH and</span></td></tr>
<tr class="codeline" data-linenumber="1851"><td class="num" id="LN1851">1851</td><td class="line"> <span class='comment'>* REPLCONF commands before starting the replication with SYNC.</span></td></tr>
<tr class="codeline" data-linenumber="1852"><td class="num" id="LN1852">1852</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1853"><td class="num" id="LN1853">1853</td><td class="line"> <span class='comment'>* The command returns an sds string representing the result of the</span></td></tr>
<tr class="codeline" data-linenumber="1854"><td class="num" id="LN1854">1854</td><td class="line"> <span class='comment'>* operation. On error the first byte is a "-".</span></td></tr>
<tr class="codeline" data-linenumber="1855"><td class="num" id="LN1855">1855</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1856"><td class="num" id="LN1856">1856</td><td class="line"><span class='directive'>#define <span class='macro'>SYNC_CMD_READ<span class='macro_popup'>(1&lt;&lt;0)</span></span> (1&lt;&lt;0)</span></td></tr>
<tr class="codeline" data-linenumber="1857"><td class="num" id="LN1857">1857</td><td class="line"><span class='directive'>#define <span class='macro'>SYNC_CMD_WRITE<span class='macro_popup'>(1&lt;&lt;1)</span></span> (1&lt;&lt;1)</span></td></tr>
<tr class="codeline" data-linenumber="1858"><td class="num" id="LN1858">1858</td><td class="line"><span class='directive'>#define <span class='macro'>SYNC_CMD_FULL<span class='macro_popup'>((1&lt;&lt;0)|(1&lt;&lt;1))</span></span> (<span class='macro'>SYNC_CMD_READ<span class='macro_popup'>(1&lt;&lt;0)</span></span>|<span class='macro'>SYNC_CMD_WRITE<span class='macro_popup'>(1&lt;&lt;1)</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="1859"><td class="num" id="LN1859">1859</td><td class="line"><span class='keyword'>char</span> *sendSynchronousCommand(<span class='keyword'>int</span> flags, connection *conn, ...) {</td></tr>
<tr class="codeline" data-linenumber="1860"><td class="num" id="LN1860">1860</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1861"><td class="num" id="LN1861">1861</td><td class="line">    <span class='comment'>/* Create the command to send to the master, we use redis binary</span></td></tr>
<tr class="codeline" data-linenumber="1862"><td class="num" id="LN1862">1862</td><td class="line">     <span class='comment'>* protocol to make sure correct arguments are sent. This function</span></td></tr>
<tr class="codeline" data-linenumber="1863"><td class="num" id="LN1863">1863</td><td class="line">     <span class='comment'>* is not safe for all binary data. */</span></td></tr>
<tr class="codeline" data-linenumber="1864"><td class="num" id="LN1864">1864</td><td class="line">    <span class='keyword'>if</span> (flags &amp; <span class='macro'>SYNC_CMD_WRITE<span class='macro_popup'>(1&lt;&lt;1)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1865"><td class="num" id="LN1865">1865</td><td class="line">        <span class='keyword'>char</span> *arg;</td></tr>
<tr class="codeline" data-linenumber="1866"><td class="num" id="LN1866">1866</td><td class="line">        va_list ap;</td></tr>
<tr class="codeline" data-linenumber="1867"><td class="num" id="LN1867">1867</td><td class="line">        sds cmd = sdsempty();</td></tr>
<tr class="codeline" data-linenumber="1868"><td class="num" id="LN1868">1868</td><td class="line">        sds cmdargs = sdsempty();</td></tr>
<tr class="codeline" data-linenumber="1869"><td class="num" id="LN1869">1869</td><td class="line">        size_t argslen = 0;</td></tr>
<tr class="codeline" data-linenumber="1870"><td class="num" id="LN1870">1870</td><td class="line">        <span class='macro'>va_start(ap,conn)<span class='macro_popup'>__builtin_va_start(ap, conn)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1871"><td class="num" id="LN1871">1871</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1872"><td class="num" id="LN1872">1872</td><td class="line">        <span class='keyword'>while</span>(1) {</td></tr>
<tr class="codeline" data-linenumber="1873"><td class="num" id="LN1873">1873</td><td class="line">            arg = <span class='macro'>va_arg(ap, <span class='keyword'>char</span>*)<span class='macro_popup'>__builtin_va_arg(ap, char*)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1874"><td class="num" id="LN1874">1874</td><td class="line">            <span class='keyword'>if</span> (arg == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1875"><td class="num" id="LN1875">1875</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1876"><td class="num" id="LN1876">1876</td><td class="line">            cmdargs = sdscatprintf(cmdargs,<span class='string_literal'>"$%zu\r\n%s\r\n"</span>,strlen(arg),arg);</td></tr>
<tr class="codeline" data-linenumber="1877"><td class="num" id="LN1877">1877</td><td class="line">            argslen++;</td></tr>
<tr class="codeline" data-linenumber="1878"><td class="num" id="LN1878">1878</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1879"><td class="num" id="LN1879">1879</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1880"><td class="num" id="LN1880">1880</td><td class="line">        <span class='macro'>va_end(ap)<span class='macro_popup'>__builtin_va_end(ap)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1881"><td class="num" id="LN1881">1881</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1882"><td class="num" id="LN1882">1882</td><td class="line">        cmd = sdscatprintf(cmd,<span class='string_literal'>"*%zu\r\n"</span>,argslen);</td></tr>
<tr class="codeline" data-linenumber="1883"><td class="num" id="LN1883">1883</td><td class="line">        cmd = sdscatsds(cmd,cmdargs);</td></tr>
<tr class="codeline" data-linenumber="1884"><td class="num" id="LN1884">1884</td><td class="line">        sdsfree(cmdargs);</td></tr>
<tr class="codeline" data-linenumber="1885"><td class="num" id="LN1885">1885</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1886"><td class="num" id="LN1886">1886</td><td class="line">        <span class='comment'>/* Transfer command to the server. */</span></td></tr>
<tr class="codeline" data-linenumber="1887"><td class="num" id="LN1887">1887</td><td class="line">        <span class='keyword'>if</span> (connSyncWrite(conn,cmd,sdslen(cmd),server.repl_syncio_timeout*1000)</td></tr>
<tr class="codeline" data-linenumber="1888"><td class="num" id="LN1888">1888</td><td class="line">            == -1)</td></tr>
<tr class="codeline" data-linenumber="1889"><td class="num" id="LN1889">1889</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="1890"><td class="num" id="LN1890">1890</td><td class="line">            sdsfree(cmd);</td></tr>
<tr class="codeline" data-linenumber="1891"><td class="num" id="LN1891">1891</td><td class="line">            <span class='keyword'>return</span> sdscatprintf(sdsempty(),<span class='string_literal'>"-Writing to master: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="1892"><td class="num" id="LN1892">1892</td><td class="line">                    connGetLastError(conn));</td></tr>
<tr class="codeline" data-linenumber="1893"><td class="num" id="LN1893">1893</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1894"><td class="num" id="LN1894">1894</td><td class="line">        sdsfree(cmd);</td></tr>
<tr class="codeline" data-linenumber="1895"><td class="num" id="LN1895">1895</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1896"><td class="num" id="LN1896">1896</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1897"><td class="num" id="LN1897">1897</td><td class="line">    <span class='comment'>/* Read the reply from the server. */</span></td></tr>
<tr class="codeline" data-linenumber="1898"><td class="num" id="LN1898">1898</td><td class="line">    <span class='keyword'>if</span> (flags &amp; <span class='macro'>SYNC_CMD_READ<span class='macro_popup'>(1&lt;&lt;0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1899"><td class="num" id="LN1899">1899</td><td class="line">        <span class='keyword'>char</span> buf[256];</td></tr>
<tr class="codeline" data-linenumber="1900"><td class="num" id="LN1900">1900</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1901"><td class="num" id="LN1901">1901</td><td class="line">        <span class='keyword'>if</span> (connSyncReadLine(conn,buf,<span class='keyword'>sizeof</span>(buf),server.repl_syncio_timeout*1000)</td></tr>
<tr class="codeline" data-linenumber="1902"><td class="num" id="LN1902">1902</td><td class="line">            == -1)</td></tr>
<tr class="codeline" data-linenumber="1903"><td class="num" id="LN1903">1903</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="1904"><td class="num" id="LN1904">1904</td><td class="line">            <span class='keyword'>return</span> sdscatprintf(sdsempty(),<span class='string_literal'>"-Reading from master: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="1905"><td class="num" id="LN1905">1905</td><td class="line">                    strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="1906"><td class="num" id="LN1906">1906</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1907"><td class="num" id="LN1907">1907</td><td class="line">        server.repl_transfer_lastio = server.unixtime;</td></tr>
<tr class="codeline" data-linenumber="1908"><td class="num" id="LN1908">1908</td><td class="line">        <span class='keyword'>return</span> sdsnew(buf);</td></tr>
<tr class="codeline" data-linenumber="1909"><td class="num" id="LN1909">1909</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1910"><td class="num" id="LN1910">1910</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1911"><td class="num" id="LN1911">1911</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1912"><td class="num" id="LN1912">1912</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1913"><td class="num" id="LN1913">1913</td><td class="line"><span class='comment'>/* Try a partial resynchronization with the master if we are about to reconnect.</span></td></tr>
<tr class="codeline" data-linenumber="1914"><td class="num" id="LN1914">1914</td><td class="line"> <span class='comment'>* If there is no cached master structure, at least try to issue a</span></td></tr>
<tr class="codeline" data-linenumber="1915"><td class="num" id="LN1915">1915</td><td class="line"> <span class='comment'>* "PSYNC ? -1" command in order to trigger a full resync using the PSYNC</span></td></tr>
<tr class="codeline" data-linenumber="1916"><td class="num" id="LN1916">1916</td><td class="line"> <span class='comment'>* command in order to obtain the master replid and the master replication</span></td></tr>
<tr class="codeline" data-linenumber="1917"><td class="num" id="LN1917">1917</td><td class="line"> <span class='comment'>* global offset.</span></td></tr>
<tr class="codeline" data-linenumber="1918"><td class="num" id="LN1918">1918</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1919"><td class="num" id="LN1919">1919</td><td class="line"> <span class='comment'>* This function is designed to be called from syncWithMaster(), so the</span></td></tr>
<tr class="codeline" data-linenumber="1920"><td class="num" id="LN1920">1920</td><td class="line"> <span class='comment'>* following assumptions are made:</span></td></tr>
<tr class="codeline" data-linenumber="1921"><td class="num" id="LN1921">1921</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1922"><td class="num" id="LN1922">1922</td><td class="line"> <span class='comment'>* 1) We pass the function an already connected socket "fd".</span></td></tr>
<tr class="codeline" data-linenumber="1923"><td class="num" id="LN1923">1923</td><td class="line"> <span class='comment'>* 2) This function does not close the file descriptor "fd". However in case</span></td></tr>
<tr class="codeline" data-linenumber="1924"><td class="num" id="LN1924">1924</td><td class="line"> <span class='comment'>*    of successful partial resynchronization, the function will reuse</span></td></tr>
<tr class="codeline" data-linenumber="1925"><td class="num" id="LN1925">1925</td><td class="line"> <span class='comment'>*    'fd' as file descriptor of the server.master client structure.</span></td></tr>
<tr class="codeline" data-linenumber="1926"><td class="num" id="LN1926">1926</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1927"><td class="num" id="LN1927">1927</td><td class="line"> <span class='comment'>* The function is split in two halves: if read_reply is 0, the function</span></td></tr>
<tr class="codeline" data-linenumber="1928"><td class="num" id="LN1928">1928</td><td class="line"> <span class='comment'>* writes the PSYNC command on the socket, and a new function call is</span></td></tr>
<tr class="codeline" data-linenumber="1929"><td class="num" id="LN1929">1929</td><td class="line"> <span class='comment'>* needed, with read_reply set to 1, in order to read the reply of the</span></td></tr>
<tr class="codeline" data-linenumber="1930"><td class="num" id="LN1930">1930</td><td class="line"> <span class='comment'>* command. This is useful in order to support non blocking operations, so</span></td></tr>
<tr class="codeline" data-linenumber="1931"><td class="num" id="LN1931">1931</td><td class="line"> <span class='comment'>* that we write, return into the event loop, and read when there are data.</span></td></tr>
<tr class="codeline" data-linenumber="1932"><td class="num" id="LN1932">1932</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1933"><td class="num" id="LN1933">1933</td><td class="line"> <span class='comment'>* When read_reply is 0 the function returns PSYNC_WRITE_ERR if there</span></td></tr>
<tr class="codeline" data-linenumber="1934"><td class="num" id="LN1934">1934</td><td class="line"> <span class='comment'>* was a write error, or PSYNC_WAIT_REPLY to signal we need another call</span></td></tr>
<tr class="codeline" data-linenumber="1935"><td class="num" id="LN1935">1935</td><td class="line"> <span class='comment'>* with read_reply set to 1. However even when read_reply is set to 1</span></td></tr>
<tr class="codeline" data-linenumber="1936"><td class="num" id="LN1936">1936</td><td class="line"> <span class='comment'>* the function may return PSYNC_WAIT_REPLY again to signal there were</span></td></tr>
<tr class="codeline" data-linenumber="1937"><td class="num" id="LN1937">1937</td><td class="line"> <span class='comment'>* insufficient data to read to complete its work. We should re-enter</span></td></tr>
<tr class="codeline" data-linenumber="1938"><td class="num" id="LN1938">1938</td><td class="line"> <span class='comment'>* into the event loop and wait in such a case.</span></td></tr>
<tr class="codeline" data-linenumber="1939"><td class="num" id="LN1939">1939</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1940"><td class="num" id="LN1940">1940</td><td class="line"> <span class='comment'>* The function returns:</span></td></tr>
<tr class="codeline" data-linenumber="1941"><td class="num" id="LN1941">1941</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1942"><td class="num" id="LN1942">1942</td><td class="line"> <span class='comment'>* PSYNC_CONTINUE: If the PSYNC command succeeded and we can continue.</span></td></tr>
<tr class="codeline" data-linenumber="1943"><td class="num" id="LN1943">1943</td><td class="line"> <span class='comment'>* PSYNC_FULLRESYNC: If PSYNC is supported but a full resync is needed.</span></td></tr>
<tr class="codeline" data-linenumber="1944"><td class="num" id="LN1944">1944</td><td class="line"> <span class='comment'>*                   In this case the master replid and global replication</span></td></tr>
<tr class="codeline" data-linenumber="1945"><td class="num" id="LN1945">1945</td><td class="line"> <span class='comment'>*                   offset is saved.</span></td></tr>
<tr class="codeline" data-linenumber="1946"><td class="num" id="LN1946">1946</td><td class="line"> <span class='comment'>* PSYNC_NOT_SUPPORTED: If the server does not understand PSYNC at all and</span></td></tr>
<tr class="codeline" data-linenumber="1947"><td class="num" id="LN1947">1947</td><td class="line"> <span class='comment'>*                      the caller should fall back to SYNC.</span></td></tr>
<tr class="codeline" data-linenumber="1948"><td class="num" id="LN1948">1948</td><td class="line"> <span class='comment'>* PSYNC_WRITE_ERROR: There was an error writing the command to the socket.</span></td></tr>
<tr class="codeline" data-linenumber="1949"><td class="num" id="LN1949">1949</td><td class="line"> <span class='comment'>* PSYNC_WAIT_REPLY: Call again the function with read_reply set to 1.</span></td></tr>
<tr class="codeline" data-linenumber="1950"><td class="num" id="LN1950">1950</td><td class="line"> <span class='comment'>* PSYNC_TRY_LATER: Master is currently in a transient error condition.</span></td></tr>
<tr class="codeline" data-linenumber="1951"><td class="num" id="LN1951">1951</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1952"><td class="num" id="LN1952">1952</td><td class="line"> <span class='comment'>* Notable side effects:</span></td></tr>
<tr class="codeline" data-linenumber="1953"><td class="num" id="LN1953">1953</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="1954"><td class="num" id="LN1954">1954</td><td class="line"> <span class='comment'>* 1) As a side effect of the function call the function removes the readable</span></td></tr>
<tr class="codeline" data-linenumber="1955"><td class="num" id="LN1955">1955</td><td class="line"> <span class='comment'>*    event handler from "fd", unless the return value is PSYNC_WAIT_REPLY.</span></td></tr>
<tr class="codeline" data-linenumber="1956"><td class="num" id="LN1956">1956</td><td class="line"> <span class='comment'>* 2) server.master_initial_offset is set to the right value according</span></td></tr>
<tr class="codeline" data-linenumber="1957"><td class="num" id="LN1957">1957</td><td class="line"> <span class='comment'>*    to the master reply. This will be used to populate the 'server.master'</span></td></tr>
<tr class="codeline" data-linenumber="1958"><td class="num" id="LN1958">1958</td><td class="line"> <span class='comment'>*    structure replication offset.</span></td></tr>
<tr class="codeline" data-linenumber="1959"><td class="num" id="LN1959">1959</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="1960"><td class="num" id="LN1960">1960</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1961"><td class="num" id="LN1961">1961</td><td class="line"><span class='directive'>#define <span class='macro'>PSYNC_WRITE_ERROR<span class='macro_popup'>0</span></span> 0</span></td></tr>
<tr class="codeline" data-linenumber="1962"><td class="num" id="LN1962">1962</td><td class="line"><span class='directive'>#define <span class='macro'>PSYNC_WAIT_REPLY<span class='macro_popup'>1</span></span> 1</span></td></tr>
<tr class="codeline" data-linenumber="1963"><td class="num" id="LN1963">1963</td><td class="line"><span class='directive'>#define <span class='macro'>PSYNC_CONTINUE<span class='macro_popup'>2</span></span> 2</span></td></tr>
<tr class="codeline" data-linenumber="1964"><td class="num" id="LN1964">1964</td><td class="line"><span class='directive'>#define <span class='macro'>PSYNC_FULLRESYNC<span class='macro_popup'>3</span></span> 3</span></td></tr>
<tr class="codeline" data-linenumber="1965"><td class="num" id="LN1965">1965</td><td class="line"><span class='directive'>#define <span class='macro'>PSYNC_NOT_SUPPORTED<span class='macro_popup'>4</span></span> 4</span></td></tr>
<tr class="codeline" data-linenumber="1966"><td class="num" id="LN1966">1966</td><td class="line"><span class='directive'>#define <span class='macro'>PSYNC_TRY_LATER<span class='macro_popup'>5</span></span> 5</span></td></tr>
<tr class="codeline" data-linenumber="1967"><td class="num" id="LN1967">1967</td><td class="line"><span class='keyword'>int</span> slaveTryPartialResynchronization(connection *conn, <span class='keyword'>int</span> read_reply) {</td></tr>
<tr class="codeline" data-linenumber="1968"><td class="num" id="LN1968">1968</td><td class="line">    <span class='keyword'>char</span> *psync_replid;</td></tr>
<tr class="codeline" data-linenumber="1969"><td class="num" id="LN1969">1969</td><td class="line">    <span class='keyword'>char</span> psync_offset[32];</td></tr>
<tr class="codeline" data-linenumber="1970"><td class="num" id="LN1970">1970</td><td class="line">    sds reply;</td></tr>
<tr class="codeline" data-linenumber="1971"><td class="num" id="LN1971">1971</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1972"><td class="num" id="LN1972">1972</td><td class="line">    <span class='comment'>/* Writing half */</span></td></tr>
<tr class="codeline" data-linenumber="1973"><td class="num" id="LN1973">1973</td><td class="line">    <span class='keyword'>if</span> (!read_reply) {</td></tr>
<tr class="codeline" data-linenumber="1974"><td class="num" id="LN1974">1974</td><td class="line">        <span class='comment'>/* Initially set master_initial_offset to -1 to mark the current</span></td></tr>
<tr class="codeline" data-linenumber="1975"><td class="num" id="LN1975">1975</td><td class="line">         <span class='comment'>* master replid and offset as not valid. Later if we'll be able to do</span></td></tr>
<tr class="codeline" data-linenumber="1976"><td class="num" id="LN1976">1976</td><td class="line">         <span class='comment'>* a FULL resync using the PSYNC command we'll set the offset at the</span></td></tr>
<tr class="codeline" data-linenumber="1977"><td class="num" id="LN1977">1977</td><td class="line">         <span class='comment'>* right value, so that this information will be propagated to the</span></td></tr>
<tr class="codeline" data-linenumber="1978"><td class="num" id="LN1978">1978</td><td class="line">         <span class='comment'>* client structure representing the master into server.master. */</span></td></tr>
<tr class="codeline" data-linenumber="1979"><td class="num" id="LN1979">1979</td><td class="line">        server.master_initial_offset = -1;</td></tr>
<tr class="codeline" data-linenumber="1980"><td class="num" id="LN1980">1980</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1981"><td class="num" id="LN1981">1981</td><td class="line">        <span class='keyword'>if</span> (server.cached_master) {</td></tr>
<tr class="codeline" data-linenumber="1982"><td class="num" id="LN1982">1982</td><td class="line">            psync_replid = server.cached_master-&gt;replid;</td></tr>
<tr class="codeline" data-linenumber="1983"><td class="num" id="LN1983">1983</td><td class="line">            snprintf(psync_offset,<span class='keyword'>sizeof</span>(psync_offset),<span class='string_literal'>"%lld"</span>, server.cached_master-&gt;reploff+1);</td></tr>
<tr class="codeline" data-linenumber="1984"><td class="num" id="LN1984">1984</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Trying a partial resynchronization (request %s:%s)."</span>, psync_replid, psync_offset);</td></tr>
<tr class="codeline" data-linenumber="1985"><td class="num" id="LN1985">1985</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1986"><td class="num" id="LN1986">1986</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Partial resynchronization not possible (no cached master)"</span>);</td></tr>
<tr class="codeline" data-linenumber="1987"><td class="num" id="LN1987">1987</td><td class="line">            psync_replid = <span class='string_literal'>"?"</span>;</td></tr>
<tr class="codeline" data-linenumber="1988"><td class="num" id="LN1988">1988</td><td class="line">            memcpy(psync_offset,<span class='string_literal'>"-1"</span>,3);</td></tr>
<tr class="codeline" data-linenumber="1989"><td class="num" id="LN1989">1989</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1990"><td class="num" id="LN1990">1990</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1991"><td class="num" id="LN1991">1991</td><td class="line">        <span class='comment'>/* Issue the PSYNC command */</span></td></tr>
<tr class="codeline" data-linenumber="1992"><td class="num" id="LN1992">1992</td><td class="line">        reply = sendSynchronousCommand(<span class='macro'>SYNC_CMD_WRITE<span class='macro_popup'>(1&lt;&lt;1)</span></span>,conn,<span class='string_literal'>"PSYNC"</span>,psync_replid,psync_offset,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1993"><td class="num" id="LN1993">1993</td><td class="line">        <span class='keyword'>if</span> (reply != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1994"><td class="num" id="LN1994">1994</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Unable to send PSYNC to master: %s"</span>,reply);</td></tr>
<tr class="codeline" data-linenumber="1995"><td class="num" id="LN1995">1995</td><td class="line">            sdsfree(reply);</td></tr>
<tr class="codeline" data-linenumber="1996"><td class="num" id="LN1996">1996</td><td class="line">            connSetReadHandler(conn, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1997"><td class="num" id="LN1997">1997</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>PSYNC_WRITE_ERROR<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1998"><td class="num" id="LN1998">1998</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1999"><td class="num" id="LN1999">1999</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>PSYNC_WAIT_REPLY<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2000"><td class="num" id="LN2000">2000</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2001"><td class="num" id="LN2001">2001</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2002"><td class="num" id="LN2002">2002</td><td class="line">    <span class='comment'>/* Reading half */</span></td></tr>
<tr class="codeline" data-linenumber="2003"><td class="num" id="LN2003">2003</td><td class="line">    reply = sendSynchronousCommand(<span class='macro'>SYNC_CMD_READ<span class='macro_popup'>(1&lt;&lt;0)</span></span>,conn,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2004"><td class="num" id="LN2004">2004</td><td class="line">    <span class='keyword'>if</span> (sdslen(reply) == 0) {</td></tr>
<tr class="codeline" data-linenumber="2005"><td class="num" id="LN2005">2005</td><td class="line">        <span class='comment'>/* The master may send empty newlines after it receives PSYNC</span></td></tr>
<tr class="codeline" data-linenumber="2006"><td class="num" id="LN2006">2006</td><td class="line">         <span class='comment'>* and before to reply, just to keep the connection alive. */</span></td></tr>
<tr class="codeline" data-linenumber="2007"><td class="num" id="LN2007">2007</td><td class="line">        sdsfree(reply);</td></tr>
<tr class="codeline" data-linenumber="2008"><td class="num" id="LN2008">2008</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>PSYNC_WAIT_REPLY<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2009"><td class="num" id="LN2009">2009</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2010"><td class="num" id="LN2010">2010</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2011"><td class="num" id="LN2011">2011</td><td class="line">    connSetReadHandler(conn, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2012"><td class="num" id="LN2012">2012</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2013"><td class="num" id="LN2013">2013</td><td class="line">    <span class='keyword'>if</span> (!strncmp(reply,<span class='string_literal'>"+FULLRESYNC"</span>,11)) {</td></tr>
<tr class="codeline" data-linenumber="2014"><td class="num" id="LN2014">2014</td><td class="line">        <span class='keyword'>char</span> *replid = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, *offset = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2015"><td class="num" id="LN2015">2015</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2016"><td class="num" id="LN2016">2016</td><td class="line">        <span class='comment'>/* FULL RESYNC, parse the reply in order to extract the replid</span></td></tr>
<tr class="codeline" data-linenumber="2017"><td class="num" id="LN2017">2017</td><td class="line">         <span class='comment'>* and the replication offset. */</span></td></tr>
<tr class="codeline" data-linenumber="2018"><td class="num" id="LN2018">2018</td><td class="line">        replid = strchr(reply,' ');</td></tr>
<tr class="codeline" data-linenumber="2019"><td class="num" id="LN2019">2019</td><td class="line">        <span class='keyword'>if</span> (replid) {</td></tr>
<tr class="codeline" data-linenumber="2020"><td class="num" id="LN2020">2020</td><td class="line">            replid++;</td></tr>
<tr class="codeline" data-linenumber="2021"><td class="num" id="LN2021">2021</td><td class="line">            offset = strchr(replid,' ');</td></tr>
<tr class="codeline" data-linenumber="2022"><td class="num" id="LN2022">2022</td><td class="line">            <span class='keyword'>if</span> (offset) offset++;</td></tr>
<tr class="codeline" data-linenumber="2023"><td class="num" id="LN2023">2023</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2024"><td class="num" id="LN2024">2024</td><td class="line">        <span class='keyword'>if</span> (!replid || !offset || (offset-replid-1) != <span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2025"><td class="num" id="LN2025">2025</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2026"><td class="num" id="LN2026">2026</td><td class="line">                <span class='string_literal'>"Master replied with wrong +FULLRESYNC syntax."</span>);</td></tr>
<tr class="codeline" data-linenumber="2027"><td class="num" id="LN2027">2027</td><td class="line">            <span class='comment'>/* This is an unexpected condition, actually the +FULLRESYNC</span></td></tr>
<tr class="codeline" data-linenumber="2028"><td class="num" id="LN2028">2028</td><td class="line">             <span class='comment'>* reply means that the master supports PSYNC, but the reply</span></td></tr>
<tr class="codeline" data-linenumber="2029"><td class="num" id="LN2029">2029</td><td class="line">             <span class='comment'>* format seems wrong. To stay safe we blank the master</span></td></tr>
<tr class="codeline" data-linenumber="2030"><td class="num" id="LN2030">2030</td><td class="line">             <span class='comment'>* replid to make sure next PSYNCs will fail. */</span></td></tr>
<tr class="codeline" data-linenumber="2031"><td class="num" id="LN2031">2031</td><td class="line">            memset(server.master_replid,0,<span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>+1);</td></tr>
<tr class="codeline" data-linenumber="2032"><td class="num" id="LN2032">2032</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2033"><td class="num" id="LN2033">2033</td><td class="line">            memcpy(server.master_replid, replid, offset-replid-1);</td></tr>
<tr class="codeline" data-linenumber="2034"><td class="num" id="LN2034">2034</td><td class="line">            server.master_replid[<span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>] = '\0';</td></tr>
<tr class="codeline" data-linenumber="2035"><td class="num" id="LN2035">2035</td><td class="line">            server.master_initial_offset = strtoll(offset,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,10);</td></tr>
<tr class="codeline" data-linenumber="2036"><td class="num" id="LN2036">2036</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Full resync from master: %s:%lld"</span>,</td></tr>
<tr class="codeline" data-linenumber="2037"><td class="num" id="LN2037">2037</td><td class="line">                server.master_replid,</td></tr>
<tr class="codeline" data-linenumber="2038"><td class="num" id="LN2038">2038</td><td class="line">                server.master_initial_offset);</td></tr>
<tr class="codeline" data-linenumber="2039"><td class="num" id="LN2039">2039</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2040"><td class="num" id="LN2040">2040</td><td class="line">        <span class='comment'>/* We are going to full resync, discard the cached master structure. */</span></td></tr>
<tr class="codeline" data-linenumber="2041"><td class="num" id="LN2041">2041</td><td class="line">        replicationDiscardCachedMaster();</td></tr>
<tr class="codeline" data-linenumber="2042"><td class="num" id="LN2042">2042</td><td class="line">        sdsfree(reply);</td></tr>
<tr class="codeline" data-linenumber="2043"><td class="num" id="LN2043">2043</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>PSYNC_FULLRESYNC<span class='macro_popup'>3</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2044"><td class="num" id="LN2044">2044</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2045"><td class="num" id="LN2045">2045</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2046"><td class="num" id="LN2046">2046</td><td class="line">    <span class='keyword'>if</span> (!strncmp(reply,<span class='string_literal'>"+CONTINUE"</span>,9)) {</td></tr>
<tr class="codeline" data-linenumber="2047"><td class="num" id="LN2047">2047</td><td class="line">        <span class='comment'>/* Partial resync was accepted. */</span></td></tr>
<tr class="codeline" data-linenumber="2048"><td class="num" id="LN2048">2048</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2049"><td class="num" id="LN2049">2049</td><td class="line">            <span class='string_literal'>"Successful partial resynchronization with master."</span>);</td></tr>
<tr class="codeline" data-linenumber="2050"><td class="num" id="LN2050">2050</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2051"><td class="num" id="LN2051">2051</td><td class="line">        <span class='comment'>/* Check the new replication ID advertised by the master. If it</span></td></tr>
<tr class="codeline" data-linenumber="2052"><td class="num" id="LN2052">2052</td><td class="line">         <span class='comment'>* changed, we need to set the new ID as primary ID, and set or</span></td></tr>
<tr class="codeline" data-linenumber="2053"><td class="num" id="LN2053">2053</td><td class="line">         <span class='comment'>* secondary ID as the old master ID up to the current offset, so</span></td></tr>
<tr class="codeline" data-linenumber="2054"><td class="num" id="LN2054">2054</td><td class="line">         <span class='comment'>* that our sub-slaves will be able to PSYNC with us after a</span></td></tr>
<tr class="codeline" data-linenumber="2055"><td class="num" id="LN2055">2055</td><td class="line">         <span class='comment'>* disconnection. */</span></td></tr>
<tr class="codeline" data-linenumber="2056"><td class="num" id="LN2056">2056</td><td class="line">        <span class='keyword'>char</span> *start = reply+10;</td></tr>
<tr class="codeline" data-linenumber="2057"><td class="num" id="LN2057">2057</td><td class="line">        <span class='keyword'>char</span> *end = reply+9;</td></tr>
<tr class="codeline" data-linenumber="2058"><td class="num" id="LN2058">2058</td><td class="line">        <span class='keyword'>while</span>(end[0] != '\r' &amp;&amp; end[0] != '\n' &amp;&amp; end[0] != '\0') end++;</td></tr>
<tr class="codeline" data-linenumber="2059"><td class="num" id="LN2059">2059</td><td class="line">        <span class='keyword'>if</span> (end-start == <span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2060"><td class="num" id="LN2060">2060</td><td class="line">            <span class='keyword'>char</span> new[<span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>+1];</td></tr>
<tr class="codeline" data-linenumber="2061"><td class="num" id="LN2061">2061</td><td class="line">            memcpy(new,start,<span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2062"><td class="num" id="LN2062">2062</td><td class="line">            new[<span class='macro'>CONFIG_RUN_ID_SIZE<span class='macro_popup'>40</span></span>] = '\0';</td></tr>
<tr class="codeline" data-linenumber="2063"><td class="num" id="LN2063">2063</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2064"><td class="num" id="LN2064">2064</td><td class="line">            <span class='keyword'>if</span> (strcmp(new,server.cached_master-&gt;replid)) {</td></tr>
<tr class="codeline" data-linenumber="2065"><td class="num" id="LN2065">2065</td><td class="line">                <span class='comment'>/* Master ID changed. */</span></td></tr>
<tr class="codeline" data-linenumber="2066"><td class="num" id="LN2066">2066</td><td class="line">                serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Master replication ID changed to %s"</span>,new);</td></tr>
<tr class="codeline" data-linenumber="2067"><td class="num" id="LN2067">2067</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2068"><td class="num" id="LN2068">2068</td><td class="line">                <span class='comment'>/* Set the old ID as our ID2, up to the current offset+1. */</span></td></tr>
<tr class="codeline" data-linenumber="2069"><td class="num" id="LN2069">2069</td><td class="line">                memcpy(server.replid2,server.cached_master-&gt;replid,</td></tr>
<tr class="codeline" data-linenumber="2070"><td class="num" id="LN2070">2070</td><td class="line">                    <span class='keyword'>sizeof</span>(server.replid2));</td></tr>
<tr class="codeline" data-linenumber="2071"><td class="num" id="LN2071">2071</td><td class="line">                server.second_replid_offset = server.master_repl_offset+1;</td></tr>
<tr class="codeline" data-linenumber="2072"><td class="num" id="LN2072">2072</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2073"><td class="num" id="LN2073">2073</td><td class="line">                <span class='comment'>/* Update the cached master ID and our own primary ID to the</span></td></tr>
<tr class="codeline" data-linenumber="2074"><td class="num" id="LN2074">2074</td><td class="line">                 <span class='comment'>* new one. */</span></td></tr>
<tr class="codeline" data-linenumber="2075"><td class="num" id="LN2075">2075</td><td class="line">                memcpy(server.replid,new,<span class='keyword'>sizeof</span>(server.replid));</td></tr>
<tr class="codeline" data-linenumber="2076"><td class="num" id="LN2076">2076</td><td class="line">                memcpy(server.cached_master-&gt;replid,new,<span class='keyword'>sizeof</span>(server.replid));</td></tr>
<tr class="codeline" data-linenumber="2077"><td class="num" id="LN2077">2077</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2078"><td class="num" id="LN2078">2078</td><td class="line">                <span class='comment'>/* Disconnect all the sub-slaves: they need to be notified. */</span></td></tr>
<tr class="codeline" data-linenumber="2079"><td class="num" id="LN2079">2079</td><td class="line">                disconnectSlaves();</td></tr>
<tr class="codeline" data-linenumber="2080"><td class="num" id="LN2080">2080</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2081"><td class="num" id="LN2081">2081</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2082"><td class="num" id="LN2082">2082</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2083"><td class="num" id="LN2083">2083</td><td class="line">        <span class='comment'>/* Setup the replication to continue. */</span></td></tr>
<tr class="codeline" data-linenumber="2084"><td class="num" id="LN2084">2084</td><td class="line">        sdsfree(reply);</td></tr>
<tr class="codeline" data-linenumber="2085"><td class="num" id="LN2085">2085</td><td class="line">        replicationResurrectCachedMaster(conn);</td></tr>
<tr class="codeline" data-linenumber="2086"><td class="num" id="LN2086">2086</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2087"><td class="num" id="LN2087">2087</td><td class="line">        <span class='comment'>/* If this instance was restarted and we read the metadata to</span></td></tr>
<tr class="codeline" data-linenumber="2088"><td class="num" id="LN2088">2088</td><td class="line">         <span class='comment'>* PSYNC from the persistence file, our replication backlog could</span></td></tr>
<tr class="codeline" data-linenumber="2089"><td class="num" id="LN2089">2089</td><td class="line">         <span class='comment'>* be still not initialized. Create it. */</span></td></tr>
<tr class="codeline" data-linenumber="2090"><td class="num" id="LN2090">2090</td><td class="line">        <span class='keyword'>if</span> (server.repl_backlog == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) createReplicationBacklog();</td></tr>
<tr class="codeline" data-linenumber="2091"><td class="num" id="LN2091">2091</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>PSYNC_CONTINUE<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2092"><td class="num" id="LN2092">2092</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2093"><td class="num" id="LN2093">2093</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2094"><td class="num" id="LN2094">2094</td><td class="line">    <span class='comment'>/* If we reach this point we received either an error (since the master does</span></td></tr>
<tr class="codeline" data-linenumber="2095"><td class="num" id="LN2095">2095</td><td class="line">     <span class='comment'>* not understand PSYNC or because it is in a special state and cannot</span></td></tr>
<tr class="codeline" data-linenumber="2096"><td class="num" id="LN2096">2096</td><td class="line">     <span class='comment'>* serve our request), or an unexpected reply from the master.</span></td></tr>
<tr class="codeline" data-linenumber="2097"><td class="num" id="LN2097">2097</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2098"><td class="num" id="LN2098">2098</td><td class="line">     <span class='comment'>* Return PSYNC_NOT_SUPPORTED on errors we don't understand, otherwise</span></td></tr>
<tr class="codeline" data-linenumber="2099"><td class="num" id="LN2099">2099</td><td class="line">     <span class='comment'>* return PSYNC_TRY_LATER if we believe this is a transient error. */</span></td></tr>
<tr class="codeline" data-linenumber="2100"><td class="num" id="LN2100">2100</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2101"><td class="num" id="LN2101">2101</td><td class="line">    <span class='keyword'>if</span> (!strncmp(reply,<span class='string_literal'>"-NOMASTERLINK"</span>,13) ||</td></tr>
<tr class="codeline" data-linenumber="2102"><td class="num" id="LN2102">2102</td><td class="line">        !strncmp(reply,<span class='string_literal'>"-LOADING"</span>,8))</td></tr>
<tr class="codeline" data-linenumber="2103"><td class="num" id="LN2103">2103</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2104"><td class="num" id="LN2104">2104</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2105"><td class="num" id="LN2105">2105</td><td class="line">            <span class='string_literal'>"Master is currently unable to PSYNC "</span></td></tr>
<tr class="codeline" data-linenumber="2106"><td class="num" id="LN2106">2106</td><td class="line">            <span class='string_literal'>"but should be in the future: %s"</span>, reply);</td></tr>
<tr class="codeline" data-linenumber="2107"><td class="num" id="LN2107">2107</td><td class="line">        sdsfree(reply);</td></tr>
<tr class="codeline" data-linenumber="2108"><td class="num" id="LN2108">2108</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>PSYNC_TRY_LATER<span class='macro_popup'>5</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2109"><td class="num" id="LN2109">2109</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2110"><td class="num" id="LN2110">2110</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2111"><td class="num" id="LN2111">2111</td><td class="line">    <span class='keyword'>if</span> (strncmp(reply,<span class='string_literal'>"-ERR"</span>,4)) {</td></tr>
<tr class="codeline" data-linenumber="2112"><td class="num" id="LN2112">2112</td><td class="line">        <span class='comment'>/* If it's not an error, log the unexpected event. */</span></td></tr>
<tr class="codeline" data-linenumber="2113"><td class="num" id="LN2113">2113</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2114"><td class="num" id="LN2114">2114</td><td class="line">            <span class='string_literal'>"Unexpected reply to PSYNC from master: %s"</span>, reply);</td></tr>
<tr class="codeline" data-linenumber="2115"><td class="num" id="LN2115">2115</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2116"><td class="num" id="LN2116">2116</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2117"><td class="num" id="LN2117">2117</td><td class="line">            <span class='string_literal'>"Master does not support PSYNC or is in "</span></td></tr>
<tr class="codeline" data-linenumber="2118"><td class="num" id="LN2118">2118</td><td class="line">            <span class='string_literal'>"error state (reply: %s)"</span>, reply);</td></tr>
<tr class="codeline" data-linenumber="2119"><td class="num" id="LN2119">2119</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2120"><td class="num" id="LN2120">2120</td><td class="line">    sdsfree(reply);</td></tr>
<tr class="codeline" data-linenumber="2121"><td class="num" id="LN2121">2121</td><td class="line">    replicationDiscardCachedMaster();</td></tr>
<tr class="codeline" data-linenumber="2122"><td class="num" id="LN2122">2122</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>PSYNC_NOT_SUPPORTED<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2123"><td class="num" id="LN2123">2123</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2124"><td class="num" id="LN2124">2124</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2125"><td class="num" id="LN2125">2125</td><td class="line"><span class='comment'>/* This handler fires when the non blocking connect was able to</span></td></tr>
<tr class="codeline" data-linenumber="2126"><td class="num" id="LN2126">2126</td><td class="line"> <span class='comment'>* establish a connection with the master. */</span></td></tr>
<tr class="codeline" data-linenumber="2127"><td class="num" id="LN2127">2127</td><td class="line"><span class='keyword'>void</span> syncWithMaster(connection *conn) {</td></tr>
<tr class="codeline" data-linenumber="2128"><td class="num" id="LN2128">2128</td><td class="line">    <span class='keyword'>char</span> tmpfile[256], *err = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2129"><td class="num" id="LN2129">2129</td><td class="line">    <span class='keyword'>int</span> dfd = -1, maxtries = 5;</td></tr>
<tr class="codeline" data-linenumber="2130"><td class="num" id="LN2130">2130</td><td class="line">    <span class='keyword'>int</span> psync_result;</td></tr>
<tr class="codeline" data-linenumber="2131"><td class="num" id="LN2131">2131</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2132"><td class="num" id="LN2132">2132</td><td class="line">    <span class='comment'>/* If this event fired after the user turned the instance into a master</span></td></tr>
<tr class="codeline" data-linenumber="2133"><td class="num" id="LN2133">2133</td><td class="line">     <span class='comment'>* with SLAVEOF NO ONE we must just return ASAP. */</span></td></tr>
<tr class="codeline" data-linenumber="2134"><td class="num" id="LN2134">2134</td><td class="line">    <span class='keyword'>if</span> (server.repl_state == <span class='macro'>REPL_STATE_NONE<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2135"><td class="num" id="LN2135">2135</td><td class="line">        connClose(conn);</td></tr>
<tr class="codeline" data-linenumber="2136"><td class="num" id="LN2136">2136</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2137"><td class="num" id="LN2137">2137</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2138"><td class="num" id="LN2138">2138</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2139"><td class="num" id="LN2139">2139</td><td class="line">    <span class='comment'>/* Check for errors in the socket: after a non blocking connect() we</span></td></tr>
<tr class="codeline" data-linenumber="2140"><td class="num" id="LN2140">2140</td><td class="line">     <span class='comment'>* may find that the socket is in error state. */</span></td></tr>
<tr class="codeline" data-linenumber="2141"><td class="num" id="LN2141">2141</td><td class="line">    <span class='keyword'>if</span> (connGetState(conn) != CONN_STATE_CONNECTED) {</td></tr>
<tr class="codeline" data-linenumber="2142"><td class="num" id="LN2142">2142</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Error condition on socket for SYNC: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="2143"><td class="num" id="LN2143">2143</td><td class="line">                connGetLastError(conn));</td></tr>
<tr class="codeline" data-linenumber="2144"><td class="num" id="LN2144">2144</td><td class="line">        <span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="2145"><td class="num" id="LN2145">2145</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2146"><td class="num" id="LN2146">2146</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2147"><td class="num" id="LN2147">2147</td><td class="line">    <span class='comment'>/* Send a PING to check the master is able to reply without errors. */</span></td></tr>
<tr class="codeline" data-linenumber="2148"><td class="num" id="LN2148">2148</td><td class="line">    <span class='keyword'>if</span> (server.repl_state == <span class='macro'>REPL_STATE_CONNECTING<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2149"><td class="num" id="LN2149">2149</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Non blocking connect for SYNC fired the event."</span>);</td></tr>
<tr class="codeline" data-linenumber="2150"><td class="num" id="LN2150">2150</td><td class="line">        <span class='comment'>/* Delete the writable event so that the readable event remains</span></td></tr>
<tr class="codeline" data-linenumber="2151"><td class="num" id="LN2151">2151</td><td class="line">         <span class='comment'>* registered and we can wait for the PONG reply. */</span></td></tr>
<tr class="codeline" data-linenumber="2152"><td class="num" id="LN2152">2152</td><td class="line">        connSetReadHandler(conn, syncWithMaster);</td></tr>
<tr class="codeline" data-linenumber="2153"><td class="num" id="LN2153">2153</td><td class="line">        connSetWriteHandler(conn, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2154"><td class="num" id="LN2154">2154</td><td class="line">        server.repl_state = <span class='macro'>REPL_STATE_RECEIVE_PONG<span class='macro_popup'>3</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2155"><td class="num" id="LN2155">2155</td><td class="line">        <span class='comment'>/* Send the PING, don't check for errors at all, we have the timeout</span></td></tr>
<tr class="codeline" data-linenumber="2156"><td class="num" id="LN2156">2156</td><td class="line">         <span class='comment'>* that will take care about this. */</span></td></tr>
<tr class="codeline" data-linenumber="2157"><td class="num" id="LN2157">2157</td><td class="line">        err = sendSynchronousCommand(<span class='macro'>SYNC_CMD_WRITE<span class='macro_popup'>(1&lt;&lt;1)</span></span>,conn,<span class='string_literal'>"PING"</span>,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2158"><td class="num" id="LN2158">2158</td><td class="line">        <span class='keyword'>if</span> (err) <span class='keyword'>goto</span> write_error;</td></tr>
<tr class="codeline" data-linenumber="2159"><td class="num" id="LN2159">2159</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2160"><td class="num" id="LN2160">2160</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2161"><td class="num" id="LN2161">2161</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2162"><td class="num" id="LN2162">2162</td><td class="line">    <span class='comment'>/* Receive the PONG command. */</span></td></tr>
<tr class="codeline" data-linenumber="2163"><td class="num" id="LN2163">2163</td><td class="line">    <span class='keyword'>if</span> (server.repl_state == <span class='macro'>REPL_STATE_RECEIVE_PONG<span class='macro_popup'>3</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2164"><td class="num" id="LN2164">2164</td><td class="line">        err = sendSynchronousCommand(<span class='macro'>SYNC_CMD_READ<span class='macro_popup'>(1&lt;&lt;0)</span></span>,conn,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2165"><td class="num" id="LN2165">2165</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2166"><td class="num" id="LN2166">2166</td><td class="line">        <span class='comment'>/* We accept only two replies as valid, a positive +PONG reply</span></td></tr>
<tr class="codeline" data-linenumber="2167"><td class="num" id="LN2167">2167</td><td class="line">         <span class='comment'>* (we just check for "+") or an authentication error.</span></td></tr>
<tr class="codeline" data-linenumber="2168"><td class="num" id="LN2168">2168</td><td class="line">         <span class='comment'>* Note that older versions of Redis replied with "operation not</span></td></tr>
<tr class="codeline" data-linenumber="2169"><td class="num" id="LN2169">2169</td><td class="line">         <span class='comment'>* permitted" instead of using a proper error code, so we test</span></td></tr>
<tr class="codeline" data-linenumber="2170"><td class="num" id="LN2170">2170</td><td class="line">         <span class='comment'>* both. */</span></td></tr>
<tr class="codeline" data-linenumber="2171"><td class="num" id="LN2171">2171</td><td class="line">        <span class='keyword'>if</span> (err[0] != '+' &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2172"><td class="num" id="LN2172">2172</td><td class="line">            strncmp(err,<span class='string_literal'>"-NOAUTH"</span>,7) != 0 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2173"><td class="num" id="LN2173">2173</td><td class="line">            strncmp(err,<span class='string_literal'>"-NOPERM"</span>,7) != 0 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2174"><td class="num" id="LN2174">2174</td><td class="line">            strncmp(err,<span class='string_literal'>"-ERR operation not permitted"</span>,28) != 0)</td></tr>
<tr class="codeline" data-linenumber="2175"><td class="num" id="LN2175">2175</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="2176"><td class="num" id="LN2176">2176</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Error reply to PING from master: '%s'"</span>,err);</td></tr>
<tr class="codeline" data-linenumber="2177"><td class="num" id="LN2177">2177</td><td class="line">            sdsfree(err);</td></tr>
<tr class="codeline" data-linenumber="2178"><td class="num" id="LN2178">2178</td><td class="line">            <span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="2179"><td class="num" id="LN2179">2179</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2180"><td class="num" id="LN2180">2180</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2181"><td class="num" id="LN2181">2181</td><td class="line">                <span class='string_literal'>"Master replied to PING, replication can continue..."</span>);</td></tr>
<tr class="codeline" data-linenumber="2182"><td class="num" id="LN2182">2182</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2183"><td class="num" id="LN2183">2183</td><td class="line">        sdsfree(err);</td></tr>
<tr class="codeline" data-linenumber="2184"><td class="num" id="LN2184">2184</td><td class="line">        server.repl_state = <span class='macro'>REPL_STATE_SEND_AUTH<span class='macro_popup'>4</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2185"><td class="num" id="LN2185">2185</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2186"><td class="num" id="LN2186">2186</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2187"><td class="num" id="LN2187">2187</td><td class="line">    <span class='comment'>/* AUTH with the master if required. */</span></td></tr>
<tr class="codeline" data-linenumber="2188"><td class="num" id="LN2188">2188</td><td class="line">    <span class='keyword'>if</span> (server.repl_state == <span class='macro'>REPL_STATE_SEND_AUTH<span class='macro_popup'>4</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2189"><td class="num" id="LN2189">2189</td><td class="line">        <span class='keyword'>if</span> (server.masteruser &amp;&amp; server.masterauth) {</td></tr>
<tr class="codeline" data-linenumber="2190"><td class="num" id="LN2190">2190</td><td class="line">            err = sendSynchronousCommand(<span class='macro'>SYNC_CMD_WRITE<span class='macro_popup'>(1&lt;&lt;1)</span></span>,conn,<span class='string_literal'>"AUTH"</span>,</td></tr>
<tr class="codeline" data-linenumber="2191"><td class="num" id="LN2191">2191</td><td class="line">                                         server.masteruser,server.masterauth,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2192"><td class="num" id="LN2192">2192</td><td class="line">            <span class='keyword'>if</span> (err) <span class='keyword'>goto</span> write_error;</td></tr>
<tr class="codeline" data-linenumber="2193"><td class="num" id="LN2193">2193</td><td class="line">            server.repl_state = <span class='macro'>REPL_STATE_RECEIVE_AUTH<span class='macro_popup'>5</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2194"><td class="num" id="LN2194">2194</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2195"><td class="num" id="LN2195">2195</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (server.masterauth) {</td></tr>
<tr class="codeline" data-linenumber="2196"><td class="num" id="LN2196">2196</td><td class="line">            err = sendSynchronousCommand(<span class='macro'>SYNC_CMD_WRITE<span class='macro_popup'>(1&lt;&lt;1)</span></span>,conn,<span class='string_literal'>"AUTH"</span>,server.masterauth,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2197"><td class="num" id="LN2197">2197</td><td class="line">            <span class='keyword'>if</span> (err) <span class='keyword'>goto</span> write_error;</td></tr>
<tr class="codeline" data-linenumber="2198"><td class="num" id="LN2198">2198</td><td class="line">            server.repl_state = <span class='macro'>REPL_STATE_RECEIVE_AUTH<span class='macro_popup'>5</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2199"><td class="num" id="LN2199">2199</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2200"><td class="num" id="LN2200">2200</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2201"><td class="num" id="LN2201">2201</td><td class="line">            server.repl_state = <span class='macro'>REPL_STATE_SEND_PORT<span class='macro_popup'>6</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2202"><td class="num" id="LN2202">2202</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2203"><td class="num" id="LN2203">2203</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2204"><td class="num" id="LN2204">2204</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2205"><td class="num" id="LN2205">2205</td><td class="line">    <span class='comment'>/* Receive AUTH reply. */</span></td></tr>
<tr class="codeline" data-linenumber="2206"><td class="num" id="LN2206">2206</td><td class="line">    <span class='keyword'>if</span> (server.repl_state == <span class='macro'>REPL_STATE_RECEIVE_AUTH<span class='macro_popup'>5</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2207"><td class="num" id="LN2207">2207</td><td class="line">        err = sendSynchronousCommand(<span class='macro'>SYNC_CMD_READ<span class='macro_popup'>(1&lt;&lt;0)</span></span>,conn,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2208"><td class="num" id="LN2208">2208</td><td class="line">        <span class='keyword'>if</span> (err[0] == '-') {</td></tr>
<tr class="codeline" data-linenumber="2209"><td class="num" id="LN2209">2209</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Unable to AUTH to MASTER: %s"</span>,err);</td></tr>
<tr class="codeline" data-linenumber="2210"><td class="num" id="LN2210">2210</td><td class="line">            sdsfree(err);</td></tr>
<tr class="codeline" data-linenumber="2211"><td class="num" id="LN2211">2211</td><td class="line">            <span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="2212"><td class="num" id="LN2212">2212</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2213"><td class="num" id="LN2213">2213</td><td class="line">        sdsfree(err);</td></tr>
<tr class="codeline" data-linenumber="2214"><td class="num" id="LN2214">2214</td><td class="line">        server.repl_state = <span class='macro'>REPL_STATE_SEND_PORT<span class='macro_popup'>6</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2215"><td class="num" id="LN2215">2215</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2216"><td class="num" id="LN2216">2216</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2217"><td class="num" id="LN2217">2217</td><td class="line">    <span class='comment'>/* Set the slave port, so that Master's INFO command can list the</span></td></tr>
<tr class="codeline" data-linenumber="2218"><td class="num" id="LN2218">2218</td><td class="line">     <span class='comment'>* slave listening port correctly. */</span></td></tr>
<tr class="codeline" data-linenumber="2219"><td class="num" id="LN2219">2219</td><td class="line">    <span class='keyword'>if</span> (server.repl_state == <span class='macro'>REPL_STATE_SEND_PORT<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2220"><td class="num" id="LN2220">2220</td><td class="line">        <span class='keyword'>int</span> port;</td></tr>
<tr class="codeline" data-linenumber="2221"><td class="num" id="LN2221">2221</td><td class="line">        <span class='keyword'>if</span> (server.slave_announce_port) port = server.slave_announce_port;</td></tr>
<tr class="codeline" data-linenumber="2222"><td class="num" id="LN2222">2222</td><td class="line">        <span class='keyword'>else</span> <span class='keyword'>if</span> (server.tls_replication &amp;&amp; server.tls_port) port = server.tls_port;</td></tr>
<tr class="codeline" data-linenumber="2223"><td class="num" id="LN2223">2223</td><td class="line">        <span class='keyword'>else</span> port = server.port;</td></tr>
<tr class="codeline" data-linenumber="2224"><td class="num" id="LN2224">2224</td><td class="line">        sds portstr = sdsfromlonglong(port);</td></tr>
<tr class="codeline" data-linenumber="2225"><td class="num" id="LN2225">2225</td><td class="line">        err = sendSynchronousCommand(<span class='macro'>SYNC_CMD_WRITE<span class='macro_popup'>(1&lt;&lt;1)</span></span>,conn,<span class='string_literal'>"REPLCONF"</span>,</td></tr>
<tr class="codeline" data-linenumber="2226"><td class="num" id="LN2226">2226</td><td class="line">                <span class='string_literal'>"listening-port"</span>,portstr, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2227"><td class="num" id="LN2227">2227</td><td class="line">        sdsfree(portstr);</td></tr>
<tr class="codeline" data-linenumber="2228"><td class="num" id="LN2228">2228</td><td class="line">        <span class='keyword'>if</span> (err) <span class='keyword'>goto</span> write_error;</td></tr>
<tr class="codeline" data-linenumber="2229"><td class="num" id="LN2229">2229</td><td class="line">        sdsfree(err);</td></tr>
<tr class="codeline" data-linenumber="2230"><td class="num" id="LN2230">2230</td><td class="line">        server.repl_state = <span class='macro'>REPL_STATE_RECEIVE_PORT<span class='macro_popup'>7</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2231"><td class="num" id="LN2231">2231</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2232"><td class="num" id="LN2232">2232</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2233"><td class="num" id="LN2233">2233</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2234"><td class="num" id="LN2234">2234</td><td class="line">    <span class='comment'>/* Receive REPLCONF listening-port reply. */</span></td></tr>
<tr class="codeline" data-linenumber="2235"><td class="num" id="LN2235">2235</td><td class="line">    <span class='keyword'>if</span> (server.repl_state == <span class='macro'>REPL_STATE_RECEIVE_PORT<span class='macro_popup'>7</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2236"><td class="num" id="LN2236">2236</td><td class="line">        err = sendSynchronousCommand(<span class='macro'>SYNC_CMD_READ<span class='macro_popup'>(1&lt;&lt;0)</span></span>,conn,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2237"><td class="num" id="LN2237">2237</td><td class="line">        <span class='comment'>/* Ignore the error if any, not all the Redis versions support</span></td></tr>
<tr class="codeline" data-linenumber="2238"><td class="num" id="LN2238">2238</td><td class="line">         <span class='comment'>* REPLCONF listening-port. */</span></td></tr>
<tr class="codeline" data-linenumber="2239"><td class="num" id="LN2239">2239</td><td class="line">        <span class='keyword'>if</span> (err[0] == '-') {</td></tr>
<tr class="codeline" data-linenumber="2240"><td class="num" id="LN2240">2240</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"(Non critical) Master does not understand "</span></td></tr>
<tr class="codeline" data-linenumber="2241"><td class="num" id="LN2241">2241</td><td class="line">                                <span class='string_literal'>"REPLCONF listening-port: %s"</span>, err);</td></tr>
<tr class="codeline" data-linenumber="2242"><td class="num" id="LN2242">2242</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2243"><td class="num" id="LN2243">2243</td><td class="line">        sdsfree(err);</td></tr>
<tr class="codeline" data-linenumber="2244"><td class="num" id="LN2244">2244</td><td class="line">        server.repl_state = <span class='macro'>REPL_STATE_SEND_IP<span class='macro_popup'>8</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2245"><td class="num" id="LN2245">2245</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2246"><td class="num" id="LN2246">2246</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2247"><td class="num" id="LN2247">2247</td><td class="line">    <span class='comment'>/* Skip REPLCONF ip-address if there is no slave-announce-ip option set. */</span></td></tr>
<tr class="codeline" data-linenumber="2248"><td class="num" id="LN2248">2248</td><td class="line">    <span class='keyword'>if</span> (server.repl_state == <span class='macro'>REPL_STATE_SEND_IP<span class='macro_popup'>8</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2249"><td class="num" id="LN2249">2249</td><td class="line">        server.slave_announce_ip == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2250"><td class="num" id="LN2250">2250</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2251"><td class="num" id="LN2251">2251</td><td class="line">            server.repl_state = <span class='macro'>REPL_STATE_SEND_CAPA<span class='macro_popup'>10</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2252"><td class="num" id="LN2252">2252</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2253"><td class="num" id="LN2253">2253</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2254"><td class="num" id="LN2254">2254</td><td class="line">    <span class='comment'>/* Set the slave ip, so that Master's INFO command can list the</span></td></tr>
<tr class="codeline" data-linenumber="2255"><td class="num" id="LN2255">2255</td><td class="line">     <span class='comment'>* slave IP address port correctly in case of port forwarding or NAT. */</span></td></tr>
<tr class="codeline" data-linenumber="2256"><td class="num" id="LN2256">2256</td><td class="line">    <span class='keyword'>if</span> (server.repl_state == <span class='macro'>REPL_STATE_SEND_IP<span class='macro_popup'>8</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2257"><td class="num" id="LN2257">2257</td><td class="line">        err = sendSynchronousCommand(<span class='macro'>SYNC_CMD_WRITE<span class='macro_popup'>(1&lt;&lt;1)</span></span>,conn,<span class='string_literal'>"REPLCONF"</span>,</td></tr>
<tr class="codeline" data-linenumber="2258"><td class="num" id="LN2258">2258</td><td class="line">                <span class='string_literal'>"ip-address"</span>,server.slave_announce_ip, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2259"><td class="num" id="LN2259">2259</td><td class="line">        <span class='keyword'>if</span> (err) <span class='keyword'>goto</span> write_error;</td></tr>
<tr class="codeline" data-linenumber="2260"><td class="num" id="LN2260">2260</td><td class="line">        sdsfree(err);</td></tr>
<tr class="codeline" data-linenumber="2261"><td class="num" id="LN2261">2261</td><td class="line">        server.repl_state = <span class='macro'>REPL_STATE_RECEIVE_IP<span class='macro_popup'>9</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2262"><td class="num" id="LN2262">2262</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2263"><td class="num" id="LN2263">2263</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2264"><td class="num" id="LN2264">2264</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2265"><td class="num" id="LN2265">2265</td><td class="line">    <span class='comment'>/* Receive REPLCONF ip-address reply. */</span></td></tr>
<tr class="codeline" data-linenumber="2266"><td class="num" id="LN2266">2266</td><td class="line">    <span class='keyword'>if</span> (server.repl_state == <span class='macro'>REPL_STATE_RECEIVE_IP<span class='macro_popup'>9</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2267"><td class="num" id="LN2267">2267</td><td class="line">        err = sendSynchronousCommand(<span class='macro'>SYNC_CMD_READ<span class='macro_popup'>(1&lt;&lt;0)</span></span>,conn,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2268"><td class="num" id="LN2268">2268</td><td class="line">        <span class='comment'>/* Ignore the error if any, not all the Redis versions support</span></td></tr>
<tr class="codeline" data-linenumber="2269"><td class="num" id="LN2269">2269</td><td class="line">         <span class='comment'>* REPLCONF listening-port. */</span></td></tr>
<tr class="codeline" data-linenumber="2270"><td class="num" id="LN2270">2270</td><td class="line">        <span class='keyword'>if</span> (err[0] == '-') {</td></tr>
<tr class="codeline" data-linenumber="2271"><td class="num" id="LN2271">2271</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"(Non critical) Master does not understand "</span></td></tr>
<tr class="codeline" data-linenumber="2272"><td class="num" id="LN2272">2272</td><td class="line">                                <span class='string_literal'>"REPLCONF ip-address: %s"</span>, err);</td></tr>
<tr class="codeline" data-linenumber="2273"><td class="num" id="LN2273">2273</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2274"><td class="num" id="LN2274">2274</td><td class="line">        sdsfree(err);</td></tr>
<tr class="codeline" data-linenumber="2275"><td class="num" id="LN2275">2275</td><td class="line">        server.repl_state = <span class='macro'>REPL_STATE_SEND_CAPA<span class='macro_popup'>10</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2276"><td class="num" id="LN2276">2276</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2277"><td class="num" id="LN2277">2277</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2278"><td class="num" id="LN2278">2278</td><td class="line">    <span class='comment'>/* Inform the master of our (slave) capabilities.</span></td></tr>
<tr class="codeline" data-linenumber="2279"><td class="num" id="LN2279">2279</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2280"><td class="num" id="LN2280">2280</td><td class="line">     <span class='comment'>* EOF: supports EOF-style RDB transfer for diskless replication.</span></td></tr>
<tr class="codeline" data-linenumber="2281"><td class="num" id="LN2281">2281</td><td class="line">     <span class='comment'>* PSYNC2: supports PSYNC v2, so understands +CONTINUE &lt;new repl ID&gt;.</span></td></tr>
<tr class="codeline" data-linenumber="2282"><td class="num" id="LN2282">2282</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2283"><td class="num" id="LN2283">2283</td><td class="line">     <span class='comment'>* The master will ignore capabilities it does not understand. */</span></td></tr>
<tr class="codeline" data-linenumber="2284"><td class="num" id="LN2284">2284</td><td class="line">    <span class='keyword'>if</span> (server.repl_state == <span class='macro'>REPL_STATE_SEND_CAPA<span class='macro_popup'>10</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2285"><td class="num" id="LN2285">2285</td><td class="line">        err = sendSynchronousCommand(<span class='macro'>SYNC_CMD_WRITE<span class='macro_popup'>(1&lt;&lt;1)</span></span>,conn,<span class='string_literal'>"REPLCONF"</span>,</td></tr>
<tr class="codeline" data-linenumber="2286"><td class="num" id="LN2286">2286</td><td class="line">                <span class='string_literal'>"capa"</span>,<span class='string_literal'>"eof"</span>,<span class='string_literal'>"capa"</span>,<span class='string_literal'>"psync2"</span>,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2287"><td class="num" id="LN2287">2287</td><td class="line">        <span class='keyword'>if</span> (err) <span class='keyword'>goto</span> write_error;</td></tr>
<tr class="codeline" data-linenumber="2288"><td class="num" id="LN2288">2288</td><td class="line">        sdsfree(err);</td></tr>
<tr class="codeline" data-linenumber="2289"><td class="num" id="LN2289">2289</td><td class="line">        server.repl_state = <span class='macro'>REPL_STATE_RECEIVE_CAPA<span class='macro_popup'>11</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2290"><td class="num" id="LN2290">2290</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2291"><td class="num" id="LN2291">2291</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2292"><td class="num" id="LN2292">2292</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2293"><td class="num" id="LN2293">2293</td><td class="line">    <span class='comment'>/* Receive CAPA reply. */</span></td></tr>
<tr class="codeline" data-linenumber="2294"><td class="num" id="LN2294">2294</td><td class="line">    <span class='keyword'>if</span> (server.repl_state == <span class='macro'>REPL_STATE_RECEIVE_CAPA<span class='macro_popup'>11</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2295"><td class="num" id="LN2295">2295</td><td class="line">        err = sendSynchronousCommand(<span class='macro'>SYNC_CMD_READ<span class='macro_popup'>(1&lt;&lt;0)</span></span>,conn,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2296"><td class="num" id="LN2296">2296</td><td class="line">        <span class='comment'>/* Ignore the error if any, not all the Redis versions support</span></td></tr>
<tr class="codeline" data-linenumber="2297"><td class="num" id="LN2297">2297</td><td class="line">         <span class='comment'>* REPLCONF capa. */</span></td></tr>
<tr class="codeline" data-linenumber="2298"><td class="num" id="LN2298">2298</td><td class="line">        <span class='keyword'>if</span> (err[0] == '-') {</td></tr>
<tr class="codeline" data-linenumber="2299"><td class="num" id="LN2299">2299</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"(Non critical) Master does not understand "</span></td></tr>
<tr class="codeline" data-linenumber="2300"><td class="num" id="LN2300">2300</td><td class="line">                                  <span class='string_literal'>"REPLCONF capa: %s"</span>, err);</td></tr>
<tr class="codeline" data-linenumber="2301"><td class="num" id="LN2301">2301</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2302"><td class="num" id="LN2302">2302</td><td class="line">        sdsfree(err);</td></tr>
<tr class="codeline" data-linenumber="2303"><td class="num" id="LN2303">2303</td><td class="line">        server.repl_state = <span class='macro'>REPL_STATE_SEND_PSYNC<span class='macro_popup'>12</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2304"><td class="num" id="LN2304">2304</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2305"><td class="num" id="LN2305">2305</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2306"><td class="num" id="LN2306">2306</td><td class="line">    <span class='comment'>/* Try a partial resynchonization. If we don't have a cached master</span></td></tr>
<tr class="codeline" data-linenumber="2307"><td class="num" id="LN2307">2307</td><td class="line">     <span class='comment'>* slaveTryPartialResynchronization() will at least try to use PSYNC</span></td></tr>
<tr class="codeline" data-linenumber="2308"><td class="num" id="LN2308">2308</td><td class="line">     <span class='comment'>* to start a full resynchronization so that we get the master replid</span></td></tr>
<tr class="codeline" data-linenumber="2309"><td class="num" id="LN2309">2309</td><td class="line">     <span class='comment'>* and the global offset, to try a partial resync at the next</span></td></tr>
<tr class="codeline" data-linenumber="2310"><td class="num" id="LN2310">2310</td><td class="line">     <span class='comment'>* reconnection attempt. */</span></td></tr>
<tr class="codeline" data-linenumber="2311"><td class="num" id="LN2311">2311</td><td class="line">    <span class='keyword'>if</span> (server.repl_state == <span class='macro'>REPL_STATE_SEND_PSYNC<span class='macro_popup'>12</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2312"><td class="num" id="LN2312">2312</td><td class="line">        <span class='keyword'>if</span> (slaveTryPartialResynchronization(conn,0) == <span class='macro'>PSYNC_WRITE_ERROR<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2313"><td class="num" id="LN2313">2313</td><td class="line">            err = sdsnew(<span class='string_literal'>"Write error sending the PSYNC command."</span>);</td></tr>
<tr class="codeline" data-linenumber="2314"><td class="num" id="LN2314">2314</td><td class="line">            <span class='keyword'>goto</span> write_error;</td></tr>
<tr class="codeline" data-linenumber="2315"><td class="num" id="LN2315">2315</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2316"><td class="num" id="LN2316">2316</td><td class="line">        server.repl_state = <span class='macro'>REPL_STATE_RECEIVE_PSYNC<span class='macro_popup'>13</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2317"><td class="num" id="LN2317">2317</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2318"><td class="num" id="LN2318">2318</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2319"><td class="num" id="LN2319">2319</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2320"><td class="num" id="LN2320">2320</td><td class="line">    <span class='comment'>/* If reached this point, we should be in REPL_STATE_RECEIVE_PSYNC. */</span></td></tr>
<tr class="codeline" data-linenumber="2321"><td class="num" id="LN2321">2321</td><td class="line">    <span class='keyword'>if</span> (server.repl_state != <span class='macro'>REPL_STATE_RECEIVE_PSYNC<span class='macro_popup'>13</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2322"><td class="num" id="LN2322">2322</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"syncWithMaster(): state machine error, "</span></td></tr>
<tr class="codeline" data-linenumber="2323"><td class="num" id="LN2323">2323</td><td class="line">                             <span class='string_literal'>"state should be RECEIVE_PSYNC but is %d"</span>,</td></tr>
<tr class="codeline" data-linenumber="2324"><td class="num" id="LN2324">2324</td><td class="line">                             server.repl_state);</td></tr>
<tr class="codeline" data-linenumber="2325"><td class="num" id="LN2325">2325</td><td class="line">        <span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="2326"><td class="num" id="LN2326">2326</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2327"><td class="num" id="LN2327">2327</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2328"><td class="num" id="LN2328">2328</td><td class="line">    psync_result = slaveTryPartialResynchronization(conn,1);</td></tr>
<tr class="codeline" data-linenumber="2329"><td class="num" id="LN2329">2329</td><td class="line">    <span class='keyword'>if</span> (psync_result == <span class='macro'>PSYNC_WAIT_REPLY<span class='macro_popup'>1</span></span>) <span class='keyword'>return</span>; <span class='comment'>/* Try again later... */</span></td></tr>
<tr class="codeline" data-linenumber="2330"><td class="num" id="LN2330">2330</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2331"><td class="num" id="LN2331">2331</td><td class="line">    <span class='comment'>/* If the master is in an transient error, we should try to PSYNC</span></td></tr>
<tr class="codeline" data-linenumber="2332"><td class="num" id="LN2332">2332</td><td class="line">     <span class='comment'>* from scratch later, so go to the error path. This happens when</span></td></tr>
<tr class="codeline" data-linenumber="2333"><td class="num" id="LN2333">2333</td><td class="line">     <span class='comment'>* the server is loading the dataset or is not connected with its</span></td></tr>
<tr class="codeline" data-linenumber="2334"><td class="num" id="LN2334">2334</td><td class="line">     <span class='comment'>* master and so forth. */</span></td></tr>
<tr class="codeline" data-linenumber="2335"><td class="num" id="LN2335">2335</td><td class="line">    <span class='keyword'>if</span> (psync_result == <span class='macro'>PSYNC_TRY_LATER<span class='macro_popup'>5</span></span>) <span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="2336"><td class="num" id="LN2336">2336</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2337"><td class="num" id="LN2337">2337</td><td class="line">    <span class='comment'>/* Note: if PSYNC does not return WAIT_REPLY, it will take care of</span></td></tr>
<tr class="codeline" data-linenumber="2338"><td class="num" id="LN2338">2338</td><td class="line">     <span class='comment'>* uninstalling the read handler from the file descriptor. */</span></td></tr>
<tr class="codeline" data-linenumber="2339"><td class="num" id="LN2339">2339</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2340"><td class="num" id="LN2340">2340</td><td class="line">    <span class='keyword'>if</span> (psync_result == <span class='macro'>PSYNC_CONTINUE<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2341"><td class="num" id="LN2341">2341</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>, <span class='string_literal'>"MASTER &lt;-&gt; REPLICA sync: Master accepted a Partial Resynchronization."</span>);</td></tr>
<tr class="codeline" data-linenumber="2342"><td class="num" id="LN2342">2342</td><td class="line">        <span class='keyword'>if</span> (server.supervised_mode == <span class='macro'>SUPERVISED_SYSTEMD<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2343"><td class="num" id="LN2343">2343</td><td class="line">            redisCommunicateSystemd(<span class='string_literal'>"STATUS=MASTER &lt;-&gt; REPLICA sync: Partial Resynchronization accepted. Ready to accept connections.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="2344"><td class="num" id="LN2344">2344</td><td class="line">            redisCommunicateSystemd(<span class='string_literal'>"READY=1\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="2345"><td class="num" id="LN2345">2345</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2346"><td class="num" id="LN2346">2346</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2347"><td class="num" id="LN2347">2347</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2348"><td class="num" id="LN2348">2348</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2349"><td class="num" id="LN2349">2349</td><td class="line">    <span class='comment'>/* PSYNC failed or is not supported: we want our slaves to resync with us</span></td></tr>
<tr class="codeline" data-linenumber="2350"><td class="num" id="LN2350">2350</td><td class="line">     <span class='comment'>* as well, if we have any sub-slaves. The master may transfer us an</span></td></tr>
<tr class="codeline" data-linenumber="2351"><td class="num" id="LN2351">2351</td><td class="line">     <span class='comment'>* entirely different data set and we have no way to incrementally feed</span></td></tr>
<tr class="codeline" data-linenumber="2352"><td class="num" id="LN2352">2352</td><td class="line">     <span class='comment'>* our slaves after that. */</span></td></tr>
<tr class="codeline" data-linenumber="2353"><td class="num" id="LN2353">2353</td><td class="line">    disconnectSlaves(); <span class='comment'>/* Force our slaves to resync with us as well. */</span></td></tr>
<tr class="codeline" data-linenumber="2354"><td class="num" id="LN2354">2354</td><td class="line">    freeReplicationBacklog(); <span class='comment'>/* Don't allow our chained slaves to PSYNC. */</span></td></tr>
<tr class="codeline" data-linenumber="2355"><td class="num" id="LN2355">2355</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2356"><td class="num" id="LN2356">2356</td><td class="line">    <span class='comment'>/* Fall back to SYNC if needed. Otherwise psync_result == PSYNC_FULLRESYNC</span></td></tr>
<tr class="codeline" data-linenumber="2357"><td class="num" id="LN2357">2357</td><td class="line">     <span class='comment'>* and the server.master_replid and master_initial_offset are</span></td></tr>
<tr class="codeline" data-linenumber="2358"><td class="num" id="LN2358">2358</td><td class="line">     <span class='comment'>* already populated. */</span></td></tr>
<tr class="codeline" data-linenumber="2359"><td class="num" id="LN2359">2359</td><td class="line">    <span class='keyword'>if</span> (psync_result == <span class='macro'>PSYNC_NOT_SUPPORTED<span class='macro_popup'>4</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2360"><td class="num" id="LN2360">2360</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Retrying with SYNC..."</span>);</td></tr>
<tr class="codeline" data-linenumber="2361"><td class="num" id="LN2361">2361</td><td class="line">        <span class='keyword'>if</span> (connSyncWrite(conn,<span class='string_literal'>"SYNC\r\n"</span>,6,server.repl_syncio_timeout*1000) == -1) {</td></tr>
<tr class="codeline" data-linenumber="2362"><td class="num" id="LN2362">2362</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"I/O error writing to MASTER: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="2363"><td class="num" id="LN2363">2363</td><td class="line">                strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="2364"><td class="num" id="LN2364">2364</td><td class="line">            <span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="2365"><td class="num" id="LN2365">2365</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2366"><td class="num" id="LN2366">2366</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2367"><td class="num" id="LN2367">2367</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2368"><td class="num" id="LN2368">2368</td><td class="line">    <span class='comment'>/* Prepare a suitable temp file for bulk transfer */</span></td></tr>
<tr class="codeline" data-linenumber="2369"><td class="num" id="LN2369">2369</td><td class="line">    <span class='keyword'>if</span> (!useDisklessLoad()) {</td></tr>
<tr class="codeline" data-linenumber="2370"><td class="num" id="LN2370">2370</td><td class="line">        <span class='keyword'>while</span>(maxtries--) {</td></tr>
<tr class="codeline" data-linenumber="2371"><td class="num" id="LN2371">2371</td><td class="line">            snprintf(tmpfile,256,</td></tr>
<tr class="codeline" data-linenumber="2372"><td class="num" id="LN2372">2372</td><td class="line">                <span class='string_literal'>"temp-%d.%ld.rdb"</span>,(<span class='keyword'>int</span>)server.unixtime,(<span class='keyword'>long</span> <span class='keyword'>int</span>)getpid());</td></tr>
<tr class="codeline" data-linenumber="2373"><td class="num" id="LN2373">2373</td><td class="line">            dfd = open(tmpfile,<span class='macro'>O_CREAT<span class='macro_popup'>0100</span></span>|<span class='macro'>O_WRONLY<span class='macro_popup'>01</span></span>|<span class='macro'>O_EXCL<span class='macro_popup'>0200</span></span>,0644);</td></tr>
<tr class="codeline" data-linenumber="2374"><td class="num" id="LN2374">2374</td><td class="line">            <span class='keyword'>if</span> (dfd != -1) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2375"><td class="num" id="LN2375">2375</td><td class="line">            sleep(1);</td></tr>
<tr class="codeline" data-linenumber="2376"><td class="num" id="LN2376">2376</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2377"><td class="num" id="LN2377">2377</td><td class="line">        <span class='keyword'>if</span> (dfd == -1) {</td></tr>
<tr class="codeline" data-linenumber="2378"><td class="num" id="LN2378">2378</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Opening the temp file needed for MASTER &lt;-&gt; REPLICA synchronization: %s"</span>,strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="2379"><td class="num" id="LN2379">2379</td><td class="line">            <span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="2380"><td class="num" id="LN2380">2380</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2381"><td class="num" id="LN2381">2381</td><td class="line">        server.repl_transfer_tmpfile = zstrdup(tmpfile);</td></tr>
<tr class="codeline" data-linenumber="2382"><td class="num" id="LN2382">2382</td><td class="line">        server.repl_transfer_fd = dfd;</td></tr>
<tr class="codeline" data-linenumber="2383"><td class="num" id="LN2383">2383</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2384"><td class="num" id="LN2384">2384</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2385"><td class="num" id="LN2385">2385</td><td class="line">    <span class='comment'>/* Setup the non blocking download of the bulk file. */</span></td></tr>
<tr class="codeline" data-linenumber="2386"><td class="num" id="LN2386">2386</td><td class="line">    <span class='keyword'>if</span> (connSetReadHandler(conn, readSyncBulkPayload)</td></tr>
<tr class="codeline" data-linenumber="2387"><td class="num" id="LN2387">2387</td><td class="line">            == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2388"><td class="num" id="LN2388">2388</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2389"><td class="num" id="LN2389">2389</td><td class="line">        <span class='keyword'>char</span> conninfo[<span class='macro'>CONN_INFO_LEN<span class='macro_popup'>32</span></span>];</td></tr>
<tr class="codeline" data-linenumber="2390"><td class="num" id="LN2390">2390</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2391"><td class="num" id="LN2391">2391</td><td class="line">            <span class='string_literal'>"Can't create readable event for SYNC: %s (%s)"</span>,</td></tr>
<tr class="codeline" data-linenumber="2392"><td class="num" id="LN2392">2392</td><td class="line">            strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>), connGetInfo(conn, conninfo, <span class='keyword'>sizeof</span>(conninfo)));</td></tr>
<tr class="codeline" data-linenumber="2393"><td class="num" id="LN2393">2393</td><td class="line">        <span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="2394"><td class="num" id="LN2394">2394</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2395"><td class="num" id="LN2395">2395</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2396"><td class="num" id="LN2396">2396</td><td class="line">    server.repl_state = <span class='macro'>REPL_STATE_TRANSFER<span class='macro_popup'>14</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2397"><td class="num" id="LN2397">2397</td><td class="line">    server.repl_transfer_size = -1;</td></tr>
<tr class="codeline" data-linenumber="2398"><td class="num" id="LN2398">2398</td><td class="line">    server.repl_transfer_read = 0;</td></tr>
<tr class="codeline" data-linenumber="2399"><td class="num" id="LN2399">2399</td><td class="line">    server.repl_transfer_last_fsync_off = 0;</td></tr>
<tr class="codeline" data-linenumber="2400"><td class="num" id="LN2400">2400</td><td class="line">    server.repl_transfer_lastio = server.unixtime;</td></tr>
<tr class="codeline" data-linenumber="2401"><td class="num" id="LN2401">2401</td><td class="line">    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2402"><td class="num" id="LN2402">2402</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2403"><td class="num" id="LN2403">2403</td><td class="line">error:</td></tr>
<tr class="codeline" data-linenumber="2404"><td class="num" id="LN2404">2404</td><td class="line">    <span class='keyword'>if</span> (dfd != -1) close(dfd);</td></tr>
<tr class="codeline" data-linenumber="2405"><td class="num" id="LN2405">2405</td><td class="line">    connClose(conn);</td></tr>
<tr class="codeline" data-linenumber="2406"><td class="num" id="LN2406">2406</td><td class="line">    server.repl_transfer_s = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2407"><td class="num" id="LN2407">2407</td><td class="line">    <span class='keyword'>if</span> (server.repl_transfer_fd != -1)</td></tr>
<tr class="codeline" data-linenumber="2408"><td class="num" id="LN2408">2408</td><td class="line">        close(server.repl_transfer_fd);</td></tr>
<tr class="codeline" data-linenumber="2409"><td class="num" id="LN2409">2409</td><td class="line">    <span class='keyword'>if</span> (server.repl_transfer_tmpfile)</td></tr>
<tr class="codeline" data-linenumber="2410"><td class="num" id="LN2410">2410</td><td class="line">        zfree(server.repl_transfer_tmpfile);</td></tr>
<tr class="codeline" data-linenumber="2411"><td class="num" id="LN2411">2411</td><td class="line">    server.repl_transfer_tmpfile = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2412"><td class="num" id="LN2412">2412</td><td class="line">    server.repl_transfer_fd = -1;</td></tr>
<tr class="codeline" data-linenumber="2413"><td class="num" id="LN2413">2413</td><td class="line">    server.repl_state = <span class='macro'>REPL_STATE_CONNECT<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2414"><td class="num" id="LN2414">2414</td><td class="line">    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2415"><td class="num" id="LN2415">2415</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2416"><td class="num" id="LN2416">2416</td><td class="line">write_error: <span class='comment'>/* Handle sendSynchronousCommand(SYNC_CMD_WRITE) errors. */</span></td></tr>
<tr class="codeline" data-linenumber="2417"><td class="num" id="LN2417">2417</td><td class="line">    serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Sending command to master in replication handshake: %s"</span>, err);</td></tr>
<tr class="codeline" data-linenumber="2418"><td class="num" id="LN2418">2418</td><td class="line">    sdsfree(err);</td></tr>
<tr class="codeline" data-linenumber="2419"><td class="num" id="LN2419">2419</td><td class="line">    <span class='keyword'>goto</span> error;</td></tr>
<tr class="codeline" data-linenumber="2420"><td class="num" id="LN2420">2420</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2421"><td class="num" id="LN2421">2421</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2422"><td class="num" id="LN2422">2422</td><td class="line"><span class='keyword'>int</span> connectWithMaster(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="2423"><td class="num" id="LN2423">2423</td><td class="line">    server.repl_transfer_s = server.tls_replication ? connCreateTLS() : connCreateSocket();</td></tr>
<tr class="codeline" data-linenumber="2424"><td class="num" id="LN2424">2424</td><td class="line">    <span class='keyword'>if</span> (connConnect(server.repl_transfer_s, server.masterhost, server.masterport,</td></tr>
<tr class="codeline" data-linenumber="2425"><td class="num" id="LN2425">2425</td><td class="line">                <span class='macro'>NET_FIRST_BIND_ADDR<span class='macro_popup'>(server.bindaddr_count ? server.bindaddr[0] : ((void*)0))</span></span>, syncWithMaster) == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2426"><td class="num" id="LN2426">2426</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Unable to connect to MASTER: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="2427"><td class="num" id="LN2427">2427</td><td class="line">                connGetLastError(server.repl_transfer_s));</td></tr>
<tr class="codeline" data-linenumber="2428"><td class="num" id="LN2428">2428</td><td class="line">        connClose(server.repl_transfer_s);</td></tr>
<tr class="codeline" data-linenumber="2429"><td class="num" id="LN2429">2429</td><td class="line">        server.repl_transfer_s = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2430"><td class="num" id="LN2430">2430</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2431"><td class="num" id="LN2431">2431</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2432"><td class="num" id="LN2432">2432</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2433"><td class="num" id="LN2433">2433</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2434"><td class="num" id="LN2434">2434</td><td class="line">    server.repl_transfer_lastio = server.unixtime;</td></tr>
<tr class="codeline" data-linenumber="2435"><td class="num" id="LN2435">2435</td><td class="line">    server.repl_state = <span class='macro'>REPL_STATE_CONNECTING<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2436"><td class="num" id="LN2436">2436</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2437"><td class="num" id="LN2437">2437</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2438"><td class="num" id="LN2438">2438</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2439"><td class="num" id="LN2439">2439</td><td class="line"><span class='comment'>/* This function can be called when a non blocking connection is currently</span></td></tr>
<tr class="codeline" data-linenumber="2440"><td class="num" id="LN2440">2440</td><td class="line"> <span class='comment'>* in progress to undo it.</span></td></tr>
<tr class="codeline" data-linenumber="2441"><td class="num" id="LN2441">2441</td><td class="line"> <span class='comment'>* Never call this function directly, use cancelReplicationHandshake() instead.</span></td></tr>
<tr class="codeline" data-linenumber="2442"><td class="num" id="LN2442">2442</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2443"><td class="num" id="LN2443">2443</td><td class="line"><span class='keyword'>void</span> undoConnectWithMaster(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="2444"><td class="num" id="LN2444">2444</td><td class="line">    connClose(server.repl_transfer_s);</td></tr>
<tr class="codeline" data-linenumber="2445"><td class="num" id="LN2445">2445</td><td class="line">    server.repl_transfer_s = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2446"><td class="num" id="LN2446">2446</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2447"><td class="num" id="LN2447">2447</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2448"><td class="num" id="LN2448">2448</td><td class="line"><span class='comment'>/* Abort the async download of the bulk dataset while SYNC-ing with master.</span></td></tr>
<tr class="codeline" data-linenumber="2449"><td class="num" id="LN2449">2449</td><td class="line"> <span class='comment'>* Never call this function directly, use cancelReplicationHandshake() instead.</span></td></tr>
<tr class="codeline" data-linenumber="2450"><td class="num" id="LN2450">2450</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2451"><td class="num" id="LN2451">2451</td><td class="line"><span class='keyword'>void</span> replicationAbortSyncTransfer(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="2452"><td class="num" id="LN2452">2452</td><td class="line">    <span class='macro'>serverAssert(server.repl_state == REPL_STATE_TRANSFER)<span class='macro_popup'>((server.repl_state == 14)?(void)0 : (_serverAssert("server.repl_state == REPL_STATE_TRANSFER"<br>,"replication.c",2452),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2453"><td class="num" id="LN2453">2453</td><td class="line">    undoConnectWithMaster();</td></tr>
<tr class="codeline" data-linenumber="2454"><td class="num" id="LN2454">2454</td><td class="line">    <span class='keyword'>if</span> (server.repl_transfer_fd!=-1) {</td></tr>
<tr class="codeline" data-linenumber="2455"><td class="num" id="LN2455">2455</td><td class="line">        close(server.repl_transfer_fd);</td></tr>
<tr class="codeline" data-linenumber="2456"><td class="num" id="LN2456">2456</td><td class="line">        bg_unlink(server.repl_transfer_tmpfile);</td></tr>
<tr class="codeline" data-linenumber="2457"><td class="num" id="LN2457">2457</td><td class="line">        zfree(server.repl_transfer_tmpfile);</td></tr>
<tr class="codeline" data-linenumber="2458"><td class="num" id="LN2458">2458</td><td class="line">        server.repl_transfer_tmpfile = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2459"><td class="num" id="LN2459">2459</td><td class="line">        server.repl_transfer_fd = -1;</td></tr>
<tr class="codeline" data-linenumber="2460"><td class="num" id="LN2460">2460</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2461"><td class="num" id="LN2461">2461</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2462"><td class="num" id="LN2462">2462</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2463"><td class="num" id="LN2463">2463</td><td class="line"><span class='comment'>/* This function aborts a non blocking replication attempt if there is one</span></td></tr>
<tr class="codeline" data-linenumber="2464"><td class="num" id="LN2464">2464</td><td class="line"> <span class='comment'>* in progress, by canceling the non-blocking connect attempt or</span></td></tr>
<tr class="codeline" data-linenumber="2465"><td class="num" id="LN2465">2465</td><td class="line"> <span class='comment'>* the initial bulk transfer.</span></td></tr>
<tr class="codeline" data-linenumber="2466"><td class="num" id="LN2466">2466</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2467"><td class="num" id="LN2467">2467</td><td class="line"> <span class='comment'>* If there was a replication handshake in progress 1 is returned and</span></td></tr>
<tr class="codeline" data-linenumber="2468"><td class="num" id="LN2468">2468</td><td class="line"> <span class='comment'>* the replication state (server.repl_state) set to REPL_STATE_CONNECT.</span></td></tr>
<tr class="codeline" data-linenumber="2469"><td class="num" id="LN2469">2469</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2470"><td class="num" id="LN2470">2470</td><td class="line"> <span class='comment'>* Otherwise zero is returned and no operation is performed at all. */</span></td></tr>
<tr class="codeline" data-linenumber="2471"><td class="num" id="LN2471">2471</td><td class="line"><span class='keyword'>int</span> cancelReplicationHandshake(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="2472"><td class="num" id="LN2472">2472</td><td class="line">    <span class='keyword'>if</span> (server.repl_state == <span class='macro'>REPL_STATE_TRANSFER<span class='macro_popup'>14</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2473"><td class="num" id="LN2473">2473</td><td class="line">        replicationAbortSyncTransfer();</td></tr>
<tr class="codeline" data-linenumber="2474"><td class="num" id="LN2474">2474</td><td class="line">        server.repl_state = <span class='macro'>REPL_STATE_CONNECT<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2475"><td class="num" id="LN2475">2475</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (server.repl_state == <span class='macro'>REPL_STATE_CONNECTING<span class='macro_popup'>2</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="2476"><td class="num" id="LN2476">2476</td><td class="line">               slaveIsInHandshakeState())</td></tr>
<tr class="codeline" data-linenumber="2477"><td class="num" id="LN2477">2477</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2478"><td class="num" id="LN2478">2478</td><td class="line">        undoConnectWithMaster();</td></tr>
<tr class="codeline" data-linenumber="2479"><td class="num" id="LN2479">2479</td><td class="line">        server.repl_state = <span class='macro'>REPL_STATE_CONNECT<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2480"><td class="num" id="LN2480">2480</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2481"><td class="num" id="LN2481">2481</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="2482"><td class="num" id="LN2482">2482</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2483"><td class="num" id="LN2483">2483</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="2484"><td class="num" id="LN2484">2484</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2485"><td class="num" id="LN2485">2485</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2486"><td class="num" id="LN2486">2486</td><td class="line"><span class='comment'>/* Set replication to the specified master address and port. */</span></td></tr>
<tr class="codeline" data-linenumber="2487"><td class="num" id="LN2487">2487</td><td class="line"><span class='keyword'>void</span> replicationSetMaster(<span class='keyword'>char</span> *ip, <span class='keyword'>int</span> port) {</td></tr>
<tr class="codeline" data-linenumber="2488"><td class="num" id="LN2488">2488</td><td class="line">    <span class='keyword'>int</span> was_master = server.masterhost == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2489"><td class="num" id="LN2489">2489</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2490"><td class="num" id="LN2490">2490</td><td class="line">    sdsfree(server.masterhost);</td></tr>
<tr class="codeline" data-linenumber="2491"><td class="num" id="LN2491">2491</td><td class="line">    server.masterhost = sdsnew(ip);</td></tr>
<tr class="codeline" data-linenumber="2492"><td class="num" id="LN2492">2492</td><td class="line">    server.masterport = port;</td></tr>
<tr class="codeline" data-linenumber="2493"><td class="num" id="LN2493">2493</td><td class="line">    <span class='keyword'>if</span> (server.master) {</td></tr>
<tr class="codeline" data-linenumber="2494"><td class="num" id="LN2494">2494</td><td class="line">        freeClient(server.master);</td></tr>
<tr class="codeline" data-linenumber="2495"><td class="num" id="LN2495">2495</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2496"><td class="num" id="LN2496">2496</td><td class="line">    disconnectAllBlockedClients(); <span class='comment'>/* Clients blocked in master, now slave. */</span></td></tr>
<tr class="codeline" data-linenumber="2497"><td class="num" id="LN2497">2497</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2498"><td class="num" id="LN2498">2498</td><td class="line">    <span class='comment'>/* Update oom_score_adj */</span></td></tr>
<tr class="codeline" data-linenumber="2499"><td class="num" id="LN2499">2499</td><td class="line">    setOOMScoreAdj(-1);</td></tr>
<tr class="codeline" data-linenumber="2500"><td class="num" id="LN2500">2500</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2501"><td class="num" id="LN2501">2501</td><td class="line">    <span class='comment'>/* Force our slaves to resync with us as well. They may hopefully be able</span></td></tr>
<tr class="codeline" data-linenumber="2502"><td class="num" id="LN2502">2502</td><td class="line">     <span class='comment'>* to partially resync with us, but we can notify the replid change. */</span></td></tr>
<tr class="codeline" data-linenumber="2503"><td class="num" id="LN2503">2503</td><td class="line">    disconnectSlaves();</td></tr>
<tr class="codeline" data-linenumber="2504"><td class="num" id="LN2504">2504</td><td class="line">    cancelReplicationHandshake();</td></tr>
<tr class="codeline" data-linenumber="2505"><td class="num" id="LN2505">2505</td><td class="line">    <span class='comment'>/* Before destroying our master state, create a cached master using</span></td></tr>
<tr class="codeline" data-linenumber="2506"><td class="num" id="LN2506">2506</td><td class="line">     <span class='comment'>* our own parameters, to later PSYNC with the new master. */</span></td></tr>
<tr class="codeline" data-linenumber="2507"><td class="num" id="LN2507">2507</td><td class="line">    <span class='keyword'>if</span> (was_master) {</td></tr>
<tr class="codeline" data-linenumber="2508"><td class="num" id="LN2508">2508</td><td class="line">        replicationDiscardCachedMaster();</td></tr>
<tr class="codeline" data-linenumber="2509"><td class="num" id="LN2509">2509</td><td class="line">        replicationCacheMasterUsingMyself();</td></tr>
<tr class="codeline" data-linenumber="2510"><td class="num" id="LN2510">2510</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2511"><td class="num" id="LN2511">2511</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2512"><td class="num" id="LN2512">2512</td><td class="line">    <span class='comment'>/* Fire the role change modules event. */</span></td></tr>
<tr class="codeline" data-linenumber="2513"><td class="num" id="LN2513">2513</td><td class="line">    moduleFireServerEvent(<span class='macro'>REDISMODULE_EVENT_REPLICATION_ROLE_CHANGED<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2514"><td class="num" id="LN2514">2514</td><td class="line">                          <span class='macro'>REDISMODULE_EVENT_REPLROLECHANGED_NOW_REPLICA<span class='macro_popup'>1</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2515"><td class="num" id="LN2515">2515</td><td class="line">                          <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2516"><td class="num" id="LN2516">2516</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2517"><td class="num" id="LN2517">2517</td><td class="line">    <span class='comment'>/* Fire the master link modules event. */</span></td></tr>
<tr class="codeline" data-linenumber="2518"><td class="num" id="LN2518">2518</td><td class="line">    <span class='keyword'>if</span> (server.repl_state == <span class='macro'>REPL_STATE_CONNECTED<span class='macro_popup'>15</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2519"><td class="num" id="LN2519">2519</td><td class="line">        moduleFireServerEvent(<span class='macro'>REDISMODULE_EVENT_MASTER_LINK_CHANGE<span class='macro_popup'>7</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2520"><td class="num" id="LN2520">2520</td><td class="line">                              <span class='macro'>REDISMODULE_SUBEVENT_MASTER_LINK_DOWN<span class='macro_popup'>1</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2521"><td class="num" id="LN2521">2521</td><td class="line">                              <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2522"><td class="num" id="LN2522">2522</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2523"><td class="num" id="LN2523">2523</td><td class="line">    server.repl_state = <span class='macro'>REPL_STATE_CONNECT<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2524"><td class="num" id="LN2524">2524</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2525"><td class="num" id="LN2525">2525</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2526"><td class="num" id="LN2526">2526</td><td class="line"><span class='comment'>/* Cancel replication, setting the instance as a master itself. */</span></td></tr>
<tr class="codeline" data-linenumber="2527"><td class="num" id="LN2527">2527</td><td class="line"><span class='keyword'>void</span> replicationUnsetMaster(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="2528"><td class="num" id="LN2528">2528</td><td class="line">    <span class='keyword'>if</span> (server.masterhost == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span>; <span class='comment'>/* Nothing to do. */</span></td></tr>
<tr class="codeline" data-linenumber="2529"><td class="num" id="LN2529">2529</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2530"><td class="num" id="LN2530">2530</td><td class="line">    <span class='comment'>/* Fire the master link modules event. */</span></td></tr>
<tr class="codeline" data-linenumber="2531"><td class="num" id="LN2531">2531</td><td class="line">    <span class='keyword'>if</span> (server.repl_state == <span class='macro'>REPL_STATE_CONNECTED<span class='macro_popup'>15</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2532"><td class="num" id="LN2532">2532</td><td class="line">        moduleFireServerEvent(<span class='macro'>REDISMODULE_EVENT_MASTER_LINK_CHANGE<span class='macro_popup'>7</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2533"><td class="num" id="LN2533">2533</td><td class="line">                              <span class='macro'>REDISMODULE_SUBEVENT_MASTER_LINK_DOWN<span class='macro_popup'>1</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2534"><td class="num" id="LN2534">2534</td><td class="line">                              <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2535"><td class="num" id="LN2535">2535</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2536"><td class="num" id="LN2536">2536</td><td class="line">    sdsfree(server.masterhost);</td></tr>
<tr class="codeline" data-linenumber="2537"><td class="num" id="LN2537">2537</td><td class="line">    server.masterhost = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2538"><td class="num" id="LN2538">2538</td><td class="line">    <span class='keyword'>if</span> (server.master) freeClient(server.master);</td></tr>
<tr class="codeline" data-linenumber="2539"><td class="num" id="LN2539">2539</td><td class="line">    replicationDiscardCachedMaster();</td></tr>
<tr class="codeline" data-linenumber="2540"><td class="num" id="LN2540">2540</td><td class="line">    cancelReplicationHandshake();</td></tr>
<tr class="codeline" data-linenumber="2541"><td class="num" id="LN2541">2541</td><td class="line">    <span class='comment'>/* When a slave is turned into a master, the current replication ID</span></td></tr>
<tr class="codeline" data-linenumber="2542"><td class="num" id="LN2542">2542</td><td class="line">     <span class='comment'>* (that was inherited from the master at synchronization time) is</span></td></tr>
<tr class="codeline" data-linenumber="2543"><td class="num" id="LN2543">2543</td><td class="line">     <span class='comment'>* used as secondary ID up to the current offset, and a new replication</span></td></tr>
<tr class="codeline" data-linenumber="2544"><td class="num" id="LN2544">2544</td><td class="line">     <span class='comment'>* ID is created to continue with a new replication history.</span></td></tr>
<tr class="codeline" data-linenumber="2545"><td class="num" id="LN2545">2545</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2546"><td class="num" id="LN2546">2546</td><td class="line">     <span class='comment'>* NOTE: this function MUST be called after we call</span></td></tr>
<tr class="codeline" data-linenumber="2547"><td class="num" id="LN2547">2547</td><td class="line">     <span class='comment'>* freeClient(server.master), since there we adjust the replication</span></td></tr>
<tr class="codeline" data-linenumber="2548"><td class="num" id="LN2548">2548</td><td class="line">     <span class='comment'>* offset trimming the final PINGs. See Github issue #7320. */</span></td></tr>
<tr class="codeline" data-linenumber="2549"><td class="num" id="LN2549">2549</td><td class="line">    shiftReplicationId();</td></tr>
<tr class="codeline" data-linenumber="2550"><td class="num" id="LN2550">2550</td><td class="line">    <span class='comment'>/* Disconnecting all the slaves is required: we need to inform slaves</span></td></tr>
<tr class="codeline" data-linenumber="2551"><td class="num" id="LN2551">2551</td><td class="line">     <span class='comment'>* of the replication ID change (see shiftReplicationId() call). However</span></td></tr>
<tr class="codeline" data-linenumber="2552"><td class="num" id="LN2552">2552</td><td class="line">     <span class='comment'>* the slaves will be able to partially resync with us, so it will be</span></td></tr>
<tr class="codeline" data-linenumber="2553"><td class="num" id="LN2553">2553</td><td class="line">     <span class='comment'>* a very fast reconnection. */</span></td></tr>
<tr class="codeline" data-linenumber="2554"><td class="num" id="LN2554">2554</td><td class="line">    disconnectSlaves();</td></tr>
<tr class="codeline" data-linenumber="2555"><td class="num" id="LN2555">2555</td><td class="line">    server.repl_state = <span class='macro'>REPL_STATE_NONE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2556"><td class="num" id="LN2556">2556</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2557"><td class="num" id="LN2557">2557</td><td class="line">    <span class='comment'>/* We need to make sure the new master will start the replication stream</span></td></tr>
<tr class="codeline" data-linenumber="2558"><td class="num" id="LN2558">2558</td><td class="line">     <span class='comment'>* with a SELECT statement. This is forced after a full resync, but</span></td></tr>
<tr class="codeline" data-linenumber="2559"><td class="num" id="LN2559">2559</td><td class="line">     <span class='comment'>* with PSYNC version 2, there is no need for full resync after a</span></td></tr>
<tr class="codeline" data-linenumber="2560"><td class="num" id="LN2560">2560</td><td class="line">     <span class='comment'>* master switch. */</span></td></tr>
<tr class="codeline" data-linenumber="2561"><td class="num" id="LN2561">2561</td><td class="line">    server.slaveseldb = -1;</td></tr>
<tr class="codeline" data-linenumber="2562"><td class="num" id="LN2562">2562</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2563"><td class="num" id="LN2563">2563</td><td class="line">    <span class='comment'>/* Update oom_score_adj */</span></td></tr>
<tr class="codeline" data-linenumber="2564"><td class="num" id="LN2564">2564</td><td class="line">    setOOMScoreAdj(-1);</td></tr>
<tr class="codeline" data-linenumber="2565"><td class="num" id="LN2565">2565</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2566"><td class="num" id="LN2566">2566</td><td class="line">    <span class='comment'>/* Once we turn from slave to master, we consider the starting time without</span></td></tr>
<tr class="codeline" data-linenumber="2567"><td class="num" id="LN2567">2567</td><td class="line">     <span class='comment'>* slaves (that is used to count the replication backlog time to live) as</span></td></tr>
<tr class="codeline" data-linenumber="2568"><td class="num" id="LN2568">2568</td><td class="line">     <span class='comment'>* starting from now. Otherwise the backlog will be freed after a</span></td></tr>
<tr class="codeline" data-linenumber="2569"><td class="num" id="LN2569">2569</td><td class="line">     <span class='comment'>* failover if slaves do not connect immediately. */</span></td></tr>
<tr class="codeline" data-linenumber="2570"><td class="num" id="LN2570">2570</td><td class="line">    server.repl_no_slaves_since = server.unixtime;</td></tr>
<tr class="codeline" data-linenumber="2571"><td class="num" id="LN2571">2571</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2572"><td class="num" id="LN2572">2572</td><td class="line">    <span class='comment'>/* Fire the role change modules event. */</span></td></tr>
<tr class="codeline" data-linenumber="2573"><td class="num" id="LN2573">2573</td><td class="line">    moduleFireServerEvent(<span class='macro'>REDISMODULE_EVENT_REPLICATION_ROLE_CHANGED<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2574"><td class="num" id="LN2574">2574</td><td class="line">                          <span class='macro'>REDISMODULE_EVENT_REPLROLECHANGED_NOW_MASTER<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2575"><td class="num" id="LN2575">2575</td><td class="line">                          <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2576"><td class="num" id="LN2576">2576</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2577"><td class="num" id="LN2577">2577</td><td class="line">    <span class='comment'>/* Restart the AOF subsystem in case we shut it down during a sync when</span></td></tr>
<tr class="codeline" data-linenumber="2578"><td class="num" id="LN2578">2578</td><td class="line">     <span class='comment'>* we were still a slave. */</span></td></tr>
<tr class="codeline" data-linenumber="2579"><td class="num" id="LN2579">2579</td><td class="line">    <span class='keyword'>if</span> (server.aof_enabled &amp;&amp; server.aof_state == <span class='macro'>AOF_OFF<span class='macro_popup'>0</span></span>) restartAOFAfterSYNC();</td></tr>
<tr class="codeline" data-linenumber="2580"><td class="num" id="LN2580">2580</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2581"><td class="num" id="LN2581">2581</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2582"><td class="num" id="LN2582">2582</td><td class="line"><span class='comment'>/* This function is called when the slave lose the connection with the</span></td></tr>
<tr class="codeline" data-linenumber="2583"><td class="num" id="LN2583">2583</td><td class="line"> <span class='comment'>* master into an unexpected way. */</span></td></tr>
<tr class="codeline" data-linenumber="2584"><td class="num" id="LN2584">2584</td><td class="line"><span class='keyword'>void</span> replicationHandleMasterDisconnection(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="2585"><td class="num" id="LN2585">2585</td><td class="line">    <span class='comment'>/* Fire the master link modules event. */</span></td></tr>
<tr class="codeline" data-linenumber="2586"><td class="num" id="LN2586">2586</td><td class="line">    <span class='keyword'>if</span> (server.repl_state == <span class='macro'>REPL_STATE_CONNECTED<span class='macro_popup'>15</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2587"><td class="num" id="LN2587">2587</td><td class="line">        moduleFireServerEvent(<span class='macro'>REDISMODULE_EVENT_MASTER_LINK_CHANGE<span class='macro_popup'>7</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2588"><td class="num" id="LN2588">2588</td><td class="line">                              <span class='macro'>REDISMODULE_SUBEVENT_MASTER_LINK_DOWN<span class='macro_popup'>1</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2589"><td class="num" id="LN2589">2589</td><td class="line">                              <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2590"><td class="num" id="LN2590">2590</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2591"><td class="num" id="LN2591">2591</td><td class="line">    server.master = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2592"><td class="num" id="LN2592">2592</td><td class="line">    server.repl_state = <span class='macro'>REPL_STATE_CONNECT<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2593"><td class="num" id="LN2593">2593</td><td class="line">    server.repl_down_since = server.unixtime;</td></tr>
<tr class="codeline" data-linenumber="2594"><td class="num" id="LN2594">2594</td><td class="line">    <span class='comment'>/* We lost connection with our master, don't disconnect slaves yet,</span></td></tr>
<tr class="codeline" data-linenumber="2595"><td class="num" id="LN2595">2595</td><td class="line">     <span class='comment'>* maybe we'll be able to PSYNC with our master later. We'll disconnect</span></td></tr>
<tr class="codeline" data-linenumber="2596"><td class="num" id="LN2596">2596</td><td class="line">     <span class='comment'>* the slaves only if we'll have to do a full resync with our master. */</span></td></tr>
<tr class="codeline" data-linenumber="2597"><td class="num" id="LN2597">2597</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2598"><td class="num" id="LN2598">2598</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2599"><td class="num" id="LN2599">2599</td><td class="line"><span class='keyword'>void</span> replicaofCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="2600"><td class="num" id="LN2600">2600</td><td class="line">    <span class='comment'>/* SLAVEOF is not allowed in cluster mode as replication is automatically</span></td></tr>
<tr class="codeline" data-linenumber="2601"><td class="num" id="LN2601">2601</td><td class="line">     <span class='comment'>* configured using the current address of the master node. */</span></td></tr>
<tr class="codeline" data-linenumber="2602"><td class="num" id="LN2602">2602</td><td class="line">    <span class='keyword'>if</span> (server.cluster_enabled) {</td></tr>
<tr class="codeline" data-linenumber="2603"><td class="num" id="LN2603">2603</td><td class="line">        addReplyError(c,<span class='string_literal'>"REPLICAOF not allowed in cluster mode."</span>);</td></tr>
<tr class="codeline" data-linenumber="2604"><td class="num" id="LN2604">2604</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2605"><td class="num" id="LN2605">2605</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2606"><td class="num" id="LN2606">2606</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2607"><td class="num" id="LN2607">2607</td><td class="line">    <span class='comment'>/* The special host/port combination "NO" "ONE" turns the instance</span></td></tr>
<tr class="codeline" data-linenumber="2608"><td class="num" id="LN2608">2608</td><td class="line">     <span class='comment'>* into a master. Otherwise the new master address is set. */</span></td></tr>
<tr class="codeline" data-linenumber="2609"><td class="num" id="LN2609">2609</td><td class="line">    <span class='keyword'>if</span> (!strcasecmp(c-&gt;argv[1]-&gt;ptr,<span class='string_literal'>"no"</span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2610"><td class="num" id="LN2610">2610</td><td class="line">        !strcasecmp(c-&gt;argv[2]-&gt;ptr,<span class='string_literal'>"one"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="2611"><td class="num" id="LN2611">2611</td><td class="line">        <span class='keyword'>if</span> (server.masterhost) {</td></tr>
<tr class="codeline" data-linenumber="2612"><td class="num" id="LN2612">2612</td><td class="line">            replicationUnsetMaster();</td></tr>
<tr class="codeline" data-linenumber="2613"><td class="num" id="LN2613">2613</td><td class="line">            sds client = catClientInfoString(sdsempty(),c);</td></tr>
<tr class="codeline" data-linenumber="2614"><td class="num" id="LN2614">2614</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"MASTER MODE enabled (user request from '%s')"</span>,</td></tr>
<tr class="codeline" data-linenumber="2615"><td class="num" id="LN2615">2615</td><td class="line">                client);</td></tr>
<tr class="codeline" data-linenumber="2616"><td class="num" id="LN2616">2616</td><td class="line">            sdsfree(client);</td></tr>
<tr class="codeline" data-linenumber="2617"><td class="num" id="LN2617">2617</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2618"><td class="num" id="LN2618">2618</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2619"><td class="num" id="LN2619">2619</td><td class="line">        <span class='keyword'>long</span> port;</td></tr>
<tr class="codeline" data-linenumber="2620"><td class="num" id="LN2620">2620</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2621"><td class="num" id="LN2621">2621</td><td class="line">        <span class='keyword'>if</span> (c-&gt;flags &amp; <span class='macro'>CLIENT_SLAVE<span class='macro_popup'>(1&lt;&lt;0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="2622"><td class="num" id="LN2622">2622</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="2623"><td class="num" id="LN2623">2623</td><td class="line">            <span class='comment'>/* If a client is already a replica they cannot run this command,</span></td></tr>
<tr class="codeline" data-linenumber="2624"><td class="num" id="LN2624">2624</td><td class="line">             <span class='comment'>* because it involves flushing all replicas (including this</span></td></tr>
<tr class="codeline" data-linenumber="2625"><td class="num" id="LN2625">2625</td><td class="line">             <span class='comment'>* client) */</span></td></tr>
<tr class="codeline" data-linenumber="2626"><td class="num" id="LN2626">2626</td><td class="line">            addReplyError(c, <span class='string_literal'>"Command is not valid when client is a replica."</span>);</td></tr>
<tr class="codeline" data-linenumber="2627"><td class="num" id="LN2627">2627</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2628"><td class="num" id="LN2628">2628</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2629"><td class="num" id="LN2629">2629</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2630"><td class="num" id="LN2630">2630</td><td class="line">        <span class='keyword'>if</span> ((getLongFromObjectOrReply(c, c-&gt;argv[2], &amp;port, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) != <span class='macro'>C_OK<span class='macro_popup'>0</span></span>))</td></tr>
<tr class="codeline" data-linenumber="2631"><td class="num" id="LN2631">2631</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2632"><td class="num" id="LN2632">2632</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2633"><td class="num" id="LN2633">2633</td><td class="line">        <span class='comment'>/* Check if we are already attached to the specified slave */</span></td></tr>
<tr class="codeline" data-linenumber="2634"><td class="num" id="LN2634">2634</td><td class="line">        <span class='keyword'>if</span> (server.masterhost &amp;&amp; !strcasecmp(server.masterhost,c-&gt;argv[1]-&gt;ptr)</td></tr>
<tr class="codeline" data-linenumber="2635"><td class="num" id="LN2635">2635</td><td class="line">            &amp;&amp; server.masterport == port) {</td></tr>
<tr class="codeline" data-linenumber="2636"><td class="num" id="LN2636">2636</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"REPLICAOF would result into synchronization "</span></td></tr>
<tr class="codeline" data-linenumber="2637"><td class="num" id="LN2637">2637</td><td class="line">                                <span class='string_literal'>"with the master we are already connected "</span></td></tr>
<tr class="codeline" data-linenumber="2638"><td class="num" id="LN2638">2638</td><td class="line">                                <span class='string_literal'>"with. No operation performed."</span>);</td></tr>
<tr class="codeline" data-linenumber="2639"><td class="num" id="LN2639">2639</td><td class="line">            addReplySds(c,sdsnew(<span class='string_literal'>"+OK Already connected to specified "</span></td></tr>
<tr class="codeline" data-linenumber="2640"><td class="num" id="LN2640">2640</td><td class="line">                                 <span class='string_literal'>"master\r\n"</span>));</td></tr>
<tr class="codeline" data-linenumber="2641"><td class="num" id="LN2641">2641</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2642"><td class="num" id="LN2642">2642</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2643"><td class="num" id="LN2643">2643</td><td class="line">        <span class='comment'>/* There was no previous master or the user specified a different one,</span></td></tr>
<tr class="codeline" data-linenumber="2644"><td class="num" id="LN2644">2644</td><td class="line">         <span class='comment'>* we can continue. */</span></td></tr>
<tr class="codeline" data-linenumber="2645"><td class="num" id="LN2645">2645</td><td class="line">        replicationSetMaster(c-&gt;argv[1]-&gt;ptr, port);</td></tr>
<tr class="codeline" data-linenumber="2646"><td class="num" id="LN2646">2646</td><td class="line">        sds client = catClientInfoString(sdsempty(),c);</td></tr>
<tr class="codeline" data-linenumber="2647"><td class="num" id="LN2647">2647</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"REPLICAOF %s:%d enabled (user request from '%s')"</span>,</td></tr>
<tr class="codeline" data-linenumber="2648"><td class="num" id="LN2648">2648</td><td class="line">            server.masterhost, server.masterport, client);</td></tr>
<tr class="codeline" data-linenumber="2649"><td class="num" id="LN2649">2649</td><td class="line">        sdsfree(client);</td></tr>
<tr class="codeline" data-linenumber="2650"><td class="num" id="LN2650">2650</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2651"><td class="num" id="LN2651">2651</td><td class="line">    addReply(c,shared.ok);</td></tr>
<tr class="codeline" data-linenumber="2652"><td class="num" id="LN2652">2652</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2653"><td class="num" id="LN2653">2653</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2654"><td class="num" id="LN2654">2654</td><td class="line"><span class='comment'>/* ROLE command: provide information about the role of the instance</span></td></tr>
<tr class="codeline" data-linenumber="2655"><td class="num" id="LN2655">2655</td><td class="line"> <span class='comment'>* (master or slave) and additional information related to replication</span></td></tr>
<tr class="codeline" data-linenumber="2656"><td class="num" id="LN2656">2656</td><td class="line"> <span class='comment'>* in an easy to process format. */</span></td></tr>
<tr class="codeline" data-linenumber="2657"><td class="num" id="LN2657">2657</td><td class="line"><span class='keyword'>void</span> roleCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="2658"><td class="num" id="LN2658">2658</td><td class="line">    <span class='keyword'>if</span> (server.masterhost == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2659"><td class="num" id="LN2659">2659</td><td class="line">        listIter li;</td></tr>
<tr class="codeline" data-linenumber="2660"><td class="num" id="LN2660">2660</td><td class="line">        listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="2661"><td class="num" id="LN2661">2661</td><td class="line">        <span class='keyword'>void</span> *mbcount;</td></tr>
<tr class="codeline" data-linenumber="2662"><td class="num" id="LN2662">2662</td><td class="line">        <span class='keyword'>int</span> slaves = 0;</td></tr>
<tr class="codeline" data-linenumber="2663"><td class="num" id="LN2663">2663</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2664"><td class="num" id="LN2664">2664</td><td class="line">        addReplyArrayLen(c,3);</td></tr>
<tr class="codeline" data-linenumber="2665"><td class="num" id="LN2665">2665</td><td class="line">        addReplyBulkCBuffer(c,<span class='string_literal'>"master"</span>,6);</td></tr>
<tr class="codeline" data-linenumber="2666"><td class="num" id="LN2666">2666</td><td class="line">        addReplyLongLong(c,server.master_repl_offset);</td></tr>
<tr class="codeline" data-linenumber="2667"><td class="num" id="LN2667">2667</td><td class="line">        mbcount = addReplyDeferredLen(c);</td></tr>
<tr class="codeline" data-linenumber="2668"><td class="num" id="LN2668">2668</td><td class="line">        listRewind(server.slaves,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="2669"><td class="num" id="LN2669">2669</td><td class="line">        <span class='keyword'>while</span>((ln = listNext(&amp;li))) {</td></tr>
<tr class="codeline" data-linenumber="2670"><td class="num" id="LN2670">2670</td><td class="line">            client *slave = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="2671"><td class="num" id="LN2671">2671</td><td class="line">            <span class='keyword'>char</span> ip[<span class='macro'>NET_IP_STR_LEN<span class='macro_popup'>46</span></span>], *slaveip = slave-&gt;slave_ip;</td></tr>
<tr class="codeline" data-linenumber="2672"><td class="num" id="LN2672">2672</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2673"><td class="num" id="LN2673">2673</td><td class="line">            <span class='keyword'>if</span> (slaveip[0] == '\0') {</td></tr>
<tr class="codeline" data-linenumber="2674"><td class="num" id="LN2674">2674</td><td class="line">                <span class='keyword'>if</span> (connPeerToString(slave-&gt;conn,ip,<span class='keyword'>sizeof</span>(ip),<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) == -1)</td></tr>
<tr class="codeline" data-linenumber="2675"><td class="num" id="LN2675">2675</td><td class="line">                    <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2676"><td class="num" id="LN2676">2676</td><td class="line">                slaveip = ip;</td></tr>
<tr class="codeline" data-linenumber="2677"><td class="num" id="LN2677">2677</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2678"><td class="num" id="LN2678">2678</td><td class="line">            <span class='keyword'>if</span> (slave-&gt;replstate != <span class='macro'>SLAVE_STATE_ONLINE<span class='macro_popup'>9</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="2679"><td class="num" id="LN2679">2679</td><td class="line">            addReplyArrayLen(c,3);</td></tr>
<tr class="codeline" data-linenumber="2680"><td class="num" id="LN2680">2680</td><td class="line">            addReplyBulkCString(c,slaveip);</td></tr>
<tr class="codeline" data-linenumber="2681"><td class="num" id="LN2681">2681</td><td class="line">            addReplyBulkLongLong(c,slave-&gt;slave_listening_port);</td></tr>
<tr class="codeline" data-linenumber="2682"><td class="num" id="LN2682">2682</td><td class="line">            addReplyBulkLongLong(c,slave-&gt;repl_ack_off);</td></tr>
<tr class="codeline" data-linenumber="2683"><td class="num" id="LN2683">2683</td><td class="line">            slaves++;</td></tr>
<tr class="codeline" data-linenumber="2684"><td class="num" id="LN2684">2684</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2685"><td class="num" id="LN2685">2685</td><td class="line">        setDeferredArrayLen(c,mbcount,slaves);</td></tr>
<tr class="codeline" data-linenumber="2686"><td class="num" id="LN2686">2686</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2687"><td class="num" id="LN2687">2687</td><td class="line">        <span class='keyword'>char</span> *slavestate = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2688"><td class="num" id="LN2688">2688</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2689"><td class="num" id="LN2689">2689</td><td class="line">        addReplyArrayLen(c,5);</td></tr>
<tr class="codeline" data-linenumber="2690"><td class="num" id="LN2690">2690</td><td class="line">        addReplyBulkCBuffer(c,<span class='string_literal'>"slave"</span>,5);</td></tr>
<tr class="codeline" data-linenumber="2691"><td class="num" id="LN2691">2691</td><td class="line">        addReplyBulkCString(c,server.masterhost);</td></tr>
<tr class="codeline" data-linenumber="2692"><td class="num" id="LN2692">2692</td><td class="line">        addReplyLongLong(c,server.masterport);</td></tr>
<tr class="codeline" data-linenumber="2693"><td class="num" id="LN2693">2693</td><td class="line">        <span class='keyword'>if</span> (slaveIsInHandshakeState()) {</td></tr>
<tr class="codeline" data-linenumber="2694"><td class="num" id="LN2694">2694</td><td class="line">            slavestate = <span class='string_literal'>"handshake"</span>;</td></tr>
<tr class="codeline" data-linenumber="2695"><td class="num" id="LN2695">2695</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="2696"><td class="num" id="LN2696">2696</td><td class="line">            <span class='keyword'>switch</span>(server.repl_state) {</td></tr>
<tr class="codeline" data-linenumber="2697"><td class="num" id="LN2697">2697</td><td class="line">            <span class='keyword'>case</span> <span class='macro'>REPL_STATE_NONE<span class='macro_popup'>0</span></span>: slavestate = <span class='string_literal'>"none"</span>; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2698"><td class="num" id="LN2698">2698</td><td class="line">            <span class='keyword'>case</span> <span class='macro'>REPL_STATE_CONNECT<span class='macro_popup'>1</span></span>: slavestate = <span class='string_literal'>"connect"</span>; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2699"><td class="num" id="LN2699">2699</td><td class="line">            <span class='keyword'>case</span> <span class='macro'>REPL_STATE_CONNECTING<span class='macro_popup'>2</span></span>: slavestate = <span class='string_literal'>"connecting"</span>; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2700"><td class="num" id="LN2700">2700</td><td class="line">            <span class='keyword'>case</span> <span class='macro'>REPL_STATE_TRANSFER<span class='macro_popup'>14</span></span>: slavestate = <span class='string_literal'>"sync"</span>; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2701"><td class="num" id="LN2701">2701</td><td class="line">            <span class='keyword'>case</span> <span class='macro'>REPL_STATE_CONNECTED<span class='macro_popup'>15</span></span>: slavestate = <span class='string_literal'>"connected"</span>; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2702"><td class="num" id="LN2702">2702</td><td class="line">            <span class='keyword'>default</span>: slavestate = <span class='string_literal'>"unknown"</span>; <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="2703"><td class="num" id="LN2703">2703</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="2704"><td class="num" id="LN2704">2704</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2705"><td class="num" id="LN2705">2705</td><td class="line">        addReplyBulkCString(c,slavestate);</td></tr>
<tr class="codeline" data-linenumber="2706"><td class="num" id="LN2706">2706</td><td class="line">        addReplyLongLong(c,server.master ? server.master-&gt;reploff : -1);</td></tr>
<tr class="codeline" data-linenumber="2707"><td class="num" id="LN2707">2707</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2708"><td class="num" id="LN2708">2708</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2709"><td class="num" id="LN2709">2709</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2710"><td class="num" id="LN2710">2710</td><td class="line"><span class='comment'>/* Send a REPLCONF ACK command to the master to inform it about the current</span></td></tr>
<tr class="codeline" data-linenumber="2711"><td class="num" id="LN2711">2711</td><td class="line"> <span class='comment'>* processed offset. If we are not connected with a master, the command has</span></td></tr>
<tr class="codeline" data-linenumber="2712"><td class="num" id="LN2712">2712</td><td class="line"> <span class='comment'>* no effects. */</span></td></tr>
<tr class="codeline" data-linenumber="2713"><td class="num" id="LN2713">2713</td><td class="line"><span class='keyword'>void</span> replicationSendAck(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="2714"><td class="num" id="LN2714">2714</td><td class="line">    client *c = server.master;</td></tr>
<tr class="codeline" data-linenumber="2715"><td class="num" id="LN2715">2715</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2716"><td class="num" id="LN2716">2716</td><td class="line">    <span class='keyword'>if</span> (c != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="2717"><td class="num" id="LN2717">2717</td><td class="line">        c-&gt;flags |= <span class='macro'>CLIENT_MASTER_FORCE_REPLY<span class='macro_popup'>(1&lt;&lt;13)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2718"><td class="num" id="LN2718">2718</td><td class="line">        addReplyArrayLen(c,3);</td></tr>
<tr class="codeline" data-linenumber="2719"><td class="num" id="LN2719">2719</td><td class="line">        addReplyBulkCString(c,<span class='string_literal'>"REPLCONF"</span>);</td></tr>
<tr class="codeline" data-linenumber="2720"><td class="num" id="LN2720">2720</td><td class="line">        addReplyBulkCString(c,<span class='string_literal'>"ACK"</span>);</td></tr>
<tr class="codeline" data-linenumber="2721"><td class="num" id="LN2721">2721</td><td class="line">        addReplyBulkLongLong(c,c-&gt;reploff);</td></tr>
<tr class="codeline" data-linenumber="2722"><td class="num" id="LN2722">2722</td><td class="line">        c-&gt;flags &amp;= ~<span class='macro'>CLIENT_MASTER_FORCE_REPLY<span class='macro_popup'>(1&lt;&lt;13)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2723"><td class="num" id="LN2723">2723</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2724"><td class="num" id="LN2724">2724</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2725"><td class="num" id="LN2725">2725</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2726"><td class="num" id="LN2726">2726</td><td class="line"><span class='comment'>/* ---------------------- MASTER CACHING FOR PSYNC -------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="2727"><td class="num" id="LN2727">2727</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2728"><td class="num" id="LN2728">2728</td><td class="line"><span class='comment'>/* In order to implement partial synchronization we need to be able to cache</span></td></tr>
<tr class="codeline" data-linenumber="2729"><td class="num" id="LN2729">2729</td><td class="line"> <span class='comment'>* our master's client structure after a transient disconnection.</span></td></tr>
<tr class="codeline" data-linenumber="2730"><td class="num" id="LN2730">2730</td><td class="line"> <span class='comment'>* It is cached into server.cached_master and flushed away using the following</span></td></tr>
<tr class="codeline" data-linenumber="2731"><td class="num" id="LN2731">2731</td><td class="line"> <span class='comment'>* functions. */</span></td></tr>
<tr class="codeline" data-linenumber="2732"><td class="num" id="LN2732">2732</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2733"><td class="num" id="LN2733">2733</td><td class="line"><span class='comment'>/* This function is called by freeClient() in order to cache the master</span></td></tr>
<tr class="codeline" data-linenumber="2734"><td class="num" id="LN2734">2734</td><td class="line"> <span class='comment'>* client structure instead of destroying it. freeClient() will return</span></td></tr>
<tr class="codeline" data-linenumber="2735"><td class="num" id="LN2735">2735</td><td class="line"> <span class='comment'>* ASAP after this function returns, so every action needed to avoid problems</span></td></tr>
<tr class="codeline" data-linenumber="2736"><td class="num" id="LN2736">2736</td><td class="line"> <span class='comment'>* with a client that is really "suspended" has to be done by this function.</span></td></tr>
<tr class="codeline" data-linenumber="2737"><td class="num" id="LN2737">2737</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2738"><td class="num" id="LN2738">2738</td><td class="line"> <span class='comment'>* The other functions that will deal with the cached master are:</span></td></tr>
<tr class="codeline" data-linenumber="2739"><td class="num" id="LN2739">2739</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2740"><td class="num" id="LN2740">2740</td><td class="line"> <span class='comment'>* replicationDiscardCachedMaster() that will make sure to kill the client</span></td></tr>
<tr class="codeline" data-linenumber="2741"><td class="num" id="LN2741">2741</td><td class="line"> <span class='comment'>* as for some reason we don't want to use it in the future.</span></td></tr>
<tr class="codeline" data-linenumber="2742"><td class="num" id="LN2742">2742</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2743"><td class="num" id="LN2743">2743</td><td class="line"> <span class='comment'>* replicationResurrectCachedMaster() that is used after a successful PSYNC</span></td></tr>
<tr class="codeline" data-linenumber="2744"><td class="num" id="LN2744">2744</td><td class="line"> <span class='comment'>* handshake in order to reactivate the cached master.</span></td></tr>
<tr class="codeline" data-linenumber="2745"><td class="num" id="LN2745">2745</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2746"><td class="num" id="LN2746">2746</td><td class="line"><span class='keyword'>void</span> replicationCacheMaster(client *c) {</td></tr>
<tr class="codeline" data-linenumber="2747"><td class="num" id="LN2747">2747</td><td class="line">    <span class='macro'>serverAssert(server.master != NULL &amp;&amp; server.cached_master == NULL)<span class='macro_popup'>((server.master != ((void*)0) &amp;&amp; server.cached_master<br> == ((void*)0))?(void)0 : (_serverAssert("server.master != NULL &amp;&amp; server.cached_master == NULL"<br>,"replication.c",2747),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2748"><td class="num" id="LN2748">2748</td><td class="line">    serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Caching the disconnected master state."</span>);</td></tr>
<tr class="codeline" data-linenumber="2749"><td class="num" id="LN2749">2749</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2750"><td class="num" id="LN2750">2750</td><td class="line">    <span class='comment'>/* Unlink the client from the server structures. */</span></td></tr>
<tr class="codeline" data-linenumber="2751"><td class="num" id="LN2751">2751</td><td class="line">    unlinkClient(c);</td></tr>
<tr class="codeline" data-linenumber="2752"><td class="num" id="LN2752">2752</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2753"><td class="num" id="LN2753">2753</td><td class="line">    <span class='comment'>/* Reset the master client so that's ready to accept new commands:</span></td></tr>
<tr class="codeline" data-linenumber="2754"><td class="num" id="LN2754">2754</td><td class="line">     <span class='comment'>* we want to discard te non processed query buffers and non processed</span></td></tr>
<tr class="codeline" data-linenumber="2755"><td class="num" id="LN2755">2755</td><td class="line">     <span class='comment'>* offsets, including pending transactions, already populated arguments,</span></td></tr>
<tr class="codeline" data-linenumber="2756"><td class="num" id="LN2756">2756</td><td class="line">     <span class='comment'>* pending outputs to the master. */</span></td></tr>
<tr class="codeline" data-linenumber="2757"><td class="num" id="LN2757">2757</td><td class="line">    sdsclear(server.master-&gt;querybuf);</td></tr>
<tr class="codeline" data-linenumber="2758"><td class="num" id="LN2758">2758</td><td class="line">    sdsclear(server.master-&gt;pending_querybuf);</td></tr>
<tr class="codeline" data-linenumber="2759"><td class="num" id="LN2759">2759</td><td class="line">    server.master-&gt;read_reploff = server.master-&gt;reploff;</td></tr>
<tr class="codeline" data-linenumber="2760"><td class="num" id="LN2760">2760</td><td class="line">    <span class='keyword'>if</span> (c-&gt;flags &amp; <span class='macro'>CLIENT_MULTI<span class='macro_popup'>(1&lt;&lt;3)</span></span>) discardTransaction(c);</td></tr>
<tr class="codeline" data-linenumber="2761"><td class="num" id="LN2761">2761</td><td class="line">    listEmpty(c-&gt;reply);</td></tr>
<tr class="codeline" data-linenumber="2762"><td class="num" id="LN2762">2762</td><td class="line">    c-&gt;sentlen = 0;</td></tr>
<tr class="codeline" data-linenumber="2763"><td class="num" id="LN2763">2763</td><td class="line">    c-&gt;reply_bytes = 0;</td></tr>
<tr class="codeline" data-linenumber="2764"><td class="num" id="LN2764">2764</td><td class="line">    c-&gt;bufpos = 0;</td></tr>
<tr class="codeline" data-linenumber="2765"><td class="num" id="LN2765">2765</td><td class="line">    resetClient(c);</td></tr>
<tr class="codeline" data-linenumber="2766"><td class="num" id="LN2766">2766</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2767"><td class="num" id="LN2767">2767</td><td class="line">    <span class='comment'>/* Save the master. Server.master will be set to null later by</span></td></tr>
<tr class="codeline" data-linenumber="2768"><td class="num" id="LN2768">2768</td><td class="line">     <span class='comment'>* replicationHandleMasterDisconnection(). */</span></td></tr>
<tr class="codeline" data-linenumber="2769"><td class="num" id="LN2769">2769</td><td class="line">    server.cached_master = server.master;</td></tr>
<tr class="codeline" data-linenumber="2770"><td class="num" id="LN2770">2770</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2771"><td class="num" id="LN2771">2771</td><td class="line">    <span class='comment'>/* Invalidate the Peer ID cache. */</span></td></tr>
<tr class="codeline" data-linenumber="2772"><td class="num" id="LN2772">2772</td><td class="line">    <span class='keyword'>if</span> (c-&gt;peerid) {</td></tr>
<tr class="codeline" data-linenumber="2773"><td class="num" id="LN2773">2773</td><td class="line">        sdsfree(c-&gt;peerid);</td></tr>
<tr class="codeline" data-linenumber="2774"><td class="num" id="LN2774">2774</td><td class="line">        c-&gt;peerid = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2775"><td class="num" id="LN2775">2775</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2776"><td class="num" id="LN2776">2776</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2777"><td class="num" id="LN2777">2777</td><td class="line">    <span class='comment'>/* Caching the master happens instead of the actual freeClient() call,</span></td></tr>
<tr class="codeline" data-linenumber="2778"><td class="num" id="LN2778">2778</td><td class="line">     <span class='comment'>* so make sure to adjust the replication state. This function will</span></td></tr>
<tr class="codeline" data-linenumber="2779"><td class="num" id="LN2779">2779</td><td class="line">     <span class='comment'>* also set server.master to NULL. */</span></td></tr>
<tr class="codeline" data-linenumber="2780"><td class="num" id="LN2780">2780</td><td class="line">    replicationHandleMasterDisconnection();</td></tr>
<tr class="codeline" data-linenumber="2781"><td class="num" id="LN2781">2781</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2782"><td class="num" id="LN2782">2782</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2783"><td class="num" id="LN2783">2783</td><td class="line"><span class='comment'>/* This function is called when a master is turend into a slave, in order to</span></td></tr>
<tr class="codeline" data-linenumber="2784"><td class="num" id="LN2784">2784</td><td class="line"> <span class='comment'>* create from scratch a cached master for the new client, that will allow</span></td></tr>
<tr class="codeline" data-linenumber="2785"><td class="num" id="LN2785">2785</td><td class="line"> <span class='comment'>* to PSYNC with the slave that was promoted as the new master after a</span></td></tr>
<tr class="codeline" data-linenumber="2786"><td class="num" id="LN2786">2786</td><td class="line"> <span class='comment'>* failover.</span></td></tr>
<tr class="codeline" data-linenumber="2787"><td class="num" id="LN2787">2787</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2788"><td class="num" id="LN2788">2788</td><td class="line"> <span class='comment'>* Assuming this instance was previously the master instance of the new master,</span></td></tr>
<tr class="codeline" data-linenumber="2789"><td class="num" id="LN2789">2789</td><td class="line"> <span class='comment'>* the new master will accept its replication ID, and potentiall also the</span></td></tr>
<tr class="codeline" data-linenumber="2790"><td class="num" id="LN2790">2790</td><td class="line"> <span class='comment'>* current offset if no data was lost during the failover. So we use our</span></td></tr>
<tr class="codeline" data-linenumber="2791"><td class="num" id="LN2791">2791</td><td class="line"> <span class='comment'>* current replication ID and offset in order to synthesize a cached master. */</span></td></tr>
<tr class="codeline" data-linenumber="2792"><td class="num" id="LN2792">2792</td><td class="line"><span class='keyword'>void</span> replicationCacheMasterUsingMyself(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="2793"><td class="num" id="LN2793">2793</td><td class="line">    serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2794"><td class="num" id="LN2794">2794</td><td class="line">        <span class='string_literal'>"Before turning into a replica, using my own master parameters "</span></td></tr>
<tr class="codeline" data-linenumber="2795"><td class="num" id="LN2795">2795</td><td class="line">        <span class='string_literal'>"to synthesize a cached master: I may be able to synchronize with "</span></td></tr>
<tr class="codeline" data-linenumber="2796"><td class="num" id="LN2796">2796</td><td class="line">        <span class='string_literal'>"the new master with just a partial transfer."</span>);</td></tr>
<tr class="codeline" data-linenumber="2797"><td class="num" id="LN2797">2797</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2798"><td class="num" id="LN2798">2798</td><td class="line">    <span class='comment'>/* This will be used to populate the field server.master-&gt;reploff</span></td></tr>
<tr class="codeline" data-linenumber="2799"><td class="num" id="LN2799">2799</td><td class="line">     <span class='comment'>* by replicationCreateMasterClient(). We'll later set the created</span></td></tr>
<tr class="codeline" data-linenumber="2800"><td class="num" id="LN2800">2800</td><td class="line">     <span class='comment'>* master as server.cached_master, so the replica will use such</span></td></tr>
<tr class="codeline" data-linenumber="2801"><td class="num" id="LN2801">2801</td><td class="line">     <span class='comment'>* offset for PSYNC. */</span></td></tr>
<tr class="codeline" data-linenumber="2802"><td class="num" id="LN2802">2802</td><td class="line">    server.master_initial_offset = server.master_repl_offset;</td></tr>
<tr class="codeline" data-linenumber="2803"><td class="num" id="LN2803">2803</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2804"><td class="num" id="LN2804">2804</td><td class="line">    <span class='comment'>/* The master client we create can be set to any DBID, because</span></td></tr>
<tr class="codeline" data-linenumber="2805"><td class="num" id="LN2805">2805</td><td class="line">     <span class='comment'>* the new master will start its replication stream with SELECT. */</span></td></tr>
<tr class="codeline" data-linenumber="2806"><td class="num" id="LN2806">2806</td><td class="line">    replicationCreateMasterClient(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,-1);</td></tr>
<tr class="codeline" data-linenumber="2807"><td class="num" id="LN2807">2807</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2808"><td class="num" id="LN2808">2808</td><td class="line">    <span class='comment'>/* Use our own ID / offset. */</span></td></tr>
<tr class="codeline" data-linenumber="2809"><td class="num" id="LN2809">2809</td><td class="line">    memcpy(server.master-&gt;replid, server.replid, <span class='keyword'>sizeof</span>(server.replid));</td></tr>
<tr class="codeline" data-linenumber="2810"><td class="num" id="LN2810">2810</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2811"><td class="num" id="LN2811">2811</td><td class="line">    <span class='comment'>/* Set as cached master. */</span></td></tr>
<tr class="codeline" data-linenumber="2812"><td class="num" id="LN2812">2812</td><td class="line">    unlinkClient(server.master);</td></tr>
<tr class="codeline" data-linenumber="2813"><td class="num" id="LN2813">2813</td><td class="line">    server.cached_master = server.master;</td></tr>
<tr class="codeline" data-linenumber="2814"><td class="num" id="LN2814">2814</td><td class="line">    server.master = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2815"><td class="num" id="LN2815">2815</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2816"><td class="num" id="LN2816">2816</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2817"><td class="num" id="LN2817">2817</td><td class="line"><span class='comment'>/* Free a cached master, called when there are no longer the conditions for</span></td></tr>
<tr class="codeline" data-linenumber="2818"><td class="num" id="LN2818">2818</td><td class="line"> <span class='comment'>* a partial resync on reconnection. */</span></td></tr>
<tr class="codeline" data-linenumber="2819"><td class="num" id="LN2819">2819</td><td class="line"><span class='keyword'>void</span> replicationDiscardCachedMaster(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="2820"><td class="num" id="LN2820">2820</td><td class="line">    <span class='keyword'>if</span> (server.cached_master == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2821"><td class="num" id="LN2821">2821</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2822"><td class="num" id="LN2822">2822</td><td class="line">    serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Discarding previously cached master state."</span>);</td></tr>
<tr class="codeline" data-linenumber="2823"><td class="num" id="LN2823">2823</td><td class="line">    server.cached_master-&gt;flags &amp;= ~<span class='macro'>CLIENT_MASTER<span class='macro_popup'>(1&lt;&lt;1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2824"><td class="num" id="LN2824">2824</td><td class="line">    freeClient(server.cached_master);</td></tr>
<tr class="codeline" data-linenumber="2825"><td class="num" id="LN2825">2825</td><td class="line">    server.cached_master = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2826"><td class="num" id="LN2826">2826</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2827"><td class="num" id="LN2827">2827</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2828"><td class="num" id="LN2828">2828</td><td class="line"><span class='comment'>/* Turn the cached master into the current master, using the file descriptor</span></td></tr>
<tr class="codeline" data-linenumber="2829"><td class="num" id="LN2829">2829</td><td class="line"> <span class='comment'>* passed as argument as the socket for the new master.</span></td></tr>
<tr class="codeline" data-linenumber="2830"><td class="num" id="LN2830">2830</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2831"><td class="num" id="LN2831">2831</td><td class="line"> <span class='comment'>* This function is called when successfully setup a partial resynchronization</span></td></tr>
<tr class="codeline" data-linenumber="2832"><td class="num" id="LN2832">2832</td><td class="line"> <span class='comment'>* so the stream of data that we'll receive will start from were this</span></td></tr>
<tr class="codeline" data-linenumber="2833"><td class="num" id="LN2833">2833</td><td class="line"> <span class='comment'>* master left. */</span></td></tr>
<tr class="codeline" data-linenumber="2834"><td class="num" id="LN2834">2834</td><td class="line"><span class='keyword'>void</span> replicationResurrectCachedMaster(connection *conn) {</td></tr>
<tr class="codeline" data-linenumber="2835"><td class="num" id="LN2835">2835</td><td class="line">    server.master = server.cached_master;</td></tr>
<tr class="codeline" data-linenumber="2836"><td class="num" id="LN2836">2836</td><td class="line">    server.cached_master = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2837"><td class="num" id="LN2837">2837</td><td class="line">    server.master-&gt;conn = conn;</td></tr>
<tr class="codeline" data-linenumber="2838"><td class="num" id="LN2838">2838</td><td class="line">    connSetPrivateData(server.master-&gt;conn, server.master);</td></tr>
<tr class="codeline" data-linenumber="2839"><td class="num" id="LN2839">2839</td><td class="line">    server.master-&gt;flags &amp;= ~(<span class='macro'>CLIENT_CLOSE_AFTER_REPLY<span class='macro_popup'>(1&lt;&lt;6)</span></span>|<span class='macro'>CLIENT_CLOSE_ASAP<span class='macro_popup'>(1&lt;&lt;10)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2840"><td class="num" id="LN2840">2840</td><td class="line">    server.master-&gt;authenticated = 1;</td></tr>
<tr class="codeline" data-linenumber="2841"><td class="num" id="LN2841">2841</td><td class="line">    server.master-&gt;lastinteraction = server.unixtime;</td></tr>
<tr class="codeline" data-linenumber="2842"><td class="num" id="LN2842">2842</td><td class="line">    server.repl_state = <span class='macro'>REPL_STATE_CONNECTED<span class='macro_popup'>15</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2843"><td class="num" id="LN2843">2843</td><td class="line">    server.repl_down_since = 0;</td></tr>
<tr class="codeline" data-linenumber="2844"><td class="num" id="LN2844">2844</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2845"><td class="num" id="LN2845">2845</td><td class="line">    <span class='comment'>/* Fire the master link modules event. */</span></td></tr>
<tr class="codeline" data-linenumber="2846"><td class="num" id="LN2846">2846</td><td class="line">    moduleFireServerEvent(<span class='macro'>REDISMODULE_EVENT_MASTER_LINK_CHANGE<span class='macro_popup'>7</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2847"><td class="num" id="LN2847">2847</td><td class="line">                          <span class='macro'>REDISMODULE_SUBEVENT_MASTER_LINK_UP<span class='macro_popup'>0</span></span>,</td></tr>
<tr class="codeline" data-linenumber="2848"><td class="num" id="LN2848">2848</td><td class="line">                          <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2849"><td class="num" id="LN2849">2849</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2850"><td class="num" id="LN2850">2850</td><td class="line">    <span class='comment'>/* Re-add to the list of clients. */</span></td></tr>
<tr class="codeline" data-linenumber="2851"><td class="num" id="LN2851">2851</td><td class="line">    linkClient(server.master);</td></tr>
<tr class="codeline" data-linenumber="2852"><td class="num" id="LN2852">2852</td><td class="line">    <span class='keyword'>if</span> (connSetReadHandler(server.master-&gt;conn, readQueryFromClient)) {</td></tr>
<tr class="codeline" data-linenumber="2853"><td class="num" id="LN2853">2853</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Error resurrecting the cached master, impossible to add the readable handler: %s"</span>, strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="2854"><td class="num" id="LN2854">2854</td><td class="line">        freeClientAsync(server.master); <span class='comment'>/* Close ASAP. */</span></td></tr>
<tr class="codeline" data-linenumber="2855"><td class="num" id="LN2855">2855</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2856"><td class="num" id="LN2856">2856</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2857"><td class="num" id="LN2857">2857</td><td class="line">    <span class='comment'>/* We may also need to install the write handler as well if there is</span></td></tr>
<tr class="codeline" data-linenumber="2858"><td class="num" id="LN2858">2858</td><td class="line">     <span class='comment'>* pending data in the write buffers. */</span></td></tr>
<tr class="codeline" data-linenumber="2859"><td class="num" id="LN2859">2859</td><td class="line">    <span class='keyword'>if</span> (clientHasPendingReplies(server.master)) {</td></tr>
<tr class="codeline" data-linenumber="2860"><td class="num" id="LN2860">2860</td><td class="line">        <span class='keyword'>if</span> (connSetWriteHandler(server.master-&gt;conn, sendReplyToClient)) {</td></tr>
<tr class="codeline" data-linenumber="2861"><td class="num" id="LN2861">2861</td><td class="line">            serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Error resurrecting the cached master, impossible to add the writable handler: %s"</span>, strerror(<span class='macro'>errno<span class='macro_popup'>(*__errno_location ())</span></span>));</td></tr>
<tr class="codeline" data-linenumber="2862"><td class="num" id="LN2862">2862</td><td class="line">            freeClientAsync(server.master); <span class='comment'>/* Close ASAP. */</span></td></tr>
<tr class="codeline" data-linenumber="2863"><td class="num" id="LN2863">2863</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="2864"><td class="num" id="LN2864">2864</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2865"><td class="num" id="LN2865">2865</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2866"><td class="num" id="LN2866">2866</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2867"><td class="num" id="LN2867">2867</td><td class="line"><span class='comment'>/* ------------------------- MIN-SLAVES-TO-WRITE  --------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="2868"><td class="num" id="LN2868">2868</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2869"><td class="num" id="LN2869">2869</td><td class="line"><span class='comment'>/* This function counts the number of slaves with lag &lt;= min-slaves-max-lag.</span></td></tr>
<tr class="codeline" data-linenumber="2870"><td class="num" id="LN2870">2870</td><td class="line"> <span class='comment'>* If the option is active, the server will prevent writes if there are not</span></td></tr>
<tr class="codeline" data-linenumber="2871"><td class="num" id="LN2871">2871</td><td class="line"> <span class='comment'>* enough connected slaves with the specified lag (or less). */</span></td></tr>
<tr class="codeline" data-linenumber="2872"><td class="num" id="LN2872">2872</td><td class="line"><span class='keyword'>void</span> refreshGoodSlavesCount(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="2873"><td class="num" id="LN2873">2873</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="2874"><td class="num" id="LN2874">2874</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="2875"><td class="num" id="LN2875">2875</td><td class="line">    <span class='keyword'>int</span> good = 0;</td></tr>
<tr class="codeline" data-linenumber="2876"><td class="num" id="LN2876">2876</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2877"><td class="num" id="LN2877">2877</td><td class="line">    <span class='keyword'>if</span> (!server.repl_min_slaves_to_write ||</td></tr>
<tr class="codeline" data-linenumber="2878"><td class="num" id="LN2878">2878</td><td class="line">        !server.repl_min_slaves_max_lag) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="2879"><td class="num" id="LN2879">2879</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2880"><td class="num" id="LN2880">2880</td><td class="line">    listRewind(server.slaves,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="2881"><td class="num" id="LN2881">2881</td><td class="line">    <span class='keyword'>while</span>((ln = listNext(&amp;li))) {</td></tr>
<tr class="codeline" data-linenumber="2882"><td class="num" id="LN2882">2882</td><td class="line">        client *slave = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="2883"><td class="num" id="LN2883">2883</td><td class="line">        time_t lag = server.unixtime - slave-&gt;repl_ack_time;</td></tr>
<tr class="codeline" data-linenumber="2884"><td class="num" id="LN2884">2884</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2885"><td class="num" id="LN2885">2885</td><td class="line">        <span class='keyword'>if</span> (slave-&gt;replstate == <span class='macro'>SLAVE_STATE_ONLINE<span class='macro_popup'>9</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="2886"><td class="num" id="LN2886">2886</td><td class="line">            lag &lt;= server.repl_min_slaves_max_lag) good++;</td></tr>
<tr class="codeline" data-linenumber="2887"><td class="num" id="LN2887">2887</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2888"><td class="num" id="LN2888">2888</td><td class="line">    server.repl_good_slaves_count = good;</td></tr>
<tr class="codeline" data-linenumber="2889"><td class="num" id="LN2889">2889</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2890"><td class="num" id="LN2890">2890</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2891"><td class="num" id="LN2891">2891</td><td class="line"><span class='comment'>/* ----------------------- REPLICATION SCRIPT CACHE --------------------------</span></td></tr>
<tr class="codeline" data-linenumber="2892"><td class="num" id="LN2892">2892</td><td class="line"> <span class='comment'>* The goal of this code is to keep track of scripts already sent to every</span></td></tr>
<tr class="codeline" data-linenumber="2893"><td class="num" id="LN2893">2893</td><td class="line"> <span class='comment'>* connected slave, in order to be able to replicate EVALSHA as it is without</span></td></tr>
<tr class="codeline" data-linenumber="2894"><td class="num" id="LN2894">2894</td><td class="line"> <span class='comment'>* translating it to EVAL every time it is possible.</span></td></tr>
<tr class="codeline" data-linenumber="2895"><td class="num" id="LN2895">2895</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2896"><td class="num" id="LN2896">2896</td><td class="line"> <span class='comment'>* We use a capped collection implemented by a hash table for fast lookup</span></td></tr>
<tr class="codeline" data-linenumber="2897"><td class="num" id="LN2897">2897</td><td class="line"> <span class='comment'>* of scripts we can send as EVALSHA, plus a linked list that is used for</span></td></tr>
<tr class="codeline" data-linenumber="2898"><td class="num" id="LN2898">2898</td><td class="line"> <span class='comment'>* eviction of the oldest entry when the max number of items is reached.</span></td></tr>
<tr class="codeline" data-linenumber="2899"><td class="num" id="LN2899">2899</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2900"><td class="num" id="LN2900">2900</td><td class="line"> <span class='comment'>* We don't care about taking a different cache for every different slave</span></td></tr>
<tr class="codeline" data-linenumber="2901"><td class="num" id="LN2901">2901</td><td class="line"> <span class='comment'>* since to fill the cache again is not very costly, the goal of this code</span></td></tr>
<tr class="codeline" data-linenumber="2902"><td class="num" id="LN2902">2902</td><td class="line"> <span class='comment'>* is to avoid that the same big script is transmitted a big number of times</span></td></tr>
<tr class="codeline" data-linenumber="2903"><td class="num" id="LN2903">2903</td><td class="line"> <span class='comment'>* per second wasting bandwidth and processor speed, but it is not a problem</span></td></tr>
<tr class="codeline" data-linenumber="2904"><td class="num" id="LN2904">2904</td><td class="line"> <span class='comment'>* if we need to rebuild the cache from scratch from time to time, every used</span></td></tr>
<tr class="codeline" data-linenumber="2905"><td class="num" id="LN2905">2905</td><td class="line"> <span class='comment'>* script will need to be transmitted a single time to reappear in the cache.</span></td></tr>
<tr class="codeline" data-linenumber="2906"><td class="num" id="LN2906">2906</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2907"><td class="num" id="LN2907">2907</td><td class="line"> <span class='comment'>* This is how the system works:</span></td></tr>
<tr class="codeline" data-linenumber="2908"><td class="num" id="LN2908">2908</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2909"><td class="num" id="LN2909">2909</td><td class="line"> <span class='comment'>* 1) Every time a new slave connects, we flush the whole script cache.</span></td></tr>
<tr class="codeline" data-linenumber="2910"><td class="num" id="LN2910">2910</td><td class="line"> <span class='comment'>* 2) We only send as EVALSHA what was sent to the master as EVALSHA, without</span></td></tr>
<tr class="codeline" data-linenumber="2911"><td class="num" id="LN2911">2911</td><td class="line"> <span class='comment'>*    trying to convert EVAL into EVALSHA specifically for slaves.</span></td></tr>
<tr class="codeline" data-linenumber="2912"><td class="num" id="LN2912">2912</td><td class="line"> <span class='comment'>* 3) Every time we transmit a script as EVAL to the slaves, we also add the</span></td></tr>
<tr class="codeline" data-linenumber="2913"><td class="num" id="LN2913">2913</td><td class="line"> <span class='comment'>*    corresponding SHA1 of the script into the cache as we are sure every</span></td></tr>
<tr class="codeline" data-linenumber="2914"><td class="num" id="LN2914">2914</td><td class="line"> <span class='comment'>*    slave knows about the script starting from now.</span></td></tr>
<tr class="codeline" data-linenumber="2915"><td class="num" id="LN2915">2915</td><td class="line"> <span class='comment'>* 4) On SCRIPT FLUSH command, we replicate the command to all the slaves</span></td></tr>
<tr class="codeline" data-linenumber="2916"><td class="num" id="LN2916">2916</td><td class="line"> <span class='comment'>*    and at the same time flush the script cache.</span></td></tr>
<tr class="codeline" data-linenumber="2917"><td class="num" id="LN2917">2917</td><td class="line"> <span class='comment'>* 5) When the last slave disconnects, flush the cache.</span></td></tr>
<tr class="codeline" data-linenumber="2918"><td class="num" id="LN2918">2918</td><td class="line"> <span class='comment'>* 6) We handle SCRIPT LOAD as well since that's how scripts are loaded</span></td></tr>
<tr class="codeline" data-linenumber="2919"><td class="num" id="LN2919">2919</td><td class="line"> <span class='comment'>*    in the master sometimes.</span></td></tr>
<tr class="codeline" data-linenumber="2920"><td class="num" id="LN2920">2920</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2921"><td class="num" id="LN2921">2921</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2922"><td class="num" id="LN2922">2922</td><td class="line"><span class='comment'>/* Initialize the script cache, only called at startup. */</span></td></tr>
<tr class="codeline" data-linenumber="2923"><td class="num" id="LN2923">2923</td><td class="line"><span class='keyword'>void</span> replicationScriptCacheInit(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="2924"><td class="num" id="LN2924">2924</td><td class="line">    server.repl_scriptcache_size = 10000;</td></tr>
<tr class="codeline" data-linenumber="2925"><td class="num" id="LN2925">2925</td><td class="line">    server.repl_scriptcache_dict = dictCreate(&amp;replScriptCacheDictType,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2926"><td class="num" id="LN2926">2926</td><td class="line">    server.repl_scriptcache_fifo = listCreate();</td></tr>
<tr class="codeline" data-linenumber="2927"><td class="num" id="LN2927">2927</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2928"><td class="num" id="LN2928">2928</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2929"><td class="num" id="LN2929">2929</td><td class="line"><span class='comment'>/* Empty the script cache. Should be called every time we are no longer sure</span></td></tr>
<tr class="codeline" data-linenumber="2930"><td class="num" id="LN2930">2930</td><td class="line"> <span class='comment'>* that every slave knows about all the scripts in our set, or when the</span></td></tr>
<tr class="codeline" data-linenumber="2931"><td class="num" id="LN2931">2931</td><td class="line"> <span class='comment'>* current AOF "context" is no longer aware of the script. In general we</span></td></tr>
<tr class="codeline" data-linenumber="2932"><td class="num" id="LN2932">2932</td><td class="line"> <span class='comment'>* should flush the cache:</span></td></tr>
<tr class="codeline" data-linenumber="2933"><td class="num" id="LN2933">2933</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2934"><td class="num" id="LN2934">2934</td><td class="line"> <span class='comment'>* 1) Every time a new slave reconnects to this master and performs a</span></td></tr>
<tr class="codeline" data-linenumber="2935"><td class="num" id="LN2935">2935</td><td class="line"> <span class='comment'>*    full SYNC (PSYNC does not require flushing).</span></td></tr>
<tr class="codeline" data-linenumber="2936"><td class="num" id="LN2936">2936</td><td class="line"> <span class='comment'>* 2) Every time an AOF rewrite is performed.</span></td></tr>
<tr class="codeline" data-linenumber="2937"><td class="num" id="LN2937">2937</td><td class="line"> <span class='comment'>* 3) Every time we are left without slaves at all, and AOF is off, in order</span></td></tr>
<tr class="codeline" data-linenumber="2938"><td class="num" id="LN2938">2938</td><td class="line"> <span class='comment'>*    to reclaim otherwise unused memory.</span></td></tr>
<tr class="codeline" data-linenumber="2939"><td class="num" id="LN2939">2939</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="2940"><td class="num" id="LN2940">2940</td><td class="line"><span class='keyword'>void</span> replicationScriptCacheFlush(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="2941"><td class="num" id="LN2941">2941</td><td class="line">    dictEmpty(server.repl_scriptcache_dict,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2942"><td class="num" id="LN2942">2942</td><td class="line">    listRelease(server.repl_scriptcache_fifo);</td></tr>
<tr class="codeline" data-linenumber="2943"><td class="num" id="LN2943">2943</td><td class="line">    server.repl_scriptcache_fifo = listCreate();</td></tr>
<tr class="codeline" data-linenumber="2944"><td class="num" id="LN2944">2944</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2945"><td class="num" id="LN2945">2945</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2946"><td class="num" id="LN2946">2946</td><td class="line"><span class='comment'>/* Add an entry into the script cache, if we reach max number of entries the</span></td></tr>
<tr class="codeline" data-linenumber="2947"><td class="num" id="LN2947">2947</td><td class="line"> <span class='comment'>* oldest is removed from the list. */</span></td></tr>
<tr class="codeline" data-linenumber="2948"><td class="num" id="LN2948">2948</td><td class="line"><span class='keyword'>void</span> replicationScriptCacheAdd(sds sha1) {</td></tr>
<tr class="codeline" data-linenumber="2949"><td class="num" id="LN2949">2949</td><td class="line">    <span class='keyword'>int</span> retval;</td></tr>
<tr class="codeline" data-linenumber="2950"><td class="num" id="LN2950">2950</td><td class="line">    sds key = sdsdup(sha1);</td></tr>
<tr class="codeline" data-linenumber="2951"><td class="num" id="LN2951">2951</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2952"><td class="num" id="LN2952">2952</td><td class="line">    <span class='comment'>/* Evict oldest. */</span></td></tr>
<tr class="codeline" data-linenumber="2953"><td class="num" id="LN2953">2953</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>listLength(server.repl_scriptcache_fifo)<span class='macro_popup'>((server.repl_scriptcache_fifo)-&gt;len)</span></span> == server.repl_scriptcache_size)</td></tr>
<tr class="codeline" data-linenumber="2954"><td class="num" id="LN2954">2954</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="2955"><td class="num" id="LN2955">2955</td><td class="line">        listNode *ln = <span class='macro'>listLast(server.repl_scriptcache_fifo)<span class='macro_popup'>((server.repl_scriptcache_fifo)-&gt;tail)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2956"><td class="num" id="LN2956">2956</td><td class="line">        sds oldest = <span class='macro'>listNodeValue(ln)<span class='macro_popup'>((ln)-&gt;value)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2957"><td class="num" id="LN2957">2957</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2958"><td class="num" id="LN2958">2958</td><td class="line">        retval = dictDelete(server.repl_scriptcache_dict,oldest);</td></tr>
<tr class="codeline" data-linenumber="2959"><td class="num" id="LN2959">2959</td><td class="line">        <span class='macro'>serverAssert(retval == DICT_OK)<span class='macro_popup'>((retval == 0)?(void)0 : (_serverAssert("retval == DICT_OK","replication.c"<br>,2959),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2960"><td class="num" id="LN2960">2960</td><td class="line">        listDelNode(server.repl_scriptcache_fifo,ln);</td></tr>
<tr class="codeline" data-linenumber="2961"><td class="num" id="LN2961">2961</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="2962"><td class="num" id="LN2962">2962</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2963"><td class="num" id="LN2963">2963</td><td class="line">    <span class='comment'>/* Add current. */</span></td></tr>
<tr class="codeline" data-linenumber="2964"><td class="num" id="LN2964">2964</td><td class="line">    retval = dictAdd(server.repl_scriptcache_dict,key,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="2965"><td class="num" id="LN2965">2965</td><td class="line">    listAddNodeHead(server.repl_scriptcache_fifo,key);</td></tr>
<tr class="codeline" data-linenumber="2966"><td class="num" id="LN2966">2966</td><td class="line">    <span class='macro'>serverAssert(retval == DICT_OK)<span class='macro_popup'>((retval == 0)?(void)0 : (_serverAssert("retval == DICT_OK","replication.c"<br>,2966),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2967"><td class="num" id="LN2967">2967</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2968"><td class="num" id="LN2968">2968</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2969"><td class="num" id="LN2969">2969</td><td class="line"><span class='comment'>/* Returns non-zero if the specified entry exists inside the cache, that is,</span></td></tr>
<tr class="codeline" data-linenumber="2970"><td class="num" id="LN2970">2970</td><td class="line"> <span class='comment'>* if all the slaves are aware of this script SHA1. */</span></td></tr>
<tr class="codeline" data-linenumber="2971"><td class="num" id="LN2971">2971</td><td class="line"><span class='keyword'>int</span> replicationScriptCacheExists(sds sha1) {</td></tr>
<tr class="codeline" data-linenumber="2972"><td class="num" id="LN2972">2972</td><td class="line">    <span class='keyword'>return</span> dictFind(server.repl_scriptcache_dict,sha1) != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="2973"><td class="num" id="LN2973">2973</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="2974"><td class="num" id="LN2974">2974</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="2975"><td class="num" id="LN2975">2975</td><td class="line"><span class='comment'>/* ----------------------- SYNCHRONOUS REPLICATION --------------------------</span></td></tr>
<tr class="codeline" data-linenumber="2976"><td class="num" id="LN2976">2976</td><td class="line"> <span class='comment'>* Redis synchronous replication design can be summarized in points:</span></td></tr>
<tr class="codeline" data-linenumber="2977"><td class="num" id="LN2977">2977</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2978"><td class="num" id="LN2978">2978</td><td class="line"> <span class='comment'>* - Redis masters have a global replication offset, used by PSYNC.</span></td></tr>
<tr class="codeline" data-linenumber="2979"><td class="num" id="LN2979">2979</td><td class="line"> <span class='comment'>* - Master increment the offset every time new commands are sent to slaves.</span></td></tr>
<tr class="codeline" data-linenumber="2980"><td class="num" id="LN2980">2980</td><td class="line"> <span class='comment'>* - Slaves ping back masters with the offset processed so far.</span></td></tr>
<tr class="codeline" data-linenumber="2981"><td class="num" id="LN2981">2981</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2982"><td class="num" id="LN2982">2982</td><td class="line"> <span class='comment'>* So synchronous replication adds a new WAIT command in the form:</span></td></tr>
<tr class="codeline" data-linenumber="2983"><td class="num" id="LN2983">2983</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2984"><td class="num" id="LN2984">2984</td><td class="line"> <span class='comment'>*   WAIT &lt;num_replicas&gt; &lt;milliseconds_timeout&gt;</span></td></tr>
<tr class="codeline" data-linenumber="2985"><td class="num" id="LN2985">2985</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2986"><td class="num" id="LN2986">2986</td><td class="line"> <span class='comment'>* That returns the number of replicas that processed the query when</span></td></tr>
<tr class="codeline" data-linenumber="2987"><td class="num" id="LN2987">2987</td><td class="line"> <span class='comment'>* we finally have at least num_replicas, or when the timeout was</span></td></tr>
<tr class="codeline" data-linenumber="2988"><td class="num" id="LN2988">2988</td><td class="line"> <span class='comment'>* reached.</span></td></tr>
<tr class="codeline" data-linenumber="2989"><td class="num" id="LN2989">2989</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2990"><td class="num" id="LN2990">2990</td><td class="line"> <span class='comment'>* The command is implemented in this way:</span></td></tr>
<tr class="codeline" data-linenumber="2991"><td class="num" id="LN2991">2991</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="2992"><td class="num" id="LN2992">2992</td><td class="line"> <span class='comment'>* - Every time a client processes a command, we remember the replication</span></td></tr>
<tr class="codeline" data-linenumber="2993"><td class="num" id="LN2993">2993</td><td class="line"> <span class='comment'>*   offset after sending that command to the slaves.</span></td></tr>
<tr class="codeline" data-linenumber="2994"><td class="num" id="LN2994">2994</td><td class="line"> <span class='comment'>* - When WAIT is called, we ask slaves to send an acknowledgement ASAP.</span></td></tr>
<tr class="codeline" data-linenumber="2995"><td class="num" id="LN2995">2995</td><td class="line"> <span class='comment'>*   The client is blocked at the same time (see blocked.c).</span></td></tr>
<tr class="codeline" data-linenumber="2996"><td class="num" id="LN2996">2996</td><td class="line"> <span class='comment'>* - Once we receive enough ACKs for a given offset or when the timeout</span></td></tr>
<tr class="codeline" data-linenumber="2997"><td class="num" id="LN2997">2997</td><td class="line"> <span class='comment'>*   is reached, the WAIT command is unblocked and the reply sent to the</span></td></tr>
<tr class="codeline" data-linenumber="2998"><td class="num" id="LN2998">2998</td><td class="line"> <span class='comment'>*   client.</span></td></tr>
<tr class="codeline" data-linenumber="2999"><td class="num" id="LN2999">2999</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="3000"><td class="num" id="LN3000">3000</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3001"><td class="num" id="LN3001">3001</td><td class="line"><span class='comment'>/* This just set a flag so that we broadcast a REPLCONF GETACK command</span></td></tr>
<tr class="codeline" data-linenumber="3002"><td class="num" id="LN3002">3002</td><td class="line"> <span class='comment'>* to all the slaves in the beforeSleep() function. Note that this way</span></td></tr>
<tr class="codeline" data-linenumber="3003"><td class="num" id="LN3003">3003</td><td class="line"> <span class='comment'>* we "group" all the clients that want to wait for synchronous replication</span></td></tr>
<tr class="codeline" data-linenumber="3004"><td class="num" id="LN3004">3004</td><td class="line"> <span class='comment'>* in a given event loop iteration, and send a single GETACK for them all. */</span></td></tr>
<tr class="codeline" data-linenumber="3005"><td class="num" id="LN3005">3005</td><td class="line"><span class='keyword'>void</span> replicationRequestAckFromSlaves(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="3006"><td class="num" id="LN3006">3006</td><td class="line">    server.get_ack_from_slaves = 1;</td></tr>
<tr class="codeline" data-linenumber="3007"><td class="num" id="LN3007">3007</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3008"><td class="num" id="LN3008">3008</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3009"><td class="num" id="LN3009">3009</td><td class="line"><span class='comment'>/* Return the number of slaves that already acknowledged the specified</span></td></tr>
<tr class="codeline" data-linenumber="3010"><td class="num" id="LN3010">3010</td><td class="line"> <span class='comment'>* replication offset. */</span></td></tr>
<tr class="codeline" data-linenumber="3011"><td class="num" id="LN3011">3011</td><td class="line"><span class='keyword'>int</span> replicationCountAcksByOffset(<span class='keyword'>long</span> <span class='keyword'>long</span> offset) {</td></tr>
<tr class="codeline" data-linenumber="3012"><td class="num" id="LN3012">3012</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="3013"><td class="num" id="LN3013">3013</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="3014"><td class="num" id="LN3014">3014</td><td class="line">    <span class='keyword'>int</span> count = 0;</td></tr>
<tr class="codeline" data-linenumber="3015"><td class="num" id="LN3015">3015</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3016"><td class="num" id="LN3016">3016</td><td class="line">    listRewind(server.slaves,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="3017"><td class="num" id="LN3017">3017</td><td class="line">    <span class='keyword'>while</span>((ln = listNext(&amp;li))) {</td></tr>
<tr class="codeline" data-linenumber="3018"><td class="num" id="LN3018">3018</td><td class="line">        client *slave = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="3019"><td class="num" id="LN3019">3019</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3020"><td class="num" id="LN3020">3020</td><td class="line">        <span class='keyword'>if</span> (slave-&gt;replstate != <span class='macro'>SLAVE_STATE_ONLINE<span class='macro_popup'>9</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="3021"><td class="num" id="LN3021">3021</td><td class="line">        <span class='keyword'>if</span> (slave-&gt;repl_ack_off &gt;= offset) count++;</td></tr>
<tr class="codeline" data-linenumber="3022"><td class="num" id="LN3022">3022</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3023"><td class="num" id="LN3023">3023</td><td class="line">    <span class='keyword'>return</span> count;</td></tr>
<tr class="codeline" data-linenumber="3024"><td class="num" id="LN3024">3024</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3025"><td class="num" id="LN3025">3025</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3026"><td class="num" id="LN3026">3026</td><td class="line"><span class='comment'>/* WAIT for N replicas to acknowledge the processing of our latest</span></td></tr>
<tr class="codeline" data-linenumber="3027"><td class="num" id="LN3027">3027</td><td class="line"> <span class='comment'>* write command (and all the previous commands). */</span></td></tr>
<tr class="codeline" data-linenumber="3028"><td class="num" id="LN3028">3028</td><td class="line"><span class='keyword'>void</span> waitCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="3029"><td class="num" id="LN3029">3029</td><td class="line">    mstime_t timeout;</td></tr>
<tr class="codeline" data-linenumber="3030"><td class="num" id="LN3030">3030</td><td class="line">    <span class='keyword'>long</span> numreplicas, ackreplicas;</td></tr>
<tr class="codeline" data-linenumber="3031"><td class="num" id="LN3031">3031</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> offset = c-&gt;woff;</td></tr>
<tr class="codeline" data-linenumber="3032"><td class="num" id="LN3032">3032</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3033"><td class="num" id="LN3033">3033</td><td class="line">    <span class='keyword'>if</span> (server.masterhost) {</td></tr>
<tr class="codeline" data-linenumber="3034"><td class="num" id="LN3034">3034</td><td class="line">        addReplyError(c,<span class='string_literal'>"WAIT cannot be used with replica instances. Please also note that since Redis 4.0 if a replica is configured to be writable (which is not the default) writes to replicas are just local and are not propagated."</span>);</td></tr>
<tr class="codeline" data-linenumber="3035"><td class="num" id="LN3035">3035</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="3036"><td class="num" id="LN3036">3036</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3037"><td class="num" id="LN3037">3037</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3038"><td class="num" id="LN3038">3038</td><td class="line">    <span class='comment'>/* Argument parsing. */</span></td></tr>
<tr class="codeline" data-linenumber="3039"><td class="num" id="LN3039">3039</td><td class="line">    <span class='keyword'>if</span> (getLongFromObjectOrReply(c,c-&gt;argv[1],&amp;numreplicas,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) != <span class='macro'>C_OK<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3040"><td class="num" id="LN3040">3040</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="3041"><td class="num" id="LN3041">3041</td><td class="line">    <span class='keyword'>if</span> (getTimeoutFromObjectOrReply(c,c-&gt;argv[2],&amp;timeout,<span class='macro'>UNIT_MILLISECONDS<span class='macro_popup'>1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3042"><td class="num" id="LN3042">3042</td><td class="line">        != <span class='macro'>C_OK<span class='macro_popup'>0</span></span>) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="3043"><td class="num" id="LN3043">3043</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3044"><td class="num" id="LN3044">3044</td><td class="line">    <span class='comment'>/* First try without blocking at all. */</span></td></tr>
<tr class="codeline" data-linenumber="3045"><td class="num" id="LN3045">3045</td><td class="line">    ackreplicas = replicationCountAcksByOffset(c-&gt;woff);</td></tr>
<tr class="codeline" data-linenumber="3046"><td class="num" id="LN3046">3046</td><td class="line">    <span class='keyword'>if</span> (ackreplicas &gt;= numreplicas || c-&gt;flags &amp; <span class='macro'>CLIENT_MULTI<span class='macro_popup'>(1&lt;&lt;3)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3047"><td class="num" id="LN3047">3047</td><td class="line">        addReplyLongLong(c,ackreplicas);</td></tr>
<tr class="codeline" data-linenumber="3048"><td class="num" id="LN3048">3048</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="3049"><td class="num" id="LN3049">3049</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3050"><td class="num" id="LN3050">3050</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3051"><td class="num" id="LN3051">3051</td><td class="line">    <span class='comment'>/* Otherwise block the client and put it into our list of clients</span></td></tr>
<tr class="codeline" data-linenumber="3052"><td class="num" id="LN3052">3052</td><td class="line">     <span class='comment'>* waiting for ack from slaves. */</span></td></tr>
<tr class="codeline" data-linenumber="3053"><td class="num" id="LN3053">3053</td><td class="line">    c-&gt;bpop.timeout = timeout;</td></tr>
<tr class="codeline" data-linenumber="3054"><td class="num" id="LN3054">3054</td><td class="line">    c-&gt;bpop.reploffset = offset;</td></tr>
<tr class="codeline" data-linenumber="3055"><td class="num" id="LN3055">3055</td><td class="line">    c-&gt;bpop.numreplicas = numreplicas;</td></tr>
<tr class="codeline" data-linenumber="3056"><td class="num" id="LN3056">3056</td><td class="line">    listAddNodeTail(server.clients_waiting_acks,c);</td></tr>
<tr class="codeline" data-linenumber="3057"><td class="num" id="LN3057">3057</td><td class="line">    blockClient(c,<span class='macro'>BLOCKED_WAIT<span class='macro_popup'>2</span></span>);</td></tr>
<tr class="codeline" data-linenumber="3058"><td class="num" id="LN3058">3058</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3059"><td class="num" id="LN3059">3059</td><td class="line">    <span class='comment'>/* Make sure that the server will send an ACK request to all the slaves</span></td></tr>
<tr class="codeline" data-linenumber="3060"><td class="num" id="LN3060">3060</td><td class="line">     <span class='comment'>* before returning to the event loop. */</span></td></tr>
<tr class="codeline" data-linenumber="3061"><td class="num" id="LN3061">3061</td><td class="line">    replicationRequestAckFromSlaves();</td></tr>
<tr class="codeline" data-linenumber="3062"><td class="num" id="LN3062">3062</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3063"><td class="num" id="LN3063">3063</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3064"><td class="num" id="LN3064">3064</td><td class="line"><span class='comment'>/* This is called by unblockClient() to perform the blocking op type</span></td></tr>
<tr class="codeline" data-linenumber="3065"><td class="num" id="LN3065">3065</td><td class="line"> <span class='comment'>* specific cleanup. We just remove the client from the list of clients</span></td></tr>
<tr class="codeline" data-linenumber="3066"><td class="num" id="LN3066">3066</td><td class="line"> <span class='comment'>* waiting for replica acks. Never call it directly, call unblockClient()</span></td></tr>
<tr class="codeline" data-linenumber="3067"><td class="num" id="LN3067">3067</td><td class="line"> <span class='comment'>* instead. */</span></td></tr>
<tr class="codeline" data-linenumber="3068"><td class="num" id="LN3068">3068</td><td class="line"><span class='keyword'>void</span> unblockClientWaitingReplicas(client *c) {</td></tr>
<tr class="codeline" data-linenumber="3069"><td class="num" id="LN3069">3069</td><td class="line">    listNode *ln = listSearchKey(server.clients_waiting_acks,c);</td></tr>
<tr class="codeline" data-linenumber="3070"><td class="num" id="LN3070">3070</td><td class="line">    <span class='macro'>serverAssert(ln != NULL)<span class='macro_popup'>((ln != ((void*)0))?(void)0 : (_serverAssert("ln != NULL","replication.c"<br>,3070),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="3071"><td class="num" id="LN3071">3071</td><td class="line">    listDelNode(server.clients_waiting_acks,ln);</td></tr>
<tr class="codeline" data-linenumber="3072"><td class="num" id="LN3072">3072</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3073"><td class="num" id="LN3073">3073</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3074"><td class="num" id="LN3074">3074</td><td class="line"><span class='comment'>/* Check if there are clients blocked in WAIT that can be unblocked since</span></td></tr>
<tr class="codeline" data-linenumber="3075"><td class="num" id="LN3075">3075</td><td class="line"> <span class='comment'>* we received enough ACKs from slaves. */</span></td></tr>
<tr class="codeline" data-linenumber="3076"><td class="num" id="LN3076">3076</td><td class="line"><span class='keyword'>void</span> processClientsWaitingReplicas(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="3077"><td class="num" id="LN3077">3077</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> last_offset = 0;</td></tr>
<tr class="codeline" data-linenumber="3078"><td class="num" id="LN3078">3078</td><td class="line">    <span class='keyword'>int</span> last_numreplicas = 0;</td></tr>
<tr class="codeline" data-linenumber="3079"><td class="num" id="LN3079">3079</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3080"><td class="num" id="LN3080">3080</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="3081"><td class="num" id="LN3081">3081</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="3082"><td class="num" id="LN3082">3082</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3083"><td class="num" id="LN3083">3083</td><td class="line">    listRewind(server.clients_waiting_acks,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="3084"><td class="num" id="LN3084">3084</td><td class="line">    <span class='keyword'>while</span>((ln = listNext(&amp;li))) {</td></tr>
<tr class="codeline" data-linenumber="3085"><td class="num" id="LN3085">3085</td><td class="line">        client *c = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="3086"><td class="num" id="LN3086">3086</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3087"><td class="num" id="LN3087">3087</td><td class="line">        <span class='comment'>/* Every time we find a client that is satisfied for a given</span></td></tr>
<tr class="codeline" data-linenumber="3088"><td class="num" id="LN3088">3088</td><td class="line">         <span class='comment'>* offset and number of replicas, we remember it so the next client</span></td></tr>
<tr class="codeline" data-linenumber="3089"><td class="num" id="LN3089">3089</td><td class="line">         <span class='comment'>* may be unblocked without calling replicationCountAcksByOffset()</span></td></tr>
<tr class="codeline" data-linenumber="3090"><td class="num" id="LN3090">3090</td><td class="line">         <span class='comment'>* if the requested offset / replicas were equal or less. */</span></td></tr>
<tr class="codeline" data-linenumber="3091"><td class="num" id="LN3091">3091</td><td class="line">        <span class='keyword'>if</span> (last_offset &amp;&amp; last_offset &gt; c-&gt;bpop.reploffset &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3092"><td class="num" id="LN3092">3092</td><td class="line">                           last_numreplicas &gt; c-&gt;bpop.numreplicas)</td></tr>
<tr class="codeline" data-linenumber="3093"><td class="num" id="LN3093">3093</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="3094"><td class="num" id="LN3094">3094</td><td class="line">            unblockClient(c);</td></tr>
<tr class="codeline" data-linenumber="3095"><td class="num" id="LN3095">3095</td><td class="line">            addReplyLongLong(c,last_numreplicas);</td></tr>
<tr class="codeline" data-linenumber="3096"><td class="num" id="LN3096">3096</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="3097"><td class="num" id="LN3097">3097</td><td class="line">            <span class='keyword'>int</span> numreplicas = replicationCountAcksByOffset(c-&gt;bpop.reploffset);</td></tr>
<tr class="codeline" data-linenumber="3098"><td class="num" id="LN3098">3098</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3099"><td class="num" id="LN3099">3099</td><td class="line">            <span class='keyword'>if</span> (numreplicas &gt;= c-&gt;bpop.numreplicas) {</td></tr>
<tr class="codeline" data-linenumber="3100"><td class="num" id="LN3100">3100</td><td class="line">                last_offset = c-&gt;bpop.reploffset;</td></tr>
<tr class="codeline" data-linenumber="3101"><td class="num" id="LN3101">3101</td><td class="line">                last_numreplicas = numreplicas;</td></tr>
<tr class="codeline" data-linenumber="3102"><td class="num" id="LN3102">3102</td><td class="line">                unblockClient(c);</td></tr>
<tr class="codeline" data-linenumber="3103"><td class="num" id="LN3103">3103</td><td class="line">                addReplyLongLong(c,numreplicas);</td></tr>
<tr class="codeline" data-linenumber="3104"><td class="num" id="LN3104">3104</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3105"><td class="num" id="LN3105">3105</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3106"><td class="num" id="LN3106">3106</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3107"><td class="num" id="LN3107">3107</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3108"><td class="num" id="LN3108">3108</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3109"><td class="num" id="LN3109">3109</td><td class="line"><span class='comment'>/* Return the slave replication offset for this instance, that is</span></td></tr>
<tr class="codeline" data-linenumber="3110"><td class="num" id="LN3110">3110</td><td class="line"> <span class='comment'>* the offset for which we already processed the master replication stream. */</span></td></tr>
<tr class="codeline" data-linenumber="3111"><td class="num" id="LN3111">3111</td><td class="line"><span class='keyword'>long</span> <span class='keyword'>long</span> replicationGetSlaveOffset(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="3112"><td class="num" id="LN3112">3112</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> offset = 0;</td></tr>
<tr class="codeline" data-linenumber="3113"><td class="num" id="LN3113">3113</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3114"><td class="num" id="LN3114">3114</td><td class="line">    <span class='keyword'>if</span> (server.masterhost != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3115"><td class="num" id="LN3115">3115</td><td class="line">        <span class='keyword'>if</span> (server.master) {</td></tr>
<tr class="codeline" data-linenumber="3116"><td class="num" id="LN3116">3116</td><td class="line">            offset = server.master-&gt;reploff;</td></tr>
<tr class="codeline" data-linenumber="3117"><td class="num" id="LN3117">3117</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (server.cached_master) {</td></tr>
<tr class="codeline" data-linenumber="3118"><td class="num" id="LN3118">3118</td><td class="line">            offset = server.cached_master-&gt;reploff;</td></tr>
<tr class="codeline" data-linenumber="3119"><td class="num" id="LN3119">3119</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3120"><td class="num" id="LN3120">3120</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3121"><td class="num" id="LN3121">3121</td><td class="line">    <span class='comment'>/* offset may be -1 when the master does not support it at all, however</span></td></tr>
<tr class="codeline" data-linenumber="3122"><td class="num" id="LN3122">3122</td><td class="line">     <span class='comment'>* this function is designed to return an offset that can express the</span></td></tr>
<tr class="codeline" data-linenumber="3123"><td class="num" id="LN3123">3123</td><td class="line">     <span class='comment'>* amount of data processed by the master, so we return a positive</span></td></tr>
<tr class="codeline" data-linenumber="3124"><td class="num" id="LN3124">3124</td><td class="line">     <span class='comment'>* integer. */</span></td></tr>
<tr class="codeline" data-linenumber="3125"><td class="num" id="LN3125">3125</td><td class="line">    <span class='keyword'>if</span> (offset &lt; 0) offset = 0;</td></tr>
<tr class="codeline" data-linenumber="3126"><td class="num" id="LN3126">3126</td><td class="line">    <span class='keyword'>return</span> offset;</td></tr>
<tr class="codeline" data-linenumber="3127"><td class="num" id="LN3127">3127</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="3128"><td class="num" id="LN3128">3128</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3129"><td class="num" id="LN3129">3129</td><td class="line"><span class='comment'>/* --------------------------- REPLICATION CRON  ---------------------------- */</span></td></tr>
<tr class="codeline" data-linenumber="3130"><td class="num" id="LN3130">3130</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3131"><td class="num" id="LN3131">3131</td><td class="line"><span class='comment'>/* Replication cron function, called 1 time per second. */</span></td></tr>
<tr class="codeline" data-linenumber="3132"><td class="num" id="LN3132">3132</td><td class="line"><span class='keyword'>void</span> replicationCron(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="3133"><td class="num" id="LN3133">3133</td><td class="line">    <span class='keyword'>static</span> <span class='keyword'>long</span> <span class='keyword'>long</span> replication_cron_loops = 0;</td></tr>
<tr class="codeline" data-linenumber="3134"><td class="num" id="LN3134">3134</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3135"><td class="num" id="LN3135">3135</td><td class="line">    <span class='comment'>/* Non blocking connection timeout? */</span></td></tr>
<tr class="codeline" data-linenumber="3136"><td class="num" id="LN3136">3136</td><td class="line">    <span class='keyword'>if</span> (server.masterhost &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3137"><td class="num" id="LN3137">3137</td><td class="line">        (server.repl_state == <span class='macro'>REPL_STATE_CONNECTING<span class='macro_popup'>2</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="3138"><td class="num" id="LN3138">3138</td><td class="line">         slaveIsInHandshakeState()) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3139"><td class="num" id="LN3139">3139</td><td class="line">         (time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)-server.repl_transfer_lastio) &gt; server.repl_timeout)</td></tr>
<tr class="codeline" data-linenumber="3140"><td class="num" id="LN3140">3140</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3141"><td class="num" id="LN3141">3141</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Timeout connecting to the MASTER..."</span>);</td></tr>
<tr class="codeline" data-linenumber="3142"><td class="num" id="LN3142">3142</td><td class="line">        cancelReplicationHandshake();</td></tr>
<tr class="codeline" data-linenumber="3143"><td class="num" id="LN3143">3143</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3144"><td class="num" id="LN3144">3144</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3145"><td class="num" id="LN3145">3145</td><td class="line">    <span class='comment'>/* Bulk transfer I/O timeout? */</span></td></tr>
<tr class="codeline" data-linenumber="3146"><td class="num" id="LN3146">3146</td><td class="line">    <span class='keyword'>if</span> (server.masterhost &amp;&amp; server.repl_state == <span class='macro'>REPL_STATE_TRANSFER<span class='macro_popup'>14</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3147"><td class="num" id="LN3147">3147</td><td class="line">        (time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)-server.repl_transfer_lastio) &gt; server.repl_timeout)</td></tr>
<tr class="codeline" data-linenumber="3148"><td class="num" id="LN3148">3148</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3149"><td class="num" id="LN3149">3149</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"Timeout receiving bulk data from MASTER... If the problem persists try to set the 'repl-timeout' parameter in redis.conf to a larger value."</span>);</td></tr>
<tr class="codeline" data-linenumber="3150"><td class="num" id="LN3150">3150</td><td class="line">        cancelReplicationHandshake();</td></tr>
<tr class="codeline" data-linenumber="3151"><td class="num" id="LN3151">3151</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3152"><td class="num" id="LN3152">3152</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3153"><td class="num" id="LN3153">3153</td><td class="line">    <span class='comment'>/* Timed out master when we are an already connected slave? */</span></td></tr>
<tr class="codeline" data-linenumber="3154"><td class="num" id="LN3154">3154</td><td class="line">    <span class='keyword'>if</span> (server.masterhost &amp;&amp; server.repl_state == <span class='macro'>REPL_STATE_CONNECTED<span class='macro_popup'>15</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3155"><td class="num" id="LN3155">3155</td><td class="line">        (time(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)-server.master-&gt;lastinteraction) &gt; server.repl_timeout)</td></tr>
<tr class="codeline" data-linenumber="3156"><td class="num" id="LN3156">3156</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3157"><td class="num" id="LN3157">3157</td><td class="line">        serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>,<span class='string_literal'>"MASTER timeout: no data nor PING received..."</span>);</td></tr>
<tr class="codeline" data-linenumber="3158"><td class="num" id="LN3158">3158</td><td class="line">        freeClient(server.master);</td></tr>
<tr class="codeline" data-linenumber="3159"><td class="num" id="LN3159">3159</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3160"><td class="num" id="LN3160">3160</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3161"><td class="num" id="LN3161">3161</td><td class="line">    <span class='comment'>/* Check if we should connect to a MASTER */</span></td></tr>
<tr class="codeline" data-linenumber="3162"><td class="num" id="LN3162">3162</td><td class="line">    <span class='keyword'>if</span> (server.repl_state == <span class='macro'>REPL_STATE_CONNECT<span class='macro_popup'>1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3163"><td class="num" id="LN3163">3163</td><td class="line">        serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"Connecting to MASTER %s:%d"</span>,</td></tr>
<tr class="codeline" data-linenumber="3164"><td class="num" id="LN3164">3164</td><td class="line">            server.masterhost, server.masterport);</td></tr>
<tr class="codeline" data-linenumber="3165"><td class="num" id="LN3165">3165</td><td class="line">        <span class='keyword'>if</span> (connectWithMaster() == <span class='macro'>C_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3166"><td class="num" id="LN3166">3166</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,<span class='string_literal'>"MASTER &lt;-&gt; REPLICA sync started"</span>);</td></tr>
<tr class="codeline" data-linenumber="3167"><td class="num" id="LN3167">3167</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3168"><td class="num" id="LN3168">3168</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3169"><td class="num" id="LN3169">3169</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3170"><td class="num" id="LN3170">3170</td><td class="line">    <span class='comment'>/* Send ACK to master from time to time.</span></td></tr>
<tr class="codeline" data-linenumber="3171"><td class="num" id="LN3171">3171</td><td class="line">     <span class='comment'>* Note that we do not send periodic acks to masters that don't</span></td></tr>
<tr class="codeline" data-linenumber="3172"><td class="num" id="LN3172">3172</td><td class="line">     <span class='comment'>* support PSYNC and replication offsets. */</span></td></tr>
<tr class="codeline" data-linenumber="3173"><td class="num" id="LN3173">3173</td><td class="line">    <span class='keyword'>if</span> (server.masterhost &amp;&amp; server.master &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3174"><td class="num" id="LN3174">3174</td><td class="line">        !(server.master-&gt;flags &amp; <span class='macro'>CLIENT_PRE_PSYNC<span class='macro_popup'>(1&lt;&lt;16)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="3175"><td class="num" id="LN3175">3175</td><td class="line">        replicationSendAck();</td></tr>
<tr class="codeline" data-linenumber="3176"><td class="num" id="LN3176">3176</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3177"><td class="num" id="LN3177">3177</td><td class="line">    <span class='comment'>/* If we have attached slaves, PING them from time to time.</span></td></tr>
<tr class="codeline" data-linenumber="3178"><td class="num" id="LN3178">3178</td><td class="line">     <span class='comment'>* So slaves can implement an explicit timeout to masters, and will</span></td></tr>
<tr class="codeline" data-linenumber="3179"><td class="num" id="LN3179">3179</td><td class="line">     <span class='comment'>* be able to detect a link disconnection even if the TCP connection</span></td></tr>
<tr class="codeline" data-linenumber="3180"><td class="num" id="LN3180">3180</td><td class="line">     <span class='comment'>* will not actually go down. */</span></td></tr>
<tr class="codeline" data-linenumber="3181"><td class="num" id="LN3181">3181</td><td class="line">    listIter li;</td></tr>
<tr class="codeline" data-linenumber="3182"><td class="num" id="LN3182">3182</td><td class="line">    listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="3183"><td class="num" id="LN3183">3183</td><td class="line">    robj *ping_argv[1];</td></tr>
<tr class="codeline" data-linenumber="3184"><td class="num" id="LN3184">3184</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3185"><td class="num" id="LN3185">3185</td><td class="line">    <span class='comment'>/* First, send PING according to ping_slave_period. */</span></td></tr>
<tr class="codeline" data-linenumber="3186"><td class="num" id="LN3186">3186</td><td class="line">    <span class='keyword'>if</span> ((replication_cron_loops % server.repl_ping_slave_period) == 0 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3187"><td class="num" id="LN3187">3187</td><td class="line">        <span class='macro'>listLength(server.slaves)<span class='macro_popup'>((server.slaves)-&gt;len)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3188"><td class="num" id="LN3188">3188</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3189"><td class="num" id="LN3189">3189</td><td class="line">        <span class='comment'>/* Note that we don't send the PING if the clients are paused during</span></td></tr>
<tr class="codeline" data-linenumber="3190"><td class="num" id="LN3190">3190</td><td class="line">         <span class='comment'>* a Redis Cluster manual failover: the PING we send will otherwise</span></td></tr>
<tr class="codeline" data-linenumber="3191"><td class="num" id="LN3191">3191</td><td class="line">         <span class='comment'>* alter the replication offsets of master and slave, and will no longer</span></td></tr>
<tr class="codeline" data-linenumber="3192"><td class="num" id="LN3192">3192</td><td class="line">         <span class='comment'>* match the one stored into 'mf_master_offset' state. */</span></td></tr>
<tr class="codeline" data-linenumber="3193"><td class="num" id="LN3193">3193</td><td class="line">        <span class='keyword'>int</span> manual_failover_in_progress =</td></tr>
<tr class="codeline" data-linenumber="3194"><td class="num" id="LN3194">3194</td><td class="line">            server.cluster_enabled &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3195"><td class="num" id="LN3195">3195</td><td class="line">            server.cluster-&gt;mf_end &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3196"><td class="num" id="LN3196">3196</td><td class="line">            clientsArePaused();</td></tr>
<tr class="codeline" data-linenumber="3197"><td class="num" id="LN3197">3197</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3198"><td class="num" id="LN3198">3198</td><td class="line">        <span class='keyword'>if</span> (!manual_failover_in_progress) {</td></tr>
<tr class="codeline" data-linenumber="3199"><td class="num" id="LN3199">3199</td><td class="line">            ping_argv[0] = createStringObject(<span class='string_literal'>"PING"</span>,4);</td></tr>
<tr class="codeline" data-linenumber="3200"><td class="num" id="LN3200">3200</td><td class="line">            replicationFeedSlaves(server.slaves, server.slaveseldb,</td></tr>
<tr class="codeline" data-linenumber="3201"><td class="num" id="LN3201">3201</td><td class="line">                ping_argv, 1);</td></tr>
<tr class="codeline" data-linenumber="3202"><td class="num" id="LN3202">3202</td><td class="line">            decrRefCount(ping_argv[0]);</td></tr>
<tr class="codeline" data-linenumber="3203"><td class="num" id="LN3203">3203</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3204"><td class="num" id="LN3204">3204</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3205"><td class="num" id="LN3205">3205</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3206"><td class="num" id="LN3206">3206</td><td class="line">    <span class='comment'>/* Second, send a newline to all the slaves in pre-synchronization</span></td></tr>
<tr class="codeline" data-linenumber="3207"><td class="num" id="LN3207">3207</td><td class="line">     <span class='comment'>* stage, that is, slaves waiting for the master to create the RDB file.</span></td></tr>
<tr class="codeline" data-linenumber="3208"><td class="num" id="LN3208">3208</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3209"><td class="num" id="LN3209">3209</td><td class="line">     <span class='comment'>* Also send the a newline to all the chained slaves we have, if we lost</span></td></tr>
<tr class="codeline" data-linenumber="3210"><td class="num" id="LN3210">3210</td><td class="line">     <span class='comment'>* connection from our master, to keep the slaves aware that their</span></td></tr>
<tr class="codeline" data-linenumber="3211"><td class="num" id="LN3211">3211</td><td class="line">     <span class='comment'>* master is online. This is needed since sub-slaves only receive proxied</span></td></tr>
<tr class="codeline" data-linenumber="3212"><td class="num" id="LN3212">3212</td><td class="line">     <span class='comment'>* data from top-level masters, so there is no explicit pinging in order</span></td></tr>
<tr class="codeline" data-linenumber="3213"><td class="num" id="LN3213">3213</td><td class="line">     <span class='comment'>* to avoid altering the replication offsets. This special out of band</span></td></tr>
<tr class="codeline" data-linenumber="3214"><td class="num" id="LN3214">3214</td><td class="line">     <span class='comment'>* pings (newlines) can be sent, they will have no effect in the offset.</span></td></tr>
<tr class="codeline" data-linenumber="3215"><td class="num" id="LN3215">3215</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3216"><td class="num" id="LN3216">3216</td><td class="line">     <span class='comment'>* The newline will be ignored by the slave but will refresh the</span></td></tr>
<tr class="codeline" data-linenumber="3217"><td class="num" id="LN3217">3217</td><td class="line">     <span class='comment'>* last interaction timer preventing a timeout. In this case we ignore the</span></td></tr>
<tr class="codeline" data-linenumber="3218"><td class="num" id="LN3218">3218</td><td class="line">     <span class='comment'>* ping period and refresh the connection once per second since certain</span></td></tr>
<tr class="codeline" data-linenumber="3219"><td class="num" id="LN3219">3219</td><td class="line">     <span class='comment'>* timeouts are set at a few seconds (example: PSYNC response). */</span></td></tr>
<tr class="codeline" data-linenumber="3220"><td class="num" id="LN3220">3220</td><td class="line">    listRewind(server.slaves,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="3221"><td class="num" id="LN3221">3221</td><td class="line">    <span class='keyword'>while</span>((ln = listNext(&amp;li))) {</td></tr>
<tr class="codeline" data-linenumber="3222"><td class="num" id="LN3222">3222</td><td class="line">        client *slave = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="3223"><td class="num" id="LN3223">3223</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3224"><td class="num" id="LN3224">3224</td><td class="line">        <span class='keyword'>int</span> is_presync =</td></tr>
<tr class="codeline" data-linenumber="3225"><td class="num" id="LN3225">3225</td><td class="line">            (slave-&gt;replstate == <span class='macro'>SLAVE_STATE_WAIT_BGSAVE_START<span class='macro_popup'>6</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="3226"><td class="num" id="LN3226">3226</td><td class="line">            (slave-&gt;replstate == <span class='macro'>SLAVE_STATE_WAIT_BGSAVE_END<span class='macro_popup'>7</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3227"><td class="num" id="LN3227">3227</td><td class="line">             server.rdb_child_type != <span class='macro'>RDB_CHILD_TYPE_SOCKET<span class='macro_popup'>2</span></span>));</td></tr>
<tr class="codeline" data-linenumber="3228"><td class="num" id="LN3228">3228</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3229"><td class="num" id="LN3229">3229</td><td class="line">        <span class='keyword'>if</span> (is_presync) {</td></tr>
<tr class="codeline" data-linenumber="3230"><td class="num" id="LN3230">3230</td><td class="line">            connWrite(slave-&gt;conn, <span class='string_literal'>"\n"</span>, 1);</td></tr>
<tr class="codeline" data-linenumber="3231"><td class="num" id="LN3231">3231</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3232"><td class="num" id="LN3232">3232</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3233"><td class="num" id="LN3233">3233</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3234"><td class="num" id="LN3234">3234</td><td class="line">    <span class='comment'>/* Disconnect timedout slaves. */</span></td></tr>
<tr class="codeline" data-linenumber="3235"><td class="num" id="LN3235">3235</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>listLength(server.slaves)<span class='macro_popup'>((server.slaves)-&gt;len)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3236"><td class="num" id="LN3236">3236</td><td class="line">        listIter li;</td></tr>
<tr class="codeline" data-linenumber="3237"><td class="num" id="LN3237">3237</td><td class="line">        listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="3238"><td class="num" id="LN3238">3238</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3239"><td class="num" id="LN3239">3239</td><td class="line">        listRewind(server.slaves,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="3240"><td class="num" id="LN3240">3240</td><td class="line">        <span class='keyword'>while</span>((ln = listNext(&amp;li))) {</td></tr>
<tr class="codeline" data-linenumber="3241"><td class="num" id="LN3241">3241</td><td class="line">            client *slave = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="3242"><td class="num" id="LN3242">3242</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3243"><td class="num" id="LN3243">3243</td><td class="line">            <span class='keyword'>if</span> (slave-&gt;replstate != <span class='macro'>SLAVE_STATE_ONLINE<span class='macro_popup'>9</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="3244"><td class="num" id="LN3244">3244</td><td class="line">            <span class='keyword'>if</span> (slave-&gt;flags &amp; <span class='macro'>CLIENT_PRE_PSYNC<span class='macro_popup'>(1&lt;&lt;16)</span></span>) <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="3245"><td class="num" id="LN3245">3245</td><td class="line">            <span class='keyword'>if</span> ((server.unixtime - slave-&gt;repl_ack_time) &gt; server.repl_timeout)</td></tr>
<tr class="codeline" data-linenumber="3246"><td class="num" id="LN3246">3246</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="3247"><td class="num" id="LN3247">3247</td><td class="line">                serverLog(<span class='macro'>LL_WARNING<span class='macro_popup'>3</span></span>, <span class='string_literal'>"Disconnecting timedout replica: %s"</span>,</td></tr>
<tr class="codeline" data-linenumber="3248"><td class="num" id="LN3248">3248</td><td class="line">                    replicationGetSlaveName(slave));</td></tr>
<tr class="codeline" data-linenumber="3249"><td class="num" id="LN3249">3249</td><td class="line">                freeClient(slave);</td></tr>
<tr class="codeline" data-linenumber="3250"><td class="num" id="LN3250">3250</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3251"><td class="num" id="LN3251">3251</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3252"><td class="num" id="LN3252">3252</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3253"><td class="num" id="LN3253">3253</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3254"><td class="num" id="LN3254">3254</td><td class="line">    <span class='comment'>/* If this is a master without attached slaves and there is a replication</span></td></tr>
<tr class="codeline" data-linenumber="3255"><td class="num" id="LN3255">3255</td><td class="line">     <span class='comment'>* backlog active, in order to reclaim memory we can free it after some</span></td></tr>
<tr class="codeline" data-linenumber="3256"><td class="num" id="LN3256">3256</td><td class="line">     <span class='comment'>* (configured) time. Note that this cannot be done for slaves: slaves</span></td></tr>
<tr class="codeline" data-linenumber="3257"><td class="num" id="LN3257">3257</td><td class="line">     <span class='comment'>* without sub-slaves attached should still accumulate data into the</span></td></tr>
<tr class="codeline" data-linenumber="3258"><td class="num" id="LN3258">3258</td><td class="line">     <span class='comment'>* backlog, in order to reply to PSYNC queries if they are turned into</span></td></tr>
<tr class="codeline" data-linenumber="3259"><td class="num" id="LN3259">3259</td><td class="line">     <span class='comment'>* masters after a failover. */</span></td></tr>
<tr class="codeline" data-linenumber="3260"><td class="num" id="LN3260">3260</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>listLength(server.slaves)<span class='macro_popup'>((server.slaves)-&gt;len)</span></span> == 0 &amp;&amp; server.repl_backlog_time_limit &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3261"><td class="num" id="LN3261">3261</td><td class="line">        server.repl_backlog &amp;&amp; server.masterhost == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="3262"><td class="num" id="LN3262">3262</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3263"><td class="num" id="LN3263">3263</td><td class="line">        time_t idle = server.unixtime - server.repl_no_slaves_since;</td></tr>
<tr class="codeline" data-linenumber="3264"><td class="num" id="LN3264">3264</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3265"><td class="num" id="LN3265">3265</td><td class="line">        <span class='keyword'>if</span> (idle &gt; server.repl_backlog_time_limit) {</td></tr>
<tr class="codeline" data-linenumber="3266"><td class="num" id="LN3266">3266</td><td class="line">            <span class='comment'>/* When we free the backlog, we always use a new</span></td></tr>
<tr class="codeline" data-linenumber="3267"><td class="num" id="LN3267">3267</td><td class="line">             <span class='comment'>* replication ID and clear the ID2. This is needed</span></td></tr>
<tr class="codeline" data-linenumber="3268"><td class="num" id="LN3268">3268</td><td class="line">             <span class='comment'>* because when there is no backlog, the master_repl_offset</span></td></tr>
<tr class="codeline" data-linenumber="3269"><td class="num" id="LN3269">3269</td><td class="line">             <span class='comment'>* is not updated, but we would still retain our replication</span></td></tr>
<tr class="codeline" data-linenumber="3270"><td class="num" id="LN3270">3270</td><td class="line">             <span class='comment'>* ID, leading to the following problem:</span></td></tr>
<tr class="codeline" data-linenumber="3271"><td class="num" id="LN3271">3271</td><td class="line">             <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3272"><td class="num" id="LN3272">3272</td><td class="line">             <span class='comment'>* 1. We are a master instance.</span></td></tr>
<tr class="codeline" data-linenumber="3273"><td class="num" id="LN3273">3273</td><td class="line">             <span class='comment'>* 2. Our slave is promoted to master. It's repl-id-2 will</span></td></tr>
<tr class="codeline" data-linenumber="3274"><td class="num" id="LN3274">3274</td><td class="line">             <span class='comment'>*    be the same as our repl-id.</span></td></tr>
<tr class="codeline" data-linenumber="3275"><td class="num" id="LN3275">3275</td><td class="line">             <span class='comment'>* 3. We, yet as master, receive some updates, that will not</span></td></tr>
<tr class="codeline" data-linenumber="3276"><td class="num" id="LN3276">3276</td><td class="line">             <span class='comment'>*    increment the master_repl_offset.</span></td></tr>
<tr class="codeline" data-linenumber="3277"><td class="num" id="LN3277">3277</td><td class="line">             <span class='comment'>* 4. Later we are turned into a slave, connect to the new</span></td></tr>
<tr class="codeline" data-linenumber="3278"><td class="num" id="LN3278">3278</td><td class="line">             <span class='comment'>*    master that will accept our PSYNC request by second</span></td></tr>
<tr class="codeline" data-linenumber="3279"><td class="num" id="LN3279">3279</td><td class="line">             <span class='comment'>*    replication ID, but there will be data inconsistency</span></td></tr>
<tr class="codeline" data-linenumber="3280"><td class="num" id="LN3280">3280</td><td class="line">             <span class='comment'>*    because we received writes. */</span></td></tr>
<tr class="codeline" data-linenumber="3281"><td class="num" id="LN3281">3281</td><td class="line">            changeReplicationId();</td></tr>
<tr class="codeline" data-linenumber="3282"><td class="num" id="LN3282">3282</td><td class="line">            clearReplicationId2();</td></tr>
<tr class="codeline" data-linenumber="3283"><td class="num" id="LN3283">3283</td><td class="line">            freeReplicationBacklog();</td></tr>
<tr class="codeline" data-linenumber="3284"><td class="num" id="LN3284">3284</td><td class="line">            serverLog(<span class='macro'>LL_NOTICE<span class='macro_popup'>2</span></span>,</td></tr>
<tr class="codeline" data-linenumber="3285"><td class="num" id="LN3285">3285</td><td class="line">                <span class='string_literal'>"Replication backlog freed after %d seconds "</span></td></tr>
<tr class="codeline" data-linenumber="3286"><td class="num" id="LN3286">3286</td><td class="line">                <span class='string_literal'>"without connected replicas."</span>,</td></tr>
<tr class="codeline" data-linenumber="3287"><td class="num" id="LN3287">3287</td><td class="line">                (<span class='keyword'>int</span>) server.repl_backlog_time_limit);</td></tr>
<tr class="codeline" data-linenumber="3288"><td class="num" id="LN3288">3288</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3289"><td class="num" id="LN3289">3289</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3290"><td class="num" id="LN3290">3290</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3291"><td class="num" id="LN3291">3291</td><td class="line">    <span class='comment'>/* If AOF is disabled and we no longer have attached slaves, we can</span></td></tr>
<tr class="codeline" data-linenumber="3292"><td class="num" id="LN3292">3292</td><td class="line">     <span class='comment'>* free our Replication Script Cache as there is no need to propagate</span></td></tr>
<tr class="codeline" data-linenumber="3293"><td class="num" id="LN3293">3293</td><td class="line">     <span class='comment'>* EVALSHA at all. */</span></td></tr>
<tr class="codeline" data-linenumber="3294"><td class="num" id="LN3294">3294</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>listLength(server.slaves)<span class='macro_popup'>((server.slaves)-&gt;len)</span></span> == 0 &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3295"><td class="num" id="LN3295">3295</td><td class="line">        server.aof_state == <span class='macro'>AOF_OFF<span class='macro_popup'>0</span></span> &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3296"><td class="num" id="LN3296">3296</td><td class="line">        <span class='macro'>listLength(server.repl_scriptcache_fifo)<span class='macro_popup'>((server.repl_scriptcache_fifo)-&gt;len)</span></span> != 0)</td></tr>
<tr class="codeline" data-linenumber="3297"><td class="num" id="LN3297">3297</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="3298"><td class="num" id="LN3298">3298</td><td class="line">        replicationScriptCacheFlush();</td></tr>
<tr class="codeline" data-linenumber="3299"><td class="num" id="LN3299">3299</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3300"><td class="num" id="LN3300">3300</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3301"><td class="num" id="LN3301">3301</td><td class="line">    <span class='comment'>/* Start a BGSAVE good for replication if we have slaves in</span></td></tr>
<tr class="codeline" data-linenumber="3302"><td class="num" id="LN3302">3302</td><td class="line">     <span class='comment'>* WAIT_BGSAVE_START state.</span></td></tr>
<tr class="codeline" data-linenumber="3303"><td class="num" id="LN3303">3303</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="3304"><td class="num" id="LN3304">3304</td><td class="line">     <span class='comment'>* In case of diskless replication, we make sure to wait the specified</span></td></tr>
<tr class="codeline" data-linenumber="3305"><td class="num" id="LN3305">3305</td><td class="line">     <span class='comment'>* number of seconds (according to configuration) so that other slaves</span></td></tr>
<tr class="codeline" data-linenumber="3306"><td class="num" id="LN3306">3306</td><td class="line">     <span class='comment'>* have the time to arrive before we start streaming. */</span></td></tr>
<tr class="codeline" data-linenumber="3307"><td class="num" id="LN3307">3307</td><td class="line">    <span class='keyword'>if</span> (!hasActiveChildProcess()) {</td></tr>
<tr class="codeline" data-linenumber="3308"><td class="num" id="LN3308">3308</td><td class="line">        time_t idle, max_idle = 0;</td></tr>
<tr class="codeline" data-linenumber="3309"><td class="num" id="LN3309">3309</td><td class="line">        <span class='keyword'>int</span> slaves_waiting = 0;</td></tr>
<tr class="codeline" data-linenumber="3310"><td class="num" id="LN3310">3310</td><td class="line">        <span class='keyword'>int</span> mincapa = -1;</td></tr>
<tr class="codeline" data-linenumber="3311"><td class="num" id="LN3311">3311</td><td class="line">        listNode *ln;</td></tr>
<tr class="codeline" data-linenumber="3312"><td class="num" id="LN3312">3312</td><td class="line">        listIter li;</td></tr>
<tr class="codeline" data-linenumber="3313"><td class="num" id="LN3313">3313</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3314"><td class="num" id="LN3314">3314</td><td class="line">        listRewind(server.slaves,&amp;li);</td></tr>
<tr class="codeline" data-linenumber="3315"><td class="num" id="LN3315">3315</td><td class="line">        <span class='keyword'>while</span>((ln = listNext(&amp;li))) {</td></tr>
<tr class="codeline" data-linenumber="3316"><td class="num" id="LN3316">3316</td><td class="line">            client *slave = ln-&gt;value;</td></tr>
<tr class="codeline" data-linenumber="3317"><td class="num" id="LN3317">3317</td><td class="line">            <span class='keyword'>if</span> (slave-&gt;replstate == <span class='macro'>SLAVE_STATE_WAIT_BGSAVE_START<span class='macro_popup'>6</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="3318"><td class="num" id="LN3318">3318</td><td class="line">                idle = server.unixtime - slave-&gt;lastinteraction;</td></tr>
<tr class="codeline" data-linenumber="3319"><td class="num" id="LN3319">3319</td><td class="line">                <span class='keyword'>if</span> (idle &gt; max_idle) max_idle = idle;</td></tr>
<tr class="codeline" data-linenumber="3320"><td class="num" id="LN3320">3320</td><td class="line">                slaves_waiting++;</td></tr>
<tr class="codeline" data-linenumber="3321"><td class="num" id="LN3321">3321</td><td class="line">                mincapa = (mincapa == -1) ? slave-&gt;slave_capa :</td></tr>
<tr class="codeline" data-linenumber="3322"><td class="num" id="LN3322">3322</td><td class="line">                                            (mincapa &amp; slave-&gt;slave_capa);</td></tr>
<tr class="codeline" data-linenumber="3323"><td class="num" id="LN3323">3323</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="3324"><td class="num" id="LN3324">3324</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3325"><td class="num" id="LN3325">3325</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3326"><td class="num" id="LN3326">3326</td><td class="line">        <span class='keyword'>if</span> (slaves_waiting &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="3327"><td class="num" id="LN3327">3327</td><td class="line">            (!server.repl_diskless_sync ||</td></tr>
<tr class="codeline" data-linenumber="3328"><td class="num" id="LN3328">3328</td><td class="line">             max_idle &gt; server.repl_diskless_sync_delay))</td></tr>
<tr class="codeline" data-linenumber="3329"><td class="num" id="LN3329">3329</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="3330"><td class="num" id="LN3330">3330</td><td class="line">            <span class='comment'>/* Start the BGSAVE. The called function may start a</span></td></tr>
<tr class="codeline" data-linenumber="3331"><td class="num" id="LN3331">3331</td><td class="line">             <span class='comment'>* BGSAVE with socket target or disk target depending on the</span></td></tr>
<tr class="codeline" data-linenumber="3332"><td class="num" id="LN3332">3332</td><td class="line">             <span class='comment'>* configuration and slaves capabilities. */</span></td></tr>
<tr class="codeline" data-linenumber="3333"><td class="num" id="LN3333">3333</td><td class="line">            startBgsaveForReplication(mincapa);</td></tr>
<tr class="codeline" data-linenumber="3334"><td class="num" id="LN3334">3334</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="3335"><td class="num" id="LN3335">3335</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="3336"><td class="num" id="LN3336">3336</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3337"><td class="num" id="LN3337">3337</td><td class="line">    <span class='comment'>/* Remove the RDB file used for replication if Redis is not running</span></td></tr>
<tr class="codeline" data-linenumber="3338"><td class="num" id="LN3338">3338</td><td class="line">     <span class='comment'>* with any persistence. */</span></td></tr>
<tr class="codeline" data-linenumber="3339"><td class="num" id="LN3339">3339</td><td class="line">    removeRDBUsedToSyncReplicas();</td></tr>
<tr class="codeline" data-linenumber="3340"><td class="num" id="LN3340">3340</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="3341"><td class="num" id="LN3341">3341</td><td class="line">    <span class='comment'>/* Refresh the number of slaves with lag &lt;= min-slaves-max-lag. */</span></td></tr>
<tr class="codeline" data-linenumber="3342"><td class="num" id="LN3342">3342</td><td class="line">    refreshGoodSlavesCount();</td></tr>
<tr class="codeline" data-linenumber="3343"><td class="num" id="LN3343">3343</td><td class="line">    replication_cron_loops++; <span class='comment'>/* Incremented with frequency 1 HZ. */</span></td></tr>
<tr class="codeline" data-linenumber="3344"><td class="num" id="LN3344">3344</td><td class="line">}</td></tr>
</table></body></html>
