<!doctype html>
<html>
<head>
<title>geo.c</title>

<style type="text/css">
body { color:#000000; background-color:#ffffff }
body { font-family:Helvetica, sans-serif; font-size:10pt }
h1 { font-size:14pt }
.FileName { margin-top: 5px; margin-bottom: 5px; display: inline; }
.FileNav { margin-left: 5px; margin-right: 5px; display: inline; }
.FileNav a { text-decoration:none; font-size: larger; }
.divider { margin-top: 30px; margin-bottom: 30px; height: 15px; }
.divider { background-color: gray; }
.code { border-collapse:collapse; width:100%; }
.code { font-family: "Monospace", monospace; font-size:10pt }
.code { line-height: 1.2em }
.comment { color: green; font-style: oblique }
.keyword { color: blue }
.string_literal { color: red }
.directive { color: darkmagenta }

/* Macros and variables could have pop-up notes hidden by default.
  - Macro pop-up:    expansion of the macro
  - Variable pop-up: value (table) of the variable */
.macro_popup, .variable_popup { display: none; }

/* Pop-up appears on mouse-hover event. */
.macro:hover .macro_popup, .variable:hover .variable_popup {
  display: block;
  padding: 2px;
  -webkit-border-radius:5px;
  -webkit-box-shadow:1px 1px 7px #000;
  border-radius:5px;
  box-shadow:1px 1px 7px #000;
  position: absolute;
  top: -1em;
  left:10em;
  z-index: 1
}

.macro_popup {
  border: 2px solid red;
  background-color:#FFF0F0;
  font-weight: normal;
}

.variable_popup {
  border: 2px solid blue;
  background-color:#F0F0FF;
  font-weight: bold;
  font-family: Helvetica, sans-serif;
  font-size: 9pt;
}

/* Pop-up notes needs a relative position as a base where they pops up. */
.macro, .variable {
  background-color: PaleGoldenRod;
  position: relative;
}
.macro { color: DarkMagenta; }

#tooltiphint {
  position: fixed;
  width: 50em;
  margin-left: -25em;
  left: 50%;
  padding: 10px;
  border: 1px solid #b0b0b0;
  border-radius: 2px;
  box-shadow: 1px 1px 7px black;
  background-color: #c0c0c0;
  z-index: 2;
}

.num { width:2.5em; padding-right:2ex; background-color:#eeeeee }
.num { text-align:right; font-size:8pt }
.num { color:#444444 }
.line { padding-left: 1ex; border-left: 3px solid #ccc }
.line { white-space: pre }
.msg { -webkit-box-shadow:1px 1px 7px #000 }
.msg { box-shadow:1px 1px 7px #000 }
.msg { -webkit-border-radius:5px }
.msg { border-radius:5px }
.msg { font-family:Helvetica, sans-serif; font-size:8pt }
.msg { float:left }
.msg { padding:0.25em 1ex 0.25em 1ex }
.msg { margin-top:10px; margin-bottom:10px }
.msg { font-weight:bold }
.msg { max-width:60em; word-wrap: break-word; white-space: pre-wrap }
.msgT { padding:0x; spacing:0x }
.msgEvent { background-color:#fff8b4; color:#000000 }
.msgControl { background-color:#bbbbbb; color:#000000 }
.msgNote { background-color:#ddeeff; color:#000000 }
.mrange { background-color:#dfddf3 }
.mrange { border-bottom:1px solid #6F9DBE }
.PathIndex { font-weight: bold; padding:0px 5px; margin-right:5px; }
.PathIndex { -webkit-border-radius:8px }
.PathIndex { border-radius:8px }
.PathIndexEvent { background-color:#bfba87 }
.PathIndexControl { background-color:#8c8c8c }
.PathIndexPopUp { background-color: #879abc; }
.PathNav a { text-decoration:none; font-size: larger }
.CodeInsertionHint { font-weight: bold; background-color: #10dd10 }
.CodeRemovalHint { background-color:#de1010 }
.CodeRemovalHint { border-bottom:1px solid #6F9DBE }
.selected{ background-color:orange !important; }

table.simpletable {
  padding: 5px;
  font-size:12pt;
  margin:20px;
  border-collapse: collapse; border-spacing: 0px;
}
td.rowname {
  text-align: right;
  vertical-align: top;
  font-weight: bold;
  color:#444444;
  padding-right:2ex;
}

/* Hidden text. */
input.spoilerhider + label {
  cursor: pointer;
  text-decoration: underline;
  display: block;
}
input.spoilerhider {
 display: none;
}
input.spoilerhider ~ .spoiler {
  overflow: hidden;
  margin: 10px auto 0;
  height: 0;
  opacity: 0;
}
input.spoilerhider:checked + label + .spoiler{
  height: auto;
  opacity: 1;
}
</style>
</head>
<body>
<!-- BUGDESC Call to function 'snprintf' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'snprintf_s' in case of C11 -->

<!-- BUGTYPE Potential insecure memory buffer bounds restriction in call 'snprintf' -->

<!-- BUGCATEGORY Security -->

<!-- BUGFILE /tmp/sslab_clang/c_redis/redis/src/geo.c -->

<!-- FILENAME geo.c -->

<!-- FUNCTIONNAME addReplyDoubleDistance -->

<!-- ISSUEHASHCONTENTOFLINEINCONTEXT ba9dfef155cf631f49254ea93b5c3c38 -->

<!-- BUGLINE 181 -->

<!-- BUGCOLUMN 16 -->

<!-- BUGPATHLENGTH 1 -->

<!-- BUGMETAEND -->
<!-- REPORTHEADER -->
<h3>Bug Summary</h3>
<table class="simpletable">
<tr><td class="rowname">File:</td><td>src/geo.c</td></tr>
<tr><td class="rowname">Warning:</td><td><a href="#EndPath">line 181, column 16</a><br />Call to function 'snprintf' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'snprintf_s' in case of C11</td></tr>

</table>
<!-- REPORTSUMMARYEXTRA -->
<h3>Annotated Source Code</h3>
<p>Press <a href="#" onclick="toggleHelp(); return false;">'?'</a>
   to see keyboard shortcuts</p>
<input type="checkbox" class="spoilerhider" id="showinvocation" />
<label for="showinvocation" >Show analyzer invocation</label>
<div class="spoiler">clang -cc1 -cc1 -triple x86_64-unknown-linux-gnu -analyze -disable-free -main-file-name geo.c -analyzer-store=region -analyzer-opt-analyze-nested-blocks -analyzer-checker=core -analyzer-checker=apiModeling -analyzer-checker=unix -analyzer-checker=deadcode -analyzer-checker=security.insecureAPI.UncheckedReturn -analyzer-checker=security.insecureAPI.getpw -analyzer-checker=security.insecureAPI.gets -analyzer-checker=security.insecureAPI.mktemp -analyzer-checker=security.insecureAPI.mkstemp -analyzer-checker=security.insecureAPI.vfork -analyzer-checker=nullability.NullPassedToNonnull -analyzer-checker=nullability.NullReturnedFromNonnull -analyzer-output plist -w -setup-static-analyzer -mrelocation-model static -mframe-pointer=none -fmath-errno -fno-rounding-math -mconstructor-aliases -munwind-tables -target-cpu x86-64 -fno-split-dwarf-inlining -debugger-tuning=gdb -resource-dir /llvm-project/build/lib/clang/12.0.0 -D REDIS_STATIC= -I ../deps/hiredis -I ../deps/linenoise -I ../deps/lua/src -D USE_JEMALLOC -I ../deps/jemalloc/include -internal-isystem /usr/local/include -internal-isystem /llvm-project/build/lib/clang/12.0.0/include -internal-externc-isystem /usr/include/x86_64-linux-gnu -internal-externc-isystem /include -internal-externc-isystem /usr/include -O2 -Wno-missing-field-initializers -std=c11 -fdebug-compilation-dir /tmp/sslab_clang/c_redis/redis/src -ferror-limit 19 -fgnuc-version=4.2.1 -vectorize-loops -vectorize-slp -analyzer-checker core -analyzer-checker cplusplus -analyzer-checker nullability -analyzer-checker optin -analyzer-checker security -analyzer-checker unix -analyzer-checker osx -analyzer-checker fuchsia -analyzer-checker webkit -analyzer-output=html -faddrsig -o /tmp/scan-build-2020-11-24-134337-37-1 -x c geo.c
</div>
<div id='tooltiphint' hidden="true">
  <p>Keyboard shortcuts: </p>
  <ul>
    <li>Use 'j/k' keys for keyboard navigation</li>
    <li>Use 'Shift+S' to show/hide relevant lines</li>
    <li>Use '?' to toggle this window</li>
  </ul>
  <a href="#" onclick="toggleHelp(); return false;">Close</a>
</div>
<script type='text/javascript'>
var relevant_lines = {"1": {"181": 1}};

var filterCounterexample = function (hide) {
  var tables = document.getElementsByClassName("code");
  for (var t=0; t<tables.length; t++) {
    var table = tables[t];
    var file_id = table.getAttribute("data-fileid");
    var lines_in_fid = relevant_lines[file_id];
    if (!lines_in_fid) {
      lines_in_fid = {};
    }
    var lines = table.getElementsByClassName("codeline");
    for (var i=0; i<lines.length; i++) {
        var el = lines[i];
        var lineNo = el.getAttribute("data-linenumber");
        if (!lines_in_fid[lineNo]) {
          if (hide) {
            el.setAttribute("hidden", "");
          } else {
            el.removeAttribute("hidden");
          }
        }
    }
  }
}

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "S") {
    var checked = document.getElementsByName("showCounterexample")[0].checked;
    filterCounterexample(!checked);
    document.getElementsByName("showCounterexample")[0].checked = !checked;
  } else {
    return;
  }
  event.preventDefault();
}, true);

document.addEventListener("DOMContentLoaded", function() {
    document.querySelector('input[name="showCounterexample"]').onchange=
        function (event) {
      filterCounterexample(this.checked);
    };
});
</script>

<form>
    <input type="checkbox" name="showCounterexample" id="showCounterexample" />
    <label for="showCounterexample">
       Show only relevant lines
    </label>
</form>

<script type='text/javascript'>
var digitMatcher = new RegExp("[0-9]+");

var querySelectorAllArray = function(selector) {
  return Array.prototype.slice.call(
    document.querySelectorAll(selector));
}

document.addEventListener("DOMContentLoaded", function() {
    querySelectorAllArray(".PathNav > a").forEach(
        function(currentValue, currentIndex) {
            var hrefValue = currentValue.getAttribute("href");
            currentValue.onclick = function() {
                scrollTo(document.querySelector(hrefValue));
                return false;
            };
        });
});

var findNum = function() {
    var s = document.querySelector(".selected");
    if (!s || s.id == "EndPath") {
        return 0;
    }
    var out = parseInt(digitMatcher.exec(s.id)[0]);
    return out;
};

var scrollTo = function(el) {
    querySelectorAllArray(".selected").forEach(function(s) {
        s.classList.remove("selected");
    });
    el.classList.add("selected");
    window.scrollBy(0, el.getBoundingClientRect().top -
        (window.innerHeight / 2));
}

var move = function(num, up, numItems) {
  if (num == 1 && up || num == numItems - 1 && !up) {
    return 0;
  } else if (num == 0 && up) {
    return numItems - 1;
  } else if (num == 0 && !up) {
    return 1 % numItems;
  }
  return up ? num - 1 : num + 1;
}

var numToId = function(num) {
  if (num == 0) {
    return document.getElementById("EndPath")
  }
  return document.getElementById("Path" + num);
};

var navigateTo = function(up) {
  var numItems = document.querySelectorAll(
      ".line > .msgEvent, .line > .msgControl").length;
  var currentSelected = findNum();
  var newSelected = move(currentSelected, up, numItems);
  var newEl = numToId(newSelected, numItems);

  // Scroll element into center.
  scrollTo(newEl);
};

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "j") {
    navigateTo(/*up=*/false);
  } else if (event.key == "k") {
    navigateTo(/*up=*/true);
  } else {
    return;
  }
  event.preventDefault();
}, true);
</script>
  
<script type='text/javascript'>

var toggleHelp = function() {
    var hint = document.querySelector("#tooltiphint");
    var attributeName = "hidden";
    if (hint.hasAttribute(attributeName)) {
      hint.removeAttribute(attributeName);
    } else {
      hint.setAttribute("hidden", "true");
    }
};
window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "?") {
    toggleHelp();
  } else {
    return;
  }
  event.preventDefault();
});
</script>
<table class="code" data-fileid="1">
<tr class="codeline" data-linenumber="1"><td class="num" id="LN1">1</td><td class="line"><span class='comment'>/*</span></td></tr>
<tr class="codeline" data-linenumber="2"><td class="num" id="LN2">2</td><td class="line"> <span class='comment'>* Copyright (c) 2014, Matt Stancliff &lt;matt@genges.com&gt;.</span></td></tr>
<tr class="codeline" data-linenumber="3"><td class="num" id="LN3">3</td><td class="line"> <span class='comment'>* Copyright (c) 2015-2016, Salvatore Sanfilippo &lt;antirez@gmail.com&gt;.</span></td></tr>
<tr class="codeline" data-linenumber="4"><td class="num" id="LN4">4</td><td class="line"> <span class='comment'>* All rights reserved.</span></td></tr>
<tr class="codeline" data-linenumber="5"><td class="num" id="LN5">5</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="6"><td class="num" id="LN6">6</td><td class="line"> <span class='comment'>* Redistribution and use in source and binary forms, with or without</span></td></tr>
<tr class="codeline" data-linenumber="7"><td class="num" id="LN7">7</td><td class="line"> <span class='comment'>* modification, are permitted provided that the following conditions are met:</span></td></tr>
<tr class="codeline" data-linenumber="8"><td class="num" id="LN8">8</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="9"><td class="num" id="LN9">9</td><td class="line"> <span class='comment'>*   * Redistributions of source code must retain the above copyright notice,</span></td></tr>
<tr class="codeline" data-linenumber="10"><td class="num" id="LN10">10</td><td class="line"> <span class='comment'>*     this list of conditions and the following disclaimer.</span></td></tr>
<tr class="codeline" data-linenumber="11"><td class="num" id="LN11">11</td><td class="line"> <span class='comment'>*   * Redistributions in binary form must reproduce the above copyright</span></td></tr>
<tr class="codeline" data-linenumber="12"><td class="num" id="LN12">12</td><td class="line"> <span class='comment'>*     notice, this list of conditions and the following disclaimer in the</span></td></tr>
<tr class="codeline" data-linenumber="13"><td class="num" id="LN13">13</td><td class="line"> <span class='comment'>*     documentation and/or other materials provided with the distribution.</span></td></tr>
<tr class="codeline" data-linenumber="14"><td class="num" id="LN14">14</td><td class="line"> <span class='comment'>*   * Neither the name of Redis nor the names of its contributors may be used</span></td></tr>
<tr class="codeline" data-linenumber="15"><td class="num" id="LN15">15</td><td class="line"> <span class='comment'>*     to endorse or promote products derived from this software without</span></td></tr>
<tr class="codeline" data-linenumber="16"><td class="num" id="LN16">16</td><td class="line"> <span class='comment'>*     specific prior written permission.</span></td></tr>
<tr class="codeline" data-linenumber="17"><td class="num" id="LN17">17</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="18"><td class="num" id="LN18">18</td><td class="line"> <span class='comment'>* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"</span></td></tr>
<tr class="codeline" data-linenumber="19"><td class="num" id="LN19">19</td><td class="line"> <span class='comment'>* AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span></td></tr>
<tr class="codeline" data-linenumber="20"><td class="num" id="LN20">20</td><td class="line"> <span class='comment'>* IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span></td></tr>
<tr class="codeline" data-linenumber="21"><td class="num" id="LN21">21</td><td class="line"> <span class='comment'>* ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span></td></tr>
<tr class="codeline" data-linenumber="22"><td class="num" id="LN22">22</td><td class="line"> <span class='comment'>* LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span></td></tr>
<tr class="codeline" data-linenumber="23"><td class="num" id="LN23">23</td><td class="line"> <span class='comment'>* CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span></td></tr>
<tr class="codeline" data-linenumber="24"><td class="num" id="LN24">24</td><td class="line"> <span class='comment'>* SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span></td></tr>
<tr class="codeline" data-linenumber="25"><td class="num" id="LN25">25</td><td class="line"> <span class='comment'>* INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span></td></tr>
<tr class="codeline" data-linenumber="26"><td class="num" id="LN26">26</td><td class="line"> <span class='comment'>* CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span></td></tr>
<tr class="codeline" data-linenumber="27"><td class="num" id="LN27">27</td><td class="line"> <span class='comment'>* ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span></td></tr>
<tr class="codeline" data-linenumber="28"><td class="num" id="LN28">28</td><td class="line"> <span class='comment'>* POSSIBILITY OF SUCH DAMAGE.</span></td></tr>
<tr class="codeline" data-linenumber="29"><td class="num" id="LN29">29</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="30"><td class="num" id="LN30">30</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="31"><td class="num" id="LN31">31</td><td class="line"><span class='directive'>#include "geo.h"</span></td></tr>
<tr class="codeline" data-linenumber="32"><td class="num" id="LN32">32</td><td class="line"><span class='directive'>#include "geohash_helper.h"</span></td></tr>
<tr class="codeline" data-linenumber="33"><td class="num" id="LN33">33</td><td class="line"><span class='directive'>#include "debugmacro.h"</span></td></tr>
<tr class="codeline" data-linenumber="34"><td class="num" id="LN34">34</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="35"><td class="num" id="LN35">35</td><td class="line"><span class='comment'>/* Things exported from t_zset.c only for geo.c, since it is the only other</span></td></tr>
<tr class="codeline" data-linenumber="36"><td class="num" id="LN36">36</td><td class="line"> <span class='comment'>* part of Redis that requires close zset introspection. */</span></td></tr>
<tr class="codeline" data-linenumber="37"><td class="num" id="LN37">37</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zzlFirstInRange(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl, zrangespec *range);</td></tr>
<tr class="codeline" data-linenumber="38"><td class="num" id="LN38">38</td><td class="line"><span class='keyword'>int</span> zslValueLteMax(<span class='keyword'>double</span> value, zrangespec *spec);</td></tr>
<tr class="codeline" data-linenumber="39"><td class="num" id="LN39">39</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="40"><td class="num" id="LN40">40</td><td class="line"><span class='comment'>/* ====================================================================</span></td></tr>
<tr class="codeline" data-linenumber="41"><td class="num" id="LN41">41</td><td class="line"> <span class='comment'>* This file implements the following commands:</span></td></tr>
<tr class="codeline" data-linenumber="42"><td class="num" id="LN42">42</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="43"><td class="num" id="LN43">43</td><td class="line"> <span class='comment'>*   - geoadd - add coordinates for value to geoset</span></td></tr>
<tr class="codeline" data-linenumber="44"><td class="num" id="LN44">44</td><td class="line"> <span class='comment'>*   - georadius - search radius by coordinates in geoset</span></td></tr>
<tr class="codeline" data-linenumber="45"><td class="num" id="LN45">45</td><td class="line"> <span class='comment'>*   - georadiusbymember - search radius based on geoset member position</span></td></tr>
<tr class="codeline" data-linenumber="46"><td class="num" id="LN46">46</td><td class="line"> <span class='comment'>* ==================================================================== */</span></td></tr>
<tr class="codeline" data-linenumber="47"><td class="num" id="LN47">47</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="48"><td class="num" id="LN48">48</td><td class="line"><span class='comment'>/* ====================================================================</span></td></tr>
<tr class="codeline" data-linenumber="49"><td class="num" id="LN49">49</td><td class="line"> <span class='comment'>* geoArray implementation</span></td></tr>
<tr class="codeline" data-linenumber="50"><td class="num" id="LN50">50</td><td class="line"> <span class='comment'>* ==================================================================== */</span></td></tr>
<tr class="codeline" data-linenumber="51"><td class="num" id="LN51">51</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="52"><td class="num" id="LN52">52</td><td class="line"><span class='comment'>/* Create a new array of geoPoints. */</span></td></tr>
<tr class="codeline" data-linenumber="53"><td class="num" id="LN53">53</td><td class="line">geoArray *geoArrayCreate(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="54"><td class="num" id="LN54">54</td><td class="line">    geoArray *ga = zmalloc(<span class='keyword'>sizeof</span>(*ga));</td></tr>
<tr class="codeline" data-linenumber="55"><td class="num" id="LN55">55</td><td class="line">    <span class='comment'>/* It gets allocated on first geoArrayAppend() call. */</span></td></tr>
<tr class="codeline" data-linenumber="56"><td class="num" id="LN56">56</td><td class="line">    ga-&gt;array = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="57"><td class="num" id="LN57">57</td><td class="line">    ga-&gt;buckets = 0;</td></tr>
<tr class="codeline" data-linenumber="58"><td class="num" id="LN58">58</td><td class="line">    ga-&gt;used = 0;</td></tr>
<tr class="codeline" data-linenumber="59"><td class="num" id="LN59">59</td><td class="line">    <span class='keyword'>return</span> ga;</td></tr>
<tr class="codeline" data-linenumber="60"><td class="num" id="LN60">60</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="61"><td class="num" id="LN61">61</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="62"><td class="num" id="LN62">62</td><td class="line"><span class='comment'>/* Add a new entry and return its pointer so that the caller can populate</span></td></tr>
<tr class="codeline" data-linenumber="63"><td class="num" id="LN63">63</td><td class="line"> <span class='comment'>* it with data. */</span></td></tr>
<tr class="codeline" data-linenumber="64"><td class="num" id="LN64">64</td><td class="line">geoPoint *geoArrayAppend(geoArray *ga) {</td></tr>
<tr class="codeline" data-linenumber="65"><td class="num" id="LN65">65</td><td class="line">    <span class='keyword'>if</span> (ga-&gt;used == ga-&gt;buckets) {</td></tr>
<tr class="codeline" data-linenumber="66"><td class="num" id="LN66">66</td><td class="line">        ga-&gt;buckets = (ga-&gt;buckets == 0) ? 8 : ga-&gt;buckets*2;</td></tr>
<tr class="codeline" data-linenumber="67"><td class="num" id="LN67">67</td><td class="line">        ga-&gt;array = zrealloc(ga-&gt;array,<span class='keyword'>sizeof</span>(geoPoint)*ga-&gt;buckets);</td></tr>
<tr class="codeline" data-linenumber="68"><td class="num" id="LN68">68</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="69"><td class="num" id="LN69">69</td><td class="line">    geoPoint *gp = ga-&gt;array+ga-&gt;used;</td></tr>
<tr class="codeline" data-linenumber="70"><td class="num" id="LN70">70</td><td class="line">    ga-&gt;used++;</td></tr>
<tr class="codeline" data-linenumber="71"><td class="num" id="LN71">71</td><td class="line">    <span class='keyword'>return</span> gp;</td></tr>
<tr class="codeline" data-linenumber="72"><td class="num" id="LN72">72</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="73"><td class="num" id="LN73">73</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="74"><td class="num" id="LN74">74</td><td class="line"><span class='comment'>/* Destroy a geoArray created with geoArrayCreate(). */</span></td></tr>
<tr class="codeline" data-linenumber="75"><td class="num" id="LN75">75</td><td class="line"><span class='keyword'>void</span> geoArrayFree(geoArray *ga) {</td></tr>
<tr class="codeline" data-linenumber="76"><td class="num" id="LN76">76</td><td class="line">    size_t i;</td></tr>
<tr class="codeline" data-linenumber="77"><td class="num" id="LN77">77</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; ga-&gt;used; i++) sdsfree(ga-&gt;array[i].member);</td></tr>
<tr class="codeline" data-linenumber="78"><td class="num" id="LN78">78</td><td class="line">    zfree(ga-&gt;array);</td></tr>
<tr class="codeline" data-linenumber="79"><td class="num" id="LN79">79</td><td class="line">    zfree(ga);</td></tr>
<tr class="codeline" data-linenumber="80"><td class="num" id="LN80">80</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="81"><td class="num" id="LN81">81</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="82"><td class="num" id="LN82">82</td><td class="line"><span class='comment'>/* ====================================================================</span></td></tr>
<tr class="codeline" data-linenumber="83"><td class="num" id="LN83">83</td><td class="line"> <span class='comment'>* Helpers</span></td></tr>
<tr class="codeline" data-linenumber="84"><td class="num" id="LN84">84</td><td class="line"> <span class='comment'>* ==================================================================== */</span></td></tr>
<tr class="codeline" data-linenumber="85"><td class="num" id="LN85">85</td><td class="line"><span class='keyword'>int</span> decodeGeohash(<span class='keyword'>double</span> bits, <span class='keyword'>double</span> *xy) {</td></tr>
<tr class="codeline" data-linenumber="86"><td class="num" id="LN86">86</td><td class="line">    GeoHashBits hash = { .bits = (uint64_t)bits, .step = <span class='macro'>GEO_STEP_MAX<span class='macro_popup'>26</span></span> };</td></tr>
<tr class="codeline" data-linenumber="87"><td class="num" id="LN87">87</td><td class="line">    <span class='keyword'>return</span> geohashDecodeToLongLatWGS84(hash, xy);</td></tr>
<tr class="codeline" data-linenumber="88"><td class="num" id="LN88">88</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="89"><td class="num" id="LN89">89</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="90"><td class="num" id="LN90">90</td><td class="line"><span class='comment'>/* Input Argument Helper */</span></td></tr>
<tr class="codeline" data-linenumber="91"><td class="num" id="LN91">91</td><td class="line"><span class='comment'>/* Take a pointer to the latitude arg then use the next arg for longitude.</span></td></tr>
<tr class="codeline" data-linenumber="92"><td class="num" id="LN92">92</td><td class="line"> <span class='comment'>* On parse error C_ERR is returned, otherwise C_OK. */</span></td></tr>
<tr class="codeline" data-linenumber="93"><td class="num" id="LN93">93</td><td class="line"><span class='keyword'>int</span> extractLongLatOrReply(client *c, robj **argv, <span class='keyword'>double</span> *xy) {</td></tr>
<tr class="codeline" data-linenumber="94"><td class="num" id="LN94">94</td><td class="line">    <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="95"><td class="num" id="LN95">95</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; 2; i++) {</td></tr>
<tr class="codeline" data-linenumber="96"><td class="num" id="LN96">96</td><td class="line">        <span class='keyword'>if</span> (getDoubleFromObjectOrReply(c, argv[i], xy + i, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) !=</td></tr>
<tr class="codeline" data-linenumber="97"><td class="num" id="LN97">97</td><td class="line">            <span class='macro'>C_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="98"><td class="num" id="LN98">98</td><td class="line">            <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="99"><td class="num" id="LN99">99</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="100"><td class="num" id="LN100">100</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="101"><td class="num" id="LN101">101</td><td class="line">    <span class='keyword'>if</span> (xy[0] &lt; <span class='macro'>GEO_LONG_MIN<span class='macro_popup'>-180</span></span> || xy[0] &gt; <span class='macro'>GEO_LONG_MAX<span class='macro_popup'>180</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="102"><td class="num" id="LN102">102</td><td class="line">        xy[1] &lt; <span class='macro'>GEO_LAT_MIN<span class='macro_popup'>-85.05112878</span></span>  || xy[1] &gt; <span class='macro'>GEO_LAT_MAX<span class='macro_popup'>85.05112878</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="103"><td class="num" id="LN103">103</td><td class="line">        addReplySds(c, sdscatprintf(sdsempty(),</td></tr>
<tr class="codeline" data-linenumber="104"><td class="num" id="LN104">104</td><td class="line">            <span class='string_literal'>"-ERR invalid longitude,latitude pair %f,%f\r\n"</span>,xy[0],xy[1]));</td></tr>
<tr class="codeline" data-linenumber="105"><td class="num" id="LN105">105</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="106"><td class="num" id="LN106">106</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="107"><td class="num" id="LN107">107</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="108"><td class="num" id="LN108">108</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="109"><td class="num" id="LN109">109</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="110"><td class="num" id="LN110">110</td><td class="line"><span class='comment'>/* Input Argument Helper */</span></td></tr>
<tr class="codeline" data-linenumber="111"><td class="num" id="LN111">111</td><td class="line"><span class='comment'>/* Decode lat/long from a zset member's score.</span></td></tr>
<tr class="codeline" data-linenumber="112"><td class="num" id="LN112">112</td><td class="line"> <span class='comment'>* Returns C_OK on successful decoding, otherwise C_ERR is returned. */</span></td></tr>
<tr class="codeline" data-linenumber="113"><td class="num" id="LN113">113</td><td class="line"><span class='keyword'>int</span> longLatFromMember(robj *zobj, robj *member, <span class='keyword'>double</span> *xy) {</td></tr>
<tr class="codeline" data-linenumber="114"><td class="num" id="LN114">114</td><td class="line">    <span class='keyword'>double</span> score = 0;</td></tr>
<tr class="codeline" data-linenumber="115"><td class="num" id="LN115">115</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="116"><td class="num" id="LN116">116</td><td class="line">    <span class='keyword'>if</span> (zsetScore(zobj, member-&gt;ptr, &amp;score) == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>) <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="117"><td class="num" id="LN117">117</td><td class="line">    <span class='keyword'>if</span> (!decodeGeohash(score, xy)) <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="118"><td class="num" id="LN118">118</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="119"><td class="num" id="LN119">119</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="120"><td class="num" id="LN120">120</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="121"><td class="num" id="LN121">121</td><td class="line"><span class='comment'>/* Check that the unit argument matches one of the known units, and returns</span></td></tr>
<tr class="codeline" data-linenumber="122"><td class="num" id="LN122">122</td><td class="line"> <span class='comment'>* the conversion factor to meters (you need to divide meters by the conversion</span></td></tr>
<tr class="codeline" data-linenumber="123"><td class="num" id="LN123">123</td><td class="line"> <span class='comment'>* factor to convert to the right unit).</span></td></tr>
<tr class="codeline" data-linenumber="124"><td class="num" id="LN124">124</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="125"><td class="num" id="LN125">125</td><td class="line"> <span class='comment'>* If the unit is not valid, an error is reported to the client, and a value</span></td></tr>
<tr class="codeline" data-linenumber="126"><td class="num" id="LN126">126</td><td class="line"> <span class='comment'>* less than zero is returned. */</span></td></tr>
<tr class="codeline" data-linenumber="127"><td class="num" id="LN127">127</td><td class="line"><span class='keyword'>double</span> extractUnitOrReply(client *c, robj *unit) {</td></tr>
<tr class="codeline" data-linenumber="128"><td class="num" id="LN128">128</td><td class="line">    <span class='keyword'>char</span> *u = unit-&gt;ptr;</td></tr>
<tr class="codeline" data-linenumber="129"><td class="num" id="LN129">129</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="130"><td class="num" id="LN130">130</td><td class="line">    <span class='keyword'>if</span> (!strcmp(u, <span class='string_literal'>"m"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="131"><td class="num" id="LN131">131</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="132"><td class="num" id="LN132">132</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(u, <span class='string_literal'>"km"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="133"><td class="num" id="LN133">133</td><td class="line">        <span class='keyword'>return</span> 1000;</td></tr>
<tr class="codeline" data-linenumber="134"><td class="num" id="LN134">134</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(u, <span class='string_literal'>"ft"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="135"><td class="num" id="LN135">135</td><td class="line">        <span class='keyword'>return</span> 0.3048;</td></tr>
<tr class="codeline" data-linenumber="136"><td class="num" id="LN136">136</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcmp(u, <span class='string_literal'>"mi"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="137"><td class="num" id="LN137">137</td><td class="line">        <span class='keyword'>return</span> 1609.34;</td></tr>
<tr class="codeline" data-linenumber="138"><td class="num" id="LN138">138</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="139"><td class="num" id="LN139">139</td><td class="line">        addReplyError(c,</td></tr>
<tr class="codeline" data-linenumber="140"><td class="num" id="LN140">140</td><td class="line">            <span class='string_literal'>"unsupported unit provided. please use m, km, ft, mi"</span>);</td></tr>
<tr class="codeline" data-linenumber="141"><td class="num" id="LN141">141</td><td class="line">        <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="142"><td class="num" id="LN142">142</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="143"><td class="num" id="LN143">143</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="144"><td class="num" id="LN144">144</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="145"><td class="num" id="LN145">145</td><td class="line"><span class='comment'>/* Input Argument Helper.</span></td></tr>
<tr class="codeline" data-linenumber="146"><td class="num" id="LN146">146</td><td class="line"> <span class='comment'>* Extract the distance from the specified two arguments starting at 'argv'</span></td></tr>
<tr class="codeline" data-linenumber="147"><td class="num" id="LN147">147</td><td class="line"> <span class='comment'>* that should be in the form: &lt;number&gt; &lt;unit&gt;, and return the distance in the</span></td></tr>
<tr class="codeline" data-linenumber="148"><td class="num" id="LN148">148</td><td class="line"> <span class='comment'>* specified unit on success. *conversions is populated with the coefficient</span></td></tr>
<tr class="codeline" data-linenumber="149"><td class="num" id="LN149">149</td><td class="line"> <span class='comment'>* to use in order to convert meters to the unit.</span></td></tr>
<tr class="codeline" data-linenumber="150"><td class="num" id="LN150">150</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="151"><td class="num" id="LN151">151</td><td class="line"> <span class='comment'>* On error a value less than zero is returned. */</span></td></tr>
<tr class="codeline" data-linenumber="152"><td class="num" id="LN152">152</td><td class="line"><span class='keyword'>double</span> extractDistanceOrReply(client *c, robj **argv,</td></tr>
<tr class="codeline" data-linenumber="153"><td class="num" id="LN153">153</td><td class="line">                                     <span class='keyword'>double</span> *conversion) {</td></tr>
<tr class="codeline" data-linenumber="154"><td class="num" id="LN154">154</td><td class="line">    <span class='keyword'>double</span> distance;</td></tr>
<tr class="codeline" data-linenumber="155"><td class="num" id="LN155">155</td><td class="line">    <span class='keyword'>if</span> (getDoubleFromObjectOrReply(c, argv[0], &amp;distance,</td></tr>
<tr class="codeline" data-linenumber="156"><td class="num" id="LN156">156</td><td class="line">                                   <span class='string_literal'>"need numeric radius"</span>) != <span class='macro'>C_OK<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="157"><td class="num" id="LN157">157</td><td class="line">        <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="158"><td class="num" id="LN158">158</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="159"><td class="num" id="LN159">159</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="160"><td class="num" id="LN160">160</td><td class="line">    <span class='keyword'>if</span> (distance &lt; 0) {</td></tr>
<tr class="codeline" data-linenumber="161"><td class="num" id="LN161">161</td><td class="line">        addReplyError(c,<span class='string_literal'>"radius cannot be negative"</span>);</td></tr>
<tr class="codeline" data-linenumber="162"><td class="num" id="LN162">162</td><td class="line">        <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="163"><td class="num" id="LN163">163</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="164"><td class="num" id="LN164">164</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="165"><td class="num" id="LN165">165</td><td class="line">    <span class='keyword'>double</span> to_meters = extractUnitOrReply(c,argv[1]);</td></tr>
<tr class="codeline" data-linenumber="166"><td class="num" id="LN166">166</td><td class="line">    <span class='keyword'>if</span> (to_meters &lt; 0) {</td></tr>
<tr class="codeline" data-linenumber="167"><td class="num" id="LN167">167</td><td class="line">        <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="168"><td class="num" id="LN168">168</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="169"><td class="num" id="LN169">169</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="170"><td class="num" id="LN170">170</td><td class="line">    <span class='keyword'>if</span> (conversion) *conversion = to_meters;</td></tr>
<tr class="codeline" data-linenumber="171"><td class="num" id="LN171">171</td><td class="line">    <span class='keyword'>return</span> distance * to_meters;</td></tr>
<tr class="codeline" data-linenumber="172"><td class="num" id="LN172">172</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="173"><td class="num" id="LN173">173</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="174"><td class="num" id="LN174">174</td><td class="line"><span class='comment'>/* The default addReplyDouble has too much accuracy.  We use this</span></td></tr>
<tr class="codeline" data-linenumber="175"><td class="num" id="LN175">175</td><td class="line"> <span class='comment'>* for returning location distances. "5.2145 meters away" is nicer</span></td></tr>
<tr class="codeline" data-linenumber="176"><td class="num" id="LN176">176</td><td class="line"> <span class='comment'>* than "5.2144992818115 meters away." We provide 4 digits after the dot</span></td></tr>
<tr class="codeline" data-linenumber="177"><td class="num" id="LN177">177</td><td class="line"> <span class='comment'>* so that the returned value is decently accurate even when the unit is</span></td></tr>
<tr class="codeline" data-linenumber="178"><td class="num" id="LN178">178</td><td class="line"> <span class='comment'>* the kilometer. */</span></td></tr>
<tr class="codeline" data-linenumber="179"><td class="num" id="LN179">179</td><td class="line"><span class='keyword'>void</span> addReplyDoubleDistance(client *c, <span class='keyword'>double</span> d) {</td></tr>
<tr class="codeline" data-linenumber="180"><td class="num" id="LN180">180</td><td class="line">    <span class='keyword'>char</span> dbuf[128];</td></tr>
<tr class="codeline" data-linenumber="181"><td class="num" id="LN181">181</td><td class="line">    <span class='keyword'>int</span> dlen = <span class="mrange">snprintf</span>(dbuf, <span class='keyword'>sizeof</span>(dbuf), <span class='string_literal'>"%.4f"</span>, d);</td></tr>
<tr><td class="num"></td><td class="line"><div id="EndPath" class="msg msgEvent" style="margin-left:16ex; max-width:59em">Call to function 'snprintf' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'snprintf_s' in case of C11</div></td></tr>
<tr class="codeline" data-linenumber="182"><td class="num" id="LN182">182</td><td class="line">    addReplyBulkCBuffer(c, dbuf, dlen);</td></tr>
<tr class="codeline" data-linenumber="183"><td class="num" id="LN183">183</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="184"><td class="num" id="LN184">184</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="185"><td class="num" id="LN185">185</td><td class="line"><span class='comment'>/* Helper function for geoGetPointsInRange(): given a sorted set score</span></td></tr>
<tr class="codeline" data-linenumber="186"><td class="num" id="LN186">186</td><td class="line"> <span class='comment'>* representing a point, and another point (the center of our search) and</span></td></tr>
<tr class="codeline" data-linenumber="187"><td class="num" id="LN187">187</td><td class="line"> <span class='comment'>* a radius, appends this entry as a geoPoint into the specified geoArray</span></td></tr>
<tr class="codeline" data-linenumber="188"><td class="num" id="LN188">188</td><td class="line"> <span class='comment'>* only if the point is within the search area.</span></td></tr>
<tr class="codeline" data-linenumber="189"><td class="num" id="LN189">189</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="190"><td class="num" id="LN190">190</td><td class="line"> <span class='comment'>* returns C_OK if the point is included, or REIDS_ERR if it is outside. */</span></td></tr>
<tr class="codeline" data-linenumber="191"><td class="num" id="LN191">191</td><td class="line"><span class='keyword'>int</span> geoAppendIfWithinRadius(geoArray *ga, <span class='keyword'>double</span> lon, <span class='keyword'>double</span> lat, <span class='keyword'>double</span> radius, <span class='keyword'>double</span> score, sds member) {</td></tr>
<tr class="codeline" data-linenumber="192"><td class="num" id="LN192">192</td><td class="line">    <span class='keyword'>double</span> distance, xy[2];</td></tr>
<tr class="codeline" data-linenumber="193"><td class="num" id="LN193">193</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="194"><td class="num" id="LN194">194</td><td class="line">    <span class='keyword'>if</span> (!decodeGeohash(score,xy)) <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>; <span class='comment'>/* Can't decode. */</span></td></tr>
<tr class="codeline" data-linenumber="195"><td class="num" id="LN195">195</td><td class="line">    <span class='comment'>/* Note that geohashGetDistanceIfInRadiusWGS84() takes arguments in</span></td></tr>
<tr class="codeline" data-linenumber="196"><td class="num" id="LN196">196</td><td class="line">     <span class='comment'>* reverse order: longitude first, latitude later. */</span></td></tr>
<tr class="codeline" data-linenumber="197"><td class="num" id="LN197">197</td><td class="line">    <span class='keyword'>if</span> (!geohashGetDistanceIfInRadiusWGS84(lon,lat, xy[0], xy[1],</td></tr>
<tr class="codeline" data-linenumber="198"><td class="num" id="LN198">198</td><td class="line">                                           radius, &amp;distance))</td></tr>
<tr class="codeline" data-linenumber="199"><td class="num" id="LN199">199</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="200"><td class="num" id="LN200">200</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="201"><td class="num" id="LN201">201</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="202"><td class="num" id="LN202">202</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="203"><td class="num" id="LN203">203</td><td class="line">    <span class='comment'>/* Append the new element. */</span></td></tr>
<tr class="codeline" data-linenumber="204"><td class="num" id="LN204">204</td><td class="line">    geoPoint *gp = geoArrayAppend(ga);</td></tr>
<tr class="codeline" data-linenumber="205"><td class="num" id="LN205">205</td><td class="line">    gp-&gt;longitude = xy[0];</td></tr>
<tr class="codeline" data-linenumber="206"><td class="num" id="LN206">206</td><td class="line">    gp-&gt;latitude = xy[1];</td></tr>
<tr class="codeline" data-linenumber="207"><td class="num" id="LN207">207</td><td class="line">    gp-&gt;dist = distance;</td></tr>
<tr class="codeline" data-linenumber="208"><td class="num" id="LN208">208</td><td class="line">    gp-&gt;member = member;</td></tr>
<tr class="codeline" data-linenumber="209"><td class="num" id="LN209">209</td><td class="line">    gp-&gt;score = score;</td></tr>
<tr class="codeline" data-linenumber="210"><td class="num" id="LN210">210</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>C_OK<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="211"><td class="num" id="LN211">211</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="212"><td class="num" id="LN212">212</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="213"><td class="num" id="LN213">213</td><td class="line"><span class='comment'>/* Query a Redis sorted set to extract all the elements between 'min' and</span></td></tr>
<tr class="codeline" data-linenumber="214"><td class="num" id="LN214">214</td><td class="line"> <span class='comment'>* 'max', appending them into the array of geoPoint structures 'gparray'.</span></td></tr>
<tr class="codeline" data-linenumber="215"><td class="num" id="LN215">215</td><td class="line"> <span class='comment'>* The command returns the number of elements added to the array.</span></td></tr>
<tr class="codeline" data-linenumber="216"><td class="num" id="LN216">216</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="217"><td class="num" id="LN217">217</td><td class="line"> <span class='comment'>* Elements which are farest than 'radius' from the specified 'x' and 'y'</span></td></tr>
<tr class="codeline" data-linenumber="218"><td class="num" id="LN218">218</td><td class="line"> <span class='comment'>* coordinates are not included.</span></td></tr>
<tr class="codeline" data-linenumber="219"><td class="num" id="LN219">219</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="220"><td class="num" id="LN220">220</td><td class="line"> <span class='comment'>* The ability of this function to append to an existing set of points is</span></td></tr>
<tr class="codeline" data-linenumber="221"><td class="num" id="LN221">221</td><td class="line"> <span class='comment'>* important for good performances because querying by radius is performed</span></td></tr>
<tr class="codeline" data-linenumber="222"><td class="num" id="LN222">222</td><td class="line"> <span class='comment'>* using multiple queries to the sorted set, that we later need to sort</span></td></tr>
<tr class="codeline" data-linenumber="223"><td class="num" id="LN223">223</td><td class="line"> <span class='comment'>* via qsort. Similarly we need to be able to reject points outside the search</span></td></tr>
<tr class="codeline" data-linenumber="224"><td class="num" id="LN224">224</td><td class="line"> <span class='comment'>* radius area ASAP in order to allocate and process more points than needed. */</span></td></tr>
<tr class="codeline" data-linenumber="225"><td class="num" id="LN225">225</td><td class="line"><span class='keyword'>int</span> geoGetPointsInRange(robj *zobj, <span class='keyword'>double</span> min, <span class='keyword'>double</span> max, <span class='keyword'>double</span> lon, <span class='keyword'>double</span> lat, <span class='keyword'>double</span> radius, geoArray *ga) {</td></tr>
<tr class="codeline" data-linenumber="226"><td class="num" id="LN226">226</td><td class="line">    <span class='comment'>/* minex 0 = include min in range; maxex 1 = exclude max in range */</span></td></tr>
<tr class="codeline" data-linenumber="227"><td class="num" id="LN227">227</td><td class="line">    <span class='comment'>/* That's: min &lt;= val &lt; max */</span></td></tr>
<tr class="codeline" data-linenumber="228"><td class="num" id="LN228">228</td><td class="line">    zrangespec range = { .min = min, .max = max, .minex = 0, .maxex = 1 };</td></tr>
<tr class="codeline" data-linenumber="229"><td class="num" id="LN229">229</td><td class="line">    size_t origincount = ga-&gt;used;</td></tr>
<tr class="codeline" data-linenumber="230"><td class="num" id="LN230">230</td><td class="line">    sds member;</td></tr>
<tr class="codeline" data-linenumber="231"><td class="num" id="LN231">231</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="232"><td class="num" id="LN232">232</td><td class="line">    <span class='keyword'>if</span> (zobj-&gt;encoding == <span class='macro'>OBJ_ENCODING_ZIPLIST<span class='macro_popup'>5</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="233"><td class="num" id="LN233">233</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl = zobj-&gt;ptr;</td></tr>
<tr class="codeline" data-linenumber="234"><td class="num" id="LN234">234</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *eptr, *sptr;</td></tr>
<tr class="codeline" data-linenumber="235"><td class="num" id="LN235">235</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *vstr = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="236"><td class="num" id="LN236">236</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>int</span> vlen = 0;</td></tr>
<tr class="codeline" data-linenumber="237"><td class="num" id="LN237">237</td><td class="line">        <span class='keyword'>long</span> <span class='keyword'>long</span> vlong = 0;</td></tr>
<tr class="codeline" data-linenumber="238"><td class="num" id="LN238">238</td><td class="line">        <span class='keyword'>double</span> score = 0;</td></tr>
<tr class="codeline" data-linenumber="239"><td class="num" id="LN239">239</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="240"><td class="num" id="LN240">240</td><td class="line">        <span class='keyword'>if</span> ((eptr = zzlFirstInRange(zl, &amp;range)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="241"><td class="num" id="LN241">241</td><td class="line">            <span class='comment'>/* Nothing exists starting at our min.  No results. */</span></td></tr>
<tr class="codeline" data-linenumber="242"><td class="num" id="LN242">242</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="243"><td class="num" id="LN243">243</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="244"><td class="num" id="LN244">244</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="245"><td class="num" id="LN245">245</td><td class="line">        sptr = ziplistNext(zl, eptr);</td></tr>
<tr class="codeline" data-linenumber="246"><td class="num" id="LN246">246</td><td class="line">        <span class='keyword'>while</span> (eptr) {</td></tr>
<tr class="codeline" data-linenumber="247"><td class="num" id="LN247">247</td><td class="line">            score = zzlGetScore(sptr);</td></tr>
<tr class="codeline" data-linenumber="248"><td class="num" id="LN248">248</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="249"><td class="num" id="LN249">249</td><td class="line">            <span class='comment'>/* If we fell out of range, break. */</span></td></tr>
<tr class="codeline" data-linenumber="250"><td class="num" id="LN250">250</td><td class="line">            <span class='keyword'>if</span> (!zslValueLteMax(score, &amp;range))</td></tr>
<tr class="codeline" data-linenumber="251"><td class="num" id="LN251">251</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="252"><td class="num" id="LN252">252</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="253"><td class="num" id="LN253">253</td><td class="line">            <span class='comment'>/* We know the element exists. ziplistGet should always succeed */</span></td></tr>
<tr class="codeline" data-linenumber="254"><td class="num" id="LN254">254</td><td class="line">            ziplistGet(eptr, &amp;vstr, &amp;vlen, &amp;vlong);</td></tr>
<tr class="codeline" data-linenumber="255"><td class="num" id="LN255">255</td><td class="line">            member = (vstr == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) ? sdsfromlonglong(vlong) :</td></tr>
<tr class="codeline" data-linenumber="256"><td class="num" id="LN256">256</td><td class="line">                                      sdsnewlen(vstr,vlen);</td></tr>
<tr class="codeline" data-linenumber="257"><td class="num" id="LN257">257</td><td class="line">            <span class='keyword'>if</span> (geoAppendIfWithinRadius(ga,lon,lat,radius,score,member)</td></tr>
<tr class="codeline" data-linenumber="258"><td class="num" id="LN258">258</td><td class="line">                == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>) sdsfree(member);</td></tr>
<tr class="codeline" data-linenumber="259"><td class="num" id="LN259">259</td><td class="line">            zzlNext(zl, &amp;eptr, &amp;sptr);</td></tr>
<tr class="codeline" data-linenumber="260"><td class="num" id="LN260">260</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="261"><td class="num" id="LN261">261</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (zobj-&gt;encoding == <span class='macro'>OBJ_ENCODING_SKIPLIST<span class='macro_popup'>7</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="262"><td class="num" id="LN262">262</td><td class="line">        zset *zs = zobj-&gt;ptr;</td></tr>
<tr class="codeline" data-linenumber="263"><td class="num" id="LN263">263</td><td class="line">        zskiplist *zsl = zs-&gt;zsl;</td></tr>
<tr class="codeline" data-linenumber="264"><td class="num" id="LN264">264</td><td class="line">        zskiplistNode *ln;</td></tr>
<tr class="codeline" data-linenumber="265"><td class="num" id="LN265">265</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="266"><td class="num" id="LN266">266</td><td class="line">        <span class='keyword'>if</span> ((ln = zslFirstInRange(zsl, &amp;range)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="267"><td class="num" id="LN267">267</td><td class="line">            <span class='comment'>/* Nothing exists starting at our min.  No results. */</span></td></tr>
<tr class="codeline" data-linenumber="268"><td class="num" id="LN268">268</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="269"><td class="num" id="LN269">269</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="270"><td class="num" id="LN270">270</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="271"><td class="num" id="LN271">271</td><td class="line">        <span class='keyword'>while</span> (ln) {</td></tr>
<tr class="codeline" data-linenumber="272"><td class="num" id="LN272">272</td><td class="line">            sds ele = ln-&gt;ele;</td></tr>
<tr class="codeline" data-linenumber="273"><td class="num" id="LN273">273</td><td class="line">            <span class='comment'>/* Abort when the node is no longer in range. */</span></td></tr>
<tr class="codeline" data-linenumber="274"><td class="num" id="LN274">274</td><td class="line">            <span class='keyword'>if</span> (!zslValueLteMax(ln-&gt;score, &amp;range))</td></tr>
<tr class="codeline" data-linenumber="275"><td class="num" id="LN275">275</td><td class="line">                <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="276"><td class="num" id="LN276">276</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="277"><td class="num" id="LN277">277</td><td class="line">            ele = sdsdup(ele);</td></tr>
<tr class="codeline" data-linenumber="278"><td class="num" id="LN278">278</td><td class="line">            <span class='keyword'>if</span> (geoAppendIfWithinRadius(ga,lon,lat,radius,ln-&gt;score,ele)</td></tr>
<tr class="codeline" data-linenumber="279"><td class="num" id="LN279">279</td><td class="line">                == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>) sdsfree(ele);</td></tr>
<tr class="codeline" data-linenumber="280"><td class="num" id="LN280">280</td><td class="line">            ln = ln-&gt;level[0].forward;</td></tr>
<tr class="codeline" data-linenumber="281"><td class="num" id="LN281">281</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="282"><td class="num" id="LN282">282</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="283"><td class="num" id="LN283">283</td><td class="line">    <span class='keyword'>return</span> ga-&gt;used - origincount;</td></tr>
<tr class="codeline" data-linenumber="284"><td class="num" id="LN284">284</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="285"><td class="num" id="LN285">285</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="286"><td class="num" id="LN286">286</td><td class="line"><span class='comment'>/* Compute the sorted set scores min (inclusive), max (exclusive) we should</span></td></tr>
<tr class="codeline" data-linenumber="287"><td class="num" id="LN287">287</td><td class="line"> <span class='comment'>* query in order to retrieve all the elements inside the specified area</span></td></tr>
<tr class="codeline" data-linenumber="288"><td class="num" id="LN288">288</td><td class="line"> <span class='comment'>* 'hash'. The two scores are returned by reference in *min and *max. */</span></td></tr>
<tr class="codeline" data-linenumber="289"><td class="num" id="LN289">289</td><td class="line"><span class='keyword'>void</span> scoresOfGeoHashBox(GeoHashBits hash, GeoHashFix52Bits *min, GeoHashFix52Bits *max) {</td></tr>
<tr class="codeline" data-linenumber="290"><td class="num" id="LN290">290</td><td class="line">    <span class='comment'>/* We want to compute the sorted set scores that will include all the</span></td></tr>
<tr class="codeline" data-linenumber="291"><td class="num" id="LN291">291</td><td class="line">     <span class='comment'>* elements inside the specified Geohash 'hash', which has as many</span></td></tr>
<tr class="codeline" data-linenumber="292"><td class="num" id="LN292">292</td><td class="line">     <span class='comment'>* bits as specified by hash.step * 2.</span></td></tr>
<tr class="codeline" data-linenumber="293"><td class="num" id="LN293">293</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="294"><td class="num" id="LN294">294</td><td class="line">     <span class='comment'>* So if step is, for example, 3, and the hash value in binary</span></td></tr>
<tr class="codeline" data-linenumber="295"><td class="num" id="LN295">295</td><td class="line">     <span class='comment'>* is 101010, since our score is 52 bits we want every element which</span></td></tr>
<tr class="codeline" data-linenumber="296"><td class="num" id="LN296">296</td><td class="line">     <span class='comment'>* is in binary: 101010?????????????????????????????????????????????</span></td></tr>
<tr class="codeline" data-linenumber="297"><td class="num" id="LN297">297</td><td class="line">     <span class='comment'>* Where ? can be 0 or 1.</span></td></tr>
<tr class="codeline" data-linenumber="298"><td class="num" id="LN298">298</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="299"><td class="num" id="LN299">299</td><td class="line">     <span class='comment'>* To get the min score we just use the initial hash value left</span></td></tr>
<tr class="codeline" data-linenumber="300"><td class="num" id="LN300">300</td><td class="line">     <span class='comment'>* shifted enough to get the 52 bit value. Later we increment the</span></td></tr>
<tr class="codeline" data-linenumber="301"><td class="num" id="LN301">301</td><td class="line">     <span class='comment'>* 6 bit prefis (see the hash.bits++ statement), and get the new</span></td></tr>
<tr class="codeline" data-linenumber="302"><td class="num" id="LN302">302</td><td class="line">     <span class='comment'>* prefix: 101011, which we align again to 52 bits to get the maximum</span></td></tr>
<tr class="codeline" data-linenumber="303"><td class="num" id="LN303">303</td><td class="line">     <span class='comment'>* value (which is excluded from the search). So we get everything</span></td></tr>
<tr class="codeline" data-linenumber="304"><td class="num" id="LN304">304</td><td class="line">     <span class='comment'>* between the two following scores (represented in binary):</span></td></tr>
<tr class="codeline" data-linenumber="305"><td class="num" id="LN305">305</td><td class="line">     <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="306"><td class="num" id="LN306">306</td><td class="line">     <span class='comment'>* 1010100000000000000000000000000000000000000000000000 (included)</span></td></tr>
<tr class="codeline" data-linenumber="307"><td class="num" id="LN307">307</td><td class="line">     <span class='comment'>* and</span></td></tr>
<tr class="codeline" data-linenumber="308"><td class="num" id="LN308">308</td><td class="line">     <span class='comment'>* 1010110000000000000000000000000000000000000000000000 (excluded).</span></td></tr>
<tr class="codeline" data-linenumber="309"><td class="num" id="LN309">309</td><td class="line">     <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="310"><td class="num" id="LN310">310</td><td class="line">    *min = geohashAlign52Bits(hash);</td></tr>
<tr class="codeline" data-linenumber="311"><td class="num" id="LN311">311</td><td class="line">    hash.bits++;</td></tr>
<tr class="codeline" data-linenumber="312"><td class="num" id="LN312">312</td><td class="line">    *max = geohashAlign52Bits(hash);</td></tr>
<tr class="codeline" data-linenumber="313"><td class="num" id="LN313">313</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="314"><td class="num" id="LN314">314</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="315"><td class="num" id="LN315">315</td><td class="line"><span class='comment'>/* Obtain all members between the min/max of this geohash bounding box.</span></td></tr>
<tr class="codeline" data-linenumber="316"><td class="num" id="LN316">316</td><td class="line"> <span class='comment'>* Populate a geoArray of GeoPoints by calling geoGetPointsInRange().</span></td></tr>
<tr class="codeline" data-linenumber="317"><td class="num" id="LN317">317</td><td class="line"> <span class='comment'>* Return the number of points added to the array. */</span></td></tr>
<tr class="codeline" data-linenumber="318"><td class="num" id="LN318">318</td><td class="line"><span class='keyword'>int</span> membersOfGeoHashBox(robj *zobj, GeoHashBits hash, geoArray *ga, <span class='keyword'>double</span> lon, <span class='keyword'>double</span> lat, <span class='keyword'>double</span> radius) {</td></tr>
<tr class="codeline" data-linenumber="319"><td class="num" id="LN319">319</td><td class="line">    GeoHashFix52Bits min, max;</td></tr>
<tr class="codeline" data-linenumber="320"><td class="num" id="LN320">320</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="321"><td class="num" id="LN321">321</td><td class="line">    scoresOfGeoHashBox(hash,&amp;min,&amp;max);</td></tr>
<tr class="codeline" data-linenumber="322"><td class="num" id="LN322">322</td><td class="line">    <span class='keyword'>return</span> geoGetPointsInRange(zobj, min, max, lon, lat, radius, ga);</td></tr>
<tr class="codeline" data-linenumber="323"><td class="num" id="LN323">323</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="324"><td class="num" id="LN324">324</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="325"><td class="num" id="LN325">325</td><td class="line"><span class='comment'>/* Search all eight neighbors + self geohash box */</span></td></tr>
<tr class="codeline" data-linenumber="326"><td class="num" id="LN326">326</td><td class="line"><span class='keyword'>int</span> membersOfAllNeighbors(robj *zobj, GeoHashRadius n, <span class='keyword'>double</span> lon, <span class='keyword'>double</span> lat, <span class='keyword'>double</span> radius, geoArray *ga) {</td></tr>
<tr class="codeline" data-linenumber="327"><td class="num" id="LN327">327</td><td class="line">    GeoHashBits neighbors[9];</td></tr>
<tr class="codeline" data-linenumber="328"><td class="num" id="LN328">328</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> i, count = 0, last_processed = 0;</td></tr>
<tr class="codeline" data-linenumber="329"><td class="num" id="LN329">329</td><td class="line">    <span class='keyword'>int</span> debugmsg = 0;</td></tr>
<tr class="codeline" data-linenumber="330"><td class="num" id="LN330">330</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="331"><td class="num" id="LN331">331</td><td class="line">    neighbors[0] = n.hash;</td></tr>
<tr class="codeline" data-linenumber="332"><td class="num" id="LN332">332</td><td class="line">    neighbors[1] = n.neighbors.north;</td></tr>
<tr class="codeline" data-linenumber="333"><td class="num" id="LN333">333</td><td class="line">    neighbors[2] = n.neighbors.south;</td></tr>
<tr class="codeline" data-linenumber="334"><td class="num" id="LN334">334</td><td class="line">    neighbors[3] = n.neighbors.east;</td></tr>
<tr class="codeline" data-linenumber="335"><td class="num" id="LN335">335</td><td class="line">    neighbors[4] = n.neighbors.west;</td></tr>
<tr class="codeline" data-linenumber="336"><td class="num" id="LN336">336</td><td class="line">    neighbors[5] = n.neighbors.north_east;</td></tr>
<tr class="codeline" data-linenumber="337"><td class="num" id="LN337">337</td><td class="line">    neighbors[6] = n.neighbors.north_west;</td></tr>
<tr class="codeline" data-linenumber="338"><td class="num" id="LN338">338</td><td class="line">    neighbors[7] = n.neighbors.south_east;</td></tr>
<tr class="codeline" data-linenumber="339"><td class="num" id="LN339">339</td><td class="line">    neighbors[8] = n.neighbors.south_west;</td></tr>
<tr class="codeline" data-linenumber="340"><td class="num" id="LN340">340</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="341"><td class="num" id="LN341">341</td><td class="line">    <span class='comment'>/* For each neighbor (*and* our own hashbox), get all the matching</span></td></tr>
<tr class="codeline" data-linenumber="342"><td class="num" id="LN342">342</td><td class="line">     <span class='comment'>* members and add them to the potential result list. */</span></td></tr>
<tr class="codeline" data-linenumber="343"><td class="num" id="LN343">343</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; <span class='keyword'>sizeof</span>(neighbors) / <span class='keyword'>sizeof</span>(*neighbors); i++) {</td></tr>
<tr class="codeline" data-linenumber="344"><td class="num" id="LN344">344</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>HASHISZERO(neighbors[i])<span class='macro_popup'>(!(neighbors[i]).bits &amp;&amp; !(neighbors[i]).step)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="345"><td class="num" id="LN345">345</td><td class="line">            <span class='keyword'>if</span> (debugmsg) <span class='macro'>D(<span class='string_literal'>"neighbors[%d] is zero"</span>,i)<span class='macro_popup'>do { FILE *fp = fopen("/tmp/log.txt","a"); fprintf(fp,"%s:%s:%d:\t"<br>, "geo.c", __func__, 345); fprintf(fp,"neighbors[%d] is zero"<br>,i); fprintf(fp,"\n"); fclose(fp); } while (0);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="346"><td class="num" id="LN346">346</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="347"><td class="num" id="LN347">347</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="348"><td class="num" id="LN348">348</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="349"><td class="num" id="LN349">349</td><td class="line">        <span class='comment'>/* Debugging info. */</span></td></tr>
<tr class="codeline" data-linenumber="350"><td class="num" id="LN350">350</td><td class="line">        <span class='keyword'>if</span> (debugmsg) {</td></tr>
<tr class="codeline" data-linenumber="351"><td class="num" id="LN351">351</td><td class="line">            GeoHashRange long_range, lat_range;</td></tr>
<tr class="codeline" data-linenumber="352"><td class="num" id="LN352">352</td><td class="line">            geohashGetCoordRange(&amp;long_range,&amp;lat_range);</td></tr>
<tr class="codeline" data-linenumber="353"><td class="num" id="LN353">353</td><td class="line">            GeoHashArea myarea = {{0}};</td></tr>
<tr class="codeline" data-linenumber="354"><td class="num" id="LN354">354</td><td class="line">            geohashDecode(long_range, lat_range, neighbors[i], &amp;myarea);</td></tr>
<tr class="codeline" data-linenumber="355"><td class="num" id="LN355">355</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="356"><td class="num" id="LN356">356</td><td class="line">            <span class='comment'>/* Dump center square. */</span></td></tr>
<tr class="codeline" data-linenumber="357"><td class="num" id="LN357">357</td><td class="line">            <span class='macro'>D(<span class='string_literal'>"neighbors[%d]:\n"</span>,i)<span class='macro_popup'>do { FILE *fp = fopen("/tmp/log.txt","a"); fprintf(fp,"%s:%s:%d:\t"<br>, "geo.c", __func__, 357); fprintf(fp,"neighbors[%d]:\n",i); fprintf<br>(fp,"\n"); fclose(fp); } while (0);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="358"><td class="num" id="LN358">358</td><td class="line">            <span class='macro'>D(<span class='string_literal'>"area.longitude.min: %f\n"</span>, myarea.longitude.min)<span class='macro_popup'>do { FILE *fp = fopen("/tmp/log.txt","a"); fprintf(fp,"%s:%s:%d:\t"<br>, "geo.c", __func__, 358); fprintf(fp,"area.longitude.min: %f\n"<br>, myarea.longitude.min); fprintf(fp,"\n"); fclose(fp); } while<br> (0);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="359"><td class="num" id="LN359">359</td><td class="line">            <span class='macro'>D(<span class='string_literal'>"area.longitude.max: %f\n"</span>, myarea.longitude.max)<span class='macro_popup'>do { FILE *fp = fopen("/tmp/log.txt","a"); fprintf(fp,"%s:%s:%d:\t"<br>, "geo.c", __func__, 359); fprintf(fp,"area.longitude.max: %f\n"<br>, myarea.longitude.max); fprintf(fp,"\n"); fclose(fp); } while<br> (0);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="360"><td class="num" id="LN360">360</td><td class="line">            <span class='macro'>D(<span class='string_literal'>"area.latitude.min: %f\n"</span>, myarea.latitude.min)<span class='macro_popup'>do { FILE *fp = fopen("/tmp/log.txt","a"); fprintf(fp,"%s:%s:%d:\t"<br>, "geo.c", __func__, 360); fprintf(fp,"area.latitude.min: %f\n"<br>, myarea.latitude.min); fprintf(fp,"\n"); fclose(fp); } while<br> (0);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="361"><td class="num" id="LN361">361</td><td class="line">            <span class='macro'>D(<span class='string_literal'>"area.latitude.max: %f\n"</span>, myarea.latitude.max)<span class='macro_popup'>do { FILE *fp = fopen("/tmp/log.txt","a"); fprintf(fp,"%s:%s:%d:\t"<br>, "geo.c", __func__, 361); fprintf(fp,"area.latitude.max: %f\n"<br>, myarea.latitude.max); fprintf(fp,"\n"); fclose(fp); } while<br> (0);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="362"><td class="num" id="LN362">362</td><td class="line">            <span class='macro'>D(<span class='string_literal'>"\n"</span>)<span class='macro_popup'>do { FILE *fp = fopen("/tmp/log.txt","a"); fprintf(fp,"%s:%s:%d:\t"<br>, "geo.c", __func__, 362); fprintf(fp,"\n"); fprintf(fp,"\n")<br>; fclose(fp); } while (0);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="363"><td class="num" id="LN363">363</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="364"><td class="num" id="LN364">364</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="365"><td class="num" id="LN365">365</td><td class="line">        <span class='comment'>/* When a huge Radius (in the 5000 km range or more) is used,</span></td></tr>
<tr class="codeline" data-linenumber="366"><td class="num" id="LN366">366</td><td class="line">         <span class='comment'>* adjacent neighbors can be the same, leading to duplicated</span></td></tr>
<tr class="codeline" data-linenumber="367"><td class="num" id="LN367">367</td><td class="line">         <span class='comment'>* elements. Skip every range which is the same as the one</span></td></tr>
<tr class="codeline" data-linenumber="368"><td class="num" id="LN368">368</td><td class="line">         <span class='comment'>* processed previously. */</span></td></tr>
<tr class="codeline" data-linenumber="369"><td class="num" id="LN369">369</td><td class="line">        <span class='keyword'>if</span> (last_processed &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="370"><td class="num" id="LN370">370</td><td class="line">            neighbors[i].bits == neighbors[last_processed].bits &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="371"><td class="num" id="LN371">371</td><td class="line">            neighbors[i].step == neighbors[last_processed].step)</td></tr>
<tr class="codeline" data-linenumber="372"><td class="num" id="LN372">372</td><td class="line">        {</td></tr>
<tr class="codeline" data-linenumber="373"><td class="num" id="LN373">373</td><td class="line">            <span class='keyword'>if</span> (debugmsg)</td></tr>
<tr class="codeline" data-linenumber="374"><td class="num" id="LN374">374</td><td class="line">                <span class='macro'>D(<span class='string_literal'>"Skipping processing of %d, same as previous\n"</span>,i)<span class='macro_popup'>do { FILE *fp = fopen("/tmp/log.txt","a"); fprintf(fp,"%s:%s:%d:\t"<br>, "geo.c", __func__, 374); fprintf(fp,"Skipping processing of %d, same as previous\n"<br>,i); fprintf(fp,"\n"); fclose(fp); } while (0);</span></span>;</td></tr>
<tr class="codeline" data-linenumber="375"><td class="num" id="LN375">375</td><td class="line">            <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="376"><td class="num" id="LN376">376</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="377"><td class="num" id="LN377">377</td><td class="line">        count += membersOfGeoHashBox(zobj, neighbors[i], ga, lon, lat, radius);</td></tr>
<tr class="codeline" data-linenumber="378"><td class="num" id="LN378">378</td><td class="line">        last_processed = i;</td></tr>
<tr class="codeline" data-linenumber="379"><td class="num" id="LN379">379</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="380"><td class="num" id="LN380">380</td><td class="line">    <span class='keyword'>return</span> count;</td></tr>
<tr class="codeline" data-linenumber="381"><td class="num" id="LN381">381</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="382"><td class="num" id="LN382">382</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="383"><td class="num" id="LN383">383</td><td class="line"><span class='comment'>/* Sort comparators for qsort() */</span></td></tr>
<tr class="codeline" data-linenumber="384"><td class="num" id="LN384">384</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> sort_gp_asc(<span class='keyword'>const</span> <span class='keyword'>void</span> *a, <span class='keyword'>const</span> <span class='keyword'>void</span> *b) {</td></tr>
<tr class="codeline" data-linenumber="385"><td class="num" id="LN385">385</td><td class="line">    <span class='keyword'>const</span> <span class='keyword'>struct</span> geoPoint *gpa = a, *gpb = b;</td></tr>
<tr class="codeline" data-linenumber="386"><td class="num" id="LN386">386</td><td class="line">    <span class='comment'>/* We can't do adist - bdist because they are doubles and</span></td></tr>
<tr class="codeline" data-linenumber="387"><td class="num" id="LN387">387</td><td class="line">     <span class='comment'>* the comparator returns an int. */</span></td></tr>
<tr class="codeline" data-linenumber="388"><td class="num" id="LN388">388</td><td class="line">    <span class='keyword'>if</span> (gpa-&gt;dist &gt; gpb-&gt;dist)</td></tr>
<tr class="codeline" data-linenumber="389"><td class="num" id="LN389">389</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="390"><td class="num" id="LN390">390</td><td class="line">    <span class='keyword'>else</span> <span class='keyword'>if</span> (gpa-&gt;dist == gpb-&gt;dist)</td></tr>
<tr class="codeline" data-linenumber="391"><td class="num" id="LN391">391</td><td class="line">        <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="392"><td class="num" id="LN392">392</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="393"><td class="num" id="LN393">393</td><td class="line">        <span class='keyword'>return</span> -1;</td></tr>
<tr class="codeline" data-linenumber="394"><td class="num" id="LN394">394</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="395"><td class="num" id="LN395">395</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="396"><td class="num" id="LN396">396</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> sort_gp_desc(<span class='keyword'>const</span> <span class='keyword'>void</span> *a, <span class='keyword'>const</span> <span class='keyword'>void</span> *b) {</td></tr>
<tr class="codeline" data-linenumber="397"><td class="num" id="LN397">397</td><td class="line">    <span class='keyword'>return</span> -sort_gp_asc(a, b);</td></tr>
<tr class="codeline" data-linenumber="398"><td class="num" id="LN398">398</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="399"><td class="num" id="LN399">399</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="400"><td class="num" id="LN400">400</td><td class="line"><span class='comment'>/* ====================================================================</span></td></tr>
<tr class="codeline" data-linenumber="401"><td class="num" id="LN401">401</td><td class="line"> <span class='comment'>* Commands</span></td></tr>
<tr class="codeline" data-linenumber="402"><td class="num" id="LN402">402</td><td class="line"> <span class='comment'>* ==================================================================== */</span></td></tr>
<tr class="codeline" data-linenumber="403"><td class="num" id="LN403">403</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="404"><td class="num" id="LN404">404</td><td class="line"><span class='comment'>/* GEOADD key long lat name [long2 lat2 name2 ... longN latN nameN] */</span></td></tr>
<tr class="codeline" data-linenumber="405"><td class="num" id="LN405">405</td><td class="line"><span class='keyword'>void</span> geoaddCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="406"><td class="num" id="LN406">406</td><td class="line">    <span class='comment'>/* Check arguments number for sanity. */</span></td></tr>
<tr class="codeline" data-linenumber="407"><td class="num" id="LN407">407</td><td class="line">    <span class='keyword'>if</span> ((c-&gt;argc - 2) % 3 != 0) {</td></tr>
<tr class="codeline" data-linenumber="408"><td class="num" id="LN408">408</td><td class="line">        <span class='comment'>/* Need an odd number of arguments if we got this far... */</span></td></tr>
<tr class="codeline" data-linenumber="409"><td class="num" id="LN409">409</td><td class="line">        addReplyError(c, <span class='string_literal'>"syntax error. Try GEOADD key [x1] [y1] [name1] "</span></td></tr>
<tr class="codeline" data-linenumber="410"><td class="num" id="LN410">410</td><td class="line">                         <span class='string_literal'>"[x2] [y2] [name2] ... "</span>);</td></tr>
<tr class="codeline" data-linenumber="411"><td class="num" id="LN411">411</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="412"><td class="num" id="LN412">412</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="413"><td class="num" id="LN413">413</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="414"><td class="num" id="LN414">414</td><td class="line">    <span class='keyword'>int</span> elements = (c-&gt;argc - 2) / 3;</td></tr>
<tr class="codeline" data-linenumber="415"><td class="num" id="LN415">415</td><td class="line">    <span class='keyword'>int</span> argc = 2+elements*2; <span class='comment'>/* ZADD key score ele ... */</span></td></tr>
<tr class="codeline" data-linenumber="416"><td class="num" id="LN416">416</td><td class="line">    robj **argv = zcalloc(argc*<span class='keyword'>sizeof</span>(robj*));</td></tr>
<tr class="codeline" data-linenumber="417"><td class="num" id="LN417">417</td><td class="line">    argv[0] = createRawStringObject(<span class='string_literal'>"zadd"</span>,4);</td></tr>
<tr class="codeline" data-linenumber="418"><td class="num" id="LN418">418</td><td class="line">    argv[1] = c-&gt;argv[1]; <span class='comment'>/* key */</span></td></tr>
<tr class="codeline" data-linenumber="419"><td class="num" id="LN419">419</td><td class="line">    incrRefCount(argv[1]);</td></tr>
<tr class="codeline" data-linenumber="420"><td class="num" id="LN420">420</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="421"><td class="num" id="LN421">421</td><td class="line">    <span class='comment'>/* Create the argument vector to call ZADD in order to add all</span></td></tr>
<tr class="codeline" data-linenumber="422"><td class="num" id="LN422">422</td><td class="line">     <span class='comment'>* the score,value pairs to the requested zset, where score is actually</span></td></tr>
<tr class="codeline" data-linenumber="423"><td class="num" id="LN423">423</td><td class="line">     <span class='comment'>* an encoded version of lat,long. */</span></td></tr>
<tr class="codeline" data-linenumber="424"><td class="num" id="LN424">424</td><td class="line">    <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="425"><td class="num" id="LN425">425</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; elements; i++) {</td></tr>
<tr class="codeline" data-linenumber="426"><td class="num" id="LN426">426</td><td class="line">        <span class='keyword'>double</span> xy[2];</td></tr>
<tr class="codeline" data-linenumber="427"><td class="num" id="LN427">427</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="428"><td class="num" id="LN428">428</td><td class="line">        <span class='keyword'>if</span> (extractLongLatOrReply(c, (c-&gt;argv+2)+(i*3),xy) == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="429"><td class="num" id="LN429">429</td><td class="line">            <span class='keyword'>for</span> (i = 0; i &lt; argc; i++)</td></tr>
<tr class="codeline" data-linenumber="430"><td class="num" id="LN430">430</td><td class="line">                <span class='keyword'>if</span> (argv[i]) decrRefCount(argv[i]);</td></tr>
<tr class="codeline" data-linenumber="431"><td class="num" id="LN431">431</td><td class="line">            zfree(argv);</td></tr>
<tr class="codeline" data-linenumber="432"><td class="num" id="LN432">432</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="433"><td class="num" id="LN433">433</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="434"><td class="num" id="LN434">434</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="435"><td class="num" id="LN435">435</td><td class="line">        <span class='comment'>/* Turn the coordinates into the score of the element. */</span></td></tr>
<tr class="codeline" data-linenumber="436"><td class="num" id="LN436">436</td><td class="line">        GeoHashBits hash;</td></tr>
<tr class="codeline" data-linenumber="437"><td class="num" id="LN437">437</td><td class="line">        geohashEncodeWGS84(xy[0], xy[1], <span class='macro'>GEO_STEP_MAX<span class='macro_popup'>26</span></span>, &amp;hash);</td></tr>
<tr class="codeline" data-linenumber="438"><td class="num" id="LN438">438</td><td class="line">        GeoHashFix52Bits bits = geohashAlign52Bits(hash);</td></tr>
<tr class="codeline" data-linenumber="439"><td class="num" id="LN439">439</td><td class="line">        robj *score = createObject(<span class='macro'>OBJ_STRING<span class='macro_popup'>0</span></span>, sdsfromlonglong(bits));</td></tr>
<tr class="codeline" data-linenumber="440"><td class="num" id="LN440">440</td><td class="line">        robj *val = c-&gt;argv[2 + i * 3 + 2];</td></tr>
<tr class="codeline" data-linenumber="441"><td class="num" id="LN441">441</td><td class="line">        argv[2+i*2] = score;</td></tr>
<tr class="codeline" data-linenumber="442"><td class="num" id="LN442">442</td><td class="line">        argv[3+i*2] = val;</td></tr>
<tr class="codeline" data-linenumber="443"><td class="num" id="LN443">443</td><td class="line">        incrRefCount(val);</td></tr>
<tr class="codeline" data-linenumber="444"><td class="num" id="LN444">444</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="445"><td class="num" id="LN445">445</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="446"><td class="num" id="LN446">446</td><td class="line">    <span class='comment'>/* Finally call ZADD that will do the work for us. */</span></td></tr>
<tr class="codeline" data-linenumber="447"><td class="num" id="LN447">447</td><td class="line">    replaceClientCommandVector(c,argc,argv);</td></tr>
<tr class="codeline" data-linenumber="448"><td class="num" id="LN448">448</td><td class="line">    zaddCommand(c);</td></tr>
<tr class="codeline" data-linenumber="449"><td class="num" id="LN449">449</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="450"><td class="num" id="LN450">450</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="451"><td class="num" id="LN451">451</td><td class="line"><span class='directive'>#define <span class='macro'>SORT_NONE<span class='macro_popup'>0</span></span> 0</span></td></tr>
<tr class="codeline" data-linenumber="452"><td class="num" id="LN452">452</td><td class="line"><span class='directive'>#define <span class='macro'>SORT_ASC<span class='macro_popup'>1</span></span> 1</span></td></tr>
<tr class="codeline" data-linenumber="453"><td class="num" id="LN453">453</td><td class="line"><span class='directive'>#define <span class='macro'>SORT_DESC<span class='macro_popup'>2</span></span> 2</span></td></tr>
<tr class="codeline" data-linenumber="454"><td class="num" id="LN454">454</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="455"><td class="num" id="LN455">455</td><td class="line"><span class='directive'>#define <span class='macro'>RADIUS_COORDS<span class='macro_popup'>(1&lt;&lt;0)</span></span> (1&lt;&lt;0)    /* Search around coordinates. */</span></td></tr>
<tr class="codeline" data-linenumber="456"><td class="num" id="LN456">456</td><td class="line"><span class='directive'>#define <span class='macro'>RADIUS_MEMBER<span class='macro_popup'>(1&lt;&lt;1)</span></span> (1&lt;&lt;1)    /* Search around member. */</span></td></tr>
<tr class="codeline" data-linenumber="457"><td class="num" id="LN457">457</td><td class="line"><span class='directive'>#define <span class='macro'>RADIUS_NOSTORE<span class='macro_popup'>(1&lt;&lt;2)</span></span> (1&lt;&lt;2)   /* Do not acceot STORE/STOREDIST option. */</span></td></tr>
<tr class="codeline" data-linenumber="458"><td class="num" id="LN458">458</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="459"><td class="num" id="LN459">459</td><td class="line"><span class='comment'>/* GEORADIUS key x y radius unit [WITHDIST] [WITHHASH] [WITHCOORD] [ASC|DESC]</span></td></tr>
<tr class="codeline" data-linenumber="460"><td class="num" id="LN460">460</td><td class="line"> <span class='comment'>*                               [COUNT count] [STORE key] [STOREDIST key]</span></td></tr>
<tr class="codeline" data-linenumber="461"><td class="num" id="LN461">461</td><td class="line"> <span class='comment'>* GEORADIUSBYMEMBER key member radius unit ... options ... */</span></td></tr>
<tr class="codeline" data-linenumber="462"><td class="num" id="LN462">462</td><td class="line"><span class='keyword'>void</span> georadiusGeneric(client *c, <span class='keyword'>int</span> flags) {</td></tr>
<tr class="codeline" data-linenumber="463"><td class="num" id="LN463">463</td><td class="line">    robj *key = c-&gt;argv[1];</td></tr>
<tr class="codeline" data-linenumber="464"><td class="num" id="LN464">464</td><td class="line">    robj *storekey = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="465"><td class="num" id="LN465">465</td><td class="line">    <span class='keyword'>int</span> storedist = 0; <span class='comment'>/* 0 for STORE, 1 for STOREDIST. */</span></td></tr>
<tr class="codeline" data-linenumber="466"><td class="num" id="LN466">466</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="467"><td class="num" id="LN467">467</td><td class="line">    <span class='comment'>/* Look up the requested zset */</span></td></tr>
<tr class="codeline" data-linenumber="468"><td class="num" id="LN468">468</td><td class="line">    robj *zobj = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="469"><td class="num" id="LN469">469</td><td class="line">    <span class='keyword'>if</span> ((zobj = lookupKeyReadOrReply(c, key, shared.emptyarray)) == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="470"><td class="num" id="LN470">470</td><td class="line">        checkType(c, zobj, <span class='macro'>OBJ_ZSET<span class='macro_popup'>3</span></span>)) {</td></tr>
<tr class="codeline" data-linenumber="471"><td class="num" id="LN471">471</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="472"><td class="num" id="LN472">472</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="473"><td class="num" id="LN473">473</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="474"><td class="num" id="LN474">474</td><td class="line">    <span class='comment'>/* Find long/lat to use for radius search based on inquiry type */</span></td></tr>
<tr class="codeline" data-linenumber="475"><td class="num" id="LN475">475</td><td class="line">    <span class='keyword'>int</span> base_args;</td></tr>
<tr class="codeline" data-linenumber="476"><td class="num" id="LN476">476</td><td class="line">    <span class='keyword'>double</span> xy[2] = { 0 };</td></tr>
<tr class="codeline" data-linenumber="477"><td class="num" id="LN477">477</td><td class="line">    <span class='keyword'>if</span> (flags &amp; <span class='macro'>RADIUS_COORDS<span class='macro_popup'>(1&lt;&lt;0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="478"><td class="num" id="LN478">478</td><td class="line">        base_args = 6;</td></tr>
<tr class="codeline" data-linenumber="479"><td class="num" id="LN479">479</td><td class="line">        <span class='keyword'>if</span> (extractLongLatOrReply(c, c-&gt;argv + 2, xy) == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="480"><td class="num" id="LN480">480</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="481"><td class="num" id="LN481">481</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (flags &amp; <span class='macro'>RADIUS_MEMBER<span class='macro_popup'>(1&lt;&lt;1)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="482"><td class="num" id="LN482">482</td><td class="line">        base_args = 5;</td></tr>
<tr class="codeline" data-linenumber="483"><td class="num" id="LN483">483</td><td class="line">        robj *member = c-&gt;argv[2];</td></tr>
<tr class="codeline" data-linenumber="484"><td class="num" id="LN484">484</td><td class="line">        <span class='keyword'>if</span> (longLatFromMember(zobj, member, xy) == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="485"><td class="num" id="LN485">485</td><td class="line">            addReplyError(c, <span class='string_literal'>"could not decode requested zset member"</span>);</td></tr>
<tr class="codeline" data-linenumber="486"><td class="num" id="LN486">486</td><td class="line">            <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="487"><td class="num" id="LN487">487</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="488"><td class="num" id="LN488">488</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="489"><td class="num" id="LN489">489</td><td class="line">        addReplyError(c, <span class='string_literal'>"Unknown georadius search type"</span>);</td></tr>
<tr class="codeline" data-linenumber="490"><td class="num" id="LN490">490</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="491"><td class="num" id="LN491">491</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="492"><td class="num" id="LN492">492</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="493"><td class="num" id="LN493">493</td><td class="line">    <span class='comment'>/* Extract radius and units from arguments */</span></td></tr>
<tr class="codeline" data-linenumber="494"><td class="num" id="LN494">494</td><td class="line">    <span class='keyword'>double</span> radius_meters = 0, conversion = 1;</td></tr>
<tr class="codeline" data-linenumber="495"><td class="num" id="LN495">495</td><td class="line">    <span class='keyword'>if</span> ((radius_meters = extractDistanceOrReply(c, c-&gt;argv + base_args - 2,</td></tr>
<tr class="codeline" data-linenumber="496"><td class="num" id="LN496">496</td><td class="line">                                                &amp;conversion)) &lt; 0) {</td></tr>
<tr class="codeline" data-linenumber="497"><td class="num" id="LN497">497</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="498"><td class="num" id="LN498">498</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="499"><td class="num" id="LN499">499</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="500"><td class="num" id="LN500">500</td><td class="line">    <span class='comment'>/* Discover and populate all optional parameters. */</span></td></tr>
<tr class="codeline" data-linenumber="501"><td class="num" id="LN501">501</td><td class="line">    <span class='keyword'>int</span> withdist = 0, withhash = 0, withcoords = 0;</td></tr>
<tr class="codeline" data-linenumber="502"><td class="num" id="LN502">502</td><td class="line">    <span class='keyword'>int</span> sort = <span class='macro'>SORT_NONE<span class='macro_popup'>0</span></span>;</td></tr>
<tr class="codeline" data-linenumber="503"><td class="num" id="LN503">503</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> count = 0;</td></tr>
<tr class="codeline" data-linenumber="504"><td class="num" id="LN504">504</td><td class="line">    <span class='keyword'>if</span> (c-&gt;argc &gt; base_args) {</td></tr>
<tr class="codeline" data-linenumber="505"><td class="num" id="LN505">505</td><td class="line">        <span class='keyword'>int</span> remaining = c-&gt;argc - base_args;</td></tr>
<tr class="codeline" data-linenumber="506"><td class="num" id="LN506">506</td><td class="line">        <span class='keyword'>for</span> (<span class='keyword'>int</span> i = 0; i &lt; remaining; i++) {</td></tr>
<tr class="codeline" data-linenumber="507"><td class="num" id="LN507">507</td><td class="line">            <span class='keyword'>char</span> *arg = c-&gt;argv[base_args + i]-&gt;ptr;</td></tr>
<tr class="codeline" data-linenumber="508"><td class="num" id="LN508">508</td><td class="line">            <span class='keyword'>if</span> (!strcasecmp(arg, <span class='string_literal'>"withdist"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="509"><td class="num" id="LN509">509</td><td class="line">                withdist = 1;</td></tr>
<tr class="codeline" data-linenumber="510"><td class="num" id="LN510">510</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(arg, <span class='string_literal'>"withhash"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="511"><td class="num" id="LN511">511</td><td class="line">                withhash = 1;</td></tr>
<tr class="codeline" data-linenumber="512"><td class="num" id="LN512">512</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(arg, <span class='string_literal'>"withcoord"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="513"><td class="num" id="LN513">513</td><td class="line">                withcoords = 1;</td></tr>
<tr class="codeline" data-linenumber="514"><td class="num" id="LN514">514</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(arg, <span class='string_literal'>"asc"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="515"><td class="num" id="LN515">515</td><td class="line">                sort = <span class='macro'>SORT_ASC<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="516"><td class="num" id="LN516">516</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(arg, <span class='string_literal'>"desc"</span>)) {</td></tr>
<tr class="codeline" data-linenumber="517"><td class="num" id="LN517">517</td><td class="line">                sort = <span class='macro'>SORT_DESC<span class='macro_popup'>2</span></span>;</td></tr>
<tr class="codeline" data-linenumber="518"><td class="num" id="LN518">518</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(arg, <span class='string_literal'>"count"</span>) &amp;&amp; (i+1) &lt; remaining) {</td></tr>
<tr class="codeline" data-linenumber="519"><td class="num" id="LN519">519</td><td class="line">                <span class='keyword'>if</span> (getLongLongFromObjectOrReply(c, c-&gt;argv[base_args+i+1],</td></tr>
<tr class="codeline" data-linenumber="520"><td class="num" id="LN520">520</td><td class="line">                    &amp;count, <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) != <span class='macro'>C_OK<span class='macro_popup'>0</span></span>) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="521"><td class="num" id="LN521">521</td><td class="line">                <span class='keyword'>if</span> (count &lt;= 0) {</td></tr>
<tr class="codeline" data-linenumber="522"><td class="num" id="LN522">522</td><td class="line">                    addReplyError(c,<span class='string_literal'>"COUNT must be &gt; 0"</span>);</td></tr>
<tr class="codeline" data-linenumber="523"><td class="num" id="LN523">523</td><td class="line">                    <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="524"><td class="num" id="LN524">524</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="525"><td class="num" id="LN525">525</td><td class="line">                i++;</td></tr>
<tr class="codeline" data-linenumber="526"><td class="num" id="LN526">526</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(arg, <span class='string_literal'>"store"</span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="527"><td class="num" id="LN527">527</td><td class="line">                       (i+1) &lt; remaining &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="528"><td class="num" id="LN528">528</td><td class="line">                       !(flags &amp; <span class='macro'>RADIUS_NOSTORE<span class='macro_popup'>(1&lt;&lt;2)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="529"><td class="num" id="LN529">529</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="530"><td class="num" id="LN530">530</td><td class="line">                storekey = c-&gt;argv[base_args+i+1];</td></tr>
<tr class="codeline" data-linenumber="531"><td class="num" id="LN531">531</td><td class="line">                storedist = 0;</td></tr>
<tr class="codeline" data-linenumber="532"><td class="num" id="LN532">532</td><td class="line">                i++;</td></tr>
<tr class="codeline" data-linenumber="533"><td class="num" id="LN533">533</td><td class="line">            } <span class='keyword'>else</span> <span class='keyword'>if</span> (!strcasecmp(arg, <span class='string_literal'>"storedist"</span>) &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="534"><td class="num" id="LN534">534</td><td class="line">                       (i+1) &lt; remaining &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="535"><td class="num" id="LN535">535</td><td class="line">                       !(flags &amp; <span class='macro'>RADIUS_NOSTORE<span class='macro_popup'>(1&lt;&lt;2)</span></span>))</td></tr>
<tr class="codeline" data-linenumber="536"><td class="num" id="LN536">536</td><td class="line">            {</td></tr>
<tr class="codeline" data-linenumber="537"><td class="num" id="LN537">537</td><td class="line">                storekey = c-&gt;argv[base_args+i+1];</td></tr>
<tr class="codeline" data-linenumber="538"><td class="num" id="LN538">538</td><td class="line">                storedist = 1;</td></tr>
<tr class="codeline" data-linenumber="539"><td class="num" id="LN539">539</td><td class="line">                i++;</td></tr>
<tr class="codeline" data-linenumber="540"><td class="num" id="LN540">540</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="541"><td class="num" id="LN541">541</td><td class="line">                addReply(c, shared.syntaxerr);</td></tr>
<tr class="codeline" data-linenumber="542"><td class="num" id="LN542">542</td><td class="line">                <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="543"><td class="num" id="LN543">543</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="544"><td class="num" id="LN544">544</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="545"><td class="num" id="LN545">545</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="546"><td class="num" id="LN546">546</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="547"><td class="num" id="LN547">547</td><td class="line">    <span class='comment'>/* Trap options not compatible with STORE and STOREDIST. */</span></td></tr>
<tr class="codeline" data-linenumber="548"><td class="num" id="LN548">548</td><td class="line">    <span class='keyword'>if</span> (storekey &amp;&amp; (withdist || withhash || withcoords)) {</td></tr>
<tr class="codeline" data-linenumber="549"><td class="num" id="LN549">549</td><td class="line">        addReplyError(c,</td></tr>
<tr class="codeline" data-linenumber="550"><td class="num" id="LN550">550</td><td class="line">            <span class='string_literal'>"STORE option in GEORADIUS is not compatible with "</span></td></tr>
<tr class="codeline" data-linenumber="551"><td class="num" id="LN551">551</td><td class="line">            <span class='string_literal'>"WITHDIST, WITHHASH and WITHCOORDS options"</span>);</td></tr>
<tr class="codeline" data-linenumber="552"><td class="num" id="LN552">552</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="553"><td class="num" id="LN553">553</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="554"><td class="num" id="LN554">554</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="555"><td class="num" id="LN555">555</td><td class="line">    <span class='comment'>/* COUNT without ordering does not make much sense, force ASC</span></td></tr>
<tr class="codeline" data-linenumber="556"><td class="num" id="LN556">556</td><td class="line">     <span class='comment'>* ordering if COUNT was specified but no sorting was requested. */</span></td></tr>
<tr class="codeline" data-linenumber="557"><td class="num" id="LN557">557</td><td class="line">    <span class='keyword'>if</span> (count != 0 &amp;&amp; sort == <span class='macro'>SORT_NONE<span class='macro_popup'>0</span></span>) sort = <span class='macro'>SORT_ASC<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="558"><td class="num" id="LN558">558</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="559"><td class="num" id="LN559">559</td><td class="line">    <span class='comment'>/* Get all neighbor geohash boxes for our radius search */</span></td></tr>
<tr class="codeline" data-linenumber="560"><td class="num" id="LN560">560</td><td class="line">    GeoHashRadius georadius =</td></tr>
<tr class="codeline" data-linenumber="561"><td class="num" id="LN561">561</td><td class="line">        geohashGetAreasByRadiusWGS84(xy[0], xy[1], radius_meters);</td></tr>
<tr class="codeline" data-linenumber="562"><td class="num" id="LN562">562</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="563"><td class="num" id="LN563">563</td><td class="line">    <span class='comment'>/* Search the zset for all matching points */</span></td></tr>
<tr class="codeline" data-linenumber="564"><td class="num" id="LN564">564</td><td class="line">    geoArray *ga = geoArrayCreate();</td></tr>
<tr class="codeline" data-linenumber="565"><td class="num" id="LN565">565</td><td class="line">    membersOfAllNeighbors(zobj, georadius, xy[0], xy[1], radius_meters, ga);</td></tr>
<tr class="codeline" data-linenumber="566"><td class="num" id="LN566">566</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="567"><td class="num" id="LN567">567</td><td class="line">    <span class='comment'>/* If no matching results, the user gets an empty reply. */</span></td></tr>
<tr class="codeline" data-linenumber="568"><td class="num" id="LN568">568</td><td class="line">    <span class='keyword'>if</span> (ga-&gt;used == 0 &amp;&amp; storekey == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="569"><td class="num" id="LN569">569</td><td class="line">        addReply(c,shared.emptyarray);</td></tr>
<tr class="codeline" data-linenumber="570"><td class="num" id="LN570">570</td><td class="line">        geoArrayFree(ga);</td></tr>
<tr class="codeline" data-linenumber="571"><td class="num" id="LN571">571</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="572"><td class="num" id="LN572">572</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="573"><td class="num" id="LN573">573</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="574"><td class="num" id="LN574">574</td><td class="line">    <span class='keyword'>long</span> result_length = ga-&gt;used;</td></tr>
<tr class="codeline" data-linenumber="575"><td class="num" id="LN575">575</td><td class="line">    <span class='keyword'>long</span> returned_items = (count == 0 || result_length &lt; count) ?</td></tr>
<tr class="codeline" data-linenumber="576"><td class="num" id="LN576">576</td><td class="line">                          result_length : count;</td></tr>
<tr class="codeline" data-linenumber="577"><td class="num" id="LN577">577</td><td class="line">    <span class='keyword'>long</span> option_length = 0;</td></tr>
<tr class="codeline" data-linenumber="578"><td class="num" id="LN578">578</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="579"><td class="num" id="LN579">579</td><td class="line">    <span class='comment'>/* Process [optional] requested sorting */</span></td></tr>
<tr class="codeline" data-linenumber="580"><td class="num" id="LN580">580</td><td class="line">    <span class='keyword'>if</span> (sort == <span class='macro'>SORT_ASC<span class='macro_popup'>1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="581"><td class="num" id="LN581">581</td><td class="line">        qsort(ga-&gt;array, result_length, <span class='keyword'>sizeof</span>(geoPoint), sort_gp_asc);</td></tr>
<tr class="codeline" data-linenumber="582"><td class="num" id="LN582">582</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (sort == <span class='macro'>SORT_DESC<span class='macro_popup'>2</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="583"><td class="num" id="LN583">583</td><td class="line">        qsort(ga-&gt;array, result_length, <span class='keyword'>sizeof</span>(geoPoint), sort_gp_desc);</td></tr>
<tr class="codeline" data-linenumber="584"><td class="num" id="LN584">584</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="585"><td class="num" id="LN585">585</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="586"><td class="num" id="LN586">586</td><td class="line">    <span class='keyword'>if</span> (storekey == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="587"><td class="num" id="LN587">587</td><td class="line">        <span class='comment'>/* No target key, return results to user. */</span></td></tr>
<tr class="codeline" data-linenumber="588"><td class="num" id="LN588">588</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="589"><td class="num" id="LN589">589</td><td class="line">        <span class='comment'>/* Our options are self-contained nested multibulk replies, so we</span></td></tr>
<tr class="codeline" data-linenumber="590"><td class="num" id="LN590">590</td><td class="line">         <span class='comment'>* only need to track how many of those nested replies we return. */</span></td></tr>
<tr class="codeline" data-linenumber="591"><td class="num" id="LN591">591</td><td class="line">        <span class='keyword'>if</span> (withdist)</td></tr>
<tr class="codeline" data-linenumber="592"><td class="num" id="LN592">592</td><td class="line">            option_length++;</td></tr>
<tr class="codeline" data-linenumber="593"><td class="num" id="LN593">593</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="594"><td class="num" id="LN594">594</td><td class="line">        <span class='keyword'>if</span> (withcoords)</td></tr>
<tr class="codeline" data-linenumber="595"><td class="num" id="LN595">595</td><td class="line">            option_length++;</td></tr>
<tr class="codeline" data-linenumber="596"><td class="num" id="LN596">596</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="597"><td class="num" id="LN597">597</td><td class="line">        <span class='keyword'>if</span> (withhash)</td></tr>
<tr class="codeline" data-linenumber="598"><td class="num" id="LN598">598</td><td class="line">            option_length++;</td></tr>
<tr class="codeline" data-linenumber="599"><td class="num" id="LN599">599</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="600"><td class="num" id="LN600">600</td><td class="line">        <span class='comment'>/* The array len we send is exactly result_length. The result is</span></td></tr>
<tr class="codeline" data-linenumber="601"><td class="num" id="LN601">601</td><td class="line">         <span class='comment'>* either all strings of just zset members  *or* a nested multi-bulk</span></td></tr>
<tr class="codeline" data-linenumber="602"><td class="num" id="LN602">602</td><td class="line">         <span class='comment'>* reply containing the zset member string _and_ all the additional</span></td></tr>
<tr class="codeline" data-linenumber="603"><td class="num" id="LN603">603</td><td class="line">         <span class='comment'>* options the user enabled for this request. */</span></td></tr>
<tr class="codeline" data-linenumber="604"><td class="num" id="LN604">604</td><td class="line">        addReplyArrayLen(c, returned_items);</td></tr>
<tr class="codeline" data-linenumber="605"><td class="num" id="LN605">605</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="606"><td class="num" id="LN606">606</td><td class="line">        <span class='comment'>/* Finally send results back to the caller */</span></td></tr>
<tr class="codeline" data-linenumber="607"><td class="num" id="LN607">607</td><td class="line">        <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="608"><td class="num" id="LN608">608</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; returned_items; i++) {</td></tr>
<tr class="codeline" data-linenumber="609"><td class="num" id="LN609">609</td><td class="line">            geoPoint *gp = ga-&gt;array+i;</td></tr>
<tr class="codeline" data-linenumber="610"><td class="num" id="LN610">610</td><td class="line">            gp-&gt;dist /= conversion; <span class='comment'>/* Fix according to unit. */</span></td></tr>
<tr class="codeline" data-linenumber="611"><td class="num" id="LN611">611</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="612"><td class="num" id="LN612">612</td><td class="line">            <span class='comment'>/* If we have options in option_length, return each sub-result</span></td></tr>
<tr class="codeline" data-linenumber="613"><td class="num" id="LN613">613</td><td class="line">             <span class='comment'>* as a nested multi-bulk.  Add 1 to account for result value</span></td></tr>
<tr class="codeline" data-linenumber="614"><td class="num" id="LN614">614</td><td class="line">             <span class='comment'>* itself. */</span></td></tr>
<tr class="codeline" data-linenumber="615"><td class="num" id="LN615">615</td><td class="line">            <span class='keyword'>if</span> (option_length)</td></tr>
<tr class="codeline" data-linenumber="616"><td class="num" id="LN616">616</td><td class="line">                addReplyArrayLen(c, option_length + 1);</td></tr>
<tr class="codeline" data-linenumber="617"><td class="num" id="LN617">617</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="618"><td class="num" id="LN618">618</td><td class="line">            addReplyBulkSds(c,gp-&gt;member);</td></tr>
<tr class="codeline" data-linenumber="619"><td class="num" id="LN619">619</td><td class="line">            gp-&gt;member = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="620"><td class="num" id="LN620">620</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="621"><td class="num" id="LN621">621</td><td class="line">            <span class='keyword'>if</span> (withdist)</td></tr>
<tr class="codeline" data-linenumber="622"><td class="num" id="LN622">622</td><td class="line">                addReplyDoubleDistance(c, gp-&gt;dist);</td></tr>
<tr class="codeline" data-linenumber="623"><td class="num" id="LN623">623</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="624"><td class="num" id="LN624">624</td><td class="line">            <span class='keyword'>if</span> (withhash)</td></tr>
<tr class="codeline" data-linenumber="625"><td class="num" id="LN625">625</td><td class="line">                addReplyLongLong(c, gp-&gt;score);</td></tr>
<tr class="codeline" data-linenumber="626"><td class="num" id="LN626">626</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="627"><td class="num" id="LN627">627</td><td class="line">            <span class='keyword'>if</span> (withcoords) {</td></tr>
<tr class="codeline" data-linenumber="628"><td class="num" id="LN628">628</td><td class="line">                addReplyArrayLen(c, 2);</td></tr>
<tr class="codeline" data-linenumber="629"><td class="num" id="LN629">629</td><td class="line">                addReplyHumanLongDouble(c, gp-&gt;longitude);</td></tr>
<tr class="codeline" data-linenumber="630"><td class="num" id="LN630">630</td><td class="line">                addReplyHumanLongDouble(c, gp-&gt;latitude);</td></tr>
<tr class="codeline" data-linenumber="631"><td class="num" id="LN631">631</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="632"><td class="num" id="LN632">632</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="633"><td class="num" id="LN633">633</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="634"><td class="num" id="LN634">634</td><td class="line">        <span class='comment'>/* Target key, create a sorted set with the results. */</span></td></tr>
<tr class="codeline" data-linenumber="635"><td class="num" id="LN635">635</td><td class="line">        robj *zobj;</td></tr>
<tr class="codeline" data-linenumber="636"><td class="num" id="LN636">636</td><td class="line">        zset *zs;</td></tr>
<tr class="codeline" data-linenumber="637"><td class="num" id="LN637">637</td><td class="line">        <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="638"><td class="num" id="LN638">638</td><td class="line">        size_t maxelelen = 0;</td></tr>
<tr class="codeline" data-linenumber="639"><td class="num" id="LN639">639</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="640"><td class="num" id="LN640">640</td><td class="line">        <span class='keyword'>if</span> (returned_items) {</td></tr>
<tr class="codeline" data-linenumber="641"><td class="num" id="LN641">641</td><td class="line">            zobj = createZsetObject();</td></tr>
<tr class="codeline" data-linenumber="642"><td class="num" id="LN642">642</td><td class="line">            zs = zobj-&gt;ptr;</td></tr>
<tr class="codeline" data-linenumber="643"><td class="num" id="LN643">643</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="644"><td class="num" id="LN644">644</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="645"><td class="num" id="LN645">645</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; returned_items; i++) {</td></tr>
<tr class="codeline" data-linenumber="646"><td class="num" id="LN646">646</td><td class="line">            zskiplistNode *znode;</td></tr>
<tr class="codeline" data-linenumber="647"><td class="num" id="LN647">647</td><td class="line">            geoPoint *gp = ga-&gt;array+i;</td></tr>
<tr class="codeline" data-linenumber="648"><td class="num" id="LN648">648</td><td class="line">            gp-&gt;dist /= conversion; <span class='comment'>/* Fix according to unit. */</span></td></tr>
<tr class="codeline" data-linenumber="649"><td class="num" id="LN649">649</td><td class="line">            <span class='keyword'>double</span> score = storedist ? gp-&gt;dist : gp-&gt;score;</td></tr>
<tr class="codeline" data-linenumber="650"><td class="num" id="LN650">650</td><td class="line">            size_t elelen = sdslen(gp-&gt;member);</td></tr>
<tr class="codeline" data-linenumber="651"><td class="num" id="LN651">651</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="652"><td class="num" id="LN652">652</td><td class="line">            <span class='keyword'>if</span> (maxelelen &lt; elelen) maxelelen = elelen;</td></tr>
<tr class="codeline" data-linenumber="653"><td class="num" id="LN653">653</td><td class="line">            znode = zslInsert(zs-&gt;zsl,score,gp-&gt;member);</td></tr>
<tr class="codeline" data-linenumber="654"><td class="num" id="LN654">654</td><td class="line">            <span class='macro'>serverAssert(dictAdd(zs-&gt;dict,gp-&gt;member,&amp;znode-&gt;score) == DICT_OK)<span class='macro_popup'>((dictAdd(zs-&gt;dict,gp-&gt;member,&amp;znode-&gt;score) == 0<br>)?(void)0 : (_serverAssert("dictAdd(zs-&gt;dict,gp-&gt;member,&amp;znode-&gt;score) == DICT_OK"<br>,"geo.c",654),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="655"><td class="num" id="LN655">655</td><td class="line">            gp-&gt;member = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="656"><td class="num" id="LN656">656</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="657"><td class="num" id="LN657">657</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="658"><td class="num" id="LN658">658</td><td class="line">        <span class='keyword'>if</span> (returned_items) {</td></tr>
<tr class="codeline" data-linenumber="659"><td class="num" id="LN659">659</td><td class="line">            zsetConvertToZiplistIfNeeded(zobj,maxelelen);</td></tr>
<tr class="codeline" data-linenumber="660"><td class="num" id="LN660">660</td><td class="line">            setKey(c,c-&gt;db,storekey,zobj);</td></tr>
<tr class="codeline" data-linenumber="661"><td class="num" id="LN661">661</td><td class="line">            decrRefCount(zobj);</td></tr>
<tr class="codeline" data-linenumber="662"><td class="num" id="LN662">662</td><td class="line">            notifyKeyspaceEvent(<span class='macro'>NOTIFY_ZSET<span class='macro_popup'>(1&lt;&lt;7)</span></span>,<span class='string_literal'>"georadiusstore"</span>,storekey,</td></tr>
<tr class="codeline" data-linenumber="663"><td class="num" id="LN663">663</td><td class="line">                                c-&gt;db-&gt;id);</td></tr>
<tr class="codeline" data-linenumber="664"><td class="num" id="LN664">664</td><td class="line">            server.dirty += returned_items;</td></tr>
<tr class="codeline" data-linenumber="665"><td class="num" id="LN665">665</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (dbDelete(c-&gt;db,storekey)) {</td></tr>
<tr class="codeline" data-linenumber="666"><td class="num" id="LN666">666</td><td class="line">            signalModifiedKey(c,c-&gt;db,storekey);</td></tr>
<tr class="codeline" data-linenumber="667"><td class="num" id="LN667">667</td><td class="line">            notifyKeyspaceEvent(<span class='macro'>NOTIFY_GENERIC<span class='macro_popup'>(1&lt;&lt;2)</span></span>,<span class='string_literal'>"del"</span>,storekey,c-&gt;db-&gt;id);</td></tr>
<tr class="codeline" data-linenumber="668"><td class="num" id="LN668">668</td><td class="line">            server.dirty++;</td></tr>
<tr class="codeline" data-linenumber="669"><td class="num" id="LN669">669</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="670"><td class="num" id="LN670">670</td><td class="line">        addReplyLongLong(c, returned_items);</td></tr>
<tr class="codeline" data-linenumber="671"><td class="num" id="LN671">671</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="672"><td class="num" id="LN672">672</td><td class="line">    geoArrayFree(ga);</td></tr>
<tr class="codeline" data-linenumber="673"><td class="num" id="LN673">673</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="674"><td class="num" id="LN674">674</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="675"><td class="num" id="LN675">675</td><td class="line"><span class='comment'>/* GEORADIUS wrapper function. */</span></td></tr>
<tr class="codeline" data-linenumber="676"><td class="num" id="LN676">676</td><td class="line"><span class='keyword'>void</span> georadiusCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="677"><td class="num" id="LN677">677</td><td class="line">    georadiusGeneric(c, <span class='macro'>RADIUS_COORDS<span class='macro_popup'>(1&lt;&lt;0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="678"><td class="num" id="LN678">678</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="679"><td class="num" id="LN679">679</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="680"><td class="num" id="LN680">680</td><td class="line"><span class='comment'>/* GEORADIUSBYMEMBER wrapper function. */</span></td></tr>
<tr class="codeline" data-linenumber="681"><td class="num" id="LN681">681</td><td class="line"><span class='keyword'>void</span> georadiusbymemberCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="682"><td class="num" id="LN682">682</td><td class="line">    georadiusGeneric(c, <span class='macro'>RADIUS_MEMBER<span class='macro_popup'>(1&lt;&lt;1)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="683"><td class="num" id="LN683">683</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="684"><td class="num" id="LN684">684</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="685"><td class="num" id="LN685">685</td><td class="line"><span class='comment'>/* GEORADIUS_RO wrapper function. */</span></td></tr>
<tr class="codeline" data-linenumber="686"><td class="num" id="LN686">686</td><td class="line"><span class='keyword'>void</span> georadiusroCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="687"><td class="num" id="LN687">687</td><td class="line">    georadiusGeneric(c, <span class='macro'>RADIUS_COORDS<span class='macro_popup'>(1&lt;&lt;0)</span></span>|<span class='macro'>RADIUS_NOSTORE<span class='macro_popup'>(1&lt;&lt;2)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="688"><td class="num" id="LN688">688</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="689"><td class="num" id="LN689">689</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="690"><td class="num" id="LN690">690</td><td class="line"><span class='comment'>/* GEORADIUSBYMEMBER_RO wrapper function. */</span></td></tr>
<tr class="codeline" data-linenumber="691"><td class="num" id="LN691">691</td><td class="line"><span class='keyword'>void</span> georadiusbymemberroCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="692"><td class="num" id="LN692">692</td><td class="line">    georadiusGeneric(c, <span class='macro'>RADIUS_MEMBER<span class='macro_popup'>(1&lt;&lt;1)</span></span>|<span class='macro'>RADIUS_NOSTORE<span class='macro_popup'>(1&lt;&lt;2)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="693"><td class="num" id="LN693">693</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="694"><td class="num" id="LN694">694</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="695"><td class="num" id="LN695">695</td><td class="line"><span class='comment'>/* GEOHASH key ele1 ele2 ... eleN</span></td></tr>
<tr class="codeline" data-linenumber="696"><td class="num" id="LN696">696</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="697"><td class="num" id="LN697">697</td><td class="line"> <span class='comment'>* Returns an array with an 11 characters geohash representation of the</span></td></tr>
<tr class="codeline" data-linenumber="698"><td class="num" id="LN698">698</td><td class="line"> <span class='comment'>* position of the specified elements. */</span></td></tr>
<tr class="codeline" data-linenumber="699"><td class="num" id="LN699">699</td><td class="line"><span class='keyword'>void</span> geohashCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="700"><td class="num" id="LN700">700</td><td class="line">    <span class='keyword'>char</span> *geoalphabet= <span class='string_literal'>"0123456789bcdefghjkmnpqrstuvwxyz"</span>;</td></tr>
<tr class="codeline" data-linenumber="701"><td class="num" id="LN701">701</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="702"><td class="num" id="LN702">702</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="703"><td class="num" id="LN703">703</td><td class="line">    <span class='comment'>/* Look up the requested zset */</span></td></tr>
<tr class="codeline" data-linenumber="704"><td class="num" id="LN704">704</td><td class="line">    robj *zobj = lookupKeyRead(c-&gt;db, c-&gt;argv[1]);</td></tr>
<tr class="codeline" data-linenumber="705"><td class="num" id="LN705">705</td><td class="line">    <span class='keyword'>if</span> (zobj &amp;&amp; checkType(c, zobj, <span class='macro'>OBJ_ZSET<span class='macro_popup'>3</span></span>)) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="706"><td class="num" id="LN706">706</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="707"><td class="num" id="LN707">707</td><td class="line">    <span class='comment'>/* Geohash elements one after the other, using a null bulk reply for</span></td></tr>
<tr class="codeline" data-linenumber="708"><td class="num" id="LN708">708</td><td class="line">     <span class='comment'>* missing elements. */</span></td></tr>
<tr class="codeline" data-linenumber="709"><td class="num" id="LN709">709</td><td class="line">    addReplyArrayLen(c,c-&gt;argc-2);</td></tr>
<tr class="codeline" data-linenumber="710"><td class="num" id="LN710">710</td><td class="line">    <span class='keyword'>for</span> (j = 2; j &lt; c-&gt;argc; j++) {</td></tr>
<tr class="codeline" data-linenumber="711"><td class="num" id="LN711">711</td><td class="line">        <span class='keyword'>double</span> score;</td></tr>
<tr class="codeline" data-linenumber="712"><td class="num" id="LN712">712</td><td class="line">        <span class='keyword'>if</span> (!zobj || zsetScore(zobj, c-&gt;argv[j]-&gt;ptr, &amp;score) == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="713"><td class="num" id="LN713">713</td><td class="line">            addReplyNull(c);</td></tr>
<tr class="codeline" data-linenumber="714"><td class="num" id="LN714">714</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="715"><td class="num" id="LN715">715</td><td class="line">            <span class='comment'>/* The internal format we use for geocoding is a bit different</span></td></tr>
<tr class="codeline" data-linenumber="716"><td class="num" id="LN716">716</td><td class="line">             <span class='comment'>* than the standard, since we use as initial latitude range</span></td></tr>
<tr class="codeline" data-linenumber="717"><td class="num" id="LN717">717</td><td class="line">             <span class='comment'>* -85,85, while the normal geohashing algorithm uses -90,90.</span></td></tr>
<tr class="codeline" data-linenumber="718"><td class="num" id="LN718">718</td><td class="line">             <span class='comment'>* So we have to decode our position and re-encode using the</span></td></tr>
<tr class="codeline" data-linenumber="719"><td class="num" id="LN719">719</td><td class="line">             <span class='comment'>* standard ranges in order to output a valid geohash string. */</span></td></tr>
<tr class="codeline" data-linenumber="720"><td class="num" id="LN720">720</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="721"><td class="num" id="LN721">721</td><td class="line">            <span class='comment'>/* Decode... */</span></td></tr>
<tr class="codeline" data-linenumber="722"><td class="num" id="LN722">722</td><td class="line">            <span class='keyword'>double</span> xy[2];</td></tr>
<tr class="codeline" data-linenumber="723"><td class="num" id="LN723">723</td><td class="line">            <span class='keyword'>if</span> (!decodeGeohash(score,xy)) {</td></tr>
<tr class="codeline" data-linenumber="724"><td class="num" id="LN724">724</td><td class="line">                addReplyNull(c);</td></tr>
<tr class="codeline" data-linenumber="725"><td class="num" id="LN725">725</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="726"><td class="num" id="LN726">726</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="727"><td class="num" id="LN727">727</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="728"><td class="num" id="LN728">728</td><td class="line">            <span class='comment'>/* Re-encode */</span></td></tr>
<tr class="codeline" data-linenumber="729"><td class="num" id="LN729">729</td><td class="line">            GeoHashRange r[2];</td></tr>
<tr class="codeline" data-linenumber="730"><td class="num" id="LN730">730</td><td class="line">            GeoHashBits hash;</td></tr>
<tr class="codeline" data-linenumber="731"><td class="num" id="LN731">731</td><td class="line">            r[0].min = -180;</td></tr>
<tr class="codeline" data-linenumber="732"><td class="num" id="LN732">732</td><td class="line">            r[0].max = 180;</td></tr>
<tr class="codeline" data-linenumber="733"><td class="num" id="LN733">733</td><td class="line">            r[1].min = -90;</td></tr>
<tr class="codeline" data-linenumber="734"><td class="num" id="LN734">734</td><td class="line">            r[1].max = 90;</td></tr>
<tr class="codeline" data-linenumber="735"><td class="num" id="LN735">735</td><td class="line">            geohashEncode(&amp;r[0],&amp;r[1],xy[0],xy[1],26,&amp;hash);</td></tr>
<tr class="codeline" data-linenumber="736"><td class="num" id="LN736">736</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="737"><td class="num" id="LN737">737</td><td class="line">            <span class='keyword'>char</span> buf[12];</td></tr>
<tr class="codeline" data-linenumber="738"><td class="num" id="LN738">738</td><td class="line">            <span class='keyword'>int</span> i;</td></tr>
<tr class="codeline" data-linenumber="739"><td class="num" id="LN739">739</td><td class="line">            <span class='keyword'>for</span> (i = 0; i &lt; 11; i++) {</td></tr>
<tr class="codeline" data-linenumber="740"><td class="num" id="LN740">740</td><td class="line">                <span class='keyword'>int</span> idx;</td></tr>
<tr class="codeline" data-linenumber="741"><td class="num" id="LN741">741</td><td class="line">                <span class='keyword'>if</span> (i == 10) {</td></tr>
<tr class="codeline" data-linenumber="742"><td class="num" id="LN742">742</td><td class="line">                    <span class='comment'>/* We have just 52 bits, but the API used to output</span></td></tr>
<tr class="codeline" data-linenumber="743"><td class="num" id="LN743">743</td><td class="line">                     <span class='comment'>* an 11 bytes geohash. For compatibility we assume</span></td></tr>
<tr class="codeline" data-linenumber="744"><td class="num" id="LN744">744</td><td class="line">                     <span class='comment'>* zero. */</span></td></tr>
<tr class="codeline" data-linenumber="745"><td class="num" id="LN745">745</td><td class="line">                    idx = 0;</td></tr>
<tr class="codeline" data-linenumber="746"><td class="num" id="LN746">746</td><td class="line">                } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="747"><td class="num" id="LN747">747</td><td class="line">                    idx = (hash.bits &gt;&gt; (52-((i+1)*5))) &amp; 0x1f;</td></tr>
<tr class="codeline" data-linenumber="748"><td class="num" id="LN748">748</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="749"><td class="num" id="LN749">749</td><td class="line">                buf[i] = geoalphabet[idx];</td></tr>
<tr class="codeline" data-linenumber="750"><td class="num" id="LN750">750</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="751"><td class="num" id="LN751">751</td><td class="line">            buf[11] = '\0';</td></tr>
<tr class="codeline" data-linenumber="752"><td class="num" id="LN752">752</td><td class="line">            addReplyBulkCBuffer(c,buf,11);</td></tr>
<tr class="codeline" data-linenumber="753"><td class="num" id="LN753">753</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="754"><td class="num" id="LN754">754</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="755"><td class="num" id="LN755">755</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="756"><td class="num" id="LN756">756</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="757"><td class="num" id="LN757">757</td><td class="line"><span class='comment'>/* GEOPOS key ele1 ele2 ... eleN</span></td></tr>
<tr class="codeline" data-linenumber="758"><td class="num" id="LN758">758</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="759"><td class="num" id="LN759">759</td><td class="line"> <span class='comment'>* Returns an array of two-items arrays representing the x,y position of each</span></td></tr>
<tr class="codeline" data-linenumber="760"><td class="num" id="LN760">760</td><td class="line"> <span class='comment'>* element specified in the arguments. For missing elements NULL is returned. */</span></td></tr>
<tr class="codeline" data-linenumber="761"><td class="num" id="LN761">761</td><td class="line"><span class='keyword'>void</span> geoposCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="762"><td class="num" id="LN762">762</td><td class="line">    <span class='keyword'>int</span> j;</td></tr>
<tr class="codeline" data-linenumber="763"><td class="num" id="LN763">763</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="764"><td class="num" id="LN764">764</td><td class="line">    <span class='comment'>/* Look up the requested zset */</span></td></tr>
<tr class="codeline" data-linenumber="765"><td class="num" id="LN765">765</td><td class="line">    robj *zobj = lookupKeyRead(c-&gt;db, c-&gt;argv[1]);</td></tr>
<tr class="codeline" data-linenumber="766"><td class="num" id="LN766">766</td><td class="line">    <span class='keyword'>if</span> (zobj &amp;&amp; checkType(c, zobj, <span class='macro'>OBJ_ZSET<span class='macro_popup'>3</span></span>)) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="767"><td class="num" id="LN767">767</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="768"><td class="num" id="LN768">768</td><td class="line">    <span class='comment'>/* Report elements one after the other, using a null bulk reply for</span></td></tr>
<tr class="codeline" data-linenumber="769"><td class="num" id="LN769">769</td><td class="line">     <span class='comment'>* missing elements. */</span></td></tr>
<tr class="codeline" data-linenumber="770"><td class="num" id="LN770">770</td><td class="line">    addReplyArrayLen(c,c-&gt;argc-2);</td></tr>
<tr class="codeline" data-linenumber="771"><td class="num" id="LN771">771</td><td class="line">    <span class='keyword'>for</span> (j = 2; j &lt; c-&gt;argc; j++) {</td></tr>
<tr class="codeline" data-linenumber="772"><td class="num" id="LN772">772</td><td class="line">        <span class='keyword'>double</span> score;</td></tr>
<tr class="codeline" data-linenumber="773"><td class="num" id="LN773">773</td><td class="line">        <span class='keyword'>if</span> (!zobj || zsetScore(zobj, c-&gt;argv[j]-&gt;ptr, &amp;score) == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="774"><td class="num" id="LN774">774</td><td class="line">            addReplyNullArray(c);</td></tr>
<tr class="codeline" data-linenumber="775"><td class="num" id="LN775">775</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="776"><td class="num" id="LN776">776</td><td class="line">            <span class='comment'>/* Decode... */</span></td></tr>
<tr class="codeline" data-linenumber="777"><td class="num" id="LN777">777</td><td class="line">            <span class='keyword'>double</span> xy[2];</td></tr>
<tr class="codeline" data-linenumber="778"><td class="num" id="LN778">778</td><td class="line">            <span class='keyword'>if</span> (!decodeGeohash(score,xy)) {</td></tr>
<tr class="codeline" data-linenumber="779"><td class="num" id="LN779">779</td><td class="line">                addReplyNullArray(c);</td></tr>
<tr class="codeline" data-linenumber="780"><td class="num" id="LN780">780</td><td class="line">                <span class='keyword'>continue</span>;</td></tr>
<tr class="codeline" data-linenumber="781"><td class="num" id="LN781">781</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="782"><td class="num" id="LN782">782</td><td class="line">            addReplyArrayLen(c,2);</td></tr>
<tr class="codeline" data-linenumber="783"><td class="num" id="LN783">783</td><td class="line">            addReplyHumanLongDouble(c,xy[0]);</td></tr>
<tr class="codeline" data-linenumber="784"><td class="num" id="LN784">784</td><td class="line">            addReplyHumanLongDouble(c,xy[1]);</td></tr>
<tr class="codeline" data-linenumber="785"><td class="num" id="LN785">785</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="786"><td class="num" id="LN786">786</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="787"><td class="num" id="LN787">787</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="788"><td class="num" id="LN788">788</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="789"><td class="num" id="LN789">789</td><td class="line"><span class='comment'>/* GEODIST key ele1 ele2 [unit]</span></td></tr>
<tr class="codeline" data-linenumber="790"><td class="num" id="LN790">790</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="791"><td class="num" id="LN791">791</td><td class="line"> <span class='comment'>* Return the distance, in meters by default, otherwise according to "unit",</span></td></tr>
<tr class="codeline" data-linenumber="792"><td class="num" id="LN792">792</td><td class="line"> <span class='comment'>* between points ele1 and ele2. If one or more elements are missing NULL</span></td></tr>
<tr class="codeline" data-linenumber="793"><td class="num" id="LN793">793</td><td class="line"> <span class='comment'>* is returned. */</span></td></tr>
<tr class="codeline" data-linenumber="794"><td class="num" id="LN794">794</td><td class="line"><span class='keyword'>void</span> geodistCommand(client *c) {</td></tr>
<tr class="codeline" data-linenumber="795"><td class="num" id="LN795">795</td><td class="line">    <span class='keyword'>double</span> to_meter = 1;</td></tr>
<tr class="codeline" data-linenumber="796"><td class="num" id="LN796">796</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="797"><td class="num" id="LN797">797</td><td class="line">    <span class='comment'>/* Check if there is the unit to extract, otherwise assume meters. */</span></td></tr>
<tr class="codeline" data-linenumber="798"><td class="num" id="LN798">798</td><td class="line">    <span class='keyword'>if</span> (c-&gt;argc == 5) {</td></tr>
<tr class="codeline" data-linenumber="799"><td class="num" id="LN799">799</td><td class="line">        to_meter = extractUnitOrReply(c,c-&gt;argv[4]);</td></tr>
<tr class="codeline" data-linenumber="800"><td class="num" id="LN800">800</td><td class="line">        <span class='keyword'>if</span> (to_meter &lt; 0) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="801"><td class="num" id="LN801">801</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (c-&gt;argc &gt; 5) {</td></tr>
<tr class="codeline" data-linenumber="802"><td class="num" id="LN802">802</td><td class="line">        addReply(c,shared.syntaxerr);</td></tr>
<tr class="codeline" data-linenumber="803"><td class="num" id="LN803">803</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="804"><td class="num" id="LN804">804</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="805"><td class="num" id="LN805">805</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="806"><td class="num" id="LN806">806</td><td class="line">    <span class='comment'>/* Look up the requested zset */</span></td></tr>
<tr class="codeline" data-linenumber="807"><td class="num" id="LN807">807</td><td class="line">    robj *zobj = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="808"><td class="num" id="LN808">808</td><td class="line">    <span class='keyword'>if</span> ((zobj = lookupKeyReadOrReply(c, c-&gt;argv[1], shared.null[c-&gt;resp]))</td></tr>
<tr class="codeline" data-linenumber="809"><td class="num" id="LN809">809</td><td class="line">        == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || checkType(c, zobj, <span class='macro'>OBJ_ZSET<span class='macro_popup'>3</span></span>)) <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="810"><td class="num" id="LN810">810</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="811"><td class="num" id="LN811">811</td><td class="line">    <span class='comment'>/* Get the scores. We need both otherwise NULL is returned. */</span></td></tr>
<tr class="codeline" data-linenumber="812"><td class="num" id="LN812">812</td><td class="line">    <span class='keyword'>double</span> score1, score2, xyxy[4];</td></tr>
<tr class="codeline" data-linenumber="813"><td class="num" id="LN813">813</td><td class="line">    <span class='keyword'>if</span> (zsetScore(zobj, c-&gt;argv[2]-&gt;ptr, &amp;score1) == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span> ||</td></tr>
<tr class="codeline" data-linenumber="814"><td class="num" id="LN814">814</td><td class="line">        zsetScore(zobj, c-&gt;argv[3]-&gt;ptr, &amp;score2) == <span class='macro'>C_ERR<span class='macro_popup'>-1</span></span>)</td></tr>
<tr class="codeline" data-linenumber="815"><td class="num" id="LN815">815</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="816"><td class="num" id="LN816">816</td><td class="line">        addReplyNull(c);</td></tr>
<tr class="codeline" data-linenumber="817"><td class="num" id="LN817">817</td><td class="line">        <span class='keyword'>return</span>;</td></tr>
<tr class="codeline" data-linenumber="818"><td class="num" id="LN818">818</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="819"><td class="num" id="LN819">819</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="820"><td class="num" id="LN820">820</td><td class="line">    <span class='comment'>/* Decode &amp; compute the distance. */</span></td></tr>
<tr class="codeline" data-linenumber="821"><td class="num" id="LN821">821</td><td class="line">    <span class='keyword'>if</span> (!decodeGeohash(score1,xyxy) || !decodeGeohash(score2,xyxy+2))</td></tr>
<tr class="codeline" data-linenumber="822"><td class="num" id="LN822">822</td><td class="line">        addReplyNull(c);</td></tr>
<tr class="codeline" data-linenumber="823"><td class="num" id="LN823">823</td><td class="line">    <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="824"><td class="num" id="LN824">824</td><td class="line">        addReplyDoubleDistance(c,</td></tr>
<tr class="codeline" data-linenumber="825"><td class="num" id="LN825">825</td><td class="line">            geohashGetDistance(xyxy[0],xyxy[1],xyxy[2],xyxy[3]) / to_meter);</td></tr>
<tr class="codeline" data-linenumber="826"><td class="num" id="LN826">826</td><td class="line">}</td></tr>
</table></body></html>
