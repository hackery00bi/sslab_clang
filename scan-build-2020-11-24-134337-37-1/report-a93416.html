<!doctype html>
<html>
<head>
<title>ziplist.c</title>

<style type="text/css">
body { color:#000000; background-color:#ffffff }
body { font-family:Helvetica, sans-serif; font-size:10pt }
h1 { font-size:14pt }
.FileName { margin-top: 5px; margin-bottom: 5px; display: inline; }
.FileNav { margin-left: 5px; margin-right: 5px; display: inline; }
.FileNav a { text-decoration:none; font-size: larger; }
.divider { margin-top: 30px; margin-bottom: 30px; height: 15px; }
.divider { background-color: gray; }
.code { border-collapse:collapse; width:100%; }
.code { font-family: "Monospace", monospace; font-size:10pt }
.code { line-height: 1.2em }
.comment { color: green; font-style: oblique }
.keyword { color: blue }
.string_literal { color: red }
.directive { color: darkmagenta }

/* Macros and variables could have pop-up notes hidden by default.
  - Macro pop-up:    expansion of the macro
  - Variable pop-up: value (table) of the variable */
.macro_popup, .variable_popup { display: none; }

/* Pop-up appears on mouse-hover event. */
.macro:hover .macro_popup, .variable:hover .variable_popup {
  display: block;
  padding: 2px;
  -webkit-border-radius:5px;
  -webkit-box-shadow:1px 1px 7px #000;
  border-radius:5px;
  box-shadow:1px 1px 7px #000;
  position: absolute;
  top: -1em;
  left:10em;
  z-index: 1
}

.macro_popup {
  border: 2px solid red;
  background-color:#FFF0F0;
  font-weight: normal;
}

.variable_popup {
  border: 2px solid blue;
  background-color:#F0F0FF;
  font-weight: bold;
  font-family: Helvetica, sans-serif;
  font-size: 9pt;
}

/* Pop-up notes needs a relative position as a base where they pops up. */
.macro, .variable {
  background-color: PaleGoldenRod;
  position: relative;
}
.macro { color: DarkMagenta; }

#tooltiphint {
  position: fixed;
  width: 50em;
  margin-left: -25em;
  left: 50%;
  padding: 10px;
  border: 1px solid #b0b0b0;
  border-radius: 2px;
  box-shadow: 1px 1px 7px black;
  background-color: #c0c0c0;
  z-index: 2;
}

.num { width:2.5em; padding-right:2ex; background-color:#eeeeee }
.num { text-align:right; font-size:8pt }
.num { color:#444444 }
.line { padding-left: 1ex; border-left: 3px solid #ccc }
.line { white-space: pre }
.msg { -webkit-box-shadow:1px 1px 7px #000 }
.msg { box-shadow:1px 1px 7px #000 }
.msg { -webkit-border-radius:5px }
.msg { border-radius:5px }
.msg { font-family:Helvetica, sans-serif; font-size:8pt }
.msg { float:left }
.msg { padding:0.25em 1ex 0.25em 1ex }
.msg { margin-top:10px; margin-bottom:10px }
.msg { font-weight:bold }
.msg { max-width:60em; word-wrap: break-word; white-space: pre-wrap }
.msgT { padding:0x; spacing:0x }
.msgEvent { background-color:#fff8b4; color:#000000 }
.msgControl { background-color:#bbbbbb; color:#000000 }
.msgNote { background-color:#ddeeff; color:#000000 }
.mrange { background-color:#dfddf3 }
.mrange { border-bottom:1px solid #6F9DBE }
.PathIndex { font-weight: bold; padding:0px 5px; margin-right:5px; }
.PathIndex { -webkit-border-radius:8px }
.PathIndex { border-radius:8px }
.PathIndexEvent { background-color:#bfba87 }
.PathIndexControl { background-color:#8c8c8c }
.PathIndexPopUp { background-color: #879abc; }
.PathNav a { text-decoration:none; font-size: larger }
.CodeInsertionHint { font-weight: bold; background-color: #10dd10 }
.CodeRemovalHint { background-color:#de1010 }
.CodeRemovalHint { border-bottom:1px solid #6F9DBE }
.selected{ background-color:orange !important; }

table.simpletable {
  padding: 5px;
  font-size:12pt;
  margin:20px;
  border-collapse: collapse; border-spacing: 0px;
}
td.rowname {
  text-align: right;
  vertical-align: top;
  font-weight: bold;
  color:#444444;
  padding-right:2ex;
}

/* Hidden text. */
input.spoilerhider + label {
  cursor: pointer;
  text-decoration: underline;
  display: block;
}
input.spoilerhider {
 display: none;
}
input.spoilerhider ~ .spoiler {
  overflow: hidden;
  margin: 10px auto 0;
  height: 0;
  opacity: 0;
}
input.spoilerhider:checked + label + .spoiler{
  height: auto;
  opacity: 1;
}
</style>
</head>
<body>
<!-- BUGDESC Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11 -->

<!-- BUGTYPE Potential insecure memory buffer bounds restriction in call 'memcpy' -->

<!-- BUGCATEGORY Security -->

<!-- BUGFILE /tmp/sslab_clang/c_redis/redis/src/ziplist.c -->

<!-- FILENAME ziplist.c -->

<!-- FUNCTIONNAME zipLoadInteger -->

<!-- ISSUEHASHCONTENTOFLINEINCONTEXT 1aeab423949c1696454ff1558ec0e1cf -->

<!-- BUGLINE 557 -->

<!-- BUGCOLUMN 9 -->

<!-- BUGPATHLENGTH 1 -->

<!-- BUGMETAEND -->
<!-- REPORTHEADER -->
<h3>Bug Summary</h3>
<table class="simpletable">
<tr><td class="rowname">File:</td><td>src/ziplist.c</td></tr>
<tr><td class="rowname">Warning:</td><td><a href="#EndPath">line 557, column 9</a><br />Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11</td></tr>

</table>
<!-- REPORTSUMMARYEXTRA -->
<h3>Annotated Source Code</h3>
<p>Press <a href="#" onclick="toggleHelp(); return false;">'?'</a>
   to see keyboard shortcuts</p>
<input type="checkbox" class="spoilerhider" id="showinvocation" />
<label for="showinvocation" >Show analyzer invocation</label>
<div class="spoiler">clang -cc1 -cc1 -triple x86_64-unknown-linux-gnu -analyze -disable-free -main-file-name ziplist.c -analyzer-store=region -analyzer-opt-analyze-nested-blocks -analyzer-checker=core -analyzer-checker=apiModeling -analyzer-checker=unix -analyzer-checker=deadcode -analyzer-checker=security.insecureAPI.UncheckedReturn -analyzer-checker=security.insecureAPI.getpw -analyzer-checker=security.insecureAPI.gets -analyzer-checker=security.insecureAPI.mktemp -analyzer-checker=security.insecureAPI.mkstemp -analyzer-checker=security.insecureAPI.vfork -analyzer-checker=nullability.NullPassedToNonnull -analyzer-checker=nullability.NullReturnedFromNonnull -analyzer-output plist -w -setup-static-analyzer -mrelocation-model static -mframe-pointer=none -fmath-errno -fno-rounding-math -mconstructor-aliases -munwind-tables -target-cpu x86-64 -fno-split-dwarf-inlining -debugger-tuning=gdb -resource-dir /llvm-project/build/lib/clang/12.0.0 -D REDIS_STATIC= -I ../deps/hiredis -I ../deps/linenoise -I ../deps/lua/src -D USE_JEMALLOC -I ../deps/jemalloc/include -internal-isystem /usr/local/include -internal-isystem /llvm-project/build/lib/clang/12.0.0/include -internal-externc-isystem /usr/include/x86_64-linux-gnu -internal-externc-isystem /include -internal-externc-isystem /usr/include -O2 -Wno-missing-field-initializers -std=c11 -fdebug-compilation-dir /tmp/sslab_clang/c_redis/redis/src -ferror-limit 19 -fgnuc-version=4.2.1 -vectorize-loops -vectorize-slp -analyzer-checker core -analyzer-checker cplusplus -analyzer-checker nullability -analyzer-checker optin -analyzer-checker security -analyzer-checker unix -analyzer-checker osx -analyzer-checker fuchsia -analyzer-checker webkit -analyzer-output=html -faddrsig -o /tmp/scan-build-2020-11-24-134337-37-1 -x c ziplist.c
</div>
<div id='tooltiphint' hidden="true">
  <p>Keyboard shortcuts: </p>
  <ul>
    <li>Use 'j/k' keys for keyboard navigation</li>
    <li>Use 'Shift+S' to show/hide relevant lines</li>
    <li>Use '?' to toggle this window</li>
  </ul>
  <a href="#" onclick="toggleHelp(); return false;">Close</a>
</div>
<script type='text/javascript'>
var relevant_lines = {"1": {"557": 1}};

var filterCounterexample = function (hide) {
  var tables = document.getElementsByClassName("code");
  for (var t=0; t<tables.length; t++) {
    var table = tables[t];
    var file_id = table.getAttribute("data-fileid");
    var lines_in_fid = relevant_lines[file_id];
    if (!lines_in_fid) {
      lines_in_fid = {};
    }
    var lines = table.getElementsByClassName("codeline");
    for (var i=0; i<lines.length; i++) {
        var el = lines[i];
        var lineNo = el.getAttribute("data-linenumber");
        if (!lines_in_fid[lineNo]) {
          if (hide) {
            el.setAttribute("hidden", "");
          } else {
            el.removeAttribute("hidden");
          }
        }
    }
  }
}

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "S") {
    var checked = document.getElementsByName("showCounterexample")[0].checked;
    filterCounterexample(!checked);
    document.getElementsByName("showCounterexample")[0].checked = !checked;
  } else {
    return;
  }
  event.preventDefault();
}, true);

document.addEventListener("DOMContentLoaded", function() {
    document.querySelector('input[name="showCounterexample"]').onchange=
        function (event) {
      filterCounterexample(this.checked);
    };
});
</script>

<form>
    <input type="checkbox" name="showCounterexample" id="showCounterexample" />
    <label for="showCounterexample">
       Show only relevant lines
    </label>
</form>

<script type='text/javascript'>
var digitMatcher = new RegExp("[0-9]+");

var querySelectorAllArray = function(selector) {
  return Array.prototype.slice.call(
    document.querySelectorAll(selector));
}

document.addEventListener("DOMContentLoaded", function() {
    querySelectorAllArray(".PathNav > a").forEach(
        function(currentValue, currentIndex) {
            var hrefValue = currentValue.getAttribute("href");
            currentValue.onclick = function() {
                scrollTo(document.querySelector(hrefValue));
                return false;
            };
        });
});

var findNum = function() {
    var s = document.querySelector(".selected");
    if (!s || s.id == "EndPath") {
        return 0;
    }
    var out = parseInt(digitMatcher.exec(s.id)[0]);
    return out;
};

var scrollTo = function(el) {
    querySelectorAllArray(".selected").forEach(function(s) {
        s.classList.remove("selected");
    });
    el.classList.add("selected");
    window.scrollBy(0, el.getBoundingClientRect().top -
        (window.innerHeight / 2));
}

var move = function(num, up, numItems) {
  if (num == 1 && up || num == numItems - 1 && !up) {
    return 0;
  } else if (num == 0 && up) {
    return numItems - 1;
  } else if (num == 0 && !up) {
    return 1 % numItems;
  }
  return up ? num - 1 : num + 1;
}

var numToId = function(num) {
  if (num == 0) {
    return document.getElementById("EndPath")
  }
  return document.getElementById("Path" + num);
};

var navigateTo = function(up) {
  var numItems = document.querySelectorAll(
      ".line > .msgEvent, .line > .msgControl").length;
  var currentSelected = findNum();
  var newSelected = move(currentSelected, up, numItems);
  var newEl = numToId(newSelected, numItems);

  // Scroll element into center.
  scrollTo(newEl);
};

window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "j") {
    navigateTo(/*up=*/false);
  } else if (event.key == "k") {
    navigateTo(/*up=*/true);
  } else {
    return;
  }
  event.preventDefault();
}, true);
</script>
  
<script type='text/javascript'>

var toggleHelp = function() {
    var hint = document.querySelector("#tooltiphint");
    var attributeName = "hidden";
    if (hint.hasAttribute(attributeName)) {
      hint.removeAttribute(attributeName);
    } else {
      hint.setAttribute("hidden", "true");
    }
};
window.addEventListener("keydown", function (event) {
  if (event.defaultPrevented) {
    return;
  }
  if (event.key == "?") {
    toggleHelp();
  } else {
    return;
  }
  event.preventDefault();
});
</script>
<table class="code" data-fileid="1">
<tr class="codeline" data-linenumber="1"><td class="num" id="LN1">1</td><td class="line"><span class='comment'>/* The ziplist is a specially encoded dually linked list that is designed</span></td></tr>
<tr class="codeline" data-linenumber="2"><td class="num" id="LN2">2</td><td class="line"> <span class='comment'>* to be very memory efficient. It stores both strings and integer values,</span></td></tr>
<tr class="codeline" data-linenumber="3"><td class="num" id="LN3">3</td><td class="line"> <span class='comment'>* where integers are encoded as actual integers instead of a series of</span></td></tr>
<tr class="codeline" data-linenumber="4"><td class="num" id="LN4">4</td><td class="line"> <span class='comment'>* characters. It allows push and pop operations on either side of the list</span></td></tr>
<tr class="codeline" data-linenumber="5"><td class="num" id="LN5">5</td><td class="line"> <span class='comment'>* in O(1) time. However, because every operation requires a reallocation of</span></td></tr>
<tr class="codeline" data-linenumber="6"><td class="num" id="LN6">6</td><td class="line"> <span class='comment'>* the memory used by the ziplist, the actual complexity is related to the</span></td></tr>
<tr class="codeline" data-linenumber="7"><td class="num" id="LN7">7</td><td class="line"> <span class='comment'>* amount of memory used by the ziplist.</span></td></tr>
<tr class="codeline" data-linenumber="8"><td class="num" id="LN8">8</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="9"><td class="num" id="LN9">9</td><td class="line"> <span class='comment'>* ----------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="10"><td class="num" id="LN10">10</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="11"><td class="num" id="LN11">11</td><td class="line"> <span class='comment'>* ZIPLIST OVERALL LAYOUT</span></td></tr>
<tr class="codeline" data-linenumber="12"><td class="num" id="LN12">12</td><td class="line"> <span class='comment'>* ======================</span></td></tr>
<tr class="codeline" data-linenumber="13"><td class="num" id="LN13">13</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="14"><td class="num" id="LN14">14</td><td class="line"> <span class='comment'>* The general layout of the ziplist is as follows:</span></td></tr>
<tr class="codeline" data-linenumber="15"><td class="num" id="LN15">15</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="16"><td class="num" id="LN16">16</td><td class="line"> <span class='comment'>* &lt;zlbytes&gt; &lt;zltail&gt; &lt;zllen&gt; &lt;entry&gt; &lt;entry&gt; ... &lt;entry&gt; &lt;zlend&gt;</span></td></tr>
<tr class="codeline" data-linenumber="17"><td class="num" id="LN17">17</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="18"><td class="num" id="LN18">18</td><td class="line"> <span class='comment'>* NOTE: all fields are stored in little endian, if not specified otherwise.</span></td></tr>
<tr class="codeline" data-linenumber="19"><td class="num" id="LN19">19</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="20"><td class="num" id="LN20">20</td><td class="line"> <span class='comment'>* &lt;uint32_t zlbytes&gt; is an unsigned integer to hold the number of bytes that</span></td></tr>
<tr class="codeline" data-linenumber="21"><td class="num" id="LN21">21</td><td class="line"> <span class='comment'>* the ziplist occupies, including the four bytes of the zlbytes field itself.</span></td></tr>
<tr class="codeline" data-linenumber="22"><td class="num" id="LN22">22</td><td class="line"> <span class='comment'>* This value needs to be stored to be able to resize the entire structure</span></td></tr>
<tr class="codeline" data-linenumber="23"><td class="num" id="LN23">23</td><td class="line"> <span class='comment'>* without the need to traverse it first.</span></td></tr>
<tr class="codeline" data-linenumber="24"><td class="num" id="LN24">24</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="25"><td class="num" id="LN25">25</td><td class="line"> <span class='comment'>* &lt;uint32_t zltail&gt; is the offset to the last entry in the list. This allows</span></td></tr>
<tr class="codeline" data-linenumber="26"><td class="num" id="LN26">26</td><td class="line"> <span class='comment'>* a pop operation on the far side of the list without the need for full</span></td></tr>
<tr class="codeline" data-linenumber="27"><td class="num" id="LN27">27</td><td class="line"> <span class='comment'>* traversal.</span></td></tr>
<tr class="codeline" data-linenumber="28"><td class="num" id="LN28">28</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="29"><td class="num" id="LN29">29</td><td class="line"> <span class='comment'>* &lt;uint16_t zllen&gt; is the number of entries. When there are more than</span></td></tr>
<tr class="codeline" data-linenumber="30"><td class="num" id="LN30">30</td><td class="line"> <span class='comment'>* 2^16-2 entries, this value is set to 2^16-1 and we need to traverse the</span></td></tr>
<tr class="codeline" data-linenumber="31"><td class="num" id="LN31">31</td><td class="line"> <span class='comment'>* entire list to know how many items it holds.</span></td></tr>
<tr class="codeline" data-linenumber="32"><td class="num" id="LN32">32</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="33"><td class="num" id="LN33">33</td><td class="line"> <span class='comment'>* &lt;uint8_t zlend&gt; is a special entry representing the end of the ziplist.</span></td></tr>
<tr class="codeline" data-linenumber="34"><td class="num" id="LN34">34</td><td class="line"> <span class='comment'>* Is encoded as a single byte equal to 255. No other normal entry starts</span></td></tr>
<tr class="codeline" data-linenumber="35"><td class="num" id="LN35">35</td><td class="line"> <span class='comment'>* with a byte set to the value of 255.</span></td></tr>
<tr class="codeline" data-linenumber="36"><td class="num" id="LN36">36</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="37"><td class="num" id="LN37">37</td><td class="line"> <span class='comment'>* ZIPLIST ENTRIES</span></td></tr>
<tr class="codeline" data-linenumber="38"><td class="num" id="LN38">38</td><td class="line"> <span class='comment'>* ===============</span></td></tr>
<tr class="codeline" data-linenumber="39"><td class="num" id="LN39">39</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="40"><td class="num" id="LN40">40</td><td class="line"> <span class='comment'>* Every entry in the ziplist is prefixed by metadata that contains two pieces</span></td></tr>
<tr class="codeline" data-linenumber="41"><td class="num" id="LN41">41</td><td class="line"> <span class='comment'>* of information. First, the length of the previous entry is stored to be</span></td></tr>
<tr class="codeline" data-linenumber="42"><td class="num" id="LN42">42</td><td class="line"> <span class='comment'>* able to traverse the list from back to front. Second, the entry encoding is</span></td></tr>
<tr class="codeline" data-linenumber="43"><td class="num" id="LN43">43</td><td class="line"> <span class='comment'>* provided. It represents the entry type, integer or string, and in the case</span></td></tr>
<tr class="codeline" data-linenumber="44"><td class="num" id="LN44">44</td><td class="line"> <span class='comment'>* of strings it also represents the length of the string payload.</span></td></tr>
<tr class="codeline" data-linenumber="45"><td class="num" id="LN45">45</td><td class="line"> <span class='comment'>* So a complete entry is stored like this:</span></td></tr>
<tr class="codeline" data-linenumber="46"><td class="num" id="LN46">46</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="47"><td class="num" id="LN47">47</td><td class="line"> <span class='comment'>* &lt;prevlen&gt; &lt;encoding&gt; &lt;entry-data&gt;</span></td></tr>
<tr class="codeline" data-linenumber="48"><td class="num" id="LN48">48</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="49"><td class="num" id="LN49">49</td><td class="line"> <span class='comment'>* Sometimes the encoding represents the entry itself, like for small integers</span></td></tr>
<tr class="codeline" data-linenumber="50"><td class="num" id="LN50">50</td><td class="line"> <span class='comment'>* as we'll see later. In such a case the &lt;entry-data&gt; part is missing, and we</span></td></tr>
<tr class="codeline" data-linenumber="51"><td class="num" id="LN51">51</td><td class="line"> <span class='comment'>* could have just:</span></td></tr>
<tr class="codeline" data-linenumber="52"><td class="num" id="LN52">52</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="53"><td class="num" id="LN53">53</td><td class="line"> <span class='comment'>* &lt;prevlen&gt; &lt;encoding&gt;</span></td></tr>
<tr class="codeline" data-linenumber="54"><td class="num" id="LN54">54</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="55"><td class="num" id="LN55">55</td><td class="line"> <span class='comment'>* The length of the previous entry, &lt;prevlen&gt;, is encoded in the following way:</span></td></tr>
<tr class="codeline" data-linenumber="56"><td class="num" id="LN56">56</td><td class="line"> <span class='comment'>* If this length is smaller than 254 bytes, it will only consume a single</span></td></tr>
<tr class="codeline" data-linenumber="57"><td class="num" id="LN57">57</td><td class="line"> <span class='comment'>* byte representing the length as an unsinged 8 bit integer. When the length</span></td></tr>
<tr class="codeline" data-linenumber="58"><td class="num" id="LN58">58</td><td class="line"> <span class='comment'>* is greater than or equal to 254, it will consume 5 bytes. The first byte is</span></td></tr>
<tr class="codeline" data-linenumber="59"><td class="num" id="LN59">59</td><td class="line"> <span class='comment'>* set to 254 (FE) to indicate a larger value is following. The remaining 4</span></td></tr>
<tr class="codeline" data-linenumber="60"><td class="num" id="LN60">60</td><td class="line"> <span class='comment'>* bytes take the length of the previous entry as value.</span></td></tr>
<tr class="codeline" data-linenumber="61"><td class="num" id="LN61">61</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="62"><td class="num" id="LN62">62</td><td class="line"> <span class='comment'>* So practically an entry is encoded in the following way:</span></td></tr>
<tr class="codeline" data-linenumber="63"><td class="num" id="LN63">63</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="64"><td class="num" id="LN64">64</td><td class="line"> <span class='comment'>* &lt;prevlen from 0 to 253&gt; &lt;encoding&gt; &lt;entry&gt;</span></td></tr>
<tr class="codeline" data-linenumber="65"><td class="num" id="LN65">65</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="66"><td class="num" id="LN66">66</td><td class="line"> <span class='comment'>* Or alternatively if the previous entry length is greater than 253 bytes</span></td></tr>
<tr class="codeline" data-linenumber="67"><td class="num" id="LN67">67</td><td class="line"> <span class='comment'>* the following encoding is used:</span></td></tr>
<tr class="codeline" data-linenumber="68"><td class="num" id="LN68">68</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="69"><td class="num" id="LN69">69</td><td class="line"> <span class='comment'>* 0xFE &lt;4 bytes unsigned little endian prevlen&gt; &lt;encoding&gt; &lt;entry&gt;</span></td></tr>
<tr class="codeline" data-linenumber="70"><td class="num" id="LN70">70</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="71"><td class="num" id="LN71">71</td><td class="line"> <span class='comment'>* The encoding field of the entry depends on the content of the</span></td></tr>
<tr class="codeline" data-linenumber="72"><td class="num" id="LN72">72</td><td class="line"> <span class='comment'>* entry. When the entry is a string, the first 2 bits of the encoding first</span></td></tr>
<tr class="codeline" data-linenumber="73"><td class="num" id="LN73">73</td><td class="line"> <span class='comment'>* byte will hold the type of encoding used to store the length of the string,</span></td></tr>
<tr class="codeline" data-linenumber="74"><td class="num" id="LN74">74</td><td class="line"> <span class='comment'>* followed by the actual length of the string. When the entry is an integer</span></td></tr>
<tr class="codeline" data-linenumber="75"><td class="num" id="LN75">75</td><td class="line"> <span class='comment'>* the first 2 bits are both set to 1. The following 2 bits are used to specify</span></td></tr>
<tr class="codeline" data-linenumber="76"><td class="num" id="LN76">76</td><td class="line"> <span class='comment'>* what kind of integer will be stored after this header. An overview of the</span></td></tr>
<tr class="codeline" data-linenumber="77"><td class="num" id="LN77">77</td><td class="line"> <span class='comment'>* different types and encodings is as follows. The first byte is always enough</span></td></tr>
<tr class="codeline" data-linenumber="78"><td class="num" id="LN78">78</td><td class="line"> <span class='comment'>* to determine the kind of entry.</span></td></tr>
<tr class="codeline" data-linenumber="79"><td class="num" id="LN79">79</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="80"><td class="num" id="LN80">80</td><td class="line"> <span class='comment'>* |00pppppp| - 1 byte</span></td></tr>
<tr class="codeline" data-linenumber="81"><td class="num" id="LN81">81</td><td class="line"> <span class='comment'>*      String value with length less than or equal to 63 bytes (6 bits).</span></td></tr>
<tr class="codeline" data-linenumber="82"><td class="num" id="LN82">82</td><td class="line"> <span class='comment'>*      "pppppp" represents the unsigned 6 bit length.</span></td></tr>
<tr class="codeline" data-linenumber="83"><td class="num" id="LN83">83</td><td class="line"> <span class='comment'>* |01pppppp|qqqqqqqq| - 2 bytes</span></td></tr>
<tr class="codeline" data-linenumber="84"><td class="num" id="LN84">84</td><td class="line"> <span class='comment'>*      String value with length less than or equal to 16383 bytes (14 bits).</span></td></tr>
<tr class="codeline" data-linenumber="85"><td class="num" id="LN85">85</td><td class="line"> <span class='comment'>*      IMPORTANT: The 14 bit number is stored in big endian.</span></td></tr>
<tr class="codeline" data-linenumber="86"><td class="num" id="LN86">86</td><td class="line"> <span class='comment'>* |10000000|qqqqqqqq|rrrrrrrr|ssssssss|tttttttt| - 5 bytes</span></td></tr>
<tr class="codeline" data-linenumber="87"><td class="num" id="LN87">87</td><td class="line"> <span class='comment'>*      String value with length greater than or equal to 16384 bytes.</span></td></tr>
<tr class="codeline" data-linenumber="88"><td class="num" id="LN88">88</td><td class="line"> <span class='comment'>*      Only the 4 bytes following the first byte represents the length</span></td></tr>
<tr class="codeline" data-linenumber="89"><td class="num" id="LN89">89</td><td class="line"> <span class='comment'>*      up to 2^32-1. The 6 lower bits of the first byte are not used and</span></td></tr>
<tr class="codeline" data-linenumber="90"><td class="num" id="LN90">90</td><td class="line"> <span class='comment'>*      are set to zero.</span></td></tr>
<tr class="codeline" data-linenumber="91"><td class="num" id="LN91">91</td><td class="line"> <span class='comment'>*      IMPORTANT: The 32 bit number is stored in big endian.</span></td></tr>
<tr class="codeline" data-linenumber="92"><td class="num" id="LN92">92</td><td class="line"> <span class='comment'>* |11000000| - 3 bytes</span></td></tr>
<tr class="codeline" data-linenumber="93"><td class="num" id="LN93">93</td><td class="line"> <span class='comment'>*      Integer encoded as int16_t (2 bytes).</span></td></tr>
<tr class="codeline" data-linenumber="94"><td class="num" id="LN94">94</td><td class="line"> <span class='comment'>* |11010000| - 5 bytes</span></td></tr>
<tr class="codeline" data-linenumber="95"><td class="num" id="LN95">95</td><td class="line"> <span class='comment'>*      Integer encoded as int32_t (4 bytes).</span></td></tr>
<tr class="codeline" data-linenumber="96"><td class="num" id="LN96">96</td><td class="line"> <span class='comment'>* |11100000| - 9 bytes</span></td></tr>
<tr class="codeline" data-linenumber="97"><td class="num" id="LN97">97</td><td class="line"> <span class='comment'>*      Integer encoded as int64_t (8 bytes).</span></td></tr>
<tr class="codeline" data-linenumber="98"><td class="num" id="LN98">98</td><td class="line"> <span class='comment'>* |11110000| - 4 bytes</span></td></tr>
<tr class="codeline" data-linenumber="99"><td class="num" id="LN99">99</td><td class="line"> <span class='comment'>*      Integer encoded as 24 bit signed (3 bytes).</span></td></tr>
<tr class="codeline" data-linenumber="100"><td class="num" id="LN100">100</td><td class="line"> <span class='comment'>* |11111110| - 2 bytes</span></td></tr>
<tr class="codeline" data-linenumber="101"><td class="num" id="LN101">101</td><td class="line"> <span class='comment'>*      Integer encoded as 8 bit signed (1 byte).</span></td></tr>
<tr class="codeline" data-linenumber="102"><td class="num" id="LN102">102</td><td class="line"> <span class='comment'>* |1111xxxx| - (with xxxx between 0001 and 1101) immediate 4 bit integer.</span></td></tr>
<tr class="codeline" data-linenumber="103"><td class="num" id="LN103">103</td><td class="line"> <span class='comment'>*      Unsigned integer from 0 to 12. The encoded value is actually from</span></td></tr>
<tr class="codeline" data-linenumber="104"><td class="num" id="LN104">104</td><td class="line"> <span class='comment'>*      1 to 13 because 0000 and 1111 can not be used, so 1 should be</span></td></tr>
<tr class="codeline" data-linenumber="105"><td class="num" id="LN105">105</td><td class="line"> <span class='comment'>*      subtracted from the encoded 4 bit value to obtain the right value.</span></td></tr>
<tr class="codeline" data-linenumber="106"><td class="num" id="LN106">106</td><td class="line"> <span class='comment'>* |11111111| - End of ziplist special entry.</span></td></tr>
<tr class="codeline" data-linenumber="107"><td class="num" id="LN107">107</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="108"><td class="num" id="LN108">108</td><td class="line"> <span class='comment'>* Like for the ziplist header, all the integers are represented in little</span></td></tr>
<tr class="codeline" data-linenumber="109"><td class="num" id="LN109">109</td><td class="line"> <span class='comment'>* endian byte order, even when this code is compiled in big endian systems.</span></td></tr>
<tr class="codeline" data-linenumber="110"><td class="num" id="LN110">110</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="111"><td class="num" id="LN111">111</td><td class="line"> <span class='comment'>* EXAMPLES OF ACTUAL ZIPLISTS</span></td></tr>
<tr class="codeline" data-linenumber="112"><td class="num" id="LN112">112</td><td class="line"> <span class='comment'>* ===========================</span></td></tr>
<tr class="codeline" data-linenumber="113"><td class="num" id="LN113">113</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="114"><td class="num" id="LN114">114</td><td class="line"> <span class='comment'>* The following is a ziplist containing the two elements representing</span></td></tr>
<tr class="codeline" data-linenumber="115"><td class="num" id="LN115">115</td><td class="line"> <span class='comment'>* the strings "2" and "5". It is composed of 15 bytes, that we visually</span></td></tr>
<tr class="codeline" data-linenumber="116"><td class="num" id="LN116">116</td><td class="line"> <span class='comment'>* split into sections:</span></td></tr>
<tr class="codeline" data-linenumber="117"><td class="num" id="LN117">117</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="118"><td class="num" id="LN118">118</td><td class="line"> <span class='comment'>*  [0f 00 00 00] [0c 00 00 00] [02 00] [00 f3] [02 f6] [ff]</span></td></tr>
<tr class="codeline" data-linenumber="119"><td class="num" id="LN119">119</td><td class="line"> <span class='comment'>*        |             |          |       |       |     |</span></td></tr>
<tr class="codeline" data-linenumber="120"><td class="num" id="LN120">120</td><td class="line"> <span class='comment'>*     zlbytes        zltail    entries   "2"     "5"   end</span></td></tr>
<tr class="codeline" data-linenumber="121"><td class="num" id="LN121">121</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="122"><td class="num" id="LN122">122</td><td class="line"> <span class='comment'>* The first 4 bytes represent the number 15, that is the number of bytes</span></td></tr>
<tr class="codeline" data-linenumber="123"><td class="num" id="LN123">123</td><td class="line"> <span class='comment'>* the whole ziplist is composed of. The second 4 bytes are the offset</span></td></tr>
<tr class="codeline" data-linenumber="124"><td class="num" id="LN124">124</td><td class="line"> <span class='comment'>* at which the last ziplist entry is found, that is 12, in fact the</span></td></tr>
<tr class="codeline" data-linenumber="125"><td class="num" id="LN125">125</td><td class="line"> <span class='comment'>* last entry, that is "5", is at offset 12 inside the ziplist.</span></td></tr>
<tr class="codeline" data-linenumber="126"><td class="num" id="LN126">126</td><td class="line"> <span class='comment'>* The next 16 bit integer represents the number of elements inside the</span></td></tr>
<tr class="codeline" data-linenumber="127"><td class="num" id="LN127">127</td><td class="line"> <span class='comment'>* ziplist, its value is 2 since there are just two elements inside.</span></td></tr>
<tr class="codeline" data-linenumber="128"><td class="num" id="LN128">128</td><td class="line"> <span class='comment'>* Finally "00 f3" is the first entry representing the number 2. It is</span></td></tr>
<tr class="codeline" data-linenumber="129"><td class="num" id="LN129">129</td><td class="line"> <span class='comment'>* composed of the previous entry length, which is zero because this is</span></td></tr>
<tr class="codeline" data-linenumber="130"><td class="num" id="LN130">130</td><td class="line"> <span class='comment'>* our first entry, and the byte F3 which corresponds to the encoding</span></td></tr>
<tr class="codeline" data-linenumber="131"><td class="num" id="LN131">131</td><td class="line"> <span class='comment'>* |1111xxxx| with xxxx between 0001 and 1101. We need to remove the "F"</span></td></tr>
<tr class="codeline" data-linenumber="132"><td class="num" id="LN132">132</td><td class="line"> <span class='comment'>* higher order bits 1111, and subtract 1 from the "3", so the entry value</span></td></tr>
<tr class="codeline" data-linenumber="133"><td class="num" id="LN133">133</td><td class="line"> <span class='comment'>* is "2". The next entry has a prevlen of 02, since the first entry is</span></td></tr>
<tr class="codeline" data-linenumber="134"><td class="num" id="LN134">134</td><td class="line"> <span class='comment'>* composed of exactly two bytes. The entry itself, F6, is encoded exactly</span></td></tr>
<tr class="codeline" data-linenumber="135"><td class="num" id="LN135">135</td><td class="line"> <span class='comment'>* like the first entry, and 6-1 = 5, so the value of the entry is 5.</span></td></tr>
<tr class="codeline" data-linenumber="136"><td class="num" id="LN136">136</td><td class="line"> <span class='comment'>* Finally the special entry FF signals the end of the ziplist.</span></td></tr>
<tr class="codeline" data-linenumber="137"><td class="num" id="LN137">137</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="138"><td class="num" id="LN138">138</td><td class="line"> <span class='comment'>* Adding another element to the above string with the value "Hello World"</span></td></tr>
<tr class="codeline" data-linenumber="139"><td class="num" id="LN139">139</td><td class="line"> <span class='comment'>* allows us to show how the ziplist encodes small strings. We'll just show</span></td></tr>
<tr class="codeline" data-linenumber="140"><td class="num" id="LN140">140</td><td class="line"> <span class='comment'>* the hex dump of the entry itself. Imagine the bytes as following the</span></td></tr>
<tr class="codeline" data-linenumber="141"><td class="num" id="LN141">141</td><td class="line"> <span class='comment'>* entry that stores "5" in the ziplist above:</span></td></tr>
<tr class="codeline" data-linenumber="142"><td class="num" id="LN142">142</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="143"><td class="num" id="LN143">143</td><td class="line"> <span class='comment'>* [02] [0b] [48 65 6c 6c 6f 20 57 6f 72 6c 64]</span></td></tr>
<tr class="codeline" data-linenumber="144"><td class="num" id="LN144">144</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="145"><td class="num" id="LN145">145</td><td class="line"> <span class='comment'>* The first byte, 02, is the length of the previous entry. The next</span></td></tr>
<tr class="codeline" data-linenumber="146"><td class="num" id="LN146">146</td><td class="line"> <span class='comment'>* byte represents the encoding in the pattern |00pppppp| that means</span></td></tr>
<tr class="codeline" data-linenumber="147"><td class="num" id="LN147">147</td><td class="line"> <span class='comment'>* that the entry is a string of length &lt;pppppp&gt;, so 0B means that</span></td></tr>
<tr class="codeline" data-linenumber="148"><td class="num" id="LN148">148</td><td class="line"> <span class='comment'>* an 11 bytes string follows. From the third byte (48) to the last (64)</span></td></tr>
<tr class="codeline" data-linenumber="149"><td class="num" id="LN149">149</td><td class="line"> <span class='comment'>* there are just the ASCII characters for "Hello World".</span></td></tr>
<tr class="codeline" data-linenumber="150"><td class="num" id="LN150">150</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="151"><td class="num" id="LN151">151</td><td class="line"> <span class='comment'>* ----------------------------------------------------------------------------</span></td></tr>
<tr class="codeline" data-linenumber="152"><td class="num" id="LN152">152</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="153"><td class="num" id="LN153">153</td><td class="line"> <span class='comment'>* Copyright (c) 2009-2012, Pieter Noordhuis &lt;pcnoordhuis at gmail dot com&gt;</span></td></tr>
<tr class="codeline" data-linenumber="154"><td class="num" id="LN154">154</td><td class="line"> <span class='comment'>* Copyright (c) 2009-2017, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;</span></td></tr>
<tr class="codeline" data-linenumber="155"><td class="num" id="LN155">155</td><td class="line"> <span class='comment'>* All rights reserved.</span></td></tr>
<tr class="codeline" data-linenumber="156"><td class="num" id="LN156">156</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="157"><td class="num" id="LN157">157</td><td class="line"> <span class='comment'>* Redistribution and use in source and binary forms, with or without</span></td></tr>
<tr class="codeline" data-linenumber="158"><td class="num" id="LN158">158</td><td class="line"> <span class='comment'>* modification, are permitted provided that the following conditions are met:</span></td></tr>
<tr class="codeline" data-linenumber="159"><td class="num" id="LN159">159</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="160"><td class="num" id="LN160">160</td><td class="line"> <span class='comment'>*   * Redistributions of source code must retain the above copyright notice,</span></td></tr>
<tr class="codeline" data-linenumber="161"><td class="num" id="LN161">161</td><td class="line"> <span class='comment'>*     this list of conditions and the following disclaimer.</span></td></tr>
<tr class="codeline" data-linenumber="162"><td class="num" id="LN162">162</td><td class="line"> <span class='comment'>*   * Redistributions in binary form must reproduce the above copyright</span></td></tr>
<tr class="codeline" data-linenumber="163"><td class="num" id="LN163">163</td><td class="line"> <span class='comment'>*     notice, this list of conditions and the following disclaimer in the</span></td></tr>
<tr class="codeline" data-linenumber="164"><td class="num" id="LN164">164</td><td class="line"> <span class='comment'>*     documentation and/or other materials provided with the distribution.</span></td></tr>
<tr class="codeline" data-linenumber="165"><td class="num" id="LN165">165</td><td class="line"> <span class='comment'>*   * Neither the name of Redis nor the names of its contributors may be used</span></td></tr>
<tr class="codeline" data-linenumber="166"><td class="num" id="LN166">166</td><td class="line"> <span class='comment'>*     to endorse or promote products derived from this software without</span></td></tr>
<tr class="codeline" data-linenumber="167"><td class="num" id="LN167">167</td><td class="line"> <span class='comment'>*     specific prior written permission.</span></td></tr>
<tr class="codeline" data-linenumber="168"><td class="num" id="LN168">168</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="169"><td class="num" id="LN169">169</td><td class="line"> <span class='comment'>* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"</span></td></tr>
<tr class="codeline" data-linenumber="170"><td class="num" id="LN170">170</td><td class="line"> <span class='comment'>* AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span></td></tr>
<tr class="codeline" data-linenumber="171"><td class="num" id="LN171">171</td><td class="line"> <span class='comment'>* IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span></td></tr>
<tr class="codeline" data-linenumber="172"><td class="num" id="LN172">172</td><td class="line"> <span class='comment'>* ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span></td></tr>
<tr class="codeline" data-linenumber="173"><td class="num" id="LN173">173</td><td class="line"> <span class='comment'>* LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span></td></tr>
<tr class="codeline" data-linenumber="174"><td class="num" id="LN174">174</td><td class="line"> <span class='comment'>* CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span></td></tr>
<tr class="codeline" data-linenumber="175"><td class="num" id="LN175">175</td><td class="line"> <span class='comment'>* SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span></td></tr>
<tr class="codeline" data-linenumber="176"><td class="num" id="LN176">176</td><td class="line"> <span class='comment'>* INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span></td></tr>
<tr class="codeline" data-linenumber="177"><td class="num" id="LN177">177</td><td class="line"> <span class='comment'>* CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span></td></tr>
<tr class="codeline" data-linenumber="178"><td class="num" id="LN178">178</td><td class="line"> <span class='comment'>* ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span></td></tr>
<tr class="codeline" data-linenumber="179"><td class="num" id="LN179">179</td><td class="line"> <span class='comment'>* POSSIBILITY OF SUCH DAMAGE.</span></td></tr>
<tr class="codeline" data-linenumber="180"><td class="num" id="LN180">180</td><td class="line"> <span class='comment'>*/</span></td></tr>
<tr class="codeline" data-linenumber="181"><td class="num" id="LN181">181</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="182"><td class="num" id="LN182">182</td><td class="line"><span class='directive'>#include &lt;stdio.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="183"><td class="num" id="LN183">183</td><td class="line"><span class='directive'>#include &lt;stdlib.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="184"><td class="num" id="LN184">184</td><td class="line"><span class='directive'>#include &lt;string.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="185"><td class="num" id="LN185">185</td><td class="line"><span class='directive'>#include &lt;stdint.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="186"><td class="num" id="LN186">186</td><td class="line"><span class='directive'>#include &lt;limits.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="187"><td class="num" id="LN187">187</td><td class="line"><span class='directive'>#include "zmalloc.h"</span></td></tr>
<tr class="codeline" data-linenumber="188"><td class="num" id="LN188">188</td><td class="line"><span class='directive'>#include "util.h"</span></td></tr>
<tr class="codeline" data-linenumber="189"><td class="num" id="LN189">189</td><td class="line"><span class='directive'>#include "ziplist.h"</span></td></tr>
<tr class="codeline" data-linenumber="190"><td class="num" id="LN190">190</td><td class="line"><span class='directive'>#include "endianconv.h"</span></td></tr>
<tr class="codeline" data-linenumber="191"><td class="num" id="LN191">191</td><td class="line"><span class='directive'>#include "redisassert.h"</span></td></tr>
<tr class="codeline" data-linenumber="192"><td class="num" id="LN192">192</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="193"><td class="num" id="LN193">193</td><td class="line"><span class='directive'>#define <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span> 255         /* Special "end of ziplist" entry. */</span></td></tr>
<tr class="codeline" data-linenumber="194"><td class="num" id="LN194">194</td><td class="line"><span class='directive'>#define <span class='macro'>ZIP_BIG_PREVLEN<span class='macro_popup'>254</span></span> 254 /* ZIP_BIG_PREVLEN - 1 is the max number of bytes of</span></td></tr>
<tr class="codeline" data-linenumber="195"><td class="num" id="LN195">195</td><td class="line">                               <span class='directive'>the previous entry, for the "prevlen" field prefixing</span></td></tr>
<tr class="codeline" data-linenumber="196"><td class="num" id="LN196">196</td><td class="line">                               <span class='directive'>each entry, to be represented with just a single byte.</span></td></tr>
<tr class="codeline" data-linenumber="197"><td class="num" id="LN197">197</td><td class="line">                               <span class='directive'>Otherwise it is represented as FE AA BB CC DD, where</span></td></tr>
<tr class="codeline" data-linenumber="198"><td class="num" id="LN198">198</td><td class="line">                               <span class='directive'>AA BB CC DD are a 4 bytes unsigned integer</span></td></tr>
<tr class="codeline" data-linenumber="199"><td class="num" id="LN199">199</td><td class="line">                               <span class='directive'>representing the previous entry len. */</span></td></tr>
<tr class="codeline" data-linenumber="200"><td class="num" id="LN200">200</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="201"><td class="num" id="LN201">201</td><td class="line"><span class='comment'>/* Different encoding/length possibilities */</span></td></tr>
<tr class="codeline" data-linenumber="202"><td class="num" id="LN202">202</td><td class="line"><span class='directive'>#define <span class='macro'>ZIP_STR_MASK<span class='macro_popup'>0xc0</span></span> 0xc0</span></td></tr>
<tr class="codeline" data-linenumber="203"><td class="num" id="LN203">203</td><td class="line"><span class='directive'>#define <span class='macro'>ZIP_INT_MASK<span class='macro_popup'>0x30</span></span> 0x30</span></td></tr>
<tr class="codeline" data-linenumber="204"><td class="num" id="LN204">204</td><td class="line"><span class='directive'>#define <span class='macro'>ZIP_STR_06B<span class='macro_popup'>(0 &lt;&lt; 6)</span></span> (0 &lt;&lt; 6)</span></td></tr>
<tr class="codeline" data-linenumber="205"><td class="num" id="LN205">205</td><td class="line"><span class='directive'>#define <span class='macro'>ZIP_STR_14B<span class='macro_popup'>(1 &lt;&lt; 6)</span></span> (1 &lt;&lt; 6)</span></td></tr>
<tr class="codeline" data-linenumber="206"><td class="num" id="LN206">206</td><td class="line"><span class='directive'>#define <span class='macro'>ZIP_STR_32B<span class='macro_popup'>(2 &lt;&lt; 6)</span></span> (2 &lt;&lt; 6)</span></td></tr>
<tr class="codeline" data-linenumber="207"><td class="num" id="LN207">207</td><td class="line"><span class='directive'>#define <span class='macro'>ZIP_INT_16B<span class='macro_popup'>(0xc0 | 0&lt;&lt;4)</span></span> (0xc0 | 0&lt;&lt;4)</span></td></tr>
<tr class="codeline" data-linenumber="208"><td class="num" id="LN208">208</td><td class="line"><span class='directive'>#define <span class='macro'>ZIP_INT_32B<span class='macro_popup'>(0xc0 | 1&lt;&lt;4)</span></span> (0xc0 | 1&lt;&lt;4)</span></td></tr>
<tr class="codeline" data-linenumber="209"><td class="num" id="LN209">209</td><td class="line"><span class='directive'>#define <span class='macro'>ZIP_INT_64B<span class='macro_popup'>(0xc0 | 2&lt;&lt;4)</span></span> (0xc0 | 2&lt;&lt;4)</span></td></tr>
<tr class="codeline" data-linenumber="210"><td class="num" id="LN210">210</td><td class="line"><span class='directive'>#define <span class='macro'>ZIP_INT_24B<span class='macro_popup'>(0xc0 | 3&lt;&lt;4)</span></span> (0xc0 | 3&lt;&lt;4)</span></td></tr>
<tr class="codeline" data-linenumber="211"><td class="num" id="LN211">211</td><td class="line"><span class='directive'>#define <span class='macro'>ZIP_INT_8B<span class='macro_popup'>0xfe</span></span> 0xfe</span></td></tr>
<tr class="codeline" data-linenumber="212"><td class="num" id="LN212">212</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="213"><td class="num" id="LN213">213</td><td class="line"><span class='comment'>/* 4 bit integer immediate encoding |1111xxxx| with xxxx between</span></td></tr>
<tr class="codeline" data-linenumber="214"><td class="num" id="LN214">214</td><td class="line"> <span class='comment'>* 0001 and 1101. */</span></td></tr>
<tr class="codeline" data-linenumber="215"><td class="num" id="LN215">215</td><td class="line"><span class='directive'>#define <span class='macro'>ZIP_INT_IMM_MASK<span class='macro_popup'>0x0f</span></span> 0x0f   /* Mask to extract the 4 bits value. To add</span></td></tr>
<tr class="codeline" data-linenumber="216"><td class="num" id="LN216">216</td><td class="line">                                   <span class='directive'>one is needed to reconstruct the value. */</span></td></tr>
<tr class="codeline" data-linenumber="217"><td class="num" id="LN217">217</td><td class="line"><span class='directive'>#define <span class='macro'>ZIP_INT_IMM_MIN<span class='macro_popup'>0xf1</span></span> 0xf1    /* 11110001 */</span></td></tr>
<tr class="codeline" data-linenumber="218"><td class="num" id="LN218">218</td><td class="line"><span class='directive'>#define <span class='macro'>ZIP_INT_IMM_MAX<span class='macro_popup'>0xfd</span></span> 0xfd    /* 11111101 */</span></td></tr>
<tr class="codeline" data-linenumber="219"><td class="num" id="LN219">219</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="220"><td class="num" id="LN220">220</td><td class="line"><span class='directive'>#define <span class='macro'>INT24_MAX<span class='macro_popup'>0x7fffff</span></span> 0x7fffff</span></td></tr>
<tr class="codeline" data-linenumber="221"><td class="num" id="LN221">221</td><td class="line"><span class='directive'>#define <span class='macro'>INT24_MIN<span class='macro_popup'>(-0x7fffff - 1)</span></span> (-<span class='macro'>INT24_MAX<span class='macro_popup'>0x7fffff</span></span> - 1)</span></td></tr>
<tr class="codeline" data-linenumber="222"><td class="num" id="LN222">222</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="223"><td class="num" id="LN223">223</td><td class="line"><span class='comment'>/* Macro to determine if the entry is a string. String entries never start</span></td></tr>
<tr class="codeline" data-linenumber="224"><td class="num" id="LN224">224</td><td class="line"> <span class='comment'>* with "11" as most significant bits of the first byte. */</span></td></tr>
<tr class="codeline" data-linenumber="225"><td class="num" id="LN225">225</td><td class="line"><span class='directive'>#define <span class='macro'>ZIP_IS_STR(enc)<span class='macro_popup'>(((enc) &amp; 0xc0) &lt; 0xc0)</span></span> (((enc) &amp; <span class='macro'>ZIP_STR_MASK<span class='macro_popup'>0xc0</span></span>) &lt; <span class='macro'>ZIP_STR_MASK<span class='macro_popup'>0xc0</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="226"><td class="num" id="LN226">226</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="227"><td class="num" id="LN227">227</td><td class="line"><span class='comment'>/* Utility macros.*/</span></td></tr>
<tr class="codeline" data-linenumber="228"><td class="num" id="LN228">228</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="229"><td class="num" id="LN229">229</td><td class="line"><span class='comment'>/* Return total bytes a ziplist is composed of. */</span></td></tr>
<tr class="codeline" data-linenumber="230"><td class="num" id="LN230">230</td><td class="line"><span class='directive'>#define <span class='macro'>ZIPLIST_BYTES(zl)<span class='macro_popup'>(*((uint32_t*)(zl)))</span></span>       (*((uint32_t*)(zl)))</span></td></tr>
<tr class="codeline" data-linenumber="231"><td class="num" id="LN231">231</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="232"><td class="num" id="LN232">232</td><td class="line"><span class='comment'>/* Return the offset of the last item inside the ziplist. */</span></td></tr>
<tr class="codeline" data-linenumber="233"><td class="num" id="LN233">233</td><td class="line"><span class='directive'>#define <span class='macro'>ZIPLIST_TAIL_OFFSET(zl)<span class='macro_popup'>(*((uint32_t*)((zl)+sizeof(uint32_t))))</span></span> (*((uint32_t*)((zl)+sizeof(uint32_t))))</span></td></tr>
<tr class="codeline" data-linenumber="234"><td class="num" id="LN234">234</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="235"><td class="num" id="LN235">235</td><td class="line"><span class='comment'>/* Return the length of a ziplist, or UINT16_MAX if the length cannot be</span></td></tr>
<tr class="codeline" data-linenumber="236"><td class="num" id="LN236">236</td><td class="line"> <span class='comment'>* determined without scanning the whole ziplist. */</span></td></tr>
<tr class="codeline" data-linenumber="237"><td class="num" id="LN237">237</td><td class="line"><span class='directive'>#define <span class='macro'>ZIPLIST_LENGTH(zl)<span class='macro_popup'>(*((uint16_t*)((zl)+sizeof(uint32_t)*2)))</span></span>      (*((uint16_t*)((zl)+sizeof(uint32_t)*2)))</span></td></tr>
<tr class="codeline" data-linenumber="238"><td class="num" id="LN238">238</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="239"><td class="num" id="LN239">239</td><td class="line"><span class='comment'>/* The size of a ziplist header: two 32 bit integers for the total</span></td></tr>
<tr class="codeline" data-linenumber="240"><td class="num" id="LN240">240</td><td class="line"> <span class='comment'>* bytes count and last item offset. One 16 bit integer for the number</span></td></tr>
<tr class="codeline" data-linenumber="241"><td class="num" id="LN241">241</td><td class="line"> <span class='comment'>* of items field. */</span></td></tr>
<tr class="codeline" data-linenumber="242"><td class="num" id="LN242">242</td><td class="line"><span class='directive'>#define <span class='macro'>ZIPLIST_HEADER_SIZE<span class='macro_popup'>(sizeof(uint32_t)*2+sizeof(uint16_t))</span></span>     (sizeof(uint32_t)*2+sizeof(uint16_t))</span></td></tr>
<tr class="codeline" data-linenumber="243"><td class="num" id="LN243">243</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="244"><td class="num" id="LN244">244</td><td class="line"><span class='comment'>/* Size of the "end of ziplist" entry. Just one byte. */</span></td></tr>
<tr class="codeline" data-linenumber="245"><td class="num" id="LN245">245</td><td class="line"><span class='directive'>#define <span class='macro'>ZIPLIST_END_SIZE<span class='macro_popup'>(sizeof(uint8_t))</span></span>        (sizeof(uint8_t))</span></td></tr>
<tr class="codeline" data-linenumber="246"><td class="num" id="LN246">246</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="247"><td class="num" id="LN247">247</td><td class="line"><span class='comment'>/* Return the pointer to the first entry of a ziplist. */</span></td></tr>
<tr class="codeline" data-linenumber="248"><td class="num" id="LN248">248</td><td class="line"><span class='directive'>#define <span class='macro'>ZIPLIST_ENTRY_HEAD(zl)<span class='macro_popup'>((zl)+(sizeof(uint32_t)*2+sizeof(uint16_t)))</span></span>  ((zl)+<span class='macro'>ZIPLIST_HEADER_SIZE<span class='macro_popup'>(sizeof(uint32_t)*2+sizeof(uint16_t))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="249"><td class="num" id="LN249">249</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="250"><td class="num" id="LN250">250</td><td class="line"><span class='comment'>/* Return the pointer to the last entry of a ziplist, using the</span></td></tr>
<tr class="codeline" data-linenumber="251"><td class="num" id="LN251">251</td><td class="line"> <span class='comment'>* last entry offset inside the ziplist header. */</span></td></tr>
<tr class="codeline" data-linenumber="252"><td class="num" id="LN252">252</td><td class="line"><span class='directive'>#define <span class='macro'>ZIPLIST_ENTRY_TAIL(zl)<span class='macro_popup'>((zl)+((*((uint32_t*)((zl)+sizeof(uint32_t))))))</span></span>  ((zl)+<span class='macro'>intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))<span class='macro_popup'>((*((uint32_t*)((zl)+sizeof(uint32_t)))))</span></span>)</span></td></tr>
<tr class="codeline" data-linenumber="253"><td class="num" id="LN253">253</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="254"><td class="num" id="LN254">254</td><td class="line"><span class='comment'>/* Return the pointer to the last byte of a ziplist, which is, the</span></td></tr>
<tr class="codeline" data-linenumber="255"><td class="num" id="LN255">255</td><td class="line"> <span class='comment'>* end of ziplist FF entry. */</span></td></tr>
<tr class="codeline" data-linenumber="256"><td class="num" id="LN256">256</td><td class="line"><span class='directive'>#define <span class='macro'>ZIPLIST_ENTRY_END(zl)<span class='macro_popup'>((zl)+((*((uint32_t*)(zl))))-1)</span></span>   ((zl)+<span class='macro'>intrev32ifbe(ZIPLIST_BYTES(zl))<span class='macro_popup'>((*((uint32_t*)(zl))))</span></span>-1)</span></td></tr>
<tr class="codeline" data-linenumber="257"><td class="num" id="LN257">257</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="258"><td class="num" id="LN258">258</td><td class="line"><span class='comment'>/* Increment the number of items field in the ziplist header. Note that this</span></td></tr>
<tr class="codeline" data-linenumber="259"><td class="num" id="LN259">259</td><td class="line"> <span class='comment'>* macro should never overflow the unsigned 16 bit integer, since entries are</span></td></tr>
<tr class="codeline" data-linenumber="260"><td class="num" id="LN260">260</td><td class="line"> <span class='comment'>* always pushed one at a time. When UINT16_MAX is reached we want the count</span></td></tr>
<tr class="codeline" data-linenumber="261"><td class="num" id="LN261">261</td><td class="line"> <span class='comment'>* to stay there to signal that a full scan is needed to get the number of</span></td></tr>
<tr class="codeline" data-linenumber="262"><td class="num" id="LN262">262</td><td class="line"> <span class='comment'>* items inside the ziplist. */</span></td></tr>
<tr class="codeline" data-linenumber="263"><td class="num" id="LN263">263</td><td class="line"><span class='directive'>#define <span class='macro'>ZIPLIST_INCR_LENGTH(zl,incr)<span class='macro_popup'>{ if ((*((uint16_t*)((zl)+sizeof(uint32_t)*2))) &lt; (65535))<br> (*((uint16_t*)((zl)+sizeof(uint32_t)*2))) = (((*((uint16_t*)<br>((zl)+sizeof(uint32_t)*2))))+incr); }</span></span> { \</span></td></tr>
<tr class="codeline" data-linenumber="264"><td class="num" id="LN264">264</td><td class="line">    <span class='directive'>if (<span class='macro'>ZIPLIST_LENGTH(zl)<span class='macro_popup'>(*((uint16_t*)((zl)+sizeof(uint32_t)*2)))</span></span> &lt; <span class='macro'>UINT16_MAX<span class='macro_popup'>(65535)</span></span>) \</span></td></tr>
<tr class="codeline" data-linenumber="265"><td class="num" id="LN265">265</td><td class="line">        <span class='directive'><span class='macro'>ZIPLIST_LENGTH(zl)<span class='macro_popup'>(*((uint16_t*)((zl)+sizeof(uint32_t)*2)))</span></span> = <span class='macro'>intrev16ifbe(intrev16ifbe(ZIPLIST_LENGTH(zl))+incr)<span class='macro_popup'>(((*((uint16_t*)((zl)+sizeof(uint32_t)*2))))+incr)</span></span>; \</span></td></tr>
<tr class="codeline" data-linenumber="266"><td class="num" id="LN266">266</td><td class="line"><span class='directive'>}</span></td></tr>
<tr class="codeline" data-linenumber="267"><td class="num" id="LN267">267</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="268"><td class="num" id="LN268">268</td><td class="line"><span class='comment'>/* We use this function to receive information about a ziplist entry.</span></td></tr>
<tr class="codeline" data-linenumber="269"><td class="num" id="LN269">269</td><td class="line"> <span class='comment'>* Note that this is not how the data is actually encoded, is just what we</span></td></tr>
<tr class="codeline" data-linenumber="270"><td class="num" id="LN270">270</td><td class="line"> <span class='comment'>* get filled by a function in order to operate more easily. */</span></td></tr>
<tr class="codeline" data-linenumber="271"><td class="num" id="LN271">271</td><td class="line"><span class='keyword'>typedef</span> <span class='keyword'>struct</span> zlentry {</td></tr>
<tr class="codeline" data-linenumber="272"><td class="num" id="LN272">272</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> prevrawlensize; <span class='comment'>/* Bytes used to encode the previous entry len*/</span></td></tr>
<tr class="codeline" data-linenumber="273"><td class="num" id="LN273">273</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> prevrawlen;     <span class='comment'>/* Previous entry len. */</span></td></tr>
<tr class="codeline" data-linenumber="274"><td class="num" id="LN274">274</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> lensize;        <span class='comment'>/* Bytes used to encode this entry type/len.</span></td></tr>
<tr class="codeline" data-linenumber="275"><td class="num" id="LN275">275</td><td class="line">                                    <span class='comment'>For example strings have a 1, 2 or 5 bytes</span></td></tr>
<tr class="codeline" data-linenumber="276"><td class="num" id="LN276">276</td><td class="line">                                    <span class='comment'>header. Integers always use a single byte.*/</span></td></tr>
<tr class="codeline" data-linenumber="277"><td class="num" id="LN277">277</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> len;            <span class='comment'>/* Bytes used to represent the actual entry.</span></td></tr>
<tr class="codeline" data-linenumber="278"><td class="num" id="LN278">278</td><td class="line">                                    <span class='comment'>For strings this is just the string length</span></td></tr>
<tr class="codeline" data-linenumber="279"><td class="num" id="LN279">279</td><td class="line">                                    <span class='comment'>while for integers it is 1, 2, 3, 4, 8 or</span></td></tr>
<tr class="codeline" data-linenumber="280"><td class="num" id="LN280">280</td><td class="line">                                    <span class='comment'>0 (for 4 bit immediate) depending on the</span></td></tr>
<tr class="codeline" data-linenumber="281"><td class="num" id="LN281">281</td><td class="line">                                    <span class='comment'>number range. */</span></td></tr>
<tr class="codeline" data-linenumber="282"><td class="num" id="LN282">282</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> headersize;     <span class='comment'>/* prevrawlensize + lensize. */</span></td></tr>
<tr class="codeline" data-linenumber="283"><td class="num" id="LN283">283</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> encoding;      <span class='comment'>/* Set to ZIP_STR_* or ZIP_INT_* depending on</span></td></tr>
<tr class="codeline" data-linenumber="284"><td class="num" id="LN284">284</td><td class="line">                                    <span class='comment'>the entry encoding. However for 4 bits</span></td></tr>
<tr class="codeline" data-linenumber="285"><td class="num" id="LN285">285</td><td class="line">                                    <span class='comment'>immediate integers this can assume a range</span></td></tr>
<tr class="codeline" data-linenumber="286"><td class="num" id="LN286">286</td><td class="line">                                    <span class='comment'>of values and must be range-checked. */</span></td></tr>
<tr class="codeline" data-linenumber="287"><td class="num" id="LN287">287</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p;            <span class='comment'>/* Pointer to the very start of the entry, that</span></td></tr>
<tr class="codeline" data-linenumber="288"><td class="num" id="LN288">288</td><td class="line">                                    <span class='comment'>is, this points to prev-entry-len field. */</span></td></tr>
<tr class="codeline" data-linenumber="289"><td class="num" id="LN289">289</td><td class="line">} zlentry;</td></tr>
<tr class="codeline" data-linenumber="290"><td class="num" id="LN290">290</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="291"><td class="num" id="LN291">291</td><td class="line"><span class='directive'>#define <span class='macro'>ZIPLIST_ENTRY_ZERO(zle)<span class='macro_popup'>{ (zle)-&gt;prevrawlensize = (zle)-&gt;prevrawlen = 0; (zle)-&gt;<br>lensize = (zle)-&gt;len = (zle)-&gt;headersize = 0; (zle)-&gt;<br>encoding = 0; (zle)-&gt;p = ((void*)0); }</span></span> { \</span></td></tr>
<tr class="codeline" data-linenumber="292"><td class="num" id="LN292">292</td><td class="line">    <span class='directive'>(zle)-&gt;prevrawlensize = (zle)-&gt;prevrawlen = 0; \</span></td></tr>
<tr class="codeline" data-linenumber="293"><td class="num" id="LN293">293</td><td class="line">    <span class='directive'>(zle)-&gt;lensize = (zle)-&gt;len = (zle)-&gt;headersize = 0; \</span></td></tr>
<tr class="codeline" data-linenumber="294"><td class="num" id="LN294">294</td><td class="line">    <span class='directive'>(zle)-&gt;encoding = 0; \</span></td></tr>
<tr class="codeline" data-linenumber="295"><td class="num" id="LN295">295</td><td class="line">    <span class='directive'>(zle)-&gt;p = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>; \</span></td></tr>
<tr class="codeline" data-linenumber="296"><td class="num" id="LN296">296</td><td class="line"><span class='directive'>}</span></td></tr>
<tr class="codeline" data-linenumber="297"><td class="num" id="LN297">297</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="298"><td class="num" id="LN298">298</td><td class="line"><span class='comment'>/* Extract the encoding from the byte pointed by 'ptr' and set it into</span></td></tr>
<tr class="codeline" data-linenumber="299"><td class="num" id="LN299">299</td><td class="line"> <span class='comment'>* 'encoding' field of the zlentry structure. */</span></td></tr>
<tr class="codeline" data-linenumber="300"><td class="num" id="LN300">300</td><td class="line"><span class='directive'>#define <span class='macro'>ZIP_ENTRY_ENCODING(ptr, encoding)<span class='macro_popup'>do { (encoding) = (ptr[0]); if ((encoding) &lt; 0xc0) (encoding<br>) &amp;= 0xc0; } while(0)</span></span> do {  \</span></td></tr>
<tr class="codeline" data-linenumber="301"><td class="num" id="LN301">301</td><td class="line">    <span class='directive'>(encoding) = (ptr[0]); \</span></td></tr>
<tr class="codeline" data-linenumber="302"><td class="num" id="LN302">302</td><td class="line">    <span class='directive'>if ((encoding) &lt; <span class='macro'>ZIP_STR_MASK<span class='macro_popup'>0xc0</span></span>) (encoding) &amp;= <span class='macro'>ZIP_STR_MASK<span class='macro_popup'>0xc0</span></span>; \</span></td></tr>
<tr class="codeline" data-linenumber="303"><td class="num" id="LN303">303</td><td class="line"><span class='directive'>} while(0)</span></td></tr>
<tr class="codeline" data-linenumber="304"><td class="num" id="LN304">304</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="305"><td class="num" id="LN305">305</td><td class="line"><span class='comment'>/* Return bytes needed to store integer encoded by 'encoding'. */</span></td></tr>
<tr class="codeline" data-linenumber="306"><td class="num" id="LN306">306</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>int</span> zipIntSize(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> encoding) {</td></tr>
<tr class="codeline" data-linenumber="307"><td class="num" id="LN307">307</td><td class="line">    <span class='keyword'>switch</span>(encoding) {</td></tr>
<tr class="codeline" data-linenumber="308"><td class="num" id="LN308">308</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>ZIP_INT_8B<span class='macro_popup'>0xfe</span></span>:  <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="309"><td class="num" id="LN309">309</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>ZIP_INT_16B<span class='macro_popup'>(0xc0 | 0&lt;&lt;4)</span></span>: <span class='keyword'>return</span> 2;</td></tr>
<tr class="codeline" data-linenumber="310"><td class="num" id="LN310">310</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>ZIP_INT_24B<span class='macro_popup'>(0xc0 | 3&lt;&lt;4)</span></span>: <span class='keyword'>return</span> 3;</td></tr>
<tr class="codeline" data-linenumber="311"><td class="num" id="LN311">311</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>ZIP_INT_32B<span class='macro_popup'>(0xc0 | 1&lt;&lt;4)</span></span>: <span class='keyword'>return</span> 4;</td></tr>
<tr class="codeline" data-linenumber="312"><td class="num" id="LN312">312</td><td class="line">    <span class='keyword'>case</span> <span class='macro'>ZIP_INT_64B<span class='macro_popup'>(0xc0 | 2&lt;&lt;4)</span></span>: <span class='keyword'>return</span> 8;</td></tr>
<tr class="codeline" data-linenumber="313"><td class="num" id="LN313">313</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="314"><td class="num" id="LN314">314</td><td class="line">    <span class='keyword'>if</span> (encoding &gt;= <span class='macro'>ZIP_INT_IMM_MIN<span class='macro_popup'>0xf1</span></span> &amp;&amp; encoding &lt;= <span class='macro'>ZIP_INT_IMM_MAX<span class='macro_popup'>0xfd</span></span>)</td></tr>
<tr class="codeline" data-linenumber="315"><td class="num" id="LN315">315</td><td class="line">        <span class='keyword'>return</span> 0; <span class='comment'>/* 4 bit immediate */</span></td></tr>
<tr class="codeline" data-linenumber="316"><td class="num" id="LN316">316</td><td class="line">    <span class='macro'>panic(<span class='string_literal'>"Invalid integer encoding 0x%02X"</span>, encoding)<span class='macro_popup'>_serverPanic("ziplist.c",316,"Invalid integer encoding 0x%02X"<br>, encoding),_exit(1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="317"><td class="num" id="LN317">317</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="318"><td class="num" id="LN318">318</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="319"><td class="num" id="LN319">319</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="320"><td class="num" id="LN320">320</td><td class="line"><span class='comment'>/* Write the encoding header of the entry in 'p'. If p is NULL it just returns</span></td></tr>
<tr class="codeline" data-linenumber="321"><td class="num" id="LN321">321</td><td class="line"> <span class='comment'>* the amount of bytes required to encode such a length. Arguments:</span></td></tr>
<tr class="codeline" data-linenumber="322"><td class="num" id="LN322">322</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="323"><td class="num" id="LN323">323</td><td class="line"> <span class='comment'>* 'encoding' is the encoding we are using for the entry. It could be</span></td></tr>
<tr class="codeline" data-linenumber="324"><td class="num" id="LN324">324</td><td class="line"> <span class='comment'>* ZIP_INT_* or ZIP_STR_* or between ZIP_INT_IMM_MIN and ZIP_INT_IMM_MAX</span></td></tr>
<tr class="codeline" data-linenumber="325"><td class="num" id="LN325">325</td><td class="line"> <span class='comment'>* for single-byte small immediate integers.</span></td></tr>
<tr class="codeline" data-linenumber="326"><td class="num" id="LN326">326</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="327"><td class="num" id="LN327">327</td><td class="line"> <span class='comment'>* 'rawlen' is only used for ZIP_STR_* encodings and is the length of the</span></td></tr>
<tr class="codeline" data-linenumber="328"><td class="num" id="LN328">328</td><td class="line"> <span class='comment'>* string that this entry represents.</span></td></tr>
<tr class="codeline" data-linenumber="329"><td class="num" id="LN329">329</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="330"><td class="num" id="LN330">330</td><td class="line"> <span class='comment'>* The function returns the number of bytes used by the encoding/length</span></td></tr>
<tr class="codeline" data-linenumber="331"><td class="num" id="LN331">331</td><td class="line"> <span class='comment'>* header stored in 'p'. */</span></td></tr>
<tr class="codeline" data-linenumber="332"><td class="num" id="LN332">332</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>int</span> zipStoreEntryEncoding(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> encoding, <span class='keyword'>unsigned</span> <span class='keyword'>int</span> rawlen) {</td></tr>
<tr class="codeline" data-linenumber="333"><td class="num" id="LN333">333</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> len = 1, buf[5];</td></tr>
<tr class="codeline" data-linenumber="334"><td class="num" id="LN334">334</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="335"><td class="num" id="LN335">335</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>ZIP_IS_STR(encoding)<span class='macro_popup'>(((encoding) &amp; 0xc0) &lt; 0xc0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="336"><td class="num" id="LN336">336</td><td class="line">        <span class='comment'>/* Although encoding is given it may not be set for strings,</span></td></tr>
<tr class="codeline" data-linenumber="337"><td class="num" id="LN337">337</td><td class="line">         <span class='comment'>* so we determine it here using the raw length. */</span></td></tr>
<tr class="codeline" data-linenumber="338"><td class="num" id="LN338">338</td><td class="line">        <span class='keyword'>if</span> (rawlen &lt;= 0x3f) {</td></tr>
<tr class="codeline" data-linenumber="339"><td class="num" id="LN339">339</td><td class="line">            <span class='keyword'>if</span> (!p) <span class='keyword'>return</span> len;</td></tr>
<tr class="codeline" data-linenumber="340"><td class="num" id="LN340">340</td><td class="line">            buf[0] = <span class='macro'>ZIP_STR_06B<span class='macro_popup'>(0 &lt;&lt; 6)</span></span> | rawlen;</td></tr>
<tr class="codeline" data-linenumber="341"><td class="num" id="LN341">341</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (rawlen &lt;= 0x3fff) {</td></tr>
<tr class="codeline" data-linenumber="342"><td class="num" id="LN342">342</td><td class="line">            len += 1;</td></tr>
<tr class="codeline" data-linenumber="343"><td class="num" id="LN343">343</td><td class="line">            <span class='keyword'>if</span> (!p) <span class='keyword'>return</span> len;</td></tr>
<tr class="codeline" data-linenumber="344"><td class="num" id="LN344">344</td><td class="line">            buf[0] = <span class='macro'>ZIP_STR_14B<span class='macro_popup'>(1 &lt;&lt; 6)</span></span> | ((rawlen &gt;&gt; 8) &amp; 0x3f);</td></tr>
<tr class="codeline" data-linenumber="345"><td class="num" id="LN345">345</td><td class="line">            buf[1] = rawlen &amp; 0xff;</td></tr>
<tr class="codeline" data-linenumber="346"><td class="num" id="LN346">346</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="347"><td class="num" id="LN347">347</td><td class="line">            len += 4;</td></tr>
<tr class="codeline" data-linenumber="348"><td class="num" id="LN348">348</td><td class="line">            <span class='keyword'>if</span> (!p) <span class='keyword'>return</span> len;</td></tr>
<tr class="codeline" data-linenumber="349"><td class="num" id="LN349">349</td><td class="line">            buf[0] = <span class='macro'>ZIP_STR_32B<span class='macro_popup'>(2 &lt;&lt; 6)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="350"><td class="num" id="LN350">350</td><td class="line">            buf[1] = (rawlen &gt;&gt; 24) &amp; 0xff;</td></tr>
<tr class="codeline" data-linenumber="351"><td class="num" id="LN351">351</td><td class="line">            buf[2] = (rawlen &gt;&gt; 16) &amp; 0xff;</td></tr>
<tr class="codeline" data-linenumber="352"><td class="num" id="LN352">352</td><td class="line">            buf[3] = (rawlen &gt;&gt; 8) &amp; 0xff;</td></tr>
<tr class="codeline" data-linenumber="353"><td class="num" id="LN353">353</td><td class="line">            buf[4] = rawlen &amp; 0xff;</td></tr>
<tr class="codeline" data-linenumber="354"><td class="num" id="LN354">354</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="355"><td class="num" id="LN355">355</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="356"><td class="num" id="LN356">356</td><td class="line">        <span class='comment'>/* Implies integer encoding, so length is always 1. */</span></td></tr>
<tr class="codeline" data-linenumber="357"><td class="num" id="LN357">357</td><td class="line">        <span class='keyword'>if</span> (!p) <span class='keyword'>return</span> len;</td></tr>
<tr class="codeline" data-linenumber="358"><td class="num" id="LN358">358</td><td class="line">        buf[0] = encoding;</td></tr>
<tr class="codeline" data-linenumber="359"><td class="num" id="LN359">359</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="360"><td class="num" id="LN360">360</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="361"><td class="num" id="LN361">361</td><td class="line">    <span class='comment'>/* Store this length at p. */</span></td></tr>
<tr class="codeline" data-linenumber="362"><td class="num" id="LN362">362</td><td class="line">    memcpy(p,buf,len);</td></tr>
<tr class="codeline" data-linenumber="363"><td class="num" id="LN363">363</td><td class="line">    <span class='keyword'>return</span> len;</td></tr>
<tr class="codeline" data-linenumber="364"><td class="num" id="LN364">364</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="365"><td class="num" id="LN365">365</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="366"><td class="num" id="LN366">366</td><td class="line"><span class='comment'>/* Decode the entry encoding type and data length (string length for strings,</span></td></tr>
<tr class="codeline" data-linenumber="367"><td class="num" id="LN367">367</td><td class="line"> <span class='comment'>* number of bytes used for the integer for integer entries) encoded in 'ptr'.</span></td></tr>
<tr class="codeline" data-linenumber="368"><td class="num" id="LN368">368</td><td class="line"> <span class='comment'>* The 'encoding' variable will hold the entry encoding, the 'lensize'</span></td></tr>
<tr class="codeline" data-linenumber="369"><td class="num" id="LN369">369</td><td class="line"> <span class='comment'>* variable will hold the number of bytes required to encode the entry</span></td></tr>
<tr class="codeline" data-linenumber="370"><td class="num" id="LN370">370</td><td class="line"> <span class='comment'>* length, and the 'len' variable will hold the entry length. */</span></td></tr>
<tr class="codeline" data-linenumber="371"><td class="num" id="LN371">371</td><td class="line"><span class='directive'>#define <span class='macro'>ZIP_DECODE_LENGTH(ptr, encoding, lensize, len)<span class='macro_popup'>do { do { ((encoding)) = ((ptr)[0]); if (((encoding)) &lt; 0xc0<br>) ((encoding)) &amp;= 0xc0; } while(0); if ((encoding) &lt; 0xc0<br>) { if ((encoding) == (0 &lt;&lt; 6)) { (lensize) = 1; (len) =<br> (ptr)[0] &amp; 0x3f; } else if ((encoding) == (1 &lt;&lt; 6)<br>) { (lensize) = 2; (len) = (((ptr)[0] &amp; 0x3f) &lt;&lt; 8)<br> | (ptr)[1]; } else if ((encoding) == (2 &lt;&lt; 6)) { (lensize<br>) = 5; (len) = ((ptr)[1] &lt;&lt; 24) | ((ptr)[2] &lt;&lt; 16<br>) | ((ptr)[3] &lt;&lt; 8) | ((ptr)[4]); } else { _serverPanic<br>("ziplist.c",371,"Invalid string encoding 0x%02X", (encoding)<br>),_exit(1); } } else { (lensize) = 1; (len) = zipIntSize(encoding<br>); } } while(0)</span></span> do {                    \</span></td></tr>
<tr class="codeline" data-linenumber="372"><td class="num" id="LN372">372</td><td class="line">    <span class='directive'><span class='macro'>ZIP_ENTRY_ENCODING((ptr), (encoding))<span class='macro_popup'>do { ((encoding)) = ((ptr)[0]); if (((encoding)) &lt; 0xc0) (<br>(encoding)) &amp;= 0xc0; } while(0)</span></span>;                                     \</span></td></tr>
<tr class="codeline" data-linenumber="373"><td class="num" id="LN373">373</td><td class="line">    <span class='directive'>if ((encoding) &lt; <span class='macro'>ZIP_STR_MASK<span class='macro_popup'>0xc0</span></span>) {                                           \</span></td></tr>
<tr class="codeline" data-linenumber="374"><td class="num" id="LN374">374</td><td class="line">        <span class='directive'>if ((encoding) == <span class='macro'>ZIP_STR_06B<span class='macro_popup'>(0 &lt;&lt; 6)</span></span>) {                                       \</span></td></tr>
<tr class="codeline" data-linenumber="375"><td class="num" id="LN375">375</td><td class="line">            <span class='directive'>(lensize) = 1;                                                     \</span></td></tr>
<tr class="codeline" data-linenumber="376"><td class="num" id="LN376">376</td><td class="line">            <span class='directive'>(len) = (ptr)[0] &amp; 0x3f;                                           \</span></td></tr>
<tr class="codeline" data-linenumber="377"><td class="num" id="LN377">377</td><td class="line">        <span class='directive'>} else if ((encoding) == <span class='macro'>ZIP_STR_14B<span class='macro_popup'>(1 &lt;&lt; 6)</span></span>) {                                \</span></td></tr>
<tr class="codeline" data-linenumber="378"><td class="num" id="LN378">378</td><td class="line">            <span class='directive'>(lensize) = 2;                                                     \</span></td></tr>
<tr class="codeline" data-linenumber="379"><td class="num" id="LN379">379</td><td class="line">            <span class='directive'>(len) = (((ptr)[0] &amp; 0x3f) &lt;&lt; 8) | (ptr)[1];                       \</span></td></tr>
<tr class="codeline" data-linenumber="380"><td class="num" id="LN380">380</td><td class="line">        <span class='directive'>} else if ((encoding) == <span class='macro'>ZIP_STR_32B<span class='macro_popup'>(2 &lt;&lt; 6)</span></span>) {                                \</span></td></tr>
<tr class="codeline" data-linenumber="381"><td class="num" id="LN381">381</td><td class="line">            <span class='directive'>(lensize) = 5;                                                     \</span></td></tr>
<tr class="codeline" data-linenumber="382"><td class="num" id="LN382">382</td><td class="line">            <span class='directive'>(len) = ((ptr)[1] &lt;&lt; 24) |                                         \</span></td></tr>
<tr class="codeline" data-linenumber="383"><td class="num" id="LN383">383</td><td class="line">                    <span class='directive'>((ptr)[2] &lt;&lt; 16) |                                         \</span></td></tr>
<tr class="codeline" data-linenumber="384"><td class="num" id="LN384">384</td><td class="line">                    <span class='directive'>((ptr)[3] &lt;&lt;  8) |                                         \</span></td></tr>
<tr class="codeline" data-linenumber="385"><td class="num" id="LN385">385</td><td class="line">                    <span class='directive'>((ptr)[4]);                                                \</span></td></tr>
<tr class="codeline" data-linenumber="386"><td class="num" id="LN386">386</td><td class="line">        <span class='directive'>} else {                                                               \</span></td></tr>
<tr class="codeline" data-linenumber="387"><td class="num" id="LN387">387</td><td class="line">            <span class='directive'><span class='macro'>panic("Invalid string encoding 0x%02X", (encoding))<span class='macro_popup'>_serverPanic("ziplist.c",387,"Invalid string encoding 0x%02X"<br>, (encoding)),_exit(1)</span></span>;               \</span></td></tr>
<tr class="codeline" data-linenumber="388"><td class="num" id="LN388">388</td><td class="line">        <span class='directive'>}                                                                      \</span></td></tr>
<tr class="codeline" data-linenumber="389"><td class="num" id="LN389">389</td><td class="line">    <span class='directive'>} else {                                                                   \</span></td></tr>
<tr class="codeline" data-linenumber="390"><td class="num" id="LN390">390</td><td class="line">        <span class='directive'>(lensize) = 1;                                                         \</span></td></tr>
<tr class="codeline" data-linenumber="391"><td class="num" id="LN391">391</td><td class="line">        <span class='directive'>(len) = zipIntSize(encoding);                                          \</span></td></tr>
<tr class="codeline" data-linenumber="392"><td class="num" id="LN392">392</td><td class="line">    <span class='directive'>}                                                                          \</span></td></tr>
<tr class="codeline" data-linenumber="393"><td class="num" id="LN393">393</td><td class="line"><span class='directive'>} while(0)</span></td></tr>
<tr class="codeline" data-linenumber="394"><td class="num" id="LN394">394</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="395"><td class="num" id="LN395">395</td><td class="line"><span class='comment'>/* Encode the length of the previous entry and write it to "p". This only</span></td></tr>
<tr class="codeline" data-linenumber="396"><td class="num" id="LN396">396</td><td class="line"> <span class='comment'>* uses the larger encoding (required in __ziplistCascadeUpdate). */</span></td></tr>
<tr class="codeline" data-linenumber="397"><td class="num" id="LN397">397</td><td class="line"><span class='keyword'>int</span> zipStorePrevEntryLengthLarge(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p, <span class='keyword'>unsigned</span> <span class='keyword'>int</span> len) {</td></tr>
<tr class="codeline" data-linenumber="398"><td class="num" id="LN398">398</td><td class="line">    <span class='keyword'>if</span> (p != <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="399"><td class="num" id="LN399">399</td><td class="line">        p[0] = <span class='macro'>ZIP_BIG_PREVLEN<span class='macro_popup'>254</span></span>;</td></tr>
<tr class="codeline" data-linenumber="400"><td class="num" id="LN400">400</td><td class="line">        memcpy(p+1,&amp;len,<span class='keyword'>sizeof</span>(len));</td></tr>
<tr class="codeline" data-linenumber="401"><td class="num" id="LN401">401</td><td class="line">        <span class='macro'>memrev32ifbe(p+1)<span class='macro_popup'>((void)(0))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="402"><td class="num" id="LN402">402</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="403"><td class="num" id="LN403">403</td><td class="line">    <span class='keyword'>return</span> 1+<span class='keyword'>sizeof</span>(len);</td></tr>
<tr class="codeline" data-linenumber="404"><td class="num" id="LN404">404</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="405"><td class="num" id="LN405">405</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="406"><td class="num" id="LN406">406</td><td class="line"><span class='comment'>/* Encode the length of the previous entry and write it to "p". Return the</span></td></tr>
<tr class="codeline" data-linenumber="407"><td class="num" id="LN407">407</td><td class="line"> <span class='comment'>* number of bytes needed to encode this length if "p" is NULL. */</span></td></tr>
<tr class="codeline" data-linenumber="408"><td class="num" id="LN408">408</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>int</span> zipStorePrevEntryLength(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p, <span class='keyword'>unsigned</span> <span class='keyword'>int</span> len) {</td></tr>
<tr class="codeline" data-linenumber="409"><td class="num" id="LN409">409</td><td class="line">    <span class='keyword'>if</span> (p == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="410"><td class="num" id="LN410">410</td><td class="line">        <span class='keyword'>return</span> (len &lt; <span class='macro'>ZIP_BIG_PREVLEN<span class='macro_popup'>254</span></span>) ? 1 : <span class='keyword'>sizeof</span>(len)+1;</td></tr>
<tr class="codeline" data-linenumber="411"><td class="num" id="LN411">411</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="412"><td class="num" id="LN412">412</td><td class="line">        <span class='keyword'>if</span> (len &lt; <span class='macro'>ZIP_BIG_PREVLEN<span class='macro_popup'>254</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="413"><td class="num" id="LN413">413</td><td class="line">            p[0] = len;</td></tr>
<tr class="codeline" data-linenumber="414"><td class="num" id="LN414">414</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="415"><td class="num" id="LN415">415</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="416"><td class="num" id="LN416">416</td><td class="line">            <span class='keyword'>return</span> zipStorePrevEntryLengthLarge(p,len);</td></tr>
<tr class="codeline" data-linenumber="417"><td class="num" id="LN417">417</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="418"><td class="num" id="LN418">418</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="419"><td class="num" id="LN419">419</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="420"><td class="num" id="LN420">420</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="421"><td class="num" id="LN421">421</td><td class="line"><span class='comment'>/* Return the number of bytes used to encode the length of the previous</span></td></tr>
<tr class="codeline" data-linenumber="422"><td class="num" id="LN422">422</td><td class="line"> <span class='comment'>* entry. The length is returned by setting the var 'prevlensize'. */</span></td></tr>
<tr class="codeline" data-linenumber="423"><td class="num" id="LN423">423</td><td class="line"><span class='directive'>#define <span class='macro'>ZIP_DECODE_PREVLENSIZE(ptr, prevlensize)<span class='macro_popup'>do { if ((ptr)[0] &lt; 254) { (prevlensize) = 1; } else { (prevlensize<br>) = 5; } } while(0)</span></span> do {                          \</span></td></tr>
<tr class="codeline" data-linenumber="424"><td class="num" id="LN424">424</td><td class="line">    <span class='directive'>if ((ptr)[0] &lt; <span class='macro'>ZIP_BIG_PREVLEN<span class='macro_popup'>254</span></span>) {                                          \</span></td></tr>
<tr class="codeline" data-linenumber="425"><td class="num" id="LN425">425</td><td class="line">        <span class='directive'>(prevlensize) = 1;                                                     \</span></td></tr>
<tr class="codeline" data-linenumber="426"><td class="num" id="LN426">426</td><td class="line">    <span class='directive'>} else {                                                                   \</span></td></tr>
<tr class="codeline" data-linenumber="427"><td class="num" id="LN427">427</td><td class="line">        <span class='directive'>(prevlensize) = 5;                                                     \</span></td></tr>
<tr class="codeline" data-linenumber="428"><td class="num" id="LN428">428</td><td class="line">    <span class='directive'>}                                                                          \</span></td></tr>
<tr class="codeline" data-linenumber="429"><td class="num" id="LN429">429</td><td class="line"><span class='directive'>} while(0)</span></td></tr>
<tr class="codeline" data-linenumber="430"><td class="num" id="LN430">430</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="431"><td class="num" id="LN431">431</td><td class="line"><span class='comment'>/* Return the length of the previous element, and the number of bytes that</span></td></tr>
<tr class="codeline" data-linenumber="432"><td class="num" id="LN432">432</td><td class="line"> <span class='comment'>* are used in order to encode the previous element length.</span></td></tr>
<tr class="codeline" data-linenumber="433"><td class="num" id="LN433">433</td><td class="line"> <span class='comment'>* 'ptr' must point to the prevlen prefix of an entry (that encodes the</span></td></tr>
<tr class="codeline" data-linenumber="434"><td class="num" id="LN434">434</td><td class="line"> <span class='comment'>* length of the previous entry in order to navigate the elements backward).</span></td></tr>
<tr class="codeline" data-linenumber="435"><td class="num" id="LN435">435</td><td class="line"> <span class='comment'>* The length of the previous entry is stored in 'prevlen', the number of</span></td></tr>
<tr class="codeline" data-linenumber="436"><td class="num" id="LN436">436</td><td class="line"> <span class='comment'>* bytes needed to encode the previous entry length are stored in</span></td></tr>
<tr class="codeline" data-linenumber="437"><td class="num" id="LN437">437</td><td class="line"> <span class='comment'>* 'prevlensize'. */</span></td></tr>
<tr class="codeline" data-linenumber="438"><td class="num" id="LN438">438</td><td class="line"><span class='directive'>#define <span class='macro'>ZIP_DECODE_PREVLEN(ptr, prevlensize, prevlen)<span class='macro_popup'>do { do { if ((ptr)[0] &lt; 254) { (prevlensize) = 1; } else {<br> (prevlensize) = 5; } } while(0); if ((prevlensize) == 1) { (<br>prevlen) = (ptr)[0]; } else if ((prevlensize) == 5) { ((sizeof<br>((prevlen)) == 4)?(void)0 : (_serverAssert("sizeof((prevlen)) == 4"<br>,"ziplist.c",438),_exit(1))); memcpy(&amp;(prevlen), ((char*)<br>(ptr)) + 1, 4); ((void)(0)); } } while(0)</span></span> do {                     \</span></td></tr>
<tr class="codeline" data-linenumber="439"><td class="num" id="LN439">439</td><td class="line">    <span class='directive'><span class='macro'>ZIP_DECODE_PREVLENSIZE(ptr, prevlensize)<span class='macro_popup'>do { if ((ptr)[0] &lt; 254) { (prevlensize) = 1; } else { (prevlensize<br>) = 5; } } while(0)</span></span>;                                  \</span></td></tr>
<tr class="codeline" data-linenumber="440"><td class="num" id="LN440">440</td><td class="line">    <span class='directive'>if ((prevlensize) == 1) {                                                  \</span></td></tr>
<tr class="codeline" data-linenumber="441"><td class="num" id="LN441">441</td><td class="line">        <span class='directive'>(prevlen) = (ptr)[0];                                                  \</span></td></tr>
<tr class="codeline" data-linenumber="442"><td class="num" id="LN442">442</td><td class="line">    <span class='directive'>} else if ((prevlensize) == 5) {                                           \</span></td></tr>
<tr class="codeline" data-linenumber="443"><td class="num" id="LN443">443</td><td class="line">        <span class='directive'><span class='macro'>assert(sizeof((prevlen)) == 4)<span class='macro_popup'>((sizeof((prevlen)) == 4)?(void)0 : (_serverAssert("sizeof((prevlen)) == 4"<br>,"ziplist.c",443),_exit(1)))</span></span>;                                        \</span></td></tr>
<tr class="codeline" data-linenumber="444"><td class="num" id="LN444">444</td><td class="line">        <span class='directive'>memcpy(&amp;(prevlen), ((char*)(ptr)) + 1, 4);                             \</span></td></tr>
<tr class="codeline" data-linenumber="445"><td class="num" id="LN445">445</td><td class="line">        <span class='directive'><span class='macro'>memrev32ifbe(&amp;prevlen)<span class='macro_popup'>((void)(0))</span></span>;                                                \</span></td></tr>
<tr class="codeline" data-linenumber="446"><td class="num" id="LN446">446</td><td class="line">    <span class='directive'>}                                                                          \</span></td></tr>
<tr class="codeline" data-linenumber="447"><td class="num" id="LN447">447</td><td class="line"><span class='directive'>} while(0)</span></td></tr>
<tr class="codeline" data-linenumber="448"><td class="num" id="LN448">448</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="449"><td class="num" id="LN449">449</td><td class="line"><span class='comment'>/* Given a pointer 'p' to the prevlen info that prefixes an entry, this</span></td></tr>
<tr class="codeline" data-linenumber="450"><td class="num" id="LN450">450</td><td class="line"> <span class='comment'>* function returns the difference in number of bytes needed to encode</span></td></tr>
<tr class="codeline" data-linenumber="451"><td class="num" id="LN451">451</td><td class="line"> <span class='comment'>* the prevlen if the previous entry changes of size.</span></td></tr>
<tr class="codeline" data-linenumber="452"><td class="num" id="LN452">452</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="453"><td class="num" id="LN453">453</td><td class="line"> <span class='comment'>* So if A is the number of bytes used right now to encode the 'prevlen'</span></td></tr>
<tr class="codeline" data-linenumber="454"><td class="num" id="LN454">454</td><td class="line"> <span class='comment'>* field.</span></td></tr>
<tr class="codeline" data-linenumber="455"><td class="num" id="LN455">455</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="456"><td class="num" id="LN456">456</td><td class="line"> <span class='comment'>* And B is the number of bytes that are needed in order to encode the</span></td></tr>
<tr class="codeline" data-linenumber="457"><td class="num" id="LN457">457</td><td class="line"> <span class='comment'>* 'prevlen' if the previous element will be updated to one of size 'len'.</span></td></tr>
<tr class="codeline" data-linenumber="458"><td class="num" id="LN458">458</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="459"><td class="num" id="LN459">459</td><td class="line"> <span class='comment'>* Then the function returns B - A</span></td></tr>
<tr class="codeline" data-linenumber="460"><td class="num" id="LN460">460</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="461"><td class="num" id="LN461">461</td><td class="line"> <span class='comment'>* So the function returns a positive number if more space is needed,</span></td></tr>
<tr class="codeline" data-linenumber="462"><td class="num" id="LN462">462</td><td class="line"> <span class='comment'>* a negative number if less space is needed, or zero if the same space</span></td></tr>
<tr class="codeline" data-linenumber="463"><td class="num" id="LN463">463</td><td class="line"> <span class='comment'>* is needed. */</span></td></tr>
<tr class="codeline" data-linenumber="464"><td class="num" id="LN464">464</td><td class="line"><span class='keyword'>int</span> zipPrevLenByteDiff(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p, <span class='keyword'>unsigned</span> <span class='keyword'>int</span> len) {</td></tr>
<tr class="codeline" data-linenumber="465"><td class="num" id="LN465">465</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> prevlensize;</td></tr>
<tr class="codeline" data-linenumber="466"><td class="num" id="LN466">466</td><td class="line">    <span class='macro'>ZIP_DECODE_PREVLENSIZE(p, prevlensize)<span class='macro_popup'>do { if ((p)[0] &lt; 254) { (prevlensize) = 1; } else { (prevlensize<br>) = 5; } } while(0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="467"><td class="num" id="LN467">467</td><td class="line">    <span class='keyword'>return</span> zipStorePrevEntryLength(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>, len) - prevlensize;</td></tr>
<tr class="codeline" data-linenumber="468"><td class="num" id="LN468">468</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="469"><td class="num" id="LN469">469</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="470"><td class="num" id="LN470">470</td><td class="line"><span class='comment'>/* Return the total number of bytes used by the entry pointed to by 'p'. */</span></td></tr>
<tr class="codeline" data-linenumber="471"><td class="num" id="LN471">471</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>int</span> zipRawEntryLength(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p) {</td></tr>
<tr class="codeline" data-linenumber="472"><td class="num" id="LN472">472</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> prevlensize, encoding, lensize, len;</td></tr>
<tr class="codeline" data-linenumber="473"><td class="num" id="LN473">473</td><td class="line">    <span class='macro'>ZIP_DECODE_PREVLENSIZE(p, prevlensize)<span class='macro_popup'>do { if ((p)[0] &lt; 254) { (prevlensize) = 1; } else { (prevlensize<br>) = 5; } } while(0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="474"><td class="num" id="LN474">474</td><td class="line">    <span class='macro'>ZIP_DECODE_LENGTH(p + prevlensize, encoding, lensize, len)<span class='macro_popup'>do { do { ((encoding)) = ((p + prevlensize)[0]); if (((encoding<br>)) &lt; 0xc0) ((encoding)) &amp;= 0xc0; } while(0); if ((encoding<br>) &lt; 0xc0) { if ((encoding) == (0 &lt;&lt; 6)) { (lensize) =<br> 1; (len) = (p + prevlensize)[0] &amp; 0x3f; } else if ((encoding<br>) == (1 &lt;&lt; 6)) { (lensize) = 2; (len) = (((p + prevlensize<br>)[0] &amp; 0x3f) &lt;&lt; 8) | (p + prevlensize)[1]; } else if<br> ((encoding) == (2 &lt;&lt; 6)) { (lensize) = 5; (len) = ((p +<br> prevlensize)[1] &lt;&lt; 24) | ((p + prevlensize)[2] &lt;&lt;<br> 16) | ((p + prevlensize)[3] &lt;&lt; 8) | ((p + prevlensize)<br>[4]); } else { _serverPanic("ziplist.c",474,"Invalid string encoding 0x%02X"<br>, (encoding)),_exit(1); } } else { (lensize) = 1; (len) = zipIntSize<br>(encoding); } } while(0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="475"><td class="num" id="LN475">475</td><td class="line">    <span class='keyword'>return</span> prevlensize + lensize + len;</td></tr>
<tr class="codeline" data-linenumber="476"><td class="num" id="LN476">476</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="477"><td class="num" id="LN477">477</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="478"><td class="num" id="LN478">478</td><td class="line"><span class='comment'>/* Check if string pointed to by 'entry' can be encoded as an integer.</span></td></tr>
<tr class="codeline" data-linenumber="479"><td class="num" id="LN479">479</td><td class="line"> <span class='comment'>* Stores the integer value in 'v' and its encoding in 'encoding'. */</span></td></tr>
<tr class="codeline" data-linenumber="480"><td class="num" id="LN480">480</td><td class="line"><span class='keyword'>int</span> zipTryEncoding(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *entry, <span class='keyword'>unsigned</span> <span class='keyword'>int</span> entrylen, <span class='keyword'>long</span> <span class='keyword'>long</span> *v, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *encoding) {</td></tr>
<tr class="codeline" data-linenumber="481"><td class="num" id="LN481">481</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> value;</td></tr>
<tr class="codeline" data-linenumber="482"><td class="num" id="LN482">482</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="483"><td class="num" id="LN483">483</td><td class="line">    <span class='keyword'>if</span> (entrylen &gt;= 32 || entrylen == 0) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="484"><td class="num" id="LN484">484</td><td class="line">    <span class='keyword'>if</span> (string2ll((<span class='keyword'>char</span>*)entry,entrylen,&amp;value)) {</td></tr>
<tr class="codeline" data-linenumber="485"><td class="num" id="LN485">485</td><td class="line">        <span class='comment'>/* Great, the string can be encoded. Check what's the smallest</span></td></tr>
<tr class="codeline" data-linenumber="486"><td class="num" id="LN486">486</td><td class="line">         <span class='comment'>* of our encoding types that can hold this value. */</span></td></tr>
<tr class="codeline" data-linenumber="487"><td class="num" id="LN487">487</td><td class="line">        <span class='keyword'>if</span> (value &gt;= 0 &amp;&amp; value &lt;= 12) {</td></tr>
<tr class="codeline" data-linenumber="488"><td class="num" id="LN488">488</td><td class="line">            *encoding = <span class='macro'>ZIP_INT_IMM_MIN<span class='macro_popup'>0xf1</span></span>+value;</td></tr>
<tr class="codeline" data-linenumber="489"><td class="num" id="LN489">489</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (value &gt;= <span class='macro'>INT8_MIN<span class='macro_popup'>(-128)</span></span> &amp;&amp; value &lt;= <span class='macro'>INT8_MAX<span class='macro_popup'>(127)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="490"><td class="num" id="LN490">490</td><td class="line">            *encoding = <span class='macro'>ZIP_INT_8B<span class='macro_popup'>0xfe</span></span>;</td></tr>
<tr class="codeline" data-linenumber="491"><td class="num" id="LN491">491</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (value &gt;= <span class='macro'>INT16_MIN<span class='macro_popup'>(-32767-1)</span></span> &amp;&amp; value &lt;= <span class='macro'>INT16_MAX<span class='macro_popup'>(32767)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="492"><td class="num" id="LN492">492</td><td class="line">            *encoding = <span class='macro'>ZIP_INT_16B<span class='macro_popup'>(0xc0 | 0&lt;&lt;4)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="493"><td class="num" id="LN493">493</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (value &gt;= <span class='macro'>INT24_MIN<span class='macro_popup'>(-0x7fffff - 1)</span></span> &amp;&amp; value &lt;= <span class='macro'>INT24_MAX<span class='macro_popup'>0x7fffff</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="494"><td class="num" id="LN494">494</td><td class="line">            *encoding = <span class='macro'>ZIP_INT_24B<span class='macro_popup'>(0xc0 | 3&lt;&lt;4)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="495"><td class="num" id="LN495">495</td><td class="line">        } <span class='keyword'>else</span> <span class='keyword'>if</span> (value &gt;= <span class='macro'>INT32_MIN<span class='macro_popup'>(-2147483647-1)</span></span> &amp;&amp; value &lt;= <span class='macro'>INT32_MAX<span class='macro_popup'>(2147483647)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="496"><td class="num" id="LN496">496</td><td class="line">            *encoding = <span class='macro'>ZIP_INT_32B<span class='macro_popup'>(0xc0 | 1&lt;&lt;4)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="497"><td class="num" id="LN497">497</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="498"><td class="num" id="LN498">498</td><td class="line">            *encoding = <span class='macro'>ZIP_INT_64B<span class='macro_popup'>(0xc0 | 2&lt;&lt;4)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="499"><td class="num" id="LN499">499</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="500"><td class="num" id="LN500">500</td><td class="line">        *v = value;</td></tr>
<tr class="codeline" data-linenumber="501"><td class="num" id="LN501">501</td><td class="line">        <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="502"><td class="num" id="LN502">502</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="503"><td class="num" id="LN503">503</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="504"><td class="num" id="LN504">504</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="505"><td class="num" id="LN505">505</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="506"><td class="num" id="LN506">506</td><td class="line"><span class='comment'>/* Store integer 'value' at 'p', encoded as 'encoding' */</span></td></tr>
<tr class="codeline" data-linenumber="507"><td class="num" id="LN507">507</td><td class="line"><span class='keyword'>void</span> zipSaveInteger(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p, int64_t value, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> encoding) {</td></tr>
<tr class="codeline" data-linenumber="508"><td class="num" id="LN508">508</td><td class="line">    int16_t i16;</td></tr>
<tr class="codeline" data-linenumber="509"><td class="num" id="LN509">509</td><td class="line">    int32_t i32;</td></tr>
<tr class="codeline" data-linenumber="510"><td class="num" id="LN510">510</td><td class="line">    int64_t i64;</td></tr>
<tr class="codeline" data-linenumber="511"><td class="num" id="LN511">511</td><td class="line">    <span class='keyword'>if</span> (encoding == <span class='macro'>ZIP_INT_8B<span class='macro_popup'>0xfe</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="512"><td class="num" id="LN512">512</td><td class="line">        ((int8_t*)p)[0] = (int8_t)value;</td></tr>
<tr class="codeline" data-linenumber="513"><td class="num" id="LN513">513</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (encoding == <span class='macro'>ZIP_INT_16B<span class='macro_popup'>(0xc0 | 0&lt;&lt;4)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="514"><td class="num" id="LN514">514</td><td class="line">        i16 = value;</td></tr>
<tr class="codeline" data-linenumber="515"><td class="num" id="LN515">515</td><td class="line">        memcpy(p,&amp;i16,<span class='keyword'>sizeof</span>(i16));</td></tr>
<tr class="codeline" data-linenumber="516"><td class="num" id="LN516">516</td><td class="line">        <span class='macro'>memrev16ifbe(p)<span class='macro_popup'>((void)(0))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="517"><td class="num" id="LN517">517</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (encoding == <span class='macro'>ZIP_INT_24B<span class='macro_popup'>(0xc0 | 3&lt;&lt;4)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="518"><td class="num" id="LN518">518</td><td class="line">        i32 = value&lt;&lt;8;</td></tr>
<tr class="codeline" data-linenumber="519"><td class="num" id="LN519">519</td><td class="line">        <span class='macro'>memrev32ifbe(&amp;i32)<span class='macro_popup'>((void)(0))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="520"><td class="num" id="LN520">520</td><td class="line">        memcpy(p,((uint8_t*)&amp;i32)+1,<span class='keyword'>sizeof</span>(i32)-<span class='keyword'>sizeof</span>(uint8_t));</td></tr>
<tr class="codeline" data-linenumber="521"><td class="num" id="LN521">521</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (encoding == <span class='macro'>ZIP_INT_32B<span class='macro_popup'>(0xc0 | 1&lt;&lt;4)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="522"><td class="num" id="LN522">522</td><td class="line">        i32 = value;</td></tr>
<tr class="codeline" data-linenumber="523"><td class="num" id="LN523">523</td><td class="line">        memcpy(p,&amp;i32,<span class='keyword'>sizeof</span>(i32));</td></tr>
<tr class="codeline" data-linenumber="524"><td class="num" id="LN524">524</td><td class="line">        <span class='macro'>memrev32ifbe(p)<span class='macro_popup'>((void)(0))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="525"><td class="num" id="LN525">525</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (encoding == <span class='macro'>ZIP_INT_64B<span class='macro_popup'>(0xc0 | 2&lt;&lt;4)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="526"><td class="num" id="LN526">526</td><td class="line">        i64 = value;</td></tr>
<tr class="codeline" data-linenumber="527"><td class="num" id="LN527">527</td><td class="line">        memcpy(p,&amp;i64,<span class='keyword'>sizeof</span>(i64));</td></tr>
<tr class="codeline" data-linenumber="528"><td class="num" id="LN528">528</td><td class="line">        <span class='macro'>memrev64ifbe(p)<span class='macro_popup'>((void)(0))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="529"><td class="num" id="LN529">529</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (encoding &gt;= <span class='macro'>ZIP_INT_IMM_MIN<span class='macro_popup'>0xf1</span></span> &amp;&amp; encoding &lt;= <span class='macro'>ZIP_INT_IMM_MAX<span class='macro_popup'>0xfd</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="530"><td class="num" id="LN530">530</td><td class="line">        <span class='comment'>/* Nothing to do, the value is stored in the encoding itself. */</span></td></tr>
<tr class="codeline" data-linenumber="531"><td class="num" id="LN531">531</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="532"><td class="num" id="LN532">532</td><td class="line">        <span class='macro'>assert(NULL)<span class='macro_popup'>((((void*)0))?(void)0 : (_serverAssert("NULL","ziplist.c",532<br>),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="533"><td class="num" id="LN533">533</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="534"><td class="num" id="LN534">534</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="535"><td class="num" id="LN535">535</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="536"><td class="num" id="LN536">536</td><td class="line"><span class='comment'>/* Read integer encoded as 'encoding' from 'p' */</span></td></tr>
<tr class="codeline" data-linenumber="537"><td class="num" id="LN537">537</td><td class="line">int64_t zipLoadInteger(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> encoding) {</td></tr>
<tr class="codeline" data-linenumber="538"><td class="num" id="LN538">538</td><td class="line">    int16_t i16;</td></tr>
<tr class="codeline" data-linenumber="539"><td class="num" id="LN539">539</td><td class="line">    int32_t i32;</td></tr>
<tr class="codeline" data-linenumber="540"><td class="num" id="LN540">540</td><td class="line">    int64_t i64, ret = 0;</td></tr>
<tr class="codeline" data-linenumber="541"><td class="num" id="LN541">541</td><td class="line">    <span class='keyword'>if</span> (encoding == <span class='macro'>ZIP_INT_8B<span class='macro_popup'>0xfe</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="542"><td class="num" id="LN542">542</td><td class="line">        ret = ((int8_t*)p)[0];</td></tr>
<tr class="codeline" data-linenumber="543"><td class="num" id="LN543">543</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (encoding == <span class='macro'>ZIP_INT_16B<span class='macro_popup'>(0xc0 | 0&lt;&lt;4)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="544"><td class="num" id="LN544">544</td><td class="line">        memcpy(&amp;i16,p,<span class='keyword'>sizeof</span>(i16));</td></tr>
<tr class="codeline" data-linenumber="545"><td class="num" id="LN545">545</td><td class="line">        <span class='macro'>memrev16ifbe(&amp;i16)<span class='macro_popup'>((void)(0))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="546"><td class="num" id="LN546">546</td><td class="line">        ret = i16;</td></tr>
<tr class="codeline" data-linenumber="547"><td class="num" id="LN547">547</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (encoding == <span class='macro'>ZIP_INT_32B<span class='macro_popup'>(0xc0 | 1&lt;&lt;4)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="548"><td class="num" id="LN548">548</td><td class="line">        memcpy(&amp;i32,p,<span class='keyword'>sizeof</span>(i32));</td></tr>
<tr class="codeline" data-linenumber="549"><td class="num" id="LN549">549</td><td class="line">        <span class='macro'>memrev32ifbe(&amp;i32)<span class='macro_popup'>((void)(0))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="550"><td class="num" id="LN550">550</td><td class="line">        ret = i32;</td></tr>
<tr class="codeline" data-linenumber="551"><td class="num" id="LN551">551</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (encoding == <span class='macro'>ZIP_INT_24B<span class='macro_popup'>(0xc0 | 3&lt;&lt;4)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="552"><td class="num" id="LN552">552</td><td class="line">        i32 = 0;</td></tr>
<tr class="codeline" data-linenumber="553"><td class="num" id="LN553">553</td><td class="line">        memcpy(((uint8_t*)&amp;i32)+1,p,<span class='keyword'>sizeof</span>(i32)-<span class='keyword'>sizeof</span>(uint8_t));</td></tr>
<tr class="codeline" data-linenumber="554"><td class="num" id="LN554">554</td><td class="line">        <span class='macro'>memrev32ifbe(&amp;i32)<span class='macro_popup'>((void)(0))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="555"><td class="num" id="LN555">555</td><td class="line">        ret = i32&gt;&gt;8;</td></tr>
<tr class="codeline" data-linenumber="556"><td class="num" id="LN556">556</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (encoding == <span class='macro'>ZIP_INT_64B<span class='macro_popup'>(0xc0 | 2&lt;&lt;4)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="557"><td class="num" id="LN557">557</td><td class="line">        <span class="mrange">memcpy</span>(&amp;i64,p,<span class='keyword'>sizeof</span>(i64));</td></tr>
<tr><td class="num"></td><td class="line"><div id="EndPath" class="msg msgEvent" style="margin-left:9ex; max-width:58em">Call to function 'memcpy' is insecure as it does not provide security checks introduced in the C11 standard. Replace with analogous functions that support length arguments or provides boundary checks such as 'memcpy_s' in case of C11</div></td></tr>
<tr class="codeline" data-linenumber="558"><td class="num" id="LN558">558</td><td class="line">        <span class='macro'>memrev64ifbe(&amp;i64)<span class='macro_popup'>((void)(0))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="559"><td class="num" id="LN559">559</td><td class="line">        ret = i64;</td></tr>
<tr class="codeline" data-linenumber="560"><td class="num" id="LN560">560</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (encoding &gt;= <span class='macro'>ZIP_INT_IMM_MIN<span class='macro_popup'>0xf1</span></span> &amp;&amp; encoding &lt;= <span class='macro'>ZIP_INT_IMM_MAX<span class='macro_popup'>0xfd</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="561"><td class="num" id="LN561">561</td><td class="line">        ret = (encoding &amp; <span class='macro'>ZIP_INT_IMM_MASK<span class='macro_popup'>0x0f</span></span>)-1;</td></tr>
<tr class="codeline" data-linenumber="562"><td class="num" id="LN562">562</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="563"><td class="num" id="LN563">563</td><td class="line">        <span class='macro'>assert(NULL)<span class='macro_popup'>((((void*)0))?(void)0 : (_serverAssert("NULL","ziplist.c",563<br>),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="564"><td class="num" id="LN564">564</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="565"><td class="num" id="LN565">565</td><td class="line">    <span class='keyword'>return</span> ret;</td></tr>
<tr class="codeline" data-linenumber="566"><td class="num" id="LN566">566</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="567"><td class="num" id="LN567">567</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="568"><td class="num" id="LN568">568</td><td class="line"><span class='comment'>/* Return a struct with all information about an entry. */</span></td></tr>
<tr class="codeline" data-linenumber="569"><td class="num" id="LN569">569</td><td class="line"><span class='keyword'>void</span> zipEntry(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p, zlentry *e) {</td></tr>
<tr class="codeline" data-linenumber="570"><td class="num" id="LN570">570</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="571"><td class="num" id="LN571">571</td><td class="line">    <span class='macro'>ZIP_DECODE_PREVLEN(p, e-&gt;prevrawlensize, e-&gt;prevrawlen)<span class='macro_popup'>do { do { if ((p)[0] &lt; 254) { (e-&gt;prevrawlensize) = 1; }<br> else { (e-&gt;prevrawlensize) = 5; } } while(0); if ((e-&gt;<br>prevrawlensize) == 1) { (e-&gt;prevrawlen) = (p)[0]; } else if<br> ((e-&gt;prevrawlensize) == 5) { ((sizeof((e-&gt;prevrawlen))<br> == 4)?(void)0 : (_serverAssert("sizeof((e-&gt;prevrawlen)) == 4"<br>,"ziplist.c",571),_exit(1))); memcpy(&amp;(e-&gt;prevrawlen),<br> ((char*)(p)) + 1, 4); ((void)(0)); } } while(0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="572"><td class="num" id="LN572">572</td><td class="line">    <span class='macro'>ZIP_DECODE_LENGTH(p + e-&gt;prevrawlensize, e-&gt;encoding, e-&gt;lensize, e-&gt;len)<span class='macro_popup'>do { do { ((e-&gt;encoding)) = ((p + e-&gt;prevrawlensize)[0]<br>); if (((e-&gt;encoding)) &lt; 0xc0) ((e-&gt;encoding)) &amp;=<br> 0xc0; } while(0); if ((e-&gt;encoding) &lt; 0xc0) { if ((e-&gt;<br>encoding) == (0 &lt;&lt; 6)) { (e-&gt;lensize) = 1; (e-&gt;len<br>) = (p + e-&gt;prevrawlensize)[0] &amp; 0x3f; } else if ((e-&gt;<br>encoding) == (1 &lt;&lt; 6)) { (e-&gt;lensize) = 2; (e-&gt;len<br>) = (((p + e-&gt;prevrawlensize)[0] &amp; 0x3f) &lt;&lt; 8) |<br> (p + e-&gt;prevrawlensize)[1]; } else if ((e-&gt;encoding) ==<br> (2 &lt;&lt; 6)) { (e-&gt;lensize) = 5; (e-&gt;len) = ((p + e<br>-&gt;prevrawlensize)[1] &lt;&lt; 24) | ((p + e-&gt;prevrawlensize<br>)[2] &lt;&lt; 16) | ((p + e-&gt;prevrawlensize)[3] &lt;&lt; 8<br>) | ((p + e-&gt;prevrawlensize)[4]); } else { _serverPanic("ziplist.c"<br>,572,"Invalid string encoding 0x%02X", (e-&gt;encoding)),_exit<br>(1); } } else { (e-&gt;lensize) = 1; (e-&gt;len) = zipIntSize<br>(e-&gt;encoding); } } while(0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="573"><td class="num" id="LN573">573</td><td class="line">    e-&gt;headersize = e-&gt;prevrawlensize + e-&gt;lensize;</td></tr>
<tr class="codeline" data-linenumber="574"><td class="num" id="LN574">574</td><td class="line">    e-&gt;p = p;</td></tr>
<tr class="codeline" data-linenumber="575"><td class="num" id="LN575">575</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="576"><td class="num" id="LN576">576</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="577"><td class="num" id="LN577">577</td><td class="line"><span class='comment'>/* Create a new empty ziplist. */</span></td></tr>
<tr class="codeline" data-linenumber="578"><td class="num" id="LN578">578</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>char</span> *ziplistNew(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="579"><td class="num" id="LN579">579</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> bytes = <span class='macro'>ZIPLIST_HEADER_SIZE<span class='macro_popup'>(sizeof(uint32_t)*2+sizeof(uint16_t))</span></span>+<span class='macro'>ZIPLIST_END_SIZE<span class='macro_popup'>(sizeof(uint8_t))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="580"><td class="num" id="LN580">580</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl = zmalloc(bytes);</td></tr>
<tr class="codeline" data-linenumber="581"><td class="num" id="LN581">581</td><td class="line">    <span class='macro'>ZIPLIST_BYTES(zl)<span class='macro_popup'>(*((uint32_t*)(zl)))</span></span> = <span class='macro'>intrev32ifbe(bytes)<span class='macro_popup'>(bytes)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="582"><td class="num" id="LN582">582</td><td class="line">    <span class='macro'>ZIPLIST_TAIL_OFFSET(zl)<span class='macro_popup'>(*((uint32_t*)((zl)+sizeof(uint32_t))))</span></span> = <span class='macro'>intrev32ifbe(ZIPLIST_HEADER_SIZE)<span class='macro_popup'>((sizeof(uint32_t)*2+sizeof(uint16_t)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="583"><td class="num" id="LN583">583</td><td class="line">    <span class='macro'>ZIPLIST_LENGTH(zl)<span class='macro_popup'>(*((uint16_t*)((zl)+sizeof(uint32_t)*2)))</span></span> = 0;</td></tr>
<tr class="codeline" data-linenumber="584"><td class="num" id="LN584">584</td><td class="line">    zl[bytes-1] = <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span>;</td></tr>
<tr class="codeline" data-linenumber="585"><td class="num" id="LN585">585</td><td class="line">    <span class='keyword'>return</span> zl;</td></tr>
<tr class="codeline" data-linenumber="586"><td class="num" id="LN586">586</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="587"><td class="num" id="LN587">587</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="588"><td class="num" id="LN588">588</td><td class="line"><span class='comment'>/* Resize the ziplist. */</span></td></tr>
<tr class="codeline" data-linenumber="589"><td class="num" id="LN589">589</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>char</span> *ziplistResize(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl, <span class='keyword'>unsigned</span> <span class='keyword'>int</span> len) {</td></tr>
<tr class="codeline" data-linenumber="590"><td class="num" id="LN590">590</td><td class="line">    zl = zrealloc(zl,len);</td></tr>
<tr class="codeline" data-linenumber="591"><td class="num" id="LN591">591</td><td class="line">    <span class='macro'>ZIPLIST_BYTES(zl)<span class='macro_popup'>(*((uint32_t*)(zl)))</span></span> = <span class='macro'>intrev32ifbe(len)<span class='macro_popup'>(len)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="592"><td class="num" id="LN592">592</td><td class="line">    zl[len-1] = <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span>;</td></tr>
<tr class="codeline" data-linenumber="593"><td class="num" id="LN593">593</td><td class="line">    <span class='keyword'>return</span> zl;</td></tr>
<tr class="codeline" data-linenumber="594"><td class="num" id="LN594">594</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="595"><td class="num" id="LN595">595</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="596"><td class="num" id="LN596">596</td><td class="line"><span class='comment'>/* When an entry is inserted, we need to set the prevlen field of the next</span></td></tr>
<tr class="codeline" data-linenumber="597"><td class="num" id="LN597">597</td><td class="line"> <span class='comment'>* entry to equal the length of the inserted entry. It can occur that this</span></td></tr>
<tr class="codeline" data-linenumber="598"><td class="num" id="LN598">598</td><td class="line"> <span class='comment'>* length cannot be encoded in 1 byte and the next entry needs to be grow</span></td></tr>
<tr class="codeline" data-linenumber="599"><td class="num" id="LN599">599</td><td class="line"> <span class='comment'>* a bit larger to hold the 5-byte encoded prevlen. This can be done for free,</span></td></tr>
<tr class="codeline" data-linenumber="600"><td class="num" id="LN600">600</td><td class="line"> <span class='comment'>* because this only happens when an entry is already being inserted (which</span></td></tr>
<tr class="codeline" data-linenumber="601"><td class="num" id="LN601">601</td><td class="line"> <span class='comment'>* causes a realloc and memmove). However, encoding the prevlen may require</span></td></tr>
<tr class="codeline" data-linenumber="602"><td class="num" id="LN602">602</td><td class="line"> <span class='comment'>* that this entry is grown as well. This effect may cascade throughout</span></td></tr>
<tr class="codeline" data-linenumber="603"><td class="num" id="LN603">603</td><td class="line"> <span class='comment'>* the ziplist when there are consecutive entries with a size close to</span></td></tr>
<tr class="codeline" data-linenumber="604"><td class="num" id="LN604">604</td><td class="line"> <span class='comment'>* ZIP_BIG_PREVLEN, so we need to check that the prevlen can be encoded in</span></td></tr>
<tr class="codeline" data-linenumber="605"><td class="num" id="LN605">605</td><td class="line"> <span class='comment'>* every consecutive entry.</span></td></tr>
<tr class="codeline" data-linenumber="606"><td class="num" id="LN606">606</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="607"><td class="num" id="LN607">607</td><td class="line"> <span class='comment'>* Note that this effect can also happen in reverse, where the bytes required</span></td></tr>
<tr class="codeline" data-linenumber="608"><td class="num" id="LN608">608</td><td class="line"> <span class='comment'>* to encode the prevlen field can shrink. This effect is deliberately ignored,</span></td></tr>
<tr class="codeline" data-linenumber="609"><td class="num" id="LN609">609</td><td class="line"> <span class='comment'>* because it can cause a "flapping" effect where a chain prevlen fields is</span></td></tr>
<tr class="codeline" data-linenumber="610"><td class="num" id="LN610">610</td><td class="line"> <span class='comment'>* first grown and then shrunk again after consecutive inserts. Rather, the</span></td></tr>
<tr class="codeline" data-linenumber="611"><td class="num" id="LN611">611</td><td class="line"> <span class='comment'>* field is allowed to stay larger than necessary, because a large prevlen</span></td></tr>
<tr class="codeline" data-linenumber="612"><td class="num" id="LN612">612</td><td class="line"> <span class='comment'>* field implies the ziplist is holding large entries anyway.</span></td></tr>
<tr class="codeline" data-linenumber="613"><td class="num" id="LN613">613</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="614"><td class="num" id="LN614">614</td><td class="line"> <span class='comment'>* The pointer "p" points to the first entry that does NOT need to be</span></td></tr>
<tr class="codeline" data-linenumber="615"><td class="num" id="LN615">615</td><td class="line"> <span class='comment'>* updated, i.e. consecutive fields MAY need an update. */</span></td></tr>
<tr class="codeline" data-linenumber="616"><td class="num" id="LN616">616</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>char</span> *__ziplistCascadeUpdate(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p) {</td></tr>
<tr class="codeline" data-linenumber="617"><td class="num" id="LN617">617</td><td class="line">    size_t curlen = <span class='macro'>intrev32ifbe(ZIPLIST_BYTES(zl))<span class='macro_popup'>((*((uint32_t*)(zl))))</span></span>, rawlen, rawlensize;</td></tr>
<tr class="codeline" data-linenumber="618"><td class="num" id="LN618">618</td><td class="line">    size_t offset, noffset, extra;</td></tr>
<tr class="codeline" data-linenumber="619"><td class="num" id="LN619">619</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *np;</td></tr>
<tr class="codeline" data-linenumber="620"><td class="num" id="LN620">620</td><td class="line">    zlentry cur, next;</td></tr>
<tr class="codeline" data-linenumber="621"><td class="num" id="LN621">621</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="622"><td class="num" id="LN622">622</td><td class="line">    <span class='keyword'>while</span> (p[0] != <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="623"><td class="num" id="LN623">623</td><td class="line">        zipEntry(p, &amp;cur);</td></tr>
<tr class="codeline" data-linenumber="624"><td class="num" id="LN624">624</td><td class="line">        rawlen = cur.headersize + cur.len;</td></tr>
<tr class="codeline" data-linenumber="625"><td class="num" id="LN625">625</td><td class="line">        rawlensize = zipStorePrevEntryLength(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,rawlen);</td></tr>
<tr class="codeline" data-linenumber="626"><td class="num" id="LN626">626</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="627"><td class="num" id="LN627">627</td><td class="line">        <span class='comment'>/* Abort if there is no next entry. */</span></td></tr>
<tr class="codeline" data-linenumber="628"><td class="num" id="LN628">628</td><td class="line">        <span class='keyword'>if</span> (p[rawlen] == <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span>) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="629"><td class="num" id="LN629">629</td><td class="line">        zipEntry(p+rawlen, &amp;next);</td></tr>
<tr class="codeline" data-linenumber="630"><td class="num" id="LN630">630</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="631"><td class="num" id="LN631">631</td><td class="line">        <span class='comment'>/* Abort when "prevlen" has not changed. */</span></td></tr>
<tr class="codeline" data-linenumber="632"><td class="num" id="LN632">632</td><td class="line">        <span class='keyword'>if</span> (next.prevrawlen == rawlen) <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="633"><td class="num" id="LN633">633</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="634"><td class="num" id="LN634">634</td><td class="line">        <span class='keyword'>if</span> (next.prevrawlensize &lt; rawlensize) {</td></tr>
<tr class="codeline" data-linenumber="635"><td class="num" id="LN635">635</td><td class="line">            <span class='comment'>/* The "prevlen" field of "next" needs more bytes to hold</span></td></tr>
<tr class="codeline" data-linenumber="636"><td class="num" id="LN636">636</td><td class="line">             <span class='comment'>* the raw length of "cur". */</span></td></tr>
<tr class="codeline" data-linenumber="637"><td class="num" id="LN637">637</td><td class="line">            offset = p-zl;</td></tr>
<tr class="codeline" data-linenumber="638"><td class="num" id="LN638">638</td><td class="line">            extra = rawlensize-next.prevrawlensize;</td></tr>
<tr class="codeline" data-linenumber="639"><td class="num" id="LN639">639</td><td class="line">            zl = ziplistResize(zl,curlen+extra);</td></tr>
<tr class="codeline" data-linenumber="640"><td class="num" id="LN640">640</td><td class="line">            p = zl+offset;</td></tr>
<tr class="codeline" data-linenumber="641"><td class="num" id="LN641">641</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="642"><td class="num" id="LN642">642</td><td class="line">            <span class='comment'>/* Current pointer and offset for next element. */</span></td></tr>
<tr class="codeline" data-linenumber="643"><td class="num" id="LN643">643</td><td class="line">            np = p+rawlen;</td></tr>
<tr class="codeline" data-linenumber="644"><td class="num" id="LN644">644</td><td class="line">            noffset = np-zl;</td></tr>
<tr class="codeline" data-linenumber="645"><td class="num" id="LN645">645</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="646"><td class="num" id="LN646">646</td><td class="line">            <span class='comment'>/* Update tail offset when next element is not the tail element. */</span></td></tr>
<tr class="codeline" data-linenumber="647"><td class="num" id="LN647">647</td><td class="line">            <span class='keyword'>if</span> ((zl+<span class='macro'>intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))<span class='macro_popup'>((*((uint32_t*)((zl)+sizeof(uint32_t)))))</span></span>) != np) {</td></tr>
<tr class="codeline" data-linenumber="648"><td class="num" id="LN648">648</td><td class="line">                <span class='macro'>ZIPLIST_TAIL_OFFSET(zl)<span class='macro_popup'>(*((uint32_t*)((zl)+sizeof(uint32_t))))</span></span> =</td></tr>
<tr class="codeline" data-linenumber="649"><td class="num" id="LN649">649</td><td class="line">                    <span class='macro'>intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))+extra)<span class='macro_popup'>(((*((uint32_t*)((zl)+sizeof(uint32_t)))))+extra)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="650"><td class="num" id="LN650">650</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="651"><td class="num" id="LN651">651</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="652"><td class="num" id="LN652">652</td><td class="line">            <span class='comment'>/* Move the tail to the back. */</span></td></tr>
<tr class="codeline" data-linenumber="653"><td class="num" id="LN653">653</td><td class="line">            memmove(np+rawlensize,</td></tr>
<tr class="codeline" data-linenumber="654"><td class="num" id="LN654">654</td><td class="line">                np+next.prevrawlensize,</td></tr>
<tr class="codeline" data-linenumber="655"><td class="num" id="LN655">655</td><td class="line">                curlen-noffset-next.prevrawlensize-1);</td></tr>
<tr class="codeline" data-linenumber="656"><td class="num" id="LN656">656</td><td class="line">            zipStorePrevEntryLength(np,rawlen);</td></tr>
<tr class="codeline" data-linenumber="657"><td class="num" id="LN657">657</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="658"><td class="num" id="LN658">658</td><td class="line">            <span class='comment'>/* Advance the cursor */</span></td></tr>
<tr class="codeline" data-linenumber="659"><td class="num" id="LN659">659</td><td class="line">            p += rawlen;</td></tr>
<tr class="codeline" data-linenumber="660"><td class="num" id="LN660">660</td><td class="line">            curlen += extra;</td></tr>
<tr class="codeline" data-linenumber="661"><td class="num" id="LN661">661</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="662"><td class="num" id="LN662">662</td><td class="line">            <span class='keyword'>if</span> (next.prevrawlensize &gt; rawlensize) {</td></tr>
<tr class="codeline" data-linenumber="663"><td class="num" id="LN663">663</td><td class="line">                <span class='comment'>/* This would result in shrinking, which we want to avoid.</span></td></tr>
<tr class="codeline" data-linenumber="664"><td class="num" id="LN664">664</td><td class="line">                 <span class='comment'>* So, set "rawlen" in the available bytes. */</span></td></tr>
<tr class="codeline" data-linenumber="665"><td class="num" id="LN665">665</td><td class="line">                zipStorePrevEntryLengthLarge(p+rawlen,rawlen);</td></tr>
<tr class="codeline" data-linenumber="666"><td class="num" id="LN666">666</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="667"><td class="num" id="LN667">667</td><td class="line">                zipStorePrevEntryLength(p+rawlen,rawlen);</td></tr>
<tr class="codeline" data-linenumber="668"><td class="num" id="LN668">668</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="669"><td class="num" id="LN669">669</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="670"><td class="num" id="LN670">670</td><td class="line">            <span class='comment'>/* Stop here, as the raw length of "next" has not changed. */</span></td></tr>
<tr class="codeline" data-linenumber="671"><td class="num" id="LN671">671</td><td class="line">            <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="672"><td class="num" id="LN672">672</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="673"><td class="num" id="LN673">673</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="674"><td class="num" id="LN674">674</td><td class="line">    <span class='keyword'>return</span> zl;</td></tr>
<tr class="codeline" data-linenumber="675"><td class="num" id="LN675">675</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="676"><td class="num" id="LN676">676</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="677"><td class="num" id="LN677">677</td><td class="line"><span class='comment'>/* Delete "num" entries, starting at "p". Returns pointer to the ziplist. */</span></td></tr>
<tr class="codeline" data-linenumber="678"><td class="num" id="LN678">678</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>char</span> *__ziplistDelete(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p, <span class='keyword'>unsigned</span> <span class='keyword'>int</span> num) {</td></tr>
<tr class="codeline" data-linenumber="679"><td class="num" id="LN679">679</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> i, totlen, deleted = 0;</td></tr>
<tr class="codeline" data-linenumber="680"><td class="num" id="LN680">680</td><td class="line">    size_t offset;</td></tr>
<tr class="codeline" data-linenumber="681"><td class="num" id="LN681">681</td><td class="line">    <span class='keyword'>int</span> nextdiff = 0;</td></tr>
<tr class="codeline" data-linenumber="682"><td class="num" id="LN682">682</td><td class="line">    zlentry first, tail;</td></tr>
<tr class="codeline" data-linenumber="683"><td class="num" id="LN683">683</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="684"><td class="num" id="LN684">684</td><td class="line">    zipEntry(p, &amp;first);</td></tr>
<tr class="codeline" data-linenumber="685"><td class="num" id="LN685">685</td><td class="line">    <span class='keyword'>for</span> (i = 0; p[0] != <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span> &amp;&amp; i &lt; num; i++) {</td></tr>
<tr class="codeline" data-linenumber="686"><td class="num" id="LN686">686</td><td class="line">        p += zipRawEntryLength(p);</td></tr>
<tr class="codeline" data-linenumber="687"><td class="num" id="LN687">687</td><td class="line">        deleted++;</td></tr>
<tr class="codeline" data-linenumber="688"><td class="num" id="LN688">688</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="689"><td class="num" id="LN689">689</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="690"><td class="num" id="LN690">690</td><td class="line">    totlen = p-first.p; <span class='comment'>/* Bytes taken by the element(s) to delete. */</span></td></tr>
<tr class="codeline" data-linenumber="691"><td class="num" id="LN691">691</td><td class="line">    <span class='keyword'>if</span> (totlen &gt; 0) {</td></tr>
<tr class="codeline" data-linenumber="692"><td class="num" id="LN692">692</td><td class="line">        <span class='keyword'>if</span> (p[0] != <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="693"><td class="num" id="LN693">693</td><td class="line">            <span class='comment'>/* Storing `prevrawlen` in this entry may increase or decrease the</span></td></tr>
<tr class="codeline" data-linenumber="694"><td class="num" id="LN694">694</td><td class="line">             <span class='comment'>* number of bytes required compare to the current `prevrawlen`.</span></td></tr>
<tr class="codeline" data-linenumber="695"><td class="num" id="LN695">695</td><td class="line">             <span class='comment'>* There always is room to store this, because it was previously</span></td></tr>
<tr class="codeline" data-linenumber="696"><td class="num" id="LN696">696</td><td class="line">             <span class='comment'>* stored by an entry that is now being deleted. */</span></td></tr>
<tr class="codeline" data-linenumber="697"><td class="num" id="LN697">697</td><td class="line">            nextdiff = zipPrevLenByteDiff(p,first.prevrawlen);</td></tr>
<tr class="codeline" data-linenumber="698"><td class="num" id="LN698">698</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="699"><td class="num" id="LN699">699</td><td class="line">            <span class='comment'>/* Note that there is always space when p jumps backward: if</span></td></tr>
<tr class="codeline" data-linenumber="700"><td class="num" id="LN700">700</td><td class="line">             <span class='comment'>* the new previous entry is large, one of the deleted elements</span></td></tr>
<tr class="codeline" data-linenumber="701"><td class="num" id="LN701">701</td><td class="line">             <span class='comment'>* had a 5 bytes prevlen header, so there is for sure at least</span></td></tr>
<tr class="codeline" data-linenumber="702"><td class="num" id="LN702">702</td><td class="line">             <span class='comment'>* 5 bytes free and we need just 4. */</span></td></tr>
<tr class="codeline" data-linenumber="703"><td class="num" id="LN703">703</td><td class="line">            p -= nextdiff;</td></tr>
<tr class="codeline" data-linenumber="704"><td class="num" id="LN704">704</td><td class="line">            zipStorePrevEntryLength(p,first.prevrawlen);</td></tr>
<tr class="codeline" data-linenumber="705"><td class="num" id="LN705">705</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="706"><td class="num" id="LN706">706</td><td class="line">            <span class='comment'>/* Update offset for tail */</span></td></tr>
<tr class="codeline" data-linenumber="707"><td class="num" id="LN707">707</td><td class="line">            <span class='macro'>ZIPLIST_TAIL_OFFSET(zl)<span class='macro_popup'>(*((uint32_t*)((zl)+sizeof(uint32_t))))</span></span> =</td></tr>
<tr class="codeline" data-linenumber="708"><td class="num" id="LN708">708</td><td class="line">                <span class='macro'>intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))-totlen)<span class='macro_popup'>(((*((uint32_t*)((zl)+sizeof(uint32_t)))))-totlen)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="709"><td class="num" id="LN709">709</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="710"><td class="num" id="LN710">710</td><td class="line">            <span class='comment'>/* When the tail contains more than one entry, we need to take</span></td></tr>
<tr class="codeline" data-linenumber="711"><td class="num" id="LN711">711</td><td class="line">             <span class='comment'>* "nextdiff" in account as well. Otherwise, a change in the</span></td></tr>
<tr class="codeline" data-linenumber="712"><td class="num" id="LN712">712</td><td class="line">             <span class='comment'>* size of prevlen doesn't have an effect on the *tail* offset. */</span></td></tr>
<tr class="codeline" data-linenumber="713"><td class="num" id="LN713">713</td><td class="line">            zipEntry(p, &amp;tail);</td></tr>
<tr class="codeline" data-linenumber="714"><td class="num" id="LN714">714</td><td class="line">            <span class='keyword'>if</span> (p[tail.headersize+tail.len] != <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="715"><td class="num" id="LN715">715</td><td class="line">                <span class='macro'>ZIPLIST_TAIL_OFFSET(zl)<span class='macro_popup'>(*((uint32_t*)((zl)+sizeof(uint32_t))))</span></span> =</td></tr>
<tr class="codeline" data-linenumber="716"><td class="num" id="LN716">716</td><td class="line">                   <span class='macro'>intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))+nextdiff)<span class='macro_popup'>(((*((uint32_t*)((zl)+sizeof(uint32_t)))))+nextdiff)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="717"><td class="num" id="LN717">717</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="718"><td class="num" id="LN718">718</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="719"><td class="num" id="LN719">719</td><td class="line">            <span class='comment'>/* Move tail to the front of the ziplist */</span></td></tr>
<tr class="codeline" data-linenumber="720"><td class="num" id="LN720">720</td><td class="line">            memmove(first.p,p,</td></tr>
<tr class="codeline" data-linenumber="721"><td class="num" id="LN721">721</td><td class="line">                <span class='macro'>intrev32ifbe(ZIPLIST_BYTES(zl))<span class='macro_popup'>((*((uint32_t*)(zl))))</span></span>-(p-zl)-1);</td></tr>
<tr class="codeline" data-linenumber="722"><td class="num" id="LN722">722</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="723"><td class="num" id="LN723">723</td><td class="line">            <span class='comment'>/* The entire tail was deleted. No need to move memory. */</span></td></tr>
<tr class="codeline" data-linenumber="724"><td class="num" id="LN724">724</td><td class="line">            <span class='macro'>ZIPLIST_TAIL_OFFSET(zl)<span class='macro_popup'>(*((uint32_t*)((zl)+sizeof(uint32_t))))</span></span> =</td></tr>
<tr class="codeline" data-linenumber="725"><td class="num" id="LN725">725</td><td class="line">                <span class='macro'>intrev32ifbe((first.p-zl)-first.prevrawlen)<span class='macro_popup'>((first.p-zl)-first.prevrawlen)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="726"><td class="num" id="LN726">726</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="727"><td class="num" id="LN727">727</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="728"><td class="num" id="LN728">728</td><td class="line">        <span class='comment'>/* Resize and update length */</span></td></tr>
<tr class="codeline" data-linenumber="729"><td class="num" id="LN729">729</td><td class="line">        offset = first.p-zl;</td></tr>
<tr class="codeline" data-linenumber="730"><td class="num" id="LN730">730</td><td class="line">        zl = ziplistResize(zl, <span class='macro'>intrev32ifbe(ZIPLIST_BYTES(zl))<span class='macro_popup'>((*((uint32_t*)(zl))))</span></span>-totlen+nextdiff);</td></tr>
<tr class="codeline" data-linenumber="731"><td class="num" id="LN731">731</td><td class="line">        <span class='macro'>ZIPLIST_INCR_LENGTH(zl,-deleted)<span class='macro_popup'>{ if ((*((uint16_t*)((zl)+sizeof(uint32_t)*2))) &lt; (65535))<br> (*((uint16_t*)((zl)+sizeof(uint32_t)*2))) = (((*((uint16_t*)<br>((zl)+sizeof(uint32_t)*2))))+-deleted); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="732"><td class="num" id="LN732">732</td><td class="line">        p = zl+offset;</td></tr>
<tr class="codeline" data-linenumber="733"><td class="num" id="LN733">733</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="734"><td class="num" id="LN734">734</td><td class="line">        <span class='comment'>/* When nextdiff != 0, the raw length of the next entry has changed, so</span></td></tr>
<tr class="codeline" data-linenumber="735"><td class="num" id="LN735">735</td><td class="line">         <span class='comment'>* we need to cascade the update throughout the ziplist */</span></td></tr>
<tr class="codeline" data-linenumber="736"><td class="num" id="LN736">736</td><td class="line">        <span class='keyword'>if</span> (nextdiff != 0)</td></tr>
<tr class="codeline" data-linenumber="737"><td class="num" id="LN737">737</td><td class="line">            zl = __ziplistCascadeUpdate(zl,p);</td></tr>
<tr class="codeline" data-linenumber="738"><td class="num" id="LN738">738</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="739"><td class="num" id="LN739">739</td><td class="line">    <span class='keyword'>return</span> zl;</td></tr>
<tr class="codeline" data-linenumber="740"><td class="num" id="LN740">740</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="741"><td class="num" id="LN741">741</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="742"><td class="num" id="LN742">742</td><td class="line"><span class='comment'>/* Insert item at "p". */</span></td></tr>
<tr class="codeline" data-linenumber="743"><td class="num" id="LN743">743</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>char</span> *__ziplistInsert(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *s, <span class='keyword'>unsigned</span> <span class='keyword'>int</span> slen) {</td></tr>
<tr class="codeline" data-linenumber="744"><td class="num" id="LN744">744</td><td class="line">    size_t curlen = <span class='macro'>intrev32ifbe(ZIPLIST_BYTES(zl))<span class='macro_popup'>((*((uint32_t*)(zl))))</span></span>, reqlen;</td></tr>
<tr class="codeline" data-linenumber="745"><td class="num" id="LN745">745</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> prevlensize, prevlen = 0;</td></tr>
<tr class="codeline" data-linenumber="746"><td class="num" id="LN746">746</td><td class="line">    size_t offset;</td></tr>
<tr class="codeline" data-linenumber="747"><td class="num" id="LN747">747</td><td class="line">    <span class='keyword'>int</span> nextdiff = 0;</td></tr>
<tr class="codeline" data-linenumber="748"><td class="num" id="LN748">748</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> encoding = 0;</td></tr>
<tr class="codeline" data-linenumber="749"><td class="num" id="LN749">749</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> value = 123456789; <span class='comment'>/* initialized to avoid warning. Using a value</span></td></tr>
<tr class="codeline" data-linenumber="750"><td class="num" id="LN750">750</td><td class="line">                                    <span class='comment'>that is easy to see if for some reason</span></td></tr>
<tr class="codeline" data-linenumber="751"><td class="num" id="LN751">751</td><td class="line">                                    <span class='comment'>we use it uninitialized. */</span></td></tr>
<tr class="codeline" data-linenumber="752"><td class="num" id="LN752">752</td><td class="line">    zlentry tail;</td></tr>
<tr class="codeline" data-linenumber="753"><td class="num" id="LN753">753</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="754"><td class="num" id="LN754">754</td><td class="line">    <span class='comment'>/* Find out prevlen for the entry that is inserted. */</span></td></tr>
<tr class="codeline" data-linenumber="755"><td class="num" id="LN755">755</td><td class="line">    <span class='keyword'>if</span> (p[0] != <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="756"><td class="num" id="LN756">756</td><td class="line">        <span class='macro'>ZIP_DECODE_PREVLEN(p, prevlensize, prevlen)<span class='macro_popup'>do { do { if ((p)[0] &lt; 254) { (prevlensize) = 1; } else { (<br>prevlensize) = 5; } } while(0); if ((prevlensize) == 1) { (prevlen<br>) = (p)[0]; } else if ((prevlensize) == 5) { ((sizeof((prevlen<br>)) == 4)?(void)0 : (_serverAssert("sizeof((prevlen)) == 4","ziplist.c"<br>,756),_exit(1))); memcpy(&amp;(prevlen), ((char*)(p)) + 1, 4)<br>; ((void)(0)); } } while(0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="757"><td class="num" id="LN757">757</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="758"><td class="num" id="LN758">758</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *ptail = <span class='macro'>ZIPLIST_ENTRY_TAIL(zl)<span class='macro_popup'>((zl)+((*((uint32_t*)((zl)+sizeof(uint32_t))))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="759"><td class="num" id="LN759">759</td><td class="line">        <span class='keyword'>if</span> (ptail[0] != <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="760"><td class="num" id="LN760">760</td><td class="line">            prevlen = zipRawEntryLength(ptail);</td></tr>
<tr class="codeline" data-linenumber="761"><td class="num" id="LN761">761</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="762"><td class="num" id="LN762">762</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="763"><td class="num" id="LN763">763</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="764"><td class="num" id="LN764">764</td><td class="line">    <span class='comment'>/* See if the entry can be encoded */</span></td></tr>
<tr class="codeline" data-linenumber="765"><td class="num" id="LN765">765</td><td class="line">    <span class='keyword'>if</span> (zipTryEncoding(s,slen,&amp;value,&amp;encoding)) {</td></tr>
<tr class="codeline" data-linenumber="766"><td class="num" id="LN766">766</td><td class="line">        <span class='comment'>/* 'encoding' is set to the appropriate integer encoding */</span></td></tr>
<tr class="codeline" data-linenumber="767"><td class="num" id="LN767">767</td><td class="line">        reqlen = zipIntSize(encoding);</td></tr>
<tr class="codeline" data-linenumber="768"><td class="num" id="LN768">768</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="769"><td class="num" id="LN769">769</td><td class="line">        <span class='comment'>/* 'encoding' is untouched, however zipStoreEntryEncoding will use the</span></td></tr>
<tr class="codeline" data-linenumber="770"><td class="num" id="LN770">770</td><td class="line">         <span class='comment'>* string length to figure out how to encode it. */</span></td></tr>
<tr class="codeline" data-linenumber="771"><td class="num" id="LN771">771</td><td class="line">        reqlen = slen;</td></tr>
<tr class="codeline" data-linenumber="772"><td class="num" id="LN772">772</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="773"><td class="num" id="LN773">773</td><td class="line">    <span class='comment'>/* We need space for both the length of the previous entry and</span></td></tr>
<tr class="codeline" data-linenumber="774"><td class="num" id="LN774">774</td><td class="line">     <span class='comment'>* the length of the payload. */</span></td></tr>
<tr class="codeline" data-linenumber="775"><td class="num" id="LN775">775</td><td class="line">    reqlen += zipStorePrevEntryLength(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,prevlen);</td></tr>
<tr class="codeline" data-linenumber="776"><td class="num" id="LN776">776</td><td class="line">    reqlen += zipStoreEntryEncoding(<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>,encoding,slen);</td></tr>
<tr class="codeline" data-linenumber="777"><td class="num" id="LN777">777</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="778"><td class="num" id="LN778">778</td><td class="line">    <span class='comment'>/* When the insert position is not equal to the tail, we need to</span></td></tr>
<tr class="codeline" data-linenumber="779"><td class="num" id="LN779">779</td><td class="line">     <span class='comment'>* make sure that the next entry can hold this entry's length in</span></td></tr>
<tr class="codeline" data-linenumber="780"><td class="num" id="LN780">780</td><td class="line">     <span class='comment'>* its prevlen field. */</span></td></tr>
<tr class="codeline" data-linenumber="781"><td class="num" id="LN781">781</td><td class="line">    <span class='keyword'>int</span> forcelarge = 0;</td></tr>
<tr class="codeline" data-linenumber="782"><td class="num" id="LN782">782</td><td class="line">    nextdiff = (p[0] != <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span>) ? zipPrevLenByteDiff(p,reqlen) : 0;</td></tr>
<tr class="codeline" data-linenumber="783"><td class="num" id="LN783">783</td><td class="line">    <span class='keyword'>if</span> (nextdiff == -4 &amp;&amp; reqlen &lt; 4) {</td></tr>
<tr class="codeline" data-linenumber="784"><td class="num" id="LN784">784</td><td class="line">        nextdiff = 0;</td></tr>
<tr class="codeline" data-linenumber="785"><td class="num" id="LN785">785</td><td class="line">        forcelarge = 1;</td></tr>
<tr class="codeline" data-linenumber="786"><td class="num" id="LN786">786</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="787"><td class="num" id="LN787">787</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="788"><td class="num" id="LN788">788</td><td class="line">    <span class='comment'>/* Store offset because a realloc may change the address of zl. */</span></td></tr>
<tr class="codeline" data-linenumber="789"><td class="num" id="LN789">789</td><td class="line">    offset = p-zl;</td></tr>
<tr class="codeline" data-linenumber="790"><td class="num" id="LN790">790</td><td class="line">    zl = ziplistResize(zl,curlen+reqlen+nextdiff);</td></tr>
<tr class="codeline" data-linenumber="791"><td class="num" id="LN791">791</td><td class="line">    p = zl+offset;</td></tr>
<tr class="codeline" data-linenumber="792"><td class="num" id="LN792">792</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="793"><td class="num" id="LN793">793</td><td class="line">    <span class='comment'>/* Apply memory move when necessary and update tail offset. */</span></td></tr>
<tr class="codeline" data-linenumber="794"><td class="num" id="LN794">794</td><td class="line">    <span class='keyword'>if</span> (p[0] != <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="795"><td class="num" id="LN795">795</td><td class="line">        <span class='comment'>/* Subtract one because of the ZIP_END bytes */</span></td></tr>
<tr class="codeline" data-linenumber="796"><td class="num" id="LN796">796</td><td class="line">        memmove(p+reqlen,p-nextdiff,curlen-offset-1+nextdiff);</td></tr>
<tr class="codeline" data-linenumber="797"><td class="num" id="LN797">797</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="798"><td class="num" id="LN798">798</td><td class="line">        <span class='comment'>/* Encode this entry's raw length in the next entry. */</span></td></tr>
<tr class="codeline" data-linenumber="799"><td class="num" id="LN799">799</td><td class="line">        <span class='keyword'>if</span> (forcelarge)</td></tr>
<tr class="codeline" data-linenumber="800"><td class="num" id="LN800">800</td><td class="line">            zipStorePrevEntryLengthLarge(p+reqlen,reqlen);</td></tr>
<tr class="codeline" data-linenumber="801"><td class="num" id="LN801">801</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="802"><td class="num" id="LN802">802</td><td class="line">            zipStorePrevEntryLength(p+reqlen,reqlen);</td></tr>
<tr class="codeline" data-linenumber="803"><td class="num" id="LN803">803</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="804"><td class="num" id="LN804">804</td><td class="line">        <span class='comment'>/* Update offset for tail */</span></td></tr>
<tr class="codeline" data-linenumber="805"><td class="num" id="LN805">805</td><td class="line">        <span class='macro'>ZIPLIST_TAIL_OFFSET(zl)<span class='macro_popup'>(*((uint32_t*)((zl)+sizeof(uint32_t))))</span></span> =</td></tr>
<tr class="codeline" data-linenumber="806"><td class="num" id="LN806">806</td><td class="line">            <span class='macro'>intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))+reqlen)<span class='macro_popup'>(((*((uint32_t*)((zl)+sizeof(uint32_t)))))+reqlen)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="807"><td class="num" id="LN807">807</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="808"><td class="num" id="LN808">808</td><td class="line">        <span class='comment'>/* When the tail contains more than one entry, we need to take</span></td></tr>
<tr class="codeline" data-linenumber="809"><td class="num" id="LN809">809</td><td class="line">         <span class='comment'>* "nextdiff" in account as well. Otherwise, a change in the</span></td></tr>
<tr class="codeline" data-linenumber="810"><td class="num" id="LN810">810</td><td class="line">         <span class='comment'>* size of prevlen doesn't have an effect on the *tail* offset. */</span></td></tr>
<tr class="codeline" data-linenumber="811"><td class="num" id="LN811">811</td><td class="line">        zipEntry(p+reqlen, &amp;tail);</td></tr>
<tr class="codeline" data-linenumber="812"><td class="num" id="LN812">812</td><td class="line">        <span class='keyword'>if</span> (p[reqlen+tail.headersize+tail.len] != <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="813"><td class="num" id="LN813">813</td><td class="line">            <span class='macro'>ZIPLIST_TAIL_OFFSET(zl)<span class='macro_popup'>(*((uint32_t*)((zl)+sizeof(uint32_t))))</span></span> =</td></tr>
<tr class="codeline" data-linenumber="814"><td class="num" id="LN814">814</td><td class="line">                <span class='macro'>intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))+nextdiff)<span class='macro_popup'>(((*((uint32_t*)((zl)+sizeof(uint32_t)))))+nextdiff)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="815"><td class="num" id="LN815">815</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="816"><td class="num" id="LN816">816</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="817"><td class="num" id="LN817">817</td><td class="line">        <span class='comment'>/* This element will be the new tail. */</span></td></tr>
<tr class="codeline" data-linenumber="818"><td class="num" id="LN818">818</td><td class="line">        <span class='macro'>ZIPLIST_TAIL_OFFSET(zl)<span class='macro_popup'>(*((uint32_t*)((zl)+sizeof(uint32_t))))</span></span> = <span class='macro'>intrev32ifbe(p-zl)<span class='macro_popup'>(p-zl)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="819"><td class="num" id="LN819">819</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="820"><td class="num" id="LN820">820</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="821"><td class="num" id="LN821">821</td><td class="line">    <span class='comment'>/* When nextdiff != 0, the raw length of the next entry has changed, so</span></td></tr>
<tr class="codeline" data-linenumber="822"><td class="num" id="LN822">822</td><td class="line">     <span class='comment'>* we need to cascade the update throughout the ziplist */</span></td></tr>
<tr class="codeline" data-linenumber="823"><td class="num" id="LN823">823</td><td class="line">    <span class='keyword'>if</span> (nextdiff != 0) {</td></tr>
<tr class="codeline" data-linenumber="824"><td class="num" id="LN824">824</td><td class="line">        offset = p-zl;</td></tr>
<tr class="codeline" data-linenumber="825"><td class="num" id="LN825">825</td><td class="line">        zl = __ziplistCascadeUpdate(zl,p+reqlen);</td></tr>
<tr class="codeline" data-linenumber="826"><td class="num" id="LN826">826</td><td class="line">        p = zl+offset;</td></tr>
<tr class="codeline" data-linenumber="827"><td class="num" id="LN827">827</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="828"><td class="num" id="LN828">828</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="829"><td class="num" id="LN829">829</td><td class="line">    <span class='comment'>/* Write the entry */</span></td></tr>
<tr class="codeline" data-linenumber="830"><td class="num" id="LN830">830</td><td class="line">    p += zipStorePrevEntryLength(p,prevlen);</td></tr>
<tr class="codeline" data-linenumber="831"><td class="num" id="LN831">831</td><td class="line">    p += zipStoreEntryEncoding(p,encoding,slen);</td></tr>
<tr class="codeline" data-linenumber="832"><td class="num" id="LN832">832</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>ZIP_IS_STR(encoding)<span class='macro_popup'>(((encoding) &amp; 0xc0) &lt; 0xc0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="833"><td class="num" id="LN833">833</td><td class="line">        memcpy(p,s,slen);</td></tr>
<tr class="codeline" data-linenumber="834"><td class="num" id="LN834">834</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="835"><td class="num" id="LN835">835</td><td class="line">        zipSaveInteger(p,value,encoding);</td></tr>
<tr class="codeline" data-linenumber="836"><td class="num" id="LN836">836</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="837"><td class="num" id="LN837">837</td><td class="line">    <span class='macro'>ZIPLIST_INCR_LENGTH(zl,1)<span class='macro_popup'>{ if ((*((uint16_t*)((zl)+sizeof(uint32_t)*2))) &lt; (65535))<br> (*((uint16_t*)((zl)+sizeof(uint32_t)*2))) = (((*((uint16_t*)<br>((zl)+sizeof(uint32_t)*2))))+1); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="838"><td class="num" id="LN838">838</td><td class="line">    <span class='keyword'>return</span> zl;</td></tr>
<tr class="codeline" data-linenumber="839"><td class="num" id="LN839">839</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="840"><td class="num" id="LN840">840</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="841"><td class="num" id="LN841">841</td><td class="line"><span class='comment'>/* Merge ziplists 'first' and 'second' by appending 'second' to 'first'.</span></td></tr>
<tr class="codeline" data-linenumber="842"><td class="num" id="LN842">842</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="843"><td class="num" id="LN843">843</td><td class="line"> <span class='comment'>* NOTE: The larger ziplist is reallocated to contain the new merged ziplist.</span></td></tr>
<tr class="codeline" data-linenumber="844"><td class="num" id="LN844">844</td><td class="line"> <span class='comment'>* Either 'first' or 'second' can be used for the result.  The parameter not</span></td></tr>
<tr class="codeline" data-linenumber="845"><td class="num" id="LN845">845</td><td class="line"> <span class='comment'>* used will be free'd and set to NULL.</span></td></tr>
<tr class="codeline" data-linenumber="846"><td class="num" id="LN846">846</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="847"><td class="num" id="LN847">847</td><td class="line"> <span class='comment'>* After calling this function, the input parameters are no longer valid since</span></td></tr>
<tr class="codeline" data-linenumber="848"><td class="num" id="LN848">848</td><td class="line"> <span class='comment'>* they are changed and free'd in-place.</span></td></tr>
<tr class="codeline" data-linenumber="849"><td class="num" id="LN849">849</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="850"><td class="num" id="LN850">850</td><td class="line"> <span class='comment'>* The result ziplist is the contents of 'first' followed by 'second'.</span></td></tr>
<tr class="codeline" data-linenumber="851"><td class="num" id="LN851">851</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="852"><td class="num" id="LN852">852</td><td class="line"> <span class='comment'>* On failure: returns NULL if the merge is impossible.</span></td></tr>
<tr class="codeline" data-linenumber="853"><td class="num" id="LN853">853</td><td class="line"> <span class='comment'>* On success: returns the merged ziplist (which is expanded version of either</span></td></tr>
<tr class="codeline" data-linenumber="854"><td class="num" id="LN854">854</td><td class="line"> <span class='comment'>* 'first' or 'second', also frees the other unused input ziplist, and sets the</span></td></tr>
<tr class="codeline" data-linenumber="855"><td class="num" id="LN855">855</td><td class="line"> <span class='comment'>* input ziplist argument equal to newly reallocated ziplist return value. */</span></td></tr>
<tr class="codeline" data-linenumber="856"><td class="num" id="LN856">856</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>char</span> *ziplistMerge(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> **first, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> **second) {</td></tr>
<tr class="codeline" data-linenumber="857"><td class="num" id="LN857">857</td><td class="line">    <span class='comment'>/* If any params are null, we can't merge, so NULL. */</span></td></tr>
<tr class="codeline" data-linenumber="858"><td class="num" id="LN858">858</td><td class="line">    <span class='keyword'>if</span> (first == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || *first == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || second == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || *second == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>)</td></tr>
<tr class="codeline" data-linenumber="859"><td class="num" id="LN859">859</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="860"><td class="num" id="LN860">860</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="861"><td class="num" id="LN861">861</td><td class="line">    <span class='comment'>/* Can't merge same list into itself. */</span></td></tr>
<tr class="codeline" data-linenumber="862"><td class="num" id="LN862">862</td><td class="line">    <span class='keyword'>if</span> (*first == *second)</td></tr>
<tr class="codeline" data-linenumber="863"><td class="num" id="LN863">863</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="864"><td class="num" id="LN864">864</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="865"><td class="num" id="LN865">865</td><td class="line">    size_t first_bytes = <span class='macro'>intrev32ifbe(ZIPLIST_BYTES(*first))<span class='macro_popup'>((*((uint32_t*)(*first))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="866"><td class="num" id="LN866">866</td><td class="line">    size_t first_len = <span class='macro'>intrev16ifbe(ZIPLIST_LENGTH(*first))<span class='macro_popup'>((*((uint16_t*)((*first)+sizeof(uint32_t)*2))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="867"><td class="num" id="LN867">867</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="868"><td class="num" id="LN868">868</td><td class="line">    size_t second_bytes = <span class='macro'>intrev32ifbe(ZIPLIST_BYTES(*second))<span class='macro_popup'>((*((uint32_t*)(*second))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="869"><td class="num" id="LN869">869</td><td class="line">    size_t second_len = <span class='macro'>intrev16ifbe(ZIPLIST_LENGTH(*second))<span class='macro_popup'>((*((uint16_t*)((*second)+sizeof(uint32_t)*2))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="870"><td class="num" id="LN870">870</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="871"><td class="num" id="LN871">871</td><td class="line">    <span class='keyword'>int</span> append;</td></tr>
<tr class="codeline" data-linenumber="872"><td class="num" id="LN872">872</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *source, *target;</td></tr>
<tr class="codeline" data-linenumber="873"><td class="num" id="LN873">873</td><td class="line">    size_t target_bytes, source_bytes;</td></tr>
<tr class="codeline" data-linenumber="874"><td class="num" id="LN874">874</td><td class="line">    <span class='comment'>/* Pick the largest ziplist so we can resize easily in-place.</span></td></tr>
<tr class="codeline" data-linenumber="875"><td class="num" id="LN875">875</td><td class="line">     <span class='comment'>* We must also track if we are now appending or prepending to</span></td></tr>
<tr class="codeline" data-linenumber="876"><td class="num" id="LN876">876</td><td class="line">     <span class='comment'>* the target ziplist. */</span></td></tr>
<tr class="codeline" data-linenumber="877"><td class="num" id="LN877">877</td><td class="line">    <span class='keyword'>if</span> (first_len &gt;= second_len) {</td></tr>
<tr class="codeline" data-linenumber="878"><td class="num" id="LN878">878</td><td class="line">        <span class='comment'>/* retain first, append second to first. */</span></td></tr>
<tr class="codeline" data-linenumber="879"><td class="num" id="LN879">879</td><td class="line">        target = *first;</td></tr>
<tr class="codeline" data-linenumber="880"><td class="num" id="LN880">880</td><td class="line">        target_bytes = first_bytes;</td></tr>
<tr class="codeline" data-linenumber="881"><td class="num" id="LN881">881</td><td class="line">        source = *second;</td></tr>
<tr class="codeline" data-linenumber="882"><td class="num" id="LN882">882</td><td class="line">        source_bytes = second_bytes;</td></tr>
<tr class="codeline" data-linenumber="883"><td class="num" id="LN883">883</td><td class="line">        append = 1;</td></tr>
<tr class="codeline" data-linenumber="884"><td class="num" id="LN884">884</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="885"><td class="num" id="LN885">885</td><td class="line">        <span class='comment'>/* else, retain second, prepend first to second. */</span></td></tr>
<tr class="codeline" data-linenumber="886"><td class="num" id="LN886">886</td><td class="line">        target = *second;</td></tr>
<tr class="codeline" data-linenumber="887"><td class="num" id="LN887">887</td><td class="line">        target_bytes = second_bytes;</td></tr>
<tr class="codeline" data-linenumber="888"><td class="num" id="LN888">888</td><td class="line">        source = *first;</td></tr>
<tr class="codeline" data-linenumber="889"><td class="num" id="LN889">889</td><td class="line">        source_bytes = first_bytes;</td></tr>
<tr class="codeline" data-linenumber="890"><td class="num" id="LN890">890</td><td class="line">        append = 0;</td></tr>
<tr class="codeline" data-linenumber="891"><td class="num" id="LN891">891</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="892"><td class="num" id="LN892">892</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="893"><td class="num" id="LN893">893</td><td class="line">    <span class='comment'>/* Calculate final bytes (subtract one pair of metadata) */</span></td></tr>
<tr class="codeline" data-linenumber="894"><td class="num" id="LN894">894</td><td class="line">    size_t zlbytes = first_bytes + second_bytes -</td></tr>
<tr class="codeline" data-linenumber="895"><td class="num" id="LN895">895</td><td class="line">                     <span class='macro'>ZIPLIST_HEADER_SIZE<span class='macro_popup'>(sizeof(uint32_t)*2+sizeof(uint16_t))</span></span> - <span class='macro'>ZIPLIST_END_SIZE<span class='macro_popup'>(sizeof(uint8_t))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="896"><td class="num" id="LN896">896</td><td class="line">    size_t zllength = first_len + second_len;</td></tr>
<tr class="codeline" data-linenumber="897"><td class="num" id="LN897">897</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="898"><td class="num" id="LN898">898</td><td class="line">    <span class='comment'>/* Combined zl length should be limited within UINT16_MAX */</span></td></tr>
<tr class="codeline" data-linenumber="899"><td class="num" id="LN899">899</td><td class="line">    zllength = zllength &lt; <span class='macro'>UINT16_MAX<span class='macro_popup'>(65535)</span></span> ? zllength : <span class='macro'>UINT16_MAX<span class='macro_popup'>(65535)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="900"><td class="num" id="LN900">900</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="901"><td class="num" id="LN901">901</td><td class="line">    <span class='comment'>/* Save offset positions before we start ripping memory apart. */</span></td></tr>
<tr class="codeline" data-linenumber="902"><td class="num" id="LN902">902</td><td class="line">    size_t first_offset = <span class='macro'>intrev32ifbe(ZIPLIST_TAIL_OFFSET(*first))<span class='macro_popup'>((*((uint32_t*)((*first)+sizeof(uint32_t)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="903"><td class="num" id="LN903">903</td><td class="line">    size_t second_offset = <span class='macro'>intrev32ifbe(ZIPLIST_TAIL_OFFSET(*second))<span class='macro_popup'>((*((uint32_t*)((*second)+sizeof(uint32_t)))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="904"><td class="num" id="LN904">904</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="905"><td class="num" id="LN905">905</td><td class="line">    <span class='comment'>/* Extend target to new zlbytes then append or prepend source. */</span></td></tr>
<tr class="codeline" data-linenumber="906"><td class="num" id="LN906">906</td><td class="line">    target = zrealloc(target, zlbytes);</td></tr>
<tr class="codeline" data-linenumber="907"><td class="num" id="LN907">907</td><td class="line">    <span class='keyword'>if</span> (append) {</td></tr>
<tr class="codeline" data-linenumber="908"><td class="num" id="LN908">908</td><td class="line">        <span class='comment'>/* append == appending to target */</span></td></tr>
<tr class="codeline" data-linenumber="909"><td class="num" id="LN909">909</td><td class="line">        <span class='comment'>/* Copy source after target (copying over original [END]):</span></td></tr>
<tr class="codeline" data-linenumber="910"><td class="num" id="LN910">910</td><td class="line">         <span class='comment'>*   [TARGET - END, SOURCE - HEADER] */</span></td></tr>
<tr class="codeline" data-linenumber="911"><td class="num" id="LN911">911</td><td class="line">        memcpy(target + target_bytes - <span class='macro'>ZIPLIST_END_SIZE<span class='macro_popup'>(sizeof(uint8_t))</span></span>,</td></tr>
<tr class="codeline" data-linenumber="912"><td class="num" id="LN912">912</td><td class="line">               source + <span class='macro'>ZIPLIST_HEADER_SIZE<span class='macro_popup'>(sizeof(uint32_t)*2+sizeof(uint16_t))</span></span>,</td></tr>
<tr class="codeline" data-linenumber="913"><td class="num" id="LN913">913</td><td class="line">               source_bytes - <span class='macro'>ZIPLIST_HEADER_SIZE<span class='macro_popup'>(sizeof(uint32_t)*2+sizeof(uint16_t))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="914"><td class="num" id="LN914">914</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="915"><td class="num" id="LN915">915</td><td class="line">        <span class='comment'>/* !append == prepending to target */</span></td></tr>
<tr class="codeline" data-linenumber="916"><td class="num" id="LN916">916</td><td class="line">        <span class='comment'>/* Move target *contents* exactly size of (source - [END]),</span></td></tr>
<tr class="codeline" data-linenumber="917"><td class="num" id="LN917">917</td><td class="line">         <span class='comment'>* then copy source into vacated space (source - [END]):</span></td></tr>
<tr class="codeline" data-linenumber="918"><td class="num" id="LN918">918</td><td class="line">         <span class='comment'>*   [SOURCE - END, TARGET - HEADER] */</span></td></tr>
<tr class="codeline" data-linenumber="919"><td class="num" id="LN919">919</td><td class="line">        memmove(target + source_bytes - <span class='macro'>ZIPLIST_END_SIZE<span class='macro_popup'>(sizeof(uint8_t))</span></span>,</td></tr>
<tr class="codeline" data-linenumber="920"><td class="num" id="LN920">920</td><td class="line">                target + <span class='macro'>ZIPLIST_HEADER_SIZE<span class='macro_popup'>(sizeof(uint32_t)*2+sizeof(uint16_t))</span></span>,</td></tr>
<tr class="codeline" data-linenumber="921"><td class="num" id="LN921">921</td><td class="line">                target_bytes - <span class='macro'>ZIPLIST_HEADER_SIZE<span class='macro_popup'>(sizeof(uint32_t)*2+sizeof(uint16_t))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="922"><td class="num" id="LN922">922</td><td class="line">        memcpy(target, source, source_bytes - <span class='macro'>ZIPLIST_END_SIZE<span class='macro_popup'>(sizeof(uint8_t))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="923"><td class="num" id="LN923">923</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="924"><td class="num" id="LN924">924</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="925"><td class="num" id="LN925">925</td><td class="line">    <span class='comment'>/* Update header metadata. */</span></td></tr>
<tr class="codeline" data-linenumber="926"><td class="num" id="LN926">926</td><td class="line">    <span class='macro'>ZIPLIST_BYTES(target)<span class='macro_popup'>(*((uint32_t*)(target)))</span></span> = <span class='macro'>intrev32ifbe(zlbytes)<span class='macro_popup'>(zlbytes)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="927"><td class="num" id="LN927">927</td><td class="line">    <span class='macro'>ZIPLIST_LENGTH(target)<span class='macro_popup'>(*((uint16_t*)((target)+sizeof(uint32_t)*2)))</span></span> = <span class='macro'>intrev16ifbe(zllength)<span class='macro_popup'>(zllength)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="928"><td class="num" id="LN928">928</td><td class="line">    <span class='comment'>/* New tail offset is:</span></td></tr>
<tr class="codeline" data-linenumber="929"><td class="num" id="LN929">929</td><td class="line">     <span class='comment'>*   + N bytes of first ziplist</span></td></tr>
<tr class="codeline" data-linenumber="930"><td class="num" id="LN930">930</td><td class="line">     <span class='comment'>*   - 1 byte for [END] of first ziplist</span></td></tr>
<tr class="codeline" data-linenumber="931"><td class="num" id="LN931">931</td><td class="line">     <span class='comment'>*   + M bytes for the offset of the original tail of the second ziplist</span></td></tr>
<tr class="codeline" data-linenumber="932"><td class="num" id="LN932">932</td><td class="line">     <span class='comment'>*   - J bytes for HEADER because second_offset keeps no header. */</span></td></tr>
<tr class="codeline" data-linenumber="933"><td class="num" id="LN933">933</td><td class="line">    <span class='macro'>ZIPLIST_TAIL_OFFSET(target)<span class='macro_popup'>(*((uint32_t*)((target)+sizeof(uint32_t))))</span></span> = <span class='macro'>intrev32ifbe(<span class='macro_popup'>((first_bytes - (sizeof(uint8_t))) + (second_offset - (sizeof<br>(uint32_t)*2+sizeof(uint16_t))))</span></span></td></tr>
<tr class="codeline" data-linenumber="934"><td class="num" id="LN934">934</td><td class="line">                                   <span class='macro'>(first_bytes - ZIPLIST_END_SIZE) +<span class='macro_popup'>((first_bytes - (sizeof(uint8_t))) + (second_offset - (sizeof<br>(uint32_t)*2+sizeof(uint16_t))))</span></span></td></tr>
<tr class="codeline" data-linenumber="935"><td class="num" id="LN935">935</td><td class="line">                                   <span class='macro'>(second_offset - ZIPLIST_HEADER_SIZE))<span class='macro_popup'>((first_bytes - (sizeof(uint8_t))) + (second_offset - (sizeof<br>(uint32_t)*2+sizeof(uint16_t))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="936"><td class="num" id="LN936">936</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="937"><td class="num" id="LN937">937</td><td class="line">    <span class='comment'>/* __ziplistCascadeUpdate just fixes the prev length values until it finds a</span></td></tr>
<tr class="codeline" data-linenumber="938"><td class="num" id="LN938">938</td><td class="line">     <span class='comment'>* correct prev length value (then it assumes the rest of the list is okay).</span></td></tr>
<tr class="codeline" data-linenumber="939"><td class="num" id="LN939">939</td><td class="line">     <span class='comment'>* We tell CascadeUpdate to start at the first ziplist's tail element to fix</span></td></tr>
<tr class="codeline" data-linenumber="940"><td class="num" id="LN940">940</td><td class="line">     <span class='comment'>* the merge seam. */</span></td></tr>
<tr class="codeline" data-linenumber="941"><td class="num" id="LN941">941</td><td class="line">    target = __ziplistCascadeUpdate(target, target+first_offset);</td></tr>
<tr class="codeline" data-linenumber="942"><td class="num" id="LN942">942</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="943"><td class="num" id="LN943">943</td><td class="line">    <span class='comment'>/* Now free and NULL out what we didn't realloc */</span></td></tr>
<tr class="codeline" data-linenumber="944"><td class="num" id="LN944">944</td><td class="line">    <span class='keyword'>if</span> (append) {</td></tr>
<tr class="codeline" data-linenumber="945"><td class="num" id="LN945">945</td><td class="line">        zfree(*second);</td></tr>
<tr class="codeline" data-linenumber="946"><td class="num" id="LN946">946</td><td class="line">        *second = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="947"><td class="num" id="LN947">947</td><td class="line">        *first = target;</td></tr>
<tr class="codeline" data-linenumber="948"><td class="num" id="LN948">948</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="949"><td class="num" id="LN949">949</td><td class="line">        zfree(*first);</td></tr>
<tr class="codeline" data-linenumber="950"><td class="num" id="LN950">950</td><td class="line">        *first = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="951"><td class="num" id="LN951">951</td><td class="line">        *second = target;</td></tr>
<tr class="codeline" data-linenumber="952"><td class="num" id="LN952">952</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="953"><td class="num" id="LN953">953</td><td class="line">    <span class='keyword'>return</span> target;</td></tr>
<tr class="codeline" data-linenumber="954"><td class="num" id="LN954">954</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="955"><td class="num" id="LN955">955</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="956"><td class="num" id="LN956">956</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>char</span> *ziplistPush(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *s, <span class='keyword'>unsigned</span> <span class='keyword'>int</span> slen, <span class='keyword'>int</span> where) {</td></tr>
<tr class="codeline" data-linenumber="957"><td class="num" id="LN957">957</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p;</td></tr>
<tr class="codeline" data-linenumber="958"><td class="num" id="LN958">958</td><td class="line">    p = (where == <span class='macro'>ZIPLIST_HEAD<span class='macro_popup'>0</span></span>) ? <span class='macro'>ZIPLIST_ENTRY_HEAD(zl)<span class='macro_popup'>((zl)+(sizeof(uint32_t)*2+sizeof(uint16_t)))</span></span> : <span class='macro'>ZIPLIST_ENTRY_END(zl)<span class='macro_popup'>((zl)+((*((uint32_t*)(zl))))-1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="959"><td class="num" id="LN959">959</td><td class="line">    <span class='keyword'>return</span> __ziplistInsert(zl,p,s,slen);</td></tr>
<tr class="codeline" data-linenumber="960"><td class="num" id="LN960">960</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="961"><td class="num" id="LN961">961</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="962"><td class="num" id="LN962">962</td><td class="line"><span class='comment'>/* Returns an offset to use for iterating with ziplistNext. When the given</span></td></tr>
<tr class="codeline" data-linenumber="963"><td class="num" id="LN963">963</td><td class="line"> <span class='comment'>* index is negative, the list is traversed back to front. When the list</span></td></tr>
<tr class="codeline" data-linenumber="964"><td class="num" id="LN964">964</td><td class="line"> <span class='comment'>* doesn't contain an element at the provided index, NULL is returned. */</span></td></tr>
<tr class="codeline" data-linenumber="965"><td class="num" id="LN965">965</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>char</span> *ziplistIndex(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl, <span class='keyword'>int</span> index) {</td></tr>
<tr class="codeline" data-linenumber="966"><td class="num" id="LN966">966</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p;</td></tr>
<tr class="codeline" data-linenumber="967"><td class="num" id="LN967">967</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> prevlensize, prevlen = 0;</td></tr>
<tr class="codeline" data-linenumber="968"><td class="num" id="LN968">968</td><td class="line">    <span class='keyword'>if</span> (index &lt; 0) {</td></tr>
<tr class="codeline" data-linenumber="969"><td class="num" id="LN969">969</td><td class="line">        index = (-index)-1;</td></tr>
<tr class="codeline" data-linenumber="970"><td class="num" id="LN970">970</td><td class="line">        p = <span class='macro'>ZIPLIST_ENTRY_TAIL(zl)<span class='macro_popup'>((zl)+((*((uint32_t*)((zl)+sizeof(uint32_t))))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="971"><td class="num" id="LN971">971</td><td class="line">        <span class='keyword'>if</span> (p[0] != <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="972"><td class="num" id="LN972">972</td><td class="line">            <span class='macro'>ZIP_DECODE_PREVLEN(p, prevlensize, prevlen)<span class='macro_popup'>do { do { if ((p)[0] &lt; 254) { (prevlensize) = 1; } else { (<br>prevlensize) = 5; } } while(0); if ((prevlensize) == 1) { (prevlen<br>) = (p)[0]; } else if ((prevlensize) == 5) { ((sizeof((prevlen<br>)) == 4)?(void)0 : (_serverAssert("sizeof((prevlen)) == 4","ziplist.c"<br>,972),_exit(1))); memcpy(&amp;(prevlen), ((char*)(p)) + 1, 4)<br>; ((void)(0)); } } while(0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="973"><td class="num" id="LN973">973</td><td class="line">            <span class='keyword'>while</span> (prevlen &gt; 0 &amp;&amp; index--) {</td></tr>
<tr class="codeline" data-linenumber="974"><td class="num" id="LN974">974</td><td class="line">                p -= prevlen;</td></tr>
<tr class="codeline" data-linenumber="975"><td class="num" id="LN975">975</td><td class="line">                <span class='macro'>ZIP_DECODE_PREVLEN(p, prevlensize, prevlen)<span class='macro_popup'>do { do { if ((p)[0] &lt; 254) { (prevlensize) = 1; } else { (<br>prevlensize) = 5; } } while(0); if ((prevlensize) == 1) { (prevlen<br>) = (p)[0]; } else if ((prevlensize) == 5) { ((sizeof((prevlen<br>)) == 4)?(void)0 : (_serverAssert("sizeof((prevlen)) == 4","ziplist.c"<br>,975),_exit(1))); memcpy(&amp;(prevlen), ((char*)(p)) + 1, 4)<br>; ((void)(0)); } } while(0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="976"><td class="num" id="LN976">976</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="977"><td class="num" id="LN977">977</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="978"><td class="num" id="LN978">978</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="979"><td class="num" id="LN979">979</td><td class="line">        p = <span class='macro'>ZIPLIST_ENTRY_HEAD(zl)<span class='macro_popup'>((zl)+(sizeof(uint32_t)*2+sizeof(uint16_t)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="980"><td class="num" id="LN980">980</td><td class="line">        <span class='keyword'>while</span> (p[0] != <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span> &amp;&amp; index--) {</td></tr>
<tr class="codeline" data-linenumber="981"><td class="num" id="LN981">981</td><td class="line">            p += zipRawEntryLength(p);</td></tr>
<tr class="codeline" data-linenumber="982"><td class="num" id="LN982">982</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="983"><td class="num" id="LN983">983</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="984"><td class="num" id="LN984">984</td><td class="line">    <span class='keyword'>return</span> (p[0] == <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span> || index &gt; 0) ? <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> : p;</td></tr>
<tr class="codeline" data-linenumber="985"><td class="num" id="LN985">985</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="986"><td class="num" id="LN986">986</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="987"><td class="num" id="LN987">987</td><td class="line"><span class='comment'>/* Return pointer to next entry in ziplist.</span></td></tr>
<tr class="codeline" data-linenumber="988"><td class="num" id="LN988">988</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="989"><td class="num" id="LN989">989</td><td class="line"> <span class='comment'>* zl is the pointer to the ziplist</span></td></tr>
<tr class="codeline" data-linenumber="990"><td class="num" id="LN990">990</td><td class="line"> <span class='comment'>* p is the pointer to the current element</span></td></tr>
<tr class="codeline" data-linenumber="991"><td class="num" id="LN991">991</td><td class="line"> <span class='comment'>*</span></td></tr>
<tr class="codeline" data-linenumber="992"><td class="num" id="LN992">992</td><td class="line"> <span class='comment'>* The element after 'p' is returned, otherwise NULL if we are at the end. */</span></td></tr>
<tr class="codeline" data-linenumber="993"><td class="num" id="LN993">993</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>char</span> *ziplistNext(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p) {</td></tr>
<tr class="codeline" data-linenumber="994"><td class="num" id="LN994">994</td><td class="line">    ((<span class='keyword'>void</span>) zl);</td></tr>
<tr class="codeline" data-linenumber="995"><td class="num" id="LN995">995</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="996"><td class="num" id="LN996">996</td><td class="line">    <span class='comment'>/* "p" could be equal to ZIP_END, caused by ziplistDelete,</span></td></tr>
<tr class="codeline" data-linenumber="997"><td class="num" id="LN997">997</td><td class="line">     <span class='comment'>* and we should return NULL. Otherwise, we should return NULL</span></td></tr>
<tr class="codeline" data-linenumber="998"><td class="num" id="LN998">998</td><td class="line">     <span class='comment'>* when the *next* element is ZIP_END (there is no next entry). */</span></td></tr>
<tr class="codeline" data-linenumber="999"><td class="num" id="LN999">999</td><td class="line">    <span class='keyword'>if</span> (p[0] == <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1000"><td class="num" id="LN1000">1000</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1001"><td class="num" id="LN1001">1001</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1002"><td class="num" id="LN1002">1002</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1003"><td class="num" id="LN1003">1003</td><td class="line">    p += zipRawEntryLength(p);</td></tr>
<tr class="codeline" data-linenumber="1004"><td class="num" id="LN1004">1004</td><td class="line">    <span class='keyword'>if</span> (p[0] == <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1005"><td class="num" id="LN1005">1005</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1006"><td class="num" id="LN1006">1006</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1007"><td class="num" id="LN1007">1007</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1008"><td class="num" id="LN1008">1008</td><td class="line">    <span class='keyword'>return</span> p;</td></tr>
<tr class="codeline" data-linenumber="1009"><td class="num" id="LN1009">1009</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1010"><td class="num" id="LN1010">1010</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1011"><td class="num" id="LN1011">1011</td><td class="line"><span class='comment'>/* Return pointer to previous entry in ziplist. */</span></td></tr>
<tr class="codeline" data-linenumber="1012"><td class="num" id="LN1012">1012</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>char</span> *ziplistPrev(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p) {</td></tr>
<tr class="codeline" data-linenumber="1013"><td class="num" id="LN1013">1013</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> prevlensize, prevlen = 0;</td></tr>
<tr class="codeline" data-linenumber="1014"><td class="num" id="LN1014">1014</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1015"><td class="num" id="LN1015">1015</td><td class="line">    <span class='comment'>/* Iterating backwards from ZIP_END should return the tail. When "p" is</span></td></tr>
<tr class="codeline" data-linenumber="1016"><td class="num" id="LN1016">1016</td><td class="line">     <span class='comment'>* equal to the first element of the list, we're already at the head,</span></td></tr>
<tr class="codeline" data-linenumber="1017"><td class="num" id="LN1017">1017</td><td class="line">     <span class='comment'>* and should return NULL. */</span></td></tr>
<tr class="codeline" data-linenumber="1018"><td class="num" id="LN1018">1018</td><td class="line">    <span class='keyword'>if</span> (p[0] == <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1019"><td class="num" id="LN1019">1019</td><td class="line">        p = <span class='macro'>ZIPLIST_ENTRY_TAIL(zl)<span class='macro_popup'>((zl)+((*((uint32_t*)((zl)+sizeof(uint32_t))))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1020"><td class="num" id="LN1020">1020</td><td class="line">        <span class='keyword'>return</span> (p[0] == <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span>) ? <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> : p;</td></tr>
<tr class="codeline" data-linenumber="1021"><td class="num" id="LN1021">1021</td><td class="line">    } <span class='keyword'>else</span> <span class='keyword'>if</span> (p == <span class='macro'>ZIPLIST_ENTRY_HEAD(zl)<span class='macro_popup'>((zl)+(sizeof(uint32_t)*2+sizeof(uint16_t)))</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1022"><td class="num" id="LN1022">1022</td><td class="line">        <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1023"><td class="num" id="LN1023">1023</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1024"><td class="num" id="LN1024">1024</td><td class="line">        <span class='macro'>ZIP_DECODE_PREVLEN(p, prevlensize, prevlen)<span class='macro_popup'>do { do { if ((p)[0] &lt; 254) { (prevlensize) = 1; } else { (<br>prevlensize) = 5; } } while(0); if ((prevlensize) == 1) { (prevlen<br>) = (p)[0]; } else if ((prevlensize) == 5) { ((sizeof((prevlen<br>)) == 4)?(void)0 : (_serverAssert("sizeof((prevlen)) == 4","ziplist.c"<br>,1024),_exit(1))); memcpy(&amp;(prevlen), ((char*)(p)) + 1, 4<br>); ((void)(0)); } } while(0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1025"><td class="num" id="LN1025">1025</td><td class="line">        <span class='macro'>assert(prevlen &gt; 0)<span class='macro_popup'>((prevlen &gt; 0)?(void)0 : (_serverAssert("prevlen &gt; 0","ziplist.c"<br>,1025),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1026"><td class="num" id="LN1026">1026</td><td class="line">        <span class='keyword'>return</span> p-prevlen;</td></tr>
<tr class="codeline" data-linenumber="1027"><td class="num" id="LN1027">1027</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1028"><td class="num" id="LN1028">1028</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1029"><td class="num" id="LN1029">1029</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1030"><td class="num" id="LN1030">1030</td><td class="line"><span class='comment'>/* Get entry pointed to by 'p' and store in either '*sstr' or 'sval' depending</span></td></tr>
<tr class="codeline" data-linenumber="1031"><td class="num" id="LN1031">1031</td><td class="line"> <span class='comment'>* on the encoding of the entry. '*sstr' is always set to NULL to be able</span></td></tr>
<tr class="codeline" data-linenumber="1032"><td class="num" id="LN1032">1032</td><td class="line"> <span class='comment'>* to find out whether the string pointer or the integer value was set.</span></td></tr>
<tr class="codeline" data-linenumber="1033"><td class="num" id="LN1033">1033</td><td class="line"> <span class='comment'>* Return 0 if 'p' points to the end of the ziplist, 1 otherwise. */</span></td></tr>
<tr class="codeline" data-linenumber="1034"><td class="num" id="LN1034">1034</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>int</span> ziplistGet(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> **sstr, <span class='keyword'>unsigned</span> <span class='keyword'>int</span> *slen, <span class='keyword'>long</span> <span class='keyword'>long</span> *sval) {</td></tr>
<tr class="codeline" data-linenumber="1035"><td class="num" id="LN1035">1035</td><td class="line">    zlentry entry;</td></tr>
<tr class="codeline" data-linenumber="1036"><td class="num" id="LN1036">1036</td><td class="line">    <span class='keyword'>if</span> (p == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span> || p[0] == <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span>) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1037"><td class="num" id="LN1037">1037</td><td class="line">    <span class='keyword'>if</span> (sstr) *sstr = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1038"><td class="num" id="LN1038">1038</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1039"><td class="num" id="LN1039">1039</td><td class="line">    zipEntry(p, &amp;entry);</td></tr>
<tr class="codeline" data-linenumber="1040"><td class="num" id="LN1040">1040</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>ZIP_IS_STR(entry.encoding)<span class='macro_popup'>(((entry.encoding) &amp; 0xc0) &lt; 0xc0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1041"><td class="num" id="LN1041">1041</td><td class="line">        <span class='keyword'>if</span> (sstr) {</td></tr>
<tr class="codeline" data-linenumber="1042"><td class="num" id="LN1042">1042</td><td class="line">            *slen = entry.len;</td></tr>
<tr class="codeline" data-linenumber="1043"><td class="num" id="LN1043">1043</td><td class="line">            *sstr = p+entry.headersize;</td></tr>
<tr class="codeline" data-linenumber="1044"><td class="num" id="LN1044">1044</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1045"><td class="num" id="LN1045">1045</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1046"><td class="num" id="LN1046">1046</td><td class="line">        <span class='keyword'>if</span> (sval) {</td></tr>
<tr class="codeline" data-linenumber="1047"><td class="num" id="LN1047">1047</td><td class="line">            *sval = zipLoadInteger(p+entry.headersize,entry.encoding);</td></tr>
<tr class="codeline" data-linenumber="1048"><td class="num" id="LN1048">1048</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1049"><td class="num" id="LN1049">1049</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1050"><td class="num" id="LN1050">1050</td><td class="line">    <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1051"><td class="num" id="LN1051">1051</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1052"><td class="num" id="LN1052">1052</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1053"><td class="num" id="LN1053">1053</td><td class="line"><span class='comment'>/* Insert an entry at "p". */</span></td></tr>
<tr class="codeline" data-linenumber="1054"><td class="num" id="LN1054">1054</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>char</span> *ziplistInsert(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *s, <span class='keyword'>unsigned</span> <span class='keyword'>int</span> slen) {</td></tr>
<tr class="codeline" data-linenumber="1055"><td class="num" id="LN1055">1055</td><td class="line">    <span class='keyword'>return</span> __ziplistInsert(zl,p,s,slen);</td></tr>
<tr class="codeline" data-linenumber="1056"><td class="num" id="LN1056">1056</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1057"><td class="num" id="LN1057">1057</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1058"><td class="num" id="LN1058">1058</td><td class="line"><span class='comment'>/* Delete a single entry from the ziplist, pointed to by *p.</span></td></tr>
<tr class="codeline" data-linenumber="1059"><td class="num" id="LN1059">1059</td><td class="line"> <span class='comment'>* Also update *p in place, to be able to iterate over the</span></td></tr>
<tr class="codeline" data-linenumber="1060"><td class="num" id="LN1060">1060</td><td class="line"> <span class='comment'>* ziplist, while deleting entries. */</span></td></tr>
<tr class="codeline" data-linenumber="1061"><td class="num" id="LN1061">1061</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>char</span> *ziplistDelete(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> **p) {</td></tr>
<tr class="codeline" data-linenumber="1062"><td class="num" id="LN1062">1062</td><td class="line">    size_t offset = *p-zl;</td></tr>
<tr class="codeline" data-linenumber="1063"><td class="num" id="LN1063">1063</td><td class="line">    zl = __ziplistDelete(zl,*p,1);</td></tr>
<tr class="codeline" data-linenumber="1064"><td class="num" id="LN1064">1064</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1065"><td class="num" id="LN1065">1065</td><td class="line">    <span class='comment'>/* Store pointer to current element in p, because ziplistDelete will</span></td></tr>
<tr class="codeline" data-linenumber="1066"><td class="num" id="LN1066">1066</td><td class="line">     <span class='comment'>* do a realloc which might result in a different "zl"-pointer.</span></td></tr>
<tr class="codeline" data-linenumber="1067"><td class="num" id="LN1067">1067</td><td class="line">     <span class='comment'>* When the delete direction is back to front, we might delete the last</span></td></tr>
<tr class="codeline" data-linenumber="1068"><td class="num" id="LN1068">1068</td><td class="line">     <span class='comment'>* entry and end up with "p" pointing to ZIP_END, so check this. */</span></td></tr>
<tr class="codeline" data-linenumber="1069"><td class="num" id="LN1069">1069</td><td class="line">    *p = zl+offset;</td></tr>
<tr class="codeline" data-linenumber="1070"><td class="num" id="LN1070">1070</td><td class="line">    <span class='keyword'>return</span> zl;</td></tr>
<tr class="codeline" data-linenumber="1071"><td class="num" id="LN1071">1071</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1072"><td class="num" id="LN1072">1072</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1073"><td class="num" id="LN1073">1073</td><td class="line"><span class='comment'>/* Delete a range of entries from the ziplist. */</span></td></tr>
<tr class="codeline" data-linenumber="1074"><td class="num" id="LN1074">1074</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>char</span> *ziplistDeleteRange(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl, <span class='keyword'>int</span> index, <span class='keyword'>unsigned</span> <span class='keyword'>int</span> num) {</td></tr>
<tr class="codeline" data-linenumber="1075"><td class="num" id="LN1075">1075</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p = ziplistIndex(zl,index);</td></tr>
<tr class="codeline" data-linenumber="1076"><td class="num" id="LN1076">1076</td><td class="line">    <span class='keyword'>return</span> (p == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) ? zl : __ziplistDelete(zl,p,num);</td></tr>
<tr class="codeline" data-linenumber="1077"><td class="num" id="LN1077">1077</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1078"><td class="num" id="LN1078">1078</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1079"><td class="num" id="LN1079">1079</td><td class="line"><span class='comment'>/* Compare entry pointer to by 'p' with 'sstr' of length 'slen'. */</span></td></tr>
<tr class="codeline" data-linenumber="1080"><td class="num" id="LN1080">1080</td><td class="line"><span class='comment'>/* Return 1 if equal. */</span></td></tr>
<tr class="codeline" data-linenumber="1081"><td class="num" id="LN1081">1081</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>int</span> ziplistCompare(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *sstr, <span class='keyword'>unsigned</span> <span class='keyword'>int</span> slen) {</td></tr>
<tr class="codeline" data-linenumber="1082"><td class="num" id="LN1082">1082</td><td class="line">    zlentry entry;</td></tr>
<tr class="codeline" data-linenumber="1083"><td class="num" id="LN1083">1083</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> sencoding;</td></tr>
<tr class="codeline" data-linenumber="1084"><td class="num" id="LN1084">1084</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> zval, sval;</td></tr>
<tr class="codeline" data-linenumber="1085"><td class="num" id="LN1085">1085</td><td class="line">    <span class='keyword'>if</span> (p[0] == <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span>) <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1086"><td class="num" id="LN1086">1086</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1087"><td class="num" id="LN1087">1087</td><td class="line">    zipEntry(p, &amp;entry);</td></tr>
<tr class="codeline" data-linenumber="1088"><td class="num" id="LN1088">1088</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>ZIP_IS_STR(entry.encoding)<span class='macro_popup'>(((entry.encoding) &amp; 0xc0) &lt; 0xc0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1089"><td class="num" id="LN1089">1089</td><td class="line">        <span class='comment'>/* Raw compare */</span></td></tr>
<tr class="codeline" data-linenumber="1090"><td class="num" id="LN1090">1090</td><td class="line">        <span class='keyword'>if</span> (entry.len == slen) {</td></tr>
<tr class="codeline" data-linenumber="1091"><td class="num" id="LN1091">1091</td><td class="line">            <span class='keyword'>return</span> memcmp(p+entry.headersize,sstr,slen) == 0;</td></tr>
<tr class="codeline" data-linenumber="1092"><td class="num" id="LN1092">1092</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1093"><td class="num" id="LN1093">1093</td><td class="line">            <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1094"><td class="num" id="LN1094">1094</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1095"><td class="num" id="LN1095">1095</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1096"><td class="num" id="LN1096">1096</td><td class="line">        <span class='comment'>/* Try to compare encoded values. Don't compare encoding because</span></td></tr>
<tr class="codeline" data-linenumber="1097"><td class="num" id="LN1097">1097</td><td class="line">         <span class='comment'>* different implementations may encoded integers differently. */</span></td></tr>
<tr class="codeline" data-linenumber="1098"><td class="num" id="LN1098">1098</td><td class="line">        <span class='keyword'>if</span> (zipTryEncoding(sstr,slen,&amp;sval,&amp;sencoding)) {</td></tr>
<tr class="codeline" data-linenumber="1099"><td class="num" id="LN1099">1099</td><td class="line">          zval = zipLoadInteger(p+entry.headersize,entry.encoding);</td></tr>
<tr class="codeline" data-linenumber="1100"><td class="num" id="LN1100">1100</td><td class="line">          <span class='keyword'>return</span> zval == sval;</td></tr>
<tr class="codeline" data-linenumber="1101"><td class="num" id="LN1101">1101</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1102"><td class="num" id="LN1102">1102</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1103"><td class="num" id="LN1103">1103</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1104"><td class="num" id="LN1104">1104</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1105"><td class="num" id="LN1105">1105</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1106"><td class="num" id="LN1106">1106</td><td class="line"><span class='comment'>/* Find pointer to the entry equal to the specified entry. Skip 'skip' entries</span></td></tr>
<tr class="codeline" data-linenumber="1107"><td class="num" id="LN1107">1107</td><td class="line"> <span class='comment'>* between every comparison. Returns NULL when the field could not be found. */</span></td></tr>
<tr class="codeline" data-linenumber="1108"><td class="num" id="LN1108">1108</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>char</span> *ziplistFind(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p, <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *vstr, <span class='keyword'>unsigned</span> <span class='keyword'>int</span> vlen, <span class='keyword'>unsigned</span> <span class='keyword'>int</span> skip) {</td></tr>
<tr class="codeline" data-linenumber="1109"><td class="num" id="LN1109">1109</td><td class="line">    <span class='keyword'>int</span> skipcnt = 0;</td></tr>
<tr class="codeline" data-linenumber="1110"><td class="num" id="LN1110">1110</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> vencoding = 0;</td></tr>
<tr class="codeline" data-linenumber="1111"><td class="num" id="LN1111">1111</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> vll = 0;</td></tr>
<tr class="codeline" data-linenumber="1112"><td class="num" id="LN1112">1112</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1113"><td class="num" id="LN1113">1113</td><td class="line">    <span class='keyword'>while</span> (p[0] != <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1114"><td class="num" id="LN1114">1114</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>int</span> prevlensize, encoding, lensize, len;</td></tr>
<tr class="codeline" data-linenumber="1115"><td class="num" id="LN1115">1115</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *q;</td></tr>
<tr class="codeline" data-linenumber="1116"><td class="num" id="LN1116">1116</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1117"><td class="num" id="LN1117">1117</td><td class="line">        <span class='macro'>ZIP_DECODE_PREVLENSIZE(p, prevlensize)<span class='macro_popup'>do { if ((p)[0] &lt; 254) { (prevlensize) = 1; } else { (prevlensize<br>) = 5; } } while(0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1118"><td class="num" id="LN1118">1118</td><td class="line">        <span class='macro'>ZIP_DECODE_LENGTH(p + prevlensize, encoding, lensize, len)<span class='macro_popup'>do { do { ((encoding)) = ((p + prevlensize)[0]); if (((encoding<br>)) &lt; 0xc0) ((encoding)) &amp;= 0xc0; } while(0); if ((encoding<br>) &lt; 0xc0) { if ((encoding) == (0 &lt;&lt; 6)) { (lensize) =<br> 1; (len) = (p + prevlensize)[0] &amp; 0x3f; } else if ((encoding<br>) == (1 &lt;&lt; 6)) { (lensize) = 2; (len) = (((p + prevlensize<br>)[0] &amp; 0x3f) &lt;&lt; 8) | (p + prevlensize)[1]; } else if<br> ((encoding) == (2 &lt;&lt; 6)) { (lensize) = 5; (len) = ((p +<br> prevlensize)[1] &lt;&lt; 24) | ((p + prevlensize)[2] &lt;&lt;<br> 16) | ((p + prevlensize)[3] &lt;&lt; 8) | ((p + prevlensize)<br>[4]); } else { _serverPanic("ziplist.c",1118,"Invalid string encoding 0x%02X"<br>, (encoding)),_exit(1); } } else { (lensize) = 1; (len) = zipIntSize<br>(encoding); } } while(0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1119"><td class="num" id="LN1119">1119</td><td class="line">        q = p + prevlensize + lensize;</td></tr>
<tr class="codeline" data-linenumber="1120"><td class="num" id="LN1120">1120</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1121"><td class="num" id="LN1121">1121</td><td class="line">        <span class='keyword'>if</span> (skipcnt == 0) {</td></tr>
<tr class="codeline" data-linenumber="1122"><td class="num" id="LN1122">1122</td><td class="line">            <span class='comment'>/* Compare current entry with specified entry */</span></td></tr>
<tr class="codeline" data-linenumber="1123"><td class="num" id="LN1123">1123</td><td class="line">            <span class='keyword'>if</span> (<span class='macro'>ZIP_IS_STR(encoding)<span class='macro_popup'>(((encoding) &amp; 0xc0) &lt; 0xc0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1124"><td class="num" id="LN1124">1124</td><td class="line">                <span class='keyword'>if</span> (len == vlen &amp;&amp; memcmp(q, vstr, vlen) == 0) {</td></tr>
<tr class="codeline" data-linenumber="1125"><td class="num" id="LN1125">1125</td><td class="line">                    <span class='keyword'>return</span> p;</td></tr>
<tr class="codeline" data-linenumber="1126"><td class="num" id="LN1126">1126</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1127"><td class="num" id="LN1127">1127</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1128"><td class="num" id="LN1128">1128</td><td class="line">                <span class='comment'>/* Find out if the searched field can be encoded. Note that</span></td></tr>
<tr class="codeline" data-linenumber="1129"><td class="num" id="LN1129">1129</td><td class="line">                 <span class='comment'>* we do it only the first time, once done vencoding is set</span></td></tr>
<tr class="codeline" data-linenumber="1130"><td class="num" id="LN1130">1130</td><td class="line">                 <span class='comment'>* to non-zero and vll is set to the integer value. */</span></td></tr>
<tr class="codeline" data-linenumber="1131"><td class="num" id="LN1131">1131</td><td class="line">                <span class='keyword'>if</span> (vencoding == 0) {</td></tr>
<tr class="codeline" data-linenumber="1132"><td class="num" id="LN1132">1132</td><td class="line">                    <span class='keyword'>if</span> (!zipTryEncoding(vstr, vlen, &amp;vll, &amp;vencoding)) {</td></tr>
<tr class="codeline" data-linenumber="1133"><td class="num" id="LN1133">1133</td><td class="line">                        <span class='comment'>/* If the entry can't be encoded we set it to</span></td></tr>
<tr class="codeline" data-linenumber="1134"><td class="num" id="LN1134">1134</td><td class="line">                         <span class='comment'>* UCHAR_MAX so that we don't retry again the next</span></td></tr>
<tr class="codeline" data-linenumber="1135"><td class="num" id="LN1135">1135</td><td class="line">                         <span class='comment'>* time. */</span></td></tr>
<tr class="codeline" data-linenumber="1136"><td class="num" id="LN1136">1136</td><td class="line">                        vencoding = <span class='macro'>UCHAR_MAX<span class='macro_popup'>(127*2 +1)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1137"><td class="num" id="LN1137">1137</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="1138"><td class="num" id="LN1138">1138</td><td class="line">                    <span class='comment'>/* Must be non-zero by now */</span></td></tr>
<tr class="codeline" data-linenumber="1139"><td class="num" id="LN1139">1139</td><td class="line">                    <span class='macro'>assert(vencoding)<span class='macro_popup'>((vencoding)?(void)0 : (_serverAssert("vencoding","ziplist.c"<br>,1139),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1140"><td class="num" id="LN1140">1140</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1141"><td class="num" id="LN1141">1141</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1142"><td class="num" id="LN1142">1142</td><td class="line">                <span class='comment'>/* Compare current entry with specified entry, do it only</span></td></tr>
<tr class="codeline" data-linenumber="1143"><td class="num" id="LN1143">1143</td><td class="line">                 <span class='comment'>* if vencoding != UCHAR_MAX because if there is no encoding</span></td></tr>
<tr class="codeline" data-linenumber="1144"><td class="num" id="LN1144">1144</td><td class="line">                 <span class='comment'>* possible for the field it can't be a valid integer. */</span></td></tr>
<tr class="codeline" data-linenumber="1145"><td class="num" id="LN1145">1145</td><td class="line">                <span class='keyword'>if</span> (vencoding != <span class='macro'>UCHAR_MAX<span class='macro_popup'>(127*2 +1)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1146"><td class="num" id="LN1146">1146</td><td class="line">                    <span class='keyword'>long</span> <span class='keyword'>long</span> ll = zipLoadInteger(q, encoding);</td></tr>
<tr class="codeline" data-linenumber="1147"><td class="num" id="LN1147">1147</td><td class="line">                    <span class='keyword'>if</span> (ll == vll) {</td></tr>
<tr class="codeline" data-linenumber="1148"><td class="num" id="LN1148">1148</td><td class="line">                        <span class='keyword'>return</span> p;</td></tr>
<tr class="codeline" data-linenumber="1149"><td class="num" id="LN1149">1149</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="1150"><td class="num" id="LN1150">1150</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1151"><td class="num" id="LN1151">1151</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1152"><td class="num" id="LN1152">1152</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1153"><td class="num" id="LN1153">1153</td><td class="line">            <span class='comment'>/* Reset skip count */</span></td></tr>
<tr class="codeline" data-linenumber="1154"><td class="num" id="LN1154">1154</td><td class="line">            skipcnt = skip;</td></tr>
<tr class="codeline" data-linenumber="1155"><td class="num" id="LN1155">1155</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1156"><td class="num" id="LN1156">1156</td><td class="line">            <span class='comment'>/* Skip entry */</span></td></tr>
<tr class="codeline" data-linenumber="1157"><td class="num" id="LN1157">1157</td><td class="line">            skipcnt--;</td></tr>
<tr class="codeline" data-linenumber="1158"><td class="num" id="LN1158">1158</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1159"><td class="num" id="LN1159">1159</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1160"><td class="num" id="LN1160">1160</td><td class="line">        <span class='comment'>/* Move to next entry */</span></td></tr>
<tr class="codeline" data-linenumber="1161"><td class="num" id="LN1161">1161</td><td class="line">        p = q + len;</td></tr>
<tr class="codeline" data-linenumber="1162"><td class="num" id="LN1162">1162</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1163"><td class="num" id="LN1163">1163</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1164"><td class="num" id="LN1164">1164</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1165"><td class="num" id="LN1165">1165</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1166"><td class="num" id="LN1166">1166</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1167"><td class="num" id="LN1167">1167</td><td class="line"><span class='comment'>/* Return length of ziplist. */</span></td></tr>
<tr class="codeline" data-linenumber="1168"><td class="num" id="LN1168">1168</td><td class="line"><span class='keyword'>unsigned</span> <span class='keyword'>int</span> ziplistLen(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl) {</td></tr>
<tr class="codeline" data-linenumber="1169"><td class="num" id="LN1169">1169</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> len = 0;</td></tr>
<tr class="codeline" data-linenumber="1170"><td class="num" id="LN1170">1170</td><td class="line">    <span class='keyword'>if</span> (<span class='macro'>intrev16ifbe(ZIPLIST_LENGTH(zl))<span class='macro_popup'>((*((uint16_t*)((zl)+sizeof(uint32_t)*2))))</span></span> &lt; <span class='macro'>UINT16_MAX<span class='macro_popup'>(65535)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1171"><td class="num" id="LN1171">1171</td><td class="line">        len = <span class='macro'>intrev16ifbe(ZIPLIST_LENGTH(zl))<span class='macro_popup'>((*((uint16_t*)((zl)+sizeof(uint32_t)*2))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1172"><td class="num" id="LN1172">1172</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1173"><td class="num" id="LN1173">1173</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p = zl+<span class='macro'>ZIPLIST_HEADER_SIZE<span class='macro_popup'>(sizeof(uint32_t)*2+sizeof(uint16_t))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1174"><td class="num" id="LN1174">1174</td><td class="line">        <span class='keyword'>while</span> (*p != <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1175"><td class="num" id="LN1175">1175</td><td class="line">            p += zipRawEntryLength(p);</td></tr>
<tr class="codeline" data-linenumber="1176"><td class="num" id="LN1176">1176</td><td class="line">            len++;</td></tr>
<tr class="codeline" data-linenumber="1177"><td class="num" id="LN1177">1177</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1178"><td class="num" id="LN1178">1178</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1179"><td class="num" id="LN1179">1179</td><td class="line">        <span class='comment'>/* Re-store length if small enough */</span></td></tr>
<tr class="codeline" data-linenumber="1180"><td class="num" id="LN1180">1180</td><td class="line">        <span class='keyword'>if</span> (len &lt; <span class='macro'>UINT16_MAX<span class='macro_popup'>(65535)</span></span>) <span class='macro'>ZIPLIST_LENGTH(zl)<span class='macro_popup'>(*((uint16_t*)((zl)+sizeof(uint32_t)*2)))</span></span> = <span class='macro'>intrev16ifbe(len)<span class='macro_popup'>(len)</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1181"><td class="num" id="LN1181">1181</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1182"><td class="num" id="LN1182">1182</td><td class="line">    <span class='keyword'>return</span> len;</td></tr>
<tr class="codeline" data-linenumber="1183"><td class="num" id="LN1183">1183</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1184"><td class="num" id="LN1184">1184</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1185"><td class="num" id="LN1185">1185</td><td class="line"><span class='comment'>/* Return ziplist blob size in bytes. */</span></td></tr>
<tr class="codeline" data-linenumber="1186"><td class="num" id="LN1186">1186</td><td class="line">size_t ziplistBlobLen(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl) {</td></tr>
<tr class="codeline" data-linenumber="1187"><td class="num" id="LN1187">1187</td><td class="line">    <span class='keyword'>return</span> <span class='macro'>intrev32ifbe(ZIPLIST_BYTES(zl))<span class='macro_popup'>((*((uint32_t*)(zl))))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1188"><td class="num" id="LN1188">1188</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1189"><td class="num" id="LN1189">1189</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1190"><td class="num" id="LN1190">1190</td><td class="line"><span class='keyword'>void</span> ziplistRepr(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl) {</td></tr>
<tr class="codeline" data-linenumber="1191"><td class="num" id="LN1191">1191</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p;</td></tr>
<tr class="codeline" data-linenumber="1192"><td class="num" id="LN1192">1192</td><td class="line">    <span class='keyword'>int</span> index = 0;</td></tr>
<tr class="codeline" data-linenumber="1193"><td class="num" id="LN1193">1193</td><td class="line">    zlentry entry;</td></tr>
<tr class="codeline" data-linenumber="1194"><td class="num" id="LN1194">1194</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1195"><td class="num" id="LN1195">1195</td><td class="line">    printf(</td></tr>
<tr class="codeline" data-linenumber="1196"><td class="num" id="LN1196">1196</td><td class="line">        <span class='string_literal'>"{total bytes %d} "</span></td></tr>
<tr class="codeline" data-linenumber="1197"><td class="num" id="LN1197">1197</td><td class="line">        <span class='string_literal'>"{num entries %u}\n"</span></td></tr>
<tr class="codeline" data-linenumber="1198"><td class="num" id="LN1198">1198</td><td class="line">        <span class='string_literal'>"{tail offset %u}\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="1199"><td class="num" id="LN1199">1199</td><td class="line">        <span class='macro'>intrev32ifbe(ZIPLIST_BYTES(zl))<span class='macro_popup'>((*((uint32_t*)(zl))))</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1200"><td class="num" id="LN1200">1200</td><td class="line">        <span class='macro'>intrev16ifbe(ZIPLIST_LENGTH(zl))<span class='macro_popup'>((*((uint16_t*)((zl)+sizeof(uint32_t)*2))))</span></span>,</td></tr>
<tr class="codeline" data-linenumber="1201"><td class="num" id="LN1201">1201</td><td class="line">        <span class='macro'>intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))<span class='macro_popup'>((*((uint32_t*)((zl)+sizeof(uint32_t)))))</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1202"><td class="num" id="LN1202">1202</td><td class="line">    p = <span class='macro'>ZIPLIST_ENTRY_HEAD(zl)<span class='macro_popup'>((zl)+(sizeof(uint32_t)*2+sizeof(uint16_t)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1203"><td class="num" id="LN1203">1203</td><td class="line">    <span class='keyword'>while</span>(*p != <span class='macro'>ZIP_END<span class='macro_popup'>255</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1204"><td class="num" id="LN1204">1204</td><td class="line">        zipEntry(p, &amp;entry);</td></tr>
<tr class="codeline" data-linenumber="1205"><td class="num" id="LN1205">1205</td><td class="line">        printf(</td></tr>
<tr class="codeline" data-linenumber="1206"><td class="num" id="LN1206">1206</td><td class="line">            <span class='string_literal'>"{\n"</span></td></tr>
<tr class="codeline" data-linenumber="1207"><td class="num" id="LN1207">1207</td><td class="line">                <span class='string_literal'>"\taddr 0x%08lx,\n"</span></td></tr>
<tr class="codeline" data-linenumber="1208"><td class="num" id="LN1208">1208</td><td class="line">                <span class='string_literal'>"\tindex %2d,\n"</span></td></tr>
<tr class="codeline" data-linenumber="1209"><td class="num" id="LN1209">1209</td><td class="line">                <span class='string_literal'>"\toffset %5ld,\n"</span></td></tr>
<tr class="codeline" data-linenumber="1210"><td class="num" id="LN1210">1210</td><td class="line">                <span class='string_literal'>"\thdr+entry len: %5u,\n"</span></td></tr>
<tr class="codeline" data-linenumber="1211"><td class="num" id="LN1211">1211</td><td class="line">                <span class='string_literal'>"\thdr len%2u,\n"</span></td></tr>
<tr class="codeline" data-linenumber="1212"><td class="num" id="LN1212">1212</td><td class="line">                <span class='string_literal'>"\tprevrawlen: %5u,\n"</span></td></tr>
<tr class="codeline" data-linenumber="1213"><td class="num" id="LN1213">1213</td><td class="line">                <span class='string_literal'>"\tprevrawlensize: %2u,\n"</span></td></tr>
<tr class="codeline" data-linenumber="1214"><td class="num" id="LN1214">1214</td><td class="line">                <span class='string_literal'>"\tpayload %5u\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="1215"><td class="num" id="LN1215">1215</td><td class="line">            (<span class='keyword'>long</span> <span class='keyword'>unsigned</span>)p,</td></tr>
<tr class="codeline" data-linenumber="1216"><td class="num" id="LN1216">1216</td><td class="line">            index,</td></tr>
<tr class="codeline" data-linenumber="1217"><td class="num" id="LN1217">1217</td><td class="line">            (<span class='keyword'>unsigned</span> <span class='keyword'>long</span>) (p-zl),</td></tr>
<tr class="codeline" data-linenumber="1218"><td class="num" id="LN1218">1218</td><td class="line">            entry.headersize+entry.len,</td></tr>
<tr class="codeline" data-linenumber="1219"><td class="num" id="LN1219">1219</td><td class="line">            entry.headersize,</td></tr>
<tr class="codeline" data-linenumber="1220"><td class="num" id="LN1220">1220</td><td class="line">            entry.prevrawlen,</td></tr>
<tr class="codeline" data-linenumber="1221"><td class="num" id="LN1221">1221</td><td class="line">            entry.prevrawlensize,</td></tr>
<tr class="codeline" data-linenumber="1222"><td class="num" id="LN1222">1222</td><td class="line">            entry.len);</td></tr>
<tr class="codeline" data-linenumber="1223"><td class="num" id="LN1223">1223</td><td class="line">        printf(<span class='string_literal'>"\tbytes: "</span>);</td></tr>
<tr class="codeline" data-linenumber="1224"><td class="num" id="LN1224">1224</td><td class="line">        <span class='keyword'>for</span> (<span class='keyword'>unsigned</span> <span class='keyword'>int</span> i = 0; i &lt; entry.headersize+entry.len; i++) {</td></tr>
<tr class="codeline" data-linenumber="1225"><td class="num" id="LN1225">1225</td><td class="line">            printf(<span class='string_literal'>"%02x|"</span>,p[i]);</td></tr>
<tr class="codeline" data-linenumber="1226"><td class="num" id="LN1226">1226</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1227"><td class="num" id="LN1227">1227</td><td class="line">        printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1228"><td class="num" id="LN1228">1228</td><td class="line">        p += entry.headersize;</td></tr>
<tr class="codeline" data-linenumber="1229"><td class="num" id="LN1229">1229</td><td class="line">        <span class='keyword'>if</span> (<span class='macro'>ZIP_IS_STR(entry.encoding)<span class='macro_popup'>(((entry.encoding) &amp; 0xc0) &lt; 0xc0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1230"><td class="num" id="LN1230">1230</td><td class="line">            printf(<span class='string_literal'>"\t[str]"</span>);</td></tr>
<tr class="codeline" data-linenumber="1231"><td class="num" id="LN1231">1231</td><td class="line">            <span class='keyword'>if</span> (entry.len &gt; 40) {</td></tr>
<tr class="codeline" data-linenumber="1232"><td class="num" id="LN1232">1232</td><td class="line">                <span class='keyword'>if</span> (fwrite(p,40,1,<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>) == 0) perror(<span class='string_literal'>"fwrite"</span>);</td></tr>
<tr class="codeline" data-linenumber="1233"><td class="num" id="LN1233">1233</td><td class="line">                printf(<span class='string_literal'>"..."</span>);</td></tr>
<tr class="codeline" data-linenumber="1234"><td class="num" id="LN1234">1234</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1235"><td class="num" id="LN1235">1235</td><td class="line">                <span class='keyword'>if</span> (entry.len &amp;&amp;</td></tr>
<tr class="codeline" data-linenumber="1236"><td class="num" id="LN1236">1236</td><td class="line">                    fwrite(p,entry.len,1,<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>) == 0) perror(<span class='string_literal'>"fwrite"</span>);</td></tr>
<tr class="codeline" data-linenumber="1237"><td class="num" id="LN1237">1237</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1238"><td class="num" id="LN1238">1238</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1239"><td class="num" id="LN1239">1239</td><td class="line">            printf(<span class='string_literal'>"\t[int]%lld"</span>, (<span class='keyword'>long</span> <span class='keyword'>long</span>) zipLoadInteger(p,entry.encoding));</td></tr>
<tr class="codeline" data-linenumber="1240"><td class="num" id="LN1240">1240</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1241"><td class="num" id="LN1241">1241</td><td class="line">        printf(<span class='string_literal'>"\n}\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1242"><td class="num" id="LN1242">1242</td><td class="line">        p += entry.len;</td></tr>
<tr class="codeline" data-linenumber="1243"><td class="num" id="LN1243">1243</td><td class="line">        index++;</td></tr>
<tr class="codeline" data-linenumber="1244"><td class="num" id="LN1244">1244</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1245"><td class="num" id="LN1245">1245</td><td class="line">    printf(<span class='string_literal'>"{end}\n\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1246"><td class="num" id="LN1246">1246</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1247"><td class="num" id="LN1247">1247</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1248"><td class="num" id="LN1248">1248</td><td class="line"><span class='directive'>#ifdef REDIS_TEST</span></td></tr>
<tr class="codeline" data-linenumber="1249"><td class="num" id="LN1249">1249</td><td class="line"><span class='directive'>#include &lt;sys/time.h&gt;</span></td></tr>
<tr class="codeline" data-linenumber="1250"><td class="num" id="LN1250">1250</td><td class="line"><span class='directive'>#include "adlist.h"</span></td></tr>
<tr class="codeline" data-linenumber="1251"><td class="num" id="LN1251">1251</td><td class="line"><span class='directive'>#include "sds.h"</span></td></tr>
<tr class="codeline" data-linenumber="1252"><td class="num" id="LN1252">1252</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1253"><td class="num" id="LN1253">1253</td><td class="line"><span class='directive'>#define debug(f, ...) { if (DEBUG) printf(f, __VA_ARGS__); }</span></td></tr>
<tr class="codeline" data-linenumber="1254"><td class="num" id="LN1254">1254</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1255"><td class="num" id="LN1255">1255</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *createList() {</td></tr>
<tr class="codeline" data-linenumber="1256"><td class="num" id="LN1256">1256</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl = ziplistNew();</td></tr>
<tr class="codeline" data-linenumber="1257"><td class="num" id="LN1257">1257</td><td class="line">    zl = ziplistPush(zl, (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)<span class='string_literal'>"foo"</span>, 3, <span class='macro'>ZIPLIST_TAIL<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1258"><td class="num" id="LN1258">1258</td><td class="line">    zl = ziplistPush(zl, (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)<span class='string_literal'>"quux"</span>, 4, <span class='macro'>ZIPLIST_TAIL<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1259"><td class="num" id="LN1259">1259</td><td class="line">    zl = ziplistPush(zl, (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)<span class='string_literal'>"hello"</span>, 5, <span class='macro'>ZIPLIST_HEAD<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1260"><td class="num" id="LN1260">1260</td><td class="line">    zl = ziplistPush(zl, (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)<span class='string_literal'>"1024"</span>, 4, <span class='macro'>ZIPLIST_TAIL<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1261"><td class="num" id="LN1261">1261</td><td class="line">    <span class='keyword'>return</span> zl;</td></tr>
<tr class="codeline" data-linenumber="1262"><td class="num" id="LN1262">1262</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1263"><td class="num" id="LN1263">1263</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1264"><td class="num" id="LN1264">1264</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *createIntList() {</td></tr>
<tr class="codeline" data-linenumber="1265"><td class="num" id="LN1265">1265</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl = ziplistNew();</td></tr>
<tr class="codeline" data-linenumber="1266"><td class="num" id="LN1266">1266</td><td class="line">    <span class='keyword'>char</span> buf[32];</td></tr>
<tr class="codeline" data-linenumber="1267"><td class="num" id="LN1267">1267</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1268"><td class="num" id="LN1268">1268</td><td class="line">    sprintf(buf, <span class='string_literal'>"100"</span>);</td></tr>
<tr class="codeline" data-linenumber="1269"><td class="num" id="LN1269">1269</td><td class="line">    zl = ziplistPush(zl, (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)buf, strlen(buf), <span class='macro'>ZIPLIST_TAIL<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1270"><td class="num" id="LN1270">1270</td><td class="line">    sprintf(buf, <span class='string_literal'>"128000"</span>);</td></tr>
<tr class="codeline" data-linenumber="1271"><td class="num" id="LN1271">1271</td><td class="line">    zl = ziplistPush(zl, (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)buf, strlen(buf), <span class='macro'>ZIPLIST_TAIL<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1272"><td class="num" id="LN1272">1272</td><td class="line">    sprintf(buf, <span class='string_literal'>"-100"</span>);</td></tr>
<tr class="codeline" data-linenumber="1273"><td class="num" id="LN1273">1273</td><td class="line">    zl = ziplistPush(zl, (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)buf, strlen(buf), <span class='macro'>ZIPLIST_HEAD<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1274"><td class="num" id="LN1274">1274</td><td class="line">    sprintf(buf, <span class='string_literal'>"4294967296"</span>);</td></tr>
<tr class="codeline" data-linenumber="1275"><td class="num" id="LN1275">1275</td><td class="line">    zl = ziplistPush(zl, (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)buf, strlen(buf), <span class='macro'>ZIPLIST_HEAD<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1276"><td class="num" id="LN1276">1276</td><td class="line">    sprintf(buf, <span class='string_literal'>"non integer"</span>);</td></tr>
<tr class="codeline" data-linenumber="1277"><td class="num" id="LN1277">1277</td><td class="line">    zl = ziplistPush(zl, (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)buf, strlen(buf), <span class='macro'>ZIPLIST_TAIL<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1278"><td class="num" id="LN1278">1278</td><td class="line">    sprintf(buf, <span class='string_literal'>"much much longer non integer"</span>);</td></tr>
<tr class="codeline" data-linenumber="1279"><td class="num" id="LN1279">1279</td><td class="line">    zl = ziplistPush(zl, (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)buf, strlen(buf), <span class='macro'>ZIPLIST_TAIL<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1280"><td class="num" id="LN1280">1280</td><td class="line">    <span class='keyword'>return</span> zl;</td></tr>
<tr class="codeline" data-linenumber="1281"><td class="num" id="LN1281">1281</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1282"><td class="num" id="LN1282">1282</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1283"><td class="num" id="LN1283">1283</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>long</span> <span class='keyword'>long</span> usec(<span class='keyword'>void</span>) {</td></tr>
<tr class="codeline" data-linenumber="1284"><td class="num" id="LN1284">1284</td><td class="line">    <span class='keyword'>struct</span> timeval tv;</td></tr>
<tr class="codeline" data-linenumber="1285"><td class="num" id="LN1285">1285</td><td class="line">    gettimeofday(&amp;tv,<span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1286"><td class="num" id="LN1286">1286</td><td class="line">    <span class='keyword'>return</span> (((<span class='keyword'>long</span> <span class='keyword'>long</span>)tv.tv_sec)*1000000)+tv.tv_usec;</td></tr>
<tr class="codeline" data-linenumber="1287"><td class="num" id="LN1287">1287</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1288"><td class="num" id="LN1288">1288</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1289"><td class="num" id="LN1289">1289</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> stress(<span class='keyword'>int</span> pos, <span class='keyword'>int</span> num, <span class='keyword'>int</span> maxsize, <span class='keyword'>int</span> dnum) {</td></tr>
<tr class="codeline" data-linenumber="1290"><td class="num" id="LN1290">1290</td><td class="line">    <span class='keyword'>int</span> i,j,k;</td></tr>
<tr class="codeline" data-linenumber="1291"><td class="num" id="LN1291">1291</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl;</td></tr>
<tr class="codeline" data-linenumber="1292"><td class="num" id="LN1292">1292</td><td class="line">    <span class='keyword'>char</span> posstr[2][5] = { <span class='string_literal'>"HEAD"</span>, <span class='string_literal'>"TAIL"</span> };</td></tr>
<tr class="codeline" data-linenumber="1293"><td class="num" id="LN1293">1293</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> start;</td></tr>
<tr class="codeline" data-linenumber="1294"><td class="num" id="LN1294">1294</td><td class="line">    <span class='keyword'>for</span> (i = 0; i &lt; maxsize; i+=dnum) {</td></tr>
<tr class="codeline" data-linenumber="1295"><td class="num" id="LN1295">1295</td><td class="line">        zl = ziplistNew();</td></tr>
<tr class="codeline" data-linenumber="1296"><td class="num" id="LN1296">1296</td><td class="line">        <span class='keyword'>for</span> (j = 0; j &lt; i; j++) {</td></tr>
<tr class="codeline" data-linenumber="1297"><td class="num" id="LN1297">1297</td><td class="line">            zl = ziplistPush(zl,(<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)<span class='string_literal'>"quux"</span>,4,<span class='macro'>ZIPLIST_TAIL<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1298"><td class="num" id="LN1298">1298</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1299"><td class="num" id="LN1299">1299</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1300"><td class="num" id="LN1300">1300</td><td class="line">        <span class='comment'>/* Do num times a push+pop from pos */</span></td></tr>
<tr class="codeline" data-linenumber="1301"><td class="num" id="LN1301">1301</td><td class="line">        start = usec();</td></tr>
<tr class="codeline" data-linenumber="1302"><td class="num" id="LN1302">1302</td><td class="line">        <span class='keyword'>for</span> (k = 0; k &lt; num; k++) {</td></tr>
<tr class="codeline" data-linenumber="1303"><td class="num" id="LN1303">1303</td><td class="line">            zl = ziplistPush(zl,(<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)<span class='string_literal'>"quux"</span>,4,pos);</td></tr>
<tr class="codeline" data-linenumber="1304"><td class="num" id="LN1304">1304</td><td class="line">            zl = ziplistDeleteRange(zl,0,1);</td></tr>
<tr class="codeline" data-linenumber="1305"><td class="num" id="LN1305">1305</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1306"><td class="num" id="LN1306">1306</td><td class="line">        printf(<span class='string_literal'>"List size: %8d, bytes: %8d, %dx push+pop (%s): %6lld usec\n"</span>,</td></tr>
<tr class="codeline" data-linenumber="1307"><td class="num" id="LN1307">1307</td><td class="line">            i,<span class='macro'>intrev32ifbe(ZIPLIST_BYTES(zl))<span class='macro_popup'>((*((uint32_t*)(zl))))</span></span>,num,posstr[pos],usec()-start);</td></tr>
<tr class="codeline" data-linenumber="1308"><td class="num" id="LN1308">1308</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1309"><td class="num" id="LN1309">1309</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1310"><td class="num" id="LN1310">1310</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1311"><td class="num" id="LN1311">1311</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1312"><td class="num" id="LN1312">1312</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *pop(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl, <span class='keyword'>int</span> where) {</td></tr>
<tr class="codeline" data-linenumber="1313"><td class="num" id="LN1313">1313</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p, *vstr;</td></tr>
<tr class="codeline" data-linenumber="1314"><td class="num" id="LN1314">1314</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> vlen;</td></tr>
<tr class="codeline" data-linenumber="1315"><td class="num" id="LN1315">1315</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> vlong;</td></tr>
<tr class="codeline" data-linenumber="1316"><td class="num" id="LN1316">1316</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1317"><td class="num" id="LN1317">1317</td><td class="line">    p = ziplistIndex(zl,where == <span class='macro'>ZIPLIST_HEAD<span class='macro_popup'>0</span></span> ? 0 : -1);</td></tr>
<tr class="codeline" data-linenumber="1318"><td class="num" id="LN1318">1318</td><td class="line">    <span class='keyword'>if</span> (ziplistGet(p,&amp;vstr,&amp;vlen,&amp;vlong)) {</td></tr>
<tr class="codeline" data-linenumber="1319"><td class="num" id="LN1319">1319</td><td class="line">        <span class='keyword'>if</span> (where == <span class='macro'>ZIPLIST_HEAD<span class='macro_popup'>0</span></span>)</td></tr>
<tr class="codeline" data-linenumber="1320"><td class="num" id="LN1320">1320</td><td class="line">            printf(<span class='string_literal'>"Pop head: "</span>);</td></tr>
<tr class="codeline" data-linenumber="1321"><td class="num" id="LN1321">1321</td><td class="line">        <span class='keyword'>else</span></td></tr>
<tr class="codeline" data-linenumber="1322"><td class="num" id="LN1322">1322</td><td class="line">            printf(<span class='string_literal'>"Pop tail: "</span>);</td></tr>
<tr class="codeline" data-linenumber="1323"><td class="num" id="LN1323">1323</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1324"><td class="num" id="LN1324">1324</td><td class="line">        <span class='keyword'>if</span> (vstr) {</td></tr>
<tr class="codeline" data-linenumber="1325"><td class="num" id="LN1325">1325</td><td class="line">            <span class='keyword'>if</span> (vlen &amp;&amp; fwrite(vstr,vlen,1,<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>) == 0) perror(<span class='string_literal'>"fwrite"</span>);</td></tr>
<tr class="codeline" data-linenumber="1326"><td class="num" id="LN1326">1326</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1327"><td class="num" id="LN1327">1327</td><td class="line">        <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1328"><td class="num" id="LN1328">1328</td><td class="line">            printf(<span class='string_literal'>"%lld"</span>, vlong);</td></tr>
<tr class="codeline" data-linenumber="1329"><td class="num" id="LN1329">1329</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1330"><td class="num" id="LN1330">1330</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1331"><td class="num" id="LN1331">1331</td><td class="line">        printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1332"><td class="num" id="LN1332">1332</td><td class="line">        <span class='keyword'>return</span> ziplistDelete(zl,&amp;p);</td></tr>
<tr class="codeline" data-linenumber="1333"><td class="num" id="LN1333">1333</td><td class="line">    } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1334"><td class="num" id="LN1334">1334</td><td class="line">        printf(<span class='string_literal'>"ERROR: Could not pop\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1335"><td class="num" id="LN1335">1335</td><td class="line">        exit(1);</td></tr>
<tr class="codeline" data-linenumber="1336"><td class="num" id="LN1336">1336</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1337"><td class="num" id="LN1337">1337</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1338"><td class="num" id="LN1338">1338</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1339"><td class="num" id="LN1339">1339</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>int</span> randstring(<span class='keyword'>char</span> *target, <span class='keyword'>unsigned</span> <span class='keyword'>int</span> min, <span class='keyword'>unsigned</span> <span class='keyword'>int</span> max) {</td></tr>
<tr class="codeline" data-linenumber="1340"><td class="num" id="LN1340">1340</td><td class="line">    <span class='keyword'>int</span> p = 0;</td></tr>
<tr class="codeline" data-linenumber="1341"><td class="num" id="LN1341">1341</td><td class="line">    <span class='keyword'>int</span> len = min+rand()%(max-min+1);</td></tr>
<tr class="codeline" data-linenumber="1342"><td class="num" id="LN1342">1342</td><td class="line">    <span class='keyword'>int</span> minval, maxval;</td></tr>
<tr class="codeline" data-linenumber="1343"><td class="num" id="LN1343">1343</td><td class="line">    <span class='keyword'>switch</span>(rand() % 3) {</td></tr>
<tr class="codeline" data-linenumber="1344"><td class="num" id="LN1344">1344</td><td class="line">    <span class='keyword'>case</span> 0:</td></tr>
<tr class="codeline" data-linenumber="1345"><td class="num" id="LN1345">1345</td><td class="line">        minval = 0;</td></tr>
<tr class="codeline" data-linenumber="1346"><td class="num" id="LN1346">1346</td><td class="line">        maxval = 255;</td></tr>
<tr class="codeline" data-linenumber="1347"><td class="num" id="LN1347">1347</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1348"><td class="num" id="LN1348">1348</td><td class="line">    <span class='keyword'>case</span> 1:</td></tr>
<tr class="codeline" data-linenumber="1349"><td class="num" id="LN1349">1349</td><td class="line">        minval = 48;</td></tr>
<tr class="codeline" data-linenumber="1350"><td class="num" id="LN1350">1350</td><td class="line">        maxval = 122;</td></tr>
<tr class="codeline" data-linenumber="1351"><td class="num" id="LN1351">1351</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1352"><td class="num" id="LN1352">1352</td><td class="line">    <span class='keyword'>case</span> 2:</td></tr>
<tr class="codeline" data-linenumber="1353"><td class="num" id="LN1353">1353</td><td class="line">        minval = 48;</td></tr>
<tr class="codeline" data-linenumber="1354"><td class="num" id="LN1354">1354</td><td class="line">        maxval = 52;</td></tr>
<tr class="codeline" data-linenumber="1355"><td class="num" id="LN1355">1355</td><td class="line">    <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1356"><td class="num" id="LN1356">1356</td><td class="line">    <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="1357"><td class="num" id="LN1357">1357</td><td class="line">        <span class='macro'>assert(NULL)<span class='macro_popup'>((((void*)0))?(void)0 : (_serverAssert("NULL","ziplist.c",1357<br>),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1358"><td class="num" id="LN1358">1358</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1359"><td class="num" id="LN1359">1359</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1360"><td class="num" id="LN1360">1360</td><td class="line">    <span class='keyword'>while</span>(p &lt; len)</td></tr>
<tr class="codeline" data-linenumber="1361"><td class="num" id="LN1361">1361</td><td class="line">        target[p++] = minval+rand()%(maxval-minval+1);</td></tr>
<tr class="codeline" data-linenumber="1362"><td class="num" id="LN1362">1362</td><td class="line">    <span class='keyword'>return</span> len;</td></tr>
<tr class="codeline" data-linenumber="1363"><td class="num" id="LN1363">1363</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1364"><td class="num" id="LN1364">1364</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1365"><td class="num" id="LN1365">1365</td><td class="line"><span class='keyword'>static</span> <span class='keyword'>void</span> verify(<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl, zlentry *e) {</td></tr>
<tr class="codeline" data-linenumber="1366"><td class="num" id="LN1366">1366</td><td class="line">    <span class='keyword'>int</span> len = ziplistLen(zl);</td></tr>
<tr class="codeline" data-linenumber="1367"><td class="num" id="LN1367">1367</td><td class="line">    zlentry _e;</td></tr>
<tr class="codeline" data-linenumber="1368"><td class="num" id="LN1368">1368</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1369"><td class="num" id="LN1369">1369</td><td class="line">    <span class='macro'>ZIPLIST_ENTRY_ZERO(&amp;_e)<span class='macro_popup'>{ (&amp;_e)-&gt;prevrawlensize = (&amp;_e)-&gt;prevrawlen = 0<br>; (&amp;_e)-&gt;lensize = (&amp;_e)-&gt;len = (&amp;_e)-&gt;headersize<br> = 0; (&amp;_e)-&gt;encoding = 0; (&amp;_e)-&gt;p = ((void*)0<br>); }</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1370"><td class="num" id="LN1370">1370</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1371"><td class="num" id="LN1371">1371</td><td class="line">    <span class='keyword'>for</span> (<span class='keyword'>int</span> i = 0; i &lt; len; i++) {</td></tr>
<tr class="codeline" data-linenumber="1372"><td class="num" id="LN1372">1372</td><td class="line">        memset(&amp;e[i], 0, <span class='keyword'>sizeof</span>(zlentry));</td></tr>
<tr class="codeline" data-linenumber="1373"><td class="num" id="LN1373">1373</td><td class="line">        zipEntry(ziplistIndex(zl, i), &amp;e[i]);</td></tr>
<tr class="codeline" data-linenumber="1374"><td class="num" id="LN1374">1374</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1375"><td class="num" id="LN1375">1375</td><td class="line">        memset(&amp;_e, 0, <span class='keyword'>sizeof</span>(zlentry));</td></tr>
<tr class="codeline" data-linenumber="1376"><td class="num" id="LN1376">1376</td><td class="line">        zipEntry(ziplistIndex(zl, -len+i), &amp;_e);</td></tr>
<tr class="codeline" data-linenumber="1377"><td class="num" id="LN1377">1377</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1378"><td class="num" id="LN1378">1378</td><td class="line">        <span class='macro'>assert(memcmp(&amp;e[i], &amp;_e, <span class='keyword'>sizeof</span>(zlentry)) == 0)<span class='macro_popup'>((memcmp(&amp;e[i], &amp;_e, sizeof(zlentry)) == 0)?(void)0 :<br> (_serverAssert("memcmp(&amp;e[i], &amp;_e, sizeof(zlentry)) == 0"<br>,"ziplist.c",1378),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1379"><td class="num" id="LN1379">1379</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1380"><td class="num" id="LN1380">1380</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1381"><td class="num" id="LN1381">1381</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1382"><td class="num" id="LN1382">1382</td><td class="line"><span class='keyword'>int</span> ziplistTest(<span class='keyword'>int</span> argc, <span class='keyword'>char</span> **argv) {</td></tr>
<tr class="codeline" data-linenumber="1383"><td class="num" id="LN1383">1383</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl, *p;</td></tr>
<tr class="codeline" data-linenumber="1384"><td class="num" id="LN1384">1384</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *entry;</td></tr>
<tr class="codeline" data-linenumber="1385"><td class="num" id="LN1385">1385</td><td class="line">    <span class='keyword'>unsigned</span> <span class='keyword'>int</span> elen;</td></tr>
<tr class="codeline" data-linenumber="1386"><td class="num" id="LN1386">1386</td><td class="line">    <span class='keyword'>long</span> <span class='keyword'>long</span> value;</td></tr>
<tr class="codeline" data-linenumber="1387"><td class="num" id="LN1387">1387</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1388"><td class="num" id="LN1388">1388</td><td class="line">    <span class='comment'>/* If an argument is given, use it as the random seed. */</span></td></tr>
<tr class="codeline" data-linenumber="1389"><td class="num" id="LN1389">1389</td><td class="line">    <span class='keyword'>if</span> (argc == 2)</td></tr>
<tr class="codeline" data-linenumber="1390"><td class="num" id="LN1390">1390</td><td class="line">        srand(atoi(argv[1]));</td></tr>
<tr class="codeline" data-linenumber="1391"><td class="num" id="LN1391">1391</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1392"><td class="num" id="LN1392">1392</td><td class="line">    zl = createIntList();</td></tr>
<tr class="codeline" data-linenumber="1393"><td class="num" id="LN1393">1393</td><td class="line">    ziplistRepr(zl);</td></tr>
<tr class="codeline" data-linenumber="1394"><td class="num" id="LN1394">1394</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1395"><td class="num" id="LN1395">1395</td><td class="line">    zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1396"><td class="num" id="LN1396">1396</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1397"><td class="num" id="LN1397">1397</td><td class="line">    zl = createList();</td></tr>
<tr class="codeline" data-linenumber="1398"><td class="num" id="LN1398">1398</td><td class="line">    ziplistRepr(zl);</td></tr>
<tr class="codeline" data-linenumber="1399"><td class="num" id="LN1399">1399</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1400"><td class="num" id="LN1400">1400</td><td class="line">    zl = pop(zl,<span class='macro'>ZIPLIST_TAIL<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1401"><td class="num" id="LN1401">1401</td><td class="line">    ziplistRepr(zl);</td></tr>
<tr class="codeline" data-linenumber="1402"><td class="num" id="LN1402">1402</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1403"><td class="num" id="LN1403">1403</td><td class="line">    zl = pop(zl,<span class='macro'>ZIPLIST_HEAD<span class='macro_popup'>0</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1404"><td class="num" id="LN1404">1404</td><td class="line">    ziplistRepr(zl);</td></tr>
<tr class="codeline" data-linenumber="1405"><td class="num" id="LN1405">1405</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1406"><td class="num" id="LN1406">1406</td><td class="line">    zl = pop(zl,<span class='macro'>ZIPLIST_TAIL<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1407"><td class="num" id="LN1407">1407</td><td class="line">    ziplistRepr(zl);</td></tr>
<tr class="codeline" data-linenumber="1408"><td class="num" id="LN1408">1408</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1409"><td class="num" id="LN1409">1409</td><td class="line">    zl = pop(zl,<span class='macro'>ZIPLIST_TAIL<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1410"><td class="num" id="LN1410">1410</td><td class="line">    ziplistRepr(zl);</td></tr>
<tr class="codeline" data-linenumber="1411"><td class="num" id="LN1411">1411</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1412"><td class="num" id="LN1412">1412</td><td class="line">    zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1413"><td class="num" id="LN1413">1413</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1414"><td class="num" id="LN1414">1414</td><td class="line">    printf(<span class='string_literal'>"Get element at index 3:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1415"><td class="num" id="LN1415">1415</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1416"><td class="num" id="LN1416">1416</td><td class="line">        zl = createList();</td></tr>
<tr class="codeline" data-linenumber="1417"><td class="num" id="LN1417">1417</td><td class="line">        p = ziplistIndex(zl, 3);</td></tr>
<tr class="codeline" data-linenumber="1418"><td class="num" id="LN1418">1418</td><td class="line">        <span class='keyword'>if</span> (!ziplistGet(p, &amp;entry, &amp;elen, &amp;value)) {</td></tr>
<tr class="codeline" data-linenumber="1419"><td class="num" id="LN1419">1419</td><td class="line">            printf(<span class='string_literal'>"ERROR: Could not access index 3\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1420"><td class="num" id="LN1420">1420</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1421"><td class="num" id="LN1421">1421</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1422"><td class="num" id="LN1422">1422</td><td class="line">        <span class='keyword'>if</span> (entry) {</td></tr>
<tr class="codeline" data-linenumber="1423"><td class="num" id="LN1423">1423</td><td class="line">            <span class='keyword'>if</span> (elen &amp;&amp; fwrite(entry,elen,1,<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>) == 0) perror(<span class='string_literal'>"fwrite"</span>);</td></tr>
<tr class="codeline" data-linenumber="1424"><td class="num" id="LN1424">1424</td><td class="line">            printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1425"><td class="num" id="LN1425">1425</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1426"><td class="num" id="LN1426">1426</td><td class="line">            printf(<span class='string_literal'>"%lld\n"</span>, value);</td></tr>
<tr class="codeline" data-linenumber="1427"><td class="num" id="LN1427">1427</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1428"><td class="num" id="LN1428">1428</td><td class="line">        printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1429"><td class="num" id="LN1429">1429</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1430"><td class="num" id="LN1430">1430</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1431"><td class="num" id="LN1431">1431</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1432"><td class="num" id="LN1432">1432</td><td class="line">    printf(<span class='string_literal'>"Get element at index 4 (out of range):\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1433"><td class="num" id="LN1433">1433</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1434"><td class="num" id="LN1434">1434</td><td class="line">        zl = createList();</td></tr>
<tr class="codeline" data-linenumber="1435"><td class="num" id="LN1435">1435</td><td class="line">        p = ziplistIndex(zl, 4);</td></tr>
<tr class="codeline" data-linenumber="1436"><td class="num" id="LN1436">1436</td><td class="line">        <span class='keyword'>if</span> (p == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1437"><td class="num" id="LN1437">1437</td><td class="line">            printf(<span class='string_literal'>"No entry\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1438"><td class="num" id="LN1438">1438</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1439"><td class="num" id="LN1439">1439</td><td class="line">            printf(<span class='string_literal'>"ERROR: Out of range index should return NULL, returned offset: %ld\n"</span>, p-zl);</td></tr>
<tr class="codeline" data-linenumber="1440"><td class="num" id="LN1440">1440</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1441"><td class="num" id="LN1441">1441</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1442"><td class="num" id="LN1442">1442</td><td class="line">        printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1443"><td class="num" id="LN1443">1443</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1444"><td class="num" id="LN1444">1444</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1445"><td class="num" id="LN1445">1445</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1446"><td class="num" id="LN1446">1446</td><td class="line">    printf(<span class='string_literal'>"Get element at index -1 (last element):\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1447"><td class="num" id="LN1447">1447</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1448"><td class="num" id="LN1448">1448</td><td class="line">        zl = createList();</td></tr>
<tr class="codeline" data-linenumber="1449"><td class="num" id="LN1449">1449</td><td class="line">        p = ziplistIndex(zl, -1);</td></tr>
<tr class="codeline" data-linenumber="1450"><td class="num" id="LN1450">1450</td><td class="line">        <span class='keyword'>if</span> (!ziplistGet(p, &amp;entry, &amp;elen, &amp;value)) {</td></tr>
<tr class="codeline" data-linenumber="1451"><td class="num" id="LN1451">1451</td><td class="line">            printf(<span class='string_literal'>"ERROR: Could not access index -1\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1452"><td class="num" id="LN1452">1452</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1453"><td class="num" id="LN1453">1453</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1454"><td class="num" id="LN1454">1454</td><td class="line">        <span class='keyword'>if</span> (entry) {</td></tr>
<tr class="codeline" data-linenumber="1455"><td class="num" id="LN1455">1455</td><td class="line">            <span class='keyword'>if</span> (elen &amp;&amp; fwrite(entry,elen,1,<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>) == 0) perror(<span class='string_literal'>"fwrite"</span>);</td></tr>
<tr class="codeline" data-linenumber="1456"><td class="num" id="LN1456">1456</td><td class="line">            printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1457"><td class="num" id="LN1457">1457</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1458"><td class="num" id="LN1458">1458</td><td class="line">            printf(<span class='string_literal'>"%lld\n"</span>, value);</td></tr>
<tr class="codeline" data-linenumber="1459"><td class="num" id="LN1459">1459</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1460"><td class="num" id="LN1460">1460</td><td class="line">        printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1461"><td class="num" id="LN1461">1461</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1462"><td class="num" id="LN1462">1462</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1463"><td class="num" id="LN1463">1463</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1464"><td class="num" id="LN1464">1464</td><td class="line">    printf(<span class='string_literal'>"Get element at index -4 (first element):\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1465"><td class="num" id="LN1465">1465</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1466"><td class="num" id="LN1466">1466</td><td class="line">        zl = createList();</td></tr>
<tr class="codeline" data-linenumber="1467"><td class="num" id="LN1467">1467</td><td class="line">        p = ziplistIndex(zl, -4);</td></tr>
<tr class="codeline" data-linenumber="1468"><td class="num" id="LN1468">1468</td><td class="line">        <span class='keyword'>if</span> (!ziplistGet(p, &amp;entry, &amp;elen, &amp;value)) {</td></tr>
<tr class="codeline" data-linenumber="1469"><td class="num" id="LN1469">1469</td><td class="line">            printf(<span class='string_literal'>"ERROR: Could not access index -4\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1470"><td class="num" id="LN1470">1470</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1471"><td class="num" id="LN1471">1471</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1472"><td class="num" id="LN1472">1472</td><td class="line">        <span class='keyword'>if</span> (entry) {</td></tr>
<tr class="codeline" data-linenumber="1473"><td class="num" id="LN1473">1473</td><td class="line">            <span class='keyword'>if</span> (elen &amp;&amp; fwrite(entry,elen,1,<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>) == 0) perror(<span class='string_literal'>"fwrite"</span>);</td></tr>
<tr class="codeline" data-linenumber="1474"><td class="num" id="LN1474">1474</td><td class="line">            printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1475"><td class="num" id="LN1475">1475</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1476"><td class="num" id="LN1476">1476</td><td class="line">            printf(<span class='string_literal'>"%lld\n"</span>, value);</td></tr>
<tr class="codeline" data-linenumber="1477"><td class="num" id="LN1477">1477</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1478"><td class="num" id="LN1478">1478</td><td class="line">        printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1479"><td class="num" id="LN1479">1479</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1480"><td class="num" id="LN1480">1480</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1481"><td class="num" id="LN1481">1481</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1482"><td class="num" id="LN1482">1482</td><td class="line">    printf(<span class='string_literal'>"Get element at index -5 (reverse out of range):\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1483"><td class="num" id="LN1483">1483</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1484"><td class="num" id="LN1484">1484</td><td class="line">        zl = createList();</td></tr>
<tr class="codeline" data-linenumber="1485"><td class="num" id="LN1485">1485</td><td class="line">        p = ziplistIndex(zl, -5);</td></tr>
<tr class="codeline" data-linenumber="1486"><td class="num" id="LN1486">1486</td><td class="line">        <span class='keyword'>if</span> (p == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1487"><td class="num" id="LN1487">1487</td><td class="line">            printf(<span class='string_literal'>"No entry\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1488"><td class="num" id="LN1488">1488</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1489"><td class="num" id="LN1489">1489</td><td class="line">            printf(<span class='string_literal'>"ERROR: Out of range index should return NULL, returned offset: %ld\n"</span>, p-zl);</td></tr>
<tr class="codeline" data-linenumber="1490"><td class="num" id="LN1490">1490</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1491"><td class="num" id="LN1491">1491</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1492"><td class="num" id="LN1492">1492</td><td class="line">        printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1493"><td class="num" id="LN1493">1493</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1494"><td class="num" id="LN1494">1494</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1495"><td class="num" id="LN1495">1495</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1496"><td class="num" id="LN1496">1496</td><td class="line">    printf(<span class='string_literal'>"Iterate list from 0 to end:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1497"><td class="num" id="LN1497">1497</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1498"><td class="num" id="LN1498">1498</td><td class="line">        zl = createList();</td></tr>
<tr class="codeline" data-linenumber="1499"><td class="num" id="LN1499">1499</td><td class="line">        p = ziplistIndex(zl, 0);</td></tr>
<tr class="codeline" data-linenumber="1500"><td class="num" id="LN1500">1500</td><td class="line">        <span class='keyword'>while</span> (ziplistGet(p, &amp;entry, &amp;elen, &amp;value)) {</td></tr>
<tr class="codeline" data-linenumber="1501"><td class="num" id="LN1501">1501</td><td class="line">            printf(<span class='string_literal'>"Entry: "</span>);</td></tr>
<tr class="codeline" data-linenumber="1502"><td class="num" id="LN1502">1502</td><td class="line">            <span class='keyword'>if</span> (entry) {</td></tr>
<tr class="codeline" data-linenumber="1503"><td class="num" id="LN1503">1503</td><td class="line">                <span class='keyword'>if</span> (elen &amp;&amp; fwrite(entry,elen,1,<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>) == 0) perror(<span class='string_literal'>"fwrite"</span>);</td></tr>
<tr class="codeline" data-linenumber="1504"><td class="num" id="LN1504">1504</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1505"><td class="num" id="LN1505">1505</td><td class="line">                printf(<span class='string_literal'>"%lld"</span>, value);</td></tr>
<tr class="codeline" data-linenumber="1506"><td class="num" id="LN1506">1506</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1507"><td class="num" id="LN1507">1507</td><td class="line">            p = ziplistNext(zl,p);</td></tr>
<tr class="codeline" data-linenumber="1508"><td class="num" id="LN1508">1508</td><td class="line">            printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1509"><td class="num" id="LN1509">1509</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1510"><td class="num" id="LN1510">1510</td><td class="line">        printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1511"><td class="num" id="LN1511">1511</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1512"><td class="num" id="LN1512">1512</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1513"><td class="num" id="LN1513">1513</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1514"><td class="num" id="LN1514">1514</td><td class="line">    printf(<span class='string_literal'>"Iterate list from 1 to end:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1515"><td class="num" id="LN1515">1515</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1516"><td class="num" id="LN1516">1516</td><td class="line">        zl = createList();</td></tr>
<tr class="codeline" data-linenumber="1517"><td class="num" id="LN1517">1517</td><td class="line">        p = ziplistIndex(zl, 1);</td></tr>
<tr class="codeline" data-linenumber="1518"><td class="num" id="LN1518">1518</td><td class="line">        <span class='keyword'>while</span> (ziplistGet(p, &amp;entry, &amp;elen, &amp;value)) {</td></tr>
<tr class="codeline" data-linenumber="1519"><td class="num" id="LN1519">1519</td><td class="line">            printf(<span class='string_literal'>"Entry: "</span>);</td></tr>
<tr class="codeline" data-linenumber="1520"><td class="num" id="LN1520">1520</td><td class="line">            <span class='keyword'>if</span> (entry) {</td></tr>
<tr class="codeline" data-linenumber="1521"><td class="num" id="LN1521">1521</td><td class="line">                <span class='keyword'>if</span> (elen &amp;&amp; fwrite(entry,elen,1,<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>) == 0) perror(<span class='string_literal'>"fwrite"</span>);</td></tr>
<tr class="codeline" data-linenumber="1522"><td class="num" id="LN1522">1522</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1523"><td class="num" id="LN1523">1523</td><td class="line">                printf(<span class='string_literal'>"%lld"</span>, value);</td></tr>
<tr class="codeline" data-linenumber="1524"><td class="num" id="LN1524">1524</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1525"><td class="num" id="LN1525">1525</td><td class="line">            p = ziplistNext(zl,p);</td></tr>
<tr class="codeline" data-linenumber="1526"><td class="num" id="LN1526">1526</td><td class="line">            printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1527"><td class="num" id="LN1527">1527</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1528"><td class="num" id="LN1528">1528</td><td class="line">        printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1529"><td class="num" id="LN1529">1529</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1530"><td class="num" id="LN1530">1530</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1531"><td class="num" id="LN1531">1531</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1532"><td class="num" id="LN1532">1532</td><td class="line">    printf(<span class='string_literal'>"Iterate list from 2 to end:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1533"><td class="num" id="LN1533">1533</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1534"><td class="num" id="LN1534">1534</td><td class="line">        zl = createList();</td></tr>
<tr class="codeline" data-linenumber="1535"><td class="num" id="LN1535">1535</td><td class="line">        p = ziplistIndex(zl, 2);</td></tr>
<tr class="codeline" data-linenumber="1536"><td class="num" id="LN1536">1536</td><td class="line">        <span class='keyword'>while</span> (ziplistGet(p, &amp;entry, &amp;elen, &amp;value)) {</td></tr>
<tr class="codeline" data-linenumber="1537"><td class="num" id="LN1537">1537</td><td class="line">            printf(<span class='string_literal'>"Entry: "</span>);</td></tr>
<tr class="codeline" data-linenumber="1538"><td class="num" id="LN1538">1538</td><td class="line">            <span class='keyword'>if</span> (entry) {</td></tr>
<tr class="codeline" data-linenumber="1539"><td class="num" id="LN1539">1539</td><td class="line">                <span class='keyword'>if</span> (elen &amp;&amp; fwrite(entry,elen,1,<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>) == 0) perror(<span class='string_literal'>"fwrite"</span>);</td></tr>
<tr class="codeline" data-linenumber="1540"><td class="num" id="LN1540">1540</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1541"><td class="num" id="LN1541">1541</td><td class="line">                printf(<span class='string_literal'>"%lld"</span>, value);</td></tr>
<tr class="codeline" data-linenumber="1542"><td class="num" id="LN1542">1542</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1543"><td class="num" id="LN1543">1543</td><td class="line">            p = ziplistNext(zl,p);</td></tr>
<tr class="codeline" data-linenumber="1544"><td class="num" id="LN1544">1544</td><td class="line">            printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1545"><td class="num" id="LN1545">1545</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1546"><td class="num" id="LN1546">1546</td><td class="line">        printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1547"><td class="num" id="LN1547">1547</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1548"><td class="num" id="LN1548">1548</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1549"><td class="num" id="LN1549">1549</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1550"><td class="num" id="LN1550">1550</td><td class="line">    printf(<span class='string_literal'>"Iterate starting out of range:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1551"><td class="num" id="LN1551">1551</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1552"><td class="num" id="LN1552">1552</td><td class="line">        zl = createList();</td></tr>
<tr class="codeline" data-linenumber="1553"><td class="num" id="LN1553">1553</td><td class="line">        p = ziplistIndex(zl, 4);</td></tr>
<tr class="codeline" data-linenumber="1554"><td class="num" id="LN1554">1554</td><td class="line">        <span class='keyword'>if</span> (!ziplistGet(p, &amp;entry, &amp;elen, &amp;value)) {</td></tr>
<tr class="codeline" data-linenumber="1555"><td class="num" id="LN1555">1555</td><td class="line">            printf(<span class='string_literal'>"No entry\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1556"><td class="num" id="LN1556">1556</td><td class="line">        } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1557"><td class="num" id="LN1557">1557</td><td class="line">            printf(<span class='string_literal'>"ERROR\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1558"><td class="num" id="LN1558">1558</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1559"><td class="num" id="LN1559">1559</td><td class="line">        printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1560"><td class="num" id="LN1560">1560</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1561"><td class="num" id="LN1561">1561</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1562"><td class="num" id="LN1562">1562</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1563"><td class="num" id="LN1563">1563</td><td class="line">    printf(<span class='string_literal'>"Iterate from back to front:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1564"><td class="num" id="LN1564">1564</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1565"><td class="num" id="LN1565">1565</td><td class="line">        zl = createList();</td></tr>
<tr class="codeline" data-linenumber="1566"><td class="num" id="LN1566">1566</td><td class="line">        p = ziplistIndex(zl, -1);</td></tr>
<tr class="codeline" data-linenumber="1567"><td class="num" id="LN1567">1567</td><td class="line">        <span class='keyword'>while</span> (ziplistGet(p, &amp;entry, &amp;elen, &amp;value)) {</td></tr>
<tr class="codeline" data-linenumber="1568"><td class="num" id="LN1568">1568</td><td class="line">            printf(<span class='string_literal'>"Entry: "</span>);</td></tr>
<tr class="codeline" data-linenumber="1569"><td class="num" id="LN1569">1569</td><td class="line">            <span class='keyword'>if</span> (entry) {</td></tr>
<tr class="codeline" data-linenumber="1570"><td class="num" id="LN1570">1570</td><td class="line">                <span class='keyword'>if</span> (elen &amp;&amp; fwrite(entry,elen,1,<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>) == 0) perror(<span class='string_literal'>"fwrite"</span>);</td></tr>
<tr class="codeline" data-linenumber="1571"><td class="num" id="LN1571">1571</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1572"><td class="num" id="LN1572">1572</td><td class="line">                printf(<span class='string_literal'>"%lld"</span>, value);</td></tr>
<tr class="codeline" data-linenumber="1573"><td class="num" id="LN1573">1573</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1574"><td class="num" id="LN1574">1574</td><td class="line">            p = ziplistPrev(zl,p);</td></tr>
<tr class="codeline" data-linenumber="1575"><td class="num" id="LN1575">1575</td><td class="line">            printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1576"><td class="num" id="LN1576">1576</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1577"><td class="num" id="LN1577">1577</td><td class="line">        printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1578"><td class="num" id="LN1578">1578</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1579"><td class="num" id="LN1579">1579</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1580"><td class="num" id="LN1580">1580</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1581"><td class="num" id="LN1581">1581</td><td class="line">    printf(<span class='string_literal'>"Iterate from back to front, deleting all items:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1582"><td class="num" id="LN1582">1582</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1583"><td class="num" id="LN1583">1583</td><td class="line">        zl = createList();</td></tr>
<tr class="codeline" data-linenumber="1584"><td class="num" id="LN1584">1584</td><td class="line">        p = ziplistIndex(zl, -1);</td></tr>
<tr class="codeline" data-linenumber="1585"><td class="num" id="LN1585">1585</td><td class="line">        <span class='keyword'>while</span> (ziplistGet(p, &amp;entry, &amp;elen, &amp;value)) {</td></tr>
<tr class="codeline" data-linenumber="1586"><td class="num" id="LN1586">1586</td><td class="line">            printf(<span class='string_literal'>"Entry: "</span>);</td></tr>
<tr class="codeline" data-linenumber="1587"><td class="num" id="LN1587">1587</td><td class="line">            <span class='keyword'>if</span> (entry) {</td></tr>
<tr class="codeline" data-linenumber="1588"><td class="num" id="LN1588">1588</td><td class="line">                <span class='keyword'>if</span> (elen &amp;&amp; fwrite(entry,elen,1,<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>) == 0) perror(<span class='string_literal'>"fwrite"</span>);</td></tr>
<tr class="codeline" data-linenumber="1589"><td class="num" id="LN1589">1589</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1590"><td class="num" id="LN1590">1590</td><td class="line">                printf(<span class='string_literal'>"%lld"</span>, value);</td></tr>
<tr class="codeline" data-linenumber="1591"><td class="num" id="LN1591">1591</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1592"><td class="num" id="LN1592">1592</td><td class="line">            zl = ziplistDelete(zl,&amp;p);</td></tr>
<tr class="codeline" data-linenumber="1593"><td class="num" id="LN1593">1593</td><td class="line">            p = ziplistPrev(zl,p);</td></tr>
<tr class="codeline" data-linenumber="1594"><td class="num" id="LN1594">1594</td><td class="line">            printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1595"><td class="num" id="LN1595">1595</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1596"><td class="num" id="LN1596">1596</td><td class="line">        printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1597"><td class="num" id="LN1597">1597</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1598"><td class="num" id="LN1598">1598</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1599"><td class="num" id="LN1599">1599</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1600"><td class="num" id="LN1600">1600</td><td class="line">    printf(<span class='string_literal'>"Delete inclusive range 0,0:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1601"><td class="num" id="LN1601">1601</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1602"><td class="num" id="LN1602">1602</td><td class="line">        zl = createList();</td></tr>
<tr class="codeline" data-linenumber="1603"><td class="num" id="LN1603">1603</td><td class="line">        zl = ziplistDeleteRange(zl, 0, 1);</td></tr>
<tr class="codeline" data-linenumber="1604"><td class="num" id="LN1604">1604</td><td class="line">        ziplistRepr(zl);</td></tr>
<tr class="codeline" data-linenumber="1605"><td class="num" id="LN1605">1605</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1606"><td class="num" id="LN1606">1606</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1607"><td class="num" id="LN1607">1607</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1608"><td class="num" id="LN1608">1608</td><td class="line">    printf(<span class='string_literal'>"Delete inclusive range 0,1:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1609"><td class="num" id="LN1609">1609</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1610"><td class="num" id="LN1610">1610</td><td class="line">        zl = createList();</td></tr>
<tr class="codeline" data-linenumber="1611"><td class="num" id="LN1611">1611</td><td class="line">        zl = ziplistDeleteRange(zl, 0, 2);</td></tr>
<tr class="codeline" data-linenumber="1612"><td class="num" id="LN1612">1612</td><td class="line">        ziplistRepr(zl);</td></tr>
<tr class="codeline" data-linenumber="1613"><td class="num" id="LN1613">1613</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1614"><td class="num" id="LN1614">1614</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1615"><td class="num" id="LN1615">1615</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1616"><td class="num" id="LN1616">1616</td><td class="line">    printf(<span class='string_literal'>"Delete inclusive range 1,2:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1617"><td class="num" id="LN1617">1617</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1618"><td class="num" id="LN1618">1618</td><td class="line">        zl = createList();</td></tr>
<tr class="codeline" data-linenumber="1619"><td class="num" id="LN1619">1619</td><td class="line">        zl = ziplistDeleteRange(zl, 1, 2);</td></tr>
<tr class="codeline" data-linenumber="1620"><td class="num" id="LN1620">1620</td><td class="line">        ziplistRepr(zl);</td></tr>
<tr class="codeline" data-linenumber="1621"><td class="num" id="LN1621">1621</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1622"><td class="num" id="LN1622">1622</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1623"><td class="num" id="LN1623">1623</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1624"><td class="num" id="LN1624">1624</td><td class="line">    printf(<span class='string_literal'>"Delete with start index out of range:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1625"><td class="num" id="LN1625">1625</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1626"><td class="num" id="LN1626">1626</td><td class="line">        zl = createList();</td></tr>
<tr class="codeline" data-linenumber="1627"><td class="num" id="LN1627">1627</td><td class="line">        zl = ziplistDeleteRange(zl, 5, 1);</td></tr>
<tr class="codeline" data-linenumber="1628"><td class="num" id="LN1628">1628</td><td class="line">        ziplistRepr(zl);</td></tr>
<tr class="codeline" data-linenumber="1629"><td class="num" id="LN1629">1629</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1630"><td class="num" id="LN1630">1630</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1631"><td class="num" id="LN1631">1631</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1632"><td class="num" id="LN1632">1632</td><td class="line">    printf(<span class='string_literal'>"Delete with num overflow:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1633"><td class="num" id="LN1633">1633</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1634"><td class="num" id="LN1634">1634</td><td class="line">        zl = createList();</td></tr>
<tr class="codeline" data-linenumber="1635"><td class="num" id="LN1635">1635</td><td class="line">        zl = ziplistDeleteRange(zl, 1, 5);</td></tr>
<tr class="codeline" data-linenumber="1636"><td class="num" id="LN1636">1636</td><td class="line">        ziplistRepr(zl);</td></tr>
<tr class="codeline" data-linenumber="1637"><td class="num" id="LN1637">1637</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1638"><td class="num" id="LN1638">1638</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1639"><td class="num" id="LN1639">1639</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1640"><td class="num" id="LN1640">1640</td><td class="line">    printf(<span class='string_literal'>"Delete foo while iterating:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1641"><td class="num" id="LN1641">1641</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1642"><td class="num" id="LN1642">1642</td><td class="line">        zl = createList();</td></tr>
<tr class="codeline" data-linenumber="1643"><td class="num" id="LN1643">1643</td><td class="line">        p = ziplistIndex(zl,0);</td></tr>
<tr class="codeline" data-linenumber="1644"><td class="num" id="LN1644">1644</td><td class="line">        <span class='keyword'>while</span> (ziplistGet(p,&amp;entry,&amp;elen,&amp;value)) {</td></tr>
<tr class="codeline" data-linenumber="1645"><td class="num" id="LN1645">1645</td><td class="line">            <span class='keyword'>if</span> (entry &amp;&amp; strncmp(<span class='string_literal'>"foo"</span>,(<span class='keyword'>char</span>*)entry,elen) == 0) {</td></tr>
<tr class="codeline" data-linenumber="1646"><td class="num" id="LN1646">1646</td><td class="line">                printf(<span class='string_literal'>"Delete foo\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1647"><td class="num" id="LN1647">1647</td><td class="line">                zl = ziplistDelete(zl,&amp;p);</td></tr>
<tr class="codeline" data-linenumber="1648"><td class="num" id="LN1648">1648</td><td class="line">            } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1649"><td class="num" id="LN1649">1649</td><td class="line">                printf(<span class='string_literal'>"Entry: "</span>);</td></tr>
<tr class="codeline" data-linenumber="1650"><td class="num" id="LN1650">1650</td><td class="line">                <span class='keyword'>if</span> (entry) {</td></tr>
<tr class="codeline" data-linenumber="1651"><td class="num" id="LN1651">1651</td><td class="line">                    <span class='keyword'>if</span> (elen &amp;&amp; fwrite(entry,elen,1,<span class='macro'>stdout<span class='macro_popup'>stdout</span></span>) == 0)</td></tr>
<tr class="codeline" data-linenumber="1652"><td class="num" id="LN1652">1652</td><td class="line">                        perror(<span class='string_literal'>"fwrite"</span>);</td></tr>
<tr class="codeline" data-linenumber="1653"><td class="num" id="LN1653">1653</td><td class="line">                } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1654"><td class="num" id="LN1654">1654</td><td class="line">                    printf(<span class='string_literal'>"%lld"</span>,value);</td></tr>
<tr class="codeline" data-linenumber="1655"><td class="num" id="LN1655">1655</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1656"><td class="num" id="LN1656">1656</td><td class="line">                p = ziplistNext(zl,p);</td></tr>
<tr class="codeline" data-linenumber="1657"><td class="num" id="LN1657">1657</td><td class="line">                printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1658"><td class="num" id="LN1658">1658</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1659"><td class="num" id="LN1659">1659</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1660"><td class="num" id="LN1660">1660</td><td class="line">        printf(<span class='string_literal'>"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1661"><td class="num" id="LN1661">1661</td><td class="line">        ziplistRepr(zl);</td></tr>
<tr class="codeline" data-linenumber="1662"><td class="num" id="LN1662">1662</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1663"><td class="num" id="LN1663">1663</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1664"><td class="num" id="LN1664">1664</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1665"><td class="num" id="LN1665">1665</td><td class="line">    printf(<span class='string_literal'>"Regression test for &gt;255 byte strings:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1666"><td class="num" id="LN1666">1666</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1667"><td class="num" id="LN1667">1667</td><td class="line">        <span class='keyword'>char</span> v1[257] = {0}, v2[257] = {0};</td></tr>
<tr class="codeline" data-linenumber="1668"><td class="num" id="LN1668">1668</td><td class="line">        memset(v1,'x',256);</td></tr>
<tr class="codeline" data-linenumber="1669"><td class="num" id="LN1669">1669</td><td class="line">        memset(v2,'y',256);</td></tr>
<tr class="codeline" data-linenumber="1670"><td class="num" id="LN1670">1670</td><td class="line">        zl = ziplistNew();</td></tr>
<tr class="codeline" data-linenumber="1671"><td class="num" id="LN1671">1671</td><td class="line">        zl = ziplistPush(zl,(<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)v1,strlen(v1),<span class='macro'>ZIPLIST_TAIL<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1672"><td class="num" id="LN1672">1672</td><td class="line">        zl = ziplistPush(zl,(<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)v2,strlen(v2),<span class='macro'>ZIPLIST_TAIL<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1673"><td class="num" id="LN1673">1673</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1674"><td class="num" id="LN1674">1674</td><td class="line">        <span class='comment'>/* Pop values again and compare their value. */</span></td></tr>
<tr class="codeline" data-linenumber="1675"><td class="num" id="LN1675">1675</td><td class="line">        p = ziplistIndex(zl,0);</td></tr>
<tr class="codeline" data-linenumber="1676"><td class="num" id="LN1676">1676</td><td class="line">        <span class='macro'>assert(ziplistGet(p,&amp;entry,&amp;elen,&amp;value))<span class='macro_popup'>((ziplistGet(p,&amp;entry,&amp;elen,&amp;value))?(void)0 : (_serverAssert<br>("ziplistGet(p,&amp;entry,&amp;elen,&amp;value)","ziplist.c",<br>1676),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1677"><td class="num" id="LN1677">1677</td><td class="line">        <span class='macro'>assert(strncmp(v1,(<span class='keyword'>char</span>*)entry,elen) == 0)<span class='macro_popup'>((strncmp(v1,(char*)entry,elen) == 0)?(void)0 : (_serverAssert<br>("strncmp(v1,(char*)entry,elen) == 0","ziplist.c",1677),_exit<br>(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1678"><td class="num" id="LN1678">1678</td><td class="line">        p = ziplistIndex(zl,1);</td></tr>
<tr class="codeline" data-linenumber="1679"><td class="num" id="LN1679">1679</td><td class="line">        <span class='macro'>assert(ziplistGet(p,&amp;entry,&amp;elen,&amp;value))<span class='macro_popup'>((ziplistGet(p,&amp;entry,&amp;elen,&amp;value))?(void)0 : (_serverAssert<br>("ziplistGet(p,&amp;entry,&amp;elen,&amp;value)","ziplist.c",<br>1679),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1680"><td class="num" id="LN1680">1680</td><td class="line">        <span class='macro'>assert(strncmp(v2,(<span class='keyword'>char</span>*)entry,elen) == 0)<span class='macro_popup'>((strncmp(v2,(char*)entry,elen) == 0)?(void)0 : (_serverAssert<br>("strncmp(v2,(char*)entry,elen) == 0","ziplist.c",1680),_exit<br>(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1681"><td class="num" id="LN1681">1681</td><td class="line">        printf(<span class='string_literal'>"SUCCESS\n\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1682"><td class="num" id="LN1682">1682</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1683"><td class="num" id="LN1683">1683</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1684"><td class="num" id="LN1684">1684</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1685"><td class="num" id="LN1685">1685</td><td class="line">    printf(<span class='string_literal'>"Regression test deleting next to last entries:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1686"><td class="num" id="LN1686">1686</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1687"><td class="num" id="LN1687">1687</td><td class="line">        <span class='keyword'>char</span> v[3][257] = {{0}};</td></tr>
<tr class="codeline" data-linenumber="1688"><td class="num" id="LN1688">1688</td><td class="line">        zlentry e[3] = {{.prevrawlensize = 0, .prevrawlen = 0, .lensize = 0,</td></tr>
<tr class="codeline" data-linenumber="1689"><td class="num" id="LN1689">1689</td><td class="line">                         .len = 0, .headersize = 0, .encoding = 0, .p = <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>}};</td></tr>
<tr class="codeline" data-linenumber="1690"><td class="num" id="LN1690">1690</td><td class="line">        size_t i;</td></tr>
<tr class="codeline" data-linenumber="1691"><td class="num" id="LN1691">1691</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1692"><td class="num" id="LN1692">1692</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; (<span class='keyword'>sizeof</span>(v)/<span class='keyword'>sizeof</span>(v[0])); i++) {</td></tr>
<tr class="codeline" data-linenumber="1693"><td class="num" id="LN1693">1693</td><td class="line">            memset(v[i], 'a' + i, <span class='keyword'>sizeof</span>(v[0]));</td></tr>
<tr class="codeline" data-linenumber="1694"><td class="num" id="LN1694">1694</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1695"><td class="num" id="LN1695">1695</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1696"><td class="num" id="LN1696">1696</td><td class="line">        v[0][256] = '\0';</td></tr>
<tr class="codeline" data-linenumber="1697"><td class="num" id="LN1697">1697</td><td class="line">        v[1][  1] = '\0';</td></tr>
<tr class="codeline" data-linenumber="1698"><td class="num" id="LN1698">1698</td><td class="line">        v[2][256] = '\0';</td></tr>
<tr class="codeline" data-linenumber="1699"><td class="num" id="LN1699">1699</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1700"><td class="num" id="LN1700">1700</td><td class="line">        zl = ziplistNew();</td></tr>
<tr class="codeline" data-linenumber="1701"><td class="num" id="LN1701">1701</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; (<span class='keyword'>sizeof</span>(v)/<span class='keyword'>sizeof</span>(v[0])); i++) {</td></tr>
<tr class="codeline" data-linenumber="1702"><td class="num" id="LN1702">1702</td><td class="line">            zl = ziplistPush(zl, (<span class='keyword'>unsigned</span> <span class='keyword'>char</span> *) v[i], strlen(v[i]), <span class='macro'>ZIPLIST_TAIL<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1703"><td class="num" id="LN1703">1703</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1704"><td class="num" id="LN1704">1704</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1705"><td class="num" id="LN1705">1705</td><td class="line">        verify(zl, e);</td></tr>
<tr class="codeline" data-linenumber="1706"><td class="num" id="LN1706">1706</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1707"><td class="num" id="LN1707">1707</td><td class="line">        <span class='macro'>assert(e[0].prevrawlensize == 1)<span class='macro_popup'>((e[0].prevrawlensize == 1)?(void)0 : (_serverAssert("e[0].prevrawlensize == 1"<br>,"ziplist.c",1707),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1708"><td class="num" id="LN1708">1708</td><td class="line">        <span class='macro'>assert(e[1].prevrawlensize == 5)<span class='macro_popup'>((e[1].prevrawlensize == 5)?(void)0 : (_serverAssert("e[1].prevrawlensize == 5"<br>,"ziplist.c",1708),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1709"><td class="num" id="LN1709">1709</td><td class="line">        <span class='macro'>assert(e[2].prevrawlensize == 1)<span class='macro_popup'>((e[2].prevrawlensize == 1)?(void)0 : (_serverAssert("e[2].prevrawlensize == 1"<br>,"ziplist.c",1709),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1710"><td class="num" id="LN1710">1710</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1711"><td class="num" id="LN1711">1711</td><td class="line">        <span class='comment'>/* Deleting entry 1 will increase `prevrawlensize` for entry 2 */</span></td></tr>
<tr class="codeline" data-linenumber="1712"><td class="num" id="LN1712">1712</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p = e[1].p;</td></tr>
<tr class="codeline" data-linenumber="1713"><td class="num" id="LN1713">1713</td><td class="line">        zl = ziplistDelete(zl, &amp;p);</td></tr>
<tr class="codeline" data-linenumber="1714"><td class="num" id="LN1714">1714</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1715"><td class="num" id="LN1715">1715</td><td class="line">        verify(zl, e);</td></tr>
<tr class="codeline" data-linenumber="1716"><td class="num" id="LN1716">1716</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1717"><td class="num" id="LN1717">1717</td><td class="line">        <span class='macro'>assert(e[0].prevrawlensize == 1)<span class='macro_popup'>((e[0].prevrawlensize == 1)?(void)0 : (_serverAssert("e[0].prevrawlensize == 1"<br>,"ziplist.c",1717),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1718"><td class="num" id="LN1718">1718</td><td class="line">        <span class='macro'>assert(e[1].prevrawlensize == 5)<span class='macro_popup'>((e[1].prevrawlensize == 5)?(void)0 : (_serverAssert("e[1].prevrawlensize == 5"<br>,"ziplist.c",1718),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1719"><td class="num" id="LN1719">1719</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1720"><td class="num" id="LN1720">1720</td><td class="line">        printf(<span class='string_literal'>"SUCCESS\n\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1721"><td class="num" id="LN1721">1721</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1722"><td class="num" id="LN1722">1722</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1723"><td class="num" id="LN1723">1723</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1724"><td class="num" id="LN1724">1724</td><td class="line">    printf(<span class='string_literal'>"Create long list and check indices:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1725"><td class="num" id="LN1725">1725</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1726"><td class="num" id="LN1726">1726</td><td class="line">        zl = ziplistNew();</td></tr>
<tr class="codeline" data-linenumber="1727"><td class="num" id="LN1727">1727</td><td class="line">        <span class='keyword'>char</span> buf[32];</td></tr>
<tr class="codeline" data-linenumber="1728"><td class="num" id="LN1728">1728</td><td class="line">        <span class='keyword'>int</span> i,len;</td></tr>
<tr class="codeline" data-linenumber="1729"><td class="num" id="LN1729">1729</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; 1000; i++) {</td></tr>
<tr class="codeline" data-linenumber="1730"><td class="num" id="LN1730">1730</td><td class="line">            len = sprintf(buf,<span class='string_literal'>"%d"</span>,i);</td></tr>
<tr class="codeline" data-linenumber="1731"><td class="num" id="LN1731">1731</td><td class="line">            zl = ziplistPush(zl,(<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)buf,len,<span class='macro'>ZIPLIST_TAIL<span class='macro_popup'>1</span></span>);</td></tr>
<tr class="codeline" data-linenumber="1732"><td class="num" id="LN1732">1732</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1733"><td class="num" id="LN1733">1733</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; 1000; i++) {</td></tr>
<tr class="codeline" data-linenumber="1734"><td class="num" id="LN1734">1734</td><td class="line">            p = ziplistIndex(zl,i);</td></tr>
<tr class="codeline" data-linenumber="1735"><td class="num" id="LN1735">1735</td><td class="line">            <span class='macro'>assert(ziplistGet(p,NULL,NULL,&amp;value))<span class='macro_popup'>((ziplistGet(p,((void*)0),((void*)0),&amp;value))?(void)0 : (<br>_serverAssert("ziplistGet(p,NULL,NULL,&amp;value)","ziplist.c"<br>,1735),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1736"><td class="num" id="LN1736">1736</td><td class="line">            <span class='macro'>assert(i == value)<span class='macro_popup'>((i == value)?(void)0 : (_serverAssert("i == value","ziplist.c"<br>,1736),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1737"><td class="num" id="LN1737">1737</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1738"><td class="num" id="LN1738">1738</td><td class="line">            p = ziplistIndex(zl,-i-1);</td></tr>
<tr class="codeline" data-linenumber="1739"><td class="num" id="LN1739">1739</td><td class="line">            <span class='macro'>assert(ziplistGet(p,NULL,NULL,&amp;value))<span class='macro_popup'>((ziplistGet(p,((void*)0),((void*)0),&amp;value))?(void)0 : (<br>_serverAssert("ziplistGet(p,NULL,NULL,&amp;value)","ziplist.c"<br>,1739),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1740"><td class="num" id="LN1740">1740</td><td class="line">            <span class='macro'>assert(999-i == value)<span class='macro_popup'>((999-i == value)?(void)0 : (_serverAssert("999-i == value","ziplist.c"<br>,1740),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1741"><td class="num" id="LN1741">1741</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1742"><td class="num" id="LN1742">1742</td><td class="line">        printf(<span class='string_literal'>"SUCCESS\n\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1743"><td class="num" id="LN1743">1743</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1744"><td class="num" id="LN1744">1744</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1745"><td class="num" id="LN1745">1745</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1746"><td class="num" id="LN1746">1746</td><td class="line">    printf(<span class='string_literal'>"Compare strings with ziplist entries:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1747"><td class="num" id="LN1747">1747</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1748"><td class="num" id="LN1748">1748</td><td class="line">        zl = createList();</td></tr>
<tr class="codeline" data-linenumber="1749"><td class="num" id="LN1749">1749</td><td class="line">        p = ziplistIndex(zl,0);</td></tr>
<tr class="codeline" data-linenumber="1750"><td class="num" id="LN1750">1750</td><td class="line">        <span class='keyword'>if</span> (!ziplistCompare(p,(<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)<span class='string_literal'>"hello"</span>,5)) {</td></tr>
<tr class="codeline" data-linenumber="1751"><td class="num" id="LN1751">1751</td><td class="line">            printf(<span class='string_literal'>"ERROR: not \"hello\"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1752"><td class="num" id="LN1752">1752</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1753"><td class="num" id="LN1753">1753</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1754"><td class="num" id="LN1754">1754</td><td class="line">        <span class='keyword'>if</span> (ziplistCompare(p,(<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)<span class='string_literal'>"hella"</span>,5)) {</td></tr>
<tr class="codeline" data-linenumber="1755"><td class="num" id="LN1755">1755</td><td class="line">            printf(<span class='string_literal'>"ERROR: \"hella\"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1756"><td class="num" id="LN1756">1756</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1757"><td class="num" id="LN1757">1757</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1758"><td class="num" id="LN1758">1758</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1759"><td class="num" id="LN1759">1759</td><td class="line">        p = ziplistIndex(zl,3);</td></tr>
<tr class="codeline" data-linenumber="1760"><td class="num" id="LN1760">1760</td><td class="line">        <span class='keyword'>if</span> (!ziplistCompare(p,(<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)<span class='string_literal'>"1024"</span>,4)) {</td></tr>
<tr class="codeline" data-linenumber="1761"><td class="num" id="LN1761">1761</td><td class="line">            printf(<span class='string_literal'>"ERROR: not \"1024\"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1762"><td class="num" id="LN1762">1762</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1763"><td class="num" id="LN1763">1763</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1764"><td class="num" id="LN1764">1764</td><td class="line">        <span class='keyword'>if</span> (ziplistCompare(p,(<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)<span class='string_literal'>"1025"</span>,4)) {</td></tr>
<tr class="codeline" data-linenumber="1765"><td class="num" id="LN1765">1765</td><td class="line">            printf(<span class='string_literal'>"ERROR: \"1025\"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1766"><td class="num" id="LN1766">1766</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1767"><td class="num" id="LN1767">1767</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1768"><td class="num" id="LN1768">1768</td><td class="line">        printf(<span class='string_literal'>"SUCCESS\n\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1769"><td class="num" id="LN1769">1769</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1770"><td class="num" id="LN1770">1770</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1771"><td class="num" id="LN1771">1771</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1772"><td class="num" id="LN1772">1772</td><td class="line">    printf(<span class='string_literal'>"Merge test:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1773"><td class="num" id="LN1773">1773</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1774"><td class="num" id="LN1774">1774</td><td class="line">        <span class='comment'>/* create list gives us: [hello, foo, quux, 1024] */</span></td></tr>
<tr class="codeline" data-linenumber="1775"><td class="num" id="LN1775">1775</td><td class="line">        zl = createList();</td></tr>
<tr class="codeline" data-linenumber="1776"><td class="num" id="LN1776">1776</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl2 = createList();</td></tr>
<tr class="codeline" data-linenumber="1777"><td class="num" id="LN1777">1777</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1778"><td class="num" id="LN1778">1778</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl3 = ziplistNew();</td></tr>
<tr class="codeline" data-linenumber="1779"><td class="num" id="LN1779">1779</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *zl4 = ziplistNew();</td></tr>
<tr class="codeline" data-linenumber="1780"><td class="num" id="LN1780">1780</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1781"><td class="num" id="LN1781">1781</td><td class="line">        <span class='keyword'>if</span> (ziplistMerge(&amp;zl4, &amp;zl4)) {</td></tr>
<tr class="codeline" data-linenumber="1782"><td class="num" id="LN1782">1782</td><td class="line">            printf(<span class='string_literal'>"ERROR: Allowed merging of one ziplist into itself.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1783"><td class="num" id="LN1783">1783</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1784"><td class="num" id="LN1784">1784</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1785"><td class="num" id="LN1785">1785</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1786"><td class="num" id="LN1786">1786</td><td class="line">        <span class='comment'>/* Merge two empty ziplists, get empty result back. */</span></td></tr>
<tr class="codeline" data-linenumber="1787"><td class="num" id="LN1787">1787</td><td class="line">        zl4 = ziplistMerge(&amp;zl3, &amp;zl4);</td></tr>
<tr class="codeline" data-linenumber="1788"><td class="num" id="LN1788">1788</td><td class="line">        ziplistRepr(zl4);</td></tr>
<tr class="codeline" data-linenumber="1789"><td class="num" id="LN1789">1789</td><td class="line">        <span class='keyword'>if</span> (ziplistLen(zl4)) {</td></tr>
<tr class="codeline" data-linenumber="1790"><td class="num" id="LN1790">1790</td><td class="line">            printf(<span class='string_literal'>"ERROR: Merging two empty ziplists created entries.\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1791"><td class="num" id="LN1791">1791</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1792"><td class="num" id="LN1792">1792</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1793"><td class="num" id="LN1793">1793</td><td class="line">        zfree(zl4);</td></tr>
<tr class="codeline" data-linenumber="1794"><td class="num" id="LN1794">1794</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1795"><td class="num" id="LN1795">1795</td><td class="line">        zl2 = ziplistMerge(&amp;zl, &amp;zl2);</td></tr>
<tr class="codeline" data-linenumber="1796"><td class="num" id="LN1796">1796</td><td class="line">        <span class='comment'>/* merge gives us: [hello, foo, quux, 1024, hello, foo, quux, 1024] */</span></td></tr>
<tr class="codeline" data-linenumber="1797"><td class="num" id="LN1797">1797</td><td class="line">        ziplistRepr(zl2);</td></tr>
<tr class="codeline" data-linenumber="1798"><td class="num" id="LN1798">1798</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1799"><td class="num" id="LN1799">1799</td><td class="line">        <span class='keyword'>if</span> (ziplistLen(zl2) != 8) {</td></tr>
<tr class="codeline" data-linenumber="1800"><td class="num" id="LN1800">1800</td><td class="line">            printf(<span class='string_literal'>"ERROR: Merged length not 8, but: %u\n"</span>, ziplistLen(zl2));</td></tr>
<tr class="codeline" data-linenumber="1801"><td class="num" id="LN1801">1801</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1802"><td class="num" id="LN1802">1802</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1803"><td class="num" id="LN1803">1803</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1804"><td class="num" id="LN1804">1804</td><td class="line">        p = ziplistIndex(zl2,0);</td></tr>
<tr class="codeline" data-linenumber="1805"><td class="num" id="LN1805">1805</td><td class="line">        <span class='keyword'>if</span> (!ziplistCompare(p,(<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)<span class='string_literal'>"hello"</span>,5)) {</td></tr>
<tr class="codeline" data-linenumber="1806"><td class="num" id="LN1806">1806</td><td class="line">            printf(<span class='string_literal'>"ERROR: not \"hello\"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1807"><td class="num" id="LN1807">1807</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1808"><td class="num" id="LN1808">1808</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1809"><td class="num" id="LN1809">1809</td><td class="line">        <span class='keyword'>if</span> (ziplistCompare(p,(<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)<span class='string_literal'>"hella"</span>,5)) {</td></tr>
<tr class="codeline" data-linenumber="1810"><td class="num" id="LN1810">1810</td><td class="line">            printf(<span class='string_literal'>"ERROR: \"hella\"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1811"><td class="num" id="LN1811">1811</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1812"><td class="num" id="LN1812">1812</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1813"><td class="num" id="LN1813">1813</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1814"><td class="num" id="LN1814">1814</td><td class="line">        p = ziplistIndex(zl2,3);</td></tr>
<tr class="codeline" data-linenumber="1815"><td class="num" id="LN1815">1815</td><td class="line">        <span class='keyword'>if</span> (!ziplistCompare(p,(<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)<span class='string_literal'>"1024"</span>,4)) {</td></tr>
<tr class="codeline" data-linenumber="1816"><td class="num" id="LN1816">1816</td><td class="line">            printf(<span class='string_literal'>"ERROR: not \"1024\"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1817"><td class="num" id="LN1817">1817</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1818"><td class="num" id="LN1818">1818</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1819"><td class="num" id="LN1819">1819</td><td class="line">        <span class='keyword'>if</span> (ziplistCompare(p,(<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)<span class='string_literal'>"1025"</span>,4)) {</td></tr>
<tr class="codeline" data-linenumber="1820"><td class="num" id="LN1820">1820</td><td class="line">            printf(<span class='string_literal'>"ERROR: \"1025\"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1821"><td class="num" id="LN1821">1821</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1822"><td class="num" id="LN1822">1822</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1823"><td class="num" id="LN1823">1823</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1824"><td class="num" id="LN1824">1824</td><td class="line">        p = ziplistIndex(zl2,4);</td></tr>
<tr class="codeline" data-linenumber="1825"><td class="num" id="LN1825">1825</td><td class="line">        <span class='keyword'>if</span> (!ziplistCompare(p,(<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)<span class='string_literal'>"hello"</span>,5)) {</td></tr>
<tr class="codeline" data-linenumber="1826"><td class="num" id="LN1826">1826</td><td class="line">            printf(<span class='string_literal'>"ERROR: not \"hello\"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1827"><td class="num" id="LN1827">1827</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1828"><td class="num" id="LN1828">1828</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1829"><td class="num" id="LN1829">1829</td><td class="line">        <span class='keyword'>if</span> (ziplistCompare(p,(<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)<span class='string_literal'>"hella"</span>,5)) {</td></tr>
<tr class="codeline" data-linenumber="1830"><td class="num" id="LN1830">1830</td><td class="line">            printf(<span class='string_literal'>"ERROR: \"hella\"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1831"><td class="num" id="LN1831">1831</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1832"><td class="num" id="LN1832">1832</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1833"><td class="num" id="LN1833">1833</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1834"><td class="num" id="LN1834">1834</td><td class="line">        p = ziplistIndex(zl2,7);</td></tr>
<tr class="codeline" data-linenumber="1835"><td class="num" id="LN1835">1835</td><td class="line">        <span class='keyword'>if</span> (!ziplistCompare(p,(<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)<span class='string_literal'>"1024"</span>,4)) {</td></tr>
<tr class="codeline" data-linenumber="1836"><td class="num" id="LN1836">1836</td><td class="line">            printf(<span class='string_literal'>"ERROR: not \"1024\"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1837"><td class="num" id="LN1837">1837</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1838"><td class="num" id="LN1838">1838</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1839"><td class="num" id="LN1839">1839</td><td class="line">        <span class='keyword'>if</span> (ziplistCompare(p,(<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)<span class='string_literal'>"1025"</span>,4)) {</td></tr>
<tr class="codeline" data-linenumber="1840"><td class="num" id="LN1840">1840</td><td class="line">            printf(<span class='string_literal'>"ERROR: \"1025\"\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1841"><td class="num" id="LN1841">1841</td><td class="line">            <span class='keyword'>return</span> 1;</td></tr>
<tr class="codeline" data-linenumber="1842"><td class="num" id="LN1842">1842</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1843"><td class="num" id="LN1843">1843</td><td class="line">        printf(<span class='string_literal'>"SUCCESS\n\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1844"><td class="num" id="LN1844">1844</td><td class="line">        zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1845"><td class="num" id="LN1845">1845</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1846"><td class="num" id="LN1846">1846</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1847"><td class="num" id="LN1847">1847</td><td class="line">    printf(<span class='string_literal'>"Stress with random payloads of different encoding:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1848"><td class="num" id="LN1848">1848</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1849"><td class="num" id="LN1849">1849</td><td class="line">        <span class='keyword'>int</span> i,j,len,where;</td></tr>
<tr class="codeline" data-linenumber="1850"><td class="num" id="LN1850">1850</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *p;</td></tr>
<tr class="codeline" data-linenumber="1851"><td class="num" id="LN1851">1851</td><td class="line">        <span class='keyword'>char</span> buf[1024];</td></tr>
<tr class="codeline" data-linenumber="1852"><td class="num" id="LN1852">1852</td><td class="line">        <span class='keyword'>int</span> buflen;</td></tr>
<tr class="codeline" data-linenumber="1853"><td class="num" id="LN1853">1853</td><td class="line">        list *ref;</td></tr>
<tr class="codeline" data-linenumber="1854"><td class="num" id="LN1854">1854</td><td class="line">        listNode *refnode;</td></tr>
<tr class="codeline" data-linenumber="1855"><td class="num" id="LN1855">1855</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1856"><td class="num" id="LN1856">1856</td><td class="line">        <span class='comment'>/* Hold temp vars from ziplist */</span></td></tr>
<tr class="codeline" data-linenumber="1857"><td class="num" id="LN1857">1857</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>char</span> *sstr;</td></tr>
<tr class="codeline" data-linenumber="1858"><td class="num" id="LN1858">1858</td><td class="line">        <span class='keyword'>unsigned</span> <span class='keyword'>int</span> slen;</td></tr>
<tr class="codeline" data-linenumber="1859"><td class="num" id="LN1859">1859</td><td class="line">        <span class='keyword'>long</span> <span class='keyword'>long</span> sval;</td></tr>
<tr class="codeline" data-linenumber="1860"><td class="num" id="LN1860">1860</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1861"><td class="num" id="LN1861">1861</td><td class="line">        <span class='keyword'>for</span> (i = 0; i &lt; 20000; i++) {</td></tr>
<tr class="codeline" data-linenumber="1862"><td class="num" id="LN1862">1862</td><td class="line">            zl = ziplistNew();</td></tr>
<tr class="codeline" data-linenumber="1863"><td class="num" id="LN1863">1863</td><td class="line">            ref = listCreate();</td></tr>
<tr class="codeline" data-linenumber="1864"><td class="num" id="LN1864">1864</td><td class="line">            listSetFreeMethod(ref,(<span class='keyword'>void</span> (*)(<span class='keyword'>void</span>*))sdsfree);</td></tr>
<tr class="codeline" data-linenumber="1865"><td class="num" id="LN1865">1865</td><td class="line">            len = rand() % 256;</td></tr>
<tr class="codeline" data-linenumber="1866"><td class="num" id="LN1866">1866</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1867"><td class="num" id="LN1867">1867</td><td class="line">            <span class='comment'>/* Create lists */</span></td></tr>
<tr class="codeline" data-linenumber="1868"><td class="num" id="LN1868">1868</td><td class="line">            <span class='keyword'>for</span> (j = 0; j &lt; len; j++) {</td></tr>
<tr class="codeline" data-linenumber="1869"><td class="num" id="LN1869">1869</td><td class="line">                where = (rand() &amp; 1) ? <span class='macro'>ZIPLIST_HEAD<span class='macro_popup'>0</span></span> : <span class='macro'>ZIPLIST_TAIL<span class='macro_popup'>1</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1870"><td class="num" id="LN1870">1870</td><td class="line">                <span class='keyword'>if</span> (rand() % 2) {</td></tr>
<tr class="codeline" data-linenumber="1871"><td class="num" id="LN1871">1871</td><td class="line">                    buflen = randstring(buf,1,<span class='keyword'>sizeof</span>(buf)-1);</td></tr>
<tr class="codeline" data-linenumber="1872"><td class="num" id="LN1872">1872</td><td class="line">                } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1873"><td class="num" id="LN1873">1873</td><td class="line">                    <span class='keyword'>switch</span>(rand() % 3) {</td></tr>
<tr class="codeline" data-linenumber="1874"><td class="num" id="LN1874">1874</td><td class="line">                    <span class='keyword'>case</span> 0:</td></tr>
<tr class="codeline" data-linenumber="1875"><td class="num" id="LN1875">1875</td><td class="line">                        buflen = sprintf(buf,<span class='string_literal'>"%lld"</span>,(0LL + rand()) &gt;&gt; 20);</td></tr>
<tr class="codeline" data-linenumber="1876"><td class="num" id="LN1876">1876</td><td class="line">                        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1877"><td class="num" id="LN1877">1877</td><td class="line">                    <span class='keyword'>case</span> 1:</td></tr>
<tr class="codeline" data-linenumber="1878"><td class="num" id="LN1878">1878</td><td class="line">                        buflen = sprintf(buf,<span class='string_literal'>"%lld"</span>,(0LL + rand()));</td></tr>
<tr class="codeline" data-linenumber="1879"><td class="num" id="LN1879">1879</td><td class="line">                        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1880"><td class="num" id="LN1880">1880</td><td class="line">                    <span class='keyword'>case</span> 2:</td></tr>
<tr class="codeline" data-linenumber="1881"><td class="num" id="LN1881">1881</td><td class="line">                        buflen = sprintf(buf,<span class='string_literal'>"%lld"</span>,(0LL + rand()) &lt;&lt; 20);</td></tr>
<tr class="codeline" data-linenumber="1882"><td class="num" id="LN1882">1882</td><td class="line">                        <span class='keyword'>break</span>;</td></tr>
<tr class="codeline" data-linenumber="1883"><td class="num" id="LN1883">1883</td><td class="line">                    <span class='keyword'>default</span>:</td></tr>
<tr class="codeline" data-linenumber="1884"><td class="num" id="LN1884">1884</td><td class="line">                        <span class='macro'>assert(NULL)<span class='macro_popup'>((((void*)0))?(void)0 : (_serverAssert("NULL","ziplist.c",1884<br>),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1885"><td class="num" id="LN1885">1885</td><td class="line">                    }</td></tr>
<tr class="codeline" data-linenumber="1886"><td class="num" id="LN1886">1886</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1887"><td class="num" id="LN1887">1887</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1888"><td class="num" id="LN1888">1888</td><td class="line">                <span class='comment'>/* Add to ziplist */</span></td></tr>
<tr class="codeline" data-linenumber="1889"><td class="num" id="LN1889">1889</td><td class="line">                zl = ziplistPush(zl, (<span class='keyword'>unsigned</span> <span class='keyword'>char</span>*)buf, buflen, where);</td></tr>
<tr class="codeline" data-linenumber="1890"><td class="num" id="LN1890">1890</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1891"><td class="num" id="LN1891">1891</td><td class="line">                <span class='comment'>/* Add to reference list */</span></td></tr>
<tr class="codeline" data-linenumber="1892"><td class="num" id="LN1892">1892</td><td class="line">                <span class='keyword'>if</span> (where == <span class='macro'>ZIPLIST_HEAD<span class='macro_popup'>0</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1893"><td class="num" id="LN1893">1893</td><td class="line">                    listAddNodeHead(ref,sdsnewlen(buf, buflen));</td></tr>
<tr class="codeline" data-linenumber="1894"><td class="num" id="LN1894">1894</td><td class="line">                } <span class='keyword'>else</span> <span class='keyword'>if</span> (where == <span class='macro'>ZIPLIST_TAIL<span class='macro_popup'>1</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1895"><td class="num" id="LN1895">1895</td><td class="line">                    listAddNodeTail(ref,sdsnewlen(buf, buflen));</td></tr>
<tr class="codeline" data-linenumber="1896"><td class="num" id="LN1896">1896</td><td class="line">                } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1897"><td class="num" id="LN1897">1897</td><td class="line">                    <span class='macro'>assert(NULL)<span class='macro_popup'>((((void*)0))?(void)0 : (_serverAssert("NULL","ziplist.c",1897<br>),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1898"><td class="num" id="LN1898">1898</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1899"><td class="num" id="LN1899">1899</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1900"><td class="num" id="LN1900">1900</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1901"><td class="num" id="LN1901">1901</td><td class="line">            <span class='macro'>assert(listLength(ref) == ziplistLen(zl))<span class='macro_popup'>((listLength(ref) == ziplistLen(zl))?(void)0 : (_serverAssert<br>("listLength(ref) == ziplistLen(zl)","ziplist.c",1901),_exit(<br>1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1902"><td class="num" id="LN1902">1902</td><td class="line">            <span class='keyword'>for</span> (j = 0; j &lt; len; j++) {</td></tr>
<tr class="codeline" data-linenumber="1903"><td class="num" id="LN1903">1903</td><td class="line">                <span class='comment'>/* Naive way to get elements, but similar to the stresser</span></td></tr>
<tr class="codeline" data-linenumber="1904"><td class="num" id="LN1904">1904</td><td class="line">                 <span class='comment'>* executed from the Tcl test suite. */</span></td></tr>
<tr class="codeline" data-linenumber="1905"><td class="num" id="LN1905">1905</td><td class="line">                p = ziplistIndex(zl,j);</td></tr>
<tr class="codeline" data-linenumber="1906"><td class="num" id="LN1906">1906</td><td class="line">                refnode = listIndex(ref,j);</td></tr>
<tr class="codeline" data-linenumber="1907"><td class="num" id="LN1907">1907</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1908"><td class="num" id="LN1908">1908</td><td class="line">                <span class='macro'>assert(ziplistGet(p,&amp;sstr,&amp;slen,&amp;sval))<span class='macro_popup'>((ziplistGet(p,&amp;sstr,&amp;slen,&amp;sval))?(void)0 : (_serverAssert<br>("ziplistGet(p,&amp;sstr,&amp;slen,&amp;sval)","ziplist.c",1908<br>),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1909"><td class="num" id="LN1909">1909</td><td class="line">                <span class='keyword'>if</span> (sstr == <span class='macro'>NULL<span class='macro_popup'>((void*)0)</span></span>) {</td></tr>
<tr class="codeline" data-linenumber="1910"><td class="num" id="LN1910">1910</td><td class="line">                    buflen = sprintf(buf,<span class='string_literal'>"%lld"</span>,sval);</td></tr>
<tr class="codeline" data-linenumber="1911"><td class="num" id="LN1911">1911</td><td class="line">                } <span class='keyword'>else</span> {</td></tr>
<tr class="codeline" data-linenumber="1912"><td class="num" id="LN1912">1912</td><td class="line">                    buflen = slen;</td></tr>
<tr class="codeline" data-linenumber="1913"><td class="num" id="LN1913">1913</td><td class="line">                    memcpy(buf,sstr,buflen);</td></tr>
<tr class="codeline" data-linenumber="1914"><td class="num" id="LN1914">1914</td><td class="line">                    buf[buflen] = '\0';</td></tr>
<tr class="codeline" data-linenumber="1915"><td class="num" id="LN1915">1915</td><td class="line">                }</td></tr>
<tr class="codeline" data-linenumber="1916"><td class="num" id="LN1916">1916</td><td class="line">                <span class='macro'>assert(memcmp(buf,listNodeValue(refnode),buflen) == 0)<span class='macro_popup'>((memcmp(buf,listNodeValue(refnode),buflen) == 0)?(void)0 : (<br>_serverAssert("memcmp(buf,listNodeValue(refnode),buflen) == 0"<br>,"ziplist.c",1916),_exit(1)))</span></span>;</td></tr>
<tr class="codeline" data-linenumber="1917"><td class="num" id="LN1917">1917</td><td class="line">            }</td></tr>
<tr class="codeline" data-linenumber="1918"><td class="num" id="LN1918">1918</td><td class="line">            zfree(zl);</td></tr>
<tr class="codeline" data-linenumber="1919"><td class="num" id="LN1919">1919</td><td class="line">            listRelease(ref);</td></tr>
<tr class="codeline" data-linenumber="1920"><td class="num" id="LN1920">1920</td><td class="line">        }</td></tr>
<tr class="codeline" data-linenumber="1921"><td class="num" id="LN1921">1921</td><td class="line">        printf(<span class='string_literal'>"SUCCESS\n\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1922"><td class="num" id="LN1922">1922</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1923"><td class="num" id="LN1923">1923</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1924"><td class="num" id="LN1924">1924</td><td class="line">    printf(<span class='string_literal'>"Stress with variable ziplist size:\n"</span>);</td></tr>
<tr class="codeline" data-linenumber="1925"><td class="num" id="LN1925">1925</td><td class="line">    {</td></tr>
<tr class="codeline" data-linenumber="1926"><td class="num" id="LN1926">1926</td><td class="line">        stress(<span class='macro'>ZIPLIST_HEAD<span class='macro_popup'>0</span></span>,100000,16384,256);</td></tr>
<tr class="codeline" data-linenumber="1927"><td class="num" id="LN1927">1927</td><td class="line">        stress(<span class='macro'>ZIPLIST_TAIL<span class='macro_popup'>1</span></span>,100000,16384,256);</td></tr>
<tr class="codeline" data-linenumber="1928"><td class="num" id="LN1928">1928</td><td class="line">    }</td></tr>
<tr class="codeline" data-linenumber="1929"><td class="num" id="LN1929">1929</td><td class="line"> </td></tr>
<tr class="codeline" data-linenumber="1930"><td class="num" id="LN1930">1930</td><td class="line">    <span class='keyword'>return</span> 0;</td></tr>
<tr class="codeline" data-linenumber="1931"><td class="num" id="LN1931">1931</td><td class="line">}</td></tr>
<tr class="codeline" data-linenumber="1932"><td class="num" id="LN1932">1932</td><td class="line"><span class='directive'>#endif</span></td></tr>
</table></body></html>
